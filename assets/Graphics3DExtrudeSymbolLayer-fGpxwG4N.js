import{y as Z}from"./jsonMap-Bs3hmeCU.js";import{Q as Lt}from"./Point-fJINO2ru.js";import{e as xt}from"./earcut-D9gy186-.js";import{P as zt,D as Mt,a as Ot}from"./Polygon-Brg2ZzgS.js";import{h as Rt,e as Ut}from"./mat4-DD840M-x.js";import{e as J}from"./mat4f64-q_b6UJoq.js";import{s as Vt,A as K,o as R,c as ot,_ as wt,R as rt,u as Ft,E as W}from"./vec32-DAazN8eR.js";import{n as P,_ as at}from"./collectionUtils-DO-P7c3V.js";import{f as Bt}from"./computeTranslationToOriginAndRotation-CIogc7ND.js";import{u as Tt,m as jt,A as Gt}from"./aaBoundingBox-DYUg4mSl.js";import{e as T,i as F}from"./DoubleArray-DExKNiTh.js";import{U as St,f as lt}from"./Indices-D0_UQPPr.js";import{r as Ht}from"./vec3-B_phcnZY.js";import{t as Wt,e as ct}from"./SnappingCandidate-DGkpYqI6.js";import{a as kt}from"./renderingInfoUtils-BzzGe-lJ.js";import{a as Nt,B as Qt,Z as Zt,_ as ut,a0 as qt,a1 as Jt,a2 as Kt,a3 as Xt,a4 as Yt,Q as te}from"./ShadowCastClear.glsl-B_hkuqUp.js";import{w as ee}from"./RealisticTree.glsl-DyN7FrnG.js";import{z as ne}from"./Extent-B4u1bcyL.js";import{h as Pt,i as se}from"./triangulationUtils-CCeR9F67.js";import{t as A}from"./orientedBoundingBox-BGtR3PRL.js";import{m as X,P as ht,a as ie}from"./Texture-BZkoXYR8.js";import{f as oe,g as re}from"./layerViewUtils-BTa15X3o.js";import{b as ae}from"./projectionUtils-DfTR--qY.js";import{c as le,e as ce}from"./edgePreprocessing-D-eyqYfP.js";function ue(e,t,n,i){const s=Pt(e.rings,!!e.hasZ&&i.mode!=="on-the-ground",1,e.spatialReference),o=T(s.position.length),r=Nt(s.position,e.spatialReference,0,o,0,s.position,0,s.position.length/3,t,n,i),a=r!=null;return new me(s.position,o,Ct(s.polygons,s.position,o),vt(s.outlines,s.position,o),a,r)}function Ke(e,t){const n=Pt(e.rings,!1,1),i=ae(n.position,e.spatialReference,0,n.position,t,0);for(let s=2;s<n.position.length;s+=3)n.position[s]=Qt;return{position:n.position,polygons:Ct(n.polygons,n.position),outlines:vt(n.outlines,n.position),projectionSuccess:i}}function vt(e,t,n=null){return e.filter(({count:i})=>i>1).map(({index:i,count:s})=>{const o=3*i,r=3*s;return n!=null?new Et(i,s,F(t,o,r),F(n,o,r)):new Y(i,s,F(t,o,r))})}function Ct(e,t,n=null){const i=new Array;for(const{index:s,count:o,holeIndices:r,pathLengths:a}of e){if(o<=1)continue;const l=3*s,b=3*o,x=r.map(g=>g-s),y=n!=null?new he(s,o,F(t,3*s,3*o),F(n,l,b),x,a):new pe(s,o,F(t,3*s,3*o),x,a);i.push(y)}return i}let Y=class{constructor(t,n,i){this.index=t,this.count=n,this.position=i}};class Et extends Y{constructor(t,n,i,s){super(t,n,i),this.mapPositions=s}}class he extends Et{constructor(t,n,i,s,o,r){super(t,n,i,s),this.holeIndices=o,this.pathLengths=r}}class pe extends Y{constructor(t,n,i,s,o){super(t,n,i),this.holeIndices=s,this.pathLengths=o}}class me{constructor(t,n,i,s,o,r){this.position=t,this.mapPositions=n,this.polygons=i,this.outlines=s,this.projectionSuccess=o,this.sampledElevation=r}}function Ye(e,t,n){const i=(t.length>0?t[0]:e.length/3)-1,s=se(e,i,n);if(s!==2){e=e.slice();for(let o=0;o<e.length;o+=3)e[o+s]=e[o+2]}return xt(e,t,3)}function tn(e){const t=[["position",new A(e.attributeData.position,e.indices,3,!0)]],n=St(e.indices.length);return e.attributeData.colorFeature!=null?t.push(["colorFeatureAttribute",new A([e.attributeData.colorFeature],n,1,!0)]):e.attributeData.color&&t.push(["color",new A(e.attributeData.color,n,4,!0)]),e.attributeData.uvMapSpace&&t.push(["uvMapSpace",new A(e.attributeData.uvMapSpace,e.indices,4,!0)]),e.attributeData.boundingRect&&t.push(["boundingRect",new A(e.attributeData.boundingRect,e.indices,9,!0)]),new X(e.material,t,e.mapPositions,0,e.attributeData.olidColor)}function en(e,t=null){const n=[["position",new A(e.attributeData.position,e.indices,3,!0)],["uv0",new A(e.attributeData.uv0,e.indices,2,!0)]];return new X(e.material,n,e.mapPositions,0,t)}function de(e){switch(e.type){case"extent":if(e instanceof ne)return zt.fromExtent(e);break;case"polygon":return e}return null}class nn{constructor(t,n,i){this.renderData=t,this.layerViewUid=n,this.graphicUid=i,this.outGeometries=new Array}}const ge=["polygon","extent"];class sn extends Zt{constructor(t,n,i,s){super(t,n,i,s,xe(n)),this.ensureDrapedStatus(!1)}async doLoad(){const t=this.symbolLayer,n=t?.material,i=this.symbolLayer.material?.color?.a,s=this.needsDrivenTransparentPass||i!=null&&i!==1,o=n?.emissive,r=!this._hasDrivenColorOrOpacity&&(i==null||i===0),a={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,ambient:at,diffuse:at,opacity:r?0:1,layerOpacity:this._getLayerOpacity(),drivenOpacity:s,hasSymbolColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:t.castShadows,emissiveStrength:o?.strength??0,emissiveSource:1,offsetTransparentBackfaces:!0,normalType:1},l=new ht(a,this._context),b=new ht({...a,cullFace:2},this._context);this._materials[0]=l,this._materials[1]=b,this._updateTransparentDepedentMaterialParameters()}destroy(){super.destroy(),this._materials.length=0}createGraphics3DGraphic(t){const n=t.graphic;if(!this._validateGeometry(n.geometry,ge,this.symbolLayer.type))return null;const i=this._getDrivenUInt8ColorWithNaNSupport(t.renderingInfo,this._materialColor,!1);oe(i,i);const s=this.createElevationContextForGraphic(n);return this._createAs3DShape(n,t.renderingInfo,i,s,n.uid)}layerOpacityChanged(t,n){const i=this._getLayerOpacity();this._materials[0]?.setParameters({layerOpacity:i}),this._materials[1]?.setParameters({layerOpacity:i}),this._updateTransparentDepedentMaterialParameters(),t?.forEach(s=>n(s)?.layerOpacityChanged(i,this._context.isAsync))}layerScreenSizePerspectiveChanged(){}layerElevationInfoChanged(t,n){return this.updateGraphics3DGraphicElevationInfo(t,n,ut)}slicePlaneEnabledChanged(t,n){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._materials[1]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),t?.forEach(i=>{const s=n(i);s?.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){const t={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0};return this._materials[0]?.setParameters(t),this._materials[1]?.setParameters(t),!0}_getExtrusionSize(t){let n;return n=t.size&&this._drivenProperties.size?kt(t.size,2)??0:this._getSymbolSize(),n/=this._context.renderCoordsHelper.unitInMeters,n}applyRendererDiff(t,n){return this._drivenPropertiesChanged(n)?0:1}async queryForSnapping(t,n,i,s){const o=this._getExtrusionSize(i)*this._context.renderCoordsHelper.unitInMeters/Lt(n),{objectId:r,target:a}=t,l=Z(a);switch(l.z=(l.z??0)+o,t.type){case"edge":{const{start:b,end:x}=t,y=Z(b),g=Z(x);return y.z=(y.z??0)+o,g.z=(g.z??0)+o,[ct(r,l,1/0,y,g)]}case"vertex":return[Wt(r,l,1/0),ct(r,a,1/0,a,l)];default:return[]}}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(t,n,i,s,o){const r=de(t.geometry);if(r==null)return null;if(r.rings.length===0||!r.rings.some(C=>C.length>0))return this._logGeometryValidationWarnings(r.rings,"rings","ExtrudeSymbol3DLayer"),null;const a=ue(r,this._context.elevationProvider,this._context.renderCoordsHelper,s);this._logGeometryCreationWarnings(a,r.rings,"rings","ExtrudeSymbol3DLayer");const l=ee(r);if(l==null)return null;const b=new Array,x=new Array,y=Tt(),g=J(),w=P(),p=this._context.renderCoordsHelper.viewingMode===1;p||this._context.renderCoordsHelper.worldUpAtPosition(null,w),Bt(r.spatialReference,[l.x,l.y,0],g,this._context.renderCoordsHelper.spatialReference);const _=J();Rt(_,g);const d=Ot();Mt(d,_);const{polygons:f,mapPositions:c,position:m}=a,h=new Map,v=this._materials[0];for(const C of f){const z=C.count;if(this._context.clippingExtent&&(jt(C.mapPositions,y),!Gt(y,this._context.clippingExtent)))continue;const M=xt(C.mapPositions,C.holeIndices,3);if(M.length===0)continue;const O=M.length,D=6*z,U=lt(D+O),k=lt(O),j=T(3*D),tt=T(3*D),et=T(3*D),nt=T(D);fe(m,c,M,C,j,et,tt,nt,U,k,this._getExtrusionSize(n),w,p),Ht(j,j,_);const st=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:o,layerViewUid:this._context.layerViewUid}),N=new Ce(j,et,le(tt),nt),Q=pt(v,U,U.length-k.length,N,i,st),At=z,$t=z,It=2*C.count,it=new Ee(At,$t,It,O/3);Dt(Q,it,g),h.set(Q,it),b.push(Q,pt(this._materials[1],k,0,N,i,st)),x.push(N.heights)}if(b.length===0)return null;const u=new qt({geometries:b,layerViewUid:this._context.layerViewUid,graphicUid:o,isElevationSource:!0});u.transformation=g;const $=re(this.symbolLayer,{opacity:this._getLayerOpacity()}),I=$?new Jt(this._materials[0],$,this._context.slicePlaneEnabled):null,L=new Kt(this,u,null,(C,z,M,O,D)=>be(C,z,M,O,D,x,h),s,I);return L.alignedSampledElevation=a.sampledElevation,L.needsElevationUpdates=ut(s.mode),L}get _materialColor(){return this.symbolLayer.material?.color}_updateTransparentDepedentMaterialParameters(){const t=this._materials[0];t&&t.setParameters({cullFace:t.transparent?0:2})}}function pt(e,t,n,i,s,o){const r=St(t.length),a=[["position",new A(i.positions,t,3,!0)],["normalCompressed",new A(i.normals,t,2,!0)],["symbolColor",new A(s,r,4,!0)]];return new X(e,a,i.elevation,0,o,n)}function fe(e,t,n,i,s,o,r,a,l,b,x,y,g){const w=n.length/3;let p=2*i.count;ye(e,t,i.index,i.count,n,0,w,s,o,r,a,l,b,p,x,y,g);let _=0,d=2*i.count;p=0;const f=i.pathLengths[0];mt(s,o,a,r,_,f,i.count,d,l,p,x),d+=4*f,p+=2*f,_+=f;for(let c=1;c<i.pathLengths.length;++c){const m=i.pathLengths[c];mt(s,o,a,r,_,m,i.count,d,l,p,x),d+=4*m,p+=2*m,_+=m}}function ye(e,t,n,i,s,o,r,a,l,b,x,y,g,w,p,_,d){Vt(E,_),l??=[],b??=[],x??=[];const f=p>0?1:-1;let c=3*n,m=0,h=3*m,v=i,u=3*v;for(let L=0;L<i;++L){const C=e[c],z=e[c+1],M=e[c+2];d&&(E[0]=C,E[1]=z,E[2]=M,K(E,E)),a[h+0]=C,a[h+1]=z,a[h+2]=M;const O=t[c+0],D=t[c+1],U=t[c+2];l[h+0]=O,l[h+1]=D,l[h+2]=U,b[h+0]=-f*E[0],b[h+1]=-f*E[1],b[h+2]=-f*E[2],x[m]=0,a[u+0]=C+p*E[0],a[u+1]=z+p*E[1],a[u+2]=M+p*E[2],l[u+0]=O,l[u+1]=D,l[u+2]=U,x[v]=p,h+=3,u+=3,c+=3,m+=1,v+=1}c=3*o,h=0,u=3*w;const $=p<0?bt:_t,I=p<0?_t:bt;for(let L=0;L<r;++L)g[h]=s[c+$[0]],g[h+1]=s[c+$[1]],g[h+2]=s[c+$[2]],y[u]=s[c+I[0]]+i,y[u+1]=s[c+I[1]]+i,y[u+2]=s[c+I[2]]+i,h+=3,u+=3,c+=3}function G(e,t,n,i,s,o,r){i[o]=i[r],r*=3,e[o*=3]=e[r],e[o+1]=e[r+1],e[o+2]=e[r+2],t[o]=t[r],t[o+1]=t[r+1],t[o+2]=t[r+2],n[o]=s[0],n[o+1]=s[1],n[o+2]=s[2]}const B=P();function mt(e,t,n,i,s,o,r,a,l,b,x){t??=[],n??=[],i??=[];let y=s,g=s+1,w=s+r,p=s+r+1,_=a,d=a+1,f=a+2*o,c=a+2*o+1;x<0&&(y=s+r+1,p=s);let m=3*b;for(let h=0;h<o;++h)h===o-1&&(g=s,x>0?p=s+r:y=s+r),_e(e,y,g,w,B),G(e,t,i,n,B,_,y),G(e,t,i,n,B,d,g),G(e,t,i,n,B,f,w),G(e,t,i,n,B,c,p),l[m]=_,l[m+1]=f,l[m+2]=c,l[m+3]=_,l[m+4]=c,l[m+5]=d,m+=6,y++,g++,w++,p++,_+=2,d+=2,f+=2,c+=2}const q=P(),dt=P(),gt=P(),ft=P(),yt=P();function _e(e,t,n,i,s){t*=3,n*=3,i*=3,R(q,e[t++],e[t++],e[t++]),R(dt,e[n++],e[n++],e[n++]),R(gt,e[i++],e[i++],e[i++]),ot(ft,dt,q),ot(yt,gt,q),wt(s,yt,ft),K(s,s)}const V=P();function be(e,t,n,i,s,o,r){const a=e.stageObject,l=a.geometries,b=l.length,x=t.mode!=="absolute-height";let y=0;const g=a.transformation,w=Ut(J(),g);for(let p=0;p<b;p+=2){const _=l[p];if(!Xt(_))continue;const d=_.getMutableAttribute("position").data,f=o[p/2],c=new Yt(_.mapPositions),m=d.length/3;let h=!1,v=0;{let u=0;for(let $=0;$<m;$++){V[0]=d[u],V[1]=d[u+1],V[2]=d[u+2],i(c,H),x&&(v+=H.sampledElevation),ie.TESTS_DISABLE_OPTIMIZATIONS?(R(S,c.array[c.offset],c.array[c.offset+1],H.z+f[u/3]),n!=null&&s.toRenderCoords(S,n,S),W(S,S,w)):(R(S,d[u],d[u+1],d[u+2]),W(S,S,g),s.setAltitude(S,H.z+f[u/3]),W(S,S,w)),d[u]=S[0],d[u+1]=S[1],d[u+2]=S[2];const I=we/s.unitInMeters;(Math.abs(V[0]-d[u])>=I||Math.abs(V[1]-d[u+1])>=I||Math.abs(V[2]-d[u+2])>=I)&&(h=!0),c.offset+=3,u+=3}}if(h){const u=r.get(_);u&&Dt(_,u,g),a.geometryVertexAttributeUpdated(l[p],"normalCompressed"),_.invalidateBoundingInfo(),a.geometryVertexAttributeUpdated(l[p],"position"),l[p+1].invalidateBoundingInfo(),a.geometryVertexAttributeUpdated(l[p+1],"position")}y+=v/m}return y/b}function Dt(e,t,n){const i=e.getMutableAttribute("position"),s=e.getMutableAttribute("normalCompressed").data,o=i.data,r=e.attributes.get("position").indices,{topVertexStart:a,topVertexCount:l,topFaceStart:b,topFaceCount:x}=t,y=b+x,g=a+l,w=Se,p=Pe,_=ve,d=E,f=S;R(f,0,0,0);const c=(m,h)=>{const v=3*m;R(h,o[v+0],o[v+1],o[v+2]),W(h,h,n)};for(let m=b;m<y;++m){const h=3*m;c(r[h+0],w[0]),c(r[h+1],w[1]),c(r[h+2],w[2]),rt(p,w[1],w[0]),rt(_,w[2],w[0]),wt(d,p,_),Ft(f,f,d)}K(f,f);for(let m=a;m<g;++m){const h=f[0],v=f[1],u=f[2];ce(s,m,h,v,u)}}function xe(e){return(e.material?.color?.a??0)===1}const S=P(),E=P(),H=new te,_t=[0,2,1],bt=[0,1,2],we=.01,Se=[P(),P(),P()],Pe=P(),ve=P();class Ce{constructor(t,n,i,s){this.positions=t,this.elevation=n,this.normals=i,this.heights=s}}class Ee{constructor(t,n,i,s){this.topVertexStart=t,this.topVertexCount=n,this.topFaceStart=i,this.topFaceCount=s}}export{sn as K,fe as X,nn as a,en as c,de as l,Ke as p,ue as r,tn as s,Ye as u};
