import{l as Y,_ as L,m as $,a as B}from"./jsonMap-Bs3hmeCU.js";import{n as M,O as J}from"./collectionUtils-yEu3-UXw.js";import{s as K,r as G}from"./Cyclical-BLSxUpe7.js";import{aF as H,I as b}from"./ShadowCastClear.glsl-9G1ObMeX.js";import{U as x}from"./elevationInfoUtils-DW7fNUvj.js";import{p as P,C as g,X as T,F as S,d as l,Y as f,_ as F,e as k,U as N,Q as W,$ as Z,k as O,a0 as ee,D as te,E as ie,a1 as re,y as se}from"./euclideanLengthMeasurementUtils-DjmCP2nz.js";import{F as oe}from"./Point-B6yFWNoR.js";import{aj as z,U as A,b as Q,j as ne,p as pe,d as ae,ak as he}from"./Polygon-BUi4eoGW.js";import{y as R,U as X}from"./angularMeasurementUtils-DwnUpjOS.js";import{n as D}from"./vec2f64-rIxtbMRN.js";import{y as U,d as me}from"./geometry2dUtils-BvGwGPs_.js";import{q as le,c as ce,o as de}from"./vec32-BF0cLBAR.js";import"./index-CAyy5ces.js";import"./reactiveUtils-SO2Ko3sy.js";import"./reader-DcGs6kKN.js";import"./Extent-D4kxmHSf.js";import"./SimpleObservable-CvFyr0NA.js";import"./mathUtils-PIGhLnI9.js";import"./Texture-BcM9ZALi.js";import"./mat4f64-q_b6UJoq.js";import"./Indices-D0_UQPPr.js";import"./BufferView-5vCN6AU9.js";import"./vec42-Cr02Pi7P.js";import"./vec4f64-DPb6J-GU.js";import"./sphere-BiyfUvnN.js";import"./mat4-DMghHRAg.js";import"./vector-B05yfH0j.js";import"./quatf64-CCm9z-pX.js";import"./frustum-BV26jp-1.js";import"./plane-B7VfuINA.js";import"./Emissions.glsl-B8XKMjLy.js";import"./Color-CERqXxxY.js";import"./enums-B4pqBiXb.js";import"./aaBoundingBox-CVMQtR0c.js";import"./aaBoundingRect-F1Nk1aID.js";import"./DoubleArray-DExKNiTh.js";import"./orientedBoundingBox-ezehkKFt.js";import"./quat-Ao2mrU5h.js";import"./spatialReferenceEllipsoidUtils-CJDHI1w1.js";import"./computeTranslationToOriginAndRotation-BK14f5O2.js";import"./projectionUtils-DIbtnzb-.js";import"./Polyline-CiznIgZG.js";import"./InterleavedLayout-NeYQVO9u.js";import"./types-BKo2foNY.js";import"./VertexElementDescriptor-BlxU8vCE.js";import"./screenUtils-BitdhK1O.js";import"./lengthUtils-BsZbNiqt.js";import"./date-IqUzANpt.js";import"./projectPointToVector-DJN8xj-B.js";import"./projectVectorToVector-P-2wsy-w.js";import"./HUDIntersectorResult-B_jyrAGm.js";import"./normalizeUtils-9qNRso4M.js";import"./normalizeUtilsCommon-C6mtpeei.js";import"./jsonUtils-BGiBUdmT.js";import"./utils-CIVJ4xuJ.js";import"./utils-CMK6z7yl.js";import"./videoUtils-Dwx3AEgj.js";import"./typeUtils-BzzgRKyX.js";import"./modeUtils-BQO-Lkkv.js";import"./intl-BY86zs1L.js";import"./uuid-Oe6SV2kF.js";import"./sanitizerUtils-BT_8V5US.js";import"./workers-CpwSXy88.js";import"./Queue-CYlrXMwB.js";import"./PooledRBush-Dco5QkUp.js";import"./quickselect-QQC62dOK.js";import"./GraphicsCollection-DOghpxSR.js";import"./Graphic-B5lJuCvi.js";import"./getPopupProvider-mvkAgiBn.js";import"./Layer-B6AWeI6O.js";import"./createFeatureId-CVwTD0fV.js";import"./typeUtils-cI568bV6.js";import"./lineMarkers-CDwLe3J6.js";import"./PolygonSymbol3D-DuQ13Get.js";import"./ExtrudeSymbol3DLayer-DSc1ou2x.js";import"./opacityUtils-DuFH0EC9.js";import"./Font-DF-HycCW.js";import"./SimpleFillSymbol-CDawtd9z.js";import"./SimpleMarkerSymbol-BGAFRS9_.js";import"./PictureMarkerSymbol-_eQf1cyL.js";import"./TextSymbol-BjfCHbpC.js";import"./HeightModelInfo-DHIKf3I1.js";import"./RealisticTree.glsl-XUrhiZwO.js";import"./meshVertexSpaceUtils-DUZqeOYR.js";import"./MeshLocalVertexSpace-C1Y-OkHk.js";import"./vec3f32-WCVSSNPR.js";import"./memoryEstimations-Bd726a_p.js";import"./Intersector-CoyLvWqI.js";import"./scaleUtils-CA2vbbgo.js";import"./layerUtils-CIRkC1pU.js";import"./TilemapCache-PuRJnLNa.js";import"./LRUCache-fy84PBMi.js";import"./TileKey-BVNpatnV.js";import"./tagSymbols-BPcGfZon.js";import"./UpdatingHandles-D2RI_3Hb.js";import"./asyncUtils-w6KfWU41.js";import"./signal-BX9ezF8a.js";import"./Map-vzu4-Gpj.js";import"./Basemap-CnwcXr2z.js";import"./loadAll-B9GTyWP9.js";import"./PortalItem-eLNwGntE.js";import"./writeUtils-BArD5fe9.js";import"./CollectionFlattener-DqqIW8Ln.js";import"./persistable-BhM8_Nvw.js";import"./MD5-MtSiOt06.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw.js";import"./resourceExtension-o9xhC_1c.js";import"./PolygonCollection-CeRBzyKs.js";import"./mat4f32-Djp3mnm5.js";import"./TablesMixin-YmY2jgQz.js";import"./timeZoneUtils-BSc7-7qA.js";import"./ReactiveMap-B0by2bYu.js";import"./Query-Dal_c4tA.js";import"./Field-Cm_ZejYW.js";import"./fieldType-DVUzXtk_.js";import"./ElevationQuery-DStHBHni.js";import"./TileInfo-Ed-RyvGY.js";import"./Scheduler-CNrsbccs.js";import"./constants-D67WmGms.js";import"./floatRGBA-CCeie_ny.js";import"./labelUtils-BtizwBfq.js";import"./ArcadeExpression-tLhjkIsm.js";import"./TimeOnly-CyjHJh3J.js";import"./enum-BzLwmiID.js";import"./UnknownTimeZone-B697BDFv.js";import"./FieldsIndex-DldSuWRM.js";import"./TileKey-C44YQC4_.js";import"./layerViewUtils-BTa15X3o.js";import"./unitConversionUtils-BhI4jDV1.js";import"./vec2f32-CaVKkSa6.js";import"./dehydratedFeatures-CTv_fIM5.js";import"./quantizationUtils-BHf4RTyd.js";import"./featureConversionUtils-BIy1MIBK.js";import"./OptimizedFeature-CwRGZPwv.js";import"./OptimizedFeatureSet-BR8EEvDc.js";import"./Octree-CCWW6e3I.js";import"./intersectorUtilsConversions-DntjJfod.js";import"./DefaultLoadingContext-CD84Ifzv.js";import"./wosrLoader-BBb8Esv0.js";import"./Version-BtYZEj58.js";import"./axisAngleDegrees-BxP7rfWR.js";import"./edgePreprocessing-KwHJ9wld.js";import"./config-Dg972SSE.js";import"./GeometryUtils-Baowv_lX.js";import"./definitions-Dvg4hMIw.js";import"./WorkerHandle-C7Ujx0oh.js";import"./colorUtils-CQgSrs28.js";import"./vec3-B_phcnZY.js";import"./vec33-CWJeyzxV.js";import"./capabilities-Bi6C4OG6.js";import"./imageUtils-Dd3IjdtB.js";import"./utils-DTE-xBiC.js";import"./geodeticLengthOperator-RdkkEHwB.js";import"./geodeticCurveType-CirnHLSB.js";class C{constructor(i,e){this.view=i,this.options=e,this.squaredShortLineThreshold=P.shortLineThreshold*P.shortLineThreshold}snap(i,e){return e.vertexHandle!=null?e.vertexHandle.type!=="vertex"?[]:this.snapExistingVertex(i,e):this.snapNewVertex(i,e)}edgeExceedsShortLineThreshold(i,e){return this.exceedsShortLineThreshold(g(i.leftVertex.pos,this.view,e),g(i.rightVertex.pos,this.view,e),e)}exceedsShortLineThreshold(i,e,{spatialReference:t}){return this.squaredShortLineThreshold===0||T(S(e,t,x,this.view),S(i,t,x,this.view))>this.squaredShortLineThreshold}isVertical(i,e,{spatialReference:t}){const r=oe(t);return z(l(i),l(e))*r<P.verticalLineThresholdMeters}squaredProximityThreshold(i){return i==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityThreshold}get _squaredMouseProximityThreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:i,touchSensitivityMultiplier:e}=this.options,t=i*e;return t*t}}class ge extends C{constructor(i,e,t){super(i,e),this._geodesicLengthMeasurementUtils=t}snapNewVertex(i,e){const t=e.editGeometryOperations.data.parts[0],r=t.segments.length,o=[];if(r<1)return o;const{spatialReference:n}=e,p=S(i,n,x,this.view),{view:s}=this,a=t.segments[r-1];let h=a;do{if(f(h)&&this.edgeExceedsShortLineThreshold(h,e)){const c=F(h,s,e);this._processCandidateProposal(c.left,c.right,i,p,e,o)}h=h.leftVertex.leftSegment}while(h&&h!==a);return o}snapExistingVertex(i,e){const t=[],r=e.vertexHandle,o=r.part;if(o.segments.length<2)return t;const{view:n}=this,{spatialReference:p}=e,s=S(i,p,x,n),a=r.leftSegment,h=r.rightSegment;f(a)&&f(h)&&this.edgeExceedsShortLineThreshold(a,e)&&this.edgeExceedsShortLineThreshold(h,e)&&this._processCandidateProposal(g(a.leftVertex.pos,n,e),g(h.rightVertex.pos,n,e),i,s,e,t);const c=o.segments[0];let d=c;do{if(f(d)&&d!==r.leftSegment&&d!==r.rightSegment&&this.edgeExceedsShortLineThreshold(d,e)){const v=F(d,n,e);this._processCandidateProposal(v.left,v.right,i,s,e,t)}d=d.rightVertex.rightSegment}while(d&&d!==c);return t}_processCandidateProposal(i,e,t,r,o,n){const{spatialReference:p,pointer:s}=o,a=M();fe(a,i,e,t,o,this._geodesicLengthMeasurementUtils);const h=k(N(a));T(r,S(h,p,x,this.view))<this.squaredProximityThreshold(s)&&n.push(new W({lineStart:i,lineEnd:e,targetPoint:h,isDraped:o.elevationInfo?.mode==="on-the-ground"}))}}function fe(m,i,e,t,r,o){ue(m,i,e,t,r,o)||xe(m,t,i,e)}function ue(m,i,e,t,{spatialReference:r},o){const n=R(i,e,r,r);if(n==null)return!1;const p=R(e,t,r,r);if(p==null)return!1;const s=o.geodesicDistance(e,t,r);if(s==null)return!1;const a=Math.abs(K.shortestSignedDiff(n,p))>Math.PI/2?G.normalize(n+Math.PI):n;return X(m,e,r,H(s,"meters"),b(a,"radians","geographic"),"geodesic"),m[2]=t[2],!0}function xe(m,i,e,t){Z(i,{start:e,end:t,type:1},m),m[2]=i[2]}class Se extends C{snapNewVertex(i,e){const t=e.editGeometryOperations.data.parts[0],r=t.segments.length,o=t.vertices.length,n=[];if(r<2)return n;const{view:p}=this,s=S(i,e.spatialReference,x,p),a=t.vertices[0],h=t.vertices[o-1],c=f(h.leftSegment)?g(h.pos,p,e):null,d=f(a.rightSegment)?g(a.pos,p,e):null,v=t.segments[r-1];let u=v;do{if(f(u)&&this.edgeExceedsShortLineThreshold(u,e)){const y=F(u,p,e);c&&this._checkEdgeForParallelLines(y,c,i,s,e,n),d&&this._checkEdgeForParallelLines(y,d,i,s,e,n)}u=u.leftVertex.leftSegment}while(u&&u!==v);return n}snapExistingVertex(i,e){const t=[],r=e.vertexHandle,o=r.part;if(o.segments.length<3)return t;const{view:n}=this,p=S(i,e.spatialReference,x,n),s=r.leftSegment,a=r.rightSegment,h=o.vertices[0],c=g(h.pos,n,e),d=o.vertices.length,v=o.vertices[d-1],u=g(v.pos,n,e),y=o.segments[0];let w=y;do{if(f(w)&&w!==s&&w!==a&&this.edgeExceedsShortLineThreshold(w,e)){const E=F(w,n,e);f(s)&&this._checkEdgeForParallelLines(E,g(s.leftVertex.pos,n,e),i,p,e,t),f(a)&&this._checkEdgeForParallelLines(E,g(a.rightVertex.pos,n,e),i,p,e,t),r===h?this._checkEdgeForParallelLines(E,u,i,p,e,t):r===v&&this._checkEdgeForParallelLines(E,c,i,p,e,t)}w=w.rightVertex.rightSegment}while(w&&w!==y);return t}_checkEdgeForParallelLines(i,e,t,r,o,n){const p=i.left,s=i.right;if(U(V,l(e),l(p),l(s)),A(V,l(e))<P.parallelLineThreshold)return;U(V,l(t),l(p),l(s),l(e));const{spatialReference:a,pointer:h}=o,c=k(O(V[0],V[1],t[2]));if(T(r,S(c,a,x,this.view))<this.squaredProximityThreshold(h)){if(this.isVertical(c,e,o)||this.isVertical(p,s,o)||ve(i,n))return;n.push(new ee({referenceLine:i,lineStart:e,targetPoint:c,isDraped:o.elevationInfo?.mode==="on-the-ground"}))}}}function ve(m,i){const e=m.left,t=m.right;for(const r of i)if(U(V,l(t),l(r.constraint.start),l(r.constraint.end),l(e)),A(V,l(t))<P.parallelLineThreshold)return r.addReferenceLine(m),!0;return!1}const V=D();class we extends C{constructor(i,e,t){super(i,e),this._geodesicLengthMeasurementUtils=t}snapNewVertex(i,e){const t=e.editGeometryOperations.data.parts[0],r=[];if(t.vertices.length<2)return r;const{view:o}=this,n=S(i,e.spatialReference,x,o),p=t.vertices.at(-1);f(p.leftSegment)&&this._checkForSnappingCandidate(1,r,p.leftSegment,p,p.leftSegment.leftVertex,i,n,e);const s=t.vertices[0];return f(s.rightSegment)&&this._checkForSnappingCandidate(2,r,s.rightSegment,s,s.rightSegment.rightVertex,i,n,e),r}snapExistingVertex(i,e){const t=[],r=e.vertexHandle;if(r.part.vertices.length<3)return t;const{view:o}=this,n=S(i,e.spatialReference,x,o),p=r.leftSegment,s=r.rightSegment;if(f(p?.leftVertex.leftSegment)){const a=p.leftVertex.leftSegment;this._checkForSnappingCandidate(3,t,a,a.rightVertex,a.leftVertex,i,n,e)}if(f(s)&&f(s.rightVertex.rightSegment)){const a=s.rightVertex.rightSegment;this._checkForSnappingCandidate(3,t,a,a.leftVertex,a.rightVertex,i,n,e)}return t}_checkForSnappingCandidate(i,e,t,r,o,n,p,s){if(!f(t)||!this.edgeExceedsShortLineThreshold(t,s))return;const a=this.view,h=g(r.pos,a,s),c=g(o.pos,a,s);ye(I,c,h,n,s,this._geodesicLengthMeasurementUtils),this._checkForSnappingCandidateAlongProjectedRay(i,e,c,h,I,n,p,s)}_checkForSnappingCandidateAlongProjectedRay(i,e,t,r,o,n,p,s){const{spatialReference:a,pointer:h}=s,c=Q(q,l(n),l(r)),d=ne(o,c)/pe(o),v=ae(q,l(r),o,d),u=k(O(v[0],v[1],n[2]));if(T(p,S(u,a,x,this.view))>this.squaredProximityThreshold(h)||this.isVertical(u,r,s)||this.isVertical(r,t,s))return;const y=le(M(),r,o,Math.sign(d));e.push(new te({targetPoint:u,constraint:new ie(r,N(y)),previousVertex:t,otherVertex:r,otherVertexType:1,selfSnappingType:i,isDraped:s.elevationInfo?.mode==="on-the-ground"}))}}function ye(m,i,e,t,r,o){Ve(m,i,e,t,r,o)||_e(m,i,e)}function Ve(m,i,e,t,{spatialReference:r},o){const n=R(i,e,r,r);if(n==null)return!1;const p=R(e,t,r,r);if(p==null)return!1;const s=Math.sign(G.shortestSignedDiff(n,p))*Math.PI*.5,a=b(n+s,"radians","geographic"),h=M(),c=o.geodesicDistance(e,t,r);return c!=null&&(X(h,e,r,H(c,"meters"),a,"geodesic"),ce(m,h,e),!0)}function _e(m,i,e){const t=Q(q,l(e),l(i));de(m,t[1],-t[0],0)}const q=D(),I=M();class Le extends C{snapNewVertex(i,e){const t=e.editGeometryOperations.data.parts[0],r=[],o=t.vertices.length;if(e.editGeometryOperations.data.type!=="polygon"||o<2)return r;const{view:n}=this,p=t.vertices[0],s=t.vertices[o-1];if(s.leftSegment&&s.leftSegment.type!=="line"||s.rightSegment&&s.rightSegment.type!=="line")return r;const a=g(p.pos,n,e),h=g(s.pos,n,e);return this._processCandidateProposal(a,h,i,e,r),r}snapExistingVertex(i,e){const t=[],r=e.vertexHandle,o=r.part;if(o.segments.length<2||e.editGeometryOperations.data.type==="polyline"&&(r.index===0||r.index===o.vertices.length-1)||r.leftSegment?.type!=="line"||r.rightSegment?.type!=="line")return t;const{view:n}=this,p=g(r.leftSegment.leftVertex.pos,n,e),s=g(r.rightSegment.rightVertex.pos,n,e);return this._processCandidateProposal(p,s,i,e,t),t}_processCandidateProposal(i,e,t,r,o){if(!this.exceedsShortLineThreshold(i,e,r))return;const n=he(j,l(i),l(e),.5),p=.5*z(l(i),l(e)),s=me(j,l(t),n,p),a=k(O(s[0],s[1],t[2])),{spatialReference:h,pointer:c}=r,d=S(t,h,x,this.view);if(T(d,S(a,h,x,this.view))<this.squaredProximityThreshold(c)){if(this.isVertical(i,a,r)||this.isVertical(a,e,r))return;o.push(new re({targetPoint:a,point1:i,point2:e,isDraped:r.elevationInfo?.mode==="on-the-ground"}))}}}const j=D();let _=class extends Y{constructor(m){super(m),this.updating=!1,this._snappers=new J,this._domain=2}initialize(){this._snappers.push(new Se(this.view,this.options),new ge(this.view,this.options,this.geodesicLengthMeasurementUtils),new we(this.view,this.options,this.geodesicLengthMeasurementUtils),new Le(this.view,this.options))}set options(m){this._set("options",m);for(const i of this._snappers)i.options=m}async fetchCandidates(m,i,e){if(!(i&this._domain&&this.options.effectiveSelfEnabled))return[];const t=[];for(const r of this._snappers.items)for(const o of r.snap(m,e))t.push(o);return se(m,t),t}};L([$({readOnly:!0})],_.prototype,"updating",void 0),L([$({constructOnly:!0})],_.prototype,"view",void 0),L([$({constructOnly:!0})],_.prototype,"geodesicLengthMeasurementUtils",void 0),L([$()],_.prototype,"options",null),_=L([B("esri.views.interactive.snapping.SelfSnappingEngine")],_);export{_ as SelfSnappingEngine};
