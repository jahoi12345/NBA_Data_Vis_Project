import{_ as n,m as h,a as ie,l as Me,aU as ye,u as P,aC as Pt,a1 as Kt,n as He,aI as Qt,d as Xt,V as Yt,bF as Jt,ac as Zt,G as ei,t as ti,bb as ii,i as si}from"./jsonMap-Bs3hmeCU.js";import{s as ai,I as ri}from"./featureReferenceUtils-BzOguQtG.js";import{by as oi,J as ni,b2 as li,f as Be,ax as Je,aZ as hi,az as ci}from"./ShadowCastClear.glsl-BGPoo-07.js";import{l as M,h as x,w as le,f as pe,U as Ft}from"./reactiveUtils-SO2Ko3sy.js";import{E as G,A as he,s as N,B as Ve,P as ue,R as F,u as K,g as k,_ as di,y as Ge,o as Q,Y as ve,q as pi,p as Ze,H as ui}from"./vec32-zHQcyKRA.js";import{n as u,r as q,b as vi,t as At,o as mi,O as wi}from"./collectionUtils-CB98pReO.js";import{F as fi,X as gi,J as _i,G as Vi}from"./projectionUtils-ClsoIho7.js";import{K as bi,F as Mi}from"./aaBoundingRect-DfeeUq5j.js";import{e as yi}from"./AnalysisView3D-zhHEgrUR.js";import{w as Si,j as Di,t as re,Y as Se,g as Oi,o as Ti,p as se,a as $i}from"./ShadedColorMaterial.glsl-3AYkzYTx.js";import{s as y,M as me,r as qe}from"./mathUtils-PIGhLnI9.js";import{e as S,r as et}from"./mat4f64-q_b6UJoq.js";import{b as ze}from"./Point-62ir3Nzl.js";import{p as X,y as be,g as Et,d as De,R as Ie,c as Le,q as fe,J as W,i as Ht,e as zt,f as xi}from"./mat4-Bjnccznk.js";import{k as Ri,a as It,j as Lt,R as Ci}from"./plane-CAH7O3r1.js";import{u as te}from"./Color-CERqXxxY.js";import{P as tt,D as Pi}from"./dragEventPipeline3D-8oHY0ebf.js";import{aP as Fi,m as Ai,g as Ei,aS as Hi,aT as zi,T as Ii,aU as Li,aV as Ui,V as ji,aW as ki,aX as Ni,aY as Wi,aZ as Bi,ao as it,aq as Oe,a_ as st,a$ as Gi,b0 as qi,a1 as Ki,a2 as Qi,b1 as Xi,a3 as Yi,aK as Ji,a8 as Zi,b2 as es,b3 as Te,u as ts}from"./Texture-CAvBvljT.js";import{u as is}from"./Viewshed-Chyge678.js";import{d as ss}from"./asyncUtils-w6KfWU41.js";import{a as at,n as as}from"./Cyclical-BLSxUpe7.js";import{M as rs,H as Ue,q as rt,A as os,l as ns}from"./RealisticTree.glsl-DAhEIR1w.js";import{y as Ut,o as jt,a as ls,p as hs}from"./MoveManipulation-DgIdg4m-.js";import{s as je}from"./BufferView-CdBDKeBv.js";import{p as _e,R as cs,h as $e,f as ds}from"./InteractiveToolBase-CFS-dgS6.js";import{a as ps,q as us}from"./sphere-DGD4QNOm.js";import{s as Ke}from"./sliceToolConfig-BnawSSVt.js";import{m as kt}from"./ColorMaterial.glsl-DITwsyR3.js";import{g as vs}from"./EditGeometryOperations-C-OVMfDU.js";import{b as ms}from"./settings-CBe1rIVY.js";import{G as ws}from"./ExtendedLineVisualElement-BbXxBw-x.js";import{c as fs}from"./LaserlinePath.glsl-B_28jNcs.js";import{f as gs}from"./intersectorUtilsConversions-Cv_V2i_M.js";import{o as _s,m as Vs,f as bs,d as ot}from"./analysisViewUtils-p9xJIaI1.js";import{o as Ms}from"./ToolIntersector-CJNxpodo.js";import{t as ys}from"./orientedBoundingBox-CbUQAgG7.js";import{x as Ss}from"./PointVisualElement-BTnHoOQz.js";import{h as Ds}from"./lineStippleUtils-CCavR4OV.js";import{n as Os,u as nt}from"./vec4f64-DPb6J-GU.js";import{n as lt,T as Ts}from"./enums-B4pqBiXb.js";import{_ as $s}from"./index-CB_zX-aI.js";import{t as ke,e as xe,f as xs,j as ht}from"./Emissions.glsl-B8XKMjLy.js";import"./Polygon-BbQMC1ht.js";import"./vec2f64-rIxtbMRN.js";import"./vec42-fTNpW1Xv.js";import"./jsonUtils-alsySR4T.js";import"./Extent-Cs-ESnE1.js";import"./Polyline-CUSonZ4c.js";import"./typeUtils-BR_JAZOz.js";import"./modeUtils-BF30GgRz.js";import"./intl-BIQN36K8.js";import"./date-IqUzANpt.js";import"./uuid-Oe6SV2kF.js";import"./sanitizerUtils-BT_8V5US.js";import"./SimpleObservable-CvFyr0NA.js";import"./screenUtils-BitdhK1O.js";import"./lengthUtils-Cm-zragw.js";import"./workers-VgzaPqUK.js";import"./Queue-CYlrXMwB.js";import"./PooledRBush-Dco5QkUp.js";import"./quickselect-QQC62dOK.js";import"./GraphicsCollection-mGxi3VN1.js";import"./Graphic-CkB18CDi.js";import"./getPopupProvider-mckaq9Ri.js";import"./reader-DcGs6kKN.js";import"./Layer-BLV7fz0K.js";import"./createFeatureId-CVwTD0fV.js";import"./typeUtils-D0MaDvT3.js";import"./lineMarkers-CDwLe3J6.js";import"./PolygonSymbol3D-Dla3O-pf.js";import"./ExtrudeSymbol3DLayer-DSc1ou2x.js";import"./opacityUtils-DuFH0EC9.js";import"./aaBoundingBox-DO0Hqciy.js";import"./DoubleArray-DExKNiTh.js";import"./Font-BYMGzku7.js";import"./SimpleFillSymbol-CDawtd9z.js";import"./SimpleMarkerSymbol-BGAFRS9_.js";import"./PictureMarkerSymbol-CjQJkY_m.js";import"./TextSymbol-Ck-WHI2u.js";import"./HeightModelInfo-CNRqlD7K.js";import"./spatialReferenceEllipsoidUtils-BGTSZp-L.js";import"./projectPointToVector-B1tbWJiK.js";import"./scaleUtils-m8EJvm5m.js";import"./layerUtils-4EQ207Ij.js";import"./TilemapCache-DrtAz5a3.js";import"./LRUCache-fy84PBMi.js";import"./TileKey-zev9cGPe.js";import"./memoryEstimations-Bd726a_p.js";import"./tagSymbols-BPcGfZon.js";import"./UpdatingHandles-D2RI_3Hb.js";import"./signal-BX9ezF8a.js";import"./Map-DoBsBAGU.js";import"./Basemap-BI8rdNrf.js";import"./loadAll-CleWBL8j.js";import"./PortalItem-QIiqvhel.js";import"./writeUtils-D0J7VXri.js";import"./CollectionFlattener-C1ewYzfL.js";import"./persistable-AW3PLevT.js";import"./MD5-MtSiOt06.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw.js";import"./resourceExtension-3aprB2zB.js";import"./PolygonCollection-BQYUC051.js";import"./mat4f32-Djp3mnm5.js";import"./TablesMixin-MGFFfhKn.js";import"./timeZoneUtils-BSc7-7qA.js";import"./ReactiveMap-B0by2bYu.js";import"./Query-98igen-k.js";import"./Field-Cm_ZejYW.js";import"./fieldType-DVUzXtk_.js";import"./normalizeUtils-BTK6arYa.js";import"./normalizeUtilsCommon-BRJdiLvx.js";import"./utils-uBZTDKaj.js";import"./utils-tSEVTzcz.js";import"./ElevationQuery-C16QuML_.js";import"./TileInfo-fM6eYiPH.js";import"./vec3f32-WCVSSNPR.js";import"./Scheduler-CNrsbccs.js";import"./Indices-D0_UQPPr.js";import"./InterleavedLayout-KZk0acs8.js";import"./types-BKo2foNY.js";import"./VertexElementDescriptor-BlxU8vCE.js";import"./constants-D67WmGms.js";import"./quat-CCdR5JrD.js";import"./quatf64-CCm9z-pX.js";import"./vector-knXISDaK.js";import"./computeTranslationToOriginAndRotation-CTVG2hGD.js";import"./projectVectorToVector-CDqzCeaL.js";import"./frustum-Cq95H2HO.js";import"./floatRGBA-D95YiFWR.js";import"./labelUtils-BtizwBfq.js";import"./ArcadeExpression-BKKJxDUn.js";import"./TimeOnly-DbBUn0Ig.js";import"./enum-BzLwmiID.js";import"./UnknownTimeZone-B697BDFv.js";import"./FieldsIndex-DoTtx8Ak.js";import"./TileKey-C44YQC4_.js";import"./layerViewUtils-BTa15X3o.js";import"./unitConversionUtils-BSQ4LGUO.js";import"./vec2f32-CaVKkSa6.js";import"./dehydratedFeatures-BBoTEZJ8.js";import"./quantizationUtils-BSWXSK29.js";import"./featureConversionUtils-DlTGrdYn.js";import"./OptimizedFeature-CwRGZPwv.js";import"./OptimizedFeatureSet-BR8EEvDc.js";import"./Octree-vaE3elxD.js";import"./elevationInfoUtils-OU8rgnDX.js";import"./HUDIntersectorResult-Ds4yeNc-.js";import"./DefaultLoadingContext-BnNmzeR1.js";import"./wosrLoader-B8RYB0d4.js";import"./Version-BtYZEj58.js";import"./axisAngleDegrees-D1LL0HZb.js";import"./edgePreprocessing-CBVaMT5L.js";import"./config-Dg972SSE.js";import"./GeometryUtils-BUMmi0hw.js";import"./definitions-Dvg4hMIw.js";import"./WorkerHandle-IsvMxqHu.js";import"./colorUtils-CfxFVJbg.js";import"./vec3-B_phcnZY.js";import"./vec33-CWJeyzxV.js";import"./capabilities-Bi6C4OG6.js";import"./imageUtils-DRSdxeif.js";import"./VisualElement-By4iq8p4.js";import"./line-DzJxYxSt.js";import"./videoUtils-Dwx3AEgj.js";import"./meshVertexSpaceUtils-BZiL5Bbc.js";import"./MeshLocalVertexSpace-De2t7DNQ.js";import"./Intersector-BFu7YAUe.js";import"./TriangleMaterial-CuAtcOpx.js";import"./geometry2dUtils-D-hxoYKh.js";import"./rotate-DPvd871g.js";import"./curveOperationUtils-Cq-Vrv9J.js";import"./EngineVisualElement-DBP6v2o3.js";const ct=2,Rs=4,Nt=y(2),Cs=1.5;let Ps=class{constructor(){this.collisionRadius=5,this.fovUnfocusedArcWidth=Rs,this.fovFocusedArcWidth=ct*this.fovUnfocusedArcWidth,this.scaleOrientSize=90,this.scaleOrientHandleRadius=.025,this.scaleOrientMinDistance=1,this.scaleOrientArrowTipLength=.3,this.scaleOrientArrowTipFocusMultiplier=ct/1.5,this.observerSize=5,this.hoverTimeoutMilliseconds=1e3,this.viewAngleThreshold=10}getFovArcWidth(e){return e?this.fovFocusedArcWidth:this.fovUnfocusedArcWidth}getScaleOrientArrowTipLength(e){return this.scaleOrientArrowTipLength*(e?this.scaleOrientArrowTipFocusMultiplier:1)}};const H=new Ps;class Fs{constructor(){this.frameWidthNotSelected=.3,this.frameWidthSelected=1,this.frameColor=new te([255,255,255,.99]),this.observerPointConfiguration={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0,color:te.toUnitRGBA(new te([3,252,111,1]))},this.shapeMaterialParameters={color:[.33,.33,.33,.25],renderOccluded:1,cullFace:2,writeDepth:!1}}}const J=new Fs;function Qe({tiltedUpVector:i,rightVector:e,observerRenderSpace:t},s){const a=Si(i,e,t,s);return a[12]=0,a[13]=0,a[14]=0,a}function Ne(i,e,t,s){const a=u(),r=Ri(t.plane),o=As(e,r);let l;if(Math.abs(o)>H.viewAngleThreshold)l=i.next(tt(e,t.plane));else{const c=It(s.targetRenderSpace,t.basis1,Lt()),p=he(Wt,t.basis1),d=he(Es,t.basis2);l=i.next(tt(e,c)).next(v=>{const m=T=>{const D=ue(F(dt,T,t.origin),d),R=Math.acos(qe(D/s.farDistanceRenderSpace,-1,1)),A=Math.sin(R)*s.farDistanceRenderSpace;return K(u(),t.origin,K(u(),k(dt,p,A),k(Hs,d,D)))},w=m(v.renderStart),f=m(v.renderEnd);return{...v,renderStart:w,renderEnd:f}})}return l.next(c=>{c.action==="start"&&N(a,c.renderStart);const p=me(Di(a,c.renderEnd,t.origin,r));return{...c,deltaAngle:p}})}function As(i,e){const t=Wt;i.renderCoordsHelper.toRenderCoords(i.camera.position,t);const s=oi(i,t,i.camera.heading,i.camera.tilt,Fi()).direction;return me(Ve(s,e))-90}function ee(i,e,t,s){return X(pt,t,s),G(i,e,pt)}const Wt=u(),Es=u(),dt=u(),Hs=u(),pt=S();var We;let g=We=class extends Me{constructor(i){super(i),this.observerRenderSpaceOverride=null,this.needUpdateByFeature=!1}get observer(){return this.viewshed.observer??new ze}get effectiveObserverRenderSpace(){return this.observerRenderSpaceOverride??this.observerRenderSpace}get effectiveObserver(){return this.renderSpaceToPoint(this.effectiveObserverRenderSpace,this.observer.spatialReference)}get effectiveTargetRenderSpace(){return this._computeTargetRenderSpace(this.effectiveObserverRenderSpace)}get farDistance(){return this.viewshed.farDistance}get farDistanceRenderSpace(){return this.farDistance/this.metersPerUnit}get heading(){return this.viewshed.heading}get tilt(){return this.viewshed.tilt}get feature(){return this.viewshed.feature}get tiltParallelToSurface(){return this.tilt-90}get horizontalFieldOfView(){return this.viewshed.horizontalFieldOfView}get verticalFieldOfView(){return this.viewshed.verticalFieldOfView}get observerRenderSpace(){return this._pointToRenderSpace(this.observer,u())}get target(){const i=this.targetRenderSpace;return this.renderSpaceToPoint(i,this.observer.spatialReference)}get targetRenderSpace(){return this._computeTargetRenderSpace(this.observerRenderSpace)}get targetDirection(){const i=F(u(),this.targetRenderSpace,this.observerRenderSpace);return he(i,i)}get tiltedUpVector(){const i=ee(u(),this.upVector,-y(this.tiltParallelToSurface),this.leftVector);return he(i,i)}get _basis(){return this.renderCoordsHelper.basisMatrixAtPosition(this.observerRenderSpace,S())}get upVector(){const i=this._basis;return q(i[8],i[9],i[10])}get northVector(){const i=this._basis;return q(i[4],i[5],i[6])}get leftVector(){const i=this.upVector,e=ee(u(),this.northVector,-y(this.heading),i);return di(e,i,e)}get rightVector(){return Ge(u(),this.leftVector)}clone(){return new We({renderCoordsHelper:this.renderCoordsHelper,viewshed:this.viewshed.clone()})}get valid(){return this.viewshed.valid}get metersPerUnit(){return this.renderCoordsHelper.spatialReference.metersPerUnit}pointOnSphere(i,e,t){const{observerRenderSpace:s,targetRenderSpace:a}=this,r=F(Re,a,s);return ee(r,r,-y(e),this.leftVector),ee(r,r,-y(i),this.tiltedUpVector),K(t,r,s)}cornerPoints(i){const e=this.horizontalFieldOfView/2,t=this.verticalFieldOfView/2;this.pointOnSphere(-e,t,i.topLeft),this.pointOnSphere(e,t,i.topRight),this.pointOnSphere(-e,-t,i.bottomLeft),this.pointOnSphere(e,-t,i.bottomRight)}arcCentersPoints(i){const e=this.horizontalFieldOfView/2,t=this.verticalFieldOfView/2;this.pointOnSphere(0,t,i.top),this.pointOnSphere(0,-t,i.bottom),this.pointOnSphere(-e,0,i.left),this.pointOnSphere(e,0,i.right)}parallelCenterPoints(i){const e=this.observerRenderSpace,t=this.farDistanceRenderSpace*Math.sin(y(this.verticalFieldOfView/2)),s=k(Re,this.tiltedUpVector,t);K(i.top,e,s),F(i.bottom,e,s)}renderSpaceToPoint(i,e){const t=Re;return this.renderCoordsHelper.fromRenderCoords(i,t,e),new ze(t[0],t[1],t[2],e)}_pointToRenderSpace(i,e){const t=vi(i.toArray());return this.renderCoordsHelper.toRenderCoords(t,i.spatialReference,e),e}_computeTargetRenderSpace(i){const{leftVector:e,northVector:t,upVector:s}=this,a=this.farDistanceRenderSpace,r=u();return k(r,t,a),ee(r,r,-y(this.heading),s),ee(r,r,-y(this.tiltParallelToSurface),e),K(r,i,r),r}};n([h()],g.prototype,"renderCoordsHelper",void 0),n([h()],g.prototype,"viewshed",void 0),n([h()],g.prototype,"observerRenderSpaceOverride",void 0),n([h()],g.prototype,"needUpdateByFeature",void 0),n([h()],g.prototype,"observer",null),n([h()],g.prototype,"effectiveObserverRenderSpace",null),n([h()],g.prototype,"effectiveObserver",null),n([h()],g.prototype,"effectiveTargetRenderSpace",null),n([h()],g.prototype,"farDistance",null),n([h()],g.prototype,"farDistanceRenderSpace",null),n([h()],g.prototype,"heading",null),n([h()],g.prototype,"tilt",null),n([h()],g.prototype,"feature",null),n([h()],g.prototype,"tiltParallelToSurface",null),n([h()],g.prototype,"horizontalFieldOfView",null),n([h()],g.prototype,"verticalFieldOfView",null),n([h()],g.prototype,"observerRenderSpace",null),n([h()],g.prototype,"target",null),n([h()],g.prototype,"targetRenderSpace",null),n([h()],g.prototype,"targetDirection",null),n([h()],g.prototype,"tiltedUpVector",null),n([h()],g.prototype,"_basis",null),n([h()],g.prototype,"upVector",null),n([h()],g.prototype,"northVector",null),n([h()],g.prototype,"leftVector",null),n([h()],g.prototype,"rightVector",null),n([h()],g.prototype,"valid",null),n([h()],g.prototype,"metersPerUnit",null),g=We=n([ie("esri.views.3d.analysis.Viewshed.ViewshedComputedData")],g);const Re=u();let zs=class extends Ut{constructor(e){super(),this._handles=new ye,this._tool=e.tool,this._view=e.view,this._focusedArcMaterial=this._createArcMaterial(!0),this._unfocusedArcMaterial=this._createArcMaterial(!1),this._createManipulators(),this.forEachManipulator(t=>this._tool.manipulators.add(t))}destroy(){this._handles=P(this._handles),this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._tool=null,this._view=null,this._manipulators=null}createDragPipeline(e,t){const s=Object.values(this._manipulators);return Pt(s.map(({manipulator:a,side:r})=>_e(a,(o,l,c,p,d)=>{const v=Ns(r,t),m=l.next(f=>({...f,manipulatorType:2,side:r})),w=Ne(m,this._view,v,t);e(o,w,c)})))}updateManipulatorsTransform(e){e.arcCentersPoints(ut),this._forEachManipulatorInfo(t=>this._updateArcManipulatorTransform(t,e,ut[t.side]))}updateManipulatorVisuals(e){this._forEachManipulatorInfo(t=>this._updateArcManipulatorVisuals(t,e))}_updateArcManipulatorVisuals({manipulator:e,side:t},s){const a=[];if(s!=null){const[r,o]=Is(t,s,this._unfocusedArcMaterial);a.push(new re(r,1),new re(r.instantiate({material:this._focusedArcMaterial}),2)),e.collisionType={type:"line",paths:[o]}}e.renderObjects=a,e.radius=H.collisionRadius}_updateArcManipulatorTransform({manipulator:e,side:t},s,a){const r=s.horizontalFieldOfView,o=y(s.verticalFieldOfView/2),l=y(r/2),c=we(t);e.renderLocation=a;const p=S(),d=T=>{Le(p,T,p)};d(be(oe,y(-90))),c||d(Et(oe,o));const v=s.farDistanceRenderSpace;let m,w;d(De(oe,Q(Bt,v,v,v))),d(Ie(oe,js(t))),d(Qe(s,oe)),c?(m=l,w=s.tiltedUpVector):(w=s.rightVector,m=o),m*=t==="right"||t==="bottom"?-1:1;const f=X(oe,m,w);f!=null&&d(f),e.modelTransform=p}_createManipulators(){const e=this._createArcManipulator("left"),t=this._createArcManipulator("right"),s=this._createArcManipulator("top"),a=this._createArcManipulator("bottom");this._manipulators={left:e,right:t,top:s,bottom:a},[[a.manipulator,s.manipulator],[e.manipulator,t.manipulator]].forEach(([r,o])=>{r.metadata={pairedManipulator:o},o.metadata={pairedManipulator:r}})}_createArcManipulator(e){const t=new Se({view:this._view,autoScaleRenderObjects:!1,worldSized:!0}),s={manipulator:t,side:e};return this._updateArcManipulatorVisuals(s),this._handles.add(t.events.on(["focus-changed","grab-changed"],a=>{const r=t.metadata?.pairedManipulator;r!=null&&(r.hovering!==t.hovering&&(r.hovering=t.hovering),r.grabbing!==t.grabbing&&(r.grabbing=t.grabbing))})),s}_createArcMaterial(e){const t=H.getFovArcWidth(e),s=new ni({renderOccluded:4,isDecoration:!0,width:t},this._view.state.isGlobal);return this._handles.add(M(()=>te.toUnitRGBA(this._view.effectiveTheme.accentColor),a=>s.setParameters({color:a}),x)),s}forEachManipulator(e){Object.values(this._manipulators).forEach(({manipulator:t})=>e(t,2))}_forEachManipulatorInfo(e){Object.values(this._manipulators).forEach(t=>e(t))}get test(){return{manipulators:this._manipulators}}};function Is(i,e,t){const{horizontalFieldOfView:s,verticalFieldOfView:a}=e,r=we(i),o=y(qe((r?a:s)/2,0,15)),l=Ls(-o/2,o/2,r?1:Math.max(Math.sin(y(90-a/2)),.1));return[rs(t,l),l]}function Ls(i,e,t,s=10){je(s>1,"createArcPolylineGeometry() needs at least 2 for numVertices");const a=e-i;if(a<=0||t<=0)return[q(0,0,.01),q(0,0,-.01)];const r=[],o=a/s;for(let l=0;l<s;l++){let c=i+l*o;l===s-1&&(c=e);const p=Math.cos(c)*t,d=Math.sin(c)*t,v=q(p-t,0,d);r.push(v)}return r}function Us(i){switch(i){case"left":return 0;case"bottom":return 1;case"right":return 2;case"top":return 3}}function js(i){return Us(i)*Ws}function we(i){return i==="left"||i==="right"}function ks(i){return i==="left"?"right":i==="right"?"left":i==="top"?"bottom":"top"}function Ns(i,{observerRenderSpace:e,targetRenderSpace:t,tiltedUpVector:s,rightVector:a,farDistanceRenderSpace:r}){const o=F(Bt,t,e),l=we(i)?a:s,c=k(Bs,l,r);return Ue(e,o,c)}const Ws=Math.PI/2,oe=S(),Bt=u(),Bs=u(),ut={top:u(),bottom:u(),left:u(),right:u()};let Ce=class extends Se{constructor(e,t){super({view:e,autoScaleRenderObjects:!1,worldSized:!1,radius:H.collisionRadius}),this._handles=new ye,this._setupManipulatorVisual(t)}destroy(){this._handles.remove(),super.destroy()}_setupManipulatorVisual(e){const t=this._createMaterial(),s=1,a=[q(0,0,0),q(0,0,s)],r=rt(t,a,e,16,!1),o=rt(t,a,e*Ke,16,!1),l=vt(!1,t,e),c=vt(!0,t,e),p=S();fe(p,a[a.length-1]),W(p,p,Et(mt,Math.PI/2)),W(p,p,be(mt,Math.PI/2)),l.transformation=p,c.transformation=p,this.renderObjects=[new re(r,1),new re(o,2),new re(l,1),new re(c,2)];const d=q(0,H.getScaleOrientArrowTipLength(!0),0),v=G(d,d,p),m=[...a,v];this.collisionType={type:"line",paths:[m]}}_createMaterial(){const e=new kt({cullFace:2,renderOccluded:4,isDecoration:!0});return this._handles.add(M(()=>te.toUnitRGBA(this.view.effectiveTheme.accentColor),t=>e.setParameters({color:t}),x)),e}};function vt(i,e,t){const s=H.getScaleOrientArrowTipLength(i);let a=2*t;i&&(a*=Ke);const r=s/2;return os(e,s,r,r,a,0)}const mt=S();let Gs=class extends Ut{constructor(e){super(),this._handles=new ye,this._tool=e.tool,this._view=e.view;const t=H.scaleOrientHandleRadius;this._manipulatorHeading=new Ce(this._view,t),this._manipulatorTilt=new Ce(this._view,t),this._manipulatorDistance=new Ce(this._view,t),this.forEachManipulator(s=>this._tool.manipulators.add(s))}destroy(){this._handles.destroy(),this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._manipulatorHeading=null,this._manipulatorTilt=null,this._manipulatorDistance=null,this._tool=null,this._view=null}createHeadingDragPipeline(e,t){return _e(this._manipulatorHeading,(s,a,r,o,l)=>{const c=this._view,{tiltParallelToSurface:p,farDistanceRenderSpace:d,upVector:v,observerRenderSpace:m,targetRenderSpace:w,rightVector:f}=t,T=Math.sin(y(p))*d,D=K(ge,m,k(Pe,v,T)),R=F(Pe,w,D),A=k(qs,f,ve(R)),C=Ue(D,R,A),z=Ne(a,c,C,t).next(I=>({...I,manipulatorType:3}));e(s,z,r)})}createTiltDragPipeline(e,t){return _e(this._manipulatorTilt,(s,a,r,o,l)=>{const{observerRenderSpace:c,farDistanceRenderSpace:p,upVector:d,targetDirection:v}=t,m=ue(v,d),w=pi(ge,v,d,-m);k(w,he(w,w),p);const f=k(Pe,d,p),T=Ue(c,w,f),D=Ne(a,this._view,T,t).next(R=>({...R,manipulatorType:3}));e(s,D,r)})}createDistanceDragPipeline(e,t){return _e(this._manipulatorDistance,(s,a,r,o,l)=>{const c=ps(t.observerRenderSpace,t.targetDirection),p=a.next(cs(this._view,s.location)).next(Pi(this._view,c)).next(d=>({...d,manipulatorType:2}));e(s,p,r)})}updateManipulators(e){const{targetRenderSpace:t}=e;this._manipulatorHeading.renderLocation=t,this._manipulatorTilt.renderLocation=t,this._manipulatorDistance.renderLocation=t;const s=S(),a=d=>{Le(s,d,s)},r=H.scaleOrientSize*(jt/ls);a(De(ce,Q(ge,r,r,r))),a(Qe(e,ce));const o=H.scaleOrientHandleRadius*Ke*r,l=k(ge,e.targetDirection,o);a(fe(ce,l));const c=Ie(ce,-Fe);W(c,c,be(wt,-Fe)),this._manipulatorHeading.modelTransform=W(S(),s,c);const p=be(ce,Fe);W(p,p,Ie(wt,Math.PI)),this._manipulatorTilt.modelTransform=Le(S(),s,p),this._manipulatorDistance.modelTransform=s}forEachManipulator(e){e(this._manipulatorHeading,3),e(this._manipulatorTilt,3),e(this._manipulatorDistance,2)}};const ce=S(),wt=S(),ge=u(),Pe=u(),qs=u(),Fe=Math.PI/2;let Gt=class extends Se{constructor(e,t){super({view:e,autoScaleRenderObjects:!1,worldSized:!1,radius:H.observerSize,interactive:!1}),this._handles=new ye;const s=Oi(this._color);this.renderObjects=[new re(ns(s,H.observerSize,32,32))],t.manipulators.add(this),this._handles.add([M(()=>this._color,a=>{s.setParameters({color:a})},x)])}destroy(){this._handles.remove(),super.destroy()}get _color(){return te.toUnitRGBA(this.view.effectiveTheme.accentColor)}};n([h()],Gt.prototype,"_color",null);const ft=Symbol("dragHandles"),gt=Symbol("hideManipulators"),_t=Symbol("hideFoVManipulators"),Vt=Symbol("hideObserverManipulator");let L=class extends Me{constructor(e){super(e),this._moveManipulation=null,this._observerManipulator=null,this._fieldOfViewManipulation=null,this._scaleOrientManipulation=null,this._forceHoveringTask=null,this._forceHoveringTestPromise=null,this._grabbing=!1,this.viewshedComputedData=null}initialize(){this._moveManipulation=this._createMoveManipulation(),this._fieldOfViewManipulation=new zs({view:this.view,tool:this.parentTool}),this._scaleOrientManipulation=new Gs({view:this.view,tool:this.parentTool}),this._observerManipulator=new Gt(this.view,this.parentTool),this.addHandles([M(()=>this.viewshedComputedData?.observerRenderSpace,t=>{t!=null&&(this._moveManipulation.renderLocation=t,this._observerManipulator.renderLocation=t)},le),M(()=>this.viewshedComputedData?.heading,t=>{t&&(this._moveManipulation.angle=y(90-t))},x),M(()=>{const{viewshedComputedData:t}=this;return{viewshedComputedData:t,observer:t?.observer}},({viewshedComputedData:t,observer:s},a)=>{this._grabbing&&s!==a?.observer||(this.removeHandles(ft),t?.valid&&this.addHandles([this._buildObserverDragPipeline(t),this._buildFOVDragPipeline(t),this._buildScaleOrientDragPipeline(t)].filter(Kt),ft))},x),M(()=>{const t=this.viewshedComputedData;return t?.valid?{viewshedCompData:t,target:t.targetRenderSpace,hFOV:t.horizontalFieldOfView,vFOV:t.verticalFieldOfView}:null},t=>{t!=null&&this._fieldOfViewManipulation.updateManipulatorsTransform(t.viewshedCompData)},x),M(()=>{const t=this.viewshedComputedData;return t?.valid?{viewshedCompData:t,hFOV:t.horizontalFieldOfView,vFOV:t.verticalFieldOfView,tilt:t.tilt}:null},t=>{t!=null&&this._fieldOfViewManipulation.updateManipulatorVisuals(t.viewshedCompData)},x),M(()=>{const t=this.analysisViewData.visible&&(this.viewshedComputedData?.valid??!1),s=this.parentTool.selectedViewshedComputedData===this.viewshedComputedData;return{fovManipulationAvailable:t&&!this.parentTool.isPlacingTarget,nonFOVManipulationAvailable:t&&(!this.parentTool.creating||s)}},({fovManipulationAvailable:t,nonFOVManipulationAvailable:s})=>{this._moveManipulation.available=s,this._scaleOrientManipulation.available=s,this._observerManipulator.available=s,this._fieldOfViewManipulation.available=t},x),M(()=>{const t=this.viewshedComputedData;if(!t?.valid)return null;const{observer:s,target:a,verticalFieldOfView:r,horizontalFieldOfView:o}=t;return{viewshedCompData:t,observer:s,target:a,verticalFieldOfView:r,horizontalFieldOfView:o}},t=>{t!=null&&this._scaleOrientManipulation.updateManipulators(t.viewshedCompData)},x)]);const e=t=>{const s=this.analysisViewData;this.addHandles([t.events.on("focus-changed",()=>{const a=this._someManipulatorHovering();a&&this.parentTool.subToolHandles.forEach(({subTool:r})=>{r._resetHoveringTask()}),this._someManipulatorSelected()||a||(this._forceHoveringTask=ss(async r=>{await(this._forceHoveringTestPromise??Qt(H.hoverTimeoutMilliseconds,r)),Xt(r),this._forceHoveringTask=null,this._updateManipulatorVisibility()}))}),t.events.on("grab-changed",a=>{this._grabbing=a.action==="start",a.action==="end"&&s.tool?.updateInteractionVisualsVisibility(),this.parentTool.subToolHandles.forEach(({subTool:r})=>{r!==this&&r._setInteractive(!this._grabbing)}),this._setInteractive(r=>r.hasManipulator(t)||!this._grabbing)}),t.events.on("drag",a=>{a.action==="start"&&s.tool?.updateInteractionVisualsVisibility()})])};this._forEachManipulator(e)}destroy(){this._forceHoveringTask=He(this._forceHoveringTask),this._moveManipulation=P(this._moveManipulation),this._fieldOfViewManipulation=P(this._fieldOfViewManipulation),this._scaleOrientManipulation=P(this._scaleOrientManipulation),this.parentTool.manipulators.remove(this._observerManipulator),this._observerManipulator=P(this._observerManipulator)}get viewshed(){return this.viewshedComputedData?.viewshed}get grabbing(){return this._grabbing}get observer(){return this.viewshed?.observer}set observer(e){const t=this.viewshed;t!=null&&(t.observer=e)}get discManipulator(){return this._moveManipulation.xyManipulation.discManipulator}get moveInteractionState(){const{dragging:e,grabbing:t}=this._moveManipulation;return{dragging:e,grabbing:t}}get scaleOrientInteractionState(){const{dragging:e,grabbing:t}=this._scaleOrientManipulation;return{dragging:e,grabbing:t}}_setInteractive(e){const t=typeof e=="boolean";this._forEachManipulation(s=>s.interactive=t?e:e(s))}onManipulatorSelectionChanged(){this._updateManipulatorVisibility(),!this._someManipulatorSelected()&&(this.analysisViewData.selectedViewshed===this.viewshed&&(this.analysisViewData.selectedViewshed=null),this._resetHoveringTask())}hasManipulator(e){let t=!1;return this._forEachManipulator(s=>{t=t||s===e}),t}_someManipulatorSelected(){return this._moveManipulation.selected||this._fieldOfViewManipulation.selected||this._scaleOrientManipulation.selected}_someManipulatorHovering(){return this._moveManipulation.hovering||this._fieldOfViewManipulation.hovering||this._scaleOrientManipulation.hovering}_createMoveManipulation(){return new hs({view:this.view,tool:this.parentTool,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:jt})}_buildObserverDragPipeline(e){const t={mode:"absolute-height",offset:0},s=e.observer;if(s==null)return null;const a=this.view.spatialReference;return this._moveManipulation.createDragPipeline((r,o,l,c,p)=>{c=c.next($e(this,["observer"]));const d=fi(s,a);if(d==null)return{steps:l,cancel:c};const v=vs.fromGeometry(d,li(this.view.viewingMode));return{steps:l.next(ds({operations:v})).next(m=>(this.observer=v.data.geometry,m)),cancel:c}},t,a,void 0)}_buildFOVDragPipeline(e){let t=0,s=0;return this._fieldOfViewManipulation.createDragPipeline((a,r,o)=>{if(e==null)return{steps:r,cancel:o};const l=e.viewshed;let c=null;return o=o.next($e(l,["horizontalFieldOfView","verticalFieldOfView"])),{steps:r.next(p=>{p.action==="start"&&(c=null,t=e.horizontalFieldOfView,s=e.verticalFieldOfView);const d=p.deltaAngle;if(c==null&&d!==0){const w=p.side==="bottom"||p.side==="left"?d>0:d<0;c=we(p.side)?t===0&&w||t===360&&!w:s===0&&w}const v=c?ks(p.side):p.side;let m=0;switch(v){case"left":m=t/2-d;break;case"right":m=t/2+d;break;case"top":m=s+2*d;break;case"bottom":m=s-2*d}return we(v)?(m=at.normalize(m),m=m>270?0:m>180?180:m,l.horizontalFieldOfView=2*m):l.verticalFieldOfView=m,p}),cancel:o}},e)}_buildScaleOrientDragPipeline(e){let t=0,s=0;const a=(r,o)=>(l,c,p)=>{if(e==null)return{steps:c,cancel:p};const d=e.viewshed;return p=p.next($e(d,[r])),{steps:c=c.next(o(d,e)),cancel:p}};return Pt([this._scaleOrientManipulation.createHeadingDragPipeline(a("heading",(r,o)=>l=>(l.action==="start"&&(s=e.heading),r.heading=at.normalize(s+l.deltaAngle),l)),e),this._scaleOrientManipulation.createTiltDragPipeline(a("tilt",(r,o)=>l=>{l.action==="start"&&(t=e.tilt);let c=t+l.deltaAngle;return c<-90?c=180:c>270&&(c=0),r.tilt=Qs.clamp(c),l}),e),this._scaleOrientManipulation.createDistanceDragPipeline(a("farDistance",(r,o)=>l=>{const c=F(Ks,l.renderEnd,o.observerRenderSpace),p=ve(c)*o.metersPerUnit,d=ue(c,o.targetDirection)<0?H.scaleOrientMinDistance:p;return r.farDistance=d,l}),e)])}_updateManipulatorVisibility(){const e=this._someManipulatorSelected(),t=this._forceHoveringTask!=null||this._someManipulatorHovering(),s=this._fieldOfViewManipulation.hovering,a=this.parentTool.creating;let r=[];const o=l=>{r.push(l.disableDisplay())};e||!a&&t?this.removeHandles(gt):(this._scaleOrientManipulation.forEachManipulator(o),this._moveManipulation.forEachManipulator(o),this.addHandles(r,gt),r=[]),e||!a&&t||a&&s?this.removeHandles(_t):(this._fieldOfViewManipulation.forEachManipulator(o),this.addHandles(r,_t)),e||!a?this.removeHandles(Vt):this.addHandles(this._observerManipulator.disableDisplay(),Vt)}_resetHoveringTask(){this._forceHoveringTask=He(this._forceHoveringTask),this._updateManipulatorVisibility()}_forEachManipulator(e){this._forEachManipulation(t=>{t.forEachManipulator(e)}),e(this._observerManipulator)}_forEachManipulation(e){e(this._moveManipulation),e(this._fieldOfViewManipulation),e(this._scaleOrientManipulation)}get test(){return{moveManipulation:this._moveManipulation,fieldOfViewManipulation:this._fieldOfViewManipulation,scaleOrientManipulation:this._scaleOrientManipulation,viewshedComputedData:this.viewshedComputedData,setHoveringTimeoutPromise:e=>{this._forceHoveringTestPromise=e}}}};n([h({constructOnly:!0})],L.prototype,"analysis",void 0),n([h({constructOnly:!0})],L.prototype,"analysisViewData",void 0),n([h({constructOnly:!0})],L.prototype,"parentTool",void 0),n([h({constructOnly:!0,nonNullable:!0})],L.prototype,"view",void 0),n([h()],L.prototype,"viewshed",null),n([h()],L.prototype,"_grabbing",void 0),n([h()],L.prototype,"grabbing",null),n([h()],L.prototype,"viewshedComputedData",void 0),n([h()],L.prototype,"observer",null),L=n([ie("esri.views.3d.analysis.Viewshed.ViewshedSubTool")],L);const Ks=u(),Qs=new as(0,180),Ae=Symbol("interactionVisuals");let O=class extends _s{constructor(i){super(i),this.removeIncompleteOnCancel=!1,this.automaticManipulatorSelection=!1,this._stagedViewshed=null,this._stagedViewshedComputedData=null,this._placementMode=yt,this._creationState=!1,this._interactionVisualElements=null,this._settings=new ms({getTheme:()=>this.view.effectiveTheme}),this._selectedManipulator=null}initialize(){this._intersector=Ms(this.view.state.viewingMode),this._createInteractionVisuals();const i=this.analysisViewData.viewshedComputedDataHandles;this.subToolHandles=Be(()=>i,({viewshedComputedData:e})=>{const t=new L({analysis:this.analysis,analysisViewData:this.analysisViewData,parentTool:this,view:this.view,viewshedComputedData:e});return{subTool:t,remove:()=>{this.selectedViewshed===e.viewshed&&(this.selectedViewshed=null),t.destroy()}}}),this.addHandles([pe(()=>this._valid,()=>this.finishToolCreation(),le),M(()=>this._stagedViewshed,e=>{const t=this.analysisViewData.viewshedComputedDataHandles;this._stagedViewshedComputedData=e!=null&&t!=null?this._findSubTool(e)?.viewshedComputedData:null},le),this.analysis.viewsheds.on("after-remove",e=>{const t=this._stagedViewshed;t!=null&&e.item===t&&this.analysis.viewsheds.add(t)}),M(()=>this.firstGrabbedManipulator,e=>{if(e!=null){const t=this._findSubTool(e)?.viewshed;this.selectedViewshed=t,this._selectManipulator(e)}else this._selectedSubTool?.onManipulatorSelectionChanged()},Ft),M(()=>this.view.activeTool,e=>{e!==this&&e!=null&&(this.selectedViewshed=null)}),pe(()=>{const e=this.selectedViewshedComputedData;return e==null?null:{subTool:this._selectedSubTool,observer:e.observerRenderSpace,target:e.targetRenderSpace}},e=>{const{subTool:t,observer:s,target:a}=e;t?.moveInteractionState.dragging?this._updateInteractionVisualsLocation(s,!0):t?.scaleOrientInteractionState.dragging&&this._updateInteractionVisualsLocation(a,!1)},x),M(()=>this.creating,()=>this.updateInteractionVisualsVisibility()),M(()=>this.selectedViewshed,e=>{const t=this._selectedManipulator,s=this._selectedSubTool;e==null?this._selectManipulator(null):t!=null&&s.hasManipulator(t)||this._selectManipulator(s.discManipulator)},x)])}destroy(){this.subToolHandles=P(this.subToolHandles),this.removeHandles(Ae)}onDeactivate(){this.removeStaged(),this._creationState=!1}get _valid(){return this.analysisViewData.viewshedComputedDataHandles?.some(i=>i.viewshedComputedData.valid)??!1}get cursor(){return this.creating?"crosshair":null}get _selectedSubTool(){return this._findSubTool(this.selectedViewshed)}_selectManipulator(i){const e=this._selectedManipulator;e!==i&&(this._selectedManipulator=i,e!=null&&(e.selected=!1),i!=null&&(i.selected=!0),this._findSubTool(e)?.onManipulatorSelectionChanged(),this._selectedSubTool?.onManipulatorSelectionChanged())}get selectedViewshed(){return this.analysisViewData.selectedViewshed}set selectedViewshed(i){this.analysisViewData.selectedViewshed=i}get selectedViewshedComputedData(){return this._selectedSubTool?.viewshedComputedData}get stagedViewshed(){return this._stagedViewshed}get grabbing(){return this.subToolHandles.some(({subTool:i})=>i.grabbing)}get creating(){return this._creationState&&this.active}get isPlacingTarget(){return this._creationState==="placing-target"}place(i){this.selectedViewshed=null,this._placementMode=i,this._creationState="placing-observer",this._finishToolCreationIfValid()}onManipulatorSelectionChanged(){this.subToolHandles.forEach(i=>i.subTool.onManipulatorSelectionChanged())}onInputEvent(i){switch(i.type){case"immediate-double-click":this._doubleClickHandler(i);break;case"pointer-move":this._pointerMoveHandler(i);break;case"key-down":Je.cancel===i.key?this._cancelKeyHandler(i):Je.delete.includes(i.key)&&this._deleteKeyHandler();break;case"hold":this.updateInteractionVisualsVisibility(!0)}}onInputEventAfter(i){i.type==="immediate-click"&&this._clickPlacementHandler(i)}onActivate(){this._placementMode=yt}_clickPlacementHandler(i){if(!this.creating||this.hasFocusedManipulators)return;const e=this._intersectScreen(i,Mt);if(e!=null){if(this._creationState==="placing-observer"){e.mapPoint.z=(e.mapPoint.z??0)+Cs;const t=new is({observer:e.mapPoint.clone(),feature:e.feature});this.analysis.viewsheds.add(t),this._stagedViewshed=t,this._creationState="placing-target",this._updateStagedViewshed(e.scenePoint)}else if(this._creationState==="placing-target"){this._updateStagedViewshed(e.scenePoint);const t=this._stagedViewshed;this._stagedViewshed=null,this._placementMode==="multiple"?this._creationState="placing-observer":(this._creationState=!1,this._stagedViewshed=null,this._finishToolCreationIfValid(),this.view.activeTool=null),this.selectedViewshed=t}i.stopPropagation()}}_doubleClickHandler(i){this.creating&&(this.removeStaged(),this._creationState=!1,this.view.activeTool=null,i.stopPropagation())}_pointerMoveHandler(i){if(!this.creating)return;const e=this._intersectScreen(i,Mt);e!=null&&(this._updateInteractionVisualsLocation(e.scenePoint,!1),this._updateStagedViewshed(e.scenePoint))}_cancelKeyHandler(i){this.creating?this._onCancelWhileCreating(i):this.grabbing||(this.selectedViewshed=null,i.stopPropagation())}_onCancelWhileCreating(i){const e=this.removeStaged();this._finishToolCreationIfValid(),e?(this._creationState="placing-observer",this.selectedViewshed=null,this._placementMode==="multiple"&&i.stopPropagation()):this._creationState=!1}_deleteKeyHandler(){this.creating&&(this.removeStaged(),this._creationState="placing-observer"),this.selectedViewshed!=null&&this.analysis.viewsheds.remove(this.selectedViewshed)}_finishToolCreationIfValid(){this._valid&&this.finishToolCreation()}_updateStagedViewshed(i){const e=this._stagedViewshed,t=this._stagedViewshedComputedData;if(e==null||t==null)return;const{heading:s,tilt:a,farDistance:r}=Xs(this.view,t,i);e.farDistance=r,e.tilt=a,e.heading=s}removeStaged(){const i=this._stagedViewshed;return i!=null&&(this._stagedViewshed=null,this.analysis.viewsheds.remove(i),!0)}_intersectScreen(i,e){const t=hi(i);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(t,this._intersector);const s=this._intersector.results.min,a=e.scenePoint;if(!s.getIntersectionPoint(a))return null;const r=e.mapPoint;return r.spatialReference=this.view.spatialReference,this.view.renderCoordsHelper.fromRenderCoords(a,r),r==null?null:(e.feature=gs(s,this.view),e)}_createInteractionVisuals(){this.removeHandles(Ae);const i=this._settings.visualElements,e=new fs({view:this.view,attached:!1,style:{glowWidth:i.heightPlane.glowWidth,innerWidth:i.heightPlane.innerWidth},isDecoration:!0}),t=new ws({view:this.view,extensionType:i.zVerticalLine.extensionType,attached:!1,innerWidth:1,writeDepthEnabled:!1,renderOccluded:4,isDecoration:!0});this._interactionVisualElements={laserline:e,verticalLine:t},this.addHandles([M(()=>i.zVerticalLine,s=>s.apply(t),le),M(()=>i.heightPlane,s=>s.apply(e),le),Yt(()=>{e.destroy(),t.destroy(),this._interactionVisualElements=null})],Ae)}updateInteractionVisualsVisibility(i=!1){const e=this.creating,t=this.analysisViewData.visible,s=this._selectedSubTool,a=this.selectedViewshedComputedData,r=(v,m)=>{const w=this._interactionVisualElements;w!=null&&(w.verticalLine.attached=m,w.laserline.attached=v)};if(e)return void r(t,!1);if(s==null||a==null)return void r(!1,!1);const o=s.moveInteractionState,l=i?o.grabbing:o.dragging,c=s.scaleOrientInteractionState,p=i?c.grabbing:c.dragging,d=t&&(l||p);if(r(d,l),d){const v=l?a.observerRenderSpace:a.targetRenderSpace;this._updateInteractionVisualsLocation(v,l)}}_updateInteractionVisualsLocation(i,e){const t=this._interactionVisualElements;if(t==null)return;const{laserline:s,verticalLine:a}=t;s.heightManifoldTarget=i,s.intersectsWorldUpAtLocation=e?i:null,i!=null&&a.setStartEndFromWorldDownAtLocation(i)}_findSubTool(i){if(i==null)return null;const e=i instanceof Se?t=>t.subTool.hasManipulator(i):t=>t.subTool.viewshed===i;return this.subToolHandles?.find(e)?.subTool}get test(){}};function Xs(i,e,t){const s=e.observerRenderSpace,a=F(Ys,t,s),r=ve(a)*e.metersPerUnit,o=i.renderCoordsHelper.basisMatrixAtPosition(s,ea),l=Q(Js,o[8],o[9],o[10]),c=It(s,l,ta),p=Ci(c,t,Zs),d=F(p,p,s),v=(ve(d)<1e-4?90:me(Ve(a,d)))*(ue(l,a)<0?-1:1)+90,m=Q(bt,o[4],o[5],o[6]),w=me(Ve(m,d)),f=Q(bt,o[0],o[1],o[2]);return{heading:ue(d,f)<0?360-w:w,tilt:v,farDistance:r}}n([h({constructOnly:!0})],O.prototype,"view",void 0),n([h()],O.prototype,"analysisViewData",void 0),n([h()],O.prototype,"removeIncompleteOnCancel",void 0),n([h()],O.prototype,"automaticManipulatorSelection",void 0),n([h({constructOnly:!0})],O.prototype,"analysis",void 0),n([h()],O.prototype,"subToolHandles",void 0),n([h()],O.prototype,"_stagedViewshed",void 0),n([h()],O.prototype,"_stagedViewshedComputedData",void 0),n([h()],O.prototype,"_placementMode",void 0),n([h()],O.prototype,"_creationState",void 0),n([h()],O.prototype,"_valid",null),n([h({readOnly:!0})],O.prototype,"cursor",null),n([h()],O.prototype,"_selectedManipulator",void 0),n([h()],O.prototype,"_selectedSubTool",null),n([h()],O.prototype,"selectedViewshed",null),n([h()],O.prototype,"selectedViewshedComputedData",null),n([h()],O.prototype,"stagedViewshed",null),n([h()],O.prototype,"grabbing",null),n([h()],O.prototype,"creating",null),n([h()],O.prototype,"isPlacingTarget",null),O=n([ie("esri.views.3d.analysis.Viewshed.ViewshedTool")],O);const Ys=u(),Js=u(),Zs=u(),bt=u(),ea=S(),ta=Lt(),Mt={mapPoint:new ze,scenePoint:u(),feature:null},yt="multiple";let ia=class extends Ti{constructor(e){super(e),this._material=null,this._viewshedComputedData=null,this._material=new kt({...J.shapeMaterialParameters,isDecoration:this.isDecoration,writeDepth:!1}),this.applyProperties(e)}get viewshedComputedData(){return this._viewshedComputedData}set viewshedComputedData(e){this._viewshedComputedData=e,this.updateTransform()}updateTransform(){const e=this._viewshedComputedData;if(e==null)return;const t=S(),s=e.farDistanceRenderSpace;De(t,q(s,s,s)),Qe(e,de),W(t,de,t),fe(de,this._viewshedComputedData.observerRenderSpace),W(t,de,t),this.transform=t}createExternalResources(){}destroyExternalResources(){}forEachMaterial(e){e(this._material)}createGeometries(e){const{_material:t,viewshedComputedData:s}=this;s==null||t==null||!s.valid||sa(t,s).forEach(a=>e.addGeometry(a))}};function sa(i,e){const{horizontalFieldOfView:t,verticalFieldOfView:s}=e,a=Q(aa,0,0,1),r=Q(Dt,0,1,0),o=Q(Ot,1,0,0);ee(a,a,y(s/2),r),ee(a,a,y(t/2),o);const l=b=>Math.ceil(Math.abs(b)/Nt)+1,c=y(t),p=N(ra,o),d=l(c),v=St(-c/(d-1)),m=X(de,v,p),w=y(-s),f=l(w),T=St(w/(f-1)),D=N(Dt,r),R=X(Tt,y(t)/2,o);G(D,D,R);const A=Tt,C=[],z=N(Ot,a);for(let b=0;b<d;b++){X(A,T,D);for(let _=0;_<f;_++){const V=3*(_*d+b);C[V]=z[0],C[V+1]=z[1],C[V+2]=z[2],G(z,z,A)}G(D,D,m),G(a,a,m),N(z,a)}const I=d*f;C[3*I]=0,C[3*I+1]=0,C[3*I+2]=0;const B=[];for(let b=0;b<d-1;b++)for(let _=0;_<f-1;_++){const V=6*(_*(d-1)+b);B[V]=_*d+b,B[V+1]=(_+1)*d+b,B[V+2]=_*d+b+1,B[V+3]=_*d+b+1,B[V+4]=(_+1)*d+b,B[V+5]=(_+1)*d+b+1}const Y=[B];if(t!==360&&s!==0){const b=[],_=[];for(let V=0;V<f-1;V++){const $=3*V;b[$]=I,b[$+1]=(V+1)*d,b[$+2]=V*d,_[$]=I,_[$+1]=V*d+d-1,_[$+2]=(V+1)*d+d-1}Y.push(b,_)}if(s!==180&&t!==0){const b=[],_=[];for(let V=0;V<d-1;V++){const $=3*V;b[$]=I,b[$+1]=V,b[$+2]=V+1,_[$]=I,_[$+1]=V+(f-1)*d+1,_[$+2]=V+(f-1)*d}Y.push(b,_)}return Y.map(b=>{const _=[["position",new ys(C,b,3,!0)]];return new Ai(i,_)})}function St(i){return isNaN(i)?1:i}const aa=u(),Dt=u(),Ot=u(),ra=u(),de=S(),Tt=S();let U=class extends Me{constructor(i){super(i),this.visible=!0,this._viewshedCorners={topLeft:u(),topRight:u(),bottomLeft:u(),bottomRight:u()},this._arcCenterPoints={top:u(),bottom:u(),left:u(),right:u()},this._parallelCenters={top:u(),bottom:u()}}initialize(){const i={view:this.view,isDecoration:!0},e={...i,color:this._color,renderOccluded:4},t={...e,stipplePattern:Ds(2)};this._observerVisualElement=new Ss({...i,...J.observerPointConfiguration}),this._shapeVisualElement=new ia({...i,isDecoration:this.isDecoration}),this._frameLinesVisualElement=new se(e),this._leftArcVisualElement=new se(e),this._rightArcVisualElement=new se(e),this._topArcVisualElement=new se(e),this._bottomArcVisualElement=new se(e),this._centralLongitude=new se(t),this._centralLatitude=new se(t),this.addHandles([M(()=>{const s=this.viewshedComputedData;if(!s?.valid)return null;const a=this._viewshedCorners,r=this._arcCenterPoints,o=this._parallelCenters;return s.cornerPoints(a),s.arcCentersPoints(r),s.parallelCenterPoints(o),{viewshedComputedData:s,corners:a,arcCenters:r,parallelCenters:o,interactive:this.analysisViewData.interactive,selected:this._selected}},s=>{const a=s!=null;this._forEachVisualElement(r=>r.attached=a),a&&this._updateVisualElements(s)},{initial:!0,equals:Jt}),M(()=>{const{viewshedComputedData:s}=this,{horizontalFieldOfView:a,verticalFieldOfView:r}=s??{};return{viewshedComputedData:s,horizontalFieldOfView:a,verticalFieldOfView:r}},({viewshedComputedData:s})=>{const{_shapeVisualElement:a}=this;s!==a.viewshedComputedData&&(a.viewshedComputedData=s),this._shapeVisualElement.recreateGeometry()},x),M(()=>{const{interactive:s}=this.analysisViewData;return{visible:this.visible,selected:s&&this._selected,staged:s&&this._staged,horFovNot360:this.viewshedComputedData?.horizontalFieldOfView!==360}},({visible:s,selected:a,staged:r,horFovNot360:o})=>{const l=a||r;this._shapeVisualElement.visible=s,this._topArcVisualElement.visible=s,this._bottomArcVisualElement.visible=s,this._frameLinesVisualElement.visible=s&&o;const c=s&&(a||o);this._leftArcVisualElement.visible=c,this._rightArcVisualElement.visible=c,this._forEachLineVisualElement(p=>{p.width=l?J.frameWidthSelected:J.frameWidthNotSelected,p.renderOccluded=a?4:1}),[this._centralLatitude,this._centralLongitude].forEach(p=>{p.width=2*(l?J.frameWidthSelected:J.frameWidthNotSelected),p.visible=s&&a})},x),M(()=>{const{analysisViewData:{interactive:s,tool:a},_selected:r,visible:o}=this,l=this.view.activeTool,c=!a?.active&&l instanceof O&&l.creating;return{observerVisible:o&&!r&&(!s||(a?.creating??!1)||c),color:this._color}},({observerVisible:s,color:a})=>{this._observerVisualElement.visible=s,this._forEachLineVisualElement(r=>r.color=a)},x)])}get _color(){const{viewshedComputedData:i,_selected:e,analysisViewData:t}=this;if(i==null)return te.toUnitRGBA(J.frameColor);const s=t.tool?.active||t.interactive,a=i.viewshed===t.tool?.stagedViewshed,r=s&&(e||a)?this.view.effectiveTheme.accentColor:J.frameColor;return te.toUnitRGBA(r)}get _selected(){const{viewshedComputedData:i,analysisViewData:{selectedViewshedComputedData:e}}=this;return i!=null&&i===e}get _staged(){const{analysisViewData:{tool:i},viewshedComputedData:e}=this;return i!=null&&i.creating&&i.stagedViewshed===e?.viewshed}destroy(){this._observerVisualElement=P(this._observerVisualElement),this._shapeVisualElement=P(this._shapeVisualElement),this._frameLinesVisualElement=P(this._frameLinesVisualElement),this._leftArcVisualElement=P(this._leftArcVisualElement),this._rightArcVisualElement=P(this._rightArcVisualElement),this._topArcVisualElement=P(this._topArcVisualElement),this._bottomArcVisualElement=P(this._bottomArcVisualElement),this._centralLongitude=P(this._centralLongitude),this._centralLatitude=P(this._centralLatitude)}_forEachLineVisualElement(i){[this._frameLinesVisualElement,this._leftArcVisualElement,this._rightArcVisualElement,this._topArcVisualElement,this._bottomArcVisualElement,this._centralLatitude,this._centralLongitude].forEach(i)}_forEachVisualElement(i){this._forEachLineVisualElement(i),i(this._observerVisualElement),i(this._shapeVisualElement)}_updateVisualElements(i){const{viewshedComputedData:e,corners:t,arcCenters:s,parallelCenters:a}=i,r=At(e.observerRenderSpace);this._observerVisualElement.geometry=e.observer,this._shapeVisualElement.updateTransform(),this._updateFrameLines(r,t),this._updateFrameArcs(e,t,a),this._updateCentralHelperArcs(e,s)}_updateFrameLines(i,e){this._frameLinesVisualElement.geometry=[[i,e.topLeft],[i,e.topRight],[i,e.bottomLeft],[i,e.bottomRight]]}_updateFrameArcs(i,e,t){const{observerRenderSpace:s,rightVector:a,horizontalFieldOfView:r,tiltedUpVector:o}=i,l=y(r),c=u(),p=S();X(p,l/2,o),G(c,a,p),ne(this._leftArcVisualElement,s,e.bottomLeft,e.topLeft,"forward",c),X(p,-l/2,o),Q(c,0,0,0),G(c,a,p),ne(this._rightArcVisualElement,s,e.bottomRight,e.topRight,"forward",c);const d=r>180?"backward":"forward";ne(this._topArcVisualElement,t.top,e.topRight,e.topLeft,d,o),ne(this._bottomArcVisualElement,t.bottom,e.bottomRight,e.bottomLeft,d,o)}_updateCentralHelperArcs(i,e){const t=i.observerRenderSpace,s=i.horizontalFieldOfView>=180?"backward":"forward";ne(this._centralLatitude,t,e.right,e.left,s,i.tiltedUpVector),ne(this._centralLongitude,t,e.top,e.bottom,"forward",i.leftVector)}get test(){}};function ne(i,e,t,s,a,r,o=Nt){const l=u();F(l,t,e);const c=ve(l),p=u();F(p,s,e),he(p,p),k(p,p,c);let d=Ve(l,p);const v=At(r);a==="backward"&&(Ge(v,v),d=-(2*Math.PI-d));const m=[],w=Math.ceil(Math.abs(d)/o),f=S();X(f,d/w,v);const T=u();N(T,l);const D=u();N(D,t);for(let R=0;R<w;R++){const A=u();N(A,D),G(T,T,f),K(D,e,T);const C=u();N(C,D),m.push([A,C])}i.geometry=m}n([h()],U.prototype,"view",void 0),n([h({constructOnly:!0})],U.prototype,"isDecoration",void 0),n([h()],U.prototype,"analysisViewData",void 0),n([h()],U.prototype,"viewshedComputedData",void 0),n([h()],U.prototype,"visible",void 0),n([h()],U.prototype,"_color",null),n([h()],U.prototype,"_selected",null),n([h()],U.prototype,"_staged",null),U=n([ie("esri.views.3d.analysis.Viewshed.ViewshedSubVisualization")],U);let ae=class extends Me{get visible(){return this.analysisViewData.visible}constructor(i){super(i)}initialize(){const i=this.analysisViewData,e=Be(()=>this.analysisViewData.viewshedComputedDataHandles,({viewshedComputedData:t})=>{const s=new U({view:this.view,viewshedComputedData:t,analysisViewData:i,isDecoration:this.isDecoration});return{visualization:s,remove:()=>s.destroy()}});this._subVisualizations=e,this.addHandles([Zt(e),M(()=>this.visible,t=>this._subVisualizations.forEach(({visualization:s})=>s.visible=t),x)])}get test(){}};n([h({constructOnly:!0})],ae.prototype,"analysisViewData",void 0),n([h({constructOnly:!0,nonNullable:!0})],ae.prototype,"view",void 0),n([h({constructOnly:!0})],ae.prototype,"isDecoration",void 0),n([h()],ae.prototype,"visible",null),ae=n([ie("esri.views.3d.analysis.Viewshed.ViewshedVisualization")],ae);let Z=class extends Ei{constructor(){super(...arguments),this.sectionAngles=Os()}get sectionAnglesDeg(){return nt(this.sectionAngles.map(e=>me(e)))}set sectionAnglesDeg(e){this.sectionAngles=nt(e.map(t=>y(t)))}get projectionMatrix(){return W(S(),this.sectionMatrix,this._projectionMatrixInternal)}get sectionMatrix(){const e=this.sectionAngles[0],t=this.sectionAngles[1],s=this.sectionAngles[2],a=this.sectionAngles[3];je(e<=t),je(s<=a);const r=2*Math.tan(this.fovX/2),o=2*Math.tan(this.fovY/2),l=Math.tan(e),c=Math.tan(t),p=Math.tan(s),d=c-l,v=Math.tan(a)-p,m=r/d,w=o/v,f=-(l+d/2)/r*2,T=-(p+v/2)/o*2,D=S();fe(D,[f,T,0]);const R=S();De(R,[m,w,1]);const A=S();return W(A,R,D)}get _sectionRatioX(){const e=Math.tan(this.sectionAngles[0]),t=Math.tan(this.sectionAngles[1]),s=2*Math.tan(this.fovX/2);return Math.min(1,(t-e)/s)}setViewport(e,t){const s=t*this._sectionRatioX;return this.viewport=[e[0],e[1],s,t],s}};n([h()],Z.prototype,"sectionAngles",void 0),n([h()],Z.prototype,"sectionAnglesDeg",null),n([h()],Z.prototype,"projectionMatrix",null),n([h()],Z.prototype,"sectionMatrix",null),n([h()],Z.prototype,"_sectionRatioX",null),Z=n([ie("esri.views.3d.webgl-engine.lib.ViewshedFaceCamera")],Z);class oa{constructor(){this.textureSizeQuality=1,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.textureSizeMultiple=128,this.toleranceSides=5,this.toleranceBottomTop=10}textureSizeModifier(e){const t=e?this.textureSizeModHighQuality:this.textureSizeModLowQuality;return this.textureSizeQuality*t}textureResizeModulo(e){return Math.ceil(e/this.textureSizeMultiple)*this.textureSizeMultiple}}const $t=["front","left","right","back","top","bottom"];function na(i){return!["top","bottom"].includes(i)}class la{constructor(e){this._fbos=e,this._faces={},this._width=0,this._height=0,this.settings=new oa,this._maxTextureSize=Math.min(ei("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}get depthTexture(){return this._handle?.getTexture(lt)}get ready(){return this.depthTexture!=null&&this._width!==0&&this._height!==0}get nearFar(){const e=this.faces;return e.length===0?null:e[0].nearFar}get numActiveFaces(){const e=this._faces;let t=0;return Object.keys(e).forEach(s=>{e[s]&&(t+=1)}),t}get faces(){const e=this._faces,t=[];for(const s of $t){const a=e[s];a&&t.push(a)}return t}get atlasRegions(){return this.faces.map(e=>[e.x/this._width,(e.x+e.width)/this._width,e.y/this._height,(e.y+e.height)/this._height])}get viewshedProjectionMatrices(){return this.faces.map(e=>e.projectionMatrix)}get viewshedViewMatrices(){return this.faces.map(e=>e.viewMatrix)}_setupFaceCamera(e,t,s,a){const{effectiveObserverRenderSpace:r,tiltedUpVector:o,targetRenderSpace:l,farDistanceRenderSpace:c,horizontalFieldOfView:p,verticalFieldOfView:d}=t,v=u();F(v,l,r);const m=u(),w=u(),f=(_,V)=>{const $=u(),Ye=S();return X(Ye,_,V),G($,v,Ye),K($,r,$),$};let T,D=o;const R=Math.min(90,p),A=Math.min(90,Math.max(0,(p-90)/2));let C=-45,z=45,I=-45,B=45;if(na(e)){const _=V=>qe(V,-45,45);I=_(-d/2)-this.settings.toleranceBottomTop,B=_(+d/2)+this.settings.toleranceBottomTop}switch(e){case"front":T=l,C=-R/2,z=R/2;break;case"left":T=f(Math.PI/2,o),C=45-A;break;case"right":T=f(-Math.PI/2,o),z=-45+A;break;case"top":T=K(m,r,o),D=Ge(w,v);break;case"bottom":T=F(m,r,o),D=v;break;case"back":T=f(Math.PI,o)}const Y=new Z({center:T,eye:r,up:D,far:c});Y.sectionAnglesDeg=[C-this.settings.toleranceSides,z+this.settings.toleranceSides,I,B],Y.fovY=Math.PI/2;const b=Y.setViewport(s,a);return this._faces[e]=Y,b}isActive(e){return this._computeActiveFaces(e).size>0}_computeActiveFaces(e){const t=new Set,{horizontalFieldOfView:s,verticalFieldOfView:a}=e,r=-a/2,o=a/2;return s===0||a===0||(r<=45&&o>=-45&&t.add("front"),s>90&&(t.add("left"),t.add("right")),s>270&&t.add("back"),o>45-this.settings.toleranceBottomTop&&t.add("top"),r<-45+this.settings.toleranceBottomTop&&t.add("bottom")),t}_computeBaseTextureSize({pixelRatio:e,fullWidth:t,fullHeight:s},a,r,o){const l=a/e,c=this.settings.textureSizeModifier(r);return Hi(Math.max(t,s)*l*c,this._maxTextureSize/o)}_ensureFBO(e){const t=this._width,s=this._height,a=this._handle?.fbo;a&&a.width===t&&a.height===s&&e===zi(a.depthStencilTexture?.descriptor?.internalFormat??Ts.DEPTH_COMPONENT16)||(this._handle?.release(),this._handle=this._allocateFBO(e))}_allocateFBO(e){const{_width:t,_height:s}=this,a=e?13:12,r=this._fbos.acquire(t,s,"viewshed shadow map",a);return r.getTexture(lt)?.setShadowFiltering(!1),r}clearFBO(e){const t=this._fbos.rctx;this._ensureFBO(e),t.bindFramebuffer(this._handle?.fbo),t.setClearColor(1,1,1,1),t.clear(16640)}dispose(){this._debugFBO||(this._handle=ti(this._handle))}start(e,t,s,a,r=!1){this._faces={};const o=this._computeActiveFaces(t),l=o.size;if(l===0)return!1;const c=this._computeBaseTextureSize(e,a,s,l);let p=0,d=0,v=0;return $t.filter(m=>o.has(m)).forEach(m=>{const w=ha(m,l);w>d&&(v=Math.max(v,p),p=0),d=w;const f=w*c;p+=this._setupFaceCamera(m,t,[p,f],c)}),v=Math.max(v,p),this._width=this.settings.textureResizeModulo(v),this._height=ca(l)*c,this.clearFBO(r),!0}finish(){}get test(){}}function ha(i,e){if(e<4)return 0;const t=i==="front"||i==="left";return e===4?t?0:1:t||i==="right"?0:1}function ca(i){return i<4?1:2}class da extends Ii{constructor(){super(...arguments),this.localOrigin=mi()}}function pa(i){i.include(Li),i.fragment.uniforms.add(new Ui("inverseViewMatrix",(e,t)=>{const s=Ht(S(),t.camera.viewMatrix,e.localOrigin);return zt(s,s)})).code.add(ke`vec4 reconstructLocalPosition(vec2 coord, float linearDepth) {
vec4 cameraSpace = vec4(reconstructPosition(coord, linearDepth), 1.0);
return inverseViewMatrix * cameraSpace;
}`)}let Xe=class extends da{constructor(){super(...arguments),this.shadowMap={depthTexture:null,nearFar:[1,100],numActiveFaces:1,atlasRegions:[[0,0,1,1]]},this.targetVector=[1,0,0],this.upVector=[0,0,1],this.fovs=[45,45],this.headingAndTilt=[0,0],this.observerOffset=[0,0,0],this.projectionMatrices=et.flat(),this.viewMatrices=et.flat(),this.volumeOffset=0}};function qt(){const i=new ji,e=i.fragment;return i.include(ki),i.include(pa),e.include(Ni),e.include(Wi),e.uniforms.add(new Bi("depthTexture",t=>t.depth?.attachment),new it("inverseProjectionMatrix",t=>t.camera.inverseProjectionMatrix),new it("inverseViewNormalMatrix",({camera:t})=>zt(ua,t.viewInverseTransposeMatrix)),new xe("viewshedObserverOffset",t=>t.observerOffset),new xe("viewshedTargetVector",t=>t.targetVector),new xe("viewshedUpVector",t=>t.upVector),new Oe("viewshedFOVs",t=>t.fovs),new Oe("viewshedHeadingAndTilt",t=>t.headingAndTilt),new Oe("viewshedNearFar",t=>t.shadowMap.nearFar??[1,100]),new xs("viewshedVolumeOffset",t=>t.volumeOffset),new ht("viewshedShadowMap",t=>t.shadowMap.depthTexture),new st("viewshedProjectionMatrices",t=>t.projectionMatrices,6),new st("viewshedViewMatrices",t=>t.viewMatrices,6),new Gi("viewshedNumFaces",t=>t.shadowMap.numActiveFaces),new qi("viewshedAtlasRegions",t=>t.shadowMap.atlasRegions.flat(),24),new ht("normalMap",t=>t.normals)),e.constants.add("visibleColor","vec4",[0,1,0,.5]),e.constants.add("occludedColor","vec4",[1,0,0,.5]),e.code.add(ke`vec2 getViewshedUv(vec4 worldPosition, int face) {
mat4 viewshedMatrix = viewshedProjectionMatrices[face];
vec4 viewshedUv4 = viewshedMatrix * worldPosition;
vec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;
return viewshedUv.xy;
}
float viewshedDepthToFloat(float depth) {
return (depth - viewshedNearFar[0]) / (viewshedNearFar[1] - viewshedNearFar[0]);
}
float getOrthographicDepthToViewshed(vec4 worldPosition, int face) {
mat4 viewshedViewMatrix = viewshedViewMatrices[face];
vec4 viewshedUv4 = viewshedViewMatrix * worldPosition;
vec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;
float depth = -viewshedUv.z;
return viewshedDepthToFloat(depth);
}
float viewshedReadShadowMapDepth(sampler2D _viewshedShadowmap, ivec2 uv) {
return texelFetch(_viewshedShadowmap, uv, 0).r;
}
float viewshedFilterShadow(sampler2D _viewshedShadowmap, vec2 uv) {
vec2 uvScaled = uv * vec2(textureSize(_viewshedShadowmap, 0));
vec2 st    = fract(uvScaled);
ivec2 base = ivec2(uvScaled);
float s00 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x,     base.y    ));
float s10 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x + 1, base.y    ));
float s11 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x + 1, base.y + 1));
float s01 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x,     base.y + 1));
return mix(mix(s00, s10, st.x), mix(s01, s11, st.x), st.y);
}
float viewshedTextureAtlasLookup(sampler2D _viewshedShadowmap, vec2 uv, vec4 atlasRegion) {
vec2 atlasScale = atlasRegion.zw - atlasRegion.xy;
vec2 uvAtlas = fract(uv) * atlasScale + atlasRegion.xy;
return viewshedFilterShadow(_viewshedShadowmap, uvAtlas);
}
float getDepthFromShadowMap(vec2 uv, int face) {
int index = 4 * face;
float umin = viewshedAtlasRegions[index];
float umax = viewshedAtlasRegions[index + 1];
float vmin = viewshedAtlasRegions[index + 2];
float vmax = viewshedAtlasRegions[index + 3];
vec4 atlasRegion = vec4(umin, vmin, umax, vmax);
return viewshedTextureAtlasLookup(viewshedShadowMap, uv, atlasRegion);
}
struct ViewshedPoint {
int face;
vec2 uv;
bool isWithin;
float orthographicDepth;
};
mat3 rotationMatrix(vec3 axis, float angle)
{
float s = sin(angle);
float c = cos(angle);
float oc = 1.0 - c;
return mat3(
oc * axis.xxz * axis.xyx + vec3(c, axis.zy) * vec3(1., -s, s),
oc * axis.xyy * axis.yyz + vec3(axis.z, c, axis.x) * vec3(s, 1., -s),
oc * axis.zyz * axis.xzz + vec3(axis.yx, c) * vec3(-s, s, 1.)
);
}
float distanceToPlane(vec3 position, vec3 normal) {
return dot(position, normal);
}
bool outsideViewshed(float distance) {
return distance > -viewshedVolumeOffset;
}
bool isWithinViewshed(vec3 position) {
float positionLength = length(position - viewshedObserverOffset);
float farSphereDistance = positionLength - viewshedNearFar[1];
if (outsideViewshed(farSphereDistance)) { return false; }
float nearSphereDistance = viewshedNearFar[0] - positionLength;
if (outsideViewshed(nearSphereDistance)) { return false; }
vec3 westVector = normalize(cross(viewshedUpVector, viewshedTargetVector));
bool leftOfTarget = distanceToPlane(position, westVector) > 0.0;
if (viewshedFOVs[0] < TWO_PI) {
float horAngle = viewshedFOVs[0] / 2.0;
horAngle = leftOfTarget ? horAngle : -horAngle;
vec3 sideVector = viewshedTargetVector * rotationMatrix(viewshedUpVector, horAngle);
bool inFront = distanceToPlane(position, sideVector) > 0.0;
if (inFront) {
vec3 sideNormal = cross(viewshedUpVector, sideVector) * (leftOfTarget ? 1. : -1.);
float sideDistance = distanceToPlane(position, normalize(sideNormal));
if (outsideViewshed(sideDistance)) { return false; }
} else if (viewshedFOVs[0] < PI) { return false; }
}
if (viewshedFOVs[1] < PI) {
float t = dot(viewshedUpVector, position);
vec3 nProjVector = normalize(position - t * viewshedUpVector);
float heading = acos(clamp(dot(normalize(viewshedTargetVector), nProjVector), -1.0, 1.0));
heading = leftOfTarget ? heading : -heading;
bool aboveTarget = distanceToPlane(position, viewshedUpVector) > 0.0;
float verFOV = viewshedFOVs[1] / 2.0;
verFOV = aboveTarget ? -verFOV : verFOV;
mat3 rotateByHeading = rotationMatrix(viewshedUpVector, heading);
vec3 sideVector = viewshedTargetVector * rotationMatrix(westVector, verFOV) * rotateByHeading;
vec3 leftVector = westVector * rotateByHeading;
vec3 sideNormal = cross(sideVector, leftVector) * (aboveTarget ? 1. : -1.);
float sideDistance = distanceToPlane(position, normalize(sideNormal));
if (outsideViewshed(sideDistance)) { return false; }
}
return true;
}
bool getViewshedPoint(vec4 localPosition, out ViewshedPoint point) {
for(int i=0; i < viewshedNumFaces; i++) {
vec2 viewshedUv = getViewshedUv(localPosition, i);
if (viewshedUv.x > 0. && viewshedUv.x < 1. && viewshedUv.y > 0. && viewshedUv.y < 1.) {
float orthoDepth = getOrthographicDepthToViewshed(localPosition, i);
if (orthoDepth >= 0.) {
bool isWithin = isWithinViewshed(localPosition.xyz);
point = ViewshedPoint(i, viewshedUv, isWithin, orthoDepth);
return true;
}
}
}
return false;
}
float normalCosAngle(float linearDepth, vec3 localPosition) {
vec4 normal4 = texture(normalMap, uv);
vec3 normalN = normalize(normal4.xyz * 2.0 - 1.0);
vec3 normal =  normalize((inverseViewNormalMatrix * vec4(normalN, 1.0)).xyz);
vec3 viewingDir = normalize(localPosition);
return dot(normal, viewingDir);
}`),e.main.add(ke`float depth = depthFromTexture(depthTexture, uv);
if (depth >= 1.0 || depth <= 0.0) {
return;
}
float linearDepth = linearizeDepth(depth);
vec4 localPosition = reconstructLocalPosition(gl_FragCoord.xy, linearDepth);
ViewshedPoint point;
bool foundFace = getViewshedPoint(localPosition, point);
if (!foundFace || !point.isWithin) {
return;
}
float viewshedDepth = getDepthFromShadowMap(point.uv, point.face);
float distance = point.orthographicDepth;
bool visible = distance < viewshedDepth;
fragColor = visible ? visibleColor : occludedColor;
float cosAngle = normalCosAngle(linearDepth, localPosition.xyz);
float threshold = -0.01;
if (cosAngle > threshold) {
fragColor = occludedColor;
}`),i}const ua=S(),va=Object.freeze(Object.defineProperty({__proto__:null,ViewshedPassParameters:Xe,build:qt},Symbol.toStringTag,{value:"Module"}));class xt extends Ki{constructor(e,t){super(e,t,new Qi(va,()=>$s(()=>Promise.resolve().then(()=>Va),void 0)),Xi)}initializePipeline(){return Yi({colorWrite:Zi,blending:Ji})}}let j=class extends es{get shadowMap(){return this._shadowMap}get hasViewsheds(){return this._viewsheds.length>0}get _contentPixelRatio(){return this.view.state.contentPixelRatio}get _viewshedsInView(){return this._viewsheds.items.filter(i=>fa(this.view,i))}constructor(i){super(i),this.isDecoration=!1,this._passParameters=new Xe,this._viewsheds=new wi,this._shadowMap=null,this.consumes={required:[Te.VIEWSHED,"normals"]},this.produces=Te.VIEWSHED,this.requireGeometryDepth=!0}initialize(){this._shadowMap=new la(this.fboCache),this.addHandles([M(()=>this.view.resolutionScale,i=>{const e=this._shadowMap;e&&(e.settings.textureSizeQuality=i)},x),pe(()=>!this.hasViewsheds,()=>this._shadowMap?.dispose()),M(()=>this._viewshedsInView.map(i=>[i.observerRenderSpace,i.heading,i.tilt,i.farDistance,i.horizontalFieldOfView,i.verticalFieldOfView]),()=>this.requestRender(1),Ft)])}destroy(){this._shadowMap=ii(this._shadowMap)}precompile(){if(this.hasViewsheds){this.techniques.precompile(xt);for(const i of this._viewshedsInView)if(this._shadowMap?.isActive(i))return void this.view.stage.renderer.precompileViewshedShadowMap()}}render(i){const e=this.bindParameters,t=this.renderingContext,s=i.find(({name:o})=>o===Te.VIEWSHED);if(!this.hasViewsheds||!e.depth||this.isDecoration&&!e.decorations)return s;this._passParameters.shadowMap=this._shadowMap??this._passParameters.shadowMap,this._passParameters.normals=i.find(({name:o})=>o==="normals")?.getTexture();const a=this.techniques.get(xt);if(!a?.compiled)return this.requestRender(1),s;const r=this.view.stage.renderer.isFeatureEnabled(7);for(const o of this._viewshedsInView){if(!this._renderShadowCubeMap(e,o,r)||!this._shadowMap?.ready)continue;const l=this._setupViewshedParameters(o,e.camera);t.bindTechnique(a,e,l),t.bindFramebuffer(s.fbo),t.screen.draw()}return this.shadowMap?.dispose(),s}updateViewsheds(i){const e=this._viewsheds,{removes:t,adds:s}=i;if(t&&(Array.isArray(t)?e.removeMany(t):e.remove(t)),s)if(Array.isArray(s)){const a=s.filter(r=>!e.includes(r));e.addMany(a)}else e.includes(s)||e.add(s)}_renderShadowCubeMap(i,e,t){const s=this._shadowMap;if(!s)return!1;const a=this.view.basemapTerrain.hasStencilEnabledExtents,r=s.start(i.camera,e,t,this._contentPixelRatio,a);return r&&s.faces.forEach(o=>this.view.stage.renderer.renderViewshedShadowMap(o)),s.finish(),r}_setupViewshedParameters(i,e){const t=this._shadowMap;if(!t)return this._passParameters;const s=this._passParameters,a=i.effectiveObserverRenderSpace;s.localOrigin=a,s.observerOffset=F(_a,i.observerRenderSpace,i.effectiveObserverRenderSpace),s.fovs=[y(i.horizontalFieldOfView),y(i.verticalFieldOfView)],s.headingAndTilt=[y(i.heading),y(i.tiltParallelToSurface)],s.upVector=i.tiltedUpVector;const r=ma(i.targetRenderSpace,a);s.targetVector=r;const o=new Array,l=new Array;for(let c=0;c<t.numActiveFaces;c++)Ht(Ee,t.viewshedViewMatrices[c],a),o.push(...Ee),wa(t.viewshedProjectionMatrices[c],Ee,Rt),l.push(...Rt);return s.viewMatrices=o,s.projectionMatrices=l,s.volumeOffset=this.selectedViewshed?.()===i.viewshed?ga(i,this.view,e.eye):0,s}get test(){return{viewsheds:this._viewsheds,shadowMap:this._shadowMap,viewshedsInView:this._viewshedsInView}}};function ma(i,e){const t=u();return F(t,i,e)}function wa(i,e,t){const s=q(.5,.5,.5);return fe(t,s),xi(t,t,s),W(t,t,i),W(t,t,e),t}function fa(i,e){const t=us(e.observerRenderSpace,e.farDistanceRenderSpace);return!!i.ready&&i.frustum.intersectsSphere(t)}function ga(i,e,t){if(i==null)return 0;const{observerRenderSpace:s,targetRenderSpace:a}=i,r=Ze(t,s)>Ze(t,a)?i.observer:i.target;return e.pixelSizeAt(r)}n([h()],j.prototype,"selectedViewshed",void 0),n([h()],j.prototype,"isDecoration",void 0),n([h()],j.prototype,"shadowMap",null),n([h()],j.prototype,"hasViewsheds",null),n([h()],j.prototype,"_contentPixelRatio",null),n([h()],j.prototype,"_viewshedsInView",null),n([h()],j.prototype,"consumes",void 0),n([h()],j.prototype,"produces",void 0),j=n([ie("esri.views.3d.webgl-engine.lib.Viewshed")],j);const _a=u(),Ee=S(),Rt=S();let E=class extends yi{constructor(i){super(i),this.type="viewshed-view-3d",this.analysis=null,this.tool=null,this._selectedViewshed=null,this.viewshedComputedDataHandles=null,this.userOperation=null,this._viewshedRenderNode=null,this._intersector=null}get visible(){return super.visible}set visible(i){super.visible=i}get interactive(){return super.interactive}set interactive(i){super.interactive=i}get selectedViewshed(){return this._selectedViewshed}set selectedViewshed(i){this._unselectOtherViewsheds(i),this._selectedViewshed=i}get selectedViewshedComputedData(){return this.tool?.selectedViewshedComputedData}get _isDecoration(){return!this.parent}initialize(){const i=this.view;this._viewshedRenderNode=new j({view:i,selectedViewshed:()=>this.selectedViewshed??this.tool?.stagedViewshed,isDecoration:this._isDecoration}),this._intersector=new ts(this.view.state.viewingMode),this._intersector.options.hud=!1,this._intersector.options.store=0,this.viewshedComputedDataHandles=Be(()=>this.analysis.viewsheds,e=>{const t=new g({renderCoordsHelper:i.renderCoordsHelper,viewshed:e}),s=Symbol();return this.addHandles([M(()=>({valid:t.valid,canProject:_i(t.observer?.spatialReference,this.view.spatialReference)||Vi()}),({valid:a,canProject:r},o)=>{this.visible&&(a&&r?this._addViewshedsToRenderer(t):o?.valid&&o?.canProject&&this._removeViewshedsFromRenderer(t),r||$i(this.analysis,t.observer.spatialReference,si.getLogger(this)))},x),...this._createFeatureReferenceHandles(t)],s),{viewshedComputedData:t,remove:()=>{this.removeHandles(s),this._removeViewshedsFromRenderer(t),t.destroy()}}}),this._visualization=new ae({view:i,analysisViewData:this,isDecoration:this._isDecoration}),this.addHandles([M(()=>this.visible,e=>{const t=this.viewshedComputedDataHandles;if(t==null)return;e||(this.selectedViewshed=null);const s=t.map(a=>a.viewshedComputedData).filter(a=>a.valid).toArray();e?this._addViewshedsToRenderer(s):this._removeViewshedsFromRenderer(s)}),M(()=>i.renderCoordsHelper,e=>{this.viewshedComputedDataHandles?.forEach(({viewshedComputedData:t})=>t.renderCoordsHelper=e)}),Vs(this,O),pe(()=>this.interactive,()=>{this._unselectOtherViewsheds(this.selectedViewshed)},le)])}destroy(){this.userOperation=He(this.userOperation),bs(this),this._visualization=P(this._visualization);const i=this.viewshedComputedDataHandles;i!=null&&this._removeViewshedsFromRenderer(i.map(e=>e.viewshedComputedData).toArray())}_createFeatureReferenceHandles(i){const{view:e}=this;return[M(()=>[e.state.camera,e.slice.plane,i.viewshed.observer,i.targetRenderSpace,i.verticalFieldOfView,i.horizontalFieldOfView,i.feature],()=>{this._updateObserverFromFeature(e,i)},x),this._createElevationUpdateHandle(i),pe(()=>i.needUpdateByFeature,()=>{this._updateObserverFromFeature(e,i),i.needUpdateByFeature=!1})]}_createElevationUpdateHandle(i){const e=(t,s)=>{const{view:a}=this,{observer:r}=i;if(r==null)return;const o=gi(r,a.spatialReference);if(o.pending!=null)return void o.pending.finally(()=>e(t,s));const l=o.geometry;l!=null&&(ci(t,s,Ct,a.spatialReference),Mi(Ct,[l.x,l.y])&&(i.needUpdateByFeature=!0))};return this.view.elevationProvider.on("elevation-change",({extent:t,spatialReference:s})=>e(t,s))}async createViewsheds(i){await ot(this,{placementOptions:i,onToolActivated:e=>e.place("multiple")})}place(i){return ot(this,{placementOptions:i,onToolActivated:e=>e.place("single")})}_addViewshedsToRenderer(i){this._viewshedRenderNode.updateViewsheds({adds:i})}_removeViewshedsFromRenderer(i){this._viewshedRenderNode.updateViewsheds({removes:i})}_updateObserverFromFeature(i,e){const t=e.observerRenderSpace,s=e.targetRenderSpace,a=N(u(),t),r={observer:t,observerSurfaceNormal:null,observerAdjusted:a,observerFeatureId:ai(e.feature),target:s,targetSurfaceNormal:null,targetAdjusted:N(u(),s),targetFeatureId:null};ri(i,this._intersector,r,o=>Math.min(o,.05*e.farDistanceRenderSpace)),e.observerRenderSpaceOverride=ui(a,t)?null:a}_unselectOtherViewsheds(i){if(i!=null)for(const e of this.view.tools.items)e!==this.tool&&e instanceof O&&(e.analysisViewData.selectedViewshed=null)}get test(){}};n([h({readOnly:!0})],E.prototype,"type",void 0),n([h({constructOnly:!0,nonNullable:!0})],E.prototype,"analysis",void 0),n([h()],E.prototype,"tool",void 0),n([h()],E.prototype,"_selectedViewshed",void 0),n([h()],E.prototype,"selectedViewshed",null),n([h()],E.prototype,"selectedViewshedComputedData",null),n([h()],E.prototype,"viewshedComputedDataHandles",void 0),n([h()],E.prototype,"userOperation",void 0),n([h()],E.prototype,"_visualization",void 0),n([h()],E.prototype,"_viewshedRenderNode",void 0),E=n([ie("esri.views.3d.analysis.ViewshedAnalysisView3D")],E);const kn=E,Ct=bi(),Va=Object.freeze(Object.defineProperty({__proto__:null,ViewshedPassParameters:Xe,build:qt},Symbol.toStringTag,{value:"Module"}));export{kn as default};
