import{bb as vt,c as H,i as Y,bc as _e,a as _t,a2 as wt,q as Ft,Y as o,H as s,G as b,L as we}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{s as xe}from"./Graphic-DgGzDmqW-CFzg0c4i.js";import{R as xt,M as Oe,e as Ot,t as be}from"./collectionUtils-jDyktm0P-ArdXNs6F.js";import{j as I,l as W,i as Te,J as Pe,r as bt,I as ke}from"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import{r as At}from"./UpdatingHandles-D2RI_3Hb-dwLPjVun.js";import{H as Se}from"./asyncUtils-w6KfWU41-HenJ0UOu.js";import{y as Ve,M as Me,T as Ce,k as Ie,x as M,$ as De}from"./SketchTooltipInfo-BNoFeSMr-92WKQOPa.js";import Ge from"./GraphicsLayer-CZ0Xqeb2-BpD6EhPB.js";import{c as Q,M as st}from"./dehydratedFeatureComparison-faNSTYzo-C3UzI31T.js";import{G as He,Q as Tt,D as Re,N as Pt,J as Ee,L as $e,q as kt,B as Ue}from"./createUtils-ScyvvYX6-NA68pXeg.js";import{m as ze,aF as tt,aD as q,K as V,aB as Nt,I as Ze,b6 as Le}from"./ShadowCastClear.glsl-CeOT_rAo-iOFMl8eB.js";import{Q as ct,bs as Fe,f as Bt,ax as Ae,b as qt,F as St}from"./Point-BfTTZoMu-BAT2Wq6O.js";import{m as Vt,b as Ne,C as jt,B as Be,R as qe,v as Yt,q as je,$ as Ye}from"./elevationInfoUtils-B8MpdRMP-CN_w2fPT.js";import{L as Jt,O as X,$ as Je,I as Ke,u as Mt,k as Ct}from"./vec32-CewSdTn3-DHOFKD0R.js";import{l as j,n as We,s as Qe,t as Kt,i as Wt,r as Xe,e as ti}from"./TooltipInfoWithCoordinates-CbHxsk06-Bop9nq2q.js";import{h as R,_ as Qt,r as ei,Z as ii}from"./angularMeasurementUtils-CP9gTlx0-Cmcd-Fla.js";import{j as ni,o as oi,k as E,u as pt,w as ri,m as si,y as Xt,B as ai,C as te,D as li,F as ci,G as pi,I as ui,i as di,p as hi}from"./euclideanLengthMeasurementUtils-CpHh36Dt-B3Q3Npaw.js";import{l as gi,J as at,o as mi}from"./InteractiveToolBase-DXh7kfgV-R_Z6wqPu.js";import{m as ee,y as ie}from"./SketchOptions-Dguq2sp8-DmrYxGLA.js";import{s as ne,a as yi}from"./screenUtils-BitdhK1O-L0FLPAMi.js";import{C as fi}from"./diffUtils-wTC1YzlE-JuqUWoWa.js";import{d as vi,S as _i,Z as wi,z as xi,a as Oi,$ as bi,R as Ti,q as Pi}from"./EditGeometryOperations-DZvKpTU8-cI99RYYJ.js";import{h as ut,x as et}from"./projectVectorToVector-Csv3NYZI-BsIKHfQD.js";import{g as It}from"./SnappingContext-CApcAey_-Kve-1Boq.js";import{r as ki}from"./SnappingDragPipelineStep-Uh4sAWwf-B8z4_n_a.js";import{a as Si}from"./SnappingOperation-ClIdnPwp-BbaP0Atw.js";import{x as oe,z as Vi,J as it}from"./RealisticTree.glsl-WN9nrQUl-CRRcYwOn.js";import{F as z,j as Dt,av as Mi,aw as Ci,b as Ii,u as Di,l as Gt,as as Ht}from"./Polygon-D6wEPb3W-CpL9Efjx.js";import{v as Z}from"./vector-B8ZDYGQ6-B1uNywRb.js";const dt={UndoRedoUpdating:"Cannot perform operation whilst undo redo is updating",UndoInvalidError:"There are no items to Undo",RedoInvalidError:"There are no items to Redo"};class L extends Error{constructor(){super(dt.UndoRedoUpdating),this.type="undo-redo-updating-error"}}let Gi=class extends Error{constructor(){super(dt.UndoInvalidError),this.type="undo-redo-undo-error"}};class Rt extends Error{constructor(){super(dt.RedoInvalidError),this.type="undo-redo-redo-error"}}let T=class extends Ft{constructor(){super(...arguments),this._stack=new xt,this._stackPosition=-1,this._updatingHandles=new At}get updating(){return this._updatingHandles.updating}get canUndo(){return this.hasUndo&&!this.updating}get hasUndo(){return this._stackPosition>=0}get canRedo(){return this.hasRedo&&!this.updating}get hasRedo(){return this._stackPosition<this._stack.length-1}_truncateForwardStack(){this._stack.splice(this._stackPosition+1,this._stack.length-this._stackPosition).forEach(t=>t.destroy())}_drainStack(){this._stack.drain(t=>t.destroy()),this._stackPosition=-1}async undo(){if(!this.hasUndo)throw new Gi;if(this.updating)throw new L;const t=this._stack.getItemAt(this._stackPosition);t&&await this._updatingHandles.addPromise((async()=>{await t.executeUndoRedoOperation(1),--this._stackPosition,t.canRedo||this._truncateForwardStack()})())}async redo(){if(!this.hasRedo)throw new Rt;if(this.updating)throw new L;const t=this._stack.getItemAt(this._stackPosition+1);if(!t)throw new Rt;await this._updatingHandles.addPromise((async()=>{await t.executeUndoRedoOperation(2),++this._stackPosition})())}peekUndo(){if(this.canUndo)return this._stack.getItemAt(this._stackPosition)}peekRedo(){if(this.canRedo)return this._stack.getItemAt(this._stackPosition+1)}async inject(t){if(this.updating)throw new L;await this._updatingHandles.addPromise((async()=>{t.status===0&&await t.executeUndoRedoOperation(0),t.canUndo?(this._stack.splice(this._stackPosition+1,0,t),this._stackPosition++):this._stackPosition>-1&&(this._stack.splice(0,this._stackPosition+1).forEach(e=>e.destroy()),this._stackPosition=-1)})())}async add(t){if(this.updating)throw new L;await this._updatingHandles.addPromise((async()=>{t.status===0&&await t.executeUndoRedoOperation(0),this._stackPosition>=-1&&this._truncateForwardStack(),t.canUndo?(this._stack.push(t),this._stackPosition=this._stack.length-1):this._drainStack()})())}async removeTagged(t,e=!1){if(this.updating&&!e)return;await bt(()=>!this.updating);const i=new xt;for(let n=0;n<this._stack.length;n++){const r=this._stack.getItemAt(n);r&&(r.tag===t?(r.destroy(),n===this._stackPosition&&(this._stackPosition=i.length-1)):i.push(r))}this._stack=i,this._stackPosition>i.length-1&&(this._stackPosition=i.length-1)}async clear(t=!1){if(this.updating&&!t)throw new L;await bt(()=>!this.updating),this._drainStack()}};o([s()],T.prototype,"_stack",void 0),o([s()],T.prototype,"_stackPosition",void 0),o([s()],T.prototype,"updating",null),o([s({readOnly:!0})],T.prototype,"canUndo",null),o([s({readOnly:!0})],T.prototype,"hasUndo",null),o([s({readOnly:!0})],T.prototype,"canRedo",null),o([s({readOnly:!0})],T.prototype,"hasRedo",null),T=o([b("esri.UndoRedo")],T);let Hi=class{constructor(){this.committedVertices=null,this.cursorVertex=null,this.full=null,this.outline=null,this.cursorEdge=null,this.circle=null,this.rectangle=null}};function $(t,e,i){if(t==null)return"noTool";switch(t){case"point":return Ri();case"multipoint":return"multipoint";case"polyline":return Ei(e,i);case"polygon":return $i(e,i);case"rectangle":case"circle":return Ui(e,i);default:return}}function Ri(t){return"point"}function Ei(t,e){const i=t!=null&&t.type==="polyline"&&t.paths.length?t.paths[0].length:0;return e==="freehand"?i<2?"freehandStart":"freehandEnd":i<2?"polylineZeroVertices":"polylineOneVertex"}function $i(t,e){const i=t!=null&&t.type==="polygon"&&t.rings.length?t.rings[0].length:0;if(i<3)switch(e){case"freehand":return"freehandStart";case"hybrid":return"polygonZeroVerticesHybrid";default:return"polygonZeroVertices"}else if(i<4)return e==="freehand"?"freehandEnd":"polygonOneVertex";return"polygonTwoVertices"}function Ui(t,e){if((t!=null&&t.type==="polygon"&&t.rings.length?t.rings[0].length:0)<3)switch(e){case"freehand":return"freehandStart";case"click":return"shapeStartClick";default:return"shapeStartHybrid"}switch(e){case"freehand":return"freehandEnd";case"click":return"shapeEndClick";default:return"shapeEndHybrid"}}function zi(t,e){const i=t?.geometry;if(!t||i?.type!=="mesh"||!e)return;const{renderCoordsHelper:n,elevationProvider:r}=e,{camera:c}=e.state,{extent:p}=i,{center:a,spatialReference:l}=p,u=St(l),g=ct(l),y=St(n.spatialReference),f=p.width*u,d=p.height*g,O=(p.zmax??0)*g,v=O-(p.zmin??0)*g,k=Math.max(f,d,v)/y,{x:_,y:C}=a,yt=a.z??0;Jt(J,_,C,yt),n.toRenderCoords(J,l,J);const ft=k/c.computeScreenPixelSizeAt(J);if(ft>Math.min(c.width,c.height)/c.pixelRatio*Li)return"meshTooClose";if(ft<Zi)return"meshTooFar";const fe=je(t),{absoluteZ:ve}=Ye(_,C,O,l,e,fe);return ve<(r.getElevation(_,C,yt,l,"ground")??0)*g+v*Fi?"meshUnderground":"mesh"}const Zi=20,Li=1,Fi=.1,J=be();function Ai(t,e,i,n,r,c){let p="geodesic",a=hi(i);const l=E();return pt(t,e,n,l),l[2]=0,a&&et(l,i,l,a)||(p="euclidean",a=i),{mode:p,view:e,elevationInfo:n,hasZ:r,directionMode:c,spatialReference:t.spatialReference,measurementSR:a,origin:l}}function Ni(t,e,i){if(e==null||t==null)return;const n=Fe(i.measurementSR);if(n==null)return;const r=nt(t,i);if(r==null)return;const c=tt(e,n);return new ai(r,c)}function Bi(t,e,i,n){if(i==null||t==null)return;const r=nt(t,n);if(r==null)return;const c=R(i),p=10,a=u=>{if(u==null)return;const g=E(),y=Ze(u,"degrees","geographic");return ei(g,r,n.measurementSR,p,y,n.mode)?new ci(r,g):void 0},l=()=>{if(e!=null&&t!=null)return R(Qt(e,t))};switch(n.directionMode){case"absolute":return a(c);case"relative":{const u=l();return u==null?void 0:a(u+c)}case"relative-bilateral":{const u=l();return u==null?void 0:te([a(u+c),a(u-c)])}}}function re(t,e){const i=ot(t,e);return i!=null?new li(i):void 0}function se(t,e,i){const{context:n,longitude:r,latitude:c,direction:p,distance:a,elevation:l}=i;if(r!=null||c!=null||a!=null||l!=null||p!=null){if(r!=null||c!=null){const u=R(r),g=R(c),y=ot(l,n);return new Xt(u,g,y)}return qi(t,e,i)}}function qi(t,e,{context:i,direction:n,distance:r,elevation:c}){if(e==null)return re(c,i);const{view:p,elevationInfo:a,measurementSR:l}=i,u=pt(e,p,a);if(!l||!et(u,e.spatialReference,Et,l))return;const[g,y]=Et,f=r!=null?tt(r,"meters"):void 0,d=R(n),O=ot(c,i),v=_=>{const C=new pi([g,y],l,f,O,_);return f==null||_==null||O==null&&i.hasZ?C:new ui(C.closestTo(u))};if(d==null)return v(void 0);const k=()=>{if(t!=null&&e!=null)return R(Qt(t,e))};switch(i.directionMode){case"absolute":return v(d);case"relative":{const _=k();return _==null?void 0:v(_+d)}case"relative-bilateral":{const _=k();return _==null?void 0:te([v(_+d),v(_-d)])}}}function ji(t){return t.context.mode==="geodesic"?se(null,null,t):ae(t)}function Yi(t,e,i){const{context:n,x:r,y:c,distance:p,direction:a,elevation:l}=i;return n.mode==="geodesic"?se(e,t,i):r!=null||c!=null?ae(i):Ji([Ni(t,p,n),Bi(t,e,a,n),re(l,n)])}function ae({x:t,y:e,elevation:i,context:n}){K.x=t?.value??0,K.y=e?.value??0,K.spatialReference=n.spatialReference;const r=nt(K,n,Qi);return new Xt(t!=null&&r!=null?r[0]:void 0,e!=null&&r!=null?r[1]:void 0,ot(i,n))}function Ji(t){let e;for(const i of t)i&&(e=e?.intersect(i)??i);return e}function nt(t,e,i=E()){const{view:n,elevationInfo:r,measurementSR:c,origin:p,mode:a}=e;if(pt(t,n,r,i),et(i,t.spatialReference,i,c))return a!=="geodesic"&&Je(i,i,p),i}function Ki(t,e,i,n){const{view:r,measurementSR:c,spatialReference:p,origin:a,mode:l}=i;if(l==="geodesic"?Ke(F,t):X(F,t,a),et(F,c,F,p))return ri(F,r,e,i,n)}function ot(t,e){return Wi(t,e)?.value??void 0}function Wi(t,{view:e,origin:i,elevationInfo:n,hasZ:r,measurementSR:c}){if(t==null||!r)return;const p=Ae(c);if(p==null)return;const[a,l]=i,u=tt(t,p),g=e?.type==="3d"?Yt(e,a,l,u,c,n):u;return g!=null?Nt(g,p):void 0}const Et=E(),Qi=E(),F=E(),K=ut(0,0,0,Bt.WGS84);let P=class extends M{constructor(t){super(t),this.type="draw-circle",this.radius=null,this.xSize=null,this.ySize=null,this.area=q}get allFields(){return[]}};o([s()],P.prototype,"type",void 0),o([s()],P.prototype,"radius",void 0),o([s()],P.prototype,"xSize",void 0),o([s()],P.prototype,"ySize",void 0),o([s()],P.prototype,"area",void 0),o([s()],P.prototype,"helpMessage",void 0),o([s()],P.prototype,"allFields",null),P=o([b("esri.views.interactive.tooltip.infos.DrawCircleTooltipInfo")],P);let A=class extends j(M){constructor(t){super(t),this.type="draw-mesh",this.orientation=We({lockable:!1}),this.scale=Qe({lockable:!1})}get allFields(){return[this.longitude,this.latitude,this.x,this.y,this.elevation,this.orientation,this.scale]}};o([s()],A.prototype,"helpMessage",void 0),o([s()],A.prototype,"allFields",null),A=o([b("esri.views.interactive.tooltip.infos.DrawMeshTooltipInfo")],A);let N=class extends j(M){constructor(t){super(t),this.type="draw-multipoint"}get allFields(){return[this.longitude,this.latitude,this.x,this.y,this.elevation]}};o([s()],N.prototype,"helpMessage",void 0),o([s()],N.prototype,"allFields",null),N=o([b("esri.views.interactive.tooltip.infos.DrawMultipointTooltipInfo")],N);let B=class extends j(M){constructor(t){super(t),this.type="draw-point"}get allFields(){return[this.longitude,this.latitude,this.x,this.y,this.elevation]}};o([s()],B.prototype,"helpMessage",void 0),o([s()],B.prototype,"allFields",null),B=o([b("esri.views.interactive.tooltip.infos.DrawPointTooltipInfo")],B);let D=class extends j(M){constructor(t){super(t),this.type="draw-polygon",this.direction=Kt(),this.distance=Wt(),this.area=Xe(),this.xyMode="direction-distance"}get allFields(){return[this.direction,this.distance,this.longitude,this.latitude,this.x,this.y,this.elevation,this.area]}};o([s()],D.prototype,"xyMode",void 0),o([s()],D.prototype,"helpMessage",void 0),o([s()],D.prototype,"allFields",null),D=o([b("esri.views.interactive.tooltip.infos.DrawPolygonTooltipInfo")],D);let G=class extends j(M){constructor(t){super(t),this.type="draw-polyline",this.direction=Kt(),this.distance=Wt(),this.totalLength=ti(),this.xyMode="direction-distance"}get allFields(){return[this.direction,this.distance,this.longitude,this.latitude,this.x,this.y,this.elevation,this.totalLength]}};o([s()],G.prototype,"helpMessage",void 0),o([s()],G.prototype,"xyMode",void 0),o([s()],G.prototype,"allFields",null),G=o([b("esri.views.interactive.tooltip.infos.DrawPolylineTooltipInfo")],G);let S=class extends M{constructor(t){super(t),this.type="draw-rectangle",this.xSize=V,this.ySize=V,this.area=q}get allFields(){return[]}};o([s()],S.prototype,"type",void 0),o([s()],S.prototype,"xSize",void 0),o([s()],S.prototype,"ySize",void 0),o([s()],S.prototype,"area",void 0),o([s()],S.prototype,"helpMessage",void 0),o([s()],S.prototype,"allFields",null),S=o([b("esri.views.interactive.tooltip.infos.DrawRectangleTooltipInfo")],S);function Xi(t,e){return{point:new B({sketchOptions:e,viewType:t}),multipoint:new N({sketchOptions:e,viewType:t}),polyline:new G({sketchOptions:e,viewType:t}),polygon:new D({sketchOptions:e,viewType:t}),mesh:new A({sketchOptions:e,viewType:t}),rectangle:new S({sketchOptions:e}),circle:new P({sketchOptions:e})}}function $t(t){const{directionOptions:e,geometryType:i,sketchOptions:n,tooltipInfos:r}=t,c=a=>{const l=rt(t).mode,u=r[a].elevation;l==="relative-to-ground"||l==="relative-to-scene"||l==="on-the-ground"?u.lock(mt(t)):u.unlock()},p=a=>{if(e){const l=r[a].direction;l.committed=e.angle,l.unlockOnVertexPlacement=!1,n.values.directionMode=e.mode}};switch(i){case"polygon":case"polyline":c(i),p(i);break;case"point":case"mesh":c(i)}}function tn(t,e){const{drawOperation:i,view:n}=e,r=ht(e),c=rt(e);if(n.type==="2d"||!t||c.mode!=="absolute-height"||i?.numCommittedVertices!==1||!r||r.type!=="draw-polyline"&&r.type!=="draw-polygon"||r.elevation.locked)return;const[p,a,l]=t,u=gn(p,a,l,c,e);u!=null&&r.elevation.lock(u)}function Ut(t){ht(t)?.allFields.forEach(e=>{e.unlockOnVertexPlacement&&e.unlock()})}function ht({geometryType:t,graphic:e,tooltipInfos:i}){return e?.geometry?.type!==en[t]?t==="circle"||t==="rectangle"?i[t]:null:i[t]}const en={point:"point",multipoint:"multipoint",mesh:"mesh",polyline:"polyline",polygon:"polygon",circle:"polygon",rectangle:"polygon",freehandPolygon:"polygon",freehandPolyline:"polyline",text:"point"};function nn(t,e){switch(t?.type){case"draw-point":on(t,e);break;case"draw-multipoint":rn(t,e);break;case"draw-polyline":an(t,e);break;case"draw-polygon":ln(t,e);break;case"draw-rectangle":pn(t,e);break;case"draw-circle":un(t,e);break;case"draw-mesh":sn(t,e)}}function on(t,e){const i=e.graphic?.geometry;i?.type==="point"&&(gt(t,i,e),t.helpMessage=$("point",i,e.drawOperation.drawingMode))}function rn(t,e){const i=e.graphic?.geometry;i?.type==="multipoint"&&(gt(t,i,e),t.helpMessage=$("multipoint",i,e.drawOperation.drawingMode))}function sn(t,e){const{graphic:i,view:n}=e,r=i?.geometry;n.type!=="3d"||r&&r.type!=="mesh"||(gt(t,r?.origin,e),r&&De(t,r),t.helpMessage=zi(i,n))}function gt(t,e,i){const{drawOperation:n,view:r,sketchOptions:c}=i,{cursorVertex:p}=n;t.sketchOptions=c,t.viewType=r.type;const a=e?.type==="multipoint"?e.getPoint(e.points.length-1):e;if(t.setLocationFromPoint(a,U(i)),ce(t.elevation,i),!p)return void(n.constraints=void 0);const l=p;n.constraints={context:he(l,i),x:t.x.committed,y:t.y.committed,longitude:t.longitude.committed,latitude:t.latitude.committed,elevation:t.elevation.committed,distance:null,direction:null}}function an(t,e){const{createOperationGeometry:i,drawOperation:n,automaticLengthMeasurementUtils:r}=e,c=i!=null?i.full:null;c&&c.type!=="polyline"||(le(t,e),t.totalLength.actual=n.lastVertex?(c?r.autoLength2D(c):null)??V:null,t.helpMessage=$("polyline",c,e.drawOperation.drawingMode))}function ln(t,e){const{createOperationGeometry:i,drawOperation:n}=e,r=i!=null?i.full:null;r&&r.type!=="polygon"||(le(t,e),t.area.actual=n.lastVertex?(r?e.automaticAreaMeasurementUtils.autoArea2D(r):null)??q:null,t.helpMessage=$("polygon",r,e.drawOperation.drawingMode))}const zt=we(qt);function le(t,e){const{drawOperation:i,sketchOptions:n,view:r,automaticLengthMeasurementUtils:c}=e,{cursorVertex:p,lastVertex:a,secondToLastVertex:l}=i,u=n.values.effectiveDirectionMode;t.sketchOptions=n,t.viewType=r.type;const g=a&&p?c.autoDistanceBetweenPoints2D(zt(a),zt(p))??V:null;if(t.distance.actual=g,t.distance.readOnly=a==null,t.direction.actual=null,t.direction.readOnly=!0,a&&p&&(u==="absolute"||l)){const d=ii(l,a,p,u);t.direction.actual=d??Le,t.direction.readOnly=!1}t.setLocationFromPoint(p,U(e)),ce(t.elevation,e);const y=cn(a,e);t.xyMode=y,t.direction.visible=y==="direction-distance",t.distance.visible=y==="direction-distance",t.effectiveX.visible=y==="coordinates",t.effectiveY.visible=y==="coordinates";const f=p??a;i.constraints=f?{context:he(f,e),x:t.x.committed,y:t.y.committed,longitude:t.longitude.committed,latitude:t.latitude.committed,elevation:t.elevation.committed,distance:t.distance.committed,direction:t.direction.committed}:void 0}function cn(t,{sketchOptions:e}){const i=e.tooltips.xyMode;return i==="auto"?t?"direction-distance":"coordinates":i}function pn(t,e){t.sketchOptions=e.sketchOptions,t.xSize=ue(e),t.ySize=de(e),t.area=pe(e),t.helpMessage=$("rectangle",e.graphic?.geometry,e.drawOperation.drawingMode)}function un(t,e){const{forceUniformSize:i,sketchOptions:n}=e;t.sketchOptions=n,t.radius=i?dn(e):null,t.xSize=i?null:ue(e),t.ySize=i?null:de(e),t.area=pe(e),t.helpMessage=$("circle",e.graphic?.geometry,e.drawOperation.drawingMode)}function ce(t,e){const{drawOperation:i}=e,n=i?.cursorVertex??i?.lastVertex;t.actual=di(n)??mt(e),t.visible=i.hasZ,t.readOnly=!1,t.showAsZ=!0}function pe(t){const e=t.createOperationGeometry?.full;return e?.type!=="polygon"?q:t.automaticAreaMeasurementUtils.autoArea2D(e)??q}function ue({createOperationGeometry:t,automaticLengthMeasurementUtils:e}){const i=t?.rectangle?.midpoints;return(i!=null?e.autoDistanceBetweenPoints2D(i.left,i.right):null)??V}function de({createOperationGeometry:t,automaticLengthMeasurementUtils:e}){const i=t?.rectangle?.midpoints;return(i!=null?e.autoDistanceBetweenPoints2D(i.top,i.bottom):null)??V}function dn({createOperationGeometry:t,automaticLengthMeasurementUtils:e}){return(t?.circle?.center!=null&&t.circle.edge!=null?e.autoDistanceBetweenPoints2D(t.circle.center,t.circle.edge):null)??V}function hn(t){const{geometryType:e,tooltipInfos:i}=t;switch(e){case"point":case"multipoint":case"mesh":case"polyline":case"polygon":{const n=i[e].elevation.committed;return n?tt(n,"meters")/ct(U(t)):void 0}default:return}}function gn(t,e,i,n,r){const{view:c,drawOperation:p}=r;if(c.type!=="3d"||!p)return;i??=0;const a=U(r),l=rt(r),u=Yt(c,t,e,i,a,l,n);return si(u,a)??mt(r)}function rt(t){return t.drawOperation.elevationInfo??qe}function U(t){return t.drawOperation.coordinateHelper.spatialReference}function mt(t){const e=ct(U(t));return Nt(t.defaultZ*e,"meters")}function he(t,e){return Ai(t,e.view,U(e),rt(e),e.drawOperation.coordinateHelper.hasZ(),e.sketchOptions.values.effectiveDirectionMode)}let m=class extends gi{constructor(t){super(t),this._graphic=null,this._coordinateFormatterLoadTask=null,this._createOperationGeometry=null,this.defaultZ=0,this.directionOptions=null,this.elevationLockOnVertexAddDisabled=!1,this.geometryType=null,this.hasZ=!0,this.geometryToPlace=null,this.snappingManager=null,this.snapToScene=!1,this.sketchOptions=new ee}initialize(){const{view:t}=this;this.internalGraphicsLayer=new Ge({listMode:"hide",internal:!0,title:"DrawGraphicTool layer"}),this.view.map.layers.add(this.internalGraphicsLayer);const e=this.drawOperation=this.makeDrawOperation();this.tooltipInfos=Xi(t.type,this.sketchOptions);const i=Ve(()=>({view:t,options:this.sketchOptions.tooltips}));this.tooltip=i,$t(this._tooltipsContext),this._coordinateFormatterLoadTask=Se(()=>Me()),this.addHandles([e.on("vertex-add",n=>this.onVertexAdd(n)),e.on("vertex-remove",n=>this.onVertexRemove(n)),e.on("vertex-update",n=>this.onVertexUpdate(n)),e.on("cursor-update",n=>this.onCursorUpdate(n)),e.on("cursor-remove",()=>this._updateGraphic()),e.on("complete",n=>this.onComplete(n)),this._coordinateFormatterLoadTask,i.on("paste",n=>Ce(n,this.activeTooltipInfo)),I(()=>this.cursor,n=>{e.cursor=n},W),vt(()=>{const{activeTooltipInfo:n,sketchOptions:r}=this;nn(n,this._tooltipsContext),i.info=r.tooltips.effectiveEnabled?n:null}),vt(()=>{e.constraintZ=hn(this._tooltipsContext)},Te)]),this.finishToolCreation(),e.initializePointer()}destroy(){this.drawOperation=H(this.drawOperation),this.tooltip=H(this.tooltip),this._destroyAllVisualizations(),this.view.map.remove(this.internalGraphicsLayer),this.internalGraphicsLayer=H(this.internalGraphicsLayer),this._set("view",null)}get _drawSpatialReference(){return this.drawOperation.coordinateHelper.spatialReference}get _tooltipsContext(){const{defaultZ:t,directionOptions:e,drawOperation:i,forceUniformSize:n,geometryType:r,graphic:c,sketchOptions:p,tooltipInfos:a,view:l,automaticAreaMeasurementUtils:u,automaticLengthMeasurementUtils:g}=this;return{createOperationGeometry:this._createOperationGeometry,defaultZ:t,directionOptions:e,drawOperation:i,forceUniformSize:n,geometryType:r,graphic:c,sketchOptions:p,tooltipInfos:a,view:l,automaticAreaMeasurementUtils:u,automaticLengthMeasurementUtils:g}}get canRedo(){return this.drawOperation.canRedo}get canUndo(){return this.drawOperation.canUndo}set centered(t){this._set("centered",t),this._updateGraphic()}get cursor(){return this._get("cursor")}set cursor(t){this._set("cursor",t)}set enabled(t){this.drawOperation.interactive=t,this._set("enabled",t)}set forceUniformSize(t){this._set("forceUniformSize",t),this._updateGraphic()}get graphic(){return this._graphic}set graphicSymbol(t){this._set("graphicSymbol",t),this._graphic!=null&&(this._graphic.symbol=t)}set mode(t){const e=this.drawOperation;e&&(e.drawingMode=t),this._set("mode",t)}get updating(){return this.drawOperation?.updating??!1}get undoRedo(){const{view:{type:t,map:e}}=this;return t==="2d"&&e&&"undoRedo"in e&&e.undoRedo instanceof T?e.undoRedo:null}set undoRedo(t){this._override("undoRedo",t)}completeCreateOperation(){this.drawOperation.complete()}onInputEvent(t){this.destroyed||Ie(t,this.tooltip)||this.drawOperation.onInputEvent(t)}redo(){this.drawOperation.redo()}reset(){}undo(){this.drawOperation.undo(),this.drawOperation.numCommittedVertices===0&&$t(this._tooltipsContext)}_destroyAllVisualizations(){this.removeHandles(x.outline),this.removeHandles(x.regularVertices),this.removeHandles(x.activeVertex),this.removeHandles(x.activeEdge),this.removeHandles(lt)}_createOrUpdateGraphic(t){if(this._graphic!=null)return this.updateGraphicGeometry(t),this._graphic;const e=new xe({...this.graphicProperties,symbol:this.graphicSymbol});return this._graphic=e,this.updateGraphicGeometry(t),this.internalGraphicsLayer.add(e),this.addHandles(this.initializeGraphic(e)),this.notifyChange("graphic"),this.addHandles(Y(()=>{this.internalGraphicsLayer.remove(e),this._graphic===e&&(this._graphic=null)}),lt),e}updateGraphicGeometry(t){this._graphic.geometry=t}_getCreateOperationGeometry(t={operationComplete:!1}){if(this.drawOperation==null)return;const{coordinateHelper:e,view:i,visualizationCursorVertex:n,lastVertex:r,committedVertices:c,geometryIncludingUncommittedVertices:p,numCommittedVertices:a}=this.drawOperation;if(!(a>0||n!=null))return;const l=t.operationComplete?c:p,u=l.length,g=n!=null?e.pointToArray(n):null,y=this._drawSpatialReference,f=i.type==="3d"&&i.viewingMode==="global",d=new Hi;d.committedVertices=c,d.cursorVertex=g;const{geometryType:O}=this;switch(O){case"point":case"mesh":d.full=e.arrayToPoint(l[0]);break;case"multipoint":d.full=u>0?Ue(l,y):null;break;case"polyline":case"polygon":u>0&&(d.full=O==="polygon"?$e([l],y,f,!0):kt([l],y,f),d.cursorEdge=g!=null&&r&&!Q(n,r)?kt([[g,e.pointToArray(r)]],y,f):null,d.outline=u>1?d.full:null);break;case"circle":case"rectangle":{if(d.committedVertices=d.cursorVertex=null,!u)break;const v=He(i,l[0]),k=l[0],_=v.makeMapPoint(k[0]+mn*i.resolution,k[1]);O==="circle"?u===1&&t.operationComplete?d.circle=Tt([k,_],v,!0):u===2&&(this.forceUniformSize?d.circle=Tt(l,v,this.centered):d.rectangle=Re(l,v,this.centered)):u===1&&t.operationComplete?d.rectangle=Pt([k,_],v,!0):u===2&&(d.rectangle=this.forceUniformSize?Pt(l,v,this.centered):Ee(l,v,this.centered)),d.full=d.circle!=null?d.circle.geometry:d.rectangle?.geometry,d.outline=d.full?.type==="polygon"?d.full:null;break}default:return null}return d}initializeGraphic(t){return Y()}onComplete(t){if(!this.drawOperation)return;this._updateGraphic();let e=null;if(this.drawOperation.isCompleted){const i=this._getCreateOperationGeometry({operationComplete:!0});i!=null&&(e=this._createOrUpdateGraphic(i.full))}this._createOperationGeometry=null,this.emit("complete",{graphic:e,...t})}onCursorUpdate(t){this._updateGraphic(),this.emit("cursor-update",t)}onDeactivate(){const{drawOperation:t}=this;t&&(t.isCompleted||t.cancel())}onOutlineChanged(t){return Y()}onCursorEdgeChanged(t){return Y()}onVertexAdd(t){Ut(this._tooltipsContext),this._updateGraphic(),this.elevationLockOnVertexAddDisabled||tn(t.vertices.at(0)?.coordinates,this._tooltipsContext),this.emit("vertex-add",t)}onVertexRemove(t){Ut(this._tooltipsContext),this._updateGraphic(),this.emit("vertex-remove",t)}onVertexUpdate(t){this._updateGraphic(),this.emit("vertex-update",t)}_updateGraphic(){const t=this._getCreateOperationGeometry();this._createOperationGeometry=t,t!=null?(t.cursorEdge!=null?this.addHandles(this.onCursorEdgeChanged(t.cursorEdge),x.activeEdge):this.removeHandles(x.activeEdge),t.outline!=null?this.addHandles(this.onOutlineChanged(t.outline),x.outline):this.removeHandles(x.outline),t.committedVertices!=null?this.addHandles(this.onRegularVerticesChanged(t.committedVertices),x.regularVertices):this.removeHandles(x.regularVertices),t.cursorVertex!=null?this.addHandles(this.onActiveVertexChanged(t.cursorVertex),x.activeVertex):this.removeHandles(x.activeVertex),t.full!=null?this._createOrUpdateGraphic(t.full):this.removeHandles(lt)):this._destroyAllVisualizations()}get activeTooltipInfo(){return this._coordinateFormatterLoadTask?.finished?ht(this._tooltipsContext):null}};o([s()],m.prototype,"_coordinateFormatterLoadTask",void 0),o([s()],m.prototype,"_createOperationGeometry",void 0),o([s()],m.prototype,"_tooltipsContext",null),o([s({value:!0})],m.prototype,"centered",null),o([s()],m.prototype,"cursor",null),o([s({nonNullable:!0})],m.prototype,"defaultZ",void 0),o([s({constructOnly:!0})],m.prototype,"directionOptions",void 0),o([s()],m.prototype,"drawOperation",void 0),o([s()],m.prototype,"elevationLockOnVertexAddDisabled",void 0),o([s({value:!0})],m.prototype,"enabled",null),o([s({value:!0})],m.prototype,"forceUniformSize",null),o([s({constructOnly:!0})],m.prototype,"geometryType",void 0),o([s()],m.prototype,"graphic",null),o([s({constructOnly:!0})],m.prototype,"graphicProperties",void 0),o([s()],m.prototype,"graphicSymbol",null),o([s({constructOnly:!0})],m.prototype,"hasZ",void 0),o([s({constructOnly:!0})],m.prototype,"geometryToPlace",void 0),o([s()],m.prototype,"mode",null),o([s()],m.prototype,"snappingManager",void 0),o([s()],m.prototype,"snapToScene",void 0),o([s()],m.prototype,"tooltip",void 0),o([s()],m.prototype,"tooltipInfos",void 0),o([s({constructOnly:!0,type:ee})],m.prototype,"sketchOptions",void 0),o([s()],m.prototype,"updating",null),o([s({constructOnly:!0,nonNullable:!0})],m.prototype,"view",void 0),o([s({constructOnly:!0})],m.prototype,"automaticAreaMeasurementUtils",void 0),o([s({constructOnly:!0})],m.prototype,"automaticLengthMeasurementUtils",void 0),o([s({constructOnly:!0})],m.prototype,"undoRedo",null),o([s()],m.prototype,"activeTooltipInfo",null),m=o([b("esri.views.draw.DrawGraphicTool")],m);const lt=Symbol("create-operation-graphic"),x={outline:Symbol("outline-visual"),regularVertices:Symbol("regular-vertices-visual"),activeVertex:Symbol("active-vertex-visual"),activeEdge:Symbol("active-edge-visual")};function Wn(t){switch(t){case"point":case"polyline":case"polygon":case"multipoint":return t;case"circle":case"rectangle":return"segment";case"mesh":return"point"}}const mn=48,ge="click";let w=class extends Ft{constructor(t){super(t),this.events=new ke,this.interactive=!0,this.selectable=!1,this.cursor=null,this.grabbable=!0}intersectionDistance(t,e){return 0}attach(){}detach(){}onElevationChange(){}onViewChange(){}};o([s()],w.prototype,"interactive",void 0),o([s()],w.prototype,"selectable",void 0),o([s()],w.prototype,"cursor",void 0),o([s()],w.prototype,"grabbing",void 0),o([s()],w.prototype,"grabbable",void 0),o([s()],w.prototype,"consumesClicks",void 0),o([s()],w.prototype,"grabbableForEvent",void 0),o([s()],w.prototype,"dragging",void 0),o([s()],w.prototype,"hovering",void 0),o([s()],w.prototype,"selected",void 0),w=o([b("esri.views.draw.LegacyDrawManipulator")],w);const yn="crosshair",fn="progress",Zt=Symbol(),Lt=Symbol();let h=class extends Pe{constructor(t){super(t),this._createOperationCompleted=!1,this._hideDefaultCursor=!1,this._pointerDownStates=new ze,this._stagedScreenPoint=null,this._stagedPointerType=null,this._updatingHandles=new At,this._stagedPointerId=null,this.constraintsEnabled=!1,this.constraints=void 0,this._getPointConstraint=Vt(ji),this._getPolylineOrPolygonConstraint=Vt(Yi),this.constraintZ=null,this.defaultZ=null,this.isDraped=!0,this.labelOptions=new ie,this.cursor=null,this.loading=!1,this.snapToSceneEnabled=null,this.firstVertex=null,this.lastVertex=null,this.secondToLastVertex=null,t.elevationInfo==null&&(this.elevationInfo=Ne(!!t.hasZ))}initializePointer(){const t=this.view.inputManager?.latestPointerInfo;t!=null&&this._updatePointer(t.location,t.id,t.type)}initialize(){const{geometryType:t,view:e}=this,i=e.spatialReference,n="viewingMode"in e.state?e.state.viewingMode:2,r=t==="segment"||t==="multipoint"?"polyline":t;this.coordinateHelper=vi(this.hasZ,this.hasM,i),this._editGeometryOperations=new _i(new wi(r,this.coordinateHelper),n),this._snappingOperation=new Si({view:e}),this.addHandles([I(()=>({stagedPoint:this._snappingOperation.stagedPoint,constraint:this._constraint}),({stagedPoint:a,constraint:l},u)=>{const{snappingOptions:g}=this;if(g&&(g.forceDisabled=l!=null&&ni(l)),u!=null&&a===u.stagedPoint&&l!==u.constraint)return this._onKeyboardBasedChange();this._processCursor(a??this._screenToMap(this._stagedScreenPoint))},{equals:(a,l)=>a.stagedPoint===l.stagedPoint&&_e(a.constraint,l.constraint)}),I(()=>this.view.viewpoint,(a,l)=>{a&&l&&fi(a,l)&&this._onKeyboardBasedChange()})]),this._activePart=new xi(i,n),this._editGeometryOperations.data.parts.push(this._activePart);const c=this.segmentLabels;c!=null&&(c.context={view:e,editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,labelOptions:this.labelOptions,automaticLengthMeasurementUtils:this.automaticLengthMeasurementUtils},this.addHandles(I(()=>this.labelOptions.enabled,a=>{c.visible=a},W))),this.addHandles(this._editGeometryOperations.on(["vertex-add","vertex-update","vertex-remove"],a=>{const l=a.vertices.map(d=>({componentIndex:0,vertexIndex:d.index,coordinates:this.coordinateHelper.vectorToArray(d.pos)})),u=l.map(d=>d.coordinates),g=this.coordinateHelper.vectorToDehydratedPoint(this._activePart.getFirstVertex()?.pos)??null;Q(g,this.firstVertex)||(this.firstVertex=g);const y=this.coordinateHelper.vectorToDehydratedPoint(this._activePart.getLastVertex()?.pos)??null;Q(y,this.lastVertex)||(this.lastVertex=y);const f=this.coordinateHelper.vectorToDehydratedPoint(this._activePart.segments.at(-1)?.leftVertex?.pos)??null;switch(Q(f,this.secondToLastVertex)||(this.secondToLastVertex=f),this._processCursor(this.cursorVertex),a.type){case"vertex-add":this.emit(a.type,{...a,added:u,vertices:l});break;case"vertex-update":this.emit(a.type,{...a,updated:u,vertices:l});break;case"vertex-remove":this.emit(a.type,{...a,removed:u,vertices:l})}}));const p=this._manipulator=new w({consumesClicks:!1,grabbableForEvent:a=>this.drawingMode!=="click"||a.pointerType==="touch"&&this._snappingEnabled&&this._pointerDownStates.size===1});this.manipulators.add(p),p.grabbable=t!=="point"&&t!=="multipoint",this.addHandles([p.events.on("immediate-click",a=>this._onImmediateClick(a)),p.events.on("immediate-double-click",a=>this._onImmediateDoubleClick(a)),I(()=>this.drawingMode,()=>{this.removeHandles(Zt),this.addHandles(this._createManipulatorDragPipeline(p),Zt)},W),I(()=>({effectiveCursor:this.effectiveCursor}),({effectiveCursor:a})=>{p.cursor=a},W)]),oi(this,()=>{const a=this.view.inputManager.latestPointerInfo?.type??"mouse",l=this._getSnappingContext(a);if(this.snappingManager!=null){const u=this._snappingOperation.snapAgainNearPreviousMapPoint(this.snappingManager,l);this._updatingHandles.addPromise(_t(u))}})}destroy(){H(this.segmentLabels),H(this._snappingOperation),this._editGeometryOperations=H(this._editGeometryOperations),this._updatingHandles.destroy()}get _isDragging(){const{_stagedPointerId:t,_manipulator:e}=this;return t!=null&&this._pointerDownStates.has(t)||e.grabbing||!e.interactive}get _snappingEnabled(){return this.snappingManager!=null&&this.snappingManager.options.effectiveEnabled}get _requiresScenePoint(){const t=this._updateAndGetEffectiveDrawSurface();return this.view.type==="3d"&&this.drawSurface!==t}get canRedo(){return this._editGeometryOperations.canRedo}get canUndo(){return this._editGeometryOperations.canUndo}get committedVertices(){return this._activePart.vertices.map(t=>this.coordinateHelper.vectorToArray(t.pos))}get _constraint(){const{constraints:t,constraintsEnabled:e}=this;if(t&&e)switch(this.geometryType){case"point":case"multipoint":return this._getPointConstraint(t);case"polygon":case"polyline":return this._getPolylineOrPolygonConstraint(this.lastVertex,this.secondToLastVertex,t)}}set drawingMode(t){this._set("drawingMode",t??ge)}get effectiveCursor(){return this.loading?fn:this._hideDefaultCursor?null:this.cursor||yn}get interactive(){return this._manipulator.interactive}set interactive(t){this._manipulator.interactive=t}get isCompleted(){return this._createOperationCompleted}get numCommittedVertices(){return this._activePart.vertices.length}get snappingOptions(){return this.snappingManager!=null?this.snappingManager.options:null}get cursorVertex(){return this._get("cursorVertex")}get visualizationCursorVertex(){return this._stagedPointerType==="mouse"?this.cursorVertex:null}get committableVertex(){const{cursorVertex:t,lastVertex:e,firstVertex:i,geometryType:n}=this;return n==="polygon"&&st(t,i)||st(t,e)?null:t}get updating(){return this._updatingHandles.updating}get geometryIncludingUncommittedVertices(){const{committedVertices:t,committableVertex:e,coordinateHelper:i}=this,n=t.slice();return e!=null&&n.push(i.pointToArray(e)),n}cancel(){this.complete({aborted:!0})}commitStagedVertex(){this._snappingOperation.abort();const{committableVertex:t}=this;t!=null&&this._editGeometryOperations.appendVertex(this.coordinateHelper.pointToVector(t),this._activePart)}complete(t){const e=t?.aborted||!1;this._snappingOperation.abort(),this.snappingManager?.doneSnapping();const{geometryType:i,numCommittedVertices:n}=this,r=i==="multipoint"&&n===0||i==="polyline"&&n<2||i==="polygon"&&n<3;i!=="segment"&&i!=="point"||this.commitStagedVertex(),this._createOperationCompleted=!r,(this.isCompleted||e)&&(this._stagedScreenPoint=null,this._stagedPointerId=null,this._stagedPointerType=null,this._processCursor(null),this.emit("complete",{vertices:this.committedVertices.map((c,p)=>({componentIndex:0,vertexIndex:p,coordinates:c})),aborted:e,type:"complete"}))}onInputEvent(t){switch(t.type){case"pointer-down":this._pointerDownStates.add(t.pointerId);break;case"pointer-up":this._pointerDownStates.delete(t.pointerId)}switch(t.type){case"pointer-move":return this._onPointerMove(t);case"hold":return this._onHold(t)}}redo(){this._editGeometryOperations.redo()}undo(){this.snappingManager!=null&&this.snappingManager.doneSnapping(),this._editGeometryOperations.undo()}_processCursor(t){const e=wt(this.cursorVertex),i=wt(t),n=i&&(this._updateAndGetEffectiveDrawSurface()?.constrainZ(i)??i),r=this._snapToClosingVertex(n),c=this._applyConstraints(r);st(e,c)||(this._set("cursorVertex",c),this.segmentLabels?.set("stagedVertex",c!=null?this.coordinateHelper.pointToVector(c):null),c==null||this._stagedPointerType!=="mouse"?this.emit("cursor-remove"):this.emit("cursor-update",{updated:null,vertices:[{componentIndex:0,vertexIndex:this._activePart.vertices.length,coordinates:this.coordinateHelper.pointToArray(c)}],operation:"apply",type:"vertex-update"}))}_snapToClosingVertex(t){if(t==null||this._isDragging||this.geometryType!=="polygon"||this.numCommittedVertices<=2)return t;const e=this._mapToScreen(t);if(!e)return t;const i=this._activePart;return this._vertexWithinPointerDistance(i.vertices[0].pos,e)?this.firstVertex:this._vertexWithinPointerDistance(i.vertices.at(-1).pos,e)?this.lastVertex:t}_createManipulatorDragPipeline(t){switch(this.drawingMode){case"click":return this._createManipulatorDragPipelineClick(t);case"freehand":return this._createManipulatorDragPipelineFreehand(t);case"hybrid":return this._createManipulatorDragPipelineHybrid(t)}}_createManipulatorDragPipelineClick(t){return at(t,(e,i,n,r)=>{const c=r==="touch"&&this._snappingEnabled;if(this.isCompleted||!c)return;const{snappingStep:p,cancelSnapping:a}=ki({predicate:()=>c,snappingManager:this.snappingManager,snappingContext:new It({editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,feature:this.graphic,pointer:r,visualizer:this.snappingVisualizer,drawConstraints:this.constraints}),updatingHandles:this._updatingHandles,useZ:!this._requiresScenePoint});n=n.next(l=>(c&&this.snappingManager!=null&&this.snappingManager.doneSnapping(),l)).next(a),i.next(this._screenToMapDragEventStep()).next(l=>(l.action==="start"&&(this._processCursor(l.mapStart),(this.geometryType==="segment"||c&&!this.numCommittedVertices)&&this.commitStagedVertex()),l)).next(mi(this.view,this.elevationInfo)).next(...p).next(l=>(c&&(this._processCursor(l.mapEnd),l.action==="end"&&this.commitStagedVertex()),l)).next(l=>(l.action==="end"&&(this._stagedPointerType!=="mouse"&&this._snappingOperation.abort(),this.geometryType!=="segment"&&this.geometryType!=="point"||this.complete()),l))})}_createManipulatorDragPipelineFreehand(t){return at(t,(e,i)=>{this.isCompleted||i.next(this._screenToMapDragEventStep()).next(n=>(n.action==="start"&&(this._snappingOperation.abort(),this.committableVertex==null&&this._processCursor(n.mapStart),this.geometryType==="segment"&&this.commitStagedVertex()),n)).next(n=>{switch(n.action){case"start":case"update":this._processCursor(n.mapEnd),this.geometryType!=="polygon"&&this.geometryType!=="polyline"||this.commitStagedVertex();break;case"end":this.complete()}return n})})}_createManipulatorDragPipelineHybrid(t){return at(t,(e,i)=>{this.isCompleted||i.next(this._screenToMapDragEventStep()).next(n=>(n.action==="start"&&(this._snappingOperation.abort(),this.addHandles(this._editGeometryOperations.createUndoGroup(),Lt),this._processCursor(n.mapStart),this.commitStagedVertex()),n)).next(n=>{switch(n.action){case"start":case"update":this._processCursor(n.mapEnd),this.geometryType!=="polygon"&&this.geometryType!=="polyline"||this.commitStagedVertex();break;case"end":this._stagedPointerType!=="mouse"&&this._snappingOperation.abort(),this.removeHandles(Lt),this.geometryType!=="segment"&&this.geometryType!=="point"||this.complete()}return n})})}get _drawAtFixedElevation(){const{constraintsEnabled:t,constraintZ:e,geometryType:i,numCommittedVertices:n}=this;return t?e!=null||i==="segment"&&n>0:(i==="segment"||i==="polygon")&&n>0}_updateAndGetEffectiveDrawSurface(){const{constraintsEnabled:t,coordinateHelper:e,drawSurface:i,elevationDrawSurface:n,snapToSceneEnabled:r}=this;if(n==null)return i;if(!this.hasZ)return n.defaultZ=null,n;const c=this.elevationInfo?.mode;let p=this.defaultZ,a=t||c==="absolute-height";return r!=null&&(a=r),c==="on-the-ground"&&(a=!1),this._drawAtFixedElevation&&(p=(t?this.constraintZ:null)??e.getZ(this._activePart.vertices[0].pos),a=!1),a?i:(n.defaultZ=p,n)}_mapToScreen(t){return this._updateAndGetEffectiveDrawSurface()?.mapToScreen(t)}_onHold(t){this._snappingOperation.abort(),this.drawingMode==="click"&&t.pointerType==="touch"&&this._snappingEnabled&&this._processCursor(t.mapPoint),t.stopPropagation()}_onImmediateClick(t){if(!(t.pointerType==="mouse"&&t.button===2||this._manipulator.dragging))try{const{drawingMode:e,geometryType:i}=this;this._stagedPointerType=t.pointerType,this._stagedScreenPoint=t.screenPoint;const n=this._screenToMap(t.screenPoint);if(n==null||n==null||e==="freehand"&&i!=="point"&&i!=="multipoint")return;if(this._snappingEnabled&&this.cursorVertex!=null||this._processCursor(n),this.committableVertex==null)return void this.complete();this.commitStagedVertex(),t.pointerType!=="mouse"&&this._processCursor(null),(e==="freehand"&&this.geometryType!=="multipoint"||i==="point"||i==="segment"&&this.numCommittedVertices===2||i==="segment"&&e==="hybrid"&&this.numCommittedVertices===1)&&this.complete()}finally{t.stopPropagation()}}_onImmediateDoubleClick(t){this._manipulator.dragging||this.geometryType==="point"||(this.complete(),t.stopPropagation())}_onPointerMove(t){const e=ne(t.x,t.y);this._updatePointer(e,t.pointerId,t.pointerType)&&t.stopPropagation()}_updatePointer(t,e,i){return this._stagedScreenPoint=t,this._stagedPointerType=i,this._stagedPointerId=e,this._isDragging?(this._snappingOperation.abort(),!1):(this._processCursorMovementRelativeToSurface(t,i),!0)}_onKeyboardBasedChange(){this._stagedPointerType==="mouse"&&this._stagedScreenPoint&&this._stagedPointerId!=null&&!this._isDragging?this._processCursorMovementRelativeToSurface(this._stagedScreenPoint,this._stagedPointerType):this._snappingOperation.abort()}_processCursorMovementRelativeToSurface(t,e){const i=this._snappingOperation,n=this._screenToMap(t),r=this._requiresScenePoint?this.drawSurface?.screenToMap(t):null;if(n==null)return this._hideDefaultCursor=!0,this._processCursor(null),void i.abort();this._hideDefaultCursor=!1;const c=this.snappingManager;if(c==null)return this._processCursor(n),void i.abort();const p=this._getSnappingContext(e);this._updatingHandles.addPromise(_t(i.snap({point:n,scenePoint:r},c,p)))}_applyConstraints(t){const{_constraint:e,constraints:i}=this;if(!t||!i||!e)return t;const{context:n}=i,r=nt(t,n),c=r?e.closestTo(r):void 0;if(!c)return t;const p=Ki(c,t,n),a=this.view.type==="2d"||n.elevationInfo.mode!=="absolute-height";return p!=null&&a&&this.constraintZ!=null&&this.hasZ&&(p.z=this.constraintZ),p}_screenToMap(t){return t?this._updateAndGetEffectiveDrawSurface()?.screenToMap(t):null}_screenToMapDragEventStep(){let t=null;return e=>{if(e.action==="start"&&(t=this._screenToMap(e.screenStart)),t==null)return null;const i=this._screenToMap(e.screenEnd);return i!=null?{...e,mapStart:t,mapEnd:i}:null}}_vertexWithinPointerDistance(t,e){const i=this._mapToScreen(this.coordinateHelper.vectorToDehydratedPoint(t));return i!=null&&vn(i,e,25)}_getSnappingContext(t){const e=this._drawAtFixedElevation?this.elevationDrawSurface?.defaultZ:null;return new It({editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,pointer:t,feature:this.graphic,visualizer:this.snappingVisualizer,selfSnappingZ:e!=null?{value:e,elevationInfo:this.elevationInfo}:null,drawConstraints:this.constraints})}};function vn(t,e,i){const n=t.x-e.x,r=t.y-e.y;return n*n+r*r<=i}o([s()],h.prototype,"_hideDefaultCursor",void 0),o([s()],h.prototype,"_stagedPointerId",void 0),o([s()],h.prototype,"_isDragging",null),o([s()],h.prototype,"_snappingOperation",void 0),o([s()],h.prototype,"_snappingEnabled",null),o([s({constructOnly:!0})],h.prototype,"graphic",void 0),o([s()],h.prototype,"constraintsEnabled",void 0),o([s()],h.prototype,"constraints",void 0),o([s()],h.prototype,"_constraint",null),o([s()],h.prototype,"constraintZ",void 0),o([s()],h.prototype,"defaultZ",void 0),o([s()],h.prototype,"isDraped",void 0),o([s({constructOnly:!0})],h.prototype,"automaticLengthMeasurementUtils",void 0),o([s({value:ge})],h.prototype,"drawingMode",null),o([s({constructOnly:!0})],h.prototype,"elevationDrawSurface",void 0),o([s({constructOnly:!0})],h.prototype,"elevationInfo",void 0),o([s({constructOnly:!0,type:ie})],h.prototype,"labelOptions",void 0),o([s({constructOnly:!0})],h.prototype,"geometryType",void 0),o([s({constructOnly:!0})],h.prototype,"hasM",void 0),o([s({constructOnly:!0})],h.prototype,"hasZ",void 0),o([s()],h.prototype,"cursor",void 0),o([s()],h.prototype,"effectiveCursor",null),o([s()],h.prototype,"loading",void 0),o([s({constructOnly:!0})],h.prototype,"manipulators",void 0),o([s({constructOnly:!0})],h.prototype,"drawSurface",void 0),o([s({constructOnly:!0})],h.prototype,"segmentLabels",void 0),o([s({constructOnly:!0})],h.prototype,"snappingManager",void 0),o([s({constructOnly:!0})],h.prototype,"snappingVisualizer",void 0),o([s()],h.prototype,"snapToSceneEnabled",void 0),o([s({readOnly:!0})],h.prototype,"cursorVertex",null),o([s({readOnly:!0})],h.prototype,"visualizationCursorVertex",null),o([s()],h.prototype,"committableVertex",null),o([s()],h.prototype,"firstVertex",void 0),o([s()],h.prototype,"lastVertex",void 0),o([s()],h.prototype,"secondToLastVertex",void 0),o([s()],h.prototype,"updating",null),o([s({constructOnly:!0})],h.prototype,"view",void 0),h=o([b("esri.views.draw.DrawOperation")],h);class Qn{constructor(e,i,n,r=null){this._elevationInfo=e,this.defaultZ=i,this._view=n,this._excludeGraphics=r}screenToMap(e){const{defaultZ:i,_view:n}=this,r=n.sceneIntersectionHelper.intersectElevationFromScreen(yi(e.x,e.y),this._elevationInfo,i??0,this._excludeGraphics);return i==null&&r!=null&&(r.z=void 0),r}mapToScreen(e){const i=ut(e.x,e.y,jt(this._view,e,this._elevationInfo),e.spatialReference);return this._view.toScreen(i)}constrainZ(e){const{defaultZ:i}=this;return i!=null&&e.z!==i&&((e=oe(e)).z=i),e}}class Xn{constructor(e,i,n=[]){this.view=e,this.elevationInfo=i,this.exclude=n}screenToMap(e){const i=this.view.toMap(e,{exclude:this.exclude,excludeLabels:!0});return i!=null&&(i.z=Be(i,this.view,this.elevationInfo)),i}mapToScreen(e){let i=e;return this.elevationInfo!=null&&(i=ut(e.x,e.y,jt(this.view,e,this.elevationInfo),e.spatialReference)),this.view.toScreen(i)}constrainZ(e){return e}}let to=class{constructor(t,e=!1,i=0){this.view=t,this.hasZ=e,this.defaultZ=i,this.mapToScreen=n=>t.toScreen(n),this.screenToMap=e?n=>{const r=t.toMap(n);return r.z=i,r}:n=>t.toMap(n)}constrainZ(t){const{defaultZ:e}=this;return this.hasZ&&t.z!==e&&((t=oe(t)).z=e),t}};class me{screenToMap(e){const{x:i,y:n}=e;return new qt({x:i,y:n,spatialReference:me.spatialReference})}mapToScreen(e){return ne(e.x,e.y)}constrainZ(e){return e}static{this.spatialReference=new Bt}}function eo(t,e){return ye(t,e,!1)}function io(t,e){return ye(t,e,!0)}function ye(t,e,i){if(t instanceof Oi){if(t.operation instanceof bi)return _n(t.operation,e,i),!0;if(t.operation instanceof Ti)return wn(t.operation,e,i),!0;if(t.operation instanceof Pi)return xn(t.operation,e,i),!0}return!1}function _n(t,e,i=!1){const n=i?-1:1,r=Oe(n*t.dx,n*t.dy,n*t.dz);X(e.origin,e.origin,r),it(e)}function wn(t,e,i=!1){const n=i?-t.angle:t.angle;Mt(e.basis1,e.basis1,Ot,n),Mt(e.basis2,e.basis2,Ot,n),it(e)}function xn(t,e,i=!1){const n=i?1/t.factor1:t.factor1,r=i?1/t.factor2:t.factor2;Ct(e.basis1,e.basis1,n),Ct(e.basis2,e.basis2,r),Ht(e.origin,e.origin,t.origin,t.axis1,n),Ht(e.origin,e.origin,t.origin,t.axis2,r),it(e)}function no(t,e,i,n,r=!1){n||(n=Vi());const c=z(Z.get(),t[1],-t[0]),p=z(Z.get(),Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),a=z(Z.get(),Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),l=Z.get(),u=e.allVerticesUnordered;u.forEach(({pos:d})=>{z(l,Dt(t,d),Dt(c,d)),Mi(p,p,l),Ci(a,a,l)});const g=1e-6,y=z(Z.get(),a[0]-p[0]<g?i/2:0,a[1]-p[1]<g?i/2:0);Ii(p,p,y),Di(a,a,y);const f=r?u.reduce((d,O)=>d+(O.pos[2]??0),0)/u.length:0;return Gt(n.basis1,t,(a[0]-p[0])/2),Gt(n.basis2,c,(a[1]-p[1])/2),Jt(n.origin,p[0]*t[0]+p[1]*c[0],p[0]*t[1]+p[1]*c[1],f),X(n.origin,n.origin,n.basis1),X(n.origin,n.origin,n.basis2),it(n),n}export{Qn as a,to as c,h as d,no as g,io as h,Xn as l,m,Wn as s,eo as u};
