const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/projectionUtils-Ca1qXe4h.js","assets/index-DqD_sEjA.js","assets/index-BWTVr3y1.css","assets/jsonMap-Bs3hmeCU.js","assets/SimpleObservable-CvFyr0NA.js","assets/collectionUtils-oMUPqMMC.js","assets/Point-Byf20bUE.js","assets/reader-DcGs6kKN.js","assets/reactiveUtils-SO2Ko3sy.js","assets/Extent-KC9qx-Cg.js","assets/Polyline-DWJWvQfr.js","assets/Polygon-BuPlovwL.js","assets/aaBoundingRect-C2DMsiYR.js","assets/mathUtils-PIGhLnI9.js","assets/projectMeshVertexPositions-BINb6PLA.js","assets/MeshLocalVertexSpace-BF5t-ZPw.js","assets/Color-CERqXxxY.js","assets/vertexSpaceConversion-BT6ySFv1.js","assets/mat4-Dyb44KrD.js","assets/mat4f64-q_b6UJoq.js","assets/vec32-D-LmkFhk.js","assets/spatialReferenceEllipsoidUtils-Dh5jNhp7.js","assets/computeTranslationToOriginAndRotation-D3f4P-V4.js","assets/projectPointToVector-CB8yc0oW.js","assets/meshVertexSpaceUtils-4wKFiYHz.js","assets/vec3-B_phcnZY.js","assets/BufferView-DJ6YhZlA.js","assets/vec42-B7JTmW9u.js","assets/vec2f64-rIxtbMRN.js","assets/vec4f64-DPb6J-GU.js","assets/vec4-B7mYuNMQ.js"])))=>i.map(i=>d[i]);
import{_ as x}from"./index-DqD_sEjA.js";import{T as z}from"./mathUtils-PIGhLnI9.js";import{an as G,f as D}from"./Point-Byf20bUE.js";import{u as k,f as q}from"./DoubleArray-DExKNiTh.js";import{a as K,i as Q}from"./MeshLocalVertexSpace-BF5t-ZPw.js";import{n as W,d as X}from"./vec3-B_phcnZY.js";import{n as Z,h as ee}from"./I3SMeshWorkerHandle-DY-0iCsS.js";import"./jsonMap-Bs3hmeCU.js";import"./reader-DcGs6kKN.js";import"./mat4f64-q_b6UJoq.js";import"./collectionUtils-oMUPqMMC.js";import"./reactiveUtils-SO2Ko3sy.js";import"./Extent-KC9qx-Cg.js";import"./SimpleObservable-CvFyr0NA.js";import"./Color-CERqXxxY.js";import"./WorkerHandle-BioJnATq.js";import"./workers-1ohSU8uJ.js";import"./Queue-CYlrXMwB.js";import"./intl-sjEXBsFq.js";import"./date-IqUzANpt.js";import"./projectionUtils-Ca1qXe4h.js";import"./Polyline-DWJWvQfr.js";import"./Polygon-BuPlovwL.js";import"./aaBoundingRect-C2DMsiYR.js";import"./projectVectorToVector-ClOaOAsc.js";import"./projectPointToVector-CB8yc0oW.js";function te(){return F??=(async()=>await(await x(()=>import("./i3s-DtWWdv1_.js"),[])).default({locateFile:t=>G(`esri/libs/i3s/${t}`)}))(),F}function re(){F=null}let F;async function Ne(e){o=await g();const t=[e.geometryBuffer];return{result:V(o,e,t),transferList:t}}async function ve(e){o=await g();const t=[e.geometryBuffer],{geometryBuffer:r}=e,a=r.byteLength,i=o._malloc(a),c=new Uint8Array(o.HEAPU8.buffer,i,a);c.set(new Uint8Array(r));const f=o.dracoDecompressPointCloudData(i,c.byteLength);if(o._free(i),f.error.length>0)throw new Error(`i3s.wasm: ${f.error}`);const m=f.featureIds?.length>0?f.featureIds.slice():null,p=f.positions.slice();return m&&t.push(m.buffer),t.push(p.buffer),{result:{positions:p,featureIds:m},transferList:t}}async function Re(e){await g(),ne(e);const t={buffer:e.buffer};return{result:t,transferList:[t.buffer]}}async function je(e){await g(),oe(e)}async function Ie(e){o=await g(),o.setLegacySchema(e.context,e.jsonSchema)}async function Ue(e){const{localMatrix:t,origin:r,positions:a,vertexSpace:i}=e,c=D.fromJSON(e.inSpatialReference),f=D.fromJSON(e.outSpatialReference),m=t?k(t):void 0,p=q(r);let l;const[{projectBuffer:_},{initializeProjection:O}]=await Promise.all([x(()=>import("./projectionUtils-Ca1qXe4h.js").then(s=>s.p),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13])),x(()=>import("./projectionUtils-Ca1qXe4h.js").then(s=>s.n),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13]))]);await O(c,f);const y=[0,0,0];if(!_(p,c,0,y,f,0))throw new Error("Failed to project");if(i.type==="georeferenced"&&i.origin==null){if(l=new Float64Array(a.length),!_(a,c,0,l,f,0,l.length/3))throw new Error("Failed to project")}else{const s=i.type==="georeferenced"?K.fromJSON(i):Q.fromJSON(i),{projectMeshVertexPositions:d}=await x(async()=>{const{projectMeshVertexPositions:T}=await import("./projectMeshVertexPositions-BINb6PLA.js");return{projectMeshVertexPositions:T}},__vite__mapDeps([14,0,1,2,3,4,5,6,7,8,9,10,11,12,13,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30])),E=d({vertexAttributes:{position:a},transform:m?{localMatrix:m}:void 0,vertexSpace:s,spatialReference:c},f);if(!E)throw new Error("Failed to project");l=E}const A=l.length,[w,L,u]=y;for(let s=0;s<A;s+=3)l[s]-=w,l[s+1]-=L,l[s+2]-=u;return{result:{projected:l,original:a,projectedOrigin:y},transferList:[l.buffer,a.buffer]}}async function Be({normalMatrix:e,normals:t}){const r=new Float32Array(t.length);return W(r,t,e),z(e)&&X(r,r),{result:{transformed:r,original:t},transferList:[r.buffer,t.buffer]}}function De(e){C(e)}let $,o;function oe(e){if(!o)return;const t=e.modifications,r=o._malloc(8*t.length),a=new Float64Array(o.HEAPU8.buffer,r,t.length);for(let i=0;i<t.length;++i)a[i]=t[i];o.setModifications(e.context,r,t.length,e.isGeodetic),o._free(r)}function V(e,t,r){const{context:a,globalTrafo:i,mbs:c,obbData:f,elevationOffset:m,geometryBuffer:p,geometryDescriptor:l,indexToVertexProjector:_,vertexToRenderProjector:O}=t,y=e._malloc(p.byteLength),A=33,w=e._malloc(A*Float64Array.BYTES_PER_ELEMENT),L=new Uint8Array(e.HEAPU8.buffer,y,p.byteLength);L.set(new Uint8Array(p));const u=new Float64Array(e.HEAPU8.buffer,w,A);P(u,[NaN,NaN,NaN]);let s=u.byteOffset+3*u.BYTES_PER_ELEMENT,d=new Float64Array(u.buffer,s);P(d,i),s+=16*u.BYTES_PER_ELEMENT,d=new Float64Array(u.buffer,s),P(d,c),s+=4*u.BYTES_PER_ELEMENT,f&&(d=new Float64Array(u.buffer,s),P(d,f));const E=l,T={isDraco:!1,isLegacy:!1,color:t.layouts.some(b=>b.some(h=>h.name==="color")),normal:t.needNormals&&t.layouts.some(b=>b.some(h=>h.name==="normalCompressed")),uv0:t.layouts.some(b=>b.some(h=>h.name==="uv0")),uvRegion:t.layouts.some(b=>b.some(h=>h.name==="uvRegion")),featureIndex:E.featureIndex},n=e.process(a,!!t.obbData,y,L.byteLength,E,T,w,m,_,O,t.normalReferenceFrame);if(e._free(w),e._free(y),n.error.length>0)throw new Error(`i3s.wasm: ${n.error}`);if(n.discarded)return null;const M=n.componentOffsets.length>0?n.componentOffsets.slice():null,S=n.featureIds.length>0?n.featureIds.slice():null,H=n.anchorIds.length>0?Array.from(n.anchorIds):null,Y=n.anchors.length>0?Array.from(n.anchors):null,N=n.interleavedVertedData.slice().buffer,v=n.indicesType===1?new Uint16Array(n.indices.buffer,n.indices.byteOffset,n.indices.byteLength/2).slice():new Uint32Array(n.indices.buffer,n.indices.byteOffset,n.indices.byteLength/4).slice(),R=n.positions.slice(),{buffer:j,byteOffset:I,byteLength:U}=n.positionIndices,B=n.positionIndicesType===1?new Uint16Array(j,I,U/2).slice():new Uint32Array(j,I,U/4).slice(),J=new Z(t.layouts[0],N,v,n.hasColors,n.hasModifications,{data:R,indices:B});return S&&r.push(S.buffer),M&&r.push(M.buffer),r.push(N),r.push(v.buffer),r.push(R.buffer),r.push(B.buffer),new ee(M,S,H,Y,J,i,n.obb)}function $e(e){return e===0?0:e===1?1:e===2?2:3}function ne(e){if(!o)return;const{context:t,buffer:r}=e,a=o._malloc(r.byteLength),i=r.byteLength/Float64Array.BYTES_PER_ELEMENT,c=new Float64Array(o.HEAPU8.buffer,a,i),f=new Float64Array(r);c.set(f),o.filterOBBs(t,a,i),f.set(c),o._free(a)}function C(e){o&&o.destroy(e)===0&&(o=null,$=null,re())}function P(e,t){for(let r=0;r<t.length;++r)e[r]=t[r]}async function Ve(){o||await g()}async function g(){return o||(o=await($??=te())),o}const Ce={transform:(e,t)=>o&&V(o,e,t),destroy:C};export{De as destroyContext,ve as dracoDecompressPointCloudData,Re as filterObbsForModifications,ne as filterObbsForModificationsSync,Ve as initialize,$e as interpretObbModificationResults,Ne as process,Ue as project,Ie as setLegacySchema,je as setModifications,oe as setModificationsSync,Ce as test,Be as transformNormals};
