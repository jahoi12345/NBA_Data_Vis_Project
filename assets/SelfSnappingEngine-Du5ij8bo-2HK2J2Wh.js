import{q as z,Y as L,H as R,G as Q}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{R as X,t as M}from"./collectionUtils-jDyktm0P-BDP2Oq99.js";import{u as Z,l as N}from"./Cyclical-BLSxUpe7-Bj8R2Yk-.js";import{aF as $,I as j}from"./ShadowCastClear.glsl-CeOT_rAo-BEYyVrmo.js";import{R as x}from"./elevationInfoUtils-B8MpdRMP-CDlK86wO.js";import{J as K,N as v,Q as g,X as f,Y as C,Z as l,U as P,a0 as k,a1 as U,a2 as T,a3 as W,a4 as Y,a5 as tt,a6 as et,F as rt,a7 as it,a8 as st}from"./euclideanLengthMeasurementUtils-CpHh36Dt-Ct4GxOU1.js";import{F as ot}from"./Point-BfTTZoMu-DeJwQYfh.js";import{U as A,b,j as nt,p as pt,d as at,ak as ht,aj as B}from"./Polygon-D6wEPb3W-D2MPjRU4.js";import{A as F,r as J}from"./angularMeasurementUtils-CP9gTlx0-ps9xKKJ5.js";import{o as G}from"./vec2f64-rIxtbMRN-Kai9mK1i.js";import{B as H,C as mt}from"./geometry2dUtils-B4vDf2wH-DzgYge1I.js";import{w as lt,$ as ct,L as dt}from"./vec32-CewSdTn3-VRto2OOh.js";import"./index-B0z_nLWi.js";import"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import"./Extent-CgDMOSRD-Bod5LY6s.js";import"./mathUtils-PIGhLnI9-B1tKUlUb.js";import"./Texture-CFNZjV2R-CxGjQ8pI.js";import"./mat4f64-q_b6UJoq-Dh6sWB_w.js";import"./Indices-D0_UQPPr-t1Qev6md.js";import"./BufferView-Cj2sQaht-avJ4OGB_.js";import"./vec42-B8VM4vXb-B6OGOEI9.js";import"./vec4f64-DPb6J-GU-C7c2DqbZ.js";import"./sphere-DLQ6p7mp-DyEe1Vll.js";import"./mat4-C96X-Nn0-BrMLOLCb.js";import"./vector-B8ZDYGQ6-DRILJdcx.js";import"./quatf64-CCm9z-pX-CQ7_sSji.js";import"./frustum-CMzahy3--B-DC1Co-.js";import"./Emissions.glsl-B8XKMjLy-DXfiRNVX.js";import"./Color-CERqXxxY-BuYn26eI.js";import"./aaBoundingBox-Cn49X7ge-BcYPaJ58.js";import"./orientedBoundingBox-BLEx7wLU-ByGP9QG1.js";import"./quat-B7J5v7rV-CZ9akUv-.js";import"./spatialReferenceEllipsoidUtils-D2JabnKt-Ce3ED0lc.js";import"./projectionUtils-BGH_5_I3-DGwchVO8.js";import"./Polyline-CoiTLswR-DTxpB2Yg.js";import"./InterleavedLayout-B7roQAzV-CdGz7mlm.js";import"./lengthUtils-Dt1_RvOO-j3MEdmHu.js";import"./date-IqUzANpt-bLKO9IDT.js";import"./projectVectorToVector-Csv3NYZI-DpBtmQMN.js";import"./normalizeUtils-85zLqeMi-C1bdAKNn.js";import"./normalizeUtilsCommon-CnhQye_A-UWhaH-kt.js";import"./typeUtils-DqrRcjBx-DZ6_Gsbu.js";import"./modeUtils-BA-mAwuS-DSb1K26b.js";import"./intl-DRFqUect-DPhFaHB2.js";import"./sanitizerUtils-BT_8V5US-CWQWUwZQ.js";import"./workers-BEkgoq8Q-BM_Hz460.js";import"./PooledRBush-Dco5QkUp-DX3CMhf3.js";import"./GraphicsCollection-Bk6M0b7D-Dk6KdmO7.js";import"./Graphic-DgGzDmqW-d1CNicxz.js";import"./getPopupProvider-CmskPttI-CzUWpGwk.js";import"./Layer-DZvC7bne-D3VLDrab.js";import"./typeUtils-CXW_VpOn-BGgLp_TK.js";import"./lineMarkers-CDwLe3J6-CNUjJvs3.js";import"./PolygonSymbol3D-BXRHZiCQ-BjPAY2LA.js";import"./ExtrudeSymbol3DLayer-DSc1ou2x-CsVYZCeG.js";import"./Font-BwmnW7d2-Dwh3xjKw.js";import"./SimpleFillSymbol-CDawtd9z-CWD2KI2D.js";import"./SimpleMarkerSymbol-BGAFRS9_-CVQ5NLIA.js";import"./PictureMarkerSymbol-CaSh-vZk-xhjZ61bb.js";import"./TextSymbol-hRGhyDHs-CoS7dSjf.js";import"./HeightModelInfo-D5IdRvJ2-23y6MRiu.js";import"./RealisticTree.glsl-WN9nrQUl-QZiY3aPA.js";import"./MeshLocalVertexSpace-BGd1IdEs-C0HJG4wR.js";import"./vec3f32-WCVSSNPR-9V6Uhrx-.js";import"./TilemapCache-CjhKW_vj-8gKqgQfa.js";import"./LRUCache-fy84PBMi-Y56WPIvD.js";import"./UpdatingHandles-D2RI_3Hb-dwLPjVun.js";import"./asyncUtils-w6KfWU41-HenJ0UOu.js";import"./Map-AEYszeHg-ZEOzAMWa.js";import"./Basemap-CL_uaRmk-O3l-dbYk.js";import"./PortalItem-DnxMlRVo-CI4Ns2_M.js";import"./writeUtils-DEFpwIW1-AHZYPaSV.js";import"./CollectionFlattener-D6h2Fkvj-WVl2BXw-.js";import"./resourceExtension-DOTCeiZj-C2WIbjQM.js";import"./PolygonCollection-HNNpnBH7-5UHgGprq.js";import"./mat4f32-Djp3mnm5-DzYG3LYB.js";import"./Query-BlS0WPDF-jdXS_Qhy.js";import"./Field-Cm_ZejYW-CwJZmSru.js";import"./fieldType-DVUzXtk_-tUuvnZJM.js";import"./ElevationQuery-DzlYa4L4-DkUTW9Ak.js";import"./TileInfo-Bz7QlefV-CdK7c8ef.js";import"./Scheduler-CNrsbccs-Bcg8fWoS.js";import"./constants-D67WmGms-H7IOwEdB.js";import"./floatRGBA-D-Q4FzNN-DQhowfyr.js";import"./UnknownTimeZone-B697BDFv-CBbtul7O.js";import"./TileKey-C44YQC4_-BW7BBbYp.js";import"./unitConversionUtils-4vB4Ezlp-DnY5MDxd.js";import"./vec2f32-CaVKkSa6-BjkBmyoj.js";import"./Octree-DckBBpQ7-CkRPu4UJ.js";import"./axisAngleDegrees-CjbXmycq-DcVVDR1-.js";import"./edgePreprocessing-D_eX-fWy-DqE-06Ss.js";import"./vec3-B_phcnZY-DHC7I6xa.js";import"./vec33-CWJeyzxV-Me4sF5XB.js";import"./utils-DTE-xBiC-uxMmcNif.js";import"./geodeticLengthOperator-ysQZ6ofQ-ChYlynyx.js";import"./reader-DcGs6kKN-DHJfK-tm.js";import"./SimpleObservable-CvFyr0NA-DXpoMYph.js";import"./jsonUtils-CmpazY1u-6pDLj5sx.js";import"./screenUtils-BitdhK1O-L0FLPAMi.js";import"./aaBoundingRect-CjwcS2F3-ri8bmh30.js";import"./projectPointToVector-DL7Z4uvb-CPbOlZdQ.js";import"./scaleUtils-yfx9kKWT-D9SVsyM-.js";import"./layerUtils-DZGhvm-W-CfyHx1TZ.js";import"./tagSymbols-BPcGfZon-BPcGfZon.js";import"./Queue-CYlrXMwB-CYJTUII-.js";import"./signal-BX9ezF8a-cf1Pn6io.js";import"./timeZoneUtils-BSc7-7qA-BAv3h8mh.js";import"./ReactiveMap-B0by2bYu-DCsCfMj5.js";import"./TablesMixin-Q80MT3nU-CBB9B-b6.js";import"./plane-BNdSPG2o-DTV5z6SO.js";import"./enums-B4pqBiXb-BO-3hS_8.js";import"./memoryEstimations-Bd726a_p-0cVCY2Jz.js";import"./VertexElementDescriptor-BlxU8vCE-BwuKQkTU.js";import"./computeTranslationToOriginAndRotation-Bjd4esRf-vJ4LbdOU.js";import"./layerViewUtils-BTa15X3o-BjQlX2q8.js";import"./dehydratedFeatures-Ql-uVzLq-aoK2987s.js";import"./quantizationUtils-Ceq-Uxsu-DjgKK_0s.js";import"./featureConversionUtils-BDA_FXJx-CDxX1Wik.js";import"./OptimizedFeature-CwRGZPwv-Ddclhn0A.js";import"./OptimizedFeatureSet-BR8EEvDc-CgsRgxJh.js";import"./createFeatureId-CVwTD0fV-3fKpJDrk.js";import"./HUDIntersectorResult-1xTExS7z-dL9SFL6u.js";import"./intersectorUtilsConversions-pLQPEbcN-Ck-nyNYa.js";import"./Intersector-DS9YtyQY-DMoYp6i0.js";import"./DefaultLoadingContext-DXgBe4GE-Unnb_XgV.js";import"./wosrLoader-CIPfz1Cl-DlmQQkMX.js";import"./Version-BtYZEj58-LyRHDnSJ.js";import"./DoubleArray-DExKNiTh-CvVpHySW.js";import"./config-Dg972SSE-D9DBKeq5.js";import"./GeometryUtils-C354xUs0-BLAznQrw.js";import"./definitions-Dvg4hMIw-CdK2DzFN.js";import"./WorkerHandle-B930SiRy-DglEKt53.js";import"./colorUtils-CeIi7j7j-C2WVx6th.js";import"./capabilities-Bi6C4OG6-CpURufko.js";import"./imageUtils-142g71N8-Wj0XNClb.js";import"./videoUtils-Dwx3AEgj-CduhpDRk.js";import"./uuid-Oe6SV2kF-IYX19xBA.js";import"./quickselect-QQC62dOK-Br2Ahhru.js";import"./meshVertexSpaceUtils-CtG7DPVT-kybwngCt.js";import"./TileKey-CXWFOqOI-Lra6v-mg.js";import"./loadAll-BCyxerwc-B4Lp8wGC.js";import"./opacityUtils-DuFH0EC9-DWspTgn2.js";import"./persistable-CdoDQOTR-BklJqWTn.js";import"./MD5-MtSiOt06-jWr180Yc.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw-DH8sdIsE.js";import"./utils-CylVuxNi--x86XOjU.js";import"./utils-Dpg4yj1D-CeFz2JVC.js";import"./types-BKo2foNY-DE0QfIFp.js";import"./labelUtils-BtizwBfq-Zegx4520.js";import"./ArcadeExpression-BlIRq-oN-VZkrwLVE.js";import"./TimeOnly-BERR31kg-CQiLyUZi.js";import"./enum-BzLwmiID-CcyIdWlQ.js";import"./FieldsIndex-CimK-TqD--24JoCkp.js";import"./geodeticCurveType-CirnHLSB-CirnHLSB.js";class q{constructor(r,t){this.view=r,this.options=t,this.squaredShortLineThreshold=P.shortLineThreshold*P.shortLineThreshold}snap(r,t){return t.vertexHandle!=null?t.vertexHandle.type!=="vertex"?[]:this.snapExistingVertex(r,t):this.snapNewVertex(r,t)}edgeExceedsShortLineThreshold(r,t){return this.exceedsShortLineThreshold(f(r.leftVertex.pos,this.view,t),f(r.rightVertex.pos,this.view,t),t)}exceedsShortLineThreshold(r,t,{spatialReference:e}){return this.squaredShortLineThreshold===0||T(v(t,e,x,this.view),v(r,e,x,this.view))>this.squaredShortLineThreshold}isVertical(r,t,{spatialReference:e}){const i=ot(e);return B(l(r),l(t))*i<P.verticalLineThresholdMeters}squaredProximityThreshold(r){return r==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityThreshold}get _squaredMouseProximityThreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:r,touchSensitivityMultiplier:t}=this.options,e=r*t;return e*e}}class gt extends q{constructor(r,t,e){super(r,t),this._geodesicLengthMeasurementUtils=e}snapNewVertex(r,t){const e=t.editGeometryOperations.data.parts[0],i=e.segments.length,o=[];if(i<1)return o;const{spatialReference:n}=t,p=v(r,n,x,this.view),{view:s}=this,a=e.segments[i-1];let h=a;do{if(g(h)&&this.edgeExceedsShortLineThreshold(h,t)){const c=C(h,s,t);this._processCandidateProposal(c.left,c.right,r,p,t,o)}h=h.leftVertex.leftSegment}while(h&&h!==a);return o}snapExistingVertex(r,t){const e=[],i=t.vertexHandle,o=i.part;if(o.segments.length<2)return e;const{view:n}=this,{spatialReference:p}=t,s=v(r,p,x,n),a=i.leftSegment,h=i.rightSegment;g(a)&&g(h)&&this.edgeExceedsShortLineThreshold(a,t)&&this.edgeExceedsShortLineThreshold(h,t)&&this._processCandidateProposal(f(a.leftVertex.pos,n,t),f(h.rightVertex.pos,n,t),r,s,t,e);const c=o.segments[0];let d=c;do{if(g(d)&&d!==i.leftSegment&&d!==i.rightSegment&&this.edgeExceedsShortLineThreshold(d,t)){const S=C(d,n,t);this._processCandidateProposal(S.left,S.right,r,s,t,e)}d=d.rightVertex.rightSegment}while(d&&d!==c);return e}_processCandidateProposal(r,t,e,i,o,n){const{spatialReference:p,pointer:s}=o,a=M();ft(a,r,t,e,o,this._geodesicLengthMeasurementUtils);const h=k(Y(a));T(i,v(h,p,x,this.view))<this.squaredProximityThreshold(s)&&n.push(new tt({lineStart:r,lineEnd:t,targetPoint:h,isDraped:o.elevationInfo?.mode==="on-the-ground"}))}}function ft(m,r,t,e,i,o){ut(m,r,t,e,i,o)||xt(m,e,r,t)}function ut(m,r,t,e,{spatialReference:i},o){const n=F(r,t,i,i);if(n==null)return!1;const p=F(t,e,i,i);if(p==null)return!1;const s=o.geodesicDistance(t,e,i);if(s==null)return!1;const a=Math.abs(Z.shortestSignedDiff(n,p))>Math.PI/2?N.normalize(n+Math.PI):n;return J(m,t,i,$(s,"meters"),j(a,"radians","geographic"),"geodesic"),m[2]=e[2],!0}function xt(m,r,t,e){st(r,{start:t,end:e,type:1},m),m[2]=r[2]}class vt extends q{snapNewVertex(r,t){const e=t.editGeometryOperations.data.parts[0],i=e.segments.length,o=e.vertices.length,n=[];if(i<2)return n;const{view:p}=this,s=v(r,t.spatialReference,x,p),a=e.vertices[0],h=e.vertices[o-1],c=g(h.leftSegment)?f(h.pos,p,t):null,d=g(a.rightSegment)?f(a.pos,p,t):null,S=e.segments[i-1];let u=S;do{if(g(u)&&this.edgeExceedsShortLineThreshold(u,t)){const V=C(u,p,t);c&&this._checkEdgeForParallelLines(V,c,r,s,t,n),d&&this._checkEdgeForParallelLines(V,d,r,s,t,n)}u=u.leftVertex.leftSegment}while(u&&u!==S);return n}snapExistingVertex(r,t){const e=[],i=t.vertexHandle,o=i.part;if(o.segments.length<3)return e;const{view:n}=this,p=v(r,t.spatialReference,x,n),s=i.leftSegment,a=i.rightSegment,h=o.vertices[0],c=f(h.pos,n,t),d=o.vertices.length,S=o.vertices[d-1],u=f(S.pos,n,t),V=o.segments[0];let w=V;do{if(g(w)&&w!==s&&w!==a&&this.edgeExceedsShortLineThreshold(w,t)){const E=C(w,n,t);g(s)&&this._checkEdgeForParallelLines(E,f(s.leftVertex.pos,n,t),r,p,t,e),g(a)&&this._checkEdgeForParallelLines(E,f(a.rightVertex.pos,n,t),r,p,t,e),i===h?this._checkEdgeForParallelLines(E,u,r,p,t,e):i===S&&this._checkEdgeForParallelLines(E,c,r,p,t,e)}w=w.rightVertex.rightSegment}while(w&&w!==V);return e}_checkEdgeForParallelLines(r,t,e,i,o,n){const p=r.left,s=r.right;if(H(y,l(t),l(p),l(s)),A(y,l(t))<P.parallelLineThreshold)return;H(y,l(e),l(p),l(s),l(t));const{spatialReference:a,pointer:h}=o,c=k(U(y[0],y[1],e[2]));if(T(i,v(c,a,x,this.view))<this.squaredProximityThreshold(h)){if(this.isVertical(c,t,o)||this.isVertical(p,s,o)||St(r,n))return;n.push(new W({referenceLine:r,lineStart:t,targetPoint:c,isDraped:o.elevationInfo?.mode==="on-the-ground"}))}}}function St(m,r){const t=m.left,e=m.right;for(const i of r)if(H(y,l(e),l(i.constraint.start),l(i.constraint.end),l(t)),A(y,l(e))<P.parallelLineThreshold)return i.addReferenceLine(m),!0;return!1}const y=G();class wt extends q{constructor(r,t,e){super(r,t),this._geodesicLengthMeasurementUtils=e}snapNewVertex(r,t){const e=t.editGeometryOperations.data.parts[0],i=[];if(e.vertices.length<2)return i;const{view:o}=this,n=v(r,t.spatialReference,x,o),p=e.vertices.at(-1);g(p.leftSegment)&&this._checkForSnappingCandidate(1,i,p.leftSegment,p,p.leftSegment.leftVertex,r,n,t);const s=e.vertices[0];return g(s.rightSegment)&&this._checkForSnappingCandidate(2,i,s.rightSegment,s,s.rightSegment.rightVertex,r,n,t),i}snapExistingVertex(r,t){const e=[],i=t.vertexHandle;if(i.part.vertices.length<3)return e;const{view:o}=this,n=v(r,t.spatialReference,x,o),p=i.leftSegment,s=i.rightSegment;if(g(p?.leftVertex.leftSegment)){const a=p.leftVertex.leftSegment;this._checkForSnappingCandidate(3,e,a,a.rightVertex,a.leftVertex,r,n,t)}if(g(s)&&g(s.rightVertex.rightSegment)){const a=s.rightVertex.rightSegment;this._checkForSnappingCandidate(3,e,a,a.leftVertex,a.rightVertex,r,n,t)}return e}_checkForSnappingCandidate(r,t,e,i,o,n,p,s){if(!g(e)||!this.edgeExceedsShortLineThreshold(e,s))return;const a=this.view,h=f(i.pos,a,s),c=f(o.pos,a,s);Vt(I,c,h,n,s,this._geodesicLengthMeasurementUtils),this._checkForSnappingCandidateAlongProjectedRay(r,t,c,h,I,n,p,s)}_checkForSnappingCandidateAlongProjectedRay(r,t,e,i,o,n,p,s){const{spatialReference:a,pointer:h}=s,c=b(O,l(n),l(i)),d=nt(o,c)/pt(o),S=at(O,l(i),o,d),u=k(U(S[0],S[1],n[2]));if(T(p,v(u,a,x,this.view))>this.squaredProximityThreshold(h)||this.isVertical(u,i,s)||this.isVertical(i,e,s))return;const V=lt(M(),i,o,Math.sign(d));t.push(new et({targetPoint:u,constraint:new rt(i,Y(V)),previousVertex:e,otherVertex:i,otherVertexType:1,selfSnappingType:r,isDraped:s.elevationInfo?.mode==="on-the-ground"}))}}function Vt(m,r,t,e,i,o){yt(m,r,t,e,i,o)||_t(m,r,t)}function yt(m,r,t,e,{spatialReference:i},o){const n=F(r,t,i,i);if(n==null)return!1;const p=F(t,e,i,i);if(p==null)return!1;const s=Math.sign(N.shortestSignedDiff(n,p))*Math.PI*.5,a=j(n+s,"radians","geographic"),h=M(),c=o.geodesicDistance(t,e,i);return c!=null&&(J(h,t,i,$(c,"meters"),a,"geodesic"),ct(m,h,t),!0)}function _t(m,r,t){const e=b(O,l(t),l(r));dt(m,e[1],-e[0],0)}const O=G(),I=M();class Lt extends q{snapNewVertex(r,t){const e=t.editGeometryOperations.data.parts[0],i=[],o=e.vertices.length;if(t.editGeometryOperations.data.type!=="polygon"||o<2)return i;const{view:n}=this,p=e.vertices[0],s=e.vertices[o-1];if(s.leftSegment&&s.leftSegment.type!=="line"||s.rightSegment&&s.rightSegment.type!=="line")return i;const a=f(p.pos,n,t),h=f(s.pos,n,t);return this._processCandidateProposal(a,h,r,t,i),i}snapExistingVertex(r,t){const e=[],i=t.vertexHandle,o=i.part;if(o.segments.length<2||t.editGeometryOperations.data.type==="polyline"&&(i.index===0||i.index===o.vertices.length-1)||i.leftSegment?.type!=="line"||i.rightSegment?.type!=="line")return e;const{view:n}=this,p=f(i.leftSegment.leftVertex.pos,n,t),s=f(i.rightSegment.rightVertex.pos,n,t);return this._processCandidateProposal(p,s,r,t,e),e}_processCandidateProposal(r,t,e,i,o){if(!this.exceedsShortLineThreshold(r,t,i))return;const n=ht(D,l(r),l(t),.5),p=.5*B(l(r),l(t)),s=mt(D,l(e),n,p),a=k(U(s[0],s[1],e[2])),{spatialReference:h,pointer:c}=i,d=v(e,h,x,this.view);if(T(d,v(a,h,x,this.view))<this.squaredProximityThreshold(c)){if(this.isVertical(r,a,i)||this.isVertical(a,t,i))return;o.push(new it({targetPoint:a,point1:r,point2:t,isDraped:i.elevationInfo?.mode==="on-the-ground"}))}}}const D=G();let _=class extends z{constructor(m){super(m),this.updating=!1,this._snappers=new X,this._domain=2}initialize(){this._snappers.push(new vt(this.view,this.options),new gt(this.view,this.options,this.geodesicLengthMeasurementUtils),new wt(this.view,this.options,this.geodesicLengthMeasurementUtils),new Lt(this.view,this.options))}set options(m){this._set("options",m);for(const r of this._snappers)r.options=m}async fetchCandidates(m,r,t){if(!(r&this._domain&&this.options.effectiveSelfEnabled))return[];const e=[];for(const i of this._snappers.items)for(const o of i.snap(m,t))e.push(o);return K(m,e),e}};L([R({readOnly:!0})],_.prototype,"updating",void 0),L([R({constructOnly:!0})],_.prototype,"view",void 0),L([R({constructOnly:!0})],_.prototype,"geodesicLengthMeasurementUtils",void 0),L([R()],_.prototype,"options",null),_=L([Q("esri.views.interactive.snapping.SelfSnappingEngine")],_);export{_ as SelfSnappingEngine};
