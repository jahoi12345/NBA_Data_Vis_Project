const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/deleteForwardEdits-CqMlbPuH.js","assets/Point-62ir3Nzl.js","assets/jsonMap-Bs3hmeCU.js","assets/reader-DcGs6kKN.js","assets/index-CB_zX-aI.js","assets/index-DJhoxO8W.css","assets/utils-uBZTDKaj.js","assets/DeleteForwardEditsParameters-TQS3KkAX.js"])))=>i.map(i=>d[i]);
import{_ as E,m as U,y as m,a5 as L,a as T}from"./jsonMap-Bs3hmeCU.js";import{i as k}from"./reactiveUtils-SO2Ko3sy.js";import{_ as j}from"./index-CB_zX-aI.js";import{H as x}from"./Point-62ir3Nzl.js";import{o as D}from"./uuid-Oe6SV2kF.js";const P=D(),V=new Map,A=new Map;async function J(e,r,a){if(!e||!a)return!1;if(!r)return!0;const t=new URL(e).host;let n=V.get(t);if(!n){const d=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,"");n=(await x(d,{responseType:"json",query:{f:"json"}})).data.defaultVersionName}return n===r}async function K(e,r,a=!1){if(!e||!r)return!0;const t=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),n=A.get(t)?.entries();if(n){for(const[d,s]of n)if(s.name===r){const c=!s.stack?.hasForwardEdits();if(!c&&a){const[{deleteForwardEdits:o},{default:h}]=await Promise.all([j(()=>import("./deleteForwardEdits-CqMlbPuH.js"),__vite__mapDeps([0,1,2,3,4,5,6])),j(()=>import("./DeleteForwardEditsParameters-TQS3KkAX.js"),__vite__mapDeps([7,2]))]),u=await o(t,d,new h({sessionId:P,moment:s.moment}));return u.success&&s.stack?.clearForwardEdits(),u.success}return c}}return!0}function O(e,r){if(!e)return!1;const a=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),t=A.get(a)?.entries();if(t){for(const[n,d]of t)if(d.name===r)return d.lockType==="edit"}return!1}const M=new k;function W(e){return M.on("apply-edits",new WeakRef(e))}function q(e){return M.on("update-moment",new WeakRef(e))}function Q(e,r,a=null,t=!1){const n=L();return t=r==null||t,M.emit("apply-edits",{serviceUrl:e,layerId:r,gdbVersion:a,mayReceiveServiceEdits:t,result:n.promise}),n}const H=Symbol();function X(e){return e!=null&&typeof e=="object"&&H in e}function p(e){return e!=null&&typeof e=="object"&&"gdbVersion"in e}function I(e,r,a){const t=new URL(e).host,n=V.get(t),d=s=>!s||s===n;return d(r)&&d(a)||r===a}const Y=e=>{var r;const a=e;let t=class extends a{static{r=H}constructor(...n){super(...n),this[r]=!0,this._applyEditsHandler=d=>{const{serviceUrl:s,layerId:c,gdbVersion:o,mayReceiveServiceEdits:h,result:u}=d,b=s===this.url,f=c!=null&&this.layerId!=null&&c===this.layerId,$=p(this),S=p(this)&&I(s,o,this.gdbVersion);if(!b||$&&!S||!f&&!h)return;const R=u.then(i=>{if(this.lastEditsEventDate=new Date,f&&(i.addedFeatures.length||i.updatedFeatures.length||i.deletedFeatures.length||i.addedAttachments.length||i.updatedAttachments.length||i.deletedAttachments.length))return this.emit("edits",m(i)),i;const y=i.editedFeatures?.find(({layerId:F})=>F===this.layerId);if(y){const{adds:F,updates:_,deletes:v}=y.editedFeatures,w={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:F?F.map(({attributes:l})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]})):[],deletedFeatures:v?v.map(({attributes:l})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]})):[],updatedFeatures:_?_.map(({current:{attributes:l}})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]})):[],editedFeatures:m(i.editedFeatures),exceededTransferLimit:!1,historicMoment:m(i.historicMoment)};return this.emit("edits",w),w}const g={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:[],deletedFeatures:[],updatedFeatures:[],editedFeatures:m(i.editedFeatures),exceededTransferLimit:!1,historicMoment:m(i.historicMoment)};return"historicMoment"in this&&this._shouldUpdateHistoricMoment(s,o,g.historicMoment)&&this.emit("edits",g),g}).then(i=>("historicMoment"in this&&this._shouldUpdateHistoricMoment(s,o,i.historicMoment)&&(this.historicMoment=i.historicMoment),i));this.emit("apply-edits",{result:R})},this._updateMomentHandler=d=>{const{serviceUrl:s,gdbVersion:c,moment:o}=d,h=s===this.url,u=p(this),b=p(this)&&I(s,c,this.gdbVersion),f=p(this)&&!I(s,this.gdbVersion,null);h&&u&&b&&f&&"historicMoment"in this&&this.historicMoment!==o&&(this.historicMoment=o)},this.when().then(()=>{this.addHandles(W(this._applyEditsHandler)),"historicMoment"in this&&this.addHandles(q(this._updateMomentHandler))},()=>{})}_shouldUpdateHistoricMoment(n,d,s){return"historicMoment"in this&&this.historicMoment!==s&&O(n,d)}};return E([U()],t.prototype,"lastEditsEventDate",void 0),t=E([T("esri.layers.mixins.EditBusLayer")],t),t};export{Y as F,O as a,Q as c,K as i,J as o,X as p,P as t};
