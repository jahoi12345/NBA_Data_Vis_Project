import{l as _,v as Z,o as tt,c4 as J}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{y as et,O as C}from"./mathUtils-PIGhLnI9-B1tKUlUb.js";import{z as nt}from"./Extent-CgDMOSRD-Bod5LY6s.js";import{a8 as rt}from"./Point-BfTTZoMu-DeJwQYfh.js";const O=()=>Z.getLogger("esri.views.2d.engine.flow.dataUtils"),ot=10;async function gt(d,t,r,h){const m=performance.now(),s=it(t,r),e=performance.now(),y=st(t,s,r.width,r.height),n=performance.now(),l=ct(y),a=performance.now(),A=d==="Streamlines"?ft(l,ot):ht(l),p=performance.now();return _("esri-2d-profiler")&&(O().info("I.1","_createFlowFieldFromData (ms)",Math.round(e-m)),O().info("I.2","_getStreamlines (ms)",Math.round(n-e)),O().info("I.3","createAnimatedLinesData (ms)",Math.round(a-n)),O().info("I.4","create{Streamlines|Particles}Mesh (ms)",Math.round(p-a)),O().info("I.5","createFlowMesh (ms)",Math.round(p-m)),O().info("I.6","Mesh size (bytes)",A.vertexData.buffer.byteLength+A.indexData.buffer.byteLength)),await Promise.resolve(),tt(h),A}function it(d,t){const r=at(t.data,t.width,t.height,d.smoothing);return d.interpolate?(h,m)=>{const s=Math.floor(h),e=Math.floor(m);if(s<0||s>=t.width)return[0,0];if(e<0||e>=t.height)return[0,0];const y=h-s,n=m-e,l=s,a=e,A=s<t.width-1?s+1:s,p=e<t.height-1?e+1:e,c=r[2*(a*t.width+l)],f=r[2*(a*t.width+A)],g=r[2*(p*t.width+l)],w=r[2*(p*t.width+A)],x=r[2*(a*t.width+l)+1],u=r[2*(a*t.width+A)+1];return[(c*(1-n)+g*n)*(1-y)+(f*(1-n)+w*n)*y,(x*(1-n)+r[2*(p*t.width+l)+1]*n)*(1-y)+(u*(1-n)+r[2*(p*t.width+A)+1]*n)*y]}:(h,m)=>{const s=Math.round(h),e=Math.round(m);return s<0||s>=t.width||e<0||e>=t.height?[0,0]:[r[2*(e*t.width+s)],r[2*(e*t.width+s)+1]]}}function j(d,t,r,h,m,s,e,y){const n=[],{raster:l,width:a,height:A,resolutionFactor:p}=y;let c=h,f=m,g=0,[w,x]=r(c,f);w*=t.velocityScale,x*=t.velocityScale;const u=Math.sqrt(w*w+x*x);let M,i;n.push({x:c,y:f,t:g,speed:u});for(let o=0;o<t.verticesPerLine;o++){let[v,T]=r(c,f);v*=t.velocityScale,T*=t.velocityScale;const U=Math.sqrt(v*v+T*T);if(U<t.minSpeedThreshold)return n;const $=d*v/U,P=d*T/U;if(c+=$*t.segmentLength,f+=P*t.segmentLength,t.wrapAround&&(c=C(c,s[0])),g+=d*t.segmentLength/U,Math.acos($*M+P*i)>t.maxTurnAngle)return n;if(t.collisions){let D=Math.round(c*p);const F=Math.round(f*p);if(t.wrapAround&&(D=C(D,a)),D<0||D>a-1||F<0||F>A-1)return n;const V=l[F*a+D];if(V!==-1&&V!==e)return n;l[F*a+D]=e}n.push({x:c,y:f,t:g,speed:U}),M=$,i=P}return n}function lt(d,t,r,h,m,s,e,y){const n=Math.round((.2+.6*e.getFloat())*d.verticesPerLine),l=d.verticesPerLine-n,a=j(-1,{...d,verticesPerLine:l},t,r,h,m,s,y),A=j(1,{...d,verticesPerLine:n},t,r,h,m,s,y),p=a.reverse();return p.splice(-1,1),p.concat(A)}function st(d,t,r,h,m={positions:[]}){if(d.density<=0)return[];const{positions:s}=m,e=[],y=new J,n=1/Math.max(d.lineCollisionWidth,1),l=Math.round(r*n),a=Math.round(h*n),A=new Int32Array(l*a);for(let u=0;u<A.length;u++)A[u]=-1;const p={raster:A,width:l,height:a,resolutionFactor:n},c={},f=d.lineSpacing/Math.sqrt(d.density),g=Math.floor(h/f),w=Math.floor(r/f);for(let u=0;u<g;u++){const M=u*f;for(let i=0;i<w;i++){const o=i*f;c[`${i}-${u}`]={x:o,y:M,positions:[]}}}for(const{x:u,y:M}of s){const i=c[`${Math.floor(u/f)}-${Math.floor(M/f)}`];i&&i.positions.push([u,M])}const x=[];for(const u in c){const M=c[u];if(M.positions.length===0)x.push({x:M.x+f/2,y:M.y+f/2,sort:.66+.33*y.getFloat(),stage:0});else{const[i]=M.positions.splice(0,1);x.push({x:i[0],y:i[1],sort:.33*y.getFloat(),stage:1});for(const[o,v]of M.positions)x.push({x:o,y:v,sort:.33+.33*y.getFloat(),stage:2})}}x.sort((u,M)=>u.sort-M.sort);for(const{x:u,y:M,stage:i}of x){const o=d.onlyForwardTracing?j(1,d,t,u,M,[r,h],e.length,p):lt(d,t,u,M,[r,h],e.length,y,p);o.length<2||e.push({stage:i,vertices:o})}return e}function at(d,t,r,h){if(h===0)return d;const m=Math.round(3*h),s=new Array(2*m+1);let e=0;for(let l=-m;l<=m;l++){const a=Math.exp(-l*l/(h*h));s[l+m]=a,e+=a}for(let l=-m;l<=m;l++)s[l+m]/=e;const y=new Float32Array(d.length);for(let l=0;l<r;l++)for(let a=0;a<t;a++){let A=0,p=0;for(let c=-m;c<=m;c++){if(a+c<0||a+c>=t)continue;const f=s[c+m];A+=f*d[2*(l*t+(a+c))],p+=f*d[2*(l*t+(a+c))+1]}y[2*(l*t+a)]=A,y[2*(l*t+a)+1]=p}const n=new Float32Array(d.length);for(let l=0;l<t;l++)for(let a=0;a<r;a++){let A=0,p=0;for(let c=-m;c<=m;c++){if(a+c<0||a+c>=r)continue;const f=s[c+m];A+=f*y[2*((a+c)*t+l)],p+=f*y[2*((a+c)*t+l)+1]}n[2*(a*t+l)]=A,n[2*(a*t+l)+1]=p}return n}function ct(d,t){const r=new J,h=d.reduce((n,l)=>n+l.vertices.length,0),m=new Float32Array(4*h),s=new Array(d.length);let e=0,y=0;for(const{vertices:n}of d){const l=e;for(const a of n)m[4*e]=a.x,m[4*e+1]=a.y,m[4*e+2]=a.t,m[4*e+3]=a.speed,e++;s[y++]={startVertex:l,numberOfVertices:n.length,totalTime:n[n.length-1].t,timeSeed:r.getFloat()}}return{lineVertices:m,lineDescriptors:s}}function ft(d,t){const{lineVertices:r,lineDescriptors:h}=d;let m=0,s=0;for(const p of h)m+=2*p.numberOfVertices,s+=6*(p.numberOfVertices-1);const e=new Float32Array(m*9),y=new Uint32Array(s);let n=0,l=0;function a(){y[l++]=n-2,y[l++]=n,y[l++]=n-1,y[l++]=n,y[l++]=n+1,y[l++]=n-1}function A(p,c,f,g,w,x,u,M){const i=n*9;let o=0;e[i+o++]=p,e[i+o++]=c,e[i+o++]=1,e[i+o++]=f,e[i+o++]=x,e[i+o++]=u,e[i+o++]=g/2,e[i+o++]=w/2,e[i+o++]=M,n++,e[i+o++]=p,e[i+o++]=c,e[i+o++]=-1,e[i+o++]=f,e[i+o++]=x,e[i+o++]=u,e[i+o++]=-g/2,e[i+o++]=-w/2,e[i+o++]=M,n++}for(const p of h){const{totalTime:c,timeSeed:f}=p;let g=null,w=null,x=null,u=null,M=null,i=null;for(let o=0;o<p.numberOfVertices;o++){const v=r[4*(p.startVertex+o)],T=r[4*(p.startVertex+o)+1],U=r[4*(p.startVertex+o)+2],$=r[4*(p.startVertex+o)+3];let P=null,D=null,F=null,V=null;if(o>0){P=v-g,D=T-w;const b=Math.sqrt(P*P+D*D);if(P/=b,D/=b,o>1){let I=P+M,q=D+i;const B=Math.sqrt(I*I+q*q);I/=B,q/=B;const S=Math.min(1/(I*P+q*D),t);I*=S,q*=S,F=-q,V=I}else F=-D,V=P;F!==null&&V!==null&&(A(g,w,x,F,V,c,f,$),a())}g=v,w=T,x=U,M=P,i=D,u=$}A(g,w,x,-i,M,c,f,u)}return{vertexData:e,indexData:y}}function ht(d){const{lineVertices:t,lineDescriptors:r}=d;let h=0,m=0;for(const F of r){const V=F.numberOfVertices-1;h+=4*V*2,m+=6*V*2}const s=new Float32Array(h*16),e=new Uint32Array(m);let y,n,l,a,A,p,c,f,g,w,x,u,M,i,o=0,v=0;function T(){e[v++]=o-8,e[v++]=o-7,e[v++]=o-6,e[v++]=o-7,e[v++]=o-5,e[v++]=o-6,e[v++]=o-4,e[v++]=o-3,e[v++]=o-2,e[v++]=o-3,e[v++]=o-1,e[v++]=o-2}function U(F,V,b,I,q,B,S,R,N,z,K,X,G,H){const k=o*16;let L=0;for(const Q of[1,2])for(const Y of[1,2,3,4])s[k+L++]=F,s[k+L++]=V,s[k+L++]=b,s[k+L++]=I,s[k+L++]=S,s[k+L++]=R,s[k+L++]=N,s[k+L++]=z,s[k+L++]=Q,s[k+L++]=Y,s[k+L++]=G,s[k+L++]=H,s[k+L++]=q/2,s[k+L++]=B/2,s[k+L++]=K/2,s[k+L++]=X/2,o++}function $(F,V){let b=g+x,I=w+u;const q=Math.sqrt(b*b+I*I);b/=q,I/=q;const B=g*b+w*I;b/=B,I/=B;let S=x+M,R=u+i;const N=Math.sqrt(S*S+R*R);S/=N,R/=N;const z=x*S+u*R;S/=z,R/=z,U(y,n,l,a,-I,b,A,p,c,f,-R,S,F,V),T()}function P(F,V,b,I,q,B){if(g=x,w=u,x=M,u=i,g==null&&w==null&&(g=x,w=u),A!=null&&p!=null){M=F-A,i=V-p;const S=Math.sqrt(M*M+i*i);M/=S,i/=S}g!=null&&w!=null&&$(q,B),y=A,n=p,l=c,a=f,A=F,p=V,c=b,f=I}function D(F,V){g=x,w=u,x=M,u=i,g==null&&w==null&&(g=x,w=u),g!=null&&w!=null&&$(F,V)}for(const F of r){y=null,n=null,l=null,a=null,A=null,p=null,c=null,f=null,g=null,w=null,x=null,u=null,M=null,i=null;const{totalTime:V,timeSeed:b}=F;for(let I=0;I<F.numberOfVertices;I++)P(t[4*(F.startVertex+I)],t[4*(F.startVertex+I)+1],t[4*(F.startVertex+I)+2],t[4*(F.startVertex+I)+3],V,b);D(V,b)}return{vertexData:s,indexData:e}}function E(d,t,r=t.width,h=t.height,m=0,s=0){const e=t.pixels,y=r*h,n=2,l=new Float32Array(y*n),a=t.width,A=(f,g)=>f+m+(g+s)*a,p=(f,g)=>f+g*r;let c;if(t.mask!=null)if(r!==t.width||h!==t.height||m!==0||s!==0){c=new Uint8Array(y*n);const f=t.mask;for(let g=0;g<h;++g)for(let w=0;w<r;++w){const x=A(w,g),u=p(w,g);c[n*u]=f[n*x],c[n*u+1]=f[n*x+1]}}else c=t.mask;else c=new Uint8Array(y*n),c.fill(255);if(d==="vector-uv")for(let f=0;f<h;++f)for(let g=0;g<r;++g){const w=A(g,f),x=p(g,f);l[n*x]=e[0][w],l[n*x+1]=-e[1][w]}else if(d==="vector-magdir"){const{cos:f,sin:g}=Math;for(let w=0;w<h;++w)for(let x=0;x<r;++x){const u=A(x,w),M=p(x,w),i=e[0][u],o=et(e[1][u]),v=f(o-Math.PI/2),T=g(o-Math.PI/2);l[n*M]=v*i,l[n*M+1]=T*i}}return{data:l,mask:c,width:r,height:h}}async function yt(d,t,r,h,m,s){const e=performance.now(),y=rt(t.spatialReference);if(!y){const i=await W(d,t,r,h,m,s);return _("esri-2d-profiler")&&O().info("I.7","loadImagery, early exit (ms)",Math.round(performance.now()-e)),_("esri-2d-profiler")&&O().info("I.9","Number of parts",1),i}const[n,l]=y.valid,a=l-n,A=Math.ceil(t.width/a),p=t.width/A,c=Math.round(r/A);let f=t.xmin;const g=[],w=performance.now();for(let i=0;i<A;i++){const o=new nt({xmin:f,xmax:f+p,ymin:t.ymin,ymax:t.ymax,spatialReference:t.spatialReference});g.push(W(d,o,c,h,m,s)),f+=p}const x=await Promise.all(g);if(_("esri-2d-profiler")&&O().info("I.8","All calls to _fetchPart (ms)",Math.round(performance.now()-w)),_("esri-2d-profiler")&&O().info("I.9","Number of parts",x.length),x.length===1)return _("esri-2d-profiler")&&O().info("I.10","loadImagery, general exit without stitching back (ms)",Math.round(performance.now()-e)),x[0];const u={data:new Float32Array(r*h*2),mask:new Uint8Array(r*h),width:r,height:h};let M=0;for(const i of x){for(let o=0;o<i.height;o++)for(let v=0;v<i.width;v++)M+v>=r||(u.data[2*(o*r+M+v)]=i.data[2*(o*i.width+v)],u.data[2*(o*r+M+v)+1]=i.data[2*(o*i.width+v)+1],u.mask[o*r+M+v]=i.mask[o*i.width+v]);M+=i.width}return _("esri-2d-profiler")&&O().info("I.10","loadImagery, general exit (ms)",Math.round(performance.now()-e)),u}async function W(d,t,r,h,m,s){const e={requestProjectedLocalDirections:!0,signal:s};if(m!=null&&(e.timeExtent=m),d.type==="imagery"){await d.load({signal:s});const n=await d.internalFetchImage(t,r,h,e);return n?.pixelData?.pixelBlock==null?{data:new Float32Array(r*h*2),mask:new Uint8Array(r*h),width:r,height:h}:E(d.rasterInfo.dataType,n.pixelData.pixelBlock)}await d.load({signal:s});const y=await d.fetchPixels(t,r,h,e);return y?.pixelBlock==null?{data:new Float32Array(r*h*2),mask:new Uint8Array(r*h),width:r,height:h}:E(d.serviceRasterInfo.dataType,y.pixelBlock)}export{E as J,yt as M,it as a,st as f,gt as x};
