const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/featureUtils-CMEuv67v-C9H0xYP0.js","assets/jsonMap-Bs3hmeCU-Cusd0Fmz.js","assets/date-IqUzANpt-bLKO9IDT.js","assets/reactiveUtils-SO2Ko3sy-BCLX8Jdy.js","assets/intl-DRFqUect-ClAS7BRt.js","assets/Point-BfTTZoMu-BAT2Wq6O.js","assets/index-CTl7hdrJ.js","assets/index-Cv2ko1Ob.css","assets/reader-DcGs6kKN-DHJfK-tm.js","assets/getPopupProvider-CmskPttI-C4PqyuPF.js","assets/collectionUtils-jDyktm0P-ArdXNs6F.js","assets/Extent-CgDMOSRD-CU1qE5Kr.js","assets/SimpleObservable-CvFyr0NA-DXpoMYph.js","assets/lengthUtils-Dt1_RvOO-bleznLOi.js","assets/Color-CERqXxxY-BuYn26eI.js","assets/mathUtils-PIGhLnI9-B1tKUlUb.js","assets/Layer-DZvC7bne-m1cEC_yw.js","assets/layerUtils-DZGhvm-W-DLw3QMll.js","assets/utils-BbtW4lHb-DKC09XMb.js","assets/mat4f32-Djp3mnm5-DzYG3LYB.js","assets/mat4-C96X-Nn0-Do6fKsNS.js","assets/Polygon-D6wEPb3W-CpL9Efjx.js","assets/aaBoundingRect-CjwcS2F3-D7aII9DY.js","assets/timeZoneUtils-BSc7-7qA-BAv3h8mh.js"])))=>i.map(i=>d[i]);
import{H as y,_ as g}from"./index-CTl7hdrJ.js";import{q as v,e as x,Y as r,H as n,G as I}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{H as _}from"./asyncUtils-w6KfWU41-HenJ0UOu.js";import{R as b}from"./collectionUtils-jDyktm0P-ArdXNs6F.js";import{i as j}from"./sanitizerUtils-BT_8V5US-CWQWUwZQ.js";import{d as T,D as F,a as U}from"./lengthUtils-Dt1_RvOO-bleznLOi.js";const f=(e,t=f,s=t.f||(t.f=["assets/featureUtils-CMEuv67v.js","assets/jsonMap-Bs3hmeCU.js","assets/date-IqUzANpt.js","assets/reactiveUtils-SO2Ko3sy.js","assets/intl-DRFqUect.js","assets/Point-BfTTZoMu.js","assets/reader-DcGs6kKN.js","assets/index-BzxsWNRw.js","assets/index-Cv2ko1Ob.css","assets/getPopupProvider-CmskPttI.js","assets/collectionUtils-jDyktm0P.js","assets/Extent-CgDMOSRD.js","assets/SimpleObservable-CvFyr0NA.js","assets/lengthUtils-Dt1_RvOO.js","assets/Color-CERqXxxY.js","assets/mathUtils-PIGhLnI9.js","assets/Layer-DZvC7bne.js","assets/layerUtils-DZGhvm-W.js","assets/utils-BbtW4lHb.js","assets/mat4f32-Djp3mnm5.js","assets/mat4-C96X-Nn0.js","assets/Polygon-D6wEPb3W.js","assets/aaBoundingRect-CjwcS2F3.js","assets/timeZoneUtils-BSc7-7qA.js"]))=>e.map(i=>s[i]),k="relationships/",P="expression/",w=/<br\s*\/*>/gi;let a=class extends v{constructor(e){super(e),this._featureUtils=null,this.effectivePopupTemplate=null}get _arcadeTask(){return this.expressionsUsedInTitle.length>0?this._get("_arcadeTask")||_(()=>U()):null}get featureUtilsPromise(){return this._get("featureUtilsPromise")??y(()=>g(()=>import("./featureUtils-CMEuv67v-C9H0xYP0.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23])),f([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23])).then(e=>this._featureUtils=e)}get calculatedExpressions(){const e=new b;if(!this.expressionsUsedInTitle.length)return e;if(!this._arcadeTask?.value){for(const t of this.expressionsUsedInTitle??[])e.push({name:t.name,invalid:!0});return e}for(const t of this.expressionsUsedInTitle)try{const s=this._arcadeTask.value.arcade.parseScript(t.expression,["$layer","$map","$datastore"]);if(s.isAsync){e.push({name:t.name,invalid:!0});break}e.push({name:t.name,syntax:s,invalid:!1,func:this._arcadeTask.value.arcade.compileScript(s,{vars:{$feature:"any"}})})}catch{e.push({name:t.name,invalid:!0});break}return e}get expressionsUsedInTitle(){let e=this.effectivePopupTemplate?.title??"";return typeof e!="string"?[]:(e=e.toLowerCase(),this.effectivePopupTemplate?.expressionInfos?.filter(t=>e.includes(`{expression/${t.name.toLowerCase()}}`))??[])}get fieldInfoMap(){return this._featureUtils?this._createFieldInfoMap(this._featureUtils.getAllFieldInfos(this.effectivePopupTemplate)):null}get hasBadExpressions(){return this.calculatedExpressions.some(e=>e.invalid===!0)}get requiredFields(){const e=new Set;if(this._arcadeTask?.value&&!this.hasBadExpressions)for(const s of this.calculatedExpressions?.toArray()??[])try{const i=this._arcadeTask.value.arcade.extractFieldLiterals(s.syntax);for(const o of i){const d=o.split("."),l=this.fieldsIndex.get(d.at(-1)??"");l&&e.add(l.name)}}catch{}const t=this._extractFieldNames(this.workingTitle);for(const s of t){const i=this.fieldsIndex.get(s);i&&e.add(i.name)}return this.objectIdField!=null&&e.add(this.objectIdField),e}get titleFromDisplayField(){let e="";return this.displayField&&(e=this.fieldsIndex.get(this.displayField)?.name??""),e||(e=this.fieldsIndex.get(this.objectIdField)?.name??""),e?`{${e}}`:""}get workingTitle(){const e=this.effectivePopupTemplate?this.effectivePopupTemplate.title:"";return e===""||e==null||this.hasBadExpressions||typeof e!="string"?this.titleFromDisplayField:e}async getTitle(e,t,s){const i=t.getObjectId()??t.attributes[e.objectIdField];return(await this.getTitles(e,[t],s)).get(i)??""}async getTitles(e,t,s){const i=new Map,o=s?.timeZone??"system";try{const[{substituteFieldsInLinksAndAttributes:d}]=await Promise.all([this.featureUtilsPromise,this._arcadeTask?.promise]);s?.fetchMissingFields&&(t=await this._checkAndReQueryGraphics(e,t));const{fieldInfoMap:l,workingTitle:c}=this,h=c&&l;t.forEach(u=>{const m=u.getObjectId()??u.attributes[e.objectIdField];let p=h?d({attributes:u.attributes,expressionAttributes:null,fieldInfoMap:l,globalAttributes:this._createFormattedAttributes(e,u,o).global,layer:e,text:c}):"";s?.removeHTML&&(p=j.sanitize(p).replaceAll(w," ")),i.set(m,p)})}catch{}return i}async _checkAndReQueryGraphics(e,t){const s=t.map(i=>i.getObjectId()??i.attributes[e.objectIdField]).filter(x);if(s.length!==t.length)return t;if(t.some(i=>!T(i,this.requiredFields))){const i=e.createQuery();i.where="1=1",i.outFields=[...this.requiredFields],i.objectIds=s;const o=await e.queryFeatures(i);if(o?.features.length===t.length)return o.features}return t}_createFieldInfoMap(e){const t=new Map;if(!e)return t;for(const s of e){if(!s.fieldName)continue;const i=this.fieldsIndex.get(s.fieldName),o=i?.name??s.fieldName;s.fieldName=o,t.set(o.toLowerCase(),s)}return t}_createFormattedAttributes(e,t,s="system"){const i=this.effectivePopupTemplate?.fieldInfos??[],o={};if(!this._featureUtils)return{};if(!this.hasBadExpressions&&this.calculatedExpressions.length>0&&this._arcadeTask?.value){const l=this._arcadeTask.value.Feature.createFromGraphicLikeObject(t.geometry,t.attributes,e,null);for(const c of this.calculatedExpressions)try{o[`expression/${c.name}`]=c.func({vars:{$feature:l}})}catch{}}const d={...t.attributes,...o};return{global:this._featureUtils.formatAttributes({fieldInfos:i,attributes:d,graphic:t,timeZone:s,layer:e,fieldInfoMap:this.fieldInfoMap}),content:[]}}_extractFieldNames(e){return F(e).filter(t=>!(t.startsWith(k)||t.startsWith(P)))}};r([n({readOnly:!0})],a.prototype,"_arcadeTask",null),r([n()],a.prototype,"_featureUtils",void 0),r([n({readOnly:!0})],a.prototype,"featureUtilsPromise",null),r([n({readOnly:!0})],a.prototype,"calculatedExpressions",null),r([n()],a.prototype,"displayField",void 0),r([n()],a.prototype,"effectivePopupTemplate",void 0),r([n()],a.prototype,"expressionsUsedInTitle",null),r([n()],a.prototype,"fieldsIndex",void 0),r([n()],a.prototype,"fieldInfoMap",null),r([n()],a.prototype,"fields",void 0),r([n()],a.prototype,"objectIdField",void 0),r([n()],a.prototype,"requiredFields",null),a=r([I("esri.layers.support.TitleCreator")],a);export{a as r};
