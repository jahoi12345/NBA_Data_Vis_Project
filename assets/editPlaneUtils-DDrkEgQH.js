import{l as At,_ as r,m as s,a as $,a9 as _e,p as vt,u as D,V as q,ag as _t,y as wt,ak as we}from"./jsonMap-Bs3hmeCU.js";import{_ as xe}from"./Graphic-DDayESOh.js";import{O as xt,n as Oe,r as be,i as Ot}from"./collectionUtils-oMUPqMMC.js";import{j as bt,l as C,w as J,U as $e,i as Te,c as Pe}from"./reactiveUtils-SO2Ko3sy.js";import{h as Ft}from"./UpdatingHandles-D2RI_3Hb.js";import{d as Ve}from"./asyncUtils-w6KfWU41.js";import{r as M,V as ke,R as Se,E as Me,c as Ce,H as Ie}from"./SketchTooltipInfo-27qR2s65.js";import Ee from"./GraphicsLayer-DSMtgy-C.js";import{a as Q,i as st}from"./dehydratedFeatureComparison-W3IVpx3G.js";import{W as De,k as $t,v as Ue,b as Tt,U as Ge,T as Re,j as Pt,R as He}from"./createUtils-DrmckW9P.js";import{aF as tt,I as ze,aB as Nt,aD as B,K as S,b6 as Ze,m as Le}from"./ShadowCastClear.glsl-CTBiNCmp.js";import{F as Vt,Q as ct,bs as Ae,f as jt,ax as Fe,b as Bt}from"./Point-Byf20bUE.js";import{c as Ne,y as je,I as Wt,U as Be,t as kt,i as We,E as qt,x as qe}from"./elevationInfoUtils-DnjVkdfR.js";import{o as Yt,c as Ye,s as Ke,u as X,w as St,g as Mt}from"./vec32-D-LmkFhk.js";import{h as W,M as Je,j as Qe,I as Kt,w as Jt,Q as Xe,U as ti}from"./TooltipInfoWithCoordinates-BgGYmCbC.js";import{R as U,j as Qt,U as ei,x as ii}from"./angularMeasurementUtils-CIyks-X7.js";import{T as G,a6 as pt,a7 as ni,a8 as Xt,a9 as oi,aa as te,ab as ri,E as si,ac as ai,n as li,N as ci,ad as pi,V as ui,ae as di,a2 as hi}from"./euclideanLengthMeasurementUtils-feyhInwu.js";import{r as gi,p as at,U as mi}from"./InteractiveToolBase-DGnHcwPi.js";import{l as ee,c as ie}from"./SketchOptions-Dguq2sp8.js";import{i as ne,f as yi}from"./screenUtils-BitdhK1O.js";import{y as fi}from"./diffUtils-CE43h1Bb.js";import{a as vi,g as _i,w as wi,V as xi,t as Oi,b as bi,o as $i,l as Ti}from"./EditGeometryOperations-CoEC_QOL.js";import{n as et,t as ut}from"./projectVectorToVector-ClOaOAsc.js";import{e as Ct}from"./SnappingContext-Do31l99O.js";import{f as Pi}from"./SnappingDragPipelineStep-CfseuoAy.js";import{p as Vi}from"./SnappingOperation-ClIdnPwp.js";import{x as oe,z as ki,J as it}from"./RealisticTree.glsl-CEyQWjjF.js";import{F as z,j as It,av as Si,aw as Mi,b as Ci,u as Ii,l as Et,as as Dt}from"./Polygon-BuPlovwL.js";import{t as Z}from"./vector-rshDErmj.js";const dt={UndoRedoUpdating:"Cannot perform operation whilst undo redo is updating",UndoInvalidError:"There are no items to Undo",RedoInvalidError:"There are no items to Redo"};class L extends Error{constructor(){super(dt.UndoRedoUpdating),this.type="undo-redo-updating-error"}}let Ei=class extends Error{constructor(){super(dt.UndoInvalidError),this.type="undo-redo-undo-error"}};class Ut extends Error{constructor(){super(dt.RedoInvalidError),this.type="undo-redo-redo-error"}}let T=class extends At{constructor(){super(...arguments),this._stack=new xt,this._stackPosition=-1,this._updatingHandles=new Ft}get updating(){return this._updatingHandles.updating}get canUndo(){return this.hasUndo&&!this.updating}get hasUndo(){return this._stackPosition>=0}get canRedo(){return this.hasRedo&&!this.updating}get hasRedo(){return this._stackPosition<this._stack.length-1}_truncateForwardStack(){this._stack.splice(this._stackPosition+1,this._stack.length-this._stackPosition).forEach(t=>t.destroy())}_drainStack(){this._stack.drain(t=>t.destroy()),this._stackPosition=-1}async undo(){if(!this.hasUndo)throw new Ei;if(this.updating)throw new L;const t=this._stack.getItemAt(this._stackPosition);t&&await this._updatingHandles.addPromise((async()=>{await t.executeUndoRedoOperation(1),--this._stackPosition,t.canRedo||this._truncateForwardStack()})())}async redo(){if(!this.hasRedo)throw new Ut;if(this.updating)throw new L;const t=this._stack.getItemAt(this._stackPosition+1);if(!t)throw new Ut;await this._updatingHandles.addPromise((async()=>{await t.executeUndoRedoOperation(2),++this._stackPosition})())}peekUndo(){if(this.canUndo)return this._stack.getItemAt(this._stackPosition)}peekRedo(){if(this.canRedo)return this._stack.getItemAt(this._stackPosition+1)}async inject(t){if(this.updating)throw new L;await this._updatingHandles.addPromise((async()=>{t.status===0&&await t.executeUndoRedoOperation(0),t.canUndo?(this._stack.splice(this._stackPosition+1,0,t),this._stackPosition++):this._stackPosition>-1&&(this._stack.splice(0,this._stackPosition+1).forEach(i=>i.destroy()),this._stackPosition=-1)})())}async add(t){if(this.updating)throw new L;await this._updatingHandles.addPromise((async()=>{t.status===0&&await t.executeUndoRedoOperation(0),this._stackPosition>=-1&&this._truncateForwardStack(),t.canUndo?(this._stack.push(t),this._stackPosition=this._stack.length-1):this._drainStack()})())}async removeTagged(t,i=!1){if(this.updating&&!i)return;await bt(()=>!this.updating);const n=new xt;for(let o=0;o<this._stack.length;o++){const a=this._stack.getItemAt(o);a&&(a.tag===t?(a.destroy(),o===this._stackPosition&&(this._stackPosition=n.length-1)):n.push(a))}this._stack=n,this._stackPosition>n.length-1&&(this._stackPosition=n.length-1)}async clear(t=!1){if(this.updating&&!t)throw new L;await bt(()=>!this.updating),this._drainStack()}};r([s()],T.prototype,"_stack",void 0),r([s()],T.prototype,"_stackPosition",void 0),r([s()],T.prototype,"updating",null),r([s({readOnly:!0})],T.prototype,"canUndo",null),r([s({readOnly:!0})],T.prototype,"hasUndo",null),r([s({readOnly:!0})],T.prototype,"canRedo",null),r([s({readOnly:!0})],T.prototype,"hasRedo",null),T=r([$("esri.UndoRedo")],T);let Di=class{constructor(){this.committedVertices=null,this.cursorVertex=null,this.full=null,this.outline=null,this.cursorEdge=null,this.circle=null,this.rectangle=null}};function R(e,t,i){if(e==null)return"noTool";switch(e){case"point":return Ui();case"multipoint":return"multipoint";case"polyline":return Gi(t,i);case"polygon":return Ri(t,i);case"rectangle":case"circle":return Hi(t,i);default:return}}function Ui(e){return"point"}function Gi(e,t){const i=e!=null&&e.type==="polyline"&&e.paths.length?e.paths[0].length:0;return t==="freehand"?i<2?"freehandStart":"freehandEnd":i<2?"polylineZeroVertices":"polylineOneVertex"}function Ri(e,t){const i=e!=null&&e.type==="polygon"&&e.rings.length?e.rings[0].length:0;if(i<3)switch(t){case"freehand":return"freehandStart";case"hybrid":return"polygonZeroVerticesHybrid";default:return"polygonZeroVertices"}else if(i<4)return t==="freehand"?"freehandEnd":"polygonOneVertex";return"polygonTwoVertices"}function Hi(e,t){if((e!=null&&e.type==="polygon"&&e.rings.length?e.rings[0].length:0)<3)switch(t){case"freehand":return"freehandStart";case"click":return"shapeStartClick";default:return"shapeStartHybrid"}switch(t){case"freehand":return"freehandEnd";case"click":return"shapeEndClick";default:return"shapeEndHybrid"}}function zi(e,t){const i=e?.geometry;if(!e||i?.type!=="mesh"||!t)return;const{renderCoordsHelper:n,elevationProvider:o}=t,{camera:a}=t.state,{extent:p}=i,{center:l,spatialReference:c}=p,u=Vt(c),h=ct(c),y=Vt(n.spatialReference),_=p.width*u,f=p.height*h,g=(p.zmax??0)*h,x=g-(p.zmin??0)*h,O=Math.max(_,f,x)/y,{x:v,y:V}=l,yt=l.z??0;Yt(Y,v,V,yt),n.toRenderCoords(Y,c,Y);const ft=O/a.computeScreenPixelSizeAt(Y);if(ft>Math.min(a.width,a.height)/a.pixelRatio*Li)return"meshTooClose";if(ft<Zi)return"meshTooFar";const fe=Ne(e),{absoluteZ:ve}=je(v,V,g,c,t,fe);return ve<(o.getElevation(v,V,yt,c,"ground")??0)*h+x*Ai?"meshUnderground":"mesh"}const Zi=20,Li=1,Ai=.1,Y=Oe();function Fi(e,t,i,n,o,a){let p="geodesic",l=ci(i);const c=G();return pt(e,t,n,c),c[2]=0,l&&et(c,i,c,l)||(p="euclidean",l=i),{mode:p,view:t,elevationInfo:n,hasZ:o,directionMode:a,spatialReference:e.spatialReference,measurementSR:l,origin:c}}function Ni(e,t,i){if(t==null||e==null)return;const n=Ae(i.measurementSR);if(n==null)return;const o=nt(e,i);if(o==null)return;const a=tt(t,n);return new oi(o,a)}function ji(e,t,i,n){if(i==null||e==null)return;const o=nt(e,n);if(o==null)return;const a=U(i),p=10,l=u=>{if(u==null)return;const h=G(),y=ze(u,"degrees","geographic");return ei(h,o,n.measurementSR,p,y,n.mode)?new si(o,h):void 0},c=()=>{if(t!=null&&e!=null)return U(Qt(t,e))};switch(n.directionMode){case"absolute":return l(a);case"relative":{const u=c();return u==null?void 0:l(u+a)}case"relative-bilateral":{const u=c();return u==null?void 0:te([l(u+a),l(u-a)])}}}function re(e,t){const i=ot(e,t);return i!=null?new ri(i):void 0}function se(e,t,i){const{context:n,longitude:o,latitude:a,direction:p,distance:l,elevation:c}=i;if(o!=null||a!=null||l!=null||c!=null||p!=null){if(o!=null||a!=null){const u=U(o),h=U(a),y=ot(c,n);return new Xt(u,h,y)}return Bi(e,t,i)}}function Bi(e,t,{context:i,direction:n,distance:o,elevation:a}){if(t==null)return re(a,i);const{view:p,elevationInfo:l,measurementSR:c}=i,u=pt(t,p,l);if(!c||!et(u,t.spatialReference,Gt,c))return;const[h,y]=Gt,_=o!=null?tt(o,"meters"):void 0,f=U(n),g=ot(a,i),x=v=>{const V=new ai([h,y],c,_,g,v);return _==null||v==null||g==null&&i.hasZ?V:new li(V.closestTo(u))};if(f==null)return x(void 0);const O=()=>{if(e!=null&&t!=null)return U(Qt(e,t))};switch(i.directionMode){case"absolute":return x(f);case"relative":{const v=O();return v==null?void 0:x(v+f)}case"relative-bilateral":{const v=O();return v==null?void 0:te([x(v+f),x(v-f)])}}}function Wi(e){return e.context.mode==="geodesic"?se(null,null,e):ae(e)}function qi(e,t,i){const{context:n,x:o,y:a,distance:p,direction:l,elevation:c}=i;return n.mode==="geodesic"?se(t,e,i):o!=null||a!=null?ae(i):Yi([Ni(e,p,n),ji(e,t,l,n),re(c,n)])}function ae({x:e,y:t,elevation:i,context:n}){K.x=e?.value??0,K.y=t?.value??0,K.spatialReference=n.spatialReference;const o=nt(K,n,Qi);return new Xt(e!=null&&o!=null?o[0]:void 0,t!=null&&o!=null?o[1]:void 0,ot(i,n))}function Yi(e){let t;for(const i of e)i&&(t=t?.intersect(i)??i);return t}function nt(e,t,i=G()){const{view:n,elevationInfo:o,measurementSR:a,origin:p,mode:l}=t;if(pt(e,n,o,i),et(i,e.spatialReference,i,a))return l!=="geodesic"&&Ye(i,i,p),i}function Ki(e,t,i,n){const{view:o,measurementSR:a,spatialReference:p,origin:l,mode:c}=i;if(c==="geodesic"?Ke(A,e):X(A,e,l),et(A,a,A,p))return ni(A,o,t,i,n)}function ot(e,t){return Ji(e,t)?.value??void 0}function Ji(e,{view:t,origin:i,elevationInfo:n,hasZ:o,measurementSR:a}){if(e==null||!o)return;const p=Fe(a);if(p==null)return;const[l,c]=i,u=tt(e,p),h=t?.type==="3d"?Wt(t,l,c,u,a,n):u;return h!=null?Nt(h,p):void 0}const Gt=G(),Qi=G(),A=G(),K=ut(0,0,0,jt.WGS84);let P=class extends M{constructor(e){super(e),this.type="draw-circle",this.radius=null,this.xSize=null,this.ySize=null,this.area=B}get allFields(){return[]}};r([s()],P.prototype,"type",void 0),r([s()],P.prototype,"radius",void 0),r([s()],P.prototype,"xSize",void 0),r([s()],P.prototype,"ySize",void 0),r([s()],P.prototype,"area",void 0),r([s()],P.prototype,"helpMessage",void 0),r([s()],P.prototype,"allFields",null),P=r([$("esri.views.interactive.tooltip.infos.DrawCircleTooltipInfo")],P);let F=class extends W(M){constructor(t){super(t),this.type="draw-mesh",this.orientation=Je({lockable:!1}),this.scale=Qe({lockable:!1})}get allFields(){return[this.longitude,this.latitude,this.x,this.y,this.elevation,this.orientation,this.scale]}};r([s()],F.prototype,"helpMessage",void 0),r([s()],F.prototype,"allFields",null),F=r([$("esri.views.interactive.tooltip.infos.DrawMeshTooltipInfo")],F);let N=class extends W(M){constructor(t){super(t),this.type="draw-multipoint"}get allFields(){return[this.longitude,this.latitude,this.x,this.y,this.elevation]}};r([s()],N.prototype,"helpMessage",void 0),r([s()],N.prototype,"allFields",null),N=r([$("esri.views.interactive.tooltip.infos.DrawMultipointTooltipInfo")],N);let j=class extends W(M){constructor(t){super(t),this.type="draw-point"}get allFields(){return[this.longitude,this.latitude,this.x,this.y,this.elevation]}};r([s()],j.prototype,"helpMessage",void 0),r([s()],j.prototype,"allFields",null),j=r([$("esri.views.interactive.tooltip.infos.DrawPointTooltipInfo")],j);let I=class extends W(M){constructor(t){super(t),this.type="draw-polygon",this.direction=Kt(),this.distance=Jt(),this.area=Xe(),this.xyMode="direction-distance"}get allFields(){return[this.direction,this.distance,this.longitude,this.latitude,this.x,this.y,this.elevation,this.area]}};r([s()],I.prototype,"xyMode",void 0),r([s()],I.prototype,"helpMessage",void 0),r([s()],I.prototype,"allFields",null),I=r([$("esri.views.interactive.tooltip.infos.DrawPolygonTooltipInfo")],I);let E=class extends W(M){constructor(t){super(t),this.type="draw-polyline",this.direction=Kt(),this.distance=Jt(),this.totalLength=ti(),this.xyMode="direction-distance"}get allFields(){return[this.direction,this.distance,this.longitude,this.latitude,this.x,this.y,this.elevation,this.totalLength]}};r([s()],E.prototype,"helpMessage",void 0),r([s()],E.prototype,"xyMode",void 0),r([s()],E.prototype,"allFields",null),E=r([$("esri.views.interactive.tooltip.infos.DrawPolylineTooltipInfo")],E);let k=class extends M{constructor(e){super(e),this.type="draw-rectangle",this.xSize=S,this.ySize=S,this.area=B}get allFields(){return[]}};r([s()],k.prototype,"type",void 0),r([s()],k.prototype,"xSize",void 0),r([s()],k.prototype,"ySize",void 0),r([s()],k.prototype,"area",void 0),r([s()],k.prototype,"helpMessage",void 0),r([s()],k.prototype,"allFields",null),k=r([$("esri.views.interactive.tooltip.infos.DrawRectangleTooltipInfo")],k);function Xi(e,t){return{point:new j({sketchOptions:t,viewType:e}),multipoint:new N({sketchOptions:t,viewType:e}),polyline:new E({sketchOptions:t,viewType:e}),polygon:new I({sketchOptions:t,viewType:e}),mesh:new F({sketchOptions:t,viewType:e}),rectangle:new k({sketchOptions:t}),circle:new P({sketchOptions:t})}}function Rt(e){const{directionOptions:t,geometryType:i,sketchOptions:n,tooltipInfos:o}=e,a=l=>{const c=rt(e).mode,u=o[l].elevation;c==="relative-to-ground"||c==="relative-to-scene"||c==="on-the-ground"?u.lock(mt(e)):u.unlock()},p=l=>{if(t){const c=o[l].direction;c.committed=t.angle,c.unlockOnVertexPlacement=!1,n.values.directionMode=t.mode}};switch(i){case"polygon":case"polyline":a(i),p(i);break;case"point":case"mesh":a(i)}}function tn(e,t){const{drawOperation:i,view:n}=t,o=ht(t),a=rt(t);if(n.type==="2d"||!e||a.mode!=="absolute-height"||i?.numCommittedVertices!==1||!o||o.type!=="draw-polyline"&&o.type!=="draw-polygon"||o.elevation.locked)return;const[p,l,c]=e,u=gn(p,l,c,a,t);u!=null&&o.elevation.lock(u)}function Ht(e){ht(e)?.allFields.forEach(t=>{t.unlockOnVertexPlacement&&t.unlock()})}function ht({geometryType:e,graphic:t,tooltipInfos:i}){return t?.geometry?.type!==en[e]?e==="circle"||e==="rectangle"?i[e]:null:i[e]}const en={point:"point",multipoint:"multipoint",mesh:"mesh",polyline:"polyline",polygon:"polygon",circle:"polygon",rectangle:"polygon",freehandPolygon:"polygon",freehandPolyline:"polyline",text:"point"};function nn(e,t){switch(e?.type){case"draw-point":on(e,t);break;case"draw-multipoint":rn(e,t);break;case"draw-polyline":an(e,t);break;case"draw-polygon":ln(e,t);break;case"draw-rectangle":pn(e,t);break;case"draw-circle":un(e,t);break;case"draw-mesh":sn(e,t)}}function on(e,t){const i=t.graphic?.geometry;i?.type==="point"&&(gt(e,i,t),e.helpMessage=R("point",i,t.drawOperation.drawingMode))}function rn(e,t){const i=t.graphic?.geometry;i?.type==="multipoint"&&(gt(e,i,t),e.helpMessage=R("multipoint",i,t.drawOperation.drawingMode))}function sn(e,t){const{graphic:i,view:n}=t,o=i?.geometry;n.type!=="3d"||o&&o.type!=="mesh"||(gt(e,o?.origin,t),o&&ke(e,o),e.helpMessage=zi(i,n))}function gt(e,t,i){const{drawOperation:n,view:o,sketchOptions:a}=i,{cursorVertex:p}=n;e.sketchOptions=a,e.viewType=o.type;const l=t?.type==="multipoint"?t.getPoint(t.points.length-1):t;if(e.setLocationFromPoint(l,H(i)),ce(e.elevation,i),!p)return void(n.constraints=void 0);const c=p;n.constraints={context:he(c,i),x:e.x.committed,y:e.y.committed,longitude:e.longitude.committed,latitude:e.latitude.committed,elevation:e.elevation.committed,distance:null,direction:null}}function an(e,t){const{createOperationGeometry:i,drawOperation:n,automaticLengthMeasurementUtils:o}=t,a=i!=null?i.full:null;a&&a.type!=="polyline"||(le(e,t),e.totalLength.actual=n.lastVertex?(a?o.autoLength2D(a):null)??S:null,e.helpMessage=R("polyline",a,t.drawOperation.drawingMode))}function ln(e,t){const{createOperationGeometry:i,drawOperation:n}=t,o=i!=null?i.full:null;o&&o.type!=="polygon"||(le(e,t),e.area.actual=n.lastVertex?(o?t.automaticAreaMeasurementUtils.autoArea2D(o):null)??B:null,e.helpMessage=R("polygon",o,t.drawOperation.drawingMode))}const zt=_e(Bt);function le(e,t){const{drawOperation:i,sketchOptions:n,view:o,automaticLengthMeasurementUtils:a}=t,{cursorVertex:p,lastVertex:l,secondToLastVertex:c}=i,u=n.values.effectiveDirectionMode;e.sketchOptions=n,e.viewType=o.type;const h=l&&p?a.autoDistanceBetweenPoints2D(zt(l),zt(p))??S:null;if(e.distance.actual=h,e.distance.readOnly=l==null,e.direction.actual=null,e.direction.readOnly=!0,l&&p&&(u==="absolute"||c)){const f=ii(c,l,p,u);e.direction.actual=f??Ze,e.direction.readOnly=!1}e.setLocationFromPoint(p,H(t)),ce(e.elevation,t);const y=cn(l,t);e.xyMode=y,e.direction.visible=y==="direction-distance",e.distance.visible=y==="direction-distance",e.effectiveX.visible=y==="coordinates",e.effectiveY.visible=y==="coordinates";const _=p??l;i.constraints=_?{context:he(_,t),x:e.x.committed,y:e.y.committed,longitude:e.longitude.committed,latitude:e.latitude.committed,elevation:e.elevation.committed,distance:e.distance.committed,direction:e.direction.committed}:void 0}function cn(e,{sketchOptions:t}){const i=t.tooltips.xyMode;return i==="auto"?e?"direction-distance":"coordinates":i}function pn(e,t){e.sketchOptions=t.sketchOptions,e.xSize=ue(t),e.ySize=de(t),e.area=pe(t),e.helpMessage=R("rectangle",t.graphic?.geometry,t.drawOperation.drawingMode)}function un(e,t){const{forceUniformSize:i,sketchOptions:n}=t;e.sketchOptions=n,e.radius=i?dn(t):null,e.xSize=i?null:ue(t),e.ySize=i?null:de(t),e.area=pe(t),e.helpMessage=R("circle",t.graphic?.geometry,t.drawOperation.drawingMode)}function ce(e,t){const{drawOperation:i}=t,n=i?.cursorVertex??i?.lastVertex;e.actual=ui(n)??mt(t),e.visible=i.hasZ,e.readOnly=!1,e.showAsZ=!0}function pe(e){const t=e.createOperationGeometry?.full;return t?.type!=="polygon"?B:e.automaticAreaMeasurementUtils.autoArea2D(t)??B}function ue({createOperationGeometry:e,automaticLengthMeasurementUtils:t}){const i=e?.rectangle?.midpoints;return(i!=null?t.autoDistanceBetweenPoints2D(i.left,i.right):null)??S}function de({createOperationGeometry:e,automaticLengthMeasurementUtils:t}){const i=e?.rectangle?.midpoints;return(i!=null?t.autoDistanceBetweenPoints2D(i.top,i.bottom):null)??S}function dn({createOperationGeometry:e,automaticLengthMeasurementUtils:t}){return(e?.circle?.center!=null&&e.circle.edge!=null?t.autoDistanceBetweenPoints2D(e.circle.center,e.circle.edge):null)??S}function hn(e){const{geometryType:t,tooltipInfos:i}=e;switch(t){case"point":case"multipoint":case"mesh":case"polyline":case"polygon":{const n=i[t].elevation.committed;return n?tt(n,"meters")/ct(H(e)):void 0}default:return}}function gn(e,t,i,n,o){const{view:a,drawOperation:p}=o;if(a.type!=="3d"||!p)return;i??=0;const l=H(o),c=rt(o),u=Wt(a,e,t,i,l,c,n);return pi(u,l)??mt(o)}function rt(e){return e.drawOperation.elevationInfo??Be}function H(e){return e.drawOperation.coordinateHelper.spatialReference}function mt(e){const t=ct(H(e));return Nt(e.defaultZ*t,"meters")}function he(e,t){return Fi(e,t.view,H(t),rt(t),t.drawOperation.coordinateHelper.hasZ(),t.sketchOptions.values.effectiveDirectionMode)}let m=class extends gi{constructor(t){super(t),this._graphic=null,this._coordinateFormatterLoadTask=null,this._createOperationGeometry=null,this.defaultZ=0,this.directionOptions=null,this.elevationLockOnVertexAddDisabled=!1,this.geometryType=null,this.hasZ=!0,this.geometryToPlace=null,this.snappingManager=null,this.snapToScene=!1,this.sketchOptions=new ee}initialize(){const{view:t}=this;this.internalGraphicsLayer=new Ee({listMode:"hide",internal:!0,title:"DrawGraphicTool layer"}),this.view.map.layers.add(this.internalGraphicsLayer);const i=this.drawOperation=this.makeDrawOperation();this.tooltipInfos=Xi(t.type,this.sketchOptions);const n=Se(()=>({view:t,options:this.sketchOptions.tooltips}));this.tooltip=n,Rt(this._tooltipsContext),this._coordinateFormatterLoadTask=Ve(()=>Me()),this.addHandles([i.on("vertex-add",o=>this.onVertexAdd(o)),i.on("vertex-remove",o=>this.onVertexRemove(o)),i.on("vertex-update",o=>this.onVertexUpdate(o)),i.on("cursor-update",o=>this.onCursorUpdate(o)),i.on("cursor-remove",()=>this._updateGraphic()),i.on("complete",o=>this.onComplete(o)),this._coordinateFormatterLoadTask,n.on("paste",o=>Ce(o,this.activeTooltipInfo)),C(()=>this.cursor,o=>{i.cursor=o},J),vt(()=>{const{activeTooltipInfo:o,sketchOptions:a}=this;nn(o,this._tooltipsContext),n.info=a.tooltips.effectiveEnabled?o:null}),vt(()=>{i.constraintZ=hn(this._tooltipsContext)},$e)]),this.finishToolCreation(),i.initializePointer()}destroy(){this.drawOperation=D(this.drawOperation),this.tooltip=D(this.tooltip),this._destroyAllVisualizations(),this.view.map.remove(this.internalGraphicsLayer),this.internalGraphicsLayer=D(this.internalGraphicsLayer),this._set("view",null)}get _drawSpatialReference(){return this.drawOperation.coordinateHelper.spatialReference}get _tooltipsContext(){const{defaultZ:t,directionOptions:i,drawOperation:n,forceUniformSize:o,geometryType:a,graphic:p,sketchOptions:l,tooltipInfos:c,view:u,automaticAreaMeasurementUtils:h,automaticLengthMeasurementUtils:y}=this;return{createOperationGeometry:this._createOperationGeometry,defaultZ:t,directionOptions:i,drawOperation:n,forceUniformSize:o,geometryType:a,graphic:p,sketchOptions:l,tooltipInfos:c,view:u,automaticAreaMeasurementUtils:h,automaticLengthMeasurementUtils:y}}get canRedo(){return this.drawOperation.canRedo}get canUndo(){return this.drawOperation.canUndo}set centered(t){this._set("centered",t),this._updateGraphic()}get cursor(){return this._get("cursor")}set cursor(t){this._set("cursor",t)}set enabled(t){this.drawOperation.interactive=t,this._set("enabled",t)}set forceUniformSize(t){this._set("forceUniformSize",t),this._updateGraphic()}get graphic(){return this._graphic}set graphicSymbol(t){this._set("graphicSymbol",t),this._graphic!=null&&(this._graphic.symbol=t)}set mode(t){const i=this.drawOperation;i&&(i.drawingMode=t),this._set("mode",t)}get updating(){return this.drawOperation?.updating??!1}get undoRedo(){const{view:{type:t,map:i}}=this;return t==="2d"&&i&&"undoRedo"in i&&i.undoRedo instanceof T?i.undoRedo:null}set undoRedo(t){this._override("undoRedo",t)}completeCreateOperation(){this.drawOperation.complete()}onInputEvent(t){this.destroyed||Ie(t,this.tooltip)||this.drawOperation.onInputEvent(t)}redo(){this.drawOperation.redo()}reset(){}undo(){this.drawOperation.undo(),this.drawOperation.numCommittedVertices===0&&Rt(this._tooltipsContext)}_destroyAllVisualizations(){this.removeHandles(b.outline),this.removeHandles(b.regularVertices),this.removeHandles(b.activeVertex),this.removeHandles(b.activeEdge),this.removeHandles(lt)}_createOrUpdateGraphic(t){if(this._graphic!=null)return this.updateGraphicGeometry(t),this._graphic;const i=new xe({...this.graphicProperties,symbol:this.graphicSymbol});return this._graphic=i,this.updateGraphicGeometry(t),this.internalGraphicsLayer.add(i),this.addHandles(this.initializeGraphic(i)),this.notifyChange("graphic"),this.addHandles(q(()=>{this.internalGraphicsLayer.remove(i),this._graphic===i&&(this._graphic=null)}),lt),i}updateGraphicGeometry(t){this._graphic.geometry=t}_getCreateOperationGeometry(t={operationComplete:!1}){if(this.drawOperation==null)return;const{coordinateHelper:i,view:n,visualizationCursorVertex:o,lastVertex:a,committedVertices:p,geometryIncludingUncommittedVertices:l,numCommittedVertices:c}=this.drawOperation;if(!(c>0||o!=null))return;const u=t.operationComplete?p:l,h=u.length,y=o!=null?i.pointToArray(o):null,_=this._drawSpatialReference,f=n.type==="3d"&&n.viewingMode==="global",g=new Di;g.committedVertices=p,g.cursorVertex=y;const{geometryType:x}=this;switch(x){case"point":case"mesh":g.full=i.arrayToPoint(u[0]);break;case"multipoint":g.full=h>0?He(u,_):null;break;case"polyline":case"polygon":h>0&&(g.full=x==="polygon"?Re([u],_,f,!0):Pt([u],_,f),g.cursorEdge=y!=null&&a&&!Q(o,a)?Pt([[y,i.pointToArray(a)]],_,f):null,g.outline=h>1?g.full:null);break;case"circle":case"rectangle":{if(g.committedVertices=g.cursorVertex=null,!h)break;const O=De(n,u[0]),v=u[0],V=O.makeMapPoint(v[0]+mn*n.resolution,v[1]);x==="circle"?h===1&&t.operationComplete?g.circle=$t([v,V],O,!0):h===2&&(this.forceUniformSize?g.circle=$t(u,O,this.centered):g.rectangle=Ue(u,O,this.centered)):h===1&&t.operationComplete?g.rectangle=Tt([v,V],O,!0):h===2&&(g.rectangle=this.forceUniformSize?Tt(u,O,this.centered):Ge(u,O,this.centered)),g.full=g.circle!=null?g.circle.geometry:g.rectangle?.geometry,g.outline=g.full?.type==="polygon"?g.full:null;break}default:return null}return g}initializeGraphic(t){return q()}onComplete(t){if(!this.drawOperation)return;this._updateGraphic();let i=null;if(this.drawOperation.isCompleted){const n=this._getCreateOperationGeometry({operationComplete:!0});n!=null&&(i=this._createOrUpdateGraphic(n.full))}this._createOperationGeometry=null,this.emit("complete",{graphic:i,...t})}onCursorUpdate(t){this._updateGraphic(),this.emit("cursor-update",t)}onDeactivate(){const{drawOperation:t}=this;t&&(t.isCompleted||t.cancel())}onOutlineChanged(t){return q()}onCursorEdgeChanged(t){return q()}onVertexAdd(t){Ht(this._tooltipsContext),this._updateGraphic(),this.elevationLockOnVertexAddDisabled||tn(t.vertices.at(0)?.coordinates,this._tooltipsContext),this.emit("vertex-add",t)}onVertexRemove(t){Ht(this._tooltipsContext),this._updateGraphic(),this.emit("vertex-remove",t)}onVertexUpdate(t){this._updateGraphic(),this.emit("vertex-update",t)}_updateGraphic(){const t=this._getCreateOperationGeometry();this._createOperationGeometry=t,t!=null?(t.cursorEdge!=null?this.addHandles(this.onCursorEdgeChanged(t.cursorEdge),b.activeEdge):this.removeHandles(b.activeEdge),t.outline!=null?this.addHandles(this.onOutlineChanged(t.outline),b.outline):this.removeHandles(b.outline),t.committedVertices!=null?this.addHandles(this.onRegularVerticesChanged(t.committedVertices),b.regularVertices):this.removeHandles(b.regularVertices),t.cursorVertex!=null?this.addHandles(this.onActiveVertexChanged(t.cursorVertex),b.activeVertex):this.removeHandles(b.activeVertex),t.full!=null?this._createOrUpdateGraphic(t.full):this.removeHandles(lt)):this._destroyAllVisualizations()}get activeTooltipInfo(){return this._coordinateFormatterLoadTask?.finished?ht(this._tooltipsContext):null}};r([s()],m.prototype,"_coordinateFormatterLoadTask",void 0),r([s()],m.prototype,"_createOperationGeometry",void 0),r([s()],m.prototype,"_tooltipsContext",null),r([s({value:!0})],m.prototype,"centered",null),r([s()],m.prototype,"cursor",null),r([s({nonNullable:!0})],m.prototype,"defaultZ",void 0),r([s({constructOnly:!0})],m.prototype,"directionOptions",void 0),r([s()],m.prototype,"drawOperation",void 0),r([s()],m.prototype,"elevationLockOnVertexAddDisabled",void 0),r([s({value:!0})],m.prototype,"enabled",null),r([s({value:!0})],m.prototype,"forceUniformSize",null),r([s({constructOnly:!0})],m.prototype,"geometryType",void 0),r([s()],m.prototype,"graphic",null),r([s({constructOnly:!0})],m.prototype,"graphicProperties",void 0),r([s()],m.prototype,"graphicSymbol",null),r([s({constructOnly:!0})],m.prototype,"hasZ",void 0),r([s({constructOnly:!0})],m.prototype,"geometryToPlace",void 0),r([s()],m.prototype,"mode",null),r([s()],m.prototype,"snappingManager",void 0),r([s()],m.prototype,"snapToScene",void 0),r([s()],m.prototype,"tooltip",void 0),r([s()],m.prototype,"tooltipInfos",void 0),r([s({constructOnly:!0,type:ee})],m.prototype,"sketchOptions",void 0),r([s()],m.prototype,"updating",null),r([s({constructOnly:!0,nonNullable:!0})],m.prototype,"view",void 0),r([s({constructOnly:!0})],m.prototype,"automaticAreaMeasurementUtils",void 0),r([s({constructOnly:!0})],m.prototype,"automaticLengthMeasurementUtils",void 0),r([s({constructOnly:!0})],m.prototype,"undoRedo",null),r([s()],m.prototype,"activeTooltipInfo",null),m=r([$("esri.views.draw.DrawGraphicTool")],m);const lt=Symbol("create-operation-graphic"),b={outline:Symbol("outline-visual"),regularVertices:Symbol("regular-vertices-visual"),activeVertex:Symbol("active-vertex-visual"),activeEdge:Symbol("active-edge-visual")};function so(e){switch(e){case"point":case"polyline":case"polygon":case"multipoint":return e;case"circle":case"rectangle":return"segment";case"mesh":return"point"}}const mn=48,ge="click";let w=class extends At{constructor(e){super(e),this.events=new Te,this.interactive=!0,this.selectable=!1,this.cursor=null,this.grabbable=!0}intersectionDistance(e,t){return 0}attach(){}detach(){}onElevationChange(){}onViewChange(){}};r([s()],w.prototype,"interactive",void 0),r([s()],w.prototype,"selectable",void 0),r([s()],w.prototype,"cursor",void 0),r([s()],w.prototype,"grabbing",void 0),r([s()],w.prototype,"grabbable",void 0),r([s()],w.prototype,"consumesClicks",void 0),r([s()],w.prototype,"grabbableForEvent",void 0),r([s()],w.prototype,"dragging",void 0),r([s()],w.prototype,"hovering",void 0),r([s()],w.prototype,"selected",void 0),w=r([$("esri.views.draw.LegacyDrawManipulator")],w);const yn="crosshair",fn="progress",Zt=Symbol(),Lt=Symbol();let d=class extends Pe{constructor(e){super(e),this._createOperationCompleted=!1,this._hideDefaultCursor=!1,this._pointerDownStates=new Le,this._stagedScreenPoint=null,this._stagedPointerType=null,this._updatingHandles=new Ft,this._stagedPointerId=null,this.constraintsEnabled=!1,this.constraints=void 0,this._getPointConstraint=kt(Wi),this._getPolylineOrPolygonConstraint=kt(qi),this.constraintZ=null,this.defaultZ=null,this.isDraped=!0,this.labelOptions=new ie,this.cursor=null,this.loading=!1,this.snapToSceneEnabled=null,this.firstVertex=null,this.lastVertex=null,this.secondToLastVertex=null,e.elevationInfo==null&&(this.elevationInfo=We(!!e.hasZ))}initializePointer(){const e=this.view.inputManager?.latestPointerInfo;e!=null&&this._updatePointer(e.location,e.id,e.type)}initialize(){const{geometryType:e,view:t}=this,i=t.spatialReference,n="viewingMode"in t.state?t.state.viewingMode:2,o=e==="segment"||e==="multipoint"?"polyline":e;this.coordinateHelper=vi(this.hasZ,this.hasM,i),this._editGeometryOperations=new _i(new wi(o,this.coordinateHelper),n),this._snappingOperation=new Vi({view:t}),this.addHandles([C(()=>({stagedPoint:this._snappingOperation.stagedPoint,constraint:this._constraint}),({stagedPoint:l,constraint:c},u)=>{const{snappingOptions:h}=this;if(h&&(h.forceDisabled=c!=null&&di(c)),u!=null&&l===u.stagedPoint&&c!==u.constraint)return this._onKeyboardBasedChange();this._processCursor(l??this._screenToMap(this._stagedScreenPoint))},{equals:(l,c)=>l.stagedPoint===c.stagedPoint&&we(l.constraint,c.constraint)}),C(()=>this.view.viewpoint,(l,c)=>{l&&c&&fi(l,c)&&this._onKeyboardBasedChange()})]),this._activePart=new xi(i,n),this._editGeometryOperations.data.parts.push(this._activePart);const a=this.segmentLabels;a!=null&&(a.context={view:t,editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,labelOptions:this.labelOptions,automaticLengthMeasurementUtils:this.automaticLengthMeasurementUtils},this.addHandles(C(()=>this.labelOptions.enabled,l=>{a.visible=l},J))),this.addHandles(this._editGeometryOperations.on(["vertex-add","vertex-update","vertex-remove"],l=>{const c=l.vertices.map(f=>({componentIndex:0,vertexIndex:f.index,coordinates:this.coordinateHelper.vectorToArray(f.pos)})),u=c.map(f=>f.coordinates),h=this.coordinateHelper.vectorToDehydratedPoint(this._activePart.getFirstVertex()?.pos)??null;Q(h,this.firstVertex)||(this.firstVertex=h);const y=this.coordinateHelper.vectorToDehydratedPoint(this._activePart.getLastVertex()?.pos)??null;Q(y,this.lastVertex)||(this.lastVertex=y);const _=this.coordinateHelper.vectorToDehydratedPoint(this._activePart.segments.at(-1)?.leftVertex?.pos)??null;switch(Q(_,this.secondToLastVertex)||(this.secondToLastVertex=_),this._processCursor(this.cursorVertex),l.type){case"vertex-add":this.emit(l.type,{...l,added:u,vertices:c});break;case"vertex-update":this.emit(l.type,{...l,updated:u,vertices:c});break;case"vertex-remove":this.emit(l.type,{...l,removed:u,vertices:c})}}));const p=this._manipulator=new w({consumesClicks:!1,grabbableForEvent:l=>this.drawingMode!=="click"||l.pointerType==="touch"&&this._snappingEnabled&&this._pointerDownStates.size===1});this.manipulators.add(p),p.grabbable=e!=="point"&&e!=="multipoint",this.addHandles([p.events.on("immediate-click",l=>this._onImmediateClick(l)),p.events.on("immediate-double-click",l=>this._onImmediateDoubleClick(l)),C(()=>this.drawingMode,()=>{this.removeHandles(Zt),this.addHandles(this._createManipulatorDragPipeline(p),Zt)},J),C(()=>({effectiveCursor:this.effectiveCursor}),({effectiveCursor:l})=>{p.cursor=l},J)]),hi(this,()=>{const l=this.view.inputManager.latestPointerInfo?.type??"mouse",c=this._getSnappingContext(l);if(this.snappingManager!=null){const u=this._snappingOperation.snapAgainNearPreviousMapPoint(this.snappingManager,c);this._updatingHandles.addPromise(_t(u))}})}destroy(){D(this.segmentLabels),D(this._snappingOperation),this._editGeometryOperations=D(this._editGeometryOperations),this._updatingHandles.destroy()}get _isDragging(){const{_stagedPointerId:e,_manipulator:t}=this;return e!=null&&this._pointerDownStates.has(e)||t.grabbing||!t.interactive}get _snappingEnabled(){return this.snappingManager!=null&&this.snappingManager.options.effectiveEnabled}get _requiresScenePoint(){const e=this._updateAndGetEffectiveDrawSurface();return this.view.type==="3d"&&this.drawSurface!==e}get canRedo(){return this._editGeometryOperations.canRedo}get canUndo(){return this._editGeometryOperations.canUndo}get committedVertices(){return this._activePart.vertices.map(e=>this.coordinateHelper.vectorToArray(e.pos))}get _constraint(){const{constraints:e,constraintsEnabled:t}=this;if(e&&t)switch(this.geometryType){case"point":case"multipoint":return this._getPointConstraint(e);case"polygon":case"polyline":return this._getPolylineOrPolygonConstraint(this.lastVertex,this.secondToLastVertex,e)}}set drawingMode(e){this._set("drawingMode",e??ge)}get effectiveCursor(){return this.loading?fn:this._hideDefaultCursor?null:this.cursor||yn}get interactive(){return this._manipulator.interactive}set interactive(e){this._manipulator.interactive=e}get isCompleted(){return this._createOperationCompleted}get numCommittedVertices(){return this._activePart.vertices.length}get snappingOptions(){return this.snappingManager!=null?this.snappingManager.options:null}get cursorVertex(){return this._get("cursorVertex")}get visualizationCursorVertex(){return this._stagedPointerType==="mouse"?this.cursorVertex:null}get committableVertex(){const{cursorVertex:e,lastVertex:t,firstVertex:i,geometryType:n}=this;return n==="polygon"&&st(e,i)||st(e,t)?null:e}get updating(){return this._updatingHandles.updating}get geometryIncludingUncommittedVertices(){const{committedVertices:e,committableVertex:t,coordinateHelper:i}=this,n=e.slice();return t!=null&&n.push(i.pointToArray(t)),n}cancel(){this.complete({aborted:!0})}commitStagedVertex(){this._snappingOperation.abort();const{committableVertex:e}=this;e!=null&&this._editGeometryOperations.appendVertex(this.coordinateHelper.pointToVector(e),this._activePart)}complete(e){const t=e?.aborted||!1;this._snappingOperation.abort(),this.snappingManager?.doneSnapping();const{geometryType:i,numCommittedVertices:n}=this,o=i==="multipoint"&&n===0||i==="polyline"&&n<2||i==="polygon"&&n<3;i!=="segment"&&i!=="point"||this.commitStagedVertex(),this._createOperationCompleted=!o,(this.isCompleted||t)&&(this._stagedScreenPoint=null,this._stagedPointerId=null,this._stagedPointerType=null,this._processCursor(null),this.emit("complete",{vertices:this.committedVertices.map((a,p)=>({componentIndex:0,vertexIndex:p,coordinates:a})),aborted:t,type:"complete"}))}onInputEvent(e){switch(e.type){case"pointer-down":this._pointerDownStates.add(e.pointerId);break;case"pointer-up":this._pointerDownStates.delete(e.pointerId)}switch(e.type){case"pointer-move":return this._onPointerMove(e);case"hold":return this._onHold(e)}}redo(){this._editGeometryOperations.redo()}undo(){this.snappingManager!=null&&this.snappingManager.doneSnapping(),this._editGeometryOperations.undo()}_processCursor(e){const t=wt(this.cursorVertex),i=wt(e),n=i&&(this._updateAndGetEffectiveDrawSurface()?.constrainZ(i)??i),o=this._snapToClosingVertex(n),a=this._applyConstraints(o);st(t,a)||(this._set("cursorVertex",a),this.segmentLabels?.set("stagedVertex",a!=null?this.coordinateHelper.pointToVector(a):null),a==null||this._stagedPointerType!=="mouse"?this.emit("cursor-remove"):this.emit("cursor-update",{updated:null,vertices:[{componentIndex:0,vertexIndex:this._activePart.vertices.length,coordinates:this.coordinateHelper.pointToArray(a)}],operation:"apply",type:"vertex-update"}))}_snapToClosingVertex(e){if(e==null||this._isDragging||this.geometryType!=="polygon"||this.numCommittedVertices<=2)return e;const t=this._mapToScreen(e);if(!t)return e;const i=this._activePart;return this._vertexWithinPointerDistance(i.vertices[0].pos,t)?this.firstVertex:this._vertexWithinPointerDistance(i.vertices.at(-1).pos,t)?this.lastVertex:e}_createManipulatorDragPipeline(e){switch(this.drawingMode){case"click":return this._createManipulatorDragPipelineClick(e);case"freehand":return this._createManipulatorDragPipelineFreehand(e);case"hybrid":return this._createManipulatorDragPipelineHybrid(e)}}_createManipulatorDragPipelineClick(e){return at(e,(t,i,n,o)=>{const a=o==="touch"&&this._snappingEnabled;if(this.isCompleted||!a)return;const{snappingStep:p,cancelSnapping:l}=Pi({predicate:()=>a,snappingManager:this.snappingManager,snappingContext:new Ct({editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,feature:this.graphic,pointer:o,visualizer:this.snappingVisualizer,drawConstraints:this.constraints}),updatingHandles:this._updatingHandles,useZ:!this._requiresScenePoint});n=n.next(c=>(a&&this.snappingManager!=null&&this.snappingManager.doneSnapping(),c)).next(l),i.next(this._screenToMapDragEventStep()).next(c=>(c.action==="start"&&(this._processCursor(c.mapStart),(this.geometryType==="segment"||a&&!this.numCommittedVertices)&&this.commitStagedVertex()),c)).next(mi(this.view,this.elevationInfo)).next(...p).next(c=>(a&&(this._processCursor(c.mapEnd),c.action==="end"&&this.commitStagedVertex()),c)).next(c=>(c.action==="end"&&(this._stagedPointerType!=="mouse"&&this._snappingOperation.abort(),this.geometryType!=="segment"&&this.geometryType!=="point"||this.complete()),c))})}_createManipulatorDragPipelineFreehand(e){return at(e,(t,i)=>{this.isCompleted||i.next(this._screenToMapDragEventStep()).next(n=>(n.action==="start"&&(this._snappingOperation.abort(),this.committableVertex==null&&this._processCursor(n.mapStart),this.geometryType==="segment"&&this.commitStagedVertex()),n)).next(n=>{switch(n.action){case"start":case"update":this._processCursor(n.mapEnd),this.geometryType!=="polygon"&&this.geometryType!=="polyline"||this.commitStagedVertex();break;case"end":this.complete()}return n})})}_createManipulatorDragPipelineHybrid(e){return at(e,(t,i)=>{this.isCompleted||i.next(this._screenToMapDragEventStep()).next(n=>(n.action==="start"&&(this._snappingOperation.abort(),this.addHandles(this._editGeometryOperations.createUndoGroup(),Lt),this._processCursor(n.mapStart),this.commitStagedVertex()),n)).next(n=>{switch(n.action){case"start":case"update":this._processCursor(n.mapEnd),this.geometryType!=="polygon"&&this.geometryType!=="polyline"||this.commitStagedVertex();break;case"end":this._stagedPointerType!=="mouse"&&this._snappingOperation.abort(),this.removeHandles(Lt),this.geometryType!=="segment"&&this.geometryType!=="point"||this.complete()}return n})})}get _drawAtFixedElevation(){const{constraintsEnabled:e,constraintZ:t,geometryType:i,numCommittedVertices:n}=this;return e?t!=null||i==="segment"&&n>0:(i==="segment"||i==="polygon")&&n>0}_updateAndGetEffectiveDrawSurface(){const{constraintsEnabled:e,coordinateHelper:t,drawSurface:i,elevationDrawSurface:n,snapToSceneEnabled:o}=this;if(n==null)return i;if(!this.hasZ)return n.defaultZ=null,n;const a=this.elevationInfo?.mode;let p=this.defaultZ,l=e||a==="absolute-height";return o!=null&&(l=o),a==="on-the-ground"&&(l=!1),this._drawAtFixedElevation&&(p=(e?this.constraintZ:null)??t.getZ(this._activePart.vertices[0].pos),l=!1),l?i:(n.defaultZ=p,n)}_mapToScreen(e){return this._updateAndGetEffectiveDrawSurface()?.mapToScreen(e)}_onHold(e){this._snappingOperation.abort(),this.drawingMode==="click"&&e.pointerType==="touch"&&this._snappingEnabled&&this._processCursor(e.mapPoint),e.stopPropagation()}_onImmediateClick(e){if(!(e.pointerType==="mouse"&&e.button===2||this._manipulator.dragging))try{const{drawingMode:t,geometryType:i}=this;this._stagedPointerType=e.pointerType,this._stagedScreenPoint=e.screenPoint;const n=this._screenToMap(e.screenPoint);if(n==null||n==null||t==="freehand"&&i!=="point"&&i!=="multipoint")return;if(this._snappingEnabled&&this.cursorVertex!=null||this._processCursor(n),this.committableVertex==null)return void this.complete();this.commitStagedVertex(),e.pointerType!=="mouse"&&this._processCursor(null),(t==="freehand"&&this.geometryType!=="multipoint"||i==="point"||i==="segment"&&this.numCommittedVertices===2||i==="segment"&&t==="hybrid"&&this.numCommittedVertices===1)&&this.complete()}finally{e.stopPropagation()}}_onImmediateDoubleClick(e){this._manipulator.dragging||this.geometryType==="point"||(this.complete(),e.stopPropagation())}_onPointerMove(e){const t=ne(e.x,e.y);this._updatePointer(t,e.pointerId,e.pointerType)&&e.stopPropagation()}_updatePointer(e,t,i){return this._stagedScreenPoint=e,this._stagedPointerType=i,this._stagedPointerId=t,this._isDragging?(this._snappingOperation.abort(),!1):(this._processCursorMovementRelativeToSurface(e,i),!0)}_onKeyboardBasedChange(){this._stagedPointerType==="mouse"&&this._stagedScreenPoint&&this._stagedPointerId!=null&&!this._isDragging?this._processCursorMovementRelativeToSurface(this._stagedScreenPoint,this._stagedPointerType):this._snappingOperation.abort()}_processCursorMovementRelativeToSurface(e,t){const i=this._snappingOperation,n=this._screenToMap(e),o=this._requiresScenePoint?this.drawSurface?.screenToMap(e):null;if(n==null)return this._hideDefaultCursor=!0,this._processCursor(null),void i.abort();this._hideDefaultCursor=!1;const a=this.snappingManager;if(a==null)return this._processCursor(n),void i.abort();const p=this._getSnappingContext(t);this._updatingHandles.addPromise(_t(i.snap({point:n,scenePoint:o},a,p)))}_applyConstraints(e){const{_constraint:t,constraints:i}=this;if(!e||!i||!t)return e;const{context:n}=i,o=nt(e,n),a=o?t.closestTo(o):void 0;if(!a)return e;const p=Ki(a,e,n),l=this.view.type==="2d"||n.elevationInfo.mode!=="absolute-height";return p!=null&&l&&this.constraintZ!=null&&this.hasZ&&(p.z=this.constraintZ),p}_screenToMap(e){return e?this._updateAndGetEffectiveDrawSurface()?.screenToMap(e):null}_screenToMapDragEventStep(){let e=null;return t=>{if(t.action==="start"&&(e=this._screenToMap(t.screenStart)),e==null)return null;const i=this._screenToMap(t.screenEnd);return i!=null?{...t,mapStart:e,mapEnd:i}:null}}_vertexWithinPointerDistance(e,t){const n=this._mapToScreen(this.coordinateHelper.vectorToDehydratedPoint(e));return n!=null&&vn(n,t,25)}_getSnappingContext(e){const t=this._drawAtFixedElevation?this.elevationDrawSurface?.defaultZ:null;return new Ct({editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,pointer:e,feature:this.graphic,visualizer:this.snappingVisualizer,selfSnappingZ:t!=null?{value:t,elevationInfo:this.elevationInfo}:null,drawConstraints:this.constraints})}};function vn(e,t,i){const n=e.x-t.x,o=e.y-t.y;return n*n+o*o<=i}r([s()],d.prototype,"_hideDefaultCursor",void 0),r([s()],d.prototype,"_stagedPointerId",void 0),r([s()],d.prototype,"_isDragging",null),r([s()],d.prototype,"_snappingOperation",void 0),r([s()],d.prototype,"_snappingEnabled",null),r([s({constructOnly:!0})],d.prototype,"graphic",void 0),r([s()],d.prototype,"constraintsEnabled",void 0),r([s()],d.prototype,"constraints",void 0),r([s()],d.prototype,"_constraint",null),r([s()],d.prototype,"constraintZ",void 0),r([s()],d.prototype,"defaultZ",void 0),r([s()],d.prototype,"isDraped",void 0),r([s({constructOnly:!0})],d.prototype,"automaticLengthMeasurementUtils",void 0),r([s({value:ge})],d.prototype,"drawingMode",null),r([s({constructOnly:!0})],d.prototype,"elevationDrawSurface",void 0),r([s({constructOnly:!0})],d.prototype,"elevationInfo",void 0),r([s({constructOnly:!0,type:ie})],d.prototype,"labelOptions",void 0),r([s({constructOnly:!0})],d.prototype,"geometryType",void 0),r([s({constructOnly:!0})],d.prototype,"hasM",void 0),r([s({constructOnly:!0})],d.prototype,"hasZ",void 0),r([s()],d.prototype,"cursor",void 0),r([s()],d.prototype,"effectiveCursor",null),r([s()],d.prototype,"loading",void 0),r([s({constructOnly:!0})],d.prototype,"manipulators",void 0),r([s({constructOnly:!0})],d.prototype,"drawSurface",void 0),r([s({constructOnly:!0})],d.prototype,"segmentLabels",void 0),r([s({constructOnly:!0})],d.prototype,"snappingManager",void 0),r([s({constructOnly:!0})],d.prototype,"snappingVisualizer",void 0),r([s()],d.prototype,"snapToSceneEnabled",void 0),r([s({readOnly:!0})],d.prototype,"cursorVertex",null),r([s({readOnly:!0})],d.prototype,"visualizationCursorVertex",null),r([s()],d.prototype,"committableVertex",null),r([s()],d.prototype,"firstVertex",void 0),r([s()],d.prototype,"lastVertex",void 0),r([s()],d.prototype,"secondToLastVertex",void 0),r([s()],d.prototype,"updating",null),r([s({constructOnly:!0})],d.prototype,"view",void 0),d=r([$("esri.views.draw.DrawOperation")],d);class ao{constructor(t,i,n,o=null){this._elevationInfo=t,this.defaultZ=i,this._view=n,this._excludeGraphics=o}screenToMap(t){const{defaultZ:i,_view:n}=this,o=n.sceneIntersectionHelper.intersectElevationFromScreen(yi(t.x,t.y),this._elevationInfo,i??0,this._excludeGraphics);return i==null&&o!=null&&(o.z=void 0),o}mapToScreen(t){const i=ut(t.x,t.y,qt(this._view,t,this._elevationInfo),t.spatialReference);return this._view.toScreen(i)}constrainZ(t){const{defaultZ:i}=this;return i!=null&&t.z!==i&&((t=oe(t)).z=i),t}}class lo{constructor(t,i,n=[]){this.view=t,this.elevationInfo=i,this.exclude=n}screenToMap(t){const i=this.view.toMap(t,{exclude:this.exclude,excludeLabels:!0});return i!=null&&(i.z=qe(i,this.view,this.elevationInfo)),i}mapToScreen(t){let i=t;return this.elevationInfo!=null&&(i=ut(t.x,t.y,qt(this.view,t,this.elevationInfo),t.spatialReference)),this.view.toScreen(i)}constrainZ(t){return t}}let co=class{constructor(t,i=!1,n=0){this.view=t,this.hasZ=i,this.defaultZ=n,this.mapToScreen=o=>t.toScreen(o),this.screenToMap=i?o=>{const a=t.toMap(o);return a.z=n,a}:o=>t.toMap(o)}constrainZ(t){const{defaultZ:i}=this;return this.hasZ&&t.z!==i&&((t=oe(t)).z=i),t}};class me{screenToMap(t){const{x:i,y:n}=t;return new Bt({x:i,y:n,spatialReference:me.spatialReference})}mapToScreen(t){return ne(t.x,t.y)}constrainZ(t){return t}static{this.spatialReference=new jt}}function uo(e,t){return ye(e,t,!1)}function ho(e,t){return ye(e,t,!0)}function ye(e,t,i){if(e instanceof Oi){if(e.operation instanceof bi)return _n(e.operation,t,i),!0;if(e.operation instanceof $i)return wn(e.operation,t,i),!0;if(e.operation instanceof Ti)return xn(e.operation,t,i),!0}return!1}function _n(e,t,i=!1){const n=i?-1:1,o=be(n*e.dx,n*e.dy,n*e.dz);X(t.origin,t.origin,o),it(t)}function wn(e,t,i=!1){const n=i?-e.angle:e.angle;St(t.basis1,t.basis1,Ot,n),St(t.basis2,t.basis2,Ot,n),it(t)}function xn(e,t,i=!1){const n=i?1/e.factor1:e.factor1,o=i?1/e.factor2:e.factor2;Mt(t.basis1,t.basis1,n),Mt(t.basis2,t.basis2,o),Dt(t.origin,t.origin,e.origin,e.axis1,n),Dt(t.origin,t.origin,e.origin,e.axis2,o),it(t)}function go(e,t,i,n,o=!1){n||(n=ki());const a=z(Z.get(),e[1],-e[0]),p=z(Z.get(),Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),l=z(Z.get(),Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),c=Z.get(),u=t.allVerticesUnordered;u.forEach(({pos:f})=>{z(c,It(e,f),It(a,f)),Si(p,p,c),Mi(l,l,c)});const h=1e-6,y=z(Z.get(),l[0]-p[0]<h?i/2:0,l[1]-p[1]<h?i/2:0);Ci(p,p,y),Ii(l,l,y);const _=o?u.reduce((f,g)=>f+(g.pos[2]??0),0)/u.length:0;return Et(n.basis1,e,(l[0]-p[0])/2),Et(n.basis2,a,(l[1]-p[1])/2),Yt(n.origin,p[0]*e[0]+p[1]*a[0],p[0]*e[1]+p[1]*a[1],_),X(n.origin,n.origin,n.basis1),X(n.origin,n.origin,n.basis2),it(n),n}export{m as A,so as M,go as S,ho as T,uo as V,d as a,ao as c,co as h,lo as l};
