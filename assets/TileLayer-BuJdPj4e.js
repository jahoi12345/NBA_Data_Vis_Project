import{f as _,s as u,_ as o,m as a,r as S,a as T}from"./jsonMap-Bs3hmeCU.js";import{f as v,I as b,H as c,A as w,p as O,g as $,d as R,_ as W,s as A}from"./Point-C1MrKtFQ.js";import{l as U}from"./loadAll-BT-Vicws.js";import{l as P}from"./MultiOriginJSONSupport-Bd1TKmh_.js";import{o as j}from"./reader-DcGs6kKN.js";import{b as D}from"./Layer-46hEBHG3.js";import{o as I}from"./APIKeyMixin--YGbad8e.js";import{p as L}from"./ArcGISCachedService-BKKk3jG5.js";import{m as B,h as M,l as N}from"./SublayersOwner-B5K3ounT.js";import{l as C}from"./ArcGISService-B5tUo6SW.js";import{p as k}from"./BlendLayer-D0U2IQDe.js";import{s as J}from"./CustomParametersMixin-Dshqz1Zp.js";import{b as q,y as G}from"./OperationalLayer-Dx_J9Xsw.js";import{j as V}from"./PortalLayer-ag_am21V.js";import{f as E}from"./RefreshableLayer-CnxZDl0i.js";import{t as H}from"./ScaleRangeLayer-DQr2T3Hh.js";import{o as f}from"./imageBitmapUtils-BP4sA6iR.js";import{c as x}from"./ElevationInfo-tmoMRTCD.js";import"./index-DJqVgRZI.js";import"./asyncUtils-w6KfWU41.js";import"./collectionUtils-0LMOubEE.js";import"./reactiveUtils-SO2Ko3sy.js";import"./Extent-BhRcB6A3.js";import"./SimpleObservable-CvFyr0NA.js";import"./date-IqUzANpt.js";import"./TileInfo-D9FZm26Y.js";import"./TileKey-y0V0VR5d.js";import"./aaBoundingRect-CirBGiM6.js";import"./mathUtils-PIGhLnI9.js";import"./TileInfoTilemapCache-B40skWYU.js";import"./TilemapCache-5LhAty9g.js";import"./LRUCache-fy84PBMi.js";import"./memoryEstimations-Bd726a_p.js";import"./Version-BtYZEj58.js";import"./portalItemUtils-BXGczwBU.js";import"./projectionUtils-DgeaYumr.js";import"./Polyline-BX3kGhk1.js";import"./Polygon-Bn-bHOAm.js";import"./CollectionFlattener-qHbwB4PG.js";import"./getPopupProvider-B6_CbTIt.js";import"./lengthUtils-S7Vd15KB.js";import"./Color-CERqXxxY.js";import"./typeUtils-DHuobzAV.js";import"./GraphicOrigin-uE6TDXc9.js";import"./QueryTask-DboCTdHo.js";import"./infoFor3D-DhzudQro.js";import"./Query-BMDyipXd.js";import"./jsonUtils-DCeeRI0j.js";import"./Field-Cm_ZejYW.js";import"./fieldType-DVUzXtk_.js";import"./utils-B141yH2f.js";import"./executeForIds-DONyWx3N.js";import"./query-Bd2C1u48.js";import"./normalizeUtils-ChDuTj7k.js";import"./Cyclical-BLSxUpe7.js";import"./normalizeUtilsCommon-BNnQ-9eo.js";import"./utils-BDdE7V1j.js";import"./pbfQueryUtils-CCvFyPoy.js";import"./pbf-2SIhMekG.js";import"./OptimizedFeature-CwRGZPwv.js";import"./OptimizedFeatureSet-BR8EEvDc.js";import"./queryZScale-vNuVx8nb.js";import"./executeQueryJSON-l-o2uDaf.js";import"./FeatureSet-C05lc4Uu.js";import"./Graphic-DKlFzFCS.js";import"./createFeatureId-CVwTD0fV.js";import"./typeUtils-B67GwOn_.js";import"./lineMarkers-CDwLe3J6.js";import"./PolygonSymbol3D-akL4YFUA.js";import"./ExtrudeSymbol3DLayer-DSc1ou2x.js";import"./screenUtils-BitdhK1O.js";import"./opacityUtils-DuFH0EC9.js";import"./aaBoundingBox-CB-h8mLX.js";import"./DoubleArray-DExKNiTh.js";import"./mat4f64-q_b6UJoq.js";import"./Font-yLAApryG.js";import"./SimpleFillSymbol-CDawtd9z.js";import"./SimpleMarkerSymbol-BGAFRS9_.js";import"./PictureMarkerSymbol-CxtyOAdw.js";import"./TextSymbol-CDXCdshW.js";import"./featureConversionUtils-D_cSc3SE.js";import"./OrderedLayer-DQAUgUTV.js";import"./featureLayerUtils-B6FZClVY.js";import"./uuid-Oe6SV2kF.js";import"./featureQueryAll-B8TlOFhd.js";import"./layerUtils-h5BWHkTQ.js";import"./SimpleRenderer-B5i794EV.js";import"./commonProperties-CvTcpee8.js";import"./colorRamps-DswZzxkO.js";import"./ColorStop-De5gQTjr.js";import"./visualVariableUtils-BfVeTIzP.js";import"./jsonUtils-CkT7ZdRy.js";import"./defaults3D-nSORRrTi.js";import"./defaults-5VdXpLB0.js";import"./defaultsJSON-GKolV7NZ.js";import"./UniqueValueRenderer-ByBNjX_v.js";import"./diffUtils-Dm-wL9ib.js";import"./RendererLegendOptions-sQVZeu79.js";import"./styleUtils-Bc0C8lP1.js";import"./NormalizationBinParametersMixin-BK9wNkI3.js";import"./FeatureType-hg58iS5L.js";import"./FeatureTemplate-CI6hFatq.js";import"./FieldsIndex-DJnOcUNs.js";import"./UnknownTimeZone-B697BDFv.js";import"./timeZoneUtils-BSc7-7qA.js";import"./labelingInfo-BPy84mTo.js";import"./labelUtils-BtizwBfq.js";import"./LayerFloorInfo-D7aRHfS2.js";import"./Relationship-DY6kFRXw.js";import"./serviceCapabilitiesUtils-Cg5BBAwj.js";import"./typeUtils-BhtrxxF2.js";import"./ClassBreaksRenderer-B-C_Epze.js";import"./DictionaryScriptEvaluator-DtAHa5Fv.js";import"./ArcadeExpression-BYjjXdCr.js";import"./TimeOnly-CcssPQOY.js";import"./enum-BzLwmiID.js";import"./utils-DX2muIr3.js";import"./heatmapUtils-DbXYwizg.js";import"./vec42-DwKDwCwf.js";import"./vec4f64-DPb6J-GU.js";import"./popupUtils-CnGcmnld.js";import"./sublayerUtils-BEQnBRaB.js";import"./layerContainerType-CSXZNpHb.js";import"./jsonUtils-WWCiN2m0.js";import"./mat4f32-Djp3mnm5.js";import"./mat4-1jyq5T0I.js";import"./PortalItem-NJTEqpHZ.js";import"./unitConversionUtils-hUSVOd8x.js";var d;const y=["Canvas/World_Dark_Gray_Base","Canvas/World_Dark_Gray_Reference","Canvas/World_Light_Gray_Base","Canvas/World_Light_Gray_Reference","Elevation/World_Hillshade","Elevation/World_Hillshade_Dark","Ocean/World_Ocean_Base","Ocean/World_Ocean_Reference","Ocean_Basemap","Reference/World_Boundaries_and_Places","Reference/World_Boundaries_and_Places_Alternate","Reference/World_Transportation","World_Imagery","World_Street_Map","World_Topo_Map"];let i=d=class extends k(H(B(L(M(q(V(C(P(E(I(J(D)))))))))))){constructor(...r){super(...r),this.listMode="show",this.elevationInfo=new x({mode:"on-the-ground"}),this.isReference=null,this.operationalLayerType="ArcGISTiledMapServiceLayer",this.resampling=!0,this.sourceJSON=null,this.spatialReference=null,this.path=null,this.sublayers=null,this.type="tile",this.url=null}normalizeCtorArgs(r,e){return typeof r=="string"?{url:r,...e}:r}load(r){const e=r!=null?r.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["Map Service"]},r).catch(_).then(()=>this._fetchService(e))),Promise.resolve(this)}get attributionDataUrl(){const r=this.parsedUrl?.path.toLowerCase();return r?this._getDefaultAttribution(this._getMapName(r)):null}get hasAttributionData(){return super.hasAttributionData}readSpatialReference(r,e){return(r=r||e.tileInfo?.spatialReference)&&v.fromJSON(r)}writeSublayers(r,e,t,s){if(!this.loaded||!r)return;const l=r.slice().reverse().flatten(({sublayers:n})=>n&&n.toArray().reverse()).toArray(),p=[],m={writeSublayerStructure:!1,...s};l.forEach(n=>{const h=n.write({},m);p.push(h)}),p.some(n=>Object.keys(n).length>1)&&(e.layers=p)}get tileServers(){return this._getDefaultTileServers(this.parsedUrl?.path)}castTileServers(r){return Array.isArray(r)?r.map(e=>b(e).path):null}fetchTile(r,e,t,s={}){const{signal:l}=s,p=this.getTileUrl(r,e,t),m={responseType:"image",signal:l,query:{...this.refreshParameters}};return c(p,m).then(n=>n.data)}async fetchImageBitmapTile(r,e,t,s={}){const{signal:l}=s;if(this.fetchTile!==d.prototype.fetchTile){const h=await this.fetchTile(r,e,t,s);return f(h,r,e,t,l)}const p=this.getTileUrl(r,e,t),m={responseType:"blob",signal:l,query:{...this.refreshParameters}},{data:n}=await c(p,m);return f(n,r,e,t,l)}getTileUrl(r,e,t){const s=!this.capabilities.operations.supportsTileMap&&this.supportsBlankTile,l=w({...this.parsedUrl?.query,blankTile:!s&&null,...this.customParameters,token:this.apiKey}),p=this.tileServers;return`${p&&p.length?p[e%p.length]:this.parsedUrl?.path}/tile/${r}/${e}/${t}${l?"?"+l:""}`}loadAll(){return U(this,r=>{r(this.allSublayers)})}_fetchService(r){return new Promise((e,t)=>{if(this.sourceJSON){if(this.sourceJSON.bandCount!=null&&this.sourceJSON.pixelSizeX!=null)throw new u("tile-layer:unsupported-url","use ImageryTileLayer to open a tiled image service");return void e({data:this.sourceJSON})}if(!this.parsedUrl)throw new u("tile-layer:undefined-url","layer's url is not defined");const s=O(this.parsedUrl.path);if(s!=null&&s.serverType==="ImageServer")throw new u("tile-layer:unsupported-url","use ImageryTileLayer to open a tiled image service");c(this.parsedUrl.path,{query:{f:"json",...this.parsedUrl.query,...this.customParameters,token:this.apiKey},responseType:"json",signal:r}).then(e,t)}).then(e=>{let t=this.url;if(e.ssl&&(t=this.url=t.replace(/^http:/i,"https:")),this.sourceJSON=e.data,this.read(e.data,{origin:"service",url:this.parsedUrl}),this.version===10.1&&!$(t))return this._fetchServerVersion(t,r).then(s=>{this.read({currentVersion:s})}).catch(()=>{})})}_fetchServerVersion(r,e){if(!R(r))return Promise.reject();const t=r.replace(/(.*\/rest)\/.*/i,"$1")+"/info";return c(t,{query:{f:"json",...this.customParameters,token:this.apiKey},responseType:"json",signal:e}).then(s=>{if(s.data?.currentVersion)return s.data.currentVersion;throw new u("tile-layer:version-not-available","Server did not provide a version")})}_getMapName(r){const e=r.match(/^(?:https?:)?\/\/(server\.arcgisonline\.com|services\.arcgisonline\.com|ibasemaps-api\.arcgis\.com)\/arcgis\/rest\/services\/([^/]+(\/[^/]+)*)\/mapserver/i);return e?e[2]:void 0}_getDefaultAttribution(r){if(r==null)return null;let e;r=r.toLowerCase();for(let t=0,s=y.length;t<s;t++)if(e=y[t],e.toLowerCase().includes(r))return W("//static.arcgis.com/attribution/"+e);return null}_getDefaultTileServers(r){if(r==null)return[];const e=r.search(/^(?:https?:)?\/\/server\.arcgisonline\.com/i)!==-1,t=r.search(/^(?:https?:)?\/\/services\.arcgisonline\.com/i)!==-1;return e||t?[r,r.replace(e?/server\.arcgisonline/i:/services\.arcgisonline/i,e?"services.arcgisonline":"server.arcgisonline")]:[]}get hasOverriddenFetchTile(){return!this.fetchTile[g]}};o([a({readOnly:!0})],i.prototype,"attributionDataUrl",null),o([a({type:["show","hide","hide-children"]})],i.prototype,"listMode",void 0),o([a({json:{read:!0,write:!0}})],i.prototype,"blendMode",void 0),o([a()],i.prototype,"elevationInfo",void 0),o([a({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],i.prototype,"isReference",void 0),o([a({readOnly:!0,type:["ArcGISTiledMapServiceLayer"]})],i.prototype,"operationalLayerType",void 0),o([a({type:Boolean})],i.prototype,"resampling",void 0),o([a()],i.prototype,"sourceJSON",void 0),o([a({type:v})],i.prototype,"spatialReference",void 0),o([j("spatialReference",["spatialReference","tileInfo"])],i.prototype,"readSpatialReference",null),o([a({type:String,json:{origins:{"web-scene":{read:!0,write:!0}},read:!1}})],i.prototype,"path",void 0),o([a({readOnly:!0})],i.prototype,"sublayers",void 0),o([S("sublayers",{layers:{type:[N]}})],i.prototype,"writeSublayers",null),o([a({json:{read:!1,write:!1}})],i.prototype,"popupEnabled",void 0),o([a()],i.prototype,"tileServers",null),o([A("tileServers")],i.prototype,"castTileServers",null),o([a({readOnly:!0,json:{read:!1}})],i.prototype,"type",void 0),o([a(G)],i.prototype,"url",void 0),i=d=o([T("esri.layers.TileLayer")],i);const g=Symbol("default-fetch-tile");i.prototype.fetchTile[g]=!0;const ht=i;export{ht as default};
