import{L as C,V as H,x as O}from"./vec32-CewSdTn3-VRto2OOh.js";import{I as F,u as v}from"./projectionUtils-BGH_5_I3-DGwchVO8.js";import{R as j,a6 as g}from"./Point-BfTTZoMu-DeJwQYfh.js";import{v as L,Y as h,H as d,G as M}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{J as N}from"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import{x as A}from"./mat4-C96X-Nn0-BrMLOLCb.js";import{n as G}from"./mat4f64-q_b6UJoq-Dh6sWB_w.js";import{t as E}from"./collectionUtils-jDyktm0P-BDP2Oq99.js";import{X as I}from"./projectBoundingSphere-B69Mxmv9-BDEAeDef.js";import{a as y,S as $}from"./aaBoundingRect-CjwcS2F3-ri8bmh30.js";import{g as q}from"./sphere-DLQ6p7mp-DyEe1Vll.js";import{ab as P,ac as b}from"./ShadowCastClear.glsl-CeOT_rAo-BEYyVrmo.js";import{z as B}from"./Texture-CFNZjV2R-CxGjQ8pI.js";function ie(e,n,t,s){const i=F(n,s);if(i==null)return!1;const o=i.source.spatialReferenceId,a=i.dest.spatialReferenceId;if(o===a&&o!==0||j(n,s))return t[0]=1,t[1]=1,t[2]=1,!0;if(o===1){const c=O(e),m=c/Math.sqrt(e[0]*e[0]+e[1]*e[1]),r=c/g.radius;if(a===3)return t[0]=m*r,t[1]=m*r,t[2]=1,!0;if(a===2||a===5){const u=v;return t[0]=u*m*r,t[1]=u*r,t[2]=1,!0}}else if(o===11){if(a===2||a===5)return t[0]=v,t[1]=v,t[2]=1,!0;if(a===3){const c=e[1]/g.radius;return t[0]=1,t[1]=1/Math.cos(c),t[2]=1,!0}}return!1}let p=class extends N{constructor(e){super(e),this._tmpEvent=new P,this._renderCoordsHelper=e.view.renderCoordsHelper,this._renderSR=this._renderCoordsHelper.spatialReference,this._layerElevationSource=e.layerElevationSource}initialize(){this._intersector=new B(this.view.state.viewingMode),this._intersector.options.store=0,this._intersector.options.normalRequired=!1,this._tmpEvent.context=this.intersectionHandler.isGround?"ground":"scene"}get spatialReference(){return this.view?.elevationProvider?.spatialReference}getElevation(e,n,t,s){const i=this._renderCoordsHelper,o=C(l,e,n,t);if(!i.toRenderCoords(o,s,o))return L.getLogger(this).error("could not project point to compute elevation"),null;const{layerElevationSource:a,_intersector:c,intersectionHandler:m}=this,r=a.fullExtent,u=r!=null&&Number.isFinite(r.xmin)&&Number.isFinite(r.xmax)&&Number.isFinite(r.ymin)&&Number.isFinite(r.ymax)&&Number.isFinite(r.zmin)&&Number.isFinite(r.zmax)?new b(r.zmin,r.zmax):a.elevationRange;if(u==null)return null;const _=a.elevationOffset,w=u.elevationRangeMin+_,z=u.elevationRangeMax+_,x=i.setAltitude(Y,z,o),R=i.setAltitude(Z,w,o);return c.reset(x,R,this.view.state.camera),m.intersect(c,null,x,R,null,!0),c.results.min.getIntersectionPoint(o)?i.getAltitude(o):null}getSphereElevationBounds(e,n){return I(e,n,S,this._renderSR),this._layerElevationSource.getElevationRange(S)}getRootElevationBounds(){const e=this.layerElevationSource.fullExtent;return e?.hasZ?new b(e.zmin,e.zmax):null}notifyObjectsChanged(e){this.spatialReference&&(this._computeLayerExtent(n=>{for(const t of e)n(t)},this._tmpEvent.extent),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}notifyObjectsChangedFunctional(e){this.spatialReference&&(this._computeLayerExtent(e,this._tmpEvent.extent),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}notifyObjectChanged(e){this.spatialReference&&(this._computeObjectExtent(e,this._tmpEvent.extent),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}_computeObjectExtent(e,n){y(n),this._expandExtent(e,n)}_computeLayerExtent(e,n){y(n),e(t=>{this._expandExtent(t,n)})}_expandExtent(e,n){const t=this.spatialReference;if(t==null||e==null)return;A(f,e.quaternion),f[12]=e.center[0],f[13]=e.center[1],f[14]=e.center[2];const s=e.halfSize;for(let i=0;i<8;++i)l[0]=1&i?s[0]:-s[0],l[1]=2&i?s[1]:-s[1],l[2]=4&i?s[2]:-s[2],H(l,l,f),this._renderCoordsHelper.fromRenderCoords(l,l,t),$(n,l,n)}};h([d({constructOnly:!0})],p.prototype,"layerElevationSource",void 0),h([d({constructOnly:!0})],p.prototype,"intersectionHandler",void 0),h([d({constructOnly:!0})],p.prototype,"view",void 0),h([d()],p.prototype,"spatialReference",null),p=h([M("esri.views.3d.layers.i3s.LayerElevationProvider")],p);const f=G(),S=q(0,0,0,0),l=E(),Y=E(),Z=E();class re{constructor(n,t,s,i,o){this.toMapSpace=n,this.transform=t,this.obb=s,this.geometry=i,this.elevationAlignable=o}}class se{constructor(n,t){this.position=n,this.rotationScale=t,this.origin=void 0}}export{re as i,ie as n,p,se as s};
