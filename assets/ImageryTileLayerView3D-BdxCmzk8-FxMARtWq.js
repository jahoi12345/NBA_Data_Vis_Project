import{I as U,Y as h,H as d,G as L,z as g}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{r as W,j as S,i as R}from"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import{r as D,z as J,H as Z}from"./rasterProjectionHelper-CKWxY3oy-BcPnCcni.js";import{u as Y}from"./LayerView3D-JY0KVfxL-H13gXtj0.js";import{L as Q}from"./TiledLayerView3D-kcWAoKG--DcjckKje.js";import{s as X}from"./throttle-D_a5zHdu-DIXrv8Hy.js";import{G as K}from"./aaBoundingRect-CjwcS2F3-ri8bmh30.js";import{J as tt}from"./dataUtils-1NJ_tbX7-BVfW_Ul3.js";import{l as et,R as rt}from"./FlowSubView3D-C_clwn1W-BcClYQpL.js";import{O as b,N as it}from"./loadUtils-DQnILyqZ-BymjZ5Cf.js";import{ao as st,am as at,an as ot}from"./ShadowCastClear.glsl-CeOT_rAo-BEYyVrmo.js";import{m as M}from"./vec2f64-rIxtbMRN-Kai9mK1i.js";import{_ as k,N as G}from"./enums-B4pqBiXb-BO-3hS_8.js";import{L as F,t as P}from"./Texture-CFNZjV2R-CxGjQ8pI.js";import{s as lt}from"./Graphic-DgGzDmqW-d1CNicxz.js";import{W as nt,o as w,V as mt}from"./rasterFieldUtils-0bNK-dHZ-COz_3SPB.js";import{p as ut}from"./timeSupport-CL-HYuK--A5dlzrQA.js";import{R as pt}from"./datasetUtils-DdDUWBI2-CH5OCkUx.js";import{m as ht}from"./popupUtils-BKHMiD6K-CUN0lBkb.js";import{t as dt}from"./LayerView-BnpxrRF8-Ca-QSx3a.js";import{f as ct}from"./RefreshableLayerView-BZ0W4dR0-NbasIvC8.js";import{i as ft}from"./capabilities-Bi6C4OG6-CpURufko.js";import"./index-B0z_nLWi.js";import"./Point-BfTTZoMu-DeJwQYfh.js";import"./Extent-CgDMOSRD-Bod5LY6s.js";import"./Polygon-D6wEPb3W-D2MPjRU4.js";import"./mathUtils-PIGhLnI9-B1tKUlUb.js";import"./projectionUtils-BGH_5_I3-DGwchVO8.js";import"./collectionUtils-jDyktm0P-BDP2Oq99.js";import"./Polyline-CoiTLswR-DTxpB2Yg.js";import"./Color-CERqXxxY-BuYn26eI.js";import"./vec4f64-DPb6J-GU-C7c2DqbZ.js";import"./ElevationInfo-Cw2HaA6E-CuK5hJ96.js";import"./lengthUtils-Dt1_RvOO-j3MEdmHu.js";import"./date-IqUzANpt-bLKO9IDT.js";import"./unitConversionUtils-4vB4Ezlp-DnY5MDxd.js";import"./SubView3D-BgWeOqxP-DyCgjZAh.js";import"./UpdatingHandles-D2RI_3Hb-dwLPjVun.js";import"./workers-BEkgoq8Q-BM_Hz460.js";import"./intl-DRFqUect-DPhFaHB2.js";import"./mat4f64-q_b6UJoq-Dh6sWB_w.js";import"./BufferView-Cj2sQaht-avJ4OGB_.js";import"./Indices-D0_UQPPr-t1Qev6md.js";import"./orientedBoundingBox-BLEx7wLU-ByGP9QG1.js";import"./vec32-CewSdTn3-VRto2OOh.js";import"./vec42-B8VM4vXb-B6OGOEI9.js";import"./quat-B7J5v7rV-CZ9akUv-.js";import"./quatf64-CCm9z-pX-CQ7_sSji.js";import"./spatialReferenceEllipsoidUtils-D2JabnKt-Ce3ED0lc.js";import"./mat4-C96X-Nn0-BrMLOLCb.js";import"./vector-B8ZDYGQ6-DRILJdcx.js";import"./Scheduler-CNrsbccs-Bcg8fWoS.js";import"./typeUtils-DqrRcjBx-DZ6_Gsbu.js";import"./modeUtils-BA-mAwuS-DSb1K26b.js";import"./sanitizerUtils-BT_8V5US-CWQWUwZQ.js";import"./PooledRBush-Dco5QkUp-DX3CMhf3.js";import"./GraphicsCollection-Bk6M0b7D-Dk6KdmO7.js";import"./HeightModelInfo-D5IdRvJ2-23y6MRiu.js";import"./RealisticTree.glsl-WN9nrQUl-QZiY3aPA.js";import"./Emissions.glsl-B8XKMjLy-DXfiRNVX.js";import"./InterleavedLayout-B7roQAzV-CdGz7mlm.js";import"./aaBoundingBox-Cn49X7ge-BcYPaJ58.js";import"./MeshLocalVertexSpace-BGd1IdEs-C0HJG4wR.js";import"./projectVectorToVector-Csv3NYZI-DpBtmQMN.js";import"./vec3f32-WCVSSNPR-9V6Uhrx-.js";import"./sphere-DLQ6p7mp-DyEe1Vll.js";import"./frustum-CMzahy3--B-DC1Co-.js";import"./Layer-DZvC7bne-D3VLDrab.js";import"./TilemapCache-CjhKW_vj-8gKqgQfa.js";import"./LRUCache-fy84PBMi-Y56WPIvD.js";import"./asyncUtils-w6KfWU41-HenJ0UOu.js";import"./Map-AEYszeHg-ZEOzAMWa.js";import"./Basemap-CL_uaRmk-O3l-dbYk.js";import"./PortalItem-DnxMlRVo-CI4Ns2_M.js";import"./writeUtils-DEFpwIW1-AHZYPaSV.js";import"./CollectionFlattener-D6h2Fkvj-WVl2BXw-.js";import"./resourceExtension-DOTCeiZj-C2WIbjQM.js";import"./PolygonCollection-HNNpnBH7-5UHgGprq.js";import"./mat4f32-Djp3mnm5-DzYG3LYB.js";import"./Query-BlS0WPDF-jdXS_Qhy.js";import"./Field-Cm_ZejYW-CwJZmSru.js";import"./fieldType-DVUzXtk_-tUuvnZJM.js";import"./normalizeUtils-85zLqeMi-C1bdAKNn.js";import"./normalizeUtilsCommon-CnhQye_A-UWhaH-kt.js";import"./ElevationQuery-DzlYa4L4-DkUTW9Ak.js";import"./TileInfo-Bz7QlefV-CdK7c8ef.js";import"./ExtrudeSymbol3DLayer-DSc1ou2x-CsVYZCeG.js";import"./constants-D67WmGms-H7IOwEdB.js";import"./floatRGBA-D-Q4FzNN-DQhowfyr.js";import"./UnknownTimeZone-B697BDFv-CBbtul7O.js";import"./TileKey-C44YQC4_-BW7BBbYp.js";import"./typeUtils-CXW_VpOn-BGgLp_TK.js";import"./lineMarkers-CDwLe3J6-CNUjJvs3.js";import"./PolygonSymbol3D-BXRHZiCQ-BjPAY2LA.js";import"./Font-BwmnW7d2-Dwh3xjKw.js";import"./SimpleFillSymbol-CDawtd9z-CWD2KI2D.js";import"./SimpleMarkerSymbol-BGAFRS9_-CVQ5NLIA.js";import"./PictureMarkerSymbol-CaSh-vZk-xhjZ61bb.js";import"./TextSymbol-hRGhyDHs-CoS7dSjf.js";import"./vec2f32-CaVKkSa6-BjkBmyoj.js";import"./Octree-DckBBpQ7-CkRPu4UJ.js";import"./axisAngleDegrees-CjbXmycq-DcVVDR1-.js";import"./edgePreprocessing-D_eX-fWy-DqE-06Ss.js";import"./vec3-B_phcnZY-DHC7I6xa.js";import"./vec33-CWJeyzxV-Me4sF5XB.js";import"./getPopupProvider-CmskPttI-CzUWpGwk.js";import"./utils-DTE-xBiC-uxMmcNif.js";import"./layerViewUtils-BTa15X3o-BjQlX2q8.js";import"./screenUtils-BitdhK1O-L0FLPAMi.js";import"./signal-BX9ezF8a-cf1Pn6io.js";import"./SimpleObservable-CvFyr0NA-DXpoMYph.js";import"./WorkerHandle-B930SiRy-DglEKt53.js";import"./line-DShd3yGd-HKPw0I1T.js";import"./DoubleArray-DExKNiTh-CvVpHySW.js";import"./elevationInfoUtils-B8MpdRMP-CDlK86wO.js";import"./memoryEstimations-Bd726a_p-0cVCY2Jz.js";import"./FeatureTileDescriptor-n_NQwd9p-DjCngMQK.js";import"./Cyclical-BLSxUpe7-Bj8R2Yk-.js";import"./jsonUtils-CmpazY1u-6pDLj5sx.js";import"./projectPointToVector-DL7Z4uvb-CPbOlZdQ.js";import"./scaleUtils-yfx9kKWT-D9SVsyM-.js";import"./layerUtils-DZGhvm-W-CfyHx1TZ.js";import"./tagSymbols-BPcGfZon-BPcGfZon.js";import"./Queue-CYlrXMwB-CYJTUII-.js";import"./timeZoneUtils-BSc7-7qA-BAv3h8mh.js";import"./ReactiveMap-B0by2bYu-DCsCfMj5.js";import"./TablesMixin-Q80MT3nU-CBB9B-b6.js";import"./plane-BNdSPG2o-DTV5z6SO.js";import"./VertexElementDescriptor-BlxU8vCE-BwuKQkTU.js";import"./reader-DcGs6kKN-DHJfK-tm.js";import"./computeTranslationToOriginAndRotation-Bjd4esRf-vJ4LbdOU.js";import"./dehydratedFeatures-Ql-uVzLq-aoK2987s.js";import"./quantizationUtils-Ceq-Uxsu-DjgKK_0s.js";import"./featureConversionUtils-BDA_FXJx-CDxX1Wik.js";import"./OptimizedFeature-CwRGZPwv-Ddclhn0A.js";import"./OptimizedFeatureSet-BR8EEvDc-CgsRgxJh.js";import"./createFeatureId-CVwTD0fV-3fKpJDrk.js";import"./HUDIntersectorResult-1xTExS7z-dL9SFL6u.js";import"./intersectorUtilsConversions-pLQPEbcN-Ck-nyNYa.js";import"./Intersector-DS9YtyQY-DMoYp6i0.js";import"./DefaultLoadingContext-DXgBe4GE-Unnb_XgV.js";import"./wosrLoader-CIPfz1Cl-DlmQQkMX.js";import"./Version-BtYZEj58-LyRHDnSJ.js";import"./config-Dg972SSE-D9DBKeq5.js";import"./GeometryUtils-C354xUs0-BLAznQrw.js";import"./definitions-Dvg4hMIw-CdK2DzFN.js";import"./colorUtils-CeIi7j7j-C2WVx6th.js";import"./imageUtils-142g71N8-Wj0XNClb.js";import"./videoUtils-Dwx3AEgj-CduhpDRk.js";import"./uuid-Oe6SV2kF-IYX19xBA.js";import"./quickselect-QQC62dOK-Br2Ahhru.js";import"./meshVertexSpaceUtils-CtG7DPVT-kybwngCt.js";import"./TileKey-CXWFOqOI-Lra6v-mg.js";import"./loadAll-BCyxerwc-B4Lp8wGC.js";import"./opacityUtils-DuFH0EC9-DWspTgn2.js";import"./persistable-CdoDQOTR-BklJqWTn.js";import"./MD5-MtSiOt06-jWr180Yc.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw-DH8sdIsE.js";import"./utils-CylVuxNi--x86XOjU.js";import"./utils-Dpg4yj1D-CeFz2JVC.js";import"./types-BKo2foNY-DE0QfIFp.js";import"./labelUtils-BtizwBfq-Zegx4520.js";import"./ArcadeExpression-BlIRq-oN-VZkrwLVE.js";import"./TimeOnly-BERR31kg-CQiLyUZi.js";import"./enum-BzLwmiID-CcyIdWlQ.js";import"./FieldsIndex-CimK-TqD--24JoCkp.js";const _={type:"delete"},yt={type:"waiting"},gt={type:"on-worker",upsampled:!1},_t={type:"on-worker",upsampled:!0};let I=class extends et{constructor(e){super(e),this._resetTileData=!0,this._throttledTriggerLoad=null,this._throttling=!1}initialize(){this.addHandles([this.surface.on("tile-data-changed",({tile:e,layerIndex:t,layerClass:r})=>{this.renderedTiles!=null&&(this.loadByTileTreesAllowed||this._tileIsUpsampled(e))&&t===this._layerIndex&&r===1&&this._updateFlowDataTile(e)}),S(()=>this.renderedTiles,e=>{const t=this.frameTask.scheduleGenerator(r=>this._updateFlowDataTiles(e,r));this.updatingHandles.addPromise(t)},R),S(()=>this._pixelSize,()=>{this.invalidateTileData(),this._resetTileData=!0},R)]),this._throttledTriggerLoad=X(()=>{super.triggerLoad(),this._throttling=!1},()=>this._throttling=!0,rt,this),this.addHandles(this._throttledTriggerLoad)}async*_updateFlowDataTiles(e,t){const r=z();for(const i of e??[]){const a=this._flowDataTiles?.get(b(i)),s=a==null||a.type==="delete"||a.type==="waiting"?this._getLoadedState(i):a;s!=null&&r.set(b(i),s),t.madeProgress(),t.done&&(t=yield)}this._flowDataTiles=r,this._resetTileData=!0,this.triggerLoad()}abort(){super.abort(),this._throttling=!1}get _layerIndex(){return this.surface.getLayerIndexByUID(1,this.layerView.uid)}get loadByTileTreesAllowed(){return super.loadByTileTreesAllowed||!this._allTilesLoaded}get _pixelSize(){return this.surface.tilingScheme.pixelSize}doRefresh(){this.invalidateTileData(),super.doRefresh()}triggerLoad(){const{_throttledTriggerLoad:e}=this;this._allTilesLoaded?(e.hasPendingUpdates()||e(),e.forceUpdate()):e()}async fetchDataAndGenerateStreamlines(e,t){const{_flowDataTiles:r,needsMagnitude:i,workerHandle:a}=this,s=this.getSimulationSettings(e);if(s==null||a==null||r==null)return;const n=this._resetTileData;this._resetTileData=!1;const u=z();r.forEach((o,l)=>{o.type==="delete"?(u.set(l,_),r.delete(l)):(n||o.type!=="on-worker"&&o.type!=="waiting")&&(u.set(l,o),r.set(l,o.type!=="waiting"&&o.upsampled?_t:gt))});const m={simulationSettings:s,flowExtentInfo:e.flowExtentInfo,flowDataTiles:u,reset:n,needsMagnitude:i,startPositions:this.startPositions(e)},{streamlines:p}=await a.generateTiledStreamlines(m,t);return p}getUpdating(){return super.getUpdating()||this._throttling}_getLoadedState(e){const{_layerIndex:t}=this,r=e.surface==null;if(t==null||r)return _;const i=e.getLayerInfo(t,1);if(i==null)return _;if(!e.visible&&i.requestAbort==null)return i.requestAbort=new AbortController,this.surface.requestTileData(e,t,1,i.requestAbort),_;const a=this._getRasterTile(i,e,t);return a==null?this._upsampleFlowData(t,i.upsampleInfo,e.lij,e.extent):{type:"loaded",data:this._createFlowDataTile(a,e.lij,e.extent,this._pixelSize),upsampled:!1}}_upsampleFlowData(e,t,r,i){if(t==null)return _;const a=t.tile;if(a==null)return _;const s=a.getLayerInfo(e,1);if(s==null)return _;const n=this._getRasterTile(s,a,e);if(n==null)return _;const{scale:u,offset:m}=t,p=Math.max(Math.floor(this._pixelSize*u),1),o=n.source,l=Math.floor(m[0]*o.width),y=Math.floor((1-m[1]-u)*o.height);return{type:"loaded",data:this._createFlowDataTile(n,r,i,p,l,y),upsampled:!0}}_getRasterTile(e,t,r){const{data:i}=e;return!e.dataMissing&&t.hasLayerData(r,1)&&at(i)?i:null}_createFlowDataTile(e,t,r,i,a,s){const n=tt(this.layer.serviceRasterInfo.dataType,e.source,i,i,a,s),u=n.mask.slice();return new it(n.data,u,n.width,n.height,t,K(r))}_updateFlowDataTile(e){const{renderedTiles:t,_layerIndex:r}=this;if(t==null||r==null)return;if(t.has(e)){const a=this._getLoadedState(e);return void(this._setTileData(e,a)&&this.triggerLoad())}let i=this._setTileData(e,_);for(const a of t.values()){const s=a.getLayerInfo(r,1);if(s==null||this._getRasterTile(s,a,r)!=null||s.upsampleInfo?.tile!==e)continue;const n=this._getLoadedState(a),u=this._setTileData(a,n);i||=u}i&&this.triggerLoad()}_setTileData(e,t){const{_flowDataTiles:r}=this;if(r==null)return!1;const i=b(e);return(r.get(i)!=null||t.type!=="delete")&&(r.set(i,t),!0)}get _allTilesLoaded(){let e=0;for(const t of this._flowDataTiles?.values()??[])t.type!=="delete"&&t.type!=="waiting"&&e++;return e===this.renderedTiles?.size}invalidateTileData(){const{_flowDataTiles:e}=this;e?.forEach((t,r)=>{e.set(r,yt)})}_tileIsUpsampled(e){const t=this._flowDataTiles?.get(b(e));return t!=null&&(t.type==="loaded"||t.type==="on-worker")&&t.upsampled}get usedMemory(){const e=9*this._pixelSize**2,t=(this._flowDataTiles?.size??0)*e;return super.usedMemory+t}get test(){return{...super.test,loadedTiles:this._flowDataTiles??z()}}};function z(){return new Map}h([d()],I.prototype,"_throttling",void 0),I=h([L("esri.views.3d.support.flow.FlowSubViewTiles3D")],I);function Tt(e,t,r="nearest",i=!1){const a=!(i&&t.pixelType==="u8"),s=a?G.FLOAT:G.UNSIGNED_BYTE,n=t.pixels==null||t.pixels.length===0?null:a?t.getAsRGBAFloat():t.getAsRGBA(),u=e.capabilities.textureFloatLinear,m=new F(t.width,t.height);return m.internalFormat=a?k.RGBA32F:6408,m.samplingMode=!u||r!=="bilinear"&&r!=="cubic"?9728:9729,m.dataType=s,m.wrapMode=33071,new P(e,m,n)}function wt(e,t){const{spacing:r,offsets:i,coefficients:a,size:[s,n]}=t,u=r[0]>1,m=new F(u?4*s:s,n);m.internalFormat=k.RGBA32F,m.dataType=G.FLOAT,m.samplingMode=9728,m.wrapMode=33071;const p=new Float32Array(u?s*n*16:2*i.length);if(u&&a!=null)for(let o=0,l=0;o<a.length;o++)p[l++]=a[o],o%3==2&&(p[l++]=1);else for(let o=0;o<n;o++)for(let l=0;l<s;l++){const y=4*(o*s+l),c=2*(l*n+o);p[y]=i[c],p[y+1]=i[c+1],p[y+3]=i[c]===-1?0:1}return new P(e,m,p)}function C(e,t){const r=new F(t.length/4,1);return r.internalFormat=6408,r.samplingMode=9728,r.wrapMode=33071,new P(e,r,t)}function xt(e,t,r,i=1,a=!0){return{u_flipY:a,u_applyTransform:!!e,u_opacity:i,u_transformSpacing:e?e.spacing:M,u_transformGridSize:e?e.size:M,u_targetImageSize:t,u_srcImageSize:r}}function bt(e,t){return{u_colormapOffset:t||0,u_colormapMaxIndex:e?e.length/4-1:0}}function It(e){return{u_bandCount:e.bandCount,u_minOutput:e.minOutput,u_maxOutput:e.maxOutput,u_minCutOff:e.minCutOff,u_maxCutOff:e.maxCutOff,u_factor:e.factor,u_useGamma:e.useGamma,u_gamma:e.gamma,u_gammaCorrection:e.gammaCorrection}}function St(e){return{u_hillshadeType:e.hillshadeType,u_sinZcosAs:e.sinZcosAs,u_sinZsinAs:e.sinZsinAs,u_cosZs:e.cosZs,u_weights:e.weights,u_factor:e.factor,u_minValue:e.minValue,u_maxValue:e.maxValue}}const j={bandCount:3,minOutput:0,maxOutput:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};class Rt{constructor(t,r,i=null,a=null){this.lij=t,this.type="raster-tile",this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.opacity=1,this.source=r,this.width=i||r.width,this.height=a||r.height}get source(){return this._source}set source(t){this._source=t,this._rasterTexture=g(this._rasterTexture),this._memoryUsed=null}get symbolizerParameters(){return this.isRendereredSource?{...j,maxCutOff:[1,1,1],factor:[1,1,1]}:this._symbolizerParameters||j}set symbolizerParameters(t){this._symbolizerParameters=t}get bandIds(){return this._bandIds}set bandIds(t){t!=null&&t.length>0?this._bandIds&&t.every((r,i)=>!!this._bandIds?.[i]&&r===this._bandIds[i])||(this._bandIds=t,this._dirty=!0):this._bandIds=null}get interpolation(){return this._interpolation||"nearest"}set interpolation(t){if(this._interpolation=t,this._rasterTexture!=null){const r=this._getRasterTextureInterpolation(t);this._rasterTexture.setSamplingMode(r==="bilinear"?9729:9728)}}get transformGrid(){return this._transformGrid}set transformGrid(t){this._transformGrid=t,this._transformGridTexture=g(this._transformGridTexture),this._memoryUsed=null}bind(t){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&((this._rasterTexture==null||this._dirty)&&this._updateRasterTexture(t,this.bandIds),this._rasterTexture!=null&&(this._updateColormapTexture(t),this.transformGrid&&this._transformGridTexture==null&&(this._transformGridTexture=wt(t,this.transformGrid))),!0)}getUniforms(t){const{symbolizerParameters:r,transformGrid:i,width:a,height:s,opacity:n}=this,u=xt(i,[a,s],[this.source.width,this.source.height],n),m=bt(r.colormap,r.colormapOffset),p=this.symbolizerParameters.type==="stretch"?It(this.symbolizerParameters):null,o=this.symbolizerParameters.type==="hillshade"?St(this.symbolizerParameters):null,l=t.emptyTexture;return new ot(u,m,p||o,this._rasterTexture??l,this._transformGridTexture??l,this._colormapTexture??l)}get isBilinearWithStretchColorRamp(){const{symbolizerParameters:t}=this;return this.interpolation==="bilinear"&&t.colormap!=null&&t.type==="stretch"}get memoryUsage(){if(this._memoryUsed==null){const t=[this._rasterTexture,this._transformGridTexture,this._colormapTexture];this._memoryUsed=t.map(r=>r!=null?r.descriptor.width*r.descriptor.height*4:0).reduce((r,i)=>r+i,0)}return this._memoryUsed}release(){return this._rasterTexture=g(this._rasterTexture),this._transformGridTexture=g(this._transformGridTexture),this._colormapTexture=g(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(t,r){const i=this.source?this.source.extractBands(r):null;if(!(i?.pixels&&i.pixels.length>0))return void(this._rasterTexture=g(this._rasterTexture));const a=r==null&&this.bandIds==null||r!=null&&this.bandIds!=null&&r.join("")===this.bandIds.join("");if(this._rasterTexture!=null&&a)return;this._rasterTexture=g(this._rasterTexture);const s=this._getRasterTextureInterpolation(this.interpolation);this._rasterTexture=Tt(t,i,s,this.isRendereredSource||this.hasStretchTypeNone())}hasStretchTypeNone(){return"stretchType"in this.symbolizerParameters&&this.symbolizerParameters.stretchType==="none"&&!this.symbolizerParameters.useGamma&&this.source.pixelType==="u8"}_getRasterTextureInterpolation(t){return this.symbolizerParameters.type==="lut"||t==="nearest"||t==="majority"||this.isBilinearWithStretchColorRamp?"nearest":"bilinear"}_updateColormapTexture(t){const r=this._colormap,i=this.symbolizerParameters.colormap;return i?r?i.length!==r.length||i.some((a,s)=>a!==r[s])?(this._colormapTexture=g(this._colormapTexture),this._colormapTexture=C(t,i),void(this._colormap=i)):void 0:(this._colormapTexture=C(t,i),void(this._colormap=i)):(this._colormapTexture=g(this._colormapTexture),void(this._colormap=null))}}const vt=e=>{const t=e;let r=class extends t{constructor(...i){super(...i),this.layer=null,this.tileInfo=null}get fullExtent(){try{return this.layer.loaded?this._getFullExtent():null}catch{return null}}get timeExtent(){return ut(this.layer,this.view?.timeExtent,this._get("timeExtent"))}get hasTilingEffects(){const{renderer:i}=this.layer;return!!(i?.type==="raster-stretch"&&i.dynamicRangeAdjustment&&!(i.stretchType==="min-max"||i.stretchType==="standard-deviation"))}get datumTransformation(){try{return this.layer.loaded?J(this.layer.fullExtent,this.view.spatialReference,!0):null}catch{return null}}supportsSpatialReference(i){try{return!this.layer.loaded||!!D(this.layer.serviceRasterInfo,i)}catch{return!1}}async fetchPopupFeaturesAtLocation(i,a){const{layer:s}=this;if(!i)throw new U("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:s});const{popupEnabled:n}=s,u=ht(s,a);if(!n||u==null)return[];const m=[],{value:p,magdirValue:o,processedValue:l}=await s.identify(i,{timeExtent:this.timeExtent,signal:a?.signal});let y="";if(p?.length){y=s.type==="imagery-tile"&&s.hasStandardTime()&&p[0]!=null?p.map(v=>s.getStandardTimeValue(v)).join(", "):p.join(", ");const c={ObjectId:0};c[w.servicePixelValue]=s.type==="imagery-tile"&&pt(s.raster)?l?.join(", "):y,c[w.rawServicePixelValue]=y;const O=s.raster?.rasterInfo??s.serviceRasterInfo,A=O?.attributeTable;if(A!=null){const{fields:v,features:N}=A,V=v.find(({name:T})=>T.toLowerCase()==="value"),q=c[w.servicePixelValue],x=V?N.find(T=>String(T.attributes[V.name])===q):null;if(x)for(const T in x.attributes)x.attributes.hasOwnProperty(T)&&(c[mt+T]=x.attributes[T])}const E=O?.dataType;E!=="vector-magdir"&&E!=="vector-uv"||(c[w.magnitude]=o?.[0],c[w.direction]=o?.[1]);const{multidimensionalDefinition:B}=this.layer.normalizeRasterFetchOptions({timeExtent:this.timeExtent});nt(s.rasterFields,c,B);const{graphicOrigin:H}=s,$=new lt({geometry:this.fullExtent?.clone(),attributes:c,layer:s,origin:H,sourceLayer:s});m.push($)}return m}async getSourceScale(){return await this.layer.load(),Z(this.layer.serviceRasterInfo,this.view.spatialReference)}_getFullExtent(){return D(this.layer.serviceRasterInfo,this.view.spatialReference)}};return h([d()],r.prototype,"fullExtent",null),h([d()],r.prototype,"layer",void 0),h([d({readOnly:!0})],r.prototype,"timeExtent",null),h([d()],r.prototype,"tileInfo",void 0),h([d({readOnly:!0})],r.prototype,"hasTilingEffects",null),h([d()],r.prototype,"datumTransformation",null),r=h([L("esri.views.layers.ImageryTileLayerView")],r),r};let f=class extends vt(ct(Q(Y(dt)))){constructor(){super(...arguments),this.type="imagery-tile-3d",this._isAlignedMapTile=!0,this._flowSubView=null,this.ignoresMemoryFactor=!1,this.unloadedMemory=0}initialize(){this.layer.increaseRasterJobHandlerUsage(),this.fullExtent==null&&this.addResolvingPromise(Promise.reject(new U("layerview:spatial-reference-incompatible","The layer extent cannot be projected to the view's spatial reference",{layer:this.layer})));const e=W(()=>this.view?.basemapTerrain?.tilingSchemeLocked).then(()=>{const t=this.view.basemapTerrain.tilingScheme,r=this.layer.tileInfo;this._isAlignedMapTile=["png","png24","png32","jpg","mixed"].includes(r.format)&&t.compatibleWith(r),this.tileInfo=this._isAlignedMapTile?r:t.toTileInfo(),this.addHandles([S(()=>this.layer.renderer,i=>{this._setSubView(i),this._updatingHandles.addPromise(this.doRefresh())},R),S(()=>[this.layer.interpolation,this.layer.bandIds,this.layer.multidimensionalDefinition,this.layer.multidimensionalSubset,this.layer.rasterFunction,this.timeExtent],()=>this._updatingHandles.addPromise(this.doRefresh()),R)])});this._setSubView(this.layer.renderer),this.addResolvingPromise(e)}destroy(){this.layer.decreaseRasterJobHandlerUsage(),this._flowSubView?.destroy()}_setSubView(e){if(this.layer.type==="wcs")return;const t=e?.type==="flow",r=this._flowSubView;t&&r!=null||(r?.destroy(),this._flowSubView=t?new I({layerView:this}):null)}get _blankTile(){const e=document.createElement("canvas"),t=e.getContext("2d"),[r,i]=this.tileInfo.size;return e.width=r,e.height=i,t.clearRect(0,0,r,i),t.getImageData(0,0,r,i)}get _hasFlow(){return this._flowSubView!=null}get imageFormatIsOpaque(){return this.layer.tileInfo.format==="jpg"}get hasMixedImageFormats(){return this.layer.tileInfo.format==="mixed"}get dataLevelRange(){const e=this.layer.tileInfo,t=this.tileInfo.lodAt(0)?.scale,r=e.lodAt(e.lods.length-1)?.scale;return this.levelRangeFromScaleRange(t,r)}get visibleAtCurrentScale(){return this._flowSubView?.visibleAtCurrentScale??this.tilesVisibleAtCurrentScale()}_getFullExtent(){return D(this.layer.serviceRasterInfo,this.view.basemapTerrain?.spatialReference??this.view.spatialReference)}async fetchTile(e,t){const r=this.tileInfo,i=this._canSymbolizeInWebGL(),a={tileInfo:r,requestRawData:i&&!this._hasFlow,signal:t.signal,timeExtent:this.timeExtent,requestAsImageElement:this._isAlignedMapTile,requestProjectedLocalDirections:this._hasFlow,noClip:!1},{layer:s}=this,[n,u,m]=e,p=await s.fetchTile(n,u,m,a);if(p instanceof HTMLImageElement)return p;let o=p?.pixelBlock;if(o==null)return this._blankTile;if(!i&&!this._hasFlow&&(o=await s.applyRenderer(p),o==null))return this._blankTile;const l=new Rt([n,u,m],o,r.size[0],r.size[1]);return i?(l.symbolizerRenderer=s.symbolizer.rendererJSON,l.symbolizerParameters=s.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(n)),l.transformGrid=p.transformGrid,l.bandIds=s.bandIds):(l.isRendereredSource=!0,l.bandIds=null),l.interpolation=s.interpolation,l}_getSymbolizerOptions(e){const t=this.tileInfo.lodAt(e).resolution;return{pixelBlock:null,isGCS:this.view.basemapTerrain?.spatialReference!=null?this.view.basemapTerrain.spatialReference.isGeographic:this.view.spatialReference.isGeographic,resolution:{x:t,y:t},bandIds:this.layer.bandIds}}ensureSymbolizerParameters(e){this._canSymbolizeInWebGL()&&JSON.stringify(e.symbolizerRenderer)!==JSON.stringify(this.layer.symbolizer.rendererJSON)&&(e.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(e.lij[0])))}createFetchPopupFeaturesQueryGeometry(e,t){return st(e,t,this.view)}async doRefresh(){this.suspended||(this._flowSubView?.doRefresh(),this.emit("data-changed"))}isUpdating(){return this._flowSubView?.updating??!1}_canSymbolizeInWebGL(){const e=ft(),{symbolizer:t}=this.layer,r=t.lookup.colormapLut?.indexedColormap,i=!!this.layer.rasterFunction?.hasClipFunction,a=r&&r.length>4*(e.maxTextureSize||4096);return t.canRenderInWebGL&&!a&&!i}get usedMemory(){return this._flowSubView?.usedMemory??0}get test(){}};h([d({readOnly:!0})],f.prototype,"_blankTile",null),h([d()],f.prototype,"_hasFlow",null),h([d({readOnly:!0})],f.prototype,"imageFormatIsOpaque",null),h([d({readOnly:!0})],f.prototype,"hasMixedImageFormats",null),h([d()],f.prototype,"_flowSubView",void 0),h([d({readOnly:!0})],f.prototype,"dataLevelRange",null),h([d({readOnly:!0})],f.prototype,"visibleAtCurrentScale",null),f=h([L("esri.views.3d.layers.ImageryTileLayerView3D")],f);const Fi=f;export{Fi as default};
