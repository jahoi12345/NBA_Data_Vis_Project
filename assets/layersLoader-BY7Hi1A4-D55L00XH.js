import{I as y}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{p as $}from"./Point-BfTTZoMu-DeJwQYfh.js";import{y as h,F}from"./fetchService-Bb67nyFD-BmjCOSQ9.js";import{S as H,L as M,u as m,d as P,v as G,w as I,h as g,I as k,l as f}from"./loadUtils-CsdEVatB-CJ6RroRL.js";import{Q as b,N as x,m as D}from"./layerUtils-DZGhvm-W-CfyHx1TZ.js";import{l as N}from"./collectionUtils-jDyktm0P-BDP2Oq99.js";import{p as v}from"./jsonContext-C00-qqFg-CYWXvsTY.js";import{a as A}from"./portalItemUtils-CaPNUJg6-CXDHI5LA.js";import{f as O}from"./styleUtils-CZJC3pZm-BNE6B1Si.js";import"./index-B0z_nLWi.js";import"./PortalItem-DnxMlRVo-CI4Ns2_M.js";import"./Extent-CgDMOSRD-Bod5LY6s.js";import"./Layer-DZvC7bne-D3VLDrab.js";import"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import"./date-IqUzANpt-bLKO9IDT.js";import"./projectionUtils-BGH_5_I3-DGwchVO8.js";import"./Polyline-CoiTLswR-DTxpB2Yg.js";import"./Polygon-D6wEPb3W-D2MPjRU4.js";import"./mathUtils-PIGhLnI9-B1tKUlUb.js";import"./asyncUtils-w6KfWU41-HenJ0UOu.js";import"./reader-DcGs6kKN-DHJfK-tm.js";import"./associatedFeatureServiceUtils-BBHOCEqH-B0C_-24D.js";import"./SimpleObservable-CvFyr0NA-DXpoMYph.js";import"./aaBoundingRect-CjwcS2F3-ri8bmh30.js";async function be(r,o){const t=r.instance.portalItem;if(t?.id)return await t.load(o),j(r),r.validateItem&&r.validateItem(t),C(r,o)}function j(r){const o=r.instance.portalItem;if(!o?.type||!r.supportedTypes.includes(o.type))throw new y("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:o?.type,expectedType:r.supportedTypes.join(", ")})}async function C(r,o){const t=r.instance,e=t.portalItem;if(!e)return;let{url:n}=e;const{title:a}=e,s=v(e,"portal-item");if(t.type==="group")return E(t,s,r);n&&t.type!=="media"&&t.read({url:n},s);const l=new g,{data:p,preferredHost:i}=await L(r,l,o);return n=e.url,"isUrlHostModified"in t&&(i?t.applyPreferredHost({preferredHost:i}):t.applyHostFromPortalItem()),p&&t.read(p,s),t.resourceReferences={portalItem:e,paths:s.readResourcePaths??[]},t.type!=="subtype-group"&&t.read({title:a},s),O(t,s)}async function E(r,o,t){const e=r.portalItem;if(!r.sourceIsPortalItem)return;const{title:n,type:a}=e;if(a==="Group Layer"){if(!A(e,"Map"))throw new y("portal:invalid-layer-item-typekeyword","'Group Layer' item without 'Map' type keyword is not supported");return J(r,t)}return r.read({title:n},o),R(r,t)}async function J(r,o){const t=r.portalItem,e=await t.fetchData("json");if(!e)return;if(!o.populateGroupLayer)throw new y("portal:missing-populate-group-layer","Missing populate group layer");const n=v(t,"web-map");r.read(e,n),await o.populateGroupLayer(r,e,{context:n}),r.resourceReferences={portalItem:t,paths:n.readResourcePaths??[]}}async function R(r,o){let t;const{portalItem:e}=r;if(!e)return;const n=e.type,a=o.layerModuleTypeMap;if(!a)throw new y("portal:missing-layer-module-type-map","Layer module type map is required to construct sub layers");switch(n){case"Feature Service":case"Feature Collection":t=a.FeatureLayer;break;case"Stream Service":t=a.StreamLayer;break;case"Scene Service":t=a.SceneLayer;break;case"Video Service":t=a.VideoLayer;break;default:throw new y("portal:unsupported-item-type-as-group",`The item type '${n}' is not supported as a 'GroupLayer'`)}const s=n==="Video Service",l=new g;let[p,{data:i}]=await Promise.all([t(),s?{data:null}:L(o,l)]),u=()=>p;if(s)return Q(r,u,a);if(n==="Feature Service"){const c=m(i)?.customParameters;i=e.url?(await P(i,e.url,l)).data:{},u=await W(i,a)||u;const{provider:S,preferredHost:T}=await K(e.url,{customParameters:c,loadContext:l});return b(e,T),await d(r,u,u,i,a,S)}return n==="Scene Service"&&e.url&&(i=await G(e,i,l)),I(i)>0?await d(r,u,null,i,a):await V(r,u,a)}async function V(r,o,t){const{portalItem:e}=r;if(!e?.url)return;const n=await h(e.url);n&&d(r,o,null,{layers:n.layers?.map(f),tables:n.tables?.map(f)},t)}async function Q(r,o,t){const{portalItem:e}=r;if(!e?.url)return;const n=await h(e.url);n&&d(r,o,null,{layers:n.layers?.map(({id:a,name:s})=>({id:a,name:s}))},t)}async function d(r,o,t,e,n,a){let s=e.layers||[];const l=e.tables||[];if(r.portalItem?.type==="Feature Collection"?(s.forEach((p,i)=>{p.id=i,p?.layerDefinition?.type==="Table"&&l.push(p)}),s=s.filter(p=>p?.layerDefinition?.type!=="Table")):(s.reverse(),l.reverse()),s.forEach(p=>{const i=a?.(p);if(i||!a){const u=w(r,o(p),e,p,i);r.add(u)}}),l.length){const p=t?null:await n.FeatureLayer();l.forEach(i=>{const u=a?.(i);if(u||!a){const c=w(r,t?t(i):p,e,i,u);r.tables.add(c)}})}}function w(r,o,t,e,n){const a=r.portalItem,s={portalItem:a.clone(),layerId:e.id};e.url!=null&&(s.url=e.url);const l=new o(s);if("sourceJSON"in l&&(l.sourceJSON=n),l.type!=="subtype-group"&&l.type!=="catalog"&&(l.sublayerTitleMode="service-name"),a.type==="Feature Collection"){const p={origin:"portal-item",portal:a.portal||N.getDefault()};l.read(e,p);const i=t.showLegend;i!=null&&l.read({showLegend:i},p)}return l}async function L(r,o,t){if(r.supportsData===!1)return{data:void 0};const e=r.instance,n=e.portalItem;if(!n)return{data:void 0};let a=null;try{a=await n.fetchData("json",t)}catch{}if(z(e)){let s=null;const{count:l,preferredHost:p}=await q(n,a,o);if(b(n,p),(a?.layers||a?.tables)&&l>0){if(e.layerId==null){const i=H(e.type),u=i?.length?M(a,i)[0]:m(a);u&&(e.layerId=u.id)}s=U(a,e),s?.layerType==="OrientedImageryLayer"&&e.type==="oriented-imagery"&&e.supportedSourceTypes.add("Feature Layer"),s&&a.showLegend!=null&&(s.showLegend=a.showLegend)}return l>1&&"sublayerTitleMode"in e&&e.sublayerTitleMode!=="service-name"&&(e.sublayerTitleMode="item-title-and-service-name"),{data:s,preferredHost:p}}return{data:a}}async function q(r,o,t){if(o?.layers&&o?.tables)return{count:I(o)};const e=$(r.url);if(!e)return{count:1};const n=e.url.path,a=await t.fetchServiceMetadata(n,{customParameters:m(o)?.customParameters}).catch(()=>null);return{count:(o?.layers?.length??a?.layers?.length??0)+(o?.tables?.length??a?.tables?.length??0),preferredHost:D(r)?x():null}}function U(r,o){const{layerId:t}=o,e=r.layers?.find(n=>n.id===t)||r.tables?.find(n=>n.id===t);return e&&B(e,o)?e:null}function z(r){return r.type!=="stream"&&"layerId"in r}function B(r,o){const t="layerType"in r&&r.layerType,{type:e}=o;return!(e==="feature"&&t&&r.layerType!=="ArcGISFeatureLayer"||e==="catalog"&&!t||e==="oriented-imagery"&&!t||e==="subtype-group"&&!t)}async function K(r,o){const{layersJSON:t,preferredHost:e}=await F(r,o);if(!t)return{provider:null,preferredHost:e};const n=[...t.layers,...t.tables];return{provider:a=>n.find(s=>s.id===a.id),preferredHost:e}}async function W(r,o){const{layers:t,tables:e}=r,n=[...t??[],...e??[]];if(!n.length)return;const a=new Set,s=[];for(const{layerType:i}of n){const u=i??"ArcGISFeatureLayer";if(a.has(u))continue;a.add(u);const c=o[k(u)];s.push(c())}const l=await Promise.all(s),p=new Map;return Array.from(a).forEach((i,u)=>{p.set(i,l[u])}),({layerType:i})=>{const u=i??"ArcGISFeatureLayer";return p.get(u)}}export{be as load};
