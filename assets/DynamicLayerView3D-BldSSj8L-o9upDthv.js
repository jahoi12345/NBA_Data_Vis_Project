import{aU as q,w as V,v,c as j,i as U,x as P,a5 as W,o as _,a4 as Y,S as Z,Y as c,H as f,G as T}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{k,C as B}from"./asyncUtils-w6KfWU41-HenJ0UOu.js";import{r as K}from"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import{z as O}from"./Extent-CgDMOSRD-CU1qE5Kr.js";import{y as G,i as N,h as R,s as b,p as I,Z as Q,d as J}from"./aaBoundingRect-CjwcS2F3-D7aII9DY.js";import{e as X}from"./SubView3D-BgWeOqxP-DyCgjZAh.js";import{i as $}from"./DoubleArray-DExKNiTh-CvVpHySW.js";import{a as ee,aK as te,ba as re,g as ie}from"./Texture-CFNZjV2R-lGBztxVp.js";import{a as C}from"./orientedBoundingBox-BLEx7wLU-CPBtS4XC.js";import{d as ae}from"./RealisticTree.glsl-WN9nrQUl-CRRcYwOn.js";import{p as se,d as ne,h as oe}from"./ShadowCastClear.glsl-CeOT_rAo-iOFMl8eB.js";import{y as le}from"./ImageMaterial.glsl-CrPy6XFt-DT5hEKxs.js";import{u as he}from"./LayerView3D-JY0KVfxL-ByE1zQWv.js";import{t as de}from"./LayerView-BnpxrRF8-CNZhc0aY.js";import{f as ue}from"./RefreshableLayerView-BZ0W4dR0-NbasIvC8.js";import{C as me}from"./layerViewUtils-BTa15X3o-BjQlX2q8.js";function ce(t,e,r){const a=R(t)/b(t),i={width:r,height:r};return a>1.0001?i.height=r/a:a<.9999&&(i.width=r*a),i.width=Math.round(i.width/(R(t)/R(e))),i.height=Math.round(i.height/(b(t)/b(e))),i}function z(t,e){return ae(t,[[e[0],e[1],-1],[e[2],e[1],-1],[e[2],e[3],-1],[e[0],e[3],-1]])}function ge(t,e,r){if(!J(e,r))return z(t,r);const a=[e[1]-r[1],Math.min(e[3],r[3])-Math.max(e[1],r[1]),r[3]-e[3],123456],i=[e[0]-r[0],Math.min(e[2],r[2])-Math.max(e[0],r[0]),r[2]-e[2],123456],n=r[2]-r[0],l=r[3]-r[1],s=i[0]>0&&i[2]>0?3:2,h=a[0]>0&&a[2]>0?3:2,o=(h+1)*(s+1),d=$(3*o),u=re(2*o),m=new Array(6*(h*s-1));let M=0,E=0,D=0,p=0,w=0;for(let y=0;y<4;y++){const L=a[y];if(L<=0)continue;let A=0;for(let x=0;x<4;x++){const H=i[x];H<=0||(d[E++]=r[0]+A,d[E++]=r[1]+M,d[E++]=-1,u[D++]=A/n,u[D++]=M/l,x<3&&y<3&&(x!==1||y!==1)&&(m[w++]=p,m[w++]=p+1,m[w++]=p+s+1,m[w++]=p+1,m[w++]=p+s+2,m[w++]=p+s+1),p++,A+=H)}M+=L}const F=new Array(m.length);return new ie(t,[["position",new C(d,m,3,!0)],["normal",new C(pe,F,3,!0)],["uv0",new C(u,m,2,!0)]])}const pe=[0,0,1];let S=class extends X{constructor(t){super(t),this.drapeSourceType=0,this.updatePolicy=1,this.type="draped",this.maximumDataResolution=null,this._images=new Array,this._extents=new Array,this._overlays=new Array,this._drapeSourceRenderer=null}initialize(){this._drapeSourceRenderer=this.view.overlayManager.registerGeometryDrapeSource(this),this.addHandles(U(()=>this.view.overlayManager.unregisterDrapeSource(this)))}setDrapingExtent(t,e){this._spatialReference=e,t.forEach((r,a)=>{this._overlays[a]=r,this._updateImageExtent(r,a)})}destroy(){this.clear()}get spatialReference(){return this._spatialReference}_updateImageExtent(t,e){const r=this._clippedExtent(t.extent,fe);if(r==null)return;const a=ce(t.extent,r,t.resolution);let i=t.pixelRatio*this.view.state.pixelRatio;const{layer:n}=this;if("imageMaxWidth"in n&&n.imageMaxWidth!=null||"imageMaxHeight"in n&&n.imageMaxHeight!=null){const s=n.imageMaxWidth,h=n.imageMaxHeight;if(a.width>s){const o=s/a.width;a.height=Math.floor(a.height*o),a.width=s,i*=o}if(a.height>h){const o=h/a.height;a.width=Math.floor(a.width*o),a.height=h,i*=o}}const l=this._extents[e];l&&N(l.extent,r)&&this._imageSizeEquals(r,l.imageSize,a)||(this._extents[e]={extent:G(r),imageSize:a,pixelRatio:i},this.suspended||this._fetch(e).catch(s=>{V(s)||v.getLogger(this).error(s)}))}clear(){for(let t=0;t<this._images.length;t++)this._clearImage(t)}async doRefresh(t){const e=[];for(let r=0;r<this._extents.length;r++)this._extents[r]&&e.push(this._fetch(r,t));await Promise.allSettled(e)}async processResult(t,e,r){(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement)&&(t.image=e)}findExtentInfoAt(t){for(const e of this._extents){const r=e.extent;if(new O(r[0],r[1],r[2],r[3],this._spatialReference).contains(t))return e}return null}async redraw(t,e){await k(this._images,async(r,a)=>{r&&(await t(r,e),await this._createStageObjects(a,r.image,e))})}_imageSizeEquals(t,e,r){if(!this.maximumDataResolution)return!1;const a=R(t)/this.maximumDataResolution.x,i=b(t)/this.maximumDataResolution.y,n=a/e.width,l=i/e.height,s=a/r.width,h=i/r.height,o=Math.abs(n-s),d=Math.abs(l-h),u=ee.TESTS_DISABLE_OPTIMIZATIONS?0:1.5;return o<=u&&d<=u}async _fetch(t,e){if(this.suspended)return;const r=this._extents[t],a=r.extent;this._images[t]||(this._images[t]={texture:null,material:null,renderGeometry:null,loadingPromise:null,loadingAbortController:null,image:null,pixelData:null,renderExtent:G(a)});const i=this._images[t];i.loadingAbortController=P(i.loadingAbortController);const n=new O(a[0],a[1],a[2],a[3],this._spatialReference);if(n.width===0||n.height===0)return void this._clearImage(t);const l=new AbortController;i.loadingAbortController=l,W(e,()=>l.abort());const s=l.signal,h=this._waitFetchReady(s).then(async()=>{_(s);const o={requestAsImageElement:!0,pixelRatio:this._overlays[t].pixelRatio,...this.layerView.getFetchOptions(),signal:s},{height:d,width:u}=r.imageSize;return this.layer?this.layer.type==="imagery"?this.layer.internalFetchImage(n,u,d,o):this.layer.fetchImage(n,u,d,o):null}).then(o=>{if(Y(s))throw v.getLogger(this).warnOnce("A call to fetchImage resolved even though the request was aborted. fetchImage should not resolve if options.signal.aborted is true."),Z();return this.processResult(i,o)}).then(()=>{I(i.renderExtent,a)});i.loadingPromise=h,await this.updatingHandles.addPromise(h.then(async()=>{_(s),await this._createStageObjects(t,i.image,s)}).catch(o=>{throw o&&!V(o)&&v.getLogger(this).error(o),o}).finally(()=>{h===i.loadingPromise&&(i.loadingPromise=null,i.loadingAbortController=null)}))}_clearImage(t){const e=this._images[t];if(e){e.renderGeometry!=null&&(this._drapeSourceRenderer.removeGeometries([e.renderGeometry],1),e.renderGeometry=null);const r=this.view.stage,a=e.texture;a?.unload(),r.removeTexture(a),e.texture=null,e.material=null,e.loadingAbortController=P(e.loadingAbortController),e.loadingPromise=null,e.image=null,e.pixelData=null}}async _createStageObjects(t,e,r){const a=this.view.stage,i=this._images[t],n=()=>{i.texture?.unload(),a.removeTexture(i.texture),i.texture=null,i.renderGeometry&&(this._drapeSourceRenderer.removeGeometries([i.renderGeometry],1),i.renderGeometry=null)};if(e){const l=new te(e,{width:e.width,height:e.height,preMultiplyAlpha:!0,wrap:{s:33071,t:33071}});if(await B(this._images[t===0?1:0].loadingPromise),_(r),n(),await a.schedule(()=>l.load(a.renderView.renderingContext),r),!l.loaded)return void n();let s;if(a.addTexture(l),i.texture=l,i.material??=new le({draped:!0,texture:l}),i.material.setParameters({texture:l}),t===0)s=z(i.material,i.renderExtent);else{const h=this._images[0].renderExtent;if(!h)return void n();s=ge(i.material,h,i.renderExtent)}i.renderGeometry=new oe(s),i.renderGeometry.localOrigin=this._overlays[t].renderLocalOrigin,this._drapeSourceRenderer.addGeometries([i.renderGeometry],1)}else n(),i.material=null}_clippedExtent(t,e){if(this.view.viewingMode!=="local")return I(e,t);const r=this.view.basemapTerrain;return r.ready?Q(t,r.extent,e):I(e,t)}async _waitFetchReady(t){await K(()=>this.view.stationary,t),_(t)}get usedMemory(){return this._images.reduce((t,e)=>t+(e.texture?.usedMemory??0),0)}};c([f()],S.prototype,"type",void 0),S=c([T("esri.views.3d.layers.DrapedSubView3D")],S);const fe=G();let g=class extends ue(he(de)){constructor(){super(...arguments),this.fullExtentInLocalViewSpatialReference=null,this.refreshDebounced=q(async t=>{this.destroyed||await this._doRefresh(t).catch(e=>{V(e)||v.getLogger(this).error(e)})},2e3),this.ignoresMemoryFactor=!1,this.unloadedMemory=0}get visibleAtCurrentScale(){const t=this.layer,e="effectiveScaleRange"in t?t.effectiveScaleRange:null;return me(e,this.view.scale)}isUpdating(){return super.isUpdating()||this.subView?.updating}initialize(){this._initSubView(),this.view.viewingMode==="local"&&this.addResolvingPromise((async()=>this.fullExtentInLocalViewSpatialReference=await se(this.layer.fullExtent,this.view.spatialReference))()),this._updatingHandles.add(()=>this.suspended,()=>this._suspendedChangeHandler())}destroy(){this.subView=j(this.subView)}_initSubView(){this.subView=new S({layerView:this})}async doRefresh(){return this._doRefresh()}async _doRefresh(t){this.suspended||await this.subView.doRefresh(t)}getFetchOptions(){}_suspendedChangeHandler(){this.suspended?this.subView.clear():this.refreshDebounced()}get test(){}get usedMemory(){return this.subView.usedMemory}get performanceInfo(){return new ne(this.usedMemory)}};c([f()],g.prototype,"layer",void 0),c([f()],g.prototype,"suspended",void 0),c([f()],g.prototype,"fullExtentInLocalViewSpatialReference",void 0),c([f({readOnly:!0})],g.prototype,"visibleAtCurrentScale",null),c([f()],g.prototype,"updating",void 0),c([f()],g.prototype,"subView",void 0),g=c([T("esri.views.3d.layers.DynamicLayerView3D")],g);export{S as b,g};
