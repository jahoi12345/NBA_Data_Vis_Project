import{H as S,_ as R}from"./index-CTl7hdrJ.js";import{an as X}from"./Point-BfTTZoMu-BAT2Wq6O.js";import{H as w}from"./enums-B4pqBiXb-BO-3hS_8.js";import"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import"./reader-DcGs6kKN-DHJfK-tm.js";function b(){return T??=(async()=>{const e=await S(()=>R(()=>import("./basis_encoder-UQPmgXGW-DOoykSfX.js"),[]),[]),t=await e.default({locateFile:n=>X(`esri/libs/basisu/${n}`)});return t.initializeBasis(),t})(),T}let T;function x(){T=null}function B(){return y??=(async()=>await(await S(()=>R(()=>import("./dxt_encoder-CtpzRCd9-D9WBlKyt.js"),[]),[])).default({locateFile:e=>X(`esri/libs/dxtEncoder/${e}`)}))(),y}let y;function F(){y=null}let A,_,u=null,f=null;class m{constructor(t,n){this.internalFormat=t,this.compressedTexture=n}}function ee(){u=null,A=null,f=null,_=null,x(),F()}async function te(e){let t;t=e.data instanceof ImageBitmap?O(e.data):v(e.data,e.width,e.height,e.components,e.needsFlip);try{if(e.hasS3TC){f||await D();const n=new Uint8Array(t.length);if(f?.encode(t,e.width,e.height,e.preMultiplyAlpha,n)){const a=Z(n,!0),o=[n.buffer];return{result:new m(a?.internalFormat??null,a?.textureData??null),transferList:o}}return{result:new m(null,null)}}if(e.hasETC){if(u||await M(),e.preMultiplyAlpha&&!f&&await D(),e.preMultiplyAlpha){const s=new Uint8ClampedArray(t.length);f?.premultiply(new Uint8Array(t),e.width,e.height,s),t=s}const n=U(t,e.width,e.height,e.hasMipmap),a=n?I(n):null,o=a?.compressedTexture?.levels.map(s=>s.buffer)||[];return{result:new m(a?.internalFormat??null,a?.compressedTexture??null),transferList:o}}return{result:new m(null,null)}}finally{t instanceof ImageBitmap&&t.close()}}async function M(){u||(u=await(A??=b()),A=null)}async function D(){f||(f=await(_??=B()),_=null)}function U(e,t,n,a,o=255,s=0,l=!1,i=!1){if(!u)return null;const r=new u.BasisEncoder;r.setPerceptual(!i),r.setCheckForAlpha(!0),r.setForceAlpha(!1),r.setRenormalize(i),r.setMipGen(a),r.setMipSRGB(!i),r.setCreateKTX2File(!0),r.setKTX2SRGBTransferFunc(!i),r.setQualityLevel(o),r.setCompressionLevel(s);const c=new Uint8Array(e.byteLength);r.setSliceSourceImage(0,new Uint8Array(e),t,n,l);const d=r.encode(c),p=new Uint8Array(c.buffer,0,d),h=new u.KTX2File(new Uint8Array(p));return h.isValid()?(r.delete(),p):(h.close(),h.delete(),r.delete(),null)}function I(e){if(!u)return new m(null,null);const t=new u.KTX2File(new Uint8Array(e));t.startTranscoding();const[n,a]=t.getHasAlpha()?[1,w.COMPRESSED_RGBA8_ETC2_EAC]:[0,w.COMPRESSED_RGB8_ETC2],o=t.getLevels(),s=[];for(let l=0;l<o;l++)s.push(new Uint8Array(t.getImageTranscodedSizeInBytes(l,0,0,n))),t.transcodeImage(s[l],l,0,0,n,0,-1,-1);return t.close(),t.delete(),{internalFormat:a,compressedTexture:{type:"compressed",levels:s}}}function O(e){const t=new OffscreenCanvas(e.width,e.height),n=t.getContext("2d");return n.drawImage(e,0,0),n.getImageData(0,0,t.width,t.height).data}function v(e,t,n,a,o){const s=new Uint8ClampedArray(e).subarray(0,t*n*a);if(!o)return s;const l=new Uint8ClampedArray(s.length),i=t*a;for(let r=0;r<n;r++){const c=r*i,d=(n-r-1)*i;l.set(s.subarray(c,c+i),d)}return l}const P=31,G=1,L=2,K=3,k=4,z=7,H=21,V=131072;function C(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}const $=C("DXT1"),Q=C("DXT3"),W=C("DXT5");function Z(e,t){const n=new Int32Array(e.buffer,e.byteOffset,P);let a,o;switch(n[H]){case $:a=8,o=w.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case Q:a=16,o=w.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case W:a=16,o=w.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return null}let s=1,l=n[k],i=n[K];(3&l||3&i)&&(l=l+3&-4,i=i+3&-4);const r=l,c=i;let d,p;n[L]&V&&t!==!1&&(s=Math.max(1,n[z]));let h=e.byteOffset+n[G]+4;const E=[];for(let g=0;g<s;++g)p=(l+3>>2)*(i+3>>2)*a,d=new Uint8Array(e.buffer,h,p),E.push(d),h+=p,l=Math.max(1,l>>1),i=Math.max(1,i>>1);return{textureData:{type:"compressed",levels:E},internalFormat:o,width:r,height:c}}export{m as TextureCompressionWorkerOutput,te as compress,U as compressRGBADataToKTX2,I as createTextureDataKTX2,ee as destroy,M as initializeBasisEncoder,D as initializeDXTEncoder};
