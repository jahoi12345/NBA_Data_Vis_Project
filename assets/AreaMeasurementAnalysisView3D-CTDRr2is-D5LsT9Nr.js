import{x as Ke,c as S,v as Je,q as He,Y as n,H as h,G as $,a as ae,b as Ye}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{s as Ze}from"./getDefaultUnitForView-BIGim07z-DyM4eekL.js";import{s as Qe}from"./AnalysisView3D-zhHEgrUR-DZ8OICjY.js";import{J as Xe,j as D,l as z,W as et,o as tt,i as X,s as it}from"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import{E as st,y as rt}from"./mathUtils-PIGhLnI9-B1tKUlUb.js";import{s as B,aB as Y,R as ne,bq as at,a9 as oe,ax as nt}from"./ShadowCastClear.glsl-CeOT_rAo-BEYyVrmo.js";import{b as j,bs as ze,af as le,by as Te,aH as ot,a5 as lt,bq as ht}from"./Point-BfTTZoMu-DeJwQYfh.js";import{aq as pt,F as he,aj as dt}from"./Polygon-D6wEPb3W-D2MPjRU4.js";import{r as $e,o as pe}from"./vec2f64-rIxtbMRN-Kai9mK1i.js";import{$ as T,v as ut,I as ke,F as ct,B as mt,A as R,k as Z,O as ee,l as Fe}from"./vec32-CewSdTn3-VRto2OOh.js";import{t as m}from"./collectionUtils-jDyktm0P-BDP2Oq99.js";import{e as N,o as gt}from"./vec4f64-DPb6J-GU-C7c2DqbZ.js";import{F as _t,J as yt}from"./projectionUtils-BGH_5_I3-DGwchVO8.js";import{z as de}from"./spatialReferenceEllipsoidUtils-D2JabnKt-Ce3ED0lc.js";import{x as K}from"./projectVectorToVector-Csv3NYZI-DpBtmQMN.js";import{l as E}from"./projectPointToVector-DL7Z4uvb-CPbOlZdQ.js";import{U as ue}from"./Indices-D0_UQPPr-t1Qev6md.js";import{G as ce}from"./Extent-CgDMOSRD-Bod5LY6s.js";import{y as ft}from"./sphere-DLQ6p7mp-DyEe1Vll.js";import{g as vt,cI as wt,o as me,cu as St,a2 as Vt,Y as Mt,w as Pt,N as Lt,B as bt,F as Dt,al as xt,bJ as Ct,a0 as At,an as Ot,ao as Rt,ay as Gt,aQ as It,aN as Ht,aR as zt,aO as Tt,bl as $t,aT as ge,aS as kt,ca as I}from"./Texture-CFNZjV2R-CxGjQ8pI.js";import{v as Ft,T as Et,E as Ut,C as Wt,q as qt,U as _e}from"./measurementUtils-C1dpMJBr-CQSGKAus.js";import{q as te,h as ye,T as Bt}from"./plane-BNdSPG2o-DTV5z6SO.js";import{t as jt,D as fe}from"./geodesicAreaMeasurementUtils-DMf2sF8v-ppx2yPNh.js";import{r as Nt,A as Kt,x as Jt,P as Yt,o as Zt}from"./euclideanLengthMeasurementUtils-CpHh36Dt-Ct4GxOU1.js";import{a as ve,P as Qt}from"./aaBoundingRect-CjwcS2F3-ri8bmh30.js";import{I as Xt,N as H,a as ei,q as we,e as Se,B as Ve}from"./ShadedColorMaterial.glsl-Cdsx30m0-BzzDoTK3.js";import{S as ie,Z as Ee,d as Ue}from"./EditGeometryOperations-DZvKpTU8-DnyvzBdp.js";import{V as ti}from"./intl-DRFqUect-DPhFaHB2.js";import{c as ii,a as J,n as se,e as Me,b as si}from"./colorUtils-CeIi7j7j-C2WVx6th.js";import{i as We}from"./quantityFormatUtils-WvkXaau6-BdljHfvV.js";import{o as ri,i as ai}from"./mat4-C96X-Nn0-BrMLOLCb.js";import{n as ni}from"./mat4f64-q_b6UJoq-Dh6sWB_w.js";import{$ as Pe,k as oi,E as li}from"./Segment-DyJXA5Sk-ByhPeua0.js";import{V as Le,_ as be}from"./vec42-B8VM4vXb-B6OGOEI9.js";import{a as De}from"./orientedBoundingBox-BLEx7wLU-ByGP9QG1.js";import{l as Q,n as xe}from"./Emissions.glsl-B8XKMjLy-DXfiRNVX.js";import{v as qe}from"./DefaultLayouts-B8c6Qefj-C3DDatg5.js";import{m as hi}from"./TriangleMaterial-BIKWylXl-CXByzRQi.js";import{H as pi}from"./index-B0z_nLWi.js";import{r as di}from"./lineStippleUtils-CCavR4OV-DESXkwZW.js";import{m as ui}from"./elevationInfoUtils-B8MpdRMP-CDlK86wO.js";import{r as ci}from"./UpdatingHandles-D2RI_3Hb-dwLPjVun.js";import{x as U,l as Ce}from"./RealisticTree.glsl-WN9nrQUl-QZiY3aPA.js";import{o as mi}from"./SnappingVisualizer3D-BUM9kaD3-CbKiGHEy.js";import{p as gi,S as _i}from"./dragEventPipeline3D-DqqdeG4y-VV3Rp8Vu.js";import{F as Ae}from"./Color-CERqXxxY-BuYn26eI.js";import{w as yi}from"./screenUtils-BitdhK1O-L0FLPAMi.js";import{H as fi}from"./LaserlinePath.glsl-DfE4imRj-NE31_VCm.js";import{H as Be,J as vi}from"./InteractiveToolBase-DXh7kfgV-B5EAl8tr.js";import{r as wi}from"./ToolIntersector-BVL3bGrn-BEYbVCK-.js";import{z as Si,f as Vi,B as Mi,u as Pi}from"./analysisViewUtils-Z_Z4rbWk-DeDBcjbG.js";import{g as Li}from"./SnappingContext-CApcAey_-Bfkkm4s2.js";import{r as bi}from"./SnappingDragPipelineStep-Uh4sAWwf-B8_f2Way.js";import{v as Di}from"./SnappingManagerPool-DdmH-hls-D0aqF7h-.js";import{a as xi}from"./SnappingOperation-ClIdnPwp-BbaP0Atw.js";import"./Polyline-CoiTLswR-DTxpB2Yg.js";import"./typeUtils-DqrRcjBx-DZ6_Gsbu.js";import"./modeUtils-BA-mAwuS-DSb1K26b.js";import"./sanitizerUtils-BT_8V5US-CWQWUwZQ.js";import"./lengthUtils-Dt1_RvOO-j3MEdmHu.js";import"./date-IqUzANpt-bLKO9IDT.js";import"./workers-BEkgoq8Q-BM_Hz460.js";import"./PooledRBush-Dco5QkUp-DX3CMhf3.js";import"./GraphicsCollection-Bk6M0b7D-Dk6KdmO7.js";import"./Graphic-DgGzDmqW-d1CNicxz.js";import"./getPopupProvider-CmskPttI-CzUWpGwk.js";import"./Layer-DZvC7bne-D3VLDrab.js";import"./typeUtils-CXW_VpOn-BGgLp_TK.js";import"./lineMarkers-CDwLe3J6-CNUjJvs3.js";import"./PolygonSymbol3D-BXRHZiCQ-BjPAY2LA.js";import"./ExtrudeSymbol3DLayer-DSc1ou2x-CsVYZCeG.js";import"./aaBoundingBox-Cn49X7ge-BcYPaJ58.js";import"./Font-BwmnW7d2-Dwh3xjKw.js";import"./SimpleFillSymbol-CDawtd9z-CWD2KI2D.js";import"./SimpleMarkerSymbol-BGAFRS9_-CVQ5NLIA.js";import"./PictureMarkerSymbol-CaSh-vZk-xhjZ61bb.js";import"./TextSymbol-hRGhyDHs-CoS7dSjf.js";import"./HeightModelInfo-D5IdRvJ2-23y6MRiu.js";import"./TilemapCache-CjhKW_vj-8gKqgQfa.js";import"./LRUCache-fy84PBMi-Y56WPIvD.js";import"./asyncUtils-w6KfWU41-HenJ0UOu.js";import"./Map-AEYszeHg-ZEOzAMWa.js";import"./Basemap-CL_uaRmk-O3l-dbYk.js";import"./PortalItem-DnxMlRVo-CI4Ns2_M.js";import"./writeUtils-DEFpwIW1-AHZYPaSV.js";import"./CollectionFlattener-D6h2Fkvj-WVl2BXw-.js";import"./resourceExtension-DOTCeiZj-C2WIbjQM.js";import"./PolygonCollection-HNNpnBH7-5UHgGprq.js";import"./mat4f32-Djp3mnm5-DzYG3LYB.js";import"./Query-BlS0WPDF-jdXS_Qhy.js";import"./Field-Cm_ZejYW-CwJZmSru.js";import"./fieldType-DVUzXtk_-tUuvnZJM.js";import"./normalizeUtils-85zLqeMi-C1bdAKNn.js";import"./normalizeUtilsCommon-CnhQye_A-UWhaH-kt.js";import"./ElevationQuery-DzlYa4L4-DkUTW9Ak.js";import"./TileInfo-Bz7QlefV-CdK7c8ef.js";import"./vec3f32-WCVSSNPR-9V6Uhrx-.js";import"./Scheduler-CNrsbccs-Bcg8fWoS.js";import"./InterleavedLayout-B7roQAzV-CdGz7mlm.js";import"./BufferView-Cj2sQaht-avJ4OGB_.js";import"./constants-D67WmGms-H7IOwEdB.js";import"./quat-B7J5v7rV-CZ9akUv-.js";import"./quatf64-CCm9z-pX-CQ7_sSji.js";import"./vector-B8ZDYGQ6-DRILJdcx.js";import"./frustum-CMzahy3--B-DC1Co-.js";import"./floatRGBA-D-Q4FzNN-DQhowfyr.js";import"./UnknownTimeZone-B697BDFv-CBbtul7O.js";import"./TileKey-C44YQC4_-BW7BBbYp.js";import"./unitConversionUtils-4vB4Ezlp-DnY5MDxd.js";import"./vec2f32-CaVKkSa6-BjkBmyoj.js";import"./Octree-DckBBpQ7-CkRPu4UJ.js";import"./axisAngleDegrees-CjbXmycq-DcVVDR1-.js";import"./edgePreprocessing-D_eX-fWy-DqE-06Ss.js";import"./vec3-B_phcnZY-DHC7I6xa.js";import"./vec33-CWJeyzxV-Me4sF5XB.js";import"./earcut-D9gy186--DqxOpTir.js";import"./utils-DTE-xBiC-uxMmcNif.js";import"./geodeticLengthOperator-ysQZ6ofQ-ChYlynyx.js";import"./ColorMaterial.glsl-rhi0cQVb-DVm6kWLC.js";import"./TextOverlayItem-OzxvglQU-B38vHCEh.js";import"./MeshLocalVertexSpace-BGd1IdEs-C0HJG4wR.js";import"./ExtendedLineVisualElement-B_Ze482f-1sZ0lLhF.js";import"./EngineVisualElement-DP9Jiq6V-Dztd1hg5.js";import"./allLayerSnapping-DASGx2Wx-CwdhFVIb.js";import"./jsonUtils-CmpazY1u-6pDLj5sx.js";import"./SimpleObservable-CvFyr0NA-DXpoMYph.js";import"./scaleUtils-yfx9kKWT-D9SVsyM-.js";import"./layerUtils-DZGhvm-W-CfyHx1TZ.js";import"./tagSymbols-BPcGfZon-BPcGfZon.js";import"./Queue-CYlrXMwB-CYJTUII-.js";import"./signal-BX9ezF8a-cf1Pn6io.js";import"./timeZoneUtils-BSc7-7qA-BAv3h8mh.js";import"./ReactiveMap-B0by2bYu-DCsCfMj5.js";import"./TablesMixin-Q80MT3nU-CBB9B-b6.js";import"./enums-B4pqBiXb-BO-3hS_8.js";import"./memoryEstimations-Bd726a_p-0cVCY2Jz.js";import"./VertexElementDescriptor-BlxU8vCE-BwuKQkTU.js";import"./reader-DcGs6kKN-DHJfK-tm.js";import"./Cyclical-BLSxUpe7-Bj8R2Yk-.js";import"./computeTranslationToOriginAndRotation-Bjd4esRf-vJ4LbdOU.js";import"./layerViewUtils-BTa15X3o-BjQlX2q8.js";import"./dehydratedFeatures-Ql-uVzLq-aoK2987s.js";import"./quantizationUtils-Ceq-Uxsu-DjgKK_0s.js";import"./featureConversionUtils-BDA_FXJx-CDxX1Wik.js";import"./OptimizedFeature-CwRGZPwv-Ddclhn0A.js";import"./OptimizedFeatureSet-BR8EEvDc-CgsRgxJh.js";import"./createFeatureId-CVwTD0fV-3fKpJDrk.js";import"./HUDIntersectorResult-1xTExS7z-dL9SFL6u.js";import"./intersectorUtilsConversions-pLQPEbcN-Ck-nyNYa.js";import"./Intersector-DS9YtyQY-DMoYp6i0.js";import"./DefaultLoadingContext-DXgBe4GE-Unnb_XgV.js";import"./wosrLoader-CIPfz1Cl-DlmQQkMX.js";import"./Version-BtYZEj58-LyRHDnSJ.js";import"./DoubleArray-DExKNiTh-CvVpHySW.js";import"./config-Dg972SSE-D9DBKeq5.js";import"./GeometryUtils-C354xUs0-BLAznQrw.js";import"./definitions-Dvg4hMIw-CdK2DzFN.js";import"./WorkerHandle-B930SiRy-DglEKt53.js";import"./capabilities-Bi6C4OG6-CpURufko.js";import"./imageUtils-142g71N8-Wj0XNClb.js";import"./videoUtils-Dwx3AEgj-CduhpDRk.js";import"./uuid-Oe6SV2kF-IYX19xBA.js";import"./quickselect-QQC62dOK-Br2Ahhru.js";import"./meshVertexSpaceUtils-CtG7DPVT-kybwngCt.js";import"./TileKey-CXWFOqOI-Lra6v-mg.js";import"./loadAll-BCyxerwc-B4Lp8wGC.js";import"./opacityUtils-DuFH0EC9-DWspTgn2.js";import"./persistable-CdoDQOTR-BklJqWTn.js";import"./MD5-MtSiOt06-jWr180Yc.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw-DH8sdIsE.js";import"./utils-CylVuxNi--x86XOjU.js";import"./utils-Dpg4yj1D-CeFz2JVC.js";import"./types-BKo2foNY-DE0QfIFp.js";import"./labelUtils-BtizwBfq-Zegx4520.js";import"./ArcadeExpression-BlIRq-oN-VZkrwLVE.js";import"./TimeOnly-BERR31kg-CQiLyUZi.js";import"./enum-BzLwmiID-CcyIdWlQ.js";import"./FieldsIndex-CimK-TqD--24JoCkp.js";import"./geometry2dUtils-B4vDf2wH-DzgYge1I.js";import"./VisualElement-By4iq8p4-ZBataKFH.js";import"./line-DShd3yGd-HKPw0I1T.js";import"./rotate-CKztRS_J-BAJoscjo.js";import"./curveOperationUtils-BGqPT1bh-DTx58Z-T.js";import"./PointVisualElement-pF4jjqm_-CfTxywah.js";import"./PointSnappingHint-w5twIXP5-BTP6hNJz.js";import"./dehydratedFeatureComparison-faNSTYzo-N4d2j25_.js";import"./geodeticCurveType-CirnHLSB-CirnHLSB.js";function Oe(t,e,i,s,r){ke(W,t),ee(q,t,e),K(W,i,W,r),K(q,i,q,r),T(s,q,W),Fe(s,s)}const W=m(),q=m();class Ci{get numVertices(){return this._length}get hasStagedVertex(){return this._lastCursorPoint!=null}constructor(e,i,s){this._sceneView=e,this._geodesicAreaMeasurementUtils=i,this._geodesicLengthMeasurementUtils=s,this.validMeasurement=!1,this.positionsWorld=[],this.positionsRender=[],this.positionsFittedWorld=[],this.positionsFittedRender=[],this.positionsGeodesic=[],this.positionsSpherical=[],this.positionsStereographic=[],this.pathSegmentLengths=[],this.geodesicPathSegmentLengths=[],this.perimeterSegmentLengths=[],this.intersectingSegments=new Set,this.geodesicIntersectingSegments=new Set,this.triangleIndices=null,this.geodesicTriangleIndices=null,this.areaCentroidWorldCoords=m(),this.areaCentroidRenderCoords=m(),this.geodesicAreaCentroidRenderCoords=m(),this.fittingMode=null,this.area=null,this.geodesicArea=null,this.pathLength=null,this.geodesicPathLength=null,this.perimeterLength=null,this._length=0,this._centroidRenderCoords=m(),this._planeWorldCoords=gt(),this._worldUp=m(),this._worldTangent=m(),this._frame=[m(),m(),m()],this._lastPathVersion=-1,this._lastCursorPoint=null,this._mode=null,this._tempU=m(),this._tempV=m(),this._tempVec3=m(),this._tempSphere=ft();const r=Kt(e.spatialReference);this._measurementSR=r,this._lengthMeasurementUnit=ze(r)??"meters",this._areaMeasurementUnit=ot(r)??"square-meters"}update(e,i,s,r,a,o){const l=this._lastPathVersion===e.version,p=i?i.equals(this._lastCursorPoint):this._lastCursorPoint==null,d=this._mode===a;return!(l&&!o&&d&&p)&&(this._lastPathVersion=e.version,this._lastCursorPoint=i,this._updateCursorSegmentLength(e,i),this._update(e,i,s,r,a),!0)}_update(e,i,s,r,a){const o=this._sceneView.renderSpatialReference,l=this._measurementSR,p=s.spatialReference;let d=e.numVertices;const u=!(i==null||i.equals(e.lastPoint)||d>2&&i.equals(e.firstPoint)||e.polygonIsClosed);u&&(d+=1);const c=!e.polygonIsClosed&&d>2,f=e.polygonIsClosed||c;this._resize(d);const _=de(p),g=p!=null&&Jt(p)?p:null,v=g!=null&&yt(p,_),{positionsGeodesic:M,positionsWorld:k,positionsRender:F,positionsSpherical:L}=this,A=(P,x)=>{Ai(s.elevationProvider,P),E(P,k[x],l),E(P,F[x],o),v&&(E(P,M[x],g),E(P,L[x],_),Fe(L[x],L[x]))};e.forEachVertexPosition((P,x)=>A(P,x)),u&&A(i,d-1);const O=this._updatePathLengths(f);if(this.pathLength=this._length>1?Y(O,this._lengthMeasurementUnit):null,v){const P=this._updateGeodesicPathLengths(f,g);this.geodesicPathLength=P!=null&&this._length>1?P:null}else this.geodesicPathLength=null;if(this._updateMode(a),!f)return this.area=null,this.geodesicArea=null,this.perimeterLength=null,this.triangleIndices=null,this.geodesicTriangleIndices=null,this.intersectingSegments.clear(),this.geodesicIntersectingSegments.clear(),void(this.validMeasurement=!1);this._updateAreaAndPerimeterLength(s,o,l,r),v&&this._updateGeodesicArea(s,g),this.validMeasurement=!0}getData(){return{validMeasurement:this.validMeasurement,numVertices:this.numVertices,hasStagedVertex:this.hasStagedVertex,positionsRender:this.positionsRender,positionsFittedWorld:this.positionsFittedWorld,positionsFittedRender:this.positionsFittedRender,intersectingSegments:this.intersectingSegments,geodesicIntersectingSegments:this.geodesicIntersectingSegments,triangleIndices:this.triangleIndices,geodesicTriangleIndices:this.geodesicTriangleIndices,areaCentroidRenderCoords:this.areaCentroidRenderCoords,geodesicAreaCentroidRenderCoords:this.geodesicAreaCentroidRenderCoords,area:this.area,geodesicArea:this.geodesicArea,pathLength:this.pathLength,geodesicPathLength:this.geodesicPathLength,perimeterLength:this.perimeterLength,actualMeasurementMode:this.actualMeasurementMode}}_resize(e){for(e<this._length&&(this.positionsWorld.length=e,this.positionsRender.length=e,this.positionsFittedWorld.length=e,this.positionsFittedRender.length=e,this.positionsGeodesic.length=e,this.positionsSpherical.length=e,this.positionsStereographic.length=e,this.pathSegmentLengths.length=e,this.geodesicPathSegmentLengths.length=e,this.perimeterSegmentLengths.length=e,this._length=e);this._length<e;)this.positionsWorld.push(m()),this.positionsRender.push(m()),this.positionsFittedWorld.push(pe()),this.positionsFittedRender.push(m()),this.positionsGeodesic.push(m()),this.positionsSpherical.push(m()),this.positionsStereographic.push(pe()),this.pathSegmentLengths.push(0),this.geodesicPathSegmentLengths.push(0),this.perimeterSegmentLengths.push(0),++this._length}_updatePathLengths(e){const i=this.positionsWorld,s=this.pathSegmentLengths;let r=0;const a=this._length;for(let o=0;o<a;++o){const l=s[o]=ut(i[o],i[(o+1)%a]);(o<a-1||e)&&(r+=l)}return r}_updateGeodesicPathLengths(e,i){const s=this.positionsGeodesic,r=this.geodesicPathSegmentLengths;let a=0;const o=this._length;for(let l=0;l<o;++l){const p=this._geodesicLengthMeasurementUtils.geodesicDistance(s[l],s[(l+1)%o],i);if(p==null)return null;const d=B(p,"meters").value,u=r[l]=d;(l<o-1||e)&&(a+=u)}return Y(a,"meters")}_updateAreaAndPerimeterLength(e,i,s,r){const a=e.renderCoordsHelper,o=this.positionsWorld,l=this.positionsRender,p=this.positionsFittedWorld,d=this.positionsFittedRender,u=this._planeWorldCoords,c=this._centroidRenderCoords;te(l,c),a.worldUpAtPosition(c,this._worldUp),a.worldBasisAtPosition(c,0,this._worldTangent),Oe(c,this._worldUp,i,this._worldUp,s),Oe(c,this._worldTangent,i,this._worldTangent,s),o.length>2&&Ft(o,u),this.fittingMode=this._selectFittingMode(u,o,this._worldUp,r);let f=0;if(this.fittingMode==="horizontal"){let L=-1/0;l.forEach((A,O)=>{const P=a.getAltitude(l[O]);P>L&&(L=P,f=O)})}const _=o[f];let g=u,v=this._worldTangent;this.fittingMode==="horizontal"?g=this._worldUp:this.fittingMode==="vertical"&&(g=this._tempVec3,v=this._worldUp,ye(u,this._worldUp,g)),ke(this._frame[2],g),ye(v,g,this._frame[0]),ct(this._frame[1],this._frame[0],this._frame[2]),mt(this._frame[1],this._frame[1]);const M=this._tempVec3,k=this._tempU,F=this._tempV;for(let L=0;L<this._length;++L){const A=p[L],O=d[L];T(M,o[L],_),he(A,R(this._frame[0],M),R(this._frame[1],M)),Z(k,this._frame[0],A[0]),Z(F,this._frame[1],A[1]),ee(M,k,F),ee(M,M,_),K(M,s,O,i)}this.perimeterLength=this._length>0?this._updatePerimeterLengths():null,te(d,this.areaCentroidRenderCoords),K(this.areaCentroidRenderCoords,i,this.areaCentroidWorldCoords,s),this._updateIntersectingSegments(),this.area=this.intersectingSegments.size===0?this._computeArea():null}_updateGeodesicArea(e,i){const{renderCoordsHelper:s,spatialReference:r}=e,{positionsSpherical:a,positionsStereographic:o}=this,l=this._tempVec3,p=Et(a,l);if(!p)return void(this.geodesicArea=null);const d=this._tempU,u=this._tempV;Bt(l,d,u);for(let c=0;c<this._length;++c){const f=R(a[c],d),_=R(a[c],u),g=R(a[c],l);he(o[c],f/g,_/g)}Z(l,l,lt(r).radius),s.toRenderCoords(l,de(r),this.geodesicAreaCentroidRenderCoords),this._updateGeodesicIntersectingSegments(),this.geodesicArea=p&&this.geodesicIntersectingSegments.size===0?this._computeGeodesicArea(i):null}_updatePerimeterLengths(){const e=this.positionsFittedWorld,i=this.perimeterSegmentLengths;let s=0;for(let r=0;r<this._length;++r)s+=i[r]=dt(e[r],e[(r+1)%this._length]);return Y(s,this._lengthMeasurementUnit)}_updateIntersectingSegments(){const e=this.positionsFittedWorld,i=this.intersectingSegments;i.clear();for(let s=0;s<this._length;++s)for(let r=s+2;r<this._length;++r){if((r+1)%this._length===s)continue;const a=e[s],o=e[(s+1)%this._length],l=e[r],p=e[(r+1)%this._length];ce(a,o,l,p)&&(i.add(s),i.add(r))}}_computeArea(){const e=this.positionsFittedWorld,i=this.triangleIndices=ue(fe(e));let s=0;for(let r=0;r<i.length;r+=3)s+=wt(e[i[r]],e[i[r+1]],e[i[r+2]]);return ne(s,this._areaMeasurementUnit)}_updateGeodesicIntersectingSegments(){const e=this.positionsStereographic,i=this.geodesicIntersectingSegments;i.clear();for(let s=0;s<this._length;++s)for(let r=s+2;r<this._length;++r){if((r+1)%this._length===s)continue;const a=e[s],o=e[(s+1)%this._length],l=e[r],p=e[(r+1)%this._length];ce(a,o,l,p)&&(i.add(s),i.add(r))}}_computeGeodesicArea(e){const i=this.positionsGeodesic,s=this.positionsStereographic,r=this.geodesicTriangleIndices=ue(fe(s));let a=0;for(let o=0;o<r.length;o+=3){const l=Ut(i[r[o]],i[r[o+1]],i[r[o+2]],e,this._geodesicAreaMeasurementUtils);if(l==null)return null;a+=B(l,"square-meters").value}return ne(a,"square-meters")}_selectFittingMode(e,i,s,r){const a=i.map(u=>Math.abs(Wt(e,u))).reduce((u,c)=>Math.max(u,c),0);qt(i,this._tempSphere);const o=a/(2*this._tempSphere[3]),l=o<r.maxRelativeErrorCoplanar,p=o<r.maxRelativeErrorAlmostCoplanar;let d="horizontal";return l?d="oblique":p&&(d=Math.abs(R(s,e))>Math.cos(rt(r.verticalAngleThreshold))?"horizontal":"vertical"),d}_updateCursorSegmentLength(e,i){const s=e.lastPoint;e.isValidPolygon||s==null||i==null?(this.geodesicStagedSegmentLength=null,this.stagedSegmentLength=null):(this.geodesicStagedSegmentLength=this._geodesicLengthMeasurementUtils.geodesicDistanceBetweenPoints(s,i),this.stagedSegmentLength=Yt(s,i)?.direct)}_updateMode(e){if(e===0){this.actualMeasurementMode="euclidean";let i=0;this.geodesicPathLength!=null&&(i+=this.geodesicPathLength.value),i>Oi&&(this.actualMeasurementMode="geodesic")}else this.actualMeasurementMode=e===1?"euclidean":"geodesic";this.geodesicPathLength==null&&(this.actualMeasurementMode="euclidean"),this._mode=e}}function Ai(t,e){e.hasZ||(e.z=at(t,e,"ground")??0)}const Oi=1e5;let C=class extends He{constructor(t){super(t)}initialize(){this._measurementDataManager=new Ci(this.view,this.geodesicAreaMeasurementUtils,this.geodesicLengthMeasurementUtils),this.addHandles([this.analysisViewData.path.on("change",()=>this._update()),D(()=>this.analysisViewData.stagedPoint,()=>this._update(),X),D(()=>this.analysisViewData.mode,()=>this._update(),X)]),this._update()}_update(t=!1){const{analysisViewData:e,view:i}=this,s={maxRelativeErrorCoplanar:.005,maxRelativeErrorAlmostCoplanar:.01,verticalAngleThreshold:80};this._measurementDataManager.update(e.path,e.stagedPoint,i,s,e.mode,t)&&(e.measurementData=this._measurementDataManager.getData())}};n([h({constructOnly:!0})],C.prototype,"view",void 0),n([h({constructOnly:!0})],C.prototype,"analysis",void 0),n([h({constructOnly:!0})],C.prototype,"analysisViewData",void 0),n([h({constructOnly:!0})],C.prototype,"geodesicAreaMeasurementUtils",void 0),n([h({constructOnly:!0})],C.prototype,"geodesicLengthMeasurementUtils",void 0),C=n([$("esri.views.3d.analysis.AreaMeasurement.support.AreaMeasurementController")],C);let b=class extends Xe{constructor(t={}){super(t),this._version=0,this._internalGeometryChange=!1,this._extent=ve()}set areaMeasurement(t){this._set("areaMeasurement",t),t!=null&&this.view!=null&&this._initialize(t,this.view)}set view(t){this._set("view",t),t!=null&&this.areaMeasurement!=null&&this._initialize(this.areaMeasurement,t)}get constructed(){return this.areaMeasurement!=null&&this.view!=null}get version(){return this._version}get isEmptyPolygon(){return!this.constructed||this._editGeometry.parts.length===0}get isValidPolygon(){return this.constructed&&this.polygonIsClosed}get extent(){if(this.constructed&&this._editGeometry.parts[0]?.vertices.length){const t=ve(this._extent);return this.forEachVertex(e=>{Qt(t,e.pos)}),t}return null}get spatialReference(){return this.constructed?this._editGeometry.coordinateHelper.spatialReference:null}_initialize(t,e){this.removeAllHandles(),this.addHandles(D(()=>t.geometry,()=>{this._updateEditGeometryFromModelGeometry(t,e)},z)),this._makeDirty(!0)}_makeDirty(t=!1){this.notifyChange("polygonIsClosed"),this.notifyChange("isValidPolygon"),this.notifyChange("initialized"),this.notifyChange("extent"),t&&this.notifyChange("numVertices")}_updateEditGeometryFromModelGeometry(t,e){if(this._version++,this._internalGeometryChange)return;this.removeHandles("EditGeometry");let i=t.geometry;if(i!=null){const s=_t(i,e.spatialReference);s==null&&Xt(t,i.spatialReference,Je.getLogger(this)),i=s}this._editGeometryOperations=i!=null?ie.fromGeometry(i,e.state.viewingMode):new ie(new Ee("polygon",Ue(!0,!1,e.spatialReference)),e.state.viewingMode),this._makeDirty(!0),this.emit("change"),this.addHandles(this._editGeometry.on("change",s=>{this._makeDirty(s.addedVertices!=null||s.removedVertices!=null),this._internalGeometryChange=!0,t.geometry=this.numVertices>0?this._editGeometry.geometry:null,this._internalGeometryChange=!1}),"EditGeometry")}get _editGeometry(){return this._editGeometryOperations.data}get vertices(){const t=[];return this.forEachVertex(e=>{t.push(e)}),t}get numVertices(){return this.constructed?this._editGeometry.parts[0]?.vertices.length??0:0}get polygonIsClosed(){return this._editGeometry.parts[0]?.isClosed()??!1}get firstPoint(){if(this.constructed){const{coordinateHelper:t,parts:e}=this._editGeometry,i=e[0]?.getFirstVertex();if(i!=null)return t.vectorToPoint(i.pos)}return null}get lastPoint(){if(this.constructed){const{coordinateHelper:t,parts:e}=this._editGeometry,i=e[0]?.getLastVertex();if(i!=null)return t.vectorToPoint(i.pos)}return null}getVertex(t){if(!this.constructed||!this._editGeometry.parts[0]?.vertices.length)return null;const e=this._editGeometry.parts[0].vertices[0];let i=e;do{if(i.index===t)return i;i=i.rightSegment.rightVertex}while(i!==e&&i!=null);return null}getVertexPositionAsPoint(t){return this._editGeometry.coordinateHelper.vectorToPoint(t.pos)}getVertexPositionAsPointFromIndex(t){return this._editGeometry.coordinateHelper.vectorToPoint(this.getVertex(t).pos)}forEachVertex(t){if(this.constructed&&this._editGeometry.parts.length>0)for(const e of this._editGeometry.parts[0].iterateVertices())t(e,e.index)}forEachVertexPosition(t){const e=this._editGeometry.coordinateHelper;this.forEachVertex((i,s)=>{e.vectorToPoint(i.pos,Re),t(Re,s)})}clear(){this.areaMeasurement!=null&&(this.areaMeasurement.geometry=null)}add(t){if(!this.constructed)return null;const e=this._editGeometryOperations.appendVertex(this._editGeometry.coordinateHelper.pointToVector(t),this._editGeometry.parts.at(0));return this.emit("change"),e}close(){if(!this.constructed||this._editGeometry.parts.length===0)return null;const t=this._editGeometryOperations.closePart(this._editGeometry.parts[0]);return this.emit("change"),t}ensureContains(t,e=""){let i=!1;if(this._editGeometry.parts.forEach(s=>{for(const r of s.iterateVertices())r===t&&(i=!0)}),!i)throw new Error(`vertex doesn't exist ${e}`);return i}setVertexPosition(t,e){if(!this.constructed)return null;const i=this._editGeometryOperations.setVertexPosition(t,this._editGeometry.coordinateHelper.pointToVector(e));return this.emit("change"),i}equals(t){if(this.numVertices!==t.numVertices)return!1;let e=!0;return this.forEachVertexPosition((i,s)=>{const r=t.getVertexPositionAsPointFromIndex(s);i.equals(r)||(e=!1)}),!!e}};n([h({value:null})],b.prototype,"areaMeasurement",null),n([h({value:null})],b.prototype,"view",null),n([h()],b.prototype,"isEmptyPolygon",null),n([h()],b.prototype,"isValidPolygon",null),n([h()],b.prototype,"extent",null),n([h()],b.prototype,"spatialReference",null),n([h()],b.prototype,"numVertices",null),n([h()],b.prototype,"polygonIsClosed",null),b=n([$("esri.views.3d.analysis.AreaMeasurement.support.AreaMeasurementPathHelper")],b);const Re=new j;function re(t,e){return B(t,Te(t.value,t.unit,e))}function Ge(t,e){return B(t,je(t,e))}function je(t,e){const i=Ri(e);return ht(t.value,t.unit,i)}function Ri(t){switch(t){case"metric":case"ares":case"hectares":return"metric";case"imperial":case"acres":return"imperial";case"square-inches":return"inches";case"square-feet":return"feet";case"square-yards":return"yards";case"square-miles":return"miles";case"square-nautical-miles":return"nautical-miles";case"square-us-feet":return"us-feet";case"square-millimeters":return"millimeters";case"square-centimeters":return"centimeters";case"square-decimeters":return"decimeters";case"square-meters":return"meters";case"square-kilometers":return"kilometers"}throw new Error("unhandled area unit")}function Ne(t){const e=new Gt,{vertex:i,fragment:s,varyings:r}=e;return e.fragment.include(It,t),e.include(Ht,t),e.include(zt,t),Tt(i,t),e.attributes.add("position","vec3"),e.attributes.add("uv0","vec2"),r.add("vUV","vec2"),r.add("vpos","vec3"),i.main.add(xe`vUV = uv0;
vpos = position;
forwardViewPosDepth((view * vec4(position, 1.0)).xyz);
gl_Position = proj * view * vec4(position, 1.0);`),s.uniforms.add(new $t("size",a=>a.size)),s.uniforms.add(new ge("color1",a=>a.color1)),s.uniforms.add(new ge("color2",a=>a.color2)),s.include(kt),s.main.add(xe`discardByTerrainDepth();
vec2 uvScaled = vUV / (2.0 * size);
vec2 uv = fract(uvScaled - 0.25);
vec2 ab = clamp((abs(uv - 0.5) - 0.25) / fwidth(uvScaled), -0.5, 0.5);
float fade = smoothstep(0.25, 0.5, max(fwidth(uvScaled.x), fwidth(uvScaled.y)));
float t = mix(abs(ab.x + ab.y), 0.5, fade);
fragColor = mix(color2, color1, t);
outputColorHighlightOID(fragColor, vpos, fragColor.rgb);`),e}const Gi=Object.freeze(Object.defineProperty({__proto__:null,build:Ne},Symbol.toStringTag,{value:"Module"}));class Ii extends Lt{constructor(e,i){super(e,i,new bt(Gi,()=>pi(()=>Promise.resolve().then(()=>Qi),void 0)),qe.locations)}initializePipeline(e){const{oitPass:i,transparent:s,polygonOffset:r,output:a}=e,o=i===0,l=i===2;return Dt({blending:s?Rt(i):null,depthTest:{func:Ot(i)},depthWrite:At(e),drawBuffers:Ct(i,a),colorWrite:xt,polygonOffset:o||l?r?Hi:null:{factor:-1,units:-25}})}}const Hi={factor:0,units:-25};class G extends Mt{constructor(){super(...arguments),this.transparent=!1,this.writeDepth=!0,this.polygonOffset=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.textureCoordinateType=0,this.emissionSource=0,this.output=0,this.occlusionPass=!1,this.olidColorInstanced=!1,this.overlayEnabled=!1,this.draped=!1,this.snowCover=!1}get discardInvisibleFragments(){return this.transparent&&this.writeDepth}}n([I()],G.prototype,"transparent",void 0),n([I()],G.prototype,"writeDepth",void 0),n([I()],G.prototype,"polygonOffset",void 0),n([I()],G.prototype,"terrainDepthTest",void 0),n([I()],G.prototype,"cullAboveTerrain",void 0);class zi extends hi{constructor(e){super(e,$i),this._configuration=new G,this.produces=new Map([[2,i=>Q(i)&&!this.transparent],[4,i=>Q(i)&&this.transparent&&this.parameters.writeDepth],[8,i=>Q(i)&&this.transparent&&!this.parameters.writeDepth]])}getConfiguration(e,i){return super.getConfiguration(e,i,this._configuration),this._configuration.transparent=this.transparent,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.oitPass=i.oitPass,this._configuration.terrainDepthTest=i.terrainDepthTest,this._configuration.cullAboveTerrain=i.cullAboveTerrain,this._configuration}get visible(){return this.parameters.color1[3]>=me||this.parameters.color2[3]>=me}get transparent(){return this.parameters.color1[3]<1||this.parameters.color2[3]<1}createGLMaterial(e){return new Ti(e)}createBufferWriter(){return new St(qe)}}class Ti extends Pt{beginSlot(e){return this.getTechnique(Ii,e)}}class $i extends Vt{constructor(){super(...arguments),this.size=$e(1,1),this.color1=N(.75,.75,.75,1),this.color2=N(.5,.5,.5,1),this.writeDepth=!0,this.polygonOffset=!1}}class ki extends ei{constructor(e){super(e),this._checkerBoardMaterial=null,this._renderOccluded=4,this._geometry=null,this._size=$e(1,1),this._color1=N(1,.5,0,.5),this._color2=N(1,1,1,.5),this.applyProperties(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get size(){return this._size}set size(e){pt(this._size,e),this._updateMaterial()}get color1(){return this._color1}set color1(e){Le(e,this._color1)||(be(this._color1,e),this._updateMaterial())}get color2(){return this._color2}set color2(e){Le(e,this._color2)||(be(this._color2,e),this._updateMaterial())}_updateMaterial(){this._checkerBoardMaterial?.setParameters({size:this._size,color1:this._color1,color2:this._color2,renderOccluded:this._renderOccluded})}createExternalResources(){this._checkerBoardMaterial=new zi({size:this._size,color1:this._color1,color2:this._color2,writeDepth:!1,polygonOffset:!0,renderOccluded:4,isDecoration:this.isDecoration})}destroyExternalResources(){this._checkerBoardMaterial=null}forEachMaterial(e){e(this._checkerBoardMaterial)}createGeometries(e){if(this._geometry==null||this._checkerBoardMaterial==null)return;const i=Fi;ai(i,this.transform);const s=this._geometry,r=[],a=m();s.position.forEach(p=>{T(a,p,i),r.push(a[0],a[1],a[2])});const o=[];s.uv.forEach(p=>{o.push(p[0],p[1])});const l=new vt(this._checkerBoardMaterial,[["position",new De(r,s.triangleIndices,3,!0)],["uv0",new De(o,s.triangleIndices,2,!0)]]);e.addGeometry(l)}}const Fi=m();let V=class extends He{get _parameters(){const{accentColor:t,textColor:e}=this.view.effectiveTheme,i=ii(t),s=J(t,.5),r=J(se(t),.5),a=se(e,160);return{accentColor:i,transparentAccentColor:s,transparentContrastColor:r,intersectingLineColor:[1,.2,0,1],textColor:e,textBackgroundColor:Me(a,.6),textCalloutColor:Me(a,.5),pathLineWidth:3,perimeterLineWidth:2,projectionLineWidth:2,projectionLineStippleSize:5,labelDistance:25}}get visible(){return this.analysisViewData.visible}get _renderUnits(){const t=this.view.renderCoordsHelper.spatialReference;return ze(t)??"meters"}get testData(){}constructor(t){super(t),this._path=null,this._intersectedPath=null,this._perimeter=null,this._intersectedPerimeter=null,this._projectionLines=null,this._measurementArea=null,this._areaLabel=null,this._perimeterLengthLabel=null,this._pathSegments=[],this._perimeterSegments=[],this._origin=m(),this._originTransform=ni(),this.messages=null,this.viewData=Wi,this.areaLabel=null,this.perimeterLengthLabel=null,this.loadingMessages=!0}initialize(){const{analysisViewData:t,_parameters:e,view:i}=this;this._path=new H({view:i,attached:!0,width:e.pathLineWidth,polygonOffset:!0,renderOccluded:4,isDecoration:!0}),this._intersectedPath=new H({view:i,attached:!0,width:e.pathLineWidth,polygonOffset:!0,renderOccluded:4,isDecoration:!0}),this._perimeter=new H({view:i,attached:!0,width:e.perimeterLineWidth,polygonOffset:!0,renderOccluded:4,isDecoration:!0}),this._intersectedPerimeter=new H({view:i,attached:!0,width:e.perimeterLineWidth,color:e.intersectingLineColor,polygonOffset:!0,renderOccluded:4,isDecoration:!0}),this._projectionLines=new H({view:i,attached:!0,width:e.projectionLineWidth,stipplePattern:di(e.projectionLineStippleSize),polygonOffset:!0,renderOccluded:4,isDecoration:!0}),this._measurementArea=new ki({view:i,attached:!0,isDecoration:!0});const s={attached:!0,view:i,isDecoration:!0};this._areaLabel=new Pe({...s,fontSize:16}),this._perimeterLengthLabel=new Pe({...s,fontSize:12}),this.addHandles([D(()=>[t.mode,this.visible,t.unit,t.measurementData,t.stagedPoint],()=>this._update(),z),D(()=>i.state?.camera,()=>this._updateLabels(),z),et(()=>this._updateMessageBundle()),D(()=>this._parameters,({accentColor:r,transparentAccentColor:a,transparentContrastColor:o,textColor:l,textBackgroundColor:p,textCalloutColor:d})=>{const{_path:u,_intersectedPath:c,_perimeter:f,_projectionLines:_,_measurementArea:g,_areaLabel:v,_perimeterLengthLabel:M}=this;u.color=r,c.color=r,f.color=r,_.color=r,g.color1=a,g.color2=o,v.textColor=l,v.backgroundColor=p,v.calloutColor=d,M.textColor=l,M.backgroundColor=p,M.calloutColor=d},tt)]),this._updateMessageBundle()}destroy(){this._measurementArea=S(this._measurementArea),this._path=S(this._path),this._intersectedPath=S(this._intersectedPath),this._perimeter=S(this._perimeter),this._intersectedPerimeter=S(this._intersectedPerimeter),this._areaLabel=S(this._areaLabel),this._perimeterLengthLabel=S(this._perimeterLengthLabel),this._projectionLines=S(this._projectionLines),this.set("view",null)}_update(){if(this.destroyed||!this.view.ready||!this.view.renderCoordsHelper)return;const{analysisViewData:{measurementData:t},analysisViewData:e}=this;t!=null&&(this._updateViewData(t,e.path),this._updateOrigin(),this._updatePathSegments(),this._updatePerimeterSegments(),this._updateArea(),this._updateProjectionLines(),this._updateLabels())}_updateViewData(t,e){const i=t.validMeasurement,s=t.actualMeasurementMode==="geodesic",r=s?t.geodesicArea:t.area;let a=1;if(r){const l=re(r,this.analysisViewData.unit);a=st(Math.sqrt(l.value)/Math.sqrt(300)),a*=Math.sqrt(le(1,l.unit,"square-meters")),a=le(a,"meters",this._renderUnits)}const o={validMeasurement:i,numVertices:t.numVertices,hasStagedVertex:t.hasStagedVertex,path:e,mode:t.actualMeasurementMode,positionsRender:t.positionsRender,positionsFittedWorld:t.positionsFittedWorld,positionsFittedRender:t.positionsFittedRender,intersectingSegments:s?t.geodesicIntersectingSegments:t.intersectingSegments,triangleIndices:s?t.geodesicTriangleIndices:t.triangleIndices,areaCentroid:s?t.geodesicAreaCentroidRenderCoords:t.areaCentroidRenderCoords,perimeterLengthLabelSegmentIndex:0,area:s?t.geodesicArea:t.area,pathLength:s?t.geodesicPathLength:t.pathLength,perimeterLength:t.perimeterLength,checkerSize:a};this._set("viewData",o)}_updateOrigin(){const t=this.viewData;te(t.positionsRender,this._origin),ri(this._originTransform,this._origin),this._measurementArea.transform=this._originTransform,this._projectionLines.transform=this._originTransform}_createSegments(t){const e=this.viewData,i=this.view.renderCoordsHelper.spatialReference,s=e.mode,r=[],a=[],o=[],l=e.numVertices,p=e.validMeasurement?l:l-1;for(let u=0;u<p;++u){const c=e[t][u],f=e[t][(u+1)%l];let _=null;switch(s){case"euclidean":_=new li(c,f);break;case"geodesic":_=new oi(c,f,i)}e.intersectingSegments.has(u)?o.push(_):a.push(_),r.push(_)}let d=null;return e.validMeasurement&&e.hasStagedVertex&&p>=2?d=r[r.length-2]:e.hasStagedVertex&&p>=1&&(d=r[r.length-1]),{all:r,nonIntersecting:a,intersecting:o,stagedSegment:d}}_updatePathSegments(){const{visible:t}=this,e=this._createSegments("positionsRender");this._path.setGeometryFromSegments(e.nonIntersecting,this._origin),this._path.visible=t,this._intersectedPath.setGeometryFromSegments(e.intersecting,this._origin),this._intersectedPath.visible=t,this._pathSegments=e.all}_updatePerimeterSegments(){const t=this.visible&&this.viewData.mode==="euclidean"&&this.viewData.path.numVertices>2,e=this._createSegments("positionsFittedRender");this._perimeter.setGeometryFromSegments(e.nonIntersecting,this._origin),this._perimeter.visible=t,this._intersectedPerimeter.setGeometryFromSegments(e.intersecting,this._origin),this._intersectedPerimeter.visible=t,this._perimeterSegments=e.all}_updateArea(){const t=this.viewData;switch(t.mode){case"euclidean":this._updateAreaEuclidean(t);break;case"geodesic":this._updateAreaGeodesic()}}_updateAreaEuclidean(t){const e=this.visible;t.validMeasurement&&t.intersectingSegments.size===0&&t.triangleIndices?(this._measurementArea.geometry={uv:t.positionsFittedWorld,position:t.positionsFittedRender,triangleIndices:t.triangleIndices},this._measurementArea.size=[t.checkerSize,t.checkerSize],this._measurementArea.visible=e):this._measurementArea.visible=!1}_updateAreaGeodesic(){this._measurementArea.visible=!1}_updateProjectionLines(){const t=this.viewData,e=this.visible,i=t.mode,s=t.numVertices;if(s>0&&t.validMeasurement&&i==="euclidean"){const r=[];for(let a=0;a<s;++a){const o=m();T(o,t.positionsRender[a],this._origin);const l=m();T(l,t.positionsFittedRender[a],this._origin),r.push([o,l])}this._projectionLines.geometry=r,this._projectionLines.visible=e}else this._projectionLines.geometry=null,this._projectionLines.visible=!1}_updateLabels(){if(this.destroyed)return;const{viewData:t}=this,{area:e,path:i}=t;if(!i)return;const s=this.visible,r=this._areaLabel,a=this._perimeterLengthLabel,o=t.validMeasurement;r.visible=!0,a.visible=!0;let l=!1;const p=Ei(this.messages,e,this.analysisViewData.unit);if(p!=null&&s&&(r.geometry={type:"point",point:t.areaCentroid},r.text=p,l=t.validMeasurement&&t.intersectingSegments.size===0),this._set("areaLabel",p),s&&o&&t.intersectingSegments.size===0){const d=t.mode==="geodesic",u=d?t.pathLength:t.perimeterLength,c=Ui(this.messages,u,this.analysisViewData.unit);this._set("perimeterLengthLabel",c),a.distance=this._parameters.labelDistance,a.anchor="top",a.text=c;let f=!0;for(let _=0;_<t.numVertices;++_){const g=(t.perimeterLengthLabelSegmentIndex+_)%t.numVertices,v=d?this._pathSegments[g]:this._perimeterSegments[g];if(f=!0,a.geometry={type:"segment",segment:v,sampleLocation:"center"},!a.overlaps(this._areaLabel))break;f=!1}a.visible=f}else a.visible=!1;r.visible=l}_updateMessageBundle(){this.loadingMessages=!0,ti("esri/core/t9n/Units").then(t=>{this.messages=t,this.view&&this._update()}).finally(()=>{this.loadingMessages=!1})}};function Ei(t,e,i){return t&&e&&We(t,e,Te(e.value,e.unit,i))}function Ui(t,e,i){return t&&e&&We(t,e,je(e,i))}n([h()],V.prototype,"_parameters",null),n([h()],V.prototype,"view",void 0),n([h()],V.prototype,"messages",void 0),n([h()],V.prototype,"analysis",void 0),n([h()],V.prototype,"viewData",void 0),n([h()],V.prototype,"analysisViewData",void 0),n([h({readOnly:!0})],V.prototype,"areaLabel",void 0),n([h({readOnly:!0})],V.prototype,"perimeterLengthLabel",void 0),n([h()],V.prototype,"loadingMessages",void 0),n([h()],V.prototype,"visible",null),n([h()],V.prototype,"_renderUnits",null),V=n([$("esri.views.3d.analysis.AreaMeasurement.support.AreaMeasurementVisualization")],V);const Wi={validMeasurement:!1,numVertices:0,hasStagedVertex:!1,path:null,mode:null,positionsRender:null,positionsFittedWorld:null,positionsFittedRender:null,intersectingSegments:null,triangleIndices:null,areaCentroid:null,perimeterLengthLabelSegmentIndex:null,checkerSize:null,area:null,pathLength:null,perimeterLength:null};class qi{constructor(e,i=null){this.screenPoint=e,this.result=i}}class Bi{constructor(e,i){this.scenePoint=e,this.mapPoint=i}}class ji{constructor(e){this.vertexManipulators=[],this._destroyed=!1,this._isManipulatorsOwner=!0,this._visible=!0,this._listenerHandles=null,this._tempHandlePosition=m();const{analysisViewData:i,manipulators:s,toolState:r,view:a,visible:o}=e;this._analysisViewData=i,this._toolState=r,s!=null?(this._manipulators=s,this._isManipulatorsOwner=!1):this._manipulators=new Be,this._view=a,this._intersector=wi(a.state.viewingMode);const l=we(this._handleColor),p=[new Se(Ce(l,1,32,32))],d=new Ve({view:a,renderObjects:p});d.available=!1,d.radius=Ie,d.interactive=!1,this._manipulators.add(d),this._cursorManipulator=d,this._cursorManipulatorMaterial=l,this._laserLine=new fi({view:a,attached:!0,style:{glowWidth:Ki,glowFalloff:Ji,innerWidth:Yi},isDecoration:!0}),this._updateVisibility(o??!0)}destroy(){this._listenerHandles=S(this._listenerHandles),this._isManipulatorsOwner?this._manipulators=S(this._manipulators):this._manipulators=null,this._laserLine=S(this._laserLine),this._destroyed=!0}get destroyed(){return this._destroyed}get visible(){return this._visible}set visible(e){e?this.show():this.hide()}get testData(){}show(){this._setVisibility(!0)}hide(){this._setVisibility(!1)}_setVisibility(e){this._destroyed||this._visible===e||this._updateVisibility(e)}_updateVisibility(e){this._visible=e,this._laserLine.visible=e,e?(this._initializeListeners(),this._updateAll()):(this._destroyListeners(),this.vertexManipulators.forEach(({manipulator:i})=>this._removeVertexManipulator(i)),this.vertexManipulators=[])}vertexHandleAt(e,i){return this._manipulators.intersect(e,i)?.metadata}pick(e){const i=this._view.spatialReference,s=yi(e.screenPoint);this._view.sceneIntersectionHelper.intersectToolIntersectorScreen(s,this._intersector);const r=this._intersector.results.min,a=m();if(!r.getIntersectionPoint(a))return null;const o=this._view.renderCoordsHelper.fromRenderCoords(a,new j({spatialReference:i}));return o==null?null:new Bi(a,o)}_updateAll(){this._visible&&(this._updateVertexManipulators(),this._updateLaserLine())}_createVertexManipulator(){const e=we(this._handleColor),i=[new Se(Ce(e,1,32,32))],s=new Ve({view:this._view,renderObjects:i});return s.radius=Ie,this._manipulators.add(s),{manipulator:s,material:e}}_removeVertexManipulator(e){this._manipulators.remove(e)}_updateVertexManipulators(){const{viewData:e}=this._analysisViewData,i=this._analysisViewData.path?this._analysisViewData.path.vertices:[],s=this.vertexManipulators;Ni(s,i.length,()=>this._createVertexManipulator(),({manipulator:r})=>this._removeVertexManipulator(r)),s.forEach(({manipulator:r},a)=>{r.metadata=i[a],r.renderLocation=e.positionsRender[a],r.cursor=a===0&&this._toolState.polygonState==="drawing"?"crosshair":null}),this._toolState.polygonState==="drawing"&&this._analysisViewData.stagedPoint!=null?(this._cursorManipulator.available=!0,this._cursorManipulator.location=this._analysisViewData.stagedPoint):this._cursorManipulator.available=!1}get _handleColor(){return J(this._view.effectiveTheme.accentColor,.5)}_getFocusPoint(){const{lastDraggedVertex:e}=this._analysisViewData;switch(this._toolState.polygonState){case"drawing":return this._analysisViewData.stagedPoint!=null?this._analysisViewData.stagedPoint:e!=null?this._analysisViewData.path.getVertexPositionAsPoint(e):this._analysisViewData.path.lastPoint;case"editing":return e!=null?this._analysisViewData.path.getVertexPositionAsPoint(e):null;default:return this._analysisViewData.stagedPoint}}_updateLaserLine(){const e=this._toolState.polygonState!=="measured"&&this._toolState.active,i=this._getFocusPoint();if(e&&i!=null){const s=this._tempHandlePosition;this._view.renderCoordsHelper.toRenderCoords(i,s),this._laserLine.heightManifoldTarget=s}else this._laserLine.heightManifoldTarget=null}_initializeListeners(){this._listenerHandles=new Ye,this._listenerHandles.add([D(()=>this._toolState.polygonState,()=>this._updateLaserLine()),D(()=>this._analysisViewData.viewData,()=>this._updateAll(),X),D(()=>({lastDraggedVertex:this._analysisViewData.lastDraggedVertex,cursorPoint:this._analysisViewData.stagedPoint}),()=>this._updateLaserLine()),D(()=>this._toolState.active,()=>this._updateAll()),D(()=>this._view.effectiveTheme.accentColor,e=>{const i=J(e,.5);for(const{material:p}of this.vertexManipulators)p.setParameters({color:i});this._cursorManipulatorMaterial.setParameters({color:i});const s=Ae.toUnitRGB(e),r=Ae.toUnitRGB(se(e)),a=.75*e.a,o=this._laserLine,l=o.style;o.style={...l,glowColor:s,innerColor:r,globalAlpha:a}},{initial:!0,equals:si})])}_destroyListeners(){this._listenerHandles=S(this._listenerHandles)}}function Ni(t,e,i,s){for(;t.length<e;)t.push(i());if(s)for(;t.length>e;)s(t.pop());else t.length=e}const Ki=8,Ji=8,Yi=1,Ie=5;let w=class extends Pi{constructor(t){super(t),this._updatingHandles=new ci,this._snappingManagerResult=null,this.polygonState="initial",this.removeIncompleteOnCancel=!1,this.manipulators=new Be,this._getSnappingContext=ui(e=>new Li({elevationInfo:{mode:"absolute-height",offset:0},pointer:e,editGeometryOperations:new ie(new Ee("point",Ue(!0,!1,this.view.spatialReference)),this.view.state.viewingMode),visualizer:new mi}))}initialize(){const{view:t,analysisViewData:e,manipulators:i,visible:s}=this;this.measurementView=new ji({view:t,analysisViewData:e,toolState:this,manipulators:i,visible:s}),this._snappingOperation=new xi({view:t}),this._updatingHandles.add(()=>this.stagedPoint,r=>{this.analysisViewData.stagedPoint=r!=null?U(r,new j):null},z),Zt(this,()=>{const r=this.view.inputManager.latestPointerInfo?.type??"mouse",a=this._getSnappingContext(r);this._updatingHandles.addPromise(ae(this._snappingOperation.snapAgainNearPreviousMapPoint(this._ensureSnappingManager(),a)))}),this._setupManipulators(),this.addHandles([it(()=>this.state==="measured",()=>this.finishToolCreation(),z),this.analysisViewData.path.on("change",()=>{const r=this.analysisViewData.path;this.polygonState!=="initial"||r.isEmptyPolygon||(r.isValidPolygon?this.polygonState="measured":this.polygonState="drawing")})])}destroy(){this.measurementView.destroy(),this._set("measurementView",null),this._updatingHandles=S(this._updatingHandles)}get _snappingManager(){return this._snappingManagerResult?.snappingManager}_ensureSnappingManager(){if(this._snappingManagerResult==null){const t=Di(this.view);this._snappingManagerResult=t,this.addHandles(t)}return this._snappingManagerResult.snappingManager}get state(){return this.analysisViewData.path.numVertices===0?"ready":this.analysisViewData.path.isValidPolygon&&this.polygonState!=="editing"?"measured":"measuring"}get cursor(){return this.active?"crosshair":null}get updating(){return this._updatingHandles.updating||!!this._snappingManager?.updating}get stagedPoint(){return this._snappingOperation.stagedPoint}set stagedPoint(t){this._snappingOperation.stagedPoint=t}get snappingOptions(){return this._snappingManager?.options}finishMeasurement(){const{path:t}=this.analysisViewData;t.numVertices<=2||(t.close(),this.polygonState="measured",this._resetSnappingState(),this.active&&(this.view.activeTool=null))}resetCreated(){super.resetCreated(),this._resetSnappingState(),this.polygonState="initial",this.state==="measured"&&(this.polygonState="measured",this.finishToolCreation())}onShow(){this.measurementView.show()}onHide(){this.measurementView.hide()}onDeactivate(){this._resetSnappingState()}onInputEvent(t){switch(t.type){case"immediate-double-click":this._handleImmediateDoubleClick(t);break;case"immediate-click":this._handleImmediateClick(t);break;case"pointer-move":this._handlePointerMove(t);break;case"drag":this._handleDrag(t);break;case"key-down":this._handleKeyDown(t)}}_setupManipulators(){const t=i=>i.events.on("grab-changed",()=>{if(this.analysisViewData.path.isValidPolygon){const s=this.manipulators.some(r=>r.manipulator.grabbing);this.polygonState=s?"editing":"measured"}}),e=i=>{this.addHandles([vi(i,(s,r,a,o)=>{const l=gi(s),p=s.metadata,d=this._snappingManager,u=this._getSnappingContext(o),c=this._updatingHandles,{snappingStep:f,cancelSnapping:_}=bi({snappingManager:d,snappingContext:u,updatingHandles:c});a=a.next(l).next(v=>(this.analysisViewData.lastDraggedVertex=null,this.analysisViewData.path.setVertexPosition(p,g),s.location=g,v)).next(_),r.next(l).next(_i(this.view)).next(...f).next(v=>{s.location=v.mapEnd,this.analysisViewData.lastDraggedVertex=v.action==="end"?null:p,this.analysisViewData.path.setVertexPosition(p,U(v.mapEnd))});const g=U(this.analysisViewData.path.getVertexPositionAsPoint(p))}),t(i)],i)};this.manipulators.forEach(({manipulator:i})=>{e(i)}),this.addHandles([this.manipulators.on("after-add",({item:{manipulator:i}})=>{e(i)}),this.manipulators.on("after-remove",({item:{manipulator:i}})=>this.removeHandles(i))])}_handleImmediateDoubleClick(t){_e(t)&&(this.polygonState==="drawing"&&this.finishMeasurement(),t.stopPropagation())}_handleDrag(t){this.polygonState==="editing"&&t.stopPropagation()}_handleImmediateClick(t){if(!_e(t))return;const e=oe(t),{pointerType:i}=t;if(this.active)switch(this.polygonState){case"initial":case"measured":if(this._addVertexAt(e,i))return this.stagedPoint=null,this.polygonState="drawing",void t.stopPropagation();break;case"drawing":{const s=this.measurementView.vertexHandleAt(e,i);if(s==null){if(this._addVertexAt(e,i))return this.stagedPoint=null,void t.stopPropagation()}else s.index===0&&(this.finishMeasurement(),t.stopPropagation());break}}t.pointerType==="mouse"&&this._hoverAt(e)}_handlePointerMove(t){if(t.pointerType==="mouse"){const e=oe(t);this._hoverAt(e)}}_handleKeyDown(t){const{path:e}=this.analysisViewData;t.key===nt.complete&&this.polygonState==="drawing"&&e.numVertices>=3&&(this.stagedPoint=null,this.finishMeasurement(),t.stopPropagation())}_hoverAt(t){const{polygonState:e}=this;if(this.active&&Zi.has(e)){const i=this._pick(t);if(i?.mapPoint!=null){const s=this._getSnappingContext("mouse");this._updatingHandles.addPromise(ae(this._snappingOperation.snap({point:i.mapPoint},this._ensureSnappingManager(),s)))}}else this.stagedPoint=null}_addVertexAt(t,e){const i=this._pick(t),s=i?.mapPoint;if(s==null)return!1;this.analysis.valid&&this.polygonState==="measured"&&(this.analysis.clear(),this._set("created",!1),this.polygonState="initial");const r=this._getSnappingContext(e),a=this._snappingOperation.update({point:s},this._ensureSnappingManager(),r),o=U(a,new j);return this.analysisViewData.path.add(o),!0}_pick(t){const e=new qi(t);return this.measurementView.pick(e)}_resetSnappingState(){this._ensureSnappingManager().doneSnapping(),this._snappingOperation.abort(),this._snappingOperation.stagedPoint=null}get test(){}};n([h()],w.prototype,"_snappingManagerResult",void 0),n([h()],w.prototype,"_snappingManager",null),n([h({readOnly:!0})],w.prototype,"state",null),n([h()],w.prototype,"polygonState",void 0),n([h({readOnly:!0})],w.prototype,"cursor",null),n([h()],w.prototype,"measurementView",void 0),n([h()],w.prototype,"removeIncompleteOnCancel",void 0),n([h({constructOnly:!0})],w.prototype,"view",void 0),n([h({constructOnly:!0})],w.prototype,"analysis",void 0),n([h({constructOnly:!0})],w.prototype,"analysisViewData",void 0),n([h({readOnly:!0})],w.prototype,"manipulators",void 0),n([h()],w.prototype,"updating",null),n([h()],w.prototype,"stagedPoint",null),n([h()],w.prototype,"snappingOptions",null),w=n([$("esri.views.3d.interactive.measurementTools.areaMeasurement3D.AreaMeasurement3DTool")],w);const Zi=new Set(["initial","drawing","measured"]);let y=class extends Qe{constructor(t){super(t),this.type="area-measurement-view-3d",this.analysis=null,this.measurementData=null,this.lastDraggedVertex=null,this.stagedPoint=null,this.mode=0,this.tool=null,this.userOperation=null}initialize(){const{analysis:t,view:e}=this;this.path=new b({view:e,areaMeasurement:t}),this._analysisVisualization=new V({view:e,analysis:t,analysisViewData:this}),this.addResolvingPromise(Promise.all([jt(),Nt()]).then(([i,s])=>{this.destroyed||(this._analysisController=new C({view:e,analysis:t,analysisViewData:this,geodesicAreaMeasurementUtils:i,geodesicLengthMeasurementUtils:s}))})),this.addHandles(Si(this,w))}destroy(){Vi(this),this.userOperation=Ke(this.userOperation),this._analysisController=S(this._analysisController),this._analysisVisualization=S(this._analysisVisualization),this.path.destroy()}get visible(){return super.visible}set visible(t){super.visible=t}get interactive(){return super.interactive}set interactive(t){super.interactive=t}get updating(){return!!this._analysisVisualization?.loadingMessages}get result(){const{measurementData:t}=this;if(t==null)return{area:null,mode:null,perimeter:null};const{unit:e}=this;if(t.actualMeasurementMode==="euclidean"){const{area:r,perimeterLength:a}=t;return{area:r!=null?re(r,e):null,perimeter:a!=null?Ge(a,e):null,mode:"euclidean"}}const{geodesicArea:i,pathLength:s}=t;return{area:i!=null?re(i,e):null,perimeter:s!=null?Ge(s,e):null,mode:"geodesic"}}get viewData(){return this._analysisVisualization.viewData}get areaLabel(){return this._analysisVisualization.areaLabel}get perimeterLengthLabel(){return this._analysisVisualization.perimeterLengthLabel}get validMeasurement(){return this.path.isValidPolygon}get unit(){return this.analysis.unit??Ze(this.view)}get testData(){}place(t){return Mi(this,{placementOptions:t})}};n([h()],y.prototype,"_analysisVisualization",void 0),n([h()],y.prototype,"_analysisController",void 0),n([h({readOnly:!0})],y.prototype,"type",void 0),n([h({constructOnly:!0,nonNullable:!0})],y.prototype,"analysis",void 0),n([h()],y.prototype,"updating",null),n([h()],y.prototype,"result",null),n([h()],y.prototype,"measurementData",void 0),n([h()],y.prototype,"viewData",null),n([h()],y.prototype,"areaLabel",null),n([h()],y.prototype,"perimeterLengthLabel",null),n([h()],y.prototype,"validMeasurement",null),n([h()],y.prototype,"path",void 0),n([h()],y.prototype,"lastDraggedVertex",void 0),n([h()],y.prototype,"stagedPoint",void 0),n([h()],y.prototype,"mode",void 0),n([h()],y.prototype,"unit",null),n([h()],y.prototype,"tool",void 0),n([h()],y.prototype,"userOperation",void 0),y=n([$("esri.views.3d.analysis.AreaMeasurementAnalysisView3D")],y);const Ln=y,Qi=Object.freeze(Object.defineProperty({__proto__:null,build:Ne},Symbol.toStringTag,{value:"Module"}));export{Ln as default};
