import{x as it,c as R,b as Z,v as K,$ as j,i as Tt,a as Dt,q as U,bc as Mt,ar as xt,Y as o,H as s,G as E}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{R as kt,t as v,a as H,X as st}from"./collectionUtils-jDyktm0P-BDP2Oq99.js";import{s as zt}from"./AnalysisView3D-zhHEgrUR-DZ8OICjY.js";import{J as Gt,I as at}from"./featureReferenceUtils-CSsVlhur-Bq31yTLX.js";import{H as Ft}from"./asyncUtils-w6KfWU41-HenJ0UOu.js";import{J as $t,o as P,t as Ut,s as jt,l as Bt,j as Nt}from"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import{I as C,$,l as nt,k,O as z,f as M,h as lt,t as qt}from"./vec32-CewSdTn3-VRto2OOh.js";import{r as rt}from"./UpdatingHandles-D2RI_3Hb-dwLPjVun.js";import{b as It}from"./Point-BfTTZoMu-DeJwQYfh.js";import{X as B}from"./projectionUtils-BGH_5_I3-DGwchVO8.js";import{az as Wt,E as Jt,a9 as ut}from"./ShadowCastClear.glsl-CeOT_rAo-BEYyVrmo.js";import{W as Xt}from"./aaBoundingBox-Cn49X7ge-BcYPaJ58.js";import{a as Zt,X as dt,U as Kt}from"./aaBoundingRect-CjwcS2F3-ri8bmh30.js";import{q as Pt,x as Lt,f as N,u as Yt}from"./sphere-DLQ6p7mp-DyEe1Vll.js";import{$ as pt,q as Qt,C as te}from"./elevationInfoUtils-B8MpdRMP-CDlK86wO.js";import{w as ee}from"./screenUtils-BitdhK1O-L0FLPAMi.js";import{v as ie}from"./vector-B8ZDYGQ6-DRILJdcx.js";import{K as ot,I as ne,D as oe}from"./intersectorUtilsConversions-pLQPEbcN-Ck-nyNYa.js";import{z as re}from"./Texture-CFNZjV2R-CxGjQ8pI.js";import{I as ct,N as Y,B as Vt,q as Rt,e as Ht}from"./ShadedColorMaterial.glsl-Cdsx30m0-BzzDoTK3.js";import{p as ht,r as q}from"./Scheduler-CNrsbccs-Bcg8fWoS.js";import{F as m}from"./Color-CERqXxxY-BuYn26eI.js";import{j as mt,r as gt}from"./LineOfSightAnalysisTarget-BF1yUkY_-CtzXt_k6.js";import{P as se,x as ae}from"./frustum-CMzahy3--B-DC1Co-.js";import{s as vt}from"./ElevationInfo-Cw2HaA6E-CuK5hJ96.js";import{n as le,a as ue}from"./colorUtils-CeIi7j7j-C2WVx6th.js";import{m as Q,c as St}from"./IViewEvents-BGasus0A-C_gwEZed.js";import{l as At}from"./RealisticTree.glsl-WN9nrQUl-QZiY3aPA.js";import{H as de}from"./LaserlinePath.glsl-DfE4imRj-NE31_VCm.js";import{z as pe,f as ce,B as he,u as me}from"./analysisViewUtils-Z_Z4rbWk-DeDBcjbG.js";import{J as _t}from"./InteractiveToolBase-DXh7kfgV-B5EAl8tr.js";import{n as ge}from"./mat4f64-q_b6UJoq-Dh6sWB_w.js";import{j as yt}from"./PointVisualElement-pF4jjqm_-CfTxywah.js";import"./index-B0z_nLWi.js";import"./Extent-CgDMOSRD-Bod5LY6s.js";import"./Polygon-D6wEPb3W-D2MPjRU4.js";import"./mathUtils-PIGhLnI9-B1tKUlUb.js";import"./Polyline-CoiTLswR-DTxpB2Yg.js";import"./typeUtils-DqrRcjBx-DZ6_Gsbu.js";import"./modeUtils-BA-mAwuS-DSb1K26b.js";import"./intl-DRFqUect-DPhFaHB2.js";import"./date-IqUzANpt-bLKO9IDT.js";import"./sanitizerUtils-BT_8V5US-CWQWUwZQ.js";import"./lengthUtils-Dt1_RvOO-j3MEdmHu.js";import"./workers-BEkgoq8Q-BM_Hz460.js";import"./PooledRBush-Dco5QkUp-DX3CMhf3.js";import"./GraphicsCollection-Bk6M0b7D-Dk6KdmO7.js";import"./Graphic-DgGzDmqW-d1CNicxz.js";import"./getPopupProvider-CmskPttI-CzUWpGwk.js";import"./Layer-DZvC7bne-D3VLDrab.js";import"./typeUtils-CXW_VpOn-BGgLp_TK.js";import"./lineMarkers-CDwLe3J6-CNUjJvs3.js";import"./PolygonSymbol3D-BXRHZiCQ-BjPAY2LA.js";import"./ExtrudeSymbol3DLayer-DSc1ou2x-CsVYZCeG.js";import"./Font-BwmnW7d2-Dwh3xjKw.js";import"./SimpleFillSymbol-CDawtd9z-CWD2KI2D.js";import"./SimpleMarkerSymbol-BGAFRS9_-CVQ5NLIA.js";import"./PictureMarkerSymbol-CaSh-vZk-xhjZ61bb.js";import"./TextSymbol-hRGhyDHs-CoS7dSjf.js";import"./HeightModelInfo-D5IdRvJ2-23y6MRiu.js";import"./spatialReferenceEllipsoidUtils-D2JabnKt-Ce3ED0lc.js";import"./TilemapCache-CjhKW_vj-8gKqgQfa.js";import"./LRUCache-fy84PBMi-Y56WPIvD.js";import"./Map-AEYszeHg-ZEOzAMWa.js";import"./Basemap-CL_uaRmk-O3l-dbYk.js";import"./PortalItem-DnxMlRVo-CI4Ns2_M.js";import"./writeUtils-DEFpwIW1-AHZYPaSV.js";import"./CollectionFlattener-D6h2Fkvj-WVl2BXw-.js";import"./resourceExtension-DOTCeiZj-C2WIbjQM.js";import"./PolygonCollection-HNNpnBH7-5UHgGprq.js";import"./mat4f32-Djp3mnm5-DzYG3LYB.js";import"./mat4-C96X-Nn0-BrMLOLCb.js";import"./Query-BlS0WPDF-jdXS_Qhy.js";import"./Field-Cm_ZejYW-CwJZmSru.js";import"./fieldType-DVUzXtk_-tUuvnZJM.js";import"./normalizeUtils-85zLqeMi-C1bdAKNn.js";import"./normalizeUtilsCommon-CnhQye_A-UWhaH-kt.js";import"./ElevationQuery-DzlYa4L4-DkUTW9Ak.js";import"./TileInfo-Bz7QlefV-CdK7c8ef.js";import"./vec42-B8VM4vXb-B6OGOEI9.js";import"./vec2f64-rIxtbMRN-Kai9mK1i.js";import"./vec3f32-WCVSSNPR-9V6Uhrx-.js";import"./Indices-D0_UQPPr-t1Qev6md.js";import"./InterleavedLayout-B7roQAzV-CdGz7mlm.js";import"./BufferView-Cj2sQaht-avJ4OGB_.js";import"./vec4f64-DPb6J-GU-C7c2DqbZ.js";import"./constants-D67WmGms-H7IOwEdB.js";import"./quat-B7J5v7rV-CZ9akUv-.js";import"./quatf64-CCm9z-pX-CQ7_sSji.js";import"./projectVectorToVector-Csv3NYZI-DpBtmQMN.js";import"./floatRGBA-D-Q4FzNN-DQhowfyr.js";import"./UnknownTimeZone-B697BDFv-CBbtul7O.js";import"./TileKey-C44YQC4_-BW7BBbYp.js";import"./unitConversionUtils-4vB4Ezlp-DnY5MDxd.js";import"./orientedBoundingBox-BLEx7wLU-ByGP9QG1.js";import"./vec2f32-CaVKkSa6-BjkBmyoj.js";import"./Emissions.glsl-B8XKMjLy-DXfiRNVX.js";import"./Octree-DckBBpQ7-CkRPu4UJ.js";import"./axisAngleDegrees-CjbXmycq-DcVVDR1-.js";import"./edgePreprocessing-D_eX-fWy-DqE-06Ss.js";import"./vec3-B_phcnZY-DHC7I6xa.js";import"./vec33-CWJeyzxV-Me4sF5XB.js";import"./ColorMaterial.glsl-rhi0cQVb-DVm6kWLC.js";import"./MeshLocalVertexSpace-BGd1IdEs-C0HJG4wR.js";import"./EditGeometryOperations-DZvKpTU8-DnyvzBdp.js";import"./reader-DcGs6kKN-DHJfK-tm.js";import"./SimpleObservable-CvFyr0NA-DXpoMYph.js";import"./jsonUtils-CmpazY1u-6pDLj5sx.js";import"./projectPointToVector-DL7Z4uvb-CPbOlZdQ.js";import"./scaleUtils-yfx9kKWT-D9SVsyM-.js";import"./layerUtils-DZGhvm-W-CfyHx1TZ.js";import"./tagSymbols-BPcGfZon-BPcGfZon.js";import"./Queue-CYlrXMwB-CYJTUII-.js";import"./signal-BX9ezF8a-cf1Pn6io.js";import"./timeZoneUtils-BSc7-7qA-BAv3h8mh.js";import"./ReactiveMap-B0by2bYu-DCsCfMj5.js";import"./TablesMixin-Q80MT3nU-CBB9B-b6.js";import"./plane-BNdSPG2o-DTV5z6SO.js";import"./enums-B4pqBiXb-BO-3hS_8.js";import"./memoryEstimations-Bd726a_p-0cVCY2Jz.js";import"./VertexElementDescriptor-BlxU8vCE-BwuKQkTU.js";import"./Cyclical-BLSxUpe7-Bj8R2Yk-.js";import"./computeTranslationToOriginAndRotation-Bjd4esRf-vJ4LbdOU.js";import"./layerViewUtils-BTa15X3o-BjQlX2q8.js";import"./dehydratedFeatures-Ql-uVzLq-aoK2987s.js";import"./quantizationUtils-Ceq-Uxsu-DjgKK_0s.js";import"./featureConversionUtils-BDA_FXJx-CDxX1Wik.js";import"./OptimizedFeature-CwRGZPwv-Ddclhn0A.js";import"./OptimizedFeatureSet-BR8EEvDc-CgsRgxJh.js";import"./createFeatureId-CVwTD0fV-3fKpJDrk.js";import"./HUDIntersectorResult-1xTExS7z-dL9SFL6u.js";import"./DefaultLoadingContext-DXgBe4GE-Unnb_XgV.js";import"./wosrLoader-CIPfz1Cl-DlmQQkMX.js";import"./Version-BtYZEj58-LyRHDnSJ.js";import"./DoubleArray-DExKNiTh-CvVpHySW.js";import"./config-Dg972SSE-D9DBKeq5.js";import"./GeometryUtils-C354xUs0-BLAznQrw.js";import"./definitions-Dvg4hMIw-CdK2DzFN.js";import"./WorkerHandle-B930SiRy-DglEKt53.js";import"./capabilities-Bi6C4OG6-CpURufko.js";import"./imageUtils-142g71N8-Wj0XNClb.js";import"./videoUtils-Dwx3AEgj-CduhpDRk.js";import"./uuid-Oe6SV2kF-IYX19xBA.js";import"./quickselect-QQC62dOK-Br2Ahhru.js";import"./meshVertexSpaceUtils-CtG7DPVT-kybwngCt.js";import"./Intersector-DS9YtyQY-DMoYp6i0.js";import"./TileKey-CXWFOqOI-Lra6v-mg.js";import"./loadAll-BCyxerwc-B4Lp8wGC.js";import"./opacityUtils-DuFH0EC9-DWspTgn2.js";import"./persistable-CdoDQOTR-BklJqWTn.js";import"./MD5-MtSiOt06-jWr180Yc.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw-DH8sdIsE.js";import"./utils-CylVuxNi--x86XOjU.js";import"./utils-Dpg4yj1D-CeFz2JVC.js";import"./types-BKo2foNY-DE0QfIFp.js";import"./labelUtils-BtizwBfq-Zegx4520.js";import"./ArcadeExpression-BlIRq-oN-VZkrwLVE.js";import"./TimeOnly-BERR31kg-CQiLyUZi.js";import"./enum-BzLwmiID-CcyIdWlQ.js";import"./FieldsIndex-CimK-TqD--24JoCkp.js";import"./VisualElement-By4iq8p4-ZBataKFH.js";import"./line-DShd3yGd-HKPw0I1T.js";import"./TriangleMaterial-BIKWylXl-CXByzRQi.js";import"./geometry2dUtils-B4vDf2wH-DzgYge1I.js";import"./rotate-CKztRS_J-BAJoscjo.js";import"./curveOperationUtils-BGqPT1bh-DTx58Z-T.js";let S=class extends U{constructor(t){super(t),this.target=null,this.intersectedGraphic=null,this.intersectedLocation=null,this.elevationAlignedTargetLocation=null,this.visible=void 0}};o([s()],S.prototype,"target",void 0),o([s()],S.prototype,"intersectedGraphic",void 0),o([s()],S.prototype,"intersectedLocation",void 0),o([s()],S.prototype,"elevationAlignedTargetLocation",void 0),o([s({type:Boolean})],S.prototype,"visible",void 0),S=o([E("esri.views.3d.analysis.LineOfSightAnalysisResult")],S);let A=class extends U{constructor(t){super(t),this.elevationAlignedTargetLocation=null,this.inputPoints={isValid:!1,observer:v(),observerSurfaceNormal:null,observerFeatureId:null,target:v(),targetSurfaceNormal:null,targetFeatureId:null,observerAdjusted:v(),targetAdjusted:v()},this.computationResult={start:v(),end:v(),intersection:v(),isValid:!1,isTargetVisible:!1},this.result=null}notifyResultChanged(){this.notifyChange("computationResult")}notifyInputPointsChanged(){this.notifyChange("inputPoints")}};o([s()],A.prototype,"target",void 0),o([s()],A.prototype,"elevationAlignedTargetLocation",void 0),o([s()],A.prototype,"inputPoints",void 0),o([s()],A.prototype,"computationResult",void 0),o([s()],A.prototype,"result",void 0),A=o([E("esri.views.3d.analysis.LineOfSight.LineOfSightComputation")],A);let O=class extends U{constructor(t){super(t)}clone(){return this}equals(t){return this.context?.type===t.context?.type&&(!this.context||!t.context||this.context.equals(t.context))&&this.id===t.id&&Mt(this.mapPoint,t.mapPoint)&&qt(this.renderPoint,t.renderPoint)&&xt(this.normal,t.normal)&&Yt(this.ray,t.ray)}};o([s({constructOnly:!0})],O.prototype,"context",void 0),o([s({constructOnly:!0})],O.prototype,"id",void 0),o([s({constructOnly:!0})],O.prototype,"mapPoint",void 0),o([s({constructOnly:!0})],O.prototype,"renderPoint",void 0),o([s({constructOnly:!0})],O.prototype,"normal",void 0),o([s({constructOnly:!0})],O.prototype,"ray",void 0),O=o([E("esri.views.3d.analysis.LineOfSight.LineOfSightIntersectionResult")],O);class ve{constructor(e){this.graphic=e,this.type="graphic"}equals(e){return e.type===this.type&&this.graphic===e.graphic}}let _e=class{constructor(){this.type="ground"}equals(t){return t.type===this.type}};const ft=new _e;let x=class extends U{constructor(t){super(t),this._terrainIntersectionOptionsLayerUids=new Set(["terrain"])}initialize(){this.intersector=new re(this.view.state.viewingMode),this.intersector.options.hud=!1,this.intersector.options.store=0}getScreenPointIntersection(t){const e=ee(t,ie.get()),i=Jt(this.view.state.camera,e,tt);return this._getRayIntersection(i)}_getRayIntersection(t,e){const{view:i,intersector:n}=this;if(t==null||i.sceneIntersectionHelper==null)return null;n.options.store=0,i.sceneIntersectionHelper.intersectToolIntersectorRay(t,n,e);const r=n.results.min;if(r.target==null)return null;const l=v();if(!r.getIntersectionPoint(l)||e?.maxDistance!=null&&!r.withinDistance(e.maxDistance))return null;const a=i.renderCoordsHelper.fromRenderCoords(l,new It({spatialReference:i.spatialReference})),p=st(r.normal);if(ne(r))return new O({context:ft,id:r.target.lij.slice(),mapPoint:a,renderPoint:l,normal:p,ray:N(t)});if(oe(i,r))return new O({context:ft,id:`${r.target.layerViewUid}`,mapPoint:a,renderPoint:l,normal:p,ray:N(t)});const d=ot(r,i);if(d!=null){const{layer:u}=d,h=d.getObjectId()??d.uid;return new O({context:new ve(d),id:`${u?.uid}/${h}`,mapPoint:a,renderPoint:l,normal:p,ray:N(t)})}const c="layerViewUid"in r.target?`${r.target.layerViewUid}`:"";return new O({context:null,id:c,mapPoint:a,renderPoint:l,normal:p,ray:N(t)})}updateFromGroundIntersection(t,e,i){const n=ye,r=fe,l=be,a=bt;C(r,t),this.view.renderCoordsHelper.worldUpAtPosition(r,l),nt(l,l);const p=this.view.basemapTerrain.visibleElevationBounds,d=(e>=0?1:-1)*((p?Math.abs(p.max-p.min):100)+Math.abs(e));k(a,l,d),z(n,r,a),Pt(n,r,tt);const c=this._getRayIntersection(tt,{include:this._terrainIntersectionOptionsLayerUids,maxDistance:d});if(c!=null){const u=bt;return k(u,l,e),z(i,c.renderPoint,u),st(c.normal)}return C(i,t),null}};o([s()],x.prototype,"view",void 0),o([s()],x.prototype,"intersector",void 0),x=o([E("esri.views.3d.analysis.LineOfSight.LineOfSightRayIntersector")],x);const ye=v(),fe=v(),be=v(),bt=v(),tt=Lt();let _=class extends $t{constructor(t){super(t),this.updateOnCameraChange=!0,this._observerGroundOffsetRenderSpace=0,this._effectiveObserverElevationMode="absolute-height",this._observerFeatureId=null,this._updatingHandles=new rt,this._frameTask=ht,this._computationHandles=new Z,this._externalObserverUpdate=!0}initialize(){const t=this.view.resourceController?.scheduler;this._frameTask=t?t.registerTask(q.LINE_OF_SIGHT_TOOL):ht,this._intersector=new x({view:this.view}),this.addHandles([this._connectObserver(),this._connectComputations(),this._connectTargets()])}destroy(){this._computationHandles.destroy(),this._computations.removeAll(),this._updatingHandles.destroy()}get updating(){return this._frameTask.updating||this._updatingHandles.updating}get priority(){return this._frameTask.priority}set priority(t){this._frameTask.priority=t}get _computations(){return this.analysisViewData.computations}get _elevationAlignedObserverPositionRenderSpace(){return this.analysisViewData.observerEngineLocation}set _elevationAlignedObserverPositionRenderSpace(t){this.analysisViewData.observerEngineLocation=t}get _screenPixelSize(){return this.view.state.camera.computeScreenPixelSizeAt(this._elevationAlignedObserverPositionRenderSpace)}_computeResult(t){const e=t.computation,{inputPoints:i,computationResult:n}=e,{observerAdjusted:r,targetAdjusted:l}=i,{start:a,end:p}=n;C(a,r),C(p,l),this._canCompute(e)?this._computeIntersection(t):Ce(t),e.notifyResultChanged(),this.emit("result-changed",{target:t.computation.target,result:e.result})}_adjustStartEndPositions(t){const{view:e}=this,{inputPoints:i}=t,{observer:n,target:r,observerAdjusted:l,targetAdjusted:a}=i;C(l,n),C(a,r),Gt(e,this._intersector.intersector,i);const{observerSurfaceNormal:p,targetSurfaceNormal:d}=i,c=this._screenPixelSize,u=X;p!=null?C(u,p):$(u,a,l);const h=c;nt(u,u),k(u,u,Math.min(h,1)),z(l,l,u),d!=null?C(u,d):$(u,l,a);const g=e.state.camera.computeScreenPixelSizeAt(a);nt(u,u),k(u,u,Math.min(g,1)),z(a,a,u)}_computeIntersection({computation:t,interpolationInfo:e}){const{view:i}=this,{sceneIntersectionHelper:n,renderCoordsHelper:r}=i;if(n==null)return;const l=this._intersector.intersector,{computationResult:a,inputPoints:p}=t,{observer:d,target:c}=p,{start:u,end:h}=a,g=Pt(u,h,Oe);l.options.store=0,n.intersectToolIntersectorRay(g,l);const L=l.results.min,T=a.intersection,G=X;let y=!0;if(L!=null&&L.getIntersectionPoint(T)){C(e.originalIntersection,T),C(e.originalObserver,u),C(e.originalTarget,h),r.fromRenderCoords(T,G,i.spatialReference);const w=1-M(h,c)/M(u,c);y=M(d,T)>=w*M(d,c)}const D=new It(G,i.spatialReference);{const{result:w,target:V}=t;w!=null?(w.target=V,w.intersectedGraphic=y?null:ot(L,i),w.intersectedLocation=y?null:D,w.visible=y):t.result=new S({target:V,elevationAlignedTargetLocation:t.elevationAlignedTargetLocation,intersectedGraphic:y?null:ot(L,i),intersectedLocation:y?null:D,visible:y})}a.isValid=p.isValid=!0,a.isTargetVisible=y}_canCompute(t){const e=this.analysisViewData.elevationAlignedObserver,i=this.view.frustum;if(e==null||t.elevationAlignedTargetLocation==null||i==null)return!1;const{observerAdjusted:n,targetAdjusted:r}=t.inputPoints,l=i.intersectsPoint(n),a=i.intersectsPoint(r);return l&&a}_onObserverPositionChange(t,e,i,n,r){if(this._externalObserverUpdate=r,t==null)return this.analysisViewData.elevationAlignedObserver=null,void(this._observerFeatureId=null);if(e==null)return ct(this.analysis,t.spatialReference,K.getLogger(this)),void(this.analysisViewData.elevationAlignedObserver=null);const l=Ct(e,i),{absoluteZ:a,elevation:p}=pt(e.x,e.y,e.z,this.view.spatialReference,this.view,l),d=e.clone();d.z=a,this._effectiveObserverElevationMode=l.mode,this.analysisViewData.elevationAlignedObserver=d;const c=v();this.view.renderCoordsHelper.toRenderCoords(d,c),this._elevationAlignedObserverPositionRenderSpace=c,this._observerGroundOffsetRenderSpace=a-p,this._observerFeatureId=at(n),this.priority=q.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onObserverRenderSpacePositionChangeForComputation(t,e,i,n,r){const{inputPoints:l}=t;switch(C(l.observer,e),l.observerFeatureId=r,l.observerSurfaceNormal=null,n){case"on-the-ground":case"relative-to-ground":{const a=this._intersector.updateFromGroundIntersection(l.observer,i,l.observer);l.observerFeatureId==null&&(l.observerSurfaceNormal=a)}}this._adjustStartEndPositions(t),t.notifyInputPointsChanged(),this.priority=q.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onTargetPositionChange(t,e,i,n,r,l=!0){const a=t.inputPoints;if(l&&(a.isValid=!1),i==null)return e!=null&&ct(this.analysis,e.spatialReference,K.getLogger(this)),t.elevationAlignedTargetLocation=null,void t.notifyInputPointsChanged();const p=Ct(i,n),{absoluteZ:d,elevation:c}=pt(i.x,i.y,i.z,this.view.spatialReference,this.view,p),u=i.clone();switch(u.z=d,t.elevationAlignedTargetLocation=u,this.view.renderCoordsHelper.toRenderCoords(t.elevationAlignedTargetLocation,a.target),a.targetFeatureId=at(r),a.targetSurfaceNormal=null,p.mode){case"on-the-ground":case"relative-to-ground":{const h=this._intersector.updateFromGroundIntersection(a.target,d-c,a.target);a.targetFeatureId==null&&(a.targetSurfaceNormal=h)}}this._adjustStartEndPositions(t),t.notifyInputPointsChanged(),this.priority=q.LINE_OF_SIGHT_TOOL_INTERACTIVE}_connectComputationToTarget(t){return j([this._updatingHandles.add(()=>({computation:t,targetPosition:t.target.position,targetElevationInfo:t.target.elevationInfo,targetFeatureInfo:t.target.feature,projectedTargetPosition:B(t.target.position,this.view.spatialReference)}),({computation:e,targetPosition:i,targetElevationInfo:n,targetFeatureInfo:r,projectedTargetPosition:l})=>{l.pending==null?this._onTargetPositionChange(e,i,l.geometry,n,r):this._updatingHandles.addPromise(l.pending)},P)])}_connectComputationToObserver(t){return this._updatingHandles.add(()=>({computation:t,observer:this.analysisViewData.elevationAlignedObserver}),({computation:e})=>{this._externalObserverUpdate&&(e.inputPoints.isValid=!1,e.notifyInputPointsChanged())},P)}_connectComputationToRenderSpaceObserver(t){return this._updatingHandles.add(()=>({computation:t,observer:this._elevationAlignedObserverPositionRenderSpace,observerGroundOffset:this._observerGroundOffsetRenderSpace,observerElevationMode:this._effectiveObserverElevationMode,observerFeatureId:this._observerFeatureId}),({computation:e,observer:i,observerGroundOffset:n,observerElevationMode:r,observerFeatureId:l})=>{this._onObserverRenderSpacePositionChangeForComputation(e,i,n,r,l)},P)}_connectComputationToCamera(t){return this._updatingHandles.add(()=>({camera:this.view.state.camera,isDirty:this._isCameraDirty}),({isDirty:e})=>{!this.updateOnCameraChange||t.inputPoints.isValid&&!e||t.notifyInputPointsChanged()})}_connectComputationToSlicePlane(t){return this._updatingHandles.add(()=>this.view.slice.plane,()=>{t.inputPoints.isValid=!1,t.notifyInputPointsChanged()})}_connectComputationToElevation(t){const e=(i,n)=>{const r=this.analysis.observer,l=t.target;let a=null,p=null,d=null,c=null,u=null,h=null;if(r?.position!=null){const g=B(r.position,this.view.spatialReference);if(g.pending!=null)return this._updatingHandles.addPromise(g.pending),void g.pending.finally(()=>e(i,n));a=g.geometry,p=r.elevationInfo,d=r.feature}if(l.position!=null){const g=B(l.position,this.view.spatialReference);if(g.pending!=null)return this._updatingHandles.addPromise(g.pending),void g.pending.finally(()=>e(i,n));c=g.geometry,u=l.elevationInfo,h=l.feature}a==null&&c==null||(Wt(i,n,W,this.view.spatialReference),a!=null&&dt(W,a)&&this._onObserverPositionChange(r!=null?r.position:null,a,p,d,!1),c!=null&&dt(W,c)&&this._onTargetPositionChange(t,l.position,c,u,h,!1),a!=null&&c!=null&&Kt(W,a,c)&&t.notifyInputPointsChanged())};return this.view.elevationProvider.on("elevation-change",({extent:i,spatialReference:n})=>e(i,n))}_connectComputationToTask(t){let e=null;const i={computation:t,interpolationInfo:{originalIntersection:v(),originalObserver:v(),originalTarget:v()}};return j([this._updatingHandles.add(()=>t.inputPoints,()=>{e=it(e),e=Ft(async n=>{await Dt(this._frameTask.schedule(()=>this._computeResult(i),n))})},{initial:!0,equals:()=>!1}),Tt(()=>e=it(e))])}_connectComputationToContent(t){return Ut(()=>this.view.pointsOfInterest?.contentGeometryUpdates.events,"request-update",e=>{const i=e?.renderBounds,{observerAdjusted:n,targetAdjusted:r}=t.inputPoints;(i==null||Xt(i,n,r))&&(t.inputPoints.isValid=!1,t.notifyInputPointsChanged())})}_connectComputation(t){const e=this._computationHandles;e.has(t)||e.add([this._connectComputationToTarget(t),this._connectComputationToObserver(t),this._connectComputationToRenderSpaceObserver(t),this._connectComputationToCamera(t),this._connectComputationToSlicePlane(t),this._connectComputationToElevation(t),this._connectComputationToTask(t),this._connectComputationToContent(t)],t)}_disconnectComputation(t){this._computationHandles.remove(t)}_onComputationCollectionChange({added:t,removed:e}){for(const i of e)this._disconnectComputation(i);for(const i of t)this._connectComputation(i)}_onTargetCollectionChange({added:t,removed:e}){for(const i of e)this._removeTarget(i);for(const i of t)this._addTarget(i)}_onCursorTargetChange(t,e){e!=null&&this._removeTarget(e),t!=null&&this._addTarget(t)}_addTarget(t){this._computations.some(e=>e.target===t)||this._computations.add(new A({target:t}))}_removeTarget(t){const e=this._computations.findIndex(i=>i.target===t);this._computations.removeAt(e)}_connectObserver(){return j([this._updatingHandles.add(()=>({observerPosition:this.analysis.observer!=null?this.analysis.observer.position:null,projectedObserverPosition:B(this.analysis.observer!=null?this.analysis.observer.position:null,this.view.spatialReference),observerElevationInfo:this.analysis.observer!=null?this.analysis.observer.elevationInfo:null,observerFeatureInfo:this.analysis.observer!=null?this.analysis.observer.feature:null}),({observerPosition:t,projectedObserverPosition:e,observerElevationInfo:i,observerFeatureInfo:n})=>{e.pending==null?this._onObserverPositionChange(t,e.geometry,i,n,!0):this._updatingHandles.addPromise(e.pending)},P)])}_connectComputations(){return this._updatingHandles.addOnCollectionChange(()=>this._computations,t=>this._onComputationCollectionChange(t),{initial:!0,final:!0})}_connectTargets(){return j([this._updatingHandles.addOnCollectionChange(()=>this.analysis.targets,t=>this._onTargetCollectionChange(t),{initial:!0,final:!0}),this._updatingHandles.add(()=>this.analysisViewData.cursorTarget,(t,e)=>{this._onCursorTargetChange(t,e)})])}get _isCameraDirty(){const t=this.analysisViewData.elevationAlignedObserver,{view:e}=this,{renderCoordsHelper:i}=e;if(t==null||i==null)return!1;const n=X;i.toRenderCoords(t,n);const r=e.state.camera.computeScreenPixelSizeAt(n);return Math.abs((r-this._screenPixelSize)/this._screenPixelSize)>we}};function Ct(t,e){return t.hasZ?e??{mode:"absolute-height",offset:0}:{mode:"on-the-ground",offset:0}}function Ce({computation:t,interpolationInfo:e}){const{computationResult:i,inputPoints:n}=t,{start:r,end:l,intersection:a}=i,{originalIntersection:p,originalObserver:d,originalTarget:c}=e;if(C(a,p),n.isValid){const u=X,h=M(d,p)/M(d,c);lt(u,r,d),k(u,u,1-h),z(a,a,u),lt(u,l,c),k(u,u,h),z(a,a,u),i.isValid=!0}else t.result=null,i.isValid=!1,i.isTargetVisible=!1}o([s({constructOnly:!0})],_.prototype,"analysis",void 0),o([s({constructOnly:!0})],_.prototype,"analysisViewData",void 0),o([s({constructOnly:!0})],_.prototype,"view",void 0),o([s()],_.prototype,"updating",null),o([s()],_.prototype,"priority",null),o([s()],_.prototype,"updateOnCameraChange",void 0),o([s()],_.prototype,"_computations",null),o([s()],_.prototype,"_elevationAlignedObserverPositionRenderSpace",null),o([s()],_.prototype,"_observerGroundOffsetRenderSpace",void 0),o([s()],_.prototype,"_effectiveObserverElevationMode",void 0),o([s()],_.prototype,"_observerFeatureId",void 0),o([s()],_.prototype,"_screenPixelSize",null),o([s({readOnly:!0})],_.prototype,"_updatingHandles",void 0),o([s()],_.prototype,"_frameTask",void 0),o([s()],_.prototype,"_isCameraDirty",null),_=o([E("esri.views.3d.analysis.LineOfSight.LineOfSightController")],_);const we=.1,X=v(),Oe=Lt(),W=Zt();let Te=class{constructor(){this.glowWidth=8,this.innerWidth=.75}};const Ie=new Te;function Pe(t){const e=t.accentColor;return{glowColor:e,innerColor:le(e),globalAlpha:.75*e.a}}class Le{constructor(){this.size=.5}}const Ve=new Le;function wt(t){return ue(t.accentColor,.75)}class Re{constructor(){this.size=.5,this.visibleColor=new m([3,252,111,.75]),this.occludedColor=new m([252,3,69,.75]),this.undefinedColor=new m([127,127,127,.75])}}const He=new Re;let Se=class{constructor(){this.innerWidth=2,this.outerWidth=8,this.visibleInnerColor=new m([3,252,111,1]),this.visibleOuterColor=new m([3,252,111,.15]),this.occludedInnerColor=new m([252,3,69,1]),this.occludedOuterColor=new m([252,3,69,.1]),this.undefinedInnerColor=new m([255,255,255,1]),this.undefinedOuterColor=new m([127,127,127,.2])}};const J=new Se;class Ae extends Vt{constructor(e,i){const n=Rt(wt(e.effectiveTheme)),r=At(n,Ve.size,32,32),l=new Ht(r);super({view:e,renderObjects:[l],metadata:i,elevationInfo:{mode:"absolute-height",offset:0}}),St(this),this.themeHandle=Nt(()=>({color:wt(e.effectiveTheme)}),a=>{n.setParameters(a)})}destroy(){this.themeHandle.remove(),super.destroy()}}class Ee extends Vt{constructor(e,i){const{size:n,visibleColor:r,occludedColor:l,undefinedColor:a}=He;super({view:e,renderObjects:[et(n,r,16),et(n,l,32),et(n,a,64)],metadata:i,elevationInfo:{mode:"absolute-height",offset:0}}),St(this)}}function et(t,e,i){return new Ht(At(Rt(m.toUnitRGBA(e)),t,32,32),i)}let b=class extends me{constructor(t){super(t),this._creationMode=!1,this.removeIncompleteOnCancel=!1,this.analysisViewData=null,this._latestPointerMovePointerType=null,this._laserlineVisualElement=null,this._grabbedManipulator=null,this._analysisHandles=new Z,this._updatingHandles=new rt,this._manipulatorHandles=new Z,this._targetTrackerManipulator=null}initialize(){this._intersector=new x({view:this.view}),this.addHandles(jt(()=>this.state==="created",()=>this.finishToolCreation(),Bt)),this._observerManipulator=this._createObserverManipulator(),this._createLaserLine(),this.addHandles([this._updatingHandles.add(()=>this.analysisViewData?.elevationAlignedObserver,t=>this._onObserverLocationChange(t),P),this._updatingHandles.add(()=>Pe(this.view.effectiveTheme),({glowColor:t,innerColor:e,globalAlpha:i})=>this._updateLaserLineStyle(t,e,i),P),this._updatingHandles.add(()=>this._laserLineRendererDependencies(),t=>this._updateLaserLineRenderer(t)),this._connectComputations(),this._updatingHandles.addWhen(()=>!this._shouldRenderTracker,()=>this._clearCursorTracker(),P),this._updatingHandles.add(()=>({active:this.active,hasGrabbedManipulators:this.hasGrabbedManipulators}),({active:t,hasGrabbedManipulators:e})=>{this._creationMode=!!t&&(this._creationMode||!e)},P)])}destroy(){this._updatingHandles=R(this._updatingHandles),this._manipulatorHandles=R(this._manipulatorHandles),this._analysisHandles=R(this._analysisHandles),this._observerManipulator=null,this._clearCursorTracker(),this._removeLaserLine(),this._intersector=null,this._set("analysis",null)}get state(){return this.active?!this.hasGrabbedManipulators||this._creationMode?"creating":"created":this.analysis.observer?.position!=null?"created":"ready"}get cursor(){return this.active&&this._showTracker?"crosshair":null}get updating(){return this.analysisViewData!=null&&this.analysisViewData.updating||this._updatingHandles.updating}get _showTracker(){return this.active&&this._latestPointerMovePointerType==="mouse"}get _shouldRenderTracker(){return this._showTracker&&this.analysis.observer?.position!=null&&!this.hasGrabbedManipulators}continue(){this.view.activeTool=this}stop(){this.view.activeTool=null}onEditableChange(){this.analysisViewData.editable=this.internallyEditable}onInputEvent(t){switch(t.type){case"immediate-double-click":this._doubleClickHandler(t);break;case"pointer-move":this._pointerMoveHandler(t)}}onInputEventAfter(t){t.type==="immediate-click"&&this._clickHandler(t)}onShow(){}onHide(){}onDeactivate(){this._clearCursorTracker()}_connectComputations(){return this._updatingHandles.addOnCollectionChange(()=>this.analysisViewData.computations,t=>this._onComputationsCollectionChange(t),{initial:!0,final:!0})}_onComputationsCollectionChange({added:t,removed:e}){for(const i of e)this._disconnectComputation(i);for(const i of t)this._connectComputation(i)}_connectComputation(t){if(this.destroyed)return void K.getLogger(this).warn("Attempting to connect an analysis to a destroyed LineOfSight tool. Ignoring.");const e=this._analysisHandles;if(e.has(t))return;const i=this._createTargetManipulator(t.target);this._targetTrackerManipulator==null&&i.metadata.target===this.analysisViewData.cursorTarget&&(this._targetTrackerManipulator=i,this._targetTrackerManipulator.available=!1,this._targetTrackerManipulator.interactive=!1,this._updateLaserLineRenderer()),e.add([this._updatingHandles.add(()=>xe(t),()=>Me(i,t),P),this._updatingHandles.add(()=>t.elevationAlignedTargetLocation,n=>this._onTargetLocationChange(n,i),P)],t)}_disconnectComputation(t){if(this.destroyed)return void K.getLogger(this).warn("Attempting to disconnect an analysis from a destroyed LineOfSight tool. Ignoring.");this._analysisHandles.remove(t);const e=this._getTargetManipulator(t.target);e!=null&&(this.manipulators.remove(e),this._manipulatorHandles.remove(e),this._targetTrackerManipulator!=null&&this._targetTrackerManipulator===e&&(this._targetTrackerManipulator=null))}_clearCursorTracker(){this.analysisViewData.cursorTarget=R(this.analysisViewData.cursorTarget)}_createTargetManipulator(t){const e={target:t,type:"target"},i=new Ee(this.view,e);return this._manipulatorHandles.add([this._createTargetManipulatorDragPipeline(i),i.events.on("grab-changed",n=>this._manipulatorGrabChanged(i,n)),i.events.on("immediate-click",n=>this._manipulatorClick(i,n))],i),this.manipulators.add(i),t.position!=null?i.elevationAlignedLocation=t.position:i.available=!1,i}_getTargetManipulator(t){let e=null;return this.manipulators.forEach(i=>{const n=i.manipulator;e==null&&n.metadata.type==="target"&&n.metadata.target===t&&(e=n)}),e}_createObserverManipulator(){const t=new Ae(this.view,{type:"observer",intersection:null});return this._manipulatorHandles.add([this._createObserverManipulatorDragPipeline(t),t.events.on("grab-changed",e=>this._manipulatorGrabChanged(t,e)),t.events.on("immediate-click",e=>this._manipulatorClick(t,e))],t),this.manipulators.add(t),t}_screenToIntersection(){return t=>{const e=this._intersector.getScreenPointIntersection(t.screenEnd);return e==null?null:{...t,intersection:e}}}_createTargetManipulatorDragPipeline(t){return _t(t,(e,i,n)=>{i.next(this._screenToIntersection()).next(this._updateTargetDragStep(t)).next(()=>this._updateLaserLineRenderer()),n.next(De(t.metadata.target)).next(()=>this._updateLaserLineRenderer())})}_createObserverManipulatorDragPipeline(t){return _t(t,(e,i,n)=>{i.next(this._screenToIntersection()).next(this._updateObserverDragStep()).next(()=>this._updateLaserLineRenderer()),n.next(this._cancelObserverDragStep()).next(()=>this._updateLaserLineRenderer())})}_updateObserverDragStep(){return t=>(t.intersection.mapPoint!=null?(this.analysis.observer==null&&(this.analysis.observer=new mt),this._updateFromIntersection(this.analysis.observer,t.intersection)):this.analysis.observer=null,t)}_cancelObserverDragStep(){const t=this.analysis.observer?.position!=null?this.analysis.observer.clone():null;return e=>(this.analysis.observer=t,e)}_updateTargetDragStep(t){return e=>{this._updateFromIntersection(t.metadata.target,e.intersection);const i=e.intersection.mapPoint;return i!=null&&(t.elevationAlignedLocation=i),e}}_manipulatorGrabChanged(t,e){switch(e.action){case"start":this._grabbedManipulator=t;break;case"end":this._grabbedManipulator===t&&(this._grabbedManipulator=null)}}_laserLineRendererDependencies(){return{laserlineVisualElement:this._laserlineVisualElement,grabbedManipulator:this._grabbedManipulator,shouldRenderTracker:this._shouldRenderTracker,observerPosition:this.analysis.observer!=null?this.analysis.observer.position:null,visible:this.visible}}_updateLaserLineRenderer(t=this._laserLineRendererDependencies()){const{laserlineVisualElement:e,grabbedManipulator:i,shouldRenderTracker:n,observerPosition:r,visible:l}=t;if(e==null)return;const a=i??(n&&r!=null?this._targetTrackerManipulator:null);a!=null&&l?(e.visible=!0,e.heightManifoldTarget=a.renderLocation,a!==this._observerManipulator?e.lineVerticalPlaneSegment=ae(this._observerManipulator.renderLocation,a.renderLocation,ke):e.lineVerticalPlaneSegment=null):(e.visible=!1,e.heightManifoldTarget=null,e.lineVerticalPlaneSegment=null)}_createLaserLine(){this._removeLaserLine();const{glowWidth:t,innerWidth:e}=Ie;this._laserlineVisualElement=new de({view:this.view,attached:!0,visible:this.visible,style:{glowWidth:t,innerWidth:e},isDecoration:!0})}_removeLaserLine(){this._laserlineVisualElement!=null&&(this._laserlineVisualElement.destroy(),this._laserlineVisualElement=null)}_updateLaserLineStyle(t,e,i){const n=this._laserlineVisualElement;if(n==null)return;const r=n.style;n.style={...r,glowColor:m.toUnitRGB(t),innerColor:m.toUnitRGB(e),globalAlpha:i}}_onObserverLocationChange(t){t!=null?(this._observerManipulator.metadata.intersection=null,this._observerManipulator.available=!0,this._observerManipulator.elevationAlignedLocation=t):this._observerManipulator.available=!1}_onTargetLocationChange(t,e){t!=null?(e.elevationAlignedLocation=t,e!==this._targetTrackerManipulator&&(e.available=!0)):e.available=!1}_addPointFromClickEvent(t){const e=this._intersector.getScreenPointIntersection(t);if(e?.mapPoint!=null)if(this.analysis.observer?.position!=null){this._clearCursorTracker();const i=new gt;this._updateFromIntersection(i,e),this.analysis.targets.add(i)}else{const i=new mt;this._updateFromIntersection(i,e),this.analysis.observer=i}}_clickHandler(t){this.active&&t.button!==Q.Right&&(this._addPointFromClickEvent(ut(t)),t.stopPropagation())}_doubleClickHandler(t){this.active&&t.button!==Q.Right&&(this.stop(),t.stopPropagation())}_pointerMoveHandler(t){if(this.hasGrabbedManipulators||(this._latestPointerMovePointerType=t.pointerType,this._updateLaserLineRenderer(),!this._showTracker||this.analysis.observer?.position==null))return;const e=ut(t),i=this._intersector.getScreenPointIntersection(e);i?.mapPoint!=null&&(this.analysisViewData.cursorTarget==null&&(this.analysisViewData.cursorTarget=new gt),this._updateFromIntersection(this.analysisViewData.cursorTarget,i),this._updateLaserLineRenderer())}_updateFromIntersection(t,e){if(e.mapPoint==null)return t.position=null,t.elevationInfo=null,void(t.feature=null);switch(e.context?.type){case"graphic":{const n=e.context.graphic,r=Qt(n);r.mode==="on-the-ground"&&(r.mode="relative-to-ground",r.offset=0),t.elevationInfo=new vt(r),t.feature=n}break;case"ground":t.elevationInfo=new vt({mode:"on-the-ground"}),t.feature=null;break;default:t.elevationInfo=null,t.feature=null}const i=e.mapPoint.clone();i.z=te(this.view,i,{mode:"absolute-height",offset:0},t.elevationInfo),t.position=i}_manipulatorClick(t,e){if(t.metadata.type==="observer"||t.grabbing||t.dragging||e.button!==Q.Right||this.analysis.targets.length<=1)return;const{target:i}=t.metadata;this.analysis.targets.remove(i),e.stopPropagation()}get testInfo(){}};function De(t){const e=t.position?.clone();return i=>(t.position=e,i)}function Me(t,e){const{isValid:i,isTargetVisible:n}=e.computationResult;t.state=i?n?16:32:64}function xe(t){const{isValid:e,isTargetVisible:i}=t.computationResult;return{isValid:e,isTargetVisible:i}}o([s({constructOnly:!0})],b.prototype,"view",void 0),o([s({constructOnly:!0})],b.prototype,"analysis",void 0),o([s()],b.prototype,"_creationMode",void 0),o([s({readOnly:!0})],b.prototype,"state",null),o([s({readOnly:!0})],b.prototype,"cursor",null),o([s()],b.prototype,"removeIncompleteOnCancel",void 0),o([s({readOnly:!0})],b.prototype,"updating",null),o([s({constructOnly:!0})],b.prototype,"analysisViewData",void 0),o([s({readOnly:!0})],b.prototype,"_showTracker",null),o([s()],b.prototype,"_latestPointerMovePointerType",void 0),o([s()],b.prototype,"_shouldRenderTracker",null),o([s()],b.prototype,"_laserlineVisualElement",void 0),o([s()],b.prototype,"_grabbedManipulator",void 0),b=o([E("esri.views.3d.analysis.LineOfSight.LineOfSightTool")],b);const ke=se();class ze{constructor(e,i,n,r){this.visibleLineVisualElement=e,this.occludedLineVisualElement=i,this.undefinedLineVisualElement=n,this.targetVisualElement=r}destroy(){this.visibleLineVisualElement.destroy(),this.occludedLineVisualElement.destroy(),this.undefinedLineVisualElement.destroy(),this.targetVisualElement.destroy()}}let I=class extends U{constructor(t){super(t),this._lineOfSightVisualElements=new Array,this._computationHandles=new Z,this._updatingHandles=new rt}initialize(){this.addHandles(this._connectComputations()),this._createObserverVisualization()}destroy(){this._updatingHandles=R(this._updatingHandles),this._computationHandles=R(this._computationHandles),this._observerVisualElement=R(this._observerVisualElement)}get visible(){return this.analysisViewData.visible}get updating(){return this._updatingHandles.updating}get interactiveAndEditable(){return this.analysisViewData.interactive&&this.analysisViewData.editable}get test(){}_createLineOfSightVisualization(){const t=J,e=this.view,i=this.isDecoration,n={view:e,attached:!0,width:t.outerWidth,innerWidth:t.innerWidth,isDecoration:i},r=m.toUnitRGBA(t.visibleOuterColor),l=m.toUnitRGBA(t.visibleInnerColor),a=m.toUnitRGBA(t.occludedOuterColor),p=m.toUnitRGBA(t.occludedInnerColor),d=m.toUnitRGBA(t.undefinedOuterColor),c=m.toUnitRGBA(t.undefinedInnerColor),u=new Y({...n,color:r,innerColor:l}),h=new Y({...n,color:a,innerColor:p}),g=new Y({...n,color:d,innerColor:c}),L=new yt({view:e,attached:!0,...Ot,size:8,isDecoration:i}),T=new ze(u,h,g,L);return this._lineOfSightVisualElements.push(T),T}_destroyLineOfSightVisualization(t){t.destroy(),this._lineOfSightVisualElements.splice(this._lineOfSightVisualElements.indexOf(t),1)}_updateLineOfSightVisualization(t,e,i){const n=J,{computationResult:r,inputPoints:l}=t,{start:a,end:p,intersection:d,isValid:c,isTargetVisible:u}=r,{observer:h}=l,g=Ue;g[12]=h[0],g[13]=h[1],g[14]=h[2];const L=$(Ge,a,h),T=$(Fe,p,h),G=$($e,d,h),{visibleLineVisualElement:y,occludedLineVisualElement:D,undefinedLineVisualElement:w,targetVisualElement:V}=e,Et=this.analysisViewData.elevationAlignedObserver==null||t.elevationAlignedTargetLocation==null,F=this.visible&&!Et;y.visible=F,D.visible=F,w.visible=F,V.visible=F,V.attached=!i.interactiveAndEditable,F&&(y.geometry=null,D.geometry=null,w.geometry=null,V.geometry=t.elevationAlignedTargetLocation,c?u?(y.geometry=[[H(L),H(T)]],y.transform=g,y.color=m.toUnitRGBA(n.visibleOuterColor),V.color=m.toUnitRGBA(n.visibleInnerColor)):(y.geometry=[[H(L),H(G)]],y.transform=g,y.color=m.toUnitRGBA(n.occludedOuterColor),D.geometry=[[H(G),H(T)]],D.transform=g,V.color=m.toUnitRGBA(n.occludedInnerColor)):(w.geometry=[[H(L),H(T)]],w.transform=g,V.color=m.toUnitRGBA(n.undefinedInnerColor)))}_getLineOfSightVisualizationDependencies(t){const{computationResult:e}=t,{occludedOuterColor:i,visibleOuterColor:n}=J;return{computationResult:e,occludedOuterColor:i,visibleOuterColor:n,visible:this.visible,interactiveAndEditable:this.interactiveAndEditable}}_connectComputation(t){const e=this._computationHandles;if(e.has(t))return;const i=this._createLineOfSightVisualization();e.add([this._updatingHandles.add(()=>this._getLineOfSightVisualizationDependencies(t),n=>this._updateLineOfSightVisualization(t,i,n),{initial:!0,equals:()=>!1}),Tt(()=>this._destroyLineOfSightVisualization(i))],t)}_disconnectComputation(t){this._computationHandles.remove(t)}_connectComputations(){return this._updatingHandles.addOnCollectionChange(()=>this.analysisViewData.computations,t=>this._onComputationsCollectionChange(t),{initial:!0,final:!0})}_onComputationsCollectionChange({added:t,removed:e}){for(const i of e)this._disconnectComputation(i);for(const i of t)this._connectComputation(i)}_createObserverVisualization(){const t=m.toUnitRGBA(J.visibleInnerColor),e=new yt({view:this.view,color:t,...Ot,isDecoration:this.isDecoration});this._observerVisualElement=e,this.addHandles(this._updatingHandles.add(()=>({observer:this.analysisViewData.elevationAlignedObserver,interactiveAndEditable:this.interactiveAndEditable,visible:this.visible}),({observer:i,interactiveAndEditable:n,visible:r})=>{i!=null&&!n&&r?(e.geometry=i,this._observerVisualElement.attached=!0):e.attached=!1},P))}};o([s({constructOnly:!0})],I.prototype,"analysis",void 0),o([s({constructOnly:!0})],I.prototype,"analysisViewData",void 0),o([s({constructOnly:!0})],I.prototype,"view",void 0),o([s({readOnly:!0})],I.prototype,"visible",null),o([s({constructOnly:!0})],I.prototype,"isDecoration",void 0),o([s()],I.prototype,"updating",null),o([s()],I.prototype,"interactiveAndEditable",null),o([s()],I.prototype,"test",null),I=o([E("esri.views.3d.analysis.LineOfSight.LineOfSightVisualization")],I);const Ot={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0},Ge=v(),Fe=v(),$e=v(),Ue=ge();let f=class extends zt{constructor(t){super(t),this.type="line-of-sight-view-3d",this.analysis=null,this.tool=null,this.computations=new kt,this.cursorTarget=null,this.editable=!0,this.elevationAlignedObserver=null,this.observerEngineLocation=v(),this.userOperation=null}initialize(){const t=this.view,e=this.analysis;this._analysisController=new _({analysis:e,analysisViewData:this,view:t}),this._analysisVisualization=new I({analysis:e,analysisViewData:this,view:t,isDecoration:!this.parent}),this.addHandles([this._analysisController.on("result-changed",i=>{i.target!==this.cursorTarget&&this.emit("result-changed",i)}),pe(this,b)])}destroy(){ce(this),this.userOperation=it(this.userOperation),this._analysisController=R(this._analysisController),this._analysisVisualization=R(this._analysisVisualization)}get visible(){return super.visible}set visible(t){super.visible=t}get interactive(){return super.interactive}set interactive(t){super.interactive=t}get results(){return this.computations.map(t=>t.result)}get priority(){return this._analysisController.priority}set priority(t){this._analysisController.priority=t}get updating(){return this._analysisController!=null&&this._analysisController.updating||this._analysisVisualization!=null&&this._analysisVisualization.updating}place(t){return he(this,{placementOptions:t})}getResultForTarget(t){return this.computations.find(e=>e.target===t)?.result}get testInfo(){}};o([s({readOnly:!0})],f.prototype,"type",void 0),o([s({constructOnly:!0,nonNullable:!0})],f.prototype,"analysis",void 0),o([s()],f.prototype,"tool",void 0),o([s({readOnly:!0})],f.prototype,"results",null),o([s()],f.prototype,"priority",null),o([s()],f.prototype,"computations",void 0),o([s()],f.prototype,"cursorTarget",void 0),o([s()],f.prototype,"editable",void 0),o([s()],f.prototype,"elevationAlignedObserver",void 0),o([s()],f.prototype,"observerEngineLocation",void 0),o([s()],f.prototype,"updating",null),o([s()],f.prototype,"userOperation",void 0),o([s()],f.prototype,"_analysisController",void 0),o([s()],f.prototype,"_analysisVisualization",void 0),f=o([E("esri.views.3d.analysis.LineOfSightAnalysisView3D")],f);const Xo=f;export{Xo as default};
