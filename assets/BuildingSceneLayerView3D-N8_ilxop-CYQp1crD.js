import{x as L,w as Q,v as h,I as w,af as A,o as R,ab as P,y as N,$ as G,Y as n,H as l,G as v,c as H,J as B,q as O}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{R as T}from"./collectionUtils-jDyktm0P-ArdXNs6F.js";import{j as E,l as _,V as W,w as k,o as x}from"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import{j as g}from"./BuildingComponentSublayer-DdDDAszP-Bx9ewdTm.js";import"./BuildingGroupSublayer-Dd91JVwX-Bx8owZhl.js";import{K as D,$ as f,s as V,C as U,J as z}from"./lengthUtils-Dt1_RvOO-bleznLOi.js";import{s as J}from"./Graphic-DgGzDmqW-CFzg0c4i.js";import{L as Y}from"./WhereClause-BSVqskBz-DANRwfyr.js";import{_ as K}from"./FeatureFilter-G4_pWMVe-vo0uU6rO.js";import{o as S}from"./Query-BlS0WPDF-BdshFBMz.js";import{x as X}from"./Layer-DZvC7bne-m1cEC_yw.js";import{h as Z,t as ee}from"./I3SMeshView3D-DJG_hEsG-BrgIUdxp.js";import{s as te}from"./vec4f64-DPb6J-GU-C7c2DqbZ.js";import{C as q,y as re}from"./layerViewUtils-BTa15X3o-BjQlX2q8.js";import{g as b,R as ie,p as se,A as oe}from"./I3SQueryFeatureAdapter-CglvJDWa-C4UAGjDX.js";import{r as ne}from"./I3SQueryFeatureStore-B0E9P4O6-BlHBuT_b.js";import{K as le,p as ae,w as pe}from"./I3SUtil-BtVE6TXz-Cfu4PxXY.js";import{k as ue,j as me}from"./TemporalSceneLayerView-B-MmOgDo-AG1ksN3O.js";import{I as de,h as he,m as I}from"./popupUtils-BKHMiD6K-B1dsckbj.js";import{r as ye}from"./Scheduler-CNrsbccs-Bcg8fWoS.js";import{u as ce}from"./LayerView3D-JY0KVfxL-ByE1zQWv.js";import{u as ge,m as C}from"./highlightUtils--bJgM-zK-ChHi1-zr.js";import{d as fe,t as be}from"./ShadowCastClear.glsl-CeOT_rAo-iOFMl8eB.js";import{t as we}from"./LayerView-BnpxrRF8-CNZhc0aY.js";import"./index-CTl7hdrJ.js";import"./Point-BfTTZoMu-BAT2Wq6O.js";import"./Extent-CgDMOSRD-CU1qE5Kr.js";import"./getPopupProvider-CmskPttI-C4PqyuPF.js";import"./Color-CERqXxxY-BuYn26eI.js";import"./mathUtils-PIGhLnI9-B1tKUlUb.js";import"./date-IqUzANpt-bLKO9IDT.js";import"./GraphicOrigin-uE6TDXc9-DqbdmNAV.js";import"./FeatureLayer-BRWpcy_W-BoHEkHsh.js";import"./MultiOriginJSONSupport-Bd1TKmh_-BHNF5tHX.js";import"./FormTemplate-DuPZvaVv-Bo80W65Y.js";import"./Field-Cm_ZejYW-CwJZmSru.js";import"./fieldType-DVUzXtk_-tUuvnZJM.js";import"./workers-BEkgoq8Q-BNWfkyQs.js";import"./intl-DRFqUect-ClAS7BRt.js";import"./Polygon-D6wEPb3W-CpL9Efjx.js";import"./typeUtils-DqrRcjBx-ZWdHcSIJ.js";import"./Polyline-CoiTLswR-BLagWJLS.js";import"./projectionUtils-BGH_5_I3-BySNUA-B.js";import"./FeatureSet-BF7daP96-BqhMUjXs.js";import"./mat4f32-Djp3mnm5-DzYG3LYB.js";import"./mat4-C96X-Nn0-Do6fKsNS.js";import"./DisplayFilteredLayer-DyjtPayS-DEIdkBF3.js";import"./EditBusLayer-rxUbWTiY-BI2sZl38.js";import"./FeatureEffect-mVCOF1v6-NIKVGK4R.js";import"./FeatureLayerBase-BUeDgO3U-BWuQV9AM.js";import"./HeightModelInfo-D5IdRvJ2-BK9di2bT.js";import"./OperationalLayer-B6zbJ5nR-sYdHUfAL.js";import"./ElevationInfo-Cw2HaA6E-Br1RWTYu.js";import"./unitConversionUtils-4vB4Ezlp-B0eWR3Ls.js";import"./featureLayerUtils-FKjLNPl_-DLktjSPx.js";import"./asyncUtils-w6KfWU41-HenJ0UOu.js";import"./SimpleRenderer-CEmCWePp-xiwnMlto.js";import"./commonProperties-DbO613LF-DeJ_ZDUB.js";import"./colorRamps-DswZzxkO-BqSFavfl.js";import"./ColorStop-De5gQTjr-C1lw16u9.js";import"./visualVariableUtils-ma4r7Z2K-C4Gu8Tj6.js";import"./PolygonSymbol3D-BXRHZiCQ-Vi0-2Gvc.js";import"./ExtrudeSymbol3DLayer-DSc1ou2x-CsVYZCeG.js";import"./aaBoundingBox-Cn49X7ge-DORLZxoS.js";import"./mat4f64-q_b6UJoq-Dh6sWB_w.js";import"./lineMarkers-CDwLe3J6-CNUjJvs3.js";import"./Font-BwmnW7d2-D-oIm_Md.js";import"./typeUtils-CXW_VpOn-BoSnXkME.js";import"./PictureMarkerSymbol-CaSh-vZk-BNpExnAb.js";import"./SimpleFillSymbol-CDawtd9z-CWD2KI2D.js";import"./SimpleMarkerSymbol-BGAFRS9_-CVQ5NLIA.js";import"./TextSymbol-hRGhyDHs-C0NgASym.js";import"./defaults3D-C2hXSee1-DVT6WkAf.js";import"./defaults-BDN9qxeN-CCVK4JpS.js";import"./UniqueValueRenderer-JPjz9Qvs-C1w5-GWR.js";import"./RendererLegendOptions-ByGHYLtx-C9PvCikc.js";import"./NormalizationBinParametersMixin-BK9wNkI3-BKYeOhDN.js";import"./LayerFloorInfo-CTubHTci-DKf2wu5F.js";import"./Relationship-CrANqG2c-DztISWOP.js";import"./FeatureReductionLayer-Bhh5MvS_-BFfoYl9g.js";import"./FeatureReductionSelection-Du7o8OIG-DmruV-ou.js";import"./labelingInfo-BYG2hiVF-Dmkr19gA.js";import"./jsonUtils-BCGKNxno-Cm1OfGeu.js";import"./typeUtils-DDFS4uuz-Cx8qHFHN.js";import"./ClassBreaksRenderer-BvgdqtTq-DxMHNS7X.js";import"./LRUCache-fy84PBMi-Y56WPIvD.js";import"./UnknownTimeZone-B697BDFv-CBbtul7O.js";import"./vec42-B8VM4vXb-BnA9MysM.js";import"./OrderedLayer-DQAUgUTV-CpnQmtbN.js";import"./PortalItem-DnxMlRVo-Dhq4alsp.js";import"./RefreshableLayer-CBbEkZf--CC_b3xaQ.js";import"./TimeInfo-D7ssmbZO-CCS1Im5i.js";import"./TrackableLayer-B-086Hm8-Bm00-8pN.js";import"./FeatureTemplate-Bur8tORn-iLlvjnYm.js";import"./FeatureType-CFJlAOcG-Dk8Ixr4n.js";import"./TitleCreator-BosRD8XX-DSGT-m9r.js";import"./sanitizerUtils-BT_8V5US-CWQWUwZQ.js";import"./versionUtils-BfuZvWmP-BDnOmw3Z.js";import"./I3SLayerDefinitions-BquY6sVj-QHSoIBIq.js";import"./quatf64-CCm9z-pX-CQ7_sSji.js";import"./vec32-CewSdTn3-DHOFKD0R.js";import"./UpdatingHandles-D2RI_3Hb-dwLPjVun.js";import"./spatialReferenceEllipsoidUtils-D2JabnKt-Cip58jmo.js";import"./Transform-B98MC8vi-BraHUyqG.js";import"./sphere-DLQ6p7mp-DmnRpHXV.js";import"./vector-B8ZDYGQ6-B1uNywRb.js";import"./vec2f64-rIxtbMRN-Kai9mK1i.js";import"./Texture-CFNZjV2R-lGBztxVp.js";import"./Indices-D0_UQPPr-t1Qev6md.js";import"./BufferView-Cj2sQaht-DuP-iLZg.js";import"./frustum-CMzahy3--CFytpSYl.js";import"./Emissions.glsl-B8XKMjLy-DXfiRNVX.js";import"./orientedBoundingBox-BLEx7wLU-CPBtS4XC.js";import"./quat-B7J5v7rV-i-DOMCm_.js";import"./InterleavedLayout-B7roQAzV-CC2VYRPC.js";import"./projectVectorToVector-Csv3NYZI-BsIKHfQD.js";import"./normalizeUtils-85zLqeMi-DCF9gKvo.js";import"./normalizeUtilsCommon-CnhQye_A-zWtr51r8.js";import"./I3SOverrides-BAPZnFo2-D2jt7RR1.js";import"./MeshLocalVertexSpace-BGd1IdEs-DqCdtROz.js";import"./SceneModification-BvcaWkQk-DMsqdzrV.js";import"./resourceExtension-DOTCeiZj-BXiJr75H.js";import"./ExtentSet-BmZuhn8E-BsM0ovD8.js";import"./RealisticTree.glsl-WN9nrQUl-CRRcYwOn.js";import"./vec3f32-WCVSSNPR-9V6Uhrx-.js";import"./PooledRBush-Dco5QkUp-DX3CMhf3.js";import"./I3SMeshWorkerHandle-BaFEt1Xl-BadcMrS1.js";import"./vec3-B_phcnZY-DHC7I6xa.js";import"./QueryEngine-J0SYKhS8-CFA9lsZ6.js";import"./FixedIntervalBinParameters-8snYOK8a-BSPWw9c2.js";import"./ClassBreaksDefinition-BGOzyovZ-K0U0wKo_.js";import"./utils-DTE-xBiC-uxMmcNif.js";import"./modeUtils-BA-mAwuS-UrytRxLw.js";import"./GraphicsCollection-Bk6M0b7D-ByzFamPI.js";import"./TilemapCache-CjhKW_vj-BYOTuKe8.js";import"./Map-AEYszeHg-D2YZkc1e.js";import"./Basemap-CL_uaRmk-ChnHJfg0.js";import"./writeUtils-DEFpwIW1-D44H3UWs.js";import"./CollectionFlattener-D6h2Fkvj-qnUHjb1M.js";import"./PolygonCollection-HNNpnBH7-C5NQ6xHr.js";import"./ElevationQuery-DzlYa4L4-BxQXlEAE.js";import"./TileInfo-Bz7QlefV-tjhen9qQ.js";import"./constants-D67WmGms-H7IOwEdB.js";import"./floatRGBA-D-Q4FzNN-BzjdY1tU.js";import"./TileKey-C44YQC4_-BW7BBbYp.js";import"./vec2f32-CaVKkSa6-BjkBmyoj.js";import"./Octree-DckBBpQ7-BC8mmFdF.js";import"./axisAngleDegrees-CjbXmycq-LMRXo165.js";import"./edgePreprocessing-D_eX-fWy-CRLN12td.js";import"./vec33-CWJeyzxV-Me4sF5XB.js";import"./reader-DcGs6kKN-DHJfK-tm.js";import"./SimpleObservable-CvFyr0NA-DXpoMYph.js";import"./capabilities-Cs4k8cuT-Cq70vfK_.js";import"./fieldProperties-BoJj55FN-yR5ddqST.js";import"./FieldsIndex-CimK-TqD-CrSnohIk.js";import"./timeZoneUtils-BSc7-7qA-BAv3h8mh.js";import"./I3SIndexInfo-B2NvYFjS-O54px-TX.js";import"./popupUtils-D4UavgYz-4fibcgIL.js";import"./loadAll-BCyxerwc-DK9uHnLK.js";import"./jsonUtils-CmpazY1u-ateEpj4Q.js";import"./createFeatureId-CVwTD0fV-3fKpJDrk.js";import"./TimeOnly-BERR31kg-PKcKegNB.js";import"./enum-BzLwmiID-CcyIdWlQ.js";import"./projectBoundingSphere-B69Mxmv9-93ObKDbx.js";import"./aaBoundingRect-CjwcS2F3-D7aII9DY.js";import"./DoubleArray-DExKNiTh-CvVpHySW.js";import"./elevationInfoUtils-B8MpdRMP-CN_w2fPT.js";import"./diffUtils-wTC1YzlE-JuqUWoWa.js";import"./SceneLayerWorker-B7YoqKUk-Dptz0gBN.js";import"./I3SBinaryReader-ZmgM2p_h-BnxBvCpV.js";import"./intersectorUtilsConversions-pLQPEbcN-rV-4Q5_m.js";import"./HUDIntersectorResult-1xTExS7z-CU1-YQoW.js";import"./Intersector-DS9YtyQY-CuzM48xl.js";import"./attributeUtils-Dc8--CBJ-B-j5BZQ_.js";import"./highlightOptionsUtils-Cdm0-Ad8-d1QoXb1P.js";import"./screenUtils-BitdhK1O-L0FLPAMi.js";import"./OptimizedFeature-CwRGZPwv-Ddclhn0A.js";import"./memoryEstimations-Bd726a_p-0cVCY2Jz.js";import"./featurePopupQueryUtils-CnnY2XPA-CIuoWQ_Y.js";import"./computeTranslationToOriginAndRotation-Bjd4esRf-CXUng2L4.js";import"./timeSupport-CL-HYuK--DWa-2gL6.js";import"./signal-BX9ezF8a-cf1Pn6io.js";import"./projectPointToVector-DL7Z4uvb-BbcUuq8O.js";import"./scaleUtils-yfx9kKWT-BPfZ-Fh2.js";import"./layerUtils-DZGhvm-W-DLw3QMll.js";import"./tagSymbols-BPcGfZon-BPcGfZon.js";import"./Queue-CYlrXMwB-CYJTUII-.js";import"./ReactiveMap-B0by2bYu-DCsCfMj5.js";import"./TablesMixin-Q80MT3nU-CFBTh0j7.js";import"./plane-BNdSPG2o-Cq7jmU6w.js";import"./enums-B4pqBiXb-BO-3hS_8.js";import"./VertexElementDescriptor-BlxU8vCE-BwuKQkTU.js";import"./Cyclical-BLSxUpe7-Bj8R2Yk-.js";import"./dehydratedFeatures-Ql-uVzLq-DehgeO5I.js";import"./quantizationUtils-Ceq-Uxsu-CDK8m1qL.js";import"./featureConversionUtils-BDA_FXJx-CUwkrHf5.js";import"./OptimizedFeatureSet-BR8EEvDc-CgsRgxJh.js";import"./DefaultLoadingContext-DXgBe4GE-Colk9t6X.js";import"./wosrLoader-CIPfz1Cl-qtGxLmBP.js";import"./Version-BtYZEj58-LyRHDnSJ.js";import"./config-Dg972SSE-D9DBKeq5.js";import"./GeometryUtils-C354xUs0-CG8X9WjO.js";import"./definitions-Dvg4hMIw-CdK2DzFN.js";import"./WorkerHandle-B930SiRy-b7IwaSpV.js";import"./colorUtils-CeIi7j7j-nwrKvQYb.js";import"./capabilities-Bi6C4OG6-CpURufko.js";import"./imageUtils-142g71N8-CjUugWaS.js";import"./videoUtils-Dwx3AEgj-CduhpDRk.js";import"./uuid-Oe6SV2kF-IYX19xBA.js";import"./quickselect-QQC62dOK-Br2Ahhru.js";import"./meshVertexSpaceUtils-CtG7DPVT-V_uCtHpB.js";import"./TileKey-CXWFOqOI-CcilLir8.js";import"./opacityUtils-DuFH0EC9-DWspTgn2.js";import"./persistable-CdoDQOTR-CH9U-JJT.js";import"./MD5-MtSiOt06-jWr180Yc.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw-DH8sdIsE.js";import"./utils-CylVuxNi-CqOfmBVG.js";import"./utils-Dpg4yj1D-BVnuoMV8.js";import"./types-BKo2foNY-DE0QfIFp.js";import"./labelUtils-BtizwBfq-Zegx4520.js";import"./ArcadeExpression-BlIRq-oN-DGzfhzBj.js";import"./layerContainerType-CSXZNpHb-BIF7XAYP.js";import"./isFeatureGraphicOrigin-YA2hudPe-Bk2FjH_E.js";import"./editsZScale-D3N5iH_c-CePEFiUi.js";import"./queryZScale-CRP3Sh_E-0yf18ElE.js";import"./APIKeyMixin--YGbad8e-DJ-JJTX5.js";import"./ArcGISService-SIwch9bz-BD00xz4C.js";import"./BlendLayer-HE_aYHHW-CZa4IAJu.js";import"./jsonUtils-CY6YsQMo-SliJcuqs.js";import"./CustomParametersMixin-Dshqz1Zp-BFC165kX.js";import"./FeatureEffectLayer-BG_KTtPw-CZiOOvL9.js";import"./PortalLayer-CbFNhtZ4-CCXE0v4V.js";import"./portalItemUtils-CaPNUJg6-JsqddoLx.js";import"./ScaleRangeLayer-DQr2T3Hh-Dh1UYk4i.js";import"./TemporalLayer-D4R0YvXo-CzgQNAIr.js";import"./serviceCapabilitiesUtils-BV_pcUiO-CjqWUbfp.js";import"./infoFor3D-DhzudQro-CCYgWfsv.js";import"./styleUtils-CZJC3pZm-BNE6B1Si.js";import"./displayFilterUtils-CIXGrQzt-Ck5cgHqb.js";import"./multiLayerServiceUtils-CpHWiXA7-B9JDcSQL.js";import"./featureQueryAll-BfDWA5Wx-ZgjJqs6l.js";import"./jsonUtils-C9q_FK4K-Cuz7ImzI.js";import"./defaultsJSON-GKolV7NZ-GKolV7NZ.js";import"./styleUtils-DWvicjTN-DYvOM9HS.js";import"./DictionaryScriptEvaluator-G73uSGpN-Cn2sp0hZ.js";import"./utils-DX2muIr3-DiPfFKSl.js";import"./heatmapUtils-B-AXnq0l-G7fD8L97.js";import"./resourceUtils-DWVfTVer-NJXuINUS.js";import"./EllipsoidMode-Bujbvu9s-BjyCTnwm.js";import"./optimizedFeatureQueryEngineAdapter-Bma9_B5X-BMDAgToU.js";import"./WhereClauseCache-B0L2SmwV-BYc3WALz.js";import"./QueryEngineCapabilities-DJC_YILC-CshvWf3J.js";import"./utils-CUk96PkC-CThUWKre.js";import"./utils-BbtW4lHb-DKC09XMb.js";import"./utils-BEeBypEk-DQLTC4jR.js";import"./SnappingCandidate-DGkpYqI6-CfPvDre4.js";const $=(e,t)=>{const r=W(X(k(e)));let i=class extends r{constructor(s){super(s)}initialize(){}get suspended(){return!this.canResume()}get updating(){return!this.suspended&&this.isUpdating()}get visible(){return!!this.sublayer?.visible}set visible(s){this._overrideIfSome("visible",s)}get fullOpacity(){const s=o=>o??1;return s(this.sublayer?.opacity)*s(this.parent?.fullOpacity)}canResume(){return!this.parent?.suspended&&this.view?.ready&&this.visible||!1}isUpdating(){return!1}};return n([l()],i.prototype,"sublayer",void 0),n([l()],i.prototype,"parent",void 0),n([l()],i.prototype,"view",void 0),n([l({readOnly:!0})],i.prototype,"suspended",null),n([l({type:Boolean,readOnly:!0})],i.prototype,"updating",null),n([l()],i.prototype,"visible",null),n([l()],i.prototype,"fullOpacity",null),i=n([v("esri.views.3d.layers.BuildingSublayerView3D")],i),i},j=.15,_e=.5*j;function Fe(e){switch(e.filterMode.type){case"solid":return{mode:0};case"wire-frame":return{mode:1,edgeMaterial:re(e.filterMode.edges,{})};case"x-ray":return{mode:2}}}function M(e,t){if(t==null)return e.color[3]=0,void(e.edgeMaterial=null);switch(t.mode){case 0:return;case 1:return e.color[3]=0,void(e.edgeMaterial=t.edgeMaterial);case 2:return e.color[0]=1,e.color[1]=1,e.color[2]=1,e.color[3]*=j,e.colorMixMode=3,e.castShadows=!1,e.pickable=!1,void(e.edgeMaterial=ve(e.edgeMaterial))}}function ve(e){return e==null?null:(y.lastMaterial!==e&&(y.cachedMaterial=Ee(e),y.lastMaterial=e),y.cachedMaterial)}function Ee(e){const t=te(e.color);return t[3]*=_e,{...e,color:t}}const y={cachedMaterial:null,lastMaterial:null};class c extends O{constructor(){super(...arguments),this.sublayer=null}get updating(){return!1}get suspended(){return!1}get availableFields(){return[]}get filter(){return null}set filter(t){throw new Error("Not implemented")}queryFeatures(t,r){throw new Error("Not implemented")}queryObjectIds(t,r){throw new Error("Not implemented")}queryFeatureCount(t,r){throw new Error("Not implemented")}createQuery(){throw new Error("Not implemented")}queryExtent(t,r){throw new Error("Not implemented")}highlight(t){throw new Error("Not implemented")}}n([l()],c.prototype,"sublayer",void 0),n([l()],c.prototype,"availableFields",null),n([l()],c.prototype,"filter",null);let u=class extends ue(me(Z($(c)))){constructor(e){super(e),this.type="building-component-sublayer-3d",this._elevationContext=2,this._supportsLabeling=!1,this.requiredFields=[],this.progressiveLoadFactor=1,this._queryEngine=null}get i3slayer(){return this.sublayer}get layerViewUid(){return this.layerView.uid}get layerId(){return this.sublayer.layer.id}get sublayerId(){return this.sublayer.id}get layerPopupEnabledAndHasTemplate(){return this.sublayer.popupEnabled&&de(this.sublayer,this.layerView.view.popup?.defaultPopupTemplateEnabled)}initialize(){this._updatingHandles.add(()=>this.mergedFilter,t=>{t!=null&&b.checkSupport(t)?this._i3sFilter==null?this._i3sFilter=new b({viewFilter:t,layerFieldsIndex:this.sublayer.fieldsIndex,loadAsyncModule:r=>this._loadAsyncModule(r),addSqlFilter:(r,i)=>this.addSqlFilter(r,i,this.logError),addTimeFilter:(r,i)=>this.addTimeFilter(r,i)}):this._i3sFilter.viewFilter=t:this._i3sFilter=H(this._i3sFilter)},_),this._updatingHandles.add(()=>[this.sublayer.renderer,this.definitionExpressionFields,this.filterExpressionFields],()=>this._updateRequiredFields()),this._updatingHandles.add(()=>this.sublayer.renderer,t=>this._rendererChange(t),x);const e=()=>this._filterChange();this._updatingHandles.add(()=>this.parsedDefinitionExpression,e),this._updatingHandles.add(()=>this._i3sFilter?.sortedObjectIds,e),this._updatingHandles.add(()=>this._i3sFilter?.parsedWhereClause,e),this._updatingHandles.add(()=>this.getTimeFilterDependencies(),e),this._updatingHandles.add(()=>this.mergedFilter,e),this._updatingHandles.add(()=>[this._i3sFilter?.parsedGeometry,this.filter?.spatialRelationship],()=>this._geometryFilterChange()),this._updatingHandles.add(()=>this.parsedFilterExpressions,()=>this._updateSymbologyOverride(),x),this.addResolvingPromise(this._updateRequiredFields())}get lodFactor(){return this.view.qualitySettings.sceneService.object.lodFactor}get parsedFilterExpressions(){return this.sublayer.modelName==="Overview"?[]:this.layerView.filterExpressions.map(([e,t])=>{let r;try{r=Y.create(e,{fieldsIndex:this.sublayer.fieldsIndex})}catch(o){return h.getLogger(this).error("Failed to parse filterExpression: "+o),null}if(!r.isStandardized)return h.getLogger(this).error("filterExpression is using non standard function"),null;const i=[],s=r.fieldNames;return ae(s,this.sublayer.fieldsIndex,{missingFields:i}),i.length>0?(h.getLogger(this).error(`filterExpression references unknown fields: ${i.join(", ")}`),null):[r,t]}).filter(e=>e!=null)}get filter(){return this._get("filter")}set filter(e){this._set("filter",b.checkSupport(e)?e:null)}isUpdating(){return super.isUpdating()||(this._i3sFilter?.updating??!1)}_updateSymbologyOverride(){const e=this.parsedFilterExpressions;e.length>0?this._setSymbologyOverride((t,r)=>{for(const[i,s]of e)try{if(i.testFeature(t))return M(r,s)}catch(o){this.logError(o)}return M(r,null)},this.filterExpressionFields):this._setSymbologyOverride(null,null)}get filterExpressionFields(){return f(this.sublayer.fieldsIndex,this.parsedFilterExpressions.reduce((e,[t])=>e.concat(t.fieldNames),new Array))}get availableFields(){const e=this.sublayer,t=e.fieldsIndex;let r=this.requiredFields;if(e.outFields||e.layer.outFields){const i=[...e.outFields||[],...e.layer.outFields||[]];r=[...V(t,i),...r]}return f(t,r)}get _graphicOrigin(){return this.sublayer.graphicOrigin}_createLayerGraphic(e){return new J({attributes:e,layer:this.sublayer.layer,sourceLayer:this.sublayer,origin:this._graphicOrigin})}canResume(){return super.canResume()&&q(this.i3slayer.effectiveScaleRange,this.view.scale)&&(!this._controller||this._controller.rootNodeVisible)}async fetchPopupFeaturesFromGraphics(e,t){const r=this._validateFetchPopupFeatures(t);if(r)throw r;if(e.length===0)return[];const i=[],s=[],o=this.sublayer.associatedLayer!=null?await this.sublayer.associatedLayer.load(t):this.sublayer,a=V(this.sublayer.fieldsIndex,await he(o,I(this.sublayer,t)));R(t);const p=new Set;for(const d of e)U(d,a,p)?s.push(d):i.push(d);return s.length===0?i:(this.sublayer.associatedLayer!=null&&await this.sublayer.associatedLayer.load().catch(()=>h.getLogger(this).warn("Failed to load associated feature layer. Displaying popup attributes from cached attributes.")),this.whenGraphicAttributes(s,Array.from(p)).catch(d=>(B(d),s)).then(d=>i.concat(d)))}async _updateRequiredFields(){const e=f(this.sublayer.fieldsIndex,[...this.sublayer.renderer?await this.sublayer.renderer.getRequiredFields(this.sublayer.fieldsIndex):[],...this.definitionExpressionFields,...this.filterExpressionFields]);this._set("requiredFields",e)}_validateFetchPopupFeatures(e){const{sublayer:t}=this,{popupEnabled:r}=t;return r?I(t,e)?void 0:new w("buildingscenelayerview3d:fetchPopupFeatures","Layer does not define a popup template",{sublayer:t}):new w("buildingscenelayerview3d:fetchPopupFeatures","Popups are disabled",{sublayer:t})}getFilters(){const e=super.getFilters();return this.addSqlFilter(e,this.parsedDefinitionExpression,this.logError),this._i3sFilter?.addFilters(e,this.view,this._controller.crsIndex,this._collection),e}createQuery(){const e={outFields:["*"],returnGeometry:!1,outSpatialReference:this.view.spatialReference};return this.filter!=null?this.filter.createQuery(e):new S(e)}queryExtent(e,t){return this._ensureQueryEngine().executeQueryForExtent(this._ensureQuery(e),t?.signal)}queryFeatureCount(e,t){return this._ensureQueryEngine().executeQueryForCount(this._ensureQuery(e),t?.signal)}queryFeatures(e,t){return this._ensureQueryEngine().executeQuery(this._ensureQuery(e),t?.signal).then(r=>{if(!r?.features)return r;const i=this.sublayer,s=i.layer,o=this._graphicOrigin;for(const a of r.features)a.layer=s,a.sourceLayer=i,a.origin=o;return r})}async queryObjectIds(e,t){return(await this._ensureQueryEngine().executeQueryForIds(this._ensureQuery(e),t?.signal)).filter(z)}_ensureQueryEngine(){return this._queryEngine??=this._createQueryEngine(),this._queryEngine}_createQueryEngine(){const e=ee(this.view.spatialReference,this.view.renderSpatialReference,this._collection);return new ie({layerView:this,priority:ye.FEATURE_QUERY_ENGINE,spatialIndex:new ne({featureAdapter:new se({objectIdField:this.sublayer.objectIdField,attributeStorageInfo:this.sublayer.attributeStorageInfo,getFeatureExtent:e}),forAllFeatures:(t,r)=>this._forAllFeatures((i,s,o)=>t(new oe(i,s,o)),r,2),getFeatureExtent:e,sourceSpatialReference:pe(this.sublayer),viewSpatialReference:this.view.spatialReference})})}_ensureQuery(e){return this._addDefinitionExpressionToQuery(e==null?this.createQuery():S.from(e))}};n([l()],u.prototype,"i3slayer",null),n([l()],u.prototype,"layerView",void 0),n([l()],u.prototype,"lodFactor",null),n([l({readOnly:!0})],u.prototype,"parsedFilterExpressions",null),n([l({type:K})],u.prototype,"filter",null),n([l()],u.prototype,"_i3sFilter",void 0),n([l({type:[String],readOnly:!0})],u.prototype,"filterExpressionFields",null),n([l({type:[String],readOnly:!0})],u.prototype,"requiredFields",void 0),n([l({type:[String],readOnly:!0})],u.prototype,"availableFields",null),n([l()],u.prototype,"_graphicOrigin",null),u=n([v("esri.views.3d.layers.BuildingComponentSublayerView3D")],u);class F extends we{constructor(t){super(t),this.layer=null,this.sublayerViews=null}highlight(t,r){throw new Error("Not implemented")}}n([l()],F.prototype,"layer",void 0),n([l()],F.prototype,"sublayerViews",void 0);const xe=$(O);let m=class extends ce(F){constructor(e){super(e),this.type="building-scene-3d",this.sublayerViews=new T,this._rejectedSublayerViews=new Map,this._abortController=new AbortController,this._loadingComponents=0,this._pendingWhenSublayerViews=new Map,this.ignoresMemoryFactor=!1}get filterExpression(){const e=this.layer.activeFilterId,t=e!=null?this.layer.filters.find(i=>i.id===e):null,r=t!=null?t.filterBlocks?.find(i=>i.filterMode.type==="solid"):null;return r?r.filterExpression:null}get filterExpressions(){const e=this.layer.activeFilterId,t=e!=null?this.layer.filters.find(r=>r.id===e):null;return t?.filterBlocks?t.filterBlocks.toArray().map(r=>[r.filterExpression??"",Fe(r)]):[]}get updatingProgressValue(){const e=this.sublayerViews,t=this._loadingComponents+(e?e.length:0);return e.reduce((r,i)=>r+i.updatingProgress,0)/t}get visibleAtCurrentScale(){return q(this.layer.effectiveScaleRange,this.view.scale)}isUpdating(){return this._loadingComponents>0||this.sublayerViews&&this.sublayerViews.some(e=>e.updating)}initialize(){le(this.layer.spatialReference,this.view.spatialReference,this.view.viewingMode),this._initializeSublayerViews(this.layer.sublayers,this)}destroy(){this.sublayerViews&&(this.sublayerViews.forEach(e=>e.destroy()),this.sublayerViews=null),this._rejectedSublayerViews=null,this._abortController=L(this._abortController)}_initializeSublayerViews(e,t){const r=this,i=this.view;e.forEach(s=>{if(!s.isEmpty)if(s.type==="building-group"){const o=new xe({sublayer:s,view:i,parent:t});this._initializeSublayerViews(s.sublayers,o)}else s.geometryType==="mesh"?(this._loadingComponents++,s.load({signal:this._abortController.signal}).then(()=>{const o=new u({sublayer:s,layerView:r,view:i,parent:t});this.sublayerViews.push(o);const a=this._pendingWhenSublayerViews.get(s);if(a){for(const p of a)p.resolve(o);this._pendingWhenSublayerViews.delete(s)}this.addHandles([E(()=>o.updating,()=>this.notifyChange("updating"),_),E(()=>o.updatingProgress,()=>this.notifyChange("updatingProgressValue"),_)])}).catch(o=>{Q(o)||h.getLogger(this).error(`Error while creating view for sublayer ${s.id}
Layer: ${this.layer.url}
`,o),this._rejectWhenSublayerView(s,o)}).then(()=>{this._loadingComponents--,this.notifyChange("updating"),this.notifyChange("updatingProgressValue")})):this._rejectWhenSublayerView(s,new w("view:no-layerview-for-sublayer",`No layerview created for sublayer ${s.id}`))})}getGraphicFromIntersectorTarget(e,t){for(const r of this.sublayerViews.items)if(r.sublayer.id===e.sublayerId)return r.getGraphicFromIntersectorTarget(e,t);return null}async fetchPopupFeaturesFromGraphics(e,t){if(e.length===0)return[];const r=Ve(e,o=>g(o.origin)?o.origin.sublayer:o.sourceLayer),i=[];for(const[o,a]of r){const p=this._findComponent(o);p!=null&&i.push(p.fetchPopupFeaturesFromGraphics(a,t))}const s=await A(i);return R(t),s.flat()}whenGraphicBounds(e){const t=this._findComponent(g(e.origin)?e.origin.sublayer:e.sourceLayer);return t==null?Promise.reject():t.whenGraphicBounds(e)}getAABBFromIntersectorTarget(e){for(const t of this.sublayerViews.items)if(t.sublayer.id===e.sublayerId)return t.getAABBFromIntersectorTarget(e);return null}async whenSublayerView(e){const t=this._findComponent(e);if(t!=null)return t;const r=this._rejectedSublayerViews.get(e);if(r!=null)throw r;const i=this._pendingWhenSublayerViews.get(e),s=P();return i?i.push(s):this._pendingWhenSublayerViews.set(e,[s]),s.promise}_rejectWhenSublayerView(e,t){this._rejectedSublayerViews.set(e,t);const r=this._pendingWhenSublayerViews.get(e);if(r){for(const i of r)i.reject(t);this._pendingWhenSublayerViews.delete(e)}}_findComponent(e){return this.sublayerViews.find(t=>e===t.sublayer)}highlight(e,t){const r=ge(e);if(r.length===0)return C;if(D(r[0])){const i=r,s=new Map;for(const a of i)N(s,g(a.origin)?a.origin.sublayer:a.sourceLayer,()=>[]).push(a);const o=[];return this.sublayerViews.forEach(a=>{const p=s.get(a.sublayer);p&&o.push(a.highlight(p,t))}),G(o)}return C}get usedMemory(){return this.sublayerViews.reduce((e,t)=>e+t.usedMemory,0)}get unloadedMemory(){return this.sublayerViews.reduce((e,t)=>e+t.unloadedMemory,0)}get performanceInfo(){return new fe(this.usedMemory)}};function Ve(e,t){const r=new Map,i=e.length;for(let s=0;s<i;s++){const o=e[s],a=t(o,s,e),p=r.get(a);p?p.push(o):r.set(a,[o])}return r}n([l()],m.prototype,"sublayerViews",void 0),n([l()],m.prototype,"_rejectedSublayerViews",void 0),n([l({readOnly:!0})],m.prototype,"filterExpression",null),n([l({readOnly:!0})],m.prototype,"filterExpressions",null),n([l(be)],m.prototype,"updatingProgress",void 0),n([l({readOnly:!0,dependsOn:[]})],m.prototype,"updatingProgressValue",null),n([l({readOnly:!0})],m.prototype,"visibleAtCurrentScale",null),m=n([v("esri.views.3d.layers.BuildingSceneLayerView3D")],m);const ho=m;export{ho as default};
