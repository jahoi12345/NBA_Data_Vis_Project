import{_ as l,m as u,a as R,l as J,u as H,a8 as Ae,i as be,s as $e}from"./jsonMap-Bs3hmeCU.js";import{i as Pe,O as Ee,n as xe}from"./collectionUtils-Cc1OWTqq.js";import{ar as Re,o as Ce,f as Oe}from"./ShadowCastClear.glsl-Dm_ZNusR.js";import{l as A,h as E}from"./reactiveUtils-SO2Ko3sy.js";import{b as Fe,a5 as Se,a6 as Te,at as Me,as as Ve}from"./Point-CMHR1y9V.js";import{e as qe}from"./earcut-D9gy186-.js";import{e as S}from"./mat4f64-q_b6UJoq.js";import{W as ke}from"./projectionUtils-BYIvMX5W.js";import{t as De}from"./operatorDensify-BAougbyn.js";import{e as Ne}from"./operatorSimplify-5A_MmN4K.js";import{fromSpatialReference as je,fromPolygon as ze,toPolygon as Ge}from"./apiConverter-DfAOfYgX.js";import{f as He}from"./computeTranslationToOriginAndRotation-D0D690pa.js";import{e as Ue}from"./DoubleArray-DExKNiTh.js";import{f as U}from"./Indices-D0_UQPPr.js";import{r as Ie}from"./vec3-B_phcnZY.js";import{r as Le,X as We}from"./Graphics3DExtrudeSymbolLayer-BSwWzfW3.js";import{w as Be}from"./RealisticTree.glsl-CD2qk3Wa.js";import{T as K,V as Q,aW as Ze,a$ as Xe,a1 as Y,a2 as ee,b1 as Je,a3 as te,a8 as re,b2 as oe,b3 as w,ao as Ke,an as Qe,bb as ie,bc as I,bd as Ye,x as et}from"./Texture-BuZokc5o.js";import{_ as se}from"./index-BiLqt4Ue.js";import{n as ae,_ as L}from"./enums-B4pqBiXb.js";import{n as tt}from"./VertexElementDescriptor-BlxU8vCE.js";import{u as W}from"./Color-CERqXxxY.js";import{R as rt}from"./OutlineVisualElement-DDGdsTBW.js";import{j as B,f as ot,t as x}from"./Emissions.glsl-B8XKMjLy.js";import{r as it}from"./signal-BX9ezF8a.js";import{i as st}from"./mat4-Df_3WIwI.js";import"./reader-DcGs6kKN.js";import"./Extent-BVvEPGp_.js";import"./SimpleObservable-CvFyr0NA.js";import"./jsonUtils-BIx2Bg38.js";import"./Polyline-CYNn9agI.js";import"./Polygon-WlfMxvm8.js";import"./aaBoundingRect-WcI4brw6.js";import"./mathUtils-PIGhLnI9.js";import"./typeUtils-Dr-CEt7y.js";import"./modeUtils-RVJH-Hyp.js";import"./intl-C3uMq9s5.js";import"./date-IqUzANpt.js";import"./uuid-Oe6SV2kF.js";import"./sanitizerUtils-BT_8V5US.js";import"./screenUtils-BitdhK1O.js";import"./lengthUtils-1lu2BknD.js";import"./workers-eNnOSbW_.js";import"./Queue-CYlrXMwB.js";import"./PooledRBush-Dco5QkUp.js";import"./quickselect-QQC62dOK.js";import"./GraphicsCollection-FgG4i9u5.js";import"./Graphic-CfT07maQ.js";import"./getPopupProvider-zqy7P9ZA.js";import"./Layer--kjMcEYS.js";import"./createFeatureId-CVwTD0fV.js";import"./typeUtils-BUTeHmXX.js";import"./lineMarkers-CDwLe3J6.js";import"./PolygonSymbol3D-DOhH5ySO.js";import"./ExtrudeSymbol3DLayer-DSc1ou2x.js";import"./opacityUtils-DuFH0EC9.js";import"./aaBoundingBox-CNqmdQRu.js";import"./Font-SQ7b_Y8G.js";import"./SimpleFillSymbol-CDawtd9z.js";import"./SimpleMarkerSymbol-BGAFRS9_.js";import"./PictureMarkerSymbol-6cJpxdoq.js";import"./TextSymbol-DhXD0YaH.js";import"./HeightModelInfo-BOZ2bCXl.js";import"./spatialReferenceEllipsoidUtils-DnehMctI.js";import"./projectPointToVector-lgC5SvvR.js";import"./scaleUtils-cWMHpBu0.js";import"./layerUtils-CCPFPk-j.js";import"./TilemapCache-ChidWVjQ.js";import"./LRUCache-fy84PBMi.js";import"./TileKey-CTZ53yPm.js";import"./memoryEstimations-Bd726a_p.js";import"./tagSymbols-BPcGfZon.js";import"./UpdatingHandles-D2RI_3Hb.js";import"./asyncUtils-w6KfWU41.js";import"./Map-BZpIOwPY.js";import"./Basemap-fKW7Cz4U.js";import"./loadAll-H0orMzpA.js";import"./PortalItem-e2bKDJZ8.js";import"./writeUtils-BvBZRLXT.js";import"./CollectionFlattener-CyTdUoKH.js";import"./persistable-Ot1881Fk.js";import"./MD5-MtSiOt06.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw.js";import"./resourceExtension-Dlt4ayx_.js";import"./PolygonCollection-j-hecAeB.js";import"./mat4f32-Djp3mnm5.js";import"./TablesMixin-Nye32Ffd.js";import"./timeZoneUtils-BSc7-7qA.js";import"./ReactiveMap-B0by2bYu.js";import"./Query-dGEUg7py.js";import"./Field-Cm_ZejYW.js";import"./fieldType-DVUzXtk_.js";import"./vec32-DIQfN9dj.js";import"./normalizeUtils-BEJV7G0l.js";import"./Cyclical-BLSxUpe7.js";import"./normalizeUtilsCommon-DnSvD7ht.js";import"./utils-BrkeFJbU.js";import"./utils-DGvxRWBb.js";import"./ElevationQuery-uPUdv3lW.js";import"./TileInfo-BbMV8v9T.js";import"./plane-C25sE_vU.js";import"./vec42-ClQ6ADuy.js";import"./vector-HTSzpX5X.js";import"./quatf64-CCm9z-pX.js";import"./vec2f64-rIxtbMRN.js";import"./vec4f64-DPb6J-GU.js";import"./vec3f32-WCVSSNPR.js";import"./Scheduler-CNrsbccs.js";import"./InterleavedLayout-DVezg4xk.js";import"./BufferView-BVrbsaWH.js";import"./types-BKo2foNY.js";import"./sphere-COwiWjRO.js";import"./constants-D67WmGms.js";import"./quat-D3JcL9GI.js";import"./projectVectorToVector-CDqEkUpu.js";import"./frustum-DWgQCJBb.js";import"./floatRGBA-1BW7WSIR.js";import"./labelUtils-BtizwBfq.js";import"./ArcadeExpression-BHPcSlWy.js";import"./TimeOnly-DH57Trnh.js";import"./enum-BzLwmiID.js";import"./UnknownTimeZone-B697BDFv.js";import"./FieldsIndex-CyoOfYU1.js";import"./TileKey-C44YQC4_.js";import"./layerViewUtils-BTa15X3o.js";import"./unitConversionUtils-C_S2QiAQ.js";import"./orientedBoundingBox-CpdLjzxi.js";import"./vec2f32-CaVKkSa6.js";import"./dehydratedFeatures-D_FpkmpM.js";import"./quantizationUtils-BYmjRh4u.js";import"./featureConversionUtils-hXFGbgzJ.js";import"./OptimizedFeature-CwRGZPwv.js";import"./OptimizedFeatureSet-BR8EEvDc.js";import"./Octree-BScVi4hI.js";import"./elevationInfoUtils-Dxkv6YB1.js";import"./HUDIntersectorResult-DJ-mrASs.js";import"./intersectorUtilsConversions-DcxEtHOg.js";import"./Intersector-BEbN3ApI.js";import"./DefaultLoadingContext-BBb1tRC-.js";import"./wosrLoader-BTzfF2iQ.js";import"./Version-BtYZEj58.js";import"./axisAngleDegrees-D1OOYQT7.js";import"./edgePreprocessing-BFYAECPd.js";import"./config-Dg972SSE.js";import"./GeometryUtils-BdjkAnCr.js";import"./definitions-Dvg4hMIw.js";import"./WorkerHandle-CWMP3YEU.js";import"./colorUtils-BzDQ74Nc.js";import"./vec33-CWJeyzxV.js";import"./capabilities-Bi6C4OG6.js";import"./imageUtils-CE3cSuc6.js";import"./SimpleGeometryCursor-B92kdZ15.js";import"./ProjectionTransformation-PJc9H7Gq.js";import"./Point2D-CMz7woHH.js";import"./Envelope2D-mFnl8dXR.js";import"./Transformation2D-CrydmBdC.js";import"./OperatorDefinitions-DP7_WWTp.js";import"./jsonConverter-CaopPWkV.js";import"./SnappingCandidate-DGkpYqI6.js";import"./renderingInfoUtils-BRpJAIBa.js";import"./visualVariableUtils-C1nFTN5Y.js";import"./triangulationUtils-3NHGJlwO.js";import"./deduplicate-Lzwo1kX7.js";import"./meshVertexSpaceUtils-CDaunXaJ.js";import"./MeshLocalVertexSpace-y1kE5w4c.js";import"./videoUtils-Dwx3AEgj.js";import"./ElevationInfo-C2qRy2Lz.js";import"./EngineVisualElement-C3RUR-2o.js";import"./VisualElement-By4iq8p4.js";import"./LaserlinePath.glsl-CWTtr26S.js";import"./line-C-ddTi4F.js";import"./line-DcZtzQ85.js";class T extends K{constructor(){super(...arguments),this.effect=0,this.fadeFactor=it(1)}}function ne(){const e=new Q;return e.include(Ze),e.outputs.add("fragColor","vec4",0),e.fragment.uniforms.add(new B("colorTexture",t=>t.color),new B("focusArea",t=>t.focusArea),new Xe("focusAreaEffectMode",t=>t.effect),new ot("fadeFactor",t=>t.fadeFactor.value)).main.add(x`
      float mask = texture( focusArea, uv, 0.0 ).r;
      vec4 color = texture( colorTexture, uv, 0.0 );
      vec4 colorDeSaturate = vec4(color.r * 0.25 + color.g * 0.5 + color.b * 0.25);
      if (focusAreaEffectMode == ${x.int(0)}) {
        fragColor = mask > 0.0 ? color : mix(color, 0.55 * colorDeSaturate + 0.45, fadeFactor);
      } else {
        fragColor = mask > 0.0 ? color : mix(color, 0.33 * color, fadeFactor);
      }
  `),e}const at=Object.freeze(Object.defineProperty({__proto__:null,FocusAreaColorPassParameters:T,build:ne},Symbol.toStringTag,{value:"Module"}));let Z=class extends Y{constructor(t,o){super(t,o,new ee(at,()=>se(()=>Promise.resolve().then(()=>ht),void 0)),Je)}initializePipeline(){return te({colorWrite:re})}},_=class extends oe{constructor(t){super({...t,view:t.focusAreasView.view}),this.consumes={required:[w.FOCUSAREA_COLOR,w.FOCUSAREA]},this.produces=w.FOCUSAREA_COLOR,this._fadeDirection=0,this._passParameters=new T}precompile(){this.techniques.precompile(Z)}fadeOut(t){this.removeAllHandles(),this._startTime=null,this._fadeDirection=1,this.addHandles(A(()=>this._passParameters.fadeFactor.value,o=>{o===0&&(this.removeAllHandles(),t())})),this.requestRender(2)}render(t){const o=this.techniques.get(Z),m=t.find(({name:v})=>v===this.produces);if(!o.compiled)return this.requestRender(1),m;const n=this.focusAreasView.style,a=this.bindParameters,s=a.camera,r=s.fullViewport[2],i=s.fullViewport[3];this._startTime??=this.view.stage?.renderer.renderContext.time;const f=this.view.qualitySettings.fadeDuration,p=f>0?Math.min(f,this.view.stage?.renderer.renderContext.time-this._startTime)/f:1,c=t.find(({name:v})=>v===w.FOCUSAREA),h=this.fboCache.acquire(r,i,this.produces),d=this.renderingContext;return d.bindFramebuffer(h.fbo),this._passParameters.color=m.getTexture(),this._passParameters.focusArea=c.getTexture(),this._passParameters.effect=nt[n],this._passParameters.fadeFactor.value=this._fadeDirection===0?p:1-p,d.bindTechnique(o,a,this._passParameters),d.screen.draw(),h.attachDepth(m.getAttachment(ae)),p<1&&this.requestRender(2),h}};l([u()],_.prototype,"consumes",void 0),l([u()],_.prototype,"produces",void 0),l([u({constructOnly:!0})],_.prototype,"focusAreasView",void 0),_=l([R("esri.views.3d.webgl-engine.effects.focusArea.FocusAreaColorNode")],_);const nt={bright:0,dark:1};let M=class extends K{constructor(){super(...arguments),this.origin=Pe}};function me(){const e=new Q;return e.attributes.add("position","vec3"),e.outputs.add("fragColor","vec4",0),e.vertex.uniforms.add(new Ke("proj",t=>t.camera.projectionMatrix),new Qe("view",(t,o)=>st(mt,o.camera.viewMatrix,t.origin))).main.add(x`gl_Position = proj * view * vec4(position, 1.0);
gl_Position.z = min(gl_Position.z, gl_Position.w);`),e.fragment.main.add(x`fragColor = vec4(1., 0., 0., 0.);`),e}const mt=S(),pt=Object.freeze(Object.defineProperty({__proto__:null,FocusAreaMaskDrawParameters:M,build:me},Symbol.toStringTag,{value:"Module"}));class X extends Y{constructor(t,o){super(t,o,new ee(pt,()=>se(()=>Promise.resolve().then(()=>dt),void 0)),tt(ie))}initializePipeline(){return te({colorWrite:re,depthTest:{func:515}})}}let g=class extends oe{constructor(e){super({...e,view:e.focusAreasView.view}),this.consumes={required:[I.TRANSPARENT]},this.produces=w.FOCUSAREA,this._vaos=new Array,this._counts=new Array,this._origins=new Array,this._maskParameters=new M}initialize(){this.updateGeometries()}destroy(){this._vaos.forEach(e=>e.dispose()),this._vaos.length=this._counts.length=this._origins.length=0}precompile(){this.techniques.precompile(X)}render(e){const t=this.techniques.get(X),o=this.bindParameters,m=o.camera,n=m.fullViewport[2],a=m.fullViewport[3];if(!t.compiled||!this._vaos)return void this.requestRender(1);const s=e.find(({name:p})=>p===I.TRANSPARENT),r=this.renderingContext,i=this.fboCache.acquire(n,a,w.FOCUSAREA,2);this.view.stage.renderer.occludedRequiresStencil?(i.acquireDepth(13),r.blitFramebuffer(s.fbo,i.fbo,256)):i.attachDepth(s.getAttachment(ae)),r.bindFramebuffer(i.fbo),r.setClearColor(0,0,0,1),r.clear(17408),r.setViewport(0,0,n,a);const f=r.bindTechnique(t,o);r.setFaceCullingEnabled(!1),r.setStencilTestEnabled(!0),r.setStencilOpSeparate(1028,7680,34055,7680),r.setStencilOpSeparate(1029,7680,34056,7680),r.setDepthWriteEnabled(!1);for(let p=0;p<this._vaos.length;p++){const c=this._vaos[p],h=this._counts[p];this._maskParameters.origin=this._origins[p],f.bindDraw(o,Ye,this._maskParameters),r.bindVAO(c),r.setDepthTestEnabled(!0),r.setStencilWriteMask(255),r.setStencilFunction(519,0,255),r.setColorMask(!1,!1,!1,!1),r.drawArrays(L.TRIANGLES,0,h),r.setDepthTestEnabled(!1),r.setStencilWriteMask(0),r.setStencilFunction(517,0,255),r.setColorMask(!0,!0,!0,!0),r.drawArrays(L.TRIANGLES,0,h)}return i}updateGeometries(){this.view.stage&&(this._vaos.forEach(e=>e.dispose()),this._vaos.length=this._counts.length=this._origins.length=0,this.focusAreasView.volumes.forEach(e=>{const t=new Array;let o=0,m=0;e.geometryVolumes.forEach(a=>{const s=a.indicesBottom;o+=s.length;for(let i=0;i<s.length;i++)t.push(a.positions[3*(s[i]-1)]),t.push(a.positions[3*(s[i]-1)+1]),t.push(a.positions[3*(s[i]-1)+2]);const r=a.indicesExtruded;m+=r.length;for(let i=0;i<r.length;i++)t.push(a.positions[3*r[i]]),t.push(a.positions[3*r[i]+1]),t.push(a.positions[3*r[i]+2])});const n=new Re(this.renderingContext,new et(this.renderingContext,ie,new Float32Array(t)));this._vaos.push(n),this._counts.push(o+m),this._origins.push(e.origin)}),this.requestRender(1))}};l([u()],g.prototype,"consumes",void 0),l([u()],g.prototype,"produces",void 0),l([u({constructOnly:!0})],g.prototype,"focusAreasView",void 0),g=l([R("esri.views.3d.webgl-engine.effects.focusArea.FocusAreaMaskNode")],g);let y=class extends J{constructor(e){super(e)}initialize(){this.addHandles([A(()=>this.area.enabled,()=>this._ensureElement(),E),A(()=>this.area.outline?.color,e=>this._updateColor(e),E),A(()=>this.area.geometries,e=>this._updateGeometries(e),E)])}destroy(){this.removeAllHandles(),this._outlineElement=H(this._outlineElement)}_ensureElement(){this.area.enabled&&this.area.outline?.color?this._outlineElement??=new rt({view:this.view,geometry:this._mergePolygons(this.area.geometries),isDraped:!0,attached:!0,isDecoration:!1,color:W.toUnitRGBA(this.area.outline?.color),renderOccluded:4,width:3}):this._outlineElement=H(this._outlineElement)}_updateGeometries(e){this._ensureElement(),this._outlineElement&&(this._outlineElement.geometry=this._mergePolygons(e))}_updateColor(e){this._ensureElement(),this._outlineElement&&e&&(this._outlineElement.color=W.toUnitRGBA(e))}_mergePolygons(e){if(!e||e.length===0)return null;const t=e.at(0).clone();return t.rings.length=0,e.forEach(o=>t.rings.push(...o.rings)),t}};l([u({constructOnly:!0})],y.prototype,"view",void 0),l([u({constructOnly:!0})],y.prototype,"area",void 0),y=l([R("esri.views.3d.webgl-engine.effects.focusArea.FocusAreaOutlineItem")],y);const lt=2e4;let P=class extends J{constructor(e){super(e),this._volumes=new Map,this._elevationContext=new Ce,this._outlineMap=new Ee}initialize(){this.addHandles([A(()=>({polygons:this.polygons,ready:this.view.basemapTerrain?.ready}),({polygons:e,ready:t})=>{t&&this._updateVolumes(e)},E)]),this._outlineMap=Oe(()=>this.areas?.areas,e=>new y({area:e,view:this.view}),{recycleItems:!0})}destroy(){this.removeAllHandles(),this._outlineMap.destroy()}get areas(){return this.view.map?.focusAreas}get enabledAreas(){return this.areas?.areas.toArray().filter(({enabled:e})=>e)??[]}get style(){return this.areas?.style??"bright"}get polygons(){return this.enabledAreas.reduce((e,t)=>e.concat(t.geometries.toArray()),new Array)}containsGeometry(e){if(this.polygons.length===0)return!0;const t=new Fe(e);return this.polygons.some(o=>o.contains(t))}_updateVolumes(e){this._extrude(e),this._ensureRenderNodes()}_extrude(e){if(!this.view.renderCoordsHelper||Ae(Array.from(this._volumes.keys()),e))return;const t=this.view.renderCoordsHelper,o=xe(),m=t.viewingMode===1,n=S(),a=S(),s=this.view.spatialReference,r=je(s),i=Se(s).radius/Te.radius,f=Me(5e5*i,"meters",s,!0);m||t.worldUpAtPosition([0,0,0],o);const p=new Map;for(const c of e){const h=this._volumes.get(c);if(h)p.set(c,h);else try{const d=s.equals(c.spatialReference)?c:ke(c,s),v=Math.max(d.extent.width,d.extent.height),pe=Ve(v,s,"meters",!0),C=Math.max(5*pe,lt*i),le=m?i/10:i,V=this._reduceGeometryHeight(d,C,le),O=Be(V);if(O==null)continue;const q=ze(V),ce=Ne(q,r,!1)??q,ue=De(ce,f,0,0),k=Ge(ue,s);if(k==null)continue;He(s,[O.x,O.y,0],n,t.spatialReference),a[12]=-n[12],a[13]=-n[13],a[14]=-n[14];const he=Le(k,this.view.elevationProvider,t,this._elevationContext),{polygons:de,mapPositions:fe,position:_e}=he,D=new Array,ge=new ct(D,[n[12],n[13],n[14]]);for(const b of de){const we=b.count,F=qe(b.mapPositions,b.holeIndices,3);if(F.length===0)continue;const N=F.length,j=6*we,ve=j+N,$=Ue(3*j),z=U(ve),G=U(N);We(_e,fe,F,b,$,null,null,null,z,G,C,o,m),Ie($,$,a);const ye=new ut($,G,z,C);D.push(ye)}p.set(c,ge)}catch(d){be.getLogger(this).error(new $e("focusareasview:projection-failed","Failed to project focus area geometry to view spatial reference",{geometry:c,error:d}))}}this._volumes=p,this.volumes.size!==0&&this._maskRenderNode?.updateGeometries()}_ensureRenderNodes(){if(this.view.stage)if(this.volumes.size===0){const{_maskRenderNode:e,_colorRenderNode:t}=this;this._maskRenderNode=this._colorRenderNode=null,t?.fadeOut(()=>{e?.destroy(),t?.destroy()})}else this._maskRenderNode??=new g({focusAreasView:this}),this._colorRenderNode??=new _({focusAreasView:this}),this.view.stage.renderView.requestRender()}_reduceGeometryHeight(e,t,o){const m=-12e5*o,n=Math.max(-t/2,m),a=e.rings.map(r=>r.map(i=>[i[0],i[1],n])),s=e.clone();return s.rings=a,s.hasZ=!0,s}get volumes(){return this._volumes}};l([u()],P.prototype,"_volumes",void 0),l([u({constructOnly:!0})],P.prototype,"view",void 0),P=l([R("esri.views.3d.FocusAreasView")],P);class ct{constructor(t,o){this.geometryVolumes=t,this.origin=o}}class ut{constructor(t,o,m,n){this.positions=t,this.indicesBottom=o,this.indicesExtruded=m,this.height=n}}const ht=Object.freeze(Object.defineProperty({__proto__:null,FocusAreaColorPassParameters:T,build:ne},Symbol.toStringTag,{value:"Module"})),dt=Object.freeze(Object.defineProperty({__proto__:null,FocusAreaMaskDrawParameters:M,build:me},Symbol.toStringTag,{value:"Module"}));export{P as FocusAreasView};
