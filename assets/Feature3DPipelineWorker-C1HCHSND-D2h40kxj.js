import{bS as $,bT as V,o as O,e as me,ab as Re,ch as Ae,q as Pe,ca as Se,aX as Te,l as Y,I as Oe,Y as w,H as C,G as he,i as Be}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{J as De,j as Le,o as je,I as Fe,r as Ee}from"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import{z as Me}from"./Extent-CgDMOSRD-Bod5LY6s.js";import{N as ke,W as Ue,b as Ge}from"./projectionUtils-BGH_5_I3-DGwchVO8.js";import{f as X}from"./Point-BfTTZoMu-DeJwQYfh.js";import{h as $e}from"./QueryEngine-J0SYKhS8-C5yUyj6A.js";import{o as Z}from"./Query-BlS0WPDF-jdXS_Qhy.js";import{r as Ve}from"./jsonUtils-BCGKNxno-DZ1Xr_O8.js";import{F as z}from"./Color-CERqXxxY-BuYn26eI.js";import{e as ze,h as K,c as Qe,t as He,f as Ne,j as qe}from"./PolygonSymbol3D-BXRHZiCQ-BjPAY2LA.js";import{p as Je}from"./ExtrudeSymbol3DLayer-DSc1ou2x-CsVYZCeG.js";import{n as B}from"./mat4f64-q_b6UJoq-Dh6sWB_w.js";import{t as U,r as Q,a as ee}from"./collectionUtils-jDyktm0P-BDP2Oq99.js";import{m as We,I as Ye}from"./vec4f64-DPb6J-GU-C7c2DqbZ.js";import{v as Xe,i as Ze,C as Ke,D as et,s as tt,u as rt,E as nt,S as it,K as st,F as at,I as ot}from"./RealisticTree.glsl-WN9nrQUl-QZiY3aPA.js";import{x as dt}from"./projectVectorToVector-Csv3NYZI-DpBtmQMN.js";import{O as lt,N as ct,d as ut,H as mt}from"./aaBoundingRect-CjwcS2F3-ri8bmh30.js";import{h as ht,U as ft}from"./Indices-D0_UQPPr-t1Qev6md.js";import{a as x}from"./orientedBoundingBox-BLEx7wLU-ByGP9QG1.js";import{k as pt,z as yt,G as _t,Y as gt,U as bt}from"./mat4-C96X-Nn0-BrMLOLCb.js";import{y as wt}from"./computeTranslationToOriginAndRotation-Bjd4esRf-vJ4LbdOU.js";import{z as Ct,l as It,Q as xt}from"./aaBoundingBox-Cn49X7ge-BcYPaJ58.js";import{a1 as vt,b6 as Rt,dc as te,cB as At,dd as re,de as Pt}from"./Texture-CFNZjV2R-CxGjQ8pI.js";import{H as ne}from"./asyncUtils-w6KfWU41-HenJ0UOu.js";import{l as ie}from"./ReactiveMap-B0by2bYu-DCsCfMj5.js";import{o as P,f as fe,i as St,a as Tt}from"./memoryEstimations-Bd726a_p-0cVCY2Jz.js";import{O as M}from"./utils-Dint_RG--BtjrWkNL.js";import{z as Ot,Q as pe}from"./PooledRBush-Dco5QkUp-DX3CMhf3.js";import{O as H,P as Bt}from"./OptimizedFeature-CwRGZPwv-Ddclhn0A.js";import{J as Dt}from"./query-DeNEvEsQ-DfFlUyui.js";import{h as Lt}from"./pbf-2SIhMekG-LK438LAR.js";import{p as jt}from"./quantizationUtils-Ceq-Uxsu-DjgKK_0s.js";import{m as Ft}from"./FieldsIndex-CimK-TqD--24JoCkp.js";import{B as Et,V as Mt}from"./pbfQueryUtils-DlZBMNQk-rXCy_evW.js";import"./index-B0z_nLWi.js";import"./Polyline-CoiTLswR-DTxpB2Yg.js";import"./Polygon-D6wEPb3W-D2MPjRU4.js";import"./mathUtils-PIGhLnI9-B1tKUlUb.js";import"./normalizeUtils-85zLqeMi-C1bdAKNn.js";import"./normalizeUtilsCommon-CnhQye_A-UWhaH-kt.js";import"./LRUCache-fy84PBMi-Y56WPIvD.js";import"./WhereClause-BSVqskBz-CT_IXPhv.js";import"./UnknownTimeZone-B697BDFv-CBbtul7O.js";import"./date-IqUzANpt-bLKO9IDT.js";import"./lengthUtils-Dt1_RvOO-j3MEdmHu.js";import"./fieldType-DVUzXtk_-tUuvnZJM.js";import"./FixedIntervalBinParameters-8snYOK8a-DXffLEh-.js";import"./NormalizationBinParametersMixin-BK9wNkI3-BKYeOhDN.js";import"./Layer-DZvC7bne-D3VLDrab.js";import"./vec42-B8VM4vXb-B6OGOEI9.js";import"./mat4f32-Djp3mnm5-DzYG3LYB.js";import"./intl-DRFqUect-DPhFaHB2.js";import"./ClassBreaksDefinition-BGOzyovZ-K0U0wKo_.js";import"./Scheduler-CNrsbccs-Bcg8fWoS.js";import"./typeUtils-DqrRcjBx-DZ6_Gsbu.js";import"./Field-Cm_ZejYW-CwJZmSru.js";import"./typeUtils-DDFS4uuz-B7KgP61w.js";import"./ClassBreaksRenderer-BvgdqtTq-D2fU8Sng.js";import"./commonProperties-DbO613LF-CHjBvYhj.js";import"./colorRamps-DswZzxkO-BqSFavfl.js";import"./ColorStop-De5gQTjr-C1lw16u9.js";import"./visualVariableUtils-ma4r7Z2K-Df6C3Hkh.js";import"./Graphic-DgGzDmqW-d1CNicxz.js";import"./getPopupProvider-CmskPttI-CzUWpGwk.js";import"./typeUtils-CXW_VpOn-BGgLp_TK.js";import"./lineMarkers-CDwLe3J6-CNUjJvs3.js";import"./SimpleFillSymbol-CDawtd9z-CWD2KI2D.js";import"./SimpleMarkerSymbol-BGAFRS9_-CVQ5NLIA.js";import"./PictureMarkerSymbol-CaSh-vZk-xhjZ61bb.js";import"./TextSymbol-hRGhyDHs-CoS7dSjf.js";import"./Font-BwmnW7d2-Dwh3xjKw.js";import"./defaults3D-C2hXSee1-CTj29-Ly.js";import"./defaults-BDN9qxeN-C-EfxQM4.js";import"./RendererLegendOptions-ByGHYLtx-Bwoo6l33.js";import"./SimpleRenderer-CEmCWePp-BJ25mYcH.js";import"./UniqueValueRenderer-JPjz9Qvs-Duu1CubQ.js";import"./vec2f64-rIxtbMRN-Kai9mK1i.js";import"./vec32-CewSdTn3-VRto2OOh.js";import"./BufferView-Cj2sQaht-avJ4OGB_.js";import"./Emissions.glsl-B8XKMjLy-DXfiRNVX.js";import"./InterleavedLayout-B7roQAzV-CdGz7mlm.js";import"./MeshLocalVertexSpace-BGd1IdEs-C0HJG4wR.js";import"./vec3f32-WCVSSNPR-9V6Uhrx-.js";import"./vector-B8ZDYGQ6-DRILJdcx.js";import"./quatf64-CCm9z-pX-CQ7_sSji.js";import"./sphere-DLQ6p7mp-DyEe1Vll.js";import"./spatialReferenceEllipsoidUtils-D2JabnKt-Ce3ED0lc.js";import"./frustum-CMzahy3--B-DC1Co-.js";import"./quat-B7J5v7rV-CZ9akUv-.js";import"./reader-DcGs6kKN-DHJfK-tm.js";import"./SimpleObservable-CvFyr0NA-DXpoMYph.js";import"./jsonUtils-CmpazY1u-6pDLj5sx.js";import"./featureConversionUtils-BDA_FXJx-CDxX1Wik.js";import"./OptimizedFeatureSet-BR8EEvDc-CgsRgxJh.js";import"./createFeatureId-CVwTD0fV-3fKpJDrk.js";import"./WhereClauseCache-B0L2SmwV-NVT3RoWW.js";import"./TimeOnly-BERR31kg-CQiLyUZi.js";import"./enum-BzLwmiID-CcyIdWlQ.js";import"./QueryEngineCapabilities-DJC_YILC-CshvWf3J.js";import"./utils-CUk96PkC-CJv0qCOi.js";import"./screenUtils-BitdhK1O-L0FLPAMi.js";import"./heatmapUtils-B-AXnq0l-BF3Q_jd2.js";import"./utils-BbtW4lHb-D1wApKS_.js";import"./timeZoneUtils-BSc7-7qA-BAv3h8mh.js";import"./utils-BEeBypEk-DQLTC4jR.js";import"./SnappingCandidate-DGkpYqI6-CfPvDre4.js";import"./opacityUtils-DuFH0EC9-DWspTgn2.js";import"./DoubleArray-DExKNiTh-CvVpHySW.js";import"./enums-B4pqBiXb-BO-3hS_8.js";import"./VertexElementDescriptor-BlxU8vCE-BwuKQkTU.js";import"./meshVertexSpaceUtils-CtG7DPVT-kybwngCt.js";import"./plane-BNdSPG2o-DTV5z6SO.js";import"./HUDIntersectorResult-1xTExS7z-dL9SFL6u.js";import"./Intersector-DS9YtyQY-DMoYp6i0.js";import"./projectPointToVector-DL7Z4uvb-CPbOlZdQ.js";import"./Cyclical-BLSxUpe7-Bj8R2Yk-.js";import"./utils-CylVuxNi--x86XOjU.js";import"./utils-Dpg4yj1D-CeFz2JVC.js";import"./videoUtils-Dwx3AEgj-CduhpDRk.js";import"./types-BKo2foNY-DE0QfIFp.js";import"./quickselect-QQC62dOK-Br2Ahhru.js";import"./queryZScale-CRP3Sh_E-F3y679Wx.js";import"./signal-BX9ezF8a-cf1Pn6io.js";import"./DictionaryScriptEvaluator-G73uSGpN-ErvAW-Hm.js";import"./Version-BtYZEj58-LyRHDnSJ.js";import"./ArcadeExpression-BlIRq-oN-VZkrwLVE.js";import"./utils-DX2muIr3-DiPfFKSl.js";import"./jsonUtils-C9q_FK4K-GRCbm_Pe.js";import"./layerUtils-DZGhvm-W-CfyHx1TZ.js";import"./defaultsJSON-GKolV7NZ-GKolV7NZ.js";import"./diffUtils-wTC1YzlE-DCTUTUs8.js";import"./styleUtils-DWvicjTN-DL6_BIk4.js";let I=class ye{constructor(e,r,n){this.renderCommandContext=e,this.renderCommandBuffer=r,this.pipelineStateCommands=n}append(e){this.appendRenderCommands(e.renderCommandBuffer),this.appendPipelineStateCommands(e.pipelineStateCommands)}appendRenderCommands(e){this.renderCommandBuffer.commands.push(...e.commands),this.renderCommandBuffer.transferList.push(...e.transferList)}appendPipelineStateCommand(e){this.pipelineStateCommands.push(e)}appendPipelineStateCommands(e){for(const r of e)this.appendPipelineStateCommand(r)}async execute(){for(const e of this.pipelineStateCommands)e();await this.renderCommandContext.dispatchRenderCommands(this.renderCommandBuffer)}static create(e,r=[]){return new ye(e,e.createRenderCommandBuffer(),r)}};function kt(t){return t.length===0?null:t.reduce((e,r)=>(e.append(r),e))}function _e(){return new ze({material:new Je({color:new z("red")})})}function Ut(){return new Ne}function W(t){const{featureCount:e}=t;if(e===0)return new Uint32Array;const r=new Uint32Array(e);return t.getObjectIdsArray(r),r}function N(t){const{featureCount:e}=t;if(e===0)return new Float64Array;const r=new Float64Array(3*e);return t.getCoordinatesArray(r),r}function Gt(t,e){const r=t.length/3,n=e.viewSpatialReference,i=e.renderSpatialReference,s=new Float64Array(3*r);if(!Ge(t,n,0,s,i,0,r))throw new Error("Failed to project coordinates");return s}function se(t,e){const r=e.viewSpatialReference,n=e.renderSpatialReference,{extent:i}=t,s=mt(i),a=U();return dt([s[0],s[1],0],r,a,n),a}function ge(t){const e=new Map;for(const[r,n]of t)e.set(r,{...n,indices:ft(n.indices)});return e}let q=class{constructor(t,e){this._context=null,this._symbolLayer=null,this._draped=!1,this._loaded=!1,this._loadingPromise=null,this._iconTextureID=null,this._materialId=null,this._context=e,this._symbolLayer=t}get loaded(){return this._loaded}load(){return this._loadingPromise==null&&(this._loadingPromise=this._load()),this._loadingPromise}_destroy(){this._iconTextureID=null}async _load(){const t=this._context.renderCommandContext,e=await t.createTexture(()=>Ke("circle"));this._iconTextureID=e;const r={anchorPosition:et.center,occlusionTest:!0,hasSlicePlane:!1,color:this._getFillColor(),outlineColor:this._getOutlineColor(),outlineSize:1,distanceFieldBoundingBox:rt,textureId:e,textureIsSignedDistanceField:!0,sampleSignedDistanceFieldTexelCenter:tt("circle")},n=new Uint8Array(8),i=0,s=255;n[0]=i,n[1]=i,n[2]=i,n[3]=s,n[4]=s,n[5]=i,n[6]=s,n[7]=s,this._materialId=await t.createMaterial({type:"hud",parameters:r}),await t.createDirectRenderer(this._materialId),await t.setBaseInstance(this._materialId,{data:n.buffer,elementCount:4}),this._loaded=!0}async createAddCommand(t){const{_materialId:e,_context:r}=this,{renderCommandContext:n}=r;if(e==null)throw new Error("expected material not to be null");const i=await this._createGeometry(t);if(i==null)return r.createPipelineCommand();const s=se(t,r);return r.createPipelineCommand(n.addDirectRendererGeometry(t.id,i,s,!0))}async _createGeometry(t){const{_materialId:e,_context:r}=this,{mainThreadDelegate:n}=r,{featureCount:i}=t;if(i===0||e==null)return null;const s=W(t),a=N(t),o=await n.applyElevationAlignmentTo(a),l=Gt(o,r),u=new Float64Array([0,0,1]),m=new Float64Array([255,255,255,255]),d=new Float64Array([24,24]),c=new Float64Array([0,0,0,1]),f=new Float64Array([0]),_=new Uint32Array(i);for(let p=0;p<i;++p)_[p]=p;const h=new Uint32Array(i);for(let p=0;p<i;++p)h[p]=0;const y=[["position",new x(l,_,3,!0)],["normal",new x(u,h,3,!0)],["color",new x(m,h,4,!0)],["rotation",new x(f,h,1,!0)],["size",new x(d,h,2,!0)],["centerOffsetAndDistance",new x(c,h,4,!0)]],g=new Uint8Array(i);return t.getVisibilityArray(g),{attributes:ge(y),olidColor:void 0,transformation:B(),materialId:e,objectIds:s,visibilities:g}}async createRemoveCommand(t){const{_materialId:e,_context:r}=this,n=r.renderCommandContext;return e==null?r.createPipelineCommand():r.createPipelineCommand(n.removeDirectRendererGeometryBuffer(e,t))}async createUpdateVisibilityCommand(t){const{_materialId:e,_context:r}=this,n=r.renderCommandContext;if(e==null)return r.createPipelineCommand();const i=new Uint8Array(t.featureCount);return t.getVisibilityArray(i),r.createPipelineCommand(n.updateVisibility(e,t.id,i))}async createUpdateLayerViewOpacityCommand(t){const{_context:e,_materialId:r}=this,n=e.renderCommandContext;return r==null?e.createPipelineCommand():e.createPipelineCommand(n.updateMaterial({type:"hud",materialId:r,parameters:{color:this._getFillColor(),outlineColor:this._getOutlineColor()}}))}async createUpdateElevationCommand(t){const{_materialId:e,_context:r}=this,{renderCommandContext:n}=r,{featureCount:i,id:s}=t;if(e==null||i===0)return r.createPipelineCommand();const a=await this._createGeometry(t);if(a==null)return r.createPipelineCommand();const o=se(t,r);return r.createPipelineCommand(n.updateDirectRendererGeometry(s,a,o,!0))}async createDestroyCommand(){const{_iconTextureID:t,_context:e}=this,r=e.renderCommandContext;let n;return n=t!=null?await r.releaseTexture(t):I.create(r),n.appendPipelineStateCommand(()=>this._destroy()),n}_getOutlineColor(){const t=this._getLayerOpacity(),e=this._symbolLayer,r=e?.outline?.color;if(r!=null){const n=z.toUnitRGB(r),i=r.a*t;return[n[0],n[1],n[2],i]}return[0,0,0,0]}_getFillColor(){if($t(this._getPrimitive()))return zt;const t=this._getPrimitive()==null,e=this._symbolLayer?.material?.color;return this._getCombinedOpacityAndColor(e,{hasIntrinsicColor:t})}_getLayerOpacity(){return this._context.layerViewInfo.fullOpacity}_getCombinedOpacity(t,e=ae){const r=this._draped?1:this._getLayerOpacity();return t?r*t.a:e.hasIntrinsicColor?r:0}_getCombinedOpacityAndColor(t,e=ae){const r=this._getCombinedOpacity(t,e),n=t!=null?z.toUnitRGB(t):Q;return nt(n,r)}_getPrimitive(){return Vt(this._symbolLayer)}};function $t(t){return t!=null&&(t==="cross"||t==="x")}function Vt(t){return t.resource?.href?null:t.resource?.primitive??qe}const ae={hasIntrinsicColor:!1},zt=We;let Qt=class{constructor(t,e){this._loaded=!1,this._loadingPromise=null,this._context=null,this._symbol=null,this._symbolLayerRenderers=[],this._context=e,this._symbol=t}_destroy(){}get loaded(){return this._loaded}load(){return this._loadingPromise==null&&(this._loadingPromise=this._load()),this._loadingPromise}async _load(){const{_context:t,_symbol:e,_symbolLayerRenderers:r}=this,n=[];for(const i of e.symbolLayers){const s=t.symbolRendererFactory.createSymbolRendererFromSymbolLayer(i);s!=null&&(n.push(s.load()),r.push(s))}await Promise.all(n),this._loaded=!0}async createDestroyCommand(){const{_context:t,_symbolLayerRenderers:e}=this,r=[];for(const i of e)r.push(i.createDestroyCommand());const n=t.joinPipelineCommands(await Promise.all(r));return n.appendPipelineStateCommand(()=>this._destroy()),n}async createAddCommand(t){const{_context:e,_symbolLayerRenderers:r}=this,n=[];for(const i of r)n.push(i.createAddCommand(t));return e.joinPipelineCommands(await Promise.all(n))}async createRemoveCommand(t){const{_context:e,_symbolLayerRenderers:r}=this,n=[];for(const i of r)n.push(i.createRemoveCommand(t));return e.joinPipelineCommands(await Promise.all(n))}async createUpdateVisibilityCommand(t){const{_context:e,_symbolLayerRenderers:r}=this,n=[];for(const i of r)n.push(i.createUpdateVisibilityCommand(t));return e.joinPipelineCommands(await Promise.all(n))}async createUpdateLayerViewOpacityCommand(t){const{_context:e,_symbolLayerRenderers:r}=this,n=[];for(const i of r)n.push(i.createUpdateLayerViewOpacityCommand(t));return e.joinPipelineCommands(await Promise.all(n))}async createUpdateElevationCommand(t){const{_context:e,_symbolLayerRenderers:r}=this,n=[];for(const i of r)n.push(i.createUpdateElevationCommand(t));return e.joinPipelineCommands(await Promise.all(n))}},Ht=class{constructor(t,e){this._symbol=null,this._featureData=new Map,this._loaded=!1,this._loadingPromise=null,this._renderer=null,this._context=e,this._renderer=t}async load(){return this._loadingPromise==null&&(this._loadingPromise=this._load()),this._loadingPromise}async _load(){const{_renderer:t,_context:e}=this;this._symbol=e.symbolRendererFactory.createSymbolRendererFromSymbol(t.symbol),this._loaded=!0}get loaded(){return this._loaded}async createAddCommand(t){const e=this._context,r=await this._provisionSymbol(),n=r==null?e.createPipelineCommand():await r.createAddCommand(t);return n.appendPipelineStateCommand(()=>this._featureData.set(t.id,t)),n}async createRemoveCommand(t){const e=this._context,r=await this._provisionSymbol(),n=r==null?e.createPipelineCommand():await r.createRemoveCommand(t);return n.appendPipelineStateCommand(()=>this._featureData.delete(t)),n}async createUpdateVisibilityCommand(t){const e=this._context,r=await this._provisionSymbol();return r==null?e.createPipelineCommand():await r.createUpdateVisibilityCommand(t)}async createUpdateLayerViewOpacityCommand(t){const e=this._context,r=await this._provisionSymbol();return r==null?e.createPipelineCommand():await r.createUpdateLayerViewOpacityCommand(t)}async createUpdateElevationCommand(){const{_featureData:t,_context:e}=this,r=await this._provisionSymbol();if(r==null)return e.createPipelineCommand();const n=[];for(const s of t.values())n.push(r.createUpdateElevationCommand(s));const i=await Promise.all(n);return e.joinPipelineCommands(i)}async createDestroyCommand(){const{_symbol:t,_context:e,_featureData:r}=this;if(!t)return e.createPipelineCommand();const n=[];for(const s of r.keys())n.push(this.createRemoveCommand(s));n.push(t.createDestroyCommand());const i=await Promise.all(n);return e.joinPipelineCommands(i)}async _provisionSymbol(){const t=this._symbol;return t?(t.loaded||await t.load(),t):null}};function Nt(t,e){const r=(n,i,s=!1)=>({levels:n.map(a=>{const o=ge(i(a.tesselation));return s&&qt(o),{components:[{attributes:o,olidColor:void 0,transformation:null,materialId:e,visibilities:new Uint8Array([1]),objectIds:new Uint32Array([-1])}],minScreenSpaceRadius:a.minScreenSpaceRadius}})});switch(t){case"cone":return r(Jt,n=>ot(1,.5,n,!1),!0);case"sphere":return r([{tesselation:0,minScreenSpaceRadius:0},{tesselation:1,minScreenSpaceRadius:8},{tesselation:2,minScreenSpaceRadius:16},{tesselation:3,minScreenSpaceRadius:50},{tesselation:4,minScreenSpaceRadius:250}],n=>at(.5,n,!0));case"cube":case"inverted-cone":case"cylinder":case"tetrahedron":case"diamond":throw new Error("not implemented");default:return}}function qt(t){const e=t,r=e.get("position").data,n=e.get("normal").data;if(n){const i=oe(t,"normal").data;for(let s=0;s<n.length;s+=3){const a=n[s+1];i[s+1]=-n[s+2],i[s+2]=a}}if(r){const i=oe(t,"position").data;for(let s=0;s<r.length;s+=3){const a=r[s+1];i[s+1]=-r[s+2],i[s+2]=a}}}function oe(t,e){let r=t.get(e);return r&&!r.exclusive&&(r={...r,exclusive:!0,data:Pt(r.data)},t.set(e,r)),r}const Jt=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];let Wt=class{constructor(t,e){this._loaded=!1,this._loadingPromise=null,this._primitiveMaterialId=null,this._lodRendererId=null,this._context=null,this._symbolLayer=null,this._primitive=null,this._context=e,this._symbolLayer=t}_destroy(){this._lodRendererId=null,this._primitiveMaterialId=null}get loaded(){return this._loaded}get _isPrimitive(){return this._primitive!=null}load(){return this._loadingPromise==null&&(this._loadingPromise=this._load()),this._loadingPromise}async _load(){const t=this._context.renderCommandContext,e={physicalBasedRenderingEnabled:!0,slicePlaneEnabled:!1,castShadows:!0},r=this._getLayerOpacity();let n={usePBR:e.physicalBasedRenderingEnabled,isSchematic:!0,mrrFactors:At,ambient:Q,diffuse:Q,hasSlicePlane:e.slicePlaneEnabled,castShadows:e.castShadows,layerOpacity:r,offsetTransparentBackfaces:!1,screenSizePerspective:{}};if(n.externalColor=Ye,n.instanced=!0,this._isPrimitive){const o=new te;o.layerOpacity=r,n={...n,cullFace:de(re(o))}}const i=await t.createMaterial({type:"default",parameters:n}),s=this._symbolLayer.resource;this._primitive=s&&it(s?.primitive)?s.primitive:K;const a=Nt(this._primitive,i);this._lodRendererId=await t.createLodRenderer(a),this._primitiveMaterialId=i,this._loaded=!0}async createDestroyCommand(){const{_lodRendererId:t,_primitiveMaterialId:e,_context:r}=this,n=r.renderCommandContext,i=[];return t!=null&&i.push(n.destroyLodRenderer(t)),e!=null&&i.push(n.destroyMaterial(e)),new I(n,n.mergeRenderCommandBuffers(i),[()=>this._destroy()])}async createAddCommand(t){const e=this._context,{renderCommandContext:r,mainThreadDelegate:n}=e;if(this._lodRendererId==null)throw new Error("expected lod renderer id to not be null");const{featureCount:i}=t;if(i===0)return e.createPipelineCommand();const s=this._isPrimitive,a=this._primitive||K,o=It(Qe(a)),l=ee(xt(o)),u=ee(He(l,{isPrimitive:s,width:100,depth:null,height:null})),m=new Float64Array(16*i),d=new Float64Array(16*i),c=N(t),f=await n.applyElevationAlignmentTo(c);for(let g=0;g<i;++g){const p=g,G=f[3*g+0],Ce=f[3*g+1],Ie=f[3*g+2],xe=this._computeGlobalTransform(G,Ce,Ie,this._context.viewSpatialReference,le),ve=this._computeLocalTransform(u,l,Yt);this._writeMatrixToTypedBuffer(m,p,ve),this._writeMatrixToTypedBuffer(d,p,xe)}const _=W(t),h=new Uint8Array(i);t.getVisibilityArray(h);const y={featureIds:new Uint32Array(_),visibility:h,localTransforms:m,globalTransforms:d};return e.createPipelineCommand(r.addLodInstances(this._lodRendererId,t.id,y))}async createRemoveCommand(t){const{_context:e,_lodRendererId:r}=this,n=e.renderCommandContext;return r==null?e.createPipelineCommand():e.createPipelineCommand(n.removeLodInstances(r,t))}async createUpdateVisibilityCommand(t){const{_lodRendererId:e,_context:r}=this,n=r.renderCommandContext;if(e==null)return r.createPipelineCommand();const i=new Uint8Array(t.featureCount);return t.getVisibilityArray(i),r.createPipelineCommand(n.updateVisibility(e,t.id,i))}async createUpdateLayerViewOpacityCommand(t){const{_context:e}=this,r=e.renderCommandContext,n=this._primitiveMaterialId;if(n==null)return e.createPipelineCommand();const i=this._getLayerOpacity();let s={layerOpacity:i};if(this._isPrimitive){const a=new te;a.layerOpacity=i,s={...s,cullFace:de(re(a))}}return e.createPipelineCommand(r.updateMaterial({type:"default",materialId:n,parameters:s}))}async createUpdateElevationCommand(t){const{_context:e,_lodRendererId:r}=this,{renderCommandContext:n,mainThreadDelegate:i}=e,{featureCount:s,id:a}=t;if(r==null||s===0)return e.createPipelineCommand();const o=new Float64Array(16*s),l=N(t),u=await i.applyElevationAlignmentTo(l);for(let m=0;m<s;++m){const d=m,c=u[3*m+0],f=u[3*m+1],_=u[3*m+2],h=this._computeGlobalTransform(c,f,_,this._context.viewSpatialReference,le);this._writeMatrixToTypedBuffer(o,d,h)}return e.createPipelineCommand(n.updateLodInstancesData(r,a,o))}_writeMatrixToTypedBuffer(t,e,r){let n=16*e;for(let i=0;i<16;i++)t[n++]=r[i]}_computeGlobalTransform(t,e,r,n,i){return D[0]=t,D[1]=e,D[2]=r,wt(n,D,i,this._context.renderSpatialReference),i}_computeLocalTransform(t,e,r){return gt(r),this._applyObjectScale(t,e,r),r}_applyObjectScale(t,e,r){const n=st(t,t,e,this._context.renderCoordsHelper.unitInMeters);n[0]===1&&n[1]===1&&n[2]===1||bt(r,r,n)}_getLayerOpacity(){return this._context.layerViewInfo.fullOpacity}};function de(t){return t?0:2}const D=U(),Yt=B(),le=B();let Xt=class{constructor(t,e){this._symbols=new Array,this._featureDataPartitioning=new Map,this._loaded=!1,this._loadingPromise=null,this._renderer=null,this._context=e,this._renderer=t}async load(){return this._loadingPromise==null&&(this._loadingPromise=this._load()),this._loadingPromise}async _load(){this._symbols[0]=new q(_e(),this._context),this._symbols[1]=new Wt(Ut(),this._context),this._loaded=!0}get loaded(){return this._loaded}async createAddCommand(t){const e=this._context,r=this._partition(t),n=await Promise.all(r.map(async({index:s,features:a})=>await(await this._provisionSymbol(s))?.createAddCommand(a))),i=e.joinPipelineCommands(n);return i.appendPipelineStateCommand(()=>this._featureDataPartitioning.set(t.id,r)),i}async createRemoveCommand(t){const{_featureDataPartitioning:e,_context:r}=this,n=r.renderCommandContext,i=e.get(t);if(i==null)return new I(n,n.createRenderCommandBuffer(),[]);const s=await Promise.all(i.map(async({index:o,features:l})=>await this._getLoadedSymbol(o)?.createRemoveCommand(l.id))),a=r.joinPipelineCommands(s);return a.appendPipelineStateCommand(()=>e.delete(t)),a}async createUpdateVisibilityCommand(t){const{_featureDataPartitioning:e,_context:r}=this,n=r.renderCommandContext,i=e.get(t.id);if(i==null)return new I(n,n.createRenderCommandBuffer(),[]);const s=await Promise.all(i.map(async({index:a,features:o})=>await this._getLoadedSymbol(a)?.createUpdateVisibilityCommand(o)));return r.joinPipelineCommands(s)}async createUpdateLayerViewOpacityCommand(t){const e=this._context,r=[];for(let i=0;i<this._symbols.length;++i){const s=this._symbols[i];s!=null&&s.loaded&&r.push(s.createUpdateLayerViewOpacityCommand(t))}const n=await Promise.all(r);return e.joinPipelineCommands(n)}async createUpdateElevationCommand(){const{_featureDataPartitioning:t,_context:e}=this,r=[];for(const i of t.values()){const s=i.map(async({index:a,features:o})=>await this._getLoadedSymbol(a)?.createUpdateElevationCommand(o));r.push(...s)}const n=await Promise.all(r);return e.joinPipelineCommands(n)}async createDestroyCommand(){const{_featureDataPartitioning:t,_context:e}=this,r=[];for(const i of t.keys())r.push(this.createRemoveCommand(i));for(const i of this._symbols)r.push(i.createDestroyCommand());const n=await Promise.all(r);return e.joinPipelineCommands(n)}async _provisionSymbol(t){if(t==null)return null;const e=this._symbols[t];return e?(e.loaded||await e.load(),e):null}_getLoadedSymbol(t){if(t==null)return null;const e=this._symbols[t];return e!=null&&e.loaded?e:null}_partition(t){const e=W(t);if(e==null)throw new Error("unable to fetch objectIds");const{featureCount:r}=t,n=[[],[]];for(let i=0;i<r;++i)n[e[i]%2].push(i);return n.map((i,s)=>new Zt(s,t.subset(new Uint32Array(i)))).filter(i=>i.features.featureCount>0)}};class Zt{constructor(e,r){this.index=e,this.features=r}}let Kt=class{constructor(t,e,r,n,i,s,a){this.viewSpatialReference=t,this.renderSpatialReference=e,this.mainThreadDelegate=r,this.renderCoordsHelper=n,this.renderCommandContext=i,this.layerInfo=s,this.layerViewInfo=a,this.symbolRendererFactory=new er(this)}createPipelineCommand(t=this.renderCommandContext.createRenderCommandBuffer(),e=[]){return new I(this.renderCommandContext,t,e)}joinPipelineCommands(t){return t.length===0?this.createPipelineCommand():t.filter(e=>e!=null).reduce((e,r)=>(e.append(r),e))}},er=class{constructor(t){this.context=t}createSymbolRendererFromJSON(t){const e=Ve(t??ce)??void 0;if(!e)throw new Error("Failed to create renderer");const r=e.type;switch(r){case"simple":return new Ht(e,this.context);case"unique-value":return new Xt(e,this.context);default:return console.warn(`Unable to create symbolrenderer for renderer of ${r}`),this.createSymbolRendererFromJSON(ce)}}createSymbolRendererFromSymbol(t){const e=t?.type;switch(e){case"point-3d":return new Qt(t,this.context);case"picture-marker":case"simple-marker":return new q(_e(),this.context);default:return console.warn(`Unable to create symbolrenderer for symbol of ${e}`),null}}createSymbolRendererFromSymbolLayer(t){const e=t.type;return e==="icon"?new q(t,this.context):(console.warn(`Unable to create symbolrenderer for symbolLayer of ${e}`),null)}};const ce={type:"simple"};let tr=class be{constructor(e,r){this._parent=e,this._subsetIndices=r,this.id=M(`featureDataSubset-${e.id}-`)}get tileId(){return this._parent.tileId}get extent(){return this._parent.extent}get featureCount(){return this._subsetIndices.length}get usedMemory(){return this._parent.usedMemory+P+this._subsetIndices.byteLength}get isFullyEnabled(){for(const e of this._subsetIndices)if(!this._parent.getEnabled(e))return!1;return!0}getObjectId(e){return this._parent.getObjectId(this._subsetIndices[e])}getAttribute(e,r){return this._parent.getAttribute(this._subsetIndices[e],r)}getAttributeAsTimestamp(e,r){return this._parent.getAttribute(this._subsetIndices[e],r)}getAttributes(e){return this._parent.getAttributes(this._subsetIndices[e])}getCoordinates(e,r,n){return this._parent.getCoordinates(this._subsetIndices[e],r,n)}getOptimizedGeometry(e){return this._parent.getOptimizedGeometry(this._subsetIndices[e])}getCentroid(e,r){return this._parent.getCentroid(this._subsetIndices[e],r)}getBounds(e){return this._parent.getBounds(this._subsetIndices[e])}getBoundingBox(e){return this._parent.getBoundingBox(this._subsetIndices[e])}getObjectIdsArray(e,r,n){return this._parent.getObjectIdsArray(e,this._translatedIndices(r),n)}getCoordinatesArray(e,r,n){return this._parent.getCoordinatesArray(e,this._translatedIndices(r),n)}objectIds(e){return this._parent.objectIds(this._translatedIndices(e))}subset(e){const{_subsetIndices:r}=this,n=new Uint32Array(e.length);for(let i=0;i<n.length;++i)n[i]=r[e[i]];return new be(this._parent,n)}disableObjectIds(e){if(e.size===0)return;const{featureCount:r}=this,n=new Array;for(let i=0;i<r;++i)this.getEnabled(i)&&e.has(this.getObjectId(i))&&n.push(i);if(n.length!==0)for(const i of n)this.setEnabled(i,!1)}setEnabled(e,r){this._parent.setEnabled(this._subsetIndices[e],r)}getEnabled(e){return this._parent.getEnabled(this._subsetIndices[e])}enableAll(){const{_subsetIndices:e,_parent:r}=this;for(const n of e)r.setEnabled(n,!0)}getVisibilityArray(e,r,n){return this._parent.getVisibilityArray(e,this._translatedIndices(r),n)}enabledObjectIds(e){return this._parent.enabledObjectIds(this._translatedIndices(e))}*_translatedIndices(e){const{_subsetIndices:r}=this;if(e!=null)for(const n of e)yield r[n];else yield*r}};class rr{constructor(e){this._tile=e,this.id=M(`featureData-${e.id}-`),this._enabled=new Array(e.featureCount).fill(!0)}get tileId(){return this._tile.id}get featureCount(){return this._tile.featureCount}get usedMemory(){return P+Tt(this.id)}get extent(){return this._tile.descriptor.extent}get isFullyEnabled(){return this._enabled.every(e=>e)}getObjectId(e){return this._tile.getObjectId(e)}getAttribute(e,r){return this._tile.getAttribute(e,r)}getAttributeAsTimestamp(e,r){return this._tile.getAttribute(e,r)}getAttributes(e){return this._tile.getAttributes(e)}getCoordinates(e,r,n){return this._tile.getCoordinates(e,r,n)}getOptimizedGeometry(e){return this._tile.getOptimizedGeometry(e)}getCentroid(e,r){return this._tile.getCentroid(e,r)}getBounds(e){return this._tile.getBounds(e)}getBoundingBox(e){return this._tile.getBoundingBox(e)}getObjectIdsArray(e,r,n){return this._tile.getObjectIdsArray(e,r,n)}getCoordinatesArray(e,r,n){return this._tile.getCoordinatesArray(e,r,n)}objectIds(e){return this._tile.objectIds(e)}subset(e){return new tr(this,e)}disableObjectIds(e){if(e.size===0)return;const{_enabled:r}=this,n=new Array;for(const i of this._allFeatureIndices())r[i]&&e.has(this.getObjectId(i))&&n.push(i);if(n.length!==0)for(const i of n)r[i]=!1}setEnabled(e,r){this._enabled[e]=r}getEnabled(e){return this._enabled[e]}enableAll(){this._enabled.fill(!0)}getVisibilityArray(e,r=this._allFeatureIndices(),n=0){const{_enabled:i}=this;for(const s of r)e[n++]=Number(i[s]);return n}*enabledObjectIds(e=this._allFeatureIndices()){const{_enabled:r}=this;for(const n of e)r[n]&&(yield this.getObjectId(n))}*_allFeatureIndices(){const{featureCount:e}=this;for(let r=0;r<e;++r)yield r}}let b=class extends Pe{constructor(t){super(t),this.extent=null,this._tileHandles=new ie,this._wanted=new ie,this._updateRequested=!1,this._synchronizationTask=null,this._requestedTiles=new Array}destroy(){this._tileHandles.clear(),this._wanted.clear()}get updating(){return this._updateRequested||!(this._synchronizationTask?.finished??1)}get _boundingRect(){const{extent:t}=this;return t==null?null:ct(t)}get _missingTiles(){const t=new Array,e=this._wanted,r=this._tileHandles;for(const n of e.values())r.get(n.id)?.featureData==null&&t.push(n);return t}onTileTreeChange({tiles:t}){this._requestedTiles=t,this._scheduleTilesSync()}_scheduleTilesSync(){if(this._updateRequested)return;this._updateRequested=!0;const t=this._synchronizationTask,e=ne(async()=>{try{await Ee(()=>t?.finished??!0),await Se(),this._updateRequested=!1,await this._synchronizeTiles()}finally{this._synchronizationTask===e&&(this._synchronizationTask=null)}});this._synchronizationTask=e}async _synchronizeTiles(){const t=this._requestedTiles,e=this._tileHandles,r=new Array;for(const d of t)e.has(d.id)||r.push(d);const n=new Array;for(const d of e.values()){const{id:c}=d;t.every(f=>f.id!==c)&&n.push(d.descriptor)}const i=this._tileHandles,{_boundingRect:s}=this,a=s!=null?r.filter(d=>!d.extent||ut(s,d.extent)):r,o=this._wanted,l=new Array;for(const{id:d}of n)o.delete(d);for(const d of a)o.set(d.id,d);const u=this._missingTiles;for(const d of n){const{id:c}=d;if(u.some(_=>v(_,d)||v(d,_)))continue;const f=i.get(c);f!=null&&l.push(this._removeTile(f))}for(const d of a)l.push(this._addTile(d));const m=await Promise.allSettled(l);for(const d of m)d.status==="rejected"&&console.error(d.reason)}forEachTile(t){for(const e of this._tileHandles.values()){const r=e.featureData;r!=null&&t(r)}}*loadedTiles(){for(const t of this._tileHandles.values()){const e=t.featureData;e!=null&&(yield e)}}async _removeTile(t){t.loadTask.abort(),this._tileHandles.delete(t.id),this._validate();const{featureData:e}=t;if(e!=null){const r={stack:[],error:void 0,hasError:!1};try{$(r,await this.tileLocks.lock([e.tileId]),!1),await(await this.createRemoveCommand(e.id))?.execute()}catch(n){r.error=n,r.hasError=!0}finally{V(r)}}}async _addTile(t){const{_tileHandles:e}=this,r=e.get(t.id);if(r!=null)return!F(r)||r.featureData.isFullyEnabled?void 0:(r.featureData.enableAll(),void await this._onTileLoad(r));const n=new nr(t,ne(async i=>{const s=await this.loadTile(t,i);return O(i),new rr(s)}));this._tileHandles.set(n.id,n);try{await n.loadTask.promise}catch(i){return void Te(i)}ir(n),await this._onTileLoad(n)}async _onTileLoad(t){const e={stack:[],error:void 0,hasError:!1};try{const{_wanted:r,_tileHandles:n,_missingTiles:i}=this,s=t.descriptor,a=new Array,o=new Array,l=new Array,u=new Set;for(const h of n.values()){if(h===t)continue;const{descriptor:y,id:g}=h;if(!(r.has(g)||i.some(p=>v(p,y)||v(y,p)))){n.delete(g),h.loadTask.abort();const{featureData:p}=h;p!=null&&a.push(p);continue}if(F(h)){if(v(s,y)){const p=h.featureData;for(const G of p.objectIds())u.add(G)}if(v(y,s)){const{featureData:p}=h;o.push(p)}}}u.size>0&&(t.featureData.disableObjectIds(u),this._validateRemoval(t.featureData,u)),this._validate(),l.push(t.featureData);const m=[...l,...a,...o].map(h=>h.tileId);if($(e,await this.tileLocks.lock(m),!1),o.length!==0){const h=t.featureData,y=new Set(h.objectIds());for(const g of o)g.disableObjectIds(y),this._validateRemoval(g,y)}const d=a.map(h=>this.createRemoveCommand(h.id)),c=l.map(h=>this.createAddCommand(h)),f=o.map(h=>this.createUpdateCommand(h)),_=await Promise.all([...d,...c,...f]);await kt(_.filter(me))?.execute()}catch(r){e.error=r,e.hasError=!0}finally{V(e)}}_validate(){if(!Y("feature-pipeline-3d-test-validation"))return;const t=new Array;for(const e of this._tileHandles.values()){if(!F(e))continue;const{featureData:r}=e;t.push({featureData:r,objectIds:new Set(r.enabledObjectIds())})}for(let e=0;e<t.length;++e){const{featureData:r,objectIds:n}=t[e];for(let i=e+1;i<t.length;++i){const{featureData:s,objectIds:a}=t[i];for(const o of a)if(n.has(o))throw new Error(`${r.id} and ${s.id} both contain ${o}.`)}}}_validateRemoval(t,e){if(Y("feature-pipeline-3d-test-validation")){for(const r of t.enabledObjectIds())if(e.has(r))throw new Error(`Failed to remove ${r} from ${t.id}!`)}}};function v({lij:[t,e,r]},{lij:[n,i,s]}){const a=n-t;return a>=0&&e===i>>a&&r===s>>a}w([C()],b.prototype,"updating",null),w([C({constructOnly:!0})],b.prototype,"loadTile",void 0),w([C({constructOnly:!0})],b.prototype,"createAddCommand",void 0),w([C({constructOnly:!0})],b.prototype,"createRemoveCommand",void 0),w([C({constructOnly:!0})],b.prototype,"createUpdateCommand",void 0),w([C({constructOnly:!0})],b.prototype,"tileLocks",void 0),w([C()],b.prototype,"extent",void 0),w([C()],b.prototype,"_boundingRect",null),w([C()],b.prototype,"_missingTiles",null),w([C()],b.prototype,"_updateRequested",void 0),w([C()],b.prototype,"_synchronizationTask",void 0),b=w([he("esri.views.3d.layers.graphics.pipeline.Tile3DManager")],b);class nr{constructor(e,r){this.descriptor=e,this.loadTask=r}get id(){return this.descriptor.id}get featureData(){return this.loadTask.value}}function F(t){return t.featureData!=null}function ir(t){if(!F(t))throw new Error}class sr{constructor(){this._previousActions=new Map}async lock(e){const{_previousActions:r}=this,n=e.map(l=>r.get(l)).filter(me),i=Promise.allSettled(n),s=Re(),a=Be(()=>s.resolve()),o=s.promise.finally(()=>{for(const l of e)r.get(l)===o&&r.delete(l)});for(const l of e)r.set(l,o);return await i,Ae(a)}}let J=class{constructor(t,e){this._index=t,this._view=e}get usedMemory(){return P+fe}getObjectId(){return this._view.getObjectId(this._index)}getAttribute(t){return this._view.getAttribute(this._index,t)}getAttributeAsTimestamp(t){return this._view.getAttributeAsTimestamp(this._index,t)}getAttributes(){return this._view.getAttributes(this._index)}getOptimizedGeometry(){return this._view.getOptimizedGeometry(this._index)}getCentroid(t){return this._view.getCentroid(this._index,t)}getBounds(){return this._view.getBounds(this._index)}getBoundingBox(){return this._view.getBoundingBox(this._index)}cloneWithGeometry(t){return new ar(this._index,this._view,t)}};class ar extends J{constructor(e,r,n){super(e,r),this._geometryOverride=n}getOptimizedGeometry(){return this._geometryOverride}getCentroid(e){return Bt(new H,this._geometryOverride,e.hasZ,e.hasM)}}let or=class{constructor(t,e){this.featureData=t,this.bounds=e}},dr=class{constructor(){this._tileBounds=new Map,this.events=new Fe,this.featureAdapter=lr.shared}get usedMemory(){return P+P*this._tileBounds.size}addTile(t){const{featureCount:e}=t;if(e===0)return;const r=new Ot(9,i=>t.getBounds(i)),n=new Array;for(let i=0;i<e;++i)n[i]=i;r.load(n),this._tileBounds.set(t.id,new or(t,r)),this.events.emit("changed")}removeTile(t){this._tileBounds.delete(t),this.events.emit("changed")}clear(){this._tileBounds.clear(),this.events.emit("changed")}forEach(t){for(const{featureData:e,bounds:r}of this._tileBounds.values())r.all(n=>{e.getEnabled(n)&&t(new J(n,e))})}forEachInBounds(t,e){S.minX=t[0],S.minY=t[1],S.maxX=t[2],S.maxY=t[3];for(const{featureData:r,bounds:n}of this._tileBounds.values())n.search(S,i=>{r.getEnabled(i)&&e(new J(i,r))})}forEachBounds(t,e){for(const r of t)e(r.getBoundingBox())}getFullExtent(t){let e=1/0,r=1/0,n=-1/0,i=-1/0;for(const{bounds:s}of this._tileBounds.values()){const{minX:a,minY:o,maxX:l,maxY:u}=s.toJSON();e=Math.min(e,a),r=Math.min(r,o),n=Math.min(n,l),i=Math.min(i,u)}return{xmin:e,ymin:r,xmax:n,ymax:i,spatialReference:t}}},lr=class we{static{this.shared=new we}getObjectId(e){return e.getObjectId()}getAttribute(e,r){return e.getAttribute(r)}getAttributeAsTimestamp(e,r){return e.getAttributeAsTimestamp(r)}getAttributes(e){return e.getAttributes()}getGeometry(e){return e.getOptimizedGeometry()}getCentroid(e,r){return e.getCentroid(r)}cloneWithGeometry(e,r){return e.cloneWithGeometry(r)}};const S=new pe;let cr=class{constructor(t,e,r){this.descriptor=t,this._pages=e,this._pageSize=r;const n=St+e.reduce((s,{usedMemory:a})=>s+a,0),i=3*fe;this.usedMemory=P+n+i,this.featureCount=e.reduce((s,a)=>s+a.featureCount,0)}get id(){return this.descriptor.id}getObjectId(t){const{pageIndex:e,featurePageIndex:r}=this._translateIndex(t);return this._pages[e].getObjectId(r)}getAttribute(t,e){const{pageIndex:r,featurePageIndex:n}=this._translateIndex(t);return this._pages[r].getAttribute(n,e)}getAttributeAsTimestamp(t,e){const{pageIndex:r,featurePageIndex:n}=this._translateIndex(t);return this._pages[r].getAttributeAsTimestamp(n,e)}getAttributes(t){const{pageIndex:e,featurePageIndex:r}=this._translateIndex(t);return this._pages[e].getAttributes(r)}getCoordinates(t,e,r){const{pageIndex:n,featurePageIndex:i}=this._translateIndex(t);this._pages[n].getCoordinates(i,e,r)}getOptimizedGeometry(t){const{pageIndex:e,featurePageIndex:r}=this._translateIndex(t);return this._pages[e].getOptimizedGeometry(r)}getCentroid(t,e){const{pageIndex:r,featurePageIndex:n}=this._translateIndex(t);return this._pages[r].getCentroid(n,e)}getBounds(t){const{pageIndex:e,featurePageIndex:r}=this._translateIndex(t);return this._pages[e].getBounds(r)}getBoundingBox(t){const{pageIndex:e,featurePageIndex:r}=this._translateIndex(t);return this._pages[e].getBoundingBox(r)}getObjectIdsArray(t,e=this._allFeatureIndices(),r=0){let n=r;for(const{page:i,indices:s}of this._batchPageIndices(e))n=i.getObjectIdsArray(t,s,n);return n}getCoordinatesArray(t,e=this._allFeatureIndices(),r=0){let n=r;for(const{page:i,indices:s}of this._batchPageIndices(e))n=i.getCoordinatesArray(t,s,n);return n}*objectIds(t=this._allFeatureIndices()){for(const{page:e,indices:r}of this._batchPageIndices(t))for(const n of e.objectIds(r))yield n}*_allFeatureIndices(){const{featureCount:t}=this;for(let e=0;e<t;++e)yield e}_translateIndex(t){const{_pageSize:e}=this;return{pageIndex:Math.floor(t/e),featurePageIndex:t%e}}*_batchPageIndices(t){const e=new Array;{let n=0,i=new Array;for(const s of t){const{pageIndex:a,featurePageIndex:o}=this._translateIndex(s);n!==a&&(i.length!==0&&e.push({pageIndex:n,indices:i}),n=a,i=[]),i.push(o)}i.length!==0&&e.push({pageIndex:n,indices:i})}const{_pages:r}=this;for(const{pageIndex:n,indices:i}of e)yield{page:r[n],indices:i}}},ur=class{constructor(t){this._reader=new Lt(new Uint8Array(t),new DataView(t)),this._index=mr(this._reader)}get featureCount(){return this._index.featureIndices.length}get exceededTransferLimit(){return this._index.exceededTransferLimit}get usedMemory(){return this._reader.usedMemory}getObjectId(t){return this.getAttribute(t,this._index.objectIdFieldName)}getAttribute(t,e){const{_index:{fieldsIndex:r,attributeIndices:n}}=this,i=r.get(e)?.index;if(i==null)return;const s=n[t*r.fields.length+i],a=this._reader;return a.move(s),L(a)}getAttributeAsTimestamp(t,e){const r=this.getAttribute(t,e);return typeof r=="string"?new Date(r).getTime():typeof r=="number"||r==null?r:null}getAttributes(t){const{_index:{fieldsIndex:e,attributeIndices:r}}=this,n=t*e.fields.length,i=this._reader,s={};for(const a of e.fields){const o=r[n+a.index];i.move(o),s[a.name]=L(i)}return s}getCoordinates(t,e,r=0){const n=this._reader,{transform:i,featureIndices:s}=this._index,{scale:a,translate:o}=i;n.move(s[t]),this._readCoordinates(a,o,e,r)}getOptimizedGeometry(t){const e=U();return this.getCoordinates(t,e),new H([],e)}getCentroid(t,{hasZ:e,hasM:r}){this.getCoordinates(t,R);const[n,i,s]=R,a=[n,i];return e&&(a[3]=s),r&&(a[e?4:3]=0),new H([],a)}getBounds(t){this.getCoordinates(t,R);const[e,r]=R,n=new pe;return n.minX=e,n.minY=r,n.maxX=e,n.maxY=r,n}getBoundingBox(t){this.getCoordinates(t,R);const[e,r,n]=R;return Ct(e,r,n,e,r,n)}getObjectIdsArray(t,e=this._allFeatureIndices(),r=0){const n=this._reader,{objectIdFieldName:i,attributeIndices:s,fieldsIndex:a}=this._index,o=a.get(i).index,l=a.fields.length;for(const u of e){const m=s[u*l+o];n.move(m),t[r++]=L(n)}return r}getCoordinatesArray(t,e=this._allFeatureIndices(),r=0){const n=this._reader,{transform:i,featureIndices:s}=this._index,{scale:a,translate:o}=i;for(const l of e){const u=s[l];n.move(u),r=this._readCoordinates(a,o,t,r)}return r}*objectIds(t=this._allFeatureIndices()){const e=this._reader,{objectIdFieldName:r,attributeIndices:n,fieldsIndex:i}=this._index,s=i.get(r).index,a=i.fields.length;for(const o of t){const l=n[o*a+s];e.move(l),yield L(e)}}*_allFeatureIndices(){const{featureCount:t}=this;for(let e=0;e<t;++e)yield e}_readCoordinates([t,e,r],[n,i,s],a,o){const l=this._reader,u=l.getLength(),m=l.pos()+u;for(;l.pos()<m&&l.next();)switch(l.tag()){case 2:{const d=l.getLength(),c=l.pos()+d;for(;l.pos()<c&&l.next();)l.tag()===3?(l.getUInt32(),a[o++]=n+t*l.getSInt64(),a[o++]=i+e*l.getSInt64(),a[o++]=s+r*l.getSInt64()):l.skip();break}default:l.skip()}return o}};function mr(t){for(;t.next();){if(t.tag()===2)return hr(t.getMessage());t.skip()}k()}function hr(t){for(;t.next();){if(t.tag()===1)return fr(t.getMessage());t.skip()}k()}function fr(t){let e,r,n=!1,i=!1,s=0;const a=new Array,o=new Array,l=new Array;for(;t.next();)switch(t.tag()){case 1:r=t.getString();break;case 7:t.getEnum()!==0&&k();break;case 9:n=t.getBool()??!1;break;case 12:e=jt(t.processMessage(Mt));break;case 13:{const m=t.processMessage(Et);m.index=s++,a.push(m);break}case 15:{o.push(t.pos());const m=t.getUInt32(),d=t.pos()+m;for(;t.pos()<d&&t.next();)t.tag()===1&&l.push(t.pos()),t.skip();break}case 10:i=t.getBool()??!1;break;default:t.skip()}const u=new Ft(a);return e!=null&&i&&r!=null&&u.has(r)||k(),{transform:e,exceededTransferLimit:n,fieldsIndex:u,objectIdFieldName:r,featureIndices:o,attributeIndices:l}}function k(){const t=new Oe("pbf-parsing-failed","Error while parsing PBF",new Error);throw console.error(t),t}function L(t){const e=t.getLength(),r=t.pos()+e;for(;t.pos()<r&&t.next();)switch(t.tag()){case 1:return t.getString();case 2:return t.getFloat();case 3:return t.getDouble();case 4:return t.getSInt32();case 5:return t.getUInt32();case 6:return t.getInt64();case 7:return t.getUInt64();case 8:return t.getSInt64();case 9:return t.getBool();default:return t.skip(),null}return null}const R=U(),ue=8e3,pr=4,yr=4;let _r=class{constructor(t,e,r,n,i){this.spatialReference=t,this.url=r,this.objectIdField=n,this.capabilities=i;const{supportsMaxRecordCountFactor:s,maxRecordCount:a}=this.capabilities.query,o=s?pr:1,l=(a??ue)*o;this._pageSize=Math.min(ue,l);const u=e.clone();u.cacheHint=!0,u.resultType="tile",u.outSpatialReference=t,u.returnGeometry=!0,u.returnZ=!0,u.maxRecordCountFactor=o,u.num=this._pageSize,u.outFields=[n],this._baseQuery=u}async fetch(t,e){const{spatialReference:r,_pageSize:n}=this,i=lt(t.extent,r),s=this._baseQuery.clone();s.geometry=i;const a=new Array;let o=0,l=!1,u=1;for(;!l;){const m=[];for(let c=0;c<u;++c)m.push(this._fetchPage(s,o++,e));const d=await Promise.all(m);O(e);for(const c of d){const f=c.featureCount!==0;l||=!c.exceededTransferLimit||!f,f&&a.push(c)}u=Math.min(u+1,yr)}return new cr(t,a,n)}async _fetchPage(t,e,r){const n=t.clone();n.start=e*this._pageSize;const i=(await Dt(this.url,n,{signal:r})).data;return O(r),new ur(i)}};class gr{constructor(e,r){this._mainThreadDelegate=r,this._bufferWriters=new Map,this.globalViewingMode=e===1}createRenderCommandBuffer(e=[],r=[]){return{commands:e,transferList:r}}mergeRenderCommandBuffers(e){const r=this.createRenderCommandBuffer();for(const n of e)n!=null&&(r.commands.push(...n.commands),r.transferList.push(...n.transferList));return r}async createTexture(e){const{data:r,parameters:n}=e();return await this._mainThreadDelegate.createTexture(r,n)}async releaseTexture(e){const r=this._destroyTexture(e);return new I(this,r,[])}_destroyTexture(e){return{commands:[{id:"destroy-texture",textureId:e}],transferList:[]}}async createMaterial(e){const{type:r,parameters:n}=e,i=M("material");let s,a;switch(r){case"default":s=new vt(e.parameters,{spherical:this.globalViewingMode}),a={type:r,materialId:i,parameters:e.parameters};break;case"hud":s=new Ze(n,this.globalViewingMode),a={type:r,materialId:i,parameters:e.parameters}}return this._bufferWriters.set(i,s.createBufferWriter()),await this._mainThreadDelegate.createMaterial(a),i}destroyMaterial(e){return{commands:[{id:"destroy-material",materialId:e}],transferList:[]}}updateMaterial(e){return{commands:[{...e,id:"update-material"}],transferList:[]}}async createDirectRenderer(e){return await this._mainThreadDelegate.createDirectRenderer(e),e}async destroyDirectRenderer(e){await this._mainThreadDelegate.destroyDirectRenderer(e)}addDirectRendererGeometry(e,r,n,i){const{materialId:s}=r;if(this._bufferWriters.get(s)==null)throw new Error(`no bufferwriter found for material ${s}`);const{renderGeometryBuffer:a,renderGeometryBufferItems:o}=this.createRenderGeometryBuffer(r,n,i);return this.addDirectRendererGeometryBuffer(s,e,a,o,n)}updateDirectRendererGeometry(e,r,n,i){const{materialId:s}=r;if(this._bufferWriters.get(s)==null)throw new Error(`no bufferwriter found for material ${s}`);const{renderGeometryBuffer:a,renderGeometryBufferItems:o}=this.createRenderGeometryBuffer(r,n,i);return this.updateDirectRendererGeometryBuffer(s,e,a,o,n)}addDirectRendererGeometryBuffer(e,r,n,i,s){const{objectIds:a,visibilities:o}=i;return{commands:[{id:"add-direct-renderer-geometry-buffer",rendererId:e,groupId:r,renderGeometryBuffer:n,renderGeometryBufferItems:i,localOrigin:s}],transferList:[n.data,a.buffer,o.buffer]}}updateDirectRendererGeometryBuffer(e,r,n,i,s){const{objectIds:a,visibilities:o}=i;return{commands:[{id:"update-direct-renderer-geometry-buffer",rendererId:e,groupId:r,renderGeometryBuffer:n,renderGeometryBufferItems:i,localOrigin:s}],transferList:[n.data,a.buffer,o.buffer]}}removeDirectRendererGeometryBuffer(e,r){return{commands:[{id:"remove-direct-renderer-geometry-buffer",rendererId:e,groupId:r}],transferList:[]}}async createLodRenderer(e){const r=M("lod-renderer"),n=new Set,i={levels:e.levels.map(s=>({components:s.components.map(a=>{const o=a.attributes.get("position");if(!o||o.indices.length===0)throw new Error("positions attribute expected");const l=3,u=ht(o.indices.length/l),m=new Rt(u,l,o);if(this._bufferWriters.get(a.materialId)==null)throw new Error("writer not found");const{renderGeometryBuffer:d}=this.createRenderGeometryBuffer(a,null);return n.add(d.data),{materialId:a.materialId,renderGeometryBuffer:d,boundingInfo:{bbMax:m.bbMax,bbMin:m.bbMin}}}),minScreenSpaceRadius:s.minScreenSpaceRadius}))};return await this._mainThreadDelegate.createLodRenderer(r,i,Array.from(n)),r}destroyLodRenderer(e){return{commands:[{id:"destroy-lod-renderer",rendererId:e}],transferList:[]}}addLodInstances(e,r,n){return{commands:[{id:"add-lod-instances",rendererId:e,groupId:r,data:n}],transferList:[n.featureIds.buffer,n.globalTransforms.buffer,n.localTransforms.buffer,n.visibility.buffer]}}removeLodInstances(e,r){return{commands:[{id:"remove-lod-instances",rendererId:e,groupId:r}],transferList:[]}}updateLodInstancesData(e,r,n){return{commands:[{id:"update-lod-instance-data",rendererId:e,groupId:r,globalTransforms:n}],transferList:[n.buffer]}}updateVisibility(e,r,n){return{commands:[{id:"update-visibility",rendererId:e,groupId:r,visibility:n}],transferList:[n.buffer]}}async dispatchRenderCommands(e){e.commands.length!==0&&await this._mainThreadDelegate.executeRenderCommands(e)}createRenderGeometryBuffer(e,r,n){const{materialId:i,visibilities:s,objectIds:a}=e,o=this._bufferWriters.get(i);if(o==null)throw new Error("no registered bufferWriter for material found");let l=null;if(e.transformation&&r)pt(A,e.transformation),A[12]-=r[0],A[13]-=r[1],A[14]-=r[2],l=A;else{if(r)throw new Error("not implemented");e.transformation&&(l=e.transformation)}let u=null;l&&(yt(j,A),_t(j,j),u=j);const m=e.attributes,d=o.elementCount(m),c=n?o.instanceLayout:o.layout;if(!c)throw new Error("Missing layout");const f=c.stride/4;d>Math.floor(br/f)&&console.warn("geometry with very large number of elements encountered");const _=c.createBuffer(d),h=0,y=o.write(l,u,m,e.olidColor,_,h);if(y==null)throw new Error("Bufferwriter.write does not provide item information.");if(s.length!==y.numItems||a.length!==y.numItems)throw new Error("Unexpected mismatch between number of RenderGeometryBufferItems and provided objectIds/visibility flags.");return{renderGeometryBuffer:{data:_.buffer,elementCount:d},renderGeometryBufferItems:{objectIds:a,visibilities:s,ranges:{numVertices:y.numVerticesPerItem,numItems:y.numItems}}}}async setBaseInstance(e,r){await this._mainThreadDelegate.setBaseInstance(e,r)}}const A=B(),j=B(),br=16777216/4;let E=class extends De{constructor(){super(...arguments),this.remoteClient=null,this._featureStore=new dr,this._tileLocks=new sr,this._tileManager=null,this._renderer=null,this._fetcher=null,this._queryEngine=null,this._defaultQueryJSON=null,this._mainThreadDelegate=null,this._viewSpatialReference=null,this._renderCommandContext=null,this._context=null}get updating(){return this._tileManager.updating}destroy(){this._featureStore.clear(),this._tileManager?.destroy()}async setup({viewSpatialReference:t,renderSpatialReference:e,viewingMode:r,layerInfo:n,layerViewInfo:i}){const s=X.fromJSON(t);this._viewSpatialReference=s;const a=X.fromJSON(e);this._fetcher=new _r(this._viewSpatialReference,Z.fromJSON(n.baseQuery),n.url,n.objectIdField,n.capabilities),this._queryEngine=new $e({hasZ:!0,hasM:!1,geometryType:"esriGeometryPoint",featureIdInfo:{type:"object-id",fieldName:n.objectIdField},fieldsIndex:n.fieldIndex,availableFields:[n.objectIdField],spatialReference:t,featureStore:this._featureStore,timeInfo:n.timeInfo}),this._mainThreadDelegate={createTexture:async(d,c)=>{const f={data:d,parameters:c};return await this.remoteClient.invoke("createTexture",f,{transferList:[d.buffer]})},releaseTexture:async d=>{const c={uid:d};await this.remoteClient.invoke("releaseTexture",c)},createMaterial:async d=>{const c={materialJSON:d};await this.remoteClient.invoke("createMaterial",c)},destroyMaterial:async d=>{const c={materialId:d};await this.remoteClient.invoke("destroyMaterial",c)},createDirectRenderer:async d=>{const c={materialId:d};await this.remoteClient.invoke("createDirectRenderer",c)},destroyDirectRenderer:async d=>{const c={materialId:d};await this.remoteClient.invoke("destroyDirectRenderer",c)},createLodRenderer:async(d,c,f)=>{const _={rendererId:d,lodRenderGeometry:c};await this.remoteClient.invoke("createLoDRenderer",_,{transferList:f})},destroyLodRenderer:async d=>{const c={rendererId:d};await this.remoteClient.invoke("destroyLoDRenderer",c)},executeRenderCommands:async d=>{const c={commands:d.commands};await this.remoteClient.invoke("dispatchRenderCommands",c,{transferList:d.transferList})},applyElevationAlignmentTo:async d=>{const c={mapPoints:d};return await this.remoteClient.invoke("applyElevationAlignment",c,{transferList:[d.buffer]})},setBaseInstance:async(d,c)=>{const f={rendererId:d,baseInstance:c};await this.remoteClient.invoke("setBaseInstance",f,{transferList:c!=null?[c.data]:void 0})}};const o=Xe.create(r,a),l=new gr(r,this._mainThreadDelegate);this._renderCommandContext=l;const u=new Kt(s,a,this._mainThreadDelegate,o,l,n,i);this._context=u,this._renderer=u.symbolRendererFactory.createSymbolRendererFromJSON(n.renderer),this._defaultQueryJSON=new Z({outSpatialReference:s}).toJSON();let m=null;if(n.fullExtent!=null){const d=Me.fromJSON(n.fullExtent);await ke(d.spatialReference,s),m=Ue(d,s)}return this._tileManager=new b({loadTile:(d,c)=>this._fetcher.fetch(d,c),createAddCommand:(d,c)=>this._createAddFeatureDataCommand(d,c),createRemoveCommand:d=>this._createRemoveFeatureDataCommand(d),createUpdateCommand:(d,c)=>this._createUpdateFeatureDataVisibilityCommand(d,c),tileLocks:this._tileLocks,extent:m}),this.addHandles(Le(()=>this.updating,d=>{this.emit("notify-updating",{updating:d})}),je),this._renderer!=null&&await this._renderer.load(),T}async executeQuery(t,e){return{result:await this._queryEngine.executeQuery(this._ensureQuery(t),e)}}async executeQueryForIds(t,e){const r=await this._queryEngine.executeQueryForIdSet(this._ensureQuery(t),e);return{result:Array.from(r)}}async executeQueryForCount(t,e){return{result:await this._queryEngine.executeQueryForCount(this._ensureQuery(t),e)}}async executeQueryForExtent(t,e){return{result:await this._queryEngine.executeQueryForExtent(this._ensureQuery(t),e)}}async executeQueryForLatestObservations(t,e){return{result:await this._queryEngine.executeQueryForLatestObservations(this._ensureQuery(t),e)}}async executeAttributeBinsQuery(t,e){return{result:await this._queryEngine.executeAttributeBinsQuery(t,e)}}onTileTreeChange(t){return this._tileManager.onTileTreeChange(t),Promise.resolve(T)}async onElevationChange(t){return T}async onLayerViewOpacityChange(t){const{_context:e,_renderer:r}=this;return e.layerViewInfo.fullOpacity=t,r==null||await(await r.createUpdateLayerViewOpacityCommand(t)).execute(),T}async onRendererChange(t){const{_context:e}=this,r=e.symbolRendererFactory.createSymbolRendererFromJSON(t);await r.load();const n=this._renderer;this._renderer=r;const i=[...this._tileManager.loadedTiles()],s=i.map(a=>a.tileId);{const a={stack:[],error:void 0,hasError:!1};try{$(a,await this._tileLocks.lock(s),!1);const o=i.flatMap(u=>[n.createRemoveCommand(u.id),r.createAddCommand(u)]),l=await Promise.all(o);await e.joinPipelineCommands(l).execute()}catch(o){a.error=o,a.hasError=!0}finally{V(a)}}return await(await n.createDestroyCommand()).execute(),T}async _createAddFeatureDataCommand(t,e){const r=this._featureStore,n=this._renderer;let i;return i=n!=null?await n.createAddCommand(t):I.create(this._renderCommandContext),O(e),i.appendPipelineStateCommand(()=>{r.addTile(t)}),i}async _createRemoveFeatureDataCommand(t){const e=this._featureStore,r=this._renderer;let n;return n=r!=null?await r.createRemoveCommand(t):I.create(this._renderCommandContext),n.appendPipelineStateCommand(()=>{e.removeTile(t)}),n}async _createUpdateFeatureDataVisibilityCommand(t,e){const r=this._renderer;let n;return n=r!=null?await r.createUpdateVisibilityCommand(t):I.create(this._renderCommandContext),O(e),n}_ensureQuery(t){return t??this._defaultQueryJSON}};w([C()],E.prototype,"updating",null),E=w([he("esri.views.3d.layers.graphics.pipeline.Feature3DPipelineWorker")],E);const Hi=E,T={result:void 0};export{Hi as default};
