import{a2 as W}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{Q as At}from"./Point-BfTTZoMu-BAT2Wq6O.js";import{A as xt}from"./earcut-D9gy186--DqxOpTir.js";import{D as Lt,a as Mt,P as Ot}from"./Polygon-D6wEPb3W-CpL9Efjx.js";import{z as Vt,H as Rt}from"./mat4-C96X-Nn0-Do6fKsNS.js";import{n as q}from"./mat4f64-q_b6UJoq-Dh6sWB_w.js";import{L as V,h as rt,F as wt,O as Ut,l as K,V as N,I as Bt,$ as it}from"./vec32-CewSdTn3-DHOFKD0R.js";import{r as at,t as v}from"./collectionUtils-jDyktm0P-ArdXNs6F.js";import{y as Ft}from"./computeTranslationToOriginAndRotation-Bjd4esRf-CXUng2L4.js";import{l as Gt,S as Tt,$ as Ht}from"./aaBoundingBox-Cn49X7ge-DORLZxoS.js";import{i as G,c as B}from"./DoubleArray-DExKNiTh-CvVpHySW.js";import{m as ct,g as St}from"./Indices-D0_UQPPr-t1Qev6md.js";import{b as jt}from"./vec3-B_phcnZY-DHC7I6xa.js";import{c as Nt,o as lt}from"./SnappingCandidate-DGkpYqI6-CfPvDre4.js";import{k as kt}from"./renderingInfoUtils-BivCmbrV-DfARK6_A.js";import{Z as Qt,_ as ut,a0 as Yt,a1 as Wt,a2 as Zt,a as qt,B as Kt,a3 as Jt,a4 as Xt,Q as te}from"./ShadowCastClear.glsl-CeOT_rAo-iOFMl8eB.js";import{w as ee}from"./RealisticTree.glsl-WN9nrQUl-CRRcYwOn.js";import{z as ne}from"./Extent-CgDMOSRD-CU1qE5Kr.js";import{G as vt,B as se}from"./triangulationUtils-D34y65Gu-uORqNaLm.js";import{a as $}from"./orientedBoundingBox-BLEx7wLU-CPBtS4XC.js";import{a1 as ht,g as J,a as oe}from"./Texture-CFNZjV2R-lGBztxVp.js";import{R as re,A as ie}from"./layerViewUtils-BTa15X3o-BjQlX2q8.js";import{b as ae}from"./projectionUtils-BGH_5_I3-BySNUA-B.js";import{N as ce,S as le}from"./edgePreprocessing-D_eX-fWy-CRLN12td.js";function ue(e,t,n,o){const s=vt(e.rings,!!e.hasZ&&o.mode!=="on-the-ground",1,e.spatialReference),r=G(s.position.length),i=qt(s.position,e.spatialReference,0,r,0,s.position,0,s.position.length/3,t,n,o),a=i!=null;return new me(s.position,r,Dt(s.polygons,s.position,r),Pt(s.outlines,s.position,r),a,i)}function Ke(e,t){const n=vt(e.rings,!1,1),o=ae(n.position,e.spatialReference,0,n.position,t,0);for(let s=2;s<n.position.length;s+=3)n.position[s]=Kt;return{position:n.position,polygons:Dt(n.polygons,n.position),outlines:Pt(n.outlines,n.position),projectionSuccess:o}}function Pt(e,t,n=null){return e.filter(({count:o})=>o>1).map(({index:o,count:s})=>{const r=3*o,i=3*s;return n!=null?new Ct(o,s,B(t,r,i),B(n,r,i)):new X(o,s,B(t,r,i))})}function Dt(e,t,n=null){const o=new Array;for(const{index:s,count:r,holeIndices:i,pathLengths:a}of e){if(r<=1)continue;const c=3*s,b=3*r,x=i.map(g=>g-s),y=n!=null?new he(s,r,B(t,3*s,3*r),B(n,c,b),x,a):new pe(s,r,B(t,3*s,3*r),x,a);o.push(y)}return o}let X=class{constructor(e,t,n){this.index=e,this.count=t,this.position=n}};class Ct extends X{constructor(t,n,o,s){super(t,n,o),this.mapPositions=s}}class he extends Ct{constructor(t,n,o,s,r,i){super(t,n,o,s),this.holeIndices=r,this.pathLengths=i}}class pe extends X{constructor(t,n,o,s,r){super(t,n,o),this.holeIndices=s,this.pathLengths=r}}class me{constructor(t,n,o,s,r,i){this.position=t,this.mapPositions=n,this.polygons=o,this.outlines=s,this.projectionSuccess=r,this.sampledElevation=i}}function Je(e,t,n){const o=(t.length>0?t[0]:e.length/3)-1,s=se(e,o,n);if(s!==2){e=e.slice();for(let r=0;r<e.length;r+=3)e[r+s]=e[r+2]}return xt(e,t,3)}function Xe(e){const t=[["position",new $(e.attributeData.position,e.indices,3,!0)]],n=St(e.indices.length);return e.attributeData.colorFeature!=null?t.push(["colorFeatureAttribute",new $([e.attributeData.colorFeature],n,1,!0)]):e.attributeData.color&&t.push(["color",new $(e.attributeData.color,n,4,!0)]),e.attributeData.uvMapSpace&&t.push(["uvMapSpace",new $(e.attributeData.uvMapSpace,e.indices,4,!0)]),e.attributeData.boundingRect&&t.push(["boundingRect",new $(e.attributeData.boundingRect,e.indices,9,!0)]),new J(e.material,t,e.mapPositions,0,e.attributeData.olidColor)}function tn(e,t=null){const n=[["position",new $(e.attributeData.position,e.indices,3,!0)],["uv0",new $(e.attributeData.uv0,e.indices,2,!0)]];return new J(e.material,n,e.mapPositions,0,t)}function de(e){switch(e.type){case"extent":if(e instanceof ne)return Ot.fromExtent(e);break;case"polygon":return e}return null}class en{constructor(t,n,o){this.renderData=t,this.layerViewUid=n,this.graphicUid=o,this.outGeometries=new Array}}const ge=["polygon","extent"];class nn extends Qt{constructor(t,n,o,s){super(t,n,o,s,xe(n)),this.ensureDrapedStatus(!1)}async doLoad(){const t=this.symbolLayer,n=t?.material,o=this.symbolLayer.material?.color?.a,s=this.needsDrivenTransparentPass||o!=null&&o!==1,r=n?.emissive,i=!this._hasDrivenColorOrOpacity&&(o==null||o===0),a={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,ambient:at,diffuse:at,opacity:i?0:1,layerOpacity:this._getLayerOpacity(),drivenOpacity:s,hasSymbolColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:t.castShadows,emissiveStrength:r?.strength??0,emissiveSource:1,offsetTransparentBackfaces:!0,normalType:1},c=new ht(a,this._context),b=new ht({...a,cullFace:2},this._context);this._materials[0]=c,this._materials[1]=b,this._updateTransparentDepedentMaterialParameters()}destroy(){super.destroy(),this._materials.length=0}createGraphics3DGraphic(t){const n=t.graphic;if(!this._validateGeometry(n.geometry,ge,this.symbolLayer.type))return null;const o=this._getDrivenUInt8ColorWithNaNSupport(t.renderingInfo,this._materialColor,!1);re(o,o);const s=this.createElevationContextForGraphic(n);return this._createAs3DShape(n,t.renderingInfo,o,s,n.uid)}layerOpacityChanged(t,n){const o=this._getLayerOpacity();this._materials[0]?.setParameters({layerOpacity:o}),this._materials[1]?.setParameters({layerOpacity:o}),this._updateTransparentDepedentMaterialParameters(),t?.forEach(s=>n(s)?.layerOpacityChanged(o,this._context.isAsync))}layerScreenSizePerspectiveChanged(){}layerElevationInfoChanged(t,n){return this.updateGraphics3DGraphicElevationInfo(t,n,ut)}slicePlaneEnabledChanged(t,n){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._materials[1]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),t?.forEach(o=>{n(o)?.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){const t={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0};return this._materials[0]?.setParameters(t),this._materials[1]?.setParameters(t),!0}_getExtrusionSize(t){let n;return n=t.size&&this._drivenProperties.size?kt(t.size,2)??0:this._getSymbolSize(),n/=this._context.renderCoordsHelper.unitInMeters,n}applyRendererDiff(t,n){return this._drivenPropertiesChanged(n)?0:1}async queryForSnapping(t,n,o,s){const r=this._getExtrusionSize(o)*this._context.renderCoordsHelper.unitInMeters/At(n),{objectId:i,target:a}=t,c=W(a);switch(c.z=(c.z??0)+r,t.type){case"edge":{const{start:b,end:x}=t,y=W(b),g=W(x);return y.z=(y.z??0)+r,g.z=(g.z??0)+r,[lt(i,c,1/0,y,g)]}case"vertex":return[Nt(i,c,1/0),lt(i,a,1/0,a,c)];default:return[]}}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(t,n,o,s,r){const i=de(t.geometry);if(i==null)return null;if(i.rings.length===0||!i.rings.some(D=>D.length>0))return this._logGeometryValidationWarnings(i.rings,"rings","ExtrudeSymbol3DLayer"),null;const a=ue(i,this._context.elevationProvider,this._context.renderCoordsHelper,s);this._logGeometryCreationWarnings(a,i.rings,"rings","ExtrudeSymbol3DLayer");const c=ee(i);if(c==null)return null;const b=new Array,x=new Array,y=Gt(),g=q(),w=v(),p=this._context.renderCoordsHelper.viewingMode===1;p||this._context.renderCoordsHelper.worldUpAtPosition(null,w),Ft(i.spatialReference,[c.x,c.y,0],g,this._context.renderCoordsHelper.spatialReference);const _=q();Vt(_,g);const d=Mt();Lt(d,_);const{polygons:f,mapPositions:l,position:m}=a,h=new Map,P=this._materials[0];for(const D of f){const L=D.count;if(this._context.clippingExtent&&(Tt(D.mapPositions,y),!Ht(y,this._context.clippingExtent)))continue;const M=xt(D.mapPositions,D.holeIndices,3);if(M.length===0)continue;const O=M.length,E=6*L,R=ct(E+O),k=ct(O),T=G(3*E),tt=G(3*E),et=G(3*E),nt=G(E);fe(m,l,M,D,T,et,tt,nt,R,k,this._getExtrusionSize(n),w,p),jt(T,T,_);const st=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:r,layerViewUid:this._context.layerViewUid}),Q=new De(T,et,ce(tt),nt),Y=pt(P,R,R.length-k.length,Q,o,st),$t=L,zt=L,It=2*D.count,ot=new Ce($t,zt,It,O/3);Et(Y,ot,g),h.set(Y,ot),b.push(Y,pt(this._materials[1],k,0,Q,o,st)),x.push(Q.heights)}if(b.length===0)return null;const u=new Yt({geometries:b,layerViewUid:this._context.layerViewUid,graphicUid:r,isElevationSource:!0});u.transformation=g;const z=ie(this.symbolLayer,{opacity:this._getLayerOpacity()}),I=z?new Wt(this._materials[0],z,this._context.slicePlaneEnabled):null,A=new Zt(this,u,null,(D,L,M,O,E)=>be(D,L,M,O,E,x,h),s,I);return A.alignedSampledElevation=a.sampledElevation,A.needsElevationUpdates=ut(s.mode),A}get _materialColor(){return this.symbolLayer.material?.color}_updateTransparentDepedentMaterialParameters(){const t=this._materials[0];t&&t.setParameters({cullFace:t.transparent?0:2})}}function pt(e,t,n,o,s,r){const i=St(t.length),a=[["position",new $(o.positions,t,3,!0)],["normalCompressed",new $(o.normals,t,2,!0)],["symbolColor",new $(s,i,4,!0)]];return new J(e,a,o.elevation,0,r,n)}function fe(e,t,n,o,s,r,i,a,c,b,x,y,g){const w=n.length/3;let p=2*o.count;ye(e,t,o.index,o.count,n,0,w,s,r,i,a,c,b,p,x,y,g);let _=0,d=2*o.count;p=0;const f=o.pathLengths[0];mt(s,r,a,i,_,f,o.count,d,c,p,x),d+=4*f,p+=2*f,_+=f;for(let l=1;l<o.pathLengths.length;++l){const m=o.pathLengths[l];mt(s,r,a,i,_,m,o.count,d,c,p,x),d+=4*m,p+=2*m,_+=m}}function ye(e,t,n,o,s,r,i,a,c,b,x,y,g,w,p,_,d){Bt(C,_),c??=[],b??=[],x??=[];const f=p>0?1:-1;let l=3*n,m=0,h=3*m,P=o,u=3*P;for(let A=0;A<o;++A){const D=e[l],L=e[l+1],M=e[l+2];d&&(C[0]=D,C[1]=L,C[2]=M,K(C,C)),a[h+0]=D,a[h+1]=L,a[h+2]=M;const O=t[l+0],E=t[l+1],R=t[l+2];c[h+0]=O,c[h+1]=E,c[h+2]=R,b[h+0]=-f*C[0],b[h+1]=-f*C[1],b[h+2]=-f*C[2],x[m]=0,a[u+0]=D+p*C[0],a[u+1]=L+p*C[1],a[u+2]=M+p*C[2],c[u+0]=O,c[u+1]=E,c[u+2]=R,x[P]=p,h+=3,u+=3,l+=3,m+=1,P+=1}l=3*r,h=0,u=3*w;const z=p<0?bt:_t,I=p<0?_t:bt;for(let A=0;A<i;++A)g[h]=s[l+z[0]],g[h+1]=s[l+z[1]],g[h+2]=s[l+z[2]],y[u]=s[l+I[0]]+o,y[u+1]=s[l+I[1]]+o,y[u+2]=s[l+I[2]]+o,h+=3,u+=3,l+=3}function H(e,t,n,o,s,r,i){o[r]=o[i],i*=3,e[r*=3]=e[i],e[r+1]=e[i+1],e[r+2]=e[i+2],t[r]=t[i],t[r+1]=t[i+1],t[r+2]=t[i+2],n[r]=s[0],n[r+1]=s[1],n[r+2]=s[2]}const F=v();function mt(e,t,n,o,s,r,i,a,c,b,x){t??=[],n??=[],o??=[];let y=s,g=s+1,w=s+i,p=s+i+1,_=a,d=a+1,f=a+2*r,l=a+2*r+1;x<0&&(y=s+i+1,p=s);let m=3*b;for(let h=0;h<r;++h)h===r-1&&(g=s,x>0?p=s+i:y=s+i),_e(e,y,g,w,F),H(e,t,o,n,F,_,y),H(e,t,o,n,F,d,g),H(e,t,o,n,F,f,w),H(e,t,o,n,F,l,p),c[m]=_,c[m+1]=f,c[m+2]=l,c[m+3]=_,c[m+4]=l,c[m+5]=d,m+=6,y++,g++,w++,p++,_+=2,d+=2,f+=2,l+=2}const Z=v(),dt=v(),gt=v(),ft=v(),yt=v();function _e(e,t,n,o,s){t*=3,n*=3,o*=3,V(Z,e[t++],e[t++],e[t++]),V(dt,e[n++],e[n++],e[n++]),V(gt,e[o++],e[o++],e[o++]),it(ft,dt,Z),it(yt,gt,Z),wt(s,yt,ft),K(s,s)}const U=v();function be(e,t,n,o,s,r,i){const a=e.stageObject,c=a.geometries,b=c.length,x=t.mode!=="absolute-height";let y=0;const g=a.transformation,w=Rt(q(),g);for(let p=0;p<b;p+=2){const _=c[p];if(!Jt(_))continue;const d=_.getMutableAttribute("position").data,f=r[p/2],l=new Xt(_.mapPositions),m=d.length/3;let h=!1,P=0;{let u=0;for(let z=0;z<m;z++){U[0]=d[u],U[1]=d[u+1],U[2]=d[u+2],o(l,j),x&&(P+=j.sampledElevation),oe.TESTS_DISABLE_OPTIMIZATIONS?(V(S,l.array[l.offset],l.array[l.offset+1],j.z+f[u/3]),n!=null&&s.toRenderCoords(S,n,S),N(S,S,w)):(V(S,d[u],d[u+1],d[u+2]),N(S,S,g),s.setAltitude(S,j.z+f[u/3]),N(S,S,w)),d[u]=S[0],d[u+1]=S[1],d[u+2]=S[2];const I=we/s.unitInMeters;(Math.abs(U[0]-d[u])>=I||Math.abs(U[1]-d[u+1])>=I||Math.abs(U[2]-d[u+2])>=I)&&(h=!0),l.offset+=3,u+=3}}if(h){const u=i.get(_);u&&Et(_,u,g),a.geometryVertexAttributeUpdated(c[p],"normalCompressed"),_.invalidateBoundingInfo(),a.geometryVertexAttributeUpdated(c[p],"position"),c[p+1].invalidateBoundingInfo(),a.geometryVertexAttributeUpdated(c[p+1],"position")}y+=P/m}return y/b}function Et(e,t,n){const o=e.getMutableAttribute("position"),s=e.getMutableAttribute("normalCompressed").data,r=o.data,i=e.attributes.get("position").indices,{topVertexStart:a,topVertexCount:c,topFaceStart:b,topFaceCount:x}=t,y=b+x,g=a+c,w=Se,p=ve,_=Pe,d=C,f=S;V(f,0,0,0);const l=(m,h)=>{const P=3*m;V(h,r[P+0],r[P+1],r[P+2]),N(h,h,n)};for(let m=b;m<y;++m){const h=3*m;l(i[h+0],w[0]),l(i[h+1],w[1]),l(i[h+2],w[2]),rt(p,w[1],w[0]),rt(_,w[2],w[0]),wt(d,p,_),Ut(f,f,d)}K(f,f);for(let m=a;m<g;++m){const h=f[0],P=f[1],u=f[2];le(s,m,h,P,u)}}function xe(e){return(e.material?.color?.a??0)===1}const S=v(),C=v(),j=new te,_t=[0,2,1],bt=[0,1,2],we=.01,Se=[v(),v(),v()],ve=v(),Pe=v();class De{constructor(t,n,o,s){this.positions=t,this.elevation=n,this.normals=o,this.heights=s}}class Ce{constructor(t,n,o,s){this.topVertexStart=t,this.topVertexCount=n,this.topFaceStart=o,this.topFaceCount=s}}export{Ke as K,Je as Y,de as d,tn as e,fe as f,en as n,nn as s,Xe as t,ue as u};
