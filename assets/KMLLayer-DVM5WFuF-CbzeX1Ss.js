import{J as T,aE as z,L as J,aH as H,a2 as v,Y as i,H as l,bR as A,G as R,K as W}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{k as B,R as I}from"./collectionUtils-jDyktm0P-BDP2Oq99.js";import{r as D}from"./CollectionFlattener-D6h2Fkvj-WVl2BXw-.js";import{k as q}from"./MultiOriginJSONSupport-Bd1TKmh_-BHNF5tHX.js";import{j as P,i as d,w as V,t as F,r as M}from"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import{f as O,q as Y,a as U,ai as Q,H as X}from"./Point-BfTTZoMu-DeJwQYfh.js";import{u as L}from"./reader-DcGs6kKN-DHJfK-tm.js";import{z as _}from"./Extent-CgDMOSRD-Bod5LY6s.js";import{o as Z}from"./Layer-DZvC7bne-D3VLDrab.js";import{y as ee}from"./BlendLayer-HE_aYHHW-D0es7Iiq.js";import{C as te,f as re}from"./OperationalLayer-B6zbJ5nR-DyK_ztCk.js";import{z as oe}from"./PortalLayer-CbFNhtZ4-Doeialq-.js";import{O as ie}from"./RefreshableLayer-CBbEkZf--DylHaNOC.js";import{s as se}from"./ScaleRangeLayer-DQr2T3Hh-Dh1UYk4i.js";import{e as le,r as ne}from"./GraphicOrigin-uE6TDXc9-DqbdmNAV.js";import"./getPopupProvider-CmskPttI-CzUWpGwk.js";import{l as j,N as x,B as g,c as ae}from"./aaBoundingBox-Cn49X7ge-BcYPaJ58.js";import{a2 as S}from"./Polygon-D6wEPb3W-D2MPjRU4.js";import"./jsonUtils-BCGKNxno-DZ1Xr_O8.js";import"./FeatureSet-BF7daP96-B_JvMbY7.js";import"./index-B0z_nLWi.js";import"./date-IqUzANpt-bLKO9IDT.js";import"./Color-CERqXxxY-BuYn26eI.js";import"./mat4f32-Djp3mnm5-DzYG3LYB.js";import"./mat4-C96X-Nn0-BrMLOLCb.js";import"./mathUtils-PIGhLnI9-B1tKUlUb.js";import"./ElevationInfo-Cw2HaA6E-CuK5hJ96.js";import"./lengthUtils-Dt1_RvOO-j3MEdmHu.js";import"./unitConversionUtils-4vB4Ezlp-DnY5MDxd.js";import"./asyncUtils-w6KfWU41-HenJ0UOu.js";import"./PortalItem-DnxMlRVo-CI4Ns2_M.js";import"./projectionUtils-BGH_5_I3-DGwchVO8.js";import"./Polyline-CoiTLswR-DTxpB2Yg.js";import"./mat4f64-q_b6UJoq-Dh6sWB_w.js";import"./typeUtils-DDFS4uuz-B7KgP61w.js";import"./ClassBreaksRenderer-BvgdqtTq-D2fU8Sng.js";import"./commonProperties-DbO613LF-CHjBvYhj.js";import"./colorRamps-DswZzxkO-BqSFavfl.js";import"./ColorStop-De5gQTjr-C1lw16u9.js";import"./visualVariableUtils-ma4r7Z2K-Df6C3Hkh.js";import"./Graphic-DgGzDmqW-d1CNicxz.js";import"./typeUtils-DqrRcjBx-DZ6_Gsbu.js";import"./typeUtils-CXW_VpOn-BGgLp_TK.js";import"./lineMarkers-CDwLe3J6-CNUjJvs3.js";import"./PolygonSymbol3D-BXRHZiCQ-BjPAY2LA.js";import"./ExtrudeSymbol3DLayer-DSc1ou2x-CsVYZCeG.js";import"./Font-BwmnW7d2-Dwh3xjKw.js";import"./SimpleFillSymbol-CDawtd9z-CWD2KI2D.js";import"./SimpleMarkerSymbol-BGAFRS9_-CVQ5NLIA.js";import"./PictureMarkerSymbol-CaSh-vZk-xhjZ61bb.js";import"./TextSymbol-hRGhyDHs-CoS7dSjf.js";import"./defaults3D-C2hXSee1-CTj29-Ly.js";import"./defaults-BDN9qxeN-C-EfxQM4.js";import"./RendererLegendOptions-ByGHYLtx-Bwoo6l33.js";import"./LRUCache-fy84PBMi-Y56WPIvD.js";import"./UnknownTimeZone-B697BDFv-CBbtul7O.js";import"./vec42-B8VM4vXb-B6OGOEI9.js";import"./vec4f64-DPb6J-GU-C7c2DqbZ.js";import"./SimpleRenderer-CEmCWePp-BJ25mYcH.js";import"./UniqueValueRenderer-JPjz9Qvs-Duu1CubQ.js";import"./Field-Cm_ZejYW-CwJZmSru.js";import"./fieldType-DVUzXtk_-tUuvnZJM.js";import"./SimpleObservable-CvFyr0NA-DXpoMYph.js";import"./layerContainerType-CSXZNpHb-BIF7XAYP.js";import"./jsonUtils-CY6YsQMo-LM0PY-PG.js";import"./screenUtils-BitdhK1O-L0FLPAMi.js";import"./opacityUtils-DuFH0EC9-DWspTgn2.js";import"./layerUtils-DZGhvm-W-CfyHx1TZ.js";import"./portalItemUtils-CaPNUJg6-CXDHI5LA.js";import"./aaBoundingRect-CjwcS2F3-ri8bmh30.js";import"./DoubleArray-DExKNiTh-CvVpHySW.js";import"./jsonUtils-CmpazY1u-6pDLj5sx.js";import"./DictionaryScriptEvaluator-G73uSGpN-ErvAW-Hm.js";import"./Version-BtYZEj58-LyRHDnSJ.js";import"./FieldsIndex-CimK-TqD--24JoCkp.js";import"./timeZoneUtils-BSc7-7qA-BAv3h8mh.js";import"./ArcadeExpression-BlIRq-oN-VZkrwLVE.js";import"./TimeOnly-BERR31kg-CQiLyUZi.js";import"./enum-BzLwmiID-CcyIdWlQ.js";import"./utils-DX2muIr3-DiPfFKSl.js";import"./heatmapUtils-B-AXnq0l-BF3Q_jd2.js";import"./jsonUtils-C9q_FK4K-GRCbm_Pe.js";import"./createFeatureId-CVwTD0fV-3fKpJDrk.js";import"./defaultsJSON-GKolV7NZ-GKolV7NZ.js";import"./diffUtils-wTC1YzlE-DCTUTUs8.js";import"./styleUtils-DWvicjTN-DL6_BIk4.js";const pe=Symbol("isKMLGraphicOrigin");var $;class ue extends le{get[($=pe,ne)](){return this.layer}constructor(t,r){super(),this[$]=!0,this.type="kml",this.layer=t,this.sublayer=r}get id(){return`${this.layer.id}:__${this.sublayer.id}__`}}const ye={esriGeometryPoint:"points",esriGeometryPolyline:"polylines",esriGeometryPolygon:"polygons"};function N(e){const t=e.folders||[],r=t.slice(),o=new Map,n=new Map,y=new Map,c=new Map,b=new Map,m={esriGeometryPoint:n,esriGeometryPolyline:y,esriGeometryPolygon:c};(e.featureCollection?.layers||[]).forEach(s=>{const h=v(s);h.featureSet.features=[];const u=s.featureSet.geometryType;o.set(u,h);const k=s.layerDefinition.objectIdField;u==="esriGeometryPoint"?E(n,k,s.featureSet.features):u==="esriGeometryPolyline"?E(y,k,s.featureSet.features):u==="esriGeometryPolygon"&&E(c,k,s.featureSet.features)}),e.groundOverlays&&e.groundOverlays.forEach(s=>{b.set(s.id,s)}),t.forEach(s=>{s.networkLinkIds.forEach(h=>{const u=fe(h,s.id,e.networkLinks);u&&r.push(u)})}),r.forEach(s=>{if(s.featureInfos){s.points=v(o.get("esriGeometryPoint")),s.polylines=v(o.get("esriGeometryPolyline")),s.polygons=v(o.get("esriGeometryPolygon")),s.mapImages=[];for(const h of s.featureInfos)switch(h.type){case"esriGeometryPoint":case"esriGeometryPolyline":case"esriGeometryPolygon":{const u=m[h.type].get(h.id);u&&s[ye[h.type]]?.featureSet.features.push(u);break}case"GroundOverlay":{const u=b.get(h.id);u&&s.mapImages.push(u);break}}s.fullExtent=G([s])}});const f=G(r);return{folders:t,sublayers:r,extent:f}}function C(e,t,r,o){const n=U?.findCredential(e);e=Q(e,{token:n?.token});const y=H.kmlServiceUrl;return X(y,{query:{url:e,model:"simple",folders:"",refresh:r!==0||void 0,outSR:JSON.stringify(t)},responseType:"json",signal:o})}function K(e,t,r=null,o=[]){const n=[],y={},c=t.sublayers,b=new Set(t.folders.map(m=>m.id));return c.forEach(m=>{const f=new e;if(r?f.read(m,r):f.read(m),o.length&&b.has(f.id)&&(f.visible=o.includes(f.id)),y[m.id]=f,m.parentFolderId!=null&&m.parentFolderId!==-1){const s=y[m.parentFolderId];s.sublayers||(s.sublayers=[]),s.sublayers?.unshift(f)}else n.unshift(f)}),n}function E(e,t,r){r.forEach(o=>{e.set(o.attributes[t],o)})}function me(e,t){let r;return t.some(o=>o.id===e&&(r=o,!0)),r}function fe(e,t,r){const o=me(e,r);return o&&(o.parentFolderId=t,o.networkLink=o),o}function G(e){const t=j(x),r=j(x);for(const o of e){if(o.polygons?.featureSet?.features)for(const n of o.polygons.featureSet.features)S(t,n.geometry),g(r,t);if(o.polylines?.featureSet?.features)for(const n of o.polylines.featureSet.features)S(t,n.geometry),g(r,t);if(o.points?.featureSet?.features)for(const n of o.points.featureSet.features)S(t,n.geometry),g(r,t);if(o.mapImages)for(const n of o.mapImages)S(t,n.extent),g(r,t)}return ae(r,x)?void 0:{xmin:r[0],ymin:r[1],zmin:r[2],xmax:r[3],ymax:r[4],zmax:r[5],spatialReference:O.WGS84}}var w;let p=w=class extends V(z(B)){constructor(...e){super(...e),this.description=null,this.fullExtent=null,this.id=null,this.networkLink=null,this.parent=null,this.sublayers=null,this.title=null,this.sourceJSON=null,this.layer=null,this.addHandles([F(()=>this.sublayers,"after-add",({item:t})=>{t.parent=this,t.layer=this.layer},d),F(()=>this.sublayers,"after-remove",({item:t})=>{t.layer=t.parent=null},d),P(()=>this.sublayers,(t,r)=>{if(r)for(const o of r)o.layer=o.parent=null;if(t)for(const o of t)o.parent=this,o.layer=this.layer},d),P(()=>this.layer,t=>{if(this.sublayers)for(const r of this.sublayers)r.layer=t},d)])}initialize(){M(()=>this.networkLink).then(()=>M(()=>this.visible===!0)).then(()=>this.load())}load(e){if(!this.networkLink||this.networkLink.viewFormat)return;const t=e!=null?e.signal:null,r=this._fetchService(this._get("networkLink")?.href??"",t).then(o=>{const n=G(o.sublayers);this.fullExtent=_.fromJSON(n),this.sourceJSON=o;const y=J(I.ofType(w),K(w,o));this.sublayers?this.sublayers.addMany(y):this.sublayers=y,this.layer?.emit("sublayer-update"),this.layer&&this.layer.notifyChange("visibleSublayers")});return this.addResolvingPromise(r),Promise.resolve(this)}get visible(){return this._get("visible")}set visible(e){this._get("visible")!==e&&(this._set("visible",e),this.layer&&this.layer.notifyChange("visibleSublayers"))}readVisible(e,t){return!!t.visibility}get origin(){return this.layer?new ue(this.layer,this):null}_fetchService(e,t){return C(e,this.layer.outSpatialReference,this.layer.refreshInterval,t).then(r=>N(r.data))}};i([l()],p.prototype,"description",void 0),i([l({type:_})],p.prototype,"fullExtent",void 0),i([l()],p.prototype,"id",void 0),i([l({readOnly:!0,value:null})],p.prototype,"networkLink",void 0),i([l({json:{write:{allowNull:!0}}})],p.prototype,"parent",void 0),i([l({type:I.ofType(p),json:{write:{allowNull:!0}}})],p.prototype,"sublayers",void 0),i([l({value:null,json:{read:{source:"name",reader:e=>A(e)}}})],p.prototype,"title",void 0),i([l({value:!0})],p.prototype,"visible",null),i([L("visible",["visibility"])],p.prototype,"readVisible",null),i([l()],p.prototype,"sourceJSON",void 0),i([l()],p.prototype,"layer",void 0),i([l()],p.prototype,"origin",null),p=w=i([R("esri.layers.support.KMLSublayer")],p);const he=["kml","xml"];let a=class extends ee(ie(se(te(oe(q(Z)))))){constructor(...e){super(...e),this._visibleFolders=[],this.allSublayers=new D({getCollections:()=>[this.sublayers],getChildrenFunction:t=>t.sublayers}),this.outSpatialReference=O.WGS84,this.path=null,this.legendEnabled=!1,this.operationalLayerType="KML",this.sublayers=null,this.type="kml",this.url=null}initialize(){this.addHandles([P(()=>this.sublayers,(e,t)=>{t&&t.forEach(r=>{r.parent=null,r.layer=null}),e&&e.forEach(r=>{r.parent=this,r.layer=this})},d),this.on("sublayer-update",()=>this.notifyChange("fullExtent"))])}normalizeCtorArgs(e,t){return typeof e=="string"?{url:e,...t}:e}get sublayerById(){const e=new Map;for(const t of this.allSublayers)e.set(t.id,t);return e}readSublayersFromItemOrWebMap(e,t){this._visibleFolders=t.visibleFolders}readSublayers(e,t,r){return K(p,t,r,this._visibleFolders)}writeSublayers(e,t){const r=[],o=e.toArray();for(;o.length;){const n=o[0];n.networkLink||(n.visible&&r.push(n.id),n.sublayers&&o.push(...n.sublayers.toArray())),o.shift()}t.visibleFolders=r}get title(){const e=this._get("title");return e&&this.originOf("title")!=="defaults"?e:this.url?Y(this.url,he)||"KML":e}set title(e){this._set("title",e)}get visibleSublayers(){const e=this.sublayers,t=[],r=o=>{o.visible&&(t.push(o),o.sublayers&&o.sublayers.forEach(r))};return e?.forEach(r),t}get fullExtent(){return this._recomputeFullExtent()}load(e){const t=e!=null?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["KML"],supportsData:!1},e).catch(T).then(()=>this._fetchService(t))),Promise.resolve(this)}destroy(){super.destroy(),this.allSublayers.destroy()}async _fetchService(e){const t=await Promise.resolve().then(()=>this.resourceInfo?{ssl:!1,data:this.resourceInfo}:C(this.url??"",this.outSpatialReference,this.refreshInterval,e)),r=N(t.data);r&&this.read(r,{origin:"service"})}_recomputeFullExtent(){let e=null;this.extent!=null&&(e=this.extent.clone());const t=r=>{if(r.sublayers)for(const o of r.sublayers.items)t(o),o.visible&&o.fullExtent&&(e!=null?e.union(o.fullExtent):e=o.fullExtent.clone())};return t(this),e}};i([l({readOnly:!0})],a.prototype,"allSublayers",void 0),i([l({readOnly:!0})],a.prototype,"sublayerById",null),i([l({type:O})],a.prototype,"outSpatialReference",void 0),i([l({type:String,json:{origins:{"web-scene":{read:!0,write:!0}},read:!1}})],a.prototype,"path",void 0),i([l({readOnly:!0,json:{read:!1,write:!1}})],a.prototype,"legendEnabled",void 0),i([l({type:["show","hide","hide-children"]})],a.prototype,"listMode",void 0),i([l({type:["KML"]})],a.prototype,"operationalLayerType",void 0),i([l({})],a.prototype,"resourceInfo",void 0),i([l({type:I.ofType(p),json:{write:{ignoreOrigin:!0}}})],a.prototype,"sublayers",void 0),i([L(["web-map","portal-item"],"sublayers",["visibleFolders"])],a.prototype,"readSublayersFromItemOrWebMap",null),i([L("service","sublayers",["sublayers"])],a.prototype,"readSublayers",null),i([W("sublayers")],a.prototype,"writeSublayers",null),i([l({readOnly:!0,json:{read:!1}})],a.prototype,"type",void 0),i([l({json:{origins:{"web-map":{read:{source:"title"}}},write:{ignoreOrigin:!0}}})],a.prototype,"title",null),i([l(re)],a.prototype,"url",void 0),i([l({readOnly:!0})],a.prototype,"visibleSublayers",null),i([l({type:_})],a.prototype,"extent",void 0),i([l()],a.prototype,"fullExtent",null),a=i([R("esri.layers.KMLLayer")],a);const qt=a;export{qt as default};
