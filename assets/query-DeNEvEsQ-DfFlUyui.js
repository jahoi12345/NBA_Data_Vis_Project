import{I as O,H as x,V as g,X as m}from"./Point-BfTTZoMu-DeJwQYfh.js";import{l as E}from"./normalizeUtils-85zLqeMi-C1bdAKNn.js";import{r as b}from"./pbfQueryUtils-DlZBMNQk-rXCy_evW.js";import{f as I}from"./jsonUtils-CmpazY1u-6pDLj5sx.js";import{a as R}from"./queryZScale-CRP3Sh_E-F3y679Wx.js";function S(t){const r={};for(const a in t){if(a==="declaredClass")continue;const i=t[a];if(i!=null&&typeof i!="function")if(Array.isArray(i)){r[a]=[];for(let u=0;u<i.length;u++)r[a][u]=S(i[u])}else typeof i=="object"?i.toJSON&&(r[a]=JSON.stringify(i)):r[a]=i}return r}function j(t,r){if(r&&t.type==="extent")return`${t.xmin},${t.ymin},${t.xmax},${t.ymax}`;if(r&&t.type==="point")return`${t.x},${t.y}`;const a=t.toJSON();return delete a.spatialReference,JSON.stringify(a)}function q(t,r,a){const{geometry:i}=t,u=t.compactGeometryEnabled??!1,e=t.toJSON();delete e.compactGeometryEnabled,delete e.defaultSpatialReferenceEnabled;const n=e;let s,o,l;if(i&&(o=i.spatialReference,l=m(o),n.geometryType=I(i),n.geometry=j(i,u),n.inSR=l),e.groupByFieldsForStatistics&&(n.groupByFieldsForStatistics=e.groupByFieldsForStatistics.join(",")),e.objectIds)switch(a?.uniqueIdFields?.length){case void 0:n.objectIds=e.objectIds.join(",");break;case 1:n.uniqueIds=JSON.stringify(e.objectIds),delete n.objectIds;break;default:n.uniqueIds=JSON.stringify(e.objectIds.map(c=>JSON.parse(c))),delete n.objectIds}if(e.orderByFields&&(n.orderByFields=e.orderByFields.join(",")),!e.outFields||!e.returnDistinctValues&&(r?.returnCountOnly||r?.returnExtentOnly||r?.returnIdsOnly)?delete n.outFields:e.outFields.includes("*")?n.outFields="*":n.outFields=e.outFields.join(","),e.outSR?(n.outSR=m(e.outSR),s=t.outSpatialReference):i&&(e.returnGeometry||e.returnCentroid)&&(n.outSR=n.inSR,s=o),e.returnGeometry&&delete e.returnGeometry,e.outStatistics&&(n.outStatistics=JSON.stringify(e.outStatistics)),e.fullText&&(n.fullText=JSON.stringify(e.fullText)),e.pixelSize&&(n.pixelSize=JSON.stringify(e.pixelSize)),e.quantizationParameters&&(t.defaultSpatialReferenceEnabled&&o!=null&&t.quantizationParameters?.extent!=null&&o.equals(t.quantizationParameters.extent.spatialReference)&&delete e.quantizationParameters.extent.spatialReference,n.quantizationParameters=JSON.stringify(e.quantizationParameters)),e.parameterValues&&(n.parameterValues=JSON.stringify(e.parameterValues)),e.rangeValues&&(n.rangeValues=JSON.stringify(e.rangeValues)),e.dynamicDataSource&&(n.layer=JSON.stringify({source:e.dynamicDataSource}),delete e.dynamicDataSource),e.timeExtent){const c=e.timeExtent,{start:y,end:f}=c;y==null&&f==null||(n.time=y===f?y:`${y??"null"},${f??"null"}`),delete e.timeExtent}return t.defaultSpatialReferenceEnabled&&o!=null&&s!=null&&o.equals(s)&&(n.defaultSR=n.inSR,delete n.inSR,delete n.outSR),n}const p="Layer does not support extent calculation.";function F(t,r,a){return q(t,r,a)}async function B(t,r,a,i,u){const e=r.timeExtent?.isEmpty?{data:{features:[]}}:await d(t,r,"json",i,void 0,u);return R(r,a,e.data),e}async function C(t,r,a,i,u){if(r.timeExtent?.isEmpty)return{data:a.createFeatureResult()};const e=await N(t,r,i,u),n=e;return n.data=b(e.data,a),n}function N(t,r,a,i){return d(t,r,"pbf",a,void 0,i)}function D(t,r,a,i){return r.timeExtent?.isEmpty?Promise.resolve({data:{objectIds:[]}}):d(t,r,"json",a,{returnIdsOnly:!0},i)}function v(t,r,a,i){return r.timeExtent?.isEmpty?Promise.resolve({data:{count:0}}):d(t,r,"json",a,{returnIdsOnly:!0,returnCountOnly:!0},i)}async function G(t,r,a){if(r.timeExtent?.isEmpty)return{data:{count:0,extent:null}};const i=await d(t,r,"json",a,{returnExtentOnly:!0,returnCountOnly:!0}),u=i.data;if(u.hasOwnProperty("extent"))return i;if(u.features)throw new Error(p);if(u.hasOwnProperty("count"))throw new Error(p);return i}function J(t,r){if(!t.returnIdsOnly||!r.uniqueIdFields)return t;const a={...t,returnUniqueIdsOnly:!0};return delete a.returnIdsOnly,a}async function d(t,r,a,i={},u={},e={}){const n=typeof t=="string"?O(t):t,s=r.geometry?[r.geometry]:[],o=await E(s,null,{signal:i.signal}),l=o?.[0];l!=null&&((r=r.clone()).geometry=l);const c=S({...n.query,f:a,...J(u,e),...F(r,u,e)});return x(g(n.path,w(r,u)?"query3d":"query"),{...i,responseType:a==="pbf"?"array-buffer":"json",query:{...c,...i.query}})}function w(t,r){return t.formatOf3DObjects!=null&&!(r.returnCountOnly||r.returnExtentOnly||r.returnIdsOnly)}export{C as B,D as C,v as D,G,N as J,S,d,q,B as v};
