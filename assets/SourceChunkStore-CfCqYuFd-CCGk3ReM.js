import{f as b,a6 as _e,F as tt,J as rt}from"./Point-BfTTZoMu-BAT2Wq6O.js";import{m as ae}from"./FieldsIndex-CimK-TqD-CrSnohIk.js";import{l as T,v as st}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{o as D,h as Ae,f as q}from"./memoryEstimations-Bd726a_p-0cVCY2Jz.js";import{O as p,Y as Be,P as it,_ as O}from"./OptimizedFeature-CwRGZPwv-Ddclhn0A.js";import{h as nt}from"./parquet-BvPtb2Qg-DEpjS4pk.js";import{I as at}from"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import{m as re,l as We}from"./aaBoundingBox-Cn49X7ge-DORLZxoS.js";import{F as z,X as ot,d as ht,K as me,t as dt,b as ut,e as lt,n as Ce,R as ct,S as ft,J as C,T as _t}from"./featureConversionUtils-BDA_FXJx-CUwkrHf5.js";import{r as Y,u as pe,J as ge}from"./TimeOnly-BERR31kg-PKcKegNB.js";import{K as mt,I as pt}from"./labelPoint-4nqVL63d-Dz1LbGNv.js";import{P as gt}from"./jsonUtils-CmpazY1u-ateEpj4Q.js";import{Z as oe,A as he,p as se}from"./quantizationUtils-Ceq-Uxsu-CDK8m1qL.js";import{X as yt,g as xt}from"./date-IqUzANpt-bLKO9IDT.js";import{H as It}from"./lengthUtils-Dt1_RvOO-bleznLOi.js";import{t as bt}from"./quickselect-QQC62dOK-Br2Ahhru.js";import{B as ye}from"./mathUtils-PIGhLnI9-B1tKUlUb.js";import{P as vt}from"./Polygon-D6wEPb3W-CpL9Efjx.js";import"./vec2f64-rIxtbMRN-Kai9mK1i.js";import{O as Tt}from"./aaBoundingRect-CjwcS2F3-D7aII9DY.js";import{K as N}from"./FixedIntervalBinParameters-8snYOK8a-BSPWw9c2.js";import{s as xe}from"./definitions-Dvg4hMIw-CdK2DzFN.js";function Ar(s,e,t){if(s==null)return null;const r=e.readArcadeFeature();e.contextTimeZone=t.$view?.timeZone;try{return s.evaluate(r,t)}catch(i){return st.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",i),null}}function De(s){return s==null||s===1/0||s===-1/0||typeof s=="number"&&isNaN(s)}function Br(s,e,t,r){if(s==null)return r??null;const i=e.readArcadeFeature();e.contextTimeZone=t.$view?.timeZone;const n=s.evaluate(i,t);return De(n)?r??null:n}let wt=class E{static fromBuffer(e,t){return new E(e,t)}static create(e,t=4294967295){const r=new Uint32Array(Math.ceil(e/32));return new E(r,t)}constructor(e,t){this._mask=0,this._buf=e,this._mask=t}_getIndex(e){return Math.floor(e/32)}get usedMemory(){return Ae(this._buf)}has(e){const t=this._mask&e;return!!(this._buf[this._getIndex(t)]&1<<t%32)}hasRange(e,t){let r=e,i=t;for(;r%32&&r!==i;){if(this.has(r))return!0;r++}for(;i%32&&r!==i;){if(this.has(r))return!0;i--}if(r===i)return!1;for(let n=r/32;n!==i/32;n++)if(this._buf[n])return!0;return!1}set(e){const t=this._mask&e,r=this._getIndex(t),i=1<<t%32;this._buf[r]|=i}setRange(e,t){let r=e,i=t;for(;r%32&&r!==i;)this.set(r++);for(;i%32&&r!==i;)this.set(i--);if(r!==i)for(let n=r/32;n!==i/32;n++)this._buf[n]=4294967295}unset(e){const t=this._mask&e,r=this._getIndex(t),i=1<<t%32;this._buf[r]&=4294967295^i}resize(e){const t=this._buf,r=new Uint32Array(Math.ceil(e/32));r.set(t),this._buf=r}or(e){for(let t=0;t<this._buf.length;t++)this._buf[t]|=e._buf[t];return this}and(e){for(let t=0;t<this._buf.length;t++)this._buf[t]&=e._buf[t];return this}xor(e){for(let t=0;t<this._buf.length;t++)this._buf[t]^=e._buf[t];return this}ior(e){for(let t=0;t<this._buf.length;t++)this._buf[t]|=~e._buf[t];return this}iand(e){for(let t=0;t<this._buf.length;t++)this._buf[t]&=~e._buf[t];return this}ixor(e){for(let t=0;t<this._buf.length;t++)this._buf[t]^=~e._buf[t];return this}any(){for(let e=0;e<this._buf.length;e++)if(this._buf[e])return!0;return!1}copy(e){for(let t=0;t<this._buf.length;t++)this._buf[t]=e._buf[t];return this}clone(){return new E(this._buf.slice(),this._mask)}clear(){for(let e=0;e<this._buf.length;e++)this._buf[e]=0;return this}forEachSet(e){for(let t=0;t<this._buf.length;t++){let r=this._buf[t],i=32*t;if(r)for(;r;)1&r&&e(i),r>>>=1,i++}}countSet(){let e=0;return this.forEachSet(t=>{e++}),e}},Mt=class{constructor(s){this._valid=wt.create(s),this._data=new Array(s)}get usedMemory(){let s=this._valid.usedMemory;if(this._data.length>0){const e=typeof this._data[0]=="string"?64:q;s+=this._data.length*e}return s}has(s){return this._valid.has(s)}set(s,e){this._valid.set(s),this._data[s]=e}get(s){return this._data[s]}};const V=T("featurelayer-simplify-thresholds")??[.5,.5,.5,.5],Ft=V[0],St=V[1],kt=V[2],At=V[3],ce=T("featurelayer-simplify-payload-size-factors")??[1,2,4],Bt=ce[0],Wt=ce[1],Ct=ce[2],Dt=T("featurelayer-simplify-mobile-factor")??2,Xt=T("esri-mobile"),Ie=4294967295;function Ot(s,e,t){if(!(s.length>e))for(;s.length<=e;)s.push(t)}class fe{constructor(e){this.metadata=e,this.type="FeatureSetReader",this._overrides=null,this._joined=[],this._objectIdToIndex=null,this._boundsBuffer=[],this._caches=new Map,this.arcadeDeclaredClass="esri.arcade.Feature",this._contextTimeZone=null}destroy(){}[Symbol.dispose](){this.destroy()}getAreaSimplificationThreshold(e,t){let r=1;const i=Xt?Dt:1;t>4e6?r=Ct*i:t>1e6?r=Wt*i:t>5e5?r=Bt*i:t>1e5&&(r=i);let n=0;return e>4e3?n=At*r:e>2e3?n=kt*r:e>100?n=St:e>15&&(n=Ft),n}getBounds(e){Ot(this._boundsBuffer,4*this.getIndex()+4,0);const t=this.getBoundsXMin();if(t===Ie||!isFinite(t))return!1;if(this.getBoundsXMin()===0){const d=this.readGeometryWorldSpace();if(d?.isPoint&&d.coords[0]===0&&d.coords[1]===0)return re(e,0,0,0,0),!0;if(!d)return this.setBoundsXMin(Ie),!1;let o=1/0,h=1/0,u=-1/0,l=-1/0;return d.forEachVertex((f,_)=>{o=Math.min(o,f),h=Math.min(h,_),u=Math.max(u,f),l=Math.max(l,_)}),this.setBoundsXMin(o),this.setBoundsYMin(h),this.setBoundsXMax(u),this.setBoundsYMax(l),re(e,o,h,u,l),!0}const r=this.getBoundsXMin(),i=this.getBoundsYMin(),n=this.getBoundsXMax(),a=this.getBoundsYMax();return re(e,r,i,n,a),!0}getBoundsXMin(){return this._boundsBuffer[4*this.getIndex()]}setBoundsXMin(e){this._boundsBuffer[4*this.getIndex()]=e}getBoundsYMin(){return this._boundsBuffer[4*this.getIndex()+1]}setBoundsYMin(e){this._boundsBuffer[4*this.getIndex()+1]=e}getBoundsXMax(){return this._boundsBuffer[4*this.getIndex()+2]}setBoundsXMax(e){this._boundsBuffer[4*this.getIndex()+2]=e}getBoundsYMax(){return this._boundsBuffer[4*this.getIndex()+3]}setBoundsYMax(e){this._boundsBuffer[4*this.getIndex()+3]=e}readAttributeAsTimestamp(e){const t=this.readAttribute(e);return typeof t=="string"?new Date(t).getTime():typeof t=="number"||t==null?t:null}readAttribute(e,t=!1){const r=this._readAttribute(e,t);if(r!==void 0)return r;for(const i of this._joined){i.setIndex(this.getIndex());const n=i._readAttribute(e,t);if(n!==void 0)return n}}readAttributes(){const e=this._readAttributes();for(const t of this._joined){t.setIndex(this.getIndex());const r=t._readAttributes();for(const i of Object.keys(r))e[i]=r[i]}return e}joinAttributes(e){this._joined.push(e)}registerOverrides(e){this._overrides=e}withoutOverrides(){const e=this.copy();return e._overrides=null,e}readOptimizedFeatureWorldSpace(){const e=this.readGeometryWorldSpace(),t=this.readAttributes(),r=this.readCentroidWorldSpace();return new Be(e,t,r,this.getObjectId(),this.getDisplayId())}readLegacyFeatureForDisplay(){const e=this.readCentroidForDisplay();return{attributes:this.readAttributes(),geometry:this.readLegacyGeometryForDisplay(),centroid:(e&&{x:e.coords[0],y:e.coords[1]})??null}}readLegacyFeatureWorldSpace(){const e=this.readCentroidWorldSpace();return{attributes:this.readAttributes(),geometry:this._readLegacyGeometryWorldSpace(),centroid:(e&&{x:e.coords[0],y:e.coords[1]})??null}}readLegacyGeometryForDisplay(){const e=this.readGeometryForDisplay();return z(e,this.geometryType,!1,!1)}readXForDisplay(){return this._readX()}readYForDisplay(){return this._readY()}readXWorldSpace(){const e=this._readX(),t=this.getInTransform();return t==null?e:e*t.scale[0]+t.translate[0]}readYWorldSpace(){const e=this._readY(),t=this.getInTransform();return t==null?e:t.translate[1]-e*t.scale[1]}readGeometryForDisplay(){const e=this._readGeometryDeltaDecoded(!0);if(!e){const t=this._createDeltaQuantizedGeometryFromServerCentroid();return t?t.deltaDecode():null}return e}readGeometryForDisplayTransformed(e){let t=this.readGeometryForDisplay();if(t&&this.metadata.geometryType==="esriGeometryPolyline"&&(t=ot(new p,t,this.hasZ,this.hasM,this.metadata.geometryType,e.scale[0])),t&&(t=ht(t,e,this.metadata.geometryType,this.hasZ,this.hasM)),!t){const r=this.readCentroidForDisplay();if(!r)return null;const i=oe(e,r.coords[0]),n=he(e,r.coords[1]);return this._createDeltaQuantizedExtrudedGeometry(i,n).deltaDecode()}return t}readGeometryWorldSpace(){let e=this._readGeometry();if(e||(e=this._createDeltaQuantizedGeometryFromServerCentroid()),!e)return null;const t=e.clone(),r=this.getInTransform();return r!=null&&me(t,t,this.hasZ,this.hasM,r),t}readCentroidForDisplay(){const e=this.readGeometryForDisplay();return e?this._computeDisplayCentroid(e):this._readServerCentroid()}readCentroidWorldSpace(){const e=this.readGeometryForDisplay(),t=e?this._computeDisplayCentroid(e):this._readServerCentroid();if(!t)return null;const r=t.clone(),i=this.getInTransform();return i!=null&&me(r,r,this.hasZ,this.hasM,i),r}setCache(e){let t=this._caches.get(e);t==null&&(t=new Mt(this.getSize()),this._caches.set(e,t)),this._activeCache=t}setCachedValue(e){this._activeCache.set(this.getIndex(),e)}hasCachedValue(){return this._activeCache.has(this.getIndex())}getCachedValue(){return this._activeCache.get(this.getIndex())}get underlyingMemory(){let e=0;e+=Ae(this._boundsBuffer);for(const t of this._caches.values())e+=t.usedMemory;return e}_readGeometryDeltaDecoded(e){const t=this._readGeometry(e);return this.geometryType!=="esriGeometryPoint"&&t&&this.getInTransform()?t.deltaDecode():t}get contextTimeZone(){return this._contextTimeZone}set contextTimeZone(e){this._contextTimeZone=e}readArcadeFeature(){return this}hasField(e){return this.fields.has(e)||this._joined.some(t=>t.hasField(e))}geometry(){const e=this.readGeometryWorldSpace(),t=z(e,this.geometryType,this.hasZ,this.hasM),r=gt(t);if(r){if(!this.metadata.outSpatialReference)throw new Error("InternalError: Expected spatial reference to be defined");r.spatialReference=this.metadata.outSpatialReference}return r}autocastArcadeDate(e,t){return t&&t instanceof Date?this.isUnknownDateTimeField(e)?Y.unknownDateJSToArcadeDate(t):Y.dateJSAndZoneToArcadeDate(t,this.contextTimeZone??yt):t}isUnknownDateTimeField(e){return this.metadata.fieldsIndex.getTimeZone(e)===xt}field(e){let t=this.fields.get(e);if(t)switch(t.type){case"date-only":case"esriFieldTypeDateOnly":return ge.fromReader(this.readAttribute(e,!1));case"time-only":case"esriFieldTypeTimeOnly":return pe.fromReader(this.readAttribute(e,!1));case"esriFieldTypeTimestampOffset":case"timestamp-offset":return Y.fromReaderAsTimeStampOffset(this.readAttribute(e,!1));case"date":case"esriFieldTypeDate":return this.autocastArcadeDate(e,this.readAttribute(e,!0));default:return this.readAttribute(e,!1)}for(const r of this._joined)if(r.setIndex(this.getIndex()),t=r.fields.get(e),t)switch(t.type){case"date-only":case"esriFieldTypeDateOnly":return ge.fromReader(r._readAttribute(e,!1));case"time-only":case"esriFieldTypeTimeOnly":return pe.fromReader(r._readAttribute(e,!1));case"esriFieldTypeTimestampOffset":case"timestamp-offset":return Y.fromReaderAsTimeStampOffset(r._readAttribute(e,!1));case"date":case"esriFieldTypeDate":return this.autocastArcadeDate(e,r._readAttribute(e,!0));default:return this.readAttribute(e,!1)}throw new Error(`Field ${e} does not exist`)}setField(e,t){throw new Error("Unable to update feature attribute values, feature is readonly")}keys(){return this.fields.fields.map(e=>e.name)}isEmpty(){return this.fields.fields.length<=0&&this.geometry()==null}castToText(e=!1){if(!e)return JSON.stringify(this.readLegacyFeatureForDisplay());const t=this.readLegacyFeatureForDisplay();if(!t)return JSON.stringify(null);const r={geometry:t.geometry,attributes:{...t.attributes}};for(const i in r.attributes){const n=r.attributes[i];n instanceof Date&&(r.attributes[i]=n.getTime())}return JSON.stringify(r)}gdbVersion(){return null}fullSchema(){return this.metadata.arcadeSchema}castAsJson(e=null){return{attributes:this._readAttributes(),geometry:e?.keepGeometryType===!0?this.geometry():this.geometry()?.toJSON()??null}}castAsJsonAsync(e=null,t=null){return Promise.resolve(this.castAsJson(t))}_getExists(){if(this._overrides){const e=this.getObjectId();return!this._overrides.hasOverride(e)}return!0}_computeDisplayCentroid(e){if(this.getInTransform()==null)return it(new p,e,this.hasM,this.hasZ);const t=mt.fromOptimized(e,this.geometryType);t.yFactor*=-1;const r=pt(t);return r?(r[1]*=-1,new p([],r)):null}copyInto(e){e._joined=this._joined,e._overrides=this._overrides,e._objectIdToIndex=this._objectIdToIndex,e._boundsBuffer=this._boundsBuffer,e._activeCache=this._activeCache,e._caches=this._caches,e._contextTimeZone=this._contextTimeZone}_readLegacyGeometryWorldSpace(){const e=this.readGeometryWorldSpace();return z(e,this.geometryType,!1,!1)}_createDeltaQuantizedGeometryFromServerCentroid(){const e=this._readServerCentroid();if(!e)return null;const[t,r]=e.coords;return this._createDeltaQuantizedExtrudedGeometry(t,r)}_createDeltaQuantizedExtrudedGeometry(e,t){return this.geometryType==="esriGeometryPolyline"?this._createDeltaQuantizedExtrudedLine(e,t):this._createDeltaQuantizedExtrudedQuad(e,t)}_createDeltaQuantizedExtrudedQuad(e,t){return new p([5],[e-1,t,1,-1,1,1,-1,1,-1,-1])}_createDeltaQuantizedExtrudedLine(e,t){return new p([2],[e-1,t+1,1,-1])}}let Xe=class v extends fe{static fromFeatures(e,t){const{geometryType:r}=t,i=dt([],e,r,!1,!1,t.featureIdInfo);for(let n=0;n<i.length;n++)i[n].displayId=e[n].displayId;return v.fromOptimizedFeatures(i,t)}static fromFeatureSet(e,t){const r=ut(e,t.featureIdInfo);return v.fromOptimizedFeatureSet(r,t)}static fromOptimizedFeatureSet(e,t){const r=v.fromOptimizedFeatures(e.features,t);return r._exceededTransferLimit=e.exceededTransferLimit,r._transform=e.transform,r._fieldsIndex=new ae(e.fields),r}static fromOptimizedFeatures(e,t,r){const i=new v(e,t);return i._fieldsIndex=t.fieldsIndex,i._transform=r,i}static empty(e){return new v([],e)}constructor(e,t){super(t),this._exceededTransferLimit=!1,this._featureIndex=-1,this._fieldsIndex=null,this._geometryType=t.geometryType,this._features=e}get fields(){return this._fieldsIndex}get geometryType(){return this._geometryType}get hasFeatures(){return!!this._features.length}get hasNext(){return this._featureIndex+1<this._features.length}get exceededTransferLimit(){return this._exceededTransferLimit}get hasZ(){return!1}get hasM(){return!1}get _current(){return this._features[this._featureIndex]}get usedMemory(){return this._current.usedMemory}getSize(){return this._features.length}getCursor(){return this.copy()}getInTransform(){return this._transform}getAttributeHash(){let e="";for(const t in this._current.attributes)e+=this._current.attributes[t];return e}getIndex(){return this._featureIndex}setIndex(e){this._featureIndex=e}getObjectId(){return this._current?.objectId}getDisplayId(){return this._current.displayId}setDisplayId(e){this._current.displayId=e}copy(){const e=new v(this._features,this.metadata);return this.copyInto(e),e}next(){for(;++this._featureIndex<this._features.length&&!this._getExists(););return this._featureIndex<this._features.length}readGeometryArea(){return O(this._current)?lt(this._current.geometry,2):0}_readX(){return O(this._current)?this._current.geometry.coords[0]:0}_readY(){return O(this._current)?this._current.geometry.coords[1]:0}_readGeometry(){return O(this._current)?this._current.geometry??null:null}_readServerCentroid(){return this._current.centroid}_readAttribute(e,t){if(!this._fieldsIndex){const n=this._current.attributes[e];if(n!==void 0)return n;const a=e.toLowerCase();for(const d in this._current.attributes)if(d.toLowerCase()===a)return this._current.attributes[d];return}const r=this._fieldsIndex.get(e);if(!r)return;const i=this._current.attributes[r.name];return i==null?i:t&&this.fields.isDateField(e)?new Date(i):i}_readAttributes(){return this._current.attributes}copyInto(e){super.copyInto(e),e._featureIndex=this._featureIndex,e._transform=this._transform,e._fieldsIndex=this._fieldsIndex}},Yt=class Oe{static{this.Shared=new Oe}getObjectId(e){return e.getObjectId()}getAttributes(e){return e.readAttributes()}getAttribute(e,t){return e.readAttribute(t)}getAttributeAsTimestamp(e,t){return e.readAttributeAsTimestamp(t)}cloneWithGeometry(e,t){const r=e.readAttributes(),i=new Be(t,r,null,e.getObjectId(),e.getDisplayId()),n=Xe.fromOptimizedFeatures([i],e.metadata);return n.setIndex(0),n}getGeometry(e){return e.readGeometryWorldSpace()}getCentroid(e,t){return e.readCentroidForDisplay()}},Wr=class P{static minimal(e,t,r=[]){return new P({geometryType:e,fieldsIndex:new ae(r).toJSON(),featureIdInfo:{type:"object-id",fieldName:t},subtypes:null,subtypeField:null,types:null,globalIdField:null,spatialReference:null,outSpatialReference:null,timeInfo:null,timeReferenceUnknownClient:null,dateFieldsTimeZone:null,typeIdField:null})}static createFeature(e){return new P(e)}constructor(e){let t;this._options=e,this._fieldsIndex=ae.fromJSON(e.fieldsIndex),e.spatialReference&&(e.spatialReference instanceof b?this._spatialReference=e.spatialReference:this._spatialReference=b.fromJSON(e.spatialReference)),e.outSpatialReference&&(e.outSpatialReference instanceof b?this._outSpatialReference=e.outSpatialReference:this._outSpatialReference=b.fromJSON(e.outSpatialReference)),e.featureIdInfo.type==="object-id"&&(t=e.featureIdInfo.fieldName),this._arcadeSchema={fields:this.fieldsIndex.fields,fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,objectIdField:t,globalIdField:this._options.globalIdField,spatialReference:this._spatialReference,timeInfo:this._options.timeInfo,typeIdField:this._options.typeIdField??void 0,types:this._options.types??void 0,subtypeField:this._options.subtypeField,subtypes:this._options.subtypes??void 0,datesInUnknownTimezone:this._options.timeReferenceUnknownClient??void 0,dateFieldsTimeZone:this._options.dateFieldsTimeZone??void 0}}get fieldsIndex(){return this._fieldsIndex}get geometryType(){return this._options.geometryType==="esriGeometryMultiPatch"?"esriGeometryPolygon":this._options.geometryType}get serviceGeometryType(){return this._options.geometryType}get subtypeField(){return this._options.subtypeField}get timeInfo(){return this._options.timeInfo}get featureIdInfo(){return this._options.featureIdInfo}get globalIdField(){return this._options.globalIdField}get arcadeSchema(){return this._arcadeSchema}get spatialReference(){return this._spatialReference}get outSpatialReference(){return this._outSpatialReference}get timeReferenceUnknownClient(){return this._options.timeReferenceUnknownClient}weakCloneWithAdditionalFields(e){return new P({fieldsIndex:{fields:[...this._fieldsIndex.fields,...e],timeZoneByFieldName:null},geometryType:this.geometryType,globalIdField:this.globalIdField,featureIdInfo:this.featureIdInfo,spatialReference:this.spatialReference,outSpatialReference:this.outSpatialReference,subtypeField:this.subtypeField,subtypes:this._options.subtypes,timeInfo:this.timeInfo,timeReferenceUnknownClient:this.timeReferenceUnknownClient,dateFieldsTimeZone:this._options.dateFieldsTimeZone,typeIdField:this._options.typeIdField,types:this._options.types})}},Ye=class{constructor(s){this._statistics=s}get statistics(){return this._statistics}};const be=Math.PI/180;let de=class ue{static create(e){return new ue(e.map(t=>Gt(t)))}constructor(e){this._statistics=e}static get estimatedMemory(){return D+4*D}values(){return this._statistics.values()}insert(e,t){for(const r of this._statistics)r.insert(e,t)}merge(e){for(let t=0;t<this._statistics.length;t++){const r=this._statistics[t],i=e._statistics[t];if(r.field.name!==i.field.name)throw new Error("InternalError: Tried to merge incompatible statistics");r.merge(i)}}clone(){return new ue(this._statistics.map(e=>e.clone()))}};function Gt(s){switch(s.statisticType){case"min":return new jt(s);case"max":return new Rt(s);case"avg":return new Et(s);case"avg_angle":return new Pt(s);case"sum":case"count":return new zt(s);case"mode":return new Ut(s)}}let S=class{constructor(s){this.field=s}insert(s,e){if(!this.field.computed)return;const t=this.field.computed.read(s,e);De(t)||this._insertValue(t)}},jt=class Ge extends S{constructor(){super(...arguments),this.type="min",this.value=Number.MAX_VALUE}_insertValue(e){this.value=Math.min(this.value,e)}merge(e){this.value=Math.min(this.value,e.value)}clone(){const e=new Ge(this.field);return e.value=this.value,e}},Rt=class je extends S{constructor(){super(...arguments),this.type="max",this.value=Number.MIN_VALUE}_insertValue(e){this.value=Math.max(this.value,e)}merge(e){this.value=Math.max(this.value,e.value)}clone(){const e=new je(this.field);return e.value=this.value,e}},zt=class Re extends S{constructor(){super(...arguments),this.type="sum",this.value=0}_insertValue(e){this.value+=e}merge(e){this.value+=e.value}clone(){const e=new Re(this.field);return e.value=this.value,e}},Et=class ze extends S{constructor(){super(...arguments),this.type="avg",this._total=0,this._count=0}get value(){return this._total/this._count}_insertValue(e){this._total+=e,this._count+=1}merge(e){this._total+=e._total,this._count+=e._count}clone(){const e=new ze(this.field);return e._total=this._total,e._count=this._count,e}},Pt=class Ee extends S{constructor(){super(...arguments),this.type="avg_angle",this._x=0,this._y=0,this._count=0}get value(){const e=this._x/this._count,t=this._y/this._count,r=180/Math.PI;return Math.atan2(t,e)*r}_insertValue(e){this._x=this._x+Math.cos(e*be),this._y=this._y+Math.sin(e*be),this._count+=1}merge(e){this._x+=e._x,this._y+=e._y,this._count+=e._count}clone(){const e=new Ee(this.field);return e._x=this._x,e._y=this._y,e._count=this._count,e}},Ut=class Pe extends S{constructor(){super(...arguments),this._frequencies=new Map}get value(){let e,t=0;for(const[r,i]of this._frequencies.entries())i>t&&(t=i,e=r);return e}_insertValue(e){const t=this._frequencies.get(e);t!=null?this._frequencies.set(e,t+1):this._frequencies.set(e,1)}merge(e){for(const[t,r]of e._frequencies.entries()){const i=this._frequencies.get(t);i!=null?this._frequencies.set(t,i+r):this._frequencies.set(t,r)}}clone(){const e=new Pe(this.field);return e._frequencies=new Map(this._frequencies),e}},ve=class U extends Ye{static createId(e,t){return`${e}.${t}`}static create(e,t,r,i){return new U(e,t,de.create(r),i)}constructor(e,t,r,i){super(r),this.gridX=e,this.gridY=t,this._worldUnitsPerCell=i,this._count=0,this._xWorldTotal=0,this._yWorldTotal=0,this._objectIds=new Set}get id(){return U.createId(this.gridX,this.gridY)}get containedObjectIds(){return this._objectIds}get count(){return this._count}get firstObjectId(){return this._objectIds.values().next().value}get centroidXWorld(){return this._xWorldTotal/this._count}get centroidYWorld(){return this._yWorldTotal/this._count}get usedMemory(){return 48}clone(){const e=new U(this.gridX,this.gridY,this._statistics.clone(),this._worldUnitsPerCell);return e._count=this._count,e._xWorldTotal=this._xWorldTotal,e._yWorldTotal=this._yWorldTotal,e._firstFeatureAttributes=this._firstFeatureAttributes,e._objectIds=new Set(this._objectIds),e}insert(e,t,r,i){this._count===0?this._firstFeatureAttributes=e.readAttributes():this._firstFeatureAttributes=null,this._count+=1,this._xWorldTotal+=r,this._yWorldTotal+=i,this._statistics.insert(e,t),this._objectIds.add(e.getObjectId())}merge(e){if(e._count!==0){this._count+=e._count,this._firstFeatureAttributes=e._firstFeatureAttributes,this._xWorldTotal+=e._xWorldTotal,this._yWorldTotal+=e._yWorldTotal,this._statistics.merge(e._statistics);for(const t of e._objectIds.values())this._objectIds.add(t)}}getCentroidX(e){return e==null?this.centroidXWorld:ct(e,this.centroidXWorld)}getCentroidY(e){return e==null?this.centroidYWorld:ft(e,this.centroidYWorld)}getGeometry(e,t){const r=this.gridX*this._worldUnitsPerCell,i=this.gridY*this._worldUnitsPerCell,n=new p([4],[r,i,r+this._worldUnitsPerCell,i,r+this._worldUnitsPerCell,i+this._worldUnitsPerCell,r,i+this._worldUnitsPerCell]);if(t!=null){const a=new p;return C(a,n,!1,!1,"esriGeometryPolygon",t)}return n}getCentroid(e){const t=new p([],[this.centroidXWorld,this.centroidYWorld]);if(e!=null){const r=new p;return C(r,t,!1,!1,"esriGeometryPoint",e)}return t}getGeometricCentroid(e,t){const r=this.gridX*this._worldUnitsPerCell+.5*this._worldUnitsPerCell,i=this.gridY*this._worldUnitsPerCell+.5*this._worldUnitsPerCell,n=new p([],[r,i]);if(t!=null){const a=new p;return C(a,n,!1,!1,"esriGeometryPoint",t)}return n}getAttributes(){const e={aggregateId:this.id};for(const t of this._statistics.values())e[t.field.name]=t.value;return this._firstFeatureAttributes!=null?{...e,...this._firstFeatureAttributes}:e}};function Lt(s,{timeZone:e,timeExtent:t}){return{$view:{scale:s,timeZone:e,timeProperties:{currentStart:t?.start,currentEnd:t?.end}}}}let Ue=class{constructor(s){this._options=s}insert(s,e){const t=s.getCursor(),{arcadeContextInfo:r,scale:i}=this._options,n=Lt(i,r);for(;t.next();)this._insertFeature(t,n,this._options.sqlOptions,e)}_insertFeature(s,e,t,r){const{featureFilter:i}=this._options;if(i!==null&&!i.check(s,t))return;let n=0,a=0;if(s.geometryType==="esriGeometryPoint")n=s.readXWorldSpace(),a=s.readYWorldSpace();else{if(r){const o=s.readCentroidForDisplay();if(o==null)return;const[h,u]=o.coords;if(h<0||h>xe||u<0||u>xe)return}const d=s.readCentroidWorldSpace();if(d==null)return;n=d.coords[0],a=d.coords[1]}this._insert(s,n,a,e)}};const Nt=96;function Zt(s,e){return tt(s)*rt*Nt/e}let $t=class extends Ue{constructor(s){super(s),this._cells=new Map,this._pixelsPerMapUnit=Zt(s.spatialReference,s.scale)}get usedMemory(){const s=this._cells.values().next().value;return s?(q+s.usedMemory)*this._cells.size:0}put(s){for(const e of this._cells.values()){const t=s.get(e.id);t?t.merge(e):s.set(e.id,e.clone())}}putBounded(s,e,t){const r=[e.xmin,e.ymin,e.xmax,e.ymax],[i,n,a,d]=r,o=Math.floor(i*this._pixelsPerMapUnit/this._options.cellSize),h=Math.floor(n*this._pixelsPerMapUnit/this._options.cellSize),u=Math.ceil(a*this._pixelsPerMapUnit/this._options.cellSize),l=Math.ceil(d*this._pixelsPerMapUnit/this._options.cellSize);for(let f=h;f<=l;f++)for(let _=o;_<=u;_++){const c=`${_}.${f}`,m=this._cells.get(c);if(!m)continue;const x=s.get(m.id);x?m&&!s.has(m.id)&&x.merge(m):s.set(m.id,m.clone())}}_insert(s,e,t,r){const i=e*this._pixelsPerMapUnit,n=t*this._pixelsPerMapUnit,a=Math.floor(i/this._options.cellSize),d=Math.floor(n/this._options.cellSize);this._getCellOrCreate(a,d).insert(s,r,e,t)}_getCellOrCreate(s,e){const t=ve.createId(s,e);let r=this._cells.get(t);if(!r){const i=1*this._options.cellSize/this._pixelsPerMapUnit;r=ve.create(s,e,this._options.fields,i),this._cells.set(t,r)}return r}};function Z(s,e){if(!(this instanceof Z))return new Z(s,e);this._maxEntries=Math.max(4,s||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),e&&(typeof e=="function"?this.toBBox=e:this._initFormat(e)),this.clear()}function Jt(s,e,t){if(!t)return e.indexOf(s);for(var r=0;r<e.length;r++)if(t(s,e[r]))return r;return-1}function w(s,e){B(s,0,s.children.length,e,s)}function B(s,e,t,r,i){i||(i=M(null)),i.minX=1/0,i.minY=1/0,i.maxX=-1/0,i.maxY=-1/0;for(var n,a=e;a<t;a++)n=s.children[a],W(i,s.leaf?r(n):n);return i}function W(s,e){return s.minX=Math.min(s.minX,e.minX),s.minY=Math.min(s.minY,e.minY),s.maxX=Math.max(s.maxX,e.maxX),s.maxY=Math.max(s.maxY,e.maxY),s}function Te(s,e){return s.minX-e.minX}function we(s,e){return s.minY-e.minY}function ie(s){return(s.maxX-s.minX)*(s.maxY-s.minY)}function G(s){return s.maxX-s.minX+(s.maxY-s.minY)}function qt(s,e){return(Math.max(e.maxX,s.maxX)-Math.min(e.minX,s.minX))*(Math.max(e.maxY,s.maxY)-Math.min(e.minY,s.minY))}function Vt(s,e){var t=Math.max(s.minX,e.minX),r=Math.max(s.minY,e.minY),i=Math.min(s.maxX,e.maxX),n=Math.min(s.maxY,e.maxY);return Math.max(0,i-t)*Math.max(0,n-r)}function ne(s,e){return s.minX<=e.minX&&s.minY<=e.minY&&e.maxX<=s.maxX&&e.maxY<=s.maxY}function j(s,e){return e.minX<=s.maxX&&e.minY<=s.maxY&&e.maxX>=s.minX&&e.maxY>=s.minY}function M(s){return{children:s,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function Me(s,e,t,r,i){for(var n,a=[e,t];a.length;)(t=a.pop())-(e=a.pop())<=r||(n=e+Math.ceil((t-e)/r/2)*r,bt(s,n,e,t,i),a.push(e,n,n,t))}Z.prototype={all:function(){return this._all(this.data,[])},search:function(s){var e=this.data,t=[],r=this.toBBox;if(!j(s,e))return t;for(var i,n,a,d,o=[];e;){for(i=0,n=e.children.length;i<n;i++)a=e.children[i],j(s,d=e.leaf?r(a):a)&&(e.leaf?t.push(a):ne(s,d)?this._all(a,t):o.push(a));e=o.pop()}return t},collides:function(s){var e=this.data,t=this.toBBox;if(!j(s,e))return!1;for(var r,i,n,a,d=[];e;){for(r=0,i=e.children.length;r<i;r++)if(n=e.children[r],j(s,a=e.leaf?t(n):n)){if(e.leaf||ne(s,a))return!0;d.push(n)}e=d.pop()}return!1},load:function(s){if(!s||!s.length)return this;if(s.length<this._minEntries){for(var e=0,t=s.length;e<t;e++)this.insert(s[e]);return this}var r=this._build(s.slice(),0,s.length-1,0);if(this.data.children.length)if(this.data.height===r.height)this._splitRoot(this.data,r);else{if(this.data.height<r.height){var i=this.data;this.data=r,r=i}this._insert(r,this.data.height-r.height-1,!0)}else this.data=r;return this},insert:function(s){return s!=null&&this._insert(s,this.data.height-1),this},clear:function(){return this.data=M([]),this},remove:function(s,e){if(s==null)return this;for(var t,r,i,n,a=this.data,d=this.toBBox(s),o=[],h=[];a||o.length;){if(a||(a=o.pop(),r=o[o.length-1],t=h.pop(),n=!0),a.leaf&&(i=Jt(s,a.children,e))!==-1)return a.children.splice(i,1),o.push(a),this._condense(o),this;n||a.leaf||!ne(a,d)?r?(t++,a=r.children[t],n=!1):a=null:(o.push(a),h.push(t),t=0,r=a,a=a.children[0])}return this},toBBox:function(s){return s},compareMinX:Te,compareMinY:we,toJSON:function(){return this.data},fromJSON:function(s){return this.data=s,this},_all:function(s,e){for(var t=[];s;)s.leaf?e.push.apply(e,s.children):t.push.apply(t,s.children),s=t.pop();return e},_build:function(s,e,t,r){var i,n=t-e+1,a=this._maxEntries;if(n<=a)return w(i=M(s.slice(e,t+1)),this.toBBox),i;r||(r=Math.ceil(Math.log(n)/Math.log(a)),a=Math.ceil(n/Math.pow(a,r-1))),(i=M([])).leaf=!1,i.height=r;var d,o,h,u,l=Math.ceil(n/a),f=l*Math.ceil(Math.sqrt(a));for(Me(s,e,t,f,this.compareMinX),d=e;d<=t;d+=f)for(Me(s,d,h=Math.min(d+f-1,t),l,this.compareMinY),o=d;o<=h;o+=l)u=Math.min(o+l-1,h),i.children.push(this._build(s,o,u,r-1));return w(i,this.toBBox),i},_chooseSubtree:function(s,e,t,r){for(var i,n,a,d,o,h,u,l;r.push(e),!e.leaf&&r.length-1!==t;){for(u=l=1/0,i=0,n=e.children.length;i<n;i++)o=ie(a=e.children[i]),(h=qt(s,a)-o)<l?(l=h,u=o<u?o:u,d=a):h===l&&o<u&&(u=o,d=a);e=d||e.children[0]}return e},_insert:function(s,e,t){var r=this.toBBox,i=t?s:r(s),n=[],a=this._chooseSubtree(i,this.data,e,n);for(a.children.push(s),W(a,i);e>=0&&n[e].children.length>this._maxEntries;)this._split(n,e),e--;this._adjustParentBBoxes(i,n,e)},_split:function(s,e){var t=s[e],r=t.children.length,i=this._minEntries;this._chooseSplitAxis(t,i,r);var n=this._chooseSplitIndex(t,i,r),a=M(t.children.splice(n,t.children.length-n));a.height=t.height,a.leaf=t.leaf,w(t,this.toBBox),w(a,this.toBBox),e?s[e-1].children.push(a):this._splitRoot(t,a)},_splitRoot:function(s,e){this.data=M([s,e]),this.data.height=s.height+1,this.data.leaf=!1,w(this.data,this.toBBox)},_chooseSplitIndex:function(s,e,t){var r,i,n,a,d,o,h,u;for(o=h=1/0,r=e;r<=t-e;r++)a=Vt(i=B(s,0,r,this.toBBox),n=B(s,r,t,this.toBBox)),d=ie(i)+ie(n),a<o?(o=a,u=r,h=d<h?d:h):a===o&&d<h&&(h=d,u=r);return u},_chooseSplitAxis:function(s,e,t){var r=s.leaf?this.compareMinX:Te,i=s.leaf?this.compareMinY:we;this._allDistMargin(s,e,t,r)<this._allDistMargin(s,e,t,i)&&s.children.sort(r)},_allDistMargin:function(s,e,t,r){s.children.sort(r);var i,n,a=this.toBBox,d=B(s,0,e,a),o=B(s,t-e,t,a),h=G(d)+G(o);for(i=e;i<t-e;i++)n=s.children[i],W(d,s.leaf?a(n):n),h+=G(d);for(i=t-e-1;i>=e;i--)n=s.children[i],W(o,s.leaf?a(n):n),h+=G(o);return h},_adjustParentBBoxes:function(s,e,t){for(var r=t;r>=0;r--)W(e[r],s)},_condense:function(s){for(var e,t=s.length-1;t>=0;t--)s[t].children.length===0?t>0?(e=s[t-1].children).splice(e.indexOf(s[t]),1):this.clear():w(s[t],this.toBBox)},_initFormat:function(s){var e=["return a"," - b",";"];this.compareMinX=new Function("a","b",e.join(s[0])),this.compareMinY=new Function("a","b",e.join(s[1])),this.toBBox=new Function("a","return {minX: a"+s[0]+", minY: a"+s[1]+", maxX: a"+s[2]+", maxY: a"+s[3]+"};")}};let Qt=class Le{static fromReader(e){const t=[],r=e.copy(),i=We();for(;r.next();)r.getBounds(i)&&t.push(r.getIndex());const n=Z(9,a=>(r.setIndex(a),{minX:r.getBoundsXMin(),minY:r.getBoundsYMin(),maxX:r.getBoundsXMax(),maxY:r.getBoundsYMax()}));return n.load(t),new Le(n,t.length)}constructor(e,t){this._index=e,this._size=t}get usedMemory(){return this._size*q}search(e){const t={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]};return this._index.search(t)}};const Ht=64;function Kt(s,e,t,r){const i=[s.xmin,s.ymin,s.xmax,s.ymax],n=vt.fromExtent(Tt(i,r)),a=N(n,r,b.WGS84,{extendedParams:{densificationStep:e*Ht}});if(!a)return null;const d=Ce(new p,a,!1,!1),o=d.coords.filter((x,g)=>!(g%2)),h=d.coords.filter((x,g)=>g%2),u=Math.min(...o),l=Math.min(...h),f=Math.max(...o),_=Math.max(...h),c=le(u,l,t,b.WGS84),m=le(f,_,t,b.WGS84);return c&&m?{bounds:i,geohashBounds:{xLL:c[0],yLL:c[1],xTR:m[0],yTR:m[1]},level:t}:null}function le(s,e,t,r){if(r.isWebMercator){const a=ye(s/_e.radius),d=a-360*Math.floor((a+180)/360),o=[0,0];return Fe(o,0,ye(Math.PI/2-2*Math.atan(Math.exp(-e/_e.radius))),d,t),o}const i=N({x:s,y:e},r,b.WGS84);if(!i)return null;const n=[0,0];return Fe(n,0,i.y,i.x,t),n}function er(s,e){let t=-90,r=90,i=-180,n=180;for(let a=0;a<e;a++){const d=Math.ceil((a+1)/2),o=Math.floor((a+1)/2),h=1-a%2,u=30-(3*d+2*o),l=30-(2*d+3*o),f=3*h+2*(1-h),_=2*h+3*(1-h),c=3*h+7*(1-h)<<l,m=(7*h+3*(1-h)<<u&s.geohashX)>>u,x=(c&s.geohashY)>>l;for(let g=f-1;g>=0;g--){const I=(i+n)/2,y=m&1<<g?1:0;i=(1-y)*i+y*I,n=(1-y)*I+y*n}for(let g=_-1;g>=0;g--){const I=(t+r)/2,y=x&1<<g?1:0;t=(1-y)*t+y*I,r=(1-y)*I+y*r}}return[i,t,n,r]}function Fe(s,e,t,r,i){i%2&&(i+=1);let n=0,a=0,d=-90,o=90,h=-180,u=180;for(let l=0;l<i/2;l++){for(let f=0;f<5;f++){const _=(h+u)/2,c=r>_?1:0;n|=c<<29-(f+5*l),h=(1-c)*h+c*_,u=(1-c)*_+c*u}for(let f=0;f<5;f++){const _=(d+o)/2,c=t>_?1:0;a|=c<<29-(f+5*l),d=(1-c)*d+c*_,o=(1-c)*_+c*o}}s[2*e]=n,s[2*e+1]=a}const Se=32;class F extends Ye{static create(e,t,r,i){const n=de.create(e),a=new Array(Se);for(let d=0;d<a.length;d++)a[d]=null;return new F(n,t,r,i,a)}constructor(e,t,r,i,n){super(e),this.xNode=t,this.yNode=r,this.depth=i,this.children=n,this._objectIds=new Set,this._count=0,this._xWorldTotal=0,this._yWorldTotal=0,this._xGeohashTotal=0,this._yGeohashTotal=0,this.next=null}static get estimatedMemory(){let e=0;return e+=2*D,e+=q*Se,e+=de.estimatedMemory,e}get id(){return`${this.xNode}.${this.yNode}`}get containedObjectIds(){return this._objectIds}get count(){return this._count}clone(){const e=new F(this._statistics.clone(),this.xNode,this.yNode,this.depth,this.children);return e._count=this._count,e._xWorldTotal=this._xWorldTotal,e._yWorldTotal=this._yWorldTotal,e._xGeohashTotal=this._xGeohashTotal,e._yGeohashTotal=this._yGeohashTotal,e.next=this.next,e._objectIds=new Set(this._objectIds),e}insert(e,t,r,i,n,a){this._count+=1,this._xWorldTotal+=t,this._yWorldTotal+=r,this._xGeohashTotal+=i,this._yGeohashTotal+=n,this._statistics.insert(e,a),this._objectIds.add(e.getObjectId())}merge(e){if(e._count!==0){this._count+=e._count,this._xWorldTotal+=e._xWorldTotal,this._yWorldTotal+=e._yWorldTotal,this._xGeohashTotal+=e._xWorldTotal,this._yGeohashTotal+=e._yWorldTotal,this._statistics.merge(e._statistics);for(const t of e._objectIds.values())this._objectIds.add(t)}}getCentroid(e){throw new Error("getCentroid not supported for GeohashNode")}getGeometry(e,t){const r=this._getLngLatBounds(),[i,n,a,d]=r,o=N({rings:[[[i,n],[i,d],[a,d],[a,n],[i,n]]]},b.WGS84,e),h=Ce(new p,o,!1,!1);return t!=null?C(new p,h,!1,!1,"esriGeometryPolygon",t,!1,!1):h}getGeometricCentroid(e,t){const r=this._getLngLatBounds(),[i,n,a,d]=r,o=N({x:(i+a)/2,y:(n+d)/2},b.WGS84,e),h=_t(new p,o);return t!=null?C(new p,h,!1,!1,"esriGeometryPoint",t,!1,!1):h}getAttributes(){const e={aggregateId:this.id};for(const t of this._statistics.values())e[t.field.name]=t.value;return e.aggregateCount=this._count,e}find(e,t,r,i,n,a){if(i>=r)return this;const d=1-i%2,o=3*d+2*(1-d),h=2*d+3*(1-d),u=30-n-o,l=30-a-h,f=((e&7*d+3*(1-d)<<u)>>u)+((t&3*d+7*(1-d)<<l)>>l)*(8*d+4*(1-d)),_=this.children[f];return _==null?null:_.find(e,t,r,i+1,n+o,a+h)}_getLngLatBounds(){const e=this.depth,t=Math.ceil(e/2),r=Math.floor(e/2),i=30-(3*t+2*r),n=30-(2*t+3*r),a=this.xNode<<i,d=this.yNode<<n;return er({geohashX:a,geohashY:d},this.depth)}}class tr{constructor(e){this._fields=e,this._size=0,this._depth=0,this._root=F.create(this._fields,0,0,0)}destroy(){}get size(){return this._size}get depth(){return this._depth}get usedMemory(){return this._size*F.estimatedMemory}find(e,t,r){return this._root.find(e,t,r,0,0,0)}insert(e,t,r,i,n,a,d){let o=this._root,h=0,u=0,l=0;for(;o!==null;){if(o.insert(e,t,r,i,n,d),h>=a)return;const f=Math.ceil((h+1)/2),_=Math.floor((h+1)/2),c=1-h%2,m=30-(3*f+2*_),x=30-(2*f+3*_),g=(i&7*c+3*(1-c)<<m)>>m,I=(n&3*c+7*(1-c)<<x)>>x,y=g+I*(8*c+4*(1-c));u=u<<3*c+2*(1-c)|g,l=l<<2*c+3*(1-c)|I,o.children[y]==null&&(o.children[y]=F.create(this._fields,u,l,h+1),this._depth=Math.max(this._depth,h+1),this._size+=1),h+=1,o=o.children[y]}}putBins(e,t){for(const r of this.getNodes(t)){const i=e.get(r.id);i?i.merge(r):e.set(r.id,r.clone())}}getNodes(e){const t=[],{geohashBounds:r,level:i}=e;let n=this._root;for(;n!==null;){const a=n.depth,d=n.xNode,o=n.yNode;if(a>=i){t.push(n),n=n.next;continue}const h=Math.ceil((a+1)/2),u=Math.floor((a+1)/2),l=1-a%2,f=30-(3*h+2*u),_=30-(2*h+3*u),c=~((1<<f)-1),m=~((1<<_)-1),x=(r.xLL&c)>>f,g=(r.yLL&m)>>_,I=(r.xTR&c)>>f,y=(r.yTR&m)>>_,Q=d<<3*l+2*(1-l),H=o<<2*l+3*(1-l),Je=Q+8*l+4*(1-l),qe=H+4*l+8*(1-l),Ve=Math.max(Q,x),Qe=Math.max(H,g),He=Math.min(Je,I),Ke=Math.min(qe,y);let X=null,K=null;for(let ee=Qe;ee<=Ke;ee++)for(let te=Ve;te<=He;te++){const et=te-Q+(ee-H)*(8*l+4*(1-l)),k=n.children[et];k&&(X||(X=k,X.next=n.next),K&&(K.next=k),K=k,k.next=n.next)}n=X||n.next}return t}}let rr=class extends Ue{constructor(s){super(s),this._tree=new tr(this._options.fields)}get usedMemory(){return this._tree.usedMemory}put(s){throw new Error("Geohash tree does not support put")}putBounded(s,e,t){const{geohashLevel:r,spatialReference:i}=this._options,n=Kt(e,t,r,i);n!=null&&this._tree.putBins(s,n)}_insert(s,e,t,r){const{geohashLevel:i,spatialReference:n}=this._options,a=le(e,t,i,n);a&&this._tree.insert(s,e,t,a[0],a[1],i,r)}},sr=class L extends fe{static from(e,t){if(e instanceof this){const r=new Set(t),i=e._indices.filter(n=>r.has(n));return new L(e._reader,i)}return new L(e.copy(),t)}constructor(e,t){super(e.metadata),this._currentIndex=-1,this._displayTransform=null,this._reader=e,this._indices=t}setTransformForDisplay(e){const t=this._reader.getInTransform();if(t==null)return void(this._displayTransform=se(e));const r=se(t),i=se(e),[n,a]=r.scale,[d,o]=r.translate,[h,u]=i.scale,[l,f]=i.translate,_=n/h,c=a/u,m=(d-l)/h,x=(o-f)/u;this._displayTransform={originPosition:"lowerLeft",scale:[1/_,1/c,1,1],translate:[-m/_,-x/c,0,0]}}getInTransform(){return this._reader.getInTransform()}get fields(){return this._reader.fields}get hasNext(){return this._currentIndex+1<this._indices.length}getSize(){return this._indices.length}getCursor(){return this.copy()}copy(){const e=new L(this._reader.copy(),this._indices);return e._currentIndex=this._currentIndex,e._displayTransform=this._displayTransform,e._processorAttributes=this._processorAttributes,e}get contextTimeZone(){return this._reader.contextTimeZone}set contextTimeZone(e){this._reader.contextTimeZone=e}get usedMemory(){return D+this._reader.usedMemory}setProcessorAttributes(e){this._processorAttributes=Object.assign(this._processorAttributes??{},e)}_nextIndex(){return++this._currentIndex<this._indices.length&&(this._reader.setIndex(this._indices[this._currentIndex]),!0)}next(){for(;this._nextIndex()&&!this._reader._getExists(););return this._currentIndex<this._indices.length}readXForDisplay(){return this._displayTransform?oe(this._displayTransform,this._reader.readXForDisplay()):this._reader.readXForDisplay()}readYForDisplay(){return this._displayTransform?he(this._displayTransform,this._reader.readYForDisplay()):this._reader.readYForDisplay()}readGeometryForDisplay(){return this._displayTransform?this._reader.readGeometryForDisplayTransformed(this._displayTransform):this._reader.readGeometryForDisplay()}readCentroidForDisplay(){const e=this._reader.readCentroidForDisplay()?.clone();if(e){const[t,r]=e.coords;this._displayTransform?(e.coords[0]=oe(this._displayTransform,t),e.coords[1]=he(this._displayTransform,r)):(e.coords[0]=t,e.coords[1]=r)}return e}get geometryType(){return this._reader.geometryType}get hasFeatures(){return this._reader.hasFeatures}get exceededTransferLimit(){return this._reader.exceededTransferLimit}get hasZ(){return this._reader.hasZ}get hasM(){return this._reader.hasM}readAttribute(e,t=!1){const r=this._reader.readAttribute(e,t);return r==null&&this._processorAttributes?this._processorAttributes[e]:r}readAttributes(){return{...this._processorAttributes,...this._reader.readAttributes()}}joinAttributes(e){return this._reader.joinAttributes(e)}getBounds(e){return this._reader.getBounds(e)}getAttributeHash(){return this._reader.getAttributeHash()}getObjectId(){return this._reader.getObjectId()}getDisplayId(){return this._reader.getDisplayId()}setDisplayId(e){return this._reader.setDisplayId(e)}setIndex(e){return this._reader.setIndex(e)}getIndex(){return this._reader.getIndex()}readXWorldSpace(){return this._reader.readXWorldSpace()}readYWorldSpace(){return this._reader.readYWorldSpace()}_readX(){return this._reader.readXForDisplay()}_readY(){return this._reader.readYForDisplay()}_readServerCentroid(){return this._reader._readServerCentroid()}readLegacyFeatureForDisplay(){const e=this.readCentroidForDisplay();return{attributes:this.readAttributes(),geometry:this.readLegacyGeometryForDisplay(),centroid:(e&&{x:e.coords[0],y:e.coords[1]})??null}}readLegacyGeometryForDisplay(){const e=this.readGeometryForDisplay();return z(e,this.geometryType,!1,!1)}readGeometryArea(){return this._displayTransform?this._reader.readGeometryForDisplayTransformed(this._displayTransform)?.area()??0:this._reader.readGeometryArea()}readGeometryWorldSpace(){return this._reader.readGeometryWorldSpace()}_readGeometry(){return this._reader._readGeometry()}_readAttribute(e,t){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}_readAttributes(){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}readArcadeFeature(){return this._reader.readArcadeFeature()}geometry(){return this._reader.geometry()}field(e){return this._reader.field(e)}hasField(e){return this._reader.hasField(e)}setField(e,t){return this._reader.setField(e,t)}keys(){return this._reader.keys()}castToText(e=!1){return this._reader.castToText(e)}},Ne=class{size(){return this.reader.getSize()}get fields(){return this.reader.fields}invalidate(){this._aggregateIndex=null,this._aggregateIndexHash=null,this._spatialIndex=null}get usedMemory(){let s=0;return s+=this.reader.underlyingMemory,this._aggregateIndex&&(s+=this._aggregateIndex.usedMemory),this._spatialIndex&&(s+=this._spatialIndex.usedMemory),s}registerOverrides(s){this.reader.registerOverrides(s),this.invalidate()}queryFeaturesInBounds(s){const e=this._getSpatialIndex().search(s);return sr.from(this.reader,e)}getAggregateIndex(s){const e=JSON.stringify(s);if(e!==this._aggregateIndexHash){switch(this._aggregateIndexHash=e,s.type){case"grid":this._aggregateIndex=new $t(s);break;case"geohash":this._aggregateIndex=new rr(s)}this._aggregateIndex.insert(this.reader,this.isTiled)}return this._aggregateIndex}_getSpatialIndex(){return this._spatialIndex||(this._spatialIndex=Qt.fromReader(this.reader)),this._spatialIndex}};const ke=1e4,ir=1e3;class ${static async create(e){const{metadata:t,definitionExpression:r}=e,i=r?await It(r,t.fieldsIndex):null;return new $(t,i,r)}constructor(e,t,r){this.metadata=e,this._clause=t,this._definitionExpression=r}get hash(){return this._definitionExpression}testFeature(e){return this._clause==null||this._clause.testFeature(e)}}class J{constructor(){this.modified=new Map,this.removed=new Set}modify(e){this.modified.set(e.objectId,e),this.removed.has(e.objectId)&&this.removed.delete(e.objectId)}remove(e){this.modified.delete(e),this.removed.add(e)}get isEmpty(){return this.modified.size===0&&this.removed.size===0}applyWhereClause(e){const t=new J;for(const[r,i]of this.modified)e.testFeature(i)?t.modified.set(r,i):t.removed.add(i.objectId);for(const r of this.removed)t.removed.add(r);return t}}let nr=class Ze extends Ne{constructor(e){super(),this._reader=e,this.chunkId="override",this.normalizedChunkId="override"}static fromFeatures(e,t){const r=Xe.fromOptimizedFeatures(e,t);return new Ze(r)}get reader(){return this._reader}get queryInfo(){return{}}get first(){return!1}get end(){return!1}get isTiled(){return!1}getTileReader(e){if(!this._reader.getSize())return null;const t=this.queryFeaturesInBounds(e.bounds);return t.setTransformForDisplay(e.transform),t}};class R{constructor(e,t){this.inner=e,this.isWeak=t,this.lastWeak=null}get isStrong(){return!this.isWeak}}class ar{constructor(e){this._parameters=e,this._overrides=new Map,this._update=new J,this._lastCleanup=0}update(e){this._parameters=e}hasOverride(e){return this._overrides.has(e)}onChunkInsert(e){if(this._overrides.size){const t=e.reader.getCursor();for(;t.next();){const r=t.getObjectId(),i=this._overrides.get(r);if(i?.lastWeak&&(i.lastWeak=null),i?.isWeak){const n=t.readOptimizedFeatureWorldSpace(),a=i.inner?.attributes??{};n.attributes={...a,...n.attributes},i.inner=n,this._update.modify(n),this.invalidate()}}}e.registerOverrides(this)}apply(e,t){const{updateWeak:r,removeWeak:i,update:n,remove:a,release:d}=e.commands;this.invalidate();for(const o of r){const h=new R(o,!0),u=this._overrides.get(o.objectId);u?.isStrong?u.lastWeak=h:(this._overrides.set(o.objectId,h),this._update.modify(o))}for(const o of n){const h=new R(o,!1),u=this._overrides.get(o.objectId);h.lastWeak=u?.isWeak?u:u?.lastWeak??null,this._overrides.set(o.objectId,h),this._update.modify(o)}for(const o of i){const h=new R(null,!0),u=this._overrides.get(o);u?.isStrong?u.lastWeak=h:(this._overrides.set(o,h),this._update.remove(o))}for(const o of a){const h=new R(null,!1),u=this._overrides.get(o);h.lastWeak=u?.isWeak?u:u?.lastWeak??null,this._overrides.set(o,h),this._update.remove(o)}if(d.length){const o=new Set;for(const h of d){const u=this._overrides.get(h);u?.lastWeak?(this._overrides.set(h,u.lastWeak),u.lastWeak.inner==null?this._update.remove(h):this._update.modify(u.lastWeak.inner)):u&&!u.isWeak&&(this._overrides.delete(h),o.add(h))}t.forEachUnsafe(h=>{const u=h.getObjectId();o.has(u)&&(this._update.modify(h.readOptimizedFeatureWorldSpace()),o.delete(u))});for(const h of o.values())this._update.remove(h)}}clearWeakOverrides(){for(const[e,t]of this._overrides.entries())t.isWeak&&this._overrides.delete(e);this.invalidate()}cleanup(e){if(this._overrides.size<ke)return;const t=performance.now();if(t-this._lastCleanup<ir)return;this._lastCleanup=t;const r=this._getWeakDeletions();if(!(r.size<ke)){for(const i of e){const n=i.reader.withoutOverrides().getCursor();for(;n.next();){const a=n.getObjectId();r.delete(a)}}for(const i of r)this._overrides.delete(i);r.size&&this.invalidate()}}takeOverrideUpdate(){const e=this._update;return e.isEmpty?null:(this._update=new J,e.applyWhereClause(this._parameters))}asChunk(){const e=this._parameters;if(this._lastOverrideParametersHash!==e.hash&&(this._lastOverrideParametersHash=e.hash,this._chunk=null),!this._chunk){const t=[];for(const r of this._overrides.values())r.inner!=null&&e.testFeature(r.inner)&&t.push(r.inner);this._chunk=nr.fromFeatures(t,e.metadata)}return this._chunk}invalidate(){this._chunk=null}putWeakObjectIdsFromGlobalIds(e,t,r){for(const[i,n]of this._overrides.entries()){if(n.isWeak&&n.inner!=null){const a=n.inner.attributes[r];a&&t.has(a)&&!e.has(a)&&e.set(a,i);continue}if(n.lastWeak!=null&&n.lastWeak.inner!=null){const a=n.lastWeak.inner.attributes[r];a&&t.has(a)&&!e.has(a)&&e.set(a,i)}}}_getWeakDeletions(){const e=new Set;for(const[t,r]of this._overrides.entries())r.isWeak&&r.inner==null&&e.add(t);return e}}class Cr extends Ne{constructor(e,t,r,i,n=0){super(),this._reader=e,this._queryJSON=t,this._page=r,this._end=i,this._fileIndex=n,this.chunkId=`${this._fileIndex}.${this._page}${this.end?"e":""}`,this.normalizedChunkId=this.chunkId}get reader(){return this._reader}get first(){return this._page===0}get end(){return this._end}get queryInfo(){return{type:"snapshot",chunkId:this.chunkId,queryJSON:this._queryJSON,page:this._page,size:this.size(),end:this.end}}get isTiled(){return!1}getTileReader(e){const t=this.queryFeaturesInBounds(e.bounds);return t.setTransformForDisplay(e.transform),t}}let A;class $e extends fe{constructor(e,t,r,i,n,a=new Uint32Array(r.size())){super(e),this._fields=t,this._inner=r,this._chunkId=i,this._fileIndex=n,this._displayIds=a,this._index=-1,this.usedMemory=D,this._size=this._inner.size(),e.featureIdInfo.type,this._chunkId>65535&&console.error("Exceeded max allowed parquet reader size")}destroy(){super.destroy(),this._inner.free()}get fields(){return this._fields}get geometryType(){return this.metadata.geometryType}get hasFeatures(){return!0}get hasNext(){throw new Error("Method not implemented.")}get exceededTransferLimit(){return!1}get hasZ(){return!1}get hasM(){return!1}getInTransform(){return null}getSize(){return this._size}getCursor(){return this.copy()}getAttributeHash(){let e="";for(const t of this.fields.fields)e+=this._readAttribute(t.name,!1)+".";return e}getObjectId(){return this._fileIndex<<24|this._inner.rowId(this._index)}getDisplayId(){return this._displayIds[this._index]}setDisplayId(e){this._displayIds[this._index]=e}setIndex(e){this._index=e}getBoundsXMin(){return this._inner.boundsXMin(this._index)}getBoundsYMin(){return this._inner.boundsYMin(this._index)}getBoundsXMax(){return this._inner.boundsXMax(this._index)}getBoundsYMax(){return this._inner.boundsYMax(this._index)}setBoundsXMin(e){throw new Error("InternalError: Setting bounds is unsupported")}setBoundsYMin(e){throw new Error("InternalError: Setting bounds is unsupported")}setBoundsXMax(e){throw new Error("InternalError: Setting bounds is unsupported")}setBoundsYMax(e){throw new Error("InternalError: Setting bounds is unsupported")}getIndex(){return this._index}next(){for(;++this._index<this._size&&!this._getExists(););return this._index<this._size}readGeometryArea(){return this.readGeometryForDisplay()?.area()??0}copy(){const e=new $e(this.metadata,this._fields,this._inner,this._chunkId,this._fileIndex,this._displayIds);return this.copyInto(e),e}copyInto(e){super.copyInto(e),e._index=this._index}readGeometryForDisplayTransformed(e){const[t,r]=e.translate,[i,n]=e.scale;return A||(A=nt.new()),this._inner.transformGeometry(A,t,r,i,n,this._index)?new p(A.readLengthsUnsafe(),A.readCoordsUnsafe()):null}_readGeometry(e){const t=this._inner.readCoords(this._index),r=this._inner.readLengths(this._index);return t&&r?new p(r,t):null}_readX(){return this._inner.readX(this._index)}_readY(){return this._inner.readY(this._index)}_readServerCentroid(){return null}_readAttribute(e,t){const r=this.fields.get(e);if(!r)return;if(r.column==null)return this.getObjectId();const i=this._inner.readAttribute(this._index,r.column);if(i==null)return i;const n=this.fields.isDateField(r.name);return t?i==null?i:n?new Date(i):i:i}_readAttributes(){const e={};for(const t of this._fields.fields)t.column!=null&&(this._inner.isEmpty(t.column)||(e[t.name]=this._readAttribute(t.name,!1)));return e.__OBJECTID=this.getObjectId(),e}}class Dr{constructor(){this._chunks=new Map,this._chunksToRemove=[],this.events=new at,this.featureAdapter=new Yt}destroy(){this.clear()}clear(){for(const e of this._chunks.values())this._chunksToRemove.push(e);this._chunks.clear(),this._overrides?.clearWeakOverrides()}get usedMemory(){let e=0;for(const t of this._chunks.values())e+=t.usedMemory;return e}async update(e){if(this._overrides){const t=await $.create(e);this._overrides.update(t)}this._schema=e}*chunks(){this._overrides&&(yield this._overrides.asChunk()),yield*this._chunks.values()}insert(e){T("esri-2d-update-debug")&&console.debug(`Chunk[${e.chunkId}] SourceChunkStore.insert`),this._overrides?.onChunkInsert(e),this._chunks.set(e.chunkId,e),this.events.emit("changed")}remove(e){T("esri-2d-update-debug")&&console.debug(`Chunk[${e.chunkId}] SourceChunkStore.remove`),this._chunks.delete(e.chunkId),this._chunksToRemove.push(e)}removeById(e){T("esri-2d-update-debug")&&console.debug(`Chunk[${e}] SourceChunkStore.remove`);const t=this._chunks.get(e);this._chunks.delete(e),t&&this._chunksToRemove.push(t)}cleanup(){const e=this._chunksToRemove;return this._chunksToRemove=[],this._overrides?.cleanup(this._chunks.values()),e}async applyOverride(e){if(this._overrides==null){const t=await $.create(this._schema);this._overrides=new ar(t);for(const r of this._chunks.values())this._overrides.onChunkInsert(r)}this._overrides.apply(e,this),this.events.emit("changed");for(const t of this._chunks.values())t.invalidate()}takeOverrideUpdate(){return this._overrides?.takeOverrideUpdate()}refresh(){this.events.emit("refresh")}forEach(e){const t=new Set;for(const r of this.chunks()){const i=r.reader.getCursor();for(;i.next();){const n=i.getObjectId();t.has(n)||(e(i.copy()),t.add(n))}}}forEachUnsafe(e){const t=new Set;for(const r of this.chunks()){const i=r.reader.getCursor();for(;i.next();){const n=i.getObjectId();t.has(n)||(e(i),t.add(n))}}}mapObjectIdsFromGlobalIds(e,t){const r=new Map,i=new Set(e);return this._overrides?.putWeakObjectIdsFromGlobalIds(r,i,t),this._forEachUnsafeIgnoreOverrides(n=>{const a=n.readAttribute(t);if(a&&i.has(a)&&!r.has(a)){const d=n.getObjectId();r.set(a,d)}}),r}forEachInBounds(e,t){const r=new Set;for(const i of this.chunks()){const n=i.queryFeaturesInBounds(e);for(;n.next();){const a=n.getObjectId();r.has(a)||(t(n.copy()),r.add(a))}}}forEachBounds(e,t){const r=We();for(const i of e)i.getBounds(r)&&t(r)}_forEachUnsafeIgnoreOverrides(e){const t=new Set;for(const r of this._chunks.values()){const i=r.reader.withoutOverrides().getCursor();for(;i.next();){const n=i.getObjectId();t.has(n)||(e(i),t.add(n))}}}}export{Xe as $,Ar as A,Br as B,Wr as C,De as D,wt as M,Zt as N,Ne as P,Lt as U,Yt as X,$e as Z,de as d,fe as f,Cr as j,nr as n,sr as s,ve as v,Mt as w,Dr as z};
