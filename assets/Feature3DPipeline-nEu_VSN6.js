import{s as v,_ as p,m,a as R,bj as H,d as E,l as L,a6 as D,u as B,V as $}from"./jsonMap-Bs3hmeCU.js";import{d as G,a as P,l as M}from"./reactiveUtils-SO2Ko3sy.js";import{t as U}from"./FeatureLayerViewBase3D-C-tWO2gV.js";import{o as N}from"./WorkerHandle-CWMP3YEU.js";import{z as Q}from"./Extent-BVvEPGp_.js";import{u as A}from"./aaBoundingRect-WcI4brw6.js";import{n as J}from"./isFeatureGraphicOrigin-YA2hudPe.js";import{i as q}from"./AttributeBinsFeatureSet-Bx4thas4.js";import{g as T}from"./FeatureSet-VgBej66c.js";import{o as z,S as j,av as W,aw as K,aq as X,ar as Y,d as Z}from"./ShadowCastClear.glsl-Dm_ZNusR.js";import{n as ee}from"./utils-B1DMZv0w.js";import"./collectionUtils-Cc1OWTqq.js";import"./vec4f64-DPb6J-GU.js";import{t as k}from"./InterleavedLayout-DVezg4xk.js";import{i as S,f as re,m as te,g as ie,h as ne}from"./RealisticTree.glsl-CD2qk3Wa.js";import{x as V,R as se,M as oe,P as ae}from"./Texture-BuZokc5o.js";import{F as de}from"./LodRenderer-D0oEAMMU.js";import"./vec32-DIQfN9dj.js";import{s as C}from"./highlightUtils-Cg9xFmN6.js";import"./index-BiLqt4Ue.js";import"./dehydratedFeatures-D_FpkmpM.js";import"./memoryEstimations-Bd726a_p.js";import"./Point-CMHR1y9V.js";import"./reader-DcGs6kKN.js";import"./aaBoundingBox-CNqmdQRu.js";import"./DoubleArray-DExKNiTh.js";import"./mat4f64-q_b6UJoq.js";import"./quantizationUtils-BYmjRh4u.js";import"./Polyline-CYNn9agI.js";import"./Polygon-WlfMxvm8.js";import"./mathUtils-PIGhLnI9.js";import"./typeUtils-Dr-CEt7y.js";import"./Field-Cm_ZejYW.js";import"./Color-CERqXxxY.js";import"./fieldType-DVUzXtk_.js";import"./lengthUtils-1lu2BknD.js";import"./date-IqUzANpt.js";import"./HeatmapDensity.glsl-Df_CR20z.js";import"./Graphic-CfT07maQ.js";import"./getPopupProvider-zqy7P9ZA.js";import"./Layer--kjMcEYS.js";import"./jsonUtils-BIx2Bg38.js";import"./createFeatureId-CVwTD0fV.js";import"./typeUtils-BUTeHmXX.js";import"./lineMarkers-CDwLe3J6.js";import"./PolygonSymbol3D-DOhH5ySO.js";import"./ExtrudeSymbol3DLayer-DSc1ou2x.js";import"./screenUtils-BitdhK1O.js";import"./opacityUtils-DuFH0EC9.js";import"./Font-SQ7b_Y8G.js";import"./SimpleFillSymbol-CDawtd9z.js";import"./SimpleMarkerSymbol-BGAFRS9_.js";import"./PictureMarkerSymbol-6cJpxdoq.js";import"./TextSymbol-DhXD0YaH.js";import"./timeSupport-CmiEw4mI.js";import"./utils-DTE-xBiC.js";import"./Version-BtYZEj58.js";import"./AttributeBinsQuery-BJJGmCqX.js";import"./FixedIntervalBinParameters-D-g10btd.js";import"./projectionUtils-BYIvMX5W.js";import"./SimpleObservable-CvFyr0NA.js";import"./normalizeUtils-BEJV7G0l.js";import"./Cyclical-BLSxUpe7.js";import"./normalizeUtilsCommon-DnSvD7ht.js";import"./utils-BrkeFJbU.js";import"./utils-DGvxRWBb.js";import"./NormalizationBinParametersMixin-BK9wNkI3.js";import"./Query-dGEUg7py.js";import"./timeZoneUtils-BSc7-7qA.js";import"./attributeUtils-Dc8--CBJ.js";import"./highlightOptionsUtils-DZ8RCN8L.js";import"./layerViewUtils-BTa15X3o.js";import"./UpdatingHandles-D2RI_3Hb.js";import"./asyncUtils-w6KfWU41.js";import"./featureLayerUtils-D13d4D7o.js";import"./uuid-Oe6SV2kF.js";import"./featureQueryAll-DDEwSb-l.js";import"./layerUtils-CCPFPk-j.js";import"./SimpleRenderer-Ezg3CDnO.js";import"./commonProperties-s14NRk_S.js";import"./colorRamps-DswZzxkO.js";import"./ColorStop-De5gQTjr.js";import"./visualVariableUtils-C1nFTN5Y.js";import"./jsonUtils-BQyFRv-V.js";import"./defaults3D-GChPz1KX.js";import"./defaults-CCZo_bZz.js";import"./defaultsJSON-GKolV7NZ.js";import"./UniqueValueRenderer-DMf1gUze.js";import"./diffUtils-D2LGH79d.js";import"./RendererLegendOptions-Bp6rvhD1.js";import"./styleUtils-Dn7fzr6g.js";import"./FeatureTileDescriptor-Cwfrd5DG.js";import"./ReactiveMap-B0by2bYu.js";import"./signal-BX9ezF8a.js";import"./dehydratedFeatureComparison-BrPPz4bi.js";import"./Scheduler-CNrsbccs.js";import"./utils-DaaAsTZs.js";import"./mat4f32-Djp3mnm5.js";import"./mat4-Df_3WIwI.js";import"./cimSymbolUtils-DOGwV0lV.js";import"./utils-DX2muIr3.js";import"./LRUCache-fy84PBMi.js";import"./queryForSymbologySnapping-CyTgvrm-.js";import"./projectPointToVector-lgC5SvvR.js";import"./projectVectorToVector-CDqEkUpu.js";import"./elevationInfoUtils-Dxkv6YB1.js";import"./unitConversionUtils-C_S2QiAQ.js";import"./Graphics3DFeatureProcessor-CYE7ZN5m.js";import"./hash-CcEbRgUF.js";import"./renderingInfoUtils-BRpJAIBa.js";import"./ExtentSet-D1MoGhwY.js";import"./Queue-CYlrXMwB.js";import"./intl-C3uMq9s5.js";import"./OptimizedFeature-CwRGZPwv.js";import"./optimizedFeatureQueryEngineAdapter-Bma9_B5X.js";import"./PooledRBush-Dco5QkUp.js";import"./quickselect-QQC62dOK.js";import"./popupUtils-b2GYcw0l.js";import"./Graphics3DObjectStates-BsigkHBd.js";import"./computeTranslationToOriginAndRotation-D0D690pa.js";import"./frustum-DWgQCJBb.js";import"./sphere-COwiWjRO.js";import"./vector-HTSzpX5X.js";import"./quatf64-CCm9z-pX.js";import"./vec2f64-rIxtbMRN.js";import"./vec42-ClQ6ADuy.js";import"./plane-C25sE_vU.js";import"./FeatureFilter-C2UaLD14.js";import"./floorFilterUtils-DKzVzLpH.js";import"./QueryEngine-ggB1MGsR.js";import"./featureConversionUtils-hXFGbgzJ.js";import"./OptimizedFeatureSet-BR8EEvDc.js";import"./WhereClauseCache-D8RPhuwG.js";import"./WhereClause-CfZyPY5e.js";import"./TimeOnly-DH57Trnh.js";import"./enum-BzLwmiID.js";import"./UnknownTimeZone-B697BDFv.js";import"./QueryEngineCapabilities-DJC_YILC.js";import"./utils-CpO3s4hv.js";import"./heatmapUtils-DUSAGtuY.js";import"./utils-CeuukQJi.js";import"./utils-BEeBypEk.js";import"./ClassBreaksDefinition-BGOzyovZ.js";import"./SnappingCandidate-DGkpYqI6.js";import"./FieldsIndex-CyoOfYU1.js";import"./Indices-D0_UQPPr.js";import"./scaleUtils-cWMHpBu0.js";import"./FeatureStore-NnTiJApV.js";import"./BoundsStore-B_wwo4Zp.js";import"./orientedBoundingBox-CpdLjzxi.js";import"./quat-D3JcL9GI.js";import"./spatialReferenceEllipsoidUtils-DnehMctI.js";import"./enums-B4pqBiXb.js";import"./VertexElementDescriptor-BlxU8vCE.js";import"./Emissions.glsl-B8XKMjLy.js";import"./LayerView3D-BWauqewo.js";import"./query-Kj1LpdBe.js";import"./pbfQueryUtils-CQVJD3eI.js";import"./pbf-2SIhMekG.js";import"./queryZScale-DN2FLuMl.js";import"./EventedSet-DfgtwAGn.js";import"./FeatureIdInfo-iL5WjyEH.js";import"./constants-SxxbBSOD.js";import"./displayFilterUtils-DjbAkIvi.js";import"./FeatureEffect-Y_A-5Vzt.js";import"./jsonUtils-Bf4h1G47.js";import"./featurePopupQueryUtils-CBqEluV9.js";import"./LayerView-BF3KIQc0.js";import"./RefreshableLayerView-BZ0W4dR0.js";import"./workers-eNnOSbW_.js";import"./modeUtils-RVJH-Hyp.js";import"./sanitizerUtils-BT_8V5US.js";import"./GraphicsCollection-FgG4i9u5.js";import"./HeightModelInfo-BOZ2bCXl.js";import"./TilemapCache-ChidWVjQ.js";import"./TileKey-CTZ53yPm.js";import"./tagSymbols-BPcGfZon.js";import"./Map-BZpIOwPY.js";import"./Basemap-fKW7Cz4U.js";import"./loadAll-H0orMzpA.js";import"./PortalItem-e2bKDJZ8.js";import"./writeUtils-BvBZRLXT.js";import"./CollectionFlattener-CyTdUoKH.js";import"./persistable-Ot1881Fk.js";import"./MD5-MtSiOt06.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw.js";import"./resourceExtension-Dlt4ayx_.js";import"./PolygonCollection-j-hecAeB.js";import"./TablesMixin-Nye32Ffd.js";import"./ElevationQuery-uPUdv3lW.js";import"./TileInfo-BbMV8v9T.js";import"./vec3f32-WCVSSNPR.js";import"./constants-D67WmGms.js";import"./floatRGBA-1BW7WSIR.js";import"./labelUtils-BtizwBfq.js";import"./ArcadeExpression-BHPcSlWy.js";import"./TileKey-C44YQC4_.js";import"./BufferView-BVrbsaWH.js";import"./vec2f32-CaVKkSa6.js";import"./Octree-BScVi4hI.js";import"./HUDIntersectorResult-DJ-mrASs.js";import"./intersectorUtilsConversions-DcxEtHOg.js";import"./Intersector-BEbN3ApI.js";import"./DefaultLoadingContext-BBb1tRC-.js";import"./wosrLoader-BTzfF2iQ.js";import"./axisAngleDegrees-D1OOYQT7.js";import"./edgePreprocessing-BFYAECPd.js";import"./config-Dg972SSE.js";import"./GeometryUtils-BdjkAnCr.js";import"./definitions-Dvg4hMIw.js";import"./colorUtils-BzDQ74Nc.js";import"./vec3-B_phcnZY.js";import"./vec33-CWJeyzxV.js";import"./capabilities-Bi6C4OG6.js";import"./imageUtils-CE3cSuc6.js";import"./types-BKo2foNY.js";import"./meshVertexSpaceUtils-CDaunXaJ.js";import"./MeshLocalVertexSpace-y1kE5w4c.js";import"./videoUtils-Dwx3AEgj.js";let h=class extends G{constructor(e){super(e),this.schedule=null,this._workerUpdating=!0}get updating(){return this._workerUpdating}get _graphicOrigin(){const e=this.layer.graphicOrigin;if(!J(e))throw new v("featurelayerview3d:invalid-graphic-origin","Layer's graphic origin is not a FeatureGraphicOrigin");return e}initialize(){const{layer:e,layerView:r,viewSpatialReference:t,renderSpatialReference:i}=this,s=e.elevationInfo;this._elevationContext=z.fromElevationInfo(s),this._workerHandle=new le(this.schedule,{createTexture:async({data:n,parameters:o})=>({result:await this.renderer.createTexture(n,o),transferList:[]}),releaseTexture:async({uid:n})=>(await this.renderer.releaseTexture(n),g),createMaterial:async({materialJSON:n})=>(await this.renderer.createMaterial(n),g),destroyMaterial:async({materialId:n})=>(await this.renderer.destroyMaterial(n),g),createDirectRenderer:async({materialId:n})=>(await this.renderer.createDirectRenderer(n),g),destroyDirectRenderer:async({materialId:n})=>(await this.renderer.destroyDirectRenderer(n),g),createLoDRenderer:async({rendererId:n,lodRenderGeometry:o},a)=>(await this.renderer.createLoDRenderer(n,o,a?.signal??void 0),g),destroyLoDRenderer:async({rendererId:n},o)=>(await this.renderer.destroyLoDRenderer(n,o?.signal??void 0),g),dispatchRenderCommands:async({commands:n})=>(await this.renderer.executeRenderCommands(n),g),applyElevationAlignment:async({mapPoints:n})=>{const{viewSpatialReference:o,elevationProvider:a,renderCoordsHelper:d}=this,l=ee(n,o,this._elevationContext,a,d);return{result:l,transferList:[l.buffer]}},setBaseInstance:async({rendererId:n,baseInstance:o})=>(this.renderer.setBaseInstance(n,o),g)}),this.addResolvingPromise((async()=>{await e.load();const n={url:e.parsedUrl?.path??"",baseQuery:e.createQuery().toJSON(),objectIdField:e.objectIdField,capabilities:e.capabilities,fieldIndex:e.fieldsIndex.toJSON(),timeInfo:e.timeInfo?.toJSON(),elevationInfo:s?.toJSON(),fullExtent:e.fullExtent?.toJSON(),renderer:e.renderer?.toJSON()},o={fullOpacity:r.fullOpacity};await this._workerHandle.invokeMethod("setup",{viewSpatialReference:t.toJSON(),renderSpatialReference:i.toJSON(),viewingMode:this.viewingMode,layerInfo:n,layerViewInfo:o})})()),this.addHandles(this._workerHandle.on("notify-updating",({updating:n})=>{this._workerUpdating=n}))}onTileTreeChange(e){this._workerHandle.invokeMethod("onTileTreeChange",{tiles:e.items.map(ue)})}onElevationChange(e){this._workerHandle.invokeMethod("onElevationChange",{context:e.context,spatialReference:e.spatialReference?.toJSON(),extent:A(e.extent)})}onLayerViewOpacityChange(e){this._workerHandle.invokeMethod("onLayerViewOpacityChange",e)}onRendererChange(e){const r=e?.toJSON();this._workerHandle.invokeMethod("onRendererChange",r)}async executeQuery(e,r){const t=await this._workerHandle.invokeMethod("executeQuery",e?.toJSON(),r),i=T.fromJSON(t);return this._ensureLayerOnFeatures(i),i}async executeQueryForIds(e,r){return await this._workerHandle.invokeMethod("executeQueryForIds",e?.toJSON(),r)}async executeQueryForCount(e,r){return await this._workerHandle.invokeMethod("executeQueryForCount",e?.toJSON(),r)}async executeQueryForExtent(e,r){const{count:t,extent:i}=await this._workerHandle.invokeMethod("executeQueryForExtent",e?.toJSON(),r);return{count:t,extent:Q.fromJSON(i)}}async executeQueryForLatestObservations(e,r){const t=await this._workerHandle.invokeMethod("executeQueryForLatestObservations",e?.toJSON(),r),i=T.fromJSON(t);return this._ensureLayerOnFeatures(i),i}async executeAttributeBinsQuery(e,r){const t=await this._workerHandle.invokeMethod("executeAttributeBinsQuery",e.toJSON(),r);return q.fromJSON(t)}_ensureLayerOnFeatures(e){const{layer:r,_graphicOrigin:t}=this;for(const i of e.features)i.layer=r,i.sourceLayer=r,i.origin=t}};p([m()],h.prototype,"updating",null),p([m({constructOnly:!0})],h.prototype,"schedule",void 0),p([m({constructOnly:!0})],h.prototype,"layer",void 0),p([m({constructOnly:!0})],h.prototype,"layerView",void 0),p([m({constructOnly:!0})],h.prototype,"viewSpatialReference",void 0),p([m({constructOnly:!0})],h.prototype,"renderSpatialReference",void 0),p([m({constructOnly:!0})],h.prototype,"viewingMode",void 0),p([m({constructOnly:!0})],h.prototype,"renderer",void 0),p([m({constructOnly:!0})],h.prototype,"elevationProvider",void 0),p([m({constructOnly:!0})],h.prototype,"renderCoordsHelper",void 0),p([m()],h.prototype,"_workerUpdating",void 0),p([m()],h.prototype,"_graphicOrigin",null),h=p([R("esri.views.3d.layers.graphics.pipeline.Feature3DPipelineWorkerHandle")],h);let le=class extends N{constructor(r,t){super("Feature3DPipelineWorker","setup",{},r,{strategy:"dedicated",client:t})}};function ue({id:e,lij:r,extent:t}){return{id:e,lij:r,extent:t}}const g={result:void 0};let I=class extends j{constructor(e){super(e),this._glMaterials=null,this._produces=new Map,this._renderGeometries=new Map,this._renderContext=null,this._drawParameters=new W,this._bufferWriter=null,this._baseInstance=null,this.slicePlaneEnabled=!1,this.isGround=!1,this.type=e.material instanceof S?1:4,this.layerViewUid=e.layerViewUid}get produces(){return this._produces}get numFeatures(){let e=0;return this._renderGeometries.forEach(r=>e+=r.numElements),e}get usedMemory(){let e=0;return this._renderGeometries.forEach(r=>{e+=r.vao.usedMemory}),e}intersect(e,r,t,i){const{material:s,_bufferWriter:n,layerViewUid:o,_renderGeometries:a}=this;n.intersect!=null&&a.forEach(({buffer:d,localOrigin:l,items:c})=>n.intersect(d.data,s.parameters,l,e,t,i,(u,y,w,f)=>{if(!c.visibilities[w])return;const b=c.objectIds[w];e.handleObjectIntersection({object:{id:H,graphicUid:b,layerViewUid:o,boundingVolumeWorldSpace:new K,geometries:[{material:s}]},geometryId:0,primitiveIndex:w},u,y,null,f)}))}initialize(){this._bufferWriter=this.material.createBufferWriter(),this.material.produces.forEach((e,r)=>{this._produces.set(r,t=>t!==9&&t!==5&&e(t))})}destroy(){this._glMaterials.dispose();const e=this._renderGeometries.keys();for(const r of e)this.removeRenderGeometryBuffer(r);this._baseInstance?.vbo.dispose(),this._baseInstance=null}acquireTechniques(e){const r=this.material;if(!r.shouldRender(e))return null;const{output:t,bind:i}=e;return!r.produces.get(i.slot)?.(t)||t===9||t===5?null:this._glMaterials.load(e.rctx,i.slot,t)?.beginSlot(i)}render(e,r){const t=this._renderGeometries;if(t.size===0)return;const{bind:i}=e,s=i.slot===10||i.slot===11?i.slot:null,n=e.rctx;n.runAppleAmdDriverHelper(),n.bindTechnique(r,i,this.material.parameters);const o=r.program,{_baseInstance:a}=this,d=a==null?l=>{n.drawArrays(r.primitiveType,l.start,l.count)}:(l,c)=>{se(n,c.locations,c.buffer("instances"),l.start),n.drawArraysInstanced(r.primitiveType,0,a.buffer.elementCount,l.count)};for(const[l,c]of t){const{vao:u,localOrigin:y,drawCalls:w}=c;this._drawParameters.origin=y,o.bindDraw(i,this.material.parameters,this._drawParameters),r.ensureAttributeLocations(u),n.bindVAO(u),n.setPipelineState(r.getPipeline(!1,s));for(const f of w)d(f,u)}}initializeRenderContext(e){this._glMaterials=new X(this.material,e.materials),this._renderContext=e.renderContext}uninitializeRenderContext(){}addRenderGeometryBuffer(e,r,t,i){this.removeRenderGeometryBuffer(e);const{data:s,elementCount:n}=r,{_baseInstance:o,_bufferWriter:a,_renderContext:{rctx:d}}=this,l=o==null?a.layout:a.instanceLayout;if(!l)throw new Error("Cannot create instance buffer for non-instanced material");const c=new V(d,k(l,o==null?0:1),s);let u;u=new Y(d,o==null?new Map([["geometry",c]]):new Map([["geometry",o.vbo],["instances",c]]));const y={localOrigin:i,numElements:n,buffer:r,items:t,vao:u,drawCalls:this._produceDrawCalls(t)};this._renderGeometries.set(e,y)}updateRenderGeometryBuffer(e,r,t,i){const{data:s,elementCount:n}=r,o=this._renderGeometries.get(e);if(o==null)return;const a=o.vao.buffer(this._baseInstance==null?"geometry":"instances");a?.setSize(s.byteLength),a?.setSubData(new Uint8Array(s),0,0,s.byteLength),o.localOrigin=i,o.numElements=n,o.buffer=r,o.items=t,o.drawCalls=this._produceDrawCalls(t)}removeRenderGeometryBuffer(e){const r=this._renderGeometries.get(e);r!=null&&(this._baseInstance?(r.vao.buffer("instances")?.dispose(),r.vao.disposeVAOOnly()):r.vao.dispose(),this._renderGeometries.delete(e))}updateVisibility(e,r){const t=this._renderGeometries.get(e);if(t==null)return;const{items:i}=t;if(i.visibilities.length!==r.length)throw new Error("Unexpected mismatch between old and new visibility flag buffer length.");i.visibilities=r,t.drawCalls=this._produceDrawCalls(i)}setBaseInstance(e){if(this._baseInstance?.vbo.dispose(),e==null)return void(this._baseInstance=null);const{data:r}=e,t=new V(this._renderContext.rctx,k(this._bufferWriter.layout),r);this._baseInstance={buffer:e,vbo:t}}hasHighlight(){return!1}_produceDrawCalls(e){const{visibilities:r,ranges:t}=e,i=[];if(pe(t)){if(t.numItems===0)return[];const s=t.numVertices;let n=null;for(let o=0;o<t.numItems;++o)r[o]?n==null?(n={start:o*s,count:s},i.push(n)):n.count+=s:n=null}else{const s=t.counts,n=s.length;if(n===0)return[];let o=null,a=0;for(let d=0;d<n;++d){const l=r[d],c=s[d];l?o==null?(o={start:a,count:c},i.push(o)):o.count+=c:o=null,a+=c}}return i}};function pe(e){return"numItems"in e}p([m({constructOnly:!0})],I.prototype,"material",void 0),I=p([R("esri.views.3d.layers.graphics.pipeline.rendering.DirectRenderer")],I);let F=class{constructor(e){this._instanceGroupToIndices=new Map,this._instanceIndexToFeatureId=new Map,this._disposeResourceHandles=new Array,this._lodRendererResources=null,this._numFeatures=0,this.layerViewUid=e.layerViewUid,this.view=e.view,this.sharedResources=this.view.sharedSymbolResources,this.scheduler=this.view.resourceController.scheduler}get numFeatures(){return this._numFeatures}get usedMemory(){return(this._lodRendererResources?.lodRenderer?.symbol?.computeUsedMemory()??0)+16*this._instanceIndexToFeatureId.size}destroy(){this._disposeResourceHandles.forEach(e=>e())}async doLoad(e,r,t){const i=ce(d=>r(d),e),s=this.view.stage,n=i.getMaterials(),o=i.getTextures();s.addTextures(o),this._addDisposeResource(()=>{o.forEach(d=>d.unload()),s.removeTextures(o)}),await Promise.all(o.map(d=>this.view.stage.schedule(()=>d.load(s.renderView.renderingContext),t))),E(t);const a=await this._createLodRenderer(i,t);this._lodRendererResources={lodRenderer:a,materials:n,textures:o}}addInstances(e,r){const t=this._lodRendererResources;if(t==null)return;const i=t.lodRenderer;if(i==null)return;const{featureIds:s,localTransforms:n,globalTransforms:o,visibility:a}=r,d=new Array,l=i.instanceData,c=s.length,u=this._instanceIndexToFeatureId;for(let y=0;y<c;++y){const w=s[y],f=l.addInstance(),b=l.view,O=16*y;b.localTransform.copyFromTypedBuffer(f,n,O),b.globalTransform.copyFromTypedBuffer(f,o,O),l.updateModelTransform(f),l.setVisible(f,!!a[y]),d.push(f),u.set(f,w)}this._instanceGroupToIndices.set(e,d),this._numFeatures+=c}removeInstances(e){const r=this._instanceGroupToIndices.get(e);if(r==null)return;const t=this._lodRendererResources;if(t==null)return;const i=t.lodRenderer.instanceData,s=this._instanceIndexToFeatureId;for(const n of r)i.removeInstance(n),s.delete(n);this._numFeatures-=r.length,this._instanceGroupToIndices.delete(e)}updateVisibility(e,r){const t=this._instanceGroupToIndices.get(e);if(t==null)return;const i=this._lodRendererResources;if(i==null)return;const s=t.length;if(s!==r.length)throw new Error("Unexpected mismatch instance count and visibility flag buffer length.");const n=i.lodRenderer.instanceData;for(let o=0;o<s;++o)n.setVisible(t[o],!!r[o])}updateGlobalTransforms(e,r){const t=this._instanceGroupToIndices.get(e);if(t==null)return;const i=this._lodRendererResources;if(i==null)return;const s=t.length;if(16*s!==r.length)throw new Error("Unexpected mismatch instance count and visibility flag buffer length.");const n=i.lodRenderer.instanceData,o=n.view;for(let a=0;a<s;++a){const d=t[a],l=16*a;o.globalTransform.copyFromTypedBuffer(d,r,l),n.updateModelTransform(d)}}_addDisposeResource(e){this._disposeResourceHandles.push(e)}async _createLodRenderer(e,r){const t=this.view.stage,i={layerViewUid:this.layerViewUid,graphicUid:n=>this._instanceIndexToFeatureId.get(n)??-1,notifyGraphicGeometryChanged:n=>1,notifyGraphicVisibilityChanged:n=>1},s=new de({symbol:e,metadata:i,shaderTransformation:null},this.scheduler);return s.slicePlaneEnabled=!1,this._addDisposeResource(()=>{t.removeRenderPlugin(s),s.destroy()}),await t.addRenderPlugin(s,r),s}};function ce(e,r){const t=r.levels.map(i=>{const s=i.components.map(n=>{const o=e(n.materialId);if(!me(o))throw new Error("LodRenderer only supports DefaultMaterial");const a=new re(o,n.renderGeometryBuffer.data,n.renderGeometryBuffer.elementCount,n.boundingInfo);return new te(a)});return new ie(s,i.minScreenSpaceRadius)});return new ne(t)}function me(e){return e!=null&&"materialType"in e&&e.materialType==="default"}F=p([R("esri.views.3d.layers.graphics.pipeline.rendering.LodRenderer")],F);let x=class extends L{constructor(e){super(),this.view=null,this.layerViewUid=null,this._stage=null,this._materials=new Map,this._textures=new Map,this._directRenderers=new Map,this._lodRenderers=new Map,this.totalFeatures=0,this.view=e.view,this.layerViewUid=e.layerViewUid}initialize(){this._stage=this.view.stage}destroy(){this.removeAllHandles(),this._lodRenderers.forEach(e=>e.destroy())}async createTexture(e,r){const{_textures:t,_stage:i}=this,s=new oe(e,r);return t.set(s.id,s),i&&(s.load(i.renderView.renderingContext),i.addTexture(s)),s.id}async releaseTexture(e){const{_textures:r,_stage:t}=this,i=r.get(e);i&&(t&&(i.unload(),t.removeTexture(i)),r.delete(e))}_destroyTexture(e){const{_textures:r,_stage:t}=this,i=r.get(e);i&&(t&&(i.unload(),t.removeTexture(i)),r.delete(e))}async createMaterial(e){const{view:r}=this,t=r.state.viewingMode===1;let i=null;switch(e.type){case"default":{const s=e.parameters,n=new ae(s,{spherical:t});n.setParameters({cullFace:n.transparent?0:2}),i=n;break}case"hud":{const s=e.parameters;i=new S(s,t)}}this._materials.set(e.materialId,i)}async destroyMaterial(e){this._materials.delete(e)}async updateMaterial(e){}async createDirectRenderer(e){if(this._directRenderers.has(e))return;const r=this._materials.get(e);if(r==null)throw new Error(`material not found ${e}`);const{view:t}=this,i=new I({material:r,layerViewUid:this.layerViewUid});this._directRenderers.set(e,i),t.stage.addRenderPlugin(i),t.stage.renderView.renderer.updateHasFlags()}setBaseInstance(e,r){const t=this._directRenderers.get(e);if(t==null)throw new Error(`renderer not found ${e}`);t.setBaseInstance(r)}async destroyDirectRenderer(e){const r=this._directRenderers.get(e);if(r==null)return;const t=this.view;t.stage.removeRenderPlugin(r),this._directRenderers.delete(e),t.stage.renderView.renderer.updateHasFlags()}async createLoDRenderer(e,r,t){const i=new F({view:this.view,layerViewUid:this.layerViewUid}),s=n=>this._materials.get(n);if(await i.doLoad(r,s,t),t?.aborted)throw i.destroy(),D();this._lodRenderers.set(e,i)}async destroyLoDRenderer(e,r){const t=this._lodRenderers.get(e);t!=null&&(t.destroy(),this._lodRenderers.delete(e))}_destroyLodRenderer({rendererId:e}){const r=this._lodRenderers.get(e);r!=null&&(r.destroy(),this._lodRenderers.delete(e))}async executeRenderCommands(e){for(const r of e)switch(r.id){case"destroy-texture":this._destroyTexture(r.textureId);break;case"update-material":this._updateMaterial(r);break;case"destroy-material":this._destroyMaterial(r);break;case"add-direct-renderer-geometry-buffer":this._addDirectRendererGeometryBuffer(r);break;case"update-direct-renderer-geometry-buffer":this._updateDirectRendererGeometryBuffer(r);break;case"remove-direct-renderer-geometry-buffer":this._removeDirectRendererGeometryBuffer(r);break;case"destroy-lod-renderer":this._destroyLodRenderer(r);break;case"add-lod-instances":this._addLodInstances(r);break;case"remove-lod-instances":this._removeLodInstances(r);break;case"update-lod-instance-data":this._updateLodInstanceData(r);break;case"update-visibility":this._updateVisibility(r)}e.length>0&&this._updateFeatureCount()}_updateFeatureCount(){let e=0;for(const r of this._directRenderers.values())e+=r.numFeatures;for(const r of this._lodRenderers.values())e+=r.numFeatures;this._set("totalFeatures",e)}get usedMemory(){let e=0;for(const r of this._directRenderers.values())e+=r.usedMemory;for(const r of this._lodRenderers.values())e+=r.usedMemory;return e}_updateMaterial({materialId:e,parameters:r}){const t=this._materials.get(e);t!=null?t.setParameters(r):console.error("material not found")}_destroyMaterial({materialId:e}){this._materials.get(e)!=null?this._materials.delete(e):console.error("material not found")}_addDirectRendererGeometryBuffer({groupId:e,rendererId:r,renderGeometryBuffer:t,renderGeometryBufferItems:i,localOrigin:s}){const n=this._directRenderers.get(r);n!=null?(n.addRenderGeometryBuffer(e,t,i,s),this.view.stage.renderView.requestRender()):console.error("no renderer assigned to provided material")}_updateDirectRendererGeometryBuffer({groupId:e,rendererId:r,renderGeometryBuffer:t,renderGeometryBufferItems:i,localOrigin:s}){const n=this._directRenderers.get(r);n!=null?(n.updateRenderGeometryBuffer(e,t,i,s),this.view.stage.renderView.requestRender()):console.error("no renderer assigned to provided material")}_removeDirectRendererGeometryBuffer({groupId:e,rendererId:r}){const t=this._directRenderers.get(r);t!=null?(t.removeRenderGeometryBuffer(e),this.view.stage.renderView.requestRender()):console.error("no renderer assigned to provided material")}_addLodInstances({rendererId:e,groupId:r,data:t}){const i=this._lodRenderers.get(e);if(i==null)throw new Error("no lod renderer assigned to provided lod renderer Id");i.addInstances(r,t),this.view.stage.renderView.requestRender()}_removeLodInstances({rendererId:e,groupId:r}){const t=this._lodRenderers.get(e);if(t==null)throw new Error("no lod renderer assigned to provided lod renderer Id");t.removeInstances(r),this.view.stage.renderView.requestRender()}_updateLodInstanceData({rendererId:e,groupId:r,globalTransforms:t}){const i=this._lodRenderers.get(e);if(i==null)throw new Error("No renderer found with the provided id");t!=null&&i.updateGlobalTransforms(r,t),this.view.stage.renderView.requestRender()}_updateVisibility({rendererId:e,groupId:r,visibility:t}){const i=this._directRenderers.get(e)??this._lodRenderers.get(e);if(i==null)throw new Error("No renderer found with the provided id");i.updateVisibility(r,t),this.view.stage.renderView.requestRender()}};p([m({readOnly:!0})],x.prototype,"totalFeatures",void 0),x=p([R("esri.views.3d.layers.graphics.pipeline.rendering.FeaturePipelineRenderManager")],x);let _=class extends G{constructor(e){super(e),this._renderer=null,this.graphicsQuery={queryForSymbologySnapping:(r,t)=>{throw new v("featurelayer:unsupported-symbology-snapping","Symbology snapping not supported")},executeQuery:async(r,t)=>await this._workerHandle.executeQuery(r,t),executeQueryForIds:async(r,t)=>await this._workerHandle.executeQueryForIds(r,t),executeQueryForCount:async(r,t)=>await this._workerHandle.executeQueryForCount(r,t),executeQueryForExtent:async(r,t)=>await this._workerHandle.executeQueryForExtent(r,t),executeQueryForLatestObservations:async(r,t)=>await this._workerHandle.executeQueryForLatestObservations(r,t),executeAttributeBinsQuery:async(r,t)=>this._workerHandle.executeAttributeBinsQuery(r,t)},this.maximumNumberOfFeatures=1e3}initialize(){if(this.layerView.layer.geometryType!=="point")throw new v("featurelayer:unsupported-geometry-type",`${this.layerView.layer.geometryType} is not supported`);this.addResolvingPromise(this.setup())}destroy(){this.removeAllHandles(),this._workerHandle.destroy(),B(this._renderer)}async setup(){const e=this.layerView,{layer:r,view:t,uid:i}=e,{spatialReference:s,renderSpatialReference:n,resourceController:o,renderCoordsHelper:a,elevationProvider:d}=t,l=t.state.viewingMode;if(this._renderer=new x({view:t,layerViewUid:i}),r.type!=="feature")throw new v("featurelayer:unsupported-layertype","Only FeatureLayer is supported");const c=new h({schedule:u=>o.immediate.schedule(u),layer:r,layerView:e,viewSpatialReference:s,renderSpatialReference:n,viewingMode:l,renderer:this._renderer,elevationProvider:d,renderCoordsHelper:a});this._workerHandle=await c.when(),this.addHandles([this.layerView.view.enableFeatureTiles(),P(()=>this.layerView.view.featureTiles?.tiles,"change",u=>{this._workerHandle.onTileTreeChange(u.target)},{onListenerAdd:u=>this._workerHandle.onTileTreeChange(u),onListenerRemove:u=>this._workerHandle.onTileTreeChange(u)}),t.elevationProvider.on("elevation-change",u=>this._workerHandle.onElevationChange(u)),M(()=>this.layerView.fullOpacity,u=>this._workerHandle.onLayerViewOpacityChange(u),{sync:!1}),M(()=>r.renderer,u=>this._workerHandle.onRendererChange(u),{sync:!1})])}get legendEnabled(){return!1}get hasAllFeatures(){return!1}get hasAllFeaturesInView(){return!1}get hasFullGeometries(){return!1}get symbologySnappingSupported(){return!1}get scaleVisibilitySuspended(){return!1}get snappingComplexityExceeded(){return!1}get suspendInfo(){return{}}get updating(){return this._workerHandle.updating}get dataUpdating(){return!1}get updatePolicy(){return 0}get maximumNumberOfFeaturesExceeded(){return!1}get updatingProgressValue(){return 1}get usedMemory(){return this._renderer?.usedMemory??0}get unloadedMemory(){return 0}get ignoresMemoryFactor(){return!0}get totalFeatures(){return this._renderer?.totalFeatures??0}get performanceInfo(){const e=this.totalFeatures;return new U(new Z(this.usedMemory,e,e,this.maximumNumberOfFeatures,0,null),e,e,this.maximumNumberOfFeaturesExceeded,"tiles","n/a")}get suspendResumeExtentMode(){return"computed"}forEachGraphic(e){}findGraphic(e){return null}highlightByObjectIds(e,r){return C}highlightByGraphics(e,r){return C}maskOccludee(e){return $()}async whenGraphicBounds(e,r){return null}computeAttachmentOrigin(e,r){return null}elevationAlignPointsInFeatures(e,r){throw new v("featurelayer:unsupported-elevation-alignment","Elevation alignment not supported")}async doRefresh(e){}setVisibility(e,r){}getMissingAttributesForFeature(e){return null}getHydratedGeometry(e){return null}};p([m()],_.prototype,"layerView",void 0),p([m()],_.prototype,"updating",null),p([m()],_.prototype,"totalFeatures",null),_=p([R("esri.views.3d.layers.graphics.pipeline.Feature3DPipeline")],_);export{_ as Feature3DPipeline};
