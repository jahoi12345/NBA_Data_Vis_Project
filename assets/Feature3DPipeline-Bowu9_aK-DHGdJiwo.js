import{I as v,c as H,i as E,q as L,S as D,ac as B,o as P,Y as p,H as m,G as R}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{N as G,t as U,j as M}from"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import{$ as N}from"./FeatureLayerViewBase3D-Cu9w2__V-CP8CgoJP.js";import{f as Q}from"./WorkerHandle-B930SiRy-DglEKt53.js";import{z as A}from"./Extent-CgDMOSRD-Bod5LY6s.js";import{G as J}from"./aaBoundingRect-CjwcS2F3-ri8bmh30.js";import{r as q}from"./isFeatureGraphicOrigin-YA2hudPe-Bk2FjH_E.js";import{s as j}from"./AttributeBinsFeatureSet-BtGn1q3D-DAVn2CFs.js";import{c as T}from"./FeatureSet-BF7daP96-B_JvMbY7.js";import{d as z,o as W,S as $,av as Y,aw as K,aq as X,ar as Z}from"./ShadowCastClear.glsl-CeOT_rAo-BEYyVrmo.js";import{U as ee}from"./utils-Dint_RG--BtjrWkNL.js";import"./collectionUtils-jDyktm0P-BDP2Oq99.js";import"./vec4f64-DPb6J-GU-C7c2DqbZ.js";import{n as k}from"./InterleavedLayout-B7roQAzV-CdGz7mlm.js";import{i as S,f as re,m as te,g as ie,h as ne}from"./RealisticTree.glsl-WN9nrQUl-QZiY3aPA.js";import{aK as se,a1 as oe,O as C,e as ae}from"./Texture-CFNZjV2R-CxGjQ8pI.js";import{g as de}from"./LodRenderer-Be2-9DZO-B3kkuRMy.js";import"./vec32-CewSdTn3-VRto2OOh.js";import{m as V}from"./highlightUtils--bJgM-zK-C5dtE5Ia.js";import"./index-B0z_nLWi.js";import"./Point-BfTTZoMu-DeJwQYfh.js";import"./aaBoundingBox-Cn49X7ge-BcYPaJ58.js";import"./Polyline-CoiTLswR-DTxpB2Yg.js";import"./Polygon-D6wEPb3W-D2MPjRU4.js";import"./typeUtils-DqrRcjBx-DZ6_Gsbu.js";import"./Field-Cm_ZejYW-CwJZmSru.js";import"./mathUtils-PIGhLnI9-B1tKUlUb.js";import"./mat4f64-q_b6UJoq-Dh6sWB_w.js";import"./Color-CERqXxxY-BuYn26eI.js";import"./fieldType-DVUzXtk_-tUuvnZJM.js";import"./lengthUtils-Dt1_RvOO-j3MEdmHu.js";import"./date-IqUzANpt-bLKO9IDT.js";import"./HeatmapDensity.glsl-CJMrIO7J-jzq8b076.js";import"./Graphic-DgGzDmqW-d1CNicxz.js";import"./getPopupProvider-CmskPttI-CzUWpGwk.js";import"./Layer-DZvC7bne-D3VLDrab.js";import"./typeUtils-CXW_VpOn-BGgLp_TK.js";import"./lineMarkers-CDwLe3J6-CNUjJvs3.js";import"./PolygonSymbol3D-BXRHZiCQ-BjPAY2LA.js";import"./ExtrudeSymbol3DLayer-DSc1ou2x-CsVYZCeG.js";import"./Font-BwmnW7d2-Dwh3xjKw.js";import"./SimpleFillSymbol-CDawtd9z-CWD2KI2D.js";import"./SimpleMarkerSymbol-BGAFRS9_-CVQ5NLIA.js";import"./PictureMarkerSymbol-CaSh-vZk-xhjZ61bb.js";import"./TextSymbol-hRGhyDHs-CoS7dSjf.js";import"./utils-DTE-xBiC-uxMmcNif.js";import"./AttributeBinsQuery-DmkXyj6Y-zPPLAaI-.js";import"./FixedIntervalBinParameters-8snYOK8a-DXffLEh-.js";import"./projectionUtils-BGH_5_I3-DGwchVO8.js";import"./normalizeUtils-85zLqeMi-C1bdAKNn.js";import"./normalizeUtilsCommon-CnhQye_A-UWhaH-kt.js";import"./NormalizationBinParametersMixin-BK9wNkI3-BKYeOhDN.js";import"./Query-BlS0WPDF-jdXS_Qhy.js";import"./UpdatingHandles-D2RI_3Hb-dwLPjVun.js";import"./asyncUtils-w6KfWU41-HenJ0UOu.js";import"./featureLayerUtils-FKjLNPl_-Cv8vWd4i.js";import"./SimpleRenderer-CEmCWePp-BJ25mYcH.js";import"./commonProperties-DbO613LF-CHjBvYhj.js";import"./colorRamps-DswZzxkO-BqSFavfl.js";import"./ColorStop-De5gQTjr-C1lw16u9.js";import"./visualVariableUtils-ma4r7Z2K-Df6C3Hkh.js";import"./defaults3D-C2hXSee1-CTj29-Ly.js";import"./defaults-BDN9qxeN-C-EfxQM4.js";import"./UniqueValueRenderer-JPjz9Qvs-Duu1CubQ.js";import"./RendererLegendOptions-ByGHYLtx-Bwoo6l33.js";import"./Scheduler-CNrsbccs-Bcg8fWoS.js";import"./utils-Dha_-5-2-l1tlHmkW.js";import"./mat4f32-Djp3mnm5-DzYG3LYB.js";import"./mat4-C96X-Nn0-BrMLOLCb.js";import"./LRUCache-fy84PBMi-Y56WPIvD.js";import"./projectVectorToVector-Csv3NYZI-DpBtmQMN.js";import"./unitConversionUtils-4vB4Ezlp-DnY5MDxd.js";import"./Graphics3DFeatureProcessor-BtLaAjI1-DpYo2p4y.js";import"./ExtentSet-BmZuhn8E-DMTIpxE1.js";import"./intl-DRFqUect-DPhFaHB2.js";import"./PooledRBush-Dco5QkUp-DX3CMhf3.js";import"./Graphics3DObjectStates-CA63huOX-B-vEaCOn.js";import"./frustum-CMzahy3--B-DC1Co-.js";import"./sphere-DLQ6p7mp-DyEe1Vll.js";import"./vector-B8ZDYGQ6-DRILJdcx.js";import"./quatf64-CCm9z-pX-CQ7_sSji.js";import"./vec2f64-rIxtbMRN-Kai9mK1i.js";import"./vec42-B8VM4vXb-B6OGOEI9.js";import"./FeatureFilter-G4_pWMVe-D0hu4KAy.js";import"./QueryEngine-J0SYKhS8-C5yUyj6A.js";import"./WhereClause-BSVqskBz-CT_IXPhv.js";import"./UnknownTimeZone-B697BDFv-CBbtul7O.js";import"./ClassBreaksDefinition-BGOzyovZ-K0U0wKo_.js";import"./Indices-D0_UQPPr-t1Qev6md.js";import"./FeatureStore-DSSTHScY-DmyCmhL1.js";import"./orientedBoundingBox-BLEx7wLU-ByGP9QG1.js";import"./quat-B7J5v7rV-CZ9akUv-.js";import"./spatialReferenceEllipsoidUtils-D2JabnKt-Ce3ED0lc.js";import"./Emissions.glsl-B8XKMjLy-DXfiRNVX.js";import"./pbf-2SIhMekG-LK438LAR.js";import"./FeatureEffect-mVCOF1v6--fvFHZv2.js";import"./LayerView-BnpxrRF8-Ca-QSx3a.js";import"./workers-BEkgoq8Q-BM_Hz460.js";import"./modeUtils-BA-mAwuS-DSb1K26b.js";import"./sanitizerUtils-BT_8V5US-CWQWUwZQ.js";import"./GraphicsCollection-Bk6M0b7D-Dk6KdmO7.js";import"./HeightModelInfo-D5IdRvJ2-23y6MRiu.js";import"./TilemapCache-CjhKW_vj-8gKqgQfa.js";import"./Map-AEYszeHg-ZEOzAMWa.js";import"./Basemap-CL_uaRmk-O3l-dbYk.js";import"./PortalItem-DnxMlRVo-CI4Ns2_M.js";import"./writeUtils-DEFpwIW1-AHZYPaSV.js";import"./CollectionFlattener-D6h2Fkvj-WVl2BXw-.js";import"./resourceExtension-DOTCeiZj-C2WIbjQM.js";import"./PolygonCollection-HNNpnBH7-5UHgGprq.js";import"./ElevationQuery-DzlYa4L4-DkUTW9Ak.js";import"./TileInfo-Bz7QlefV-CdK7c8ef.js";import"./vec3f32-WCVSSNPR-9V6Uhrx-.js";import"./constants-D67WmGms-H7IOwEdB.js";import"./floatRGBA-D-Q4FzNN-DQhowfyr.js";import"./TileKey-C44YQC4_-BW7BBbYp.js";import"./BufferView-Cj2sQaht-avJ4OGB_.js";import"./vec2f32-CaVKkSa6-BjkBmyoj.js";import"./Octree-DckBBpQ7-CkRPu4UJ.js";import"./axisAngleDegrees-CjbXmycq-DcVVDR1-.js";import"./edgePreprocessing-D_eX-fWy-DqE-06Ss.js";import"./vec3-B_phcnZY-DHC7I6xa.js";import"./vec33-CWJeyzxV-Me4sF5XB.js";import"./MeshLocalVertexSpace-BGd1IdEs-C0HJG4wR.js";import"./dehydratedFeatures-Ql-uVzLq-aoK2987s.js";import"./memoryEstimations-Bd726a_p-0cVCY2Jz.js";import"./quantizationUtils-Ceq-Uxsu-DjgKK_0s.js";import"./LayerView3D-JY0KVfxL-H13gXtj0.js";import"./query-DeNEvEsQ-DfFlUyui.js";import"./pbfQueryUtils-DlZBMNQk-rXCy_evW.js";import"./OptimizedFeature-CwRGZPwv-Ddclhn0A.js";import"./OptimizedFeatureSet-BR8EEvDc-CgsRgxJh.js";import"./jsonUtils-CmpazY1u-6pDLj5sx.js";import"./queryZScale-CRP3Sh_E-F3y679Wx.js";import"./EventedSet-DfgtwAGn-CMNGS81T.js";import"./signal-BX9ezF8a-cf1Pn6io.js";import"./SimpleObservable-CvFyr0NA-DXpoMYph.js";import"./FeatureIdInfo-iL5WjyEH-DzYZU4u5.js";import"./constants-SxxbBSOD-SxxbBSOD.js";import"./displayFilterUtils-CIXGrQzt-XEoxkZ3i.js";import"./featurePopupQueryUtils-CnnY2XPA-CIiZSoGi.js";import"./floorFilterUtils-DKzVzLpH-C2F2Cy-S.js";import"./popupUtils-BKHMiD6K-CUN0lBkb.js";import"./RefreshableLayerView-BZ0W4dR0-NbasIvC8.js";import"./reader-DcGs6kKN-DHJfK-tm.js";import"./screenUtils-BitdhK1O-L0FLPAMi.js";import"./projectPointToVector-DL7Z4uvb-CPbOlZdQ.js";import"./scaleUtils-yfx9kKWT-D9SVsyM-.js";import"./layerUtils-DZGhvm-W-CfyHx1TZ.js";import"./tagSymbols-BPcGfZon-BPcGfZon.js";import"./Queue-CYlrXMwB-CYJTUII-.js";import"./timeZoneUtils-BSc7-7qA-BAv3h8mh.js";import"./ReactiveMap-B0by2bYu-DCsCfMj5.js";import"./TablesMixin-Q80MT3nU-CBB9B-b6.js";import"./plane-BNdSPG2o-DTV5z6SO.js";import"./enums-B4pqBiXb-BO-3hS_8.js";import"./VertexElementDescriptor-BlxU8vCE-BwuKQkTU.js";import"./Cyclical-BLSxUpe7-Bj8R2Yk-.js";import"./computeTranslationToOriginAndRotation-Bjd4esRf-vJ4LbdOU.js";import"./layerViewUtils-BTa15X3o-BjQlX2q8.js";import"./featureConversionUtils-BDA_FXJx-CDxX1Wik.js";import"./createFeatureId-CVwTD0fV-3fKpJDrk.js";import"./elevationInfoUtils-B8MpdRMP-CDlK86wO.js";import"./HUDIntersectorResult-1xTExS7z-dL9SFL6u.js";import"./intersectorUtilsConversions-pLQPEbcN-Ck-nyNYa.js";import"./Intersector-DS9YtyQY-DMoYp6i0.js";import"./DefaultLoadingContext-DXgBe4GE-Unnb_XgV.js";import"./wosrLoader-CIPfz1Cl-DlmQQkMX.js";import"./Version-BtYZEj58-LyRHDnSJ.js";import"./DoubleArray-DExKNiTh-CvVpHySW.js";import"./config-Dg972SSE-D9DBKeq5.js";import"./GeometryUtils-C354xUs0-BLAznQrw.js";import"./definitions-Dvg4hMIw-CdK2DzFN.js";import"./colorUtils-CeIi7j7j-C2WVx6th.js";import"./capabilities-Bi6C4OG6-CpURufko.js";import"./imageUtils-142g71N8-Wj0XNClb.js";import"./videoUtils-Dwx3AEgj-CduhpDRk.js";import"./uuid-Oe6SV2kF-IYX19xBA.js";import"./quickselect-QQC62dOK-Br2Ahhru.js";import"./meshVertexSpaceUtils-CtG7DPVT-kybwngCt.js";import"./TileKey-CXWFOqOI-Lra6v-mg.js";import"./loadAll-BCyxerwc-B4Lp8wGC.js";import"./opacityUtils-DuFH0EC9-DWspTgn2.js";import"./persistable-CdoDQOTR-BklJqWTn.js";import"./MD5-MtSiOt06-jWr180Yc.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw-DH8sdIsE.js";import"./utils-CylVuxNi--x86XOjU.js";import"./utils-Dpg4yj1D-CeFz2JVC.js";import"./types-BKo2foNY-DE0QfIFp.js";import"./labelUtils-BtizwBfq-Zegx4520.js";import"./ArcadeExpression-BlIRq-oN-VZkrwLVE.js";import"./TimeOnly-BERR31kg-CQiLyUZi.js";import"./enum-BzLwmiID-CcyIdWlQ.js";import"./FieldsIndex-CimK-TqD--24JoCkp.js";import"./timeSupport-CL-HYuK--A5dlzrQA.js";import"./attributeUtils-Dc8--CBJ-B-j5BZQ_.js";import"./highlightOptionsUtils-Cdm0-Ad8-Cud-MHR_.js";import"./FeatureTileDescriptor-n_NQwd9p-DjCngMQK.js";import"./dehydratedFeatureComparison-faNSTYzo-N4d2j25_.js";import"./queryForSymbologySnapping-cmldLZWb-jGt06mw8.js";import"./heatmapUtils-B-AXnq0l-BF3Q_jd2.js";import"./featureQueryAll-BfDWA5Wx-BKksFkIA.js";import"./jsonUtils-C9q_FK4K-GRCbm_Pe.js";import"./defaultsJSON-GKolV7NZ-GKolV7NZ.js";import"./diffUtils-wTC1YzlE-DCTUTUs8.js";import"./styleUtils-DWvicjTN-DL6_BIk4.js";import"./cimSymbolUtils-DOGwV0lV-DF1x9X12.js";import"./utils-DX2muIr3-DiPfFKSl.js";import"./hash-CcEbRgUF-DpReY683.js";import"./renderingInfoUtils-BivCmbrV-CIlcu1O_.js";import"./optimizedFeatureQueryEngineAdapter-Bma9_B5X-BMDAgToU.js";import"./WhereClauseCache-B0L2SmwV-NVT3RoWW.js";import"./QueryEngineCapabilities-DJC_YILC-CshvWf3J.js";import"./utils-CUk96PkC-CJv0qCOi.js";import"./utils-BbtW4lHb-D1wApKS_.js";import"./utils-BEeBypEk-DQLTC4jR.js";import"./SnappingCandidate-DGkpYqI6-CfPvDre4.js";import"./BoundsStore-CBAymNAD-BDX_dT4b.js";import"./jsonUtils-CY6YsQMo-LM0PY-PG.js";let h=class extends G{constructor(e){super(e),this.schedule=null,this._workerUpdating=!0}get updating(){return this._workerUpdating}get _graphicOrigin(){const e=this.layer.graphicOrigin;if(!q(e))throw new v("featurelayerview3d:invalid-graphic-origin","Layer's graphic origin is not a FeatureGraphicOrigin");return e}initialize(){const{layer:e,layerView:r,viewSpatialReference:t,renderSpatialReference:i}=this,s=e.elevationInfo;this._elevationContext=W.fromElevationInfo(s),this._workerHandle=new le(this.schedule,{createTexture:async({data:n,parameters:o})=>({result:await this.renderer.createTexture(n,o),transferList:[]}),releaseTexture:async({uid:n})=>(await this.renderer.releaseTexture(n),g),createMaterial:async({materialJSON:n})=>(await this.renderer.createMaterial(n),g),destroyMaterial:async({materialId:n})=>(await this.renderer.destroyMaterial(n),g),createDirectRenderer:async({materialId:n})=>(await this.renderer.createDirectRenderer(n),g),destroyDirectRenderer:async({materialId:n})=>(await this.renderer.destroyDirectRenderer(n),g),createLoDRenderer:async({rendererId:n,lodRenderGeometry:o},a)=>(await this.renderer.createLoDRenderer(n,o,a?.signal??void 0),g),destroyLoDRenderer:async({rendererId:n},o)=>(await this.renderer.destroyLoDRenderer(n,o?.signal??void 0),g),dispatchRenderCommands:async({commands:n})=>(await this.renderer.executeRenderCommands(n),g),applyElevationAlignment:async({mapPoints:n})=>{const{viewSpatialReference:o,elevationProvider:a,renderCoordsHelper:d}=this,l=ee(n,o,this._elevationContext,a,d);return{result:l,transferList:[l.buffer]}},setBaseInstance:async({rendererId:n,baseInstance:o})=>(this.renderer.setBaseInstance(n,o),g)}),this.addResolvingPromise((async()=>{await e.load();const n={url:e.parsedUrl?.path??"",baseQuery:e.createQuery().toJSON(),objectIdField:e.objectIdField,capabilities:e.capabilities,fieldIndex:e.fieldsIndex.toJSON(),timeInfo:e.timeInfo?.toJSON(),elevationInfo:s?.toJSON(),fullExtent:e.fullExtent?.toJSON(),renderer:e.renderer?.toJSON()},o={fullOpacity:r.fullOpacity};await this._workerHandle.invokeMethod("setup",{viewSpatialReference:t.toJSON(),renderSpatialReference:i.toJSON(),viewingMode:this.viewingMode,layerInfo:n,layerViewInfo:o})})()),this.addHandles(this._workerHandle.on("notify-updating",({updating:n})=>{this._workerUpdating=n}))}onTileTreeChange(e){this._workerHandle.invokeMethod("onTileTreeChange",{tiles:e.items.map(ue)})}onElevationChange(e){this._workerHandle.invokeMethod("onElevationChange",{context:e.context,spatialReference:e.spatialReference?.toJSON(),extent:J(e.extent)})}onLayerViewOpacityChange(e){this._workerHandle.invokeMethod("onLayerViewOpacityChange",e)}onRendererChange(e){const r=e?.toJSON();this._workerHandle.invokeMethod("onRendererChange",r)}async executeQuery(e,r){const t=await this._workerHandle.invokeMethod("executeQuery",e?.toJSON(),r),i=T.fromJSON(t);return this._ensureLayerOnFeatures(i),i}async executeQueryForIds(e,r){return await this._workerHandle.invokeMethod("executeQueryForIds",e?.toJSON(),r)}async executeQueryForCount(e,r){return await this._workerHandle.invokeMethod("executeQueryForCount",e?.toJSON(),r)}async executeQueryForExtent(e,r){const{count:t,extent:i}=await this._workerHandle.invokeMethod("executeQueryForExtent",e?.toJSON(),r);return{count:t,extent:A.fromJSON(i)}}async executeQueryForLatestObservations(e,r){const t=await this._workerHandle.invokeMethod("executeQueryForLatestObservations",e?.toJSON(),r),i=T.fromJSON(t);return this._ensureLayerOnFeatures(i),i}async executeAttributeBinsQuery(e,r){const t=await this._workerHandle.invokeMethod("executeAttributeBinsQuery",e.toJSON(),r);return j.fromJSON(t)}_ensureLayerOnFeatures(e){const{layer:r,_graphicOrigin:t}=this;for(const i of e.features)i.layer=r,i.sourceLayer=r,i.origin=t}};p([m()],h.prototype,"updating",null),p([m({constructOnly:!0})],h.prototype,"schedule",void 0),p([m({constructOnly:!0})],h.prototype,"layer",void 0),p([m({constructOnly:!0})],h.prototype,"layerView",void 0),p([m({constructOnly:!0})],h.prototype,"viewSpatialReference",void 0),p([m({constructOnly:!0})],h.prototype,"renderSpatialReference",void 0),p([m({constructOnly:!0})],h.prototype,"viewingMode",void 0),p([m({constructOnly:!0})],h.prototype,"renderer",void 0),p([m({constructOnly:!0})],h.prototype,"elevationProvider",void 0),p([m({constructOnly:!0})],h.prototype,"renderCoordsHelper",void 0),p([m()],h.prototype,"_workerUpdating",void 0),p([m()],h.prototype,"_graphicOrigin",null),h=p([R("esri.views.3d.layers.graphics.pipeline.Feature3DPipelineWorkerHandle")],h);let le=class extends Q{constructor(e,r){super("Feature3DPipelineWorker","setup",{},e,{strategy:"dedicated",client:r})}};function ue({id:e,lij:r,extent:t}){return{id:e,lij:r,extent:t}}const g={result:void 0};let I=class extends ${constructor(e){super(e),this._glMaterials=null,this._produces=new Map,this._renderGeometries=new Map,this._renderContext=null,this._drawParameters=new Y,this._bufferWriter=null,this._baseInstance=null,this.slicePlaneEnabled=!1,this.isGround=!1,this.type=e.material instanceof S?1:4,this.layerViewUid=e.layerViewUid}get produces(){return this._produces}get numFeatures(){let e=0;return this._renderGeometries.forEach(r=>e+=r.numElements),e}get usedMemory(){let e=0;return this._renderGeometries.forEach(r=>{e+=r.vao.usedMemory}),e}intersect(e,r,t,i){const{material:s,_bufferWriter:n,layerViewUid:o,_renderGeometries:a}=this;n.intersect!=null&&a.forEach(({buffer:d,localOrigin:l,items:c})=>n.intersect(d.data,s.parameters,l,e,t,i,(u,y,w,f)=>{if(!c.visibilities[w])return;const b=c.objectIds[w];e.handleObjectIntersection({object:{id:B,graphicUid:b,layerViewUid:o,boundingVolumeWorldSpace:new K,geometries:[{material:s}]},geometryId:0,primitiveIndex:w},u,y,null,f)}))}initialize(){this._bufferWriter=this.material.createBufferWriter(),this.material.produces.forEach((e,r)=>{this._produces.set(r,t=>t!==9&&t!==5&&e(t))})}destroy(){this._glMaterials.dispose();const e=this._renderGeometries.keys();for(const r of e)this.removeRenderGeometryBuffer(r);this._baseInstance?.vbo.dispose(),this._baseInstance=null}acquireTechniques(e){const r=this.material;if(!r.shouldRender(e))return null;const{output:t,bind:i}=e;return!r.produces.get(i.slot)?.(t)||t===9||t===5?null:this._glMaterials.load(e.rctx,i.slot,t)?.beginSlot(i)}render(e,r){const t=this._renderGeometries;if(t.size===0)return;const{bind:i}=e,s=i.slot===10||i.slot===11?i.slot:null,n=e.rctx;n.runAppleAmdDriverHelper(),n.bindTechnique(r,i,this.material.parameters);const o=r.program,{_baseInstance:a}=this,d=a==null?l=>{n.drawArrays(r.primitiveType,l.start,l.count)}:(l,c)=>{ae(n,c.locations,c.buffer("instances"),l.start),n.drawArraysInstanced(r.primitiveType,0,a.buffer.elementCount,l.count)};for(const[l,c]of t){const{vao:u,localOrigin:y,drawCalls:w}=c;this._drawParameters.origin=y,o.bindDraw(i,this.material.parameters,this._drawParameters),r.ensureAttributeLocations(u),n.bindVAO(u),n.setPipelineState(r.getPipeline(!1,s));for(const f of w)d(f,u)}}initializeRenderContext(e){this._glMaterials=new X(this.material,e.materials),this._renderContext=e.renderContext}uninitializeRenderContext(){}addRenderGeometryBuffer(e,r,t,i){this.removeRenderGeometryBuffer(e);const{data:s,elementCount:n}=r,{_baseInstance:o,_bufferWriter:a,_renderContext:{rctx:d}}=this,l=o==null?a.layout:a.instanceLayout;if(!l)throw new Error("Cannot create instance buffer for non-instanced material");const c=new C(d,k(l,o==null?0:1),s);let u;u=new Z(d,o==null?new Map([["geometry",c]]):new Map([["geometry",o.vbo],["instances",c]]));const y={localOrigin:i,numElements:n,buffer:r,items:t,vao:u,drawCalls:this._produceDrawCalls(t)};this._renderGeometries.set(e,y)}updateRenderGeometryBuffer(e,r,t,i){const{data:s,elementCount:n}=r,o=this._renderGeometries.get(e);if(o==null)return;const a=o.vao.buffer(this._baseInstance==null?"geometry":"instances");a?.setSize(s.byteLength),a?.setSubData(new Uint8Array(s),0,0,s.byteLength),o.localOrigin=i,o.numElements=n,o.buffer=r,o.items=t,o.drawCalls=this._produceDrawCalls(t)}removeRenderGeometryBuffer(e){const r=this._renderGeometries.get(e);r!=null&&(this._baseInstance?(r.vao.buffer("instances")?.dispose(),r.vao.disposeVAOOnly()):r.vao.dispose(),this._renderGeometries.delete(e))}updateVisibility(e,r){const t=this._renderGeometries.get(e);if(t==null)return;const{items:i}=t;if(i.visibilities.length!==r.length)throw new Error("Unexpected mismatch between old and new visibility flag buffer length.");i.visibilities=r,t.drawCalls=this._produceDrawCalls(i)}setBaseInstance(e){if(this._baseInstance?.vbo.dispose(),e==null)return void(this._baseInstance=null);const{data:r}=e,t=new C(this._renderContext.rctx,k(this._bufferWriter.layout),r);this._baseInstance={buffer:e,vbo:t}}hasHighlight(){return!1}_produceDrawCalls(e){const{visibilities:r,ranges:t}=e,i=[];if(pe(t)){if(t.numItems===0)return[];const s=t.numVertices;let n=null;for(let o=0;o<t.numItems;++o)r[o]?n==null?(n={start:o*s,count:s},i.push(n)):n.count+=s:n=null}else{const s=t.counts,n=s.length;if(n===0)return[];let o=null,a=0;for(let d=0;d<n;++d){const l=r[d],c=s[d];l?o==null?(o={start:a,count:c},i.push(o)):o.count+=c:o=null,a+=c}}return i}};function pe(e){return"numItems"in e}p([m({constructOnly:!0})],I.prototype,"material",void 0),I=p([R("esri.views.3d.layers.graphics.pipeline.rendering.DirectRenderer")],I);let O=class{constructor(e){this._instanceGroupToIndices=new Map,this._instanceIndexToFeatureId=new Map,this._disposeResourceHandles=new Array,this._lodRendererResources=null,this._numFeatures=0,this.layerViewUid=e.layerViewUid,this.view=e.view,this.sharedResources=this.view.sharedSymbolResources,this.scheduler=this.view.resourceController.scheduler}get numFeatures(){return this._numFeatures}get usedMemory(){return(this._lodRendererResources?.lodRenderer?.symbol?.computeUsedMemory()??0)+16*this._instanceIndexToFeatureId.size}destroy(){this._disposeResourceHandles.forEach(e=>e())}async doLoad(e,r,t){const i=ce(d=>r(d),e),s=this.view.stage,n=i.getMaterials(),o=i.getTextures();s.addTextures(o),this._addDisposeResource(()=>{o.forEach(d=>d.unload()),s.removeTextures(o)}),await Promise.all(o.map(d=>this.view.stage.schedule(()=>d.load(s.renderView.renderingContext),t))),P(t);const a=await this._createLodRenderer(i,t);this._lodRendererResources={lodRenderer:a,materials:n,textures:o}}addInstances(e,r){const t=this._lodRendererResources;if(t==null)return;const i=t.lodRenderer;if(i==null)return;const{featureIds:s,localTransforms:n,globalTransforms:o,visibility:a}=r,d=new Array,l=i.instanceData,c=s.length,u=this._instanceIndexToFeatureId;for(let y=0;y<c;++y){const w=s[y],f=l.addInstance(),b=l.view,F=16*y;b.localTransform.copyFromTypedBuffer(f,n,F),b.globalTransform.copyFromTypedBuffer(f,o,F),l.updateModelTransform(f),l.setVisible(f,!!a[y]),d.push(f),u.set(f,w)}this._instanceGroupToIndices.set(e,d),this._numFeatures+=c}removeInstances(e){const r=this._instanceGroupToIndices.get(e);if(r==null)return;const t=this._lodRendererResources;if(t==null)return;const i=t.lodRenderer.instanceData,s=this._instanceIndexToFeatureId;for(const n of r)i.removeInstance(n),s.delete(n);this._numFeatures-=r.length,this._instanceGroupToIndices.delete(e)}updateVisibility(e,r){const t=this._instanceGroupToIndices.get(e);if(t==null)return;const i=this._lodRendererResources;if(i==null)return;const s=t.length;if(s!==r.length)throw new Error("Unexpected mismatch instance count and visibility flag buffer length.");const n=i.lodRenderer.instanceData;for(let o=0;o<s;++o)n.setVisible(t[o],!!r[o])}updateGlobalTransforms(e,r){const t=this._instanceGroupToIndices.get(e);if(t==null)return;const i=this._lodRendererResources;if(i==null)return;const s=t.length;if(16*s!==r.length)throw new Error("Unexpected mismatch instance count and visibility flag buffer length.");const n=i.lodRenderer.instanceData,o=n.view;for(let a=0;a<s;++a){const d=t[a],l=16*a;o.globalTransform.copyFromTypedBuffer(d,r,l),n.updateModelTransform(d)}}_addDisposeResource(e){this._disposeResourceHandles.push(e)}async _createLodRenderer(e,r){const t=this.view.stage,i={layerViewUid:this.layerViewUid,graphicUid:n=>this._instanceIndexToFeatureId.get(n)??-1,notifyGraphicGeometryChanged:n=>1,notifyGraphicVisibilityChanged:n=>1},s=new de({symbol:e,metadata:i,shaderTransformation:null},this.scheduler);return s.slicePlaneEnabled=!1,this._addDisposeResource(()=>{t.removeRenderPlugin(s),s.destroy()}),await t.addRenderPlugin(s,r),s}};function ce(e,r){const t=r.levels.map(i=>{const s=i.components.map(n=>{const o=e(n.materialId);if(!me(o))throw new Error("LodRenderer only supports DefaultMaterial");const a=new re(o,n.renderGeometryBuffer.data,n.renderGeometryBuffer.elementCount,n.boundingInfo);return new te(a)});return new ie(s,i.minScreenSpaceRadius)});return new ne(t)}function me(e){return e!=null&&"materialType"in e&&e.materialType==="default"}O=p([R("esri.views.3d.layers.graphics.pipeline.rendering.LodRenderer")],O);let x=class extends L{constructor(e){super(),this.view=null,this.layerViewUid=null,this._stage=null,this._materials=new Map,this._textures=new Map,this._directRenderers=new Map,this._lodRenderers=new Map,this.totalFeatures=0,this.view=e.view,this.layerViewUid=e.layerViewUid}initialize(){this._stage=this.view.stage}destroy(){this.removeAllHandles(),this._lodRenderers.forEach(e=>e.destroy())}async createTexture(e,r){const{_textures:t,_stage:i}=this,s=new se(e,r);return t.set(s.id,s),i&&(s.load(i.renderView.renderingContext),i.addTexture(s)),s.id}async releaseTexture(e){const{_textures:r,_stage:t}=this,i=r.get(e);i&&(t&&(i.unload(),t.removeTexture(i)),r.delete(e))}_destroyTexture(e){const{_textures:r,_stage:t}=this,i=r.get(e);i&&(t&&(i.unload(),t.removeTexture(i)),r.delete(e))}async createMaterial(e){const{view:r}=this,t=r.state.viewingMode===1;let i=null;switch(e.type){case"default":{const s=e.parameters,n=new oe(s,{spherical:t});n.setParameters({cullFace:n.transparent?0:2}),i=n;break}case"hud":{const s=e.parameters;i=new S(s,t)}}this._materials.set(e.materialId,i)}async destroyMaterial(e){this._materials.delete(e)}async updateMaterial(e){}async createDirectRenderer(e){if(this._directRenderers.has(e))return;const r=this._materials.get(e);if(r==null)throw new Error(`material not found ${e}`);const{view:t}=this,i=new I({material:r,layerViewUid:this.layerViewUid});this._directRenderers.set(e,i),t.stage.addRenderPlugin(i),t.stage.renderView.renderer.updateHasFlags()}setBaseInstance(e,r){const t=this._directRenderers.get(e);if(t==null)throw new Error(`renderer not found ${e}`);t.setBaseInstance(r)}async destroyDirectRenderer(e){const r=this._directRenderers.get(e);if(r==null)return;const t=this.view;t.stage.removeRenderPlugin(r),this._directRenderers.delete(e),t.stage.renderView.renderer.updateHasFlags()}async createLoDRenderer(e,r,t){const i=new O({view:this.view,layerViewUid:this.layerViewUid}),s=n=>this._materials.get(n);if(await i.doLoad(r,s,t),t?.aborted)throw i.destroy(),D();this._lodRenderers.set(e,i)}async destroyLoDRenderer(e,r){const t=this._lodRenderers.get(e);t!=null&&(t.destroy(),this._lodRenderers.delete(e))}_destroyLodRenderer({rendererId:e}){const r=this._lodRenderers.get(e);r!=null&&(r.destroy(),this._lodRenderers.delete(e))}async executeRenderCommands(e){for(const r of e)switch(r.id){case"destroy-texture":this._destroyTexture(r.textureId);break;case"update-material":this._updateMaterial(r);break;case"destroy-material":this._destroyMaterial(r);break;case"add-direct-renderer-geometry-buffer":this._addDirectRendererGeometryBuffer(r);break;case"update-direct-renderer-geometry-buffer":this._updateDirectRendererGeometryBuffer(r);break;case"remove-direct-renderer-geometry-buffer":this._removeDirectRendererGeometryBuffer(r);break;case"destroy-lod-renderer":this._destroyLodRenderer(r);break;case"add-lod-instances":this._addLodInstances(r);break;case"remove-lod-instances":this._removeLodInstances(r);break;case"update-lod-instance-data":this._updateLodInstanceData(r);break;case"update-visibility":this._updateVisibility(r)}e.length>0&&this._updateFeatureCount()}_updateFeatureCount(){let e=0;for(const r of this._directRenderers.values())e+=r.numFeatures;for(const r of this._lodRenderers.values())e+=r.numFeatures;this._set("totalFeatures",e)}get usedMemory(){let e=0;for(const r of this._directRenderers.values())e+=r.usedMemory;for(const r of this._lodRenderers.values())e+=r.usedMemory;return e}_updateMaterial({materialId:e,parameters:r}){const t=this._materials.get(e);t!=null?t.setParameters(r):console.error("material not found")}_destroyMaterial({materialId:e}){this._materials.get(e)!=null?this._materials.delete(e):console.error("material not found")}_addDirectRendererGeometryBuffer({groupId:e,rendererId:r,renderGeometryBuffer:t,renderGeometryBufferItems:i,localOrigin:s}){const n=this._directRenderers.get(r);n!=null?(n.addRenderGeometryBuffer(e,t,i,s),this.view.stage.renderView.requestRender()):console.error("no renderer assigned to provided material")}_updateDirectRendererGeometryBuffer({groupId:e,rendererId:r,renderGeometryBuffer:t,renderGeometryBufferItems:i,localOrigin:s}){const n=this._directRenderers.get(r);n!=null?(n.updateRenderGeometryBuffer(e,t,i,s),this.view.stage.renderView.requestRender()):console.error("no renderer assigned to provided material")}_removeDirectRendererGeometryBuffer({groupId:e,rendererId:r}){const t=this._directRenderers.get(r);t!=null?(t.removeRenderGeometryBuffer(e),this.view.stage.renderView.requestRender()):console.error("no renderer assigned to provided material")}_addLodInstances({rendererId:e,groupId:r,data:t}){const i=this._lodRenderers.get(e);if(i==null)throw new Error("no lod renderer assigned to provided lod renderer Id");i.addInstances(r,t),this.view.stage.renderView.requestRender()}_removeLodInstances({rendererId:e,groupId:r}){const t=this._lodRenderers.get(e);if(t==null)throw new Error("no lod renderer assigned to provided lod renderer Id");t.removeInstances(r),this.view.stage.renderView.requestRender()}_updateLodInstanceData({rendererId:e,groupId:r,globalTransforms:t}){const i=this._lodRenderers.get(e);if(i==null)throw new Error("No renderer found with the provided id");t!=null&&i.updateGlobalTransforms(r,t),this.view.stage.renderView.requestRender()}_updateVisibility({rendererId:e,groupId:r,visibility:t}){const i=this._directRenderers.get(e)??this._lodRenderers.get(e);if(i==null)throw new Error("No renderer found with the provided id");i.updateVisibility(r,t),this.view.stage.renderView.requestRender()}};p([m({readOnly:!0})],x.prototype,"totalFeatures",void 0),x=p([R("esri.views.3d.layers.graphics.pipeline.rendering.FeaturePipelineRenderManager")],x);let _=class extends G{constructor(e){super(e),this._renderer=null,this.graphicsQuery={queryForSymbologySnapping:(r,t)=>{throw new v("featurelayer:unsupported-symbology-snapping","Symbology snapping not supported")},executeQuery:async(r,t)=>await this._workerHandle.executeQuery(r,t),executeQueryForIds:async(r,t)=>await this._workerHandle.executeQueryForIds(r,t),executeQueryForCount:async(r,t)=>await this._workerHandle.executeQueryForCount(r,t),executeQueryForExtent:async(r,t)=>await this._workerHandle.executeQueryForExtent(r,t),executeQueryForLatestObservations:async(r,t)=>await this._workerHandle.executeQueryForLatestObservations(r,t),executeAttributeBinsQuery:async(r,t)=>this._workerHandle.executeAttributeBinsQuery(r,t)},this.maximumNumberOfFeatures=1e3}initialize(){if(this.layerView.layer.geometryType!=="point")throw new v("featurelayer:unsupported-geometry-type",`${this.layerView.layer.geometryType} is not supported`);this.addResolvingPromise(this.setup())}destroy(){this.removeAllHandles(),this._workerHandle.destroy(),H(this._renderer)}async setup(){const e=this.layerView,{layer:r,view:t,uid:i}=e,{spatialReference:s,renderSpatialReference:n,resourceController:o,renderCoordsHelper:a,elevationProvider:d}=t,l=t.state.viewingMode;if(this._renderer=new x({view:t,layerViewUid:i}),r.type!=="feature")throw new v("featurelayer:unsupported-layertype","Only FeatureLayer is supported");const c=new h({schedule:u=>o.immediate.schedule(u),layer:r,layerView:e,viewSpatialReference:s,renderSpatialReference:n,viewingMode:l,renderer:this._renderer,elevationProvider:d,renderCoordsHelper:a});this._workerHandle=await c.when(),this.addHandles([this.layerView.view.enableFeatureTiles(),U(()=>this.layerView.view.featureTiles?.tiles,"change",u=>{this._workerHandle.onTileTreeChange(u.target)},{onListenerAdd:u=>this._workerHandle.onTileTreeChange(u),onListenerRemove:u=>this._workerHandle.onTileTreeChange(u)}),t.elevationProvider.on("elevation-change",u=>this._workerHandle.onElevationChange(u)),M(()=>this.layerView.fullOpacity,u=>this._workerHandle.onLayerViewOpacityChange(u),{sync:!1}),M(()=>r.renderer,u=>this._workerHandle.onRendererChange(u),{sync:!1})])}get legendEnabled(){return!1}get hasAllFeatures(){return!1}get hasAllFeaturesInView(){return!1}get hasFullGeometries(){return!1}get symbologySnappingSupported(){return!1}get scaleVisibilitySuspended(){return!1}get snappingComplexityExceeded(){return!1}get suspendInfo(){return{}}get updating(){return this._workerHandle.updating}get dataUpdating(){return!1}get updatePolicy(){return 0}get maximumNumberOfFeaturesExceeded(){return!1}get updatingProgressValue(){return 1}get usedMemory(){return this._renderer?.usedMemory??0}get unloadedMemory(){return 0}get ignoresMemoryFactor(){return!0}get totalFeatures(){return this._renderer?.totalFeatures??0}get performanceInfo(){const e=this.totalFeatures;return new N(new z(this.usedMemory,e,e,this.maximumNumberOfFeatures,0,null),e,e,this.maximumNumberOfFeaturesExceeded,"tiles","n/a")}get suspendResumeExtentMode(){return"computed"}forEachGraphic(e){}findGraphic(e){return null}highlightByObjectIds(e,r){return V}highlightByGraphics(e,r){return V}maskOccludee(e){return E()}async whenGraphicBounds(e,r){return null}computeAttachmentOrigin(e,r){return null}elevationAlignPointsInFeatures(e,r){throw new v("featurelayer:unsupported-elevation-alignment","Elevation alignment not supported")}async doRefresh(e){}setVisibility(e,r){}getMissingAttributesForFeature(e){return null}getHydratedGeometry(e){return null}};p([m()],_.prototype,"layerView",void 0),p([m()],_.prototype,"updating",null),p([m()],_.prototype,"totalFeatures",null),_=p([R("esri.views.3d.layers.graphics.pipeline.Feature3DPipeline")],_);export{_ as Feature3DPipeline};
