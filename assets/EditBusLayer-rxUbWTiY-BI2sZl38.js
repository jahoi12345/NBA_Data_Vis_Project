const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/deleteForwardEdits-CIdd-s9d-Bq-FWGEV.js","assets/Point-BfTTZoMu-BAT2Wq6O.js","assets/index-CTl7hdrJ.js","assets/index-Cv2ko1Ob.css","assets/jsonMap-Bs3hmeCU-Cusd0Fmz.js","assets/reader-DcGs6kKN-DHJfK-tm.js","assets/utils-CylVuxNi-CqOfmBVG.js","assets/DeleteForwardEditsParameters-TQS3KkAX-D_SR05-0.js"])))=>i.map(i=>d[i]);
import{H as E,_ as H}from"./index-CTl7hdrJ.js";import{Y as V,H as k,G as D,a2 as m,ab as L}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{I as P}from"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import{H as $}from"./Point-BfTTZoMu-BAT2Wq6O.js";import{a as N}from"./uuid-Oe6SV2kF-IYX19xBA.js";const M=(e,s=M,a=s.f||(s.f=["assets/deleteForwardEdits-CIdd-s9d.js","assets/Point-BfTTZoMu.js","assets/jsonMap-Bs3hmeCU.js","assets/reader-DcGs6kKN.js","assets/index-BzxsWNRw.js","assets/index-Cv2ko1Ob.css","assets/utils-CylVuxNi.js","assets/DeleteForwardEditsParameters-TQS3KkAX.js"]))=>e.map(t=>a[t]),B=N(),A=new Map,S=new Map;async function X(e,s,a){if(!e||!a)return!1;if(!s)return!0;const t=new URL(e).host;let n=A.get(t);if(!n){const d=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,"");n=(await $(d,{responseType:"json",query:{f:"json"}})).data.defaultVersionName}return n===s}async function z(e,s,a=!1){if(!e||!s)return!0;const t=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),n=S.get(t)?.entries();if(n){for(const[d,i]of n)if(i.name===s){const c=!i.stack?.hasForwardEdits();if(!c&&a){const[{deleteForwardEdits:o},{default:h}]=await Promise.all([E(()=>H(()=>import("./deleteForwardEdits-CIdd-s9d-Bq-FWGEV.js"),__vite__mapDeps([0,1,2,3,4,5,6])),M([0,1,2,3,4,5,6])),E(()=>H(()=>import("./DeleteForwardEditsParameters-TQS3KkAX-D_SR05-0.js"),__vite__mapDeps([7,4])),M([7,2]))]),u=await o(t,d,new h({sessionId:B,moment:i.moment}));return u.success&&i.stack?.clearForwardEdits(),u.success}return c}}return!0}function C(e,s){if(!e)return!1;const a=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),t=S.get(a)?.entries();if(t){for(const[n,d]of t)if(d.name===s)return d.lockType==="edit"}return!1}const y=new P;function O(e){return y.on("apply-edits",new WeakRef(e))}function W(e){return y.on("update-moment",new WeakRef(e))}function J(e,s,a=null,t=!1){const n=L();return t=s==null||t,y.emit("apply-edits",{serviceUrl:e,layerId:s,gdbVersion:a,mayReceiveServiceEdits:t,result:n.promise}),n}const R=Symbol();function Z(e){return e!=null&&typeof e=="object"&&R in e}function p(e){return e!=null&&typeof e=="object"&&"gdbVersion"in e}function g(e,s,a){const t=new URL(e).host,n=A.get(t),d=i=>!i||i===n;return d(s)&&d(a)||s===a}const ee=e=>{var s;const a=e;let t=class extends a{static{s=R}constructor(...n){super(...n),this[s]=!0,this._applyEditsHandler=d=>{const{serviceUrl:i,layerId:c,gdbVersion:o,mayReceiveServiceEdits:h,result:u}=d,F=i===this.url,f=c!=null&&this.layerId!=null&&c===this.layerId,x=p(this),T=p(this)&&g(i,o,this.gdbVersion);if(!F||x&&!T||!f&&!h)return;const U=u.then(r=>{if(this.lastEditsEventDate=new Date,f&&(r.addedFeatures.length||r.updatedFeatures.length||r.deletedFeatures.length||r.addedAttachments.length||r.updatedAttachments.length||r.deletedAttachments.length))return this.emit("edits",m(r)),r;const _=r.editedFeatures?.find(({layerId:b})=>b===this.layerId);if(_){const{adds:b,updates:v,deletes:j}=_.editedFeatures,w={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:b?b.map(({attributes:l})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]})):[],deletedFeatures:j?j.map(({attributes:l})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]})):[],updatedFeatures:v?v.map(({current:{attributes:l}})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]})):[],editedFeatures:m(r.editedFeatures),exceededTransferLimit:!1,historicMoment:m(r.historicMoment)};return this.emit("edits",w),w}const I={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:[],deletedFeatures:[],updatedFeatures:[],editedFeatures:m(r.editedFeatures),exceededTransferLimit:!1,historicMoment:m(r.historicMoment)};return"historicMoment"in this&&this._shouldUpdateHistoricMoment(i,o,I.historicMoment)&&this.emit("edits",I),I}).then(r=>("historicMoment"in this&&this._shouldUpdateHistoricMoment(i,o,r.historicMoment)&&(this.historicMoment=r.historicMoment),r));this.emit("apply-edits",{result:U})},this._updateMomentHandler=d=>{const{serviceUrl:i,gdbVersion:c,moment:o}=d,h=i===this.url,u=p(this),F=p(this)&&g(i,c,this.gdbVersion),f=p(this)&&!g(i,this.gdbVersion,null);h&&u&&F&&f&&"historicMoment"in this&&this.historicMoment!==o&&(this.historicMoment=o)},this.when().then(()=>{this.addHandles(O(this._applyEditsHandler)),"historicMoment"in this&&this.addHandles(W(this._updateMomentHandler))},()=>{})}_shouldUpdateHistoricMoment(n,d,i){return"historicMoment"in this&&this.historicMoment!==i&&C(n,d)}};return V([k()],t.prototype,"lastEditsEventDate",void 0),t=V([D("esri.layers.mixins.EditBusLayer")],t),t};export{X as J,z as K,C as O,B as P,J as Q,Z as X,ee as Y};
