const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/Feature3DPipeline-DmIlSTr4.js","assets/jsonMap-Bs3hmeCU.js","assets/reactiveUtils-SO2Ko3sy.js","assets/WorkerHandle-BioJnATq.js","assets/workers-1ohSU8uJ.js","assets/Queue-CYlrXMwB.js","assets/SimpleObservable-CvFyr0NA.js","assets/Point-Byf20bUE.js","assets/reader-DcGs6kKN.js","assets/index-DqD_sEjA.js","assets/index-BWTVr3y1.css","assets/intl-sjEXBsFq.js","assets/date-IqUzANpt.js","assets/Extent-KC9qx-Cg.js","assets/aaBoundingRect-C2DMsiYR.js","assets/mathUtils-PIGhLnI9.js","assets/isFeatureGraphicOrigin-YA2hudPe.js","assets/AttributeBinsFeatureSet-B9dIyCEP.js","assets/Graphic-DDayESOh.js","assets/getPopupProvider-3D7bbDmC.js","assets/collectionUtils-oMUPqMMC.js","assets/lengthUtils-go2kD43r.js","assets/Color-CERqXxxY.js","assets/Layer-C7047eDe.js","assets/jsonUtils-yEjkUv4W.js","assets/Polyline-DWJWvQfr.js","assets/Polygon-BuPlovwL.js","assets/typeUtils-cp7rBKcN.js","assets/createFeatureId-CVwTD0fV.js","assets/typeUtils-CzDvsuOn.js","assets/lineMarkers-CDwLe3J6.js","assets/PolygonSymbol3D-59towS1W.js","assets/ExtrudeSymbol3DLayer-DSc1ou2x.js","assets/screenUtils-BitdhK1O.js","assets/opacityUtils-DuFH0EC9.js","assets/aaBoundingBox-3Iqogf_p.js","assets/DoubleArray-DExKNiTh.js","assets/mat4f64-q_b6UJoq.js","assets/Font-2nHmDeHF.js","assets/SimpleFillSymbol-CDawtd9z.js","assets/SimpleMarkerSymbol-BGAFRS9_.js","assets/PictureMarkerSymbol-BOUJUEwC.js","assets/TextSymbol-nUyYMD__.js","assets/FeatureSet-DvzIE7hz.js","assets/Field-Cm_ZejYW.js","assets/fieldType-DVUzXtk_.js","assets/ShadowCastClear.glsl-CTBiNCmp.js","assets/Texture-DTVG6Cub.js","assets/vec32-D-LmkFhk.js","assets/Indices-D0_UQPPr.js","assets/BufferView-DJ6YhZlA.js","assets/vec42-B7JTmW9u.js","assets/vec2f64-rIxtbMRN.js","assets/vec4f64-DPb6J-GU.js","assets/sphere-Bsee12C4.js","assets/mat4-Dyb44KrD.js","assets/vector-rshDErmj.js","assets/quatf64-CCm9z-pX.js","assets/frustum-CMU-76e0.js","assets/plane-DWmLiQ-_.js","assets/Emissions.glsl-B8XKMjLy.js","assets/enums-B4pqBiXb.js","assets/orientedBoundingBox-BZfYAK8f.js","assets/quat-BOZsyh2S.js","assets/spatialReferenceEllipsoidUtils-Dh5jNhp7.js","assets/computeTranslationToOriginAndRotation-D3f4P-V4.js","assets/projectionUtils-Ca1qXe4h.js","assets/InterleavedLayout-BzTz5c2k.js","assets/types-BKo2foNY.js","assets/VertexElementDescriptor-BlxU8vCE.js","assets/Cyclical-BLSxUpe7.js","assets/projectPointToVector-CB8yc0oW.js","assets/projectVectorToVector-ClOaOAsc.js","assets/HUDIntersectorResult-CB-YC_gl.js","assets/normalizeUtils-Cn5Bv9D5.js","assets/normalizeUtilsCommon-CXyKHnVX.js","assets/utils-Co6npZg_.js","assets/utils-pRUfTktY.js","assets/videoUtils-Dwx3AEgj.js","assets/modeUtils-BQgEm-fS.js","assets/uuid-Oe6SV2kF.js","assets/sanitizerUtils-BT_8V5US.js","assets/modeUtils-OCMtRbrJ.css","assets/PooledRBush-Dco5QkUp.js","assets/quickselect-QQC62dOK.js","assets/GraphicsCollection-B5BtcSOd.js","assets/HeightModelInfo-BAxQYIJ4.js","assets/RealisticTree.glsl-CEyQWjjF.js","assets/meshVertexSpaceUtils-4wKFiYHz.js","assets/MeshLocalVertexSpace-BF5t-ZPw.js","assets/vec3f32-WCVSSNPR.js","assets/memoryEstimations-Bd726a_p.js","assets/Intersector-xRrE-gUt.js","assets/scaleUtils-BWnCGTna.js","assets/layerUtils-CVHRa_-F.js","assets/TilemapCache-BbjoN03J.js","assets/LRUCache-fy84PBMi.js","assets/TileKey-7ckOq8tD.js","assets/tagSymbols-BPcGfZon.js","assets/UpdatingHandles-D2RI_3Hb.js","assets/asyncUtils-w6KfWU41.js","assets/signal-BX9ezF8a.js","assets/Map-DHqF3BVm.js","assets/Basemap-DGCp49tr.js","assets/loadAll-CJq_H00c.js","assets/PortalItem-BBxBVCCK.js","assets/writeUtils-BEpoIKEQ.js","assets/CollectionFlattener-DgYL3St7.js","assets/persistable-BoVzi5yb.js","assets/MD5-MtSiOt06.js","assets/multiOriginJSONSupportUtils-C0wm8_Yw.js","assets/resourceExtension-D2zUsunA.js","assets/PolygonCollection-CKv8Fhgy.js","assets/mat4f32-Djp3mnm5.js","assets/TablesMixin-CNKorJ8k.js","assets/timeZoneUtils-BSc7-7qA.js","assets/ReactiveMap-B0by2bYu.js","assets/Query-CEeFv7EX.js","assets/ElevationQuery-DPyvicX-.js","assets/TileInfo-91BYYMfX.js","assets/Scheduler-CNrsbccs.js","assets/constants-D67WmGms.js","assets/floatRGBA-CKE8XRqu.js","assets/labelUtils-BtizwBfq.js","assets/ArcadeExpression-Cdtbfg1V.js","assets/TimeOnly-DVuxiQet.js","assets/enum-BzLwmiID.js","assets/UnknownTimeZone-B697BDFv.js","assets/FieldsIndex-CKlbiDH8.js","assets/TileKey-C44YQC4_.js","assets/layerViewUtils-BTa15X3o.js","assets/unitConversionUtils-CewTmddc.js","assets/vec2f32-CaVKkSa6.js","assets/dehydratedFeatures-mX9SSgz7.js","assets/quantizationUtils-BEnKwGJh.js","assets/featureConversionUtils-DmN26Mnx.js","assets/OptimizedFeature-CwRGZPwv.js","assets/OptimizedFeatureSet-BR8EEvDc.js","assets/Octree-D2AA2k9W.js","assets/elevationInfoUtils-DnjVkdfR.js","assets/intersectorUtilsConversions-rja_eiKU.js","assets/DefaultLoadingContext-C43nV_Si.js","assets/wosrLoader-BQn9EqLz.js","assets/Version-BtYZEj58.js","assets/axisAngleDegrees-DcezjY_o.js","assets/edgePreprocessing-t8VXN1GM.js","assets/config-Dg972SSE.js","assets/GeometryUtils-BG5lg9a7.js","assets/definitions-Dvg4hMIw.js","assets/colorUtils-lLdknrGQ.js","assets/vec3-B_phcnZY.js","assets/vec33-CWJeyzxV.js","assets/capabilities-Bi6C4OG6.js","assets/imageUtils-BJxc18ls.js","assets/utils-Dwmi6JVi.js","assets/LodRenderer-q9rzNPNz.js","assets/highlightUtils-PYaHWGzp.js","assets/HeatmapDensity.glsl-BotGkJK-.js","assets/timeSupport-CGX8sogK.js","assets/utils-DTE-xBiC.js","assets/AttributeBinsQuery-t1JNpbUU.js","assets/FixedIntervalBinParameters-Bqd528PN.js","assets/NormalizationBinParametersMixin-BK9wNkI3.js","assets/attributeUtils-Dc8--CBJ.js","assets/highlightOptionsUtils-BP2PWw_7.js","assets/featureLayerUtils-Bv2SFOZp.js","assets/featureQueryAll-Bs1TsJHw.js","assets/SimpleRenderer-CSKJe5WL.js","assets/commonProperties-DG223FIq.js","assets/colorRamps-DswZzxkO.js","assets/ColorStop-De5gQTjr.js","assets/visualVariableUtils-F6Iu93CZ.js","assets/jsonUtils-DrqApMOE.js","assets/defaults3D-wBN5DBv3.js","assets/defaults-ByYwEp-i.js","assets/defaultsJSON-GKolV7NZ.js","assets/UniqueValueRenderer-CqL01Pyt.js","assets/diffUtils-CE43h1Bb.js","assets/RendererLegendOptions-BT9sB-l4.js","assets/styleUtils-D82ESqjo.js","assets/FeatureTileDescriptor-Bb_QT1pS.js","assets/dehydratedFeatureComparison-W3IVpx3G.js","assets/utils-Bb3b4-ci.js","assets/cimSymbolUtils-DOGwV0lV.js","assets/utils-DX2muIr3.js","assets/queryForSymbologySnapping-07QNULfz.js","assets/Graphics3DFeatureProcessor-BU9Nmh1H.js","assets/hash-CcEbRgUF.js","assets/renderingInfoUtils-Db9Q8QL9.js","assets/ExtentSet-DO4wYGOA.js","assets/optimizedFeatureQueryEngineAdapter-Bma9_B5X.js","assets/popupUtils-DtAIjudn.js","assets/Graphics3DObjectStates-CGKVSDN_.js","assets/FeatureFilter-BkpRbqma.js","assets/floorFilterUtils-DKzVzLpH.js","assets/QueryEngine-CpCjGYsg.js","assets/WhereClauseCache-B5H9FuJx.js","assets/WhereClause-CkFo5rAx.js","assets/QueryEngineCapabilities-DJC_YILC.js","assets/utils-BMngQjji.js","assets/heatmapUtils-DPGN6AdF.js","assets/utils-CvNxd5Ky.js","assets/utils-BEeBypEk.js","assets/ClassBreaksDefinition-BGOzyovZ.js","assets/SnappingCandidate-DGkpYqI6.js","assets/FeatureStore-DLkcZoZ-.js","assets/BoundsStore-Hjs9JcIT.js","assets/LayerView3D-CVs4RknR.js","assets/query-B5JUtqVm.js","assets/pbfQueryUtils-BWnD0e8P.js","assets/pbf-2SIhMekG.js","assets/queryZScale-DHIHeTwN.js","assets/EventedSet-DfgtwAGn.js","assets/FeatureIdInfo-iL5WjyEH.js","assets/constants-SxxbBSOD.js","assets/displayFilterUtils-DDhiY40-.js","assets/FeatureEffect-C6zu39AG.js","assets/jsonUtils-CZHLtdFW.js","assets/featurePopupQueryUtils-C5O2CTOV.js","assets/LayerView-CK0lo0ll.js","assets/RefreshableLayerView-BZ0W4dR0.js"])))=>i.map(i=>d[i]);
import{_ as Z}from"./index-DqD_sEjA.js";import{ap as H,l as q,bg as G,d as P,a6 as A,u as C,_ as a,m as o,a as b,i as v,G as U,s as z}from"./jsonMap-Bs3hmeCU.js";import{l as R,h as $,w as M,f as B,a as E}from"./reactiveUtils-SO2Ko3sy.js";import{j,R as W}from"./dehydratedFeatures-mX9SSgz7.js";import{G as J,b as T,f as X,r as K,P as Y,l as O,Y as S,Q as ee,R as D,W as te,X as re,M as m,Z as ie,_ as se,B as _,k as ae,$ as le}from"./lengthUtils-go2kD43r.js";import{V as oe,L as ne,v as ue}from"./HeatmapDensity.glsl-BotGkJK-.js";import{l as pe}from"./LayerView3D-CVs4RknR.js";import{n as de}from"./RealisticTree.glsl-CEyQWjjF.js";import{d as ce,t as he}from"./ShadowCastClear.glsl-CTBiNCmp.js";import{j as ye,y as fe}from"./query-B5JUtqVm.js";import{o as me}from"./WorkerHandle-BioJnATq.js";import{f as N}from"./Point-Byf20bUE.js";import{m as ge}from"./Field-Cm_ZejYW.js";import{s as Fe}from"./EventedSet-DfgtwAGn.js";import{t as be}from"./getPopupProvider-3D7bbDmC.js";import{e as we}from"./FeatureIdInfo-iL5WjyEH.js";import{E as _e}from"./constants-SxxbBSOD.js";import{u as xe}from"./displayFilterUtils-DDhiY40-.js";import{p as ve}from"./FeatureEffect-C6zu39AG.js";import{d as Ie}from"./FeatureFilter-BkpRbqma.js";import{J as Re}from"./featureLayerUtils-Bv2SFOZp.js";import{n as Ce,s as Ee}from"./featurePopupQueryUtils-C5O2CTOV.js";import{o as Q}from"./floorFilterUtils-DKzVzLpH.js";import{b as L}from"./Query-CEeFv7EX.js";import{a as Oe}from"./Graphics3DFeatureProcessor-BU9Nmh1H.js";import{n as Pe,p as qe}from"./popupUtils-DtAIjudn.js";import{d as Me}from"./LayerView-CK0lo0ll.js";import{i as Ve}from"./RefreshableLayerView-BZ0W4dR0.js";let $e=class extends ce{constructor(e,i,r,s,l,u){super(e.usedMemory,e.displayedFeatures,e.totalFeatures,e.maximumFeatures,e.nodes,e.core),this.storedFeatures=i,this.totalVertices=r,this.partial=s,this.mode=l,this.symbolComplexity=u}};class Te{constructor(e){this._controller=e,this._handle=new De(i=>e.schedule(i))}destroy(){this._handle.destroy()}invoke(e,i){return e.buffer&&e.buffer.byteLength!==0?(e.options.sourceSpatialReference&&e.options.sourceSpatialReference instanceof N&&(e.options={...e.options,sourceSpatialReference:e.options.sourceSpatialReference.toJSON()}),this._handle.invoke(e,i).then(r=>{let s=0,l=0;const u=N.fromJSON(r.spatialReference);r.spatialReference=u;const p=async d=>{const n=r.fields;if(n){for(;s<n.length;)if(n[s]=ge.fromJSON(n[s]),s++,d.madeProgress())return this._controller.reschedule(F=>p(F))}const h=r.features;for(;l<h.length;){const F=h[l];++l,F.uid=H();const w=F.geometry;if(w!=null&&(w.spatialReference=u,Se(w),d.madeProgress()))return this._controller.reschedule(c=>p(c))}return r};return this._controller.schedule(d=>p(d))})):Promise.resolve(null)}}function Se(t){switch(t.type){case"polyline":t.paths=t.hasZ&&t.hasM?t.paths.map(e=>e.map(i=>[i[0],i[1],i[2],i[3]])):t.hasZ||t.hasM?t.paths.map(e=>e.map(i=>[i[0],i[1],i[2]])):t.paths.map(e=>e.map(i=>[i[0],i[1]]));break;case"polygon":t.rings=t.hasZ&&t.hasM?t.rings.map(e=>e.map(i=>[i[0],i[1],i[2],i[3]])):t.hasZ||t.hasM?t.rings.map(e=>e.map(i=>[i[0],i[1],i[2]])):t.rings.map(e=>e.map(i=>[i[0],i[1]]))}}class De extends me{constructor(e){super("PBFDecoderWorker","_parseFeatureQuery",{_parseFeatureQuery:i=>[i.buffer]},e)}}let g=class extends q{constructor(t){super(t)}get implicitFields(){if(!this.layer.outFields?.includes("*"))return new Set;const e=new Set(this.layerView.requiredFields),i=new Set(this.layerView.availableFields);return G(i,e)}get queryFeaturesDehydrated(){const{layer:t}=this,e=t.capabilities,i=e&&e.query,r=i&&i.supportsFormatPBF,s=t.parsedUrl;if(r){this._decoder==null&&(this._decoder=new Te(this.controller));const l={sourceSpatialReference:t.spatialReference?.toJSON()??null,applyTransform:!0,maxStringAttributeFields:this.implicitFields,maxStringAttributeLength:k};return(u,p)=>ye(s,u,"pbf",this._createRequestOptions(p)).then(d=>(P(p),this._decoder!=null?this._decoder.invoke({buffer:d.data,options:l},p.signal):Promise.reject(A())))}return(l,u)=>fe(s,l,t.spatialReference,this._createRequestOptions(u)).then(p=>j(p.data,{maxStringAttributeFields:this.implicitFields,maxStringAttributeLength:k}))}queryFeatureCount(t,e){return this.layer.queryFeatureCount(t,e)}destroy(){this._decoder=C(this._decoder)}_createRequestOptions(t){return{...t,query:{...this.layer.customParameters,token:this.layer.apiKey,...t?.query}}}};a([o({constructOnly:!0})],g.prototype,"layer",void 0),a([o({constructOnly:!0})],g.prototype,"layerView",void 0),a([o({constructOnly:!0})],g.prototype,"controller",void 0),a([o({readOnly:!0})],g.prototype,"implicitFields",null),a([o({readOnly:!0})],g.prototype,"queryFeaturesDehydrated",null),g=a([b("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],g);let I=class extends q{constructor(e){super(e)}queryFeaturesDehydrated(e,i){return this.layer.queryFeatures(e,i)}};a([o({constructOnly:!0})],I.prototype,"layer",void 0),I=a([b("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileOGCServiceQuery3D")],I);let x=class extends q{constructor(t){super(t)}queryFeaturesDehydrated(t,e){return this.source.queryFeaturesJSON(t,e).then(j,i=>{if(i&&i.name==="query-features-json:unsupported")return this.layer.queryFeatures(t,e);throw i})}queryFeatureCount(t,e){return this.layer.queryFeatureCount(t,e)}};function Ne(t,e){const{layer:i}=t;return i.type==="feature"&&i.source.type==="feature-layer"||i.type==="catalog-footprint"?new g({layer:i,layerView:t,controller:e}):i.type==="feature"&&i.source.type==="memory"||i.type==="csv"||i.type==="geojson"||i.type==="oriented-imagery"||i.type==="wfs"?new x({layer:i,source:i.source}):i.type==="ogc-feature"?new I({layer:i}):null}a([o({constructOnly:!0})],x.prototype,"layer",void 0),a([o({constructOnly:!0})],x.prototype,"source",void 0),x=a([b("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileClientQuery3D")],x);const k=1024;class Qe{constructor(e){this._memoryCache=null;const i=e.layerView.layer;this._layerView=e.layerView,this.objectIdField=i.objectIdField,this.globalIdField="globalIdField"in i?i.globalIdField:null,this._returnZ=e.returnZ,this._returnM=e.returnM;const r=this._layerView.view.resourceController;this.query=Ne(this._layerView,r.normal),r&&this._memoryCacheEnabled&&(this._memoryCache=r.memoryController.newCache(`fl-${i.uid}`))}get _memoryCacheEnabled(){switch(this._layerView.layer.source.type){case"feature-layer":case"ogc-feature":case"oriented-imagery":return!0;case"csv":case"parquet":case"geojson":case"memory":case"wfs":return!1}}destroy(){this._memoryCache=C(this._memoryCache),this.query.destroy()}createQuery(){const e=this._layerView.layer.createQuery();return e.outFields=this._layerView.availableFieldsForQuery,e.returnZ=this._returnZ,e.returnM=this._returnM,e.outSpatialReference=this.tilingScheme?.spatialReference??this._layerView.view.spatialReference,e}get memoryCache(){return this._memoryCache}get viewingMode(){return this._layerView.view.state.viewingMode}get tilingScheme(){return this._layerView.view.featureTiles?.tilingScheme}get scheduler(){return this._layerView.view.resourceController?.scheduler}get geometryType(){return this._layerView.layer.geometryType}get fullExtent(){return this._layerView.layer.fullExtent}get tileMaxRecordCount(){return this._layerView.layer.capabilities.query.tileMaxRecordCount}get standardMaxRecordCount(){return this._layerView.layer.capabilities.query.standardMaxRecordCount}get maxRecordCount(){return this._layerView.layer.capabilities.query.maxRecordCount}get isDraped(){return this._layerView.layer.elevationInfo?.mode==="on-the-ground"}get effectiveDisplayFilter(){return this._layerView.displayFilterEnabled?this._layerView.effectiveDisplayFilter:null}get highlightIds(){return this._layerView.displayFilterEnabled?this._layerView.highlightIds:null}get capabilities(){return this._capabilities??=Le(this._layerView.layer),this._capabilities}logFetchError(e,i){e.error("#fetchTile()",this._layerView.layer,i?.message??i)}}function Le(t){const e=t.capabilities.query;return{supportsMultipleResolutions:ke(t),supportsPagination:!(!e||!e.supportsPagination),supportsResultType:!(!e||!e.supportsResultType),supportsCacheHint:!(!e||!e.supportsCacheHint),supportsQuantization:!(!e||!e.supportsQuantization),supportsQuantizationEditMode:!(!e||!e.supportsQuantizationEditMode),supportsMaxRecordCountFactor:!(!e||!e.supportsMaxRecordCountFactor),supportsFormatPBF:!(!e||!e.supportsFormatPBF)}}function ke(t){switch(t.geometryType){case"polyline":return!0;case"polygon":return t.capabilities&&t.capabilities.query&&t.capabilities.query.supportsQuantization;default:return!1}}let y=class extends oe{constructor(t){super(t),this._controllerTotal=0,this._processorTotal=0,this._needsRefresh=!1,this.suspendResumeExtentMode="data"}initialize(){this.addHandles(R(()=>({controller:this.controller,suspended:this.suspended}),({controller:t,suspended:e})=>{t&&!e&&this._needsRefresh&&(t.refetch(),this._needsRefresh=!1)}))}destroy(){this._fetcherContext=C(this._fetcherContext)}get maximumNumberOfFeatures(){return this.controller?.maximumNumberOfFeatures??this._get("maximumNumberOfFeatures")}set maximumNumberOfFeatures(t){this._set("maximumNumberOfFeatures",t),this.controller&&(this.controller.maximumNumberOfFeatures=t)}get snappingComplexityExceeded(){return this.controller?.snappingComplexityExceeded??!0}get maximumNumberOfFeaturesExceeded(){return!!this.controller&&!(this.suspended||!this.controller.maximumNumberOfFeaturesExceeded)}get updatingProgressValue(){let t=0;if(this.controller?.updating){const i=this.controller.updatingRemaining,r=Math.max(this.controller.updatingTotal,this._controllerTotal);r>0&&(t=(r-i)/r,this._controllerTotal=r)}let e=0;if(this.processor?.updating){const i=this.processor.updatingRemaining,r=Math.max(i,this._processorTotal);r>0&&(e=(r-i)/r,this._processorTotal=r)}return .5*(t+e)}get updatePolicy(){if(!this.controller)return 0;switch(this.controller.mode){case"snapshot":{const t=je.get(this.layer.geometryType);return t==null||this.controller.serviceDataCount>t?0:1}case"tiles":return 0}}get usedMemory(){return(this.processor?.usedMemory??0)+(this.controller?.memoryForUnusedFeatures??0)}get unloadedMemory(){const t=this.processor?.unprocessedMemoryEstimate??0,e=this.controller?.expectedFeatureDiff??0,i=this.processor?.loadedFeatures??0,r=i+e>0?i/(i+e):1;return t+e*(this.processor?.usedMemoryPerFeature??0)*r}get ignoresMemoryFactor(){return this.controller?.hasMaximumNumberOfFeaturesOverride}get performanceInfo(){const t=this.controller?.displayFeatureLimit,e=t?.averageSymbolComplexity,i=e!=null?`f:${e.verticesPerFeature},v:${e.verticesPerCoordinate}`:"n/a";return new $e(super.performanceInfo,this.controller?.performanceInfo?.storedFeatures??0,this.controller?.performanceInfo?.totalVertices??0,this.maximumNumberOfFeaturesExceeded,this.controller?.mode??"n/a",i)}async doRefresh(t){const{controller:e,processor:i,suspended:r}=this;t&&e&&(r?this._needsRefresh=!0:(e.refetch(),this._needsRefresh=!1)),i.refreshFilter()}setVisibility(t,e){this.processor?.setObjectIdVisibility(t,e)}getMissingAttributesForFeature(t){return this.controller.getMissingAttributesForFeature(t)}getHydratedGeometry(t){const e=this.graphics3DProcessor;if(e==null)return null;const i=e.graphics3DGraphicsByObjectID;if(i==null)return null;const r=i.get(t);return r==null?null:de(r.graphic.geometry)}createController(){this._fetcherContext=new Qe({layerView:this.layerView,returnZ:this.hasZ,returnM:this.hasM});const t=new ne({layerView:this.layerView,context:this._fetcherContext,graphics:new Fe,extent:this.clippingExtent});return this.updatingHandles.add(()=>t.serviceDataExtent,e=>{this.processor&&(this.processor.dataExtent=e)},$),this.addHandles(R(()=>this.suspended&&this.layerView.updateSuspended,e=>{e?t.suspend():t.resume()},M)),this.updatingHandles.add(()=>this.processor?.displayFeatureLimit,e=>t.displayFeatureLimit=e,$),this.addHandles(B(()=>!this.updating,()=>{this._controllerTotal=0,this._processorTotal=0})),t}beforeSetController(t){t.maximumNumberOfFeatures=this.maximumNumberOfFeatures}get test(){return{controller:this.controller,graphics3DProcessor:this.graphics3DProcessor,heatmapProcessor:this.heatmapProcessor,loadedGraphics:this.loadedGraphics}}};a([o()],y.prototype,"layerView",void 0),a([o()],y.prototype,"controller",void 0),a([o()],y.prototype,"_controllerTotal",void 0),a([o()],y.prototype,"_processorTotal",void 0),a([o()],y.prototype,"_needsRefresh",void 0),a([o()],y.prototype,"maximumNumberOfFeatures",null),a([o()],y.prototype,"snappingComplexityExceeded",null),a([o()],y.prototype,"maximumNumberOfFeaturesExceeded",null),a([o()],y.prototype,"updatingProgressValue",null),a([o()],y.prototype,"updatePolicy",null),a([o()],y.prototype,"suspendResumeExtentMode",void 0),y=a([b("esri.views.3d.layers.graphics.FeatureGraphics3DGraphicsPipeline")],y);const je=new Map([["point",5e3],["polygon",500],["polyline",1e3]]);function Ze(t,e){if(e.type!=="feature"&&e.type!=="subtype-group")return[];if(!e.url)return[];const i="utilityNetworks"in t.map?t.map.utilityNetworks??[]:[];for(const r of i)if(r.isUtilityLayer(e)){const s=e.fieldsIndex.get("assetgroup"),l=e.fieldsIndex.get("assettype");return[s?.name,l?.name].filter(u=>u!=null)}return[]}class He{constructor(e){this._fieldsIndex=e,this._clauses=[]}async finish(){return{requiresCurrentUser:(await Promise.all(this._clauses)).some(e=>e.currentUserRequired)}}visitClientWhereClause(e){e&&this._clauses.push(J(e,this._fieldsIndex))}visitFeatureReduction(e){if(e)switch(e.type){case"binning":case"cluster":this.visitLabelingInfo(e.labelsVisible,e.labelingInfo)}}visitLabelingInfo(e,i){if(e&&i!=null)for(const r of i)this.visitClientWhereClause(r.where)}visitDisplayFilter(e,i){if(e)for(const r of i?.filters??[])this.visitClientWhereClause(r.where)}visitFilter(e){this.visitClientWhereClause(e?.where)}visitTrackInfo(e){e!=null&&(this.visitLabelingInfo(e?.latestObservations.labelsVisible,e?.latestObservations.labelingInfo),this.visitLabelingInfo(e?.previousObservations.labelsVisible,e?.previousObservations.labelingInfo),this.visitLabelingInfo(e?.trackLines.labelsVisible,e?.trackLines.labelingInfo))}}const Ge=t=>{const e=t;let i=class extends e{constructor(...r){super(...r),this._updatingRequiredPromise=null,this.filter=null,this.layer=null,this.requiresCurrentUser=!1,this.requiredFields=[],this.view=null}initialize(){this.addHandles([R(()=>{const r=this.layer,s=this.view;return[r&&"elevationInfo"in r?r.elevationInfo?.featureExpressionInfo:null,r&&"displayField"in r?r.displayField:null,r&&"timeInfo"in r&&r.timeInfo,r&&"renderer"in r&&r.renderer,r&&"labelingInfo"in r&&r.labelingInfo,r&&"floorInfo"in r&&r.floorInfo,s?.requiredFieldsOptions?.featureTitleFields&&r&&"featureTitleFields"in r&&r.featureTitleFields,s?.requiredFieldsOptions?.utilityNetworkFields&&Ze(s,r),r.displayFilterInfo,this.displayFilterEnabled,this.filter,this.featureEffect,this.timeExtent,r?.type==="knowledge-graph-sublayer"&&r.parentCompositeLayer.type==="link-chart"&&r.parentCompositeLayer.linkChart?.linkChartProperties.nonspatialDataDisplay?.mode]},()=>this._handleChange(),M),E(()=>this.view?.floors,"change",()=>this._handleChange()),E(()=>this.layer.displayFilterInfo?.filters,"change",()=>this._handleChange()),E(()=>this.layer&&"sublayers"in this.layer?this.layer.sublayers:null,"change",()=>this._handleChange())])}get availableFields(){if(!this.layer)return[];const{layer:r,layer:{fieldsIndex:s},requiredFields:l}=this;return"outFields"in r&&r.outFields?T(s,[...X(s,r.outFields),...l]):T(s,l)}get displayFilterEnabled(){return(this.view?.displayFilterEnabled??!0)&&(!("displayFilterEnabled"in this.layer)||(this.layer?.displayFilterEnabled??!0))}get effectiveDisplayFilter(){const r=this.layer;return this.displayFilterEnabled&&r.displayFilterInfo?xe(r.displayFilterInfo,this.view):null}get effectiveDisplayFilterClause(){const r=this.effectiveDisplayFilter?.where??null;return r&&this.hasHighlight?K(r,Y(this.layer.objectIdField,this.highlightIds)):r}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(r){this._override("featureEffect",r)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(r){v.getLogger(this).error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}get signedInUser(){return this.layer?.url?Re(this.layer.url):Promise.resolve(null)}highlight(r,s){throw new Error("missing implementation")}createQuery(){const r={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},s=this.filter!=null?this.filter.createQuery(r):new L(r);return"floorInfo"in this.layer&&this.layer.floorInfo&&(s.where=O(s.where,Q(this))),this.displayFilterEnabled&&(s.where=O(s.where,this.effectiveDisplayFilter?.where)),this.timeExtent!=null&&(s.timeExtent=s.timeExtent!=null?s.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),s}createAggregateQuery(){const r={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return new L(r)}queryFeatures(r,s){throw new Error("missing implementation")}queryObjectIds(r,s){throw new Error("missing implementation")}queryFeatureCount(r,s){throw new Error("missing implementation")}queryExtent(r,s){throw new Error("missing implementation")}async fetchPopupFeaturesFromGraphics(r,s){const l=[],u=new Set;for(const d of r){const n=be(d.origin),h=Pe(n,{...s,checkPopupEnabled:!0});h&&(l.push(d),u.add(h))}if(l.length===0||u.size===0)return[];const p=await this._createPopupQuery(u,s);return await Ce(this.layer,l,p,{hasRequiredFields:(d,n)=>this._popupFeatureHasRequiredFields(d,n),...s})}_handleChange(){const r=Promise.all([this._updateRequiredFields(),this._updateClientWhereClauseRequirements()]).then(()=>{});return this._set("_updatingRequiredPromise",r),r.then(()=>{this._updatingRequiredPromise===r&&this._set("_updatingRequiredPromise",null)}),r}async _updateClientWhereClauseRequirements(){if(!this.layer||!this.view)return;const{layer:r}=this,s=new He(r.fieldsIndex);if(s.visitFilter(this.filter),"featureReduction"in r&&s.visitFeatureReduction(r.featureReduction),"labelingInfo"in r&&s.visitLabelingInfo(r.labelsVisible,r.labelingInfo),"trackInfo"in r&&s.visitTrackInfo(r.trackInfo),this.view.type==="2d"&&(s.visitFilter(this.featureEffect?.filter),s.visitDisplayFilter(this.displayFilterEnabled,r.displayFilterInfo),"featureReduction"in r&&s.visitFeatureReduction(r.featureReduction)),r.type==="subtype-group")for(const l of r.sublayers)s.visitLabelingInfo(l.labelsVisible,l.labelingInfo);try{const l=await s.finish();this._set("requiresCurrentUser",l.requiresCurrentUser)}catch(l){v.getLogger(this).error(l)}}async _updateRequiredFields(){if(!this.layer||!this.view)return;const r=this.view.type==="3d",{layer:s,layer:{fieldsIndex:l}}=this,u="renderer"in s&&s.renderer,p="orderBy"in s&&s.orderBy,d="featureReduction"in s?s.featureReduction:null,n=new Set,h=[u?u.collectRequiredFields(n,l):null,S(n,s),r&&"elevationInfo"in s?ee(n,s):null,this.filter!=null?D(n,s,this.filter):null,r||this.featureEffect==null?null:D(n,s,this.featureEffect.filter),!r&&d?te(n,s,d):null,!r&&p?re(n,s,p):null];if("timeInfo"in s&&s.timeInfo&&this.timeExtent&&m(n,s.fieldsIndex,[s.timeInfo.startField,s.timeInfo.endField]),"timeInfo"in s&&s.timeInfo&&"trackInfo"in s&&s.trackInfo){const{trackInfo:c}=s;m(n,s.fieldsIndex,[s.timeInfo.trackIdField]),s.type!=="feature"&&c.timeField!=="startTimeField"||m(n,s.fieldsIndex,[s.timeInfo.startField]),c.timeField==="endTimeField"&&m(n,s.fieldsIndex,[s.timeInfo.endField]),await ie(n,s)}if("floorInfo"in s&&s.floorInfo&&m(n,s.fieldsIndex,[s.floorInfo.floorField]),"featureTitleFields"in s&&this.view?.requiredFieldsOptions?.featureTitleFields&&s.featureTitleFields&&m(n,s.fieldsIndex,s.featureTitleFields),s.type==="feature"&&s.globalIdField&&this.view?.requiredFieldsOptions?.globalIdField&&m(n,s.fieldsIndex,[s.globalIdField]),this.displayFilterEnabled&&h.push(se(n,s,s.displayFilterInfo)),s.type==="feature"&&r&&s.infoFor3D!=null&&(s.globalIdField==null&&v.getLogger(this).error("globalIdField missing on 3DObjectFeatureLayer"),m(n,s.fieldsIndex,[s.globalIdField])),s.type==="subtype-group"){_(n,l,s.subtypeField);const c=s.sublayers.map(V=>Promise.all([V.renderer?.collectRequiredFields(n,l),S(n,V)]));h.push(Promise.all(c))}if(s.type==="catalog-footprint"&&s.parent){const c=s.parent;m(n,l,[c.itemNameField,c.itemSourceField,c.itemTypeField,c.maxScaleField,c.minScaleField])}s.type==="knowledge-graph-sublayer"&&s.parentCompositeLayer.type==="link-chart"&&_(n,l,_e);const F=await Promise.allSettled(h);if(r)_(n,l,s.objectIdField);else for(const c of we(Oe(s)))_(n,l,c);r&&"displayField"in s&&s.displayField&&_(n,l,s.displayField);for(const c of F)c.status==="rejected"&&v.getLogger(this).error(c.reason);const w=Array.from(n).sort();this._set("requiredFields",w)}_popupFeatureHasRequiredFields(r,s){return ae(r,s)}async _createPopupQuery(r,s){const l=this.layer.createQuery(),u=new Set;let p=this.layer.geometryType==="point";for(const d of r){if(!p){const h=await Ee(d);P(s),p=(h&&h.arcadeUtils.hasGeometryOperations(d))??!1}const n=await qe(this.layer,d);P(s);for(const h of n)u.add(h)}return l.returnGeometry=p,l.returnZ=p,l.returnM=p,l.outFields=Array.from(u),l.outSpatialReference=this.view.spatialReference,"floorInfo"in this.layer&&this.layer.floorInfo&&(l.where=O(l.where,Q(this))),l}canResume(){return!!super.canResume()&&(this.timeExtent==null||!this.timeExtent.isEmpty)}getTest(){}get test(){}};return a([o()],i.prototype,"_updatingRequiredPromise",void 0),a([o({readOnly:!0})],i.prototype,"availableFields",null),a([o({readOnly:!0})],i.prototype,"displayFilterEnabled",null),a([o({readOnly:!0})],i.prototype,"effectiveDisplayFilter",null),a([o({readOnly:!0})],i.prototype,"effectiveDisplayFilterClause",null),a([o({type:ve})],i.prototype,"featureEffect",null),a([o({type:Ie})],i.prototype,"filter",void 0),a([o()],i.prototype,"layer",void 0),a([o({type:Number})],i.prototype,"maximumNumberOfFeatures",null),a([o({readOnly:!0,type:Boolean})],i.prototype,"maximumNumberOfFeaturesExceeded",null),a([o()],i.prototype,"requiresCurrentUser",void 0),a([o({readOnly:!0})],i.prototype,"requiredFields",void 0),a([o({readOnly:!0})],i.prototype,"signedInUser",null),a([o()],i.prototype,"suspended",void 0),a([o()],i.prototype,"view",void 0),i=a([b("esri.views.layers.FeatureLayerView")],i),i};let f=class extends Ve(ue(Ge(pe(Me)))){constructor(t){super(t)}initialize(){this.addHandles(R(()=>this._updatingRequiredPromise,t=>this._updatingHandles.addPromise(t),M))}destroy(){this._updatingHandles.removeAll(),this._fetcherContext=C(this._fetcherContext)}get maximumNumberOfFeatures(){return this.graphicsPipeline.maximumNumberOfFeatures}set maximumNumberOfFeatures(t){this.graphicsPipeline.maximumNumberOfFeatures=t}get maximumNumberOfFeaturesExceeded(){return this.graphicsPipeline!=null&&!this.suspended&&this.graphicsPipeline.maximumNumberOfFeaturesExceeded}get updatingProgressValue(){return this.graphicsPipeline?.updatingProgressValue??0}get updatePolicy(){return this.graphicsPipeline?.updatePolicy??0}get snappingComplexityExceeded(){return this.graphicsPipeline?.snappingComplexityExceeded??!0}get hasZ(){const t=this.layer,e=t.capabilities&&t.capabilities.data;return!(!e||!e.supportsZ)&&("returnZ"in t&&t.returnZ!=null?t.returnZ:e.supportsZ)}get hasM(){const t=this.layer,e=t.capabilities&&t.capabilities.data;return!(!e||!e.supportsM)&&"returnM"in t&&t.returnM!=null&&t.returnM}get availableFieldsForQuery(){return le(this.layer.fieldsIndex,this.availableFields)}setVisibility(t,e){this.graphicsPipeline?.setVisibility(t,e)}createQuery(){return super.createQuery()}queryFeatures(t,e){const i=()=>super.queryFeatures(t,e);return this.layer.geometryType==="mesh"?this._queryFeaturesMesh(this._ensureQuery(t),i):i()}async createGraphicsPipeline(){if(U("feature-pipeline-3d-test")){const{Feature3DPipeline:t}=await Z(()=>import("./Feature3DPipeline-DmIlSTr4.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220]));return new t({layerView:this})}return new y({layerView:this})}async doRefresh(t){return await this.graphicsPipeline.doRefresh(t)}_popupFeatureHasRequiredFields(t,e){if(!super._popupFeatureHasRequiredFields(t,e))return!1;const i=W(t,this.layer.objectIdField);if(i==null)return!0;const r=this.graphicsPipeline.getMissingAttributesForFeature(i);if(r==null)return!0;for(const s of e)if(r.has(s))return!1;return!0}get usedMemory(){return this.graphicsPipeline?.usedMemory??0}get unloadedMemory(){return this.graphicsPipeline?.unloadedMemory??0}get ignoresMemoryFactor(){return this.graphicsPipeline?.ignoresMemoryFactor??!1}async _queryFeaturesMesh(t,e){this._validateQueryFeaturesMesh(t);const i=await e(),r=this.graphicsPipeline;if(t?.outStatistics||r==null)return i;const s=this.layer.objectIdField,l=[];for(const u of i.features)if(u.geometry){const p=r.getHydratedGeometry(u.attributes[s]);p&&(u.geometry=p,l.push(u))}else l.push(u);return i.features=l,i}_validateQueryFeaturesMesh(t){if(!t)return;const e=r=>{throw new z("feature-layer-view:unsupported-query",`Queries on Mesh feature collection layers do not support '${r}'`)},i=["quantizationParameters","geometryPrecision","maxAllowableOffset"];for(const r of i)t[r]!=null&&e(r);"returnM"in t&&t.returnM&&e("returnM"),"returnCentroid"in t&&t.returnCentroid&&e("returnCentroid"),t.outSpatialReference==null||t.outSpatialReference.equals(this.view.spatialReference)||e("outSpatialReference")}get test(){}};a([o()],f.prototype,"layer",void 0),a([o()],f.prototype,"graphicsPipeline",void 0),a([o()],f.prototype,"maximumNumberOfFeatures",null),a([o()],f.prototype,"maximumNumberOfFeaturesExceeded",null),a([o(he)],f.prototype,"updatingProgress",void 0),a([o({readOnly:!0})],f.prototype,"updatingProgressValue",null),a([o({readOnly:!0})],f.prototype,"updatePolicy",null),a([o()],f.prototype,"snappingComplexityExceeded",null),a([o({readOnly:!0})],f.prototype,"hasZ",null),a([o({readOnly:!0})],f.prototype,"hasM",null),a([o()],f.prototype,"availableFieldsForQuery",null),f=a([b("esri.views.3d.layers.FeatureLayerViewBase3D")],f);export{f,$e as t};
