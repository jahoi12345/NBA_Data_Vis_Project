import{I as M,v as B,a7 as C,y as I,Y as a,H as i,G as b}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import"./UnknownTimeZone-B697BDFv-CBbtul7O.js";import{K as $,w as N,a8 as O,A as j}from"./Dictionary-B4WY1XGX-DPfLsCo2.js";import{H as F}from"./Point-BfTTZoMu-DeJwQYfh.js";import{l as Z}from"./collectionUtils-jDyktm0P-BDP2Oq99.js";import{t as G}from"./commonProperties-DHiB1uzW-DHiB1uzW.js";import{o as H}from"./arcadeEnvironment-DqZGrNFy-B7LAcj80.js";import{u as T}from"./enum-BzLwmiID-CcyIdWlQ.js";import{N as R,J as Y,q as D}from"./utils-CylVuxNi--x86XOjU.js";import{f as k,Z as A}from"./lengthUtils-Dt1_RvOO-j3MEdmHu.js";import"./date-IqUzANpt-bLKO9IDT.js";import"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import"./TimeOnly-BERR31kg-CQiLyUZi.js";import"./Extent-CgDMOSRD-Bod5LY6s.js";import"./index-B0z_nLWi.js";import"./reader-DcGs6kKN-DHJfK-tm.js";import"./ImmutableArray-BPVd6ESQ-BGk4ZTNG.js";import"./shared-yd-CR64C-BEo7YVMh.js";import"./Field-Cm_ZejYW-CwJZmSru.js";import"./Color-CERqXxxY-BuYn26eI.js";import"./mathUtils-PIGhLnI9-B1tKUlUb.js";import"./fieldType-DVUzXtk_-tUuvnZJM.js";import"./number-D_FvV3D1-OQFavbmh.js";import"./Polyline-CoiTLswR-DTxpB2Yg.js";import"./Polygon-D6wEPb3W-D2MPjRU4.js";import"./aaBoundingRect-CjwcS2F3-ri8bmh30.js";import"./jsonUtils-CmpazY1u-6pDLj5sx.js";import"./SimpleObservable-CvFyr0NA-DXpoMYph.js";let d=class extends C{constructor(o){super(o),this.text=null,this.detectedLanguage="en",this.detectedLanguageScore=-1}};a([i({type:String,json:{write:!0}})],d.prototype,"key",void 0),a([i({type:String,json:{write:!0}})],d.prototype,"text",void 0),a([i({type:String,json:{read:{source:"detectedLanguage.language"},write:{target:"detectedLanguage.language"}}})],d.prototype,"detectedLanguage",void 0),a([i({type:Number,json:{read:{source:"detectedLanguage.score"},write:{target:"detectedLanguage.score"}}})],d.prototype,"detectedLanguageScore",void 0),a([i({type:Object,json:{write:!0}})],d.prototype,"translation",void 0),d=a([b("esri.rest.support.TranslateResult")],d);async function E(o,n,r){const t=n.toJSON();t.contents=JSON.stringify(t.contents),t.token=await R(n.portalUrl,n.apiKey,{signal:r?.signal,prompt:r?.authMode!=="no-prompt"});const s=Y(o),e=D(s.query,{...r,query:t,method:"post",authMode:"anonymous"});return(await F(s.path,e)).data.results.map(c=>d.fromJSON(c))}let S=class extends C{constructor(o){super(o)}};a([i({type:String,json:{write:!0}})],S.prototype,"key",void 0),a([i({type:String,json:{write:!0}})],S.prototype,"text",void 0),S=a([b("esri.rest.support.TranslateContent")],S);let p=class extends C{constructor(o){super(o),this.to=null,this.contents=null,this.portalUrl="https://www.arcgis.com",this.translator="esri",this.from=null,this.apiKey=null,this.requestSource=null}};a([i({type:[String],json:{write:!0}})],p.prototype,"to",void 0),a([i({type:[S],json:{write:!0}})],p.prototype,"contents",void 0),a([i({type:String,json:{write:!0}})],p.prototype,"portalUrl",void 0),a([i({type:String,json:{write:!0,default:"esri"}})],p.prototype,"translator",void 0),a([i({type:String,json:{write:!0}})],p.prototype,"from",void 0),a([i(G)],p.prototype,"apiKey",void 0),a([i({type:String,json:{name:"x-esri-request-source"}})],p.prototype,"requestSource",void 0),p=a([b("esri.rest.support.TranslateParameters")],p);class z{constructor(n,r){this.portal=n,this._debugLog=r}async translate(n){this.portal.loaded||await this.portal.load();const r=this.portal.helperServices?.aiUtilityServices;if(r==null)return{success:!1};const t=r.url+r.translateUtility;try{return n.requestSource??="arcade",{success:!0,results:(await E(t,n,{authMode:"no-prompt"})).map(s=>s.toJSON())}}catch(s){return this._debugLog!=null&&(s instanceof Error||s instanceof M)&&this._debugLog(`TranslateText error: ${s.message}`),B.getLogger("esri.arcade.functions.aiServices").error(s),{success:!1}}}}class Q{constructor(n,r,t){this._parameters=n,this._maxTotalContentSize=r,this._maxContentsLength=t,this._requests=[],this._normalizedContents=new Map,this._contentsTotalSize=0}tryAdd(n){const r=new Set(n.filter(e=>!this._normalizedContents.has(e.text)).map(e=>e.text));if(this._requests.length+r.size>this._maxContentsLength)return null;let t=0;for(const e of r)t+=e.length;if((t+this._contentsTotalSize)*(this._parameters.to.length??1)>this._maxTotalContentSize)return null;const s=this._requests.length;for(const{key:e,text:c}of n)I(this._normalizedContents,c,()=>[]).push({batchIdx:s,key:e});return this._requests.push(n),this._contentsTotalSize+=t,s}async send(n){const r=[],t=[];let s=0;for(const[y,f]of this._normalizedContents)r.push(new S({key:String(s++),text:y})),t.push(f);const e=new p(this._parameters);e.contents=r;const c=await n.translate(e);if(!c.success)return Array.from(this._requests,()=>c);const x=Array.from(this._requests,()=>({success:!0,results:[]}));for(const y of c.results){const f=Number(y.key);for(const h of t[f])x[h.batchIdx].results.push({...y,key:h.key})}return x}}function L(o){const n=[...new Set(o.to)].sort(),r=o.from??null,t=o.portalUrl,s=o.translator,e=o.apiKey??null;return JSON.stringify([n,r,t,s,e])}async function U(o,n,r){try{return(await o.yieldFor(r))[n]}catch{return{success:!1}}}class K{constructor(n,r,{maxTotalContentSize:t=5e4,maxContentsLength:s=1e3}={}){this._executor=n,this._service=r,this._openBatches=new Map,this._maxTotalContentSize=t,this._maxContentsLength=s}create(n){return{translate:async r=>{const t=L(r),{contents:s,to:e,from:c,translator:x,portalUrl:y,apiKey:f}=r;if(e==null)return{success:!1};if(s==null||s.every(u=>u.text.length===0))return{success:!1};const h=this._openBatches.get(t);if(h!=null){const u=h.data.tryAdd(s);if(u!=null)return await U(n,u,h);h.send()}const m=new Q({to:e,from:c,translator:x,portalUrl:y,apiKey:f},this._maxTotalContentSize,this._maxContentsLength),v=m.tryAdd(s);if(v!=null){const u=this._executor.openBatch(m,{open:w=>{this._openBatches.set(t,w)},execute:w=>w.send(this._service),close:w=>{this._openBatches.get(t)===w&&this._openBatches.delete(t)}});return await U(n,v,u)}return await this._service.translate(r)}}}}function P(o){o.mode==="async"&&(o.functions[H("TranslateText")]=function(n,r){return o.standardFunctionAsync(n,r,async(t,s,e)=>{if($(e,2,3,t,s),!k(e[0])&&!A(e[0])&&!N(e[0]))throw new T(t,"InvalidParameter",s);const c=O(e[0]);if(!k(e[1])&&!A(e[1])&&!N(e[1]))throw new T(t,"InvalidParameter",s);const x=O(e[1]);let y=null;if(e.length>=3){if(!k(e[2]))throw new T(t,"InvalidParameter",s);y=e[2]}const f=c.map((g,l)=>new S({key:String(l),text:g})),h=t.services?.portal??Z.getDefault(),m=new p({to:x,contents:f,from:y,portalUrl:h.restUrl.replace(/\/sharing\/rest$/,"")}),v=new Map;let u=null;if(t.lrucache!=null){const g=t.lrucache;u??=L(m),m.contents=m.contents?.filter(l=>{const _=g.getCachedTranslation(u,l.text);return _==null||(v.set(l.key,{..._,key:l.key,text:l.text}),!1)})}if(m.contents?.length){const g=t.services?.translation??new z(h,t.console),l=await g.translate(m);if(!l.success)return new j({__proto__:null,success:!1});for(const _ of l.results){const q=m.contents?.find(J=>J.key===_.key)?.text;if(q==null)throw new T(null,"NeverReach",null);v.set(_.key,_),t.lrucache!=null&&(u??=L(m),t.lrucache.setCachedTranslation(u,q,{detectedLanguage:_.detectedLanguage,translation:_.translation}))}}const w=Array.from(f,g=>{const l=d.fromJSON(v.get(g.key));if(l==null)throw new T(null,"NeverReach",null);return l.text=g.text,j.convertJsonToArcade(l.toJSON(),t.timeZone??"system",!0)});return new j({__proto__:null,success:!0,results:w})})})}const jt=Object.freeze(Object.defineProperty({__proto__:null,BatchTranslationServiceFactory:K,PortalTranslationService:z,getTranslateParametersKey:L,registerFunctions:P},Symbol.toStringTag,{value:"Module"})),kt=Object.freeze(Object.defineProperty({__proto__:null,BatchTranslationServiceFactory:K,PortalTranslationService:z,getTranslateParametersKey:L,registerFunctions:P},Symbol.toStringTag,{value:"Module"}));export{jt as T,kt as a};
