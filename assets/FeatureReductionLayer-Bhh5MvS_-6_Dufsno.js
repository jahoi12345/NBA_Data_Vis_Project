import{Y as n,H as o,G as h,bh as O,a2 as c,a7 as z,v as X,I as Z,l as B,aO as q,K as _}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{j as ee,i as te}from"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import{j as re,A as H}from"./getPopupProvider-CmskPttI-CzUWpGwk.js";import{e as ie}from"./GraphicOrigin-uE6TDXc9-DqbdmNAV.js";import{Y as se}from"./collectionUtils-jDyktm0P-BDP2Oq99.js";import{e as ne}from"./layerContainerType-CSXZNpHb-BIF7XAYP.js";import{s as C,e as x}from"./FeatureReductionSelection-Du7o8OIG-DmruV-ou.js";import{x as m}from"./screenUtils-BitdhK1O-L0FLPAMi.js";import{B as M}from"./Color-CERqXxxY-BuYn26eI.js";import{u as w}from"./reader-DcGs6kKN-DHJfK-tm.js";import{v as Y,L as J}from"./OperationalLayer-B6zbJ5nR-DyK_ztCk.js";import{t as P}from"./featureLayerUtils-FKjLNPl_-Cv8vWd4i.js";import{i as U}from"./labelingInfo-BYG2hiVF-B7-dv03v.js";import{r as F}from"./jsonUtils-BCGKNxno-DZ1Xr_O8.js";import{e as D}from"./typeUtils-DDFS4uuz-B7KgP61w.js";import $ from"./SimpleRenderer-CEmCWePp-BJ25mYcH.js";import{H as oe}from"./typeUtils-CXW_VpOn-BGgLp_TK.js";import{c as ae,f as E,o as le}from"./commonProperties-DbO613LF-CHjBvYhj.js";import{k as K}from"./MD5-MtSiOt06-jWr180Yc.js";import{u as ue}from"./SimpleMarkerSymbol-BGAFRS9_-CVQ5NLIA.js";class pe extends ie{constructor(s){super(),this.type="aggregate",this.featureReductionProvider=s}get id(){return this.featureReductionProvider.id}get[re](){const s=this.featureReductionProvider.featureReduction;return s&&"popupTemplate"in s?s:null}}let f=class extends se(z){constructor(r){super(r),this.expression=null,this.title=null,this.returnType=null}};n([o({type:String,json:{write:!0}})],f.prototype,"expression",void 0),n([o({type:String,json:{write:!0}})],f.prototype,"title",void 0),n([o({type:String,json:{write:!0}})],f.prototype,"returnType",void 0),f=n([h("esri.layers.support.ExpressionInfo")],f);var V;let d=class extends z{static{V=this}constructor(r){super(r),this.isAutoGenerated=!1,this.name=null,this.alias=null,this.onStatisticField=null,this.onStatisticExpression=null,this.statisticType=null}clone(){return new V({name:this.name,alias:this.alias,isAutoGenerated:this.isAutoGenerated,onStatisticExpression:c(this.onStatisticExpression),onStatisticField:this.onStatisticField,statisticType:this.statisticType})}};n([o({type:Boolean,json:{write:!0}})],d.prototype,"isAutoGenerated",void 0),n([o({type:String,json:{write:!0}})],d.prototype,"name",void 0),n([o({type:String,json:{write:!0}})],d.prototype,"alias",void 0),n([o({type:String,json:{write:!0}})],d.prototype,"onStatisticField",void 0),n([o({type:f,json:{write:!0}})],d.prototype,"onStatisticExpression",void 0),n([o({type:String,json:{write:!0}})],d.prototype,"statisticType",void 0),d=V=n([h("esri.layers.support.AggregateField")],d);var T;let p=T=class extends x{constructor(r){super(r),this.type="binning",this.binType="geohash",this.fixedBinLevel=null,this.labelingInfo=null,this.labelsVisible=!0,this.maxScale=0,this.popupEnabled=!0,this.popupTemplate=null,this.size=m("12px"),this.fields=[],this.renderer=null}writeFields(r,s,e){const i=r.filter(t=>t.statisticType!=="avg_angle").map(t=>t.toJSON());O(e,i,s)}readRenderer(r,s,e){const i=s.drawingInfo?.renderer;return i?F(i,s,e)??void 0:P(s,e)}clone(){return new T({fields:c(this.fields),fixedBinLevel:this.fixedBinLevel,labelingInfo:c(this.labelingInfo),labelsVisible:this.labelsVisible,maxScale:this.maxScale,popupEnabled:this.popupEnabled,popupTemplate:c(this.popupTemplate),renderer:c(this.renderer),binType:c(this.binType),size:this.size})}};n([M({binning:"binning"})],p.prototype,"type",void 0),n([M({geohash:"geohash",square:"square"}),o({type:["geohash","square"]})],p.prototype,"binType",void 0),n([o({type:Number,json:{write:!0}})],p.prototype,"fixedBinLevel",void 0),n([o({type:[U],json:{read:{source:"drawingInfo.labelingInfo"},write:{target:"drawingInfo.labelingInfo"}}})],p.prototype,"labelingInfo",void 0),n([o(Y)],p.prototype,"labelsVisible",void 0),n([o({type:Number,json:{default:0,name:"visibilityInfo.maxScale"}})],p.prototype,"maxScale",void 0),n([o(J)],p.prototype,"popupEnabled",void 0),n([o({type:H,json:{name:"popupInfo",write:!0}})],p.prototype,"popupTemplate",void 0),n([o({cast:r=>r==="auto"?r:q(m(r))})],p.prototype,"size",void 0),n([o({type:[d],json:{write:!0}})],p.prototype,"fields",void 0),n([_("fields")],p.prototype,"writeFields",null),n([o({types:D,json:{write:{target:"drawingInfo.renderer"}}})],p.prototype,"renderer",void 0),n([w("renderer",["drawingInfo.renderer"])],p.prototype,"readRenderer",null),p=T=n([h("esri.layers.support.FeatureReductionBinning")],p);var j;function k(r){return r.type==="simple"&&!r.visualVariables?.length}let l=j=class extends z{constructor(r){super(r),this.type="cluster",this.clusterRadius=m("80px"),this.clusterMinSize=m("12px"),this.clusterMaxSize=m("50px"),this.maxScale=0,this.popupEnabled=!0,this.popupTemplate=null,this.renderer=null,this.symbol=null,this.labelingInfo=null,this.labelsVisible=!0,this.fields=[]}readRenderer(r,s,e){const i=s.drawingInfo?.renderer;return i?.authoringInfo?.isAutoGenerated?null:i?k(i)?null:F(i,s,e)??void 0:P(s,e)}readSymbol(r,s,e){const i=s.drawingInfo?.renderer;return i?.authoringInfo?.isAutoGenerated?null:i&&k(i)?F(i,s,e)?.symbol:null}writeSymbol(r,s,e,i){const t=this.renderer?.authoringInfo?.isAutoGenerated;if(!this.renderer||t){const a=new $({symbol:r});s.drawingInfo={renderer:a.write({},i)}}}writeFields(r,s,e){const i=r.filter(t=>t.statisticType!=="avg_angle").map(t=>t.toJSON());O(e,i,s)}readFields(r,s,e){return r.filter(i=>!i.isAutoGenerated).map(i=>d.fromJSON(i))}clone(){return new j({clusterRadius:this.clusterRadius,clusterMinSize:this.clusterMinSize,clusterMaxSize:this.clusterMaxSize,labelingInfo:c(this.labelingInfo),labelsVisible:this.labelsVisible,fields:c(this.fields),maxScale:this.maxScale,renderer:c(this.renderer),symbol:c(this.symbol),popupEnabled:this.popupEnabled,popupTemplate:c(this.popupTemplate)})}};n([o({type:["cluster"],readOnly:!0,json:{write:!0}})],l.prototype,"type",void 0),n([o({cast:r=>r==="auto"?r:q(m(r)),json:{write:!0}})],l.prototype,"clusterRadius",void 0),n([o({type:Number,cast:m,json:{write:!0}})],l.prototype,"clusterMinSize",void 0),n([o({type:Number,cast:m,json:{write:!0}})],l.prototype,"clusterMaxSize",void 0),n([o({type:Number,json:{default:0,name:"visibilityInfo.maxScale"}})],l.prototype,"maxScale",void 0),n([o(J)],l.prototype,"popupEnabled",void 0),n([o({type:H,json:{read:{source:"popupInfo"},write:{target:"popupInfo"}}})],l.prototype,"popupTemplate",void 0),n([o({types:D,json:{write:{target:"drawingInfo.renderer"}}})],l.prototype,"renderer",void 0),n([w("renderer",["drawingInfo.renderer"])],l.prototype,"readRenderer",null),n([o({types:oe})],l.prototype,"symbol",void 0),n([w("symbol",["drawingInfo.renderer"])],l.prototype,"readSymbol",null),n([_("symbol")],l.prototype,"writeSymbol",null),n([o({type:[U],json:{read:{source:"drawingInfo.labelingInfo"},write:{target:"drawingInfo.labelingInfo"}}})],l.prototype,"labelingInfo",void 0),n([o(Y)],l.prototype,"labelsVisible",void 0),n([o({type:[d],json:{write:!0}})],l.prototype,"fields",void 0),n([_("fields")],l.prototype,"writeFields",null),n([w("fields")],l.prototype,"readFields",null),l=j=n([h("esri.layers.support.FeatureReductionCluster")],l);const L={key:"type",base:x,typeMap:{cluster:l,binning:p}},de={types:{key:"type",base:x,typeMap:{selection:C,cluster:l,binning:p}},json:{name:"layerDefinition.featureReduction",write:{allowNull:!0},origins:{"web-map":{types:L},"portal-item":{types:L},"web-scene":{types:{key:"type",base:x,typeMap:{selection:C}},name:"layerDefinition.featureReduction",write:{allowNull:!0,layerContainerTypes:ne}}}}},ce=()=>X.getLogger("esri.views.2d.layers.support.clusterUtils");B.add("esri-cluster-arcade-enabled",!0);const fe=B("esri-cluster-arcade-enabled"),me=new Set(["simple-line","simple-fill","picture-fill"]);function N(r,s){let e=s.clone();if(!ye(e))return e;if(s.symbols.some(i=>me.has(i.type))&&(e=new $({symbol:new ue})),e.authoringInfo||(e.authoringInfo=new le),e.authoringInfo.isAutoGenerated=!0,"visualVariables"in e){const i=(e.visualVariables||[]).filter(t=>t.valueExpression!=="$view.scale");i.forEach(t=>{t.type==="rotation"?t.field?t.field=y(r,t.field,"avg_angle","number"):t.valueExpression&&(t.field=v(r,t.valueExpression,"avg_angle","number"),t.valueExpression=null):t.normalizationField?(t.field=y(r,t.field,"avg_norm","number",t.normalizationField),t.normalizationField=null):t.field?t.field=y(r,t.field,"avg","number"):t.valueExpression&&(t.field=v(r,t.valueExpression,"avg","number"),t.valueExpression=null)}),e.visualVariables=i}switch(e.type){case"simple":break;case"pie-chart":for(const i of e.attributes)i.field?i.field=y(r,i.field,"sum","number"):i.valueExpression&&(i.field=v(r,i.valueExpression,"sum","number"),i.valueExpression=null);break;case"unique-value":e.field?e.field=y(r,e.field,"mode","string"):e.valueExpression&&(e.field=v(r,e.valueExpression,"mode","string"),e.valueExpression=null);break;case"class-breaks":e.normalizationField?(e.field=y(r,e.field,"avg_norm","number",e.normalizationField),e.normalizationField=null):e.field?e.field=y(r,e.field,"avg","number"):e.valueExpression&&(e.field=v(r,e.valueExpression,"avg","number"),e.valueExpression=null)}return e}const ye=r=>{const s=e=>ce().error(new Z("Unsupported-renderer",e,{renderer:r}));if(!r)return!1;switch(r.type){case"unique-value":if(r.field2||r.field3)return s("FeatureReductionCluster does not support multi-field UniqueValueRenderers"),!1;break;case"class-breaks":if(r.normalizationField){const e=r.normalizationType;if(e!=="field")return s(`FeatureReductionCluster does not support a normalizationType of ${e}`),!1}break;case"simple":case"pie-chart":break;default:return s(`FeatureReductionCluster does not support renderers of type ${r.type}`),!1}if(!fe){if("valueExpression"in r&&r.valueExpression)return s("FeatureReductionCluster does not currently support renderer.valueExpression. Support will be added in a future release"),!1;if(("visualVariables"in r&&r.visualVariables||[]).some(e=>!(!("valueExpression"in e)||!e.valueExpression)))return s("FeatureReductionCluster does not currently support visualVariables with a valueExpression. Support will be added in a future release"),!1}return!0};function be(r,s,e){switch(r){case"sum":return`cluster_sum_${s}`;case"avg":case"avg_angle":return`cluster_avg_${s}`;case"mode":return`cluster_type_${s}`;case"avg_norm":{const i=e,t="field",a=s.toLowerCase()+",norm:"+t+","+i.toLowerCase();return"cluster_avg_"+K(a)}}}function v(r,s,e,i){const t=K(s),a=e==="mode"?`cluster_type_${t}`:e==="sum"?`cluster_sum_${t}`:`cluster_avg_${t}`;return r.some(u=>u.name===a)||r.push(new d({name:a,isAutoGenerated:!0,onStatisticExpression:new f({expression:s,returnType:i}),statisticType:e})),a}function y(r,s,e,i,t){if(s==="cluster_count"||r.some(u=>u.name===s))return s;const a=be(e,s,t);return r.some(u=>u.name===a)||(e==="avg_norm"?r.push(new d({name:a,isAutoGenerated:!0,onStatisticExpression:new f({expression:`$feature.${s} / $feature.${t}`,returnType:i}),statisticType:"avg"})):r.push(new d({name:a,isAutoGenerated:!0,onStatisticField:s,statisticType:e}))),a}const ke=r=>{const s=r;let e=class extends s{constructor(...i){super(...i),this.aggregateGraphicOrigin=new pe(this),this.addHandles(ee(()=>this.renderer,()=>{if(this.featureReduction){const t=this._normalizeFeatureReduction(this.featureReduction);this._set("featureReduction",t)}},te))}set featureReduction(i){const t=this._normalizeFeatureReduction(i);this._set("featureReduction",t)}set renderer(i){}_withClusterVariable(i,t,a){const u=i.clone();return"visualVariables"in u&&(u.visualVariables||(u.visualVariables=[]),u.visualVariables.some(S=>S.type==="size")||u.visualVariables.push(new ae({field:"cluster_count",stops:[new E({value:1}),new E({useMinValue:!0,size:t}),new E({useMaxValue:!0,size:a})]}))),u}_normalizeFeatureReduction(i){if(i?.type!=="cluster")return i;const t=i.clone(),a=[new d({name:"cluster_count",alias:"cluster_count",isAutoGenerated:!0,statisticType:"count"})],u=(t.fields??[]).filter(b=>!b.isAutoGenerated),S=i.renderer&&!i.renderer.authoringInfo?.isAutoGenerated,{clusterMinSize:I,clusterMaxSize:R}=t;if(S){t.fields=[...a,...u];const b=this._withClusterVariable(t.renderer,I,R);return t.effectiveFeatureRenderer=b,t.effectiveClusterRenderer=b,t}if(i.symbol){if(t.fields=[...a,...u],t.renderer=null,!this.renderer)return t.effectiveFeatureRenderer=null,t.effectiveClusterRenderer=null,t;const b=N(a,this.renderer),g=this._withClusterVariable(b,I,R),Q="visualVariables"in g&&g.visualVariables?g.visualVariables:[],W=new $({symbol:i.symbol,visualVariables:Q});return t.fields=[...a,...u],t.effectiveFeatureRenderer=g,t.effectiveClusterRenderer=W,t}if(!this.renderer)return i;const G=N(a,this.renderer);t.fields=[...a,...u],t.renderer=G;const A=this._withClusterVariable(G,I,R);return t.effectiveFeatureRenderer=A,t.effectiveClusterRenderer=A,t}};return n([o({readOnly:!0,clonable:!1})],e.prototype,"aggregateGraphicOrigin",void 0),n([o(de)],e.prototype,"featureReduction",null),e=n([h("esri.layers.mixins.FeatureReductionLayer")],e),e};export{ke as L,de as a,d};
