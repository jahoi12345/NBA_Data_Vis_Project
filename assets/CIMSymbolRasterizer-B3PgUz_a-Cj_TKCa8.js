import{s as E,y as L}from"./jsonUtils-CmpazY1u-ateEpj4Q.js";import{s as $}from"./floatRGBA-D-Q4FzNN-BzjdY1tU.js";import{L as k}from"./imageUtils-142g71N8-CjUugWaS.js";import{B as F,G as A,c as H}from"./CIMSymbolHelper-CD2S7jie-Bc00obB6.js";import{OverrideHelper as O}from"./OverrideHelper-B9cjxPfl-B2tmmsY6.js";import{D as P,A as G}from"./rasterizingUtils-CnBgARH0-BdMfGptJ.js";import{o as D}from"./utils-DX2muIr3-DiPfFKSl.js";import"./Extent-CgDMOSRD-CU1qE5Kr.js";import"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import"./Point-BfTTZoMu-BAT2Wq6O.js";import"./index-CTl7hdrJ.js";import"./Polyline-CoiTLswR-BLagWJLS.js";import"./Polygon-D6wEPb3W-CpL9Efjx.js";import"./mathUtils-PIGhLnI9-B1tKUlUb.js";import"./lengthUtils-Dt1_RvOO-bleznLOi.js";import"./date-IqUzANpt-bLKO9IDT.js";import"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import"./intl-DRFqUect-ClAS7BRt.js";import"./UnknownTimeZone-B697BDFv-CBbtul7O.js";import"./TileKey-C44YQC4_-BW7BBbYp.js";import"./Font-BwmnW7d2-D-oIm_Md.js";import"./mat2d-DlTglBkI--S7WYOjk.js";import"./mat2df32-Dpt2CT5P-CY1Hu5g0.js";import"./vec2f32-CaVKkSa6-BjkBmyoj.js";import"./defaults-BDN9qxeN-CCVK4JpS.js";import"./SimpleFillSymbol-CDawtd9z-CWD2KI2D.js";import"./Color-CERqXxxY-BuYn26eI.js";import"./SimpleMarkerSymbol-BGAFRS9_-CVQ5NLIA.js";import"./lineMarkers-CDwLe3J6-CNUjJvs3.js";import"./TextSymbol-hRGhyDHs-C0NgASym.js";import"./vec42-B8VM4vXb-BnA9MysM.js";import"./vec4f64-DPb6J-GU-C7c2DqbZ.js";import"./labelUtils-BtizwBfq-Zegx4520.js";import"./ArcadeExpression-BlIRq-oN-DGzfhzBj.js";import"./TimeOnly-BERR31kg-PKcKegNB.js";import"./enum-BzLwmiID-CcyIdWlQ.js";import"./FieldsIndex-CimK-TqD-CrSnohIk.js";import"./timeZoneUtils-BSc7-7qA-BAv3h8mh.js";import"./Queue-CYlrXMwB-CYJTUII-.js";import"./SimpleObservable-CvFyr0NA-DXpoMYph.js";import"./ReactiveMap-B0by2bYu-DCsCfMj5.js";import"./signal-BX9ezF8a-cf1Pn6io.js";import"./BidiEngine-BvER9tXK-EFuB0NWZ.js";import"./screenUtils-BitdhK1O-L0FLPAMi.js";import"./labelPoint-4nqVL63d-Dz1LbGNv.js";import"./OptimizedFeature-CwRGZPwv-Ddclhn0A.js";import"./memoryEstimations-Bd726a_p-0cVCY2Jz.js";import"./aaBoundingRect-CjwcS2F3-D7aII9DY.js";import"./GeometryUtils-C354xUs0-CG8X9WjO.js";import"./definitions-Dvg4hMIw-CdK2DzFN.js";import"./colorUtils-CeIi7j7j-nwrKvQYb.js";import"./callExpressionWithFeature-CVhPXWjd-XltR0UsH.js";import"./quantizationUtils-Ceq-Uxsu-CDK8m1qL.js";import"./reader-DcGs6kKN-DHJfK-tm.js";import"./defaultsJSON-GKolV7NZ-GKolV7NZ.js";class q{constructor(){this._resourceMap=new Map,this._inFlightResourceMap=new Map}destroy(){this._inFlightResourceMap.clear(),this._resourceMap.clear()}getResource(e){return this._resourceMap.get(e)??null}async fetchResource(e,n){const a=this._resourceMap.get(e);if(a)return{width:a.width,height:a.height};let p=this._inFlightResourceMap.get(e);return p?p.then(r=>({width:r.width,height:r.height})):(p=k(e,n),this._inFlightResourceMap.set(e,p),p.then(r=>(this._inFlightResourceMap.delete(e),this._resourceMap.set(e,r),{width:r.width,height:r.height}),()=>({width:0,height:0})))}deleteResource(e){this._inFlightResourceMap.delete(e),this._resourceMap.delete(e)}loadFont(e){return $(e)}}const J=96/72;class Kt{constructor(e){this._spatialReference=e,this._imageDataCanvas=null,this._cimResourceManager=new q}get _canvas(){return this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas")),this._imageDataCanvas}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(e,n,a,p,r,m,c,g,_,C){if(!e)return null;const{data:u}=e;if(!u||u.type!=="CIMSymbolReference"||!u.symbol)return null;const{symbol:v}=u;m||(m=D(v));const l=await O.resolveSymbolOverrides(u,n,this._spatialReference,r,m,c,g),w=this._cimResourceManager,R=[];F.fetchResources(l,w,R),F.fetchFonts(l,w,R),R.length>0&&await Promise.all(R);const{width:i,height:h}=a;let d=z(m,i,h,p,C);const t=F.getEnvelope(l,d,w);if(!t)return null;t.x===1/0&&(t.x=i+2),t.y===1/0&&(t.y=-h/2),t.width===-1/0&&(t.width=i),t.height===-1/0&&(t.height=h);let y=1,I=0,x=0;switch(v.type){case"CIMPointSymbol":case"CIMTextSymbol":{let o=1;t.width>i&&(o=i/t.width);let s=1;t.height>h&&(s=h/t.height),p==="preview"&&(t.width<i&&(o=i/t.width),t.height<h&&(s=h/t.height)),y=Math.min(o,s),I=t.x+t.width/2,x=t.y+t.height/2}break;case"CIMLineSymbol":if(C){x=t.y+t.height/2,I=t.x+t.width/2;const o=t.width-i,s=t.height-h;d={paths:P(d.paths,{xmin:-1*t.width/2+o,xmax:t.width/2-o,ymin:-1*t.height/2+s,ymax:t.height/2-s,width:t.width-2*o,height:t.height-2*s})}}else{(_||t.height>h)&&(y=h/t.height),x=t.y+t.height/2;const o=t.x*y+i/2,s=(t.x+t.width)*y+i/2,b=E(d)?d.paths:L(d)?d.rings:null;if(b===null)throw new Error("Bad geometry, can't rasterise symbol!");b[0][0][0]-=o/y,b[0][2][0]-=(s-i)/y}break;case"CIMPolygonSymbol":if(C){x=t.y+t.height/2,I=t.x+t.width/2;const o=t.width-i,s=t.height-h;d={paths:P(d.rings,{xmin:-1*t.width/2+o,xmax:t.width/2-o,ymin:-1*t.height/2+s,ymax:t.height/2-s,width:t.width-2*o,height:t.height-2*s})}}else{I=t.x+t.width/2,x=t.y+t.height/2;const o=t.x*y+i/2,s=(t.x+t.width)*y+i/2,b=t.y*y+h/2,S=(t.y+t.height)*y+h/2,{rings:f}=d;o<0&&(f[0][0][0]-=o,f[0][3][0]-=o,f[0][4][0]-=o),b<0&&(f[0][0][1]+=b,f[0][1][1]+=b,f[0][4][1]+=b),s>i&&(f[0][1][0]-=s-i,f[0][2][0]-=s-i),S>h&&(f[0][2][1]+=S-h,f[0][3][1]+=S-h)}}const B={type:"cim",data:{type:"CIMSymbolReference",symbol:l}};return this.rasterize(B,i,h,I,x,y,m,1,d)}rasterize(e,n,a,p,r,m,c,g=0,_=null,C=window.devicePixelRatio||1){const{data:u}=e;if(!u||u.type!=="CIMSymbolReference"||!u.symbol)return null;const{symbol:v}=u,l=this._canvas,w=C*J;l.width=n*w,l.height=a*w,c||(c=D(v)),_||(_=z(c,n,a,"legend")),l.width+=2*g,l.height+=2*g;const R=l.getContext("2d",{willReadFrequently:!0}),i=A.createIdentity();return i.translate(-p,-r),i.scale(m*w,-m*w),i.translate(n*w/2+g,a*w/2+g),R.clearRect(0,0,l.width,l.height),new H(R,this._cimResourceManager,i,!0).drawSymbol(v,_),R.getImageData(0,0,l.width,l.height)}}function T(M,e,n,a){return e==="esriGeometryPolygon"?{rings:G(P(M.rings,{xmin:0,ymin:0,width:n,height:a}),-1*n/2,-1*a/2)}:e==="esriGeometryPolyline"?{paths:G(P(M.paths,{xmin:0,ymin:0,width:n,height:a}),-1*n/2,-1*a/2)}:null}function z(M,e,n,a,p){const r=-e/2+1,m=e/2-1,c=n/2-1,g=-n/2+1;if(p&&(M==="esriGeometryPolygon"||M==="esriGeometryPolyline")){const _=T(p,M,e,n);if(_)return _}switch(M){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[r,0],[0,0],[m,0]]]};default:return a==="legend"?{rings:[[[r,c],[m,0],[m,g],[r,g],[r,c]]]}:{rings:[[[r,c],[m,c],[m,g],[r,g],[r,c]]]}}}export{Kt as CIMSymbolRasterizer};
