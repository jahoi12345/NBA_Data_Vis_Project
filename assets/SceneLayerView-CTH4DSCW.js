const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/intersectsOperator-ByEh4yAG.js","assets/ProjectionTransformation-PJc9H7Gq.js","assets/Point2D-CMz7woHH.js","assets/Envelope2D-mFnl8dXR.js","assets/Transformation2D-CrydmBdC.js","assets/SimpleGeometryCursor-B92kdZ15.js","assets/jsonMap-Bs3hmeCU.js","assets/OperatorDefinitions-DP7_WWTp.js","assets/Extent-BhRcB6A3.js","assets/Point-C1MrKtFQ.js","assets/reader-DcGs6kKN.js","assets/index-DJqVgRZI.js","assets/Polyline-BX3kGhk1.js","assets/Polygon-Bn-bHOAm.js","assets/aaBoundingRect-CirBGiM6.js","assets/mathUtils-PIGhLnI9.js","assets/jsonConverter-CAo24zrm.js","assets/OperatorIntersects-Cd0VWkC0.js","assets/apiConverter-BNnz6UeA.js","assets/simplifyOperator-1_-uWDZR.js","assets/operatorSimplify-5A_MmN4K.js","assets/unionOperator-DFSgOk8j.js","assets/operatorUnion-CKW7ZNtE.js"])))=>i.map(i=>d[i]);
import{b as V}from"./asyncUtils-w6KfWU41.js";import{y as k,_ as p,m,a as L,ah as z,i as O,l as M,a1 as C,f as N,ba as R,n as D}from"./jsonMap-Bs3hmeCU.js";import{e as q}from"./uuid-Oe6SV2kF.js";import{r as H}from"./featureQueryAll-B8TlOFhd.js";import{b as $,f as G,Y as Q,R as J}from"./lengthUtils-S7Vd15KB.js";import{h as W,j as S}from"./reactiveUtils-SO2Ko3sy.js";import{h as Y}from"./UpdatingHandles-D2RI_3Hb.js";import{_ as A}from"./index-DJqVgRZI.js";import{a as B,n as K,b as X}from"./TemporalSceneLayerView-C6jPAdcl.js";import{W as Z,J as ee,G as te,L as re}from"./projectionUtils-DgeaYumr.js";import{d as ie}from"./LayerView-ZCxqIAY2.js";const ne={setAttribute(){},rollback(){},commit(){}};function xe(e,r){const t=r.attributes[e.objectIdField];if(t==null)return ne;const i=e.sessions.get(t);if(i)return i;const l=k(r.attributes),a=new Set,d=e.i3sOverrides.createInteractiveEditSession(t),c=new Map,f=(n,u)=>{const g=c.get(n);if(g==null){const y=u.indexOf(t);return c.set(n,y),y}return g};let s=0;const o={setAttribute(n,u){if(s!==0)return;const g=e.fieldsIndex.get(n);if(!g)return;const y=e.attributeStorageInfo.findIndex(b=>b.name===g.name);if(y<0)return;if(!(n in l))throw new Error(`Attribute "${n}" is not an attribute of the edited feature.`);d.setAttribute(y,u);const F=e.attributeStorageInfo[y];let _=!1;a.add(n),e.forEachNode((b,I)=>{const E=f(b,I);if(E===-1)return;const x=e.getAttributeData(b.index);if(x){const v=x[F.name];v&&(v[E]=u,e.setAttributeData(b.index,x,r),_=!0)}}),_&&e.clearMemCache()},rollback(){if(s===0){for(const n of a)this.setAttribute(n,l[n]);d.remove(),s=1,e.sessions.delete(t)}},commit(){s===0&&(d.remove(),s=2,e.sessions.delete(t))}};return e.sessions.set(t,o),o}function oe(e,r,t){const{gidToFeatureInfo:i,oidToFeatureInfo:l,fieldsIndex:a,objectIdField:d,globalIdField:c,featureOrIdentifierList:f}=t;if(!t.featuresResolved&&f!=null){for(const s of f){const o={feature:null,oid:-1,gid:null};if("attributes"in s){o.feature=s;const n=s.attributes;if(n!=null)for(const u in n){if(o.oid!==-1&&o.gid!=null)break;const g=a.normalizeFieldName(u);g===d&&(o.oid=n[u]??-1),g===c&&(o.gid=n[u])}}else o.oid=s.objectId??-1,o.gid=s.globalId;o.gid!=null&&i.set(o.gid,o),o.oid!==-1&&l.set(o.oid,o)}t.featuresResolved=!0}return(e!==-1?l.get(e):null)??(r!=null?i.get(r):null)}function j(e,r,t,i,l=null,a=!0){const d=[],c={gidToFeatureInfo:new Map,oidToFeatureInfo:new Map,featuresResolved:t==null,fieldsIndex:e.fieldsIndex,objectIdField:e.objectIdField,globalIdField:e.globalIdField,featureOrIdentifierList:t};for(const f of r){if(f.error!=null)continue;const s=f.objectId??-1,o=f.globalId,n=(s===-1||a?oe(s,o,c):null)??{feature:null,oid:s,gid:o},u={oid:s===-1?n.oid:s,gid:o??n.gid,feature:n.feature,result:f};d.push(u);const g=u.gid?q(u.gid):null;if(u.oid===-1&&g!=null&&l!=null&&(u.oid=l.get(g)??-1),u.oid===-1&&g!=null){let y=i.get(g);y==null&&(y={gid:u.gid,edits:[]},i.set(g,y)),y.edits.push(u)}}return d}async function ve(e,r){const t=new Map,i=j(e,r.addedFeatures,r.edits?.addFeatures,t),l=j(e,r.updatedFeatures,r.edits?.updateFeatures,t),a=j(e,r.deletedFeatures,r.edits?.deleteFeatures,t,r.globalIdToObjectId,!1);return t.size>0&&await se(e,t),{adds:i.filter(d=>d.oid!==-1),updates:l.filter(d=>d.oid!==-1),deletes:a.filter(d=>d.oid!==-1)}}async function se(e,r){const t=e.i3sOverrides.layer.associatedLayer;if(t?.globalIdField==null)return;const i=t.createQuery(),{objectIdField:l,globalIdField:a}=t;i.where=Array.from(r.values()).map(({gid:f})=>`${a}='${f}'`).join(" OR "),i.returnGeometry=!1,i.outFields=[l,a],i.cacheHint=!1;const d=await V(H(t,i));if(!d.ok)return;const c=d.value.features;for(const f of c){const s=f.attributes[a],o=f.attributes[l];if(s==null||o==null||o===-1)continue;const n=r.get(q(s));if(n!=null)for(const u of n.edits)u.oid=o}}function Oe(e,r){const t=new Map,i=l=>{for(const{oid:a,feature:d}of l){const c=d?.geometry;c?.type==="mesh"&&t.set(a,c)}};i(r.adds),i(r.updates);for(const l of r.deletes)t.set(l.oid,null);for(const[l,a]of t)e.i3sOverrides.updateGeometry(l,a)}function Ee(e,r){const t=ae(e,r),i=le(e,r);if(t.size===0&&i.size===0)return;const l=new Map;for(let u=0;u<e.attributeStorageInfo.length;u++)l.set(e.attributeStorageInfo[u].name,u);let a=!1;t.forEach((u,g)=>{const y=e.getAttributeData(g);let F=!1;u.forEach((_,b)=>{const I=y!=null?y[b]:null,E=l.get(b);for(const{featureIndex:x,value:v,featureId:U}of _)I&&(I[x]=v,F=!0,a=!0),e.i3sOverrides.updateAttributeValue(U,E,v)}),F&&e.setAttributeData(g,y,null)}),a&&e.clearMemCache();const{fieldsIndex:d,i3sOverrides:c,objectIdField:f,globalIdField:s}=e,o=c.layer.associatedLayer?.infoFor3D,n=new Set(o?[...Object.values(o.assetMapFieldRoles),...Object.values(o.transformFieldRoles)]:[]);for(const[u,g]of i){c.featureAdded(u);const{attributes:y}=g;for(const F in y){if(F!==f&&F!==s&&n.has(F))continue;const _=d.normalizeFieldName(F),b=_!=null?l.get(_):null;if(b==null)continue;const I=y[F];c.updateAttributeValue(u,b,I)}}}function le(e,r){const t=new Map,i=r.adds;if(!i||i.length===0||e.globalIdField==null)return t;for(const l of i){const a=l.oid,d=l.feature;d?.geometry?.type==="mesh"&&t.set(a,d)}return t}function ae(e,r){const t=r.updates;if(!t||t.length===0)return new P;const i=new P,l=new Map;for(let a=0;a<e.attributeStorageInfo.length;a++)l.set(e.attributeStorageInfo[a].name,a);return e.forEachNode((a,d)=>{for(const c of t){if(c.feature==null)continue;const f=c.feature,s=c.oid,o=d.indexOf(s);for(const n in f.attributes){const u=e.fieldsIndex.normalizeFieldName(n),g=de(i,a.index,u),y=f.attributes[n];g.push({featureIndex:o,featureId:s,value:y})}}}),i}function de(e,r,t){const i=ue(e,r),l=t!=null&&i.get(t);if(l)return l;const a=new Array;return i.set(t,a),a}function ue(e,r){const t=e.get(r);if(t)return t;const i=new ce;return e.set(r,i),i}const ce=Map,P=Map;function Ae(){return{requiredFields:{type:[String],readOnly:!0},availableFields:{type:[String],readOnly:!0,get:function(){const{layer:e,layer:{fieldsIndex:r},requiredFields:t}=this;return e.outFields?$(r,[...G(r,e.outFields),...t]):$(r,t)}}}}const T=e=>{const r=e;let t=class extends r{constructor(){super(...arguments),this._updatingHandles=new Y,this._numUpdating=0}get updating(){return this._numUpdating>0||this._updatingHandles.updating}destroy(){this._updatingHandles.destroy()}autoUpdateAsync(i,l){const a=z(async d=>{++this._numUpdating;try{const c=await d;this.destroyed||this._set(i,c)}catch{O.getLogger(this).warn(`Async update of "${String(i)}" failed. Async update functions should not throw exceptions.`)}--this._numUpdating});return this._updatingHandles.add(l,a,W)}};return p([m()],t.prototype,"_updatingHandles",void 0),p([m({readOnly:!0})],t.prototype,"updating",null),p([m()],t.prototype,"_numUpdating",void 0),t=p([L("esri.core.AsyncUpdate")],t),t};T(M);let w=class extends T(M){get layer(){return this.layerView.layer}get requiredFields(){const{layerView:{layer:{fieldsIndex:e},definitionExpressionFields:r},rendererFields:t,labelingFields:i,viewFilterFields:l}=this;return $(e,[...r??[],...t??[],...i??[],...l??[]])}constructor(e){super(e)}initialize(){this.addHandles([this.autoUpdateAsync("rendererFields",async()=>{const{fieldsIndex:e,renderer:r}=this.layer;return r?this._getFieldsAsync(t=>r.collectRequiredFields(t,e)):null}),this.autoUpdateAsync("labelingFields",async()=>{const{layer:e}=this;return e.labelsVisible?this._getFieldsAsync(r=>Q(r,e)):null}),this.autoUpdateAsync("viewFilterFields",()=>{const{layer:e,mergedFilter:r}=this.layerView;return this._getFieldsAsync(t=>J(t,e,r))})])}async _getFieldsAsync(e){const r=new Set;try{return await e(r),Array.from(r).sort()}catch(t){return O.getLogger(this).error(t),null}}};p([m()],w.prototype,"layerView",void 0),p([m()],w.prototype,"layer",null),p([m()],w.prototype,"requiredFields",null),p([m()],w.prototype,"rendererFields",void 0),p([m()],w.prototype,"labelingFields",void 0),p([m()],w.prototype,"viewFilterFields",void 0),w=p([L("esri.views.3d.layers.support.SceneLayerViewRequiredFields")],w);let h=class extends ie{constructor(){super(...arguments),this.layer=null,this.filter=null,this._geometryOperators=null,this._projectionEngineLoaded=!1,this._abortController=new AbortController}get availableFields(){return[]}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){throw new Error("Not implemented")}get maximumNumberOfFeaturesExceeded(){return!1}get layerFilter(){return B(this._layerFilter)}get _layerFilter(){const e=this.layer?.filter;if(e==null||e.geometries.length<1)return null;if(!this._geometryOperators||!this._projectionEngineLoaded&&this._filterNeedsProjectionEngine)return K;const[r,t,i]=this._geometryOperators,l=e.geometries.at(0).spatialReference,a=e.geometries.toArray().map(s=>{let o;try{o=t.execute(s)}catch{return O.getLogger(this).warnOncePerTick("Failed to simplify scene filter mask polygon. Polygon will be ignored."),null}if(!o)return null;if(o.spatialReference.equals(l))return o;try{return Z(o,l)}catch{return O.getLogger(this).warnOncePerTick("Failed to project scene filter mask polygon. Polygon will be ignored."),null}}).filter(C).sort((s,o)=>s.extent.xmin-o.extent.xmin),d=new Set,c=new Array,f=new Array;for(let s of a){const o=s.extent.xmin;if(c.length=0,d.forEach(n=>{if(o>=n.extent.xmax)return f.push(n),void d.delete(n);s.extent.ymin<=n.extent.ymax&&s.extent.ymax>=n.extent.ymin&&r.execute(s,n)&&c.push(n)}),c.length>0){let n;c.push(s);try{n=i.executeMany(c)}catch{O.getLogger(this).warnOncePerTick("Failed to unify filter mask polygons. Polygon will be ignored.");continue}c.pop(),n&&(c.forEach(u=>d.delete(u)),s=n)}d.add(s)}return d.forEach(s=>f.push(s)),f.length>0?{spatialRelationship:e.spatialRelationship,geometries:f}:null}get _filterNeedsProjectionEngine(){const e=this.layer.filter;if(e==null||e.geometries.length<=1)return!1;const r=e.geometries.at(0).spatialReference;return e.geometries.some(({spatialReference:t})=>!t.equals(r)&&!ee(t,r))}get layerFilterUpdating(){return X(this._layerFilter)}initialize(){const{signal:e}=this._abortController;S(()=>this.destroyed||!this._geometryOperators&&this.layer?.filter?.geometries?.length,e).then(async()=>{N(e),this._geometryOperators=await Promise.all([A(()=>import("./intersectsOperator-ByEh4yAG.js").then(r=>r.i),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18])),A(()=>import("./simplifyOperator-1_-uWDZR.js").then(r=>r.s),__vite__mapDeps([19,2,1,3,4,5,6,7,8,9,10,11,12,13,14,15,16,20,18])),A(()=>import("./unionOperator-DFSgOk8j.js").then(r=>r.u),__vite__mapDeps([21,2,1,3,4,5,6,7,8,9,10,11,12,13,14,15,16,22,18]))])}).catch(R),this._projectionEngineLoaded=te(),S(()=>this.destroyed||!this._projectionEngineLoaded&&this._filterNeedsProjectionEngine,e).then(async()=>{N(e),await re(),this._projectionEngineLoaded=!0}).catch(R)}destroy(){this._abortController=D(this._abortController)}highlight(e,r){throw new Error("Not implemented")}queryFeatures(e,r){throw new Error("Not implemented")}queryObjectIds(e,r){throw new Error("Not implemented")}queryFeatureCount(e,r){throw new Error("Not implemented")}createQuery(){throw new Error("Not implemented")}queryExtent(e,r){throw new Error("Not implemented")}};p([m()],h.prototype,"layer",void 0),p([m()],h.prototype,"availableFields",null),p([m()],h.prototype,"maximumNumberOfFeatures",null),p([m({readOnly:!0})],h.prototype,"maximumNumberOfFeaturesExceeded",null),p([m()],h.prototype,"filter",void 0),p([m({readOnly:!0})],h.prototype,"layerFilter",null),p([m({readOnly:!0})],h.prototype,"_layerFilter",null),p([m()],h.prototype,"_geometryOperators",void 0),p([m()],h.prototype,"_projectionEngineLoaded",void 0),p([m()],h.prototype,"_filterNeedsProjectionEngine",null),p([m()],h.prototype,"layerFilterUpdating",null),h=p([L("esri.views.layers.SceneLayerView")],h);export{w as a,h as b,Ae as c,Oe as d,Ee as f,xe as i,ve as u};
