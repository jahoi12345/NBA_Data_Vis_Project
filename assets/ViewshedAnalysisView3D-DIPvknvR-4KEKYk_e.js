import{v as Kt,x as ze,c as A,z as Xt,q as Me,M as Yt,i as Jt,l as Qt,aq as Zt,c6 as ei,e as ti,$ as Pt,a8 as ii,o as si,b as ye,Y as n,H as h,G as ie}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{I as ai,J as ri}from"./featureReferenceUtils-CSsVlhur-Bq31yTLX.js";import{f as We,az as oi,ax as Qe,aZ as ni,b2 as li,J as hi,by as ci}from"./ShadowCastClear.glsl-CeOT_rAo-BEYyVrmo.js";import{j as M,o as R,s as pe,l as le,i as Ft}from"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import{I as k,c as di,h as P,l as he,F as pi,B as Ge,O as K,k as N,v as Ze,V as G,L as X,a as ue,s as Ve,A as ve,w as ui}from"./vec32-CewSdTn3-VRto2OOh.js";import{t as v,R as vi,M as q,a as mi,X as Et,y as wi}from"./collectionUtils-jDyktm0P-BDP2Oq99.js";import{J as fi,G as gi,X as _i,F as Vi}from"./projectionUtils-BGH_5_I3-DGwchVO8.js";import{a as bi,J as Mi}from"./aaBoundingRect-CjwcS2F3-ri8bmh30.js";import{s as yi}from"./AnalysisView3D-zhHEgrUR-DZ8OICjY.js";import{I as Si,N as se,B as Se,a as Di,e as re,q as Oi,o as Ti,K as xi}from"./ShadedColorMaterial.glsl-Cdsx30m0-BzzDoTK3.js";import{y,s as qe,B as me}from"./mathUtils-PIGhLnI9-B1tKUlUb.js";import{n as S,s as et}from"./mat4f64-q_b6UJoq-Dh6sWB_w.js";import{b as $e}from"./Point-BfTTZoMu-DeJwQYfh.js";import{L as Ht,o as fe,U as Ri,A as j,h as Y,e as De,u as be,r as zt,M as Le,E as Ie,H as $t}from"./mat4-C96X-Nn0-BrMLOLCb.js";import{X as Lt,K as It,z as Ci,x as Ai}from"./plane-BNdSPG2o-DTV5z6SO.js";import{F as te}from"./Color-CERqXxxY-BuYn26eI.js";import{m as Pi,B as tt}from"./dragEventPipeline3D-DqqdeG4y-VV3Rp8Vu.js";import{z as Fi,aW as Ei,aY as Oe,aD as Hi,cN as zi,N as $i,B as Li,E as Ii,F as Ui,ar as Ni,al as ki,V as ji,a8 as Bi,ay as Wi,az as Gi,S as qi,aL as Ki,U as Xi,n as it,bl as Te,cO as st,bL as Yi,h as Ji,g as Qi,bY as Zi,bN as es,aZ as ts}from"./Texture-CFNZjV2R-CxGjQ8pI.js";import{t as is}from"./Viewshed-DfPsAopA-B3KuvnAd.js";import{H as ss}from"./asyncUtils-w6KfWU41-HenJ0UOu.js";import{M as at,r as as}from"./Cyclical-BLSxUpe7-Bj8R2Yk-.js";import{l as rs,M as os,q as rt,A as ns,H as Ue}from"./RealisticTree.glsl-WN9nrQUl-QZiY3aPA.js";import{b as ls,T as Ut,$ as Nt,m as hs}from"./MoveManipulation-BXYicJ8k-VQxEWIac.js";import{a as Ne}from"./BufferView-Cj2sQaht-avJ4OGB_.js";import{e as xe,P as cs,J as _e,r as ds}from"./InteractiveToolBase-DXh7kfgV-B5EAl8tr.js";import{d as ps,A as us}from"./sphere-DLQ6p7mp-DyEe1Vll.js";import{c as Ke}from"./sliceToolConfig-BnawSSVt-BPWko_GQ.js";import{V as kt}from"./ColorMaterial.glsl-rhi0cQVb-DVm6kWLC.js";import{S as vs}from"./EditGeometryOperations-DZvKpTU8-DnyvzBdp.js";import{i as ms}from"./settings-CtLiSuVx-BZX89kPd.js";import{Z as ws}from"./ExtendedLineVisualElement-B_Ze482f-1sZ0lLhF.js";import{H as fs}from"./LaserlinePath.glsl-DfE4imRj-NE31_VCm.js";import{K as gs}from"./intersectorUtilsConversions-pLQPEbcN-Ck-nyNYa.js";import{z as _s,f as Vs,B as ot,u as bs}from"./analysisViewUtils-Z_Z4rbWk-DeDBcjbG.js";import{r as Ms}from"./ToolIntersector-BVL3bGrn-BEYbVCK-.js";import{a as ys}from"./orientedBoundingBox-BLEx7wLU-ByGP9QG1.js";import{j as Ss}from"./PointVisualElement-pF4jjqm_-CfTxywah.js";import{r as Ds}from"./lineStippleUtils-CCavR4OV-DESXkwZW.js";import{o as Os,T as nt}from"./vec4f64-DPb6J-GU-C7c2DqbZ.js";import{P as lt,T as Ts}from"./enums-B4pqBiXb-BO-3hS_8.js";import{H as xs}from"./index-B0z_nLWi.js";import{A as Re,y as Rs,C as ht,n as ke}from"./Emissions.glsl-B8XKMjLy-DXfiRNVX.js";import"./Polygon-D6wEPb3W-D2MPjRU4.js";import"./vec2f64-rIxtbMRN-Kai9mK1i.js";import"./vec42-B8VM4vXb-B6OGOEI9.js";import"./Extent-CgDMOSRD-Bod5LY6s.js";import"./Polyline-CoiTLswR-DTxpB2Yg.js";import"./typeUtils-DqrRcjBx-DZ6_Gsbu.js";import"./modeUtils-BA-mAwuS-DSb1K26b.js";import"./intl-DRFqUect-DPhFaHB2.js";import"./date-IqUzANpt-bLKO9IDT.js";import"./sanitizerUtils-BT_8V5US-CWQWUwZQ.js";import"./lengthUtils-Dt1_RvOO-j3MEdmHu.js";import"./workers-BEkgoq8Q-BM_Hz460.js";import"./PooledRBush-Dco5QkUp-DX3CMhf3.js";import"./GraphicsCollection-Bk6M0b7D-Dk6KdmO7.js";import"./Graphic-DgGzDmqW-d1CNicxz.js";import"./getPopupProvider-CmskPttI-CzUWpGwk.js";import"./Layer-DZvC7bne-D3VLDrab.js";import"./typeUtils-CXW_VpOn-BGgLp_TK.js";import"./lineMarkers-CDwLe3J6-CNUjJvs3.js";import"./PolygonSymbol3D-BXRHZiCQ-BjPAY2LA.js";import"./ExtrudeSymbol3DLayer-DSc1ou2x-CsVYZCeG.js";import"./aaBoundingBox-Cn49X7ge-BcYPaJ58.js";import"./Font-BwmnW7d2-Dwh3xjKw.js";import"./SimpleFillSymbol-CDawtd9z-CWD2KI2D.js";import"./SimpleMarkerSymbol-BGAFRS9_-CVQ5NLIA.js";import"./PictureMarkerSymbol-CaSh-vZk-xhjZ61bb.js";import"./TextSymbol-hRGhyDHs-CoS7dSjf.js";import"./HeightModelInfo-D5IdRvJ2-23y6MRiu.js";import"./spatialReferenceEllipsoidUtils-D2JabnKt-Ce3ED0lc.js";import"./TilemapCache-CjhKW_vj-8gKqgQfa.js";import"./LRUCache-fy84PBMi-Y56WPIvD.js";import"./UpdatingHandles-D2RI_3Hb-dwLPjVun.js";import"./Map-AEYszeHg-ZEOzAMWa.js";import"./Basemap-CL_uaRmk-O3l-dbYk.js";import"./PortalItem-DnxMlRVo-CI4Ns2_M.js";import"./writeUtils-DEFpwIW1-AHZYPaSV.js";import"./CollectionFlattener-D6h2Fkvj-WVl2BXw-.js";import"./resourceExtension-DOTCeiZj-C2WIbjQM.js";import"./PolygonCollection-HNNpnBH7-5UHgGprq.js";import"./mat4f32-Djp3mnm5-DzYG3LYB.js";import"./Query-BlS0WPDF-jdXS_Qhy.js";import"./Field-Cm_ZejYW-CwJZmSru.js";import"./fieldType-DVUzXtk_-tUuvnZJM.js";import"./normalizeUtils-85zLqeMi-C1bdAKNn.js";import"./normalizeUtilsCommon-CnhQye_A-UWhaH-kt.js";import"./ElevationQuery-DzlYa4L4-DkUTW9Ak.js";import"./TileInfo-Bz7QlefV-CdK7c8ef.js";import"./vec3f32-WCVSSNPR-9V6Uhrx-.js";import"./Scheduler-CNrsbccs-Bcg8fWoS.js";import"./Indices-D0_UQPPr-t1Qev6md.js";import"./InterleavedLayout-B7roQAzV-CdGz7mlm.js";import"./constants-D67WmGms-H7IOwEdB.js";import"./quat-B7J5v7rV-CZ9akUv-.js";import"./quatf64-CCm9z-pX-CQ7_sSji.js";import"./vector-B8ZDYGQ6-DRILJdcx.js";import"./projectVectorToVector-Csv3NYZI-DpBtmQMN.js";import"./frustum-CMzahy3--B-DC1Co-.js";import"./floatRGBA-D-Q4FzNN-DQhowfyr.js";import"./UnknownTimeZone-B697BDFv-CBbtul7O.js";import"./TileKey-C44YQC4_-BW7BBbYp.js";import"./unitConversionUtils-4vB4Ezlp-DnY5MDxd.js";import"./vec2f32-CaVKkSa6-BjkBmyoj.js";import"./Octree-DckBBpQ7-CkRPu4UJ.js";import"./axisAngleDegrees-CjbXmycq-DcVVDR1-.js";import"./edgePreprocessing-D_eX-fWy-DqE-06Ss.js";import"./vec3-B_phcnZY-DHC7I6xa.js";import"./vec33-CWJeyzxV-Me4sF5XB.js";import"./MeshLocalVertexSpace-BGd1IdEs-C0HJG4wR.js";import"./EngineVisualElement-DP9Jiq6V-Dztd1hg5.js";import"./jsonUtils-CmpazY1u-6pDLj5sx.js";import"./SimpleObservable-CvFyr0NA-DXpoMYph.js";import"./screenUtils-BitdhK1O-L0FLPAMi.js";import"./projectPointToVector-DL7Z4uvb-CPbOlZdQ.js";import"./scaleUtils-yfx9kKWT-D9SVsyM-.js";import"./layerUtils-DZGhvm-W-CfyHx1TZ.js";import"./tagSymbols-BPcGfZon-BPcGfZon.js";import"./Queue-CYlrXMwB-CYJTUII-.js";import"./signal-BX9ezF8a-cf1Pn6io.js";import"./timeZoneUtils-BSc7-7qA-BAv3h8mh.js";import"./ReactiveMap-B0by2bYu-DCsCfMj5.js";import"./TablesMixin-Q80MT3nU-CBB9B-b6.js";import"./memoryEstimations-Bd726a_p-0cVCY2Jz.js";import"./VertexElementDescriptor-BlxU8vCE-BwuKQkTU.js";import"./reader-DcGs6kKN-DHJfK-tm.js";import"./computeTranslationToOriginAndRotation-Bjd4esRf-vJ4LbdOU.js";import"./layerViewUtils-BTa15X3o-BjQlX2q8.js";import"./dehydratedFeatures-Ql-uVzLq-aoK2987s.js";import"./quantizationUtils-Ceq-Uxsu-DjgKK_0s.js";import"./featureConversionUtils-BDA_FXJx-CDxX1Wik.js";import"./OptimizedFeature-CwRGZPwv-Ddclhn0A.js";import"./OptimizedFeatureSet-BR8EEvDc-CgsRgxJh.js";import"./createFeatureId-CVwTD0fV-3fKpJDrk.js";import"./elevationInfoUtils-B8MpdRMP-CDlK86wO.js";import"./HUDIntersectorResult-1xTExS7z-dL9SFL6u.js";import"./DefaultLoadingContext-DXgBe4GE-Unnb_XgV.js";import"./wosrLoader-CIPfz1Cl-DlmQQkMX.js";import"./Version-BtYZEj58-LyRHDnSJ.js";import"./DoubleArray-DExKNiTh-CvVpHySW.js";import"./config-Dg972SSE-D9DBKeq5.js";import"./GeometryUtils-C354xUs0-BLAznQrw.js";import"./definitions-Dvg4hMIw-CdK2DzFN.js";import"./WorkerHandle-B930SiRy-DglEKt53.js";import"./colorUtils-CeIi7j7j-C2WVx6th.js";import"./capabilities-Bi6C4OG6-CpURufko.js";import"./imageUtils-142g71N8-Wj0XNClb.js";import"./videoUtils-Dwx3AEgj-CduhpDRk.js";import"./uuid-Oe6SV2kF-IYX19xBA.js";import"./quickselect-QQC62dOK-Br2Ahhru.js";import"./meshVertexSpaceUtils-CtG7DPVT-kybwngCt.js";import"./Intersector-DS9YtyQY-DMoYp6i0.js";import"./TileKey-CXWFOqOI-Lra6v-mg.js";import"./loadAll-BCyxerwc-B4Lp8wGC.js";import"./opacityUtils-DuFH0EC9-DWspTgn2.js";import"./persistable-CdoDQOTR-BklJqWTn.js";import"./MD5-MtSiOt06-jWr180Yc.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw-DH8sdIsE.js";import"./utils-CylVuxNi--x86XOjU.js";import"./utils-Dpg4yj1D-CeFz2JVC.js";import"./types-BKo2foNY-DE0QfIFp.js";import"./labelUtils-BtizwBfq-Zegx4520.js";import"./ArcadeExpression-BlIRq-oN-VZkrwLVE.js";import"./TimeOnly-BERR31kg-CQiLyUZi.js";import"./enum-BzLwmiID-CcyIdWlQ.js";import"./FieldsIndex-CimK-TqD--24JoCkp.js";import"./VisualElement-By4iq8p4-ZBataKFH.js";import"./line-DShd3yGd-HKPw0I1T.js";import"./TriangleMaterial-BIKWylXl-CXByzRQi.js";import"./geometry2dUtils-B4vDf2wH-DzgYge1I.js";import"./rotate-CKztRS_J-BAJoscjo.js";import"./curveOperationUtils-BGqPT1bh-DTx58Z-T.js";const ct=2,Cs=4,jt=y(2),As=1.5;let Ps=class{constructor(){this.collisionRadius=5,this.fovUnfocusedArcWidth=Cs,this.fovFocusedArcWidth=ct*this.fovUnfocusedArcWidth,this.scaleOrientSize=90,this.scaleOrientHandleRadius=.025,this.scaleOrientMinDistance=1,this.scaleOrientArrowTipLength=.3,this.scaleOrientArrowTipFocusMultiplier=ct/1.5,this.observerSize=5,this.hoverTimeoutMilliseconds=1e3,this.viewAngleThreshold=10}getFovArcWidth(e){return e?this.fovFocusedArcWidth:this.fovUnfocusedArcWidth}getScaleOrientArrowTipLength(e){return this.scaleOrientArrowTipLength*(e?this.scaleOrientArrowTipFocusMultiplier:1)}};const H=new Ps;class Fs{constructor(){this.frameWidthNotSelected=.3,this.frameWidthSelected=1,this.frameColor=new te([255,255,255,.99]),this.observerPointConfiguration={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0,color:te.toUnitRGBA(new te([3,252,111,1]))},this.shapeMaterialParameters={color:[.33,.33,.33,.25],renderOccluded:1,cullFace:2,writeDepth:!1}}}const Q=new Fs;function Xe({tiltedUpVector:e,rightVector:t,observerRenderSpace:i},s){const a=Ti(e,t,i,s);return a[12]=0,a[13]=0,a[14]=0,a}function je(e,t,i,s){const a=v(),r=Ai(i.plane),o=Es(t,r);let l;if(Math.abs(o)>H.viewAngleThreshold)l=e.next(tt(t,i.plane));else{const c=Lt(s.targetRenderSpace,i.basis1,It()),d=he(Bt,i.basis1),p=he(Hs,i.basis2);l=e.next(tt(t,c)).next(u=>{const m=T=>{const D=ve(P(dt,T,i.origin),p),F=Math.acos(qe(D/s.farDistanceRenderSpace,-1,1)),z=Math.sin(F)*s.farDistanceRenderSpace;return K(v(),i.origin,K(v(),N(dt,d,z),N(zs,p,D)))},w=m(u.renderStart),b=m(u.renderEnd);return{...u,renderStart:w,renderEnd:b}})}return l.next(c=>{c.action==="start"&&k(a,c.renderStart);const d=me(xi(a,c.renderEnd,i.origin,r));return{...c,deltaAngle:d}})}function Es(e,t){const i=Bt;e.renderCoordsHelper.toRenderCoords(e.camera.position,i);const s=ci(e,i,e.camera.heading,e.camera.tilt,ts()).direction;return me(Ve(s,t))-90}function ee(e,t,i,s){return Y(pt,i,s),G(e,t,pt)}const Bt=v(),Hs=v(),dt=v(),zs=v(),pt=S();var Be;let f=Be=class extends Me{constructor(e){super(e),this.observerRenderSpaceOverride=null,this.needUpdateByFeature=!1}get observer(){return this.viewshed.observer??new $e}get effectiveObserverRenderSpace(){return this.observerRenderSpaceOverride??this.observerRenderSpace}get effectiveObserver(){return this.renderSpaceToPoint(this.effectiveObserverRenderSpace,this.observer.spatialReference)}get effectiveTargetRenderSpace(){return this._computeTargetRenderSpace(this.effectiveObserverRenderSpace)}get farDistance(){return this.viewshed.farDistance}get farDistanceRenderSpace(){return this.farDistance/this.metersPerUnit}get heading(){return this.viewshed.heading}get tilt(){return this.viewshed.tilt}get feature(){return this.viewshed.feature}get tiltParallelToSurface(){return this.tilt-90}get horizontalFieldOfView(){return this.viewshed.horizontalFieldOfView}get verticalFieldOfView(){return this.viewshed.verticalFieldOfView}get observerRenderSpace(){return this._pointToRenderSpace(this.observer,v())}get target(){const e=this.targetRenderSpace;return this.renderSpaceToPoint(e,this.observer.spatialReference)}get targetRenderSpace(){return this._computeTargetRenderSpace(this.observerRenderSpace)}get targetDirection(){const e=P(v(),this.targetRenderSpace,this.observerRenderSpace);return he(e,e)}get tiltedUpVector(){const e=ee(v(),this.upVector,-y(this.tiltParallelToSurface),this.leftVector);return he(e,e)}get _basis(){return this.renderCoordsHelper.basisMatrixAtPosition(this.observerRenderSpace,S())}get upVector(){const e=this._basis;return q(e[8],e[9],e[10])}get northVector(){const e=this._basis;return q(e[4],e[5],e[6])}get leftVector(){const e=this.upVector,t=ee(v(),this.northVector,-y(this.heading),e);return pi(t,e,t)}get rightVector(){return Ge(v(),this.leftVector)}clone(){return new Be({renderCoordsHelper:this.renderCoordsHelper,viewshed:this.viewshed.clone()})}get valid(){return this.viewshed.valid}get metersPerUnit(){return this.renderCoordsHelper.spatialReference.metersPerUnit}pointOnSphere(e,t,i){const{observerRenderSpace:s,targetRenderSpace:a}=this,r=P(Ce,a,s);return ee(r,r,-y(t),this.leftVector),ee(r,r,-y(e),this.tiltedUpVector),K(i,r,s)}cornerPoints(e){const t=this.horizontalFieldOfView/2,i=this.verticalFieldOfView/2;this.pointOnSphere(-t,i,e.topLeft),this.pointOnSphere(t,i,e.topRight),this.pointOnSphere(-t,-i,e.bottomLeft),this.pointOnSphere(t,-i,e.bottomRight)}arcCentersPoints(e){const t=this.horizontalFieldOfView/2,i=this.verticalFieldOfView/2;this.pointOnSphere(0,i,e.top),this.pointOnSphere(0,-i,e.bottom),this.pointOnSphere(-t,0,e.left),this.pointOnSphere(t,0,e.right)}parallelCenterPoints(e){const t=this.observerRenderSpace,i=this.farDistanceRenderSpace*Math.sin(y(this.verticalFieldOfView/2)),s=N(Ce,this.tiltedUpVector,i);K(e.top,t,s),P(e.bottom,t,s)}renderSpaceToPoint(e,t){const i=Ce;return this.renderCoordsHelper.fromRenderCoords(e,i,t),new $e(i[0],i[1],i[2],t)}_pointToRenderSpace(e,t){const i=mi(e.toArray());return this.renderCoordsHelper.toRenderCoords(i,e.spatialReference,t),t}_computeTargetRenderSpace(e){const{leftVector:t,northVector:i,upVector:s}=this,a=this.farDistanceRenderSpace,r=v();return N(r,i,a),ee(r,r,-y(this.heading),s),ee(r,r,-y(this.tiltParallelToSurface),t),K(r,e,r),r}};n([h()],f.prototype,"renderCoordsHelper",void 0),n([h()],f.prototype,"viewshed",void 0),n([h()],f.prototype,"observerRenderSpaceOverride",void 0),n([h()],f.prototype,"needUpdateByFeature",void 0),n([h()],f.prototype,"observer",null),n([h()],f.prototype,"effectiveObserverRenderSpace",null),n([h()],f.prototype,"effectiveObserver",null),n([h()],f.prototype,"effectiveTargetRenderSpace",null),n([h()],f.prototype,"farDistance",null),n([h()],f.prototype,"farDistanceRenderSpace",null),n([h()],f.prototype,"heading",null),n([h()],f.prototype,"tilt",null),n([h()],f.prototype,"feature",null),n([h()],f.prototype,"tiltParallelToSurface",null),n([h()],f.prototype,"horizontalFieldOfView",null),n([h()],f.prototype,"verticalFieldOfView",null),n([h()],f.prototype,"observerRenderSpace",null),n([h()],f.prototype,"target",null),n([h()],f.prototype,"targetRenderSpace",null),n([h()],f.prototype,"targetDirection",null),n([h()],f.prototype,"tiltedUpVector",null),n([h()],f.prototype,"_basis",null),n([h()],f.prototype,"upVector",null),n([h()],f.prototype,"northVector",null),n([h()],f.prototype,"leftVector",null),n([h()],f.prototype,"rightVector",null),n([h()],f.prototype,"valid",null),n([h()],f.prototype,"metersPerUnit",null),f=Be=n([ie("esri.views.3d.analysis.Viewshed.ViewshedComputedData")],f);const Ce=v();let $s=class extends Nt{constructor(e){super(),this._handles=new ye,this._tool=e.tool,this._view=e.view,this._focusedArcMaterial=this._createArcMaterial(!0),this._unfocusedArcMaterial=this._createArcMaterial(!1),this._createManipulators(),this.forEachManipulator(t=>this._tool.manipulators.add(t))}destroy(){this._handles=A(this._handles),this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._tool=null,this._view=null,this._manipulators=null}createDragPipeline(e,t){const i=Object.values(this._manipulators);return Pt(i.map(({manipulator:s,side:a})=>_e(s,(r,o,l,c,d)=>{const p=js(a,t),u=o.next(w=>({...w,manipulatorType:2,side:a})),m=je(u,this._view,p,t);e(r,m,l)})))}updateManipulatorsTransform(e){e.arcCentersPoints(ut),this._forEachManipulatorInfo(t=>this._updateArcManipulatorTransform(t,e,ut[t.side]))}updateManipulatorVisuals(e){this._forEachManipulatorInfo(t=>this._updateArcManipulatorVisuals(t,e))}_updateArcManipulatorVisuals({manipulator:e,side:t},i){const s=[];if(i!=null){const[a,r]=Ls(t,i,this._unfocusedArcMaterial);s.push(new re(a,1),new re(a.instantiate({material:this._focusedArcMaterial}),2)),e.collisionType={type:"line",paths:[r]}}e.renderObjects=s,e.radius=H.collisionRadius}_updateArcManipulatorTransform({manipulator:e,side:t},i,s){const a=i.horizontalFieldOfView,r=y(i.verticalFieldOfView/2),o=y(a/2),l=we(t);e.renderLocation=s;const c=S(),d=b=>{Ie(c,b,c)};d(be(oe,y(-90))),l||d(zt(oe,r));const p=i.farDistanceRenderSpace;let u,m;d(De(oe,X(Wt,p,p,p))),d(Le(oe,Ns(t))),d(Xe(i,oe)),l?(u=o,m=i.tiltedUpVector):(m=i.rightVector,u=r),u*=t==="right"||t==="bottom"?-1:1;const w=Y(oe,u,m);w!=null&&d(w),e.modelTransform=c}_createManipulators(){const e=this._createArcManipulator("left"),t=this._createArcManipulator("right"),i=this._createArcManipulator("top"),s=this._createArcManipulator("bottom");this._manipulators={left:e,right:t,top:i,bottom:s},[[s.manipulator,i.manipulator],[e.manipulator,t.manipulator]].forEach(([a,r])=>{a.metadata={pairedManipulator:r},r.metadata={pairedManipulator:a}})}_createArcManipulator(e){const t=new Se({view:this._view,autoScaleRenderObjects:!1,worldSized:!0}),i={manipulator:t,side:e};return this._updateArcManipulatorVisuals(i),this._handles.add(t.events.on(["focus-changed","grab-changed"],s=>{const a=t.metadata?.pairedManipulator;a!=null&&(a.hovering!==t.hovering&&(a.hovering=t.hovering),a.grabbing!==t.grabbing&&(a.grabbing=t.grabbing))})),i}_createArcMaterial(e){const t=H.getFovArcWidth(e),i=new hi({renderOccluded:4,isDecoration:!0,width:t},this._view.state.isGlobal);return this._handles.add(M(()=>te.toUnitRGBA(this._view.effectiveTheme.accentColor),s=>i.setParameters({color:s}),R)),i}forEachManipulator(e){Object.values(this._manipulators).forEach(({manipulator:t})=>e(t,2))}_forEachManipulatorInfo(e){Object.values(this._manipulators).forEach(t=>e(t))}get test(){return{manipulators:this._manipulators}}};function Ls(e,t,i){const{horizontalFieldOfView:s,verticalFieldOfView:a}=t,r=we(e),o=y(qe((r?a:s)/2,0,15)),l=Is(-o/2,o/2,r?1:Math.max(Math.sin(y(90-a/2)),.1));return[os(i,l),l]}function Is(e,t,i,s=10){Ne(s>1,"createArcPolylineGeometry() needs at least 2 for numVertices");const a=t-e;if(a<=0||i<=0)return[q(0,0,.01),q(0,0,-.01)];const r=[],o=a/s;for(let l=0;l<s;l++){let c=e+l*o;l===s-1&&(c=t);const d=Math.cos(c)*i,p=Math.sin(c)*i,u=q(d-i,0,p);r.push(u)}return r}function Us(e){switch(e){case"left":return 0;case"bottom":return 1;case"right":return 2;case"top":return 3}}function Ns(e){return Us(e)*Bs}function we(e){return e==="left"||e==="right"}function ks(e){return e==="left"?"right":e==="right"?"left":e==="top"?"bottom":"top"}function js(e,{observerRenderSpace:t,targetRenderSpace:i,tiltedUpVector:s,rightVector:a,farDistanceRenderSpace:r}){const o=P(Wt,i,t),l=we(e)?a:s,c=N(Ws,l,r);return Ue(t,o,c)}const Bs=Math.PI/2,oe=S(),Wt=v(),Ws=v(),ut={top:v(),bottom:v(),left:v(),right:v()};let Ae=class extends Se{constructor(e,t){super({view:e,autoScaleRenderObjects:!1,worldSized:!1,radius:H.collisionRadius}),this._handles=new ye,this._setupManipulatorVisual(t)}destroy(){this._handles.remove(),super.destroy()}_setupManipulatorVisual(e){const t=this._createMaterial(),i=1,s=[q(0,0,0),q(0,0,i)],a=rt(t,s,e,16,!1),r=rt(t,s,e*Ke,16,!1),o=vt(!1,t,e),l=vt(!0,t,e),c=S();fe(c,s[s.length-1]),j(c,c,zt(mt,Math.PI/2)),j(c,c,be(mt,Math.PI/2)),o.transformation=c,l.transformation=c,this.renderObjects=[new re(a,1),new re(r,2),new re(o,1),new re(l,2)];const d=q(0,H.getScaleOrientArrowTipLength(!0),0),p=G(d,d,c),u=[...s,p];this.collisionType={type:"line",paths:[u]}}_createMaterial(){const e=new kt({cullFace:2,renderOccluded:4,isDecoration:!0});return this._handles.add(M(()=>te.toUnitRGBA(this.view.effectiveTheme.accentColor),t=>e.setParameters({color:t}),R)),e}};function vt(e,t,i){const s=H.getScaleOrientArrowTipLength(e);let a=2*i;e&&(a*=Ke);const r=s/2;return ns(t,s,r,r,a,0)}const mt=S();let Gs=class extends Nt{constructor(e){super(),this._handles=new ye,this._tool=e.tool,this._view=e.view;const t=H.scaleOrientHandleRadius;this._manipulatorHeading=new Ae(this._view,t),this._manipulatorTilt=new Ae(this._view,t),this._manipulatorDistance=new Ae(this._view,t),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this._handles.destroy(),this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._manipulatorHeading=null,this._manipulatorTilt=null,this._manipulatorDistance=null,this._tool=null,this._view=null}createHeadingDragPipeline(e,t){return _e(this._manipulatorHeading,(i,s,a,r,o)=>{const l=this._view,{tiltParallelToSurface:c,farDistanceRenderSpace:d,upVector:p,observerRenderSpace:u,targetRenderSpace:m,rightVector:w}=t,b=Math.sin(y(c))*d,T=K(ge,u,N(Pe,p,b)),D=P(Pe,m,T),F=N(qs,w,ue(D)),z=Ue(T,D,F),C=je(s,l,z,t).next($=>({...$,manipulatorType:3}));e(i,C,a)})}createTiltDragPipeline(e,t){return _e(this._manipulatorTilt,(i,s,a,r,o)=>{const{observerRenderSpace:l,farDistanceRenderSpace:c,upVector:d,targetDirection:p}=t,u=ve(p,d),m=ui(ge,p,d,-u);N(m,he(m,m),c);const w=N(Pe,d,c),b=Ue(l,m,w),T=je(s,this._view,b,t).next(D=>({...D,manipulatorType:3}));e(i,T,a)})}createDistanceDragPipeline(e,t){return _e(this._manipulatorDistance,(i,s,a,r,o)=>{const l=us(t.observerRenderSpace,t.targetDirection),c=s.next(ds(this._view,i.location)).next(Pi(this._view,l)).next(d=>({...d,manipulatorType:2}));e(i,c,a)})}updateManipulators(e){const{targetRenderSpace:t}=e;this._manipulatorHeading.renderLocation=t,this._manipulatorTilt.renderLocation=t,this._manipulatorDistance.renderLocation=t;const i=S(),s=d=>{Ie(i,d,i)},a=H.scaleOrientSize*(Ut/hs);s(De(ce,X(ge,a,a,a))),s(Xe(e,ce));const r=H.scaleOrientHandleRadius*Ke*a,o=N(ge,e.targetDirection,r);s(fe(ce,o));const l=Le(ce,-Fe);j(l,l,be(wt,-Fe)),this._manipulatorHeading.modelTransform=j(S(),i,l);const c=be(ce,Fe);j(c,c,Le(wt,Math.PI)),this._manipulatorTilt.modelTransform=Ie(S(),i,c),this._manipulatorDistance.modelTransform=i}forEachManipulator(e){e(this._manipulatorHeading,3),e(this._manipulatorTilt,3),e(this._manipulatorDistance,2)}};const ce=S(),wt=S(),ge=v(),Pe=v(),qs=v(),Fe=Math.PI/2;let Gt=class extends Se{constructor(e,t){super({view:e,autoScaleRenderObjects:!1,worldSized:!1,radius:H.observerSize,interactive:!1}),this._handles=new ye;const i=Oi(this._color);this.renderObjects=[new re(rs(i,H.observerSize,32,32))],t.manipulators.add(this),this._handles.add([M(()=>this._color,s=>{i.setParameters({color:s})},R)])}destroy(){this._handles.remove(),super.destroy()}get _color(){return te.toUnitRGBA(this.view.effectiveTheme.accentColor)}};n([h()],Gt.prototype,"_color",null);const ft=Symbol("dragHandles"),gt=Symbol("hideManipulators"),_t=Symbol("hideFoVManipulators"),Vt=Symbol("hideObserverManipulator");let L=class extends Me{constructor(e){super(e),this._moveManipulation=null,this._observerManipulator=null,this._fieldOfViewManipulation=null,this._scaleOrientManipulation=null,this._forceHoveringTask=null,this._forceHoveringTestPromise=null,this._grabbing=!1,this.viewshedComputedData=null}initialize(){this._moveManipulation=this._createMoveManipulation(),this._fieldOfViewManipulation=new $s({view:this.view,tool:this.parentTool}),this._scaleOrientManipulation=new Gs({view:this.view,tool:this.parentTool}),this._observerManipulator=new Gt(this.view,this.parentTool),this.addHandles([M(()=>this.viewshedComputedData?.observerRenderSpace,t=>{t!=null&&(this._moveManipulation.renderLocation=t,this._observerManipulator.renderLocation=t)},le),M(()=>this.viewshedComputedData?.heading,t=>{t&&(this._moveManipulation.angle=y(90-t))},R),M(()=>{const{viewshedComputedData:t}=this;return{viewshedComputedData:t,observer:t?.observer}},({viewshedComputedData:t,observer:i},s)=>{this._grabbing&&i!==s?.observer||(this.removeHandles(ft),t?.valid&&this.addHandles([this._buildObserverDragPipeline(t),this._buildFOVDragPipeline(t),this._buildScaleOrientDragPipeline(t)].filter(ti),ft))},R),M(()=>{const t=this.viewshedComputedData;return t?.valid?{viewshedCompData:t,target:t.targetRenderSpace,hFOV:t.horizontalFieldOfView,vFOV:t.verticalFieldOfView}:null},t=>{t!=null&&this._fieldOfViewManipulation.updateManipulatorsTransform(t.viewshedCompData)},R),M(()=>{const t=this.viewshedComputedData;return t?.valid?{viewshedCompData:t,hFOV:t.horizontalFieldOfView,vFOV:t.verticalFieldOfView,tilt:t.tilt}:null},t=>{t!=null&&this._fieldOfViewManipulation.updateManipulatorVisuals(t.viewshedCompData)},R),M(()=>{const t=this.analysisViewData.visible&&(this.viewshedComputedData?.valid??!1),i=this.parentTool.selectedViewshedComputedData===this.viewshedComputedData;return{fovManipulationAvailable:t&&!this.parentTool.isPlacingTarget,nonFOVManipulationAvailable:t&&(!this.parentTool.creating||i)}},({fovManipulationAvailable:t,nonFOVManipulationAvailable:i})=>{this._moveManipulation.available=i,this._scaleOrientManipulation.available=i,this._observerManipulator.available=i,this._fieldOfViewManipulation.available=t},R),M(()=>{const t=this.viewshedComputedData;if(!t?.valid)return null;const{observer:i,target:s,verticalFieldOfView:a,horizontalFieldOfView:r}=t;return{viewshedCompData:t,observer:i,target:s,verticalFieldOfView:a,horizontalFieldOfView:r}},t=>{t!=null&&this._scaleOrientManipulation.updateManipulators(t.viewshedCompData)},R)]);const e=t=>{const i=this.analysisViewData;this.addHandles([t.events.on("focus-changed",()=>{const s=this._someManipulatorHovering();s&&this.parentTool.subToolHandles.forEach(({subTool:a})=>{a._resetHoveringTask()}),this._someManipulatorSelected()||s||(this._forceHoveringTask=ss(async a=>{await(this._forceHoveringTestPromise??ii(H.hoverTimeoutMilliseconds,a)),si(a),this._forceHoveringTask=null,this._updateManipulatorVisibility()}))}),t.events.on("grab-changed",s=>{this._grabbing=s.action==="start",s.action==="end"&&i.tool?.updateInteractionVisualsVisibility(),this.parentTool.subToolHandles.forEach(({subTool:a})=>{a!==this&&a._setInteractive(!this._grabbing)}),this._setInteractive(a=>a.hasManipulator(t)||!this._grabbing)}),t.events.on("drag",s=>{s.action==="start"&&i.tool?.updateInteractionVisualsVisibility()})])};this._forEachManipulator(e)}destroy(){this._forceHoveringTask=ze(this._forceHoveringTask),this._moveManipulation=A(this._moveManipulation),this._fieldOfViewManipulation=A(this._fieldOfViewManipulation),this._scaleOrientManipulation=A(this._scaleOrientManipulation),this.parentTool.manipulators.remove(this._observerManipulator),this._observerManipulator=A(this._observerManipulator)}get viewshed(){return this.viewshedComputedData?.viewshed}get grabbing(){return this._grabbing}get observer(){return this.viewshed?.observer}set observer(e){const t=this.viewshed;t!=null&&(t.observer=e)}get discManipulator(){return this._moveManipulation.xyManipulation.discManipulator}get moveInteractionState(){const{dragging:e,grabbing:t}=this._moveManipulation;return{dragging:e,grabbing:t}}get scaleOrientInteractionState(){const{dragging:e,grabbing:t}=this._scaleOrientManipulation;return{dragging:e,grabbing:t}}_setInteractive(e){const t=typeof e=="boolean";this._forEachManipulation(i=>i.interactive=t?e:e(i))}onManipulatorSelectionChanged(){this._updateManipulatorVisibility(),!this._someManipulatorSelected()&&(this.analysisViewData.selectedViewshed===this.viewshed&&(this.analysisViewData.selectedViewshed=null),this._resetHoveringTask())}hasManipulator(e){let t=!1;return this._forEachManipulator(i=>{t=t||i===e}),t}_someManipulatorSelected(){return this._moveManipulation.selected||this._fieldOfViewManipulation.selected||this._scaleOrientManipulation.selected}_someManipulatorHovering(){return this._moveManipulation.hovering||this._fieldOfViewManipulation.hovering||this._scaleOrientManipulation.hovering}_createMoveManipulation(){return new ls({view:this.view,tool:this.parentTool,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:Ut})}_buildObserverDragPipeline(e){const t={mode:"absolute-height",offset:0},i=e.observer;if(i==null)return null;const s=this.view.spatialReference;return this._moveManipulation.createDragPipeline((a,r,o,l,c)=>{l=l.next(xe(this,["observer"]));const d=Vi(i,s);if(d==null)return{steps:o,cancel:l};const p=vs.fromGeometry(d,li(this.view.viewingMode));return{steps:o.next(cs({operations:p})).next(u=>(this.observer=p.data.geometry,u)),cancel:l}},t,s,void 0)}_buildFOVDragPipeline(e){let t=0,i=0;return this._fieldOfViewManipulation.createDragPipeline((s,a,r)=>{if(e==null)return{steps:a,cancel:r};const o=e.viewshed;let l=null;return r=r.next(xe(o,["horizontalFieldOfView","verticalFieldOfView"])),{steps:a.next(c=>{c.action==="start"&&(l=null,t=e.horizontalFieldOfView,i=e.verticalFieldOfView);const d=c.deltaAngle;if(l==null&&d!==0){const m=c.side==="bottom"||c.side==="left"?d>0:d<0;l=we(c.side)?t===0&&m||t===360&&!m:i===0&&m}const p=l?ks(c.side):c.side;let u=0;switch(p){case"left":u=t/2-d;break;case"right":u=t/2+d;break;case"top":u=i+2*d;break;case"bottom":u=i-2*d}return we(p)?(u=at.normalize(u),u=u>270?0:u>180?180:u,o.horizontalFieldOfView=2*u):o.verticalFieldOfView=u,c}),cancel:r}},e)}_buildScaleOrientDragPipeline(e){let t=0,i=0;const s=(a,r)=>(o,l,c)=>{if(e==null)return{steps:l,cancel:c};const d=e.viewshed;return c=c.next(xe(d,[a])),{steps:l=l.next(r(d,e)),cancel:c}};return Pt([this._scaleOrientManipulation.createHeadingDragPipeline(s("heading",(a,r)=>o=>(o.action==="start"&&(i=e.heading),a.heading=at.normalize(i+o.deltaAngle),o)),e),this._scaleOrientManipulation.createTiltDragPipeline(s("tilt",(a,r)=>o=>{o.action==="start"&&(t=e.tilt);let l=t+o.deltaAngle;return l<-90?l=180:l>270&&(l=0),a.tilt=Xs.clamp(l),o}),e),this._scaleOrientManipulation.createDistanceDragPipeline(s("farDistance",(a,r)=>o=>{const l=P(Ks,o.renderEnd,r.observerRenderSpace),c=ue(l)*r.metersPerUnit,d=ve(l,r.targetDirection)<0?H.scaleOrientMinDistance:c;return a.farDistance=d,o}),e)])}_updateManipulatorVisibility(){const e=this._someManipulatorSelected(),t=this._forceHoveringTask!=null||this._someManipulatorHovering(),i=this._fieldOfViewManipulation.hovering,s=this.parentTool.creating;let a=[];const r=o=>{a.push(o.disableDisplay())};e||!s&&t?this.removeHandles(gt):(this._scaleOrientManipulation.forEachManipulator(r),this._moveManipulation.forEachManipulator(r),this.addHandles(a,gt),a=[]),e||!s&&t||s&&i?this.removeHandles(_t):(this._fieldOfViewManipulation.forEachManipulator(r),this.addHandles(a,_t)),e||!s?this.removeHandles(Vt):this.addHandles(this._observerManipulator.disableDisplay(),Vt)}_resetHoveringTask(){this._forceHoveringTask=ze(this._forceHoveringTask),this._updateManipulatorVisibility()}_forEachManipulator(e){this._forEachManipulation(t=>{t.forEachManipulator(e)}),e(this._observerManipulator)}_forEachManipulation(e){e(this._moveManipulation),e(this._fieldOfViewManipulation),e(this._scaleOrientManipulation)}get test(){return{moveManipulation:this._moveManipulation,fieldOfViewManipulation:this._fieldOfViewManipulation,scaleOrientManipulation:this._scaleOrientManipulation,viewshedComputedData:this.viewshedComputedData,setHoveringTimeoutPromise:e=>{this._forceHoveringTestPromise=e}}}};n([h({constructOnly:!0})],L.prototype,"analysis",void 0),n([h({constructOnly:!0})],L.prototype,"analysisViewData",void 0),n([h({constructOnly:!0})],L.prototype,"parentTool",void 0),n([h({constructOnly:!0,nonNullable:!0})],L.prototype,"view",void 0),n([h()],L.prototype,"viewshed",null),n([h()],L.prototype,"_grabbing",void 0),n([h()],L.prototype,"grabbing",null),n([h()],L.prototype,"viewshedComputedData",void 0),n([h()],L.prototype,"observer",null),L=n([ie("esri.views.3d.analysis.Viewshed.ViewshedSubTool")],L);const Ks=v(),Xs=new as(0,180),Ee=Symbol("interactionVisuals");let O=class extends bs{constructor(e){super(e),this.removeIncompleteOnCancel=!1,this.automaticManipulatorSelection=!1,this._stagedViewshed=null,this._stagedViewshedComputedData=null,this._placementMode=yt,this._creationState=!1,this._interactionVisualElements=null,this._settings=new ms({getTheme:()=>this.view.effectiveTheme}),this._selectedManipulator=null}initialize(){this._intersector=Ms(this.view.state.viewingMode),this._createInteractionVisuals();const e=this.analysisViewData.viewshedComputedDataHandles;this.subToolHandles=We(()=>e,({viewshedComputedData:t})=>{const i=new L({analysis:this.analysis,analysisViewData:this.analysisViewData,parentTool:this,view:this.view,viewshedComputedData:t});return{subTool:i,remove:()=>{this.selectedViewshed===t.viewshed&&(this.selectedViewshed=null),i.destroy()}}}),this.addHandles([pe(()=>this._valid,()=>this.finishToolCreation(),le),M(()=>this._stagedViewshed,t=>{const i=this.analysisViewData.viewshedComputedDataHandles;this._stagedViewshedComputedData=t!=null&&i!=null?this._findSubTool(t)?.viewshedComputedData:null},le),this.analysis.viewsheds.on("after-remove",t=>{const i=this._stagedViewshed;i!=null&&t.item===i&&this.analysis.viewsheds.add(i)}),M(()=>this.firstGrabbedManipulator,t=>{if(t!=null){const i=this._findSubTool(t)?.viewshed;this.selectedViewshed=i,this._selectManipulator(t)}else this._selectedSubTool?.onManipulatorSelectionChanged()},Ft),M(()=>this.view.activeTool,t=>{t!==this&&t!=null&&(this.selectedViewshed=null)}),pe(()=>{const t=this.selectedViewshedComputedData;return t==null?null:{subTool:this._selectedSubTool,observer:t.observerRenderSpace,target:t.targetRenderSpace}},t=>{const{subTool:i,observer:s,target:a}=t;i?.moveInteractionState.dragging?this._updateInteractionVisualsLocation(s,!0):i?.scaleOrientInteractionState.dragging&&this._updateInteractionVisualsLocation(a,!1)},R),M(()=>this.creating,()=>this.updateInteractionVisualsVisibility()),M(()=>this.selectedViewshed,t=>{const i=this._selectedManipulator,s=this._selectedSubTool;t==null?this._selectManipulator(null):i!=null&&s.hasManipulator(i)||this._selectManipulator(s.discManipulator)},R)])}destroy(){this.subToolHandles=A(this.subToolHandles),this.removeHandles(Ee)}onDeactivate(){this.removeStaged(),this._creationState=!1}get _valid(){return this.analysisViewData.viewshedComputedDataHandles?.some(e=>e.viewshedComputedData.valid)??!1}get cursor(){return this.creating?"crosshair":null}get _selectedSubTool(){return this._findSubTool(this.selectedViewshed)}_selectManipulator(e){const t=this._selectedManipulator;t!==e&&(this._selectedManipulator=e,t!=null&&(t.selected=!1),e!=null&&(e.selected=!0),this._findSubTool(t)?.onManipulatorSelectionChanged(),this._selectedSubTool?.onManipulatorSelectionChanged())}get selectedViewshed(){return this.analysisViewData.selectedViewshed}set selectedViewshed(e){this.analysisViewData.selectedViewshed=e}get selectedViewshedComputedData(){return this._selectedSubTool?.viewshedComputedData}get stagedViewshed(){return this._stagedViewshed}get grabbing(){return this.subToolHandles.some(({subTool:e})=>e.grabbing)}get creating(){return this._creationState&&this.active}get isPlacingTarget(){return this._creationState==="placing-target"}place(e){this.selectedViewshed=null,this._placementMode=e,this._creationState="placing-observer",this._finishToolCreationIfValid()}onManipulatorSelectionChanged(){this.subToolHandles.forEach(e=>e.subTool.onManipulatorSelectionChanged())}onInputEvent(e){switch(e.type){case"immediate-double-click":this._doubleClickHandler(e);break;case"pointer-move":this._pointerMoveHandler(e);break;case"key-down":Qe.cancel===e.key?this._cancelKeyHandler(e):Qe.delete.includes(e.key)&&this._deleteKeyHandler();break;case"hold":this.updateInteractionVisualsVisibility(!0)}}onInputEventAfter(e){e.type==="immediate-click"&&this._clickPlacementHandler(e)}onActivate(){this._placementMode=yt}_clickPlacementHandler(e){if(!this.creating||this.hasFocusedManipulators)return;const t=this._intersectScreen(e,Mt);if(t!=null){if(this._creationState==="placing-observer"){t.mapPoint.z=(t.mapPoint.z??0)+As;const i=new is({observer:t.mapPoint.clone(),feature:t.feature});this.analysis.viewsheds.add(i),this._stagedViewshed=i,this._creationState="placing-target",this._updateStagedViewshed(t.scenePoint)}else if(this._creationState==="placing-target"){this._updateStagedViewshed(t.scenePoint);const i=this._stagedViewshed;this._stagedViewshed=null,this._placementMode==="multiple"?this._creationState="placing-observer":(this._creationState=!1,this._stagedViewshed=null,this._finishToolCreationIfValid(),this.view.activeTool=null),this.selectedViewshed=i}e.stopPropagation()}}_doubleClickHandler(e){this.creating&&(this.removeStaged(),this._creationState=!1,this.view.activeTool=null,e.stopPropagation())}_pointerMoveHandler(e){if(!this.creating)return;const t=this._intersectScreen(e,Mt);t!=null&&(this._updateInteractionVisualsLocation(t.scenePoint,!1),this._updateStagedViewshed(t.scenePoint))}_cancelKeyHandler(e){this.creating?this._onCancelWhileCreating(e):this.grabbing||(this.selectedViewshed=null,e.stopPropagation())}_onCancelWhileCreating(e){const t=this.removeStaged();this._finishToolCreationIfValid(),t?(this._creationState="placing-observer",this.selectedViewshed=null,this._placementMode==="multiple"&&e.stopPropagation()):this._creationState=!1}_deleteKeyHandler(){this.creating&&(this.removeStaged(),this._creationState="placing-observer"),this.selectedViewshed!=null&&this.analysis.viewsheds.remove(this.selectedViewshed)}_finishToolCreationIfValid(){this._valid&&this.finishToolCreation()}_updateStagedViewshed(e){const t=this._stagedViewshed,i=this._stagedViewshedComputedData;if(t==null||i==null)return;const{heading:s,tilt:a,farDistance:r}=Ys(this.view,i,e);t.farDistance=r,t.tilt=a,t.heading=s}removeStaged(){const e=this._stagedViewshed;return e!=null&&(this._stagedViewshed=null,this.analysis.viewsheds.remove(e),!0)}_intersectScreen(e,t){const i=ni(e);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(i,this._intersector);const s=this._intersector.results.min,a=t.scenePoint;if(!s.getIntersectionPoint(a))return null;const r=t.mapPoint;return r.spatialReference=this.view.spatialReference,this.view.renderCoordsHelper.fromRenderCoords(a,r),r==null?null:(t.feature=gs(s,this.view),t)}_createInteractionVisuals(){this.removeHandles(Ee);const e=this._settings.visualElements,t=new fs({view:this.view,attached:!1,style:{glowWidth:e.heightPlane.glowWidth,innerWidth:e.heightPlane.innerWidth},isDecoration:!0}),i=new ws({view:this.view,extensionType:e.zVerticalLine.extensionType,attached:!1,innerWidth:1,writeDepthEnabled:!1,renderOccluded:4,isDecoration:!0});this._interactionVisualElements={laserline:t,verticalLine:i},this.addHandles([M(()=>e.zVerticalLine,s=>s.apply(i),le),M(()=>e.heightPlane,s=>s.apply(t),le),Jt(()=>{t.destroy(),i.destroy(),this._interactionVisualElements=null})],Ee)}updateInteractionVisualsVisibility(e=!1){const t=this.creating,i=this.analysisViewData.visible,s=this._selectedSubTool,a=this.selectedViewshedComputedData,r=(u,m)=>{const w=this._interactionVisualElements;w!=null&&(w.verticalLine.attached=m,w.laserline.attached=u)};if(t)return void r(i,!1);if(s==null||a==null)return void r(!1,!1);const o=s.moveInteractionState,l=e?o.grabbing:o.dragging,c=s.scaleOrientInteractionState,d=e?c.grabbing:c.dragging,p=i&&(l||d);if(r(p,l),p){const u=l?a.observerRenderSpace:a.targetRenderSpace;this._updateInteractionVisualsLocation(u,l)}}_updateInteractionVisualsLocation(e,t){const i=this._interactionVisualElements;if(i==null)return;const{laserline:s,verticalLine:a}=i;s.heightManifoldTarget=e,s.intersectsWorldUpAtLocation=t?e:null,e!=null&&a.setStartEndFromWorldDownAtLocation(e)}_findSubTool(e){if(e==null)return null;const t=e instanceof Se?i=>i.subTool.hasManipulator(e):i=>i.subTool.viewshed===e;return this.subToolHandles?.find(t)?.subTool}get test(){}};function Ys(e,t,i){const s=t.observerRenderSpace,a=P(Js,i,s),r=ue(a)*t.metersPerUnit,o=e.renderCoordsHelper.basisMatrixAtPosition(s,ea),l=X(Qs,o[8],o[9],o[10]),c=Lt(s,l,ta),d=Ci(c,i,Zs),p=P(d,d,s),u=(ue(p)<1e-4?90:me(Ve(a,p)))*(ve(l,a)<0?-1:1)+90,m=X(bt,o[4],o[5],o[6]),w=me(Ve(m,p)),b=X(bt,o[0],o[1],o[2]);return{heading:ve(p,b)<0?360-w:w,tilt:u,farDistance:r}}n([h({constructOnly:!0})],O.prototype,"view",void 0),n([h()],O.prototype,"analysisViewData",void 0),n([h()],O.prototype,"removeIncompleteOnCancel",void 0),n([h()],O.prototype,"automaticManipulatorSelection",void 0),n([h({constructOnly:!0})],O.prototype,"analysis",void 0),n([h()],O.prototype,"subToolHandles",void 0),n([h()],O.prototype,"_stagedViewshed",void 0),n([h()],O.prototype,"_stagedViewshedComputedData",void 0),n([h()],O.prototype,"_placementMode",void 0),n([h()],O.prototype,"_creationState",void 0),n([h()],O.prototype,"_valid",null),n([h({readOnly:!0})],O.prototype,"cursor",null),n([h()],O.prototype,"_selectedManipulator",void 0),n([h()],O.prototype,"_selectedSubTool",null),n([h()],O.prototype,"selectedViewshed",null),n([h()],O.prototype,"selectedViewshedComputedData",null),n([h()],O.prototype,"stagedViewshed",null),n([h()],O.prototype,"grabbing",null),n([h()],O.prototype,"creating",null),n([h()],O.prototype,"isPlacingTarget",null),O=n([ie("esri.views.3d.analysis.Viewshed.ViewshedTool")],O);const Js=v(),Qs=v(),Zs=v(),bt=v(),ea=S(),ta=It(),Mt={mapPoint:new $e,scenePoint:v(),feature:null},yt="multiple";let ia=class extends Di{constructor(e){super(e),this._material=null,this._viewshedComputedData=null,this._material=new kt({...Q.shapeMaterialParameters,isDecoration:this.isDecoration,writeDepth:!1}),this.applyProperties(e)}get viewshedComputedData(){return this._viewshedComputedData}set viewshedComputedData(e){this._viewshedComputedData=e,this.updateTransform()}updateTransform(){const e=this._viewshedComputedData;if(e==null)return;const t=S(),i=e.farDistanceRenderSpace;De(t,q(i,i,i)),Xe(e,de),j(t,de,t),fe(de,this._viewshedComputedData.observerRenderSpace),j(t,de,t),this.transform=t}createExternalResources(){}destroyExternalResources(){}forEachMaterial(e){e(this._material)}createGeometries(e){const{_material:t,viewshedComputedData:i}=this;i==null||t==null||!i.valid||sa(t,i).forEach(s=>e.addGeometry(s))}};function sa(e,t){const{horizontalFieldOfView:i,verticalFieldOfView:s}=t,a=X(aa,0,0,1),r=X(Dt,0,1,0),o=X(Ot,1,0,0);ee(a,a,y(s/2),r),ee(a,a,y(i/2),o);const l=V=>Math.ceil(Math.abs(V)/jt)+1,c=y(i),d=k(ra,o),p=l(c),u=St(-c/(p-1)),m=Y(de,u,d),w=y(-s),b=l(w),T=St(w/(b-1)),D=k(Dt,r),F=Y(Tt,y(i)/2,o);G(D,D,F);const z=Tt,C=[],$=k(Ot,a);for(let V=0;V<p;V++){Y(z,T,D);for(let g=0;g<b;g++){const _=3*(g*p+V);C[_]=$[0],C[_+1]=$[1],C[_+2]=$[2],G($,$,z)}G(D,D,m),G(a,a,m),k($,a)}const B=p*b;C[3*B]=0,C[3*B+1]=0,C[3*B+2]=0;const W=[];for(let V=0;V<p-1;V++)for(let g=0;g<b-1;g++){const _=6*(g*(p-1)+V);W[_]=g*p+V,W[_+1]=(g+1)*p+V,W[_+2]=g*p+V+1,W[_+3]=g*p+V+1,W[_+4]=(g+1)*p+V,W[_+5]=(g+1)*p+V+1}const J=[W];if(i!==360&&s!==0){const V=[],g=[];for(let _=0;_<b-1;_++){const x=3*_;V[x]=B,V[x+1]=(_+1)*p,V[x+2]=_*p,g[x]=B,g[x+1]=_*p+p-1,g[x+2]=(_+1)*p+p-1}J.push(V,g)}if(s!==180&&i!==0){const V=[],g=[];for(let _=0;_<p-1;_++){const x=3*_;V[x]=B,V[x+1]=_,V[x+2]=_+1,g[x]=B,g[x+1]=_+(b-1)*p+1,g[x+2]=_+(b-1)*p}J.push(V,g)}return J.map(V=>{const g=[["position",new ys(C,V,3,!0)]];return new Qi(e,g)})}function St(e){return isNaN(e)?1:e}const aa=v(),Dt=v(),Ot=v(),ra=v(),de=S(),Tt=S();let I=class extends Me{constructor(e){super(e),this.visible=!0,this._viewshedCorners={topLeft:v(),topRight:v(),bottomLeft:v(),bottomRight:v()},this._arcCenterPoints={top:v(),bottom:v(),left:v(),right:v()},this._parallelCenters={top:v(),bottom:v()}}initialize(){const e={view:this.view,isDecoration:!0},t={...e,color:this._color,renderOccluded:4},i={...t,stipplePattern:Ds(2)};this._observerVisualElement=new Ss({...e,...Q.observerPointConfiguration}),this._shapeVisualElement=new ia({...e,isDecoration:this.isDecoration}),this._frameLinesVisualElement=new se(t),this._leftArcVisualElement=new se(t),this._rightArcVisualElement=new se(t),this._topArcVisualElement=new se(t),this._bottomArcVisualElement=new se(t),this._centralLongitude=new se(i),this._centralLatitude=new se(i),this.addHandles([M(()=>{const s=this.viewshedComputedData;if(!s?.valid)return null;const a=this._viewshedCorners,r=this._arcCenterPoints,o=this._parallelCenters;return s.cornerPoints(a),s.arcCentersPoints(r),s.parallelCenterPoints(o),{viewshedComputedData:s,corners:a,arcCenters:r,parallelCenters:o,interactive:this.analysisViewData.interactive,selected:this._selected}},s=>{const a=s!=null;this._forEachVisualElement(r=>r.attached=a),a&&this._updateVisualElements(s)},{initial:!0,equals:ei}),M(()=>{const{viewshedComputedData:s}=this,{horizontalFieldOfView:a,verticalFieldOfView:r}=s??{};return{viewshedComputedData:s,horizontalFieldOfView:a,verticalFieldOfView:r}},({viewshedComputedData:s})=>{const{_shapeVisualElement:a}=this;s!==a.viewshedComputedData&&(a.viewshedComputedData=s),this._shapeVisualElement.recreateGeometry()},R),M(()=>{const{interactive:s}=this.analysisViewData;return{visible:this.visible,selected:s&&this._selected,staged:s&&this._staged,horFovNot360:this.viewshedComputedData?.horizontalFieldOfView!==360}},({visible:s,selected:a,staged:r,horFovNot360:o})=>{const l=a||r;this._shapeVisualElement.visible=s,this._topArcVisualElement.visible=s,this._bottomArcVisualElement.visible=s,this._frameLinesVisualElement.visible=s&&o;const c=s&&(a||o);this._leftArcVisualElement.visible=c,this._rightArcVisualElement.visible=c,this._forEachLineVisualElement(d=>{d.width=l?Q.frameWidthSelected:Q.frameWidthNotSelected,d.renderOccluded=a?4:1}),[this._centralLatitude,this._centralLongitude].forEach(d=>{d.width=2*(l?Q.frameWidthSelected:Q.frameWidthNotSelected),d.visible=s&&a})},R),M(()=>{const{analysisViewData:{interactive:s,tool:a},_selected:r,visible:o}=this,l=this.view.activeTool,c=!a?.active&&l instanceof O&&l.creating;return{observerVisible:o&&!r&&(!s||(a?.creating??!1)||c),color:this._color}},({observerVisible:s,color:a})=>{this._observerVisualElement.visible=s,this._forEachLineVisualElement(r=>r.color=a)},R)])}get _color(){const{viewshedComputedData:e,_selected:t,analysisViewData:i}=this;if(e==null)return te.toUnitRGBA(Q.frameColor);const s=i.tool?.active||i.interactive,a=e.viewshed===i.tool?.stagedViewshed,r=s&&(t||a)?this.view.effectiveTheme.accentColor:Q.frameColor;return te.toUnitRGBA(r)}get _selected(){const{viewshedComputedData:e,analysisViewData:{selectedViewshedComputedData:t}}=this;return e!=null&&e===t}get _staged(){const{analysisViewData:{tool:e},viewshedComputedData:t}=this;return e!=null&&e.creating&&e.stagedViewshed===t?.viewshed}destroy(){this._observerVisualElement=A(this._observerVisualElement),this._shapeVisualElement=A(this._shapeVisualElement),this._frameLinesVisualElement=A(this._frameLinesVisualElement),this._leftArcVisualElement=A(this._leftArcVisualElement),this._rightArcVisualElement=A(this._rightArcVisualElement),this._topArcVisualElement=A(this._topArcVisualElement),this._bottomArcVisualElement=A(this._bottomArcVisualElement),this._centralLongitude=A(this._centralLongitude),this._centralLatitude=A(this._centralLatitude)}_forEachLineVisualElement(e){[this._frameLinesVisualElement,this._leftArcVisualElement,this._rightArcVisualElement,this._topArcVisualElement,this._bottomArcVisualElement,this._centralLatitude,this._centralLongitude].forEach(e)}_forEachVisualElement(e){this._forEachLineVisualElement(e),e(this._observerVisualElement),e(this._shapeVisualElement)}_updateVisualElements(e){const{viewshedComputedData:t,corners:i,arcCenters:s,parallelCenters:a}=e,r=Et(t.observerRenderSpace);this._observerVisualElement.geometry=t.observer,this._shapeVisualElement.updateTransform(),this._updateFrameLines(r,i),this._updateFrameArcs(t,i,a),this._updateCentralHelperArcs(t,s)}_updateFrameLines(e,t){this._frameLinesVisualElement.geometry=[[e,t.topLeft],[e,t.topRight],[e,t.bottomLeft],[e,t.bottomRight]]}_updateFrameArcs(e,t,i){const{observerRenderSpace:s,rightVector:a,horizontalFieldOfView:r,tiltedUpVector:o}=e,l=y(r),c=v(),d=S();Y(d,l/2,o),G(c,a,d),ne(this._leftArcVisualElement,s,t.bottomLeft,t.topLeft,"forward",c),Y(d,-l/2,o),X(c,0,0,0),G(c,a,d),ne(this._rightArcVisualElement,s,t.bottomRight,t.topRight,"forward",c);const p=r>180?"backward":"forward";ne(this._topArcVisualElement,i.top,t.topRight,t.topLeft,p,o),ne(this._bottomArcVisualElement,i.bottom,t.bottomRight,t.bottomLeft,p,o)}_updateCentralHelperArcs(e,t){const i=e.observerRenderSpace,s=e.horizontalFieldOfView>=180?"backward":"forward";ne(this._centralLatitude,i,t.right,t.left,s,e.tiltedUpVector),ne(this._centralLongitude,i,t.top,t.bottom,"forward",e.leftVector)}get test(){}};function ne(e,t,i,s,a,r,o=jt){const l=v();P(l,i,t);const c=ue(l),d=v();P(d,s,t),he(d,d),N(d,d,c);let p=Ve(l,d);const u=Et(r);a==="backward"&&(Ge(u,u),p=-(2*Math.PI-p));const m=[],w=Math.ceil(Math.abs(p)/o),b=S();Y(b,p/w,u);const T=v();k(T,l);const D=v();k(D,i);for(let F=0;F<w;F++){const z=v();k(z,D),G(T,T,b),K(D,t,T);const C=v();k(C,D),m.push([z,C])}e.geometry=m}n([h()],I.prototype,"view",void 0),n([h({constructOnly:!0})],I.prototype,"isDecoration",void 0),n([h()],I.prototype,"analysisViewData",void 0),n([h()],I.prototype,"viewshedComputedData",void 0),n([h()],I.prototype,"visible",void 0),n([h()],I.prototype,"_color",null),n([h()],I.prototype,"_selected",null),n([h()],I.prototype,"_staged",null),I=n([ie("esri.views.3d.analysis.Viewshed.ViewshedSubVisualization")],I);let ae=class extends Me{get visible(){return this.analysisViewData.visible}constructor(e){super(e)}initialize(){const e=this.analysisViewData,t=We(()=>this.analysisViewData.viewshedComputedDataHandles,({viewshedComputedData:i})=>{const s=new I({view:this.view,viewshedComputedData:i,analysisViewData:e,isDecoration:this.isDecoration});return{visualization:s,remove:()=>s.destroy()}});this._subVisualizations=t,this.addHandles([Yt(t),M(()=>this.visible,i=>this._subVisualizations.forEach(({visualization:s})=>s.visible=i),R)])}get test(){}};n([h({constructOnly:!0})],ae.prototype,"analysisViewData",void 0),n([h({constructOnly:!0,nonNullable:!0})],ae.prototype,"view",void 0),n([h({constructOnly:!0})],ae.prototype,"isDecoration",void 0),n([h()],ae.prototype,"visible",null),ae=n([ie("esri.views.3d.analysis.Viewshed.ViewshedVisualization")],ae);let Z=class extends Bi{constructor(){super(...arguments),this.sectionAngles=Os()}get sectionAnglesDeg(){return nt(this.sectionAngles.map(e=>me(e)))}set sectionAnglesDeg(e){this.sectionAngles=nt(e.map(t=>y(t)))}get projectionMatrix(){return j(S(),this.sectionMatrix,this._projectionMatrixInternal)}get sectionMatrix(){const e=this.sectionAngles[0],t=this.sectionAngles[1],i=this.sectionAngles[2],s=this.sectionAngles[3];Ne(e<=t),Ne(i<=s);const a=2*Math.tan(this.fovX/2),r=2*Math.tan(this.fovY/2),o=Math.tan(e),l=Math.tan(t),c=Math.tan(i),d=l-o,p=Math.tan(s)-c,u=a/d,m=r/p,w=-(o+d/2)/a*2,b=-(c+p/2)/r*2,T=S();fe(T,[w,b,0]);const D=S();De(D,[u,m,1]);const F=S();return j(F,D,T)}get _sectionRatioX(){const e=Math.tan(this.sectionAngles[0]),t=Math.tan(this.sectionAngles[1]),i=2*Math.tan(this.fovX/2);return Math.min(1,(t-e)/i)}setViewport(e,t){const i=t*this._sectionRatioX;return this.viewport=[e[0],e[1],i,t],i}};n([h()],Z.prototype,"sectionAngles",void 0),n([h()],Z.prototype,"sectionAnglesDeg",null),n([h()],Z.prototype,"projectionMatrix",null),n([h()],Z.prototype,"sectionMatrix",null),n([h()],Z.prototype,"_sectionRatioX",null),Z=n([ie("esri.views.3d.webgl-engine.lib.ViewshedFaceCamera")],Z);class oa{constructor(){this.textureSizeQuality=1,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.textureSizeMultiple=128,this.toleranceSides=5,this.toleranceBottomTop=10}textureSizeModifier(t){const i=t?this.textureSizeModHighQuality:this.textureSizeModLowQuality;return this.textureSizeQuality*i}textureResizeModulo(t){return Math.ceil(t/this.textureSizeMultiple)*this.textureSizeMultiple}}const xt=["front","left","right","back","top","bottom"];function na(e){return!["top","bottom"].includes(e)}class la{constructor(t){this._fbos=t,this._faces={},this._width=0,this._height=0,this.settings=new oa,this._maxTextureSize=Math.min(Qt("esri-mobile")?4096:16384,t.rctx.parameters.maxTextureSize)}get depthTexture(){return this._handle?.getTexture(lt)}get ready(){return this.depthTexture!=null&&this._width!==0&&this._height!==0}get nearFar(){const t=this.faces;return t.length===0?null:t[0].nearFar}get numActiveFaces(){const t=this._faces;let i=0;return Object.keys(t).forEach(s=>{t[s]&&(i+=1)}),i}get faces(){const t=this._faces,i=[];for(const s of xt){const a=t[s];a&&i.push(a)}return i}get atlasRegions(){return this.faces.map(t=>[t.x/this._width,(t.x+t.width)/this._width,t.y/this._height,(t.y+t.height)/this._height])}get viewshedProjectionMatrices(){return this.faces.map(t=>t.projectionMatrix)}get viewshedViewMatrices(){return this.faces.map(t=>t.viewMatrix)}_setupFaceCamera(t,i,s,a){const{effectiveObserverRenderSpace:r,tiltedUpVector:o,targetRenderSpace:l,farDistanceRenderSpace:c,horizontalFieldOfView:d,verticalFieldOfView:p}=i,u=v();P(u,l,r);const m=v(),w=v(),b=(g,_)=>{const x=v(),Je=S();return Y(Je,g,_),G(x,u,Je),K(x,r,x),x};let T,D=o;const F=Math.min(90,d),z=Math.min(90,Math.max(0,(d-90)/2));let C=-45,$=45,B=-45,W=45;if(na(t)){const g=_=>qe(_,-45,45);B=g(-p/2)-this.settings.toleranceBottomTop,W=g(+p/2)+this.settings.toleranceBottomTop}switch(t){case"front":T=l,C=-F/2,$=F/2;break;case"left":T=b(Math.PI/2,o),C=45-z;break;case"right":T=b(-Math.PI/2,o),$=-45+z;break;case"top":T=K(m,r,o),D=Ge(w,u);break;case"bottom":T=P(m,r,o),D=u;break;case"back":T=b(Math.PI,o)}const J=new Z({center:T,eye:r,up:D,far:c});J.sectionAnglesDeg=[C-this.settings.toleranceSides,$+this.settings.toleranceSides,B,W],J.fovY=Math.PI/2;const V=J.setViewport(s,a);return this._faces[t]=J,V}isActive(t){return this._computeActiveFaces(t).size>0}_computeActiveFaces(t){const i=new Set,{horizontalFieldOfView:s,verticalFieldOfView:a}=t,r=-a/2,o=a/2;return s===0||a===0||(r<=45&&o>=-45&&i.add("front"),s>90&&(i.add("left"),i.add("right")),s>270&&i.add("back"),o>45-this.settings.toleranceBottomTop&&i.add("top"),r<-45+this.settings.toleranceBottomTop&&i.add("bottom")),i}_computeBaseTextureSize({pixelRatio:t,fullWidth:i,fullHeight:s},a,r,o){const l=a/t,c=this.settings.textureSizeModifier(r);return Hi(Math.max(i,s)*l*c,this._maxTextureSize/o)}_ensureFBO(t){const i=this._width,s=this._height,a=this._handle?.fbo;a&&a.width===i&&a.height===s&&t===zi(a.depthStencilTexture?.descriptor?.internalFormat??Ts.DEPTH_COMPONENT16)||(this._handle?.release(),this._handle=this._allocateFBO(t))}_allocateFBO(t){const{_width:i,_height:s}=this,a=t?13:12,r=this._fbos.acquire(i,s,"viewshed shadow map",a);return r.getTexture(lt)?.setShadowFiltering(!1),r}clearFBO(t){const i=this._fbos.rctx;this._ensureFBO(t),i.bindFramebuffer(this._handle?.fbo),i.setClearColor(1,1,1,1),i.clear(16640)}dispose(){this._debugFBO||(this._handle=Zt(this._handle))}start(t,i,s,a,r=!1){this._faces={};const o=this._computeActiveFaces(i),l=o.size;if(l===0)return!1;const c=this._computeBaseTextureSize(t,a,s,l);let d=0,p=0,u=0;return xt.filter(m=>o.has(m)).forEach(m=>{const w=ha(m,l);w>p&&(u=Math.max(u,d),d=0),p=w;const b=w*c;d+=this._setupFaceCamera(m,i,[d,b],c)}),u=Math.max(u,d),this._width=this.settings.textureResizeModulo(u),this._height=ca(l)*c,this.clearFBO(r),!0}finish(){}get test(){}}function ha(e,t){if(t<4)return 0;const i=e==="front"||e==="left";return t===4?i?0:1:i||e==="right"?0:1}function ca(e){return e<4?1:2}class da extends ji{constructor(){super(...arguments),this.localOrigin=wi()}}function pa(e){e.include(Zi),e.fragment.uniforms.add(new es("inverseViewMatrix",(t,i)=>{const s=Ht(S(),i.camera.viewMatrix,t.localOrigin);return $t(s,s)})).code.add(ke`vec4 reconstructLocalPosition(vec2 coord, float linearDepth) {
vec4 cameraSpace = vec4(reconstructPosition(coord, linearDepth), 1.0);
return inverseViewMatrix * cameraSpace;
}`)}let Ye=class extends da{constructor(){super(...arguments),this.shadowMap={depthTexture:null,nearFar:[1,100],numActiveFaces:1,atlasRegions:[[0,0,1,1]]},this.targetVector=[1,0,0],this.upVector=[0,0,1],this.fovs=[45,45],this.headingAndTilt=[0,0],this.observerOffset=[0,0,0],this.projectionMatrices=et.flat(),this.viewMatrices=et.flat(),this.volumeOffset=0}};function qt(){const e=new Wi,t=e.fragment;return e.include(Gi),e.include(pa),t.include(qi),t.include(Ki),t.uniforms.add(new Xi("depthTexture",i=>i.depth?.attachment),new it("inverseProjectionMatrix",i=>i.camera.inverseProjectionMatrix),new it("inverseViewNormalMatrix",({camera:i})=>$t(ua,i.viewInverseTransposeMatrix)),new Re("viewshedObserverOffset",i=>i.observerOffset),new Re("viewshedTargetVector",i=>i.targetVector),new Re("viewshedUpVector",i=>i.upVector),new Te("viewshedFOVs",i=>i.fovs),new Te("viewshedHeadingAndTilt",i=>i.headingAndTilt),new Te("viewshedNearFar",i=>i.shadowMap.nearFar??[1,100]),new Rs("viewshedVolumeOffset",i=>i.volumeOffset),new ht("viewshedShadowMap",i=>i.shadowMap.depthTexture),new st("viewshedProjectionMatrices",i=>i.projectionMatrices,6),new st("viewshedViewMatrices",i=>i.viewMatrices,6),new Yi("viewshedNumFaces",i=>i.shadowMap.numActiveFaces),new Ji("viewshedAtlasRegions",i=>i.shadowMap.atlasRegions.flat(),24),new ht("normalMap",i=>i.normals)),t.constants.add("visibleColor","vec4",[0,1,0,.5]),t.constants.add("occludedColor","vec4",[1,0,0,.5]),t.code.add(ke`vec2 getViewshedUv(vec4 worldPosition, int face) {
mat4 viewshedMatrix = viewshedProjectionMatrices[face];
vec4 viewshedUv4 = viewshedMatrix * worldPosition;
vec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;
return viewshedUv.xy;
}
float viewshedDepthToFloat(float depth) {
return (depth - viewshedNearFar[0]) / (viewshedNearFar[1] - viewshedNearFar[0]);
}
float getOrthographicDepthToViewshed(vec4 worldPosition, int face) {
mat4 viewshedViewMatrix = viewshedViewMatrices[face];
vec4 viewshedUv4 = viewshedViewMatrix * worldPosition;
vec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;
float depth = -viewshedUv.z;
return viewshedDepthToFloat(depth);
}
float viewshedReadShadowMapDepth(sampler2D _viewshedShadowmap, ivec2 uv) {
return texelFetch(_viewshedShadowmap, uv, 0).r;
}
float viewshedFilterShadow(sampler2D _viewshedShadowmap, vec2 uv) {
vec2 uvScaled = uv * vec2(textureSize(_viewshedShadowmap, 0));
vec2 st    = fract(uvScaled);
ivec2 base = ivec2(uvScaled);
float s00 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x,     base.y    ));
float s10 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x + 1, base.y    ));
float s11 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x + 1, base.y + 1));
float s01 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x,     base.y + 1));
return mix(mix(s00, s10, st.x), mix(s01, s11, st.x), st.y);
}
float viewshedTextureAtlasLookup(sampler2D _viewshedShadowmap, vec2 uv, vec4 atlasRegion) {
vec2 atlasScale = atlasRegion.zw - atlasRegion.xy;
vec2 uvAtlas = fract(uv) * atlasScale + atlasRegion.xy;
return viewshedFilterShadow(_viewshedShadowmap, uvAtlas);
}
float getDepthFromShadowMap(vec2 uv, int face) {
int index = 4 * face;
float umin = viewshedAtlasRegions[index];
float umax = viewshedAtlasRegions[index + 1];
float vmin = viewshedAtlasRegions[index + 2];
float vmax = viewshedAtlasRegions[index + 3];
vec4 atlasRegion = vec4(umin, vmin, umax, vmax);
return viewshedTextureAtlasLookup(viewshedShadowMap, uv, atlasRegion);
}
struct ViewshedPoint {
int face;
vec2 uv;
bool isWithin;
float orthographicDepth;
};
mat3 rotationMatrix(vec3 axis, float angle)
{
float s = sin(angle);
float c = cos(angle);
float oc = 1.0 - c;
return mat3(
oc * axis.xxz * axis.xyx + vec3(c, axis.zy) * vec3(1., -s, s),
oc * axis.xyy * axis.yyz + vec3(axis.z, c, axis.x) * vec3(s, 1., -s),
oc * axis.zyz * axis.xzz + vec3(axis.yx, c) * vec3(-s, s, 1.)
);
}
float distanceToPlane(vec3 position, vec3 normal) {
return dot(position, normal);
}
bool outsideViewshed(float distance) {
return distance > -viewshedVolumeOffset;
}
bool isWithinViewshed(vec3 position) {
float positionLength = length(position - viewshedObserverOffset);
float farSphereDistance = positionLength - viewshedNearFar[1];
if (outsideViewshed(farSphereDistance)) { return false; }
float nearSphereDistance = viewshedNearFar[0] - positionLength;
if (outsideViewshed(nearSphereDistance)) { return false; }
vec3 westVector = normalize(cross(viewshedUpVector, viewshedTargetVector));
bool leftOfTarget = distanceToPlane(position, westVector) > 0.0;
if (viewshedFOVs[0] < TWO_PI) {
float horAngle = viewshedFOVs[0] / 2.0;
horAngle = leftOfTarget ? horAngle : -horAngle;
vec3 sideVector = viewshedTargetVector * rotationMatrix(viewshedUpVector, horAngle);
bool inFront = distanceToPlane(position, sideVector) > 0.0;
if (inFront) {
vec3 sideNormal = cross(viewshedUpVector, sideVector) * (leftOfTarget ? 1. : -1.);
float sideDistance = distanceToPlane(position, normalize(sideNormal));
if (outsideViewshed(sideDistance)) { return false; }
} else if (viewshedFOVs[0] < PI) { return false; }
}
if (viewshedFOVs[1] < PI) {
float t = dot(viewshedUpVector, position);
vec3 nProjVector = normalize(position - t * viewshedUpVector);
float heading = acos(clamp(dot(normalize(viewshedTargetVector), nProjVector), -1.0, 1.0));
heading = leftOfTarget ? heading : -heading;
bool aboveTarget = distanceToPlane(position, viewshedUpVector) > 0.0;
float verFOV = viewshedFOVs[1] / 2.0;
verFOV = aboveTarget ? -verFOV : verFOV;
mat3 rotateByHeading = rotationMatrix(viewshedUpVector, heading);
vec3 sideVector = viewshedTargetVector * rotationMatrix(westVector, verFOV) * rotateByHeading;
vec3 leftVector = westVector * rotateByHeading;
vec3 sideNormal = cross(sideVector, leftVector) * (aboveTarget ? 1. : -1.);
float sideDistance = distanceToPlane(position, normalize(sideNormal));
if (outsideViewshed(sideDistance)) { return false; }
}
return true;
}
bool getViewshedPoint(vec4 localPosition, out ViewshedPoint point) {
for(int i=0; i < viewshedNumFaces; i++) {
vec2 viewshedUv = getViewshedUv(localPosition, i);
if (viewshedUv.x > 0. && viewshedUv.x < 1. && viewshedUv.y > 0. && viewshedUv.y < 1.) {
float orthoDepth = getOrthographicDepthToViewshed(localPosition, i);
if (orthoDepth >= 0.) {
bool isWithin = isWithinViewshed(localPosition.xyz);
point = ViewshedPoint(i, viewshedUv, isWithin, orthoDepth);
return true;
}
}
}
return false;
}
float normalCosAngle(float linearDepth, vec3 localPosition) {
vec4 normal4 = texture(normalMap, uv);
vec3 normalN = normalize(normal4.xyz * 2.0 - 1.0);
vec3 normal =  normalize((inverseViewNormalMatrix * vec4(normalN, 1.0)).xyz);
vec3 viewingDir = normalize(localPosition);
return dot(normal, viewingDir);
}`),t.main.add(ke`float depth = depthFromTexture(depthTexture, uv);
if (depth >= 1.0 || depth <= 0.0) {
return;
}
float linearDepth = linearizeDepth(depth);
vec4 localPosition = reconstructLocalPosition(gl_FragCoord.xy, linearDepth);
ViewshedPoint point;
bool foundFace = getViewshedPoint(localPosition, point);
if (!foundFace || !point.isWithin) {
return;
}
float viewshedDepth = getDepthFromShadowMap(point.uv, point.face);
float distance = point.orthographicDepth;
bool visible = distance < viewshedDepth;
fragColor = visible ? visibleColor : occludedColor;
float cosAngle = normalCosAngle(linearDepth, localPosition.xyz);
float threshold = -0.01;
if (cosAngle > threshold) {
fragColor = occludedColor;
}`),e}const ua=S(),va=Object.freeze(Object.defineProperty({__proto__:null,ViewshedPassParameters:Ye,build:qt},Symbol.toStringTag,{value:"Module"}));class Rt extends $i{constructor(t,i){super(t,i,new Li(va,()=>xs(()=>Promise.resolve().then(()=>Va),void 0)),Ii)}initializePipeline(){return Ui({colorWrite:ki,blending:Ni})}}let U=class extends Ei{get shadowMap(){return this._shadowMap}get hasViewsheds(){return this._viewsheds.length>0}get _contentPixelRatio(){return this.view.state.contentPixelRatio}get _viewshedsInView(){return this._viewsheds.items.filter(e=>fa(this.view,e))}constructor(e){super(e),this.isDecoration=!1,this._passParameters=new Ye,this._viewsheds=new vi,this._shadowMap=null,this.consumes={required:[Oe.VIEWSHED,"normals"]},this.produces=Oe.VIEWSHED,this.requireGeometryDepth=!0}initialize(){this._shadowMap=new la(this.fboCache),this.addHandles([M(()=>this.view.resolutionScale,e=>{const t=this._shadowMap;t&&(t.settings.textureSizeQuality=e)},R),pe(()=>!this.hasViewsheds,()=>this._shadowMap?.dispose()),M(()=>this._viewshedsInView.map(e=>[e.observerRenderSpace,e.heading,e.tilt,e.farDistance,e.horizontalFieldOfView,e.verticalFieldOfView]),()=>this.requestRender(1),Ft)])}destroy(){this._shadowMap=Xt(this._shadowMap)}precompile(){if(this.hasViewsheds){this.techniques.precompile(Rt);for(const e of this._viewshedsInView)if(this._shadowMap?.isActive(e))return void this.view.stage.renderer.precompileViewshedShadowMap()}}render(e){const t=this.bindParameters,i=this.renderingContext,s=e.find(({name:o})=>o===Oe.VIEWSHED);if(!this.hasViewsheds||!t.depth||this.isDecoration&&!t.decorations)return s;this._passParameters.shadowMap=this._shadowMap??this._passParameters.shadowMap,this._passParameters.normals=e.find(({name:o})=>o==="normals")?.getTexture();const a=this.techniques.get(Rt);if(!a?.compiled)return this.requestRender(1),s;const r=this.view.stage.renderer.isFeatureEnabled(7);for(const o of this._viewshedsInView){if(!this._renderShadowCubeMap(t,o,r)||!this._shadowMap?.ready)continue;const l=this._setupViewshedParameters(o,t.camera);i.bindTechnique(a,t,l),i.bindFramebuffer(s.fbo),i.screen.draw()}return this.shadowMap?.dispose(),s}updateViewsheds(e){const t=this._viewsheds,{removes:i,adds:s}=e;if(i&&(Array.isArray(i)?t.removeMany(i):t.remove(i)),s)if(Array.isArray(s)){const a=s.filter(r=>!t.includes(r));t.addMany(a)}else t.includes(s)||t.add(s)}_renderShadowCubeMap(e,t,i){const s=this._shadowMap;if(!s)return!1;const a=this.view.basemapTerrain.hasStencilEnabledExtents,r=s.start(e.camera,t,i,this._contentPixelRatio,a);return r&&s.faces.forEach(o=>this.view.stage.renderer.renderViewshedShadowMap(o)),s.finish(),r}_setupViewshedParameters(e,t){const i=this._shadowMap;if(!i)return this._passParameters;const s=this._passParameters,a=e.effectiveObserverRenderSpace;s.localOrigin=a,s.observerOffset=P(_a,e.observerRenderSpace,e.effectiveObserverRenderSpace),s.fovs=[y(e.horizontalFieldOfView),y(e.verticalFieldOfView)],s.headingAndTilt=[y(e.heading),y(e.tiltParallelToSurface)],s.upVector=e.tiltedUpVector;const r=ma(e.targetRenderSpace,a);s.targetVector=r;const o=new Array,l=new Array;for(let c=0;c<i.numActiveFaces;c++)Ht(He,i.viewshedViewMatrices[c],a),o.push(...He),wa(i.viewshedProjectionMatrices[c],He,Ct),l.push(...Ct);return s.viewMatrices=o,s.projectionMatrices=l,s.volumeOffset=this.selectedViewshed?.()===e.viewshed?ga(e,this.view,t.eye):0,s}get test(){return{viewsheds:this._viewsheds,shadowMap:this._shadowMap,viewshedsInView:this._viewshedsInView}}};function ma(e,t){const i=v();return P(i,e,t)}function wa(e,t,i){const s=q(.5,.5,.5);return fe(i,s),Ri(i,i,s),j(i,i,e),j(i,i,t),i}function fa(e,t){const i=ps(t.observerRenderSpace,t.farDistanceRenderSpace);return!!e.ready&&e.frustum.intersectsSphere(i)}function ga(e,t,i){if(e==null)return 0;const{observerRenderSpace:s,targetRenderSpace:a}=e,r=Ze(i,s)>Ze(i,a)?e.observer:e.target;return t.pixelSizeAt(r)}n([h()],U.prototype,"selectedViewshed",void 0),n([h()],U.prototype,"isDecoration",void 0),n([h()],U.prototype,"shadowMap",null),n([h()],U.prototype,"hasViewsheds",null),n([h()],U.prototype,"_contentPixelRatio",null),n([h()],U.prototype,"_viewshedsInView",null),n([h()],U.prototype,"consumes",void 0),n([h()],U.prototype,"produces",void 0),U=n([ie("esri.views.3d.webgl-engine.lib.Viewshed")],U);const _a=v(),He=S(),Ct=S();let E=class extends yi{constructor(e){super(e),this.type="viewshed-view-3d",this.analysis=null,this.tool=null,this._selectedViewshed=null,this.viewshedComputedDataHandles=null,this.userOperation=null,this._viewshedRenderNode=null,this._intersector=null}get visible(){return super.visible}set visible(e){super.visible=e}get interactive(){return super.interactive}set interactive(e){super.interactive=e}get selectedViewshed(){return this._selectedViewshed}set selectedViewshed(e){this._unselectOtherViewsheds(e),this._selectedViewshed=e}get selectedViewshedComputedData(){return this.tool?.selectedViewshedComputedData}get _isDecoration(){return!this.parent}initialize(){const e=this.view;this._viewshedRenderNode=new U({view:e,selectedViewshed:()=>this.selectedViewshed??this.tool?.stagedViewshed,isDecoration:this._isDecoration}),this._intersector=new Fi(this.view.state.viewingMode),this._intersector.options.hud=!1,this._intersector.options.store=0,this.viewshedComputedDataHandles=We(()=>this.analysis.viewsheds,t=>{const i=new f({renderCoordsHelper:e.renderCoordsHelper,viewshed:t}),s=Symbol();return this.addHandles([M(()=>({valid:i.valid,canProject:fi(i.observer?.spatialReference,this.view.spatialReference)||gi()}),({valid:a,canProject:r},o)=>{this.visible&&(a&&r?this._addViewshedsToRenderer(i):o?.valid&&o?.canProject&&this._removeViewshedsFromRenderer(i),r||Si(this.analysis,i.observer.spatialReference,Kt.getLogger(this)))},R),...this._createFeatureReferenceHandles(i)],s),{viewshedComputedData:i,remove:()=>{this.removeHandles(s),this._removeViewshedsFromRenderer(i),i.destroy()}}}),this._visualization=new ae({view:e,analysisViewData:this,isDecoration:this._isDecoration}),this.addHandles([M(()=>this.visible,t=>{const i=this.viewshedComputedDataHandles;if(i==null)return;t||(this.selectedViewshed=null);const s=i.map(a=>a.viewshedComputedData).filter(a=>a.valid).toArray();t?this._addViewshedsToRenderer(s):this._removeViewshedsFromRenderer(s)}),M(()=>e.renderCoordsHelper,t=>{this.viewshedComputedDataHandles?.forEach(({viewshedComputedData:i})=>i.renderCoordsHelper=t)}),_s(this,O),pe(()=>this.interactive,()=>{this._unselectOtherViewsheds(this.selectedViewshed)},le)])}destroy(){this.userOperation=ze(this.userOperation),Vs(this),this._visualization=A(this._visualization);const e=this.viewshedComputedDataHandles;e!=null&&this._removeViewshedsFromRenderer(e.map(t=>t.viewshedComputedData).toArray())}_createFeatureReferenceHandles(e){const{view:t}=this;return[M(()=>[t.state.camera,t.slice.plane,e.viewshed.observer,e.targetRenderSpace,e.verticalFieldOfView,e.horizontalFieldOfView,e.feature],()=>{this._updateObserverFromFeature(t,e)},R),this._createElevationUpdateHandle(e),pe(()=>e.needUpdateByFeature,()=>{this._updateObserverFromFeature(t,e),e.needUpdateByFeature=!1})]}_createElevationUpdateHandle(e){const t=(i,s)=>{const{view:a}=this,{observer:r}=e;if(r==null)return;const o=_i(r,a.spatialReference);if(o.pending!=null)return void o.pending.finally(()=>t(i,s));const l=o.geometry;l!=null&&(oi(i,s,At,a.spatialReference),Mi(At,[l.x,l.y])&&(e.needUpdateByFeature=!0))};return this.view.elevationProvider.on("elevation-change",({extent:i,spatialReference:s})=>t(i,s))}async createViewsheds(e){await ot(this,{placementOptions:e,onToolActivated:t=>t.place("multiple")})}place(e){return ot(this,{placementOptions:e,onToolActivated:t=>t.place("single")})}_addViewshedsToRenderer(e){this._viewshedRenderNode.updateViewsheds({adds:e})}_removeViewshedsFromRenderer(e){this._viewshedRenderNode.updateViewsheds({removes:e})}_updateObserverFromFeature(e,t){const i=t.observerRenderSpace,s=t.targetRenderSpace,a=k(v(),i),r={observer:i,observerSurfaceNormal:null,observerAdjusted:a,observerFeatureId:ai(t.feature),target:s,targetSurfaceNormal:null,targetAdjusted:k(v(),s),targetFeatureId:null};ri(e,this._intersector,r,o=>Math.min(o,.05*t.farDistanceRenderSpace)),t.observerRenderSpaceOverride=di(a,i)?null:a}_unselectOtherViewsheds(e){if(e!=null)for(const t of this.view.tools.items)t!==this.tool&&t instanceof O&&(t.analysisViewData.selectedViewshed=null)}get test(){}};n([h({readOnly:!0})],E.prototype,"type",void 0),n([h({constructOnly:!0,nonNullable:!0})],E.prototype,"analysis",void 0),n([h()],E.prototype,"tool",void 0),n([h()],E.prototype,"_selectedViewshed",void 0),n([h()],E.prototype,"selectedViewshed",null),n([h()],E.prototype,"selectedViewshedComputedData",null),n([h()],E.prototype,"viewshedComputedDataHandles",void 0),n([h()],E.prototype,"userOperation",void 0),n([h()],E.prototype,"_visualization",void 0),n([h()],E.prototype,"_viewshedRenderNode",void 0),E=n([ie("esri.views.3d.analysis.ViewshedAnalysisView3D")],E);const Fn=E,At=bi(),Va=Object.freeze(Object.defineProperty({__proto__:null,ViewshedPassParameters:Ye,build:qt},Symbol.toStringTag,{value:"Module"}));export{Fn as default};
