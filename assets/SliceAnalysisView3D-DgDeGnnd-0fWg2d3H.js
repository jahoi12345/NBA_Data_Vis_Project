import{c as H,q as lt,M as J,v as $,U as ft,Y as n,H as l,G as L,ag as Vt,a6 as bt,s as W}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{s as Dt}from"./AnalysisView3D-zhHEgrUR-DZ8OICjY.js";import{H as ot,F as pt,L as ht,D as Mt,T as F,I as ut,V as Ct,q as Et,E as Tt,W as x,N as ct,J as St,a as X,O as xt,k as kt,x as zt,U as g,b as Ht,c as Lt,z as Gt,d as $t,A as It}from"./SlicePlaneMaterial.glsl-Bk_6X0A4-DG6-BzL8.js";import{j as m,l as k,i as P,s as Ot}from"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import{z as d,G as h,e as K,H as Y}from"./RealisticTree.glsl-WN9nrQUl-CRRcYwOn.js";import{o as Z}from"./Layer-DZvC7bne-m1cEC_yw.js";import{i as Rt}from"./BuildingComponentSublayer-DdDDAszP-Bx9ewdTm.js";import{I as At,K as Bt}from"./ShadedColorMaterial.glsl-Cdsx30m0-VRbWQZDd.js";import{s as Ft,w as Kt}from"./screenUtils-BitdhK1O-L0FLPAMi.js";import{e as dt,E as mt,h as Ut}from"./mat4-C96X-Nn0-Do6fKsNS.js";import{L as yt,x as C,A as E,I as Q,k as I,O as tt,V as et,l as it}from"./vec32-CewSdTn3-DHOFKD0R.js";import{t as U,X as jt}from"./collectionUtils-jDyktm0P-ArdXNs6F.js";import{m as vt,s as qt}from"./vec4f64-DPb6J-GU-C7c2DqbZ.js";import{j as at,K as j,P as z,x as O}from"./plane-BNdSPG2o-Cq7jmU6w.js";import{x as Nt}from"./sphere-DLQ6p7mp-DmnRpHXV.js";import{z as c,C as f,v as Jt}from"./vector-B8ZDYGQ6-B1uNywRb.js";import{c as Wt}from"./GraphicOrigin-uE6TDXc9-DqbdmNAV.js";import{j as Xt,b as Yt}from"./Factory-CBIg5Skh-B50LJt1_.js";import{t as st,Z as Zt}from"./RotateManipulator-D6-3UwxH-BhG5xrAM.js";import{l as _t,x as Qt,i as te,m as R,r as A,b as ee,n as ie,p as ae}from"./sliceToolConfig-BnawSSVt-BPWko_GQ.js";import{B as T}from"./dragEventPipeline3D-DqqdeG4y-BLCkBDmN.js";import{a9 as b,ap as D}from"./ShadowCastClear.glsl-CeOT_rAo-iOFMl8eB.js";import{z as se,f as re,B as ne,D as le,u as oe}from"./analysisViewUtils-Z_Z4rbWk-DilCDlu1.js";import{J as S}from"./InteractiveToolBase-DXh7kfgV-R_Z6wqPu.js";import{r as pe}from"./ToolIntersector-BVL3bGrn-Vo_uVU8o.js";import{r as he}from"./lineStippleUtils-CCavR4OV-DESXkwZW.js";import"./Color-CERqXxxY-BuYn26eI.js";import"./mathUtils-PIGhLnI9-B1tKUlUb.js";import"./vec42-B8VM4vXb-BnA9MysM.js";import"./Polygon-D6wEPb3W-CpL9Efjx.js";import"./Extent-CgDMOSRD-CU1qE5Kr.js";import"./Point-BfTTZoMu-BAT2Wq6O.js";import"./index-CTl7hdrJ.js";import"./mat4f64-q_b6UJoq-Dh6sWB_w.js";import"./quat-B7J5v7rV-i-DOMCm_.js";import"./quatf64-CCm9z-pX-CQ7_sSji.js";import"./projectionUtils-BGH_5_I3-BySNUA-B.js";import"./Polyline-CoiTLswR-BLagWJLS.js";import"./Emissions.glsl-B8XKMjLy-DXfiRNVX.js";import"./Texture-CFNZjV2R-lGBztxVp.js";import"./Indices-D0_UQPPr-t1Qev6md.js";import"./BufferView-Cj2sQaht-DuP-iLZg.js";import"./vec2f64-rIxtbMRN-Kai9mK1i.js";import"./frustum-CMzahy3--CFytpSYl.js";import"./aaBoundingBox-Cn49X7ge-DORLZxoS.js";import"./orientedBoundingBox-BLEx7wLU-CPBtS4XC.js";import"./spatialReferenceEllipsoidUtils-D2JabnKt-Cip58jmo.js";import"./InterleavedLayout-B7roQAzV-CC2VYRPC.js";import"./lengthUtils-Dt1_RvOO-bleznLOi.js";import"./date-IqUzANpt-bLKO9IDT.js";import"./projectVectorToVector-Csv3NYZI-BsIKHfQD.js";import"./normalizeUtils-85zLqeMi-DCF9gKvo.js";import"./normalizeUtilsCommon-CnhQye_A-zWtr51r8.js";import"./DefaultLayouts-B8c6Qefj-D-9ZzY5G.js";import"./ColorMaterial.glsl-rhi0cQVb-BUmbct5I.js";import"./MeshLocalVertexSpace-BGd1IdEs-DqCdtROz.js";import"./Graphic-DgGzDmqW-CFzg0c4i.js";import"./getPopupProvider-CmskPttI-C4PqyuPF.js";import"./typeUtils-DqrRcjBx-ZWdHcSIJ.js";import"./typeUtils-CXW_VpOn-BoSnXkME.js";import"./lineMarkers-CDwLe3J6-CNUjJvs3.js";import"./PolygonSymbol3D-BXRHZiCQ-Vi0-2Gvc.js";import"./ExtrudeSymbol3DLayer-DSc1ou2x-CsVYZCeG.js";import"./Font-BwmnW7d2-D-oIm_Md.js";import"./SimpleFillSymbol-CDawtd9z-CWD2KI2D.js";import"./SimpleMarkerSymbol-BGAFRS9_-CVQ5NLIA.js";import"./PictureMarkerSymbol-CaSh-vZk-BNpExnAb.js";import"./TextSymbol-hRGhyDHs-C0NgASym.js";import"./vec3f32-WCVSSNPR-9V6Uhrx-.js";import"./FeatureLayer-BRWpcy_W-BoHEkHsh.js";import"./MultiOriginJSONSupport-Bd1TKmh_-BHNF5tHX.js";import"./FormTemplate-DuPZvaVv-Bo80W65Y.js";import"./Field-Cm_ZejYW-CwJZmSru.js";import"./fieldType-DVUzXtk_-tUuvnZJM.js";import"./workers-BEkgoq8Q-BNWfkyQs.js";import"./intl-DRFqUect-ClAS7BRt.js";import"./FeatureSet-BF7daP96-BqhMUjXs.js";import"./mat4f32-Djp3mnm5-DzYG3LYB.js";import"./DisplayFilteredLayer-DyjtPayS-DEIdkBF3.js";import"./EditBusLayer-rxUbWTiY-BI2sZl38.js";import"./FeatureEffect-mVCOF1v6-NIKVGK4R.js";import"./FeatureFilter-G4_pWMVe-vo0uU6rO.js";import"./Query-BlS0WPDF-BdshFBMz.js";import"./FeatureLayerBase-BUeDgO3U-BWuQV9AM.js";import"./HeightModelInfo-D5IdRvJ2-BK9di2bT.js";import"./OperationalLayer-B6zbJ5nR-sYdHUfAL.js";import"./ElevationInfo-Cw2HaA6E-Br1RWTYu.js";import"./unitConversionUtils-4vB4Ezlp-B0eWR3Ls.js";import"./featureLayerUtils-FKjLNPl_-DLktjSPx.js";import"./asyncUtils-w6KfWU41-HenJ0UOu.js";import"./SimpleRenderer-CEmCWePp-xiwnMlto.js";import"./commonProperties-DbO613LF-DeJ_ZDUB.js";import"./colorRamps-DswZzxkO-BqSFavfl.js";import"./ColorStop-De5gQTjr-C1lw16u9.js";import"./visualVariableUtils-ma4r7Z2K-C4Gu8Tj6.js";import"./defaults3D-C2hXSee1-DVT6WkAf.js";import"./defaults-BDN9qxeN-CCVK4JpS.js";import"./UniqueValueRenderer-JPjz9Qvs-C1w5-GWR.js";import"./RendererLegendOptions-ByGHYLtx-C9PvCikc.js";import"./NormalizationBinParametersMixin-BK9wNkI3-BKYeOhDN.js";import"./LayerFloorInfo-CTubHTci-DKf2wu5F.js";import"./Relationship-CrANqG2c-DztISWOP.js";import"./FeatureReductionLayer-Bhh5MvS_-BFfoYl9g.js";import"./FeatureReductionSelection-Du7o8OIG-DmruV-ou.js";import"./labelingInfo-BYG2hiVF-Dmkr19gA.js";import"./jsonUtils-BCGKNxno-Cm1OfGeu.js";import"./typeUtils-DDFS4uuz-Cx8qHFHN.js";import"./ClassBreaksRenderer-BvgdqtTq-DxMHNS7X.js";import"./LRUCache-fy84PBMi-Y56WPIvD.js";import"./UnknownTimeZone-B697BDFv-CBbtul7O.js";import"./OrderedLayer-DQAUgUTV-CpnQmtbN.js";import"./PortalItem-DnxMlRVo-Dhq4alsp.js";import"./RefreshableLayer-CBbEkZf--CC_b3xaQ.js";import"./TimeInfo-D7ssmbZO-CCS1Im5i.js";import"./TrackableLayer-B-086Hm8-Bm00-8pN.js";import"./FeatureTemplate-Bur8tORn-iLlvjnYm.js";import"./FeatureType-CFJlAOcG-Dk8Ixr4n.js";import"./TitleCreator-BosRD8XX-DSGT-m9r.js";import"./sanitizerUtils-BT_8V5US-CWQWUwZQ.js";import"./versionUtils-BfuZvWmP-BDnOmw3Z.js";import"./I3SLayerDefinitions-BquY6sVj-QHSoIBIq.js";import"./I3SUtil-BtVE6TXz-Cfu4PxXY.js";import"./ImageMaterial.glsl-CrPy6XFt-DT5hEKxs.js";import"./modeUtils-BA-mAwuS-UrytRxLw.js";import"./PooledRBush-Dco5QkUp-DX3CMhf3.js";import"./GraphicsCollection-Bk6M0b7D-ByzFamPI.js";import"./TilemapCache-CjhKW_vj-BYOTuKe8.js";import"./UpdatingHandles-D2RI_3Hb-dwLPjVun.js";import"./Map-AEYszeHg-D2YZkc1e.js";import"./Basemap-CL_uaRmk-ChnHJfg0.js";import"./writeUtils-DEFpwIW1-D44H3UWs.js";import"./CollectionFlattener-D6h2Fkvj-qnUHjb1M.js";import"./resourceExtension-DOTCeiZj-BXiJr75H.js";import"./PolygonCollection-HNNpnBH7-C5NQ6xHr.js";import"./ElevationQuery-DzlYa4L4-BxQXlEAE.js";import"./TileInfo-Bz7QlefV-tjhen9qQ.js";import"./Scheduler-CNrsbccs-Bcg8fWoS.js";import"./constants-D67WmGms-H7IOwEdB.js";import"./floatRGBA-D-Q4FzNN-BzjdY1tU.js";import"./TileKey-C44YQC4_-BW7BBbYp.js";import"./vec2f32-CaVKkSa6-BjkBmyoj.js";import"./Octree-DckBBpQ7-BC8mmFdF.js";import"./axisAngleDegrees-CjbXmycq-LMRXo165.js";import"./edgePreprocessing-D_eX-fWy-CRLN12td.js";import"./vec3-B_phcnZY-DHC7I6xa.js";import"./vec33-CWJeyzxV-Me4sF5XB.js";import"./EditGeometryOperations-DZvKpTU8-cI99RYYJ.js";import"./colorUtils-CeIi7j7j-nwrKvQYb.js";import"./Cyclical-BLSxUpe7-Bj8R2Yk-.js";import"./TriangleMaterial-BIKWylXl-CcDbhy8X.js";import"./aaBoundingRect-CjwcS2F3-D7aII9DY.js";import"./enums-B4pqBiXb-BO-3hS_8.js";import"./VertexElementDescriptor-BlxU8vCE-BwuKQkTU.js";import"./meshVertexSpaceUtils-CtG7DPVT-V_uCtHpB.js";import"./jsonUtils-CmpazY1u-ateEpj4Q.js";import"./DoubleArray-DExKNiTh-CvVpHySW.js";import"./memoryEstimations-Bd726a_p-0cVCY2Jz.js";import"./HUDIntersectorResult-1xTExS7z-CU1-YQoW.js";import"./Intersector-DS9YtyQY-CuzM48xl.js";import"./projectPointToVector-DL7Z4uvb-BbcUuq8O.js";import"./reader-DcGs6kKN-DHJfK-tm.js";import"./SimpleObservable-CvFyr0NA-DXpoMYph.js";import"./utils-CylVuxNi-CqOfmBVG.js";import"./utils-Dpg4yj1D-BVnuoMV8.js";import"./videoUtils-Dwx3AEgj-CduhpDRk.js";import"./types-BKo2foNY-DE0QfIFp.js";import"./createFeatureId-CVwTD0fV-3fKpJDrk.js";import"./opacityUtils-DuFH0EC9-DWspTgn2.js";import"./computeTranslationToOriginAndRotation-Bjd4esRf-CXUng2L4.js";import"./capabilities-Cs4k8cuT-Cq70vfK_.js";import"./fieldProperties-BoJj55FN-yR5ddqST.js";import"./FieldsIndex-CimK-TqD-CrSnohIk.js";import"./timeZoneUtils-BSc7-7qA-BAv3h8mh.js";import"./I3SIndexInfo-B2NvYFjS-O54px-TX.js";import"./popupUtils-D4UavgYz-4fibcgIL.js";import"./popupUtils-BKHMiD6K-B1dsckbj.js";import"./VisualElement-By4iq8p4-ZBataKFH.js";import"./line-DShd3yGd-Vds7wO8W.js";import"./elevationInfoUtils-B8MpdRMP-CN_w2fPT.js";import"./scaleUtils-yfx9kKWT-BPfZ-Fh2.js";import"./layerUtils-DZGhvm-W-DLw3QMll.js";import"./tagSymbols-BPcGfZon-BPcGfZon.js";import"./Queue-CYlrXMwB-CYJTUII-.js";import"./signal-BX9ezF8a-cf1Pn6io.js";import"./ReactiveMap-B0by2bYu-DCsCfMj5.js";import"./TablesMixin-Q80MT3nU-CFBTh0j7.js";import"./layerViewUtils-BTa15X3o-BjQlX2q8.js";import"./dehydratedFeatures-Ql-uVzLq-DehgeO5I.js";import"./quantizationUtils-Ceq-Uxsu-CDK8m1qL.js";import"./featureConversionUtils-BDA_FXJx-CUwkrHf5.js";import"./OptimizedFeature-CwRGZPwv-Ddclhn0A.js";import"./OptimizedFeatureSet-BR8EEvDc-CgsRgxJh.js";import"./intersectorUtilsConversions-pLQPEbcN-rV-4Q5_m.js";import"./DefaultLoadingContext-DXgBe4GE-Colk9t6X.js";import"./wosrLoader-CIPfz1Cl-qtGxLmBP.js";import"./Version-BtYZEj58-LyRHDnSJ.js";import"./config-Dg972SSE-D9DBKeq5.js";import"./GeometryUtils-C354xUs0-CG8X9WjO.js";import"./definitions-Dvg4hMIw-CdK2DzFN.js";import"./WorkerHandle-B930SiRy-b7IwaSpV.js";import"./capabilities-Bi6C4OG6-CpURufko.js";import"./imageUtils-142g71N8-CjUugWaS.js";import"./uuid-Oe6SV2kF-IYX19xBA.js";import"./quickselect-QQC62dOK-Br2Ahhru.js";import"./TileKey-CXWFOqOI-CcilLir8.js";import"./loadAll-BCyxerwc-DK9uHnLK.js";import"./persistable-CdoDQOTR-CH9U-JJT.js";import"./MD5-MtSiOt06-jWr180Yc.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw-DH8sdIsE.js";import"./labelUtils-BtizwBfq-Zegx4520.js";import"./ArcadeExpression-BlIRq-oN-DGzfhzBj.js";import"./TimeOnly-BERR31kg-PKcKegNB.js";import"./enum-BzLwmiID-CcyIdWlQ.js";import"./layerContainerType-CSXZNpHb-BIF7XAYP.js";import"./isFeatureGraphicOrigin-YA2hudPe-Bk2FjH_E.js";import"./editsZScale-D3N5iH_c-CePEFiUi.js";import"./queryZScale-CRP3Sh_E-0yf18ElE.js";import"./APIKeyMixin--YGbad8e-DJ-JJTX5.js";import"./ArcGISService-SIwch9bz-BD00xz4C.js";import"./BlendLayer-HE_aYHHW-CZa4IAJu.js";import"./jsonUtils-CY6YsQMo-SliJcuqs.js";import"./CustomParametersMixin-Dshqz1Zp-BFC165kX.js";import"./FeatureEffectLayer-BG_KTtPw-CZiOOvL9.js";import"./PortalLayer-CbFNhtZ4-CCXE0v4V.js";import"./portalItemUtils-CaPNUJg6-JsqddoLx.js";import"./ScaleRangeLayer-DQr2T3Hh-Dh1UYk4i.js";import"./TemporalLayer-D4R0YvXo-CzgQNAIr.js";import"./serviceCapabilitiesUtils-BV_pcUiO-CjqWUbfp.js";import"./infoFor3D-DhzudQro-CCYgWfsv.js";import"./styleUtils-CZJC3pZm-BNE6B1Si.js";import"./displayFilterUtils-CIXGrQzt-Ck5cgHqb.js";import"./multiLayerServiceUtils-CpHWiXA7-B9JDcSQL.js";import"./featureQueryAll-BfDWA5Wx-ZgjJqs6l.js";import"./jsonUtils-C9q_FK4K-Cuz7ImzI.js";import"./defaultsJSON-GKolV7NZ-GKolV7NZ.js";import"./diffUtils-wTC1YzlE-JuqUWoWa.js";import"./styleUtils-DWvicjTN-DYvOM9HS.js";import"./DictionaryScriptEvaluator-G73uSGpN-Cn2sp0hZ.js";import"./utils-DX2muIr3-DiPfFKSl.js";import"./heatmapUtils-B-AXnq0l-G7fD8L97.js";import"./featurePopupQueryUtils-CnnY2XPA-CIuoWQ_Y.js";import"./I3SBinaryReader-ZmgM2p_h-BnxBvCpV.js";import"./geometry2dUtils-B4vDf2wH-D5Eyn-ve.js";import"./rotate-CKztRS_J-BP1oc49D.js";import"./curveOperationUtils-BGqPT1bh-COCfpJm1.js";function ue(t){switch(t.type){case"building-scene":case"catalog":case"catalog-dynamic-group":case"catalog-footprint":case"csv":case"dimension":case"feature":case"gaussian-splat":case"geo-rss":case"geojson":case"graphics":case"group":case"integrated-mesh":case"integrated-mesh-3dtiles":case"kml":case"knowledge-graph":case"link-chart":case"knowledge-graph-sublayer":case"line-of-sight":case"map-notes":case"ogc-feature":case"oriented-imagery":case"point-cloud":case"route":case"scene":case"stream":case"viewshed":case"voxel":case"subtype-group":case"unknown":case"unsupported":case"wfs":case"parquet":case null:case"imagery":case"imagery-tile":return!1;case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"elevation":case"map-image":case"media":case"open-street-map":case"tile":case"vector-tile":case"video":case"wcs":case"web-tile":case"wms":case"wmts":return!0;default:return ft(t.type),!1}}let _=class extends lt{constructor(t){super(t),this._internalChange=!1,this._currentSlicePlane=null}initialize(){this.addHandles(this.analysis.excludedLayers.on("before-add",t=>{const e=t.item;e!=null&&(e instanceof Z||e instanceof Rt)?e instanceof Z&&ue(e)?($.getLogger(this).error("excludedLayers",`Layer '${e.title}, id:${e.id}' of type '${e.type}' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead.`),t.preventDefault()):this.analysis.excludedLayers.includes(e)&&t.preventDefault():($.getLogger(this).error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),t.preventDefault())})),me(this.view,this),this.addHandles([m(()=>this.analysisViewData.plane,()=>{this._internalChange||this._updateSlicePlaneFromBoundedPlane(),this._updateLayerViews()},P),m(()=>this.analysis.excludeGroundSurface,()=>this._updateLayerViews(),P),this.analysis.excludedLayers.on("change",()=>this._updateLayerViews()),m(()=>[this.analysisViewData.active,this.analysisViewData.visible],()=>{this._updateActiveController(),this._updateViewSlicePlane(),this._updateViewSlicePlaneDecoration()},P),m(()=>this._allLayerAndSubLayerViews,()=>this._updateLayerViews())]),this.addHandles([m(()=>this.analysis.shape,()=>{this._internalChange||(this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane())},P),m(()=>this.analysis.origin?.type!=="web-scene",()=>this._updateViewSlicePlaneDecoration(),P)],"analysis"),this._updateActiveController(),this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane(),this._updateViewSlicePlaneDecoration()}destroy(){this.analysisViewData.active&&(this.analysisViewData.active=!1,this.view.slice.plane=null,this._updateActiveController(),this._updateViewSlicePlane()),ye(this.view,this),this.set("view",null)}get _allLayerAndSubLayerViews(){const t=this.view.allLayerViews.items;return t.concat(t.filter(Ct).flatMap(({sublayerViews:e})=>e.items))}_updateBoundedPlaneFromSlicePlane(){const t=this.analysis.shape,e=this._currentSlicePlane;if(e==null&&t==null||e!=null&&t!=null&&t.equals(e))return;let i=null,a=null;if(t?.position!=null){const s=t.position.spatialReference,r=Et(t,this.view);r==null&&At(this.analysis,s,$.getLogger(this)),i=Tt(r,this.view,{tiltEnabled:this.analysis.tiltEnabled},d()),i!=null&&(a=new x({heading:t.heading,tilt:t.tilt,position:t.position,width:t.width,height:t.height}))}this._currentSlicePlane=a,this._internalChange=!0,this.analysisViewData.plane=i,this._internalChange=!1}_updateSlicePlaneFromBoundedPlane(){const t=this.analysisViewData.plane,e=ct(t,this.view,this.view.spatialReference,new x);let i=null;e!=null&&(i=new x({heading:e.heading,tilt:e.tilt,position:e.position,width:e.width,height:e.height})),this._currentSlicePlane=i,this._internalChange=!0,this.analysis.shape=e,this._internalChange=!1,this._updateViewSlicePlane()}_updateActiveController(){if(B)return;const t=N(this.view);if(t)if(this.analysisViewData.active)t.activeController!=null&&t.activeController!==this?(B=!0,t.activeController.analysisViewData.active=!1,B=!1):t.activeController!=null&&t.activeController,this._updateLayerViews(),t.activeController=this;else{if(t.activeController!=null&&t.activeController!==this)return;t.activeController!=null&&t.activeController===this&&(t.activeController=null,this._updateLayerViews())}}_updateViewSlicePlane(){ce(this.view)}_updateViewSlicePlaneDecoration(){de(this.view)}_updateLayerViews(){const t=this.analysisViewData.plane!=null&&this.analysisViewData.visible&&this.analysisViewData.active,e=[],i=a=>{"layers"in a?a.layers.forEach(i):e.push(a)};this.analysis.excludedLayers.forEach(i),this.view.allLayerViews.forEach(a=>{a.destroyed||("slicePlaneEnabled"in a&&(a.slicePlaneEnabled=t&&!e.includes(a.layer)),"sublayerViews"in a&&a.sublayerViews.forEach(s=>{s.slicePlaneEnabled=t&&!e.includes(s.sublayer)}))}),this.view.basemapTerrain!=null&&(this.view.basemapTerrain.slicePlaneEnabled=t&&!this.analysis.excludeGroundSurface)}};n([l()],_.prototype,"view",void 0),n([l()],_.prototype,"analysis",void 0),n([l()],_.prototype,"analysisViewData",void 0),n([l()],_.prototype,"_allLayerAndSubLayerViews",null),_=n([L("esri.views.3d.analysis.Slice.SliceController")],_);const w=new Map;let B=!1;function ce(t){const e=N(t),i=e?.activeController;i?.analysisViewData.plane!=null&&i.analysisViewData.visible?t.slice.plane=i.analysisViewData.plane:t.slice.plane=null}function de(t){const e=N(t),i=e?.activeController;t.slice.isDecoration=i?.analysis.origin?.type!=="web-scene"}function me(t,e){w.has(t)||w.set(t,{all:[],activeController:null}),w.get(t)?.all.push(e)}function N(t){return w.get(t)}function ye(t,e){if(!w.has(t))throw new Error("view expected in global slice register");const i=w.get(t),a=i?.all.lastIndexOf(e)??-1;if(!i||a===-1)throw new Error("controller expected in global slice register");i.all.splice(a,1),i.all.length===0&&w.delete(t)}var q;let o=class extends oe{static{q=this}constructor(t){super(t),this._clock=Vt,this._previewPlaneOpacity=1,this.removeIncompleteOnCancel=!1,this._mode="none",this.shiftManipulator=null,this.rotateHeadingManipulator=null,this.rotateTiltManipulator=null,this.resizeManipulators=null,this._frameTask=null,this._pointerMoveTimerMs=te,this._prevPointerMoveTimeout=null,this._previewPlaneGridVisualElement=null,this._previewPlaneOutlineVisualElement=null,this._startPlane=d(),this._previewPlane=null,this._activeKeyModifiers={},this._lastCursorPosition=Ft(),this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._intersector=pe(t.view.state.viewingMode)}initialize(){if(this.analysis==null)throw new Error("SliceTool requires valid analysis, but null was provided.");const t=r=>{this._updateManipulatorsInteractive(r),r.grabbing||(this.analysisViewData.plane!=null&&h(this.analysisViewData.plane,this._startPlane),this.inputState=null)},e=new St(this.view,1);this.shiftManipulator=e,this.manipulators.add(e),this.addHandles([this._createShiftDragPipeline(e),e.events.on("grab-changed",r=>{this._onShiftGrab(r),t(e)})]);const i=!this.view.stage?.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result,a=new st(this.view,(r,p)=>Xt(this.view.stage.textures,{accentColor:r,contrastColor:p,preMultiplyAlpha:i}));this.rotateHeadingManipulator=a,this.manipulators.add(a),this.addHandles([this._createRotateHeadingDragPipeline(a),a.events.on("grab-changed",r=>{this._onRotateHeadingGrab(r),t(a)})]);const s=new st(this.view,(r,p)=>Yt(this.view.stage.textures,{accentColor:r,contrastColor:p,preMultiplyAlpha:i}));this.rotateTiltManipulator=s,this.manipulators.add(s),this.addHandles([this._createRotateTiltDragPipeline(s),s.events.on("grab-changed",r=>{this._onRotateTiltGrab(r),t(s)})]),this.resizeManipulators=this._resizeHandles.map((r,p)=>{const y=new Zt(this.view,r);return this.addHandles([this._createResizeDragPipeline(y),y.events.on("grab-changed",V=>{this._onResizeGrab(V,p),t(y)})]),y}),this.manipulators.addMany(this.resizeManipulators),this._previewPlaneGridVisualElement=ot(this.view),this._previewPlaneOutlineVisualElement=pt(this.view),this._previewPlaneOutlineVisualElement.width=_t,this.addHandles(m(()=>[this.analysisViewData.plane,this.analysis.tiltEnabled],()=>this._updateManipulators(),P)),this.addHandles([Ot(()=>this.state==="sliced",()=>{this.finishToolCreation(),this.stop()},k),m(()=>this.view.state.camera,()=>this._onCameraChange())])}destroy(){this._removeFrameTask(),this._clearPointerMoveTimeout(),this._previewPlaneOutlineVisualElement=H(this._previewPlaneOutlineVisualElement),this._previewPlaneGridVisualElement=H(this._previewPlaneGridVisualElement)}get state(){const t=!!this.analysisViewData.plane,e=!!this.inputState;return t?t&&e?"slicing":t&&!e?"sliced":"ready":"ready"}get cursor(){return this.active?this._placingSlicePlane||this.mode==="exclude"?"crosshair":this._creatingPointerId!=null?"grabbing":null:null}set analysis(t){if(t==null)throw new Error("SliceTool requires valid analysis, but null was provided.");this.removeHandles("analysis"),this._set("analysis",t)}get mode(){return this._mode}static{this.disableEngineLayers=!1}get inputState(){return this._get("inputState")}set inputState(t){this._set("inputState",t),this.analysisViewData.showGrid=t!=null&&t.type==="resize",this._updateMaterials()}get _placingSlicePlane(){return this.active&&!this.inputState&&this._mode==="place"}get _creatingPointerId(){return this.inputState!=null&&this.inputState.type==="shift"?this.inputState.creatingPointerId:null}start(t){this._finishToolCreationIfValid(),this._mode=t,this.active||(this.view.activeTool=this)}stop(){this.active&&(this.view.activeTool=null)}onActivate(){this._finishToolCreationIfValid(),this._mode==="none"&&this.analysisViewData.plane==null&&(this._mode="place")}onDeactivate(){this._mode="none",this._updatePreviewPlane(null)}onShow(){this._updateVisibility(!0)}onHide(){this._updateVisibility(!1)}_updateVisibility(t){this._updateManipulators(),t||this._clearPointerMoveTimeout()}onInputEvent(t){switch(t.type){case"pointer-drag":if(!nt(t))return;this._placingSlicePlane?this._onClickPlacePlane(t)&&t.stopPropagation():this._onPointerDrag(t)&&t.stopPropagation();break;case"pointer-move":this._onPointerMove(t);break;case"pointer-up":this._onPointerUp(t)&&t.stopPropagation();break;case"immediate-click":if(!nt(t))return;this._mode==="exclude"?t.defer(async()=>{await this._onClickExcludeLayer(t)&&t.stopPropagation()}):this._onClickPlacePlane(t)&&t.stopPropagation();break;case"drag":this.inputState&&t.stopPropagation();break;case"key-down":this._onKeyDown(t)&&t.stopPropagation();break;case"key-up":this._onKeyUp(t)&&t.stopPropagation()}}onEditableChange(){this.analysisViewData.editable=this.internallyEditable}_onPointerDrag(t){const e=this.inputState;if(t.pointerId===this._creatingPointerId&&e!=null&&e.type==="shift"){const i=b(t);return this.shiftManipulator.events.emit("drag",{action:e.hasBeenDragged?"update":"start",pointerType:t.pointerType,start:i,screenPoint:i}),e.hasBeenDragged=!0,!0}return!1}_onPointerMove(t){this._lastCursorPosition.x=t.x,this._lastCursorPosition.y=t.y,this._resetPointerMoveTimeout(),t.pointerType!=="touch"&&this._updatePreviewPlane(b(t),this._activeKeyModifiers)}_onCameraChange(){this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),this._updateManipulators()}_onPointerUp(t){if(t.pointerId===this._creatingPointerId&&this.analysisViewData.plane!=null){const e=b(t);return this.shiftManipulator.events.emit("drag",{action:"end",start:e,screenPoint:e}),h(this.analysisViewData.plane,this._startPlane),this.inputState=null,!0}return!1}_onClickPlacePlane(t){if(!this._placingSlicePlane)return!1;const e=b(t),i=d();if(this._pickPlane(e,!1,this._activeKeyModifiers,i)){if(t.type==="pointer-drag"){const a=D(this.view.state.camera,e,M);this.inputState=rt(a,t.pointerId,i.origin,i)}return h(i,this._startPlane),this.analysis.shape=ct(i,this.view,this.view.spatialReference,new x),t.type!=="pointer-drag"&&this.stop(),!0}return!1}async _onClickExcludeLayer(t){if(this.mode!=="exclude")return!1;const e=await this.view.hitTest(b(t)),i=e.results.at(0);if(i){const a=i.type==="graphic"&&i.graphic;if(a){const s=Wt(a.origin)??a.sourceLayer??a.layer;s&&s.type!=="subtype-sublayer"&&this.analysis.excludedLayers.push(s)}}else e.ground.layer?this.analysis.excludedLayers.push(e.ground.layer):this.analysis.excludeGroundSurface=!0;return this.stop(),!0}_onKeyDown(t){return(t.key===R||t.key===A)&&(this._activeKeyModifiers[t.key]=!0,this._previewPlane!=null&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onKeyUp(t){return!(t.key!==R&&t.key!==A||!this._activeKeyModifiers[t.key])&&(delete this._activeKeyModifiers[t.key],this._previewPlane!=null&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onShiftGrab(t){if(t.action!=="start"||this.analysisViewData.plane==null||!t.screenPoint)return;const e=D(this.view.state.camera,t.screenPoint,M);h(this.analysisViewData.plane,this._startPlane),this.inputState=rt(e,null,this.shiftManipulator.renderLocation,this.analysisViewData.plane)}_createShiftDragPipeline(t){return S(t,(e,i,a)=>{const s=this.inputState;if(s==null||s.type!=="shift")return;const r=this.analysisViewData.plane!=null?h(this.analysisViewData.plane,d()):null;i.next(T(this.view,s.shiftPlane)).next(this._shiftDragAdjustSensitivity(s)).next(this._shiftDragUpdatePlane(s)),a.next(()=>{r!=null&&this._updateBoundedPlane(r)})})}_shiftDragAdjustSensitivity(t){return e=>{if(this.analysisViewData.plane==null)return null;const i=.001,a=Math.min((1-Math.abs(E(K(this.analysisViewData.plane),e.ray.direction)/C(e.ray.direction)))/i,1),s=-at(this._startPlane.plane,e.renderEnd),r=-at(this._startPlane.plane,t.startPoint);return t.depth=t.depth*(1-a)+s*a-r,e}}_shiftDragUpdatePlane(t){return()=>{if(this.analysisViewData.plane==null)return;const e=Q(c.get(),this._startPlane.origin),i=Q(c.get(),K(this._startPlane));I(i,i,-t.depth),tt(i,i,e);const a=Y(i,this.analysisViewData.plane.basis1,this.analysisViewData.plane.basis2,d());this._updateBoundedPlane(a)}}_onRotateHeadingGrab(t){if(t.action!=="start"||this.analysisViewData.plane==null||!t.screenPoint)return;const e=X(this.analysisViewData.plane,this.view.renderCoordsHelper,1,j()),i=D(this.view.state.camera,t.screenPoint,M),a=U();z(e,i,a)&&(h(this.analysisViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:e,startPoint:a})}_createRotateHeadingDragPipeline(t){return S(t,(e,i,a)=>{const s=this.inputState;if(s==null||s.type!=="rotate")return;const r=this.analysisViewData.plane!=null?h(this.analysisViewData.plane,d()):null;i.next(T(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdatePlaneFromRotate()),a.next(()=>{r!=null&&this._updateBoundedPlane(r)})})}_onRotateTiltGrab(t){if(t.action!=="start"||this.analysisViewData.plane==null||!t.screenPoint)return;const e=X(this.analysisViewData.plane,this.view.renderCoordsHelper,2,j()),i=D(this.view.state.camera,t.screenPoint,M),a=U();z(e,i,a)&&(h(this.analysisViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:e,startPoint:a})}_createRotateTiltDragPipeline(t){return S(t,(e,i,a)=>{const s=this.inputState;if(s==null||s.type!=="rotate")return;const r=this.analysisViewData.plane!=null?h(this.analysisViewData.plane,d()):null;i.next(T(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdatePlaneFromRotate()),a.next(()=>{r!=null&&this._updateBoundedPlane(r)})})}_rotateDragRenderPlaneToRotate(t){return e=>{if(this.analysisViewData.plane==null)return null;const i=O(t.rotatePlane),a=Bt(t.startPoint,e.renderEnd,this.analysisViewData.plane.origin,i);return{...e,rotateAxis:i,rotateAngle:a}}}_rotateDragUpdatePlaneFromRotate(){return t=>{if(this.analysisViewData.plane==null)return;const e=Ut(f.get(),t.rotateAngle,t.rotateAxis);if(e==null)return;const i=et(c.get(),this._startPlane.basis1,e),a=et(c.get(),this._startPlane.basis2,e),s=Y(this.analysisViewData.plane.origin,i,a,d());this._updateBoundedPlane(s)}}_onResizeGrab(t,e){if(t.action!=="start"||this.analysisViewData.plane==null||!t.screenPoint)return;const i=D(this.view.state.camera,t.screenPoint,M),a=c.get();z(this.analysisViewData.plane.plane,i,a)&&(h(this.analysisViewData.plane,this._startPlane),this.inputState={type:"resize",activeHandleIdx:e,startPoint:jt(a)})}_createResizeDragPipeline(t){return S(t,(e,i,a)=>{const s=this.inputState;if(s==null||s.type!=="resize"||this.analysisViewData.plane==null)return;const r=h(this.analysisViewData.plane,d());i.next(T(this.view,this.analysisViewData.plane.plane)).next(this._resizeDragUpdatePlane(s)),a.next(()=>{this._updateBoundedPlane(r)})})}_resizeDragUpdatePlane(t){return e=>{if(this.analysisViewData.plane==null)return;const i=this._resizeHandles[t.activeHandleIdx],a=xt(i,t.startPoint,e.renderEnd,this.view.state.camera,this._startPlane,h(this.analysisViewData.plane));this._updateBoundedPlane(a)}}_updateBoundedPlane(t){const e=this.analysisViewData;if(e==null)throw new Error("valid internal object expected");e.plane=t}_updatePreviewPlane(t,e={}){if(this.mode==="exclude")return;let i=this._previewPlane;if(this._previewPlane=null,t==null)return this._removeFrameTask(),void this._updateManipulators();if(this.active){const a=i??d();if(i=i!=null?h(i,ve):null,this._pickPlane(t,!0,e,a)){const s=ie;let r=!1;i!=null&&(r=E(O(i.plane),O(a.plane))<s||E(it(c.get(),i.basis1),it(c.get(),a.basis1))<s),r&&(this._previewPlaneOpacity=0),this._previewPlane=a}}this._previewPlane!=null&&this._frameTask==null&&this._previewPlaneOpacity===0?this._frameTask=bt({update:({deltaTime:a})=>{this._previewPlaneOpacity=Math.min(this._previewPlaneOpacity+a/(1e3*ee),1),this._updateManipulators(),this._previewPlaneOpacity===1&&this._removeFrameTask()}}):this._previewPlane==null&&this._frameTask!=null?this._removeFrameTask():this._previewPlane!=null&&this._updateManipulators()}_removeFrameTask(){this._frameTask=W(this._frameTask)}_pickMinResult(t){const e=Kt(t,Jt.get());return this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(e,this._intersector),this._intersector.results.min}_pickPlane(t,e,i,a){const s=this._pickMinResult(t),r=c.get();if(!s.getIntersectionPoint(r))return!1;const p=s.getTransformedNormal(c.get()),y=this.view.state.camera;E(p,y.viewForward)>0&&I(p,p,-1);const V=kt(r,y),wt=(e?1:-1)*V*ae,G=I(c.get(),p,wt);tt(G,G,r);const gt=this.analysis.tiltEnabled?3:0,Pt=i[R]?2:i[A]?1:gt;return zt(G,p,V,V,y,Pt,this.view.renderCoordsHelper,a),!0}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=W(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.shiftManipulator.state|=g,this.rotateHeadingManipulator.state|=g,this.rotateTiltManipulator.state|=g,this._prevPointerMoveTimeout=this._clock.setTimeout(()=>{this.shiftManipulator.state&=~g,this.rotateHeadingManipulator.state&=~g,this.rotateTiltManipulator.state&=~g},this._pointerMoveTimerMs)}_updateManipulators(){if(q.disableEngineLayers)return;let t,e,i=!1;if(this.analysisViewData.plane!=null)t=this.analysisViewData.plane,e=this._previewPlane??t,i=!1;else{if(this._previewPlane==null)return this._setManipulatorVisibility(!1),void this._setPreviewPlaneVisibility(!1);e=t=this._previewPlane,i=!0}if(this._setManipulatorVisibility(!i),!i){const a=F(t,f.get());Ht(this.shiftManipulator,a,t,this.view.state.camera),Lt(this.rotateHeadingManipulator,a,t,this.view.renderCoordsHelper),Gt(this.rotateTiltManipulator,a,t),this.resizeManipulators.forEach((s,r)=>$t(s,this._resizeHandles[r],a,t))}this._setPreviewPlaneVisibility(!this._creatingPointerId&&(i||this._mode==="place")),this._updatePreviewPlaneTransform(e),this._updateMaterials()}_setManipulatorVisibility(t){this.shiftManipulator.available=t,this.rotateHeadingManipulator.available=t,this.rotateTiltManipulator.available=t&&this.analysis.tiltEnabled,this.resizeManipulators.forEach(e=>e.available=t)}_updatePreviewPlaneTransform(t){const e=F(t,f.get()),i=yt(c.get(),C(t.basis1),C(t.basis2),1),a=dt(f.get(),i),s=mt(a,e,a);this._previewPlaneOutlineVisualElement.transform=s,this._previewPlaneGridVisualElement.transform=s}_setPreviewPlaneVisibility(t){const e=this._previewPlaneOutlineVisualElement,i=this._previewPlaneGridVisualElement;t&&(e.attached=!0,i.attached=!0),e.visible=t,i.visible=t}_updateMaterials(){const t=ht(this.view.effectiveTheme);t[3]*=this._previewPlaneOpacity;const e=qt(ut);e[3]*=this._previewPlaneOpacity,this._previewPlaneOutlineVisualElement.color=t,this._previewPlaneGridVisualElement.backgroundColor=e,this._previewPlaneGridVisualElement.gridColor=vt}_updateManipulatorsInteractive(t){if(!t.grabbing)return this.shiftManipulator.interactive=!0,this.rotateHeadingManipulator.interactive=!0,this.rotateTiltManipulator.interactive=!0,void this.resizeManipulators.forEach(e=>{e.interactive=!0});this.shiftManipulator.interactive=this.shiftManipulator===t,this.rotateHeadingManipulator.interactive=this.rotateHeadingManipulator===t,this.rotateTiltManipulator.interactive=this.rotateTiltManipulator===t,this.resizeManipulators.forEach(e=>{e.interactive=e===t})}_finishToolCreationIfValid(){this.analysis.valid&&this.finishToolCreation()}get test(){return{plane:this.analysisViewData.plane,setPointerMoveTimerMs:t=>{this._pointerMoveTimerMs=t}}}};function rt(t,e,i,a){const s=It(i,K(a),t.direction,j()),r=U();return z(s,t,r)?{type:"shift",creatingPointerId:e,hasBeenDragged:!1,shiftPlane:s,depth:0,startPoint:r}:null}function nt(t){return t.pointerType!=="mouse"||t.button===0}n([l()],o.prototype,"_clock",void 0),n([l({constructOnly:!0})],o.prototype,"view",void 0),n([l()],o.prototype,"analysisViewData",void 0),n([l({readOnly:!0})],o.prototype,"state",null),n([l({readOnly:!0})],o.prototype,"cursor",null),n([l()],o.prototype,"analysis",null),n([l()],o.prototype,"removeIncompleteOnCancel",void 0),n([l()],o.prototype,"_mode",void 0),n([l()],o.prototype,"mode",null),n([l({value:null})],o.prototype,"inputState",null),n([l()],o.prototype,"_placingSlicePlane",null),n([l()],o.prototype,"_creatingPointerId",null),o=q=n([L("esri.views.3d.analysis.Slice.SliceTool")],o);const ve=d(),M=Nt();let v=class extends lt{constructor(t){super(t),this._gridVisualElement=null,this._outlineVisualElement=null,this.showGrid=!1,this.preview=!0}initialize(){const t=this.analysisViewData;if(t==null)throw new Error("expected internal object to be valid");this._gridVisualElement=ot(this.view),this._outlineVisualElement=pt(this.view),this.addHandles([m(()=>{const e=t.plane!=null&&this.analysisViewData.visible,{active:i}=this.analysisViewData,{preview:a,showGrid:s,view:r}=this,{effectiveTheme:p}=r;return{visible:e,active:i,preview:a,showGrid:s,gridColor:Mt(p),outlineColor:ht(p)}},e=>this._updateMaterials(e),k),m(()=>t.plane,e=>this._updatePlane(e),k),J(this._gridVisualElement),J(this._outlineVisualElement),m(()=>this.analysis?.origin?.type!=="web-scene",e=>{this._gridVisualElement.isDecoration=e,this._outlineVisualElement.isDecoration=e},k)])}destroy(){this.set("view",null)}_updatePlane(t){if(t==null)return;this._gridVisualElement.attached=!0,this._outlineVisualElement.attached=!0;const e=yt(c.get(),C(t.basis1),C(t.basis2),1),i=dt(f.get(),e),a=F(t,f.get()),s=mt(i,a,i);this._outlineVisualElement.transform=s,this._gridVisualElement.transform=s}_updateMaterials({visible:t,active:e,preview:i,showGrid:a,gridColor:s,outlineColor:r}){this._outlineVisualElement.color=r,this._outlineVisualElement.width=i?_t:Qt,this._outlineVisualElement.stipplePattern=e?null:he(5),this._gridVisualElement.backgroundColor=ut,this._gridVisualElement.gridColor=a?s:vt,this._gridVisualElement.visible=t,this._outlineVisualElement.visible=t}};n([l()],v.prototype,"view",void 0),n([l()],v.prototype,"analysis",void 0),n([l()],v.prototype,"analysisViewData",void 0),n([l()],v.prototype,"showGrid",void 0),n([l()],v.prototype,"preview",void 0),v=n([L("esri.views.3d.analysis.Slice.SliceVisualization")],v);let u=class extends Dt{constructor(t){super(t),this.type="slice-view-3d",this.analysis=null,this.tool=null,this.plane=null,this.active=!0,this.userOperation=null,this._analysisVisualization=null,this._analysisController=null}initialize(){this._analysisVisualization=new v({view:this.view,analysis:this.analysis,analysisViewData:this}),this._analysisController=new _({view:this.view,analysis:this.analysis,analysisViewData:this}),this.addHandles(se(this,o))}destroy(){re(this),this._analysisVisualization=H(this._analysisVisualization),this._analysisController=H(this._analysisController)}get visible(){return super.visible}set visible(t){super.visible=t}get interactive(){return super.interactive}set interactive(t){super.interactive=t}get editable(){return!this._analysisVisualization.preview}set editable(t){this._analysisVisualization.preview=!t}get showGrid(){return this._analysisVisualization?.showGrid??!1}set showGrid(t){this._analysisVisualization&&(this._analysisVisualization.showGrid=t)}get testData(){}place(t){return this.active=!0,ne(this,{placementOptions:t,onToolActivated:e=>e.start("place")})}async pickLayerToExclude(t){return this.active=!0,le(this,{abortOptions:t,onToolActivated:e=>e.start("exclude")})}};n([l({readOnly:!0})],u.prototype,"type",void 0),n([l({constructOnly:!0,nonNullable:!0})],u.prototype,"analysis",void 0),n([l()],u.prototype,"tool",void 0),n([l()],u.prototype,"plane",void 0),n([l()],u.prototype,"active",void 0),n([l()],u.prototype,"editable",null),n([l()],u.prototype,"showGrid",null),n([l()],u.prototype,"userOperation",void 0),n([l()],u.prototype,"_analysisVisualization",void 0),n([l()],u.prototype,"_analysisController",void 0),u=n([L("esri.views.3d.analysis.SliceAnalysisView3D")],u);const qr=u;export{qr as default};
