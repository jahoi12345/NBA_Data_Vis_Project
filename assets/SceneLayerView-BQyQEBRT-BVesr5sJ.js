const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/intersectsOperator-jQl-E9Rz-UqW6o2m3.js","assets/ProjectionTransformation-PJc9H7Gq-Rbz84pUM.js","assets/Point2D-CMz7woHH-BVbGGL7p.js","assets/Envelope2D-mFnl8dXR-MYac-bfa.js","assets/Transformation2D-CrydmBdC-D4jE8w-_.js","assets/SimpleGeometryCursor-B92kdZ15-B1Z6elF7.js","assets/jsonMap-Bs3hmeCU-Cusd0Fmz.js","assets/OperatorDefinitions-DP7_WWTp-DP7_WWTp.js","assets/Extent-CgDMOSRD-CU1qE5Kr.js","assets/Point-BfTTZoMu-BAT2Wq6O.js","assets/index-CTl7hdrJ.js","assets/index-Cv2ko1Ob.css","assets/reader-DcGs6kKN-DHJfK-tm.js","assets/Polyline-CoiTLswR-BLagWJLS.js","assets/Polygon-D6wEPb3W-CpL9Efjx.js","assets/aaBoundingRect-CjwcS2F3-D7aII9DY.js","assets/mathUtils-PIGhLnI9-B1tKUlUb.js","assets/jsonConverter-DmBmaSz7-DAl7KiR-.js","assets/OperatorIntersects-Cd0VWkC0-Cu7rSpCI.js","assets/apiConverter-BAgvri9D-CJVft-_U.js","assets/simplifyOperator-bRe3zzdW-Ci0cJetU.js","assets/operatorSimplify-5A_MmN4K-aDmNvEee.js","assets/unionOperator-Bm74yF-r-BA1ODqFZ.js","assets/operatorUnion-CKW7ZNtE-BWfa5JTs.js"])))=>i.map(i=>d[i]);
import{H as A,_ as N}from"./index-CTl7hdrJ.js";import{$ as V}from"./asyncUtils-w6KfWU41-HenJ0UOu.js";import{v,a2 as k,Y as p,H as m,G as L,aU as z,q as T,e as H,J as C,aX as S,x as B}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{u as U}from"./uuid-Oe6SV2kF-IYX19xBA.js";import{d as G}from"./featureQueryAll-BfDWA5Wx-ZgjJqs6l.js";import{$ as R,y as W,M as J,s as Q}from"./lengthUtils-Dt1_RvOO-bleznLOi.js";import{o as K,r as D}from"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import{r as Z}from"./UpdatingHandles-D2RI_3Hb-dwLPjVun.js";import{J as X,S as Y,V as ee}from"./TemporalSceneLayerView-B-MmOgDo-AG1ksN3O.js";import{W as te,J as re,G as se,L as ne}from"./projectionUtils-BGH_5_I3-BySNUA-B.js";import{t as ie}from"./LayerView-BnpxrRF8-CNZhc0aY.js";const E=(e,t=E,r=t.f||(t.f=["assets/intersectsOperator-jQl-E9Rz.js","assets/ProjectionTransformation-PJc9H7Gq.js","assets/Point2D-CMz7woHH.js","assets/Envelope2D-mFnl8dXR.js","assets/Transformation2D-CrydmBdC.js","assets/SimpleGeometryCursor-B92kdZ15.js","assets/jsonMap-Bs3hmeCU.js","assets/OperatorDefinitions-DP7_WWTp.js","assets/Extent-CgDMOSRD.js","assets/Point-BfTTZoMu.js","assets/reader-DcGs6kKN.js","assets/index-BzxsWNRw.js","assets/index-Cv2ko1Ob.css","assets/Polyline-CoiTLswR.js","assets/Polygon-D6wEPb3W.js","assets/aaBoundingRect-CjwcS2F3.js","assets/mathUtils-PIGhLnI9.js","assets/jsonConverter-DmBmaSz7.js","assets/OperatorIntersects-Cd0VWkC0.js","assets/apiConverter-BAgvri9D.js","assets/simplifyOperator-bRe3zzdW.js","assets/operatorSimplify-5A_MmN4K.js","assets/unionOperator-Bm74yF-r.js","assets/operatorUnion-CKW7ZNtE.js"]))=>e.map(s=>r[s]),oe={setAttribute(){},rollback(){},commit(){}};function ve(e,t){const r=t.attributes[e.objectIdField];if(r==null)return oe;const s=e.sessions.get(r);if(s)return s;const a=k(t.attributes),l=new Set,d=e.i3sOverrides.createInteractiveEditSession(r),c=new Map,f=(o,u)=>{const g=c.get(o);if(g==null){const y=u.indexOf(r);return c.set(o,y),y}return g};let i=0;const n={setAttribute(o,u){if(i!==0)return;const g=e.fieldsIndex.get(o);if(!g)return;const y=e.attributeStorageInfo.findIndex(F=>F.name===g.name);if(y<0)return;if(!(o in a))throw new Error(`Attribute "${o}" is not an attribute of the edited feature.`);d.setAttribute(y,u);const b=e.attributeStorageInfo[y];let _=!1;l.add(o),e.forEachNode((F,x)=>{const O=f(F,x);if(O===-1)return;const I=e.getAttributeData(F.index);if(I){const j=I[b.name];j&&(j[O]=u,e.setAttributeData(F.index,I,t),_=!0)}}),_&&e.clearMemCache()},rollback(){if(i===0){for(const o of l)this.setAttribute(o,a[o]);d.remove(),i=1,e.sessions.delete(r)}},commit(){i===0&&(d.remove(),i=2,e.sessions.delete(r))}};return e.sessions.set(r,n),n}function ae(e,t,r){const{gidToFeatureInfo:s,oidToFeatureInfo:a,fieldsIndex:l,objectIdField:d,globalIdField:c,featureOrIdentifierList:f}=r;if(!r.featuresResolved&&f!=null){for(const i of f){const n={feature:null,oid:-1,gid:null};if("attributes"in i){n.feature=i;const o=i.attributes;if(o!=null)for(const u in o){if(n.oid!==-1&&n.gid!=null)break;const g=l.normalizeFieldName(u);g===d&&(n.oid=o[u]??-1),g===c&&(n.gid=o[u])}}else n.oid=i.objectId??-1,n.gid=i.globalId;n.gid!=null&&s.set(n.gid,n),n.oid!==-1&&a.set(n.oid,n)}r.featuresResolved=!0}return(e!==-1?a.get(e):null)??(t!=null?s.get(t):null)}function P(e,t,r,s,a=null,l=!0){const d=[],c={gidToFeatureInfo:new Map,oidToFeatureInfo:new Map,featuresResolved:r==null,fieldsIndex:e.fieldsIndex,objectIdField:e.objectIdField,globalIdField:e.globalIdField,featureOrIdentifierList:r};for(const f of t){if(f.error!=null)continue;const i=f.objectId??-1,n=f.globalId,o=(i===-1||l?ae(i,n,c):null)??{feature:null,oid:i,gid:n},u={oid:i===-1?o.oid:i,gid:n??o.gid,feature:o.feature,result:f};d.push(u);const g=u.gid?U(u.gid):null;if(u.oid===-1&&g!=null&&a!=null&&(u.oid=a.get(g)??-1),u.oid===-1&&g!=null){let y=s.get(g);y==null&&(y={gid:u.gid,edits:[]},s.set(g,y)),y.edits.push(u)}}return d}async function Oe(e,t){const r=new Map,s=P(e,t.addedFeatures,t.edits?.addFeatures,r),a=P(e,t.updatedFeatures,t.edits?.updateFeatures,r),l=P(e,t.deletedFeatures,t.edits?.deleteFeatures,r,t.globalIdToObjectId,!1);return r.size>0&&await le(e,r),{adds:s.filter(d=>d.oid!==-1),updates:a.filter(d=>d.oid!==-1),deletes:l.filter(d=>d.oid!==-1)}}async function le(e,t){const r=e.i3sOverrides.layer.associatedLayer;if(r?.globalIdField==null)return;const s=r.createQuery(),{objectIdField:a,globalIdField:l}=r;s.where=Array.from(t.values()).map(({gid:f})=>`${l}='${f}'`).join(" OR "),s.returnGeometry=!1,s.outFields=[a,l],s.cacheHint=!1;const d=await V(G(r,s));if(!d.ok)return;const c=d.value.features;for(const f of c){const i=f.attributes[l],n=f.attributes[a];if(i==null||n==null||n===-1)continue;const o=t.get(U(i));if(o!=null)for(const u of o.edits)u.oid=n}}function Ee(e,t){const r=new Map,s=a=>{for(const{oid:l,feature:d}of a){const c=d?.geometry;c?.type==="mesh"&&r.set(l,c)}};s(t.adds),s(t.updates);for(const a of t.deletes)r.set(a.oid,null);for(const[a,l]of r)e.i3sOverrides.updateGeometry(a,l)}function Ae(e,t){const r=ue(e,t),s=de(e,t);if(r.size===0&&s.size===0)return;const a=new Map;for(let u=0;u<e.attributeStorageInfo.length;u++)a.set(e.attributeStorageInfo[u].name,u);let l=!1;r.forEach((u,g)=>{const y=e.getAttributeData(g);let b=!1;u.forEach((_,F)=>{const x=y!=null?y[F]:null,O=a.get(F);for(const{featureIndex:I,value:j,featureId:q}of _)x&&(x[I]=j,b=!0,l=!0),e.i3sOverrides.updateAttributeValue(q,O,j)}),b&&e.setAttributeData(g,y,null)}),l&&e.clearMemCache();const{fieldsIndex:d,i3sOverrides:c,objectIdField:f,globalIdField:i}=e,n=c.layer.associatedLayer?.infoFor3D,o=new Set(n?[...Object.values(n.assetMapFieldRoles),...Object.values(n.transformFieldRoles)]:[]);for(const[u,g]of s){c.featureAdded(u);const{attributes:y}=g;for(const b in y){if(b!==f&&b!==i&&o.has(b))continue;const _=d.normalizeFieldName(b),F=_!=null?a.get(_):null;if(F==null)continue;const x=y[b];c.updateAttributeValue(u,F,x)}}}function de(e,t){const r=new Map,s=t.adds;if(!s||s.length===0||e.globalIdField==null)return r;for(const a of s){const l=a.oid,d=a.feature;d?.geometry?.type==="mesh"&&r.set(l,d)}return r}function ue(e,t){const r=t.updates;if(!r||r.length===0)return new M;const s=new M,a=new Map;for(let l=0;l<e.attributeStorageInfo.length;l++)a.set(e.attributeStorageInfo[l].name,l);return e.forEachNode((l,d)=>{for(const c of r){if(c.feature==null)continue;const f=c.feature,i=c.oid,n=d.indexOf(i);for(const o in f.attributes){const u=e.fieldsIndex.normalizeFieldName(o),g=ce(s,l.index,u),y=f.attributes[o];g.push({featureIndex:n,featureId:i,value:y})}}}),s}function ce(e,t,r){const s=fe(e,t),a=r!=null&&s.get(r);if(a)return a;const l=new Array;return s.set(r,l),l}function fe(e,t){const r=e.get(t);if(r)return r;const s=new pe;return e.set(t,s),s}const pe=Map,M=Map;function Ne(){return{requiredFields:{type:[String],readOnly:!0},availableFields:{type:[String],readOnly:!0,get:function(){const{layer:e,layer:{fieldsIndex:t},requiredFields:r}=this;return e.outFields?R(t,[...Q(t,e.outFields),...r]):R(t,r)}}}}const $=e=>{const t=e;let r=class extends t{constructor(){super(...arguments),this._updatingHandles=new Z,this._numUpdating=0}get updating(){return this._numUpdating>0||this._updatingHandles.updating}destroy(){this._updatingHandles.destroy()}autoUpdateAsync(s,a){const l=z(async d=>{++this._numUpdating;try{const c=await d;this.destroyed||this._set(s,c)}catch{v.getLogger(this).warn(`Async update of "${String(s)}" failed. Async update functions should not throw exceptions.`)}--this._numUpdating});return this._updatingHandles.add(a,l,K)}};return p([m()],r.prototype,"_updatingHandles",void 0),p([m({readOnly:!0})],r.prototype,"updating",null),p([m()],r.prototype,"_numUpdating",void 0),r=p([L("esri.core.AsyncUpdate")],r),r};$(T);let w=class extends $(T){get layer(){return this.layerView.layer}get requiredFields(){const{layerView:{layer:{fieldsIndex:e},definitionExpressionFields:t},rendererFields:r,labelingFields:s,viewFilterFields:a}=this;return R(e,[...t??[],...r??[],...s??[],...a??[]])}constructor(e){super(e)}initialize(){this.addHandles([this.autoUpdateAsync("rendererFields",async()=>{const{fieldsIndex:e,renderer:t}=this.layer;return t?this._getFieldsAsync(r=>t.collectRequiredFields(r,e)):null}),this.autoUpdateAsync("labelingFields",async()=>{const{layer:e}=this;return e.labelsVisible?this._getFieldsAsync(t=>W(t,e)):null}),this.autoUpdateAsync("viewFilterFields",()=>{const{layer:e,mergedFilter:t}=this.layerView;return this._getFieldsAsync(r=>J(r,e,t))})])}async _getFieldsAsync(e){const t=new Set;try{return await e(t),Array.from(t).sort()}catch(r){return v.getLogger(this).error(r),null}}};p([m()],w.prototype,"layerView",void 0),p([m()],w.prototype,"layer",null),p([m()],w.prototype,"requiredFields",null),p([m()],w.prototype,"rendererFields",void 0),p([m()],w.prototype,"labelingFields",void 0),p([m()],w.prototype,"viewFilterFields",void 0),w=p([L("esri.views.3d.layers.support.SceneLayerViewRequiredFields")],w);let h=class extends ie{constructor(){super(...arguments),this.layer=null,this.filter=null,this._geometryOperators=null,this._projectionEngineLoaded=!1,this._abortController=new AbortController}get availableFields(){return[]}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){throw new Error("Not implemented")}get maximumNumberOfFeaturesExceeded(){return!1}get layerFilter(){return X(this._layerFilter)}get _layerFilter(){const e=this.layer?.filter;if(e==null||e.geometries.length<1)return null;if(!this._geometryOperators||!this._projectionEngineLoaded&&this._filterNeedsProjectionEngine)return Y;const[t,r,s]=this._geometryOperators,a=e.geometries.at(0).spatialReference,l=e.geometries.toArray().map(i=>{let n;try{n=r.execute(i)}catch{return v.getLogger(this).warnOncePerTick("Failed to simplify scene filter mask polygon. Polygon will be ignored."),null}if(!n)return null;if(n.spatialReference.equals(a))return n;try{return te(n,a)}catch{return v.getLogger(this).warnOncePerTick("Failed to project scene filter mask polygon. Polygon will be ignored."),null}}).filter(H).sort((i,n)=>i.extent.xmin-n.extent.xmin),d=new Set,c=new Array,f=new Array;for(let i of l){const n=i.extent.xmin;if(c.length=0,d.forEach(o=>{if(n>=o.extent.xmax)return f.push(o),void d.delete(o);i.extent.ymin<=o.extent.ymax&&i.extent.ymax>=o.extent.ymin&&t.execute(i,o)&&c.push(o)}),c.length>0){let o;c.push(i);try{o=s.executeMany(c)}catch{v.getLogger(this).warnOncePerTick("Failed to unify filter mask polygons. Polygon will be ignored.");continue}c.pop(),o&&(c.forEach(u=>d.delete(u)),i=o)}d.add(i)}return d.forEach(i=>f.push(i)),f.length>0?{spatialRelationship:e.spatialRelationship,geometries:f}:null}get _filterNeedsProjectionEngine(){const e=this.layer.filter;if(e==null||e.geometries.length<=1)return!1;const t=e.geometries.at(0).spatialReference;return e.geometries.some(({spatialReference:r})=>!r.equals(t)&&!re(r,t))}get layerFilterUpdating(){return ee(this._layerFilter)}initialize(){const{signal:e}=this._abortController;D(()=>this.destroyed||!this._geometryOperators&&this.layer?.filter?.geometries?.length,e).then(async()=>{C(e),this._geometryOperators=await Promise.all([A(()=>N(()=>import("./intersectsOperator-jQl-E9Rz-UqW6o2m3.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19])).then(t=>t.i),E([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19])),A(()=>N(()=>import("./simplifyOperator-bRe3zzdW-Ci0cJetU.js"),__vite__mapDeps([20,2,1,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,21,19])).then(t=>t.s),E([20,2,1,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,21,19])),A(()=>N(()=>import("./unionOperator-Bm74yF-r-BA1ODqFZ.js"),__vite__mapDeps([22,2,1,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,23,19])).then(t=>t.u),E([22,2,1,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,23,19]))])}).catch(S),this._projectionEngineLoaded=se(),D(()=>this.destroyed||!this._projectionEngineLoaded&&this._filterNeedsProjectionEngine,e).then(async()=>{C(e),await ne(),this._projectionEngineLoaded=!0}).catch(S)}destroy(){this._abortController=B(this._abortController)}highlight(e,t){throw new Error("Not implemented")}queryFeatures(e,t){throw new Error("Not implemented")}queryObjectIds(e,t){throw new Error("Not implemented")}queryFeatureCount(e,t){throw new Error("Not implemented")}createQuery(){throw new Error("Not implemented")}queryExtent(e,t){throw new Error("Not implemented")}};p([m()],h.prototype,"layer",void 0),p([m()],h.prototype,"availableFields",null),p([m()],h.prototype,"maximumNumberOfFeatures",null),p([m({readOnly:!0})],h.prototype,"maximumNumberOfFeaturesExceeded",null),p([m()],h.prototype,"filter",void 0),p([m({readOnly:!0})],h.prototype,"layerFilter",null),p([m({readOnly:!0})],h.prototype,"_layerFilter",null),p([m()],h.prototype,"_geometryOperators",void 0),p([m()],h.prototype,"_projectionEngineLoaded",void 0),p([m()],h.prototype,"_filterNeedsProjectionEngine",null),p([m()],h.prototype,"layerFilterUpdating",null),h=p([L("esri.views.layers.SceneLayerView")],h);export{Ne as A,Ae as E,Ee as O,h,Oe as v,w,ve as x};
