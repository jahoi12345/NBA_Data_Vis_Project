import{I as c}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{s as f}from"./mathUtils-PIGhLnI9-B1tKUlUb.js";import{_ as p,e as u,i as m}from"./streamLayerUtils-DFlbJ4P1-DFlbJ4P1.js";class d{constructor(t){this.size=0,this._start=0,this.maxSize=t,this._buffer=new Array(t)}get entries(){return this._buffer}enqueue(t){if(this.size===this.maxSize){const e=this._buffer[this._start];return this._buffer[this._start]=t,this._start=(this._start+1)%this.maxSize,e}return this._buffer[(this._start+this.size++)%this.maxSize]=t,null}dequeue(){if(this.size===0)return null;const t=this._buffer[this._start];return this._buffer[this._start]=null,this.size--,this._start=(this._start+1)%this.maxSize,t}peek(){return this.size===0?null:this._buffer[this._start]}peekLast(){return this.size===0?null:this._buffer[(this._start+(this.size-1))%this.maxSize]}find(t){if(this.size===0)return null;for(const e of this._buffer)if(e!=null&&t(e))return e;return null}clear(t){let e=this.dequeue();for(;e!=null;)t&&t(e),e=this.dequeue()}}const _=1e3;class v{constructor(t,e,s,i,r=128){if(this._trackIdToObservations=new Map,this._idCounter=0,this._lastPurge=performance.now(),this._addOrUpdated=new Map,this._removed=[],this._maxAge=0,this._timeInfo=s,this._purgeOptions=i,this.store=t,e.type==="unique-id-composite")throw new c("stream-layer","composite uniqueIds are not supported");this.idField=e.fieldName,this.purgeInterval=r,this._useGeneratedIds=this.idField===p}removeById(t){this._removed.push(t)}removeByTrackId(t){const e=this._trackIdToObservations.get(t);if(e)for(const s of e.entries)this._removed.push(s)}add(t){if(this._useGeneratedIds){const o=this._nextId();t.attributes[this.idField]=o,t.objectId=o}else t.objectId=t.attributes[this.idField];const e=t.objectId;if(this._addOrUpdated.set(e,t),this._maxAge=Math.max(this._maxAge,t.attributes[this._timeInfo.startTimeField]),!this._timeInfo.trackIdField)return this._trackIdLessObservations==null&&(this._trackIdLessObservations=new d(1e5)),void this._trackIdLessObservations.enqueue(e);const s=t.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(s)){const o=this._purgeOptions?.maxObservations!=null?this._purgeOptions.maxObservations:_,n=f(o,0,_);this._trackIdToObservations.set(s,new d(n))}const i=this._trackIdToObservations.get(s),r=i?.enqueue(e);r!=null&&(this._addOrUpdated.has(r)?this._addOrUpdated.delete(r):this._removed.push(r))}checkForUpdates(){const t=this._getToAdd(),e=this._getToRemove(),s=performance.now(),i=s-this._lastPurge,r=Date.now();i>=this.purgeInterval&&(this._purge(s),this._lastPurge=s);const o=[];if(e!=null)for(const a of e){const h=this.store.removeById(a);h!=null&&o.push(h)}const n=[];if(t!=null){const a=new Set(e??[]);for(const h of t)a.has(h.objectId)||(h.attributes[u]=s,h.attributes[m]=r,this.store.add(h),n.push(h))}return!(!n.length&&!o?.length)&&(this.store.update(n,o),!0)}_getToAdd(){if(!this._addOrUpdated.size)return null;const t=new Array(this._addOrUpdated.size);let e=0;return this._addOrUpdated.forEach(s=>t[e++]=s),this._addOrUpdated.clear(),t}_getToRemove(){const t=this._removed;return this._removed.length?(this._removed=[],t):null}_nextId(){const t=this._idCounter;return this._idCounter=(this._idCounter+1)%4294967294+1,t}_purge(t){const e=this._purgeOptions;e!=null&&(this._purgeSomeByDisplayCount(e),this._purgeByAge(e),this._purgeByAgeReceived(t,e),this._purgeTracks())}_purgeSomeByDisplayCount(t){if(!t.displayCount)return;let e=this.store.size;if(e>t.displayCount){if(this._timeInfo.trackIdField){for(const s of this._trackIdToObservations.values())if(e>t.displayCount&&s.size){const i=s.dequeue();this._removed.push(i),e--}}if(this._trackIdLessObservations!=null){let s=e-t.displayCount;for(;s-- >0;){const i=this._trackIdLessObservations.dequeue();i!=null&&this._removed.push(i)}}}}_purgeByAge(t){const e=this._timeInfo?.startTimeField;if(!t.age||!e)return;const s=60*t.age*1e3,i=this._maxAge-s;this.store.forEach(r=>{r.attributes[e]<i&&this._removed.push(r.objectId)})}_purgeByAgeReceived(t,e){if(!e.ageReceived)return;const s=t-60*e.ageReceived*1e3;this.store.forEach(i=>{i.attributes[u]<s&&this._removed.push(i.objectId)})}_purgeTracks(){this._trackIdToObservations.forEach((t,e)=>{t.size===0&&this._trackIdToObservations.delete(e)})}}export{v as I};
