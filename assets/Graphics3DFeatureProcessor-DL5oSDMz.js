import{l as F,_ as n,m as a,a as E,ba as $,o as T,u as _,d as b,f as H,i as N,bl as x,V as U,aA as A}from"./jsonMap-Bs3hmeCU.js";import{i as q}from"./hash-CcEbRgUF.js";import{d as M}from"./asyncUtils-w6KfWU41.js";import{h as d,d as P,l as c,f as J}from"./reactiveUtils-SO2Ko3sy.js";import{y as w}from"./diffUtils-CvuzActy.js";import{h as v}from"./UpdatingHandles-D2RI_3Hb.js";import{aP as j,aj as D}from"./Point-BN8RINcc.js";import{r as k,n as L}from"./renderingInfoUtils-BXcQx9dw.js";import{l as C,N as B}from"./lengthUtils-Ceo6858g.js";import{r as z}from"./ShadowCastClear.glsl-Bhq9MYuW.js";import{k as Z,p as W,e as Y}from"./ExtentSet-ckKEFcpL.js";import{a as K,h as X,u as ee}from"./Graphics3DObjectStates-BC7UoD8w.js";import{U as te}from"./RealisticTree.glsl-IWCjmMLr.js";import{d as f}from"./FeatureFilter-BCfZeYLB.js";import{o as ie}from"./floorFilterUtils-DKzVzLpH.js";import{z as re}from"./Extent-Bbnm65bN.js";import{y as se}from"./typeUtils-Dk-Jta7H.js";import{W as ne}from"./QueryEngine-jFSusG_2.js";import{Z as ae}from"./FieldsIndex-B72TFK42.js";import{i as oe}from"./AttributeBinsFeatureSet-CBfDT7ZE.js";import{g as S}from"./FeatureSet-BzuZ0plV.js";import{b as le}from"./Query-CikRiKlY.js";import{a as ue,s as he}from"./memoryEstimations-Bd726a_p.js";import{f as pe}from"./Scheduler-CNrsbccs.js";import{s as O}from"./highlightUtils-DrzpF6-n.js";function de(e){const{objectIdField:t,uniqueIdFields:r}=e;return r?.length?r.length>=2?{type:"unique-id-composite",fieldNames:r}:{type:"unique-id-simple",fieldName:r[0]}:{type:"object-id",fieldName:t}}class ce{constructor(t){this._cache=t.newCache("QueryEngine",null,-1)}clear(){this._cache.clear()}destroy(){this._cache.destroy()}get(t){return this._cache.get(t)?.items}put(t,r){this._cache.put(t,new ye(r))}get test(){}}class ye{constructor(t){this.items=t}get usedMemory(){return this.items.reduce((t,r)=>t+r.usedMemory,ue+he)}}const ge=ne;let p=class extends F{constructor(t){super(t),this._dataQueryEngineInstance=null}destroy(){this.clear()}get layer(){return this.context.layer}get spatialReference(){return this.context.spatialReference}get _queryGeometryType(){switch(this.layer.geometryType){case"multipoint":case"point":case"polygon":case"polyline":return this.layer.geometryType;case"mesh":return"polygon";default:return}}get defaultQueryJSON(){return new le({outSpatialReference:this.spatialReference}).toJSON()}clear(){return!!this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null,!0)}async executeQueryForIdSet(t,r,i){return this._dataQueryEngine.executeQueryForIdSet(this._ensureQueryJSON(t,r),i)}async executeQueryForCount(t,r){return this._dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(t),r)}async executeQueryForExtent(t,r){const{count:i,extent:s}=await this._dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(t),r);return{count:i,extent:re.fromJSON(s)}}async executeQueryForIds(t,r){return this._dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(t),r)}async executeQueryForLatestObservations(t,r){const i=await this._dataQueryEngine.executeQueryForLatestObservations(this._ensureQueryJSON(t),r),s=S.fromJSON(i);return s.features.forEach(l=>{l.layer=this.layer,l.sourceLayer=this.layer,"graphicOrigin"in this.layer&&(l.origin=this.layer.graphicOrigin)}),s}async executeAttributeBinsQuery(t,r){const i=await this._dataQueryEngine.executeAttributeBinsQuery(t.toJSON(),r);return oe.fromJSON(i)}async executeQuery(t,r){const i=await this._dataQueryEngine.executeQuery(this._ensureQueryJSON(t),r),s=S.fromJSON(i);return s.features.forEach(l=>{l.layer=this.layer,l.sourceLayer=this.layer,"graphicOrigin"in this.layer&&(l.origin=this.layer.graphicOrigin)}),s}_ensureQueryJSON(t,r){let i=this.defaultQueryJSON;if(t!=null&&("outSpatialReference"in t&&!t.outSpatialReference&&(t.outSpatialReference=this.spatialReference),i=t.toJSON(),i.cacheHint=!0),r!=null){const s=r.geometries.map(l=>l.toJSON()).reduce((l,h)=>(l.rings=l.rings.concat(h.rings),l));i={...i,cacheHint:!0,sceneFilter:{...r,geometry:s}}}return i}get _dataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const{priority:t,layer:r}=this,i="timeInfo"in r&&r.timeInfo?.toJSON()||null,s=de(r),l=se.toJSON(this._queryGeometryType),h=r.fieldsIndex?.toJSON()||new ae([]),y=this.spatialReference.toJSON(),{hasZ:g,hasM:I,featureStore:R,scheduler:V,memoryController:Q}=this.context,G=new ce(Q);return this._dataQueryEngineInstance=new ge({hasZ:g,hasM:I,geometryType:l,fieldsIndex:h,timeInfo:i,spatialReference:y,featureIdInfo:s,featureStore:R,scheduler:V,cache:G,priority:t}),this._dataQueryEngineInstance}};n([a({constructOnly:!0})],p.prototype,"context",void 0),n([a({constructOnly:!0})],p.prototype,"priority",void 0),n([a()],p.prototype,"layer",null),n([a()],p.prototype,"spatialReference",null),n([a()],p.prototype,"_queryGeometryType",null),n([a()],p.prototype,"defaultQueryJSON",null),p=n([E("esri.views.3d.layers.graphics.QueryEngine")],p);class fe{constructor(t,r,i,s,l,h){this.spatialReference=t,this.layer=r,this.resourceController=i,this._getFeatureStore=s,this.hasZ=l,this.hasM=h}get scheduler(){return this.resourceController.scheduler}get memoryController(){return this.resourceController.memoryController}get featureStore(){return this._getFeatureStore()}}let u=class extends F{constructor(e){super(e),this._frameTask=null,this._queryEngine=null,this._updateRequested=!0,this._updatingHandles=new v,this._abortController=new AbortController}initialize(){const e=pe.FILTER_VISIBILITY,{layer:t,view:r}=this._configuration,{featureStore:i}=this.context,{spatialReference:s,resourceController:l}=r,h=this._configuration.hasZ??!1,y=this._configuration.hasM??!1,g=new fe(s,t,l,()=>i,h,y);this._queryEngine=new p({context:g,priority:e}),this._frameTask=r.resourceController.scheduler.registerTask(e),this._updatingHandles.add(()=>[this._compositedFeatureFilter,this._sceneFilter,this._displayFilterHighlightIds],()=>this.reapply(),d),this._updatingHandles.addWhen(()=>!this._frameTask.updating&&this._updateRequested,()=>{this._frameTask.scheduleGenerator(()=>this._updateVisibility(),this._abortController.signal).catch($)},d)}destroy(){this._abortController.abort(),this._updatingHandles.destroy(),this.clear(),this._frameTask=T(this._frameTask),this._queryEngine=_(this._queryEngine),this._set("context",null)}get updating(){return this._updateRequested||this._updatingHandles.updating||this._frameTask.updating}get defaultVisibility(){return this._compositedFeatureFilter==null&&this._sceneFilter==null}get _featureFilter(){return"filter"in this._configuration?this._configuration.filter:null}get _effectiveDisplayFilter(){return"effectiveDisplayFilter"in this._configuration?this._configuration.effectiveDisplayFilter:null}get _highlightIds(){return"highlightIds"in this._configuration?this._configuration.highlightIds:null}get _displayFilterHighlightIds(){return this._effectiveDisplayFilter&&this._highlightIds?.length?new Set(this._highlightIds):null}get _sceneFilter(){return"layerFilter"in this._configuration?this._configuration.layerFilter:null}get _floorFilter(){return ie(this._configuration)}get _timeExtent(){return"timeExtent"in this._configuration?this._configuration.timeExtent:null}get _compositedFeatureFilter(){const{_featureFilter:e,_effectiveDisplayFilter:t,_timeExtent:r,_floorFilter:i}=this;let s=e?.clone();if(t!=null&&(s??=new f,s.where=C(s.where,t.where)),r!=null&&(s??=new f,s.timeExtent=s.timeExtent?.intersection(r)??r),i!=null){s??=new f;const l=s.where==null||s.where==="";s.where=l?i:C(s.where,i)}return s}get _configuration(){return this.context.configuration}reapply(){this._updateRequested=!0}clear(){this._queryEngine.clear(),this.context.clearFeaturesVisibility()}async*_updateVisibility(){this._updateRequested=!1;const{context:e,_sceneFilter:t,_compositedFeatureFilter:r,_displayFilterHighlightIds:i,_abortController:{signal:s}}=this;if(b(s),r==null&&t==null||e.getFeatureCount()===0)return this.clear();try{let l=await this._queryEngine.executeQueryForIdSet(r,t,s);yield,i&&(l=new Set([...l,...i])),yield,e.updateFeatureVisibilities(h=>l.has(h))}catch(l){H(l),N.getLogger(this).warn(`FeatureFilter query failed: ${l}`,{error:l}),e.setAllFeaturesVisibility(!0)}}};n([a({constructOnly:!0})],u.prototype,"context",void 0),n([a()],u.prototype,"updating",null),n([a()],u.prototype,"defaultVisibility",null),n([a()],u.prototype,"_featureFilter",null),n([a()],u.prototype,"_effectiveDisplayFilter",null),n([a()],u.prototype,"_highlightIds",null),n([a()],u.prototype,"_displayFilterHighlightIds",null),n([a()],u.prototype,"_sceneFilter",null),n([a()],u.prototype,"_floorFilter",null),n([a()],u.prototype,"_timeExtent",null),n([a()],u.prototype,"_compositedFeatureFilter",null),n([a()],u.prototype,"_configuration",null),n([a()],u.prototype,"_updateRequested",void 0),u=n([E("esri.views.3d.layers.support.FeatureVisibilityFilter")],u);let o=class extends P{constructor(e){super(e),this.type="graphics-3d",this._updatingHandles=new v,this.elevationFeatureExpressionEnabled=!1,this.scaleVisibilityEnabled=!1,this.filterVisibilityEnabled=!1,this.frustumVisibilityEnabled=!1,this.elevationAlignmentEnabled=!1,this.timeExtentEnabled=!1,this.setUidToIdOnAdd=!0,this.dataExtent=null,this.drapeSourceType=1,this.preferredUpdatePolicy=0,this._suspendResumeExtent=null}initialize(){const e=this.owner,t=(this.filterVisibilityEnabled||this.timeExtentEnabled)&&e.layer.geometryType!=="multipatch",r=new Z({owner:this,layer:this.layer,preferredUpdatePolicy:this.preferredUpdatePolicy,elevationFeatureExpressionEnabled:this.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1,hasZ:e.hasZ,hasM:e.hasM,setUidToIdOnAdd:this.setUidToIdOnAdd,componentFactories:{deconflictor:i=>e.view.deconflictor.addGraphicsOwner(i),labeler:(i,s)=>e.view.labeler.addGraphicsOwner(i,s),elevationAlignment:this.elevationAlignmentEnabled?(i,s)=>new X({graphicsCoreOwner:this,graphicsCore:i,queryGraphicUIDsInExtent:s,elevationProvider:e.view.elevationProvider}):null,scaleVisibility:this.scaleVisibilityEnabled?(i,s)=>new W({graphicsCoreOwner:this,layer:this.layer,queryGraphicUIDsInExtent:s,graphicsCore:i,basemapTerrain:e.view.basemapTerrain}):null,filterVisibility:t?i=>new u({context:{...i,configuration:e}}):null,objectStates:i=>new K(i)}});this._set("graphicsCore",r),this.frustumVisibilityEnabled&&this._set("frustumVisibility",new ee({graphicsCoreOwner:this})),this.elevationAlignment&&this._updatingHandles.add(()=>this.layer.elevationInfo,(i,s)=>{w(i,s)&&this._updatingHandles.addPromise(this.graphicsCore.elevationInfoChange())}),this._updatingHandles.add(()=>this.layer.labelsVisible,()=>this.graphicsCore.updateVisibilityInfo()),this._updatingHandles.add(()=>this.layer.labelingInfo,(i,s)=>{w(i,s)&&this.graphicsCore.updateLabelingInfo()}),this._updatingHandles.add(()=>this.preferredUpdatePolicy,i=>this.graphicsCore.preferredUpdatePolicy=i),this.addResolvingTask(M(i=>this._initializeAsync(i)))}async _initializeAsync(e){await x(this.graphicsCore.initializePromise),b(e);const t=this.owner;this._updatingHandles.add(()=>this.renderer,r=>this._updatingHandles.addPromise(this.graphicsCore.rendererChange(r))),this._updatingHandles.add(()=>t.fullOpacity,()=>this.graphicsCore.opacityChange()),this._setupSuspendResumeExtent(),this.updateClippingExtent&&(this._updatingHandles.add(()=>t.view.clippingArea,()=>this._updateClippingExtent()),this._updateClippingExtent()),this.graphicsCore.startCreateGraphics(),this.graphicsCore.labelsEnabled&&(await x(this.graphicsCore.updateLabelingInfo()),b(e))}destroy(){this._updatingHandles.destroy(),this._set("frustumVisibility",_(this.frustumVisibility)),this._set("graphicsCore",_(this.graphicsCore)),this._set("owner",null)}get layer(){return this.owner.layer}get layerViewUid(){return this.owner.layerViewUid}get dataUpdating(){return this.graphicsCore?.dataUpdating??!1}get renderer(){const{renderer:e,objectIdField:t}=this.layer;if(!e||!t||e.type==="heatmap"||!e.visualVariables)return e;const r=e.visualVariables.findIndex(s=>s.type==="rotation"&&s.valueExpression!=null&&B(s.valueExpression)===t&&(s.axis==null||s.axis==="heading")&&s.rotationType==="geographic");if(r<0)return e;const i=e.clone();return i.visualVariables?(i.visualVariables.splice(r,1),this._randomRotationRenderers??=new WeakMap,this._randomRotationRenderers.set(i,t),i):e}get scaleVisibility(){return this.graphicsCore?.scaleVisibility}get filterVisibility(){return this.graphicsCore?.filterVisibility}get elevationAlignment(){return this.graphicsCore?.elevationAlignment}get suspendResumeExtentMode(){return this.owner.suspendResumeExtentMode??"computed"}get scaleVisibilitySuspended(){return this.scaleVisibility!=null&&this.scaleVisibility.suspended}get suspended(){return this.owner.suspended}get legendEnabled(){return this.frustumVisibility==null||!this.frustumVisibility.suspended}get suspendInfo(){const e={};return this.scaleVisibilitySuspended&&(e.outsideScaleRange=!0),this.frustumVisibility!=null&&this.frustumVisibility.suspended&&(e.outsideOfView=!0),e}get updating(){return!!(this.graphicsCore?.updating||this.frustumVisibility?.updating||this._updatingHandles.updating)}get updatingRemaining(){return this.graphicsCore?.updatingRemaining??0}get featureStore(){return this.graphicsCore?.featureStore}get view(){return this.owner.view}get loadedGraphics(){return this.owner.loadedGraphics}get fullOpacity(){return this.owner?.fullOpacity}get filter(){return"filter"in this.owner?this.owner.filter:null}get slicePlaneEnabled(){return this.owner.slicePlaneEnabled}get updatePolicy(){return this.owner.updatePolicy}get featureSpatialReference(){return"featureSpatialReference"in this.owner?this.owner.featureSpatialReference:this.owner.view.spatialReference}get graphics3DGraphics(){return this.graphicsCore?.graphics3DGraphics}get graphics3DGraphicsByObjectID(){return this.graphicsCore?.graphics3DGraphicsByObjectID}get symbolUpdateType(){return this.graphicsCore?.symbolUpdateType}get displayFeatureLimit(){const e=this.view.quality,t=this.graphicsCore?.displayFeatureLimit;if(e===1)return t;const r=Math.ceil(t.maximumNumberOfFeatures*e);return new Y(t.maximumTotalNumberOfVertices,r,t.averageSymbolComplexity)}get usedMemory(){return this.graphicsCore?.usedMemory??0}get loadedFeatures(){return this.graphicsCore?.numberOfGraphics??0}get usedMemoryPerFeature(){return this.graphicsCore?.usedMemoryPerGraphic??0}get unprocessedMemoryEstimate(){return this.graphicsCore?.unprocessedMemoryEstimate??0}get performanceInfo(){return this.graphicsCore.performanceInfo}maskOccludee(e){const t=this.graphicsCore?.objectStates;if(!t)return U();const{set:r,handle:i}=t.acquireOccludeeSet(null);return t.setUid(r,e.uid),i}highlightByGraphics(e,t){const r=this.graphicsCore?.objectStates;if(!r)return O;const i=e.map(h=>h.uid),{set:s,handle:l}=r.acquireHighlightSet(t,null);return r.setUids(s,i),l}highlightByObjectIds(e,t=null,r){const i=this.graphicsCore?.objectStates;if(!i)return O;const{set:s,handle:l}=i.acquireHighlightSet(r,t);return i.setObjectIds(s,e),l}resetObjectStates(){this.graphicsCore?.objectStates?.reset()}whenGraphicBounds(e,t){return this.graphicsCore?.whenGraphicBounds(e,t)}computeAttachmentOrigin(e,t){return this.graphicsCore?.computeAttachmentOrigin(e,t)}notifyGraphicGeometryChanged(e){this.graphicsCore.notifyGraphicGeometryChanged(e)}notifyGraphicVisibilityChanged(e){this.graphicsCore.notifyGraphicVisibilityChanged(e)}notifyContentGeometryUpdate(){this.owner.notifyContentGeometryUpdate?.()}getRenderingInfo(e,t,r){const i=k(e,{renderer:t,arcade:r});if(i?.color){const s=i.color;s[0]=s[0]/255,s[1]=s[1]/255,s[2]=s[2]/255}if(i!=null&&t!=null&&this._randomRotationRenderers?.has(t)){const s=this._randomRotationRenderers.get(t),l=e.attributes[s],h=new q(0);h.updateFloatArray([l]),h.updateUint8Array([173]),i.heading=8381e-11*h.digest()}return i}getRenderingInfoAsync(e,t,r,i){return L(e,{renderer:t,arcade:r,...i})}getSymbolLayerSize(e,t){return this.graphicsCore?.getSymbolLayerSize(e,t)}setObjectIdVisibility(e,t){this.graphicsCore?.setObjectIdVisibility(e,t)}refreshFilter(){this.filterVisibility!=null&&this.filterVisibility.reapply()}getGraphics3DGraphicByObjectId(e){return this.graphicsCore?.getGraphics3DGraphicByObjectId(e)}_updateClippingExtent(){const e=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.owner.view.spatialReference)&&(this.updateClippingExtent(e)||this.graphicsCore.recreateAllGraphics())}_setupSuspendResumeExtent(){(this.frustumVisibility||this.scaleVisibility)&&this.addHandles(c(()=>this.suspendResumeExtentMode,()=>{switch(this.removeHandles(m),this.suspendResumeExtentMode){case"computed":this.addHandles([c(()=>this.graphicsCore.computedExtent,e=>this._updateSuspendResumeExtent(e),d),c(()=>this.graphicsCore.extentPadding,()=>this._updateSuspendResumeExtent(this.graphicsCore.computedExtent))],m);break;case"data":this.addHandles([J(()=>this.dataExtent,e=>this._updateSuspendResumeExtent(e),d),c(()=>this.graphicsCore.extentPadding,()=>this._updateSuspendResumeExtent(this.dataExtent))],m);break;default:A(this.suspendResumeExtentMode)}},d))}_updateSuspendResumeExtent(e){e?this._suspendResumeExtentChanged(this._extentToSuspendResumeRect(e,this._suspendResumeExtent)):this._suspendResumeExtentChanged(null)}_extentToSuspendResumeRect(e,t){const r=this.owner.view.spatialReference;if(!e.spatialReference.equals(r)){if(!j(e,r))return;e=D(e,r)}return te(e,t,z,this.graphicsCore.extentPadding)}_suspendResumeExtentChanged(e){this.frustumVisibility!=null&&this.frustumVisibility.setExtent(e),this.scaleVisibility!=null&&this.scaleVisibility.setExtent(e)}};n([a()],o.prototype,"type",void 0),n([a({constructOnly:!0})],o.prototype,"owner",void 0),n([a()],o.prototype,"layer",null),n([a()],o.prototype,"layerViewUid",null),n([a({readOnly:!0})],o.prototype,"dataUpdating",null),n([a()],o.prototype,"renderer",null),n([a({constructOnly:!0})],o.prototype,"updateClippingExtent",void 0),n([a({constructOnly:!0})],o.prototype,"elevationFeatureExpressionEnabled",void 0),n([a({constructOnly:!0})],o.prototype,"graphicsCore",void 0),n([a({constructOnly:!0})],o.prototype,"scaleVisibilityEnabled",void 0),n([a({constructOnly:!0})],o.prototype,"filterVisibilityEnabled",void 0),n([a({constructOnly:!0})],o.prototype,"frustumVisibilityEnabled",void 0),n([a({constructOnly:!0})],o.prototype,"elevationAlignmentEnabled",void 0),n([a({constructOnly:!0})],o.prototype,"timeExtentEnabled",void 0),n([a({constructOnly:!0})],o.prototype,"setUidToIdOnAdd",void 0),n([a()],o.prototype,"scaleVisibility",null),n([a()],o.prototype,"filterVisibility",null),n([a()],o.prototype,"elevationAlignment",null),n([a({constructOnly:!0})],o.prototype,"frustumVisibility",void 0),n([a()],o.prototype,"suspendResumeExtentMode",null),n([a()],o.prototype,"dataExtent",void 0),n([a()],o.prototype,"scaleVisibilitySuspended",null),n([a()],o.prototype,"suspended",null),n([a()],o.prototype,"legendEnabled",null),n([a()],o.prototype,"suspendInfo",null),n([a()],o.prototype,"updating",null),n([a()],o.prototype,"updatingRemaining",null),n([a()],o.prototype,"featureStore",null),n([a()],o.prototype,"view",null),n([a()],o.prototype,"loadedGraphics",null),n([a()],o.prototype,"fullOpacity",null),n([a()],o.prototype,"filter",null),n([a()],o.prototype,"slicePlaneEnabled",null),n([a()],o.prototype,"drapeSourceType",void 0),n([a()],o.prototype,"updatePolicy",null),n([a()],o.prototype,"preferredUpdatePolicy",void 0),n([a({readOnly:!0})],o.prototype,"displayFeatureLimit",null),o=n([E("esri.views.3d.layers.graphics.Graphics3DFeatureProcessor")],o);const m="suspendResumeExtentMode";export{o as U,de as a,u as b,fe as e,p as m};
