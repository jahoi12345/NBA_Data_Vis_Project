import{s as m,f as h,i as d,_ as o,m as a,a as T}from"./jsonMap-Bs3hmeCU.js";import{aq as S,f as c,H as u}from"./Point-vWR8_ZMt.js";import{l as v}from"./MultiOriginJSONSupport-Bd1TKmh_.js";import{a as w,U as b}from"./reactiveUtils-SO2Ko3sy.js";import{o as L}from"./reader-DcGs6kKN.js";import{j as k}from"./persistable-BlVCbEVW.js";import{z as y}from"./Extent-DY3BG_6i.js";import{b as I}from"./Layer-BMwTffmV.js";import{o as P}from"./APIKeyMixin--YGbad8e.js";import{l as R}from"./ArcGISService-LAhkiI9y.js";import{s as x}from"./CustomParametersMixin-Dshqz1Zp.js";import{b as D,m as $,y as E}from"./OperationalLayer-FCdqv79e.js";import{j}from"./PortalLayer-_7TK261k.js";import{t as O}from"./ScaleRangeLayer-DQr2T3Hh.js";import{n as g}from"./SceneModifications-CZYlmlxe.js";import{E as q}from"./tiles3DUtils-B_YH7rmu.js";import{M}from"./collectionUtils-DoXnmzlX.js";import{j as f,w as N,R as U}from"./elevationInfoUtils-v7CkQ9i1.js";import{t as A}from"./layerUtils-Dp0n27PK.js";import"./index-JW0QcsSZ.js";import"./MD5-MtSiOt06.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw.js";import"./uuid-Oe6SV2kF.js";import"./resourceExtension-BdKRKq5q.js";import"./date-IqUzANpt.js";import"./layerContainerType-CSXZNpHb.js";import"./ElevationInfo-DtRUQF80.js";import"./lengthUtils-CUXP1wE0.js";import"./unitConversionUtils-DLqXrs5X.js";import"./opacityUtils-DuFH0EC9.js";import"./asyncUtils-w6KfWU41.js";import"./PortalItem-5Ub3M2il.js";import"./portalItemUtils-DRve4gDd.js";import"./projectionUtils-CxkhtTt4.js";import"./SimpleObservable-CvFyr0NA.js";import"./Polyline-CTW9EJXE.js";import"./Polygon-CHS6Qlya.js";import"./aaBoundingRect-aK0fPvVw.js";import"./mathUtils-PIGhLnI9.js";import"./SceneModification-5zOuqf33.js";import"./vec32-3aXs3jbn.js";import"./HeightModelInfo-CaqLl28i.js";let e=class extends R(D(j(O(v(x(P(I))))))){readModifications(t,i,r){this._modificationsSource={url:S(t,r),context:r}}initialize(){this.addHandles(w(()=>this.modifications,"after-changes",()=>this.modifications=this.modifications,b))}constructor(t){super(t),this.operationalLayerType="IntegratedMesh3DTilesLayer",this.modifications=null,this._modificationsSource=null,this.spatialReference=new c({wkid:4326,vcsWkid:115700}),this.fullExtent=new y(-180,-90,180,90,this.spatialReference),this.url=null,this.type="integrated-mesh-3dtiles",this.path=null,this.minScale=0,this.maxScale=0,this._rootTilesetJSON=null,this._rootTileset=null,this._key=null,this._session=null,this._rootRequestPromise=null}set elevationInfo(t){t!=null&&t.mode!=="absolute-height"||this._set("elevationInfo",t),this._validateElevationInfo(t)}async load(t){return this.addResolvingPromise(this._doLoad(t)),this}get rootTilesetJSON(){return this._rootTilesetJSON}get rootTileset(){return this._rootTileset}get key(){return this._key}get session(){return this._session}_findSessionParameter(t){const i=[t];for(;i?.length>0;){const r=i.pop();if(!r)return;for(const[n,s]of Object.entries(r)){if(n==="uri")try{const l=new URL("https://tmp"+s).searchParams.get("session");if(l)return l}catch{}typeof s=="object"&&s!==null&&i.push(s)}}return null}async requestRootAndSession(t){const i=(r,n)=>new m("3dtiles-init:"+r,n);return this._rootRequestPromise||(this._rootRequestPromise=new Promise((r,n)=>{this.url||n(i("url-missing","Layer url missing")),this._key=this.customParameters?this.customParameters.key:null,new Promise((s,l)=>{if(this.replacesTerrain&&!this._key){const p=this.portalItem?.portal||this.parent?.portalItem?.portal||M.getDefault();p.signIn().then(()=>{p.g3dTilesEnabled?u(p.restUrl+"/portals/self/modules/g3dtiles",{responseType:"json",query:{f:"json"}}).then(_=>{this._key=_.data.keyString,s()},()=>l(i("g3dtiles-key-error","Error fetching Google 3D Tiles key from portal"))):l(i("g3dTilesEnabled-false","Google 3D Tiles are not enabled on Portal "+p.url))},()=>l(i("sign-in-failed","Error signing in to Portal")))}else s()}).then(()=>{u(this.url,{query:this._key?{key:this._key,token:this.apiKey}:{token:this.apiKey},responseType:"array-buffer",signal:t}).then(s=>{try{this._rootTilesetJSON=JSON.parse(new TextDecoder().decode(s.data))}catch(l){return void n(i("root-parse-failed","Error parsing root tile, details: "+l))}this._rootTilesetJSON?(this._session=this._findSessionParameter(this._rootTilesetJSON),this._rootTileset=s.data,this.fullExtent=q(this._rootTilesetJSON),r(),this._rootRequestPromise=null):n(i("root-is-null","Root tile is null."))},s=>{h(s),n(i("root-load-failed","Error loading root tile")),this._rootRequestPromise=null,d.getLogger("IntegratedMesh3DTilesLayer").error("Layer loading failed",s)})},s=>n(s))})),this._rootRequestPromise}async _doLoad(t){const i=t!=null?t.signal:null;if(this._isUsedAsGroundLayer)throw new m("3dtiles-init:not-supported-in-groundlayers","Layer is not supported in basemap.");try{await this.loadFromPortal({supportedTypes:["3DTiles Service"],validateItem:r=>{if(r.typeKeywords?.includes("IntegratedMesh"))return!0;throw new m("portal:invalid-layer-item-type","Invalid layer item, expected '${expectedType}' ",{expectedType:"3DTiles Service containing IntegratedMesh"})}},t)}catch(r){h(r)}if(this._modificationsSource!=null){const r=await g.fromUrl(this._modificationsSource.url,this.spatialReference,t);this.setAtOrigin("modifications",r,this._modificationsSource.context.origin),this._modificationsSource=null}await this.requestRootAndSession(i)}beforeSave(){if(this._modificationsSource!=null)return this.load().then(()=>{},()=>{})}get hasAttributionData(){return!1}async fetchAttributionData(){return{}}_validateElevationInfo(t){const i="Integrated mesh 3d tiles layers";f(d.getLogger(this),N(i,"absolute-height",t)),f(d.getLogger(this),U(i,t))}get replacesTerrain(){return!1}get _isUsedAsGroundLayer(){return A(this.parent)}get hasGoogleUrl(){return!!this.url?.match(/.+\.googleapis.com/)}};o([a({type:["IntegratedMesh3DTilesLayer"]})],e.prototype,"operationalLayerType",void 0),o([a({type:g,clonable:t=>t.clone()}),k({origins:["web-scene","portal-item"],type:"resource",prefix:"modifications"})],e.prototype,"modifications",void 0),o([L(["web-scene","portal-item"],"modifications")],e.prototype,"readModifications",null),o([a({type:c})],e.prototype,"spatialReference",void 0),o([a({type:y})],e.prototype,"fullExtent",void 0),o([a($)],e.prototype,"elevationInfo",null),o([a({type:["show","hide"]})],e.prototype,"listMode",void 0),o([a(E)],e.prototype,"url",void 0),o([a({readOnly:!0})],e.prototype,"type",void 0),o([a({type:String,json:{origins:{"web-scene":{read:!0,write:!0},"portal-item":{read:!0,write:!0}},read:!1}})],e.prototype,"path",void 0),o([a({type:Number,json:{name:"layerDefinition.minScale",write:!0,origins:{service:{read:!1,write:!1}}}})],e.prototype,"minScale",void 0),o([a({type:Number,json:{name:"layerDefinition.maxScale",write:!0,origins:{service:{read:!1,write:!1}}}})],e.prototype,"maxScale",void 0),o([a()],e.prototype,"replacesTerrain",null),o([a()],e.prototype,"_isUsedAsGroundLayer",null),o([a()],e.prototype,"hasGoogleUrl",null),e=o([T("esri.layers.IntegratedMesh3DTilesLayer")],e);const Rt=e;export{Rt as default};
