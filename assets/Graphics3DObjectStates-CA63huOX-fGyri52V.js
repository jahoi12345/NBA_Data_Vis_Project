import{i as I,q as U,U as N,Y as l,H as p,G as z}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{I as F,j as f,i as L,o as $}from"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import{a as q}from"./ExtentSet-BmZuhn8E-BsM0ovD8.js";import{r as x,v as W}from"./Scheduler-CNrsbccs-Bcg8fWoS.js";import{a5 as C}from"./Point-BfTTZoMu-BAT2Wq6O.js";import{m as G}from"./mathUtils-PIGhLnI9-B1tKUlUb.js";import{z as Y}from"./mat4-C96X-Nn0-Do6fKsNS.js";import{n as V}from"./mat4f64-q_b6UJoq-Dh6sWB_w.js";import{O as K,k as S,i as J,V as O,L as u,A as j}from"./vec32-CewSdTn3-DHOFKD0R.js";import{t as y}from"./collectionUtils-jDyktm0P-ArdXNs6F.js";import{y as Q}from"./computeTranslationToOriginAndRotation-Bjd4esRf-CXUng2L4.js";import{ay as X,az as Z}from"./ShadowCastClear.glsl-CeOT_rAo-iOFMl8eB.js";import{x as tt}from"./projectVectorToVector-Csv3NYZI-BsIKHfQD.js";import{f as et,D as it,l as st}from"./aaBoundingBox-Cn49X7ge-DORLZxoS.js";import{H as rt,y as nt}from"./aaBoundingRect-CjwcS2F3-D7aII9DY.js";import{x as at,P as ot}from"./frustum-CMzahy3--CFytpSYl.js";import{K as v,H as D,v as R,W as ht,j as B}from"./plane-BNdSPG2o-Cq7jmU6w.js";import{b as T}from"./sphere-DLQ6p7mp-DmnRpHXV.js";let _=class extends U{constructor(i){super(i),this._dirtyExtents=new q,this._globalDirty=!1,this._averageExtentUpdateSize=0,this._dirtyGraphicsSet=new Set,this._updateElevation=!1,this.graphicsCoreOwner=null,this.graphicsCore=null,this.events=new F}initialize(){const i=this.elevationProvider,t=this.graphicsCoreOwner.view.resourceController.scheduler;this._task=t.registerTask(H(this.graphicsCore.layer.elevationInfo?.mode),this),this.addHandles([i.on("elevation-change",e=>this._elevationChanged(e)),f(()=>this.graphicsCoreOwner.suspended,()=>this._suspendedChange()),this._task,f(()=>H(this.graphicsCore.layer.elevationInfo?.mode),e=>this._task.priority=e)])}destroy(){this._dirtyGraphicsSet.clear(),this.graphicsCoreOwner=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null,this.elevationProvider=null,this._dirtyExtents.destroy()}clear(){this._dirtyGraphicsSet.clear(),this.notifyChange("updating")}_suspendedChange(){this.graphicsCoreOwner.suspended===!0?this._updateElevation=!1:this.graphicsCoreOwner.suspended===!1&&this._updateElevation&&(this._globalDirty=!0,this.notifyChange("updating"))}elevationInfoChange(){this._globalDirty=!0,this.notifyChange("updating")}get updating(){return this.readyToRun}get readyToRun(){return this._dirtyGraphicsSet.size>0||this._dirtyExtents&&!this._dirtyExtents.empty||this._globalDirty}get updatingRemaining(){return this._dirtyGraphicsSet.size+this._dirtyExtents.size*this._averageExtentUpdateSize}runTask(i){for(this._globalDirty&&(this._markAllGraphicsElevationDirty(),this._globalDirty=!1,i.madeProgress()),i.run(()=>this._dirtyExtents.merge(i));this.readyToRun&&!i.done;)this._updateDirtyGraphics(i),this._updateDirtyExtents(i);this.notifyChange("updating")}_updateDirtyGraphics(i){const t=this.graphicsCoreOwner.view.renderCoordsHelper,e=this.graphicsCore.effectiveUpdatePolicy===0;for(const s of this._dirtyGraphicsSet.keys()){const r=this.graphicsCore.getGraphics3DGraphicById(s);if(this._dirtyGraphicsSet.delete(s),r!=null&&(r.alignWithElevation(this.elevationProvider,t,e),this.graphicsCore.deconflictor?.setDirty(),i.madeProgress()),i.done)return}}_updateDirtyExtents(i){for(;!this._dirtyExtents.empty&&!i.done;){const t=this._dirtyExtents.pop(),e=this.elevationProvider.spatialReference;this.events.emit("invalidate-elevation",{extent:t,spatialReference:e});const s=this._dirtyGraphicsSet.size;this.queryGraphicUIDsInExtent(t,e,r=>{const n=this.graphicsCore.getGraphics3DGraphicById(r);n!=null&&n.needsElevationUpdates()&&this._dirtyGraphicsSet.add(r)}),this._averageExtentUpdateSize=.1*(this._dirtyGraphicsSet.size-s)+.9*this._averageExtentUpdateSize,i.madeProgress()}}_markAllGraphicsElevationDirty(){this._dirtyExtents.clear(),this._dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach((i,t)=>this._dirtyGraphicsSet.add(t))}_elevationChanged(i){if(i.context==="scene"&&(!this.graphicsCore.layer.elevationInfo||this.graphicsCore.layer.elevationInfo.mode!=="relative-to-scene"))return;const t=i.extent;if(this.graphicsCoreOwner.suspended){if(!this._updateElevation){const e=this.graphicsCore.computedExtent;e&&t[2]>e.xmin&&t[0]<e.xmax&&t[3]>e.ymin&&t[1]<e.ymax&&(this._updateElevation=!0)}this.events.emit("invalidate-elevation",i)}else t[0]===-1/0?this._globalDirty=!0:this._dirtyExtents.add(t),this.notifyChange("updating")}};function H(i){return i==null?x.ELEVATION_ALIGNMENT:i==="relative-to-scene"?x.ELEVATION_ALIGNMENT_SCENE:x.ELEVATION_ALIGNMENT}l([p()],_.prototype,"graphicsCoreOwner",void 0),l([p()],_.prototype,"graphicsCore",void 0),l([p()],_.prototype,"queryGraphicUIDsInExtent",void 0),l([p()],_.prototype,"elevationProvider",void 0),l([p({readOnly:!0})],_.prototype,"updating",null),l([p({readOnly:!0})],_.prototype,"updatingRemaining",null),_=l([z("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],_);const P=.5*Math.PI,ct=P/Math.PI*180;class lt{constructor(t){this._extent=new Array(4),this._planes=new Array(6),this._maxSpan=0,this._center={origin:y(),direction:y()},this._renderCoordsHelper=t.renderCoordsHelper;for(let e=0;e<4;e++)this._extent[e]={origin:y(),direction:y(),cap:{next:null,direction:y()}},this._planes[e]=v();this._planes[4]=v(),this._planes[5]=v(),this._planesWithoutFar=this._planes.slice(0,5)}update(t,e,s,r=!0){const n=this._extent;this._toRenderBoundingExtent(t,e,s),K(this._center.origin,n[0].origin,n[2].origin),S(this._center.origin,this._center.origin,.5),this._renderCoordsHelper.worldUpAtPosition(this._center.origin,this._center.direction),r||S(this._center.direction,this._center.direction,-1);for(let a=0;a<4;a++){const h=n[a];this._renderCoordsHelper.worldUpAtPosition(h.origin,h.direction);const g=n[a===3?0:a+1];h.cap.next=g.origin,J(h.cap.direction,h.origin,g.origin),D(h.direction,h.cap.direction,h.origin,this._planes[a]),r||S(h.direction,h.direction,-1)}D(n[0].cap.direction,n[1].cap.direction,n[0].origin,this._planes[4]),r?R(this._planes[4],this._planes[5]):(ht(this._planes[5],this._planes[4]),R(this._planes[4],this._planes[4])),this._maxSpan=Math.max(Math.abs(t[0]-t[2]),Math.abs(t[1]-t[3])),this._maxSpanSpatialReference=e,this._minGlobalAltitude=.9*C(this._maxSpanSpatialReference).radius}isVisibleInFrustum(t,e,s=!1){if(t==null)return!1;if(this._renderCoordsHelper.viewingMode===1){const n=this._maxSpanSpatialReference.isGeographic?ct:P*e;if(this._maxSpan>n)return!0;if(t.altitude!=null&&t.altitude>=this._minGlobalAltitude)return this._isVisibleInFrustumGlobal(t)}if(this._maxSpan===0){const n=this._extent[0];return!(s||!t.intersectsRay(T(n.origin,n.direction)))}for(let n=0;n<this._extent.length;n++){const a=this._extent[n];if(!s&&t.intersectsRay(T(a.origin,a.direction))||t.intersectsLineSegment(at(a.origin,a.cap.next,pt),a.cap.direction))return!0}const r=s?this._planes:this._planesWithoutFar;for(let n=0;n<t.lines.length;n++){const a=t.lines[n];if(X(r,a.origin,a.endpoint,a.direction))return!0}return!1}_toRenderBoundingExtentGlobal(t,e,s){rt(t,c),c[2]=s,Q(e,c,b,this._renderCoordsHelper.spatialReference),Y(A,b),et(o);for(const{x0:r,x1:n,y0:a,y1:h}of dt)for(let g=0;g<5;g++){const E=g/4;c[0]=G(t[r],t[n],E),c[1]=G(t[a],t[h],E),c[2]=s,tt(c,e,c,this._renderCoordsHelper.spatialReference),O(c,c,A),it(o,c)}u(this._extent[0].origin,o[0],o[1],o[2]),u(this._extent[1].origin,o[3],o[1],o[2]),u(this._extent[2].origin,o[3],o[4],o[2]),u(this._extent[3].origin,o[0],o[4],o[2]);for(let r=0;r<4;++r)O(this._extent[r].origin,this._extent[r].origin,b)}_toRenderBoundingExtentLocal(t,e,s){Z(t,e,d,this._renderCoordsHelper.spatialReference),u(this._extent[0].origin,d[0],d[1],s),u(this._extent[1].origin,d[2],d[1],s),u(this._extent[2].origin,d[2],d[3],s),u(this._extent[3].origin,d[0],d[3],s)}_toRenderBoundingExtent(t,e,s){switch(this._renderCoordsHelper.viewingMode){case 1:this._toRenderBoundingExtentGlobal(t,e,s);break;case 2:this._toRenderBoundingExtentLocal(t,e,s);break;default:N(this._renderCoordsHelper.viewingMode)}}_isVisibleInFrustumGlobal(t){if(B(t.planes[4],this._center.origin)<0&&j(this._center.direction,t.direction)<0)return!0;for(let e=0;e<4;e++){const s=this._extent[e];if(B(t.planes[4],s.origin)<0&&j(s.direction,t.direction)<0)return!0}return!1}}const dt=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],c=y(),b=V(),A=V(),o=st(),d=nt(),pt=ot(),ut=1.2;let m=class extends U{constructor(i){super(i),this.suspended=!1,this._extent=null,this._extentIntersectionDirty=!0,this._isVisibleBelowSurfaceInternal=!1,this.graphicsCoreOwner=null,this.updating=!0}initialize(){const{graphicsCoreOwner:i}=this;this._extentIntersection=new lt({renderCoordsHelper:i.view.renderCoordsHelper});const t=i.view,e=t.basemapTerrain,s=t.resourceController.scheduler;this.addHandles([t.on("resize",()=>this._viewChange()),f(()=>t.state.camera,()=>this._viewChange(),L),s.registerTask(x.FRUSTUM_VISIBILITY,this),f(()=>e.visibleElevationBounds,()=>this._elevationBoundsChange())]),t.viewingMode==="local"?this._isVisibleBelowSurface=!0:this.addHandles([f(()=>[e.baseOpacity,e.wireframe,t.map?.ground?.navigationConstraint?.type],()=>this._updateIsVisibleBelowSurface(),$)])}destroy(){this._set("graphicsCoreOwner",null),this._extent=null,this._extentIntersection=null}_setDirty(){this.updating||this._set("updating",!0)}setExtent(i){this._extent=i,this._extentIntersectionDirty=!0,this._setDirty()}_viewChange(){this._setDirty()}_elevationBoundsChange(){this._setDirty(),this._extentIntersectionDirty=!0}set _isVisibleBelowSurface(i){this._isVisibleBelowSurfaceInternal=i,this._setDirty(),this._extentIntersectionDirty=!0}_updateIsVisibleBelowSurface(){const i=this.graphicsCoreOwner.view,t=i.basemapTerrain,e=i.viewingMode==="local",s=i.map.ground?.navigationConstraint?.type==="none";this._isVisibleBelowSurface=e||!t.opaque||s}_updateExtentIntersection(){if(!this._extentIntersectionDirty)return;this._extentIntersectionDirty=!1;const i=this.graphicsCoreOwner.view;let t;if(this._isVisibleBelowSurfaceInternal)t=-.3*C(i.spatialReference).radius;else{const{min:e,max:s}=i.basemapTerrain.visibleElevationBounds;t=e-Math.max(1,(s-e)*(ut-1))}this._extentIntersection.update(this._extent,i.spatialReference,t)}get readyToRun(){return this.updating}runTask(i){if(this._set("updating",!1),!this._extent)return this._set("suspended",!1),W;this._updateExtentIntersection();const t=this.graphicsCoreOwner.view.frustum,e=C(this.graphicsCoreOwner.view.spatialReference).radius;this._set("suspended",!this._extentIntersection.isVisibleInFrustum(t,e)),i.madeProgress()}};l([p({readOnly:!0})],m.prototype,"suspended",void 0),l([p({constructOnly:!0})],m.prototype,"graphicsCoreOwner",void 0),l([p({readOnly:!0})],m.prototype,"updating",void 0),m=l([z("esri.views.3d.layers.graphics.Graphics3DFrustumVisibility")],m);class w{}class _t extends w{constructor(t,e){super(),this.objectStateId=t,this.object=e}remove(){this.object.removeStateID(this.objectStateId)}}let gt=class extends w{constructor(i,t,e){super(),this.objectStateId=i,this.object=t,this.owner=e}remove(){this.owner.removeRenderGeometryObjectState(this.object,this.objectStateId)}};class yt extends w{constructor(t,e){super(),this.objectStateId=t,this._removeCallback=e,this.object=null}remove(){this._removeCallback(this.objectStateId)}}class M{constructor(){this._items=[]}addObject(t,e){this._items.push(new _t(e,t))}addRenderGeometry(t,e,s){this._items.push(new gt(e,t,s))}addExternal(t,e){this._items.push(new yt(e,t))}remove(t){this._remove(e=>e.objectStateId===t)}removeByObject(t){this._remove(e=>e.object===t)}removeAll(){this._items.forEach(t=>t.remove()),this._items=[]}_remove(t){const{_items:e}=this;for(let s=e.length-1;s>=0;--s){const r=e[s];t(r)&&(r.remove(),e.splice(s,1))}}}let mt=class extends M{constructor(){super(...arguments),this.stateType=1}},ft=class extends M{constructor(i){super(),this.highlightName=i,this.stateType=0}};class k{constructor(t){this.objectIdField=t,this.ids=new Set,this.paused=!1}hasGraphic(t){const e=this.objectIdField?t.graphic.attributes[this.objectIdField]:t.graphic.uid;return this.ids.has(e)}}class xt extends k{constructor(t){super(t),this.stateType=1,this.objectStateSet=new mt}}class St extends k{constructor(t,e){super(e),this.highlightName=t,this.stateType=0,this.objectStateSet=new ft(t)}}class Pt{constructor(t){this._graphicsCore=t,this._stateSets=new Array}destroy(){this.reset(),this._stateSets=null}reset(){this._stateSets&&(this._stateSets.forEach(t=>t.objectStateSet.removeAll()),this._stateSets.length=0)}acquireOccludeeSet(t){const e=new xt(t);this._stateSets.push(e);const s=I(()=>this.releaseSet(e));return{set:e,handle:s}}acquireHighlightSet(t,e){const s=new St(t,e);this._stateSets.push(s);const r=I(()=>this.releaseSet(s));return{set:s,handle:r}}releaseSet(t){t.objectStateSet.removeAll();const e=this._stateSets?this._stateSets.indexOf(t):-1;e!==-1&&this._stateSets.splice(e,1)}setUid(t,e){t.ids.add(e);const s=this._graphicsCore.graphics3DGraphics.get(e);s&&s.addObjectStateSet(t.objectStateSet)}setUids(t,e){e.forEach(s=>this.setUid(t,s))}setObjectIds(t,e){e.forEach(s=>t.ids.add(s)),this._initializeSet(t)}addGraphic(t){this._stateSets.forEach(e=>{!e.paused&&e.hasGraphic(t)&&t.addObjectStateSet(e.objectStateSet)})}removeGraphic(t){this._stateSets.forEach(e=>{e.hasGraphic(t)&&t.removeObjectState(e.objectStateSet)})}allGraphicsDeleted(){this._stateSets&&this._stateSets.forEach(t=>t.objectStateSet.removeAll())}_initializeSet(t){const e=this._graphicsCore.graphics3DGraphics;t.objectIdField?e.forEach(s=>{s&&t.hasGraphic(s)&&s.addObjectStateSet(t.objectStateSet)}):t.ids.forEach(s=>{const r=e.get(s);r&&r.addObjectStateSet(t.objectStateSet)})}get test(){}}export{Pt as N,_,m as y};
