import{q as oe,m as ne,s as ae,v as le,Y as k,H as P,G as ue}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{R as me,t as n,Z as Et,M as pe,e as ce}from"./collectionUtils-jDyktm0P-ArdXNs6F.js";import{j as ht,l as Ot,i as Ct}from"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import{n as qt}from"./signal-BX9ezF8a-cf1Pn6io.js";import{y as he,d as kt,_ as fe}from"./aaBoundingRect-CjwcS2F3-D7aII9DY.js";import{s as At,u as Tt}from"./FeatureTileDescriptor-n_NQwd9p-Cu6-pgr7.js";import{a as vt,L as d,l as E,A as T,k as Z,I as Gt,f as B,h as N,w as at,F as tt,O as Mt}from"./vec32-CewSdTn3-DHOFKD0R.js";import{F as ft}from"./frustum-CMzahy3--CFytpSYl.js";import{A as de}from"./sphere-DLQ6p7mp-DmnRpHXV.js";import{a5 as _e}from"./Point-BfTTZoMu-BAT2Wq6O.js";import{z as ge}from"./spatialReferenceEllipsoidUtils-D2JabnKt-Cip58jmo.js";import{b as ve,C as ye,d as Te}from"./projectionUtils-BGH_5_I3-BySNUA-B.js";import{L as ot,j as mt}from"./plane-BNdSPG2o-Cq7jmU6w.js";import{a8 as Me,aa as Re}from"./Texture-CFNZjV2R-lGBztxVp.js";import{aa as be}from"./ShadowCastClear.glsl-CeOT_rAo-iOFMl8eB.js";import{r as Rt,d as Pt}from"./Scheduler-CNrsbccs-Bcg8fWoS.js";import"./index-CTl7hdrJ.js";import"./Extent-CgDMOSRD-CU1qE5Kr.js";import"./mathUtils-PIGhLnI9-B1tKUlUb.js";import"./Polygon-D6wEPb3W-CpL9Efjx.js";import"./vector-B8ZDYGQ6-B1uNywRb.js";import"./mat4f64-q_b6UJoq-Dh6sWB_w.js";import"./quatf64-CCm9z-pX-CQ7_sSji.js";import"./vec2f64-rIxtbMRN-Kai9mK1i.js";import"./vec4f64-DPb6J-GU-C7c2DqbZ.js";import"./mat4-C96X-Nn0-Do6fKsNS.js";import"./vec42-B8VM4vXb-BnA9MysM.js";import"./Polyline-CoiTLswR-BLagWJLS.js";import"./Indices-D0_UQPPr-t1Qev6md.js";import"./BufferView-Cj2sQaht-DuP-iLZg.js";import"./Emissions.glsl-B8XKMjLy-DXfiRNVX.js";import"./Color-CERqXxxY-BuYn26eI.js";import"./aaBoundingBox-Cn49X7ge-DORLZxoS.js";import"./orientedBoundingBox-BLEx7wLU-CPBtS4XC.js";import"./quat-B7J5v7rV-i-DOMCm_.js";import"./InterleavedLayout-B7roQAzV-CC2VYRPC.js";import"./lengthUtils-Dt1_RvOO-bleznLOi.js";import"./date-IqUzANpt-bLKO9IDT.js";import"./projectVectorToVector-Csv3NYZI-BsIKHfQD.js";import"./normalizeUtils-85zLqeMi-DCF9gKvo.js";import"./normalizeUtilsCommon-CnhQye_A-zWtr51r8.js";import"./typeUtils-DqrRcjBx-ZWdHcSIJ.js";import"./modeUtils-BA-mAwuS-UrytRxLw.js";import"./intl-DRFqUect-ClAS7BRt.js";import"./sanitizerUtils-BT_8V5US-CWQWUwZQ.js";import"./workers-BEkgoq8Q-BNWfkyQs.js";import"./PooledRBush-Dco5QkUp-DX3CMhf3.js";import"./GraphicsCollection-Bk6M0b7D-ByzFamPI.js";import"./Graphic-DgGzDmqW-CFzg0c4i.js";import"./getPopupProvider-CmskPttI-C4PqyuPF.js";import"./Layer-DZvC7bne-m1cEC_yw.js";import"./typeUtils-CXW_VpOn-BoSnXkME.js";import"./lineMarkers-CDwLe3J6-CNUjJvs3.js";import"./PolygonSymbol3D-BXRHZiCQ-Vi0-2Gvc.js";import"./ExtrudeSymbol3DLayer-DSc1ou2x-CsVYZCeG.js";import"./Font-BwmnW7d2-D-oIm_Md.js";import"./SimpleFillSymbol-CDawtd9z-CWD2KI2D.js";import"./SimpleMarkerSymbol-BGAFRS9_-CVQ5NLIA.js";import"./PictureMarkerSymbol-CaSh-vZk-BNpExnAb.js";import"./TextSymbol-hRGhyDHs-C0NgASym.js";import"./HeightModelInfo-D5IdRvJ2-BK9di2bT.js";import"./RealisticTree.glsl-WN9nrQUl-CRRcYwOn.js";import"./MeshLocalVertexSpace-BGd1IdEs-DqCdtROz.js";import"./vec3f32-WCVSSNPR-9V6Uhrx-.js";import"./TilemapCache-CjhKW_vj-BYOTuKe8.js";import"./LRUCache-fy84PBMi-Y56WPIvD.js";import"./UpdatingHandles-D2RI_3Hb-dwLPjVun.js";import"./asyncUtils-w6KfWU41-HenJ0UOu.js";import"./Map-AEYszeHg-D2YZkc1e.js";import"./Basemap-CL_uaRmk-ChnHJfg0.js";import"./PortalItem-DnxMlRVo-Dhq4alsp.js";import"./writeUtils-DEFpwIW1-D44H3UWs.js";import"./CollectionFlattener-D6h2Fkvj-qnUHjb1M.js";import"./resourceExtension-DOTCeiZj-BXiJr75H.js";import"./PolygonCollection-HNNpnBH7-C5NQ6xHr.js";import"./mat4f32-Djp3mnm5-DzYG3LYB.js";import"./Query-BlS0WPDF-BdshFBMz.js";import"./Field-Cm_ZejYW-CwJZmSru.js";import"./fieldType-DVUzXtk_-tUuvnZJM.js";import"./ElevationQuery-DzlYa4L4-BxQXlEAE.js";import"./TileInfo-Bz7QlefV-tjhen9qQ.js";import"./constants-D67WmGms-H7IOwEdB.js";import"./floatRGBA-D-Q4FzNN-BzjdY1tU.js";import"./UnknownTimeZone-B697BDFv-CBbtul7O.js";import"./TileKey-C44YQC4_-BW7BBbYp.js";import"./unitConversionUtils-4vB4Ezlp-B0eWR3Ls.js";import"./vec2f32-CaVKkSa6-BjkBmyoj.js";import"./Octree-DckBBpQ7-BC8mmFdF.js";import"./axisAngleDegrees-CjbXmycq-LMRXo165.js";import"./edgePreprocessing-D_eX-fWy-CRLN12td.js";import"./vec3-B_phcnZY-DHC7I6xa.js";import"./vec33-CWJeyzxV-Me4sF5XB.js";import"./reader-DcGs6kKN-DHJfK-tm.js";import"./SimpleObservable-CvFyr0NA-DXpoMYph.js";import"./enums-B4pqBiXb-BO-3hS_8.js";import"./screenUtils-BitdhK1O-L0FLPAMi.js";import"./Cyclical-BLSxUpe7-Bj8R2Yk-.js";import"./projectPointToVector-DL7Z4uvb-BbcUuq8O.js";import"./HUDIntersectorResult-1xTExS7z-CU1-YQoW.js";import"./VertexElementDescriptor-BlxU8vCE-BwuKQkTU.js";import"./videoUtils-Dwx3AEgj-CduhpDRk.js";import"./jsonUtils-CmpazY1u-ateEpj4Q.js";import"./scaleUtils-yfx9kKWT-BPfZ-Fh2.js";import"./layerUtils-DZGhvm-W-DLw3QMll.js";import"./tagSymbols-BPcGfZon-BPcGfZon.js";import"./Queue-CYlrXMwB-CYJTUII-.js";import"./timeZoneUtils-BSc7-7qA-BAv3h8mh.js";import"./ReactiveMap-B0by2bYu-DCsCfMj5.js";import"./TablesMixin-Q80MT3nU-CFBTh0j7.js";import"./memoryEstimations-Bd726a_p-0cVCY2Jz.js";import"./computeTranslationToOriginAndRotation-Bjd4esRf-CXUng2L4.js";import"./layerViewUtils-BTa15X3o-BjQlX2q8.js";import"./dehydratedFeatures-Ql-uVzLq-DehgeO5I.js";import"./quantizationUtils-Ceq-Uxsu-CDK8m1qL.js";import"./featureConversionUtils-BDA_FXJx-CUwkrHf5.js";import"./OptimizedFeature-CwRGZPwv-Ddclhn0A.js";import"./OptimizedFeatureSet-BR8EEvDc-CgsRgxJh.js";import"./createFeatureId-CVwTD0fV-3fKpJDrk.js";import"./elevationInfoUtils-B8MpdRMP-CN_w2fPT.js";import"./intersectorUtilsConversions-pLQPEbcN-rV-4Q5_m.js";import"./Intersector-DS9YtyQY-CuzM48xl.js";import"./DefaultLoadingContext-DXgBe4GE-Colk9t6X.js";import"./wosrLoader-CIPfz1Cl-qtGxLmBP.js";import"./Version-BtYZEj58-LyRHDnSJ.js";import"./DoubleArray-DExKNiTh-CvVpHySW.js";import"./config-Dg972SSE-D9DBKeq5.js";import"./GeometryUtils-C354xUs0-CG8X9WjO.js";import"./definitions-Dvg4hMIw-CdK2DzFN.js";import"./WorkerHandle-B930SiRy-b7IwaSpV.js";import"./colorUtils-CeIi7j7j-nwrKvQYb.js";import"./capabilities-Bi6C4OG6-CpURufko.js";import"./imageUtils-142g71N8-CjUugWaS.js";import"./uuid-Oe6SV2kF-IYX19xBA.js";import"./quickselect-QQC62dOK-Br2Ahhru.js";import"./meshVertexSpaceUtils-CtG7DPVT-V_uCtHpB.js";import"./TileKey-CXWFOqOI-CcilLir8.js";import"./loadAll-BCyxerwc-DK9uHnLK.js";import"./opacityUtils-DuFH0EC9-DWspTgn2.js";import"./persistable-CdoDQOTR-CH9U-JJT.js";import"./MD5-MtSiOt06-jWr180Yc.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw-DH8sdIsE.js";import"./utils-CylVuxNi-CqOfmBVG.js";import"./utils-Dpg4yj1D-BVnuoMV8.js";import"./types-BKo2foNY-DE0QfIFp.js";import"./labelUtils-BtizwBfq-Zegx4520.js";import"./ArcadeExpression-BlIRq-oN-DGzfhzBj.js";import"./TimeOnly-BERR31kg-PKcKegNB.js";import"./enum-BzLwmiID-CcyIdWlQ.js";import"./FieldsIndex-CimK-TqD-CrSnohIk.js";function we(t,r,e,s,i,o,a=1){const l=ye(r,i);if(l==null)return!1;if(l===Te){if(t===s&&e===o)return!0;const m=e+a;for(let p=e,h=o;p<m;++p,++h)Gt(s[h],t[p]);return!0}const u=e+a;for(let m=e,p=o;m<u;++m,++p)l(t[m],0,s[p],0);return!0}let xe=class{constructor(t,r){this._renderCoordsHelper=t,this.opaqueGround=r,this._cache=new Map,this._cameraForward=n(),this._cameraEye=n(),this._cameraFovY=55*Math.PI/180,this._frustumBoundingSphereCenter=n(),this._frustumBoundingSphereRadius=0,this._frustum=new Re(t),this._renderSR=t.spatialReference;const e=ge(this._renderSR);this._renderSREllipsoidRadius=_e(e).radius}setup(t){this._aboveGround=t.aboveGround,this._frustum.update(t),E(this._cameraForward,t.viewForward),Gt(this._cameraEye,t.eye),this._cameraFovY=t.fovY,this._updateFrustumBoundingSphere()}done(){this._cache.clear()}compute(t){if(this._cache.has(t.id))return this._cache.get(t.id);const r=this._isVisibleInFrustum(t);return this._cache.set(t.id,r),r}_isVisibleInFrustum(t){return this._renderCoordsHelper.viewingMode===2?this._isTileVisibleInFrustumLocal(t):this._isTileVisibleInFrustumGlobal(t)}_updateFrustumBoundingSphere(){const t=this._frustum,r=t.origin,e=Ce;E(e,t.direction);const s=t.points,i=qe;N(i,s[4],r);const o=.5*T(i,i)/T(e,i),a=this._frustumBoundingSphereCenter;at(a,r,e,o);const l=1+o;this._frustumBoundingSphereRadius=l}_isTileVisibleInFrustumLocal(t){const r=t.spatialReference,e=t.extent,s=this._renderSR;if(!e)return!0;if(M[0]=e[0],M[1]=e[1],M[2]=0,M[3]=e[2],M[4]=e[3],M[5]=0,!ve(M,r,0,M,s,0))return!1;d($[0],M[0],M[1],0),d($[1],M[3],M[1],0),d($[2],M[3],M[4],0),d($[3],M[0],M[4],0),d(dt,.5*(M[0]+M[3]),.5*(M[1]+M[4]),.5*(M[2]+M[5]));const i=Vt,o=.5*B($[0],$[2]),a=this._frustum,l=this._frustumBoundingSphereRadius,u=this._frustumBoundingSphereCenter,m=Ae;N(m,u,dt);const p=T(i,m),h=ke;if(at(h,dt,i,p),B(h,u)>o+l)return!1;const R=this._cameraForward,_=T(R,Vt),C=this._cameraFovY,g=this._cameraEye;if(Math.abs(_)<Math.abs(Math.cos(.5*C))){let c=!0;const G=d(ur,R[0],R[1],0),L=T(g,G);for(let F=0;F<4;++F){const V=$[F];if(T(V,G)-L>0){c=!1;break}}if(c)return!1}{const c=$[0],G=$[2];if(c[0]<=g[0]&&g[0]<=G[0]&&c[1]<=g[1]&&g[1]<=G[1])return!0}const f=Ge,w=this.opaqueGround&&this._aboveGround,z=this.opaqueGround&&!this._aboveGround,I=Math.min(z?ut:1/0,p+l),U=Math.max(w?-ut:-1/0,p-l);for(let c=0;c<4;++c)at(f[c],$[c],i,I),at(f[c+4],$[c],i,U);if(Bt(a.planes,f,8))return!1;if(bt(a.planes,f,8))return!0;for(let c=0;c<4;++c){const G=f[c],L=f[c+4];if(St(a.planes,G,L))return!0;const F=f[(c+1)%4];if(St(a.planes,G,F))return!0;const V=f[4+(c+1)%4];if(St(a.planes,L,V))return!0}if(Y[0][3]=+$[0][0],Y[1][3]=-$[2][0],Y[2][3]=+$[0][1],Y[3][3]=-$[2][1],Y[4][3]=+U,Y[5][3]=-I,bt(Y,a.points)||bt(Y,a.points))return!0;for(let c=0;c<4;++c){const G=g,L=a.points[c+4];if(Wt(Y,G,L))return!0;const F=a.points[4+(c+1)%4];if(Wt(Y,L,F))return!0}return!1}_isTileVisibleInFrustumGlobal(t){if(t.level<gt)return!0;const r=t.spatialReference,e=t.extent;if(!e||!r)return!0;const s=this.opaqueGround&&this._aboveGround,i=this.opaqueGround&&!this._aboveGround,o=$,a=.5*(e[0]+e[2]);if(d(o[0],e[0],e[1],0),d(o[1],e[2],e[1],0),d(o[2],e[2],e[3],0),d(o[3],e[0],e[3],0),d(o[4],a,e[1],0),d(o[5],a,e[3],0),!we(o,r,0,o,this._renderSR,0,6))return!1;const l=o[0][2]>0,u=o[3][2]<0,m=l||u,p=this._renderSREllipsoidRadius;if(m){const x=Fe;K(x,_t,o[0]);const b=$e;if(K(b,_t,o[1]),l){const y=Ut,v=o[4],S=Ht;K(S,v,_t),K(y,S,v);const q=o[0];tt(q,x,y),lt(q,p);const D=o[1];tt(D,b,y),lt(D,p)}else if(u){const y=Ut,v=o[5],S=Ht;K(S,v,_t),K(y,v,S);const q=o[3];tt(q,y,x),lt(q,p);const D=o[2];tt(D,y,b),lt(D,p)}}const h=dt,R=N(Ue,o[3],o[0]);E(R,R);const _=Mt(He,o[0],o[3]);Z(_,_,.5);const C=-T(_,R),g=Mt(je,o[0],o[1]);Z(g,g,.5);const f=Mt(Ve,o[2],o[3]);Z(f,f,.5);const w=N(We,f,g);E(w,w);const z=-(C+T(R,g))/T(R,w);at(h,g,w,z),lt(h,p);const I=this._frustumBoundingSphereRadius,U=this._frustumBoundingSphereCenter,c=this._frustum,G=c.planes,L=Ie;E(L,h);const F=T(o[0],L)/vt(o[0]),V=c.origin,J=c.points;let X=!1;if(s){{X=!0;const b=E(jt,V);for(let y=0;y<4;++y){const v=J[4+y],S=N(n(),v,V);E(S,S);const q=tt(n(),b,S);E(q,q);const D=tt(n(),S,q);if(E(D,D),T(V,D)>p){X=!1;break}}}if(X&&T(V,L)<p*F-ut)return!1;const x=E(jt,c.origin);if(T(x,L)<0)return!1;{const b=E(ar,c.direction);if(T(b,L)>lr)return!1}}const et=Math.sqrt(1-F*F);if(et>.9)return!0;let nt=!1;const rt=T(L,U),st=vt(U);if(st<=I&&!G.some(x=>mt(x,wt)>0)){if(!s)return!0;nt=!0}const it=rt/st;if(!nt&&rt<=0&&-rt>I)return!1;const A=I/st;if(Math.sqrt(1-it*it)*Math.sqrt(1-A*A)-A*it>et)return!1;if(!X&&(o.some(x=>c.intersectsPoint(x))||c.intersectsPoint(h)))return!0;const H=Pe;N(H,U,wt);const Q=T(H,L),pt=Oe;Z(pt,L,Q);const ee=B(pt,U),Ft=r.isWGS84,yt=t.lij,$t=Ft&&yt[2]===2**yt[0]-1,It=Ft&&yt[2]===0,re=It?er:$t?Xe:Qe,se=It?rr:$t?tr:Ke;if(!nt){const x=o,b=sr,y=Ye,v=ze,S=wt;for(const q of re){const D=x[q];if(Dt(y,x[(q+1)%4],D),Dt(v,S,D),K(b,v,y),Ee(b,J,1))return!1}}let j=null;if(!s&&Q<1.01*I){const x=2.5*I;if(ee>F*x+I)return!1;const b=Be,y=x/F;for(let v=0;v<4;++v)Z(b[v],o[v],y/p);d(b[4],0,0,0),j=b}else{const x=(i?p+ut:Q+I)/F,b=s?p-ut:(Q-I)/F,y=De;for(let v=0;v<4;++v){const S=o[v];Z(y[v],S,b/p),Z(y[v+4],S,x/p)}j=y}if(Bt(G,j,j.length))return!1;const ie=c.lines,W=Ne,ct=Ze;for(const x of ie){E(ct,x.direction);for(const b of se){const y=j[b];if(E(W,y),xt(ct,W,j,J))return!1;const v=(b+1)%4;if(s){const S=j[v];if(N(W,S,y),E(W,W),xt(ct,W,j,J))return!1}if(i){const S=j[4+b],q=j[4+v];if(N(W,q,S),E(W,W),xt(ct,W,j,J))return!1}}}return!0}};function K(t,r,e){return tt(t,r,e),E(t,t),t}function Dt(t,r,e){return N(t,r,e),E(t,t),t}function lt(t,r){return Z(t,t,r/vt(t)),t}const Kt=[0,1,2,3,5];function Se(t,r,e){for(let s=0;s<e;++s)if(mt(t,r[s])<=0)return!1;return!0}function Bt(t,r,e){for(const s of Kt)if(Se(t[s],r,e))return!0;return!1}function bt(t,r,e=r.length){for(let s=0;s<e;++s){const i=r[s];let o=!0;for(const a of t)if(mt(a,i)>0){o=!1;break}if(o)return!0}return!1}const gt=2,Le=4;function Ee(t,r,e){for(const s of r)if(T(s,t)<e)return!1;return!0}const Ge=[n(),n(),n(),n(),n(),n(),n(),n()],M=[0,0,0,0,0,0],$=[n(),n(),n(),n(),n(),n()],dt=n(),Ut=n(),Fe=n(),$e=n(),Ht=n(),Ie=n(),Oe=n(),Ce=n(),qe=n(),ke=n(),Ae=n(),wt=Et(0,0,0),Pe=n(),De=[n(),n(),n(),n(),n(),n(),n(),n()],Be=[n(),n(),n(),n(),n()],Ue=n(),He=n(),je=n(),Ve=n(),We=n(),Ye=n(),ze=n(),Ne=n(),Ze=n(),Je=n(),Qe=[0,1,2,3],Ke=[0,1,2,3],Xe=[0,1,3],tr=[0,1,3],er=[1,2,3],rr=[1,2,3],sr=n();function ir(t,r,e){let s=1/0,i=-1/0;for(const o of e){const a=T(r,o);s=Math.min(s,a),i=Math.max(i,a)}t[0]=s,t[1]=i}function or(t,r,e,s){let i=1/0,o=-1/0;for(const a of s){const l=T(e,a);if(i=Math.min(i,l),o=Math.max(o,l),i<=r&&o>=t)return!1}return!0}const nr=[0,0];function xt(t,r,e,s){const i=e.length,o=s.length;if(i===0||o===0)return!0;const a=Je;K(a,t,r);const l=o<i,u=l?e:s,m=nr;return ir(m,a,l?s:e),or(m[0],m[1],a,u)}const ut=430,jt=n(),ar=n(),lr=Math.cos(.25*Math.PI),Vt=pe(0,0,1),ur=n();function St(t,r,e){const s={t0:0,t1:1};for(const i of Kt)if(!Xt(t[i],r,e,s))return!1;return s.t0<s.t1}function Wt(t,r,e){const s={t0:0,t1:1};for(const i of t)if(!Xt(i,r,e,s))return!1;return s.t0<s.t1}function Xt(t,r,e,s){let{t0:i,t1:o}=s;const a=mt(t,r),l=mt(t,e);if(a>=0&&l>=0)return!1;if(a<0&&l>=0){const u=-a/(l-a);if(u<i)return!1;u<o&&(o=u)}else if(a>=0&&l<0){const u=a/(a-l);if(u>o)return!1;u>i&&(i=u)}return s.t0=i,s.t1=o,!0}const Y=[ot(-1,0,0,1),ot(1,0,0,-1),ot(0,-1,0,1),ot(0,1,0,-1),ot(0,0,-1,1),ot(0,0,1,-1)],_t=Et(0,0,1);class Yt{constructor(r,e,s){this._renderCoordsHelper=r,this._tilingScheme=e,this._camera=new Me,this._surfaceElevation=0,this._focusOnMap=[0,0],this._visibility=new xe(r,s)}set opaqueGround(r){this._visibility.opaqueGround=r}setup(r,e,s){this._camera.copyFrom(r),this._surfaceElevation=s,this._focusOnMap[0]=e.x,this._focusOnMap[1]=e.y,this._visibility.setup(this._camera)}done(){this._visibility.done()}update(r){const{measures:e,extent:s,level:i}=r;s&&(e.visible=this._visibility.compute(r),e.distance=fe(s,this._focusOnMap),e.mergeable=!0,e.lodLevel=gt,e.splitPriority=Math.max(0,gt-i),e.visible&&(this._isGlobal?this._updateSplitAndLodGlobal(r):this._updateSplitAndLodLocal(r)))}_updateSplitAndLodGlobal(r){const e=r.level,s=this._renderCoordsHelper,{eye:i,fov:o}=this._camera,a=s.referenceEllipsoid.radius,l=vt(i)-a;if(2*Math.atan(a/l)<o&&l>0)return void(r.measures.lodLevel=Math.max(e,gt));const u=zt,{extent:m}=r;if(!m)return;const{_surfaceElevation:p}=this;d(u[0],m[0],m[1],p),d(u[1],m[2],m[1],p),d(u[2],m[2],m[3],p),d(u[3],m[0],m[3],p);const h=d(Nt,.5*(m[0]+m[2]),.5*(m[1]+m[3]),p),R=this._tilingScheme.spatialReference;for(let f=0;f<4;++f)s.toRenderCoords(u[f],R,u[f]);s.toRenderCoords(h,R,h);const _=E(Lt.direction,h),C=T(i,_),g=Z(Zt,_,C);this._updateSplitAndLod(r,u,h,g)}_updateSplitAndLodLocal(r){const e=zt,{extent:s}=r;if(!s)return;const{_surfaceElevation:i}=this;d(e[0],s[0],s[1],i),d(e[1],s[2],s[1],i),d(e[2],s[2],s[3],i),d(e[3],s[0],s[3],i);const o=this._tilingScheme.spatialReference;for(let h=0;h<4;++h)this._renderCoordsHelper.toRenderCoords(e[h],o,e[h]);const a=d(Nt,.5*(e[0][0]+e[2][0]),.5*(e[0][1]+e[2][1]),.25*(e[0][2]+e[1][2]+e[2][2]+e[3][2])),l=d(mr,a[0],a[1],0),{eye:u,far:m}=this._camera,p=d(Zt,l[0],l[1],u[2]);d(Lt.origin,l[0],l[1],u[2]-2*m),Gt(Lt.direction,te),this._updateSplitAndLod(r,e,a,p)}_updateSplitAndLod(r,e,s,i){const o=Math.max(B(e[0],e[2]),B(e[1],e[3]),B(e[0],s)+B(s,e[2]),B(e[1],s)+B(s,e[3])),{eye:a,near:l,fov:u,viewForward:m,width:p,height:h,pixelRatio:R,frustum:_}=this._camera,C=T(a,m),g=T(s,m)-C,f=B(s,a);let w=g,z=g,I=f,U=f;const c=(A,H)=>H<l?1:Math.sqrt(A*A-H*H)/H;let G=c(f,g);for(const A of e){const H=T(A,m)-C;w=Math.min(w,H),z=Math.max(z,H);const Q=B(A,a);U=Math.max(U,Q),I=Math.min(I,Q);const pt=c(Q,H);G=Math.min(G,pt)}if(z<l)return void(r.measures.lodLevel=0);const L=Math.cos(.5*u),F=B(a,i);G>L&&F>cr*o&&(z=Jt*U,w=Jt*I);const V=.5*Math.sqrt(p*p+h*h)/R,J=2*Math.tan(.5*u),X=A=>Math.max(l,A)*pr/V*J,et=r.level,nt=o*2**et*Math.max(1,J),rt=X(w),st=Math.ceil(Math.log2(Math.max(1,nt/rt)));if(r.measures.lodLevel=Math.max(st,r.measures.lodLevel),r.measures.splitPriority+=r.measures.lodLevel-et,et<st){const A=+ft(_,e[0])+ +ft(_,e[1])+ +ft(_,e[2])+ +ft(_,e[3]);r.measures.splitPriority+=A}const it=X(z)/rt;it>2.5&&(r.measures.splitPriority+=it)}get _isGlobal(){return this._renderCoordsHelper.viewingMode===1}}const zt=[n(),n(),n(),n()],Nt=n(),mr=n(),Zt=n(),te=Et(0,0,1),Lt=de(ce,te),pr=312,cr=.5,Jt=2,hr=60;let O=class extends oe{constructor(t){super(t),this.tiles=new me,this.tileSize=512,this._idToTile=new Map,this._dirty=qt(!1),this._pendingTiles=qt(null),this._newTiles=new ne,this._tests=!1,this._measurements=new Yt(t.renderCoordsHelper,t.terrain.tilingScheme,this._opaqueGround)}initialize(){this.addHandles([ht(()=>this.tileSize,()=>this._reset(),Ot),ht(()=>[this.pointsOfInterest.cameraOnSurface?.location,this.viewState?.contentCamera,this.pointsOfInterest.focus?.location,this.terrain?.baseOpacity??1],()=>this._setDirty(),Ot),ht(()=>this.tilingScheme,t=>{this._reset(),this._measurements=new Yt(this.renderCoordsHelper,t,this._opaqueGround)},Ct),ht(()=>this._opaqueGround,t=>this._measurements.opaqueGround=t,Ct)]),this._frameWorker=this.scheduler?.registerTask(Rt.FEATURE_TILE_TREE,this)}destroy(){this._frameWorker=ae(this._frameWorker),this._measurements=null,this._newTiles.prune()}get tilingScheme(){return this.terrain.tilingScheme?.clone()}set filterExtent(t){if(t!=null&&!t.spatialReference.equals(this.viewState.spatialReference))return void le.getLogger(this).error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const r=this._get("filterExtent");if(r===t||r!=null&&t&&r.equals(t))return;const e=t!=null?t.clone():null;this._set("filterExtent",e),this._setDirty()}get _filterExtentRect(){if(this.filterExtent==null)return null;const t=he();return be(this.filterExtent,t,this.tilingScheme.spatialReference),t}get _rootTileIds(){const{tilingScheme:t}=this;return this._filterExtentRect&&t?t.rootTilesInExtent(this._filterExtentRect):[[0,0,0]]}set suspended(t){t!==this._get("suspended")&&(this._set("suspended",t),this._setDirty())}get updating(){return this._dirty.value||!!this._pendingTiles.value}get _opaqueGround(){return(this.terrain?.baseOpacity??1)===1}_setDirty(){this.suspended||(this._frameWorker?this._dirty.value=!0:this.runTask(Pt))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(!1),this._dirty.value=!1}get readyToRun(){return this.updating}_reset(t=!0){this._newTiles.clear(),this._pendingTiles.value=null,t&&this._setDirty()}_getRootTiles(){const t=this.tilingScheme;return this._rootTileIds.map(r=>new At(r[0],r[1],r[2],t))}runTask(t){t=this._tests?Pt:t,this._dirty.value=!1,this._pendingTiles.value||(this._startUpdate(t),this._frameWorker!=null&&(this._frameWorker.priority=Rt.FEATURE_TILE_TREE_ACTIVE)),this._splitPendingTiles(t),this._pendingTiles.value||this._frameWorker==null||(this._frameWorker.priority=Rt.FEATURE_TILE_TREE)}_startUpdate(t){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();const{_measurements:r,_filterExtentRect:e,_newTiles:s}=this;r.setup(this.viewState.contentCamera,this.pointsOfInterest.focus.location,this.pointsOfInterest.cameraOnSurface.location.z??0),this._pendingTiles.value=this._getRootTiles().filter(i=>{if(r.update(i),i.measures.visible&&(!e||!i.extent||kt(i.extent,e))){if(i.measures.splitPriority>0)return!0;s.push(i)}return!1}).sort(Qt),this._newTiles.clear(),t.madeProgress()}_splitPendingTiles(t){const r=this._pendingTiles.value;if(!r)return;const{tilingScheme:e,_filterExtentRect:s,_newTiles:i,_measurements:o}=this;for(;r.length>0&&this._tileBudgetRatio<=2;){const a=r.pop();if(t.madeProgress(),a.measures.splitPriority>0){e.ensureMaxLod(a.level+1);const l=a.createChildren();for(const u of l)o.update(u),!u.measures.visible||s&&u.extent&&!kt(u.extent,s)||(u.measures.splitPriority>0?r.push(u):i.push(u));r.sort(Qt),this._mergeNewTiles(2),this._mergeNewTiles(2,!0)}else i.push(a);if(t.done)return}i.pushArray(r),this._pendingTiles.value=null,this._updateTiles(),i.clear(),o.done()}get _tileBudgetRatio(){return(this._newTiles.length+(this._pendingTiles.value?.length??0))/hr}_mergeNewTiles(t,r=!1){if(this._tileBudgetRatio<=t)return;const{_newTiles:e,_measurements:s}=this;e.sort((a,l)=>l.measures.distance-a.measures.distance);const i=new Map(e.map(a=>[a.id,a])),o=e.length;for(const a of i.values()){const{lij:l,measures:u}=a;if(!u.mergeable||l[1]%2!=0||l[2]%2!=0||l[0]<=1||a.lodLevelDelta>=Le)continue;const m=u.lodLevel;let p=m,h=!0;const R=i.get(Tt(l[0],l[1]+1,l[2]));let _=Math.abs((R?.measures.lodLevel??0)-m),C=_===0||r&&R?.measures.mergeable&&_<=1;if(!R||!C)continue;p+=R.measures.lodLevel,h&&=_===0;const g=i.get(Tt(l[0],l[1],l[2]+1));if(_=Math.abs((g?.measures.lodLevel??0)-m),C=_===0||r&&g?.measures.mergeable&&_<=1,!g||!C)continue;p+=g.measures.lodLevel,h&&=_===0;const f=i.get(Tt(l[0],l[1]+1,l[2]+1));if(_=Math.abs((f?.measures.lodLevel??0)-m),C=_===0||r&&f?.measures.mergeable&&_<=1,!f||!C)continue;p+=f.measures.lodLevel,h&&=_===0,e.removeUnordered(a),e.removeUnordered(R),e.removeUnordered(g),e.removeUnordered(f),i.delete(a.id),i.delete(R.id),i.delete(g.id),i.delete(f.id);const w=new At(l[0]-1,l[1]/2,l[2]/2,this.tilingScheme);if(s.update(w),w.measures.visible=!0,w.measures.lodLevel=p/4,w.measures.mergeable=h,e.push(w),i.set(w.id,w),this._tileBudgetRatio<=t)return}e.length<o&&this._mergeNewTiles(t,r)}_updateTiles(){this._mergeNewTiles(1),this._mergeNewTiles(1,!0);for(const s of this.tiles.items)s.used=!1;let t=!1;const r=this._newTiles.filter(s=>{const i=this._idToTile.get(s.id);return i?(t||=i.measures.lodLevel!==s.measures.lodLevel,i.measures={...s.measures},i.used=!0):this._idToTile.set(s.id,s),!i}),e=this.tiles.items.filter(s=>!s.used&&(this._idToTile.delete(s.id),!0));this.tiles.removeMany(e),this.tiles.addMany(r),this._sortTiles(),!t||e.length||r.length||this.tiles.emit("change")}_sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort((t,r)=>t.measures.distance-r.measures.distance),this.tiles.forEach((t,r)=>t.loadPriority=r)}};function Qt(t,r){return t.lodLevelDelta-r.lodLevelDelta||t.measures.splitPriority-r.measures.splitPriority||r.measures.distance-t.measures.distance}k([P({constructOnly:!0})],O.prototype,"scheduler",void 0),k([P({constructOnly:!0})],O.prototype,"renderCoordsHelper",void 0),k([P({constructOnly:!0})],O.prototype,"pointsOfInterest",void 0),k([P({constructOnly:!0})],O.prototype,"viewState",void 0),k([P({constructOnly:!0})],O.prototype,"terrain",void 0),k([P()],O.prototype,"tiles",void 0),k([P()],O.prototype,"tileSize",void 0),k([P({readOnly:!0})],O.prototype,"tilingScheme",null),k([P()],O.prototype,"filterExtent",null),k([P({readOnly:!0})],O.prototype,"_filterExtentRect",null),k([P({readOnly:!0})],O.prototype,"_rootTileIds",null),k([P({value:!1})],O.prototype,"suspended",null),k([P({readOnly:!0})],O.prototype,"updating",null),O=k([ue("esri.views.3d.layers.support.FeatureTileTree3D")],O);export{O as FeatureTileTree3D};
