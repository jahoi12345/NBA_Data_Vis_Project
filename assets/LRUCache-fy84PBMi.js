import{G as g}from"./jsonMap-Bs3hmeCU.js";const c=-3,f=c-1,y=!!g("esri-tests-disable-gpu-memory-measurements");let R=class{constructor(t,e,i,r=0){this.name=t,this._storage=e,this.removeFunc=i,this._defaultPriority=r,this.id=`${S++}${a}`,this.size=0,this._hit=0,this._miss=0,this._storage.register(this)}destroy(){this._storage.deregister(this),this._storage=p}get hitRate(){return this._hit/(this._hit+this._miss)}get storageSize(){return this._storage.size}getSize(t){return this._storage.getSize(this,t)}set maxSize(t){this._storage.setMaxSize(this,t)}resetHitRate(){this._hit=this._miss=0}put(t,e,i=this._defaultPriority){this._storage.put(this,t,e,e.usedMemory,i)}pop(t){const e=this._storage.pop(this,t);return e===void 0?++this._miss:++this._hit,e}get(t){const e=this._storage.get(this,t);return e===void 0?++this._miss:++this._hit,e}peek(t){return this._storage.peek(this,t)}updateSize(t){this._storage.updateSize(this,t)}clear(){this._storage.clear(this)}clearAll(){this._storage.clearAll()}*[Symbol.iterator](){yield*this._storage.values(this)}get performanceInfo(){return this._storage.performanceInfo}resetStats(){this._storage.resetStats()}};class d{get size(){return this._size}constructor(t=10485760){this._maxSize=t,this._db=new Map,this._size=0,this._hit=0,this._miss=0,this._users=new Map,this._sizeLimits=new Map}destroy(){this.clearAll(),this._sizeLimits.clear(),this._users.clear(),this._db=null}register(t){this._users.set(t.id.slice(0,-1),t)}deregister(t){this.clear(t),this._sizeLimits.delete(t),this._users.delete(t.id.slice(0,-1))}get maxSize(){return this._maxSize}set maxSize(t){this._maxSize=Math.max(t,-1),this._checkSize()}getSize(t,e){return this._db.get(t.id+e)?.size??0}put(t,e,i,r,o){e=t.id+e;const s=this._db.get(e);if(s&&(this._size-=s.size,t.size-=s.size,this._db.delete(e),s.entry!==i&&this._notifyRemove(e,s.entry,s.size,0)),r>this._maxSize)return void this._notifyRemove(e,i,r,0);if(i===void 0)return void console.warn("Refusing to cache undefined entry ");if(!r||r<0)return y||console.warn(`Refusing to cache entry with size ${r} for key ${e}`),void this._notifyRemove(e,i,0,0);const h=1+Math.max(o,f)-c;this._db.set(e,new b(i,r,h)),this._size+=r,t.size+=r,this._checkSize()}updateSize(t,e){e=t.id+e;const i=this._db.get(e);if(!i)return;this._size-=i.size,t.size-=i.size;let r=i.entry.usedMemory;for(;r>this._maxSize;){const o=this._notifyRemove(e,i.entry,r,1);if(!(o!=null&&o>0))return void this._db.delete(e);r=o}i.size=r,this._size+=r,t.size+=r,this._checkSize()}pop(t,e){e=t.id+e;const i=this._db.get(e);if(i)return this._size-=i.size,t.size-=i.size,this._db.delete(e),++this._hit,i.entry;++this._miss}get(t,e){e=t.id+e;const i=this._db.get(e);if(i!==void 0)return this._db.delete(e),i.lives=i.lifetime,this._db.set(e,i),++this._hit,i.entry;++this._miss}peek(t,e){const i=this._db.get(t.id+e);return i?++this._hit:++this._miss,i?.entry}get performanceInfo(){const t={Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+"%",Entries:this._db.size.toString()},e={},i=new Array;this._db.forEach((s,h)=>{const _=s.lifetime;i[_]=(i[_]||0)+s.size,this._users.forEach(l=>{const{id:u,name:z}=l;if(h.startsWith(u)){const m=e[z]||0;e[z]=m+s.size}})});const r={};this._users.forEach(s=>{const h=s.name;if("hitRate"in s&&typeof s.hitRate=="number"&&!isNaN(s.hitRate)&&s.hitRate>0){const _=e[h]||0;e[h]=_,r[h]=Math.round(100*s.hitRate)+"%"}else r[h]="0%"});const o=Object.keys(e);o.sort((s,h)=>e[h]-e[s]),o.forEach(s=>t[s]=Math.round(e[s]/2**20)+"MB / "+r[s]);for(let s=i.length-1;s>=0;--s){const h=i[s];h&&(t["Priority "+(s+c-1)]=Math.round(h/this._size*100)+"%")}return t}resetStats(){this._hit=this._miss=0,this._users.forEach(t=>t.resetHitRate())}clear(t){const e=t.id;this._db.forEach((i,r)=>{r.startsWith(e)&&(this._size-=i.size,this._db.delete(r),this._notifyRemove(r,i.entry,i.size,0))}),t.size=0}clearAll(){this._db.forEach((t,e)=>this._notifyRemove(e,t.entry,t.size,0)),this._users.forEach(t=>t.size=0),this._size=0,this._db.clear()}*values(t){for(const[e,i]of this._db)e.startsWith(t.id)&&(yield i.entry)}_getHitRate(){return this._hit/(this._hit+this._miss)}_notifyRemove(t,e,i,r){const o=this._users.get(t.split(a)[0])?.removeFunc,s=o?.(e,r,i);return typeof s=="number"?s:null}_checkSize(){this._sizeLimits.forEach((t,e)=>this._checkSizeLimits(t,e)),this._checkSizeLimits(this.maxSize)}setMaxSize(t,e){e==null||e<=0?this._sizeLimits.delete(t):this._sizeLimits.set(t,e)}_checkSizeLimits(t,e){const i=e??this;if(i.size<=t)return;const r=e?.id;let o=!0;for(;o;){o=!1;for(const[s,h]of this._db)if(h.lifetime===0&&(!r||s.startsWith(r))){const _=e??this._users.get(s.split(a)[0]);if(this._purgeItem(s,h,_),i.size<=.9*t)return;o||=this._db.has(s)}}for(const[s,h]of this._db)if(!r||s.startsWith(r)){const _=e??this._users.get(s.split(a)[0]);if(this._purgeItem(s,h,_),i.size<=.9*t)return}}_purgeItem(t,e,i){if(this._db.delete(t),e.lives<=1){this._size-=e.size,i&&(i.size-=e.size);const r=this._notifyRemove(t,e.entry,e.size,1);r!=null&&r>0&&(this._size+=r,i&&(i.size+=r),e.lives=e.lifetime,e.size=r,this._db.set(t,e))}else--e.lives,this._db.set(t,e)}}const p=new d(0);let S=0;class b{constructor(t,e,i){this.entry=t,this.size=e,this.lifetime=i,this.lives=i}}const a=":";class M{constructor(t,e){this.removeFunc=e,this._storage=new d,this.id="",this.name="",this.size=0,this._storage.maxSize=t,this._storage.register(this)}destroy(){this._storage.deregister(this),this._storage.destroy(),this._storage=null}put(t,e,i=1){this._storage.put(this,t,e,i,1)}pop(t){return this._storage.pop(this,t)}get(t){return this._storage.get(this,t)}clear(){this._storage.clearAll()}get maxSize(){return this._storage.maxSize}set maxSize(t){this._storage.maxSize=t}resetHitRate(){}}export{R as a,M as e,d as h,f as s,c as t};
