import{Q as v,i as x}from"./jsonMap-Bs3hmeCU.js";import{n as w}from"./collectionUtils-oMUPqMMC.js";import{o as S}from"./WorkerHandle-BioJnATq.js";import{J as j}from"./projectionUtils-Ca1qXe4h.js";import{n as k}from"./projectVectorToVector-ClOaOAsc.js";class R{constructor(o,e,r,n,p,u){this.layout=o,this.interleavedVertexData=e,this.indices=r,this.hasColors=n,this.hasModifications=p,this.positionData=u}}class W{constructor(o,e,r,n,p,u,f){this.componentOffsets=o,this.featureIds=e,this.anchorIds=r,this.anchors=n,this.transformedGeometry=p,this.globalTrafo=u,this.obb=f}}class A extends S{constructor(o){super("SceneLayerWorker","process",{process:e=>[e.geometryBuffer],project:e=>[e.positions.buffer],transformNormals:e=>[e.normals.buffer]},o,{hasInitialize:!0})}setModifications(o,e,r){const n={context:o,modifications:e,isGeodetic:r};return this.broadcast(n,"setModifications")}setLegacySchema(o,e){const r=JSON.stringify(e);return this.broadcast({context:o,jsonSchema:r},"setLegacySchema")}destroyContext(o){return this.broadcast(o,"destroyContext")}async destroyContextAndSelf(o){await this.destroyContext(o),this.destroy()}project(o,e){return this.invokeMethod("project",o,e)}transformNormals(o,e){return this.invokeMethod("transformNormals",o,e)}}const s=new v({deallocator:null}),l=w();function D(t,o,e){s.clear();let r=1/0,n=1/0,p=-1/0,u=-1/0,f=!1;for(const h of o){const g=h.type==="clip"?2:h.type==="mask"?1:0,a=h.geometry;let m=i=>i;if(a.spatialReference){if(!j(a.spatialReference,e)){x.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle").warn("im-modification-projection-failed","Can't project modification polygon into layer spatial reference, ignoring modification",{polygon:a});continue}m=i=>(k(i,a.spatialReference,l,e),l)}else a.hasZ||(l[2]=0,m=i=>(l[0]=i[0],l[1]=i[1],l));f=f||g===1;const y=a.rings.length,M=a.rings.some(i=>i.length<3);if(y===0||M)x.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle").warn("im-modification-invalid-polygon","Ignoring invalid modification polygon (no rings or rings with less than 3 vertices).",{polygon:a});else{s.push(g),s.push(y);for(const i of a.rings){s.push(i.length);for(const b of i){const c=m(b);s.push(c[0]),s.push(c[1]),s.push(c[2]),r=Math.min(r,c[0]),n=Math.min(n,c[1]),p=Math.max(p,c[0]),u=Math.max(u,c[1])}}}}t!=null&&(f?(s.push(2),s.push(2),s.push(4),s.push(r-1e-4),s.push(n-1e-4),s.push(0),s.push(p+1e-4),s.push(n-1e-4),s.push(0),s.push(p+1e-4),s.push(u+1e-4),s.push(0),s.push(r-1e-4),s.push(u+1e-4),s.push(0),s.push(4),s.push(t[0]),s.push(t[1]),s.push(0),s.push(t[2]),s.push(t[1]),s.push(0),s.push(t[2]),s.push(t[3]),s.push(0),s.push(t[0]),s.push(t[3]),s.push(0)):(s.push(1),s.push(1),s.push(4),s.push(t[0]),s.push(t[1]),s.push(0),s.push(t[2]),s.push(t[1]),s.push(0),s.push(t[2]),s.push(t[3]),s.push(0),s.push(t[0]),s.push(t[3]),s.push(0))),s.push(3);const d=new Float64Array(s.length);for(let h=0;h<s.length;++h)d[h]=s.at(h);return d}export{A as a,W as h,R as n,D as u};
