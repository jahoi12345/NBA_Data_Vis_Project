import{a9 as $e,l as K,ac as Q,i as Kt,_ as d,m as u,a as I,aU as Qt,ag as At,t as Oe,u as Pt,bF as gt,aC as De,V as Te,o as xe,bc as Re,n as Ae}from"./jsonMap-Bs3hmeCU.js";import{s as te,f as ut,J as j,aY as He,ax as Ht,aZ as ze,a_ as ke,a$ as Ge}from"./ShadowCastClear.glsl-Bhq9MYuW.js";import{e as Ee}from"./AnalysisView3D-zhHEgrUR.js";import{l as v,w as O,h as X,U as vt,f as at,e as Le}from"./reactiveUtils-SO2Ko3sy.js";import{bp as Ve,bq as Ue,b as G,af as Ie}from"./Point-BN8RINcc.js";import{e as je}from"./getDefaultUnitForView-DwTC0lpI.js";import{s as zt,M as Fe}from"./mathUtils-PIGhLnI9.js";import{p as kt,o as Be,f as ee,q as Ne}from"./mat4-n_G6OS58.js";import{e as bt}from"./mat4f64-q_b6UJoq.js";import{s as $,j as _t,q as st,E as Gt,R,_ as L,P as H,A as qe,J as ie,X as Et,g as tt,H as ne,r as ae,o as se,c as oe}from"./vec32-CNF8e3LG.js";import{n as P,i as F,r as ot}from"./collectionUtils-Dk3LoVuX.js";import{c as f}from"./vector-CGHTqcz0.js";import{t as Je}from"./projectVectorToVector-DkxXb83V.js";import{x as q,l as Xe,M as W}from"./RealisticTree.glsl-IWCjmMLr.js";import{m as V,f as We}from"./Segment-agewC3Lx.js";import{a3 as Ye,a4 as re,a5 as Ze,a2 as Ke}from"./euclideanLengthMeasurementUtils-Dd_tZ3Tl.js";import{u as U}from"./Color-CERqXxxY.js";import{t as Qe,u as ti}from"./LengthDimension-CWtE4bVx.js";import{a as yt}from"./Cyclical-BLSxUpe7.js";import{u as D}from"./screenUtils-BitdhK1O.js";import{n as ei,a as B}from"./vec4f64-DPb6J-GU.js";import{a as St,j as Mt,X as Lt,k as ii}from"./plane-CYSvzg5X.js";import{D as ni,I as ai}from"./colorUtils-Chvbp2-y.js";import{Y as mt,g as si,t as T,h as le,w as Ct,f as it,j as oi,p as E,o as ri,r as li,a as pi}from"./ShadedColorMaterial.glsl-BVRWw9mq.js";import{G as $t,O as di,P as pe}from"./dragEventPipeline3D-D_wkf_Q_.js";import{t as Vt}from"./orientedBoundingBox-VXwBwem5.js";import{m as ui}from"./Texture-Cw36TGeQ.js";import{p as et,h as Ot,D as mi}from"./InteractiveToolBase-DYdTOPhs.js";import{t as ci}from"./elevationInfoUtils-DOC7auVy.js";import{h as hi}from"./UpdatingHandles-D2RI_3Hb.js";import{l as Ut}from"./Factory-ZQZ22k6R.js";import{w as fi}from"./SnappingVisualizer3D-3XfQy-Gy.js";import{h as gi}from"./VerticesVisualElement-OZJDLt9Y.js";import{g as vi}from"./ImageMaterial.glsl-BKsUALFo.js";import{h as rt}from"./lineStippleUtils-CCavR4OV.js";import{g as _i,w as yi,a as Si}from"./EditGeometryOperations-B4UKkiuM.js";import{e as Mi}from"./SnappingContext-DCZIwxmt.js";import{f as wi}from"./SnappingDragPipelineStep-COkB-gjg.js";import{a as Pi}from"./SnappingManagerPool-BnDJ-2h5.js";import{p as bi}from"./SnappingOperation-ClIdnPwp.js";import{o as Ci,m as $i,f as Oi,d as It}from"./analysisViewUtils-Cb9GWzKA.js";import{o as Di}from"./ToolIntersector-DUCGi0IY.js";import{f as Ti}from"./intl-BvIZ3ldN.js";import{d as xi}from"./quantityFormatUtils-DalIiLRy.js";import{S as Ri,f as Ai}from"./line-CK0BnMAu.js";import{g as de}from"./LineMarker.glsl-D6k8Mddm.js";import{c as Hi}from"./automaticLengthMeasurementUtils-Dre-iSuB.js";import"./index-C-2WWcaK.js";import"./jsonUtils-UGNxUp3z.js";import"./Extent-Bbnm65bN.js";import"./Polyline-BtUG5wiC.js";import"./Polygon-BdLNJfwi.js";import"./aaBoundingRect-CrU5VtR_.js";import"./typeUtils-Dk-Jta7H.js";import"./modeUtils-DKmpkquP.js";import"./uuid-Oe6SV2kF.js";import"./sanitizerUtils-BT_8V5US.js";import"./SimpleObservable-CvFyr0NA.js";import"./lengthUtils-Ceo6858g.js";import"./date-IqUzANpt.js";import"./workers-D8pWeOqp.js";import"./Queue-CYlrXMwB.js";import"./PooledRBush-Dco5QkUp.js";import"./quickselect-QQC62dOK.js";import"./GraphicsCollection-CbLe7TzM.js";import"./Graphic-BiQTZi7k.js";import"./getPopupProvider-DjIxdahS.js";import"./reader-DcGs6kKN.js";import"./Layer-Ciy6IOGe.js";import"./createFeatureId-CVwTD0fV.js";import"./typeUtils-W6WEjFtn.js";import"./lineMarkers-CDwLe3J6.js";import"./PolygonSymbol3D-D50k8Fcq.js";import"./ExtrudeSymbol3DLayer-DSc1ou2x.js";import"./opacityUtils-DuFH0EC9.js";import"./aaBoundingBox-CtkshuSS.js";import"./DoubleArray-DExKNiTh.js";import"./Font-Ct7_LYCJ.js";import"./SimpleFillSymbol-CDawtd9z.js";import"./SimpleMarkerSymbol-BGAFRS9_.js";import"./PictureMarkerSymbol-LudhOruE.js";import"./TextSymbol-DH6PXxVy.js";import"./HeightModelInfo-DRFN7tKf.js";import"./projectionUtils-zKDw1yLq.js";import"./spatialReferenceEllipsoidUtils-T3ZM6b8E.js";import"./projectPointToVector-CELlCh-8.js";import"./scaleUtils-en5WDx65.js";import"./layerUtils-Ca2TiN3a.js";import"./TilemapCache-obN_L5Xm.js";import"./LRUCache-fy84PBMi.js";import"./TileKey-jKcqhCzg.js";import"./memoryEstimations-Bd726a_p.js";import"./tagSymbols-BPcGfZon.js";import"./asyncUtils-w6KfWU41.js";import"./signal-BX9ezF8a.js";import"./Map-BG-ZPeaW.js";import"./Basemap-BBszaJs6.js";import"./loadAll-B7O5Buv4.js";import"./PortalItem-JZSYzcdX.js";import"./writeUtils-DAWG90I-.js";import"./CollectionFlattener-Cag-8feq.js";import"./persistable-CuCo7Cu3.js";import"./MD5-MtSiOt06.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw.js";import"./resourceExtension-B0hY4a0f.js";import"./PolygonCollection-90Z4vnqc.js";import"./mat4f32-Djp3mnm5.js";import"./TablesMixin-BFz-cIJ-.js";import"./timeZoneUtils-BSc7-7qA.js";import"./ReactiveMap-B0by2bYu.js";import"./Query-CikRiKlY.js";import"./Field-Cm_ZejYW.js";import"./fieldType-DVUzXtk_.js";import"./normalizeUtils-BDt2F_N3.js";import"./normalizeUtilsCommon-rK4fWGKa.js";import"./utils-DBDpKdtI.js";import"./utils-DQFbn7-c.js";import"./ElevationQuery-pJqr5aW2.js";import"./TileInfo-Y7H9liCK.js";import"./vec2f64-rIxtbMRN.js";import"./vec3f32-WCVSSNPR.js";import"./enums-B4pqBiXb.js";import"./Scheduler-CNrsbccs.js";import"./Indices-D0_UQPPr.js";import"./InterleavedLayout-8W9JN4bc.js";import"./BufferView-BMlFYMIb.js";import"./vec42-CkbV-zLi.js";import"./types-BKo2foNY.js";import"./VertexElementDescriptor-BlxU8vCE.js";import"./sphere-9lseHxo-.js";import"./constants-D67WmGms.js";import"./quat-CK9e8_eG.js";import"./quatf64-CCm9z-pX.js";import"./computeTranslationToOriginAndRotation-Cz93wRWF.js";import"./frustum-BypfKDJS.js";import"./floatRGBA-CYO4yRwl.js";import"./labelUtils-BtizwBfq.js";import"./ArcadeExpression-Ddk8yIk3.js";import"./TimeOnly-Du0ClqSA.js";import"./enum-BzLwmiID.js";import"./UnknownTimeZone-B697BDFv.js";import"./FieldsIndex-B72TFK42.js";import"./TileKey-C44YQC4_.js";import"./layerViewUtils-BTa15X3o.js";import"./unitConversionUtils-BEb-Sf7Y.js";import"./vec2f32-CaVKkSa6.js";import"./Emissions.glsl-B8XKMjLy.js";import"./dehydratedFeatures-Brxjc3JN.js";import"./quantizationUtils-BuQfweOC.js";import"./featureConversionUtils-yVOZE0te.js";import"./OptimizedFeature-CwRGZPwv.js";import"./OptimizedFeatureSet-BR8EEvDc.js";import"./Octree-Bb_mCzwl.js";import"./HUDIntersectorResult-D3KkIdaq.js";import"./intersectorUtilsConversions-U5KUl8sG.js";import"./Intersector-BDgm95L3.js";import"./DefaultLoadingContext-D5ihlAAW.js";import"./wosrLoader-Bo3AtRk9.js";import"./Version-BtYZEj58.js";import"./axisAngleDegrees-BIah1hxG.js";import"./edgePreprocessing-YzR1XaHD.js";import"./config-Dg972SSE.js";import"./GeometryUtils-BoySfe8Y.js";import"./definitions-Dvg4hMIw.js";import"./WorkerHandle-nVMczE_1.js";import"./vec3-B_phcnZY.js";import"./vec33-CWJeyzxV.js";import"./capabilities-Bi6C4OG6.js";import"./imageUtils-DFuQNq2S.js";import"./meshVertexSpaceUtils-DM2fDb9e.js";import"./MeshLocalVertexSpace-oQGry7Qx.js";import"./VisualElement-By4iq8p4.js";import"./TextOverlayItem-BD2PDyJ-.js";import"./utils-DTE-xBiC.js";import"./geometry2dUtils-CYnL6wJ1.js";import"./geodeticLengthOperator-CGvLaEl3.js";import"./geodeticCurveType-CirnHLSB.js";import"./ColorMaterial.glsl-iVY8sJRd.js";import"./TriangleMaterial-DyU1F4o5.js";import"./videoUtils-Dwx3AEgj.js";import"./ExtendedLineVisualElement-jwbByWTi.js";import"./EngineVisualElement-CkOmELQC.js";import"./LaserlinePath.glsl-Bs_lKAf8.js";import"./PointVisualElement-CEL7QdWI.js";import"./DefaultLayouts-Bl15_2Jf.js";import"./rotate-C0W4p449.js";import"./curveOperationUtils-CTvChjIC.js";import"./PointSnappingHint-DFp1pBau.js";import"./dehydratedFeatureComparison-OYwn4uut.js";import"./allLayerSnapping-D12oZ67L.js";class zi{constructor(e,i,n,a,s,o){this.elevationAlignedStartPoint=e,this.elevationAlignedEndPoint=i,this.directSegment=n,this.dimensionSegment=a,this.primaryOffsetAxis=s,this.spatialReference=o}}const jt=$e(G);function ki(t,e,i,n){if(t==null)return null;let a;if(e==="horizontal")a=n.autoDistanceBetweenPoints2D(jt(t.elevationAlignedStartPoint),jt(t.elevationAlignedEndPoint));else{const{startRenderSpace:o,endRenderSpace:l}=t.dimensionSegment;a=Ze(o,l,t.spatialReference)}if(a==null)return null;const s=e==="vertical"?Ve(a.value,a.unit,i):Ue(a.value,a.unit,i);return te(a,s)}function lt(t){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:i,dimension:{offset:n,measureType:a,orientation:s}}=t;return{elevationAlignedStartPoint:e,elevationAlignedEndPoint:i,offset:n,measureType:a,orientation:s}}function pt({elevationAlignedStartPoint:t,elevationAlignedEndPoint:e,offset:i,measureType:n,orientation:a},s,o=null){if(t==null||e==null)return null;const l=me(o?.directSegment??new V,{elevationAlignedStartPoint:t,elevationAlignedEndPoint:e},s),r=o?.primaryOffsetAxis??P();ct(r,{measureType:n,elevationAlignedStartPoint:t,elevationAlignedEndPoint:e,directSegment:l,orientation:a,renderCoordsHelper:s});const p=o?.dimensionSegment??new V;return Dt({elevationAlignedStartPoint:t,elevationAlignedEndPoint:e})&&n==="vertical"?($(p.startRenderSpace,l.startRenderSpace),$(p.endRenderSpace,l.endRenderSpace)):ce(p,r,i,l,s),new zi(t,e,l,p,r,s.spatialReference)}function Ft(t,e,i,n){return e===0?($(t.startRenderSpace,i.startRenderSpace),$(t.endRenderSpace,n.startRenderSpace)):($(t.startRenderSpace,i.endRenderSpace),$(t.endRenderSpace,n.endRenderSpace)),t}function Gi(t,e,i,n){st(t.startRenderSpace,e.startRenderSpace,i,n),st(t.endRenderSpace,e.endRenderSpace,i,n)}function ue(t,e,i,n){switch(e){case"direct":return me(t,i,n);case"horizontal":case"vertical":{const{elevationAlignedStartPoint:a,elevationAlignedEndPoint:s,dimension:o,geometry:l}=i;let r;o.measureType==="direct"?(r=Ei(l,n)===a.z>s.z,e==="horizontal"&&(r=!r)):r=!Li(l);const[p,m]=r?[a,s]:[s,a],h=q(m,Vi);return e==="horizontal"?h.z=p.z:(h.x=p.x,h.y=p.y),n.toRenderCoords(p,t.startRenderSpace),n.toRenderCoords(h,t.endRenderSpace),t}}}function me(t,e,i){return i.toRenderCoords(e.elevationAlignedStartPoint,t.startRenderSpace),i.toRenderCoords(e.elevationAlignedEndPoint,t.endRenderSpace),t}function Ei(t,e){const i=t.directSegment.eval(.5,f.get()),n=e.worldUpAtPosition(i,f.get()),a=t.dimensionSegment.eval(.5,f.get()),s=R(f.get(),a,i);return!ie(s,F)&&H(s,n)>0}function Li(t){const{startRenderSpace:e,endRenderSpace:i}=t.dimensionSegment,{startRenderSpace:n,endRenderSpace:a}=t.directSegment;return Et(n,e)<Et(a,i)}const Vi=Je(0,0,0,null);function Ui(t,e,i,n){const{directSegment:a}=i,s=ct(f.get(),{measureType:e,directSegment:a,renderCoordsHelper:n}),o=ce(Ii,s,0,a,n).eval(.5,f.get()),l=R(f.get(),t,o);return H(l,s)*n.unitInMeters}const Ii=new V;function ct(t,e){const{measureType:i,elevationAlignedStartPoint:n,elevationAlignedEndPoint:a,directSegment:{startRenderSpace:s,endRenderSpace:o},directSegment:l,renderCoordsHelper:r}=e,p=l.eval(.5,f.get()),m=r.worldUpAtPosition(p,f.get()),h=r.worldBasisAtPosition(p,1,f.get());switch(i){case"horizontal":$(t,m);break;case"vertical":H(s,m)<H(o,m)?R(t,o,s):R(t,s,o),L(t,t,m),L(t,t,m);break;case"direct":{const c=e.orientation??0;if(Dt({elevationAlignedStartPoint:n,elevationAlignedEndPoint:a}))kt(nt,-zt(c),m),Gt(t,h,nt);else{const g=R(f.get(),o,s),_=L(f.get(),g,m);L(_,_,g),kt(nt,zt(c),g),Gt(t,_,nt)}break}}return ie(t,F)?$(t,h):qe(t,t)}const nt=bt();function Dt({elevationAlignedStartPoint:t,elevationAlignedEndPoint:e}){return t!=null&&e!=null&&t.x===e.x&&t.y===e.y}function ce(t,e,i,n,a){const{startRenderSpace:s,endRenderSpace:o}=n,l=i/a.unitInMeters,[r,p]=ji(s,o,e,l);return st(t.startRenderSpace,n.startRenderSpace,e,r),st(t.endRenderSpace,n.endRenderSpace,e,p),t}function ji(t,e,i,n=0){const a=H(e,i),s=H(t,i),o=Math.abs(a-s)+n;return a>s?[o,n]:[n,o]}function ht(t,e,i){const n=e.directSegment.eval(.5,f.get());return i.worldUpAtPosition(n,t)}function Tt(t,e){const{startRenderSpace:i,endRenderSpace:n}=e.directSegment;return R(t,n,i)}function xt(t,e,i={invert:!1}){const{startRenderSpace:n,endRenderSpace:a}=e.dimensionSegment;return i.invert?R(t,n,a):R(t,a,n)}function wt(t,e){const i=t.directSegment.eval(.5,f.get());return e.headingAtPosition(i,t.primaryOffsetAxis)}function Fi(t,e){return _t(xt(Bi,t))/e**2}const Bi=P();function he(t){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:i}=t;if(e==null||i==null)return!1;const n=Ye(e,i);return n!=null&&te(n,"meters").value>re}function Y(t){return t.geometry!=null}let k=class extends K{constructor(e){super(e)}initialize(){const e=ut(()=>this.analysisViewData.computations,({computation:i})=>this._watchComputation(i));this.addHandles(Q(e))}get analysis(){return this.analysisViewData.analysis}get _defaultUnit(){return je(this.view)}_watchComputation(e){return v(()=>lt(e),i=>{const{measureType:n}=i;if(he(i)&&n!=="direct"){const s=Math.round(Ie(re,"meters","kilometers"));return Kt.getLogger(this).warnOnce(`A ${n} dimension in the analysis (id: '${this.analysis.id}') will not display, because only direct dimensions can measure lengths greater than ${s} km. Update the measureType of the affected dimension to "direct" to display it.`),void(e.geometry=null)}const a=pt(i,this.view.renderCoordsHelper,e.geometry);e.geometry=a,e.result.length=ki(a,n,this._defaultUnit,this.automaticLengthMeasurementUtils)},O)}};d([u({constructOnly:!0})],k.prototype,"analysisViewData",void 0),d([u({constructOnly:!0})],k.prototype,"view",void 0),d([u({constructOnly:!0})],k.prototype,"automaticLengthMeasurementUtils",void 0),d([u()],k.prototype,"analysis",null),d([u()],k.prototype,"_defaultUnit",null),k=d([I("esri.views.3d.analysis.Dimension.DimensionController")],k);function Z(t){return ni(t.accentColor,.5)}function Bt(t){return ai(t.accentColor)}const fe=5,Ni=new U([127,127,127,.5]),ge=.8,qi=4,Ji=6,Xi=.1,ve=.5,Wi=18,Yi=2,Zi=.3,Ki=2,Qi=.25,tn=20,en=5,Nt=5,qt=10,nn=2500,an=50,sn=2;class on{constructor(e){this.start=e.start,this.end=e.end,this.offset=e.offset,this.heading=e.heading,this.rotation=e.rotation,this.direct=e.direct,this.horizontal=e.horizontal,this.vertical=e.vertical}manipulatorName(e){return Object.keys(this).find(i=>this.hasOwnProperty(i)&&e===this[i])}values(){return[this.start,this.end,this.offset,this.heading,this.rotation,this.direct,this.horizontal,this.vertical]}forEachMeasureTypeManipulator(e){for(const i of Qe)e(this.manipulatorForMeasureType(i),i)}manipulatorForMeasureType(e){switch(e){case"direct":return this.direct;case"horizontal":return this.horizontal;case"vertical":return this.vertical}}}class rn extends mt{constructor(e,i){const n=si(U.toUnitRGBA(Z(e.effectiveTheme))),a=[new T(Xe(n,1,32,32),A)];super({view:e,renderObjects:a,metadata:i.metadata,available:!1,grabCursor:"crosshair",radius:fe,collisionPriority:1}),this._themeHandle=v(()=>({color:U.toUnitRGBA(Z(e.effectiveTheme))}),s=>n.setParameters(s))}destroy(){this._themeHandle.remove(),super.destroy()}}function ln(t,e){const i=[ot(-.5,0,0),ot(.5,0,0)],n=W(e.unfocusedMaterial,i.map(s=>tt(P(),s,ve))),a=n.instantiate({material:e.focusedMaterial});return new mt({view:t,renderObjects:[new T(n,9|A),new T(a,2|A)],collisionType:{type:"line",paths:[i]},radius:Rt(e.lineSizePt)/2,metadata:e.metadata,available:!1,...le})}class Jt extends mt{constructor(e,{lineSizePt:i,material:n,metadata:a}){super({view:e,autoScaleRenderObjects:!1,collisionPriority:1,metadata:a}),this._options={calloutColor:ei(),lineSizePt:i,material:n},this._themeHandle=v(()=>U.toUnitRGBA(Z(e.effectiveTheme)),s=>{this._options.calloutColor=s,Wt(this,Xt({...this._options,metadata:this.metadata}))},X)}update({lineSizePt:e,material:i}){this._options.lineSizePt=e,this._options.material=i,Wt(this,Xt({...this._options,metadata:this.metadata}))}destroy(){this._themeHandle.remove(),super.destroy()}}function Xt({calloutColor:t,lineSizePt:e,material:i,metadata:n}){return{calloutLength:.25*He*ge*D(e)+Wi,calloutColor:t,calloutWidth:Yi,customStateMask:A,discScale:Zi,focusMultiplier:Ki,material:i,metadata:n}}function pn(t,e){const i=[ot(-.5,0,0),ot(.5,0,0)],n=W(e.thinOffsetManipulatorMaterial,i),a=W(e.unfocusedMaterial,i.map(o=>tt(P(),o,ve))),s=a.instantiate({material:e.focusedMaterial});return new mt({view:t,renderObjects:[new T(a,1|A),new T(s,2|A),new T(n,A)],collisionType:{type:"line",paths:[i]},radius:Rt(e.lineSizePt)/2,available:!1,metadata:e.metadata,...le})}function dn(t,{isStart:e,createSnappingPipelineStep:i,dimension:n,onUpdate:a,view:s}){const o=e?"startPoint":"endPoint";return[et(t,(r,p,m,h)=>{const c=$t(r),{snappingStep:g,cancelSnapping:_}=i(h);m=m.next(c).next(Ot(n,[o,"measureType","orientation"])).next(_),p.next(c).next(di(s)).next(...g).next(M=>{const y=q(M.mapEnd,new G);a(o==="startPoint"?{startPoint:y}:{endPoint:y})})})]}function un(t,{computation:e,view:i}){return[et(t,(n,a,s)=>{if(!Y(e)||!n.selected)return;const{geometry:o,dimension:l}=e,r=$t(n);a.next(r).next(ye(i,l,o.dimensionSegment,o.primaryOffsetAxis)),s.next(r).next(Ot(l,["offset"]))})]}function mn(t,{computation:e,view:i}){return[et(t,(n,a,s)=>{_e({cancel:s,computation:e,settingHeading:!0,steps:a,view:i})})]}function cn(t,{computation:e,view:i}){return[et(t,(n,a,s)=>{_e({cancel:s,computation:e,settingHeading:!1,steps:a,view:i})}),t.events.on("immediate-click",n=>{hn(n,e,i)})]}function hn(t,e,i){const{dimension:n,geometry:a}=e;if(n.orientation===90||n.orientation===270)return n.orientation=0,void t.stopPropagation();if(a==null)return;const{renderCoordsHelper:s}=i,o=pt({...lt(e),orientation:90},s),l=pt({...lt(e),orientation:270},s);if(o==null||l==null)return;const r=wt(o,s),p=wt(l,s),m=Se(a,i),h=yt.shortestSignedDiff(m,r),c=yt.shortestSignedDiff(m,p);n.orientation=Math.abs(h)<Math.abs(c)?90:270,t.stopPropagation()}function _e(t){const{cancel:e,computation:i,settingHeading:n,steps:a,view:s}=t;if(!Y(i))return;const{renderCoordsHelper:o}=s,{dimension:l,geometry:r}=i,p=P(),m=we(P(),r,r.directSegment,o),h=Pe(f.get(),{forHeading:n,geometry:r,renderCoordsHelper:o}),c=St(m,h,Mt()),g=n?l.orientation??wt(r,s.renderCoordsHelper):l.orientation??0;a.next(pe(s,c)).next(_=>{_.action==="start"&&$(p,_.renderStart);const M=ii(c),y=oi(p,_.renderEnd,m,M);let z=g-Fe(y);n||(z=fn(z)),l.orientation=z}),e.next(Ot(l,["orientation"]))}function fn(t){const e=yt.normalize(t)%90;return e<Nt?t-e:90-e<Nt?t+(90-e):t}function gn(t,{computation:e,manipulatorMeasureType:i,view:n}){let a="direct",s=0,o=0;return[t.events.on("grab-changed",l=>{if(l.action!=="start"||!Y(e))return;const{dimension:r,geometry:p}=e;a=r.measureType,s=r.offset,o=r.orientation;const m=$(f.get(),t.renderLocation);r.measureType=i,r.offset=Ui(m,i,p,n.renderCoordsHelper),r.orientation=0}),et(t,(l,r,p)=>{if(!Y(e))return;const{geometry:m,dimension:h}=e,{renderCoordsHelper:c}=n,g=ue(be,i,e,c),_=ct(f.get(),{measureType:i,directSegment:m.directSegment,renderCoordsHelper:c}),M=$t(l);r.next(M).next(ye(n,h,g,_)),p.next(M).next(y=>(h.measureType=a,h.offset=s,h.orientation=o,y))})]}function ye(t,e,i,n){const a=oe(f.get(),i.endRenderSpace,i.startRenderSpace);L(a,a,n);const s=St(i.startRenderSpace,a,Mt()),o=St(i.startRenderSpace,n,Mt()),l=e.offset;let r,p=0;const m=new mi;return m.next(pe(t,s)).next(h=>{h.action==="start"&&(p=Lt(o,h.renderStart));const c=(Lt(o,h.renderEnd)-p)*t.renderCoordsHelper.unitInMeters;e.offset=l+c,r=h}),h=>(m.execute(h),r)}function Se(t,e){const{directSegment:i}=t,{renderCoordsHelper:n}=e,a=ht(f.get(),t,n),s=Tt(f.get(),t),o=L(f.get(),s,a),{viewForward:l}=e.state.camera;H(o,l)>0&&tt(o,o,-1);const r=i.eval(.5,f.get());return n.headingAtPosition(r,o)}function vn(t,e,i){const{dimensionSegment:n,primaryOffsetAxis:a}=e,s=xt(J,e),o=ne(s,F)?Be(dt):Ct(s,a,F,dt),l=Math.max(ae(s),Xi/i.unitInMeters);ee(o,o,se(J,l,l,l)),t.modelTransform=o,t.renderLocation=n.eval(.5,J)}function _n(t,e,i){Me(t,e,i,{forHeading:!0})}function yn(t,e,i){Me(t,e,i,{forHeading:!1})}function Me(t,e,i,{forHeading:n}){const{dimension:a,geometry:s}=e,{primaryOffsetAxis:o}=s,l=tt(Sn,o,a.offset>=0?1:-1),r=Pe(Mn,{forHeading:n,geometry:s,renderCoordsHelper:i});L(r,r,l);const p=Ct(l,r,F,dt);t.modelTransform=p,t.renderLocation=we(J,s,s.dimensionSegment,i)}const Sn=P(),Mn=P();function wn(t,e,i,n){const{geometry:a}=e,s=ue(be,i,e,n),o=ct(J,{measureType:i,directSegment:a.directSegment,renderCoordsHelper:n}),l=R(ft,s.endRenderSpace,s.startRenderSpace),r=Ct(l,o,F,dt),p=ae(l);ee(r,r,se(ft,p,p,p)),t.modelTransform=r,t.renderLocation=s.eval(.5,ft)}function we(t,e,i,n){const{startRenderSpace:a,endRenderSpace:s}=i,o=Pn(e,n)?a:s;return $(t,o)}function Pe(t,{forHeading:e,geometry:i,renderCoordsHelper:n}){return e?ht(t,i,n):xt(t,i,{invert:!0})}function Pn(t,e){const i=Tt(bn,t),n=ht(Cn,t,e);return H(i,n)>0}const bn=P(),Cn=P();function $n(t){return D(t)+qi}function Rt(t){return D(t)+Ji}function Wt(t,e){const i=e.material,n=e.focusMultiplier??it.focusMultiplier,a=e.calloutLength??it.calloutLength,s=it.discRadius*(e.discScale??1),o=s*n,l=(g,_)=>{const M=[0,1,2,2,3,0];return new ui(_,[["position",new Vt([a-g,-g,0,a+g,-g,0,a+g,g,0,a-g,g,0],M,3,!0)],["uv0",new Vt([0,0,1,0,1,1,0,1],M,2,!0)]])},r=e.calloutWidth??it.calloutWidth,p=new j({width:r,color:e.calloutColor,renderOccluded:4,isDecoration:!0},t.view.state.isGlobal),m=W(p,[[0,0,0],[a-s,0,0]]),h=W(p,[[0,0,0],[a-o,0,0]]),c=e.customStateMask??0;t.collisionType={type:"disc",direction:[0,0,1],offset:[a,0,0]},t.focusMultiplier=n,t.metadata=e.metadata,t.radius=s,t.renderObjects=[new T(l(s,i),1|c),new T(m,1|c),new T(l(o,i),2|c),new T(h,2|c)]}const A=16,J=P(),ft=P(),dt=bt(),be=new V;function On(t,e){return{enabled:e.effectiveFeatureEnabled,elevationAlignedStartPoint:t.elevationAlignedStartPoint,elevationAlignedEndPoint:t.elevationAlignedEndPoint,geometry:t.geometry}}function Dn(t,e){if(he(t))return 2;if(!t.enabled)return null;const{geometry:i}=t;if(i==null||ne(i.directSegment.startRenderSpace,i.directSegment.endRenderSpace))return null;const{camera:n}=e.state,a=ht(f.get(),i,e.renderCoordsHelper),s=Tt(f.get(),i),o=tt(f.get(),a,H(s,a)),l=oe(f.get(),s,o),r=_t(l),p=_t(o),{startRenderSpace:m,endRenderSpace:h}=i.directSegment,c=Math.max(n.computeScreenPixelSizeAt(m)*qt,n.computeScreenPixelSizeAt(h)*qt)**2;return r<c?1:p<c?0:null}function Tn(t,e,{constraint:i,view:n}){const{unconstrainedGeometry:a}=t;if(a==null)return;const{renderCoordsHelper:s,spatialReference:o}=n,{startRenderSpace:l,endRenderSpace:r}=a.directSegment,p=s.fromRenderCoords(l,new G({spatialReference:o})),m=s.fromRenderCoords(r,new G({spatialReference:o}));let h;h=e==="start"?{startPoint:p}:{endPoint:m},Ce(t,h,{constraint:i,elevationAlignedStartPoint:t.elevationAlignedStartPoint,elevationAlignedEndPoint:t.elevationAlignedEndPoint,unconstrainedGeometry:a,view:n})}function Ce(t,e,i){const{constraint:n,elevationAlignedStartPoint:a,elevationAlignedEndPoint:s,unconstrainedGeometry:o,view:l}=i,{dimension:r,previousConstraint:p,preConstraintProperties:m}=t;if(a==null||s==null)return;const h=()=>{"startPoint"in e?r.startPoint=e.startPoint:"endPoint"in e&&(r.endPoint=e.endPoint)};if(n==null)h(),p!=null&&m!=null&&(r.measureType=m.measureType,r.orientation=m.orientation);else switch(r.measureType="direct",n){case 0:if(n!==p&&(r.orientation=0),"startPoint"in e){const c=e.startPoint;c!=null&&(c.z=s.z),r.startPoint=c}else if("endPoint"in e){const c=e.endPoint;c!=null&&(c.z=a.z),r.endPoint=c}break;case 1:if(n!==p&&(r.orientation=Se(o,l)),"startPoint"in e){const c=e.startPoint;c!=null&&(c.x=s.x,c.y=s.y),r.startPoint=c}else if("endPoint"in e){const c=e.endPoint;c!=null&&(c.x=a.x,c.y=a.y),r.endPoint=c}break;case 2:n!==p&&m!=null&&(r.orientation=m.orientation),h()}t.previousConstraint=n,t.unconstrainedGeometry=o}let S=class extends K{constructor(t){super(t),this._stagedDimension=null,this._snappingManagerResult=null,this._computationManipulators=new Map,this._computationHandles=new Qt,this._updatingHandles=new hi,this._getSnappingContext=ci(n=>new Mi({elevationInfo:{mode:"absolute-height",offset:0},pointer:n,editGeometryOperations:new _i(new yi("point",Si(!0,!1,this.view.spatialReference)),this.view.state.viewingMode),visualizer:new fi}));const{view:e}=t;this._unfocusedOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(e),this._focusedOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(e),this._thinOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(e),this._thinOffsetManipulatorMaterial.setParameters({stipplePattern:rt(2)}),this._constraintSnappingIndicator=new E({view:e,attached:!0,width:1,renderOccluded:4,stipplePattern:rt(5),isDecoration:!0});const i=U.toUnitRGBA(Ni);this._stagedStartIndicator=new gi({view:e,attached:!1,elevationInfo:{mode:"absolute-height",offset:0},spatialReference:t.view.renderCoordsHelper.spatialReference,color:i,size:2*fe,outlineSize:0,renderOccluded:4,isDecoration:!0})}initialize(){const{view:t}=this;this._snappingOperation=new bi({view:t});const e=Z(t.effectiveTheme),i=Bt(t.effectiveTheme),n=!t.stage?.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result;this._textureHandle=Ut(t.stage.textures,{accentColor:e,contrastColor:i,preMultiplyAlpha:n}),this._orientationManipulatorMaterial=new vi({draped:!1,texture:this._textureHandle.texture,writeDepth:!1,renderOccluded:16,isDecoration:!0});const a=ut(()=>this.analysisViewData.computations,({computation:s})=>this._createManipulators(s));this.addHandles([v(()=>({accentColor:Z(t.effectiveTheme),contrastColor:Bt(t.effectiveTheme)}),({accentColor:s,contrastColor:o})=>{const l=this._textureHandle;this._textureHandle=Ut(t.stage.textures,{accentColor:s,contrastColor:o,preMultiplyAlpha:n}),this._orientationManipulatorMaterial.setParameters({texture:this._textureHandle.texture}),l?.release();const r=U.toUnitRGBA(s);this._unfocusedOffsetManipulatorMaterial.setParameters({color:r}),this._focusedOffsetManipulatorMaterial.setParameters({color:r}),this._thinOffsetManipulatorMaterial.setParameters({color:r}),this._constraintSnappingIndicator.color=r},X),Q(a),v(()=>({stagedPoint:this._snappingOperation.stagedPoint,stagedComputation:this._stagedComputation}),({stagedPoint:s,stagedComputation:o})=>{if(o==null||s==null)return;const l=q(s,new G);this._applyPointUpdate(o,{endPoint:l})},vt),v(()=>({stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}),(s,o)=>{const{stagedDimension:l,selectedComputation:r,firstGrabbedManipulator:p}=s;if(l===o?.stagedDimension&&p===o?.firstGrabbedManipulator){for(const m of[r,o?.selectedComputation])if(m!=null){const h=this._computationManipulators.get(m);h!=null&&this._updateManipulators(m,h,s)}}else for(const[m,h]of this._computationManipulators)this._updateManipulators(m,h,s)},O),v(()=>this.analysis.style.lineSize,s=>this._updateManipulatorStyle(s),X),v(()=>this.view.state.camera,()=>{this._stagedComputation!=null&&this._updateStagedDimensionOffset(this._stagedComputation)}),v(()=>{const s=this._stagedComputation;if(!s)return null;const o=s.elevationAlignedStartPoint,l=P();return o!=null&&this.view.renderCoordsHelper.toRenderCoords(o,l)?l:null},s=>{s!=null?(this._stagedStartIndicator.vertices=[s],this._stagedStartIndicator.attached=!0):this._stagedStartIndicator.attached=!1})]),this.addHandles(this._constraintHandles),this.addHandles(this._snappingIndicatorHandles),Ke(this,()=>{const s=this._activeComputation,o=this._stagedComputation;if(s==null||o!=null){const l=this.view.inputManager.latestPointerInfo?.type??"mouse",r=this._getSnappingContext(l);this._updatingHandles.addPromise(At(this._snappingOperation.snapAgainNearPreviousMapPoint(this._ensureSnappingManager(),r)))}if(s!=null){const{start:l,end:r}=this._computationManipulators.get(s);if(l.grabbing||r.grabbing){const p=l.grabbing?"start":"end",m=this._computeConstraint(s);Tn(s,p,{constraint:m,view:this.view})}}})}destroy(){this._textureHandle=Oe(this._textureHandle),this._snappingOperation=Pt(this._snappingOperation),this._computationHandles.destroy(),this._constraintSnappingIndicator.destroy(),this._stagedStartIndicator.destroy(),this._orientationManipulatorMaterial.dispose()}get updating(){return this._updatingHandles.updating||!!this._snappingManager?.updating}get firstGrabbedManipulator(){return this.parentTool.firstGrabbedManipulator}get hasGrabbedManipulators(){return this.parentTool.hasGrabbedManipulators}get snappingOptions(){return this._snappingManager?.options}get _snappingManager(){return this._snappingManagerResult?.snappingManager}_ensureSnappingManager(){return this._snappingManagerResult||(this._snappingManagerResult=Pi(this.view),this.addHandles(this._snappingManagerResult)),this._snappingManagerResult.snappingManager}get _activeComputation(){if(this._stagedComputation!=null)return this._stagedComputation;const{selectedComputation:t}=this.analysisViewData;return this.hasGrabbedManipulators&&t!=null?t:null}get _stagedComputation(){const t=this._stagedDimension,e=this.analysisViewData.computations.at(-1)?.computation;return t==null||e==null||e.dimension!==t?null:e}get _constraintHandles(){return[at(()=>this.analysisViewData.selectedComputation,t=>{t.previousConstraint=this._computeConstraint(t)},{...O,equals:gt}),v(()=>{const t=this._activeComputation;if(t==null)return null;const{measureType:e,orientation:i}=t.dimension;return{measureType:e,orientation:i,computation:t}},(t,e)=>{if(t!=null&&e==null){const{measureType:i,orientation:n,computation:a}=t;switch(a.previousConstraint){case 0:a.preConstraintProperties={measureType:"horizontal",orientation:0};break;case 1:a.preConstraintProperties={measureType:"vertical",orientation:0};break;case 2:a.preConstraintProperties={measureType:"direct",orientation:n};break;default:a.preConstraintProperties={measureType:i,orientation:n}}}t==null&&e!=null&&(e.computation.preConstraintProperties=null)},vt)]}get _snappingIndicatorHandles(){const t="snapping-indicator-event-handles";return[v(()=>({stagedComputation:this._stagedComputation,activeComputation:this._activeComputation}),({stagedComputation:e,activeComputation:i})=>{const n=this._constraintSnappingIndicator;if(this.removeHandles(t),i!=null)if(i===e)n.attached=!0;else{const{start:a,end:s}=this._computationManipulators.get(i),o=()=>{n.attached=a.grabbing||s.grabbing};o(),this.addHandles([a.events.on("grab-changed",o),s.events.on("grab-changed",o)],t)}else n.attached=!1}),v(()=>{const e=this._activeComputation;return e!=null?{geometry:e.geometry,constraint:e.previousConstraint}:{}},({geometry:e,constraint:i})=>{const n=this._constraintSnappingIndicator;e!=null&&i!=null&&i!==2?(n.visible=!0,n.setGeometryFromSegment(e.directSegment)):n.visible=!1})]}removeStaged(){return this._stagedDimension!=null&&(this.analysis.dimensions.remove(this._stagedDimension),this._stagedDimension=null,!0)}onDeactivate(){this.removeStaged(),this._resetSnappingState()}onClick(t){const{_stagedDimension:e}=this;if(e==null){const i=this._onUnstagedClick(t);return this.analysis.dimensions.add(i),null}return this._onStagedClick(t),e}onPointerMove({mapPoint:t,pointerType:e}){if(e==="touch")return;const i=this._getSnappingContext(e);this._updatingHandles.addPromise(At(this._snappingOperation.snap({point:t},this._ensureSnappingManager(),i)))}onManipulatorSelectionChanged(){this.analysisViewData.selectedComputation!=null&&(this._computationManipulators.get(this.analysisViewData.selectedComputation).offset.selected||(this.analysisViewData.selectedDimension=null))}_onUnstagedClick({mapPoint:t,pointerType:e}){let i=t;if(e==="mouse"){const a=this._getSnappingContext(e);i=this._ensureSnappingManager().update({point:t,context:a})}const n=new ti({startPoint:q(i,new G),endPoint:null,measureType:"horizontal"});return this._stagedDimension=n,this._resetSnappingState(),n}_onStagedClick({mapPoint:t,pointerType:e}){const i=this._stagedComputation;if(i==null)return;let n=t;if(e==="mouse"){const s=this._getSnappingContext(e);n=this._ensureSnappingManager().update({point:t,context:s})}const a=q(n,new G);this._applyPointUpdate(i,{endPoint:a}),this._stagedDimension=null,this._resetSnappingState()}_resetSnappingState(){this._ensureSnappingManager().doneSnapping(),this._snappingOperation.abort(),this._snappingOperation.stagedPoint=null}_createManipulators(t){const e=this._setupPointManipulator(t,{isStart:!0}),i=this._setupPointManipulator(t,{isStart:!1}),n=this._setupOffsetManipulator(t),a=this._setupHeadingManipulator(t),s=this._setupRotationManipulator(t),o=this._setupMeasureTypeManipulator(t,"direct"),l=this._setupMeasureTypeManipulator(t,"horizontal"),r=this._setupMeasureTypeManipulator(t,"vertical"),p=new on({start:e,end:i,offset:n,heading:a,rotation:s,direct:o,horizontal:l,vertical:r});this._setupComputationToManipulatorsSync(t,p),this._computationManipulators.set(t,p),this.manipulators.addMany(p.values());const m=De(p.values().map(h=>h.events.on("focus-changed",()=>{p.values().some(c=>c.focused)&&this._resetSnappingState()})));return{manipulators:p,remove:()=>{m.remove(),this._computationHandles.remove(t),this._computationManipulators.delete(t);for(const h of p.values())this.manipulators.remove(h)}}}_setupComputationToManipulatorsSync(t,e){this._computationHandles.add([v(()=>t.geometry,()=>this._updateManipulators(t,e),{...O,equals:gt})],t)}_setupPointManipulator(t,e){const{view:i}=this,{dimension:n}=t,a=new rn(i,{metadata:n}),s=dn(a,{isStart:e.isStart,createSnappingPipelineStep:o=>wi({snappingContext:this._getSnappingContext(o),snappingManager:this._snappingManager,updatingHandles:this._updatingHandles}),dimension:n,onUpdate:o=>this._applyPointUpdate(t,o),view:i});return this._computationHandles.add(s,t),a}_setupOffsetManipulator(t){const{view:e}=this,i=ln(e,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,metadata:t.dimension}),n=un(i,{computation:t,view:e});return this._computationHandles.add(n,t),i}_setupHeadingManipulator(t){const{view:e}=this,i=new Jt(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:t.dimension}),n=mn(i,{computation:t,view:e});return this._computationHandles.add(n,t),i}_setupRotationManipulator(t){const{view:e}=this,i=new Jt(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:t.dimension}),n=cn(i,{computation:t,view:e});return this._computationHandles.add(n,t),i}_setupMeasureTypeManipulator(t,e){const{view:i}=this,n=pn(i,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,thinOffsetManipulatorMaterial:this._thinOffsetManipulatorMaterial,metadata:t.dimension}),a=gn(n,{computation:t,manipulatorMeasureType:e,view:i});return this._computationHandles.add(a,t),n}_updateManipulators(t,e,i={stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}){const{stagedDimension:n,selectedComputation:a,firstGrabbedManipulator:s}=i,{start:o,end:l,offset:r,heading:p,rotation:m}=e,h=a===t,c=Y(t),{dimension:g}=t;for(const y of e.values()){const z=c&&n==null&&(s==null||y===s);y===r?(y.available=z,y.selected=h):y.available=z&&h}if(!c)return;this._computeConstraint(t)!=null?e.forEachMeasureTypeManipulator(y=>y.available=!1):e.manipulatorForMeasureType(g.measureType).available=!1;for(const y of[p,m])g.measureType==="direct"&&g.offset!==0||(y.available=!1);Dt(t)?m.available=!1:p.available=!1;const{geometry:_}=t;o.renderLocation=_.directSegment.startRenderSpace,l.renderLocation=_.directSegment.endRenderSpace;const{renderCoordsHelper:M}=this.view;vn(r,_,M),p.available&&_n(p,t,M),m.available&&yn(m,t,M),e.forEachMeasureTypeManipulator((y,z)=>{y.available&&wn(y,t,z,M)})}_updateManipulatorStyle(t){const e=$n(t),i=Rt(t),n={lineSizePt:t,material:this._orientationManipulatorMaterial};for(const{offset:a,heading:s,rotation:o}of this._computationManipulators.values())a.radius=i/2,s.update(n),o.update(n);this._unfocusedOffsetManipulatorMaterial.setParameters({width:e}),this._focusedOffsetManipulatorMaterial.setParameters({width:i})}_applyPointUpdate(t,e){const{view:i}=this,n=lt(t);"startPoint"in e&&(n.elevationAlignedStartPoint=e.startPoint),"endPoint"in e&&(n.elevationAlignedEndPoint=e.endPoint);const a=pt(n,i.renderCoordsHelper);if(a==null)return;const s=this._computeConstraint({...n,geometry:a});Ce(t,e,{...n,constraint:s,unconstrainedGeometry:a,view:i}),t===this._stagedComputation&&this._updateStagedDimensionOffset(t)}_updateStagedDimensionOffset(t){if(t.geometry==null)return;t.geometry.directSegment.eval(.5,Yt);const{state:e,renderCoordsHelper:i}=this.view,n=e.camera.computeScreenPixelSizeAt(Yt);t.dimension.offset=an*n*i.unitInMeters}_computeConstraint(t){return Dn(On(t,this._ensureSnappingManager().options),this.view)}_createOffsetManipulatorMaterial(t){return new j({width:1,renderOccluded:4,writeDepth:!1,hasPolygonOffset:!0,isDecoration:!0},t.state.isGlobal)}get test(){}};d([u({constructOnly:!0})],S.prototype,"analysis",void 0),d([u({constructOnly:!0})],S.prototype,"analysisViewData",void 0),d([u({constructOnly:!0})],S.prototype,"manipulators",void 0),d([u({constructOnly:!0})],S.prototype,"parentTool",void 0),d([u({constructOnly:!0,nonNullable:!0})],S.prototype,"view",void 0),d([u({readOnly:!0})],S.prototype,"updating",null),d([u()],S.prototype,"firstGrabbedManipulator",null),d([u()],S.prototype,"hasGrabbedManipulators",null),d([u()],S.prototype,"snappingOptions",null),d([u()],S.prototype,"_stagedDimension",void 0),d([u()],S.prototype,"_snappingManager",null),d([u()],S.prototype,"_activeComputation",null),d([u()],S.prototype,"_stagedComputation",null),d([u()],S.prototype,"_snappingManagerResult",void 0),S=d([I("esri.views.3d.analysis.Dimension.LengthDimensionSubTool")],S);const Yt=P();let b=class extends Ci{constructor(t){super(t),this.automaticManipulatorSelection=!1,this.removeIncompleteOnCancel=!1,this._placementMode=Zt,this._pointerMoveTimerMs=nn,this._prevPointerMoveTimeout=null}initialize(){this._intersector=Di(this.view.state.viewingMode),this._lengthDimensionSubTool=new S({analysis:this.analysis,analysisViewData:this.analysisViewData,manipulators:this.manipulators,parentTool:this,view:this.view}),this.addHandles([Q(this._lengthDimensionSubTool),Te(()=>this._clearPointerMoveTimeout()),at(()=>this.state==="created",()=>this.finishToolCreation(),O),at(()=>this.firstGrabbedManipulator,t=>{this.selectedDimension=t.metadata},O),v(()=>this.selectedDimension,()=>this._resetPointerMoveTimeout(),O)])}get state(){return this.analysis.dimensions.some(t=>t.type==="length")?this._activeSubTool!=null?"creating":"created":"ready"}get updating(){return this._lengthDimensionSubTool.updating}get cursor(){return this.active?"crosshair":null}get selectedDimension(){return this.analysisViewData.selectedDimension}set selectedDimension(t){this.analysisViewData.selectedDimension=t}place(t){this.selectedDimension=null,this._placementMode=t}onInputEvent(t){switch(t.type){case"immediate-click":this._clickHandler(t);break;case"immediate-double-click":this._doubleClickHandler(t);break;case"pointer-move":this._pointerMoveHandler(t);break;case"key-down":this._keyDownHandler(t)}}onActivate(){this._placementMode=Zt,this._activeSubTool=this._lengthDimensionSubTool}onDeactivate(){this._activeSubTool?.onDeactivate(),this._activeSubTool=null}onShow(){this._resetPointerMoveTimeout()}onManipulatorSelectionChanged(){this._lengthDimensionSubTool.onManipulatorSelectionChanged()}onHide(){this.selectedDimension=null}_clickHandler(t){if(this.hasFocusedManipulators)return void t.stopPropagation();if(this._activeSubTool==null)return;const e=this._intersectScreen(t);e!=null&&(this.selectedDimension=this._activeSubTool.onClick({mapPoint:e,pointerType:t.pointerType}),this.selectedDimension&&this._placementMode==="single"&&(this.view.activeTool=null),t.stopPropagation())}_doubleClickHandler(t){this.active&&(this.view.activeTool=null,t.stopPropagation())}_pointerMoveHandler(t){if(this._resetPointerMoveTimeout(),this._activeSubTool==null||this.hasFocusedManipulators)return;const e=this._intersectScreen(t);e!=null&&this._activeSubTool.onPointerMove({mapPoint:e,pointerType:t.pointerType})}_keyDownHandler(t){Ht.cancel===t.key?(this._activeSubTool?.removeStaged()&&this._placementMode==="multiple"&&t.stopPropagation(),this.active||(this.selectedDimension=null)):Ht.delete.includes(t.key)&&(this._activeSubTool?.removeStaged(),this._removeSelected())}_intersectScreen(t){const e=ze(t);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(e,this._intersector);const i=this._intersector.results.min,n=f.get();return i.getIntersectionPoint(n)?this.view.renderCoordsHelper.fromRenderCoords(n,new G({spatialReference:this.view.spatialReference})):null}_removeSelected(){this.selectedDimension!=null&&(this.analysis.dimensions.remove(this.selectedDimension),this.selectedDimension=null)}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=xe(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.manipulators.forEach(t=>t.manipulator.state|=A),this._prevPointerMoveTimeout=Re.setTimeout(()=>{this.manipulators.forEach(t=>t.manipulator.state&=~A)},this._pointerMoveTimerMs)}get test(){}};d([u({constructOnly:!0})],b.prototype,"view",void 0),d([u({constructOnly:!0})],b.prototype,"analysis",void 0),d([u({readOnly:!0})],b.prototype,"state",null),d([u({readOnly:!0})],b.prototype,"updating",null),d([u({readOnly:!0})],b.prototype,"cursor",null),d([u({constructOnly:!0})],b.prototype,"analysisViewData",void 0),d([u()],b.prototype,"selectedDimension",null),d([u()],b.prototype,"automaticManipulatorSelection",void 0),d([u()],b.prototype,"_activeSubTool",void 0),d([u()],b.prototype,"_lengthDimensionSubTool",void 0),d([u()],b.prototype,"_placementMode",void 0),b=d([I("esri.views.3d.analysis.Dimension.DimensionTool")],b);const Zt="multiple";class xn extends ri{constructor(e,i){super(e),this._hasExternalMaterial=!1,this._renderOccluded=4,this._width=1,this._color=ke(1,0,1,1),this._placement="end",this._markerPrimitive="arrow",this._material=i,this._hasExternalMaterial=i!=null,this.applyProperties(e)}setGeometryFromSegment(e,i){const n=e.endRenderSpace;this.transform=Ne(Rn,n),this._normal=i;const{points:a}=e.createRenderGeometry(n,this.view.renderCoordsHelper);this.geometry=[a]}get renderOccluded(){return this._material?.parameters.renderOccluded??this._renderOccluded}set renderOccluded(e){this._renderOccluded=e,this._material?.setParameters({renderOccluded:e})}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get normal(){return this._normal}set normal(e){this._normal=e,this.recreateGeometry()}get width(){return this._material?.parameters.width??this._width}set width(e){this._width=e,this._material?.setParameters({width:e})}get color(){return this._material?.parameters.color??this._color}set color(e){this._color=Ge(e),this._material?.setParameters({color:this._color})}get placement(){return this._material?.parameters.placement??this._placement}set placement(e){this._placement=e,this._material?.setParameters({placement:this._placement})}get markerPrimitive(){return this._material?.parameters.markerPrimitive??this._markerPrimitive}set markerPrimitive(e){this._markerPrimitive=e,this._material?.setParameters({markerPrimitive:e})}createExternalResources(){this._hasExternalMaterial||(this._material=new de({width:this._width,color:this._color,placement:this._placement,renderOccluded:this._renderOccluded,markerPrimitive:this._markerPrimitive,isDecoration:this.isDecoration},this.view.state.isGlobal))}destroyExternalResources(){this._hasExternalMaterial||(this._material=null)}createGeometries(e){for(const i of Ri(this.geometry,this.normal)){const n=Ai(this._material,i);e.addGeometry(n)}}forEachMaterial(e){this._hasExternalMaterial||e(this._material)}}const Rn=bt();let An=class{set visible(e){for(const i of this._visualElements.values())i.attached=e}constructor(e){this.destroyed=!1,this._handles=new Qt,this._messages=null,this._labelSegment=new V;const{analysis:i,computation:n,view:a,messages:s,isDecoration:o}=e;this.analysis=i,this.computation=n,this.view=a,this._messages=s;const l=e.visible,r={view:a,attached:l,isDecoration:o},{fontSize:p,textColor:m,textBackgroundColor:h}=i.style;this._visualElements=new En({marker:new xn(r,e.markerMaterial),dimension:new E(r,e.dimensionLineMaterial),startOffset:new E(r,e.offsetLineMaterial),endOffset:new E(r,e.offsetLineMaterial),dimensionSmall:new E(r,e.smallDimensionLineMaterial),startOffsetSmall:new E(r,e.smallOffsetLineMaterial),endOffsetSmall:new E(r,e.smallOffsetLineMaterial),label:new We({view:a,attached:l,distance:0,geometry:{type:"segment",sampleLocation:"center",segment:this._labelSegment,callout:!1},fontSize:D(p),textColor:m.clone(),backgroundColor:h.clone(),isDecoration:o})}),this._handles.add([v(()=>n.geometry,c=>{this.updateCameraDependentElements(a.state.camera,c,i.style),n.geometry!=null&&this._updateLines(n.geometry)},{...X,equals:gt}),v(()=>n.length,c=>this._updateLabelContent(c),X)])}destroy(){this.destroyed=!0,this._handles=Pt(this._handles);for(const e of this._visualElements.values())e.destroy()}get testInfo(){}_updateLines(e){const i=Ft(zn,0,e.directSegment,e.dimensionSegment),n=Ft(kn,1,e.directSegment,e.dimensionSegment),a=this._visualElements;a.marker.setGeometryFromSegment(e.dimensionSegment,e.primaryOffsetAxis),a.dimension.setGeometryFromSegment(e.dimensionSegment),a.startOffset.setGeometryFromSegment(i),a.endOffset.setGeometryFromSegment(n),a.dimensionSmall.setGeometryFromSegment(e.dimensionSegment),a.startOffsetSmall.setGeometryFromSegment(i),a.endOffsetSmall.setGeometryFromSegment(n)}updateCameraDependentElements(e,i,n){const a=this._visualElements;if(i==null){for(const M of a.values())M.visible=!1;return}const s=e.computeScreenPixelSizeAt(i.dimensionSegment.eval(.5,Gn)),o=Fi(i,s),l=o<(D(n.lineSize)*sn)**2,r=!l;a.marker.visible=r,a.dimension.visible=r,a.startOffset.visible=r,a.endOffset.visible=r,a.dimensionSmall.visible=l,a.startOffsetSmall.visible=l,a.endOffsetSmall.visible=l;const p=D(n.fontSize)*en,{label:m}=a;if(m.visible=o>=p**2,!m.visible)return;const{dimensionSegment:h,primaryOffsetAxis:c}=i,{offset:g}=this.computation.dimension,_=(Math.sign(g)>=0?1:-1)*Hn(n)*s;Gi(this._labelSegment,h,c,_),m.updateLabelPosition()}updateLabelStyle(e){const{label:i}=this._visualElements;i.fontSize=D(e.fontSize),i.textColor=e.textColor,i.backgroundColor=e.textBackgroundColor}updateUnitsMessages(e){this._messages=e;const{length:i}=this.computation;this._updateLabelContent(i)}_updateLabelContent(e){const{label:i}=this._visualElements;e!=null&&this._messages!=null?i.text=xi(this._messages,e,e.unit):i.text=""}};function Hn(t){return 1.5*D(t.fontSize)+tn+D(t.lineSize/2)}const zn=new V,kn=new V,Gn=P();class En{constructor(e){this.marker=e.marker,this.dimension=e.dimension,this.startOffset=e.startOffset,this.endOffset=e.endOffset,this.dimensionSmall=e.dimensionSmall,this.startOffsetSmall=e.startOffsetSmall,this.endOffsetSmall=e.endOffsetSmall,this.label=e.label}values(){return[this.marker,this.dimension,this.startOffset,this.endOffset,this.dimensionSmall,this.startOffsetSmall,this.endOffsetSmall,this.label]}}let x=class extends K{get analysis(){return this.analysisViewData.analysis}get visible(){return this.analysisViewData.visible}constructor(t){super(t),this.loadingMessages=!1,this._messages=null}initialize(){const t=this.isDecoration;this._markerMaterial=new de({width:1,anchor:1,color:B,placement:"begin-end",worldSpace:!0,hideOnShortSegments:!0,hasTip:!0,renderOccluded:4,markerPrimitive:"triangle",isDecoration:t},this.view.state.isGlobal),this._dimensionLineMaterial=new j({width:1,color:B,renderOccluded:4,markerParameters:this._markerMaterial.parameters,isDecoration:t},this.view.state.isGlobal),this._offsetLineMaterial=new j({width:1,color:B,renderOccluded:4,stipplePattern:rt(5),isDecoration:t},this.view.state.isGlobal),this._smallDimensionLineMaterial=new j({width:1,color:B,renderOccluded:4,isDecoration:t},this.view.state.isGlobal),this._smallOffsetLineMaterial=new j({width:1,color:B,renderOccluded:4,stipplePattern:rt(5),isDecoration:t},this.view.state.isGlobal);const e=ut(()=>this.analysisViewData.computations,({computation:i})=>this._createVisualization(i));this._dimensionVisualizations=e,this.addHandles([Q(e),v(()=>U.toUnitRGBA(this.analysis.style.color),i=>{for(const n of this._lineMaterials())n.setParameters({color:i})},O),v(()=>this.analysis.style.lineSize,i=>{const n=D(i);this._markerMaterial.setParameters({width:n*ge}),this._dimensionLineMaterial.setParameters({width:n,markerParameters:this._markerMaterial.parameters});const a=Math.max(n*Qi,1);this._offsetLineMaterial.setParameters({width:a})},O),v(()=>({camera:this.view.state.camera,style:Ln(this.analysis)}),({camera:i,style:n})=>{for(const{visualization:a}of this._dimensionVisualizations)a.updateCameraDependentElements(i,a.computation.geometry,n),a.updateLabelStyle(n)}),v(()=>this.visible,i=>{for(const{visualization:n}of this._dimensionVisualizations)n.visible=i})]),this.addHandles([Le(()=>this._updateMessageBundle()),at(()=>!this.loadingMessages,()=>{for(const{visualization:i}of this._dimensionVisualizations)i.updateUnitsMessages(this._messages)},vt)]),this._updateMessageBundle()}get testInfo(){}_createVisualization(t){const e=new An({analysis:this.analysis,computation:t,view:this.view,visible:this.visible,markerMaterial:this._markerMaterial,dimensionLineMaterial:this._dimensionLineMaterial,offsetLineMaterial:this._offsetLineMaterial,smallDimensionLineMaterial:this._smallDimensionLineMaterial,smallOffsetLineMaterial:this._smallOffsetLineMaterial,messages:this._messages,isDecoration:this.isDecoration});return{visualization:e,remove:()=>e.destroy()}}_lineMaterials(){return[this._markerMaterial,this._dimensionLineMaterial,this._offsetLineMaterial,this._smallDimensionLineMaterial,this._smallOffsetLineMaterial]}async _updateMessageBundle(){this.loadingMessages=!0;try{this._messages=await Ti("esri/core/t9n/Units")}finally{this.loadingMessages=!1}}};function Ln(t){const{fontSize:e,lineSize:i,textColor:n,textBackgroundColor:a}=t.style;return{fontSize:e,lineSize:i,textBackgroundColor:a.clone(),textColor:n.clone()}}d([u({constructOnly:!0})],x.prototype,"analysisViewData",void 0),d([u({constructOnly:!0,nonNullable:!0})],x.prototype,"view",void 0),d([u({constructOnly:!0})],x.prototype,"isDecoration",void 0),d([u()],x.prototype,"analysis",null),d([u()],x.prototype,"visible",null),d([u()],x.prototype,"loadingMessages",void 0),x=d([I("esri.views.3d.analysis.Dimension.DimensionVisualization")],x);let N=class extends K{constructor(t){super(t),this.dimension=null,this.length=null}};d([u({constructOnly:!0,nonNullable:!0})],N.prototype,"dimension",void 0),d([u()],N.prototype,"length",void 0),N=d([I("esri.views.analysis.LengthDimensionResult")],N);let C=class extends K{constructor(t){super(t),this.geometry=null,this.unconstrainedGeometry=null,this.elevationAlignedStartPoint=null,this.elevationAlignedEndPoint=null}normalizeCtorArgs(t){const{dimension:e,...i}=t;return{result:new N({dimension:e}),...i}}initialize(){this.addHandles([v(()=>this.dimension.startPoint,t=>this.elevationAlignedStartPoint=this.projectAndAlignPoint(t),O),v(()=>this.dimension.endPoint,t=>this.elevationAlignedEndPoint=this.projectAndAlignPoint(t),O)])}get dimension(){return this.result.dimension}get length(){return this.result.length}};d([u({constructOnly:!0,nonNullable:!0})],C.prototype,"result",void 0),d([u({constructOnly:!0,nonNullable:!0})],C.prototype,"projectAndAlignPoint",void 0),d([u()],C.prototype,"dimension",null),d([u()],C.prototype,"length",null),d([u()],C.prototype,"geometry",void 0),d([u()],C.prototype,"unconstrainedGeometry",void 0),d([u()],C.prototype,"elevationAlignedStartPoint",void 0),d([u()],C.prototype,"elevationAlignedEndPoint",void 0),d([u()],C.prototype,"preConstraintProperties",void 0),d([u()],C.prototype,"previousConstraint",void 0),C=d([I("esri.views.3d.analysis.Dimension.LengthDimensionComputation")],C);let w=class extends Ee{constructor(t){super(t),this.type="dimension-view-3d",this.analysis=null,this.tool=null,this.selectedDimension=null,this.userOperation=null,this._dimensionsToComputations=new Map,this._projectAndAlignPoint=null}initialize(){this._projectAndAlignPoint=e=>{if(e==null)return null;const{spatialReference:i,elevationProvider:n}=this.view,a=li(e,i,n);return a==null&&pi(this.analysis,e.spatialReference,Kt.getLogger(this)),a};const t=ut(()=>this.analysis.dimensions,e=>this._createComputation(e));this.computations=t,this.addHandles([$i(this,b),Q(t)]),this._analysisVisualization=new x({analysisViewData:this,view:this.view,isDecoration:!this.parent}),this.addResolvingPromise(Hi().then(e=>{this._analysisController=new k({analysisViewData:this,view:this.view,automaticLengthMeasurementUtils:e})}))}destroy(){this.userOperation=Ae(this.userOperation),Oi(this),this._analysisVisualization=Pt(this._analysisVisualization)}get visible(){return super.visible}set visible(t){super.visible=t}get interactive(){return super.interactive}set interactive(t){super.interactive=t}get updating(){return this._analysisVisualization?.loadingMessages??!1}get results(){return this.analysis.dimensions.map(t=>this._dimensionsToComputations.get(t).result)}get selectedComputation(){const{selectedDimension:t}=this;return t==null?null:this._dimensionsToComputations.get(t)}get testInfo(){}async createLengthDimensions(t){this.selectedDimension=null,await It(this,{placementOptions:t,onToolActivated:e=>e.place("multiple")})}place(t){return this.selectedDimension=null,It(this,{placementOptions:t,onToolActivated:e=>e.place("single")})}_createComputation(t){const{_dimensionsToComputations:e}=this,i=new C({dimension:t,projectAndAlignPoint:this._projectAndAlignPoint});return e.set(t,i),{computation:i,remove:()=>this._removeComputation(i)}}_removeComputation(t){const{dimension:e}=t;e===this.selectedDimension&&(this.selectedDimension=null),this._dimensionsToComputations.delete(e),t.destroy()}};d([u({readOnly:!0})],w.prototype,"type",void 0),d([u({constructOnly:!0,nonNullable:!0})],w.prototype,"analysis",void 0),d([u()],w.prototype,"tool",void 0),d([u()],w.prototype,"updating",null),d([u({readOnly:!0})],w.prototype,"results",null),d([u()],w.prototype,"computations",void 0),d([u()],w.prototype,"selectedDimension",void 0),d([u()],w.prototype,"selectedComputation",null),d([u()],w.prototype,"userOperation",void 0),d([u()],w.prototype,"_analysisVisualization",void 0),d([u()],w.prototype,"_analysisController",void 0),d([u()],w.prototype,"_dimensionsToComputations",void 0),w=d([I("esri.views.3d.analysis.DimensionAnalysisView3D")],w);const gr=w;export{gr as default};
