import{G,u as ue,W as fe,i as K,_ as O,m as H,a as ge}from"./jsonMap-Bs3hmeCU.js";import{h as E,l as Q,f as ye}from"./reactiveUtils-SO2Ko3sy.js";import{E as be,$ as _e,a0 as N,a as Z}from"./Polygon-BbQMC1ht.js";import{e as we}from"./mat4f64-q_b6UJoq.js";import{n as ve}from"./quatf64-CCm9z-pX.js";import{R as le,A as Me,N as xe,u as Ce,P as ee}from"./vec32-zHQcyKRA.js";import{n as C,b as Oe,t as Te}from"./collectionUtils-CB98pReO.js";import{r as je}from"./vec4f64-DPb6J-GU.js";import{z as Pe}from"./Point-62ir3Nzl.js";import{f as Ue}from"./computeTranslationToOriginAndRotation-CTVG2hGD.js";import{E as He,i as Se,t as Ee,a as Fe}from"./Transform-CCt9OVQD.js";import{n as Re}from"./projectVectorToVector-CDqzCeaL.js";import{i as Ve}from"./aaBoundingRect-DfeeUq5j.js";import{y as te,T as Ae,g as ke,M as Ie,o as z,O as Be,V as $e,H as De,v as ie,w as re}from"./BufferView-CdBDKeBv.js";import{y as Le}from"./SceneModification-8XJBM1CN.js";import{z as se}from"./elevationInfoUtils-OU8rgnDX.js";import{u as Ge}from"./I3SMeshWorkerHandle-Dfa1NACn.js";import{l as Ne}from"./LayerView3D-CCv_nmv5.js";import{d as ze,ad as We,ae as qe,af as Je,aa as Xe,ag as Ye,ac as Ke,ah as Qe,ai as Ze,aj as et}from"./ShadowCastClear.glsl-BGPoo-07.js";import{_ as oe}from"./enums-B4pqBiXb.js";import{l as tt}from"./intersectorUtilsConversions-Cv_V2i_M.js";import{f as it}from"./HUDIntersectorResult-Ds4yeNc-.js";import{i as rt,j as st,U as ot,q as W,k as at,M as nt,l as lt}from"./Texture-CAvBvljT.js";import{t as A,G as ct,J as mt}from"./orientedBoundingBox-CbUQAgG7.js";import{s as dt,t as pt}from"./EllipsoidMode-Diy_TLdg.js";import{f as ht}from"./edgePreprocessing-CBVaMT5L.js";import{d as ut}from"./LayerView-B4B44Ajx.js";import{l as ft,t as gt}from"./layerViewUtils-BTa15X3o.js";import"./Extent-Cs-ESnE1.js";import"./mathUtils-PIGhLnI9.js";import"./index-CB_zX-aI.js";import"./reader-DcGs6kKN.js";import"./SimpleObservable-CvFyr0NA.js";import"./mat4-Bjnccznk.js";import"./projectionUtils-ClsoIho7.js";import"./Polyline-CUSonZ4c.js";import"./projectBoundingSphere-s0pRerwh.js";import"./sphere-DGD4QNOm.js";import"./vector-knXISDaK.js";import"./vec2f64-rIxtbMRN.js";import"./projectPointToVector-B1tbWJiK.js";import"./vec42-fTNpW1Xv.js";import"./persistable-AW3PLevT.js";import"./MD5-MtSiOt06.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw.js";import"./uuid-Oe6SV2kF.js";import"./resourceExtension-3aprB2zB.js";import"./unitConversionUtils-BSQ4LGUO.js";import"./lengthUtils-Cm-zragw.js";import"./date-IqUzANpt.js";import"./WorkerHandle-IsvMxqHu.js";import"./workers-VgzaPqUK.js";import"./Queue-CYlrXMwB.js";import"./intl-BIQN36K8.js";import"./jsonUtils-alsySR4T.js";import"./typeUtils-BR_JAZOz.js";import"./modeUtils-BF30GgRz.js";import"./sanitizerUtils-BT_8V5US.js";import"./screenUtils-BitdhK1O.js";import"./PooledRBush-Dco5QkUp.js";import"./quickselect-QQC62dOK.js";import"./GraphicsCollection-mGxi3VN1.js";import"./Graphic-CkB18CDi.js";import"./getPopupProvider-mckaq9Ri.js";import"./Color-CERqXxxY.js";import"./Layer-BLV7fz0K.js";import"./createFeatureId-CVwTD0fV.js";import"./typeUtils-D0MaDvT3.js";import"./lineMarkers-CDwLe3J6.js";import"./PolygonSymbol3D-Dla3O-pf.js";import"./ExtrudeSymbol3DLayer-DSc1ou2x.js";import"./opacityUtils-DuFH0EC9.js";import"./aaBoundingBox-DO0Hqciy.js";import"./DoubleArray-DExKNiTh.js";import"./Font-BYMGzku7.js";import"./SimpleFillSymbol-CDawtd9z.js";import"./SimpleMarkerSymbol-BGAFRS9_.js";import"./PictureMarkerSymbol-CjQJkY_m.js";import"./TextSymbol-Ck-WHI2u.js";import"./HeightModelInfo-CNRqlD7K.js";import"./spatialReferenceEllipsoidUtils-BGTSZp-L.js";import"./RealisticTree.glsl-DAhEIR1w.js";import"./Emissions.glsl-B8XKMjLy.js";import"./InterleavedLayout-KZk0acs8.js";import"./types-BKo2foNY.js";import"./VertexElementDescriptor-BlxU8vCE.js";import"./meshVertexSpaceUtils-BZiL5Bbc.js";import"./MeshLocalVertexSpace-De2t7DNQ.js";import"./vec3f32-WCVSSNPR.js";import"./Indices-D0_UQPPr.js";import"./plane-CAH7O3r1.js";import"./memoryEstimations-Bd726a_p.js";import"./Intersector-BFu7YAUe.js";import"./frustum-Cq95H2HO.js";import"./scaleUtils-m8EJvm5m.js";import"./layerUtils-4EQ207Ij.js";import"./TilemapCache-DrtAz5a3.js";import"./LRUCache-fy84PBMi.js";import"./TileKey-zev9cGPe.js";import"./tagSymbols-BPcGfZon.js";import"./UpdatingHandles-D2RI_3Hb.js";import"./asyncUtils-w6KfWU41.js";import"./signal-BX9ezF8a.js";import"./Map-DoBsBAGU.js";import"./Basemap-BI8rdNrf.js";import"./loadAll-CleWBL8j.js";import"./PortalItem-QIiqvhel.js";import"./writeUtils-D0J7VXri.js";import"./CollectionFlattener-C1ewYzfL.js";import"./PolygonCollection-BQYUC051.js";import"./mat4f32-Djp3mnm5.js";import"./TablesMixin-MGFFfhKn.js";import"./timeZoneUtils-BSc7-7qA.js";import"./ReactiveMap-B0by2bYu.js";import"./Query-98igen-k.js";import"./Field-Cm_ZejYW.js";import"./fieldType-DVUzXtk_.js";import"./normalizeUtils-BTK6arYa.js";import"./Cyclical-BLSxUpe7.js";import"./normalizeUtilsCommon-BRJdiLvx.js";import"./utils-uBZTDKaj.js";import"./utils-tSEVTzcz.js";import"./ElevationQuery-C16QuML_.js";import"./TileInfo-fM6eYiPH.js";import"./Scheduler-CNrsbccs.js";import"./constants-D67WmGms.js";import"./quat-CCdR5JrD.js";import"./floatRGBA-D95YiFWR.js";import"./labelUtils-BtizwBfq.js";import"./ArcadeExpression-BKKJxDUn.js";import"./TimeOnly-DbBUn0Ig.js";import"./enum-BzLwmiID.js";import"./UnknownTimeZone-B697BDFv.js";import"./FieldsIndex-DoTtx8Ak.js";import"./TileKey-C44YQC4_.js";import"./vec2f32-CaVKkSa6.js";import"./dehydratedFeatures-BBoTEZJ8.js";import"./quantizationUtils-BSWXSK29.js";import"./featureConversionUtils-DlTGrdYn.js";import"./OptimizedFeature-CwRGZPwv.js";import"./OptimizedFeatureSet-BR8EEvDc.js";import"./Octree-vaE3elxD.js";import"./DefaultLoadingContext-BnNmzeR1.js";import"./wosrLoader-B8RYB0d4.js";import"./Version-BtYZEj58.js";import"./axisAngleDegrees-D1LL0HZb.js";import"./config-Dg972SSE.js";import"./GeometryUtils-BUMmi0hw.js";import"./definitions-Dvg4hMIw.js";import"./colorUtils-CfxFVJbg.js";import"./vec3-B_phcnZY.js";import"./vec33-CWJeyzxV.js";import"./capabilities-Bi6C4OG6.js";import"./imageUtils-DRSdxeif.js";import"./videoUtils-Dwx3AEgj.js";class yt extends ze{constructor(t,n,i,c,l,a,m){super(t,0,0,0,n),this.nodesCached=i,this.vboMB=c,this.textureMB=l,this.vboMBCached=a,this.textureMBCached=m}}const bt={Points:null,Lines:null,LineStrip:null,Triangles:oe.TRIANGLES,TriangleStrip:oe.TRIANGLE_STRIP,NotSet:null},ae={Opaque:1,Mask:2,Blend:0},_t={Back:2,Front:1,None:0,NotSet:2},wt={WrapYBit:{s:33071,t:10497},WrapXBit:{s:10497,t:33071},WrapXy:{s:10497,t:10497},None:{s:33071,t:33071},NotSet:{s:33071,t:33071}},vt={U8:1,I8:1,U16:2,I16:2,U32:4,I32:4,F32:4,F64:8,Utf8String:1,NotSet:1};class Mt{constructor(t){this.layerView=t,this.type=8,this.slicePlaneEnabled=!1,this.isGround=!0,this.layerViewUid=t.uid}intersect(t,n,i,c,l,a){if(t.options.filteredLayerViewUids.includes(this.layerView.uid))return;const{results:m,tolerance:_}=t,f=t.options.store===2,{componentObjectCollection:u}=this.layerView.view.stage.renderView,d=new rt(_,a,t.options.normalRequired),o=st(i,c,xt),r=le(C(),c,i),h=Me(C(),r),b=(x,g,y)=>{if(g>=0){if(n!=null&&!n(i,c,g))return;const w=p=>{const I=new tt(this.layerView.layer.uid);p.set(this.type,I,g,y)};if(this.isGround&&(m.ground.distance==null||g<m.ground.distance)&&w(m.ground),t.options.isFiltered)return;if((m.min.distance==null||g<m.min.distance)&&w(m.min),(m.max.distance==null||g>m.max.distance)&&w(m.max),f){const p=new it(t.ray);w(p),t.results.all.push(p)}}};this.layerView.forEachVisibleTile(x=>{if(!x.boundingVolumeIntersectsRay(i,h))return;const{componentObjects:g}=x;for(const y of g)ot(y.aabbInWorldCoordinates,i,o,0)&&u.intersect(y,i,c,null,d,b)})}}const xt=C();class Ct{constructor(t,n,i,c,l,a,m){this.handle=t,this.componentObjects=n,this.textures=i,this.cpuMemoryUsage=c,this.vboMemoryUsage=l,this.textureMemoryUsage=a,this.obb=m,this.isVisible=!1,this.usedMemory=this.textureMemoryUsage+this.vboMemoryUsage+this.cpuMemoryUsage;const _=C();m?.getCenter(_),this._obbCenter=_,this._obbRadiusSquared=m?m?.radius**2:0}boundingVolumeIntersectsRay(t,n){if(!this.obb)return!0;const i=le(Ot,this._obbCenter,t),c=ee(i,n);return ee(i,i)-c*c<=this._obbRadiusSquared&&this.obb.intersectRay(t,n)}}const Ot=C();function k(e){return Math.round(e/1048.576)/1e3}let M=class extends Ne(ut){get hasModifications(){return this._modifications&&this._modifications.length>0}constructor(e){super(e),this.type="integrated-mesh-3dtiles",this._compressionTracker=new We,this._modifications=new Array,this._visibleGeometryChangedSchedulerHandle=null,this._wasmLayerId=-1,this.ignoresMemoryFactor=!1,this._usedMemory=0,this._cacheMemory=0,this.drapeTargetType=1,this._applySSAO=!G("disable-feature:im-ssao"),this._shadeNormals=!!G("enable-feature:im-shading"),this._lyrHandleToObjects=new Map,this._visibleObjects=new Set,this._initialCullFace=new Map,this._suspendedHandle=null,this._dbgFlags=new Set,this._memCache=e.view.resourceController.memoryController.newCache(`IM3DTiles-${this.uid}`,t=>this._deletePerObjectData(t))}initialize(){this._dbgFlags.add(3),this._dbg(2,"Tiles3DLayerView3D initialize() called");const{view:e}=this;if(this._updatingHandles.add(()=>this.layer.modifications,()=>this._loadModifications(),E),!this._canProjectWithoutEngine())throw ft("layer",this.layer.spatialReference.wkid,e.renderSpatialReference?.wkid);const t=qe(this).then(n=>{this._wasmLayerId=n,this._intersectionHandler=new Mt(this),e.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler),this._updatingHandles.add(()=>this.slicePlaneEnabled,i=>this._slicePlaneEnabledChange(i)),this._updatingHandles.add(()=>this._modifications,()=>this._modificationsChanged(),E),this._updatingHandles.add(()=>this.fullOpacity,()=>this._opacityChange()),this._updatingHandles.add(()=>e.clippingArea,()=>this._clippingAreaChanged(),E),this._elevationProvider=new He({view:e,layerElevationSource:this,intersectionHandler:this._intersectionHandler}),e.elevationProvider.register(1,this._elevationProvider),e.overlayManager.registerDrapeTarget(this),this.addHandles([Q(()=>this.layer.elevationInfo,i=>this._elevationInfoChanged(i))]),this._suspendedHandle=Q(()=>this.suspended,i=>this._wasm?.setEnabled(this,!i),E)});this.addResolvingPromise(t),this._replacesTerrain&&this.addHandles(ye(()=>this.view.map.ground.opacity,()=>{this._opacityChange()}))}get _replacesTerrain(){return this.layer.replacesTerrain&&!!this.view.map.basemap?.groundLayers.includes(this.layer)}get fullOpacity(){return this._replacesTerrain?this.view.map.ground.opacity:1}get opacity(){return 1}_opacityChange(){const{fullOpacity:e}=this;this.forEachComponentObject(t=>{this._collection.getMaterial(t).objectOpacity=e})}intersect(e,t,n,i){this._intersectionHandler.intersect(e,t,n,i,null,!1)}get ready(){return!0}destroy(){this._dbg(2,"Tiles3DLayerView3D destroy() called"),Je(this),this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null),this._intersectionHandler&&(this.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null),this._elevationProvider&&(this._elevationProvider.notifyObjectsChangedFunctional(e=>this.forEachComponentObject(t=>e(t.obb))),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this.view.overlayManager.unregisterDrapeTarget(this),this._lyrHandleToObjects.forEach(e=>this.freeObject(e)),this._lyrHandleToObjects.clear(),this._initialCullFace.clear(),this._visibleObjects.clear(),this._usedMemory=0,this._cacheMemory=0,this._memCache.destroy(),this._updatingHandles=ue(this._updatingHandles),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}_modificationsChanged(){const e=this.layer.spatialReference,t=Ge(this._layerClippingArea,this._modifications,e);this._wasm?.setMeshModifications(this,t,e.wkid)}_clippingAreaChanged(){const e=this.layer.spatialReference,t=Ve();this._layerClippingArea=Xe(this.view.clippingArea,t,e)?t:null,this._modificationsChanged()}_visibleGeometryChanged(){this._visibleGeometryChangedSchedulerHandle??=fe(()=>{this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle=null})}_slicePlaneEnabledChange(e){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=e),this.forEachComponentObject(t=>{const n=this._collection.getMaterial(t);n.commonMaterialParameters.hasSlicePlane=e,n.commonMaterialParameters.cullFace=e?0:this._initialCullFace.get(t)})}_elevationInfoChanged(e){this._wasm?.setLayerOffset(this,se(e))}get _wasm(){return Ye(this.view)}get wasmLayerId(){return this._wasmLayerId}get usedMemory(){return this._usedMemory}get unloadedMemory(){return 0}get cachedMemory(){return this._cacheMemory}get visibleAtCurrentScale(){return gt(this.layer.effectiveScaleRange,this.view.scale)}get performanceInfo(){let e=0,t=0,n=0,i=0,c=0,l=0;return this._lyrHandleToObjects.forEach(a=>{a.isVisible?(e+=a.textureMemoryUsage,t+=a.vboMemoryUsage,c++):(n+=a.textureMemoryUsage,i+=a.vboMemoryUsage,l++)}),new yt(this.usedMemory,c,l,k(t),k(e),k(i),k(n))}_canProjectWithoutEngine(){if(this.view.state.viewingMode===2){const e=this.view.renderSpatialReference?.isWebMercator?3857:this.view.renderSpatialReference?.wkid??-1;if(e!==3857&&e!==32662)return!1}return!0}get _stage(){return this.view.stage}get _collection(){return this._stage.renderView.componentObjectCollection}get elevationProvider(){return this._elevationProvider}get elevationOffset(){return se(this.layer.elevationInfo)}get elevationRange(){const e=this.fullExtent;return e?.zmin&&e?.zmax?new Ke(e.zmin,e.zmax):null}getElevationRange(e){return null}get fullExtent(){return this.layer.fullExtent}forEachComponentObject(e){this._forEachObject(this._lyrHandleToObjects.values(),e)}forEachVisibleTile(e){for(const t of this._visibleObjects)e(t)}forEachVisibleComponentObject(e){this._forEachObject(this._visibleObjects,e)}_forEachObject(e,t){for(const n of e)for(const i of n.componentObjects)t(i)}isUpdating(){const e=this._wasm;return!(this._wasmLayerId<0||e==null)&&(e.isUpdating(this._wasmLayerId)||this._compressionTracker.compressing)}updatingFlagChanged(){this.notifyChange("updating")}async createRenderable(e){const t=e.meshData;if(t.data==null)throw new Error("meshData.data undefined");if(t.desc=JSON.parse(t.desc),t.desc==null)throw new Error("meshData.desc undefined");const n=Oe(t.desc.origin),i=new Array,c=this.view.basemapTerrain.spatialReference;let l,a;if(this.view.viewingMode==="global"){const y=we();Ue(Pe,n,y,c),l=be(Z(),y),a=_e(Z(),l)}else l=N,a=N;const m=Te(n),_=C(),f=jt(t.desc.obb);let u=0,d=0;const o={textureMemoryUsage:0},r=new Array,h=new Map,b=t.desc.prims.length;for(let y=0;y<b;y++){const w=t.desc.prims[y];if(this._dbg(2,JSON.stringify(w)),bt[w.ptype]==null||t.data==null){this._dbg(2,"[Unsupported Feature] Unsupported primitive mode ("+w.ptype+"). Skipping primitive.");continue}const p=t.desc?.materials&&w.materialId!=null?t.desc.materials[w.materialId]:null,I=p!=null?p.lightingModel:"Unlit",{positionView:T,positionAttr:j,normalsView:ce,normalsAttr:B,colorAttr:F,texCoord0Attr:R,indicesView:S}=this.getBufferViews(w,t.data.buffer,l);if(j==null||T==null||S==null)continue;const q=new Qe(F!=null,R?1:0,ce!=null,this._shadeNormals||this._replacesTerrain,this._applySSAO),me=j.data.length/j.size,$=(v,s)=>!v||v.data.length/v.size===me||(this._dbg(3,`${s} !== numPos. Skipping primitive.`),!1);if(!$(R,"numTexcoord")||!$(F,"numColors")||!$(B,"normals"))continue;const J=Ze(q),de=f?.clone()??Tt(j,n);if(l!==N)for(let v=0;v<T.count;v++)T.getVec(v,_),xe(_,_,l),T.setVec(v,_);const P=J.createBuffer(j.data.length);if(W("position",j,null,null,P,0),R!=null){const v=P.getField("uv0",te);at(R,v,0)}F!=null&&W("color",F,null,null,P,0),B!=null&&W("normalCompressed",B,null,null,P,0);const pe=new Uint32Array([0,S.typedBuffer.length]),he=new et({data:P.buffer,count:P.byteLength/J.stride,layoutParameters:q},{positions:T.typedBuffer,indices:S.typedBuffer},S.typedBuffer,pe);u+=T.count+S.count;const X=this.view.renderSpatialReference,D=C(),L=[1,1,1];Se(m,X,L,c)||this._dbg(3,"Unsupported coordinate system for IM overlay"),Re(m,X,D,c);const V=this._collection.createObject(new Ee(je(D[0],D[1],L[0],L[1]),new Fe(m,a),de,he,!1));if(p){const v=s=>{s.baseColor=p.baseColorFactor,s.usePBR=I==="Pbr",s.hasParametersFromSource=!1,s.baseColorTexture=this._getTexture(p.baseColorTex,t,h,o),s.usePBR&&(s.mrrFactors=[p.metallicFactor,p.roughnessFactor,0],s.emissiveBaseColor=p.emissiveFactor??[0,0,0],s.metallicRoughnessTexture=this._getTexture(p.metalTex,t,h,o),s.emissionTexture=this._getTexture(p.emissiveTex,t,h,o),s.occlusionTexture=this._getTexture(p.occlusionTex,t,h,o),s.normalTexture=this._getTexture(p.normalTex,t,h,o)),s.objectOpacity=0,s.alphaDiscardMode=2;const U=[];s.baseColorTexture&&U.push(s.baseColorTexture.loadPromise),s.usePBR&&(s.metallicRoughnessTexture&&U.push(s.metallicRoughnessTexture.loadPromise),s.emissionTexture&&U.push(s.emissionTexture.loadPromise),s.occlusionTexture&&U.push(s.occlusionTexture.loadPromise),s.normalTexture&&U.push(s.normalTexture.loadPromise));const Y=Promise.all(U);i.push(Y),Y.then(()=>{s.alphaDiscardMode=ae[p.alphaMode],s.objectOpacity=this.fullOpacity,o.textureMemoryUsage+=s.baseColorTexture?.glTexture?.usedMemory??0,s.usePBR&&(o.textureMemoryUsage+=(s.metallicRoughnessTexture?.glTexture?.usedMemory??0)+(s.emissionTexture?.glTexture?.usedMemory??0)+(s.occlusionTexture?.glTexture?.usedMemory??0)+(s.normalTexture?.glTexture?.usedMemory??0))}),s.commonMaterialParameters.doubleSided=p.isDoubleSided,s.commonMaterialParameters.cullFace=p.faceCulling?_t[p.faceCulling]:0,this._initialCullFace.set(V,s.commonMaterialParameters.cullFace),s.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,s.componentParameters.castShadows=0,s.textureAlphaCutoff=p.alphaCutoff??lt,s.alphaDiscardMode=ae[p.alphaMode],s.isIntegratedMesh=!0,s.sphereDepthInterpolate=this.layer.hasGoogleUrl,s.polygonOffsetEnabled=!1,s.hasOccludees=!1,s.ellipsoidMode=pt(this.view.spatialReference)};this._collection.updateMaterial(V,v)}r.push(V),d+=this._collection.getObjectGPUMemoryUsage(V)}await Promise.all(i);const x=new Array;h.forEach(y=>{x.push(y)});const g=new Ct(e.handle,r,x,u,d,o.textureMemoryUsage,f);return this._memCache.put(`${g.handle}`,g),this._lyrHandleToObjects.set(e.handle,g),this._cacheMemory+=g.usedMemory,{memUsageBytes:g.usedMemory}}freeRenderable(e){const t=this._lyrHandleToObjects.get(e);t&&(t.isVisible?(this._visibleObjects.delete(t),this._usedMemory-=t.usedMemory):this._cacheMemory-=t.usedMemory,this.freeObject(t),this._lyrHandleToObjects.delete(e))}freeObject(e){this._memCache.pop(`${e.handle}`),e.textures.forEach(t=>this._stage.removeTexture(t)),e.componentObjects.forEach(t=>{this._collection.destroyObject(t),this._initialCullFace.delete(t)})}setRenderableVisibility(e,t,n){for(let i=0;i<n;++i){const c=t[i];if(!c)continue;const l=e[i],a=this._lyrHandleToObjects.get(l);if(a){if(a.isVisible)continue;this._visibleGeometryChanged(),a.isVisible=!0,this._visibleObjects.add(a),this._usedMemory+=a.usedMemory,this._cacheMemory-=a.usedMemory,a.componentObjects.forEach(m=>{this._collection.setObjectVisibility(m,c),this._elevationProvider.notifyObjectChanged(this._collection.getComponentObb(m))}),this._memCache.pop(`${l}`)}}for(let i=0;i<n;++i){const c=e[i],l=t[i];if(l)continue;const a=this._lyrHandleToObjects.get(c);if(a){if(!a.isVisible)continue;this._visibleGeometryChanged(),a.isVisible=!1,this._visibleObjects.delete(a),this._usedMemory-=a.usedMemory,this._cacheMemory+=a.usedMemory,a.componentObjects.forEach(m=>{this._collection.setObjectVisibility(m,l),this._elevationProvider.notifyObjectChanged(this._collection.getComponentObb(m))}),this._memCache.put(`${c}`,a)}}}_getTexture(e,t,n,i){let c=null;if(e&&t.desc?.images&&t.data?.buffer){const l=t.desc.images[e?.imageId];if(c=n.get(l),!c&&l){const a=this._stage.renderView.renderingContext.parameters.maxMaxAnisotropy,m=!!l.mipCount||a>1,_=wt[e.wrapMode??"None"];let f=l.alpha?6408:6407;const u=new Uint8Array(t.data.buffer,l.data.byteOffset,l.data.byteCount);let d=null,o=null,r=null;switch(l.format){case"Raw":l.pixelFormat==="R8"?(d=u,f=6403,o=""):l.pixelFormat==="Rgb8"?(d=u,f=6407,o=""):l.pixelFormat==="Rgba8"&&(d=u,f=6408,o="");break;case"Dxt1":d=u,f=6407,o="image/vnd-ms.dds";break;case"Dxt5":d=u,f=6408,o="image/vnd-ms.dds";break;case"Basis":d=u,f=6407,o="image/ktx2";break;case"Png":o="image/png",r=document.createElement("img");break;case"Jpeg":o="image/jpeg",r=document.createElement("img");break;case"Etc2":o="image/ktx",r=document.createElement("img");break;case"Astc":this._dbg(3,"Astc texture not supported");break;case"Pvrtc":this._dbg(3,"Pvrtc texture not supported")}if(r&&o){const h=new Blob([u],{type:o});r.src=URL.createObjectURL(h),d=r}if(d&&o!=null){const h=G("enable-feature:esri-compress-IM-textures")?{compressionTracker:this._compressionTracker,compressionCallback:b=>{b&&b>0&&(i.textureMemoryUsage-=b)}}:void 0;c=new nt(d,{mipmap:m,maxAnisotropy:a,encoding:o,wrap:_,pixelFormat:f,compressionOptions:h,noUnpackFlip:!0,width:l.mip0Width,height:l.mip0Height}),this._stage.addTexture(c),n.set(l,c)}}}return c?new dt(this.view.stage.renderView.textures,c.id):null}getBufferViews(e,t,n){let i,c,l,a,m,_,f,u=null;for(let d=0;d<e.atrbs.length;d++){const o=e.atrbs[d],r=o.view,h=void 0,b=r.byteOffset+r.byteCount,x=r.byteCount/vt[r.type],g=[...Array(x).keys()].map(y=>y);try{switch(o.sem){case"Position":r.ncomp!==3||r.type!=="F32"?this._dbg(3,"[Unsupported Feature] Unsupported view for Position ("+r+")"):(i=new z(t,r.byteOffset,h,b),c=new A(i.typedBuffer,g,3));break;case"Normal":if(r.ncomp!==3||r.type!=="F32")this._dbg(3,"[Unsupported Feature] Unsupported view for Normal ("+r+")");else{const y=new z(t,r.byteOffset,h,b),w=ht(y.typedBuffer,n);m=new De(w.buffer),_=new A(m.typedBuffer,g,2)}break;case"TexCoord":r.ncomp!==2||r.type!=="F32"?this._dbg(3,"[Unsupported Feature] Unsupported view for Texcoord ("+r+")"):a===void 0&&(a=new A(new te(t,r.byteOffset,h,b).typedBuffer,g,2));break;case"Color":r.ncomp===4?(r.type==="F32"&&(u=new Ae(t,r.byteOffset,h,b)),r.type==="U8"&&(u=new ke(t,r.byteOffset,h,b)),r.type==="U16"&&(u=new Ie(t,r.byteOffset,h,b))):r.ncomp===3&&(r.type==="F32"&&(u=new z(t,r.byteOffset,h,b)),r.type==="U8"&&(u=new Be(t,r.byteOffset,h,b)),r.type==="U16"&&(u=new $e(t,r.byteOffset,h,b))),u==null?this._dbg(2,"[Unsupported Feature] Unsupported view for Color ("+r+")"):l=new A(u.typedBuffer,g,r.ncomp);break;case"FeatureIndex":break;default:this._dbg(2,"[Unsupported Feature] Unsupported semantic ("+o.sem+"). Skipping vertex attribute.")}}catch(y){this._dbg(2,"Error Creating buffer ("+y+"). Skipping vertex attribute.")}}if(e.index){const d=e.index.view,o=void 0,r=d.byteOffset+d.byteCount;switch(e.index.view.type){case"U16":f=new re(t,d.byteOffset,o,r);break;case"U32":f=new ie(t,d.byteOffset,o,r);break;default:this._dbg(3,"[Unsupported Feature] index type not supported ("+d.type+").")}}if(f==null&&i!=null){const d=i.count;if(d<65535){const o=new Uint16Array(d);f=new re(o.buffer)}else{const o=new Uint32Array(d);f=new ie(o.buffer)}for(let o=0;o<d;o++)f.set(o,o)}return{positionView:i,positionAttr:c,colorAttr:l,texCoord0Attr:a,indicesView:f,normalsView:m,normalsAttr:_}}_loadModifications(){if(this.removeHandles("modifications"),this.layer.modifications==null)return void(this._modifications=[]);const e=this.layer.modifications;this.addHandles(this._updatingHandles.addOnCollectionChange(()=>e,()=>this._modifications=e.toArray(),E),"modifications")}_deletePerObjectData(e){this._wasm?.onRenderableEvicted(this,e.handle,e.usedMemory),this.freeRenderable(e.handle)}_dbg(e,t){this._dbgFlags.has(e)&&(e===3?K.getLogger(this).error(t):K.getLogger(this).warn(t))}};O([H()],M.prototype,"fullOpacity",null),O([H({type:[Le]})],M.prototype,"_modifications",void 0),O([H()],M.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),O([H()],M.prototype,"layer",void 0),O([H({readOnly:!0})],M.prototype,"visibleAtCurrentScale",null),O([H()],M.prototype,"elevationOffset",null),M=O([ge("esri.views.3d.layers.IntegratedMesh3DTilesLayerView3D")],M);const vs=M,ne=C();function Tt(e,t){const n=mt(e);return Ce(ne,n.center,t),n.center=ne,n}function jt(e){return e?new ct(e.center,e.halfSize,ve(...e.quaternion)):null}export{vs as default};
