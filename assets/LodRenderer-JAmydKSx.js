import{a1 as N,ad as W,d as k,aT as K,u as Q,s as A,e as X,_ as f,m as y,a as ee}from"./jsonMap-Bs3hmeCU.js";import{e as j}from"./mat4f64-q_b6UJoq.js";import{c as x,P as O,E as B}from"./vec32-CNF8e3LG.js";import{n as E}from"./collectionUtils-Dk3LoVuX.js";import{n as Y,e as S}from"./vec4f64-DPb6J-GU.js";import{x as te,g as ne,F as se,y as ae,z as re,a as P,B as w,C as ie,D as oe,R as le}from"./Texture-Cw36TGeQ.js";import{t as Z}from"./InterleavedLayout-8W9JN4bc.js";import{aq as ce,ar as he,as as de,c as L,at as ue}from"./ShadowCastClear.glsl-Bhq9MYuW.js";import{s as R}from"./BufferView-BMlFYMIb.js";import{R as me,P as _e,D as ge,H as pe}from"./sphere-9lseHxo-.js";import{m as fe}from"./plane-CYSvzg5X.js";import{S as ye}from"./Octree-Bb_mCzwl.js";import{q as ve,l as F,b as be,F as Ie}from"./aaBoundingBox-CtkshuSS.js";import{f as Ce,F as De}from"./Scheduler-CNrsbccs.js";import{n as Se}from"./VertexElementDescriptor-BlxU8vCE.js";class Re extends ye{constructor(e,n){super(s=>me(this._instanceData.view.boundingSphere.getVec(s,Ee)),{maximumDepth:25}),this._instanceData=e,this._boundingSphere=n,this._tmpSphere=_e(),this._tmpMat4=j()}addInstance(e){const n=this._instanceData.view.boundingSphere,s=this._instanceData.getCombinedModelTransform(e,this._tmpMat4);ge(this._tmpSphere,this._boundingSphere.center,s),this._tmpSphere[3]=this._boundingSphere.radius*fe(s),n.setVec(e,pe(this._tmpSphere)),this.add([e])}removeInstance(e){this.remove([e])}}const Ee=Y();class xe{constructor(e,n){this._worldSpaceRadius=e,this._minScreenSpaceRadii=n}selectLevel(e,n,s){const a=s.computeScreenPixelSizeAt(e),o=this._worldSpaceRadius*n/a;let r=0;for(let l=1;l<this._minScreenSpaceRadii.length;++l)o>=this._minScreenSpaceRadii[l]&&(r=l);return r}}class we{constructor(e,n){this.geometry=n;const s=e.renderContext.rctx,a=n.renderGeometry,{material:o,layout:r,buffer:l}=a;this._materials=e.materials,o.setParameters({instancedDoublePrecision:!0}),this.glMaterials=new ce(o,this._materials),this.vbo=new te(s,Z(r),l),this.vao=new he(s,this.vbo)}destroy(){this.glMaterials.dispose(),this.vbo.dispose(),this.vao.dispose()}get material(){return this.geometry.renderGeometry.material}get layout(){return this.geometry.renderGeometry.layout}get boundingInfo(){return this.geometry.boundingInfo}get numTriangles(){return this.numVertices/3}get numVertices(){return this.geometry.renderGeometry.numVertices}get usedMemory(){return 128+this.vbo.usedMemory+this.vao.usedMemory}intersect(e,n,s,a,o,r,l,i){return this.geometry.intersect(e,n,s,a,o,r,l,i)}}class M{static async create(e,n,s){const a=await Promise.allSettled(n.components.map(r=>e.controller.schedule(()=>new we(e,r.geometry),s))),o=a.map(r=>r.status==="fulfilled"?r.value:null).filter(N);if(W(s)||o.length!==a.length){o.forEach(r=>r.destroy()),k(s);for(const r of a)if(r.status==="rejected")throw r.reason}return new M(n.minScreenSpaceRadius,o)}constructor(e,n){this.minScreenSpaceRadius=e,this.components=n}destroy(){this.components.forEach(e=>e.destroy())}intersect(e,n,s,a,o,r,l){this.components.forEach(i=>i.intersect(e,n,s,a,o,r,this.boundingSphere,l))}get boundingBox(){if(this._boundingBox==null){const e=ve();this.components.forEach(n=>{n.boundingInfo!=null&&(F(e,n.boundingInfo.bbMin),F(e,n.boundingInfo.bbMax))}),this._boundingBox=e}return this._boundingBox}get boundingSphere(){if(this._boundingSphere==null){const e=this.boundingBox,n=E();be(e,n),this._boundingSphere={center:n,radius:.5*Ie(e)}}return this._boundingSphere}get triangleCount(){return this.components.reduce((e,n)=>e+n.numTriangles,0)}}const Le=t=>{const e=t.baseBoundingSphere.radius,n=t.levels.map(s=>s.minScreenSpaceRadius);return new xe(e,n)};let g=class extends de{constructor(t,e){super(t),this.type=3,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=new Array,this._highlightRenderInstanceDatas=new Map,this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new ne,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.produces=new Map([[2,n=>this._produces(n)],[4,n=>!!this._hasTransparentLevels()&&this._produces(n)]]),this._instanceData=new se({shaderTransformation:t.shaderTransformation},t.symbol.materialParameters),this.addHandles(e.registerTask(Ce.LOD_RENDERER,this))}initialize(){this._instanceBufferLayout=ae(this.symbol.materialParameters),this._glInstanceBufferLayout=Z(this._instanceBufferLayout,1),this.addHandles([this._instanceData.events.on("instances-changed",()=>this._requestUpdateCycle()),this._instanceData.events.on("instance-transform-changed",({index:t})=>{this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(t)}),this._instanceData.events.on("instance-visibility-changed",({index:t})=>{this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(t)}),this._instanceData.events.on("instance-highlight-changed",()=>this._requestUpdateCycle(!0))])}get _allRenderInstanceData(){return[this._defaultRenderInstanceData,...this._highlightRenderInstanceDatas.values()]}get _allRenderInstanceDataExceptHighlightShadow(){const t=[this._defaultRenderInstanceData];for(const e of this._highlightRenderInstanceDatas)e[0]!==L&&t.push(e[1]);return t}hasHighlight(t){return this._highlightRenderInstanceDatas.has(t)}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(t){this._slicePlane=t}get layerViewUid(){return this.metadata.layerViewUid}get instanceData(){return this._instanceData}get hasEmitters(){return this._levels.some(t=>t.components.some(e=>e.material.hasEmissions))}get usedMemory(){return this._allRenderInstanceData.reduce((t,e)=>e.reduce((n,s)=>n+s.usedMemory,t),this._levels.reduce((t,e)=>t+e.components.reduce((n,s)=>n+s.usedMemory,0),0))}get renderStats(){const t=this._instanceData.size,e=[];return this._levels.forEach((n,s)=>{const a=this._allRenderInstanceData[0][s].size+this._allRenderInstanceData[1][s].size,o=n.triangleCount;e.push({renderedInstances:a,renderedTriangles:a*o,trianglesPerInstance:o})}),{totalInstances:t,renderedInstances:e.reduce((n,s)=>n+s.renderedInstances,0),renderedTriangles:e.reduce((n,s)=>n+s.renderedTriangles,0),levels:e}}_createRenderInstanceDataArray(){const{rctx:t}=this._context.renderContext;return this.symbol.levels.map(e=>new re(t,this._instanceBufferLayout))}async initializeRenderContext(t,e){this._context=t,this._defaultRenderInstanceData=this._createRenderInstanceDataArray();const n=await Promise.allSettled(this.symbol.levels.map(a=>M.create(t,a,e))),s=n.map(a=>a.status==="fulfilled"?a.value:null).filter(N);if(W(e)||s.length!==n.length){s.forEach(a=>a.destroy()),k(e);for(const a of n)if(a.status==="rejected")throw a.reason}this._levels=s,this._levelSelector=Le(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach(t=>t.destroy()),this._defaultRenderInstanceData.forEach(t=>t.destroy()),this._highlightRenderInstanceDatas.forEach(t=>t.forEach(e=>e.destroy()))}_hasTransparentLevels(){return this._levels.some(t=>t.components.some(e=>e.material.produces.get(4)?.(0)))}hasHighlights(){return K(this._highlightRenderInstanceDatas,t=>t.some(e=>e.size>0))}_produces(t){return(t!==9||this.hasHighlights())&&(t!==5||this.hasHighlight(L))}prepareRender(t){if(!P.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){const e=t.bind.contentCamera.equals(this._camera);this._camera.copyFrom(t.bind.contentCamera),e||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(De),this._needFullCycle=!1)}}acquireTechniques(t){if(!this.baseMaterial.visible||!this.baseMaterial.isVisibleForOutput(t.output))return null;const e=this._getInstanceDatas(t);if(!e)return null;const n=new Array,s=this.levels;return e.forEach(a=>s.forEach(({components:o},r)=>o.forEach(l=>n.push(this._beginComponent(t,a[r],l))))),n}render(t,e){const n=this._getInstanceDatas(t);if(!n||e==null)return;let s=0;const a=this.levels;n.forEach(o=>a.forEach(({components:r},l)=>r.forEach(i=>this._renderComponent(t,e[s++],o[l],i,l)))),t.rctx.unbindBuffer(34962),t.rctx.bindVAO(null)}_getInstanceDatas(t){const{output:e,bind:n}=t,s=e===9,a=e===5,o=e!==6;if(!s&&!a)return o?this._allRenderInstanceData:this._allRenderInstanceDataExceptHighlightShadow;const{_highlightRenderInstanceDatas:r}=this;if(o){if(s){const i=n.highlight?.name;if(!i)return null;const m=r.get(i);return m?[m]:null}const l=r.get(L);return a?l?[l]:null:Array.from(r.values())}return null}intersect(t,e,n,s){if(!this.baseMaterial.visible||this._octree==null)return;const a=E();x(a,s,n);const o=r=>{this._instanceData.getCombinedModelTransform(r,q),t.transform.set(q),B(H,n,t.transform.inverse),B(z,s,t.transform.inverse);const l=this._instanceData.getState(r),i=this._instanceData.getLodLevel(r),m=this._levels.length;4&l&&(R(!!(18&l),"invalid instance state"),R(i>=0&&i<m,"invaid lod level"),this._levels[i].intersect(t,e,H,z,r,this.metadata,m))};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(o):this._octree.forEachAlongRay(n,a,o)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){if(this._octreeCached==null){const t=this._instanceData,e=t.view?.state;if(!e)return null;this._octreeCached=new Re(t,this.baseBoundingSphere);for(let n=0;n<t.capacity;++n)18&e.get(n)&&this._octreeCached.addInstance(n)}return this._octreeCached}_invalidateOctree(){this._octreeCached=Q(this._octreeCached)}queryDepthRange(t){if(this._octree==null)return new w;const e=t.viewForward,n=this._octree.findClosest(e,1,t.frustum),s=this._octree.findClosest(e,-1,t.frustum);if(n==null||s==null)return new w;const a=t.eye,o=this._instanceData.view;o.boundingSphere.getVec(n,p),x(p,p,a);const r=O(p,e)-p[3];o.boundingSphere.getVec(s,p),x(p,p,a);const l=O(p,e)+p[3];return new w(r,l)}_requestUpdateCycle(t=!1){this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,t&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._allRenderInstanceData.forEach(t=>t.forEach(e=>e.startUpdateCycle()))}get readyToRun(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(t){const{_enableLevelSelection:e,_camera:n,_levelSelector:s}=this;this._allRenderInstanceData.forEach(d=>d.forEach(c=>c.beginUpdate()));const a=this._instanceData,o=a.view;let r=a.size;const l=a.capacity;let i=this._instanceIndex;const m=Math.ceil(l/500),{_highlightRenderInstanceDatas:u}=this;for(let d=0;d<r&&!t.done;++d){i===this._cycleStartIndex&&this._startUpdateCycle();const c=o.state.get(i);let h=0;if(!(1&c)){i=i+1===l?0:i+1,r++;continue}const I=o.lodLevel.get(i);if(2&c&&this._defaultRenderInstanceData[I].freeTail(),16&c){const _=a.geHighlightOptionsPrev(i);if(_){const v=u.get(_);if(!v)throw new A("internal:lod-renderer","Internal error in lodRenderer");v[I].freeTail(),v.every(D=>D.isEmpty)&&(v.forEach(D=>D.destroy()),u.delete(_))}}if(32&c)a.freeInstance(i);else if(4&c){let _=0;if(e&&(o.modelOrigin.getVec(i,U),_=s.selectLevel(U,a.getCombinedMedianScaleFactor(i),n)),h=-83&c,_>=0)if(8&c){const v=a.getHighlightName(i);if(v){const D=()=>{const $=this._createRenderInstanceDataArray();return $.forEach(J=>J.beginUpdate()),$},T=X(u,v,D);if(_>=T.length)throw new A("internal:lod-renderer",`LodRenderer internal error - missing lodLevel ${_}`);V(T[_],o,i)}h|=16}else V(this._defaultRenderInstanceData[_],o,i),h|=2;o.state.set(i,h),o.lodLevel.set(i,_)}else h=-83&c,o.state.set(i,h);const b=!!(18&c),C=!!(18&h);this._octreeCached!=null&&(!b&&C?this._octreeCached.addInstance(i):b&&!C?this._octreeCached.removeInstance(i):b&&C&&64&c&&(this._octreeCached.removeInstance(i),this._octreeCached.addInstance(i))),i=i+1===l?0:i+1,i%m===0&&t.madeProgress(),b!==C&&this.metadata.notifyGraphicVisibilityChanged(i),C&&64&c&&this.metadata.notifyGraphicGeometryChanged(i)}this._instanceIndex=i,this._allRenderInstanceData.forEach(d=>d.forEach(c=>c.endUpdate())),this._context.requestRender()}_beginComponent(t,e,n){return e.size===0?null:n.glMaterials.load(t.rctx,t.bind.slot,t.output)?.beginSlot(t.bind)}_renderComponent(t,e,n,s,a){if(!e)return;const{bind:o,rctx:r}=t;r.runAppleAmdDriverHelper();const l=r.bindTechnique(e,o,s.material.parameters,Te),i=this._glInstanceBufferLayout;l.assertCompatibleVertexAttributeLocations(s.vao,Se(i)),r.bindVAO(s.vao),P.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&t.output===0&&(l.setUniform4fv("externalColor",G[Math.min(a,G.length-1)]),l.setUniform1i("symbolColorMixMode",oe.replace));const m=n.capacity,u=n.headIndex,d=n.tailIndex,c=n.firstIndex,h=(I,b)=>{le(r,l.locations,n.buffer,I),r.drawArraysInstanced(e.primitiveType,0,s.numVertices,b-I)};s.material.transparent&&c!=null?u>d?(R(c>=d&&c<=u,"invalid firstIndex"),h(c,u),h(d,c)):u<d&&(c<=u?(R(c>=0&&c<=u,"invalid firstIndex"),h(c,u),h(d,m),h(0,c)):(R(c>=d&&c<=m,"invalid firstIndex"),h(c,m),h(0,u),h(d,c))):u>d?h(d,u):u<d&&(h(0,u),h(d,m))}};function V(t,e,n){const s=t.allocateHead();Me(e,n,t.view,s)}function Me(t,e,n,s){ue(t.modelOrigin,e,n.modelOriginHi,n.modelOriginLo,s),n.model.copyFrom(s,t.model,e),n.modelNormal.copyFrom(s,t.modelNormal,e),t.color&&n.color&&n.color.copyFrom(s,t.color,e),t.olidColor&&n.olidColor&&n.olidColor.copyFrom(s,t.olidColor,e),t.featureAttribute&&n.featureAttribute&&n.featureAttribute.copyFrom(s,t.featureAttribute,e)}f([y({constructOnly:!0})],g.prototype,"symbol",void 0),f([y({constructOnly:!0})],g.prototype,"metadata",void 0),f([y({constructOnly:!0})],g.prototype,"shaderTransformation",void 0),f([y()],g.prototype,"_instanceData",void 0),f([y()],g.prototype,"_cycleStartIndex",void 0),f([y({readOnly:!0})],g.prototype,"_enableLevelSelection",null),f([y()],g.prototype,"_updateCyclesWithStaticCamera",void 0),f([y({readOnly:!0})],g.prototype,"readyToRun",null),g=f([ee("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],g);const U=E(),p=Y(),q=j(),H=E(),z=E(),G=[S(1,0,1,1),S(0,0,1,1),S(0,1,0,1),S(1,1,0,1),S(1,0,0,1)],Te=new ie;export{g as F};
