import{l as G,c as ue,a3 as fe,v as Z,Y as O,H,G as ge}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{o as E,j as K,s as ye}from"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import{E as be,a as Q,$ as _e,a0 as N}from"./Polygon-D6wEPb3W-D2MPjRU4.js";import{n as we}from"./mat4f64-q_b6UJoq-Dh6sWB_w.js";import{c as ve}from"./quatf64-CCm9z-pX-CQ7_sSji.js";import{W as xe,h as le,l as Ce,O as Me,A as ee}from"./vec32-CewSdTn3-VRto2OOh.js";import{a as Oe,X as Te,t as M}from"./collectionUtils-jDyktm0P-BDP2Oq99.js";import{e as je}from"./vec4f64-DPb6J-GU-C7c2DqbZ.js";import{z as Pe}from"./Point-BfTTZoMu-DeJwQYfh.js";import{y as Ue}from"./computeTranslationToOriginAndRotation-Bjd4esRf-vJ4LbdOU.js";import{p as He,n as Fe,i as Ee,s as Se}from"./Transform-B98MC8vi-B90xtMIX.js";import{x as Re}from"./projectVectorToVector-Csv3NYZI-DpBtmQMN.js";import{y as Ve}from"./aaBoundingRect-CjwcS2F3-ri8bmh30.js";import{e as te,F as Ae,_ as ke,j as Ie,m as z,A as Be,X as $e,Z as De,q as ie,k as re}from"./BufferView-Cj2sQaht-avJ4OGB_.js";import{r as Le}from"./SceneModification-BvcaWkQk-BdvrXsuH.js";import{w as se}from"./elevationInfoUtils-B8MpdRMP-CDlK86wO.js";import{D as Ge}from"./I3SMeshWorkerHandle-BaFEt1Xl-BDbleven.js";import{u as Ne}from"./LayerView3D-JY0KVfxL-H13gXtj0.js";import{ad as ze,ae as We,af as qe,aa as Je,ag as Xe,ac as Ye,ah as Ze,ai as Ke,aj as Qe,d as et}from"./ShadowCastClear.glsl-CeOT_rAo-BEYyVrmo.js";import{E as oe}from"./enums-B4pqBiXb-BO-3hS_8.js";import{C as tt}from"./intersectorUtilsConversions-pLQPEbcN-Ck-nyNYa.js";import{v as it}from"./HUDIntersectorResult-1xTExS7z-dL9SFL6u.js";import{cv as W,cg as rt,aK as st,o as ot,a$ as at,bF as nt,bG as lt}from"./Texture-CFNZjV2R-CxGjQ8pI.js";import{a as A,d as ct,w as mt}from"./orientedBoundingBox-BLEx7wLU-ByGP9QG1.js";import{d as dt,f as pt}from"./EllipsoidMode-Bujbvu9s-CCgL6L-h.js";import{x as ht}from"./edgePreprocessing-D_eX-fWy-DqE-06Ss.js";import{t as ut}from"./LayerView-BnpxrRF8-Ca-QSx3a.js";import{F as ft,C as gt}from"./layerViewUtils-BTa15X3o-BjQlX2q8.js";import"./Extent-CgDMOSRD-Bod5LY6s.js";import"./mathUtils-PIGhLnI9-B1tKUlUb.js";import"./index-B0z_nLWi.js";import"./mat4-C96X-Nn0-BrMLOLCb.js";import"./projectionUtils-BGH_5_I3-DGwchVO8.js";import"./Polyline-CoiTLswR-DTxpB2Yg.js";import"./sphere-DLQ6p7mp-DyEe1Vll.js";import"./vector-B8ZDYGQ6-DRILJdcx.js";import"./vec2f64-rIxtbMRN-Kai9mK1i.js";import"./vec42-B8VM4vXb-B6OGOEI9.js";import"./resourceExtension-DOTCeiZj-C2WIbjQM.js";import"./unitConversionUtils-4vB4Ezlp-DnY5MDxd.js";import"./lengthUtils-Dt1_RvOO-j3MEdmHu.js";import"./date-IqUzANpt-bLKO9IDT.js";import"./workers-BEkgoq8Q-BM_Hz460.js";import"./intl-DRFqUect-DPhFaHB2.js";import"./typeUtils-DqrRcjBx-DZ6_Gsbu.js";import"./modeUtils-BA-mAwuS-DSb1K26b.js";import"./sanitizerUtils-BT_8V5US-CWQWUwZQ.js";import"./PooledRBush-Dco5QkUp-DX3CMhf3.js";import"./GraphicsCollection-Bk6M0b7D-Dk6KdmO7.js";import"./Graphic-DgGzDmqW-d1CNicxz.js";import"./getPopupProvider-CmskPttI-CzUWpGwk.js";import"./Color-CERqXxxY-BuYn26eI.js";import"./Layer-DZvC7bne-D3VLDrab.js";import"./typeUtils-CXW_VpOn-BGgLp_TK.js";import"./lineMarkers-CDwLe3J6-CNUjJvs3.js";import"./PolygonSymbol3D-BXRHZiCQ-BjPAY2LA.js";import"./ExtrudeSymbol3DLayer-DSc1ou2x-CsVYZCeG.js";import"./aaBoundingBox-Cn49X7ge-BcYPaJ58.js";import"./Font-BwmnW7d2-Dwh3xjKw.js";import"./SimpleFillSymbol-CDawtd9z-CWD2KI2D.js";import"./SimpleMarkerSymbol-BGAFRS9_-CVQ5NLIA.js";import"./PictureMarkerSymbol-CaSh-vZk-xhjZ61bb.js";import"./TextSymbol-hRGhyDHs-CoS7dSjf.js";import"./HeightModelInfo-D5IdRvJ2-23y6MRiu.js";import"./spatialReferenceEllipsoidUtils-D2JabnKt-Ce3ED0lc.js";import"./RealisticTree.glsl-WN9nrQUl-QZiY3aPA.js";import"./Emissions.glsl-B8XKMjLy-DXfiRNVX.js";import"./InterleavedLayout-B7roQAzV-CdGz7mlm.js";import"./MeshLocalVertexSpace-BGd1IdEs-C0HJG4wR.js";import"./vec3f32-WCVSSNPR-9V6Uhrx-.js";import"./Indices-D0_UQPPr-t1Qev6md.js";import"./frustum-CMzahy3--B-DC1Co-.js";import"./TilemapCache-CjhKW_vj-8gKqgQfa.js";import"./LRUCache-fy84PBMi-Y56WPIvD.js";import"./UpdatingHandles-D2RI_3Hb-dwLPjVun.js";import"./asyncUtils-w6KfWU41-HenJ0UOu.js";import"./Map-AEYszeHg-ZEOzAMWa.js";import"./Basemap-CL_uaRmk-O3l-dbYk.js";import"./PortalItem-DnxMlRVo-CI4Ns2_M.js";import"./writeUtils-DEFpwIW1-AHZYPaSV.js";import"./CollectionFlattener-D6h2Fkvj-WVl2BXw-.js";import"./PolygonCollection-HNNpnBH7-5UHgGprq.js";import"./mat4f32-Djp3mnm5-DzYG3LYB.js";import"./Query-BlS0WPDF-jdXS_Qhy.js";import"./Field-Cm_ZejYW-CwJZmSru.js";import"./fieldType-DVUzXtk_-tUuvnZJM.js";import"./normalizeUtils-85zLqeMi-C1bdAKNn.js";import"./normalizeUtilsCommon-CnhQye_A-UWhaH-kt.js";import"./ElevationQuery-DzlYa4L4-DkUTW9Ak.js";import"./TileInfo-Bz7QlefV-CdK7c8ef.js";import"./Scheduler-CNrsbccs-Bcg8fWoS.js";import"./constants-D67WmGms-H7IOwEdB.js";import"./quat-B7J5v7rV-CZ9akUv-.js";import"./floatRGBA-D-Q4FzNN-DQhowfyr.js";import"./UnknownTimeZone-B697BDFv-CBbtul7O.js";import"./TileKey-C44YQC4_-BW7BBbYp.js";import"./vec2f32-CaVKkSa6-BjkBmyoj.js";import"./Octree-DckBBpQ7-CkRPu4UJ.js";import"./axisAngleDegrees-CjbXmycq-DcVVDR1-.js";import"./vec3-B_phcnZY-DHC7I6xa.js";import"./vec33-CWJeyzxV-Me4sF5XB.js";import"./reader-DcGs6kKN-DHJfK-tm.js";import"./SimpleObservable-CvFyr0NA-DXpoMYph.js";import"./projectBoundingSphere-B69Mxmv9-BDEAeDef.js";import"./projectPointToVector-DL7Z4uvb-CPbOlZdQ.js";import"./persistable-CdoDQOTR-BklJqWTn.js";import"./MD5-MtSiOt06-jWr180Yc.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw-DH8sdIsE.js";import"./uuid-Oe6SV2kF-IYX19xBA.js";import"./WorkerHandle-B930SiRy-DglEKt53.js";import"./jsonUtils-CmpazY1u-6pDLj5sx.js";import"./screenUtils-BitdhK1O-L0FLPAMi.js";import"./scaleUtils-yfx9kKWT-D9SVsyM-.js";import"./layerUtils-DZGhvm-W-CfyHx1TZ.js";import"./tagSymbols-BPcGfZon-BPcGfZon.js";import"./Queue-CYlrXMwB-CYJTUII-.js";import"./signal-BX9ezF8a-cf1Pn6io.js";import"./timeZoneUtils-BSc7-7qA-BAv3h8mh.js";import"./ReactiveMap-B0by2bYu-DCsCfMj5.js";import"./TablesMixin-Q80MT3nU-CBB9B-b6.js";import"./plane-BNdSPG2o-DTV5z6SO.js";import"./memoryEstimations-Bd726a_p-0cVCY2Jz.js";import"./VertexElementDescriptor-BlxU8vCE-BwuKQkTU.js";import"./Cyclical-BLSxUpe7-Bj8R2Yk-.js";import"./dehydratedFeatures-Ql-uVzLq-aoK2987s.js";import"./quantizationUtils-Ceq-Uxsu-DjgKK_0s.js";import"./featureConversionUtils-BDA_FXJx-CDxX1Wik.js";import"./OptimizedFeature-CwRGZPwv-Ddclhn0A.js";import"./OptimizedFeatureSet-BR8EEvDc-CgsRgxJh.js";import"./createFeatureId-CVwTD0fV-3fKpJDrk.js";import"./DefaultLoadingContext-DXgBe4GE-Unnb_XgV.js";import"./wosrLoader-CIPfz1Cl-DlmQQkMX.js";import"./Version-BtYZEj58-LyRHDnSJ.js";import"./DoubleArray-DExKNiTh-CvVpHySW.js";import"./config-Dg972SSE-D9DBKeq5.js";import"./GeometryUtils-C354xUs0-BLAznQrw.js";import"./definitions-Dvg4hMIw-CdK2DzFN.js";import"./colorUtils-CeIi7j7j-C2WVx6th.js";import"./capabilities-Bi6C4OG6-CpURufko.js";import"./imageUtils-142g71N8-Wj0XNClb.js";import"./videoUtils-Dwx3AEgj-CduhpDRk.js";import"./quickselect-QQC62dOK-Br2Ahhru.js";import"./meshVertexSpaceUtils-CtG7DPVT-kybwngCt.js";import"./Intersector-DS9YtyQY-DMoYp6i0.js";import"./TileKey-CXWFOqOI-Lra6v-mg.js";import"./loadAll-BCyxerwc-B4Lp8wGC.js";import"./opacityUtils-DuFH0EC9-DWspTgn2.js";import"./utils-CylVuxNi--x86XOjU.js";import"./utils-Dpg4yj1D-CeFz2JVC.js";import"./types-BKo2foNY-DE0QfIFp.js";import"./labelUtils-BtizwBfq-Zegx4520.js";import"./ArcadeExpression-BlIRq-oN-VZkrwLVE.js";import"./TimeOnly-BERR31kg-CQiLyUZi.js";import"./enum-BzLwmiID-CcyIdWlQ.js";import"./FieldsIndex-CimK-TqD--24JoCkp.js";class yt extends et{constructor(t,n,i,c,l,a,m){super(t,0,0,0,n),this.nodesCached=i,this.vboMB=c,this.textureMB=l,this.vboMBCached=a,this.textureMBCached=m}}const bt={Points:null,Lines:null,LineStrip:null,Triangles:oe.TRIANGLES,TriangleStrip:oe.TRIANGLE_STRIP,NotSet:null},ae={Opaque:1,Mask:2,Blend:0},_t={Back:2,Front:1,None:0,NotSet:2},wt={WrapYBit:{s:33071,t:10497},WrapXBit:{s:10497,t:33071},WrapXy:{s:10497,t:10497},None:{s:33071,t:33071},NotSet:{s:33071,t:33071}},vt={U8:1,I8:1,U16:2,I16:2,U32:4,I32:4,F32:4,F64:8,Utf8String:1,NotSet:1};class xt{constructor(t){this.layerView=t,this.type=8,this.slicePlaneEnabled=!1,this.isGround=!0,this.layerViewUid=t.uid}intersect(t,n,i,c,l,a){if(t.options.filteredLayerViewUids.includes(this.layerView.uid))return;const{results:m,tolerance:_}=t,f=t.options.store===2,{componentObjectCollection:u}=this.layerView.view.stage.renderView,d=new at(_,a,t.options.normalRequired),o=nt(i,c,Ct),r=le(M(),c,i),h=Ce(M(),r),b=(C,g,y)=>{if(g>=0){if(n!=null&&!n(i,c,g))return;const w=p=>{const I=new tt(this.layerView.layer.uid);p.set(this.type,I,g,y)};if(this.isGround&&(m.ground.distance==null||g<m.ground.distance)&&w(m.ground),t.options.isFiltered)return;if((m.min.distance==null||g<m.min.distance)&&w(m.min),(m.max.distance==null||g>m.max.distance)&&w(m.max),f){const p=new it(t.ray);w(p),t.results.all.push(p)}}};this.layerView.forEachVisibleTile(C=>{if(!C.boundingVolumeIntersectsRay(i,h))return;const{componentObjects:g}=C;for(const y of g)lt(y.aabbInWorldCoordinates,i,o,0)&&u.intersect(y,i,c,null,d,b)})}}const Ct=M();class Mt{constructor(t,n,i,c,l,a,m){this.handle=t,this.componentObjects=n,this.textures=i,this.cpuMemoryUsage=c,this.vboMemoryUsage=l,this.textureMemoryUsage=a,this.obb=m,this.isVisible=!1,this.usedMemory=this.textureMemoryUsage+this.vboMemoryUsage+this.cpuMemoryUsage;const _=M();m?.getCenter(_),this._obbCenter=_,this._obbRadiusSquared=m?m?.radius**2:0}boundingVolumeIntersectsRay(t,n){if(!this.obb)return!0;const i=le(Ot,this._obbCenter,t),c=ee(i,n);return ee(i,i)-c*c<=this._obbRadiusSquared&&this.obb.intersectRay(t,n)}}const Ot=M();function k(e){return Math.round(e/1048.576)/1e3}let x=class extends Ne(ut){get hasModifications(){return this._modifications&&this._modifications.length>0}constructor(e){super(e),this.type="integrated-mesh-3dtiles",this._compressionTracker=new ze,this._modifications=new Array,this._visibleGeometryChangedSchedulerHandle=null,this._wasmLayerId=-1,this.ignoresMemoryFactor=!1,this._usedMemory=0,this._cacheMemory=0,this.drapeTargetType=1,this._applySSAO=!G("disable-feature:im-ssao"),this._shadeNormals=!!G("enable-feature:im-shading"),this._lyrHandleToObjects=new Map,this._visibleObjects=new Set,this._initialCullFace=new Map,this._suspendedHandle=null,this._dbgFlags=new Set,this._memCache=e.view.resourceController.memoryController.newCache(`IM3DTiles-${this.uid}`,t=>this._deletePerObjectData(t))}initialize(){this._dbgFlags.add(3),this._dbg(2,"Tiles3DLayerView3D initialize() called");const{view:e}=this;if(this._updatingHandles.add(()=>this.layer.modifications,()=>this._loadModifications(),E),!this._canProjectWithoutEngine())throw ft("layer",this.layer.spatialReference.wkid,e.renderSpatialReference?.wkid);const t=We(this).then(n=>{this._wasmLayerId=n,this._intersectionHandler=new xt(this),e.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler),this._updatingHandles.add(()=>this.slicePlaneEnabled,i=>this._slicePlaneEnabledChange(i)),this._updatingHandles.add(()=>this._modifications,()=>this._modificationsChanged(),E),this._updatingHandles.add(()=>this.fullOpacity,()=>this._opacityChange()),this._updatingHandles.add(()=>e.clippingArea,()=>this._clippingAreaChanged(),E),this._elevationProvider=new He({view:e,layerElevationSource:this,intersectionHandler:this._intersectionHandler}),e.elevationProvider.register(1,this._elevationProvider),e.overlayManager.registerDrapeTarget(this),this.addHandles([K(()=>this.layer.elevationInfo,i=>this._elevationInfoChanged(i))]),this._suspendedHandle=K(()=>this.suspended,i=>this._wasm?.setEnabled(this,!i),E)});this.addResolvingPromise(t),this._replacesTerrain&&this.addHandles(ye(()=>this.view.map.ground.opacity,()=>{this._opacityChange()}))}get _replacesTerrain(){return this.layer.replacesTerrain&&!!this.view.map.basemap?.groundLayers.includes(this.layer)}get fullOpacity(){return this._replacesTerrain?this.view.map.ground.opacity:1}get opacity(){return 1}_opacityChange(){const{fullOpacity:e}=this;this.forEachComponentObject(t=>{this._collection.getMaterial(t).objectOpacity=e})}intersect(e,t,n,i){this._intersectionHandler.intersect(e,t,n,i,null,!1)}get ready(){return!0}destroy(){this._dbg(2,"Tiles3DLayerView3D destroy() called"),qe(this),this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null),this._intersectionHandler&&(this.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null),this._elevationProvider&&(this._elevationProvider.notifyObjectsChangedFunctional(e=>this.forEachComponentObject(t=>e(t.obb))),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this.view.overlayManager.unregisterDrapeTarget(this),this._lyrHandleToObjects.forEach(e=>this.freeObject(e)),this._lyrHandleToObjects.clear(),this._initialCullFace.clear(),this._visibleObjects.clear(),this._usedMemory=0,this._cacheMemory=0,this._memCache.destroy(),this._updatingHandles=ue(this._updatingHandles),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}_modificationsChanged(){const e=this.layer.spatialReference,t=Ge(this._layerClippingArea,this._modifications,e);this._wasm?.setMeshModifications(this,t,e.wkid)}_clippingAreaChanged(){const e=this.layer.spatialReference,t=Ve();this._layerClippingArea=Je(this.view.clippingArea,t,e)?t:null,this._modificationsChanged()}_visibleGeometryChanged(){this._visibleGeometryChangedSchedulerHandle??=fe(()=>{this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle=null})}_slicePlaneEnabledChange(e){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=e),this.forEachComponentObject(t=>{const n=this._collection.getMaterial(t);n.commonMaterialParameters.hasSlicePlane=e,n.commonMaterialParameters.cullFace=e?0:this._initialCullFace.get(t)})}_elevationInfoChanged(e){this._wasm?.setLayerOffset(this,se(e))}get _wasm(){return Xe(this.view)}get wasmLayerId(){return this._wasmLayerId}get usedMemory(){return this._usedMemory}get unloadedMemory(){return 0}get cachedMemory(){return this._cacheMemory}get visibleAtCurrentScale(){return gt(this.layer.effectiveScaleRange,this.view.scale)}get performanceInfo(){let e=0,t=0,n=0,i=0,c=0,l=0;return this._lyrHandleToObjects.forEach(a=>{a.isVisible?(e+=a.textureMemoryUsage,t+=a.vboMemoryUsage,c++):(n+=a.textureMemoryUsage,i+=a.vboMemoryUsage,l++)}),new yt(this.usedMemory,c,l,k(t),k(e),k(i),k(n))}_canProjectWithoutEngine(){if(this.view.state.viewingMode===2){const e=this.view.renderSpatialReference?.isWebMercator?3857:this.view.renderSpatialReference?.wkid??-1;if(e!==3857&&e!==32662)return!1}return!0}get _stage(){return this.view.stage}get _collection(){return this._stage.renderView.componentObjectCollection}get elevationProvider(){return this._elevationProvider}get elevationOffset(){return se(this.layer.elevationInfo)}get elevationRange(){const e=this.fullExtent;return e?.zmin&&e?.zmax?new Ye(e.zmin,e.zmax):null}getElevationRange(e){return null}get fullExtent(){return this.layer.fullExtent}forEachComponentObject(e){this._forEachObject(this._lyrHandleToObjects.values(),e)}forEachVisibleTile(e){for(const t of this._visibleObjects)e(t)}forEachVisibleComponentObject(e){this._forEachObject(this._visibleObjects,e)}_forEachObject(e,t){for(const n of e)for(const i of n.componentObjects)t(i)}isUpdating(){const e=this._wasm;return!(this._wasmLayerId<0||e==null)&&(e.isUpdating(this._wasmLayerId)||this._compressionTracker.compressing)}updatingFlagChanged(){this.notifyChange("updating")}async createRenderable(e){const t=e.meshData;if(t.data==null)throw new Error("meshData.data undefined");if(t.desc=JSON.parse(t.desc),t.desc==null)throw new Error("meshData.desc undefined");const n=Oe(t.desc.origin),i=new Array,c=this.view.basemapTerrain.spatialReference;let l,a;if(this.view.viewingMode==="global"){const y=we();Ue(Pe,n,y,c),l=be(Q(),y),a=_e(Q(),l)}else l=N,a=N;const m=Te(n),_=M(),f=jt(t.desc.obb);let u=0,d=0;const o={textureMemoryUsage:0},r=new Array,h=new Map,b=t.desc.prims.length;for(let y=0;y<b;y++){const w=t.desc.prims[y];if(this._dbg(2,JSON.stringify(w)),bt[w.ptype]==null||t.data==null){this._dbg(2,"[Unsupported Feature] Unsupported primitive mode ("+w.ptype+"). Skipping primitive.");continue}const p=t.desc?.materials&&w.materialId!=null?t.desc.materials[w.materialId]:null,I=p!=null?p.lightingModel:"Unlit",{positionView:T,positionAttr:j,normalsView:ce,normalsAttr:B,colorAttr:S,texCoord0Attr:R,indicesView:F}=this.getBufferViews(w,t.data.buffer,l);if(j==null||T==null||F==null)continue;const q=new Ze(S!=null,R?1:0,ce!=null,this._shadeNormals||this._replacesTerrain,this._applySSAO),me=j.data.length/j.size,$=(v,s)=>!v||v.data.length/v.size===me||(this._dbg(3,`${s} !== numPos. Skipping primitive.`),!1);if(!$(R,"numTexcoord")||!$(S,"numColors")||!$(B,"normals"))continue;const J=Ke(q),de=f?.clone()??Tt(j,n);if(l!==N)for(let v=0;v<T.count;v++)T.getVec(v,_),xe(_,_,l),T.setVec(v,_);const P=J.createBuffer(j.data.length);if(W("position",j,null,null,P,0),R!=null){const v=P.getField("uv0",te);rt(R,v,0)}S!=null&&W("color",S,null,null,P,0),B!=null&&W("normalCompressed",B,null,null,P,0);const pe=new Uint32Array([0,F.typedBuffer.length]),he=new Qe({data:P.buffer,count:P.byteLength/J.stride,layoutParameters:q},{positions:T.typedBuffer,indices:F.typedBuffer},F.typedBuffer,pe);u+=T.count+F.count;const X=this.view.renderSpatialReference,D=M(),L=[1,1,1];Fe(m,X,L,c)||this._dbg(3,"Unsupported coordinate system for IM overlay"),Re(m,X,D,c);const V=this._collection.createObject(new Ee(je(D[0],D[1],L[0],L[1]),new Se(m,a),de,he,!1));if(p){const v=s=>{s.baseColor=p.baseColorFactor,s.usePBR=I==="Pbr",s.hasParametersFromSource=!1,s.baseColorTexture=this._getTexture(p.baseColorTex,t,h,o),s.usePBR&&(s.mrrFactors=[p.metallicFactor,p.roughnessFactor,0],s.emissiveBaseColor=p.emissiveFactor??[0,0,0],s.metallicRoughnessTexture=this._getTexture(p.metalTex,t,h,o),s.emissionTexture=this._getTexture(p.emissiveTex,t,h,o),s.occlusionTexture=this._getTexture(p.occlusionTex,t,h,o),s.normalTexture=this._getTexture(p.normalTex,t,h,o)),s.objectOpacity=0,s.alphaDiscardMode=2;const U=[];s.baseColorTexture&&U.push(s.baseColorTexture.loadPromise),s.usePBR&&(s.metallicRoughnessTexture&&U.push(s.metallicRoughnessTexture.loadPromise),s.emissionTexture&&U.push(s.emissionTexture.loadPromise),s.occlusionTexture&&U.push(s.occlusionTexture.loadPromise),s.normalTexture&&U.push(s.normalTexture.loadPromise));const Y=Promise.all(U);i.push(Y),Y.then(()=>{s.alphaDiscardMode=ae[p.alphaMode],s.objectOpacity=this.fullOpacity,o.textureMemoryUsage+=s.baseColorTexture?.glTexture?.usedMemory??0,s.usePBR&&(o.textureMemoryUsage+=(s.metallicRoughnessTexture?.glTexture?.usedMemory??0)+(s.emissionTexture?.glTexture?.usedMemory??0)+(s.occlusionTexture?.glTexture?.usedMemory??0)+(s.normalTexture?.glTexture?.usedMemory??0))}),s.commonMaterialParameters.doubleSided=p.isDoubleSided,s.commonMaterialParameters.cullFace=p.faceCulling?_t[p.faceCulling]:0,this._initialCullFace.set(V,s.commonMaterialParameters.cullFace),s.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,s.componentParameters.castShadows=0,s.textureAlphaCutoff=p.alphaCutoff??ot,s.alphaDiscardMode=ae[p.alphaMode],s.isIntegratedMesh=!0,s.sphereDepthInterpolate=this.layer.hasGoogleUrl,s.polygonOffsetEnabled=!1,s.hasOccludees=!1,s.ellipsoidMode=pt(this.view.spatialReference)};this._collection.updateMaterial(V,v)}r.push(V),d+=this._collection.getObjectGPUMemoryUsage(V)}await Promise.all(i);const C=new Array;h.forEach(y=>{C.push(y)});const g=new Mt(e.handle,r,C,u,d,o.textureMemoryUsage,f);return this._memCache.put(`${g.handle}`,g),this._lyrHandleToObjects.set(e.handle,g),this._cacheMemory+=g.usedMemory,{memUsageBytes:g.usedMemory}}freeRenderable(e){const t=this._lyrHandleToObjects.get(e);t&&(t.isVisible?(this._visibleObjects.delete(t),this._usedMemory-=t.usedMemory):this._cacheMemory-=t.usedMemory,this.freeObject(t),this._lyrHandleToObjects.delete(e))}freeObject(e){this._memCache.pop(`${e.handle}`),e.textures.forEach(t=>this._stage.removeTexture(t)),e.componentObjects.forEach(t=>{this._collection.destroyObject(t),this._initialCullFace.delete(t)})}setRenderableVisibility(e,t,n){for(let i=0;i<n;++i){const c=t[i];if(!c)continue;const l=e[i],a=this._lyrHandleToObjects.get(l);if(a){if(a.isVisible)continue;this._visibleGeometryChanged(),a.isVisible=!0,this._visibleObjects.add(a),this._usedMemory+=a.usedMemory,this._cacheMemory-=a.usedMemory,a.componentObjects.forEach(m=>{this._collection.setObjectVisibility(m,c),this._elevationProvider.notifyObjectChanged(this._collection.getComponentObb(m))}),this._memCache.pop(`${l}`)}}for(let i=0;i<n;++i){const c=e[i],l=t[i];if(l)continue;const a=this._lyrHandleToObjects.get(c);if(a){if(!a.isVisible)continue;this._visibleGeometryChanged(),a.isVisible=!1,this._visibleObjects.delete(a),this._usedMemory-=a.usedMemory,this._cacheMemory+=a.usedMemory,a.componentObjects.forEach(m=>{this._collection.setObjectVisibility(m,l),this._elevationProvider.notifyObjectChanged(this._collection.getComponentObb(m))}),this._memCache.put(`${c}`,a)}}}_getTexture(e,t,n,i){let c=null;if(e&&t.desc?.images&&t.data?.buffer){const l=t.desc.images[e?.imageId];if(c=n.get(l),!c&&l){const a=this._stage.renderView.renderingContext.parameters.maxMaxAnisotropy,m=!!l.mipCount||a>1,_=wt[e.wrapMode??"None"];let f=l.alpha?6408:6407;const u=new Uint8Array(t.data.buffer,l.data.byteOffset,l.data.byteCount);let d=null,o=null,r=null;switch(l.format){case"Raw":l.pixelFormat==="R8"?(d=u,f=6403,o=""):l.pixelFormat==="Rgb8"?(d=u,f=6407,o=""):l.pixelFormat==="Rgba8"&&(d=u,f=6408,o="");break;case"Dxt1":d=u,f=6407,o="image/vnd-ms.dds";break;case"Dxt5":d=u,f=6408,o="image/vnd-ms.dds";break;case"Basis":d=u,f=6407,o="image/ktx2";break;case"Png":o="image/png",r=document.createElement("img");break;case"Jpeg":o="image/jpeg",r=document.createElement("img");break;case"Etc2":o="image/ktx",r=document.createElement("img");break;case"Astc":this._dbg(3,"Astc texture not supported");break;case"Pvrtc":this._dbg(3,"Pvrtc texture not supported")}if(r&&o){const h=new Blob([u],{type:o});r.src=URL.createObjectURL(h),d=r}if(d&&o!=null){const h=G("enable-feature:esri-compress-IM-textures")?{compressionTracker:this._compressionTracker,compressionCallback:b=>{b&&b>0&&(i.textureMemoryUsage-=b)}}:void 0;c=new st(d,{mipmap:m,maxAnisotropy:a,encoding:o,wrap:_,pixelFormat:f,compressionOptions:h,noUnpackFlip:!0,width:l.mip0Width,height:l.mip0Height}),this._stage.addTexture(c),n.set(l,c)}}}return c?new dt(this.view.stage.renderView.textures,c.id):null}getBufferViews(e,t,n){let i,c,l,a,m,_,f,u=null;for(let d=0;d<e.atrbs.length;d++){const o=e.atrbs[d],r=o.view,h=void 0,b=r.byteOffset+r.byteCount,C=r.byteCount/vt[r.type],g=[...Array(C).keys()].map(y=>y);try{switch(o.sem){case"Position":r.ncomp!==3||r.type!=="F32"?this._dbg(3,"[Unsupported Feature] Unsupported view for Position ("+r+")"):(i=new z(t,r.byteOffset,h,b),c=new A(i.typedBuffer,g,3));break;case"Normal":if(r.ncomp!==3||r.type!=="F32")this._dbg(3,"[Unsupported Feature] Unsupported view for Normal ("+r+")");else{const y=new z(t,r.byteOffset,h,b),w=ht(y.typedBuffer,n);m=new De(w.buffer),_=new A(m.typedBuffer,g,2)}break;case"TexCoord":r.ncomp!==2||r.type!=="F32"?this._dbg(3,"[Unsupported Feature] Unsupported view for Texcoord ("+r+")"):a===void 0&&(a=new A(new te(t,r.byteOffset,h,b).typedBuffer,g,2));break;case"Color":r.ncomp===4?(r.type==="F32"&&(u=new Ae(t,r.byteOffset,h,b)),r.type==="U8"&&(u=new ke(t,r.byteOffset,h,b)),r.type==="U16"&&(u=new Ie(t,r.byteOffset,h,b))):r.ncomp===3&&(r.type==="F32"&&(u=new z(t,r.byteOffset,h,b)),r.type==="U8"&&(u=new Be(t,r.byteOffset,h,b)),r.type==="U16"&&(u=new $e(t,r.byteOffset,h,b))),u==null?this._dbg(2,"[Unsupported Feature] Unsupported view for Color ("+r+")"):l=new A(u.typedBuffer,g,r.ncomp);break;case"FeatureIndex":break;default:this._dbg(2,"[Unsupported Feature] Unsupported semantic ("+o.sem+"). Skipping vertex attribute.")}}catch(y){this._dbg(2,"Error Creating buffer ("+y+"). Skipping vertex attribute.")}}if(e.index){const d=e.index.view,o=void 0,r=d.byteOffset+d.byteCount;switch(e.index.view.type){case"U16":f=new re(t,d.byteOffset,o,r);break;case"U32":f=new ie(t,d.byteOffset,o,r);break;default:this._dbg(3,"[Unsupported Feature] index type not supported ("+d.type+").")}}if(f==null&&i!=null){const d=i.count;if(d<65535){const o=new Uint16Array(d);f=new re(o.buffer)}else{const o=new Uint32Array(d);f=new ie(o.buffer)}for(let o=0;o<d;o++)f.set(o,o)}return{positionView:i,positionAttr:c,colorAttr:l,texCoord0Attr:a,indicesView:f,normalsView:m,normalsAttr:_}}_loadModifications(){if(this.removeHandles("modifications"),this.layer.modifications==null)return void(this._modifications=[]);const e=this.layer.modifications;this.addHandles(this._updatingHandles.addOnCollectionChange(()=>e,()=>this._modifications=e.toArray(),E),"modifications")}_deletePerObjectData(e){this._wasm?.onRenderableEvicted(this,e.handle,e.usedMemory),this.freeRenderable(e.handle)}_dbg(e,t){this._dbgFlags.has(e)&&(e===3?Z.getLogger(this).error(t):Z.getLogger(this).warn(t))}};O([H()],x.prototype,"fullOpacity",null),O([H({type:[Le]})],x.prototype,"_modifications",void 0),O([H()],x.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),O([H()],x.prototype,"layer",void 0),O([H({readOnly:!0})],x.prototype,"visibleAtCurrentScale",null),O([H()],x.prototype,"elevationOffset",null),x=O([ge("esri.views.3d.layers.IntegratedMesh3DTilesLayerView3D")],x);const vs=x,ne=M();function Tt(e,t){const n=mt(e);return Me(ne,n.center,t),n.center=ne,n}function jt(e){return e?new ct(e.center,e.halfSize,ve(...e.quaternion)):null}export{vs as default};
