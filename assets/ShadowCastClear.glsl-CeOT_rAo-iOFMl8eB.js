const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/Popup-Dpb_Kw6t-hWl3nhdy.js","assets/index-CTl7hdrJ.js","assets/index-Cv2ko1Ob.css","assets/jsonMap-Bs3hmeCU-Cusd0Fmz.js","assets/reactiveUtils-SO2Ko3sy-BCLX8Jdy.js","assets/getPopupProvider-CmskPttI-C4PqyuPF.js","assets/collectionUtils-jDyktm0P-ArdXNs6F.js","assets/Point-BfTTZoMu-BAT2Wq6O.js","assets/reader-DcGs6kKN-DHJfK-tm.js","assets/Extent-CgDMOSRD-CU1qE5Kr.js","assets/SimpleObservable-CvFyr0NA-DXpoMYph.js","assets/lengthUtils-Dt1_RvOO-bleznLOi.js","assets/date-IqUzANpt-bLKO9IDT.js","assets/Color-CERqXxxY-BuYn26eI.js","assets/mathUtils-PIGhLnI9-B1tKUlUb.js","assets/Layer-DZvC7bne-m1cEC_yw.js","assets/intl-DRFqUect-ClAS7BRt.js","assets/throttle-D_a5zHdu-DIXrv8Hy.js","assets/signal-BX9ezF8a-cf1Pn6io.js","assets/Polygon-D6wEPb3W-CpL9Efjx.js","assets/aaBoundingRect-CjwcS2F3-D7aII9DY.js","assets/modeUtils-BA-mAwuS-UrytRxLw.js","assets/uuid-Oe6SV2kF-IYX19xBA.js","assets/sanitizerUtils-BT_8V5US-CWQWUwZQ.js","assets/substitute-CT75-Q6W-DvMObpj8.js","assets/Graphic-DgGzDmqW-CFzg0c4i.js","assets/jsonUtils-CmpazY1u-ateEpj4Q.js","assets/Polyline-CoiTLswR-BLagWJLS.js","assets/typeUtils-DqrRcjBx-ZWdHcSIJ.js","assets/createFeatureId-CVwTD0fV-3fKpJDrk.js","assets/typeUtils-CXW_VpOn-BoSnXkME.js","assets/lineMarkers-CDwLe3J6-CNUjJvs3.js","assets/PolygonSymbol3D-BXRHZiCQ-Vi0-2Gvc.js","assets/ExtrudeSymbol3DLayer-DSc1ou2x-CsVYZCeG.js","assets/screenUtils-BitdhK1O-L0FLPAMi.js","assets/opacityUtils-DuFH0EC9-DWspTgn2.js","assets/aaBoundingBox-Cn49X7ge-DORLZxoS.js","assets/DoubleArray-DExKNiTh-CvVpHySW.js","assets/mat4f64-q_b6UJoq-Dh6sWB_w.js","assets/Font-BwmnW7d2-D-oIm_Md.js","assets/SimpleFillSymbol-CDawtd9z-CWD2KI2D.js","assets/SimpleMarkerSymbol-BGAFRS9_-CVQ5NLIA.js","assets/PictureMarkerSymbol-CaSh-vZk-BNpExnAb.js","assets/TextSymbol-hRGhyDHs-C0NgASym.js","assets/AttachmentInfo-f2OvCjJR-HodY2X_o.js","assets/featureLayerUtils-FKjLNPl_-DLktjSPx.js","assets/asyncUtils-w6KfWU41-HenJ0UOu.js","assets/Field-Cm_ZejYW-CwJZmSru.js","assets/fieldType-DVUzXtk_-tUuvnZJM.js","assets/featureQueryAll-BfDWA5Wx-ZgjJqs6l.js","assets/Query-BlS0WPDF-BdshFBMz.js","assets/layerUtils-DZGhvm-W-DLw3QMll.js","assets/SimpleRenderer-CEmCWePp-xiwnMlto.js","assets/commonProperties-DbO613LF-DeJ_ZDUB.js","assets/colorRamps-DswZzxkO-BqSFavfl.js","assets/ColorStop-De5gQTjr-C1lw16u9.js","assets/visualVariableUtils-ma4r7Z2K-C4Gu8Tj6.js","assets/jsonUtils-C9q_FK4K-Cuz7ImzI.js","assets/defaults3D-C2hXSee1-DVT6WkAf.js","assets/defaults-BDN9qxeN-CCVK4JpS.js","assets/defaultsJSON-GKolV7NZ-GKolV7NZ.js","assets/UniqueValueRenderer-JPjz9Qvs-C1w5-GWR.js","assets/diffUtils-wTC1YzlE-JuqUWoWa.js","assets/RendererLegendOptions-ByGHYLtx-C9PvCikc.js","assets/styleUtils-DWvicjTN-DYvOM9HS.js","assets/NormalizationBinParametersMixin-BK9wNkI3-BKYeOhDN.js","assets/featureUtils-CMEuv67v-C9H0xYP0.js","assets/utils-BbtW4lHb-DKC09XMb.js","assets/mat4f32-Djp3mnm5-DzYG3LYB.js","assets/mat4-C96X-Nn0-Do6fKsNS.js","assets/timeZoneUtils-BSc7-7qA-BAv3h8mh.js","assets/a11yUtils-B9mR-UhZ-BVFKYm-0.js","assets/utils-Dha_-5-2-eHjlcsVE.js","assets/cimSymbolUtils-DOGwV0lV-DF1x9X12.js","assets/utils-DX2muIr3-DiPfFKSl.js","assets/LRUCache-fy84PBMi-Y56WPIvD.js","assets/typeUtils-DDFS4uuz-Cx8qHFHN.js","assets/ClassBreaksRenderer-BvgdqtTq-DxMHNS7X.js","assets/DictionaryScriptEvaluator-G73uSGpN-Cn2sp0hZ.js","assets/Version-BtYZEj58-LyRHDnSJ.js","assets/FieldsIndex-CimK-TqD-CrSnohIk.js","assets/UnknownTimeZone-B697BDFv-CBbtul7O.js","assets/ArcadeExpression-BlIRq-oN-DGzfhzBj.js","assets/TimeOnly-BERR31kg-PKcKegNB.js","assets/enum-BzLwmiID-CcyIdWlQ.js","assets/heatmapUtils-B-AXnq0l-G7fD8L97.js","assets/vec42-B8VM4vXb-BnA9MysM.js","assets/vec4f64-DPb6J-GU-C7c2DqbZ.js","assets/executeQueryJSON-DgYznOlB-DXG9oqHS.js","assets/utils-CylVuxNi-CqOfmBVG.js","assets/query-DeNEvEsQ-piAD5C2I.js","assets/normalizeUtils-85zLqeMi-DCF9gKvo.js","assets/Cyclical-BLSxUpe7-Bj8R2Yk-.js","assets/normalizeUtilsCommon-CnhQye_A-zWtr51r8.js","assets/utils-Dpg4yj1D-BVnuoMV8.js","assets/pbfQueryUtils-DlZBMNQk-B4EJfzeq.js","assets/pbf-2SIhMekG-LK438LAR.js","assets/memoryEstimations-Bd726a_p-0cVCY2Jz.js","assets/OptimizedFeature-CwRGZPwv-Ddclhn0A.js","assets/OptimizedFeatureSet-BR8EEvDc-CgsRgxJh.js","assets/queryZScale-CRP3Sh_E-0yf18ElE.js","assets/projectionUtils-BGH_5_I3-BySNUA-B.js","assets/FeatureSet-BF7daP96-BqhMUjXs.js","assets/shared-yd-CR64C-r_XSstFM.js","assets/isImageryGraphicOrigin-Ccuhb4eK-DL3hfhS7.js","assets/isImageryTileGraphicOrigin-ZR-gBf9D-D2Wlykhy.js","assets/FeatureLayer-BRWpcy_W-BoHEkHsh.js","assets/MultiOriginJSONSupport-Bd1TKmh_-BHNF5tHX.js","assets/layerContainerType-CSXZNpHb-BIF7XAYP.js","assets/FormTemplate-DuPZvaVv-Bo80W65Y.js","assets/GraphicOrigin-uE6TDXc9-DqbdmNAV.js","assets/isFeatureGraphicOrigin-YA2hudPe-Bk2FjH_E.js","assets/workers-BEkgoq8Q-BNWfkyQs.js","assets/Queue-CYlrXMwB-CYJTUII-.js","assets/editsZScale-D3N5iH_c-CePEFiUi.js","assets/APIKeyMixin--YGbad8e-DJ-JJTX5.js","assets/ArcGISService-SIwch9bz-BD00xz4C.js","assets/BlendLayer-HE_aYHHW-CZa4IAJu.js","assets/jsonUtils-CY6YsQMo-SliJcuqs.js","assets/CustomParametersMixin-Dshqz1Zp-BFC165kX.js","assets/DisplayFilteredLayer-DyjtPayS-DEIdkBF3.js","assets/scaleUtils-yfx9kKWT-BPfZ-Fh2.js","assets/displayFilterUtils-CIXGrQzt-Ck5cgHqb.js","assets/EditBusLayer-rxUbWTiY-BI2sZl38.js","assets/FeatureEffectLayer-BG_KTtPw-CZiOOvL9.js","assets/FeatureEffect-mVCOF1v6-NIKVGK4R.js","assets/FeatureFilter-G4_pWMVe-vo0uU6rO.js","assets/FeatureLayerBase-BUeDgO3U-BWuQV9AM.js","assets/HeightModelInfo-D5IdRvJ2-BK9di2bT.js","assets/OperationalLayer-B6zbJ5nR-sYdHUfAL.js","assets/ElevationInfo-Cw2HaA6E-Br1RWTYu.js","assets/unitConversionUtils-4vB4Ezlp-B0eWR3Ls.js","assets/LayerFloorInfo-CTubHTci-DKf2wu5F.js","assets/multiLayerServiceUtils-CpHWiXA7-B9JDcSQL.js","assets/Relationship-CrANqG2c-DztISWOP.js","assets/serviceCapabilitiesUtils-BV_pcUiO-CjqWUbfp.js","assets/infoFor3D-DhzudQro-CCYgWfsv.js","assets/portalItemUtils-CaPNUJg6-JsqddoLx.js","assets/FeatureReductionLayer-Bhh5MvS_-BFfoYl9g.js","assets/FeatureReductionSelection-Du7o8OIG-DmruV-ou.js","assets/labelingInfo-BYG2hiVF-Dmkr19gA.js","assets/labelUtils-BtizwBfq-Zegx4520.js","assets/jsonUtils-BCGKNxno-Cm1OfGeu.js","assets/MD5-MtSiOt06-jWr180Yc.js","assets/OrderedLayer-DQAUgUTV-CpnQmtbN.js","assets/PortalLayer-CbFNhtZ4-CCXE0v4V.js","assets/PortalItem-DnxMlRVo-Dhq4alsp.js","assets/RefreshableLayer-CBbEkZf--CC_b3xaQ.js","assets/ScaleRangeLayer-DQr2T3Hh-Dh1UYk4i.js","assets/TemporalLayer-D4R0YvXo-CzgQNAIr.js","assets/TimeInfo-D7ssmbZO-CCS1Im5i.js","assets/TrackableLayer-B-086Hm8-Bm00-8pN.js","assets/FeatureTemplate-Bur8tORn-iLlvjnYm.js","assets/FeatureType-CFJlAOcG-Dk8Ixr4n.js","assets/fieldProperties-BoJj55FN-yR5ddqST.js","assets/TitleCreator-BosRD8XX-DSGT-m9r.js","assets/versionUtils-BfuZvWmP-BDnOmw3Z.js","assets/styleUtils-CZJC3pZm-BNE6B1Si.js","assets/popupUtils-D4UavgYz-4fibcgIL.js","assets/streamLayerUtils-DFlbJ4P1-DFlbJ4P1.js","assets/ReactiveMap-B0by2bYu-DCsCfMj5.js","assets/NetworkElement-BXc67_5E-DNTBtQTx.js","assets/symbolUtils-CszXO9gh-TW5N5Ng7.js","assets/mat2df32-Dpt2CT5P-CY1Hu5g0.js","assets/mat2d-DlTglBkI--S7WYOjk.js","assets/layerViewUtils-BTa15X3o-BjQlX2q8.js","assets/Texture-CFNZjV2R-lGBztxVp.js","assets/vec32-CewSdTn3-DHOFKD0R.js","assets/Indices-D0_UQPPr-t1Qev6md.js","assets/BufferView-Cj2sQaht-DuP-iLZg.js","assets/vec2f64-rIxtbMRN-Kai9mK1i.js","assets/sphere-DLQ6p7mp-DmnRpHXV.js","assets/vector-B8ZDYGQ6-B1uNywRb.js","assets/quatf64-CCm9z-pX-CQ7_sSji.js","assets/frustum-CMzahy3--CFytpSYl.js","assets/plane-BNdSPG2o-Cq7jmU6w.js","assets/Emissions.glsl-B8XKMjLy-DXfiRNVX.js","assets/enums-B4pqBiXb-BO-3hS_8.js","assets/orientedBoundingBox-BLEx7wLU-CPBtS4XC.js","assets/quat-B7J5v7rV-i-DOMCm_.js","assets/spatialReferenceEllipsoidUtils-D2JabnKt-Cip58jmo.js","assets/computeTranslationToOriginAndRotation-Bjd4esRf-CXUng2L4.js","assets/InterleavedLayout-B7roQAzV-CC2VYRPC.js","assets/types-BKo2foNY-DE0QfIFp.js","assets/VertexElementDescriptor-BlxU8vCE-BwuKQkTU.js","assets/projectPointToVector-DL7Z4uvb-BbcUuq8O.js","assets/projectVectorToVector-Csv3NYZI-BsIKHfQD.js","assets/HUDIntersectorResult-1xTExS7z-CU1-YQoW.js","assets/videoUtils-Dwx3AEgj-CduhpDRk.js","assets/PooledRBush-Dco5QkUp-DX3CMhf3.js","assets/quickselect-QQC62dOK-Br2Ahhru.js","assets/GraphicsCollection-Bk6M0b7D-ByzFamPI.js","assets/RealisticTree.glsl-WN9nrQUl-CRRcYwOn.js","assets/meshVertexSpaceUtils-CtG7DPVT-V_uCtHpB.js","assets/MeshLocalVertexSpace-BGd1IdEs-DqCdtROz.js","assets/vec3f32-WCVSSNPR-9V6Uhrx-.js","assets/Intersector-DS9YtyQY-CuzM48xl.js","assets/TilemapCache-CjhKW_vj-BYOTuKe8.js","assets/TileKey-CXWFOqOI-CcilLir8.js","assets/tagSymbols-BPcGfZon-BPcGfZon.js","assets/UpdatingHandles-D2RI_3Hb-dwLPjVun.js","assets/Map-AEYszeHg-D2YZkc1e.js","assets/Basemap-CL_uaRmk-ChnHJfg0.js","assets/loadAll-BCyxerwc-DK9uHnLK.js","assets/writeUtils-DEFpwIW1-D44H3UWs.js","assets/CollectionFlattener-D6h2Fkvj-qnUHjb1M.js","assets/persistable-CdoDQOTR-CH9U-JJT.js","assets/multiOriginJSONSupportUtils-C0wm8_Yw-DH8sdIsE.js","assets/resourceExtension-DOTCeiZj-BXiJr75H.js","assets/PolygonCollection-HNNpnBH7-C5NQ6xHr.js","assets/TablesMixin-Q80MT3nU-CFBTh0j7.js","assets/ElevationQuery-DzlYa4L4-BxQXlEAE.js","assets/TileInfo-Bz7QlefV-tjhen9qQ.js","assets/Scheduler-CNrsbccs-Bcg8fWoS.js","assets/constants-D67WmGms-H7IOwEdB.js","assets/floatRGBA-D-Q4FzNN-BzjdY1tU.js","assets/TileKey-C44YQC4_-BW7BBbYp.js","assets/vec2f32-CaVKkSa6-BjkBmyoj.js","assets/dehydratedFeatures-Ql-uVzLq-DehgeO5I.js","assets/quantizationUtils-Ceq-Uxsu-CDK8m1qL.js","assets/featureConversionUtils-BDA_FXJx-CUwkrHf5.js","assets/Octree-DckBBpQ7-BC8mmFdF.js","assets/elevationInfoUtils-B8MpdRMP-CN_w2fPT.js","assets/intersectorUtilsConversions-pLQPEbcN-rV-4Q5_m.js","assets/DefaultLoadingContext-DXgBe4GE-Colk9t6X.js","assets/wosrLoader-CIPfz1Cl-qtGxLmBP.js","assets/axisAngleDegrees-CjbXmycq-LMRXo165.js","assets/edgePreprocessing-D_eX-fWy-CRLN12td.js","assets/config-Dg972SSE-D9DBKeq5.js","assets/GeometryUtils-C354xUs0-CG8X9WjO.js","assets/definitions-Dvg4hMIw-CdK2DzFN.js","assets/WorkerHandle-B930SiRy-b7IwaSpV.js","assets/colorUtils-CeIi7j7j-nwrKvQYb.js","assets/vec3-B_phcnZY-DHC7I6xa.js","assets/vec33-CWJeyzxV-Me4sF5XB.js","assets/capabilities-Bi6C4OG6-CpURufko.js","assets/imageUtils-142g71N8-CjUugWaS.js","assets/geometryServiceUtils-DZErnHX--BymfKu41.js","assets/project-C1P0PqN_-B9wpkoKv.js","assets/TileLayerView3D-DhhIIZW9-CrfD8Tip.js","assets/LayerView3D-JY0KVfxL-ByE1zQWv.js","assets/TiledLayerView3D-kcWAoKG--D4JeXFCA.js","assets/fetchTile-CUA3iC4h-EX3g6Ugv.js","assets/SublayerPopupHighlightHelper3D-9b1PhBzc-BMOAE6ss.js","assets/ImageHighlightHelper3D-dVfxjzIS-CJ8B_gKB.js","assets/floorFilterUtils-DKzVzLpH-C2F2Cy-S.js","assets/sublayerUtils-BEQnBRaB-BKtQCtZt.js","assets/popupUtils-BKHMiD6K-B1dsckbj.js","assets/LayerView-BnpxrRF8-CNZhc0aY.js","assets/RefreshableLayerView-BZ0W4dR0-NbasIvC8.js","assets/ElevationLayerView3D-FO-Wx7i2-CtbvXW0t.js","assets/LercDecoder-DToR6m7T-BLWLZctV.js","assets/BaseDynamicLayerView3D-B5w63uP7-aBW9B75I.js","assets/DynamicLayerView3D-BldSSj8L-o9upDthv.js","assets/SubView3D-BgWeOqxP-DyCgjZAh.js","assets/ImageMaterial.glsl-CrPy6XFt-DT5hEKxs.js","assets/TriangleMaterial-BIKWylXl-CcDbhy8X.js","assets/DefaultLayouts-B8c6Qefj-D-9ZzY5G.js","assets/BuildingSceneLayerView3D-N8_ilxop-CYQp1crD.js","assets/BuildingComponentSublayer-DdDDAszP-Bx9ewdTm.js","assets/capabilities-Cs4k8cuT-Cq70vfK_.js","assets/I3SIndexInfo-B2NvYFjS-O54px-TX.js","assets/I3SLayerDefinitions-BquY6sVj-QHSoIBIq.js","assets/I3SUtil-BtVE6TXz-Cfu4PxXY.js","assets/featurePopupQueryUtils-CnnY2XPA-CIuoWQ_Y.js","assets/I3SBinaryReader-ZmgM2p_h-BnxBvCpV.js","assets/BuildingGroupSublayer-Dd91JVwX-Bx8owZhl.js","assets/WhereClause-BSVqskBz-DANRwfyr.js","assets/I3SMeshView3D-DJG_hEsG-BrgIUdxp.js","assets/Transform-B98MC8vi-BraHUyqG.js","assets/projectBoundingSphere-B69Mxmv9-93ObKDbx.js","assets/I3SOverrides-BAPZnFo2-D2jt7RR1.js","assets/resourceUtils-DWVfTVer-NJXuINUS.js","assets/EllipsoidMode-Bujbvu9s-BjyCTnwm.js","assets/SceneModification-BvcaWkQk-DMsqdzrV.js","assets/ExtentSet-BmZuhn8E-BsM0ovD8.js","assets/optimizedFeatureQueryEngineAdapter-Bma9_B5X-BMDAgToU.js","assets/I3SMeshWorkerHandle-BaFEt1Xl-BadcMrS1.js","assets/SceneLayerWorker-B7YoqKUk-Dptz0gBN.js","assets/attributeUtils-Dc8--CBJ-B-j5BZQ_.js","assets/highlightUtils--bJgM-zK-ChHi1-zr.js","assets/highlightOptionsUtils-Cdm0-Ad8-d1QoXb1P.js","assets/I3SQueryFeatureAdapter-CglvJDWa-C4UAGjDX.js","assets/TemporalSceneLayerView-B-MmOgDo-AG1ksN3O.js","assets/QueryEngine-J0SYKhS8-CFA9lsZ6.js","assets/WhereClauseCache-B0L2SmwV-BYc3WALz.js","assets/FixedIntervalBinParameters-8snYOK8a-BSPWw9c2.js","assets/QueryEngineCapabilities-DJC_YILC-CshvWf3J.js","assets/utils-CUk96PkC-CThUWKre.js","assets/utils-BEeBypEk-DQLTC4jR.js","assets/ClassBreaksDefinition-BGOzyovZ-K0U0wKo_.js","assets/SnappingCandidate-DGkpYqI6-CfPvDre4.js","assets/timeSupport-CL-HYuK--DWa-2gL6.js","assets/utils-DTE-xBiC-uxMmcNif.js","assets/I3SQueryFeatureStore-B0E9P4O6-BlHBuT_b.js","assets/CatalogLayerView3D-DgPCTze8-HTU8cUxs.js","assets/CatalogDynamicGroupLayerView3D-CwMgUc14-7IP7hu5I.js","assets/CatalogFootprintLayerView3D-DBjxrE8v-BdSXQq8N.js","assets/FeatureLayerViewBase3D-Cu9w2__V-E3NTPGaF.js","assets/HeatmapDensity.glsl-CJMrIO7J-CdMKNLXb.js","assets/AttributeBinsQuery-DmkXyj6Y-CoR4xwlT.js","assets/FeatureTileDescriptor-n_NQwd9p-Cu6-pgr7.js","assets/dehydratedFeatureComparison-faNSTYzo-C3UzI31T.js","assets/queryForSymbologySnapping-cmldLZWb-DcW_ZFbB.js","assets/Graphics3DFeatureProcessor-BtLaAjI1-CaXfqlkg.js","assets/hash-CcEbRgUF-DpReY683.js","assets/renderingInfoUtils-BivCmbrV-DfARK6_A.js","assets/Graphics3DObjectStates-CA63huOX-fGyri52V.js","assets/AttributeBinsFeatureSet-BtGn1q3D-BzPdjLAd.js","assets/FeatureStore-DSSTHScY-B0QQjb8C.js","assets/BoundsStore-CBAymNAD-BJvinsAr.js","assets/EventedSet-DfgtwAGn-CMNGS81T.js","assets/FeatureIdInfo-iL5WjyEH-DzYZU4u5.js","assets/constants-SxxbBSOD-SxxbBSOD.js","assets/CSVLayerView3D-DtcmkA2e-C-fKLCAh.js","assets/DimensionLayerView3D-BUGs6ZqE-aDBd0XVJ.js","assets/LayerViewAnalysisViewManager-6ffDeA9n-CHrXiGjk.js","assets/FeatureLayerView3D-BxWfZa1A-CCHf0fmT.js","assets/GaussianSplatLayerView3D-CqHGcAWt-Cg78ozXV.js","assets/tiles3DUtils-CDSpqUp9-B2n4-xex.js","assets/GeoJSONLayerView3D-5L11OzQ7-B12YKXAM.js","assets/GraphicsLayerView3D-DoEiLwFO-CGOuYTck.js","assets/GraphicsProcessor-fvs9gGTh-Bqvmkcbn.js","assets/GroupLayerView3D-UsUyJr4_-BpHWhRCI.js","assets/ImageryLayerView3D-wFtfRKpO-DBLWoNGS.js","assets/dataUtils-1NJ_tbX7-DOg3Y4ON.js","assets/FlowSubView3D-C_clwn1W-DBiNQuwj.js","assets/loadUtils-DQnILyqZ--fJrgD4K.js","assets/line-DShd3yGd-Vds7wO8W.js","assets/rasterFieldUtils-0bNK-dHZ-COz_3SPB.js","assets/rasterProjectionHelper-CKWxY3oy-CcS-Q5Ne.js","assets/IntegratedMeshLayerView3D-Cr-lDHcl-BMeD39Nj.js","assets/IntegratedMesh3DTilesLayerView3D-Ef05Po1M-B20cuGtC.js","assets/LineOfSightLayerView3D-BCb4bshS-9_Lnt5tA.js","assets/MapImageLayerView3D-BwlyxS_1-COJ2CYxU.js","assets/ExportImageParameters-O9hPdhyJ-DU8D07mU.js","assets/MediaLayerView3D-1XR1oxgL-jMppTVfv.js","assets/MediaElementView-B9N_b_bU-B7MtHM4f.js","assets/normalizeUtilsSync-DqNvil4L-CeJdnwwK.js","assets/mat2df64-DFLy2zOC-BU6AmJok.js","assets/EditGeometryOperations-DZvKpTU8-cI99RYYJ.js","assets/geometry2dUtils-B4vDf2wH-D5Eyn-ve.js","assets/rotate-CKztRS_J-BP1oc49D.js","assets/curveOperationUtils-BGqPT1bh-COCfpJm1.js","assets/SnappingManagerPool-DdmH-hls-BuYjMLac.js","assets/allLayerSnapping-DASGx2Wx-Bt7bxtdA.js","assets/euclideanLengthMeasurementUtils-CpHh36Dt-B3Q3Npaw.js","assets/geodeticLengthOperator-ysQZ6ofQ-CX26XL0i.js","assets/geodeticCurveType-CirnHLSB-CirnHLSB.js","assets/automaticAreaMeasurementUtils-L66brXzH-PvNPZ2Ew.js","assets/geodesicAreaMeasurementUtils-DMf2sF8v-BTVCK7aY.js","assets/earcut-D9gy186--DqxOpTir.js","assets/automaticLengthMeasurementUtils-O6uwtXFm-C_BY4_yv.js","assets/OGCFeatureLayerView3D-BG2ABTWS-DiMzq5lK.js","assets/PointCloudLayerView3D-C0RrrH-R-BVZTmoGh.js","assets/PointCloudWorkerUtil-NeuLSYI--FnH795vk.js","assets/PointCloudUniqueValueRenderer-7tgHeRs5-HegVVIn7.js","assets/PopupSceneLayerView-BZIYKvNy-DOChyh6X.js","assets/ViewshedLayerView3D-Y4yo4dOY-BGc7rvPA.js","assets/VoxelLayerView3D-akNAZreO-Ds3bQB_n.js","assets/VoxelGraphic-BRZHiNJ5-CzAv7amP.js","assets/RouteLayerView3D-DxmsZ1zT-BQVYzBIm.js","assets/Stop-m0VmG4Od-tH09j72j.js","assets/networkEnums-DcxQ-KKD-B7fWvtQx.js","assets/SceneLayerView3D-oBc0YUM_-DStf1waQ.js","assets/SceneLayerView-BQyQEBRT-BVesr5sJ.js","assets/SceneLayerGraphicsView3D-Cg_VcFAo-Bl2mSj0E.js","assets/StreamLayerView3D-Glutgj0u-KxV7m_md.js","assets/StreamFeatureManager-DS8maxEM-BXarN2IM.js","assets/createConnection-qpkJl2Gf-Bk84wmnb.js","assets/ImageryTileLayerView3D-BdxCmzk8-DGHnSpjz.js","assets/datasetUtils-DdDUWBI2-CH5OCkUx.js","assets/VectorTileLayerView3D-eERbBVJy-Bz1hY_KC.js","assets/Rect-BAnET0xx--LefF6x-.js","assets/rasterizingUtils-CnBgARH0-BdMfGptJ.js","assets/StyleRepository-DpniiW2t-DZ-qoSQW.js","assets/WFSLayerView3D-Gy9kXxeH-Bf80h1yZ.js","assets/WMSLayerView3D-Dt5uSI5I-d-UNgMCW.js","assets/ExportWMSImageParameters-DXoETD5V-BRfosHZ1.js","assets/WMTSLayerView3D-cg7HqkZ7-CcZeFkpg.js","assets/AreaMeasurementAnalysisView3D-CTDRr2is-3NwnTwTE.js","assets/getDefaultUnitForView-BIGim07z-C-_fairS.js","assets/AnalysisView3D-zhHEgrUR-DZ8OICjY.js","assets/measurementUtils-C1dpMJBr-D459YuOv.js","assets/ShadedColorMaterial.glsl-Cdsx30m0-VRbWQZDd.js","assets/VisualElement-By4iq8p4-ZBataKFH.js","assets/ColorMaterial.glsl-rhi0cQVb-BUmbct5I.js","assets/quantityFormatUtils-WvkXaau6-BqnfKmyX.js","assets/Segment-DyJXA5Sk-cifKzJu0.js","assets/TextOverlayItem-OzxvglQU-BNRRgu9H.js","assets/lineStippleUtils-CCavR4OV-DESXkwZW.js","assets/SnappingVisualizer3D-BUM9kaD3-BdMhfnf4.js","assets/ExtendedLineVisualElement-B_Ze482f-D1G6-LVV.js","assets/EngineVisualElement-DP9Jiq6V-BhC9DiP0.js","assets/LaserlinePath.glsl-DfE4imRj-B0vl76WV.js","assets/PointVisualElement-pF4jjqm_-_bLXT2e5.js","assets/SnappingContext-CApcAey_-Kve-1Boq.js","assets/PointSnappingHint-w5twIXP5-ULx8JUZp.js","assets/dragEventPipeline3D-DqqdeG4y-BLCkBDmN.js","assets/InteractiveToolBase-DXh7kfgV-R_Z6wqPu.js","assets/ToolIntersector-BVL3bGrn-Vo_uVU8o.js","assets/analysisViewUtils-Z_Z4rbWk-DilCDlu1.js","assets/SnappingDragPipelineStep-Uh4sAWwf-B8z4_n_a.js","assets/SnappingOperation-ClIdnPwp-BbaP0Atw.js","assets/DimensionAnalysisView3D-BOeost4V-CmXaDhD5.js","assets/LengthDimension-B4lz3ld0-C7bgQA1m.js","assets/Factory-CBIg5Skh-B50LJt1_.js","assets/VerticesVisualElement-_ApBW3px-D82ufz7m.js","assets/LineMarker.glsl-CTKL3oPN-CG-nglIF.js","assets/DirectLineMeasurementAnalysisView3D-DMU2hgOq-DFNimEOg.js","assets/ElevationProfileAnalysisView3D-DL54O_5q-Bhw1t0u-.js","assets/settings-CtLiSuVx-Dwe01oqt.js","assets/OutlineVisualElement-D-YFBknk-D6MK02_Z.js","assets/line-CgFvXjo5-DqgBHZMR.js","assets/triangulationUtils-D34y65Gu-uORqNaLm.js","assets/deduplicate-Lzwo1kX7-CSf-1ZcR.js","assets/createUtils-ScyvvYX6-NA68pXeg.js","assets/distanceOperator-DGmm_87g-DnhsW2Ef.js","assets/Point2D-CMz7woHH-BVbGGL7p.js","assets/Distance2DCalculator-CXhBP-8I-BMMI87Nn--mnz8rUK.js","assets/ProjectionTransformation-PJc9H7Gq-Rbz84pUM.js","assets/Envelope2D-mFnl8dXR-MYac-bfa.js","assets/Transformation2D-CrydmBdC-D4jE8w-_.js","assets/SimpleGeometryCursor-B92kdZ15-B1Z6elF7.js","assets/OperatorDefinitions-DP7_WWTp-DP7_WWTp.js","assets/apiConverter-BAgvri9D-CJVft-_U.js","assets/jsonConverter-DmBmaSz7-DAl7KiR-.js","assets/simplifyOperator-bRe3zzdW-Ci0cJetU.js","assets/operatorSimplify-5A_MmN4K-aDmNvEee.js","assets/GraphicsLayer-CZ0Xqeb2-BpD6EhPB.js","assets/SketchViewModel-DKGDyAz7--IntltwL.js","assets/SketchOptions-Dguq2sp8-DmrYxGLA.js","assets/LineOfSightAnalysisView3D-Dvtqyw5y-Dhjtpi3u.js","assets/featureReferenceUtils-CSsVlhur-5L05HRrv.js","assets/LineOfSightAnalysisTarget-BF1yUkY_-nYjUOomi.js","assets/IViewEvents-BGasus0A-Da_9DG23.js","assets/SliceAnalysisView3D-DgDeGnnd-0fWg2d3H.js","assets/SlicePlaneMaterial.glsl-Bk_6X0A4-DG6-BzL8.js","assets/sliceToolConfig-BnawSSVt-BPWko_GQ.js","assets/RotateManipulator-D6-3UwxH-BhG5xrAM.js","assets/ViewshedAnalysisView3D-DIPvknvR-DaYSuxNB.js","assets/Viewshed-DfPsAopA-1zUwfQym.js","assets/MoveManipulation-BXYicJ8k-EJS8oaGo.js","assets/VolumeMeasurementAnalysisView3D-Dz4lZMha-A3JC4I9F.js","assets/Graphics3DExtrudeSymbolLayer-zvNu2dVq-k9iWdLuG.js","assets/SketchTooltipInfo-BNoFeSMr-92WKQOPa.js","assets/MeshTransform-Bl0zl104-DPLjEW5o.js","assets/angularMeasurementUtils-CP9gTlx0-Cmcd-Fla.js","assets/TooltipInfoWithCoordinates-CbHxsk06-Bop9nq2q.js","assets/VoxelWasmPerSceneView-CLy8E53P-iIWohSvU.js","assets/Graphics3DSymbolLayerFactory-C1ySNcVb-CLmGExA7.js","assets/CIMSymbolHelper-CD2S7jie-Bc00obB6.js","assets/BidiEngine-BvER9tXK-EFuB0NWZ.js","assets/labelPoint-4nqVL63d-Dz1LbGNv.js","assets/MeshComponent-Ccgxjntc-CO8Xga6n.js","assets/meshProperties-DWLWd_LJ-DdGPdsWo.js","assets/vertexSpaceConversion-DwAXLcxI-Cu_SOyoj.js","assets/vec4-B7mYuNMQ-ChTBJPnP.js","assets/projectMeshVertexPositions-CRpCilk_-Cw83mAbh.js","assets/objectResourceUtils-WT8hgQE0-C6f2rG2i.js","assets/devEnvironmentUtils-8WtPGj6h-8bFtASy7.js","assets/indexUtils-DpmEYOW0-Be5tCvPq.js","assets/webStyleSymbolUtils-BPZtEnNN-RjfXjq8Q.js","assets/LodRenderer-Be2-9DZO-CzdrBODx.js","assets/loader-CvLhmqYC-zMi5AUkS.js","assets/TerrainTileTree3DDebugger-DLG2XTCo-Cu-oK0va.js","assets/TileTreeDebugger-DsAI0NzA-1EaToDU-.js","assets/edgeProcessing-XRp0V_T8-C5tvOlj0.js","assets/bufferLayouts-f-kO2Y2_-BEmDeZBp.js","assets/EdgeView-BleGvDNY-CWq-AQWV.js","assets/EdgeWorkerHandle-BHMdREna-CzLJKLwY.js","assets/workerHelper-gnhZ_iny-Ci8Q9Ppj.js","assets/Lyr3DWasmPerSceneView-C8ajBbu--BrJE_FPC.js","assets/Lyr3DModule-jg8cORhI-CZqL7mwc.js","assets/index-E6-DofOg-CMLF7D_5.js","assets/index-B021OJ1T-C7lU1Y5Y.js","assets/guid-LcV_DAvu-CBh637k4.js","assets/useT9n-CZ94CLEK-DHaYR60Q.js","assets/index-BydpoIod-N2gWdIcW.js","assets/index-DPItRse1-DsqzxNyn.js","assets/dom-B0I8tRvb-D-J9meVE.js","assets/observers-BuKI3rEh-CspdYUm5.js","assets/ref-BDl3YEzd-6NjlSH3D.js","assets/static-DACmO_6Y-BCFYYrE1.js","assets/form-CeAwoRly-DYFh5bxd.js","assets/interactive-CN95A_Z_-DtsL-9xn.js","assets/label-BEGL2zKa-Bp4oLp78.js","assets/useSetFocus-ChPWRCQz-CcoXYshq.js","assets/FeatureTileTree3DDebugger-x3eaKSD9-D-SAT6rW.js","assets/GraphicsView3D-BCaFUj4d-IymUVp7y.js","assets/FocusAreasView-tRUpT6rS-BY6xzyQn.js","assets/operatorDensify-BAougbyn-C4sw96yF.js","assets/FeatureTileTree3D-BvDvMsKe-CUYj04kl.js"])))=>i.map(i=>d[i]);
import{H as k,_ as le}from"./index-CTl7hdrJ.js";import{v as $,k as y2,o as qe,N as Fp,a as Rg,M as x_,j as uu,b as C_,B as ec,t as zs,c as Z,l as Qe,d as tA,e as Dg,f as iA,g as VP,h as Fw,O as rA,I as fe,y as Fa,i as Sn,$ as sA,m as jt,n as fn,p as wv,V as Vw,r as v2,z as ye,U as na,_ as nA,Y as h,H as d,q as ie,s as xi,u as Yo,D as aA,w as js,x as Ar,A as oA,C as Eo,E as lA,F as zP,P as cA,R as zw,L as hA,Q as uA,S as Ui,T as kP,W as dA,X as pA,Z as mA,a0 as b2,G as D,J as fA,a1 as gA,a2 as Og,a3 as BP,a4 as Gl,a5 as Ao,a6 as tc,a7 as ca,a8 as NP,a9 as xv,aa as kw,ab as aa,ac as qd,ad as im,ae as _A,af as yA,ag as Vp,ah as Oe,ai as vA,aj as rm,ak as bA,al as wA,am as xA,an as CA,ao as SA,ap as sm,aq as Ht,ar as TA,as as PA,at as MA,au as RA,av as Yi,aw as jP,ax as pi,ay as nm,az as DA,aA as OA,aB as EA,aC as AA,K as ly,aD as IA}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{u as UP,o as Or,I as cy,p as LA,q as FA,g as HP,z as Us,V as Kt,J as VA,v as zA,a as bi,t as bt,T as Hs,b as hn,O as ei,Z as zp,K as kA,x as qP,e as GP,c as BA,A as NA,d as w2,f as $P,h as us,M as jA,i as x2,j as Er,Q as du,L as gt,C as hy,k as UA,l as kp,D as HA,m as WP,n as ps,U as gs,r as qA,Y as S_,s as Io,w as ZP,y as hr,N as ct,B as ht,E as ai,F as Ge,G as cc,H as T_,P as Bw,R as Pn,S as Xa,W as op,X as Eg,_ as Lo,$ as Nw,a0 as GA,a1 as $A,a2 as WA,a3 as ZA,a4 as QA,a5 as QP,a6 as XA,a7 as jw,a8 as vt,a9 as nr,aa as YA,ab as $h,ac as Qn,ad as pu,ae as Xr,af as C2,ag as Uw,ah as XP,ai as Hw,aj as YP,ak as Cv,al as st,am as Sh,an as KP,ao as JP,ap as KA,aq as qw,ar as ja,as as JA,at as e8,au as Gw,av as t8,aw as i8,ax as r8,ay as ut,az as $i,aA as P_,aB as s8,aC as e4,aD as Wh,aE as n8,aF as Fo,aG as t4,aH as a8,aI as o8,aJ as Cf,aK as l8,aL as i4,aM as c8,aN as r4,aO as s4,aP as M_,aQ as n4,aR as a4,aS as S2,aT as $r,aU as T2,aV as mu,aW as qo,aX as Ft,aY as ne,aZ as h8,a_ as u8,a$ as P2,b0 as d8,b1 as p8,b2 as m8,b3 as o4,b4 as fu,b5 as ic,b6 as f8,b7 as g8,b8 as _8,b9 as l4,ba as c4,bb as Sv,bc as R_,bd as $w,be as y8,bf as M2,bg as h4,bh as R2,bi as D2,bj as v8,bk as b8,bl as qs,bm as w8,bn as uy,bo as x8,bp as u4,bq as O2,br as C8,bs as d4,bt as S8,bu as T8,bv as Ag,bw as P8,bx as M8,by as R8,bz as Tv,bA as D8,bB as O8,bC as E8,bD as A8,bE as I8,bF as L8,bG as F8,bH as V8,bI as z8,bJ as Gd,bK as k8,bL as hc,bM as B8,bN as N8,bO as j8,bP as p4,bQ as m4,bR as f4,bS as Pv,bT as U8,bU as H8,bV as q8,bW as G8,bX as $8,bY as E2,bZ as Mv,b_ as W8,b$ as Sf,c0 as g4,c1 as _4,c2 as Z8,c3 as Q8,c4 as X8,c5 as Y8,c6 as K8,c7 as J8,c8 as e9,c9 as t9,ca as z,cb as i9}from"./Texture-CFNZjV2R-lGBztxVp.js";import{bD as y4,af as _s,bG as r9,bH as s9,bF as v4,bC as Bp,bz as b4,Q as w4,F as Zh,R as rc,$ as n9,b as wt,bB as Ww,ay as Rv,f as At,az as x4,aD as C4,bE as S4,p as a9,a6 as Li,a5 as Yt,bJ as T4,aS as P4,a0 as o9,aA as A2,aB as I2,bI as M4,H as dy,an as Zw,bK as l9,c as c9,ar as h9,aj as u9,b7 as d9,b8 as p9,s as Ua}from"./Point-BfTTZoMu-BAT2Wq6O.js";import{P as Qw}from"./jsonUtils-CmpazY1u-ateEpj4Q.js";import{a as m9}from"./typeUtils-DqrRcjBx-ZWdHcSIJ.js";import{t as w,R as Mt,r as f9,e as ia,M as We,b as D_,X as Mn,a as g9,C as R4,_ as Xw,Y as _9,v as y9,m as v9,Z as b9,i as w9,s as x9,o as C9,y as S9,S as T9}from"./collectionUtils-jDyktm0P-ArdXNs6F.js";import{c as L2,x as P9,h as Yw,u as Kw,K as Np,H as F2,J as Hi,F as M9,Z as R9,j as D9,V as Qh,B as O9}from"./modeUtils-BA-mAwuS-UrytRxLw.js";import{r as E9}from"./SimpleObservable-CvFyr0NA-DXpoMYph.js";import{I as uc,J as gu,t as Ir,j as M,o as Ee,r as lp,l as Ve,i as Ie,q as A9,s as Yr,w as O_,N as D4,v as I9,W as L9}from"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import{h as Xh,g as Va,s as ms,a as si,w as gn,l as Ig,y as O4}from"./screenUtils-BitdhK1O-L0FLPAMi.js";import{a as F9,q as V9}from"./lengthUtils-Dt1_RvOO-bleznLOi.js";import{z as z9}from"./workers-BEkgoq8Q-BNWfkyQs.js";import{C as k9}from"./PooledRBush-Dco5QkUp-DX3CMhf3.js";import{o as B9,i as E4,u as Dv}from"./GraphicsCollection-Bk6M0b7D-ByzFamPI.js";import{z as sr,t as N9,a as A4}from"./Extent-CgDMOSRD-CU1qE5Kr.js";import{r as jp}from"./HeightModelInfo-D5IdRvJ2-BK9di2bT.js";import{b as oa,H as Vo,W as Up,f as th,m as j9,J as I4,C as Jw,F as L4,G as U9,L as H9,Q as q9}from"./projectionUtils-BGH_5_I3-BySNUA-B.js";import{B as G9,n as $9,e as W9}from"./spatialReferenceEllipsoidUtils-D2JabnKt-Cip58jmo.js";import{a as zo,p as Hp,y as Rt,W as Ov,O as F4,i as $l,Z as Ev,T as ex,S as Nh,q as Z9,h as ds,s as Kn,N as V4,u as Lg,H as z4,j as Q9,o as X9,r as tx,d as k4,P as Y9,e as K9,w as J9,L as eI,D as Fg}from"./aaBoundingRect-CjwcS2F3-D7aII9DY.js";import{l as Ha,y as Vg}from"./projectPointToVector-DL7Z4uvb-BbcUuq8O.js";import{a8 as B4,E as py,Q as tI,w as N4,B as iI,v as rI,n as sI,W as nI,ad as aI,ai as ix,aj as oI,c as lI,a0 as cI,a4 as hI,z as E_,G as V2,i as z2,ac as j4,a9 as qp,ak as uI,ah as dI,al as pI,an as mI,F as fI,ae as gI,af as _I,ag as yI,ab as Av,P as rx,aa as U4,am as zg}from"./RealisticTree.glsl-WN9nrQUl-CRRcYwOn.js";import{s as vI,T as bI}from"./scaleUtils-yfx9kKWT-BPfZ-Fh2.js";import{P as sx,I as jh,O as nx,$ as Yh,D as Tf,k as ih,E as ax,K as H4,A as wI,M as Kh,x as xI,S as CI,H as my}from"./layerUtils-DZGhvm-W-DLw3QMll.js";import{u as SI}from"./TilemapCache-CjhKW_vj-BYOTuKe8.js";import{e as TI}from"./tagSymbols-BPcGfZon-BPcGfZon.js";import{r as dc}from"./UpdatingHandles-D2RI_3Hb-dwLPjVun.js";import{k as k2,H as Ya,C as kg}from"./asyncUtils-w6KfWU41-HenJ0UOu.js";import{l as Iv}from"./Queue-CYlrXMwB-CYJTUII-.js";import{n as ar}from"./signal-BX9ezF8a-cf1Pn6io.js";import{L as PI}from"./Map-AEYszeHg-D2YZkc1e.js";import{r as q4}from"./CollectionFlattener-D6h2Fkvj-qnUHjb1M.js";import{X as MI}from"./date-IqUzANpt-bLKO9IDT.js";import{o as RI,d as DI}from"./Layer-DZvC7bne-m1cEC_yw.js";import{p as OI}from"./timeZoneUtils-BSc7-7qA-BAv3h8mh.js";import{l as Lv}from"./ReactiveMap-B0by2bYu-DCsCfMj5.js";import{o as ox}from"./Query-BlS0WPDF-BdshFBMz.js";import{F as wi,B as _u}from"./Color-CERqXxxY-BuYn26eI.js";import{v as EI,s as j,y as rt,i as fy,q as AI,m as De,B as sc,A as qa,S as cp,p as nc,D as Jh,g as II,I as LI,h as FI}from"./mathUtils-PIGhLnI9-B1tKUlUb.js";import{w as am}from"./TablesMixin-Q80MT3nU-CFBTh0j7.js";import{L as xe,$ as de,A as $e,k as te,O as ce,I as q,x as ge,v as Gt,J as Nt,V as lt,l as me,h as ji,c as Go,t as eu,y as Do,f as B2,a as cn,F as ri,z as Wr,B as za,i as N2,W as _n,r as VI,H as zI,b as lx}from"./vec32-CewSdTn3-DHOFKD0R.js";import{D as G4,$ as kI,M as BI}from"./normalizeUtils-85zLqeMi-DCF9gKvo.js";import{t as NI,G as jI,i as UI}from"./ElevationQuery-DzlYa4L4-BxQXlEAE.js";import{p as om,a as lm}from"./TileInfo-Bz7QlefV-tjhen9qQ.js";import{Y as cm,j as cs,x as un,a as hp,M as A_,m as Pf,g as hm,K as Ga,X as $4,y as W4,A as cx,v as HI,P as j2,$ as qI}from"./plane-BNdSPG2o-Cq7jmU6w.js";import{aq as fs,m as GI,aP as $I,aC as WI,aS as U2,aT as up,aU as H2,W as q2,P as Z4,l as Ol,K as Q4,H as X4,b as El,ar as Y4,F as Ki,E as G2,ak as dn,aj as dp,a as Rn,M as Gp,$ as $2,aV as ZI,T as QI,al as K4,e as gy,u as Ko,U as hx,j as Xi,X as XI,Y as ux,V as YI}from"./Polygon-D6wEPb3W-CpL9Efjx.js";import{E as lr,k as ks,z as tu,L as ac,_ as KI,G as J4,h as ko,o as eM,y as JI,Y as pp,a as dx,t as eL,s as Fv,W as yn,g as tL,D as iL,R as tM,P as rL,H as sL}from"./mat4-C96X-Nn0-Do6fKsNS.js";import{n as Le,s as vn,m as iM}from"./mat4f64-q_b6UJoq-Dh6sWB_w.js";import{o as ze,m as mp,r as yu,a as nL,u as aL}from"./vec2f64-rIxtbMRN-Kai9mK1i.js";import{o as oL,r as Is}from"./vec3f32-WCVSSNPR-9V6Uhrx-.js";import{O as yi,C as Et,N as ni,F as lL,S as iu,P as qi,T as Wl,e as rM,E as St,R as Tn,_ as Lr,D as Qr,U as sM,B as Vv,A as rh,I as _y}from"./enums-B4pqBiXb-BO-3hS_8.js";import{d as bn,r as mi,v as Fi,p as fp,E as cL,a as hL}from"./Scheduler-CNrsbccs-Bcg8fWoS.js";import{h as nM,M as uL,U as aM}from"./Indices-D0_UQPPr-t1Qev6md.js";import{p as Ka,n as Bs}from"./InterleavedLayout-B7roQAzV-CC2VYRPC.js";import{p as dL,m as pL,h as px}from"./memoryEstimations-Bd726a_p-0cVCY2Jz.js";import{f as mL,u as Ja,c as fL,h as gL}from"./VertexElementDescriptor-BlxU8vCE-BwuKQkTU.js";import{u as mx}from"./reader-DcGs6kKN-DHJfK-tm.js";import{a as _L}from"./ExtrudeSymbol3DLayer-DSc1ou2x-CsVYZCeG.js";import{x as $o,Y as W2,h as Gi,y as Kr,w as yL,O as gp,C as vL,a as _p,Q as oM,J as bL,G as wL,T as I_,t as L_,b as ru,c as Z2,F as xL,k as CL,j as F_,d as SL,S as TL}from"./sphere-DLQ6p7mp-DmnRpHXV.js";import{q as yp,r as um,m as fx,w as PL}from"./constants-D67WmGms-H7IOwEdB.js";import{M as Q2,u as Bo}from"./Cyclical-BLSxUpe7-Bj8R2Yk-.js";import{r as ML}from"./quat-B7J5v7rV-i-DOMCm_.js";import{t as RL}from"./quatf64-CCm9z-pX-CQ7_sSji.js";import{z as yt,H as DL,G as lM,C as OL,B as EL}from"./vector-B8ZDYGQ6-B1uNywRb.js";import{_ as Zl,S as X2,V as Mf,z as cr,P as Bg,j as AL,G as IL,Z as cM}from"./vec42-B8VM4vXb-BnA9MysM.js";import{m as di,e as Mi,I as hM,T as LL,o as Vt,s as Rf,N as FL}from"./vec4f64-DPb6J-GU-C7c2DqbZ.js";import{s as Y2}from"./Graphic-DgGzDmqW-CFzg0c4i.js";import{o as uM}from"./Polyline-CoiTLswR-BLagWJLS.js";import{y as V_}from"./computeTranslationToOriginAndRotation-Bjd4esRf-CXUng2L4.js";import{h as VL,x as No}from"./projectVectorToVector-Csv3NYZI-BsIKHfQD.js";import{l as eo,u as zL,a as kL,t as dM,f as Gs,L as K2,X as BL,r as J2,D as Ng,B as pM,J as NL,U as jL,y as mM,P as UL,n as fM,h as HL,x as qL,s as GL,z as gx}from"./aaBoundingBox-Cn49X7ge-DORLZxoS.js";import{k as $L,x as yy,X as WL,P as gM,S as ZL,N as QL,V as eb,d as XL,F as YL}from"./frustum-CMzahy3--CFytpSYl.js";import{X as z_}from"./intl-DRFqUect-ClAS7BRt.js";import{l as KL,r as JL,s as eF,e as tF,Z as iF,a as rF}from"./floatRGBA-D-Q4FzNN-BzjdY1tU.js";import{U as _M,A as sF,h as nF}from"./typeUtils-CXW_VpOn-BoSnXkME.js";import{h as aF,e as oF,b as lF}from"./PolygonSymbol3D-BXRHZiCQ-Vi0-2Gvc.js";import{R as cF,P as hF,q as uF,E as Df,C as dF,v as pF,k as _x,O as mF}from"./layerViewUtils-BTa15X3o-BjQlX2q8.js";import{i as yM,u as fF}from"./unitConversionUtils-4vB4Ezlp-B0eWR3Ls.js";import{P as gF,a as Qt,T as vy,b as vM,_ as jg,m as _F,w as yx,N as yF,M as Tc,C as dm}from"./BufferView-Cj2sQaht-DuP-iLZg.js";import{a as Of,V as bM,e as vF}from"./orientedBoundingBox-BLEx7wLU-CPBtS4XC.js";import{r as Pc}from"./vec2f32-CaVKkSa6-BjkBmyoj.js";import{g as bF,l as or,$ as wF,S as vx,N as xF,n as _,u as ha,y as _e,A as Zr,m as X,E as pc,C as Ne,U as by,Q as CF,z as wM,T as SF,R as tb,M as TF,G as xM}from"./Emissions.glsl-B8XKMjLy-DXfiRNVX.js";import{e as PF}from"./dehydratedFeatures-Ql-uVzLq-DehgeO5I.js";import{H as MF}from"./featureConversionUtils-BDA_FXJx-CUwkrHf5.js";import{e as RF}from"./Octree-DckBBpQ7-BC8mmFdF.js";import{w as DF}from"./elevationInfoUtils-B8MpdRMP-CN_w2fPT.js";import{v as CM,o as SM}from"./HUDIntersectorResult-1xTExS7z-CU1-YQoW.js";import{E as OF,B as TM,J as PM}from"./intersectorUtilsConversions-pLQPEbcN-rV-4Q5_m.js";import{f as EF,d as AF,R as IF}from"./LRUCache-fy84PBMi-Y56WPIvD.js";import{y as LF}from"./DefaultLoadingContext-DXgBe4GE-Colk9t6X.js";import{$ as $a,g as FF}from"./wosrLoader-CIPfz1Cl-qtGxLmBP.js";import{g as bx,E as wx,o as VF}from"./axisAngleDegrees-CjbXmycq-LMRXo165.js";import{I as zF,S as vp,y as kF}from"./edgePreprocessing-D_eX-fWy-CRLN12td.js";import{i as zv}from"./DoubleArray-DExKNiTh-CvVpHySW.js";import{s as ib}from"./TileKey-C44YQC4_-BW7BBbYp.js";import{o as kv,e as BF}from"./config-Dg972SSE-D9DBKeq5.js";import{U as NF}from"./GeometryUtils-C354xUs0-CG8X9WjO.js";import{I as jF,H as UF}from"./definitions-Dvg4hMIw-CdK2DzFN.js";import{f as HF}from"./WorkerHandle-B930SiRy-b7IwaSpV.js";import{c as rb}from"./colorUtils-CeIi7j7j-nwrKvQYb.js";import{q as qF}from"./vec3-B_phcnZY-DHC7I6xa.js";import{p as GF}from"./vec33-CWJeyzxV-Me4sF5XB.js";import{i as $F,a as WF}from"./capabilities-Bi6C4OG6-CpURufko.js";import{v as Ef}from"./imageUtils-142g71N8-CjUugWaS.js";import"./videoUtils-Dwx3AEgj-CduhpDRk.js";import"./uuid-Oe6SV2kF-IYX19xBA.js";import"./sanitizerUtils-BT_8V5US-CWQWUwZQ.js";import"./quickselect-QQC62dOK-Br2Ahhru.js";import"./meshVertexSpaceUtils-CtG7DPVT-V_uCtHpB.js";import"./MeshLocalVertexSpace-BGd1IdEs-DqCdtROz.js";import"./Intersector-DS9YtyQY-CuzM48xl.js";import"./TileKey-CXWFOqOI-CcilLir8.js";import"./Basemap-CL_uaRmk-ChnHJfg0.js";import"./loadAll-BCyxerwc-DK9uHnLK.js";import"./PortalItem-DnxMlRVo-Dhq4alsp.js";import"./writeUtils-DEFpwIW1-D44H3UWs.js";import"./opacityUtils-DuFH0EC9-DWspTgn2.js";import"./persistable-CdoDQOTR-CH9U-JJT.js";import"./MD5-MtSiOt06-jWr180Yc.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw-DH8sdIsE.js";import"./resourceExtension-DOTCeiZj-BXiJr75H.js";import"./PolygonCollection-HNNpnBH7-C5NQ6xHr.js";import"./mat4f32-Djp3mnm5-DzYG3LYB.js";import"./Field-Cm_ZejYW-CwJZmSru.js";import"./fieldType-DVUzXtk_-tUuvnZJM.js";import"./normalizeUtilsCommon-CnhQye_A-zWtr51r8.js";import"./utils-CylVuxNi-CqOfmBVG.js";import"./utils-Dpg4yj1D-BVnuoMV8.js";import"./types-BKo2foNY-DE0QfIFp.js";import"./getPopupProvider-CmskPttI-C4PqyuPF.js";import"./createFeatureId-CVwTD0fV-3fKpJDrk.js";import"./labelUtils-BtizwBfq-Zegx4520.js";import"./ArcadeExpression-BlIRq-oN-DGzfhzBj.js";import"./TimeOnly-BERR31kg-PKcKegNB.js";import"./enum-BzLwmiID-CcyIdWlQ.js";import"./UnknownTimeZone-B697BDFv-CBbtul7O.js";import"./FieldsIndex-CimK-TqD-CrSnohIk.js";import"./lineMarkers-CDwLe3J6-CNUjJvs3.js";import"./SimpleFillSymbol-CDawtd9z-CWD2KI2D.js";import"./SimpleMarkerSymbol-BGAFRS9_-CVQ5NLIA.js";import"./PictureMarkerSymbol-CaSh-vZk-BNpExnAb.js";import"./TextSymbol-hRGhyDHs-C0NgASym.js";import"./Font-BwmnW7d2-D-oIm_Md.js";import"./quantizationUtils-Ceq-Uxsu-CDK8m1qL.js";import"./OptimizedFeature-CwRGZPwv-Ddclhn0A.js";import"./OptimizedFeatureSet-BR8EEvDc-CgsRgxJh.js";import"./Version-BtYZEj58-LyRHDnSJ.js";const ue=(e,t=ue,i=t.f||(t.f=["assets/Popup-Dpb_Kw6t.js","assets/jsonMap-Bs3hmeCU.js","assets/reactiveUtils-SO2Ko3sy.js","assets/getPopupProvider-CmskPttI.js","assets/collectionUtils-jDyktm0P.js","assets/index-BzxsWNRw.js","assets/index-Cv2ko1Ob.css","assets/Point-BfTTZoMu.js","assets/reader-DcGs6kKN.js","assets/Extent-CgDMOSRD.js","assets/SimpleObservable-CvFyr0NA.js","assets/lengthUtils-Dt1_RvOO.js","assets/date-IqUzANpt.js","assets/Color-CERqXxxY.js","assets/mathUtils-PIGhLnI9.js","assets/Layer-DZvC7bne.js","assets/intl-DRFqUect.js","assets/throttle-D_a5zHdu.js","assets/signal-BX9ezF8a.js","assets/Polygon-D6wEPb3W.js","assets/aaBoundingRect-CjwcS2F3.js","assets/modeUtils-BA-mAwuS.js","assets/uuid-Oe6SV2kF.js","assets/sanitizerUtils-BT_8V5US.js","assets/modeUtils-OCMtRbrJ.css","assets/substitute-CT75-Q6W.js","assets/Graphic-DgGzDmqW.js","assets/jsonUtils-CmpazY1u.js","assets/Polyline-CoiTLswR.js","assets/typeUtils-DqrRcjBx.js","assets/createFeatureId-CVwTD0fV.js","assets/typeUtils-CXW_VpOn.js","assets/lineMarkers-CDwLe3J6.js","assets/PolygonSymbol3D-BXRHZiCQ.js","assets/ExtrudeSymbol3DLayer-DSc1ou2x.js","assets/screenUtils-BitdhK1O.js","assets/opacityUtils-DuFH0EC9.js","assets/aaBoundingBox-Cn49X7ge.js","assets/DoubleArray-DExKNiTh.js","assets/mat4f64-q_b6UJoq.js","assets/Font-BwmnW7d2.js","assets/SimpleFillSymbol-CDawtd9z.js","assets/SimpleMarkerSymbol-BGAFRS9_.js","assets/PictureMarkerSymbol-CaSh-vZk.js","assets/TextSymbol-hRGhyDHs.js","assets/AttachmentInfo-f2OvCjJR.js","assets/featureLayerUtils-FKjLNPl_.js","assets/asyncUtils-w6KfWU41.js","assets/Field-Cm_ZejYW.js","assets/fieldType-DVUzXtk_.js","assets/featureQueryAll-BfDWA5Wx.js","assets/Query-BlS0WPDF.js","assets/layerUtils-DZGhvm-W.js","assets/SimpleRenderer-CEmCWePp.js","assets/commonProperties-DbO613LF.js","assets/colorRamps-DswZzxkO.js","assets/ColorStop-De5gQTjr.js","assets/visualVariableUtils-ma4r7Z2K.js","assets/jsonUtils-C9q_FK4K.js","assets/defaults3D-C2hXSee1.js","assets/defaults-BDN9qxeN.js","assets/defaultsJSON-GKolV7NZ.js","assets/UniqueValueRenderer-JPjz9Qvs.js","assets/diffUtils-wTC1YzlE.js","assets/RendererLegendOptions-ByGHYLtx.js","assets/styleUtils-DWvicjTN.js","assets/NormalizationBinParametersMixin-BK9wNkI3.js","assets/featureUtils-CMEuv67v.js","assets/utils-BbtW4lHb.js","assets/mat4f32-Djp3mnm5.js","assets/mat4-C96X-Nn0.js","assets/timeZoneUtils-BSc7-7qA.js","assets/a11yUtils-B9mR-UhZ.js","assets/utils-Dha_-5-2.js","assets/cimSymbolUtils-DOGwV0lV.js","assets/utils-DX2muIr3.js","assets/LRUCache-fy84PBMi.js","assets/typeUtils-DDFS4uuz.js","assets/ClassBreaksRenderer-BvgdqtTq.js","assets/DictionaryScriptEvaluator-G73uSGpN.js","assets/Version-BtYZEj58.js","assets/FieldsIndex-CimK-TqD.js","assets/UnknownTimeZone-B697BDFv.js","assets/ArcadeExpression-BlIRq-oN.js","assets/TimeOnly-BERR31kg.js","assets/enum-BzLwmiID.js","assets/heatmapUtils-B-AXnq0l.js","assets/vec42-B8VM4vXb.js","assets/vec4f64-DPb6J-GU.js","assets/executeQueryJSON-DgYznOlB.js","assets/utils-CylVuxNi.js","assets/query-DeNEvEsQ.js","assets/normalizeUtils-85zLqeMi.js","assets/Cyclical-BLSxUpe7.js","assets/normalizeUtilsCommon-CnhQye_A.js","assets/utils-Dpg4yj1D.js","assets/pbfQueryUtils-DlZBMNQk.js","assets/pbf-2SIhMekG.js","assets/memoryEstimations-Bd726a_p.js","assets/OptimizedFeature-CwRGZPwv.js","assets/OptimizedFeatureSet-BR8EEvDc.js","assets/queryZScale-CRP3Sh_E.js","assets/projectionUtils-BGH_5_I3.js","assets/FeatureSet-BF7daP96.js","assets/shared-yd-CR64C.js","assets/isImageryGraphicOrigin-Ccuhb4eK.js","assets/isImageryTileGraphicOrigin-ZR-gBf9D.js","assets/FeatureLayer-BRWpcy_W.js","assets/MultiOriginJSONSupport-Bd1TKmh_.js","assets/layerContainerType-CSXZNpHb.js","assets/FormTemplate-DuPZvaVv.js","assets/GraphicOrigin-uE6TDXc9.js","assets/isFeatureGraphicOrigin-YA2hudPe.js","assets/workers-BEkgoq8Q.js","assets/Queue-CYlrXMwB.js","assets/editsZScale-D3N5iH_c.js","assets/APIKeyMixin--YGbad8e.js","assets/ArcGISService-SIwch9bz.js","assets/BlendLayer-HE_aYHHW.js","assets/jsonUtils-CY6YsQMo.js","assets/CustomParametersMixin-Dshqz1Zp.js","assets/DisplayFilteredLayer-DyjtPayS.js","assets/scaleUtils-yfx9kKWT.js","assets/displayFilterUtils-CIXGrQzt.js","assets/EditBusLayer-rxUbWTiY.js","assets/FeatureEffectLayer-BG_KTtPw.js","assets/FeatureEffect-mVCOF1v6.js","assets/FeatureFilter-G4_pWMVe.js","assets/FeatureLayerBase-BUeDgO3U.js","assets/HeightModelInfo-D5IdRvJ2.js","assets/OperationalLayer-B6zbJ5nR.js","assets/ElevationInfo-Cw2HaA6E.js","assets/unitConversionUtils-4vB4Ezlp.js","assets/LayerFloorInfo-CTubHTci.js","assets/multiLayerServiceUtils-CpHWiXA7.js","assets/Relationship-CrANqG2c.js","assets/serviceCapabilitiesUtils-BV_pcUiO.js","assets/infoFor3D-DhzudQro.js","assets/portalItemUtils-CaPNUJg6.js","assets/FeatureReductionLayer-Bhh5MvS_.js","assets/FeatureReductionSelection-Du7o8OIG.js","assets/labelingInfo-BYG2hiVF.js","assets/labelUtils-BtizwBfq.js","assets/jsonUtils-BCGKNxno.js","assets/MD5-MtSiOt06.js","assets/OrderedLayer-DQAUgUTV.js","assets/PortalLayer-CbFNhtZ4.js","assets/PortalItem-DnxMlRVo.js","assets/RefreshableLayer-CBbEkZf-.js","assets/ScaleRangeLayer-DQr2T3Hh.js","assets/TemporalLayer-D4R0YvXo.js","assets/TimeInfo-D7ssmbZO.js","assets/TrackableLayer-B-086Hm8.js","assets/FeatureTemplate-Bur8tORn.js","assets/FeatureType-CFJlAOcG.js","assets/fieldProperties-BoJj55FN.js","assets/TitleCreator-BosRD8XX.js","assets/versionUtils-BfuZvWmP.js","assets/styleUtils-CZJC3pZm.js","assets/popupUtils-D4UavgYz.js","assets/streamLayerUtils-DFlbJ4P1.js","assets/ReactiveMap-B0by2bYu.js","assets/NetworkElement-BXc67_5E.js","assets/symbolUtils-CszXO9gh.js","assets/mat2df32-Dpt2CT5P.js","assets/mat2d-DlTglBkI.js","assets/layerViewUtils-BTa15X3o.js","assets/geometryServiceUtils-DZErnHX-.js","assets/project-C1P0PqN_.js","assets/TileLayerView3D-DhhIIZW9.js","assets/LayerView3D-JY0KVfxL.js","assets/TiledLayerView3D-kcWAoKG-.js","assets/fetchTile-CUA3iC4h.js","assets/SublayerPopupHighlightHelper3D-9b1PhBzc.js","assets/ImageHighlightHelper3D-dVfxjzIS.js","assets/GraphicsCollection-Bk6M0b7D.js","assets/floorFilterUtils-DKzVzLpH.js","assets/sublayerUtils-BEQnBRaB.js","assets/popupUtils-BKHMiD6K.js","assets/LayerView-BnpxrRF8.js","assets/UpdatingHandles-D2RI_3Hb.js","assets/RefreshableLayerView-BZ0W4dR0.js","assets/Texture-CFNZjV2R.js","assets/vec32-CewSdTn3.js","assets/Indices-D0_UQPPr.js","assets/BufferView-Cj2sQaht.js","assets/vec2f64-rIxtbMRN.js","assets/sphere-DLQ6p7mp.js","assets/vector-B8ZDYGQ6.js","assets/quatf64-CCm9z-pX.js","assets/frustum-CMzahy3-.js","assets/plane-BNdSPG2o.js","assets/Emissions.glsl-B8XKMjLy.js","assets/enums-B4pqBiXb.js","assets/orientedBoundingBox-BLEx7wLU.js","assets/quat-B7J5v7rV.js","assets/spatialReferenceEllipsoidUtils-D2JabnKt.js","assets/computeTranslationToOriginAndRotation-Bjd4esRf.js","assets/InterleavedLayout-B7roQAzV.js","assets/types-BKo2foNY.js","assets/VertexElementDescriptor-BlxU8vCE.js","assets/projectPointToVector-DL7Z4uvb.js","assets/projectVectorToVector-Csv3NYZI.js","assets/HUDIntersectorResult-1xTExS7z.js","assets/videoUtils-Dwx3AEgj.js","assets/PooledRBush-Dco5QkUp.js","assets/quickselect-QQC62dOK.js","assets/RealisticTree.glsl-WN9nrQUl.js","assets/meshVertexSpaceUtils-CtG7DPVT.js","assets/MeshLocalVertexSpace-BGd1IdEs.js","assets/vec3f32-WCVSSNPR.js","assets/Intersector-DS9YtyQY.js","assets/TilemapCache-CjhKW_vj.js","assets/TileKey-CXWFOqOI.js","assets/tagSymbols-BPcGfZon.js","assets/Map-AEYszeHg.js","assets/Basemap-CL_uaRmk.js","assets/loadAll-BCyxerwc.js","assets/writeUtils-DEFpwIW1.js","assets/CollectionFlattener-D6h2Fkvj.js","assets/persistable-CdoDQOTR.js","assets/multiOriginJSONSupportUtils-C0wm8_Yw.js","assets/resourceExtension-DOTCeiZj.js","assets/PolygonCollection-HNNpnBH7.js","assets/TablesMixin-Q80MT3nU.js","assets/ElevationQuery-DzlYa4L4.js","assets/TileInfo-Bz7QlefV.js","assets/Scheduler-CNrsbccs.js","assets/constants-D67WmGms.js","assets/floatRGBA-D-Q4FzNN.js","assets/TileKey-C44YQC4_.js","assets/vec2f32-CaVKkSa6.js","assets/dehydratedFeatures-Ql-uVzLq.js","assets/quantizationUtils-Ceq-Uxsu.js","assets/featureConversionUtils-BDA_FXJx.js","assets/Octree-DckBBpQ7.js","assets/elevationInfoUtils-B8MpdRMP.js","assets/intersectorUtilsConversions-pLQPEbcN.js","assets/DefaultLoadingContext-DXgBe4GE.js","assets/wosrLoader-CIPfz1Cl.js","assets/axisAngleDegrees-CjbXmycq.js","assets/edgePreprocessing-D_eX-fWy.js","assets/config-Dg972SSE.js","assets/GeometryUtils-C354xUs0.js","assets/definitions-Dvg4hMIw.js","assets/WorkerHandle-B930SiRy.js","assets/colorUtils-CeIi7j7j.js","assets/vec3-B_phcnZY.js","assets/vec33-CWJeyzxV.js","assets/capabilities-Bi6C4OG6.js","assets/imageUtils-142g71N8.js","assets/ElevationLayerView3D-FO-Wx7i2.js","assets/LercDecoder-DToR6m7T.js","assets/BaseDynamicLayerView3D-B5w63uP7.js","assets/DynamicLayerView3D-BldSSj8L.js","assets/SubView3D-BgWeOqxP.js","assets/ImageMaterial.glsl-CrPy6XFt.js","assets/TriangleMaterial-BIKWylXl.js","assets/DefaultLayouts-B8c6Qefj.js","assets/BuildingSceneLayerView3D-N8_ilxop.js","assets/BuildingComponentSublayer-DdDDAszP.js","assets/capabilities-Cs4k8cuT.js","assets/I3SIndexInfo-B2NvYFjS.js","assets/I3SLayerDefinitions-BquY6sVj.js","assets/I3SUtil-BtVE6TXz.js","assets/featurePopupQueryUtils-CnnY2XPA.js","assets/I3SBinaryReader-ZmgM2p_h.js","assets/BuildingGroupSublayer-Dd91JVwX.js","assets/WhereClause-BSVqskBz.js","assets/I3SMeshView3D-DJG_hEsG.js","assets/Transform-B98MC8vi.js","assets/projectBoundingSphere-B69Mxmv9.js","assets/I3SOverrides-BAPZnFo2.js","assets/resourceUtils-DWVfTVer.js","assets/EllipsoidMode-Bujbvu9s.js","assets/SceneModification-BvcaWkQk.js","assets/ExtentSet-BmZuhn8E.js","assets/optimizedFeatureQueryEngineAdapter-Bma9_B5X.js","assets/I3SMeshWorkerHandle-BaFEt1Xl.js","assets/SceneLayerWorker-B7YoqKUk.js","assets/attributeUtils-Dc8--CBJ.js","assets/highlightUtils--bJgM-zK.js","assets/highlightOptionsUtils-Cdm0-Ad8.js","assets/I3SQueryFeatureAdapter-CglvJDWa.js","assets/TemporalSceneLayerView-B-MmOgDo.js","assets/QueryEngine-J0SYKhS8.js","assets/WhereClauseCache-B0L2SmwV.js","assets/FixedIntervalBinParameters-8snYOK8a.js","assets/QueryEngineCapabilities-DJC_YILC.js","assets/utils-CUk96PkC.js","assets/utils-BEeBypEk.js","assets/ClassBreaksDefinition-BGOzyovZ.js","assets/SnappingCandidate-DGkpYqI6.js","assets/timeSupport-CL-HYuK-.js","assets/utils-DTE-xBiC.js","assets/I3SQueryFeatureStore-B0E9P4O6.js","assets/CatalogLayerView3D-DgPCTze8.js","assets/CatalogDynamicGroupLayerView3D-CwMgUc14.js","assets/CatalogFootprintLayerView3D-DBjxrE8v.js","assets/FeatureLayerViewBase3D-Cu9w2__V.js","assets/HeatmapDensity.glsl-CJMrIO7J.js","assets/AttributeBinsQuery-DmkXyj6Y.js","assets/FeatureTileDescriptor-n_NQwd9p.js","assets/dehydratedFeatureComparison-faNSTYzo.js","assets/queryForSymbologySnapping-cmldLZWb.js","assets/Graphics3DFeatureProcessor-BtLaAjI1.js","assets/hash-CcEbRgUF.js","assets/renderingInfoUtils-BivCmbrV.js","assets/Graphics3DObjectStates-CA63huOX.js","assets/AttributeBinsFeatureSet-BtGn1q3D.js","assets/FeatureStore-DSSTHScY.js","assets/BoundsStore-CBAymNAD.js","assets/EventedSet-DfgtwAGn.js","assets/FeatureIdInfo-iL5WjyEH.js","assets/constants-SxxbBSOD.js","assets/CSVLayerView3D-DtcmkA2e.js","assets/DimensionLayerView3D-BUGs6ZqE.js","assets/LayerViewAnalysisViewManager-6ffDeA9n.js","assets/FeatureLayerView3D-BxWfZa1A.js","assets/GaussianSplatLayerView3D-CqHGcAWt.js","assets/tiles3DUtils-CDSpqUp9.js","assets/GeoJSONLayerView3D-5L11OzQ7.js","assets/GraphicsLayerView3D-DoEiLwFO.js","assets/GraphicsProcessor-fvs9gGTh.js","assets/GroupLayerView3D-UsUyJr4_.js","assets/ImageryLayerView3D-wFtfRKpO.js","assets/dataUtils-1NJ_tbX7.js","assets/FlowSubView3D-C_clwn1W.js","assets/loadUtils-DQnILyqZ.js","assets/line-DShd3yGd.js","assets/rasterFieldUtils-0bNK-dHZ.js","assets/rasterProjectionHelper-CKWxY3oy.js","assets/IntegratedMeshLayerView3D-Cr-lDHcl.js","assets/IntegratedMesh3DTilesLayerView3D-Ef05Po1M.js","assets/LineOfSightLayerView3D-BCb4bshS.js","assets/MapImageLayerView3D-BwlyxS_1.js","assets/ExportImageParameters-O9hPdhyJ.js","assets/MediaLayerView3D-1XR1oxgL.js","assets/MediaElementView-B9N_b_bU.js","assets/normalizeUtilsSync-DqNvil4L.js","assets/mat2df64-DFLy2zOC.js","assets/EditGeometryOperations-DZvKpTU8.js","assets/geometry2dUtils-B4vDf2wH.js","assets/rotate-CKztRS_J.js","assets/curveOperationUtils-BGqPT1bh.js","assets/SnappingManagerPool-DdmH-hls.js","assets/allLayerSnapping-DASGx2Wx.js","assets/euclideanLengthMeasurementUtils-CpHh36Dt.js","assets/geodeticLengthOperator-ysQZ6ofQ.js","assets/geodeticCurveType-CirnHLSB.js","assets/automaticAreaMeasurementUtils-L66brXzH.js","assets/geodesicAreaMeasurementUtils-DMf2sF8v.js","assets/earcut-D9gy186-.js","assets/automaticLengthMeasurementUtils-O6uwtXFm.js","assets/OGCFeatureLayerView3D-BG2ABTWS.js","assets/PointCloudLayerView3D-C0RrrH-R.js","assets/PointCloudWorkerUtil-NeuLSYI-.js","assets/PointCloudUniqueValueRenderer-7tgHeRs5.js","assets/PopupSceneLayerView-BZIYKvNy.js","assets/ViewshedLayerView3D-Y4yo4dOY.js","assets/VoxelLayerView3D-akNAZreO.js","assets/VoxelGraphic-BRZHiNJ5.js","assets/RouteLayerView3D-DxmsZ1zT.js","assets/Stop-m0VmG4Od.js","assets/networkEnums-DcxQ-KKD.js","assets/SceneLayerView3D-oBc0YUM_.js","assets/SceneLayerView-BQyQEBRT.js","assets/SceneLayerGraphicsView3D-Cg_VcFAo.js","assets/StreamLayerView3D-Glutgj0u.js","assets/StreamFeatureManager-DS8maxEM.js","assets/createConnection-qpkJl2Gf.js","assets/ImageryTileLayerView3D-BdxCmzk8.js","assets/datasetUtils-DdDUWBI2.js","assets/VectorTileLayerView3D-eERbBVJy.js","assets/Rect-BAnET0xx.js","assets/rasterizingUtils-CnBgARH0.js","assets/StyleRepository-DpniiW2t.js","assets/WFSLayerView3D-Gy9kXxeH.js","assets/WMSLayerView3D-Dt5uSI5I.js","assets/ExportWMSImageParameters-DXoETD5V.js","assets/WMTSLayerView3D-cg7HqkZ7.js","assets/AreaMeasurementAnalysisView3D-CTDRr2is.js","assets/getDefaultUnitForView-BIGim07z.js","assets/AnalysisView3D-zhHEgrUR.js","assets/measurementUtils-C1dpMJBr.js","assets/ShadedColorMaterial.glsl-Cdsx30m0.js","assets/VisualElement-By4iq8p4.js","assets/ColorMaterial.glsl-rhi0cQVb.js","assets/quantityFormatUtils-WvkXaau6.js","assets/Segment-DyJXA5Sk.js","assets/TextOverlayItem-OzxvglQU.js","assets/lineStippleUtils-CCavR4OV.js","assets/SnappingVisualizer3D-BUM9kaD3.js","assets/ExtendedLineVisualElement-B_Ze482f.js","assets/EngineVisualElement-DP9Jiq6V.js","assets/LaserlinePath.glsl-DfE4imRj.js","assets/PointVisualElement-pF4jjqm_.js","assets/SnappingContext-CApcAey_.js","assets/PointSnappingHint-w5twIXP5.js","assets/dragEventPipeline3D-DqqdeG4y.js","assets/InteractiveToolBase-DXh7kfgV.js","assets/ToolIntersector-BVL3bGrn.js","assets/analysisViewUtils-Z_Z4rbWk.js","assets/SnappingDragPipelineStep-Uh4sAWwf.js","assets/SnappingOperation-ClIdnPwp.js","assets/DimensionAnalysisView3D-BOeost4V.js","assets/LengthDimension-B4lz3ld0.js","assets/Factory-CBIg5Skh.js","assets/VerticesVisualElement-_ApBW3px.js","assets/LineMarker.glsl-CTKL3oPN.js","assets/DirectLineMeasurementAnalysisView3D-DMU2hgOq.js","assets/ElevationProfileAnalysisView3D-DL54O_5q.js","assets/settings-CtLiSuVx.js","assets/OutlineVisualElement-D-YFBknk.js","assets/line-CgFvXjo5.js","assets/triangulationUtils-D34y65Gu.js","assets/deduplicate-Lzwo1kX7.js","assets/createUtils-ScyvvYX6.js","assets/distanceOperator-DGmm_87g.js","assets/Point2D-CMz7woHH.js","assets/Distance2DCalculator-CXhBP-8I-BMMI87Nn.js","assets/ProjectionTransformation-PJc9H7Gq.js","assets/Envelope2D-mFnl8dXR.js","assets/Transformation2D-CrydmBdC.js","assets/SimpleGeometryCursor-B92kdZ15.js","assets/OperatorDefinitions-DP7_WWTp.js","assets/apiConverter-BAgvri9D.js","assets/jsonConverter-DmBmaSz7.js","assets/simplifyOperator-bRe3zzdW.js","assets/operatorSimplify-5A_MmN4K.js","assets/GraphicsLayer-CZ0Xqeb2.js","assets/SketchViewModel-DKGDyAz7.js","assets/SketchOptions-Dguq2sp8.js","assets/LineOfSightAnalysisView3D-Dvtqyw5y.js","assets/featureReferenceUtils-CSsVlhur.js","assets/LineOfSightAnalysisTarget-BF1yUkY_.js","assets/IViewEvents-BGasus0A.js","assets/SliceAnalysisView3D-DgDeGnnd.js","assets/SlicePlaneMaterial.glsl-Bk_6X0A4.js","assets/sliceToolConfig-BnawSSVt.js","assets/RotateManipulator-D6-3UwxH.js","assets/ViewshedAnalysisView3D-DIPvknvR.js","assets/Viewshed-DfPsAopA.js","assets/MoveManipulation-BXYicJ8k.js","assets/VolumeMeasurementAnalysisView3D-Dz4lZMha.js","assets/Graphics3DExtrudeSymbolLayer-zvNu2dVq.js","assets/SketchTooltipInfo-BNoFeSMr.js","assets/MeshTransform-Bl0zl104.js","assets/angularMeasurementUtils-CP9gTlx0.js","assets/TooltipInfoWithCoordinates-CbHxsk06.js","assets/VoxelWasmPerSceneView-CLy8E53P.js","assets/Graphics3DSymbolLayerFactory-C1ySNcVb.js","assets/CIMSymbolHelper-CD2S7jie.js","assets/BidiEngine-BvER9tXK.js","assets/labelPoint-4nqVL63d.js","assets/MeshComponent-Ccgxjntc.js","assets/meshProperties-DWLWd_LJ.js","assets/vertexSpaceConversion-DwAXLcxI.js","assets/vec4-B7mYuNMQ.js","assets/projectMeshVertexPositions-CRpCilk_.js","assets/objectResourceUtils-WT8hgQE0.js","assets/devEnvironmentUtils-8WtPGj6h.js","assets/indexUtils-DpmEYOW0.js","assets/webStyleSymbolUtils-BPZtEnNN.js","assets/LodRenderer-Be2-9DZO.js","assets/loader-CvLhmqYC.js","assets/TerrainTileTree3DDebugger-DLG2XTCo.js","assets/TileTreeDebugger-DsAI0NzA.js","assets/edgeProcessing-XRp0V_T8.js","assets/bufferLayouts-f-kO2Y2_.js","assets/EdgeView-BleGvDNY.js","assets/EdgeWorkerHandle-BHMdREna.js","assets/workerHelper-gnhZ_iny.js","assets/Lyr3DWasmPerSceneView-C8ajBbu-.js","assets/Lyr3DModule-jg8cORhI.js","assets/index-E6-DofOg.js","assets/index-B021OJ1T.js","assets/guid-LcV_DAvu.js","assets/useT9n-CZ94CLEK.js","assets/index-BydpoIod.js","assets/index-DPItRse1.js","assets/dom-B0I8tRvb.js","assets/observers-BuKI3rEh.js","assets/ref-BDl3YEzd.js","assets/static-DACmO_6Y.js","assets/form-CeAwoRly.js","assets/interactive-CN95A_Z_.js","assets/label-BEGL2zKa.js","assets/useSetFocus-ChPWRCQz.js","assets/FeatureTileTree3DDebugger-x3eaKSD9.js","assets/GraphicsView3D-BCaFUj4d.js","assets/FocusAreasView-tRUpT6rS.js","assets/operatorDensify-BAougbyn.js","assets/FeatureTileTree3D-BvDvMsKe.js"]))=>e.map(r=>i[r]);var Bv;let po=Bv=class extends ca{constructor(e){super(e),this.rotation=0,this.scale=0,this.targetGeometry=null,this.camera=null}castRotation(e){return(e%=360)<0&&(e+=360),e}clone(){return new Bv({rotation:this.rotation,scale:this.scale,targetGeometry:this.targetGeometry!=null?this.targetGeometry.clone():null,camera:this.camera!=null?this.camera.clone():null})}};h([d({type:Number,json:{write:!0,origins:{"web-map":{default:0,write:!0},"web-scene":{write:{overridePolicy:wy}}}}})],po.prototype,"rotation",void 0),h([Ua("rotation")],po.prototype,"castRotation",null),h([d({type:Number,json:{write:!0,origins:{"web-map":{default:0,write:!0},"web-scene":{write:{overridePolicy:wy}}}}})],po.prototype,"scale",void 0),h([d({types:m9,json:{read:Qw,write:!0,origins:{"web-scene":{read:Qw,write:{overridePolicy:wy}}}}})],po.prototype,"targetGeometry",void 0),h([d({type:Xr,json:{write:!0,origins:{"web-scene":{write:{isRequired:!0}}}}})],po.prototype,"camera",void 0),po=Bv=h([D("esri.Viewpoint")],po);const jo=po;function wy(){return{enabled:!this.camera}}let ZF=class{constructor(e){this._observable=new E9,this._set=new Set(e)}get size(){return Yo(this._observable),this._set.size}add(e){const t=this._set.size;return this._set.add(e),this._set.size!==t&&this._observable.notify(),this}clear(){this._set.size>0&&(this._set.clear(),this._observable.notify())}delete(e){const t=this._set.delete(e);return t&&this._observable.notify(),t}entries(){return Yo(this._observable),this._set.entries()}forEach(e,t){Yo(this._observable),this._set.forEach((i,r)=>e.call(t,i,r,this),t)}has(e){return Yo(this._observable),this._set.has(e)}keys(){return Yo(this._observable),this._set.keys()}values(){return Yo(this._observable),this._set.values()}[Symbol.iterator](){return Yo(this._observable),this._set[Symbol.iterator]()}[Symbol.dispose](){this._observable.destroy()}get[Symbol.toStringTag](){return this._set[Symbol.toStringTag]}};function MM(e,t){const i=kw(e),r=kw(t),s=i.store,n=r.store,a=r.metadata;for(const o in a){const l=a[o],c=s.originOf(o),u=n.originOf(o);if(!l.readOnly&&u!==0){if(c!==0){const p=s.get(o),m=n.get(o);p&&m&&m instanceof ie&&p instanceof ie&&p instanceof m.constructor&&MM(p,m);continue}e.set(o,n.get(o))}}}function sb(e,t,i,r){return e!=null&&(rc(t,r)?(Hp(i,e),!0):(kr[0]=e[0],kr[1]=e[1],kr[2]=0,!!oa(kr,t,0,kr,r,0)&&(i[0]=kr[0],i[1]=kr[1],kr[0]=e[2],kr[1]=e[3],kr[2]=0,!!oa(kr,t,0,kr,r,0)&&(i[2]=kr[0],i[3]=kr[1],!0))))}const kr=w();let su=class extends B9{constructor(e){super(e),this.addHandles(this.on("before-add",t=>{t.item!=null&&t.item.parent===this.owner&&($.getLogger(this).warn("Analysis inside the collection must be unique. Not adding this element again."),t.preventDefault())}))}_own(e){e.parent=this.owner}_release(e){e.parent=null}};su=h([D("esri.support.AnalysesCollection")],su);const Af={widthBreakpoint:{getValue(e){const t=e.viewSize[0],i=e.breakpoints,r=this.values;return t<=i.xsmall?r.xsmall:t<=i.small?r.small:t<=i.medium?r.medium:t<=i.large?r.large:r.xlarge},values:{xsmall:"xsmall",small:"small",medium:"medium",large:"large",xlarge:"xlarge"},valueToClassName:{xsmall:"esri-view-width-xsmall esri-view-width-less-than-small esri-view-width-less-than-medium esri-view-width-less-than-large esri-view-width-less-than-xlarge",small:"esri-view-width-small esri-view-width-greater-than-xsmall esri-view-width-less-than-medium esri-view-width-less-than-large esri-view-width-less-than-xlarge",medium:"esri-view-width-medium esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-less-than-large esri-view-width-less-than-xlarge",large:"esri-view-width-large esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-greater-than-medium esri-view-width-less-than-xlarge",xlarge:"esri-view-width-xlarge esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-greater-than-medium esri-view-width-greater-than-large"}},heightBreakpoint:{getValue(e){const t=e.viewSize[1],i=e.breakpoints,r=this.values;return t<=i.xsmall?r.xsmall:t<=i.small?r.small:t<=i.medium?r.medium:t<=i.large?r.large:r.xlarge},values:{xsmall:"xsmall",small:"small",medium:"medium",large:"large",xlarge:"xlarge"},valueToClassName:{xsmall:"esri-view-height-xsmall esri-view-height-less-than-small esri-view-height-less-than-medium esri-view-height-less-than-large esri-view-height-less-than-xlarge",small:"esri-view-height-small esri-view-height-greater-than-xsmall esri-view-height-less-than-medium esri-view-height-less-than-large esri-view-height-less-than-xlarge",medium:"esri-view-height-medium esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-less-than-large esri-view-height-less-than-xlarge",large:"esri-view-height-large esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-greater-than-medium esri-view-height-less-than-xlarge",xlarge:"esri-view-height-xlarge esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-greater-than-medium esri-view-height-greater-than-large"}},orientation:{getValue(e){const t=e.viewSize,i=t[0],r=t[1],s=this.values;return r>=i?s.portrait:s.landscape},values:{portrait:"portrait",landscape:"landscape"},valueToClassName:{portrait:"esri-view-orientation-portrait",landscape:"esri-view-orientation-landscape"}}},xy={xsmall:544,small:768,medium:992,large:1200};function QF(e){const t=e;return t&&t.xsmall<t.small&&t.small<t.medium&&t.medium<t.large}function Cy(e,t){return t?Af[e].valueToClassName[t].split(" "):[]}const XF=e=>{const t=e;let i=class extends t{constructor(...r){super(...r),this.orientation=null,this.widthBreakpoint=null,this.heightBreakpoint=null,this.breakpoints=xy}initialize(){this.addHandles(M(()=>[this.breakpoints,this.size],()=>this._updateClassNames(),Ee))}destroy(){this.destroyed||this._removeActiveClassNames()}set breakpoints(r){if(r!==this._get("breakpoints")){if(!QF(r)){const s=JSON.stringify(xy,null,2);console.warn("provided breakpoints are not valid, using defaults:"+s),r=xy}this._set("breakpoints",{...r})}}_updateClassNames(){if(!this.container)return;const r=im.acquire(),s=im.acquire();let n,a=!1;for(n in Af){const o=this[n],l=Af[n].getValue({viewSize:this.size,breakpoints:this.breakpoints});o!==l&&(a=!0,this[n]=l,Cy(n,o).forEach(c=>s.push(c)),Cy(n,l).forEach(c=>r.push(c)))}a&&(this._applyClassNameChanges(r,s),im.release(r),im.release(s))}_applyClassNameChanges(r,s){const n=this.container;n&&(s.forEach(a=>n.classList.remove(a)),r.forEach(a=>n.classList.add(a)))}_removeActiveClassNames(){const r=this.container;if(!r)return;let s;for(s in Af)Cy(s,this[s]).forEach(n=>r.classList.remove(n))}};return h([d()],i.prototype,"breakpoints",null),h([d()],i.prototype,"orientation",void 0),h([d()],i.prototype,"widthBreakpoint",void 0),h([d()],i.prototype,"heightBreakpoint",void 0),i=h([D("esri.views.BreakpointsOwner")],i),i};let mo=class extends ie{constructor(){super(...arguments),this.items=new Mt,this._watchUpdatingTracking=new dc,this._callbacks=new Map,this._projector=Kw(),this._hiddenProjector=Kw()}get needsRender(){return this.items.length>0}get updating(){return this._watchUpdatingTracking?.updating??!1}initialize(){const e=document.createElement("div");e.className="esri-overlay-surface",this._set("surface",e),this._hiddenSurface=document.createElement("div"),this._hiddenSurface.setAttribute("style","visibility: hidden;"),e.appendChild(this._hiddenSurface),this._watchUpdatingTracking.addOnCollectionChange(()=>this.items,t=>{for(const i of t.added){const r=()=>i.render();this._callbacks.set(i,r),this._projector.append(this.surface,r)}for(const i of t.removed){const r=this._projector.detach(this._callbacks.get(i));this.surface.removeChild(r.domNode),this._callbacks.delete(i)}})}addItem(e){this.items.add(e)}removeItem(e){this.items.remove(e)}destroy(){this.items.removeAll(),this._callbacks.forEach(e=>this._projector.detach(e)),this._callbacks=null,this._projector=null,this._watchUpdatingTracking.destroy()}render(){this._projector.renderNow()}computeBoundingRect(e){const t=this._hiddenSurface,i=this._hiddenProjector;let r;const s=()=>(r=e.render(),r);i.append(t,s),i.renderNow();const n={left:0,top:0,right:0,bottom:0};if(r?.domNode){const a=r.domNode.getBoundingClientRect();n.left=a.left,n.top=a.top,n.right=a.right,n.bottom=a.bottom}for(i.detach(s);t.firstChild;)t.removeChild(t.firstChild);return n}overlaps(e,t){const i=this.computeBoundingRect(e),r=this.computeBoundingRect(t);return Math.max(i.left,r.left)<=Math.min(i.right,r.right)&&Math.max(i.top,r.top)<=Math.min(i.bottom,r.bottom)}get hasVisibleItems(){return this.items.some(e=>e.visible)}async prepare(){await document.fonts.load(this._fontString()).catch(()=>{})}renderCanvas(e,t){const i=!!t?.disableDecorations;if(!this.items.some(s=>s.visible&&!(i&&s.isDecoration)))return;const r=e.getContext("2d");r.save(),r.font=this._fontString(),this.items.forEach(s=>{i&&s.isDecoration||(r.save(),s.renderCanvas(r),r.restore())}),r.restore()}_fontString(){return`10px ${getComputedStyle(this.surface).fontFamily}`}};h([d({readOnly:!0})],mo.prototype,"surface",void 0),h([d({readOnly:!0})],mo.prototype,"items",void 0),h([d({readOnly:!0})],mo.prototype,"needsRender",null),h([d({readOnly:!0})],mo.prototype,"_watchUpdatingTracking",void 0),h([d({readOnly:!0})],mo.prototype,"updating",null),mo=h([D("esri.views.overlay.ViewOverlay")],mo);const xx=mo,Sy=[0,0];function YF(e){const t=(e.ownerDocument||window.document).defaultView,i=e.getBoundingClientRect();return Sy[0]=i.left+(t?.pageXOffset??0),Sy[1]=i.top+(t?.pageYOffset??0),Sy}function Cx(e){e&&(e.textContent="",e.parentNode&&e.parentNode.removeChild(e))}function KF(e){const t=document.createElement("div");return e.appendChild(t),t}const Mc=16,Du=750,JF=512,e6=2,t6=e=>{const t=e;let i=class extends t{constructor(...r){super(...r),this._freqInfo={freq:Mc,time:Du},this._overlayRenderTaskHandle=null,this.aria={},this.height=0,this.messagesCommon=null,this.overlay=null,this.position=null,this.resizing=!1,this.root=null,this.surface=null,this.suspended=!0,this.userContent=null,this.width=0,this.widthBreakpoint=null,this.addHandles([M(()=>this.cursor,s=>{const{surface:n}=this;n&&n.setAttribute("data-cursor",s)}),M(()=>this.navigating,s=>{const{surface:n}=this;n&&n.setAttribute("data-navigating",s.toString())}),M(()=>[this.aria,this.surface],()=>this._updateAria(),{initial:!0})])}initialize(){const r=this;this.addHandles([M(()=>this.ui,(s,n)=>this._handleUIChange(s,n),Ee),r.on("focus",()=>this.notifyChange("focused")),r.on("blur",()=>this.notifyChange("focused"))])}destroy(){this.destroyed||(this.ui?.destroy(),this.container=null)}get container(){return this._get("container")??null}set container(r){const s=this._get("container"),n=L2(r);if(n||typeof r!="string"||$.getLogger(this).error("#container",`element with id '${r}' not found`),s===n)return;if(this._stopMeasuring(),s&&(s.classList.remove("esri-view"),this._overlayRenderTaskHandle&&(this._overlayRenderTaskHandle.remove(),this._overlayRenderTaskHandle=null),this.overlay&&(this.overlay.destroy(),this._set("overlay",null)),this.root&&(Cx(this.root),this._set("root",null)),this.userContent&&(Yw(this.userContent,s),Cx(this.userContent),this._set("userContent",null))),!n)return this._set("width",0),this._set("height",0),this._set("position",null),this._set("suspended",!0),this._set("surface",null),void this._set("container",null);n.classList.add("esri-view");const a=document.createElement("div");a.className="esri-view-user-storage",Yw(n,a),n.appendChild(a),this._set("userContent",a);const o=document.createElement("div");o.className="esri-view-root",n.insertBefore(o,n.firstChild),this._set("root",o);const l=document.createElement("div");l.className="esri-view-surface",l.setAttribute("role","application"),l.tabIndex=0,o.appendChild(l),this._set("surface",l);const c=new xx;o.appendChild(c.surface),this._set("overlay",c),this.addHandles(M(()=>c.needsRender,u=>{u&&!this._overlayRenderTaskHandle?this._overlayRenderTaskHandle=tc({render:()=>this.overlay?.render()}):this._overlayRenderTaskHandle=xi(this._overlayRenderTaskHandle)})),this.forceDOMReadyCycle(),this._set("container",n),this._startMeasuring()}get focused(){const r=document.activeElement===this.surface;return document.hasFocus()&&r}get size(){return[this.width,this.height]}set ui(r){const s=this._get("ui");s!==r&&s?.destroy(),this._set("ui",r)}blur(){this.surface?.blur()}focus(){this.surface?.focus()}pageToContainer(r,s,n){const a=this.position;return r-=a?a[0]:0,s-=a?a[1]:0,n?(n[0]=r,n[1]=s):n=[r,s],n}containerToPage(r,s,n){const a=this.position;return r+=a?a[0]:0,s+=a?a[1]:0,n?(n[0]=r,n[1]=s):n=[r,s],n}_updateAria(){const{surface:r,aria:s}=this;r&&(r.ariaLabelledByElements=s?.labelledByElements??null,r.ariaDescribedByElements=s?.describedByElements??null,r.ariaLabel=s?.label??null,r.ariaDescription=s?.description??null)}_handleUIChange(r,s){this.removeHandles("ui"),s&&s!==r&&s.destroy(),r&&(r.view=this,this.addHandles(M(()=>this.root,n=>{r.container=n?KF(n):null},Ee),"ui")),this._set("ui",r)}_stopMeasuring(){this.removeHandles("measuring"),this._get("resizing")&&this._set("resizing",!1)}_startMeasuring(){const r=this._freqInfo;r.freq=Mc,r.time=Du;const s=tc({prepare:o=>{const l=this._measure(),c=this._freqInfo;if(c.time+=o.deltaTime,l&&(c.freq=Mc,this._get("resizing")||this._set("resizing",!0)),c.time<c.freq)return;c.time=0;const u=this._position();c.freq=u||l?Mc:Math.min(Du,c.freq*e6),!l&&c.freq>=JF&&(s.pause(),this._get("resizing")&&this._set("resizing",!1))}}),n=new ResizeObserver(o=>{r.freq=Mc,r.time=Du,s.resume()});this.container!=null&&n.observe(this.container);const a=Sn(()=>n.disconnect());this.addHandles([kP(window,"resize",()=>{r.freq=Mc,r.time=Du,s.resume()}),a,s],"measuring"),this._measure(),this._position()}_measure(){const r=this.container,s=r?r.clientWidth:0,n=r?r.clientHeight:0;if(s===0||n===0)return this.suspended||this._set("suspended",!0),!1;const a=this.width,o=this.height;return s===a&&n===o?(this.suspended&&this._set("suspended",!1),!1):(this._set("width",s),this._set("height",n),this.suspended&&this._set("suspended",!1),this.emit("resize",{oldWidth:a,oldHeight:o,width:s,height:n}),!0)}_position(){const r=this.container,s=this.position,n=r&&YF(r);return!!n&&(!s||n[0]!==s[0]||n[1]!==s[1])&&(this._set("position",[n[0],n[1]]),!0)}forceDOMReadyCycle(){}};return h([d()],i.prototype,"aria",void 0),h([d()],i.prototype,"container",null),h([d({readOnly:!0})],i.prototype,"focused",null),h([d({readOnly:!0})],i.prototype,"height",void 0),h([d()],i.prototype,"messagesCommon",void 0),h([d({type:xx})],i.prototype,"overlay",void 0),h([d({readOnly:!0})],i.prototype,"position",void 0),h([d({readOnly:!0})],i.prototype,"resizing",void 0),h([d({readOnly:!0})],i.prototype,"root",void 0),h([d({value:null,readOnly:!0})],i.prototype,"size",null),h([d({readOnly:!0})],i.prototype,"surface",void 0),h([d({readOnly:!0})],i.prototype,"suspended",void 0),h([d({nonNullable:!0})],i.prototype,"ui",null),h([d({readOnly:!0})],i.prototype,"userContent",void 0),h([d({readOnly:!0})],i.prototype,"width",void 0),h([d()],i.prototype,"widthBreakpoint",void 0),i=h([D("esri.views.DOMContainer")],i),i},pm="popup",Sx="manual";function ra(e){return e!=null&&"open"in e&&"declaredClass"in e}function Wa(e){return!!e&&e.tagName.toLowerCase()==="arcgis-popup"&&"open"in e}function i6(e,t,i){const[r,s,n]=t;if(i){const[a,o,l]=i;a&&ra(o)&&(o.view=null,a.remove(o,pm),o!==s&&s&&o.destroy()),a&&l&&Wa(l)&&(l.view=null,a.remove(l,pm),l!==n&&n&&l.remove())}r&&ra(s)&&(s.view=e,r.add(s,{key:pm,position:Sx,internal:!0})),r&&n&&Wa(n)&&(n.view=e,r.add(n,{key:pm,position:Sx,internal:!0}))}async function r6(e,t){const{popup:i,popupElement:r}=e;ra(i)?await mm(i,null,t):r&&Wa(r)?await mm(null,r,t):t?.defer(async()=>{await e.setupPopup();const{popup:s,popupElement:n}=e;ra(s)&&!e.destroyed&&e.ready&&e.popupEnabled?await mm(s,null,t):n&&Wa(n)&&await mm(null,n,t)})}function s6(e,t){const{popup:i,popupElement:r}=e;if(ra(i))return i.open(t);r&&Wa(r)&&r.open(t)}function n6(e,t){ra(e)&&e.close(),t&&Wa(t)&&(t.visible=!1)}async function mm(e,t,i){if(ra(e)){const r=await e.viewModel.handleViewClick(i);return void(r?.promises?.length?e.open(r):e.visible&&e.close())}if(t&&Wa(t)){const r=await t.handleViewClick(i);r?.promises?.length?t.open(r):t.visible&&(t.visible=!1)}}const RM=Qe("mac")?"Meta":"Control",a6=new Set(["Alt","Control","Meta","Shift","Ctrl","Primary"]),o6=e=>a6.has(e);let l6=class{constructor(e,t=[]){this.eventType=e,this.keyModifiers=t}matches(e){if(e.type!==this.eventType)return!1;if(this.keyModifiers.length===0)return!0;const t=e.modifiers;for(const i of this.keyModifiers)if(!t.has(i))return!1;return!0}},Wi=class{constructor(e){this._manager=null,this._incoming={},this._outgoing={},this._incomingEventMatches=null,this._incomingEventTypes=null,this._outgoingEventTypes=null,this._hasSideEffects=e}get incomingEventMatches(){if(!this._incomingEventMatches){this._incomingEventMatches=[];for(const e in this._incoming){const t=this._incoming[e];for(const i of t)this._incomingEventMatches.push(i.match)}}return this._incomingEventMatches}get incomingEventTypes(){return this._incomingEventTypes||(this._incomingEventTypes=this.incomingEventMatches.map(e=>e.eventType)),this._incomingEventTypes}get outgoingEventTypes(){return this._outgoingEventTypes||(this._outgoingEventTypes=Object.keys(this._outgoing)),this._outgoingEventTypes}get hasSideEffects(){return this._hasSideEffects}get hasPendingInputs(){return!1}onInstall(e){this._manager||(e.setEventCallback(t=>this._handleEvent(t)),e.setUninstallCallback(()=>this._onUninstall()),this._manager=e)}onUninstall(){}registerIncoming(e,t,i){let r;typeof t=="function"?(i=t,r=[]):r=t||[];const s=typeof e=="string"?new l6(e,r):e,n=()=>{this._incomingEventTypes=null,this._incomingEventMatches=null},a=c=>{const u=this._incoming[c.match.eventType];if(u){const p=u.indexOf(c);u.splice(p,1),n(),this._manager&&this._manager.updateDependencies()}},o=new c6(s,i,{onPause:a,onRemove:a,onResume:c=>{const u=this._incoming[c.match.eventType];u&&!u.includes(c)&&(u.push(c),n(),this._manager&&this._manager.updateDependencies())}});let l=this._incoming[s.eventType];return l||(l=[],this._incoming[s.eventType]=l),l.push(o),n(),this._manager&&this._manager.updateDependencies(),o}registerOutgoing(e){if(this._outgoing[e])throw new Error("There is already a callback registered for this outgoing InputEvent: "+e);const t=new h6(e,{onEmit:(i,r,s,n)=>{this._manager?.emit(i.eventType,r,s,n)},onRemove:i=>{delete this._outgoing[i.eventType],this._manager?.updateDependencies()}});return this._outgoing[e]=t,this._outgoingEventTypes=null,this._manager&&this._manager.updateDependencies(),t}startCapturingPointer(e){this._manager?.setPointerCapture(e,!0)}stopCapturingPointer(e){this._manager?.setPointerCapture(e,!1)}refreshHasPendingInputs(){this._manager?.refreshHasPendingInputs()}_onUninstall(){this._manager&&(this.onUninstall(),this._manager=null)}_handleEvent(e){const t=this._incoming[e.type];if(t){for(const i of t)if(i.match.matches(e)&&(i.callback?.(e),e.shouldStopPropagation()))break}}},c6=class{constructor(e,t,i){this.match=e,this._callback=t,this._handler=i}pause(){this._handler.onPause(this)}resume(){this._handler.onResume(this)}remove(){this._handler.onRemove(this)}get callback(){return this._callback}},h6=class{constructor(e,t){this.eventType=e,this._removed=!1,this._handler=t}emit(e,t,i){this._removed||this._handler.onEmit(this,e,t,i)}remove(){this._removed=!0,this._handler.onRemove(this)}},u6=class extends Wi{constructor(e){super(!0),this._onChange=e,this._value="mouse",this._x=null,this._y=null,this._id=null,this.registerIncoming("pointer-move",t=>this._update(t.data))}_update(e){const t=e.native.pointerType==="touch"?"touch":"mouse",{x:i,y:r,native:{pointerId:s}}=e;t===this._value&&this._x===i&&this._y===r&&this._id===s||(this._value=t,this._x=i,this._y=r,this._id=s,this._onChange(s,t,i,r))}},d6=class extends Wi{get multiTouchActive(){return this._multiTouchActive.value}constructor(){super(!0),this._activeTouchPointerIds=new Set,this._multiTouchActive=ar(!1),this._onPointerAdd=({data:e})=>{e.pointerType==="touch"&&(this._activeTouchPointerIds.add(e.native.pointerId),this._update())},this._onPointerRemove=({data:e})=>{e.pointerType==="touch"&&(this._activeTouchPointerIds.delete(e.native.pointerId),this._update())},this.registerIncoming("pointer-down",this._onPointerAdd),this.registerIncoming("pointer-up",this._onPointerRemove),this.registerIncoming("pointer-capture-lost",this._onPointerRemove),this.registerIncoming("pointer-cancel",this._onPointerRemove)}_update(){this._multiTouchActive.value=this._activeTouchPointerIds.size>1}},Za=class{constructor(e,t){this._owner=t,this._properties={},this._afterDispatchHandle=null;for(const i in e){const r=e[i],s=new iA(r,void 0,void 0,2,2);this._properties[i]={pool:s,acquired:[]}}this._afterDispatchHandle=VP(()=>this._release())}destroy(){this._afterDispatchHandle&&(this._afterDispatchHandle.remove(),this._afterDispatchHandle=null);for(const e in this._properties){const t=this._properties[e];for(const i of t.acquired)Fw(i)||t.pool.release(i);t.pool.destroy(),t.pool=null,t.acquired=null}this._properties=null,this._owner=null}get(e){const t=this._owner._get(e),i=this._properties[e];let r=i.pool.acquire();for(i.acquired.push(r);r===t;)r=i.pool.acquire(),i.acquired.push(r);return rA(),r}_release(){for(const e in this._properties){const t=this._properties[e];let i=0;for(const r of t.acquired)Fw(r)?t.acquired[i++]=r:t.pool.release(r);t.acquired.length=i}}},p6=class{constructor(){this.id=0,this.type="mouse",this.location=ms()}},sn=class extends ie{constructor(e){super(e),this._pointerCaptures=new Map,this._nameToGroup={},this._handlers=[],this._handlersPriority=[],this._currentPropagation=null,this._updateDependenciesAfterPropagation=!1,this._sourceEvents=new Set,this._keyModifiers=new Set,this._activeKeyModifiers=new Set,this._stoppedPropagationEventIds=new Set,this.primaryKey=RM,this._propertiesPool=new Za({latestPointerInfo:()=>new p6},this),this._latestPointerInfo=void 0,this._paused=!1,this._testTimestamp=void 0}initialize(){this.eventSource.onEventReceived=this._onEventReceived.bind(this),this._installRecognizers()}destroy(){const e=Object.keys(this._nameToGroup);for(const t of e)this.uninstallHandlers(t);this.eventSource.destroy(),this._currentPropagation=null,this._propertiesPool.destroy()}get hasPendingInputs(){return this._handlers.some(e=>e.handler.hasPendingInputs)}get multiTouchActive(){return this._multiTouchHandler.multiTouchActive}get latestPointerInfo(){return this._latestPointerInfo}get updating(){return this.hasPendingInputs||this._paused}installHandlers(e,t,i=ka.INTERNAL){if(this._nameToGroup[e]||t.length===0)return;const r={name:e,handlers:t.map(s=>({handler:s,active:!0,removed:!1,priorityIndex:0,groupPriority:i,eventCallback:null,uninstallCallback:null}))};this._nameToGroup[e]=r;for(let s=r.handlers.length-1;s>=0;s--){const n=r.handlers[s];this._handlers.push(n),n.handler.onInstall({updateDependencies:()=>{this.updateDependencies()},emit:(a,o,l,c,u)=>{this._emitInputEvent(n.priorityIndex+1,a,o,l,u,c)},setPointerCapture:(a,o)=>{this._setPointerCapture(r,n,a,o)},setEventCallback:a=>{n.eventCallback=a},setUninstallCallback:a=>{n.uninstallCallback=a},refreshHasPendingInputs:()=>{this.notifyChange("hasPendingInputs")}})}this.updateDependencies()}uninstallHandlers(e){const t=this._nameToGroup[e];t?(t.handlers.forEach(i=>{i.removed=!0,i.uninstallCallback?.()}),delete this._nameToGroup[e],this._currentPropagation?this._currentPropagation.needsHandlerGarbageCollect=!0:this._garbageCollectRemovedHandlers()):$.getLogger(this).error("There is no InputHandler group registered under the name `"+e+"`")}hasHandlers(e){return this._nameToGroup[e]!==void 0}isModifierKeyDown(e){return this._activeKeyModifiers.has(e)}updateDependencies(){if(this._currentPropagation)return void(this._updateDependenciesAfterPropagation=!0);this._updateDependenciesAfterPropagation=!1;const e=new Set,t=new Set;this._handlersPriority=[];for(let i=this._handlers.length-1;i>=0;i--){const r=this._handlers[i];r.priorityIndex=i,this._handlersPriority.push(r)}this._handlersPriority=this._sortHandlersPriority(this._handlersPriority);for(let i=this._handlersPriority.length-1;i>=0;i--){const r=this._handlersPriority[i];r.priorityIndex=i;let s=r.handler.hasSideEffects;if(!s){for(const n of r.handler.outgoingEventTypes)if(e.has(n)){s=!0;break}}if(s)for(const n of r.handler.incomingEventMatches){e.add(n.eventType);for(const a of n.keyModifiers)o6(a)||t.add(a)}r.active=s}this._sourceEvents=e,this._keyModifiers=t,this._pointerCaptures.size>0&&this._sourceEvents.add("pointer-capture-lost"),this._keyModifiers.size>0&&(this._sourceEvents.add("key-down"),this._sourceEvents.add("key-up")),this.eventSource&&(this.eventSource.activeEvents=this._sourceEvents)}_setLatestPointer(e,t,i,r){const s=this._latestPointerInfo;if(s==null||s.id!==e||s.type!==t||s.location.x!==i||s.location.y!==r){const n=this._propertiesPool.get("latestPointerInfo");n.id=e,n.type=t,n.location.x=i,n.location.y=r,this._latestPointerInfo=n}}_onEventReceived(e,t){if(e==="pointer-capture-lost"){const s=t;this._pointerCaptures.delete(s.native.pointerId)}this._updateKeyModifiers(e,t);const i=this._testTimestamp??t.native?.timestamp,r=t.native?.cancelable;this._emitInputEventFromSource(e,t,i,r)}_updateKeyModifiers(e,t){if(!t)return;let i=!1;const r=()=>{i||(this._activeKeyModifiers=new Set(this._activeKeyModifiers),i=!0)},s=(a,o)=>{o&&!this._activeKeyModifiers.has(a)?(r(),this._activeKeyModifiers.add(a)):!o&&this._activeKeyModifiers.has(a)&&(r(),this._activeKeyModifiers.delete(a))};if(e==="key-down"||e==="key-up"){const a=t.key;this._keyModifiers.has(a)&&s(a,e==="key-down")}const n=t.native;s("Alt",!!n?.altKey),s("Control",!!n?.ctrlKey),s("Ctrl",!!n?.ctrlKey),s("Shift",!!n?.shiftKey),s("Meta",!!n?.metaKey),s("Primary",this._activeKeyModifiers.has(this.primaryKey))}_installRecognizers(){this._latestPointerHandler=new u6((e,t,i,r)=>this._setLatestPointer(e,t,i,r)),this._multiTouchHandler=new d6,this.installHandlers("input-manager-logic",[this._latestPointerHandler,this._multiTouchHandler],ka.ALWAYS),this.recognizers.length>0&&this.installHandlers("default",this.recognizers,ka.INTERNAL)}_setPointerCapture(e,t,i,r){const s=e.name+"-"+t.priorityIndex,n=this._pointerCaptures.get(i.pointerId)||new Set;this._pointerCaptures.set(i.pointerId,n),r?(n.add(s),n.size===1&&this.eventSource&&this.eventSource.setPointerCapture(i,!0)):n.has(s)&&(n.delete(s),n.size===0&&(this._pointerCaptures.delete(i.pointerId),this.eventSource&&this.eventSource.setPointerCapture(i,!1)))}_garbageCollectRemovedHandlers(){this._handlers=this._handlers.filter(e=>!e.removed),this.updateDependencies()}_emitInputEventFromSource(e,t,i,r){this._emitInputEvent(0,e,t,i,r)}_emitInputEvent(e,t,i,r,s,n){const a=r??this._currentPropagation?.timestamp??performance.now(),o=s??!1,l={event:new m6(t,i,a,n||this._activeKeyModifiers,o),priorityIndex:e};this._currentPropagation?this._currentPropagation.events.push(l):this._doNewPropagation(l)}_doNewPropagation(e){this._currentPropagation={events:new Iv,currentHandler:null,needsHandlerGarbageCollect:!1,timestamp:e.event.timestamp},this._currentPropagation.events.push(e),this._continuePropagation()}_continuePropagation(){this._paused=!1;const e=this._currentPropagation;if(e){for(;e.events.length>0;){const{event:t,priorityIndex:i}=e.events.pop(),r=t.data?.eventId;if(!(r!=null&&this._stoppedPropagationEventIds.has(r)))for(e.currentHandler=this._handlersPriority[i];e.currentHandler;){if(e.currentHandler.removed)e.needsHandlerGarbageCollect=!0;else{if(e.currentHandler.active&&!t.shouldStopPropagation()&&e.currentHandler.eventCallback?.(t),t.shouldStopPropagation()){r!=null&&this._stoppedPropagationEventIds.add(r);break}if(t.shouldPausePropagation(()=>this._continuePropagation()))return void this._pausePropagation({event:t,priorityIndex:e.currentHandler.priorityIndex+1})}e.currentHandler=this._handlersPriority[e.currentHandler.priorityIndex+1]}}e.needsHandlerGarbageCollect&&this._garbageCollectRemovedHandlers(),this.hasPendingInputs||this._stoppedPropagationEventIds.clear(),this._currentPropagation=null,this._updateDependenciesAfterPropagation&&this.updateDependencies()}}_pausePropagation(e){const t=new Iv;t.push(e);const i=this._currentPropagation;if(i){for(;i.events.length;)t.push(i.events.pop());i.events=t,i.currentHandler=null,this._paused=!0}}_compareHandlerPriority(e,t){if(e.handler.hasSideEffects!==t.handler.hasSideEffects)return e.handler.hasSideEffects?1:-1;if(e.groupPriority!==t.groupPriority)return e.groupPriority>t.groupPriority?-1:1;for(const i of e.handler.incomingEventMatches)for(const r of t.handler.incomingEventMatches){if(i.eventType!==r.eventType)continue;const s=i.keyModifiers.filter(n=>r.keyModifiers.includes(n));if(s.length===i.keyModifiers.length!=(s.length===r.keyModifiers.length))return i.keyModifiers.length>r.keyModifiers.length?-1:1}return e.priorityIndex>t.priorityIndex?-1:1}_sortHandlersPriority(e){const t=[];for(const i of e){let r=0;for(;r<t.length&&this._compareHandlerPriority(i,t[r])>=0;)r++;t.splice(r,0,i)}return t}get test(){}};h([d({readOnly:!0})],sn.prototype,"hasPendingInputs",null),h([d({constructOnly:!0})],sn.prototype,"eventSource",void 0),h([d({constructOnly:!0})],sn.prototype,"recognizers",void 0),h([d()],sn.prototype,"multiTouchActive",null),h([d()],sn.prototype,"_latestPointerInfo",void 0),h([d()],sn.prototype,"latestPointerInfo",null),h([d()],sn.prototype,"_paused",void 0),h([d({readOnly:!0})],sn.prototype,"updating",null),sn=h([D("esri.views.input.InputManager")],sn);let m6=class{constructor(e,t,i,r,s){this.type=e,this.data=t,this.timestamp=i,this.modifiers=r,this.cancelable=s,this._propagationState=0,this._resumeCallback=null}stopPropagation(){this._propagationState|=1}shouldStopPropagation(){return!!(1&this._propagationState)}defer(e){this._propagationState|=2;const t=(i,r)=>{this._propagationState&=-3;const s=this._resumeCallback;if(this._resumeCallback=null,s&&s(),r)throw i;return i};return(typeof e=="function"?e():e).then(i=>t(i,!1),i=>t(i,!0))}shouldPausePropagation(e){return!!(2&this._propagationState)&&(this._resumeCallback=e,!0)}preventDefault(){this.data.native.preventDefault()}};const ka={ALWAYS:1,DEFAULT:0,TOOL:-1,WIDGET:-2,INTERNAL:-3},f6=e=>{const t=e;let i=class extends t{constructor(){super(...arguments),this._popupSetupTask=null,this.popup={},this.popupEnabled=!0}initialize(){this.addHandles([M(()=>[this.ui,this.popup,this.popupElement],([r,s,n],a)=>{const[o,l,c]=a??[];i6(this,[r,s,n],[o,l,c])},Ve),this.on("click",r=>{this.popup&&this.popupEnabled&&(r.pointerType!=="mouse"||r.button===0)&&r6(this,r)},ka.WIDGET)]),lp(()=>this.ready&&this.popupEnabled&&!this.updating).then(()=>k(()=>le(()=>import("./Popup-Dpb_Kw6t-hWl3nhdy.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236])).then(r=>r.P),ue([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166])))}destroy(){this.destroyed||this.closePopup()}async openPopup(r){if(ra(this.popup))return this.popup.open(r);if(this.popupElement&&Wa(this.popupElement))this.popupElement.open(r).catch(()=>{});else try{if(await this.setupPopup(),!this.popup)return void $.getLogger(this).error(new fe("view:null-popup","Popup is null and can't be opened"));s6(this,r)}catch{}}closePopup(){this._popupSetupTask?.abort(),n6(this.popup,this.popupElement)}async fetchPopupFeatures(r,s){return await this.when(),this._popupHitsToFeatures(await this._getPopupHits(r,s),s)}async setupPopup(){if(this._popupSetupTask?.abort(),this.popup&&!ra(this.popup))return this._popupSetupTask=Ya(async r=>{if(!this.popupEnabled||!Wa(this.popupElement))if(this.dependencies.popup&&typeof this.dependencies.popup=="function")await this.dependencies.popup(),qe(r),customElements.get("arcgis-popup")||$.getLogger(this).error(new fe("view:undefined-popup-element","`arcgis-popup` custom element is undefined and can't be opened")),this.popupElement=document.createElement("arcgis-popup");else{const{default:s}=await k(()=>le(()=>import("./Popup-Dpb_Kw6t-hWl3nhdy.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236])).then(a=>a.P),ue([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166]));if(qe(r),!this.popup||ra(this.popup))return;const n=this.popup;if("open"in n||"close"in n){const{open:a,close:o,...l}=n;this.popup=new s({...l})}else this.popup=new s(n)}}),this._popupSetupTask.promise}async _popupHitsToFeatures({location:r,hits:s},n){const a=[],o=[];let l=!1;const c=_A(n,Qe("popup-view-fetch-timeout")??_6),u=f=>{const g=new g6(f);return o.push(g),a.push(g.promise),g},p=f=>{const g=o.at(-1);return g&&g.layerView===f&&!l?g:u(f)};for(const f of s)"graphic"in f?(p(f.layerView).graphics.push(f.graphic),l=!1):(a.push(f.layerView.fetchPopupFeaturesAtLocation(f.mapPoint,c)),l=!0);o.forEach(f=>f.resolve(c));const m=yA(a).then(f=>f.filter(g=>!!g).flat());return{pendingFeatures:a,allGraphicsPromise:m,location:r}}async _getPopupHits(r,s){const{hits:n,location:a}=await this.popupHitTest(r);qe(s);const o=[];for(const l of n)if("graphic"in l){if(this._isValidPopupGraphic(l.graphic,s)){const c=this._isValidPopupGraphicsLayerView(l.layerView)?l.layerView:void 0;o.push({graphic:l.graphic,layerView:c})}}else this._isValidPopupLocationLayerView(l.layerView)&&o.push({mapPoint:l.mapPoint,layerView:l.layerView});return{hits:o,location:a}}_isValidPopupGraphic(r,s){return r&&!!r.getEffectivePopupTemplate(s?.defaultPopupTemplateEnabled)}_isValidPopupGraphicsLayerView(r){return!r||(!("layer"in r)||!r.suspended)&&"fetchPopupFeaturesFromGraphics"in r}_isValidPopupLocationLayerView(r){return(!("layer"in r)||!r.suspended)&&"fetchPopupFeaturesAtLocation"in r}};return h([d()],i.prototype,"popup",void 0),h([d()],i.prototype,"popupElement",void 0),h([d()],i.prototype,"popupEnabled",void 0),i=h([D("esri.views.PopupView")],i),i};let g6=class{constructor(e){this.layerView=e,this._resolver=aa(),this.graphics=[]}get promise(){return this._resolver.promise}resolve(e){const{layerView:t,graphics:i,_resolver:r}=this;if(!t)return r.resolve(i),r.promise;let s;return t.fetchPopupFeaturesFromGraphics(i,e).catch(n=>(s=n,null)).then(n=>{n?r.resolve(n):r.reject(s)}),r.promise}};const _6=5e3;let ba=class extends ie{constructor(e){super(e),this.view=null,this.baseLayerViews=new Mt,this.groundLayerViews=new Mt,this.referenceLayerViews=new Mt,this._loadingHandle=M(()=>this.view?.map?.basemap,t=>{t&&t.load().catch(()=>{})},Ee)}destroy(){this._set("view",null),this._loadingHandle=xi(this._loadingHandle),this.baseLayerViews.destroyAll(),this.groundLayerViews.destroyAll(),this.referenceLayerViews.destroyAll()}get suspended(){return this.view?.suspended??!0}get updating(){return this.view?.suspended?!1:!!this.view?.map?.basemap?.loaded&&(this.baseLayerViews.some(e=>e.updating)||this.groundLayerViews.some(e=>e.updating)||this.referenceLayerViews.some(e=>e.updating))}};h([d({constructOnly:!0})],ba.prototype,"view",void 0),h([d({readOnly:!0})],ba.prototype,"baseLayerViews",void 0),h([d({readOnly:!0})],ba.prototype,"groundLayerViews",void 0),h([d({readOnly:!0})],ba.prototype,"referenceLayerViews",void 0),h([d({readOnly:!0})],ba.prototype,"suspended",null),h([d({type:Boolean,readOnly:!0})],ba.prototype,"updating",null),ba=h([D("esri.views.BasemapView")],ba);const y6=ba;let ns=class extends ie{constructor(e){super(e),this.factor=1.5,this.offset=ms(0,0),this.position=null,this.size=120,this.maskUrl=null,this.maskEnabled=!0,this.overlayUrl=null,this.overlayEnabled=!0,this.visible=!0}get version(){return this.commitProperty("factor"),this.commitProperty("offset"),this.commitProperty("position"),this.commitProperty("visible"),this.commitProperty("size"),this.commitProperty("maskUrl"),this.commitProperty("maskEnabled"),this.commitProperty("overlayUrl"),this.commitProperty("overlayEnabled"),(this._get("version")||0)+1}};h([d({type:Number})],ns.prototype,"factor",void 0),h([d({nonNullable:!0})],ns.prototype,"offset",void 0),h([d()],ns.prototype,"position",void 0),h([d({type:Number,range:{min:0}})],ns.prototype,"size",void 0),h([d()],ns.prototype,"maskUrl",void 0),h([d()],ns.prototype,"maskEnabled",void 0),h([d()],ns.prototype,"overlayUrl",void 0),h([d()],ns.prototype,"overlayEnabled",void 0),h([d({readOnly:!0})],ns.prototype,"version",null),h([d({type:Boolean})],ns.prototype,"visible",void 0),ns=h([D("esri.views.Magnifier")],ns);const DM=ns;function ro(e){return!(e==null||typeof e!="object"||!("createQuery"in e)||!e.createQuery)}let bs=class extends gu{constructor(e){super(e),this._selectionMap=new Lv,this._sources=new Mt,this._trashCan=[],this._layerEditHandles=new Mt,this._vizTaskId=0,this.view=null,this.showHighlight=!0,this.highlightName="default"}initialize(){this.addHandles([M(()=>[this.view,this.showHighlight],()=>this._refreshVisualization()),M(()=>this.view,e=>{e?.when().then(()=>this.syncSources())},Ee),Ir(()=>this.sources,"change",e=>{const t=this._selectionMap,i=[];for(const r of e.removed){const s=t.get(r);s&&(t.delete(r),s.highlightHandle?.remove(),i.push({layer:r,selection:[],added:[],removed:[...s.selection]}))}this._refreshListeners(),i.length&&this._onSelectionChange(i)},{onListenerAdd:()=>this._refreshListeners()})])}destroy(){this.clear(),this._layerEditHandles.drain(xi)}get selections(){return Array.from(this._selectionMap.entries()).map(e=>{const[t,i]=e;return{layer:t,selection:[...i.selection]}})}get count(){let e=0;for(const t of this._selectionMap.values())e+=t.selection.length;return e}get hasSelection(){return this.count>0}get sources(){return this._sources}set sources(e){R4(e,this._sources)}syncSources(){const e=new Set,t=this.view?.map;if(!t)return;const i=r=>{xI(r)?(r.layers?.forEach(i),r.tables?.forEach(i)):CI(r)?(r.sublayers?.forEach(i),r.subtables?.forEach(i)):ax(r)?r.sublayers?.forEach(i):ro(r)&&e.add(r)};t.allLayers.forEach(i),t.allTables.forEach(i),this.sources=[...e]}async getSelectedFeatures(e,t={},i="layerView"){const{view:r,selections:s}=this;if(!r&&i==="layerView")return $.getLogger(this).warn("Cannot query layer views without a view."),[];const n=(e?.length?s.filter(a=>e.includes(a.layer)):s).map(async a=>{const{layer:o,selection:l}=a;if(!l.length)return;const c=ih(o)?o.parent:o;if(c!=null){if(r&&i==="layerView"&&!Tx(c)&&Px(c)){const u=await r.whenLayerView(c).catch(()=>null);if(u)return Mx(u,l,t)}return Mx(c,l,t)}}).filter(Dg);return(await Promise.all(n)).filter(Dg)}updateSelection(e){const t=new Map;for(const[s,n]of this._selectionMap)t.set(s,[...n.selection]);let i=!1;const r=e.current.concat(e.added);for(const s of r){const n=s.sourceLayer,a=s.getObjectId();if(this.sources.includes(n)&&(ro(n)||ih(n))&&a!==null){const o=Fa(t,n,()=>[]);o.includes(a)||(o.push(a),i=!0)}}for(const s of e.removed){const n=s.sourceLayer,a=s.getObjectId();if(this.sources.includes(n)&&(ro(n)||ih(n))&&a!==null){const o=t.get(n),l=o?.indexOf(a);l!==void 0&&l>=0&&(o?.splice(l,1),i=!0)}}if(i){const{_selectionMap:s,_trashCan:n}=this,a=[];for(const[o,l]of t){const c=s.get(o);c!==void 0&&n.push(c),s.set(o,{selection:l}),a.push({layer:o,selection:l,...xv(c!==void 0?c.selection:[],l)})}this._onSelectionChange(a)}}setSelection(e,t){this._setSelection(e,t)}getSelection(e){return this._selectionMap.get(e)?.selection}appendToSelection(e,t){const i=this._selectionMap.get(e),r=i!==void 0?[...i.selection]:[];for(const s of t)r.includes(s)||r.push(s);this._setSelection(e,r)}removeFromSelection(e,t){const i=this._selectionMap.get(e);if(!i)return;const r=[];for(const s of i.selection)t.includes(s)||r.push(s);this._setSelection(e,r)}toggleInSelection(e,t){const i=this._selectionMap.get(e);if(!i||i.selection.length===0)return void this._setSelection(e,t);const r=new Set(i.selection),s=new Set(t),n=bA(r,s);this._setSelection(e,Array.from(n))}clear(){const e=this._selectionMap.values();this._trashCan.push(...e);const t=[];for(const[i,r]of this._selectionMap.entries())t.push({layer:i,added:[],removed:[...r.selection],selection:[]});this._selectionMap.clear(),this._onSelectionChange(t)}_onSelectionChange(e){this._refreshVisualization(),this.emit("selection-change",{view:this.view,changes:e})}_refreshVisualization(){for(this._vizTaskId++;this._trashCan.length>0;)this._trashCan.pop()?.highlightHandle?.remove();if(this.view==null)return;const{sources:e,view:t,_selectionMap:i,showHighlight:r}=this,s=this._vizTaskId;for(const n of e){const a=i.get(n),o=ih(n)?n.parent:n;if(o!=null&&Px(o)){if(Tx(o))continue;t.whenLayerView(o).then(l=>{a?.highlightHandle?.remove(),a!=null&&r&&s===this._vizTaskId&&"highlight"in l&&typeof l.highlight=="function"&&a.selection.length>0&&(a.highlightHandle=l.highlight(a.selection,this.highlightName))}).catch(()=>{a?.highlightHandle?.remove()})}}}_refreshListeners(){this._layerEditHandles.drain(xi);const e=new Set(this.sources.map(t=>ih(t)?t.parent:t));for(const t of e)ro(t)&&"on"in t&&t.on&&this._layerEditHandles.push(t.on("edits",i=>this._onLayerEdit(i,t)))}_onLayerEdit(e,t){if(ax(t))this._onParentLayerEdit(e,t);else if(e.deletedFeatures.length&&this._selectionMap.has(t)){const i=[];e.deletedFeatures.forEach(({error:r,objectId:s})=>{s!=null&&r==null&&i.push(s)}),this.removeFromSelection(t,i)}}_onParentLayerEdit(e,t){const{deletedFeatures:i,edits:r,updatedFeatures:s}=e;if(r?.updateFeatures?.forEach(n=>{const a=n.getObjectId()??n.attributes[t.objectIdField];if(a==null||s.find(c=>c.objectId===a)?.error)return;const o=t.findSublayerForFeature(n);if(!ro(o))return;const l=t.sublayers.find(c=>!(!ro(c)||!this.getSelection(c)?.includes(a)));ro(l)&&l!==o&&(this.removeFromSelection(l,[a]),this.appendToSelection(o,[a]))}),i.length){const n=[];i.forEach(({error:a,objectId:o})=>{o!=null&&a==null&&n.push(o)}),t.sublayers.forEach(a=>{ro(a)&&this._selectionMap.has(a)&&this.removeFromSelection(a,n)})}}_setSelection(e,t){if(!this.sources.includes(e))throw new Error(`Cannot set selection on layer ${e.title} because it is not in 'sources'`);const i=this._selectionMap.get(e);if(i===void 0||!b6(i,{selection:t})){i!==void 0&&this._trashCan.push(i),this._selectionMap.set(e,{selection:[...t]});const r={layer:e,selection:[...t],...xv(i!==void 0?i.selection:[],t)};this._onSelectionChange([r])}}};h([d()],bs.prototype,"_selectionMap",void 0),h([d()],bs.prototype,"_sources",void 0),h([d({readOnly:!0,nonNullable:!0})],bs.prototype,"selections",null),h([d({readOnly:!0,nonNullable:!0})],bs.prototype,"count",null),h([d()],bs.prototype,"view",void 0),h([d({readOnly:!0,nonNullable:!0})],bs.prototype,"hasSelection",null),h([d()],bs.prototype,"showHighlight",void 0),h([d()],bs.prototype,"sources",null),h([d()],bs.prototype,"highlightName",void 0),bs=h([D("esri.views.SelectionManager")],bs);const Tx=e=>ih(e)?e.parent?.isTable===!0:e.isTable,v6=e=>e.layer!==void 0,Px=e=>e?.when!==void 0,b6=(e,t)=>{if(e==null&&t==null)return!0;if(e!=null&&t==null||e==null&&t!=null)return!1;if(e!=null&&t!=null&&e.selection!=null&&t.selection!=null){const i=[...e.selection],r=[...t.selection];if(i.length!==r.length)return!1;i.sort(),r.sort();for(let s=0;s<i.length;s++)if(i[s]!==r[s])return!1}return!0},Mx=async(e,t,i={})=>{let r;if(v6(e)){const s=e;r=s===void 0?null:await s.queryFeatures(new ox({...i,objectIds:t})).then(n=>({data:n,layer:e.layer}))}else{const s=e;r=s===void 0?null:await s.queryFeatures(new ox({...i,objectIds:t})).then(n=>({data:n,layer:s}))}return r},w6=bs;let nd=class extends _9(ie){constructor(e){super(e),this.accentColor=new wi([255,127,0]),this.textColor=new wi([255,255,255])}};h([d({type:wi,nonNullable:!0})],nd.prototype,"accentColor",void 0),h([d({type:wi,nonNullable:!0})],nd.prototype,"textColor",void 0),nd=h([D("esri.views.Theme")],nd);const Nv=nd,OM=["click","double-click","immediate-click","immediate-double-click","hold","drag","key-down","key-up","pointer-down","pointer-move","pointer-up","pointer-drag","mouse-wheel","pointer-enter","pointer-leave","gamepad","focus","blur"],EM={};function AM(e){return!!EM[e]}function x6(e){for(const t of e)if(!AM(t))return!1;return!0}OM.forEach(e=>{EM[e]=!0});let C6=class{constructor(e){this._handlers=new Map,this._counter=0,this._handlerCounts=new Map,this.view=e,this.inputManager=null}connect(e){e&&this.disconnect(),this.inputManager=e,this._handlers.forEach(({handler:t,priority:i},r)=>this.inputManager?.installHandlers(r,[t],i))}disconnect(){this.inputManager&&this._handlers.forEach((e,t)=>this.inputManager?.uninstallHandlers(t)),this.inputManager=null}destroy(){this.disconnect(),this._handlers.clear(),this.view=null}on(e,t,i,r){const s=Array.isArray(e)?e:e.split(",");if(!x6(s))return s.some(AM)&&console.error("Error: registering input events and other events on the view at the same time is not supported."),null;let n,a;Array.isArray(t)?a=t:(n=t,a=[]),typeof i=="function"?n=i:r=i,r=r??ka.DEFAULT;const o=this._createUniqueGroupName(),l=new S6(this.view,s,a,n);this._handlers.set(o,{handler:l,priority:r});for(const c of s){const u=this._handlerCounts.get(c)||0;this._handlerCounts.set(c,u+1)}return this.inputManager&&this.inputManager.installHandlers(o,[l],r),Sn(()=>this._removeHandler(o,s))}hasHandler(e){return!!this._handlerCounts.get(e)}_removeHandler(e,t){if(this._handlers.has(e)){this._handlers.delete(e);for(const i of t){const r=this._handlerCounts.get(i);r===void 0||(r===1?this._handlerCounts.delete(i):this._handlerCounts.set(i,r-1))}}this.inputManager&&this.inputManager.uninstallHandlers(e)}_createUniqueGroupName(){return this._counter+=1,`viewEvents_${this._counter}`}},S6=class extends Wi{constructor(e,t,i,r){super(!0),this._latestDragStart=void 0,this.view=e;for(const s of t)switch(s){case"click":this.registerIncoming("click",i,n=>r(M6(e,n)));break;case"double-click":this.registerIncoming("double-click",i,n=>r(R6(e,n)));break;case"immediate-click":this.registerIncoming("immediate-click",i,n=>r(D6(e,n)));break;case"immediate-double-click":this.registerIncoming("immediate-double-click",i,n=>r(O6(e,n)));break;case"hold":this.registerIncoming("hold",i,n=>r(E6(e,n)));break;case"drag":this.registerIncoming("drag",i,n=>{const a=this._wrapDrag(n);a&&r(a)});break;case"key-down":this.registerIncoming("key-down",i,n=>r(A6(n)));break;case"key-up":this.registerIncoming("key-up",i,n=>r(I6(n)));break;case"pointer-down":this.registerIncoming("pointer-down",i,n=>r(Ou(n,"pointer-down")));break;case"pointer-move":this.registerIncoming("pointer-move",i,n=>r(Ou(n,"pointer-move")));break;case"pointer-up":this.registerIncoming("pointer-up",i,n=>r(Ou(n,"pointer-up")));break;case"pointer-drag":this.registerIncoming("pointer-drag",i,n=>r(L6(n)));break;case"mouse-wheel":this.registerIncoming("mouse-wheel",i,n=>r(F6(n)));break;case"pointer-enter":this.registerIncoming("pointer-enter",i,n=>r(Ou(n,"pointer-enter")));break;case"pointer-leave":this.registerIncoming("pointer-leave",i,n=>r(Ou(n,"pointer-leave")));break;case"gamepad":this.registerIncoming("gamepad",i,n=>{r(V6(n))});break;case"focus":this.registerIncoming("focus",i,n=>{r(T6(n))});break;case"blur":this.registerIncoming("blur",i,n=>{r(P6(n))})}}_wrapDrag(e){const t=e.data,{x:i,y:r}=t.center,{action:s,pointerType:n,button:a}=t;if(s==="start"&&(this._latestDragStart=t),!this._latestDragStart)return;const o=t.pointer.native,l=t.buttons,{cancelable:c,timestamp:u}=e,p={x:this._latestDragStart.center.x,y:this._latestDragStart.center.y};return s==="end"&&(this._latestDragStart=void 0),{type:"drag",action:s,x:i,y:r,origin:p,pointerType:n,button:a,buttons:l,radius:t.radius,angle:sc(t.angle),native:o,timestamp:u,cancelable:c,stopPropagation:()=>e.stopPropagation(),defer:m=>e.defer(m),preventDefault:()=>e.preventDefault()}}};function T6(e){return{type:"focus",timestamp:e.timestamp,native:e.data.native,cancelable:e.cancelable,stopPropagation:()=>e.stopPropagation(),defer:t=>e.defer(t),preventDefault:()=>e.preventDefault()}}function P6(e){return{type:"blur",timestamp:e.timestamp,native:e.data.native,cancelable:e.cancelable,stopPropagation:()=>e.stopPropagation(),defer:t=>e.defer(t),preventDefault:()=>e.preventDefault()}}function M6(e,t){const{pointerType:i,button:r,buttons:s,x:n,y:a,native:o,eventId:l}=t.data,{cancelable:c,timestamp:u}=t;return{type:"click",pointerType:i,button:r,buttons:s,x:n,y:a,native:o,timestamp:u,screenPoint:ms(n,a),mapPoint:$p(e,n,a),eventId:l,cancelable:c,stopPropagation:()=>t.stopPropagation(),defer:p=>t.defer(p),preventDefault:()=>t.preventDefault()}}function R6(e,t){const{pointerType:i,button:r,buttons:s,x:n,y:a,native:o,eventId:l}=t.data,{cancelable:c,timestamp:u}=t;return{type:"double-click",pointerType:i,button:r,buttons:s,x:n,y:a,native:o,timestamp:u,mapPoint:$p(e,n,a),eventId:l,cancelable:c,stopPropagation:()=>t.stopPropagation(),defer:p=>t.defer(p),preventDefault:()=>t.preventDefault()}}function D6(e,t){const{pointerType:i,button:r,buttons:s,x:n,y:a,native:o,eventId:l}=t.data,c=o.pointerId,{cancelable:u,timestamp:p}=t;return{type:"immediate-click",pointerId:c,pointerType:i,button:r,buttons:s,x:n,y:a,native:o,timestamp:p,mapPoint:$p(e,n,a),eventId:l,cancelable:u,stopPropagation:()=>t.stopPropagation(),defer:m=>t.defer(m),preventDefault:()=>t.preventDefault()}}function O6(e,t){const{pointerType:i,button:r,buttons:s,x:n,y:a,native:o,eventId:l}=t.data,c=o.pointerId,{cancelable:u,timestamp:p}=t;return{type:"immediate-double-click",pointerId:c,pointerType:i,button:r,buttons:s,x:n,y:a,native:o,timestamp:p,mapPoint:$p(e,n,a),eventId:l,cancelable:u,stopPropagation:()=>t.stopPropagation(),defer:m=>t.defer(m),preventDefault:()=>t.preventDefault()}}function E6(e,t){const{pointerType:i,button:r,buttons:s,x:n,y:a,native:o}=t.data,{cancelable:l,timestamp:c}=t;return{type:"hold",pointerType:i,button:r,buttons:s,x:n,y:a,native:o,timestamp:c,mapPoint:$p(e,n,a),cancelable:l,stopPropagation:()=>t.stopPropagation(),defer:u=>t.defer(u),preventDefault:()=>t.preventDefault()}}function $p(e,t,i){return e.toMap(ms(t,i),{exclude:[]})}function A6(e){const{key:t,repeat:i,native:r}=e.data,{cancelable:s,timestamp:n}=e;return{type:"key-down",key:t,repeat:i,native:r,timestamp:n,cancelable:s,stopPropagation:()=>e.stopPropagation(),defer:a=>e.defer(a),preventDefault:()=>e.preventDefault()}}function I6(e){const{key:t,native:i}=e.data,{cancelable:r,timestamp:s}=e;return{type:"key-up",key:t,native:i,timestamp:s,cancelable:r,stopPropagation:()=>e.stopPropagation(),defer:n=>e.defer(n),preventDefault:()=>e.preventDefault()}}function Ou(e,t){const{x:i,y:r,button:s,buttons:n,native:a,eventId:o}=e.data,l=a.pointerId,c=a.pointerType,{cancelable:u,timestamp:p}=e;return{type:t,x:i,y:r,pointerId:l,pointerType:c,button:s,buttons:n,native:a,timestamp:p,eventId:o,cancelable:u,stopPropagation:()=>e.stopPropagation(),defer:m=>e.defer(m),preventDefault:()=>e.preventDefault()}}function L6(e){const{x:t,y:i,buttons:r,native:s,eventId:n}=e.data.currentEvent,{button:a}=e.data.startEvent,o=e.data.startEvent.native.pointerId,l=e.data.startEvent.native.pointerType,c=e.data.action,u={x:e.data.startEvent.x,y:e.data.startEvent.y},{cancelable:p,timestamp:m}=e;return{type:"pointer-drag",x:t,y:i,pointerId:o,pointerType:l,button:a,buttons:r,action:c,origin:u,native:s,timestamp:m,eventId:n,cancelable:p,stopPropagation:()=>e.stopPropagation(),defer:f=>e.defer(f),preventDefault:()=>e.preventDefault()}}function F6(e){const{cancelable:t,data:i,timestamp:r}=e,{x:s,y:n,deltaY:a,native:o}=i;return{type:"mouse-wheel",x:s,y:n,deltaY:a,native:o,timestamp:r,cancelable:t,stopPropagation:()=>e.stopPropagation(),defer:l=>e.defer(l),preventDefault:()=>e.preventDefault()}}function V6(e){const{action:t,state:i,device:r}=e.data,{cancelable:s,timestamp:n}=e,{buttons:a,axes:o}=i;return{type:"gamepad",device:r,timestamp:n,action:t,buttons:a,axes:o,cancelable:s,stopPropagation:()=>e.stopPropagation(),defer:l=>e.defer(l),preventDefault:()=>e.preventDefault()}}const IM="z",LM="r",FM={cancel:"Escape",complete:"Enter"},mre={...FM,redo:LM,undo:IM,center:"Alt",constraint:"Shift",delete:["Backspace","Delete"],vertexAdd:"f",pan:" "},fre={toggle:"Control"},gre={enterInputMode:"Tab",commit:"Enter",discard:"Escape",next:"Tab"},_re={moveUp:{key:"ArrowUp",modifier:"Shift",repeats:!0},moveDown:{key:"ArrowDown",modifier:"Shift",repeats:!0},moveLeft:{key:"ArrowLeft",modifier:"Shift",repeats:!0},moveRight:{key:"ArrowRight",modifier:"Shift",repeats:!0},scaleUp:{key:"+",modifier:"Shift"},scaleDown:{key:"-",modifier:"Shift"},factorModifier:{key:RM,continuePropagation:!0},toggleOpacity:"t",preserveAspectRatio:{key:"Shift",continuePropagation:!0},rotateIncrements:{key:"Shift",continuePropagation:!0},editSourcePoints:{key:"Alt",continuePropagation:!0},undo:IM,redo:LM};let yre=class{constructor(){this._bindings=new Map}add(e,t){return this.addToggle(e,i=>{i.type==="key-down"&&t(i)})}addToggle(e,t){const i=z6.fromDefinition(e,t),r=Fa(this._bindings,i.key,()=>[]);return r.push(i),Sn(()=>b2(r,i))}register(e,t=ka.WIDGET){return sA([e.on("key-down",i=>this.dispatch(e.inputManager,i),t),e.on("key-up",i=>this.dispatch(e.inputManager,i),t)])}dispatch(e,t){const i=t.key,r=this._bindings.get(i);if(r)for(const s of r)s.process(e,t)}},z6=class jv{constructor(t,i,r,s,n){this.key=t,this.modifiers=i,this.repeats=r,this.continuePropagation=s,this.callback=n}process(t,i){if(!(i.key!==this.key||"repeat"in i&&i.repeat&&!this.repeats)){for(const r of this.modifiers)if(!t.isModifierKeyDown(r))return;this.continuePropagation||i.stopPropagation(),this.callback(i)}}static fromDefinition(t,i){if(typeof t=="string")return new jv(t,[],!1,!1,i);const{key:r,modifier:s,repeats:n,continuePropagation:a}=t;return new jv(r,s?Array.isArray(s)?s:[s]:[],!!n,!!a,i)}};function k6(e){return[e.on("before-add",t=>{const i=t.item;if(i==null||e.includes(i))return $.getLogger("esri.views.interactive.interactiveToolUtils").warn("Tool is either already in the list of tools or tool is `null`. Not adding tool."),void t.preventDefault();i.onAdd()}),e.on("after-remove",t=>{const i=t.item;i.active&&(i.view.activeTool=null),i.destroy()})]}function Uv(e){return e.visible&&e.getEditableFlag!=null&&e.getEditableFlag(0)&&e.getEditableFlag(1)}function B6(e){return e.type==="key-down"&&e.key===FM.cancel}function Nn(e){return ms(e.x,e.y)}function vre(e){return si(e.x,e.y)}function VM(e,t){const i=(e instanceof HTMLElement?e:e.surface)?.getBoundingClientRect();return i?ms(t.clientX-i.left,t.clientY-i.top):ms(0,0)}function Rx(e,t){return t instanceof Event?VM(e,t):Nn(t)}function Dx(e){if(e instanceof Event)return!0;if(typeof e=="object"&&"type"in e)switch(e.type){case"click":case"double-click":case"pointer-down":case"pointer-drag":case"pointer-enter":case"pointer-leave":case"pointer-up":case"pointer-move":case"immediate-click":case"immediate-double-click":case"hold":case"drag":case"mouse-wheel":return!0;default:return!1}return!1}let If=class extends ie{constructor(){super(...arguments),this._pointerLocations=new Map,this._hoveredManipulators=new Lv,this._grabbedManipulators=new Lv,this._draggedManipulators=new Map,this._stopDrag=!1,this._externallyDragging=!1,this._revertToNullActiveTool=!1}get cursor(){return this._cursorFromMap(this._grabbedManipulators,"grabbing")??this._cursorFromMap(this._hoveredManipulators,"pointer")}get hasFocusedManipulators(){return this._grabbedManipulators.size>0||this._draggedManipulators.size>0}handleInputEvent(e,t){const i=()=>e.stopPropagation();switch(e.type){case"pointer-move":Ox(e.pointerType)&&this._pointerLocations.set(e.pointerId,{x:e.x,y:e.y,pointerType:e.pointerType});break;case"drag":this._grabbedManipulators.size>0?this._stopDrag=!0:e.action==="start"?this._externallyDragging=!0:e.action==="end"&&(this._externallyDragging=!1),this._stopDrag&&(i(),e.action==="end"&&(this._stopDrag=!1));break;case"pointer-down":{if(!Ex(e))break;const r=Nn(e),s=Rc(r,e.pointerType,t.tools);if(s==null)break;const n=s.manipulator,a=s.tool;n==null||a==null||!n.interactive||n.grabbable&&n.grabbableForEvent(e)||!n.grabbing||n.dragging||this._releaseManipulatorBeforeDragging(n,e,t),n!=null&&a!=null&&n.interactive&&n.grabbable&&n.grabbableForEvent(e)&&!n.grabbing&&(this._grabbedManipulators.set(e.pointerId,{manipulator:n,tool:a,start:r,pointerType:e.pointerType}),this._grabbedManipulators.size===1&&t.activeTool==null&&(this._revertToNullActiveTool=!0,t.setActiveTool(s.tool)),n.grabbing=!0,n.events.emit("grab-changed",{action:"start",pointerType:e.pointerType,screenPoint:r}),i());break}case"pointer-up":this._draggedManipulators.has(e.pointerId)||this._handlePointerEnd(e,t);break;case"pointer-drag":{if(!Ex(e))break;const r=this._grabbedManipulators.get(e.pointerId),s=r?.manipulator,n=r?.tool;if(s==null||n==null)break;const a=Nn(e);a.x=j(a.x,0,t.view.width),a.y=j(a.y,0,t.view.height);const o=r.start,l=this._draggedManipulators.get(e.pointerId);switch(e.action){case"start":case"update":e.action!=="update"&&this._grabbedManipulators.size!==1||(s.dragging=!0,l?s.events.emit("drag",{action:"update",start:o,screenPoint:a}):s.events.emit("drag",{action:"start",start:o,screenPoint:a,pointerType:e.pointerType}),this._draggedManipulators.set(e.pointerId,{tool:n,manipulator:s,start:o}));break;case"end":s.dragging=!1,l&&s.events.emit("drag",{action:"end",start:o,screenPoint:a}),this._draggedManipulators.delete(e.pointerId),this._handlePointerEnd(e,t)}i();break}case"immediate-click":{const r=Nn(e),s=Rc(r,e.pointerType,t.tools);if(!N6(e)){for(const l of t.tools)if((s==null||s.tool!==l||l.automaticManipulatorSelection)&&l.manipulators){let c=!1;l.manipulators.forEach(({manipulator:u})=>{u.selected&&(u.selected=!1,c=!0)}),c&&l.onManipulatorSelectionChanged&&l.onManipulatorSelectionChanged()}}if(s==null)break;const{manipulator:n,tool:a}=s;if(!n.interactive)break;n.selectable&&a.automaticManipulatorSelection&&(n.selected=!n.selected,a.onManipulatorSelectionChanged&&a.onManipulatorSelectionChanged());const o=e.native.shiftKey;n.events.emit("immediate-click",{screenPoint:r,button:e.button,pointerType:e.pointerType,shiftKey:o,stopPropagation:i}),Ty(n,i);break}case"click":{const r=Nn(e),s=Rc(r,e.pointerType,t.tools),n=s?.manipulator;if(n==null||!n.interactive)break;const a=e.native.shiftKey;n.events.emit(e.type,{screenPoint:r,button:e.button,pointerType:e.pointerType,shiftKey:a}),i();break}case"double-click":{const r=Nn(e),s=Rc(r,e.pointerType,t.tools),n=s!=null?s.manipulator:null;if(n==null||!n.interactive)break;const a=e.native.shiftKey;n.events.emit("double-click",{screenPoint:r,button:e.button,pointerType:e.pointerType,shiftKey:a,stopPropagation:i}),Ty(n,i);break}case"immediate-double-click":{const r=Nn(e),s=Rc(r,e.pointerType,t.tools),n=s!=null?s.manipulator:null;if(n==null||!n.interactive)break;const a=e.native.shiftKey;n.events.emit("immediate-double-click",{screenPoint:r,button:e.button,pointerType:e.pointerType,shiftKey:a,stopPropagation:i}),e.pointerType==="mouse"&&Ty(n,i);break}}this._onFocusChange(t.tools)}_releaseManipulatorBeforeDragging(e,t,i){e.grabbing=!1,e.events.emit("grab-changed",{action:"end",pointerType:t.pointerType,screenPoint:Nn(t)}),this._grabbedManipulators.forEach(({manipulator:r},s)=>{r===e&&this._grabbedManipulators.delete(s)}),this._afterManipulatorRelease(i.setActiveTool)}_handlePointerEnd(e,t){const i=this._grabbedManipulators.get(e.pointerId)?.manipulator;i!=null&&i.grabbing&&(i.grabbing=!1,i.events.emit("grab-changed",{action:"end",pointerType:e.pointerType,screenPoint:Nn(e)}),this._grabbedManipulators.delete(e.pointerId),this._afterManipulatorRelease(t.setActiveTool))}_onFocusChange(e){this._updateFocusedManipulatorTools(e)}_updateFocusedManipulatorTools(e){const t=new Set,i=new Set;this._grabbedManipulators.forEach(({tool:r})=>t.add(r)),this._hoveredManipulators.forEach(({tool:r})=>i.add(r));for(const r of e){r.hasGrabbedManipulators=t.has(r),r.hasHoveredManipulators=i.has(r);const s=this._grabbedManipulators.values(),n=CA(s,({tool:a})=>a===r);r.firstGrabbedManipulator=n!=null?n.manipulator:null}}clearPointers(e,{tools:t,setActiveTool:i},r=!0,s){const n=(a,o)=>a===e&&(s==null||s===o);this._grabbedManipulators.forEach(({tool:a,manipulator:o,pointerType:l},c)=>{n(a,o)&&(this._grabbedManipulators.delete(c),o.grabbing=!1,o.events.emit("grab-changed",{action:"end",screenPoint:null,pointerType:l}))}),this._draggedManipulators.forEach(({tool:a,manipulator:o},l)=>{n(a,o)&&(this._draggedManipulators.delete(l),o.dragging=!1,o.events.emit("drag",{action:"cancel"}))}),r&&this._hoveredManipulators.forEach(({tool:a,manipulator:o},l)=>{n(a,o)&&(this._hoveredManipulators.delete(l),o.hovering=!1)}),this._afterManipulatorRelease(i),this._onFocusChange(t)}updateHoveredStateFromKnownPointers(e){this._pointerLocations.forEach((t,i)=>{this._updateHoveredStateForPointerAtScreenPosition(ms(t.x,t.y),i,t.pointerType,e)})}handleHoverEvent(e,t){const i=e.type;i!=="pointer-up"&&i!=="immediate-click"&&i!=="pointer-move"||!Ox(e.pointerType)||(i!=="pointer-up"&&this._externallyDragging?this._clearHoveredManipulatorStates(e.pointerId):this._updateHoveredStateForPointerAtScreenPosition(Nn(e),e.pointerId,e.pointerType,t))}_updateHoveredStateForPointerAtScreenPosition(e,t,i,r){let s=Rc(e,i,r);const n=this._hoveredManipulators.get(t)?.manipulator;s==null||s.manipulator.interactive||(s=null),s!=null&&n===s.manipulator||(n!=null&&(n.hovering=!1),s!=null?(s.manipulator.hovering=!0,this._hoveredManipulators.set(t,s)):this._hoveredManipulators.delete(t),this._onFocusChange(r))}_afterManipulatorRelease(e){this._grabbedManipulators.size===0&&this._revertToNullActiveTool&&(e(null),this._revertToNullActiveTool=!1)}_clearHoveredManipulatorStates(e){this._hoveredManipulators.forEach(({manipulator:t},i)=>{e===i&&(this._hoveredManipulators.delete(e),t.hovering=!1)})}_cursorFromMap(e,t){if(!e?.size)return null;for(const{manipulator:i}of e.values())if(i?.interactive){if(i.grabbing&&i.grabCursor)return i.grabCursor;if(i.cursor)return i.cursor}return t}};function Rc(e,t,i){for(const r of i){if(r.manipulators==null||!Uv(r))continue;const s=r.manipulators.intersect(e,t);if(s!=null)return{tool:r,manipulator:s}}return null}function Ox(e){return e==="mouse"}function Ex(e){return e.pointerType!=="mouse"||e.button===0}function N6(e){return!!e.native.shiftKey}function Ty(e,t){e?.consumesClicks&&t()}h([d()],If.prototype,"cursor",null),If=h([D("esri.views.interactive.ToolViewManagerManipulatorState")],If);const Ax="attached",Py="tools",j6=1e3;let jn=class extends ie{constructor(e){super(e),this._updatingHandles=new dc,this._clock=Vp,this._manipulatorState=new If,this.tools=new Mt,this._interacting=!1,this._interactingTimeout=j6,this._interactingTimeoutHandle=null}initialize(){this.addHandles([this.view.on(OM,e=>{this._handleInputEvent(e)},ka.TOOL),...k6(this.tools),this.tools.on("before-add",({item:e})=>{this._updateToolEditableFlag(e)}),this.tools.on("before-remove",({item:e})=>{this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs)}),this.tools.on("change",()=>{this._refreshToolWatchers()})])}destroy(){this.activeTool=null,this.tools.drain(e=>e.destroy()),this._clearInteractingTimeout(),this._interacting=!1,this._updatingHandles.destroy(),this._manipulatorState.destroy()}get _manipulatorStateEventArgs(){return{tools:this.tools,activeTool:this.activeTool,setActiveTool:e=>{this.activeTool=e},view:this.view}}set activeTool(e){if(e!=null&&!this.view.ready)return void $.getLogger(this).error("Cannot set active tool while view is not ready.");if(e===this.activeTool)return;const t=this.activeTool;this._set("activeTool",e),t?.deactivate(),e?.activate(),this._removeIncompleteTools(e);for(const i of this.tools){this._updateToolEditableFlag(i);const r=Uv(i);this.activeTool!=null&&r||this._manipulatorState.clearPointers(i,this._manipulatorStateEventArgs,!r)}}get cursor(){const e=this._manipulatorState.cursor;if(e!=null)return e;for(const t of this.tools)if(t.visible&&t.cursor!=null)return t.cursor;return null}get updating(){return this._updatingHandles.updating||this.tools.some(e=>e.updating)}get interacting(){return this._interacting}_clearInteractingTimeout(){this._interactingTimeoutHandle=xi(this._interactingTimeoutHandle)}_startInteractingTimeout(){this._clearInteractingTimeout(),this._interactingTimeoutHandle=this._clock.setTimeout(()=>this._interacting=!1,this._interactingTimeout)}attach(){this.view.type==="3d"?this.addHandles([M(()=>{const{state:e}=this.view;return"camera"in e&&e.camera},()=>this._forEachManipulator(e=>e.onViewChange())),this.view.elevationProvider.on("elevation-change",e=>this._forEachManipulator(t=>t.onElevationChange(e)))],Ax):this.addHandles(M(()=>this.view.extent,()=>this._forEachManipulator(e=>e.onViewChange())))}detach(){this.activeTool=null,this.tools.removeAll(),this.removeHandles(Ax),this._clearInteractingTimeout(),this._interacting=!1}_forEachManipulator(e){for(const t of this.tools)t.manipulators&&t.manipulators.forEach(({manipulator:i})=>e(i,t))}_handleInputEvent(e){let t=!1;const i={...e,stopPropagation:()=>{t=!0,e.stopPropagation()}};if(this.activeTool!=null)this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(i);else for(const r of this.tools)!t&&r.visible&&r.handleInputEvent(i);!t&&B6(e)&&this.activeTool&&(e.stopPropagation(),e.preventDefault(),this.activeTool.cancel(),this.activeTool=null),this._manipulatorState.handleInputEvent(i,this._manipulatorStateEventArgs),t||this.activeTool==null||this.activeTool.handleInputEventAfter(i),this._manipulatorState.handleHoverEvent(i,this.tools),e.type==="pointer-move"&&(this._manipulatorState.hasFocusedManipulators||this.activeTool)&&(this._interacting=!0,this._startInteractingTimeout())}_refreshToolWatchers(){this.removeHandles(Py);for(const e of this.tools){if(e instanceof ie){const t=M(()=>[e.cursor,e.visible,e.editable],()=>{Uv(e)||this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs)});this.addHandles(t,Py)}e.manipulators&&this.addHandles([e.manipulators.on("after-remove",t=>{this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs,!0,t.item.manipulator)}),e.manipulators.on("change",()=>{this._manipulatorState.updateHoveredStateFromKnownPointers(this.tools)})],Py)}this._manipulatorState.updateHoveredStateFromKnownPointers(this.tools)}_updateToolEditableFlag(e){e.setEditableFlag?.(1,this.activeTool==null||e===this.activeTool)}_removeIncompleteTools(e){this.tools.filter(t=>(e==null||t!==e)&&!t.created&&t.removeIncompleteOnCancel).forEach(t=>{this.tools.remove(t)})}get test(){}};h([d({constructOnly:!0,nonNullable:!0})],jn.prototype,"view",void 0),h([d({value:null})],jn.prototype,"activeTool",null),h([d({readOnly:!0,type:Mt})],jn.prototype,"tools",void 0),h([d()],jn.prototype,"cursor",null),h([d({readOnly:!0})],jn.prototype,"updating",null),h([d()],jn.prototype,"_interacting",void 0),h([d({readOnly:!0})],jn.prototype,"interacting",null),jn=h([D("esri.views.ToolViewManager")],jn);const U6=new wi("cyan"),H6=1,q6=.25,zM=new wi("black"),kM=.4,BM=.2,G6=.25,la="default",$6="temporary",W6=new wi("yellow"),Z6=8;var Hv;let as=Hv=class extends ie{constructor(e){super(e),this.name=la,this.color=U6.clone(),this.haloColor=null,this.haloOpacity=H6,this.fillOpacity=q6,this.shadowColor=zM.clone(),this.shadowOpacity=kM,this.shadowDifference=BM,this.haloWidth=2.1,this.haloBlur=.8/this.haloWidth}equals(e){return this.color.equals(e.color)&&(this.haloColor||this.color).equals(e.haloColor||e.color)&&this.haloOpacity===e.haloOpacity&&this.fillOpacity===e.fillOpacity&&this.haloWidth===e.haloWidth&&this.haloBlur===e.haloBlur&&this.shadowColor.equals(e.shadowColor)&&this.shadowOpacity===e.shadowOpacity&&this.shadowDifference===e.shadowDifference}clone(){return new Hv({...this,color:this.color.clone(),haloColor:this.haloColor?.clone(),shadowColor:this.shadowColor?.clone()})}assignFrom(e){this.color=e.color.clone(),this.haloColor=e.haloColor?.clone(),this.haloOpacity=e.haloOpacity,this.fillOpacity=e.fillOpacity,this.shadowColor=e.shadowColor.clone(),this.shadowDifference=e.shadowDifference,this.shadowOpacity=e.shadowOpacity,this.haloBlur=e.haloBlur,this.haloWidth=e.haloWidth}};h([d({type:String,constructOnly:!0,nonNullable:!0})],as.prototype,"name",void 0),h([d({type:wi,nonNullable:!0})],as.prototype,"color",void 0),h([d({type:wi})],as.prototype,"haloColor",void 0),h([d({nonNullable:!0})],as.prototype,"haloOpacity",void 0),h([d({nonNullable:!0})],as.prototype,"fillOpacity",void 0),h([d({type:wi,nonNullable:!0})],as.prototype,"shadowColor",void 0),h([d({nonNullable:!0})],as.prototype,"shadowOpacity",void 0),h([d({nonNullable:!0})],as.prototype,"shadowDifference",void 0),h([d({nonNullable:!0})],as.prototype,"haloWidth",void 0),h([d({nonNullable:!0})],as.prototype,"haloBlur",void 0),as=Hv=h([D("esri.views.support.HighlightOptions")],as);const Ql=as;function Q6(){return new(Mt.ofType(Ql))([new Ql({name:la}),new Ql({name:$6,color:W6})])}let sh=class extends ie{constructor(e){super(),this.nativeIndex=null,this._detectedDeviceType="unknown",e.mapping==="standard"?this._detectedDeviceType="standard":X6.test(e.id)?this._detectedDeviceType="spacemouse":this._detectedDeviceType="unknown",this.nativeIndex=e.index}get native(){const e=navigator.getGamepads?navigator.getGamepads():[];return this.nativeIndex!=null&&this.nativeIndex<e.length?e[this.nativeIndex]:null}get deviceType(){return this._detectedDeviceType}get axisThreshold(){return Y6[this.deviceType]}};h([d({nonNullable:!0,readOnly:!0})],sh.prototype,"nativeIndex",void 0),h([d({type:String,readOnly:!0})],sh.prototype,"deviceType",null),h([d({type:Number,readOnly:!0})],sh.prototype,"axisThreshold",null),sh=h([D("esri.views.input.gamepad.GamepadInputDevice")],sh);const nb=sh,X6=new RegExp("^(3dconnexion|space(mouse|navigator|pilot|explorer))","i"),Y6={standard:.15,spacemouse:.025,unknown:0};let ad=class extends ie{constructor(e){super(e),this.devices=new Mt,this.enabledFocusMode="document"}};h([d({type:Mt.ofType(nb),readOnly:!0})],ad.prototype,"devices",void 0),h([d({type:["document","view","none"]})],ad.prototype,"enabledFocusMode",void 0),ad=h([D("esri.views.input.gamepad.GamepadSettings")],ad);const K6=ad;let Lf=class extends ie{constructor(){super(...arguments),this.gamepad=new K6}};h([d({readOnly:!0})],Lf.prototype,"gamepad",void 0),Lf=h([D("esri.views.input.Input")],Lf);const J6=Lf,My=()=>d({type:["pan","rotate","zoom","none"],nonNullable:!0});let gl=class extends ie{constructor(e){super(e),this.dragPrimary="pan",this.dragSecondary="rotate",this.dragTertiary="zoom",this.mouseWheel="zoom"}};h([My()],gl.prototype,"dragPrimary",void 0),h([My()],gl.prototype,"dragSecondary",void 0),h([My()],gl.prototype,"dragTertiary",void 0),h([d({type:["zoom","none"],nonNullable:!0})],gl.prototype,"mouseWheel",void 0),gl=h([D("esri.views.navigation.NavigationActionMap")],gl);const NM=gl;let fo=class extends ie{constructor(e){super(e),this.enabled=!0,this.device=null,this.mode="pan",this.tiltDirection="forward-down",this.velocityFactor=1}};h([d({type:Boolean,nonNullable:!0})],fo.prototype,"enabled",void 0),h([d({type:nb})],fo.prototype,"device",void 0),h([d({type:["pan","zoom"],nonNullable:!0})],fo.prototype,"mode",void 0),h([d({type:["forward-down","forward-up"],nonNullable:!0})],fo.prototype,"tiltDirection",void 0),h([d({type:Number,nonNullable:!0})],fo.prototype,"velocityFactor",void 0),fo=h([D("esri.views.navigation.gamepad.GamepadSettings")],fo);const jM=fo;let go=class extends ie{constructor(e){super(e),this.actionMap=new NM,this.browserTouchPanEnabled=!0,this.gamepad=new jM,this.momentumEnabled=!0}get mouseWheelZoomEnabled(){return this.actionMap.mouseWheel==="zoom"}set mouseWheelZoomEnabled(e){vA($.getLogger(this),"mouseWheelZoomEnabled",{replacement:"actionMap.mouseWheel",version:"4.32",warnOnce:!0}),this.actionMap.mouseWheel=e?"zoom":"none"}};h([d({type:NM,nonNullable:!0})],go.prototype,"actionMap",void 0),h([d({type:Boolean})],go.prototype,"browserTouchPanEnabled",void 0),h([d({type:jM,nonNullable:!0})],go.prototype,"gamepad",void 0),h([d({type:Boolean})],go.prototype,"momentumEnabled",void 0),h([d({type:Boolean})],go.prototype,"mouseWheelZoomEnabled",null),go=h([D("esri.views.navigation.Navigation")],go);const UM=go;function bre(e,t,i){const r=HM(e),s=t,n=e7(r,s,i);if(r){const a=jp.deriveUnitFromSR(r,e.spatialReference).heightUnit;if(!i&&a!==r.heightUnit){const o=new fe("layerview:unmatched-height-unit",`The vertical units of the layer must match the horizontal units (${a})`,{horizontalUnit:a});return new fe("layerview:unsupported-height-model-info","The vertical coordinate system of the layer is not supported",{heightModelInfo:r,error:o})}}if(!t7(e)||n===4)return new fe("layerview:unsupported-height-model-info","The vertical coordinate system of the layer is not supported",{heightModelInfo:r});switch(n){case 1:{const a=r?.heightUnit||"unknown",o=s?.heightUnit||"unknown",l=new fe("layerview:incompatible-height-unit",`The vertical units of the layer (${a}) must match the vertical units of the scene (${o})`,{layerUnit:a,sceneUnit:o});return new fe("layerview:incompatible-height-model-info","The vertical coordinate system of the layer is incompatible with the scene",{layerHeightModelInfo:r,sceneHeightModelInfo:s,error:l})}case 2:{const a=r?.heightModel||"unknown",o=s?.heightModel||"unknown",l=new fe("layerview:incompatible-height-model",`The height model of the layer (${a}) must match the height model of the scene (${o})`,{layerHeightModel:a,sceneHeightModel:o});return new fe("layerview:incompatible-height-model-info","The vertical coordinate system of the layer is incompatible with the scene",{layerHeightModelInfo:r,sceneHeightModelInfo:s,error:l})}case 3:{const a=r?.vertCRS||"unknown",o=s?.vertCRS||"unknown",l=new fe("layerview:incompatible-vertical-datum",`The vertical datum of the layer (${a}) must match the vertical datum of the scene (${o})`,{layerDatum:a,sceneDatum:o});return new fe("layerview:incompatible-height-model-info","The vertical coordinate system of the layer is incompatible with the scene",{layerHeightModelInfo:r,sceneHeightModelInfo:s,error:l})}}return null}function e7(e,t,i){if(!Ix(e)||!Ix(t))return 4;if(e==null||t==null)return 0;if(!i&&e.heightUnit!==t.heightUnit)return 1;if(e.heightModel!==t.heightModel)return 2;switch(e.heightModel){case"gravity-related-height":return 0;case"ellipsoidal":return e.vertCRS===t.vertCRS?0:3;default:return 4}}function Ix(e){return e==null||e.heightModel!=null&&e.heightUnit!=null}function t7(e){return"heightModelInfo"in e&&e.heightModelInfo!=null||e.spatialReference!=null||!$M(e)}function HM(e){if(e.type==="integrated-mesh-3dtiles"||e.type==="gaussian-splat")return null;const t=e.url?a9(e.url):void 0;return!(e.spatialReference?.vcsWkid==null&&t!=null&&t.serverType==="ImageServer")&&qM(e)&&e.heightModelInfo?e.heightModelInfo:$M(e)?jp.deriveUnitFromSR(r7,e.spatialReference):null}function qM(e){return"heightModelInfo"in e}function GM(e){if(e.type==="unknown"||!("capabilities"in e))return!1;switch(e.type){case"catalog":case"catalog-footprint":case"csv":case"feature":case"geojson":case"subtype-group":case"ogc-feature":case"oriented-imagery":case"wfs":case"knowledge-graph-sublayer":return!0;default:return!1}}function $M(e){return GM(e)?!!(e.capabilities&&e.capabilities.data&&e.capabilities.data.supportsZ):WM(e)}function i7(e){return e.layers!=null||WM(e)||GM(e)||qM(e)}function WM(e){switch(e.type){case"building-scene":case"elevation":case"integrated-mesh":case"integrated-mesh-3dtiles":case"point-cloud":case"scene":case"voxel":return!0;case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"catalog":case"catalog-footprint":case"catalog-dynamic-group":case"csv":case"dimension":case"gaussian-splat":case"geojson":case"feature":case"subtype-group":case"geo-rss":case"graphics":case"group":case"imagery":case"imagery-tile":case"kml":case"knowledge-graph":case"link-chart":case"knowledge-graph-sublayer":case"line-of-sight":case"map-image":case"map-notes":case"media":case"ogc-feature":case"open-street-map":case"oriented-imagery":case"parquet":case"route":case"stream":case"tile":case"unknown":case"unsupported":case"vector-tile":case"video":case"viewshed":case"wcs":case"web-tile":case"wfs":case"wms":case"wmts":case null:return!1}return!1}const r7=new jp({heightModel:"gravity-related-height"});let qv,Ry=null;async function s7(e){Ry||(Ry=k(()=>le(()=>import("./geometryServiceUtils-DZErnHX--BymfKu41.js"),__vite__mapDeps([237,3,6,1,2,7,8,4,9,10,238,26,27,19,20,14,89,94])),ue([167,1,4,5,6,7,8,2,9,10,168,27,28,19,20,14,90,95])).then(t=>qv=t)),await Ry,qe(e)}async function ZM(e,t,i,r){if(!e)return null;const s=e.spatialReference;return U9()||I4(s,t)?Up(e,t):qv?qv.projectGeometry(e,t,i,r):(await Promise.race([s7(r),H9(r)]),ZM(e,t,i,r))}async function wre(e,t){try{return e?.spatialReference?await Vo(e,t):null}catch{return null}}let Lt=class extends ie{constructor(e){super(e),this.required={extent:!1,heightModelInfo:!1,tileInfo:!1},this.defaultSpatialReference=null,this.userSpatialReference=null,this.sourcePreloadCount=10,this.priorityCollection=null,this.requiresExtentInSpatialReference=!0,this.suspended=!1,this._projectExtentTask={task:null,input:null,output:null,spatialReference:null}}destroy(){this._projectExtentTask.task&&(this._projectExtentTask.task=Ar(this._projectExtentTask.task)),this._set("map",null)}get ready(){return!this._spatialReferenceTask.updating&&!this._tileInfoTask.updating&&!this._extentTask.updating}get heightModelInfoReady(){return!this._heightModelInfoTask.updating}get spatialReference(){return this.userSpatialReference??this._spatialReferenceTask.spatialReference}get extent(){return this._extentTask.extent}get heightModelInfo(){return this._heightModelInfoTask.heightModelInfo}get vcsWkid(){return this._heightModelInfoTask.vcsWkid}get latestVcsWkid(){return this._heightModelInfoTask.latestVcsWkid}get viewingMode(){return this.userSpatialReference==null||this.userSpatialReference.equals(this._spatialReferenceTask.spatialReference)?this._spatialReferenceTask.viewingMode:null}get tileInfo(){return this._tileInfoTask.tileInfo}get mapCollections(){const e=this.map?.(),t=[];return this.priorityCollection!=null&&t.push(this.priorityCollection),t.push({parent:e?.basemap,layers:e?.basemap?.baseLayers},{parent:e?.basemap,layers:e?.basemap?.groundLayers},{layers:e?.layers},{parent:e?.ground,layers:e?.ground?.layers},{parent:e?.basemap,layers:e?.basemap?.referenceLayers}),t}get _spatialReferenceTask(){if(this.suspended)return this._get("_spatialReferenceTask")??{updating:!1};let e;if(this._collectLayers(this.mapCollections,i=>{const r=this._getSupportedSpatialReferences(i);if(r.length>0){const s=this._narrowDownSpatialReferenceCandidates(e,r);s!=null&&(e=s)}return e?.length===1})&&e?.length!==1)return{updating:!0};const t=this._pickSpatialReferenceCandidate(e);return{spatialReference:t?.spatialReference??null,viewingMode:t?.viewingMode??null,updating:!1}}get _tileInfoTask(){if(!this.required.tileInfo)return this._get("_tileInfoTask")??{updating:!1};const e=this.map?.(),t=this.spatialReference;if(!t)return{updating:this._spatialReferenceTask.updating};let i;const r=this._collectLayers([{parent:e?.basemap,layers:e?.basemap?.baseLayers},{parent:e?.basemap,layers:e?.basemap?.groundLayers},{layers:e?.layers}],s=>!(!("tileInfo"in s)||!s.tileInfo?.spatialReference.equals(t))&&(i=s,!0),s=>"tileInfo"in s);return i?{tileInfo:i.tileInfo,updating:!1}:{updating:r}}get _heightModelInfoTask(){if(!this.required.heightModelInfo||this.suspended&&this._get("_heightModelInfoTask")?.heightModelInfo)return this._get("_heightModelInfoTask")??{updating:!1};let e={};const t=this._collectLayers(this.mapCollections,i=>{const r=HM(i);return!!r&&(e={heightModelInfo:r,vcsWkid:i.spatialReference?.vcsWkid,latestVcsWkid:i.spatialReference?.latestVcsWkid},!0)},i=>i7(i));return{...e,updating:t}}get _extentCandidatesTask(){if(this.suspended||!this.required.extent)return this._get("_extentCandidatesTask")??{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const e=[],t=this._collectLayers(this.mapCollections,i=>{const r="fullExtents"in i&&i.fullExtents||(i.fullExtent!=null?[i.fullExtent]:[]),s=this.requiresExtentInSpatialReference?null:r[0],n=r.find(a=>a.spatialReference.equals(this.spatialReference))??s;if(n)return e.push({extent:n,layer:i}),!0;if(this._getSupportedSpatialReferences(i).length>0)for(const a of r)e.push({extent:a,layer:i});return!1});return{candidates:e,updating:t}}get _extentTask(){const{candidates:e,updating:t}=this._extentCandidatesTask;if(t)return{updating:t};if(e==null||e.length===0)return{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const i=this._pickExtentCandidate(e),r=this.spatialReference;return i.extent.equals(this._projectExtentTask.input)&&r.equals(this._projectExtentTask.spatialReference)?{extent:this._projectExtentTask.output,updating:this._projectExtentTask.task!=null&&!this._projectExtentTask.task.finished}:(this._projectExtentTask.task!=null&&(this._projectExtentTask.task=Ar(this._projectExtentTask.task)),this._projectExtentTask={input:i.extent.clone(),output:null,spatialReference:r.clone(),task:Ya(async s=>{try{const n=await ZM(i.extent,r,"portalItem"in i.layer?i.layer.portalItem:void 0,s);this._projectExtentTask={...this._projectExtentTask,task:null,output:n}}catch{if(Gl(s))return;this._projectExtentTask={...this._projectExtentTask,task:null}}})},{updating:!0})}_narrowDownSpatialReferenceCandidates(e,t){if(e==null)return t;const i=new Array;for(const r of e)for(const s of t){if(!r.spatialReference.equals(s.spatialReference))continue;const n=a7(r.viewingMode,s.viewingMode);if(n!==!1){i.push({spatialReference:r.spatialReference,viewingMode:n});break}}return i.length>0?i:null}_pickSpatialReferenceCandidate(e){const t=this.defaultSpatialReference;return e==null||e.length<1?t?{spatialReference:t,viewingMode:null}:null:(t!=null&&e.length>1&&e.some(({spatialReference:i})=>i.equals(t))&&(e=e.filter(({spatialReference:i})=>i.equals(t))),e.length>1&&e.some(({viewingMode:i})=>i!==2)&&(e=e.filter(({viewingMode:i})=>i!==2)),e[0])}_getSupportedSpatialReferences(e){const t="supportedSpatialReferences"in e&&e.supportedSpatialReferences||(e.spatialReference?[e.spatialReference]:[]);if(t.length===0)return[];const i=[];for(const r of t){const s=this.getSpatialReferenceSupport(r,e);if(s!=null){const n=s.constraints??[{spatialReference:r,viewingMode:null}];for(const{spatialReference:a,viewingMode:o}of n)this.requiresExtentInSpatialReference&&this.userSpatialReference!=null&&!a.equals(this.userSpatialReference)||i.push({spatialReference:a,viewingMode:o})}}return i}_pickExtentCandidate(e){const t=this.spatialReference;return e.find(({extent:i})=>t.equals(i.spatialReference))||e[0]}_collectLayers(e,t,i=()=>!0){switch(this._loadMaybe(this.map?.())){case"loading":return!0;case"failed":return!1}const r=new n7(i,t);for(const s of e)if(this._collectCollection(s,r),r.done||r.preloading===this.sourcePreloadCount)break;return r.updating}_collectCollection(e,t){if(e.layers){switch(this._loadMaybe(e.parent)){case"loading":return t.updating=!0,void++t.preloading;case"failed":return}for(const i of e.layers)if((i.type!=="graphics"||!i.internal)&&t.layerFilter(i)){switch(this._loadMaybe(i)){case"failed":continue;case"loading":t.updating=!0,++t.preloading;break;case"loaded":if(t.updating||(t.done=t.pushLayer(i)),t.done||t.preloading===this.sourcePreloadCount)break;"layers"in i&&this._collectCollection({layers:i.layers},t)}if(t.done||t.preloading===this.sourcePreloadCount)break}}}_loadMaybe(e){return e&&"loadStatus"in e&&e.loadStatus!=null?e.loadStatus==="not-loaded"?(e.load().catch(t=>{js(t)}),"loading"):e.loadStatus:"loaded"}};h([d()],Lt.prototype,"required",void 0),h([d({constructOnly:!0})],Lt.prototype,"map",void 0),h([d({constructOnly:!0})],Lt.prototype,"getSpatialReferenceSupport",void 0),h([d()],Lt.prototype,"defaultSpatialReference",void 0),h([d()],Lt.prototype,"userSpatialReference",void 0),h([d()],Lt.prototype,"sourcePreloadCount",void 0),h([d()],Lt.prototype,"priorityCollection",void 0),h([d()],Lt.prototype,"requiresExtentInSpatialReference",void 0),h([d()],Lt.prototype,"suspended",void 0),h([d({readOnly:!0})],Lt.prototype,"ready",null),h([d({readOnly:!0})],Lt.prototype,"heightModelInfoReady",null),h([d({readOnly:!0})],Lt.prototype,"spatialReference",null),h([d({readOnly:!0})],Lt.prototype,"extent",null),h([d({readOnly:!0})],Lt.prototype,"heightModelInfo",null),h([d({readOnly:!0})],Lt.prototype,"vcsWkid",null),h([d({readOnly:!0})],Lt.prototype,"latestVcsWkid",null),h([d({readOnly:!0})],Lt.prototype,"viewingMode",null),h([d({readOnly:!0})],Lt.prototype,"tileInfo",null),h([d({readOnly:!0})],Lt.prototype,"mapCollections",null),h([d({readOnly:!0})],Lt.prototype,"_spatialReferenceTask",null),h([d({readOnly:!0})],Lt.prototype,"_tileInfoTask",null),h([d({readOnly:!0})],Lt.prototype,"_heightModelInfoTask",null),h([d({readOnly:!0})],Lt.prototype,"_extentCandidatesTask",null),h([d()],Lt.prototype,"_extentTask",null),h([d()],Lt.prototype,"_projectExtentTask",void 0),Lt=h([D("esri.views.support.DefaultsFromMap")],Lt);let n7=class{constructor(e,t){this.layerFilter=e,this.pushLayer=t,this.preloading=-1,this.updating=!1,this.done=!1}};function a7(e,t){return e!=null?t!=null?e===t&&e:e:t}function o7(e){return"tryRecycleWith"in e}let l7=class{constructor(e,t,i){this.layer=e,this.view=t,this.layerViewImporter=i,this._controller=new AbortController,this._started=!1,this.done=!1,this._deferred=aa(),this.promise=this._deferred.promise,Ao(this._controller.signal,()=>{this._recycleController?.abort();const r=new fe("cancelled:layerview-create","layerview creation cancelled",{layer:e});this._deferred?.reject(r)})}tryRecycle(e){if(!this.done||!this.layerView||!o7(this.layerView))return null;this._recycleController?.abort(),this._recycleController=new AbortController;const t=this.layer.type,i=this._recycleController.signal;for(let r=0;r<e.length;r++){const s=e[r];if(s.type!==t)continue;const n=this.layerView.tryRecycleWith(s,{signal:i});if(n){e.splice(r,1),this.layer=s;const a=this.layerView,o=a.view;return this.promise=n.then(()=>(qe(i),s.emit("layerview-destroy",{view:o,layerView:a}),o.emit("layerview-destroy",{view:o,layerView:a}),s.emit("layerview-create",{view:o,layerView:a}),o.emit("layerview-create",{view:o,layerView:a}),a)),this.promise}}return null}destroy(){this._controller.abort();const{layerView:e}=this;if(e){const{layer:t,view:i}=this;t.emit("layerview-destroy",{view:i,layerView:e}),i.emit("layerview-destroy",{layer:t,layerView:e})}this.done=!0,this.layer=null,this.layerView=null,this.view=null,this.layerViewImporter=null,this._map=null,this.promise=null,this._deferred=null}async start(){const{view:e}=this;if(this._started||!e.map)return;this._started=!0;const{_controller:{signal:t},layer:i}=this;this._map=e.map;try{let r,s;if(await i.load({signal:t}),i.prefetchResources&&await i.prefetchResources({signal:t}),c7(i))r=await i.createLayerView(e,{signal:t});else{if(!this.layerViewImporter.hasLayerViewModule(i))throw new fe("layer:view-not-supported","No layerview implementation was found");const a=await this.layerViewImporter.importLayerView(i);qe(t),r="default"in a?new a.default({layer:i,view:e}):new a({layer:i,view:e})}const n=()=>{s=xi(s),r.destroyed||r.destroy(),this.done=!0};s=Ao(t,n),qe(t);try{await r.when()}catch(a){throw n(),a}if(!this._map?.allLayers?.includes(i))return n(),void this._deferred?.reject(new fe("view:no-layerview-for-layer","The layer has been removed from the map",{layer:i}));this.layerView=r,i.emit("layerview-create",{view:e,layerView:r}),e.emit("layerview-create",{layer:i,layerView:r}),this.done=!0,this._deferred?.resolve(r)}catch(r){i.emit("layerview-create-error",{view:e,error:r}),e.emit("layerview-create-error",{layer:i,error:r}),this.done=!0,this._deferred?.reject(new fe("layerview:create-error","layerview creation failed",{layer:i,error:r}))}}};function c7(e){return e.createLayerView!==RI.prototype.createLayerView}function h7(e){return e!=null&&typeof e=="object"&&"layerViews"in e}let Ur=class extends ie{constructor(e){super(e),this._layerLayerViewInfoMap=new Map,this._recyclingInfoMap=new Map,this._watchUpdatingTracking=new dc,this.supportsGround=!0,this._preloadLayerViewModules=()=>{const t=this.view.map?.allLayers;if(t)for(const i of t)this.layerViewFilter?.(i)!==!1&&this.layerViewImporter.hasLayerViewModule(i)&&this.layerViewImporter.importLayerView(i)},this._reschedule=()=>this.destroyed?Promise.reject():(this._workPromise==null&&(this._workPromise=aa(),this._workPromise.promise.catch(()=>{})),this.removeHandles("reschedule"),this.addHandles(BP(this._doWork),"reschedule"),this._workPromise.promise),this._doWork=()=>{if(this.destroyed)return;const{map:t}=this.view;if(!t)return void this.clear();if(this._map!==t&&(this.clear(),this._map=t),this._workPromise==null)return void this.notifyChange("updating");this.removeHandles("reschedule"),this.removeHandles("collection-change");const i=new Set,r=[],s=this.view.ready,n=c=>{if(c!=null){for(const u of c)if(u){if(this.layerViewFilter?.(u)===!1)continue;i.add(u);const p=this._layerLayerViewInfoMap.get(u);p&&s?p.start():p||this._recyclingInfoMap.has(u)||r.push(u),"layers"in u&&u.layers&&n(u.layers)}}};for(const c of this._rootCollectionNames)n(rm(this,c));const a=new Array,o=c=>{const u=c.tryRecycle(r);u?(this._recyclingInfoMap.set(c.layer,c),this.notifyChange("updating"),u.then(()=>{this._recyclingInfoMap.delete(c.layer),this._layerLayerViewInfoMap.set(c.layer,c),this._reschedule(),this.notifyChange("updating")}).catch(p=>{js(p)||(this._recyclingInfoMap.delete(c.layer),c.destroy(),this._reschedule(),this.notifyChange("updating"))})):a.push(c)};for(const c of this._layerLayerViewInfoMap.values())i.has(c.layer)||(this._layerLayerViewInfoMap.delete(c.layer),o(c));for(const c of this._recyclingInfoMap.values())i.has(c.layer)||(this._recyclingInfoMap.delete(c.layer),o(c));for(const c of r)this._createLayerView(c);this._refreshCollections(),a.forEach(c=>c.destroy());const l=[t?.ground?.layers,t?.basemap?.baseLayers,t?.basemap?.groundLayers,t?.basemap?.referenceLayers,t?.layers].filter(c=>!!c);i.forEach(c=>"layers"in c&&l.push(c.layers)),this.addHandles(l.map(c=>this._watchUpdatingTracking.addOnCollectionChange(()=>c,this._reschedule)),"collection-change"),this._workPromise.resolve(),this._workPromise=null},this._layersToLayerViews=new Map(e.layerviewMapping)}initialize(){this.addHandles([Ir(()=>this.view?.map?.allLayers,"change",this._preloadLayerViewModules,{onListenerAdd:this._preloadLayerViewModules}),M(()=>{const e=this.view,t=e?.map;return[t?.basemap,t?.ground,t?.layers,e?.ready]},()=>this._reschedule(),Ve)]),this._preloadLayerViewModules(),this._reschedule()}clearHandles(){this._watchUpdatingTracking.removeAll()}destroy(){this.clear(),am(this._recyclingInfoMap),am(this._layerLayerViewInfoMap),this._watchUpdatingTracking.destroy(),this._map=null,this._workPromise!=null&&(this._workPromise.reject(Ui()),this._workPromise=null)}get _rootCollectionNames(){return Array.from(this._layersToLayerViews.keys())}get updating(){return this._workPromise!=null||this._watchUpdatingTracking.updating||fn(this._layerLayerViewInfoMap,e=>!e.done)||this._recyclingInfoMap.size>0}get updatingRemaining(){let e=0;for(const t of this._layerLayerViewInfoMap.values())t.done||++e;return e}clear(){this.destroyed||(this._clearCollections(),am(this._layerLayerViewInfoMap),am(this._recyclingInfoMap))}async whenLayerView(e){await this._reschedule();const t=this._layerLayerViewInfoMap.get(e)?.promise;if(!t){const i=this._recyclingInfoMap.get(e)?.promise;if(!i)throw new fe("view:no-layerview-for-layer","No layerview has been found for the layer",{layer:e});return i}return t}isCreatingLayerViewsForLayer(e,t){this.commitProperty("updatingRemaining");const i=this._layerLayerViewInfoMap.get(e);if(!i?.done)return!0;const r=i.layerView;return!(!r||!t||r.parent===t)||!!(i.done&&r&&"layers"in e&&e.layers?.length)&&e.layers.some(s=>this.isCreatingLayerViewsForLayer(s,r))}_refreshCollections(){for(const[e,t]of this._layersToLayerViews)this._populateLayerViewsOwners(rm(this,e),rm(this,t),this.view);this.notifyChange("updating"),this.notifyChange("updatingRemaining")}_clearCollections(){for(const e of this._layersToLayerViews.values())rm(this,e)?.removeAll()}_populateLayerViewsOwners(e,t,i){if(!e||!t)return void t?.removeAll();let r=0;for(const s of e){const n=this._layerLayerViewInfoMap.get(s);if(!n?.layerView)continue;const{layerView:a}=n;a.layer=s,a.parent=i,t.at(r)!==a&&t.splice(r,0,a),"layers"in s&&h7(a)&&this._populateLayerViewsOwners(s.layers,a.layerViews,a),++r}r<t.length&&t.splice(r)}_createLayerView(e){e.load().catch(()=>{}),this.layerViewImporter.hasLayerViewModule(e)&&this.layerViewImporter.importLayerView(e);const t=new l7(e,this.view,this.layerViewImporter);t.promise?.then(()=>this._refreshCollections(),i=>{i&&(js(i)||i.name==="cancelled:layerview-create")||$.getLogger(this).error(`Failed to create layerview for layer title:'${e.title??"no title"}', id:'${e.id??"no id"}' of type '${e.type}'.`,{layer:e,error:i}),this.destroyed||this._refreshCollections()}),this._layerLayerViewInfoMap.set(e,t),this.view.ready&&t.start(),this.notifyChange("updating"),this.notifyChange("updatingRemaining")}};h([d()],Ur.prototype,"_workPromise",void 0),h([d({readOnly:!0})],Ur.prototype,"_watchUpdatingTracking",void 0),h([d({readOnly:!0})],Ur.prototype,"_layersToLayerViews",void 0),h([d({constructOnly:!0})],Ur.prototype,"layerviewMapping",void 0),h([d({readOnly:!0})],Ur.prototype,"_rootCollectionNames",null),h([d({constructOnly:!0})],Ur.prototype,"layerViewFilter",void 0),h([d()],Ur.prototype,"layerViewImporter",void 0),h([d()],Ur.prototype,"supportsGround",void 0),h([d({readOnly:!0})],Ur.prototype,"updating",null),h([d({readOnly:!0})],Ur.prototype,"updatingRemaining",null),h([d({constructOnly:!0})],Ur.prototype,"view",void 0),Ur=h([D("esri.views.support.LayerViewManager")],Ur);const u7=Ur;let nh=class extends ie{constructor(e){super(e),this.featureTitleFields=!1,this.utilityNetworkFields=!1,this.globalIdField=!1}};h([d()],nh.prototype,"featureTitleFields",void 0),h([d()],nh.prototype,"utilityNetworkFields",void 0),h([d()],nh.prototype,"globalIdField",void 0),nh=h([D("esri.views.support.RequiredFieldsOptions")],nh);const d7=nh;var ah;let oe=class extends O_(D4){static{ah=this}constructor(e){super(e),this._userSpatialReference=null,this.handles=new C_,this.updatingHandles=new dc,this.allLayerViews=new q4({getCollections:()=>this.layerviewCollections,getChildrenFunction:p7}),this.analyses=new su,this.basemapView=null,this.dependencies={popup:void 0},this.displayFilterEnabled=!0,this.fatalError=null,this.graphics=new E4,this.typeSpecificPreconditionsReady=!0,this.layerViews=new Mt,this.magnifier=new DM,this.padding={left:0,top:0,right:0,bottom:0},this.ready=!1,this._readyStateWaitingTask=null,this.type=null,this.scale=null,this.updating=!1,this.initialExtentRequired=!0,this._lowPriorityCursorHandles=new Mt,this._highPriorityCursorHandles=new Mt,this.input=new J6,this.navigation=new UM,this.layerViewManager=null,this.analysisViewManager=null,this.isHeightModelInfoRequired=!1,this.width=null,this.height=null,this.resizing=!1,this.suspended=!1,this.viewEvents=new C6(this),this.persistableViewModels=new Mt,this.requiredFieldsOptions=new d7,this._isValid=!1,this._readyCycleForced=!1,this._lockedSpatialReference=null,this._userTimeZone=null,this._lockedTimeZone=null,this._userTimeExtent=null,this._lockedTimeExtent=null,this.theme=null,this.handles.add(M(()=>this.preconditionsReady,t=>{const i=this.ready;if(t?(this._lockedSpatialReference=this.spatialReference,this._lockedTimeZone=this.timeZone,this._lockedTimeExtent=this.timeExtent,ah.views.add(this)):(this._lockedSpatialReference=null,ah.views.remove(this)),this.notifyChange("spatialReference"),!t&&i)this.toolViewManager?.detach(),this.analysisViewManager?.detach(),this.layerViewManager?.clear(),this._teardown();else if(t&&!i){try{this._startup()}catch(r){return void queueMicrotask(()=>{this.fatalError=new fe("view:startup-error","View._startup failed",r)})}this.analysisViewManager?.attach(),this.toolViewManager.attach()}},Ie))}initialize(){this.addResolvingPromise(Promise.all([this.loadAsyncDependencies(),this._validateWithErrorDisplay()]).then(()=>(this._isValid=!0,lp(()=>this.ready)))),this.basemapView=new y6({view:this}),this.layerViewManager=new u7({view:this,layerViewFilter:e=>this.layerViewFilter?.(e)??!0,layerViewImporter:{importLayerView:e=>this.importLayerView(e),hasLayerViewModule:e=>this.hasLayerViewModule(e)},layerviewMapping:this._layerToLayerviewMapping}),this.toolViewManager=new jn({view:this}),this.selectionManager=new w6({view:this}),this.addHandles([Yr(()=>this.readyState==="map-content-error"&&!this.spatialReference,()=>{$.getLogger(this).warn("#spatialReference","no spatial reference could be derived from the currently added map layers")}),M(()=>this.initialExtentRequired,e=>this.defaultsFromMap.required={...this.defaultsFromMap.required,extent:e},Ve),M(()=>this.ready,e=>{this.defaultsFromMap&&(this.defaultsFromMap.suspended=e,this.defaultsFromMap.userSpatialReference=e?this.spatialReference:this._userSpatialReference)},Ie),M(()=>this._userSpatialReference,e=>{this.defaultsFromMap&&(this.defaultsFromMap.userSpatialReference=e)},Ve)])}get _layerToLayerviewMapping(){return ah._layerToLayerview}static{this._layerToLayerview=[["view.map.basemap.baseLayers","view.basemapView.baseLayerViews"],["view.map.basemap.groundLayers","view.basemapView.groundLayerViews"],["view.map.basemap.referenceLayers","view.basemapView.referenceLayerViews"],["view.map.layers","view.layerViews"]]}destroy(){this.destroyed||(ah.views.remove(this),this.viewEvents.destroy(),this.allLayerViews.destroy(),this.navigation&&(this.navigation.destroy(),this._set("navigation",null)),this.graphics=Z(this.graphics),this.analyses=Z(this.analyses),this.defaultsFromMap.destroy(),this._set("defaultsFromMap",null),this.analysisViewManager=Z(this.analysisViewManager),this.toolViewManager=Z(this.toolViewManager),this.layerViewManager=Z(this.layerViewManager),this.selectionManager=Z(this.selectionManager),this.basemapView=Z(this.basemapView),this.layerViews?.forEach(e=>e.destroy()),this.layerViews.length=0,this.invalidate(),this.handles.destroy(),this.map=Z(this.map),this.updatingHandles.destroy())}_startup(){this._set("ready",!0)}_teardown(){this._set("ready",!1)}whenReady(){return Promise.resolve(this)}toMap(){return $.getLogger(this).error("#toMap()","Not implemented on this instance of View"),null}get activeTool(){return this.toolViewManager?.activeTool}set activeTool(e){this.toolViewManager&&(this.toolViewManager.activeTool=e)}get layerviewCollections(){return[this.basemapView?.baseLayerViews,this.basemapView?.groundLayerViews,this.layerViews,this.basemapView?.referenceLayerViews]}get animation(){return this._get("animation")}set animation(e){this._set("animation",e)}get center(){return null}get defaultsFromMapSettings(){return{}}get defaultsFromMap(){return new Lt({required:{tileInfo:!1,heightModelInfo:!1,extent:!1},map:()=>this.map,getSpatialReferenceSupport:(e,t)=>this.getSpatialReferenceSupport(e,t),...this.defaultsFromMapSettings})}get extent(){return this._get("extent")}set extent(e){this._set("extent",e)}get heightModelInfo(){return this.getDefaultHeightModelInfo()}get highlights(){return this._get("highlights")??Q6()}set highlights(e){this._set("highlights",R4(e,this._get("highlights"),Mt.ofType(Ql)))}get interacting(){return this.navigating}get navigating(){return!1}get preconditionsReady(){return!this.destroying&&!this.destroyed&&!(this.fatalError||!this._isValid||this._readyCycleForced||!this.map||Xw(this.map)&&!this.map.loaded||this.width===0||this.height===0||!this.spatialReference||!this._validateSpatialReference(this.spatialReference)||!this._lockedSpatialReference&&!this.defaultsFromMap?.ready||!this.typeSpecificPreconditionsReady)}get resolution(){return 0}set map(e){e!==this._get("map")&&(e?.destroyed&&($.getLogger(this).warn("#map","The provided map is already destroyed",{map:e}),e=null),Xw(e)&&e.load().catch(()=>{}),this.constructed&&!this.destroyed&&(this.forceReadyCycle(),this._lockedSpatialReference=null),this._set("map",e))}get readyState(){if(this.destroyed)return this._get("readyState");if(!this.map)return"missing-map";if("container"in this&&!this.container)return"missing-container";if(this.fatalError)return"rendering-error";if((this.defaultsFromMap?.ready??!1)&&!this.spatialReference){const e=!("loaded"in this.map)||this.map.loaded,t=this.map.ground.loaded,i=this.map.basemap?.loaded??!0;return e&&i&&t&&!this.map?.allLayers.length?"empty-map":(this._readyStateWaitingTask||(this._readyStateWaitingTask=Ya(r=>NP(Qe("view-readyState-waiting-delay"),null,r)),this.addHandles(this._readyStateWaitingTask),this.addHandles(this._readyStateWaitingTask,"ready-state-task")),this._readyStateWaitingTask?.finished?"map-content-error":"loading")}return this._readyStateWaitingTask=Ar(this._readyStateWaitingTask),this.removeHandles("ready-state-task"),this.ready?"ready":"loading"}get spatialReference(){const e=this._userSpatialReference||this._lockedSpatialReference||this.getDefaultSpatialReference()||null;if(e&&this.defaultsFromMap?.required?.heightModelInfo){const t=e.clone();return t.vcsWkid=this.defaultsFromMap.vcsWkid,t.latestVcsWkid=this.defaultsFromMap.latestVcsWkid,t}return e}set spatialReference(e){const t=!rc(e,this._get("spatialReference"));this._set("_userSpatialReference",e),t&&(this._set("spatialReference",e),this._spatialReferenceChanged(e))}_spatialReferenceChanged(e){}get stationary(){return!this.animation&&!this.navigating&&!this.resizing}get timeExtent(){return this._userTimeExtent??this._lockedTimeExtent??this.getDefaultTimeExtent()??null}set timeExtent(e){this._userTimeExtent=e}get timeZone(){return this._userTimeZone??this._lockedTimeZone??this.getDefaultTimeZone()??MI}set timeZone(e){this._userTimeZone=e,OI(e)||$.getLogger(this).warn("#timeZone",`the parsed value '${e}' may not be a valid IANA time zone`)}get tools(){return this.toolViewManager?.tools}get initialExtent(){return this.defaultsFromMap?.extent}get cursor(){return this.toolViewManager?.cursor??this._highPriorityCursorHandles.at(-1)?.cursor??this._lowPriorityCursorHandles.at(-1)?.cursor??"default"}acquireCursor(e,t="low"){const i=t==="high"?this._highPriorityCursorHandles:this._lowPriorityCursorHandles,r={cursor:e},s=Sn(()=>i.remove(r));return i.add(r),this.addHandles(s),s}get size(){return[this.width,this.height]}get effectiveTheme(){return this.theme??new Nv}whenLayerView(e){return this.layerViewManager?.whenLayerView(e)??Promise.reject()}getDefaultSpatialReference(){return this.defaultsFromMap?.spatialReference}getDefaultHeightModelInfo(){return(this.map&&"heightModelInfo"in this.map?this.map.heightModelInfo:void 0)??this.defaultsFromMap?.heightModelInfo??null}getDefaultTimeZone(){return null}getDefaultTimeExtent(){return null}getSurface(){return null}importLayerView(e){throw new fe("view:importLayerView-missing","importLayerView() not implemented")}hasLayerViewModule(e){return!1}async validate(){}async loadAsyncDependencies(){}invalidate(){this._isValid=!1}getSpatialReferenceSupport(){return{constraints:null}}_validateSpatialReference(e){return this.getSpatialReferenceSupport(e)!=null}when(e,t){return this.isResolved()&&!this.ready&&$.getLogger(this).warn("#when()","Calling view.when() while the view is no longer ready but was already resolved once will resolve immediately. Use reactiveUtils.whenOnce(() => view.ready).then(...) instead."),super.when(e,t)}forceReadyCycle(){this.ready&&(Yr(()=>this.destroyed||this.preconditionsReady===!1,()=>this._readyCycleForced=!1,{once:!0}),this._readyCycleForced=!0)}on(e,t){return super.on(e,t)}addAndActivateTool(e){this.toolViewManager.tools.add(e),this.activeTool=e}tryFatalErrorRecovery(){this.fatalError=null}static{this.views=new Mt}async _validateWithErrorDisplay(){try{await this.validate()}catch(e){const t=document.createElement("div");t.setAttribute("style","display: flex; flex-direction: column; gap: 8px; padding: 20px; height: 100%; justify-content: center; color: black; background: white; font-family: sans-serif;");const i=document.createElement("div");i.innerHTML="Unable to display map. WebGL2 support is required.",i.setAttribute("style","font-size: 24px; font-weight: bold;");const r=document.createElement("div");r.innerHTML="Ensure that your browser and hardware meet the minimum requirements.",r.setAttribute("style","font-size: 18px;");const s=document.createElement("a");s.innerHTML="https://esriurl.com/webgl-faq",s.target="_blank",s.setAttribute("style","font-size: 18px;"),s.href="https://esriurl.com/webgl-faq",t.appendChild(i),t.appendChild(r),t.appendChild(s);const n=this.getSurface();throw n&&n.appendChild(t),e}}};h([d()],oe.prototype,"_userSpatialReference",void 0),h([d()],oe.prototype,"activeTool",null),h([d({readOnly:!0})],oe.prototype,"allLayerViews",void 0),h([d({readOnly:!0})],oe.prototype,"layerviewCollections",null),h([d(Dv(su,"analyses"))],oe.prototype,"analyses",void 0),h([d()],oe.prototype,"animation",null),h([d()],oe.prototype,"basemapView",void 0),h([d()],oe.prototype,"center",null),h([d()],oe.prototype,"defaultsFromMapSettings",null),h([d()],oe.prototype,"defaultsFromMap",null),h([d()],oe.prototype,"dependencies",void 0),h([d()],oe.prototype,"displayFilterEnabled",void 0),h([d({type:sr})],oe.prototype,"extent",null),h([d()],oe.prototype,"fatalError",void 0),h([d(Dv(E4,"graphics"))],oe.prototype,"graphics",void 0),h([d({readOnly:!0,type:jp})],oe.prototype,"heightModelInfo",null),h([d({type:Mt.ofType(Ql)})],oe.prototype,"highlights",null),h([d({readOnly:!0})],oe.prototype,"interacting",null),h([d({constructOnly:!0})],oe.prototype,"layerViewFilter",void 0),h([d({readOnly:!0})],oe.prototype,"navigating",null),h([d({readOnly:!0,dependsOn:["fatalError","_isValid","_readyCycleForced","map","map.loaded?","width","height","spatialReference","_lockedSpatialReference","defaultsFromMap.ready","typeSpecificPreconditionsReady"]})],oe.prototype,"preconditionsReady",null),h([d({readOnly:!0})],oe.prototype,"typeSpecificPreconditionsReady",void 0),h([d({type:Mt,readOnly:!0})],oe.prototype,"layerViews",void 0),h([d()],oe.prototype,"resolution",null),h([d({type:DM})],oe.prototype,"magnifier",void 0),h([d({value:null,type:PI})],oe.prototype,"map",null),h([d()],oe.prototype,"padding",void 0),h([d({readOnly:!0})],oe.prototype,"ready",void 0),h([d()],oe.prototype,"_readyStateWaitingTask",void 0),h([d({readOnly:!0})],oe.prototype,"readyState",null),h([d({type:At})],oe.prototype,"spatialReference",null),h([d()],oe.prototype,"stationary",null),h([d({type:DI})],oe.prototype,"timeExtent",null),h([d({type:String,nonNullable:!0})],oe.prototype,"timeZone",null),h([d()],oe.prototype,"tools",null),h([d()],oe.prototype,"toolViewManager",void 0),h([d({readOnly:!0})],oe.prototype,"type",void 0),h([d({type:Number})],oe.prototype,"scale",void 0),h([d({readOnly:!0})],oe.prototype,"updating",void 0),h([d({readOnly:!0})],oe.prototype,"initialExtentRequired",void 0),h([d({readOnly:!0})],oe.prototype,"initialExtent",null),h([d()],oe.prototype,"cursor",null),h([d({readOnly:!0})],oe.prototype,"input",void 0),h([d({type:UM,nonNullable:!0})],oe.prototype,"navigation",void 0),h([d()],oe.prototype,"layerViewManager",void 0),h([d()],oe.prototype,"analysisViewManager",void 0),h([d()],oe.prototype,"selectionManager",void 0),h([d()],oe.prototype,"width",void 0),h([d()],oe.prototype,"height",void 0),h([d({readOnly:!0})],oe.prototype,"resizing",void 0),h([d({value:null,readOnly:!0})],oe.prototype,"size",null),h([d({readOnly:!0})],oe.prototype,"suspended",void 0),h([d({readOnly:!0})],oe.prototype,"viewEvents",void 0),h([d({readOnly:!0})],oe.prototype,"persistableViewModels",void 0),h([d()],oe.prototype,"_isValid",void 0),h([d()],oe.prototype,"_readyCycleForced",void 0),h([d()],oe.prototype,"_lockedSpatialReference",void 0),h([d()],oe.prototype,"_userTimeZone",void 0),h([d()],oe.prototype,"_lockedTimeZone",void 0),h([d()],oe.prototype,"_userTimeExtent",void 0),h([d()],oe.prototype,"_lockedTimeExtent",void 0),h([d({type:Nv})],oe.prototype,"theme",void 0),h([d({readOnly:!0,type:Nv})],oe.prototype,"effectiveTheme",null),oe=ah=h([D("esri.views.View")],oe);const Dy=globalThis.$arcgis;Dy&&!Dy.views&&Object.defineProperty(Dy,"views",{configurable:!1,enumerable:!0,writable:!1,value:oe.views});const Lx=oe;function p7(e){return e.layerViews}let oh=class extends D4{constructor(e){super(e),this.state="running",this.target=null,this._resolver=null}initialize(){this._resolver=aa(),this.addResolvingPromise(this._resolver.promise)}get done(){return this.state==="finished"||this.state==="stopped"}stop(){this.state!=="stopped"&&this.state!=="finished"&&(this._set("state","stopped"),this._resolver?.reject(new fe("view:animation-stopped","ViewAnimation stopped")))}finish(){this.state!=="stopped"&&this.state!=="finished"&&(this._set("state","finished"),this._resolver?.resolve())}update(e,t){t||(t=Fp(e)?"waiting-for-target":"running"),this._set("target",e),this._set("state",t)}static{this.state={RUNNING:"running",STOPPED:"stopped",FINISHED:"finished",WAITING_FOR_TARGET:"waiting-for-target"}}};h([d({readOnly:!0})],oh.prototype,"done",null),h([d({readOnly:!0,type:String})],oh.prototype,"state",void 0),h([d()],oh.prototype,"target",void 0),oh=h([D("esri.views.ViewAnimation")],oh);const nu=oh;function Gv(e){return e==="global"?1:2}function Oy(e){return e===1?"global":"local"}let m7=class{constructor(e,t=null,i=0){this.array=e,this.spatialReference=t,this.offset=i}};function QM(e){return"array"in e}function Jn(e,t,i="ground"){if(B4(t))return e.getElevation(t.x,t.y,t.z||0,t.spatialReference,i);if(QM(t)){let r=t.offset;return e.getElevation(t.array[r++],t.array[r++],t.array[r]||0,t.spatialReference??e.spatialReference,i)}return e.getElevation(t[0],t[1],t[2]||0,e.spatialReference,i)}function $v(e,t){return e!=null&&(t==null||(t===2?!e.isGeographic||e.isWGS84||e.wkid===4490:e.isWebMercator||e.isWGS84||e.wkid===4490||e.wkid===104971||e.wkid===104905||e.wkid===104903))}const ab=()=>$.getLogger("esri.views.3d.support.cameraUtils"),XM=96*39.37,Wv=1,f7=8,g7=5,YM=1,$d=w();function mc(e){return e.spatialReference??At.WGS84}function _7(e,t,i,r,s){return du(e).headingTiltToDirectionUp(t,i,r,s)}function bp(e,t){const{camera:i}=e.state,{unitInMeters:r}=e.renderCoordsHelper;return t/=r,i.width/2/i.pixelRatio/(XM/t)/Math.tan(i.fovX/2)}function oc(e,t){const{camera:i}=e.state,{unitInMeters:r}=e.renderCoordsHelper,s=t*Math.tan(i.fovX/2),n=i.width/2/i.pixelRatio;return XM/(n/s)*r}function KM(e,t,i,r){const s=r.levelAtScale(t),n=JM(P_(e,i.eye,i.viewForward,i.up).tilt),a=Math.max(s-n,0);return r.scaleAtLevel(a)}function Fx(e,t,i){const r=i.levelAtScale(e),s=JM(t);return i.scaleAtLevel(r+s)}function JM(e){return 2*((e>90?180-e:e)/90)**2}function y7(e,t,i=0){const r=e.basemapTerrain?.tilingScheme;if(!r)return 0;const s=Yt(e.spatialReference).radius,n=e.state.viewingMode===2?t.eye[2]:ge(t.eye)-s;return KM(e,oc(e,Math.abs(n-i)),t,r)}function v7(e,t,i=0){const r=Qn(e,t);return r?y7(e,r,i):0}const b7=1,w7=100;function x7(e,t,i,r){if(t===0)return 0;const s=e.state.contentCamera,n=Gt(s.eye,i),a=e.basemapTerrain?.tilingScheme;if(!a)return ab().error("#scaleToTargetDistance()","Cannot compute distance from scale without a tiling scheme"),n;let o=n;const l=P_(e,s.eye,s.viewForward,s.up),c=l.tilt>90;if(e.state.isLocal){const g=(bp(e,Fx(t,l.tilt,a))-Math.abs(s.eye[2]-r[2]))/Math.cos(rt(l.tilt));return o=c?o-g:o+g,o}let u=1/0,p=0,m=wp(e,l.heading,l.tilt,i,n,1);if(!m)return o;const f=ge(r);for(;u>b7&&p<w7;){const g=ge(m.eye),y=c?180-m.tilt:m.tilt,v=rt(y),C=Math.sin(v)*g,b=Math.cos(v)*g,S=bp(e,Fx(t,m.tilt,a)),x=c?f-S:f+S,T=cp(C/x),P=Math.cos(T)*x-b,R=Gt(m.eye,i);o=c?R-P:R+P,m=wp(e,l.heading,l.tilt,i,o,1);const O=lb(e,m,sc(s.fov));if(!m||!O)return o;const E=v7(e,O,f-Yt(e.spatialReference).radius);u=Math.abs(t-E),++p}return o}async function C7(e,t,i,r,s,n){return k_(e,t,bp(e,i),r,s,n)}function S7(e,t,i,r,s,n){return lb(e,wp(e,r.heading,r.tilt,t,i,s),r.fov,n)}async function k_(e,t,i,r,s,n){const a=await tR(e,r.heading,r.tilt,t,i,s,n);return qe(n),pR(e,a,r.fov,n)}function eR(e,t){return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,$d,e.spatialReference)&&e.elevationProvider&&(Jn(e.elevationProvider,$d)??0)>$d[2]-YM)}async function T7(e,t,i){if(eR(e,t))return!0;const{elevationProvider:r,spatialReference:s,renderCoordsHelper:n}=e;if(r==null||!n.fromRenderCoords(t,$d,s))return!1;const[a,o,l]=$d,c=await r.queryElevation(a,o,l,s,"ground",i)??0;return qe(i),c>l-YM}async function P7(e,t,i){const r=w();if(t==null)return q(r,e.state.camera.center);if(t instanceof wt){const{renderSpatialReference:s,basemapTerrain:n,elevationProvider:a}=e,o=t.spatialReference;if(await Vg(t,r,s,0,{signal:i}),qe(i),t.z==null&&n!=null&&a!=null){const l=await a.queryElevation(t.x,t.y,t.z??0,o,"ground",i);qe(i),l!=null&&e.renderCoordsHelper.setAltitude(r,l)}return r}return q(r,t)}function M7(e,t){const i=w();if(t==null)return q(i,e.state.camera.center);if(t instanceof wt){if(!Ha(t,i,e.renderSpatialReference))return null;const{basemapTerrain:r,elevationProvider:s}=e;if(t.z==null&&r!=null&&s!=null){const n=Jn(s,t);n!=null&&e.renderCoordsHelper.setAltitude(i,n)}return i}return q(i,t)}function wp(e,t,i,r,s,n){return iR(e,t,i,r instanceof wt?r:null,M7(e,r),s,n)}async function tR(e,t,i,r,s,n,a){const o=r instanceof wt?r:null,l=await P7(e,r,a);return qe(a),rR(e,t,i,o,l,s,n,a)}function iR(e,t,i,r,s,n,a){if(s==null||!r&&(r=new wt({spatialReference:mc(e)}),!qp(s,e.renderSpatialReference,r)))return null;const o=sR(e,t,i,s,n,a);if(nR(e,i,a)&&eR(e,o.eye)){const{tilt:l,mode:c}=aR(e,i,s,n);return iR(e,t,l,r,s,n,c)}return oR(o,s)}async function rR(e,t,i,r,s,n,a,o){r||(r=new wt({spatialReference:mc(e)}),await U4(s,e.renderSpatialReference,r,{signal:o})||(r=null)),qe(o);const l=sR(e,t,i,s,n,a);if(nR(e,i,a)&&await T7(e,l.eye,o)){qe(o);const{tilt:c,mode:u}=aR(e,i,s,n);return rR(e,t,c,r,s,n,u,o)}return oR(l,s)}function sR(e,t,i,r,s,n){const a=O7(e,t,i,r,s=Math.max(s,e.state.constraints.minimumPoiDistance),n);return(0,du(e).eyeForCenterWithHeadingTilt)(r,s,a.heading,a.tilt)}function nR(e,t,i){const r=e.map.ground.navigationConstraint;return i===1&&e.state.isGlobal&&t>0&&(r==null||r.type==="stay-above")}function aR(e,t,i,r){const s=dR(e,i,r,A7(e,r,t,i));return{tilt:s,mode:t-s<1?0:1}}function oR(e,t){return{...e,center:Mn(t)}}function lR(e,t){const{state:i,spatialReference:r}=e,s=t.spatialReference;return i.isGlobal&&$v(s,1)||i.isLocal&&r.equals(s)}function cR(e,t){let i,r,s;if(e.state.isGlobal){const u=new wt(t.xmin,t.ymin,t.spatialReference),p=new wt(t.xmax,t.ymax,t.spatialReference),m=t.spatialReference.isGeographic?kI:BI;i=new wt({x:m.center(u.x,p.x),y:(p.y+u.y)/2,z:t.zmax!=null&&t.zmin!=null?(t.zmax+t.zmin)/2:void 0,spatialReference:t.spatialReference});const f=Yt(t.spatialReference),g=u8(i,u,p);r=g.lon,s=g.lat,m.diff(u.x,p.x)>m.range/2&&(r+=f.halfCircumference),r=Math.min(r,f.halfCircumference),s=Math.min(s,f.halfCircumference)}else{const u=e.renderSpatialReference??t.spatialReference;u.equals(t.spatialReference)||(t=Up(t,u)),r=t.xmax-t.xmin,s=t.ymax-t.ymin;const p=t.zmax!=null&&t.zmin!=null?(t.zmax+t.zmin)/2:void 0;i=new wt({x:t.xmin+.5*r,y:t.ymin+.5*s,z:p,spatialReference:u})}const n=t.zmax!=null&&t.zmin!=null?t.zmax-t.zmin:0,a=e.state.camera,o=1/Math.tan(a.fovX/2),l=1/Math.tan(a.fovY/2),c=1/Math.tan(a.fov/2);return{center:i,distance:Math.max(.5*r*o,.5*s*l,.5*n*c)/Wv}}async function hR(e,t,i,r,s,n){const a=lR(e,t)?t:await Vo(t,e.spatialReference,{signal:n});qe(n);const{center:o,distance:l}=cR(e,a),c=await tR(e,i,r,o,l,s,n);return qe(n),pR(e,c,e.camera.fov,n)}function Ff(e,t,i,r,s,n){let a;try{a=lR(e,t)?t:Up(t,e.spatialReference)}catch{return null}const{center:o,distance:l}=cR(e,a),c=wp(e,i,r,o,l,s);return c==null?null:lb(e,c,e.camera.fov,n)}function uR(e,t,i){const r=e.renderSpatialReference,s=new wt({spatialReference:mc(e)});if(!qp(i,r,s))return null;const n=Math.tan(t.fovX/2),a=Math.tan(t.fovY/2),o=B2(t.eye,i),l=2*o*n*Wv,c=2*o*a*Wv;return du(e).toExtent(e,s,l,c)}function R7(e,t){return du(e).toArea(e,t)}function D7(e,t,i){const r=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(i/r)/Math.LN2>f7)return!0;const s=t,n=e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation;return Gt(s,n)/(Math.tan(.5*e.state.camera.fov)*r)>g7}function O7(e,t,i,r,s,n){let a=0;return n===1&&D7(e,r,s)?(t=0,a=E7(e,s,i,r)):a=ob(e,r,s,i),a=e.state.constraints.clampTilt(s,a),{heading:t,tilt:i=dR(e,r,s,a)}}const Ug=.7;function E7(e,t,i,r){const s=ob(e,r,t,i);if(!e.state.constraints.tilt)return s;const n=e.state.constraints.tilt(t);n.max=Math.min(n.max,.5*Math.PI);const a=n.min*(1-Ug)+n.max*Ug;return Math.min(s,a)}function A7(e,t,i,r){let s=ob(e,r,t,i);if(!e.state.constraints.tilt)return s;const n=e.state.constraints.tilt(t);return s=Math.min(s,.5*Math.PI),n.min*(1-Ug)+s*Ug}function dR(e,t,i,r){return du(e).lookAtTiltToEyeTilt(r,t,i)}function ob(e,t,i,r){return du(e).eyeTiltToLookAtTilt(r,t,i)}function lb(e,t,i,r){if(t==null)return null;const s=e.renderSpatialReference,n=new wt({spatialReference:mc(e)});return qp(t.eye,s,n)?(r??=new Xr,r.position=n,r.heading=t.heading,r.tilt=t.tilt,r.fov=i,r):null}async function pR(e,t,i,r){const s=e.renderSpatialReference,n=new wt({spatialReference:mc(e)});return await U4(t.eye,s,n,{signal:r}),qe(r),new Xr(n,t.heading,t.tilt,i)}function I7(e,t){const i=e.basemapTerrain?.tilingScheme;if(i)return i.levelAtScale(t);ab().error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function mR(e,t){const i=e.basemapTerrain?.tilingScheme;if(i)return i.scaleAtLevel(t);ab().error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}const L7=12;let pn=class br{constructor(t){const i=br.checkUnsupported(t);if(i!=null)throw i;const r=t;this.spatialReference=r.spatialReference,this._isWebMercator=this.spatialReference.isWebMercator,this._isGCS=n9(this.spatialReference),this.origin=[r.origin.x,r.origin.y],this.pixelSize=r.size[0],this.dpi=r.dpi;const s=r.lods.reduce((c,u)=>(u.level<c.minLod.level&&(c.minLod=u),c.max=Math.max(c.max,u.level),c),{minLod:r.lods[0],max:-1/0}),n=s.minLod,a=2**n.level;let o=n.resolution*a,l=n.scale*a;this.levels=new Array(s.max+1);for(let c=0;c<this.levels.length;c++)this.levels[c]={resolution:o,scale:l,tileSize:[o*r.size[0],o*r.size[1]]},o/=2,l/=2}clone(){return new br(this.toTileInfo())}toTileInfo(){return new om({dpi:this.dpi,origin:new wt({x:this.origin[0],y:this.origin[1],spatialReference:this.spatialReference}),size:[this.pixelSize,this.pixelSize],spatialReference:this.spatialReference,lods:this.levels.map((t,i)=>new lm({level:i,scale:t.scale,resolution:t.resolution}))})}getExtent(t,i,r,s){const n=this.levels[t],a=n.tileSize[0],o=n.tileSize[1];s[0]=this.origin[0]+r*a,s[2]=this.origin[0]+(r+1)*a,s[3]=this.origin[1]-i*o,s[1]=this.origin[1]-(i+1)*o}convertExtentToRadians(t,i){this._isWebMercator?(i[0]=Ww(t[0]),i[1]=Rv(t[1]),i[2]=Ww(t[2]),i[3]=Rv(t[3])):this._isGCS&&(i[0]=rt(t[0]),i[1]=rt(t[1]),i[2]=rt(t[2]),i[3]=rt(t[3]))}getExtentGeometry(t,i,r,s=new sr){return this.getExtent(t,i,r,En),s.spatialReference=this.spatialReference,s.xmin=En[0],s.ymin=En[1],s.xmax=En[2],s.ymax=En[3],s.zmin=void 0,s.zmax=void 0,s}ensureMaxLod(t){if(t==null)return!1;let i=!1;for(;this.levels.length<=t;){const{resolution:r,scale:s}=this.levels[this.levels.length-1],n=r/2*this.pixelSize;this.levels.push({resolution:r/2,scale:s/2,tileSize:[n,n]}),i=!0}return i}capMaxLod(t){this.levels.length>t+1&&(this.levels.length=t+1)}getMaxLod(){return this.levels.length-1}scaleAtLevel(t){return this.levels[0].scale/2**t}levelAtScale(t){const i=this.levels[0].scale;return t>=i?0:Math.log(i/t)*Math.LOG2E}resolutionAtLevel(t){return this.levels[0].resolution/2**t}compatibleWith(t,i=1/0){if(br.checkUnsupported(t))return!1;const r=new br(t);if(!r.spatialReference.equals(this.spatialReference)||r.pixelSize!==this.pixelSize)return!1;const s=Math.min(this.levels.length-1,r.levels.length-1,i),n=this.levels[s].resolution;let a=.5*n;return!fy(r.origin[0],this.origin[0],a)||!fy(r.origin[1],this.origin[1],a)?!1:(a=.5*n/2**s/this.pixelSize*L7,fy(n,r.levels[s].resolution,a))}rootTilesInExtent(t,i=null,r=1/0){const s=new Array,n=this.levels[0].tileSize;if(t==null||n[0]===0||n[1]===0)return s;br.computeRowColExtent(t,n,this.origin,En);let a=En[1],o=En[3],l=En[0],c=En[2];const u=c-l,p=o-a;if(u*p>r){const m=Math.floor(Math.sqrt(r));p>m&&(a=a+Math.floor(.5*p)-Math.floor(.5*m),o=a+m),u>m&&(l=l+Math.floor(.5*u)-Math.floor(.5*m),c=l+m)}for(let m=a;m<o;m++)for(let f=l;f<c;f++)s.push([0,m,f]);return i!=null&&(i[0]=this.origin[0]+l*n[0],i[1]=this.origin[1]-o*n[1],i[2]=this.origin[0]+c*n[0],i[3]=this.origin[1]-a*n[1]),s}static computeRowColExtent(t,i,r,s){const n=.001*(t[2]-t[0]+(t[3]-t[1]));s[0]=Math.max(0,Math.floor((t[0]+n-r[0])/i[0])),s[2]=Math.max(0,Math.ceil((t[2]-n-r[0])/i[0])),s[1]=Math.max(0,Math.floor((r[1]-t[3]+n)/i[1])),s[3]=Math.max(0,Math.ceil((r[1]-t[1]-n)/i[1]))}static isPowerOfTwo(t){const i=t.lods,r=i[0].resolution*2**i[0].level;return!i.some(s=>!AI(s.resolution,r/2**s.level))}static hasGapInLevels(t){const i=t.lods.map(r=>r.level);i.sort((r,s)=>r-s);for(let r=1;r<i.length;r++)if(i[r]!==i[0]+r)return!0;return!1}static tileSizeSupported(t){const i=t.size[1];return i===t.size[0]&&!(i&i-1)&&i>=128&&i<=512}static hasOriginPerLODs(t){const i=t.origin;return t.lods.some(r=>r.origin!=null&&(r.origin[0]!==i.x||r.origin[1]!==i.y))}static getMissingTileInfoError(){return new fe("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}static checkUnsupported(t){return t==null?cb():t.lods.length<1?new fe("tilingscheme:generic","Tiling scheme must have at least one level"):br.isPowerOfTwo(t)?br.hasGapInLevels(t)?new fe("tilingscheme:gaps","Tiling scheme levels must not have gaps between min and max level"):br.tileSizeSupported(t)?br.hasOriginPerLODs(t)?new fe("tilingscheme:multiple-origin","Tiling scheme levels must not have their own origin"):null:new fe("tilingscheme:tile-size","Tiles must be square and size must be one of [128, 256, 512]"):new fe("tilingscheme:power-of-two","Tiling scheme must be power of two")}static fromExtent(t,i){const r=t[2]-t[0],s=t[3]-t[1],n=Zh(i),a=1.2*Math.max(r,s),o=256,l=a/o,c=l*n*(96/.0254),u=new br(new om({size:[o,o],origin:new wt({x:t[0]-.5*(a-r),y:t[3]+.5*(a-s)}),lods:[new lm({level:0,resolution:l,scale:c})],spatialReference:i}));return u.ensureMaxLod(20),u}static makeWebMercatorAuxiliarySphere(t){const i=new br(br.WebMercatorAuxiliarySphereTileInfo);return i.ensureMaxLod(t),i}static makeGCSWithTileSize(t,i=256,r=16){const s=256/i,n=new br(new om({size:[i,i],origin:new wt({x:-180,y:90,spatialReference:t}),spatialReference:t,lods:[new lm({level:0,resolution:.703125*s,scale:295497598570834e-6*s})]}));return n.ensureMaxLod(r),n}static{this.WebMercatorAuxiliarySphereTileInfo=new om({size:[256,256],origin:new wt({x:-20037508342787e-6,y:20037508342787e-6,spatialReference:At.WebMercator}),spatialReference:At.WebMercator,lods:[new lm({level:0,resolution:156543.03392800014,scale:591657527591555e-6})]})}static{this.WebMercatorAuxiliarySphere=br.makeWebMercatorAuxiliarySphere(19)}get test(){}};function cb(){return new fe("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}const En=Rt(),Th=64,od=512,F7=2.5,hb=EI(FI/10),fR=2,gR=Rt();pn.WebMercatorAuxiliarySphere.getExtent(0,0,0,gR);const V7=Rt([-180,-90,180,90]),z7="Cannot extend surface to encompass all layers because it would result in too many root tiles.",k7="Surface extent is too large for tile resolution at level 0.",hi=4;let Ph=class extends UI{constructor(e){super(e),this.noDataValue=hb}};h([d({constructOnly:!0})],Ph.prototype,"view",void 0),h([d({readOnly:!0})],Ph.prototype,"noDataValue",void 0),Ph=h([D("esri.views.support.GroundViewElevationSampler")],Ph);let lh=class extends Ph{initialize(){this.view.basemapTerrain.on("elevation-change",()=>this.emit("changed",{}))}get demResolution(){return this.view.basemapTerrain.demResolution}get extent(){const e=this.view.basemapTerrain;if(e?.extent==null||e.spatialReference==null)return null;const t=F4(e.extent,e.spatialReference);return t.zmin=e.visibleElevationBounds.min,t.zmax=e.visibleElevationBounds.max,t}get spatialReference(){return this.view.basemapTerrain?.spatialReference??At.WGS84}elevationAt(e,t){if(this.extent==null||!A4(this.extent,e,t)){const i=this.extent!=null?`${this.extent.xmin}, ${this.extent.ymin}, ${this.extent.xmax}, ${this.extent.ymax}`:null;return $.getLogger(this).warn("#elevationAt()",`Point used to sample elevation (${e}, ${t}) is outside of the sampler extent (${i})`),this.noDataValue}return this.view.elevationProvider?.getElevation(e,t,0,this.spatialReference,"ground")??this.noDataValue}};h([d({readOnly:!0})],lh.prototype,"demResolution",null),h([d({readOnly:!0})],lh.prototype,"extent",null),h([d()],lh.prototype,"spatialReference",null),lh=h([D("esri.views.support.GroundElevationSampler")],lh);let ch=class extends Ph{get demResolution(){return this.view.basemapTerrain.demResolution}get extent(){return this.view.map.allLayers.reduce((e,t)=>t.type!=="integrated-mesh"&&t.type!=="integrated-mesh-3dtiles"||!t.fullExtent?e:e?e.union(t.fullExtent):t.fullExtent.clone(),null)}get spatialReference(){return this.view.spatialReference}elevationAt(e,t){return this.extent!=null&&A4(this.extent,e,t)?this.view.elevationProvider.getElevation(e,t,0,this.spatialReference,"im")??this.noDataValue:this.noDataValue}};h([d({readOnly:!0})],ch.prototype,"demResolution",null),h([d({readOnly:!0})],ch.prototype,"extent",null),h([d()],ch.prototype,"spatialReference",null),ch=h([D("esri.views.support.IntegratedMeshElevationSampler")],ch);let Un=class extends ie{constructor(e){super(e),this.view=null,this.layerViews=new Mt}initialize(){this.addHandles(Yr(()=>this.view?.map?.ground,async e=>e.load())),this.view.type==="3d"&&this.addHandles([M(()=>this.view.map?.basemap,()=>this._groundLayersChanged(),{initial:!0}),M(()=>this.view.map?.basemap?.groundLayers,e=>{this._groundLayersChanged(),e?.on("after-changes",()=>this._groundLayersChanged())},{initial:!0}),M(()=>this.view.basemapView?.groundLayerViews,e=>{this._groundLayersChanged(),e?.on("after-changes",()=>this._groundLayersChanged())},{initial:!0}),Yr(()=>this.view.type==="3d"&&(this.view?.basemapTerrain??!1),async()=>{this._groundLayersChanged()})])}_groundLayersChanged(){const{view:e}=this;if(e!=null&&e.type==="3d"){const t=e.basemapTerrain;if(t){const i=e.map?.basemap?.groundLayers.some(r=>!!e.basemapView?.groundLayerViews.find(s=>s.layer===r)&&"replacesTerrain"in r&&r.replacesTerrain);t.enable(!i)}}}get ground(){return this.view?.map?.ground}destroy(){this._set("view",null),this.layerViews.destroyAll()}get elevationSampler(){return this.view.type==="3d"?new lh({view:this.view}):null}get integratedMeshElevationSampler(){return this.view?new ch({view:this.view}):null}get extent(){const{view:e}=this;return e?.ready?uR(e,e.state.camera,e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation):null}get updating(){return!this.suspended&&this.layerViews.some(({updating:e})=>e)}get suspended(){return this.view?.suspended??!0}};h([d({readOnly:!0})],Un.prototype,"elevationSampler",null),h([d({readOnly:!0})],Un.prototype,"integratedMeshElevationSampler",null),h([d({readOnly:!0})],Un.prototype,"extent",null),h([d({type:Boolean,readOnly:!0})],Un.prototype,"updating",null),h([d({constructOnly:!0})],Un.prototype,"view",void 0),h([d({type:Mt,readOnly:!0})],Un.prototype,"layerViews",void 0),h([d({readOnly:!0})],Un.prototype,"suspended",null),Un=h([D("esri.views.GroundView")],Un);const B7=Un;let os=class extends O_(B7){constructor(e){super(e)}initialize(){super.initialize(),this.addHandles(Yr(()=>this._terrainSurface,e=>e.on("elevation-change",t=>this._elevationChange(t)))),this.addHandles(Yr(()=>this._integratedMeshGroundLayerView,e=>{this.removeHandles(Vx),e&&this.addHandles(e.elevationProvider.on("elevation-change",t=>this._elevationChange(t)),Vx)}))}_elevationChange(e){this.emit("elevation-change",e)}get _integratedMeshGroundLayerView(){const e=this.ground?.integratedMeshGround;if(e)return this.view.basemapView?.groundLayerViews.find(t=>t.layer===e)}get _terrainSurface(){return this.view.basemapTerrain}get _usingTerrain(){return this._terrainSurface?.enabled??!1}get _usingIntegratedMesh(){return this._integratedMeshGroundLayerView?.visible??!1}get spatialReference(){return this._terrainSurface?.spatialReference}intersect(e,t,i,r){this._source?.intersect(e,t,i,r)}get updating(){return!this.suspended&&((this._source?.updating??!1)||this.layerViews.some(({updating:e})=>e))}get elevationQueryCache(){return this._usingTerrain?this._terrainSurface?.elevationQueryCache:null}get extentAABR(){return this._terrainSurface?.extent}get suspended(){return this._source?.suspended??!1}get ready(){return this._source?.ready??!0}updateOverlayParameters(){this._terrainSurface?.updateOverlayParameters()}get _source(){return this._usingTerrain?this._terrainSurface:this._usingIntegratedMesh?this._integratedMeshGroundLayerView:null}requestRender(e){this.view.stage.renderView?.requestRender(e)}};h([d({readOnly:!0})],os.prototype,"_integratedMeshGroundLayerView",null),h([d({readOnly:!0})],os.prototype,"_terrainSurface",null),h([d({readOnly:!0})],os.prototype,"_usingTerrain",null),h([d({readOnly:!0})],os.prototype,"_usingIntegratedMesh",null),h([d({readOnly:!0})],os.prototype,"spatialReference",null),h([d({type:Boolean,readOnly:!0})],os.prototype,"updating",null),h([d({readOnly:!0})],os.prototype,"elevationQueryCache",null),h([d({readOnly:!0})],os.prototype,"extentAABR",null),h([d({readOnly:!0})],os.prototype,"suspended",null),h([d({readOnly:!0})],os.prototype,"ready",null),os=h([D("esri.views.3d.GroundView3D")],os);const Vx=Symbol("integratedMeshHandleKey"),Eu=()=>k(()=>le(()=>import("./TileLayerView3D-DhhIIZW9-CrfD8Tip.js"),__vite__mapDeps([239,3,101,1,2,10,6,7,8,4,9,27,19,20,14,240,241,165,13,34,87,242,147,108,243,244,191,25,5,11,12,15,26,28,29,30,31,32,33,35,36,37,38,39,40,41,42,43,121,245,91,92,93,89,94,246,247,248,200,249,166,167,168,169,86,170,171,69,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,21,16,22,23,112,113,189,190,128,192,193,194,195,97,196,197,75,198,46,201,202,203,146,51,204,205,206,143,207,208,209,68,210,50,47,48,211,212,213,18,214,215,141,82,83,84,81,80,70,216,160,131,217,221,226,227,233,234,199,218,219,220,98,99,222,223,224,225,79,228,229,230,231,232,235,236])),ue([169,1,102,5,6,10,4,7,8,2,9,28,19,20,14,170,171,166,13,35,88,172,148,109,173,174,175,26,3,11,12,15,27,29,30,31,32,33,34,36,37,38,39,40,41,42,43,44,122,176,92,93,94,90,95,177,178,179,180,181,182,183,184,185,87,186,187,70,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,21,16,22,23,24,113,114,205,206,129,207,208,209,210,98,211,52,212,76,213,214,47,18,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,132,231,232,233,234,99,100,235,236,237,238,239,80,240,241,242,243,244,245,246,247,248,249,250])),zx=()=>k(()=>le(()=>import("./ElevationLayerView3D-FO-Wx7i2-CtbvXW0t.js"),__vite__mapDeps([250,1,2,3,251,231,112,113,10,7,8,16,12,4,9,20,14,240,241,165,13,34,87,248,15,6,200,166,38,167,19,168,169,86,170,171,69,172,173,174,175,176,177,36,37,178,179,180,181,101,27,182,183,184,11,92,185,186,187,91,93,26,89,94,188,28,21,22,23,189,190,191,25,5,29,30,31,32,33,35,39,40,41,42,43,128,192,193,194,195,97,196,197,75,198,46,201,202,203,146,51,204,205,206,143,207,208,209,68,210,50,47,48,211,212,213,18,214,215,141,82,83,84,81,80,70,216,160,131,217,221,226,227,233,234,121,199,218,219,220,98,99,222,223,224,225,79,228,229,230,232,235,236])),ue([251,5,6,1,252,245,113,114,10,7,8,16,12,2,9,20,14,170,171,166,13,35,88,179,15,4,180,182,39,183,19,184,185,87,186,187,70,188,189,190,191,192,193,37,38,194,195,196,197,102,28,198,199,200,11,93,201,202,203,92,94,27,90,95,204,29,21,22,23,24,205,206,175,26,3,30,31,32,33,34,36,40,41,42,43,44,129,207,208,209,210,98,211,122,52,212,76,213,214,47,18,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,132,231,232,233,234,99,100,235,236,237,238,239,80,240,241,242,243,244,246,247,248,249,250])),kx={"base-dynamic":()=>k(()=>le(()=>import("./BaseDynamicLayerView3D-B5w63uP7-aBW9B75I.js"),__vite__mapDeps([252,3,253,46,4,9,7,1,2,8,20,14,254,200,37,38,166,167,6,10,19,168,169,86,170,87,171,69,172,173,174,175,176,13,177,36,178,179,180,181,101,27,182,183,184,34,11,12,92,185,186,187,91,93,26,89,94,188,192,193,194,25,5,15,28,29,30,31,32,33,35,39,40,41,42,43,195,97,196,255,256,257,240,248,165,249,21,16,22,23,112,113,189,190,191,128,197,75,198,201,202,203,146,51,204,205,206,143,207,208,209,68,210,50,47,48,211,212,213,18,214,215,141,82,83,84,81,80,70,216,160,131,217,221,226,227,233,234,121,199,218,219,220,98,99,222,223,224,225,79,228,229,230,231,232,235,236])),ue([253,1,254,47,2,9,7,8,5,6,20,14,255,180,38,39,182,183,4,10,19,184,185,87,186,88,187,70,188,189,190,191,192,13,193,37,194,195,196,197,102,28,198,199,200,35,11,12,93,201,202,203,92,94,27,90,95,204,207,208,209,26,3,15,29,30,31,32,33,34,36,40,41,42,43,44,210,98,211,256,257,258,170,179,166,181,21,16,22,23,24,113,114,205,206,175,129,122,52,212,76,213,214,18,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,132,231,232,233,234,99,100,235,236,237,238,239,80,240,241,242,243,244,245,246,247,248,249,250])),"base-elevation":zx,"base-tile":Eu,"bing-maps":Eu,"building-scene":()=>k(()=>le(()=>import("./BuildingSceneLayerView3D-N8_ilxop-CYQp1crD.js"),__vite__mapDeps([258,3,6,1,2,7,8,4,9,10,259,25,5,11,12,13,14,15,26,27,19,20,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,110,106,107,108,109,47,48,111,112,113,16,114,100,101,102,115,116,117,118,68,69,119,120,121,22,122,123,124,125,126,50,127,128,129,130,131,70,45,46,49,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,132,133,134,135,136,137,138,139,140,141,142,76,77,75,78,79,80,81,82,83,84,74,85,86,87,143,144,145,146,147,148,149,150,151,152,153,154,155,23,156,157,158,260,261,262,263,167,186,185,171,172,173,170,264,265,181,165,178,179,180,175,176,247,266,203,267,268,200,269,270,166,168,169,174,177,182,183,184,92,187,91,93,89,94,188,271,193,194,272,213,18,232,273,97,274,206,207,208,275,218,219,192,195,196,98,276,189,190,222,277,231,278,233,223,279,280,281,282,283,284,220,99,285,286,287,288,67,289,290,291,292,293,294,240,248,21,191,197,198,201,202,204,205,209,210,211,212,214,215,216,160,217,221,226,227,234,199,224,225,228,229,230,235,236])),ue([259,1,4,5,6,7,8,2,9,10,260,26,3,11,12,13,14,15,27,28,19,20,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,111,107,108,109,110,48,49,112,113,114,16,115,101,102,103,116,117,118,119,69,70,120,121,122,22,123,124,125,126,127,51,128,129,130,131,132,71,46,47,50,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,133,134,135,136,137,138,139,140,141,142,143,77,78,76,79,80,81,82,83,84,85,75,86,87,88,144,145,146,147,148,149,150,151,152,153,154,155,156,23,157,158,159,261,262,263,264,183,202,201,187,188,189,186,265,266,197,166,194,195,196,191,192,178,267,217,268,269,180,270,271,182,184,185,190,193,198,199,200,93,203,92,94,90,95,204,272,208,209,273,227,18,246,274,98,275,220,221,222,276,232,233,207,210,211,99,277,205,206,236,278,245,279,247,237,280,281,282,283,284,285,234,100,286,287,288,289,68,290,291,292,293,294,295,170,179,21,24,175,212,213,214,215,216,218,219,223,224,161,225,226,228,229,230,231,235,238,239,240,241,242,243,244,248,249,250])),catalog:()=>k(()=>le(()=>import("./CatalogLayerView3D-DgPCTze8-HTU8cUxs.js"),__vite__mapDeps([295,3,6,1,2,7,8,4,9,10,240,248,15,12,200,165,13,14,34,87,166,38,167,19,20,168,169,86,170,171,69,172,173,174,175,176,177,36,37,178,179,180,181,101,27,182,183,184,11,92,185,186,187,91,93,26,89,94,188,28,21,16,22,23,112,113,189,190,191,25,5,29,30,31,32,33,35,39,40,41,42,43,128,192,193,194,195,97,196,197,75,198,46,201,202,203,146,51,204,205,206,143,207,208,209,68,210,50,47,48,211,212,213,18,214,215,141,82,83,84,81,80,70,216,160,131,217,221,226,227,233,234,121,199,218,219,220,98,99,222,223,224,225,79,228,229,230,231,232,235,236])),ue([296,1,4,5,6,7,8,2,9,10,170,179,15,12,180,166,13,14,35,88,182,39,183,19,20,184,185,87,186,187,70,188,189,190,191,192,193,37,38,194,195,196,197,102,28,198,199,200,11,93,201,202,203,92,94,27,90,95,204,29,21,16,22,23,24,113,114,205,206,175,26,3,30,31,32,33,34,36,40,41,42,43,44,129,207,208,209,210,98,211,122,52,212,76,213,214,47,18,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,132,231,232,233,234,99,100,235,236,237,238,239,80,240,241,242,243,244,245,246,247,248,249,250])),"catalog-dynamic-group":()=>k(()=>le(()=>import("./CatalogDynamicGroupLayerView3D-CwMgUc14-7IP7hu5I.js"),__vite__mapDeps([296,3,6,1,2,7,8,4,9,10,240,11,12,248,15,200,165,13,14,34,87,166,38,167,19,20,168,169,86,170,171,69,172,173,174,175,176,177,36,37,178,179,180,181,101,27,182,183,184,92,185,186,187,91,93,26,89,94,188,28,21,16,22,23,112,113,189,190,191,25,5,29,30,31,32,33,35,39,40,41,42,43,128,192,193,194,195,97,196,197,75,198,46,201,202,203,146,51,204,205,206,143,207,208,209,68,210,50,47,48,211,212,213,18,214,215,141,82,83,84,81,80,70,216,160,131,217,221,226,227,233,234,121,199,218,219,220,98,99,222,223,224,225,79,228,229,230,231,232,235,236])),ue([297,1,4,5,6,7,8,2,9,10,170,11,12,179,15,180,166,13,14,35,88,182,39,183,19,20,184,185,87,186,187,70,188,189,190,191,192,193,37,38,194,195,196,197,102,28,198,199,200,93,201,202,203,92,94,27,90,95,204,29,21,16,22,23,24,113,114,205,206,175,26,3,30,31,32,33,34,36,40,41,42,43,44,129,207,208,209,210,98,211,122,52,212,76,213,214,47,18,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,132,231,232,233,234,99,100,235,236,237,238,239,80,240,241,242,243,244,245,246,247,248,249,250])),"catalog-footprint":()=>k(()=>le(()=>import("./CatalogFootprintLayerView3D-DBjxrE8v-BdSXQq8N.js"),__vite__mapDeps([297,3,298,1,2,4,218,97,7,8,36,9,20,14,37,38,219,27,19,28,47,13,48,11,12,299,25,5,6,10,15,26,29,30,31,32,33,34,35,39,40,41,42,43,192,69,170,167,87,169,86,166,168,171,172,173,174,175,176,177,178,179,180,181,101,182,183,184,92,185,186,187,91,93,89,94,188,193,194,195,196,292,293,79,300,286,65,50,70,279,280,281,165,200,46,45,22,49,51,52,53,54,55,56,57,58,59,60,61,62,63,64,301,160,18,302,213,72,68,73,74,75,303,222,131,304,305,306,275,113,16,98,276,189,190,247,307,126,245,284,220,99,285,267,83,84,81,287,288,85,67,289,290,291,80,308,102,121,309,310,240,90,95,96,100,231,112,311,312,313,122,125,118,264,248,249,21,23,191,128,197,198,201,202,203,146,204,205,206,143,207,208,209,210,211,212,214,215,141,82,216,217,221,226,227,233,234,199,223,224,225,228,229,230,232,235,236])),ue([298,1,299,5,6,2,232,98,7,8,37,9,20,14,38,39,233,28,19,29,48,13,49,11,12,300,26,3,4,10,15,27,30,31,32,33,34,35,36,40,41,42,43,44,207,70,186,183,88,185,87,182,184,187,188,189,190,191,192,193,194,195,196,197,102,198,199,200,93,201,202,203,92,94,90,95,204,208,209,210,211,293,294,80,301,287,66,51,71,280,281,282,166,180,47,46,22,50,52,53,54,55,56,57,58,59,60,61,62,63,64,65,302,161,18,303,227,73,69,74,75,76,304,236,132,305,306,307,276,114,16,99,277,205,206,178,308,127,176,285,234,100,286,268,84,85,82,288,289,86,68,290,291,292,81,309,103,122,310,311,170,91,96,97,101,245,113,312,313,314,123,126,119,265,179,181,21,23,24,175,129,212,213,214,215,216,217,147,218,219,220,144,221,222,223,224,225,226,228,229,142,83,230,231,235,237,238,239,240,241,242,243,244,246,247,248,249,250])),csv:()=>k(()=>le(()=>import("./CSVLayerView3D-DtcmkA2e-C-fKLCAh.js"),__vite__mapDeps([314,3,298,1,2,4,218,97,7,8,36,9,20,14,37,38,219,27,19,28,47,13,48,11,12,299,25,5,6,10,15,26,29,30,31,32,33,34,35,39,40,41,42,43,192,69,170,167,87,169,86,166,168,171,172,173,174,175,176,177,178,179,180,181,101,182,183,184,92,185,186,187,91,93,89,94,188,193,194,195,196,292,293,79,300,286,65,50,70,279,280,281,165,200,46,45,22,49,51,52,53,54,55,56,57,58,59,60,61,62,63,64,301,160,18,302,213,72,68,73,74,75,303,222,131,304,305,306,275,113,16,98,276,189,190,247,307,126,245,284,220,99,285,267,83,84,81,287,288,85,67,289,290,291,80,308,102,121,309,310,240,90,95,96,100,231,112,311,312,313,122,125,118,264,248,249,21,23,191,128,197,198,201,202,203,146,204,205,206,143,207,208,209,210,211,212,214,215,141,82,216,217,221,226,227,233,234,199,223,224,225,228,229,230,232,235,236])),ue([315,1,299,5,6,2,232,98,7,8,37,9,20,14,38,39,233,28,19,29,48,13,49,11,12,300,26,3,4,10,15,27,30,31,32,33,34,35,36,40,41,42,43,44,207,70,186,183,88,185,87,182,184,187,188,189,190,191,192,193,194,195,196,197,102,198,199,200,93,201,202,203,92,94,90,95,204,208,209,210,211,293,294,80,301,287,66,51,71,280,281,282,166,180,47,46,22,50,52,53,54,55,56,57,58,59,60,61,62,63,64,65,302,161,18,303,227,73,69,74,75,76,304,236,132,305,306,307,276,114,16,99,277,205,206,178,308,127,176,285,234,100,286,268,84,85,82,288,289,86,68,290,291,292,81,309,103,122,310,311,170,91,96,97,101,245,113,312,313,314,123,126,119,265,179,181,21,23,24,175,129,212,213,214,215,216,217,147,218,219,220,144,221,222,223,224,225,226,228,229,142,83,230,231,235,237,238,239,240,241,242,243,244,246,247,248,249,250])),dimension:()=>k(()=>le(()=>import("./DimensionLayerView3D-BUGs6ZqE-aDBd0XVJ.js"),__vite__mapDeps([315,1,2,3,240,4,316,46,6,7,8,9,10,248,15,12,200,165,13,14,34,87,166,38,167,19,20,168,169,86,170,171,69,172,173,174,175,176,177,36,37,178,179,180,181,101,27,182,183,184,11,92,185,186,187,91,93,26,89,94,188,28,21,16,22,23,112,113,189,190,191,25,5,29,30,31,32,33,35,39,40,41,42,43,128,192,193,194,195,97,196,197,75,198,201,202,203,146,51,204,205,206,143,207,208,209,68,210,50,47,48,211,212,213,18,214,215,141,82,83,84,81,80,70,216,160,131,217,221,226,227,233,234,121,199,218,219,220,98,99,222,223,224,225,79,228,229,230,231,232,235,236])),ue([316,5,6,1,170,2,317,47,4,7,8,9,10,179,15,12,180,166,13,14,35,88,182,39,183,19,20,184,185,87,186,187,70,188,189,190,191,192,193,37,38,194,195,196,197,102,28,198,199,200,11,93,201,202,203,92,94,27,90,95,204,29,21,16,22,23,24,113,114,205,206,175,26,3,30,31,32,33,34,36,40,41,42,43,44,129,207,208,209,210,98,211,122,52,212,76,213,214,18,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,132,231,232,233,234,99,100,235,236,237,238,239,80,240,241,242,243,244,245,246,247,248,249,250])),elevation:zx,feature:()=>k(()=>le(()=>import("./FeatureLayerView3D-BxWfZa1A-CCHf0fmT.js"),__vite__mapDeps([317,3,101,1,2,10,6,7,8,4,9,27,19,20,14,111,51,15,12,298,218,97,36,37,38,219,28,47,13,48,11,299,25,5,26,29,30,31,32,33,34,35,39,40,41,42,43,192,69,170,167,87,169,86,166,168,171,172,173,174,175,176,177,178,179,180,181,182,183,184,92,185,186,187,91,93,89,94,188,193,194,195,196,292,293,79,300,286,65,50,70,279,280,281,165,200,46,45,22,49,52,53,54,55,56,57,58,59,60,61,62,63,64,301,160,18,302,213,72,68,73,74,75,303,222,131,304,305,306,275,113,16,98,276,189,190,247,307,126,245,284,220,99,285,267,83,84,81,287,288,85,67,289,290,291,80,308,102,121,309,310,240,90,95,96,100,231,112,311,312,313,122,125,118,264,248,249,21,23,191,128,197,198,201,202,203,146,204,205,206,143,207,208,209,210,211,212,214,215,141,82,216,217,221,226,227,233,234,199,223,224,225,228,229,230,232,235,236])),ue([318,1,102,5,6,10,4,7,8,2,9,28,19,20,14,112,52,15,12,299,232,98,37,38,39,233,29,48,13,49,11,300,26,3,27,30,31,32,33,34,35,36,40,41,42,43,44,207,70,186,183,88,185,87,182,184,187,188,189,190,191,192,193,194,195,196,197,198,199,200,93,201,202,203,92,94,90,95,204,208,209,210,211,293,294,80,301,287,66,51,71,280,281,282,166,180,47,46,22,50,53,54,55,56,57,58,59,60,61,62,63,64,65,302,161,18,303,227,73,69,74,75,76,304,236,132,305,306,307,276,114,16,99,277,205,206,178,308,127,176,285,234,100,286,268,84,85,82,288,289,86,68,290,291,292,81,309,103,122,310,311,170,91,96,97,101,245,113,312,313,314,123,126,119,265,179,181,21,23,24,175,129,212,213,214,215,216,217,147,218,219,220,144,221,222,223,224,225,226,228,229,142,83,230,231,235,237,238,239,240,241,242,243,244,246,247,248,249,250])),"gaussian-splat":()=>k(()=>le(()=>import("./GaussianSplatLayerView3D-CqHGcAWt-Cg78ozXV.js"),__vite__mapDeps([318,3,4,7,1,2,8,173,319,14,167,6,9,10,19,20,128,101,27,222,131,11,12,240,178,38,179,86,87,180,181,69,175,172,170,97,171,166,168,169,174,176,13,177,36,37,182,183,184,34,92,185,186,187,91,93,26,89,94,188,223,196,18,231,112,113,16,248,15,200,165,28,21,22,23,189,190,191,25,5,29,30,31,32,33,35,39,40,41,42,43,192,193,194,195,197,75,198,46,201,202,203,146,51,204,205,206,143,207,208,209,68,210,50,47,48,211,212,213,214,215,141,82,83,84,81,80,70,216,160,217,221,226,227,233,234,121,199,218,219,220,98,99,224,225,79,228,229,230,232,235,236])),ue([319,1,2,7,8,5,6,189,320,14,183,4,9,10,19,20,129,102,28,236,132,11,12,170,194,39,195,87,88,196,197,70,191,188,186,98,187,182,184,185,190,192,13,193,37,38,198,199,200,35,93,201,202,203,92,94,27,90,95,204,237,211,18,245,113,114,16,179,15,180,166,29,21,22,23,24,205,206,175,26,3,30,31,32,33,34,36,40,41,42,43,44,207,208,209,210,122,52,212,76,213,214,47,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,231,232,233,234,99,100,235,238,239,80,240,241,242,243,244,246,247,248,249,250])),geojson:()=>k(()=>le(()=>import("./GeoJSONLayerView3D-5L11OzQ7-B12YKXAM.js"),__vite__mapDeps([320,3,298,1,2,4,218,97,7,8,36,9,20,14,37,38,219,27,19,28,47,13,48,11,12,299,25,5,6,10,15,26,29,30,31,32,33,34,35,39,40,41,42,43,192,69,170,167,87,169,86,166,168,171,172,173,174,175,176,177,178,179,180,181,101,182,183,184,92,185,186,187,91,93,89,94,188,193,194,195,196,292,293,79,300,286,65,50,70,279,280,281,165,200,46,45,22,49,51,52,53,54,55,56,57,58,59,60,61,62,63,64,301,160,18,302,213,72,68,73,74,75,303,222,131,304,305,306,275,113,16,98,276,189,190,247,307,126,245,284,220,99,285,267,83,84,81,287,288,85,67,289,290,291,80,308,102,121,309,310,240,90,95,96,100,231,112,311,312,313,122,125,118,264,248,249,21,23,191,128,197,198,201,202,203,146,204,205,206,143,207,208,209,210,211,212,214,215,141,82,216,217,221,226,227,233,234,199,223,224,225,228,229,230,232,235,236])),ue([321,1,299,5,6,2,232,98,7,8,37,9,20,14,38,39,233,28,19,29,48,13,49,11,12,300,26,3,4,10,15,27,30,31,32,33,34,35,36,40,41,42,43,44,207,70,186,183,88,185,87,182,184,187,188,189,190,191,192,193,194,195,196,197,102,198,199,200,93,201,202,203,92,94,90,95,204,208,209,210,211,293,294,80,301,287,66,51,71,280,281,282,166,180,47,46,22,50,52,53,54,55,56,57,58,59,60,61,62,63,64,65,302,161,18,303,227,73,69,74,75,76,304,236,132,305,306,307,276,114,16,99,277,205,206,178,308,127,176,285,234,100,286,268,84,85,82,288,289,86,68,290,291,292,81,309,103,122,310,311,170,91,96,97,101,245,113,312,313,314,123,126,119,265,179,181,21,23,24,175,129,212,213,214,215,216,217,147,218,219,220,144,221,222,223,224,225,226,228,229,142,83,230,231,235,237,238,239,240,241,242,243,244,246,247,248,249,250])),graphics:()=>k(()=>le(()=>import("./GraphicsLayerView3D-DoEiLwFO-CGOuYTck.js"),__vite__mapDeps([321,3,4,240,303,6,1,2,7,8,9,10,185,101,27,19,20,14,186,222,131,11,12,322,25,5,13,15,26,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,62,200,192,69,170,167,87,169,86,166,168,171,172,173,174,175,176,177,178,179,180,181,182,183,184,92,187,91,93,89,94,188,193,194,195,97,196,306,56,275,75,113,218,219,47,48,61,53,54,55,57,51,58,59,60,63,64,68,16,98,276,46,189,190,247,213,18,165,307,280,248,281,21,22,23,112,191,128,197,198,201,202,203,146,204,205,206,143,207,208,209,210,50,211,212,214,215,141,82,83,84,81,80,70,216,160,217,221,226,227,233,234,121,199,220,99,223,224,225,79,228,229,230,231,232,235,236])),ue([322,1,2,170,304,4,5,6,7,8,9,10,201,102,28,19,20,14,202,236,132,11,12,323,26,3,13,15,27,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,63,180,207,70,186,183,88,185,87,182,184,187,188,189,190,191,192,193,194,195,196,197,198,199,200,93,203,92,94,90,95,204,208,209,210,98,211,307,57,276,76,114,232,233,48,49,62,54,55,56,58,52,59,60,61,64,65,69,16,99,277,47,205,206,178,227,18,166,308,281,179,282,21,22,23,24,113,175,129,122,212,213,214,215,216,217,147,218,219,220,144,221,222,223,224,71,161,51,225,226,228,229,142,83,84,85,82,81,230,231,234,100,235,237,238,239,80,240,241,242,243,244,245,246,247,248,249,250])),group:()=>k(()=>le(()=>import("./GroupLayerView3D-UsUyJr4_-BpHWhRCI.js"),__vite__mapDeps([323,3,6,1,2,7,8,4,9,10,248,15,12,200,165,13,14,34,87])),ue([324,1,4,5,6,7,8,2,9,10,179,15,12,180,166,13,14,35,88])),imagery:()=>k(()=>le(()=>import("./ImageryLayerView3D-wFtfRKpO-DBLWoNGS.js"),__vite__mapDeps([324,3,4,253,46,9,7,1,2,8,20,14,254,200,37,38,166,167,6,10,19,168,169,86,170,87,171,69,172,173,174,175,176,13,177,36,178,179,180,181,101,27,182,183,184,34,11,12,92,185,186,187,91,93,26,89,94,188,192,193,194,25,5,15,28,29,30,31,32,33,35,39,40,41,42,43,195,97,196,255,256,257,240,248,165,249,244,191,325,326,130,131,327,301,231,112,113,16,328,222,213,18,80,81,70,329,47,48,292,293,79,330,50,247,21,22,23,189,190,128,197,75,198,201,202,203,146,51,204,205,206,143,207,208,209,68,210,211,212,214,215,141,82,83,84,216,160,217,221,226,227,233,234,121,199,218,219,220,98,99,223,224,225,228,229,230,232,235,236])),ue([325,1,2,254,47,9,7,8,5,6,20,14,255,180,38,39,182,183,4,10,19,184,185,87,186,88,187,70,188,189,190,191,192,13,193,37,194,195,196,197,102,28,198,199,200,35,11,12,93,201,202,203,92,94,27,90,95,204,207,208,209,26,3,15,29,30,31,32,33,34,36,40,41,42,43,44,210,98,211,256,257,258,170,179,166,181,174,175,326,327,131,132,328,302,245,113,114,16,329,236,227,18,81,82,71,330,48,49,293,294,80,331,51,178,21,22,23,24,205,206,129,122,52,212,76,213,214,215,216,217,147,218,219,220,144,221,222,223,69,224,161,225,226,228,229,142,83,84,85,230,231,232,233,234,99,100,235,237,238,239,240,241,242,243,244,246,247,248,249,250])),"integrated-mesh":()=>k(()=>le(()=>import("./IntegratedMeshLayerView3D-Cr-lDHcl-BMeD39Nj.js"),__vite__mapDeps([331,3,4,268,1,2,13,14,25,5,6,7,8,9,10,11,12,15,26,27,19,20,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,69,173,167,86,87,200,180,269,101,270,171,172,170,166,168,169,174,175,176,177,178,179,181,182,183,184,92,185,186,187,91,93,89,94,188,271,75,22,193,194,272,213,18,263,264,50,47,48,265,165,46,232,273,97,16,49,274,206,143,207,208,56,275,113,62,218,219,192,195,196,61,53,54,55,57,51,58,59,60,63,64,68,98,276,189,190,247,222,131,277,231,112,278,233,223,279,280,281,240,248,21,23,191,128,197,198,201,202,203,146,204,205,209,210,211,212,214,215,141,82,83,84,81,80,70,216,160,217,221,226,227,234,121,199,220,99,224,225,79,228,229,230,235,236])),ue([332,1,2,269,5,6,13,14,26,3,4,7,8,9,10,11,12,15,27,28,19,20,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,70,189,183,87,88,180,196,270,102,271,187,188,186,182,184,185,190,191,192,193,194,195,197,198,199,200,93,201,202,203,92,94,90,95,204,272,76,22,208,209,273,227,18,264,265,51,48,49,266,166,47,246,274,98,16,50,275,220,144,221,222,57,276,114,63,232,233,207,210,211,62,54,55,56,58,52,59,60,61,64,65,69,99,277,205,206,178,236,132,278,245,113,279,247,237,280,281,282,170,179,21,23,24,175,129,122,212,213,214,215,216,217,147,218,219,223,224,71,161,225,226,228,229,142,83,84,85,82,81,230,231,234,100,235,238,239,80,240,241,242,243,244,248,249,250])),"integrated-mesh-3dtiles":()=>k(()=>le(()=>import("./IntegratedMesh3DTilesLayerView3D-Ef05Po1M-B20cuGtC.js"),__vite__mapDeps([332,3,4,19,9,7,1,2,8,20,14,38,173,167,6,10,87,181,69,101,27,269,270,171,172,170,166,168,169,86,174,175,176,13,177,36,37,178,179,180,182,183,184,34,11,12,92,185,186,187,91,93,26,89,94,188,274,206,143,207,22,208,222,131,277,231,112,113,16,240,223,196,273,227,248,15,200,165,28,21,23,189,190,191,25,5,29,30,31,32,33,35,39,40,41,42,43,128,192,193,194,195,97,197,75,198,46,201,202,203,146,51,204,205,209,68,210,50,47,48,211,212,213,18,214,215,141,82,83,84,81,80,70,216,160,217,221,226,233,234,121,199,218,219,220,98,99,224,225,79,228,229,230,232,235,236])),ue([333,1,2,19,9,7,8,5,6,20,14,39,189,183,4,10,88,197,70,102,28,270,271,187,188,186,182,184,185,87,190,191,192,13,193,37,38,194,195,196,198,199,200,35,11,12,93,201,202,203,92,94,27,90,95,204,275,220,144,221,22,222,236,132,278,245,113,114,16,170,237,211,274,241,179,15,180,166,29,21,23,24,205,206,175,26,3,30,31,32,33,34,36,40,41,42,43,44,129,207,208,209,210,98,122,52,212,76,213,214,47,18,215,216,217,147,218,219,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,231,232,233,234,99,100,235,238,239,80,240,242,243,244,246,247,248,249,250])),"line-of-sight":()=>k(()=>le(()=>import("./LineOfSightLayerView3D-BCb4bshS-9_Lnt5tA.js"),__vite__mapDeps([333,1,2,3,240,4,316,46,248,15,7,8,6,9,10,12,200,165,13,14,34,87,166,38,167,19,20,168,169,86,170,171,69,172,173,174,175,176,177,36,37,178,179,180,181,101,27,182,183,184,11,92,185,186,187,91,93,26,89,94,188,28,21,16,22,23,112,113,189,190,191,25,5,29,30,31,32,33,35,39,40,41,42,43,128,192,193,194,195,97,196,197,75,198,201,202,203,146,51,204,205,206,143,207,208,209,68,210,50,47,48,211,212,213,18,214,215,141,82,83,84,81,80,70,216,160,131,217,221,226,227,233,234,121,199,218,219,220,98,99,222,223,224,225,79,228,229,230,231,232,235,236])),ue([334,5,6,1,170,2,317,47,179,15,7,8,4,9,10,12,180,166,13,14,35,88,182,39,183,19,20,184,185,87,186,187,70,188,189,190,191,192,193,37,38,194,195,196,197,102,28,198,199,200,11,93,201,202,203,92,94,27,90,95,204,29,21,16,22,23,24,113,114,205,206,175,26,3,30,31,32,33,34,36,40,41,42,43,44,129,207,208,209,210,98,211,122,52,212,76,213,214,18,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,132,231,232,233,234,99,100,235,236,237,238,239,80,240,241,242,243,244,245,246,247,248,249,250])),"map-image":()=>k(()=>le(()=>import("./MapImageLayerView3D-BwlyxS_1-COJ2CYxU.js"),__vite__mapDeps([334,3,253,46,4,9,7,1,2,8,20,14,254,200,37,38,166,167,6,10,19,168,169,86,170,87,171,69,172,173,174,175,176,13,177,36,178,179,180,181,101,27,182,183,184,34,11,12,92,185,186,187,91,93,26,89,94,188,192,193,194,25,5,15,28,29,30,31,32,33,35,39,40,41,42,43,195,97,196,255,256,257,240,248,165,249,243,244,191,121,245,246,247,335,292,293,79,21,16,22,23,112,113,189,190,128,197,75,198,201,202,203,146,51,204,205,206,143,207,208,209,68,210,50,47,48,211,212,213,18,214,215,141,82,83,84,81,80,70,216,160,131,217,221,226,227,233,234,199,218,219,220,98,99,222,223,224,225,228,229,230,231,232,235,236])),ue([335,1,254,47,2,9,7,8,5,6,20,14,255,180,38,39,182,183,4,10,19,184,185,87,186,88,187,70,188,189,190,191,192,13,193,37,194,195,196,197,102,28,198,199,200,35,11,12,93,201,202,203,92,94,27,90,95,204,207,208,209,26,3,15,29,30,31,32,33,34,36,40,41,42,43,44,210,98,211,256,257,258,170,179,166,181,173,174,175,122,176,177,178,336,293,294,80,21,16,22,23,24,113,114,205,206,129,52,212,76,213,214,18,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,132,231,232,233,234,99,100,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250])),media:()=>k(()=>le(()=>import("./MediaLayerView3D-1XR1oxgL-jMppTVfv.js"),__vite__mapDeps([336,1,2,3,337,19,9,7,8,20,14,167,6,4,10,101,27,338,26,93,240,164,339,170,200,340,86,87,175,172,38,173,341,342,343,344,345,346,46,222,131,11,12,186,185,13,15,50,28,47,48,293,79,171,69,34,347,348,180,349,350,351,166,168,169,174,176,177,36,37,178,179,181,182,183,184,92,187,91,89,94,188,352,255,256,257,248,165,281,21,16,22,23,112,113,189,190,191,25,5,29,30,31,32,33,35,39,40,41,42,43,128,192,193,194,195,97,196,121,51,197,75,198,199,18,201,202,203,146,204,205,206,143,207,208,209,68,210,70,160,211,212,213,214,215,141,82,83,84,81,80,216,217,218,219,220,98,99,221,223,224,225,226,227,228,229,230,231,232,233,234,235,236])).then(e=>e.M),ue([337,1,338,19,9,7,8,5,6,20,14,183,4,2,10,102,28,339,27,94,170,165,340,186,180,341,87,88,191,188,39,189,342,343,344,345,346,347,47,236,132,11,12,202,201,13,15,51,29,48,49,294,80,187,70,35,348,349,196,350,351,352,182,184,185,190,192,193,37,38,194,195,197,198,199,200,93,203,92,90,95,204,353,256,257,258,179,166,282])),"ogc-feature":()=>k(()=>le(()=>import("./OGCFeatureLayerView3D-BG2ABTWS-DiMzq5lK.js"),__vite__mapDeps([353,3,298,1,2,4,218,97,7,8,36,9,20,14,37,38,219,27,19,28,47,13,48,11,12,299,25,5,6,10,15,26,29,30,31,32,33,34,35,39,40,41,42,43,192,69,170,167,87,169,86,166,168,171,172,173,174,175,176,177,178,179,180,181,101,182,183,184,92,185,186,187,91,93,89,94,188,193,194,195,196,292,293,79,300,286,65,50,70,279,280,281,165,200,46,45,22,49,51,52,53,54,55,56,57,58,59,60,61,62,63,64,301,160,18,302,213,72,68,73,74,75,303,222,131,304,305,306,275,113,16,98,276,189,190,247,307,126,245,284,220,99,285,267,83,84,81,287,288,85,67,289,290,291,80,308,102,121,309,310,240,90,95,96,100,231,112,311,312,313,122,125,118,264,248,249,21,23,191,128,197,198,201,202,203,146,204,205,206,143,207,208,209,210,211,212,214,215,141,82,216,217,221,226,227,233,234,199,223,224,225,228,229,230,232,235,236])),ue([354,1,299,5,6,2,232,98,7,8,37,9,20,14,38,39,233,28,19,29,48,13,49,11,12,300,26,3,4,10,15,27,30,31,32,33,34,35,36,40,41,42,43,44,207,70,186,183,88,185,87,182,184,187,188,189,190,191,192,193,194,195,196,197,102,198,199,200,93,201,202,203,92,94,90,95,204,208,209,210,211,293,294,80,301,287,66,51,71,280,281,282,166,180,47,46,22,50,52,53,54,55,56,57,58,59,60,61,62,63,64,65,302,161,18,303,227,73,69,74,75,76,304,236,132,305,306,307,276,114,16,99,277,205,206,178,308,127,176,285,234,100,286,268,84,85,82,288,289,86,68,290,291,292,81,309,103,122,310,311,170,91,96,97,101,245,113,312,313,314,123,126,119,265,179,181,21,23,24,175,129,212,213,214,215,216,217,147,218,219,220,144,221,222,223,224,225,226,228,229,142,83,230,231,235,237,238,239,240,241,242,243,244,246,247,248,249,250])),"open-street-map":Eu,"oriented-imagery":()=>k(()=>le(()=>import("./FeatureLayerView3D-BxWfZa1A-CCHf0fmT.js"),__vite__mapDeps([317,3,101,1,2,10,6,7,8,4,9,27,19,20,14,111,51,15,12,298,218,97,36,37,38,219,28,47,13,48,11,299,25,5,26,29,30,31,32,33,34,35,39,40,41,42,43,192,69,170,167,87,169,86,166,168,171,172,173,174,175,176,177,178,179,180,181,182,183,184,92,185,186,187,91,93,89,94,188,193,194,195,196,292,293,79,300,286,65,50,70,279,280,281,165,200,46,45,22,49,52,53,54,55,56,57,58,59,60,61,62,63,64,301,160,18,302,213,72,68,73,74,75,303,222,131,304,305,306,275,113,16,98,276,189,190,247,307,126,245,284,220,99,285,267,83,84,81,287,288,85,67,289,290,291,80,308,102,121,309,310,240,90,95,96,100,231,112,311,312,313,122,125,118,264,248,249,21,23,191,128,197,198,201,202,203,146,204,205,206,143,207,208,209,210,211,212,214,215,141,82,216,217,221,226,227,233,234,199,223,224,225,228,229,230,232,235,236])),ue([318,1,102,5,6,10,4,7,8,2,9,28,19,20,14,112,52,15,12,299,232,98,37,38,39,233,29,48,13,49,11,300,26,3,27,30,31,32,33,34,35,36,40,41,42,43,44,207,70,186,183,88,185,87,182,184,187,188,189,190,191,192,193,194,195,196,197,198,199,200,93,201,202,203,92,94,90,95,204,208,209,210,211,293,294,80,301,287,66,51,71,280,281,282,166,180,47,46,22,50,53,54,55,56,57,58,59,60,61,62,63,64,65,302,161,18,303,227,73,69,74,75,76,304,236,132,305,306,307,276,114,16,99,277,205,206,178,308,127,176,285,234,100,286,268,84,85,82,288,289,86,68,290,291,292,81,309,103,122,310,311,170,91,96,97,101,245,113,312,313,314,123,126,119,265,179,181,21,23,24,175,129,212,213,214,215,216,217,147,218,219,220,144,221,222,223,224,225,226,228,229,142,83,230,231,235,237,238,239,240,241,242,243,244,246,247,248,249,250])),"point-cloud":()=>k(()=>le(()=>import("./PointCloudLayerView3D-C0RrrH-R-BVZTmoGh.js"),__vite__mapDeps([354,3,25,5,6,1,2,7,8,4,9,10,11,12,13,14,15,26,27,19,20,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,46,97,167,195,270,101,171,69,87,172,173,170,186,185,175,86,98,284,91,92,93,89,94,220,99,285,75,267,83,84,81,48,286,65,287,219,288,85,67,68,16,70,289,290,291,80,213,18,47,102,50,222,131,240,231,112,113,294,263,264,265,181,165,178,179,180,176,223,187,196,166,168,169,174,177,182,183,184,188,355,356,63,55,280,357,247,248,200,281,21,22,23,189,190,191,128,192,193,194,197,198,201,202,203,146,51,204,205,206,143,207,208,209,210,211,212,214,215,141,82,216,160,217,221,226,227,233,234,121,199,218,224,225,79,228,229,230,232,235,236])),ue([355,1,26,3,4,5,6,7,8,2,9,10,11,12,13,14,15,27,28,19,20,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,47,98,183,210,271,102,187,70,88,188,189,186,202,201,191,87,99,285,92,93,94,90,95,234,100,286,76,268,84,85,82,49,287,66,288,233,289,86,68,69,16,71,290,291,292,81,227,18,48,103,51,236,132,170,245,113,114,295,264,265,266,197,166,194,195,196,192,237,203,211,182,184,185,190,193,198,199,200,204,356,357,64,56,281,358,178,179,180,282,21,22,23,24,205,206,175,129,207,208,209,122,52,212,213,214,215,216,217,147,218,219,220,144,221,222,223,224,161,225,226,228,229,142,83,230,231,232,235,238,239,80,240,241,242,243,244,246,247,248,249,250])),viewshed:()=>k(()=>le(()=>import("./ViewshedLayerView3D-Y4yo4dOY-BGc7rvPA.js"),__vite__mapDeps([358,1,2,3,240,4,316,46,248,15,7,8,6,9,10,12,200,165,13,14,34,87,166,38,167,19,20,168,169,86,170,171,69,172,173,174,175,176,177,36,37,178,179,180,181,101,27,182,183,184,11,92,185,186,187,91,93,26,89,94,188,28,21,16,22,23,112,113,189,190,191,25,5,29,30,31,32,33,35,39,40,41,42,43,128,192,193,194,195,97,196,197,75,198,201,202,203,146,51,204,205,206,143,207,208,209,68,210,50,47,48,211,212,213,18,214,215,141,82,83,84,81,80,70,216,160,131,217,221,226,227,233,234,121,199,218,219,220,98,99,222,223,224,225,79,228,229,230,231,232,235,236])),ue([359,5,6,1,170,2,317,47,179,15,7,8,4,9,10,12,180,166,13,14,35,88,182,39,183,19,20,184,185,87,186,187,70,188,189,190,191,192,193,37,38,194,195,196,197,102,28,198,199,200,11,93,201,202,203,92,94,27,90,95,204,29,21,16,22,23,24,113,114,205,206,175,26,3,30,31,32,33,34,36,40,41,42,43,44,129,207,208,209,210,98,211,122,52,212,76,213,214,18,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,132,231,232,233,234,99,100,235,236,237,238,239,80,240,241,242,243,244,245,246,247,248,249,250])),voxel:()=>k(()=>le(()=>import("./VoxelLayerView3D-akNAZreO-Ds3bQB_n.js"),__vite__mapDeps([359,3,4,167,6,1,2,7,8,9,10,19,20,14,186,27,101,185,36,37,38,240,360,25,5,11,12,13,15,26,28,29,30,31,32,33,34,35,39,40,41,42,43,357,247,248,200,165,87,166,168,169,86,170,171,69,172,173,174,175,176,177,178,179,180,181,182,183,184,92,187,91,93,89,94,188,21,16,22,23,112,113,189,190,191,128,192,193,194,195,97,196,197,75,198,46,201,202,203,146,51,204,205,206,143,207,208,209,68,210,50,47,48,211,212,213,18,214,215,141,82,83,84,81,80,70,216,160,131,217,221,226,227,233,234,121,199,218,219,220,98,99,222,223,224,225,79,228,229,230,231,232,235,236])),ue([360,1,2,183,4,5,6,7,8,9,10,19,20,14,202,28,102,201,37,38,39,170,361,26,3,11,12,13,15,27,29,30,31,32,33,34,35,36,40,41,42,43,44,358,178,179,180,166,88,182,184,185,87,186,187,70,188,189,190,191,192,193,194,195,196,197,198,199,200,93,203,92,94,90,95,204,21,16,22,23,24,113,114,205,206,175,129,207,208,209,210,98,211,122,52,212,76,213,214,47,18,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,132,231,232,233,234,99,100,235,236,237,238,239,80,240,241,242,243,244,245,246,247,248,249,250])),route:()=>k(()=>le(()=>import("./RouteLayerView3D-DxmsZ1zT-BQVYzBIm.js"),__vite__mapDeps([361,3,6,1,2,7,8,4,9,10,205,362,25,5,11,12,13,14,15,26,27,19,20,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,363,240,322,62,200,192,69,170,167,87,169,86,166,168,171,172,173,174,175,176,177,178,179,180,181,101,182,183,184,92,185,186,187,91,93,89,94,188,193,194,195,97,196,306,56,275,75,113,218,219,47,48,61,53,54,55,57,51,58,59,60,63,64,68,16,98,276,46,189,190,247,213,18,165,307,280,311,248,281,21,22,23,112,191,128,197,198,201,202,203,146,204,206,143,207,208,209,210,50,211,212,214,215,141,82,83,84,81,80,70,216,160,131,217,221,226,227,233,234,121,199,220,99,222,223,224,225,79,228,229,230,231,232,235,236])),ue([362,1,4,5,6,7,8,2,9,10,219,363,26,3,11,12,13,14,15,27,28,19,20,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,364,170,323,63,180,207,70,186,183,88,185,87,182,184,187,188,189,190,191,192,193,194,195,196,197,102,198,199,200,93,201,202,203,92,94,90,95,204,208,209,210,98,211,307,57,276,76,114,232,233,48,49,62,54,55,56,58,52,59,60,61,64,65,69,16,99,277,47,205,206,178,227,18,166,308,281,312,179,282,21,22,23,24,113,175,129,122,212,213,214,215,216,217,147,218,220,144,221,222,223,224,71,161,51,225,226,228,229,142,83,84,85,82,81,230,132,231,234,100,235,236,237,238,239,80,240,241,242,243,244,245,246,247,248,249,250])),scene:e=>e.profile==null||e.profile==="mesh-pyramids"?k(()=>le(()=>import("./SceneLayerView3D-oBc0YUM_-DStf1waQ.js"),__vite__mapDeps([364,3,25,5,6,1,2,7,8,4,9,10,11,12,13,14,15,26,27,19,20,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,267,83,84,81,126,50,47,48,245,268,69,173,167,86,87,200,180,269,101,270,171,172,170,166,168,169,174,175,176,177,178,179,181,182,183,184,92,185,186,187,91,93,89,94,188,271,75,22,193,194,272,213,18,263,264,265,165,46,232,273,97,16,49,274,206,143,207,208,56,275,113,62,218,219,192,195,196,61,53,54,55,57,51,58,59,60,63,64,68,98,276,189,190,247,222,131,277,231,112,278,233,223,279,280,281,240,365,283,284,220,99,285,286,65,287,288,85,67,70,289,290,291,80,292,293,79,248,282,102,294,357,21,23,191,128,197,198,201,202,203,146,204,205,209,210,211,212,214,215,141,82,216,160,217,221,226,227,234,121,199,224,225,228,229,230,235,236])),ue([365,1,26,3,4,5,6,7,8,2,9,10,11,12,13,14,15,27,28,19,20,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,268,84,85,82,127,51,48,49,176,269,70,189,183,87,88,180,196,270,102,271,187,188,186,182,184,185,190,191,192,193,194,195,197,198,199,200,93,201,202,203,92,94,90,95,204,272,76,22,208,209,273,227,18,264,265,266,166,47,246,274,98,16,50,275,220,144,221,222,57,276,114,63,232,233,207,210,211,62,54,55,56,58,52,59,60,61,64,65,69,99,277,205,206,178,236,132,278,245,113,279,247,237,280,281,282,170,366,284,285,234,100,286,287,66,288,289,86,68,71,290,291,292,81,293,294,80,179,283,103,295,358,21,23,24,175,129,122,212,213,214,215,216,217,147,218,219,223,224,161,225,226,228,229,142,83,230,231,235,238,239,240,241,242,243,244,248,249,250])):k(()=>le(()=>import("./SceneLayerGraphicsView3D-Cg_VcFAo-Bl2mSj0E.js"),__vite__mapDeps([366,1,2,3,97,4,167,6,7,8,9,10,19,20,14,101,27,186,185,37,38,218,36,219,28,47,13,48,192,69,170,87,169,86,166,168,171,172,173,174,175,176,177,178,179,180,181,182,183,184,34,11,12,92,187,91,93,26,89,94,188,193,194,25,5,15,29,30,31,32,33,35,39,40,41,42,43,195,196,271,200,75,22,270,272,213,18,263,264,50,265,165,46,232,273,16,49,126,275,113,62,61,53,54,55,56,57,51,58,59,60,63,64,68,98,276,189,190,247,231,112,240,304,305,306,307,245,284,220,99,285,267,83,84,81,286,65,287,288,85,67,70,289,290,291,80,308,102,280,365,283,292,293,79,248,279,357,281,21,23,191,128,197,198,201,202,203,146,204,205,206,143,207,208,209,210,211,212,214,215,141,82,216,160,131,217,221,226,227,233,234,121,199,222,223,224,225,228,229,230,235,236])),ue([367,5,6,1,98,2,183,4,7,8,9,10,19,20,14,102,28,202,201,38,39,232,37,233,29,48,13,49,207,70,186,88,185,87,182,184,187,188,189,190,191,192,193,194,195,196,197,198,199,200,35,11,12,93,203,92,94,27,90,95,204,208,209,26,3,15,30,31,32,33,34,36,40,41,42,43,44,210,211,272,180,76,22,271,273,227,18,264,265,51,266,166,47,246,274,16,50,127,276,114,63,62,54,55,56,57,58,52,59,60,61,64,65,69,99,277,205,206,178,245,113,170,305,306,307,308,176,285,234,100,286,268,84,85,82,287,66,288,289,86,68,71,290,291,292,81,309,103,281,366,284,293,294,80,179,280,358,282,21,23,24,175,129,122,212,213,214,215,216,217,147,218,219,220,144,221,222,223,224,161,225,226,228,229,142,83,230,132,231,235,236,237,238,239,240,241,242,243,244,247,248,249,250])),stream:()=>k(()=>le(()=>import("./StreamLayerView3D-Glutgj0u-KxV7m_md.js"),__vite__mapDeps([367,3,4,50,7,1,2,8,13,14,26,9,27,19,20,28,47,48,6,10,15,12,11,299,25,5,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,192,69,170,167,87,169,86,166,168,171,172,173,174,175,176,177,178,179,180,181,101,182,183,184,92,185,186,187,91,93,89,94,188,193,194,195,97,196,292,293,79,300,286,65,70,279,280,281,165,200,46,45,22,49,51,52,53,54,55,56,57,58,59,60,61,62,63,64,301,160,18,218,219,302,213,72,68,73,74,75,303,222,131,304,305,306,275,113,16,98,276,189,190,247,307,126,245,284,220,99,285,267,83,84,81,287,288,85,67,289,290,291,80,308,102,121,309,310,240,368,159,369,90,95,96,100,311,248,21,23,112,191,128,197,198,201,202,203,146,204,205,206,143,207,208,209,210,211,212,214,215,141,82,216,217,221,226,227,233,234,199,223,224,225,228,229,230,231,232,235,236])),ue([368,1,2,51,7,8,5,6,13,14,27,9,28,19,20,29,48,49,4,10,15,12,11,300,26,3,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,207,70,186,183,88,185,87,182,184,187,188,189,190,191,192,193,194,195,196,197,102,198,199,200,93,201,202,203,92,94,90,95,204,208,209,210,98,211,293,294,80,301,287,66,71,280,281,282,166,180,47,46,22,50,52,53,54,55,56,57,58,59,60,61,62,63,64,65,302,161,18,232,233,303,227,73,69,74,75,76,304,236,132,305,306,307,276,114,16,99,277,205,206,178,308,127,176,285,234,100,286,268,84,85,82,288,289,86,68,290,291,292,81,309,103,122,310,311,170,369,160,370,91,96,97,101,312,179,21,23,24,113,175,129,212,213,214,215,216,217,147,218,219,220,144,221,222,223,224,225,226,228,229,142,83,230,231,235,237,238,239,240,241,242,243,244,245,246,247,248,249,250])),tile:Eu,"imagery-tile":()=>k(()=>le(()=>import("./ImageryTileLayerView3D-BdxCmzk8-DGHnSpjz.js"),__vite__mapDeps([370,3,4,330,1,2,7,8,9,19,20,14,101,10,6,27,240,241,165,13,34,87,17,18,325,326,130,11,12,131,327,301,92,254,200,231,112,113,16,166,38,167,168,169,86,170,171,69,172,173,174,175,176,177,36,37,178,179,180,181,182,183,184,185,186,187,91,93,26,89,94,188,328,222,97,213,25,5,15,28,29,30,31,32,33,35,39,40,41,42,43,329,47,48,292,293,79,371,247,248,249,235,21,22,23,189,190,191,128,192,193,194,195,196,197,75,198,46,201,202,203,146,51,204,205,206,143,207,208,209,68,210,50,211,212,214,215,141,82,83,84,81,80,70,216,160,217,221,226,227,233,234,121,199,218,219,220,98,99,223,224,225,228,229,230,232,236])),ue([371,1,2,331,5,6,7,8,9,19,20,14,102,10,4,28,170,171,166,13,35,88,17,18,326,327,131,11,12,132,328,302,93,255,180,245,113,114,16,182,39,183,184,185,87,186,187,70,188,189,190,191,192,193,37,38,194,195,196,197,198,199,200,201,202,203,92,94,27,90,95,204,329,236,98,227,26,3,15,29,30,31,32,33,34,36,40,41,42,43,44,330,48,49,293,294,80,372,178,179,181,249,21,22,23,24,205,206,175,129,207,208,209,210,211,122,52,212,76,213,214,47,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,225,226,228,229,142,83,84,85,82,81,230,231,232,233,234,99,100,235,237,238,239,240,241,242,243,244,246,247,248,250])),"vector-tile":()=>k(()=>le(()=>import("./VectorTileLayerView3D-eERbBVJy-Bz1hY_KC.js"),__vite__mapDeps([372,3,4,75,20,14,9,7,1,2,8,214,112,113,10,16,12,373,166,38,167,6,19,168,169,86,170,87,171,69,172,173,174,175,176,13,177,36,37,178,179,180,181,101,27,182,183,184,34,11,92,185,186,187,91,93,26,89,94,188,96,97,374,215,141,82,83,84,81,80,70,216,160,18,212,198,230,217,228,375,229,232,240,241,165,248,15,200,28,21,22,23,189,190,191,25,5,29,30,31,32,33,35,39,40,41,42,43,128,192,193,194,195,196,197,46,201,202,203,146,51,204,205,206,143,207,208,209,68,210,50,47,48,211,213,131,221,226,227,233,234,121,199,218,219,220,98,99,222,223,224,225,79,231,235,236])),ue([373,1,2,76,20,14,9,7,8,5,6,228,113,114,10,16,12,374,182,39,183,4,19,184,185,87,186,88,187,70,188,189,190,191,192,13,193,37,38,194,195,196,197,102,28,198,199,200,35,11,93,201,202,203,92,94,27,90,95,204,97,98,375,229,142,83,84,85,82,81,71,230,161,18,226,213,244,231,242,376,243,246,170,171,166,179,15,180,29,21,22,23,24,205,206,175,26,3,30,31,32,33,34,36,40,41,42,43,44,129,207,208,209,210,211,122,52,212,214,47,215,216,217,147,218,219,220,144,221,222,223,69,224,51,48,49,225,227,132,232,233,234,99,100,235,236,237,238,239,80,240,241,245,247,248,249,250])),wcs:()=>k(()=>le(()=>import("./ImageryTileLayerView3D-BdxCmzk8-DGHnSpjz.js"),__vite__mapDeps([370,3,4,330,1,2,7,8,9,19,20,14,101,10,6,27,240,241,165,13,34,87,17,18,325,326,130,11,12,131,327,301,92,254,200,231,112,113,16,166,38,167,168,169,86,170,171,69,172,173,174,175,176,177,36,37,178,179,180,181,182,183,184,185,186,187,91,93,26,89,94,188,328,222,97,213,25,5,15,28,29,30,31,32,33,35,39,40,41,42,43,329,47,48,292,293,79,371,247,248,249,235,21,22,23,189,190,191,128,192,193,194,195,196,197,75,198,46,201,202,203,146,51,204,205,206,143,207,208,209,68,210,50,211,212,214,215,141,82,83,84,81,80,70,216,160,217,221,226,227,233,234,121,199,218,219,220,98,99,223,224,225,228,229,230,232,236])),ue([371,1,2,331,5,6,7,8,9,19,20,14,102,10,4,28,170,171,166,13,35,88,17,18,326,327,131,11,12,132,328,302,93,255,180,245,113,114,16,182,39,183,184,185,87,186,187,70,188,189,190,191,192,193,37,38,194,195,196,197,198,199,200,201,202,203,92,94,27,90,95,204,329,236,98,227,26,3,15,29,30,31,32,33,34,36,40,41,42,43,44,330,48,49,293,294,80,372,178,179,181,249,21,22,23,24,205,206,175,129,207,208,209,210,211,122,52,212,76,213,214,47,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,225,226,228,229,142,83,84,85,82,81,230,231,232,233,234,99,100,235,237,238,239,240,241,242,243,244,246,247,248,250])),"web-tile":Eu,wfs:()=>k(()=>le(()=>import("./WFSLayerView3D-Gy9kXxeH-Bf80h1yZ.js"),__vite__mapDeps([376,3,298,1,2,4,218,97,7,8,36,9,20,14,37,38,219,27,19,28,47,13,48,11,12,299,25,5,6,10,15,26,29,30,31,32,33,34,35,39,40,41,42,43,192,69,170,167,87,169,86,166,168,171,172,173,174,175,176,177,178,179,180,181,101,182,183,184,92,185,186,187,91,93,89,94,188,193,194,195,196,292,293,79,300,286,65,50,70,279,280,281,165,200,46,45,22,49,51,52,53,54,55,56,57,58,59,60,61,62,63,64,301,160,18,302,213,72,68,73,74,75,303,222,131,304,305,306,275,113,16,98,276,189,190,247,307,126,245,284,220,99,285,267,83,84,81,287,288,85,67,289,290,291,80,308,102,121,309,310,240,90,95,96,100,231,112,311,312,313,122,125,118,264,248,249,21,23,191,128,197,198,201,202,203,146,204,205,206,143,207,208,209,210,211,212,214,215,141,82,216,217,221,226,227,233,234,199,223,224,225,228,229,230,232,235,236])),ue([377,1,299,5,6,2,232,98,7,8,37,9,20,14,38,39,233,28,19,29,48,13,49,11,12,300,26,3,4,10,15,27,30,31,32,33,34,35,36,40,41,42,43,44,207,70,186,183,88,185,87,182,184,187,188,189,190,191,192,193,194,195,196,197,102,198,199,200,93,201,202,203,92,94,90,95,204,208,209,210,211,293,294,80,301,287,66,51,71,280,281,282,166,180,47,46,22,50,52,53,54,55,56,57,58,59,60,61,62,63,64,65,302,161,18,303,227,73,69,74,75,76,304,236,132,305,306,307,276,114,16,99,277,205,206,178,308,127,176,285,234,100,286,268,84,85,82,288,289,86,68,290,291,292,81,309,103,122,310,311,170,91,96,97,101,245,113,312,313,314,123,126,119,265,179,181,21,23,24,175,129,212,213,214,215,216,217,147,218,219,220,144,221,222,223,224,225,226,228,229,142,83,230,231,235,237,238,239,240,241,242,243,244,246,247,248,249,250])),wms:()=>k(()=>le(()=>import("./WMSLayerView3D-Dt5uSI5I-d-UNgMCW.js"),__vite__mapDeps([377,3,9,7,1,2,8,253,46,4,20,14,254,200,37,38,166,167,6,10,19,168,169,86,170,87,171,69,172,173,174,175,176,13,177,36,178,179,180,181,101,27,182,183,184,34,11,12,92,185,186,187,91,93,26,89,94,188,192,193,194,25,5,15,28,29,30,31,32,33,35,39,40,41,42,43,195,97,196,255,256,257,240,248,165,249,378,292,293,79,21,16,22,23,112,113,189,190,191,128,197,75,198,201,202,203,146,51,204,205,206,143,207,208,209,68,210,50,47,48,211,212,213,18,214,215,141,82,83,84,81,80,70,216,160,131,217,221,226,227,233,234,121,199,218,219,220,98,99,222,223,224,225,228,229,230,231,232,235,236])),ue([378,1,9,7,8,5,6,254,47,2,20,14,255,180,38,39,182,183,4,10,19,184,185,87,186,88,187,70,188,189,190,191,192,13,193,37,194,195,196,197,102,28,198,199,200,35,11,12,93,201,202,203,92,94,27,90,95,204,207,208,209,26,3,15,29,30,31,32,33,34,36,40,41,42,43,44,210,98,211,256,257,258,170,179,166,181,379,293,294,80,21,16,22,23,24,113,114,205,206,175,129,122,52,212,76,213,214,18,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,132,231,232,233,234,99,100,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250])),wmts:()=>k(()=>le(()=>import("./WMTSLayerView3D-cg7HqkZ7-CcZeFkpg.js"),__vite__mapDeps([379,3,6,1,2,7,8,4,9,10,51,15,12,240,241,165,13,14,34,87,242,147,108,248,200,249,166,38,167,19,20,168,169,86,170,171,69,172,173,174,175,176,177,36,37,178,179,180,181,101,27,182,183,184,11,92,185,186,187,91,93,26,89,94,188,28,21,16,22,23,112,113,189,190,191,25,5,29,30,31,32,33,35,39,40,41,42,43,128,192,193,194,195,97,196,197,75,198,46,201,202,203,146,204,205,206,143,207,208,209,68,210,50,47,48,211,212,213,18,214,215,141,82,83,84,81,80,70,216,160,131,217,221,226,227,233,234,121,199,218,219,220,98,99,222,223,224,225,79,228,229,230,231,232,235,236])),ue([380,1,4,5,6,7,8,2,9,10,52,15,12,170,171,166,13,14,35,88,172,148,109,179,180,181,182,39,183,19,20,184,185,87,186,187,70,188,189,190,191,192,193,37,38,194,195,196,197,102,28,198,199,200,11,93,201,202,203,92,94,27,90,95,204,29,21,16,22,23,24,113,114,205,206,175,26,3,30,31,32,33,34,36,40,41,42,43,44,129,207,208,209,210,98,211,122,212,76,213,214,47,18,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,132,231,232,233,234,99,100,235,236,237,238,239,80,240,241,242,243,244,245,246,247,248,249,250])),"geo-rss":null,kml:null,"knowledge-graph-sublayer":null,"knowledge-graph":null,"link-chart":null,"map-notes":null,parquet:null,"subtype-group":null,unknown:null,unsupported:null,video:null};function N7(e){const t=e.declaredClass?e.declaredClass.slice(e.declaredClass.lastIndexOf(".")+1):"Unknown",i=t.replaceAll(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new fe(`${i}:view-not-supported`,`${t} is not supported in 3D`)}const Bx={hasLayerViewModule:e=>kx[e.type]!=null,importLayerView:e=>{const t=kx[e.type];if(t==null)throw N7(e);return t(e)}},j7={"area-measurement":()=>k(()=>le(()=>import("./AreaMeasurementAnalysisView3D-CTDRr2is-3NwnTwTE.js"),__vite__mapDeps([380,3,381,7,1,2,8,6,4,9,10,382,14,19,20,170,167,87,101,27,180,186,185,168,171,69,172,38,173,166,169,86,174,175,176,13,177,36,37,178,179,181,182,183,184,34,11,12,92,187,91,93,26,89,94,188,383,350,351,346,46,222,131,15,50,28,47,48,293,79,341,347,348,384,385,328,192,193,194,25,5,29,30,31,32,33,35,39,40,41,42,43,195,97,196,232,386,256,340,342,343,16,387,388,21,22,23,389,257,390,200,391,392,393,394,395,396,397,398,399,400,401,402,302,213,18,344,345,403,112,113,189,190,191,128,197,75,198,201,202,203,146,51,204,205,206,143,207,208,209,68,210,211,212,214,215,141,82,83,84,81,80,70,216,160,217,221,226,227,233,234,121,199,165,218,219,220,98,99,223,224,225,228,229,230,231,235,236])),ue([381,1,382,7,8,5,6,4,2,9,10,383,14,19,20,186,183,88,102,28,196,202,201,184,187,70,188,39,189,182,185,87,190,191,192,13,193,37,38,194,195,197,198,199,200,35,11,12,93,203,92,94,27,90,95,204,384,351,352,347,47,236,132,15,51,29,48,49,294,80,342,348,349,385,386,329,207,208,209,26,3,30,31,32,33,34,36,40,41,42,43,44,210,98,211,246,387,257,341,343,344,16,388,389,21,22,23,24,390,258,391,180,392,393,394,395,396,397,398,399,400,401,402,403,303,227,18,345,346,404,113,114,205,206,175,129,122,52,212,76,213,214,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,225,226,228,229,142,83,84,85,82,81,230,166,231,232,233,234,99,100,235,237,238,239,240,241,242,243,244,245,247,248,249,250])),dimension:()=>k(()=>le(()=>import("./DimensionAnalysisView3D-BOeost4V-CmXaDhD5.js"),__vite__mapDeps([404,3,382,4,7,1,2,8,381,6,9,10,14,69,19,20,38,167,172,173,170,87,186,27,101,185,192,169,86,166,168,171,174,175,176,13,177,36,37,178,179,180,181,182,183,184,34,11,12,92,187,91,93,26,89,94,188,193,194,25,5,15,28,29,30,31,32,33,35,39,40,41,42,43,195,97,196,388,346,46,222,131,50,47,48,293,79,341,347,348,385,21,16,22,23,389,405,232,384,328,386,256,398,399,340,342,343,200,406,391,392,393,394,395,396,397,407,255,257,390,402,302,213,18,344,345,403,401,400,387,408,352,112,113,189,190,191,128,197,75,198,201,202,203,146,51,204,205,206,143,207,208,209,68,210,211,212,214,215,141,82,83,84,81,80,70,216,160,217,221,226,227,233,234,121,199,165,218,219,220,98,99,223,224,225,228,229,230,231,235,236])),ue([405,1,383,2,7,8,5,6,382,4,9,10,14,70,19,20,39,183,188,189,186,88,202,28,102,201,207,185,87,182,184,187,190,191,192,13,193,37,38,194,195,196,197,198,199,200,35,11,12,93,203,92,94,27,90,95,204,208,209,26,3,15,29,30,31,32,33,34,36,40,41,42,43,44,210,98,211,389,347,47,236,132,51,48,49,294,80,342,348,349,386,21,16,22,23,24,390,406,246,385,329,387,257,399,400,341,343,344,180,407,392,393,394,395,396,397,398,408,256,258,391,403,303,227,18,345,346,404,402,401,388,409,353,113,114,205,206,175,129,122,52,212,76,213,214,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,225,226,228,229,142,83,84,85,82,81,230,166,231,232,233,234,99,100,235,237,238,239,240,241,242,243,244,245,247,248,249,250])),"direct-line-measurement":()=>k(()=>le(()=>import("./DirectLineMeasurementAnalysisView3D-DMU2hgOq-DFNimEOg.js"),__vite__mapDeps([409,3,381,7,1,2,8,6,4,9,10,382,384,101,27,19,20,14,69,38,167,87,385,328,170,37,166,168,169,86,171,172,173,174,175,176,13,177,36,178,179,180,181,182,183,184,34,11,12,92,185,186,187,91,93,26,89,94,188,192,193,194,25,5,15,28,29,30,31,32,33,35,39,40,41,42,43,195,97,196,222,131,232,386,256,346,46,50,47,48,293,79,341,347,348,16,387,388,21,22,23,389,391,392,393,394,395,396,397,390,200,383,398,399,340,342,343,401,402,302,213,18,344,345,112,113,189,190,191,128,197,75,198,201,202,203,146,51,204,205,206,143,207,208,209,68,210,211,212,214,215,141,82,83,84,81,80,70,216,160,217,221,226,227,233,234,121,199,165,218,219,220,98,99,223,224,225,228,229,230,231,235,236])),ue([410,1,382,7,8,5,6,4,2,9,10,383,385,102,28,19,20,14,70,39,183,88,386,329,186,38,182,184,185,87,187,188,189,190,191,192,13,193,37,194,195,196,197,198,199,200,35,11,12,93,201,202,203,92,94,27,90,95,204,207,208,209,26,3,15,29,30,31,32,33,34,36,40,41,42,43,44,210,98,211,236,132,246,387,257,347,47,51,48,49,294,80,342,348,349,16,388,389,21,22,23,24,390,392,393,394,395,396,397,398,391,180,384,399,400,341,343,344,402,403,303,227,18,345,346,113,114,205,206,175,129,122,52,212,76,213,214,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,225,226,228,229,142,83,84,85,82,81,230,166,231,232,233,234,99,100,235,237,238,239,240,241,242,243,244,245,247,248,249,250])),"elevation-profile":()=>k(()=>le(()=>import("./ElevationProfileAnalysisView3D-DL54O_5q-Bhw1t0u-.js"),__vite__mapDeps([410,1,2,3,382,4,7,8,167,6,9,10,19,20,14,171,69,87,172,38,173,170,211,46,101,27,198,166,168,169,86,174,175,176,13,177,36,37,178,179,180,181,182,183,184,34,11,12,92,185,186,187,91,93,26,89,94,188,223,196,222,131,346,15,50,28,47,48,293,79,341,347,348,215,16,141,82,83,84,81,80,70,216,113,160,18,213,411,232,390,412,130,393,385,394,328,413,414,351,415,17,416,417,418,419,420,421,422,423,424,425,426,427,428,164,339,75,381,201,202,203,146,51,204,205,35,22,206,143,207,208,209,68,210,25,5,29,30,31,32,33,39,40,41,42,43,200,429,191,117,108,118,148,430,431,349,350,352,21,23,112,189,190,128,192,193,194,195,97,197,212,214,217,221,226,227,233,234,121,199,165,218,219,220,98,99,224,225,228,229,230,231,235,236])),ue([411,1,383,2,7,8,5,6,183,4,9,10,19,20,14,187,70,88,188,39,189,186,225,47,102,28,213,182,184,185,87,190,191,192,13,193,37,38,194,195,196,197,198,199,200,35,11,12,93,201,202,203,92,94,27,90,95,204,237,211,236,132,347,15,51,29,48,49,294,80,342,348,349,229,16,142,83,84,85,82,81,71,230,114,161,18,227,412,246,391,413,131,394,386,395,329,414,415,352,416,17,417,418,419,420,421,422,423,424,425,426,427,428,429,165,340,76,382,215,216,217,147,52,218,219,36,22,220,144,221,222,223,69,224,26,3,30,31,32,33,34,40,41,42,43,44,180,430,175,118,109,119,149,431,432,350,351,353,21,23,24,113,205,206,129,207,208,209,210,98,122,212,214,226,228,166,231,232,233,234,99,100,235,238,239,240,241,242,243,244,245,247,248,249,250])),"line-of-sight":()=>k(()=>le(()=>import("./LineOfSightAnalysisView3D-Dvtqyw5y-Dhjtpi3u.js"),__vite__mapDeps([432,3,6,1,2,7,8,4,9,10,382,433,167,19,20,14,171,69,87,172,38,173,170,223,36,37,187,86,196,46,200,101,27,222,131,11,12,34,166,168,169,174,175,176,13,177,178,179,180,181,182,183,184,92,185,186,91,93,26,89,94,188,384,385,328,192,193,194,25,5,15,28,29,30,31,32,33,35,39,40,41,42,43,195,97,232,386,256,213,18,434,206,143,207,22,208,130,435,394,401,399,340,341,342,343,395,21,16,23,112,113,189,190,191,128,197,75,198,201,202,203,146,51,204,205,209,68,210,50,47,48,211,212,214,215,141,82,83,84,81,80,70,216,160,217,221,226,227,233,234,121,199,165,218,219,220,98,99,224,225,79,228,229,230,231,235,236])),ue([433,1,4,5,6,7,8,2,9,10,383,434,183,19,20,14,187,70,88,188,39,189,186,237,37,38,203,87,211,47,180,102,28,236,132,11,12,35,182,184,185,190,191,192,13,193,194,195,196,197,198,199,200,93,201,202,92,94,27,90,95,204,385,386,329,207,208,209,26,3,15,29,30,31,32,33,34,36,40,41,42,43,44,210,98,246,387,257,227,18,435,220,144,221,22,222,131,436,395,402,400,341,342,343,344,396,21,16,23,24,113,114,205,206,175,129,122,52,212,76,213,214,215,216,217,147,218,219,223,69,224,71,161,51,48,49,225,226,228,229,142,83,84,85,82,81,230,166,231,232,233,234,99,100,235,238,239,80,240,241,242,243,244,245,247,248,249,250])),slice:()=>k(()=>le(()=>import("./SliceAnalysisView3D-DgDeGnnd-0fWg2d3H.js"),__vite__mapDeps([436,3,382,4,437,13,14,232,86,19,9,7,1,2,8,20,87,69,6,10,38,179,173,167,172,170,438,92,34,101,27,192,169,166,168,171,174,175,176,177,36,37,178,180,181,182,183,184,11,12,185,186,187,91,93,26,89,94,188,193,194,25,5,15,28,29,30,31,32,33,35,39,40,41,42,43,195,97,196,384,385,328,222,131,386,256,257,259,110,106,107,108,109,47,48,111,112,113,16,114,100,102,115,116,117,118,68,119,120,121,22,122,123,124,125,126,50,127,128,129,130,70,45,46,49,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,132,133,134,135,136,137,138,139,140,141,142,76,77,75,78,79,80,81,82,83,84,74,85,143,144,145,146,147,148,149,150,151,152,153,154,155,23,156,157,158,260,261,262,263,264,265,165,247,406,439,255,398,399,340,341,342,343,401,400,390,21,189,190,191,197,198,200,201,202,203,204,205,206,207,208,209,210,211,212,213,18,214,215,216,160,217,221,226,227,233,234,199,218,219,220,98,99,223,224,225,228,229,230,231,235,236])),ue([437,1,383,2,438,13,14,246,87,19,9,7,8,5,6,20,88,70,4,10,39,195,189,183,188,186,439,93,35,102,28,207,185,182,184,187,190,191,192,193,37,38,194,196,197,198,199,200,11,12,201,202,203,92,94,27,90,95,204,208,209,26,3,15,29,30,31,32,33,34,36,40,41,42,43,44,210,98,211,385,386,329,236,132,387,257,258,260,111,107,108,109,110,48,49,112,113,114,16,115,101,103,116,117,118,119,69,120,121,122,22,123,124,125,126,127,51,128,129,130,131,71,46,47,50,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,133,134,135,136,137,138,139,140,141,142,143,77,78,76,79,80,81,82,83,84,85,75,86,144,145,146,147,148,149,150,151,152,153,154,155,156,23,157,158,159,261,262,263,264,265,266,166,178,407,440,256,399,400,341,342,343,344,402,401,391,21,24,205,206,175,212,213,214,180,18,215,216,217,218,219,220,221,222,223,224,161,225,226,227,228,229,230,231,232,233,234,99,100,235,237,238,239,240,241,242,243,244,245,247,248,249,250])),viewshed:()=>k(()=>le(()=>import("./ViewshedAnalysisView3D-DIPvknvR-DaYSuxNB.js"),__vite__mapDeps([440,3,433,167,6,1,2,7,8,4,9,10,19,20,14,171,69,87,172,38,173,170,223,36,37,187,86,196,101,27,382,384,385,328,166,168,169,174,175,176,13,177,178,179,180,181,182,183,184,34,11,12,92,185,186,91,93,26,89,94,188,192,193,194,25,5,15,28,29,30,31,32,33,35,39,40,41,42,43,195,97,222,131,232,386,256,398,399,340,341,342,343,441,46,442,411,390,438,392,393,394,401,400,395,21,16,22,23,112,113,189,190,191,128,197,75,198,200,201,202,203,146,51,204,205,206,143,207,208,209,68,210,50,47,48,211,212,213,18,214,215,141,82,83,84,81,80,70,216,160,217,221,226,227,233,234,121,199,165,218,219,220,98,99,224,225,79,228,229,230,231,235,236])),ue([441,1,434,183,4,5,6,7,8,2,9,10,19,20,14,187,70,88,188,39,189,186,237,37,38,203,87,211,102,28,383,385,386,329,182,184,185,190,191,192,13,193,194,195,196,197,198,199,200,35,11,12,93,201,202,92,94,27,90,95,204,207,208,209,26,3,15,29,30,31,32,33,34,36,40,41,42,43,44,210,98,236,132,246,387,257,399,400,341,342,343,344,442,47,443,412,391,439,393,394,395,402,401,396,21,16,22,23,24,113,114,205,206,175,129,122,52,212,76,213,214,180,18,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,166,231,232,233,234,99,100,235,238,239,80,240,241,242,243,244,245,247,248,249,250])),"volume-measurement":()=>k(()=>le(()=>import("./VolumeMeasurementAnalysisView3D-Dz4lZMha-A3JC4I9F.js"),__vite__mapDeps([443,3,7,1,2,8,6,4,9,10,381,382,13,14,34,351,38,167,19,20,200,101,27,181,69,37,233,130,11,12,131,384,87,385,328,170,166,168,169,86,171,172,173,174,175,176,177,36,178,179,180,182,183,184,92,185,186,187,91,93,26,89,94,188,192,193,194,25,5,15,28,29,30,31,32,33,35,39,40,41,42,43,195,97,196,222,232,386,256,444,291,306,56,414,415,165,227,346,46,50,47,48,293,79,341,347,348,16,387,388,21,22,23,389,412,393,394,413,390,24,429,191,117,108,118,68,148,437,438,257,398,399,340,342,343,431,445,446,226,71,447,448,430,18,51,201,202,203,146,204,205,206,143,207,208,209,210,349,350,352,345,112,113,189,190,128,197,75,198,211,212,213,214,215,141,82,83,84,81,80,70,216,160,217,221,234,121,199,218,219,220,98,99,223,224,225,228,229,230,231,235,236])),ue([444,1,7,8,5,6,4,2,9,10,382,383,13,14,35,352,39,183,19,20,180,102,28,197,70,38,247,131,11,12,132,385,88,386,329,186,182,184,185,87,187,188,189,190,191,192,193,37,194,195,196,198,199,200,93,201,202,203,92,94,27,90,95,204,207,208,209,26,3,15,29,30,31,32,33,34,36,40,41,42,43,44,210,98,211,236,246,387,257,445,292,307,57,415,416,166,241,347,47,51,48,49,294,80,342,348,349,16,388,389,21,22,23,24,390,413,394,395,414,391,25,430,175,118,109,119,69,149,438,439,258,399,400,341,343,344,432,446,447,240,72,448,449,431,18,52,215,216,217,147,218,219,220,144,221,222,223,224,350,351,353,346,113,114,205,206,129,122,212,76,213,214,71,161,225,226,227,228,229,142,83,84,85,82,81,230,231,232,233,234,99,100,235,237,238,239,242,243,244,245,248,249,250]))};function U7(e){const t=j7[e.type];if(!t)throw new fe("analysis-view-module-import-utils:analysis-not-supported",`Analysis "${e.type}" is not supported`);return t()}let wa=class extends ie{constructor(e){super(e),this.collision=new ld,this.distance=1/0,this.minimumPoiDistance=4,this.tilt=null}get altitude(){return this.mode===2?null:this._get("altitude")||null}set altitude(e){this.mode!==2?this._set("altitude",e):$.getLogger(this).warn("Altitude constraint is ignored in local scenes")}get mode(){return this.state.viewingMode}clampAltitude(e){return this.altitude?j(e,this.altitude.min,this.altitude.max):e}clampTilt(e,t){if(!this.tilt)return t;const i=this.tilt(e);return j(t,i.min,i.max)}clampDistance(e){return Math.min(e,this.distance)}createDefaultTilt(){return this.mode===2?this._createDefaultTiltLocal():this._createDefaultTiltGlobal()}createConstantMaxTilt(e){return(t,i=Ey)=>(i.min=Ni.min,i.max=e,i)}_createDefaultTiltLocal(){const e=this.collision.enabled?Pf([[4e3,Ni.max],[1e4,rt(88)],[6e6,rt(88)]]):()=>Ni.max;return(t,i=Ey)=>(i.min=Ni.min,i.max=e(t),i)}_createDefaultTiltGlobal(){const e=this.collision.enabled?Pf([[4e3,Ni.max],[5e4,rt(88)],[6e6,rt(88)],[2e7,Ni.min]]):Pf([[3e5,Ni.max],[3e6,rt(88)],[6e6,rt(88)],[2e7,Ni.min]]);return(t,i=Ey)=>(i.min=Ni.min,i.max=e(t),i)}};function H7(e){return{min:-2e5,max:4*e.radius}}h([d()],wa.prototype,"altitude",null),h([d({readOnly:!0})],wa.prototype,"collision",void 0),h([d()],wa.prototype,"distance",void 0),h([d({readOnly:!0})],wa.prototype,"minimumPoiDistance",void 0),h([d()],wa.prototype,"tilt",void 0),h([d({constructOnly:!0})],wa.prototype,"state",void 0),wa=h([D("esri.views.3d.state.Constraints")],wa);const Nx=H7(Li),Ni={min:rt(.5),max:rt(179.5)},Ey={min:0,max:0};let ld=class extends ie{constructor(){super(...arguments),this.enabled=!0,this.elevationMargin=5}};h([d({type:Boolean})],ld.prototype,"enabled",void 0),h([d({type:Number})],ld.prototype,"elevationMargin",void 0),ld=h([D("esri.views.3d.state.Constraints.CollisionConstraint")],ld);let Mh=class extends D_{constructor(){super(...arguments),this.min=Nx.min,this.max=Nx.max}};h([d({type:Number})],Mh.prototype,"min",void 0),h([d({type:Number})],Mh.prototype,"max",void 0),Mh=h([D("esri.views.3d.constraints.AltitudeConstraint")],Mh);let Aa=class extends D_{constructor(){super(...arguments),this.mode="auto"}get near(){return this._get("near")}set near(e){this._set("near",e),e>=this._get("far")&&(this.far=e+1e-9),this.mode="manual"}castNear(e){return Math.max(1e-8,e)}get far(){return this._get("far")}set far(e){this._set("far",e),e<=this._get("near")&&(this.near=e-1e-9),this.mode="manual"}castFar(e){return Math.max(1e-8,e)}autoUpdate(e,t){this.mode==="auto"&&(this._get("near")!==e&&this._set("near",e),this._get("far")!==t&&this._set("far",t))}};h([d({type:Number,value:1e-8})],Aa.prototype,"near",null),h([Ua("near")],Aa.prototype,"castNear",null),h([d({type:Number,value:1e-8})],Aa.prototype,"far",null),h([Ua("far")],Aa.prototype,"castFar",null),h([d({type:["auto","manual"]})],Aa.prototype,"mode",void 0),Aa=h([D("esri.views.3d.constraints.ClipDistanceConstraint")],Aa);const Zv={min:sc(Ni.min),max:sc(Ni.max)};let Al=class extends D_{constructor(e){super(e),this.mode="auto"}get max(){return this._get("max")}set max(e){this._set("max",e),this.mode="manual"}castMax(e){return j(e,Zv.min,Zv.max)}autoUpdate(e){this.mode==="auto"&&this._get("max")!==e&&this._set("max",e)}};h([d({type:["auto","manual"]})],Al.prototype,"mode",void 0),h([d({type:Number,value:Zv.max})],Al.prototype,"max",null),h([Ua("max")],Al.prototype,"castMax",null),Al=h([D("esri.views.3d.constraints.TiltConstraint")],Al);let Il=class extends D_{constructor(e){super(e),this.tilt=new Al,this.altitude=new Mh,this.clipDistance=new Aa}};h([d({type:Al,nonNullable:!0})],Il.prototype,"tilt",void 0),h([d({type:Mh,nonNullable:!0})],Il.prototype,"altitude",void 0),h([d({type:Aa,nonNullable:!0})],Il.prototype,"clipDistance",void 0),Il=h([D("esri.views.3d.constraints.Constraints")],Il);function jx(e){return rc(e,$9)||A2(e)?{wkid:104971}:rc(e,W9)||I2(e)?{wkid:104903}:At.WGS84}let Au=class{constructor(e,t,i,r,s,n,a,o,l=.5){this.coverage=e,this.density=t,this.absorption=i,this.cloudSize=r,this.detailSize=s,this.smoothness=n,this.cloudHeight=a,this.raymarchingSteps=o,this.median=l}};const Bi={sunny:new Au([0,.6],[.03,.03],[0,0],[.9,.9],[.8,.8],[.7,.7],[.05,.05],0),cloudy:new Au([.3,.65],[.2,.4],[0,0],[.85,.85],[.75,.75],[.3,.4],[1,1],2,.6),rainy:new Au([.6,.8],[.5,.8],[.1,.5],[.9,.9],[.75,.75],[.5,.5],[1,1],2,.4),snowy:new Au([.25,.75],[.3,.3],[0,0],[.95,.95],[.7,.7],[.69,.75],[.3,1],1,.65),foggy:new Au([.8,.8],[.5,.5],[0,0],[.95,.95],[.9,.9],[.55,.55],[.3,.3],0)};Bi.default=Bi.sunny;const As=Qe("esri-mobile")?64:128,q7=As/128,ln=Math.ceil(Math.sqrt(As)),Ba=(As+2)*ln,G7=1e5,fm=128,$7=Ba/1560;let au=class extends ha{constructor(e,t){super(e,"bool",1,(i,r,s)=>i.setUniform1b(e,t(r,s)))}};function Wp(e){e.code.add(_`vec2 sphereIntersect(vec3 start, vec3 dir, float distance) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float d = (b * b) - 4.0 * a * distance;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`)}let ub=class extends Kt{constructor(){super(...arguments),this.cloudRadius=0,this.cloudSize=0,this.detailSize=0,this.absorption=0,this.density=0,this.smoothness=0,this.cloudHeight=0,this.coverage=0,this.lastSlice=!1,this.viewMatrix=Rn()}};const Uh=Qe("esri-mobile")?1024:2048;function _R(e){const t=new ut;t.include($i,!1);const i=t.fragment;return i.include(Wp),i.uniforms.add(new _e("cloudRadius",r=>r.cloudRadius),new _e("power",r=>De(35,120,r.absorption)),new _e("sigmaE",r=>1+r.absorption),new _e("density",r=>De(0,.3,r.density)),new _e("cloudSize",r=>De(0,.02,Math.max(.01,1-r.cloudSize))),new _e("detailSize",r=>De(0,.2,Math.max(.01,1-r.detailSize))),new _e("smoothness",r=>De(0,.5,1-r.smoothness)),new _e("cloudHeight",r=>De(0,1500,r.cloudHeight)),new _e("coverage",r=>r.coverage),new k8("view",r=>r.viewMatrix),new Ne("cloudShapeTexture",r=>r.noiseTexture!=null?r.noiseTexture.textureAtlas:null),new qs("cloudVariables",r=>Ki(W7,r.coverage,r.absorption)),new au("lastSlice",r=>r.lastSlice)),i.constants.add("halfCubeMapSize","float",.5*Uh),i.code.add(_`
    const int STEPS = ${e.steps===0?_`16`:e.steps===1?_`100`:_`200`};
    const int STEPS_LIGHT = 6;
    const float stepL = 300.0 / float(STEPS_LIGHT);
    const float cloudStart = 1500.0;

    vec3 rayDirection(vec2 fragCoord) {
      vec2 xy = fragCoord;
      xy.x -= halfCubeMapSize;
      xy.y = lastSlice ? fragCoord.y - halfCubeMapSize : fragCoord.y;

      return normalize(vec3(-xy, -halfCubeMapSize));
    }

    float remap(float x, float low1, float high1, float low2, float high2) {
      return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
    }

    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }`),i.code.add(_`
    float getCloudShape(vec3 pos, float pOffset) {
      const float textureWidth = ${_.float(Ba)};
      const float dataWidth = ${_.float(Ba)};
      const float tileRows = ${_.float(ln)};
      const vec3 atlasDimensions = vec3(${_.float(As)}, ${_.float(As)}, tileRows * tileRows);

      //Change from Y being height to Z being height
      vec3 p = float(${_.float(q7)}) * pos.xzy;

      //Pixel coordinates of point in the 3D data
      vec3 coord = vec3(mod(p - pOffset * atlasDimensions, atlasDimensions));
      float f = fract(coord.z);
      float level = floor(coord.z);
      float tileY = floor(level / tileRows);
      float tileX = level - tileY * tileRows;

      //The data coordinates are offset by the x and y tile, the two boundary cells between each tile pair and the initial boundary cell on the first row/column
      vec2 offset = atlasDimensions.x * vec2(tileX, tileY) + 2.0 * vec2(tileX, tileY) + 1.0;
      vec2 pixel = coord.xy + offset;
      vec2 data = texture(cloudShapeTexture, mod(pixel, dataWidth) / textureWidth).xy;

      return 1.0 - mix(data.x, data.y, f);
    }

    float getCloudMap(vec2 p){
      // Shift the texture center to origin to avoid seam artifacts
      vec2 uv = (${_.float($7)} * p) / ${_.float(Ba)} + 0.5;

      return texture(cloudShapeTexture, uv).a;
    }
    `),i.code.add(_`float clouds(vec3 p) {
float cloud = saturate(0.5 * mix(0.0, 1.0, min(2.0 * coverage, 1.0)));
if (cloud <= 0.0) {
return 0.0;
}
float cloudMap = getCloudMap(cloudSize * p.xy);
cloud = mix(cloud, min(2.0 * (coverage), 1.0) * cloudMap, min(2.0 * (1.0 - coverage), 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float shape = getCloudShape(8.0 * cloudSize * p, 0.0);
cloud = saturate(remap(cloud, smoothness * shape, 1.0, 0.0, 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float heightFraction = saturate((length(p) - cloudRadius - cloudStart) / cloudHeight);
cloud *= saturate(remap(heightFraction, 0.0, 0.25, 0.0, 1.0)) * smoothstep(1.0, 0.25, heightFraction);
if (cloud <= 0.0) {
return 0.0;
}
return density * saturate(remap(cloud, 0.35 * smoothness * getCloudShape(detailSize * p, 0.0), 1.0, 0.0, 1.0));
}`),i.code.add(_`float HenyeyGreenstein(float g, float costh) {
return (1.0 / (4.0 * 3.1415))  * ((1.0 - g * g) / pow(1.0 + g * g - 2.0 * g * costh, 1.5));
}
float multipleOctaves(float extinction, float mu, float stepL) {
float attenuation = 1.0;
float contribution = 1.0;
float phaseAttenuation = 1.0;
float luminance = 0.0;
for (int i = 0; i < 4; i++) {
float phase = mix(HenyeyGreenstein(0.0, mu), HenyeyGreenstein(0.3 * phaseAttenuation, mu), 0.7);
luminance += contribution * phase * exp(-stepL * extinction * sigmaE * attenuation);
attenuation *= 0.2;
contribution *= 0.6;
phaseAttenuation *= 0.5;
}
return luminance;
}`),i.code.add(_`float lightRay(vec3 org, vec3 p, float phaseFunction, float mu, vec3 sunDirection) {
float lightRayDensity = clouds(p);
lightRayDensity += clouds(p + sunDirection * 1.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 2.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 3.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 4.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 5.0 * stepL);
float beersLaw = multipleOctaves(lightRayDensity, mu, stepL);
return mix(beersLaw * 2.0 * (1.0 - (exp(-stepL * lightRayDensity * 2.0 * sigmaE ))), beersLaw, 0.5 + 0.5 * mu);
}`),i.code.add(_`float mainRay(vec3 org, vec3 dir, vec3 sunDirection, float distToStart, float totalDistance, out float totalTransmittance) {
if (dir.z < 0.0) {
return 0.0;
}
totalTransmittance = 1.0;
float stepS = totalDistance / float(STEPS);
float cameraHeight = length(org);
float mu = 0.5 + 0.5 * dot(sunDirection, dir);
float phaseFunction = mix(HenyeyGreenstein(-0.3, mu), HenyeyGreenstein(0.3, mu), 0.7);
vec3 p = org + distToStart  * dir;
float dist = distToStart;
float shading = 0.0;
for (int i = 0; i < STEPS; i++) {
float sampleDensity = clouds(p);
float sampleSigmaE = sampleDensity * sigmaE;
if (sampleDensity > 0.0 ) {
float ambient = mix((1.2), (1.6), saturate((length(p) - cloudRadius - cloudStart) / cloudHeight));
float luminance = sampleDensity * (ambient + power * phaseFunction * lightRay(org, p, phaseFunction, mu, sunDirection));
float transmittance = exp(-sampleSigmaE * stepS);
shading += totalTransmittance * (luminance - luminance * transmittance) / sampleSigmaE;
totalTransmittance *= transmittance;
if (totalTransmittance <= 0.001) {
totalTransmittance = 0.0;
break;
}
}
dist += stepS;
p = org + dir * dist;
}
return shading;
}`),i.main.add(_`if (coverage ==  0.0) {
fragColor = vec4(0.0, 1.0, 0.0, 1.0);
return;
}
vec3 rayDir = rayDirection(gl_FragCoord.xy);
rayDir = normalize(view * rayDir);
vec3 viewPos = vec3(0, 0, cloudRadius + 1.0);
float hazeFactor = smoothstep(-0.01, mix(0.0, 0.075, cloudVariables.x), abs(dot(rayDir, vec3(0, 0, 1))));
float totalTransmittance = 1.0;
float shading = 0.0;
float cloudDistance = cloudRadius + cloudStart;
float rayStartDistance = dot(viewPos, viewPos) - (cloudDistance * cloudDistance);
vec2 rayStartIntersect = sphereIntersect(viewPos, rayDir, rayStartDistance);
float rayEndDistance = dot(viewPos, viewPos) - ((cloudDistance + cloudHeight) * (cloudDistance + cloudHeight));
vec2 rayEndIntersect = sphereIntersect(viewPos, rayDir, rayEndDistance);
float distToStart = rayStartIntersect.y;
float totalDistance = rayEndIntersect.y - distToStart;
vec3 sunDirection = normalize(vec3(0, 0, 1));
shading = 0.5 * mainRay(viewPos, rayDir, sunDirection, distToStart, totalDistance, totalTransmittance);
shading = mix(clamp(1.0 - cloudVariables.y, 0.6, 1.0), shading, hazeFactor);
totalTransmittance = mix(0.0, totalTransmittance, hazeFactor);
fragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);`),t}const W7=ze(),Z7=Object.freeze(Object.defineProperty({__proto__:null,CloudsPassParameters:ub,build:_R,cubeMapSize:Uh},Symbol.toStringTag,{value:"Module"}));let Ay=class extends ct{constructor(e,t){super(e,t,new ht(Z7,()=>k(()=>Promise.resolve().then(()=>WJ),void 0)),ai)}initializePipeline(e){return Ge({blending:M2(32769,32770,32774,e.writeTextureChannels===0?[1,1,0,0]:[0,0,1,1]),depthTest:{func:515},colorWrite:st})}},Qv=class extends hr{constructor(){super(...arguments),this.steps=0,this.writeTextureChannels=0}};h([z({count:3})],Qv.prototype,"steps",void 0),h([z({count:2})],Qv.prototype,"writeTextureChannels",void 0);let db=class extends Kt{constructor(){super(...arguments),this.weatherTile=yu(0,0)}};function yR(e){const t=new ut;return t.include($i,!1),t.fragment.code.add(_`float remap(float x, float low1, float high1, float low2, float high2) {
return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
}`),e.mode===0&&(t.fragment.code.add(_`float saturate(float x) {
return clamp(x, 0.0, 1.0);
}`),t.fragment.code.add(_`vec3 modulo(vec3 m, float n) {
return mod(mod(m, n) + n, n);
}
vec3 hash(vec3 p3, float frequency) {
p3 = modulo(p3, frequency);
p3 = fract(p3 * vec3(0.1031, 0.1030, 0.0973));
p3 += dot(p3, p3.yxz + 33.33);
return -1.0 + 2.0 * fract((p3.xxy + p3.yxx) * p3.zyx);
}`),t.fragment.code.add(_`vec3 fade(vec3 t) {
return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
}`),t.fragment.code.add(_`
    float gradientNoise(vec3 p, float frequency) {
      vec3 i = floor(p);
      vec3 f = fract(p);
      vec3 u = fade(f);
      return mix( mix( mix( dot( hash( i + vec3(0.0,0.0,0.0), frequency), f - vec3(0.0,0.0,0.0) ),
                            dot( hash( i + vec3(1.0,0.0,0.0), frequency), f - vec3(1.0,0.0,0.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,0.0), frequency), f - vec3(0.0,1.0,0.0) ),
                            dot( hash( i + vec3(1.0,1.0,0.0), frequency), f - vec3(1.0,1.0,0.0) ), u.x), u.y),
                  mix( mix( dot( hash( i + vec3(0.0,0.0,1.0), frequency), f - vec3(0.0,0.0,1.0) ),
                            dot( hash( i + vec3(1.0,0.0,1.0), frequency), f - vec3(1.0,0.0,1.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,1.0), frequency), f - vec3(0.0,1.0,1.0) ),
                            dot( hash( i + vec3(1.0,1.0,1.0), frequency), f - vec3(1.0,1.0,1.0) ), u.x), u.y), u.z );
    }

    float getPerlinNoise(vec3 pos, float frequency) {
      float octaveFrequency = 2.0;
      float sum = 0.0;
      float weightSum = 0.0;
      float weight = 1.0;

      for (int oct = 0; oct < 3; oct++) {
        vec3 p = pos * frequency;
        float val = 0.5 + 0.5 * gradientNoise(p, frequency);
        sum += val * weight;
        weightSum += weight;
        weight *= 0.5;
        frequency *= octaveFrequency;
      }

      float noise = (sum / weightSum);
      noise = saturate(noise);
      return noise;
    }

    float worley(vec3 pos, float numCells) {
      vec3 p = pos * numCells;
      float d = 1.0e10;

      for (int x = -1; x <= 1; x++) {
        for (int y = -1; y <= 1; y++) {
          for (int z = -1; z <= 1; z++) {
            vec3 tp = floor(p) + vec3(x, y, z);
            tp = p - tp - (hash(tp, numCells) * 0.5 + 0.5);
            d = min(d, dot(tp, tp));
          }
        }
      }

      return 1.0 - clamp(d, 0.0, 1.0);
    }

    vec3 get3Dfrom2D(vec2 uv) {
      vec2 tile = floor(uv);
      float z = floor(${_.float(ln)} * tile.y + tile.x);
      return vec3(fract(uv), z);
    }

    float getTextureForPointPerlinWorley(vec3 p) {
      float perlinNoise = getPerlinNoise(p, ${_.float(8)});

      float worley0 = worley(p, ${_.float(2)} * 2.0);
      float worley1 = worley(p, ${_.float(2)} * 8.0);
      float worley2 = worley(p, ${_.float(2)} * 14.0);

      float worleyFBM = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      return remap(perlinNoise, 0.0, 1.0, worleyFBM, 1.0);
    }

    float getTextureForPointWorley(vec3 p) {
      float worley0 = worley(p, ${_.float(2)});
      float worley1 = worley(p, ${_.float(2)} * 2.0);
      float worley2 = worley(p, ${_.float(2)} * 4.0);
      float worley3 = worley(p, ${_.float(2)} * 8.0);

      float FBM0 = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      float FBM1 = worley1 * 0.625 + worley2 * 0.25 + worley3 * 0.125;
      float FBM2 = worley2 * 0.75 + worley3 * 0.25;

      return FBM0 * 0.625 + FBM1 * 0.25 + FBM2 * 0.125;
    }
  `)),t.fragment.uniforms.add(new qs("weatherTile",i=>i.weatherTile)).code.add(_`
    vec2 modulo(vec2 m, float n){
      return mod(mod(m, n) + n, n);
    }

    vec2 hash(vec2 p){
      // Get position of p in weather tile
      p = modulo(p, ${_.float(fm)});

      // Get global coordinates of p
      p += weatherTile * ${_.float(fm)};

      // Limit position to avoid numerical instability
      p = modulo(p, ${_.float(G7)});

      vec3 p3 = fract(vec3(p.xyx) * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yzx + 33.33);
      return 2.0 * fract((p3.xx + p3.yz) * p3.zy) - 1.0;
    }

    vec2 fade(vec2 t){
      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
    }

    float gradientNoise(vec2 p){
      vec2 i = floor( p );
      vec2 f = fract( p );

      vec2 u = fade(f);

      // Bilinear interpolation of gradients at cell vertices around point
      return  mix(
                mix(dot( hash( i + vec2(0.0,0.0) ), f - vec2(0.0,0.0) ),
                    dot( hash( i + vec2(1.0,0.0) ), f - vec2(1.0,0.0) ), u.x),
                mix(dot( hash( i + vec2(0.0,1.0) ), f - vec2(0.0,1.0) ),
                    dot( hash( i + vec2(1.0,1.0) ), f - vec2(1.0,1.0) ), u.x),
                u.y);
    }

    float worley(vec2 p){
      float d = 1.0e10;
      for (int x = -1; x <= 1; x++){
        for (int y = -1; y <= 1; y++){
                vec2 tp = floor(p) + vec2(x, y);
                tp = p - tp - (0.5 + 0.5 * hash(tp));
                d = min(d, dot(tp, tp));
            }
        }
      return 1.0 - clamp(d, 0.0, 1.0);
    }
  `),e.mode===0?t.fragment.main.add(_`
      float padWidth = 1.0;
      float paddedSize = ${_.float(As)} + 2.0 * padWidth;
      float tileCount = ${_.float(ln)} * ${_.float(ln)};
      vec2 tile = floor((gl_FragCoord.xy - 0.5) / paddedSize);

      bool padCell = false;
      if (mod(gl_FragCoord.x, paddedSize) == 0.5 || mod(gl_FragCoord.x, paddedSize) == paddedSize - 0.5) {
        padCell = true;
      }

      if (mod(gl_FragCoord.y, paddedSize) == 0.5 || mod(gl_FragCoord.y, paddedSize) == paddedSize - 0.5) {
        padCell = true;
      }

      bool startPadX = false;
      bool startPadY = false;
      bool endPadX = false;
      bool endPadY = false;

      if (gl_FragCoord.x == tile.x * paddedSize + 0.5) {
        startPadX = true;
      }

      if (gl_FragCoord.y == tile.y * paddedSize + 0.5) {
        startPadY = true;
      }

      if (gl_FragCoord.x == (tile.x + 1.0) * paddedSize - 0.5) {
        endPadX = true;
      }

      if (gl_FragCoord.y == (tile.y + 1.0) * paddedSize - 0.5) {
        endPadY = true;
      }

      vec2 padding = vec2(2.0 * padWidth) * tile;
      vec2 uv;

      if (padCell) {
        vec2 pixel = gl_FragCoord.xy - padWidth - padding;

        if (startPadX) {
          pixel.x += ${_.float(As)};
        }

        if (startPadY) {
          pixel.y += ${_.float(As)};
        }

        if (endPadX) {
          pixel.x -= ${_.float(As)};
        }

        if (endPadY) {
          pixel.y -= ${_.float(As)};
        }

        uv = vec2(pixel.xy / ${_.float(As)});
      } else {
        vec2 pixel = gl_FragCoord.xy - padWidth - padding;
        uv = vec2(pixel.xy / ${_.float(As)});
      }

      vec3 p_ = get3Dfrom2D(uv);
      vec3 p = p_;
      p.z /= (${_.float(ln)} * ${_.float(ln)});

      float worleyPerlinNoise = getTextureForPointPerlinWorley(p);
      float worleyNoise = getTextureForPointWorley(p);

      fragColor.r = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));

      p_ = mod(p_ + 1.0, ${_.float(ln)} * ${_.float(ln)});
      p = p_;
      p.z /= (${_.float(ln)} * ${_.float(ln)});

      worleyPerlinNoise = getTextureForPointPerlinWorley(p);
      worleyNoise = getTextureForPointWorley(p);

      fragColor.g = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));

      vec2 mapUV = ${_.float(fm)} * (gl_FragCoord.xy / ${_.float(Ba)});
      float map = abs(gradientNoise(mapUV));
      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);
      fragColor.ba = vec2(0.0, map);
      `):t.fragment.main.add(_`
      vec2 mapUV = ${_.float(fm)} * (gl_FragCoord.xy / ${_.float(Ba)});
      float map = abs(gradientNoise(mapUV));
      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);
      fragColor = vec4(map);
    `),t}const Q7=Object.freeze(Object.defineProperty({__proto__:null,NoiseTextureAtlasPassParameters:db,build:yR},Symbol.toStringTag,{value:"Module"}));let Vf=class extends hr{constructor(){super(...arguments),this.mode=0}};h([z({count:2})],Vf.prototype,"mode",void 0);let Iy=class extends ct{constructor(e,t){super(e,t,new ht(Q7,()=>k(()=>Promise.resolve().then(()=>ZJ),void 0)),ai)}initializePipeline(e){return Ge({blending:e.mode===0?D2:mu(0,1,1,0),depthTest:{func:519},colorWrite:st})}},X7=class{constructor(e,t=0,i=t,r=!1,s=1){this.internalFormat=e,this.width=t,this.height=i,this.multisampled=r,this.samples=s}};function Y7(e){return e.width<=0||e.height<=0||e.internalFormat==null?0:e.width*e.height*ZA(e.internalFormat)}const K7=!!Qe("esri-tests-disable-gpu-memory-measurements");let vR=class{constructor(e,t){this._context=e,this._descriptor=t,this.type=2,this._context.instanceCounter.increment(yi.Renderbuffer,this);const i=this._context.gl;this.glName=i.createRenderbuffer(),this._context.bindRenderbuffer(this);const{width:r,height:s,internalFormat:n,multisampled:a}=t;a?i.renderbufferStorageMultisample(i.RENDERBUFFER,this.samples,n,r,s):i.renderbufferStorage(i.RENDERBUFFER,n,r,s),this._context.bindRenderbuffer(null)}get descriptor(){return this._descriptor}get samples(){const e=this._descriptor.samples,t=this._context.parameters.maxSamples;return e?Math.min(e,t):t}get usedMemory(){return K7?0:Y7(this._descriptor)}resize(e,t){const i=this._descriptor;if(i.width===e&&i.height===t)return;i.width=e,i.height=t;const r=this._context.gl;this._context.bindRenderbuffer(this),i.multisampled?r.renderbufferStorageMultisample(r.RENDERBUFFER,this.samples,i.internalFormat,i.width,i.height):r.renderbufferStorage(r.RENDERBUFFER,i.internalFormat,i.width,i.height),this._context.bindRenderbuffer(null)}dispose(){this._context&&(this._context.gl.deleteRenderbuffer(this.glName),this._context.instanceCounter.decrement(yi.Renderbuffer,this),this._context=null)}};const J7=()=>$.getLogger("esri.views.webgl.FramebufferObject");let Wo=class cd{constructor(t,i,r){if(this._context=t,this._glName=null,this._colorAttachments=new Map,this._depthStencilBuffer=null,this._depthStencilTexture=null,this._initialized=!1,t.instanceCounter.increment(yi.FramebufferObject,this),i!=null){const s=iV(t,i);s!=null&&(this._colorAttachments.set(Et,s),wo(s)?this._validateTextureDescriptor(s.descriptor):this._validateRenderbufferDescriptor(s.descriptor)),this._validateColorAttachmentPoint(Et)}if(r!=null)if(eV(r))this._depthStencilTexture=wo(r)?r:new bt(t,r),this._validateTextureDescriptor(this._depthStencilTexture.descriptor);else{const s=Xv(r)?r:new vR(t,r);this._depthStencilBuffer=s,this._validateRenderbufferDescriptor(s.descriptor)}}dispose(){const{_colorAttachments:t,_glName:i}=this;if(t.size===0&&!this._depthStencilBuffer&&!this._depthStencilTexture&&!i)return;const{_context:r}=this,s=r.getBoundFramebufferObject();t.forEach((n,a)=>this.detachColorTexture(a)?.dispose()),this.detachDepthStencilBuffer()?.dispose(),this.detachDepthStencilTexture()?.dispose(),r.gl.deleteFramebuffer(i),this._glName=null,r.bindFramebuffer(s===this?null:s),r.instanceCounter.decrement(yi.FramebufferObject,this)}get glName(){return this._glName}get colorTexture(){const t=this._colorAttachments.get(Et);return wo(t)?t:null}get depthStencil(){return this._depthStencilTexture||this._depthStencilBuffer}get depthStencilTexture(){return this._depthStencilTexture}get width(){return(this._colorAttachments.get(Et)??this._depthStencilTexture??this._depthStencilBuffer)?.descriptor?.width??0}get height(){return(this._colorAttachments.get(Et)??this._depthStencilTexture??this._depthStencilBuffer)?.descriptor?.height??0}get usedMemory(){return[...this._colorAttachments].reduce((t,[i,r])=>t+r.usedMemory,this.depthStencil?.usedMemory??0)}static{this._MAX_COLOR_ATTACHMENTS=-1}getColorTexture(t){const i=this._colorAttachments.get(t);return i&&wo(i)?i:null}get colorAttachments(){return[...this._colorAttachments.keys()]}attachColorTexture(t,i=Et){if(!t)return;this._validateColorAttachmentPoint(i);const{descriptor:r}=t;this._validateTextureDescriptor(r),this.detachColorTexture(i)?.dispose(),this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(t.glName,i)),this._colorAttachments.set(i,t)}detachColorTexture(t=Et){const i=this._colorAttachments.get(t);if(!i)return;const r=wo(i);return this._initialized&&this._context.temporaryBindFramebufferObject(this,()=>{if(r)this._framebufferTexture2D(null,t);else{const s=this._context.gl;s.framebufferRenderbuffer(s.FRAMEBUFFER,t,s.RENDERBUFFER,null)}}),this._colorAttachments.delete(t),r?i:void 0}setColorTextureTarget(t,i=Et,r=0){const s=this._colorAttachments.get(i);s&&(t===35866?this._framebufferTextureLayer(s.glName,i,36160,0,r):this._framebufferTexture2D(s.glName,i,t,36160,0))}attachDepthStencil(t){if(t)switch(t.type){case 1:return this._attachDepthStencilTexture(t);case 2:return this._attachDepthStencilBuffer(t)}}_attachDepthStencilTexture(t){if(t==null)return;const{descriptor:i}=t,{pixelFormat:r,dataType:s}=i;r===34041||r===6402?r!==34041||s===ni.UNSIGNED_INT_24_8?r!==6402||s===ni.UNSIGNED_INT||s===ni.UNSIGNED_SHORT?(this._validateTextureDescriptor(i),this._disposeDepthStencilAttachments(),this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(t.glName,gm(r))),this._depthStencilTexture?.dispose(),this._depthStencilTexture=t):console.error("Depth texture must have data type of UNSIGNED_INT or UNSIGNED_SHORT!"):console.error("Depth/Stencil texture must have data type of UNSIGNED_INT_24_8!"):console.error("Depth/Stencil texture must have a pixel type of DEPTH_STENCIL!")}detachDepthStencilTexture(){const t=this._depthStencilTexture;return t&&this._initialized&&this._context.temporaryBindFramebufferObject(this,()=>{this._framebufferTexture2D(null,gm(t.descriptor.pixelFormat))}),this._depthStencilTexture=null,t}_attachDepthStencilBuffer(t){if(t==null)return;const i=t.descriptor;if(this._validateRenderbufferDescriptor(i),this._disposeDepthStencilAttachments(),this._initialized){this._context.bindFramebuffer(this);const{gl:r}=this._context,s=this._getGLAttachmentPoint(i);r.framebufferRenderbuffer(36160,s,r.RENDERBUFFER,t.glName)}this._depthStencilBuffer=t}detachDepthStencilBuffer(){const t=this._depthStencilBuffer;if(t&&this._initialized){const{_context:i}=this,r=i.getBoundFramebufferObject();i.bindFramebuffer(this);const{gl:s}=i,n=this._getGLAttachmentPoint(t.descriptor);s.framebufferRenderbuffer(36160,n,s.RENDERBUFFER,null),i.bindFramebuffer(r)}return this._depthStencilBuffer=null,t}invalidateAttachments(t){const{_context:i}=this;i.temporaryBindFramebufferObject(this,()=>i.gl.invalidateFramebuffer(36160,t),!0)}copyToTexture(t,i,r,s,n,a,o){(t<0||i<0||n<0||a<0)&&console.error("Offsets cannot be negative!"),(r<=0||s<=0)&&console.error("Copy width and height must be greater than zero!");const l=o.descriptor;o.descriptor.target!==3553&&console.error("Texture target must be TEXTURE_2D!"),(l?.width==null||l?.height==null||t+r>this.width||i+s>this.height||n+r>l.width||a+s>l.height)&&console.error("Bad dimensions, the current input values will attempt to read or copy out of bounds!");const c=this._context,u=c.bindTexture(o,bt.TEXTURE_UNIT_FOR_UPDATES);c.setActiveTexture(bt.TEXTURE_UNIT_FOR_UPDATES),c.bindFramebuffer(this),c.gl.copyTexSubImage2D(3553,0,n,a,t,i,r,s),c.bindTexture(u,bt.TEXTURE_UNIT_FOR_UPDATES)}readPixels(t,i,r,s,n,a,o){(r<=0||s<=0)&&console.error("Copy width and height must be greater than zero!"),o||console.error("Target memory is not initialized!"),this._context.bindFramebuffer(this),this._context.gl.readPixels(t,i,r,s,n,a,o)}async readPixelsAsync(t,i,r,s,n,a,o){const{gl:l}=this._context,c=Hs.createPixelPack(this._context,35041,o.byteLength);this._context.bindBuffer(c);const u=this._context.getBoundFramebufferObject();this._context.bindFramebuffer(this),l.readPixels(t,i,r,s,n,a,0),this._context.unbindBuffer(35051),this._context.bindFramebuffer(u),await c.getSubDataAsync(o),c.dispose()}resize(t,i){if(this.width===t&&this.height===i)return;const r={width:t,height:i};if(Bl(r,this._context.parameters.maxTextureSize),this._colorAttachments.forEach(s=>s.resize(r.width,r.height)),this._depthStencilTexture?.resize(r.width,r.height),this._initialized&&(Bl(r,this._context.parameters.maxRenderbufferSize),this._depthStencilBuffer?.resize(r.width,r.height),hn())){const{gl:s}=this._context;s.checkFramebufferStatus(36160)!==s.FRAMEBUFFER_COMPLETE&&console.error("Framebuffer is incomplete!")}}initializeAndBind(t=36160){const{gl:i}=this._context;if(this._initialized)return void i.bindFramebuffer(t,this.glName);this._glName&&i.deleteFramebuffer(this._glName);const r=i.createFramebuffer();if(i.bindFramebuffer(t,r),this._colorAttachments.forEach((s,n)=>{if(wo(s)){const a=Ux(s);a===35866?this._framebufferTextureLayer(s.glName,n,t,0,0):this._framebufferTexture2D(s.glName,n,a,t)}else if(Xv(s)){const a=this._context.gl;a.framebufferRenderbuffer(t,n,a.RENDERBUFFER,s.glName)}}),this._depthStencilBuffer){const s=this._getGLAttachmentPoint(this._depthStencilBuffer.descriptor);i.framebufferRenderbuffer(t,s,i.RENDERBUFFER,this._depthStencilBuffer.glName)}else if(this._depthStencilTexture){const s=gm(this._depthStencilTexture.descriptor.pixelFormat);this._framebufferTexture2D(this._depthStencilTexture.glName,s,Ux(this._depthStencilTexture),t)}hn()&&i.checkFramebufferStatus(t)!==i.FRAMEBUFFER_COMPLETE&&console.error("Framebuffer is incomplete!"),this._glName=r,this._initialized=!0}_framebufferTexture2D(t,i=Et,r=3553,s=36160,n=0){this._context.gl.framebufferTexture2D(s,i,r,t,n)}_framebufferTextureLayer(t,i=Et,r=36160,s=0,n=0){this._context.gl.framebufferTextureLayer(r,i,t,s,n)}_disposeDepthStencilAttachments(){const t=this._context.gl;if(this._depthStencilBuffer){if(this._initialized){this._context.bindFramebuffer(this);const i=this._getGLAttachmentPoint(this._depthStencilBuffer.descriptor);t.framebufferRenderbuffer(36160,i,t.RENDERBUFFER,null)}this._depthStencilBuffer=ye(this._depthStencilBuffer)}this._depthStencilTexture&&(this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(null,gm(this._depthStencilTexture.descriptor.pixelFormat))),this._depthStencilTexture=ye(this._depthStencilTexture))}_validateTextureDescriptor(t){t.target!==3553&&t.target!==34067&&t.target!==35866&&console.error("Texture type must be TEXTURE_2D, TEXTURE_2D_ARRAY or TEXTURE_CUBE_MAP!"),Bl(t,this._context.parameters.maxTextureSize),this._validateBufferDimensions(t)}_validateRenderbufferDescriptor(t){Bl(t,this._context.parameters.maxRenderbufferSize),this._validateBufferDimensions(t)}_validateBufferDimensions(t){t.width<=0&&(t.width=this.width),t.height<=0&&(t.height=this.height),this.width>0&&this.height>0&&(this.width===t.width&&this.height===t.height||console.error("Attachment size must match framebuffer size!"))}_getGLAttachmentPoint(t){switch(t.internalFormat){case Wl.DEPTH_COMPONENT16:case Wl.DEPTH_COMPONENT24:case Wl.DEPTH_COMPONENT32F:return rM;case iu.DEPTH24_STENCIL8:case iu.DEPTH32F_STENCIL8:return qi;case 36168:return lL;default:return Et}}_validateColorAttachmentPoint(t){if(cd._MAX_COLOR_ATTACHMENTS===-1){const{gl:r}=this._context;cd._MAX_COLOR_ATTACHMENTS=r.getParameter(r.MAX_COLOR_ATTACHMENTS)}const i=t-Et;i+1>cd._MAX_COLOR_ATTACHMENTS&&$.getLogger("esri.views.webgl.FrameBufferObject").error("esri.FrameBufferObject",`illegal attachment point for color attachment: ${i+1}. Implementation supports up to ${cd._MAX_COLOR_ATTACHMENTS} color attachments`)}};function wo(e){return B_(e)===1}function Xv(e){return B_(e)===2}function eV(e){return wo(e)||bR(e)}function bR(e){return B_(e)===0}function tV(e){return B_(e)===3||e!=null&&"samples"in e}function B_(e){return e!=null&&"type"in e?e.type:null}function iV(e,t){return wo(t)||Xv(t)?t:bR(t)?new bt(e,t):tV(t)?new vR(e,t):null}function Bl(e,t){const i=Math.max(e.width,e.height);if(i>t){J7().warnOnce(`Resizing FBO attachment size ${e.width}x${e.height} to device limit ${t}`);const r=t/i;return e.width=Math.round(e.width*r),e.height=Math.round(e.height*r),!1}return!0}function Ux(e){return e.descriptor.target===34067?34069:e.descriptor.target===35866?35866:3553}function gm(e){return e===6402?rM:qi}let zf=class extends ie{constructor(e){super(e),this._needsRender=!0,this._passParameters=new db,this._configuration=new Vf,this._fbo=new Wo(e.context.renderContext.rctx,new gt(Ba)),e.context.techniques.precompile(Iy,new Vf);const t=new Vf;t.mode=1,e.context.techniques.precompile(Iy,t)}get textureAtlas(){if(this._texture&&!this._needsRender)return this._texture;this._configuration.mode=this._texture?1:0;const e=this.context.techniques.get(Iy,this._configuration);return e.compiled&&(this._texture=this._render(e)),this._texture}updateWeatherMap(e){Y4(this._passParameters.weatherTile,e)||(fs(this._passParameters.weatherTile,e),this._needsRender=!0)}destroy(){this._fbo=ye(this._fbo)}_render(e){if(!this._fbo)return null;const t=this.context.renderContext.rctx,i=t.getViewport();return t.setViewport(0,0,Ba,Ba),t.bindFramebuffer(this._fbo),t.bindTechnique(e,this.context.renderContext.bind,this._passParameters),t.screen.draw(),t.setViewport(i.x,i.y,i.width,i.height),this._needsRender=!1,this._fbo.colorTexture}};h([d({constructOnly:!0})],zf.prototype,"context",void 0),zf=h([D("esri.views.3d.environment.NoiseTextureAtlas")],zf);let wr=class extends ie{constructor(e){super(e),this._state=ar(0),this._passParameters=new ub,this._weatherTileCount=128,this._sliceIndex=0,this._tileIndex=0,this._tilesPerSlice=1,this.coverage=De(Bi.default.coverage[0],Bi.default.coverage[1],.5),this.density=De(Bi.default.density[0],Bi.default.density[1],.5),this.absorption=De(Bi.default.absorption[0],Bi.default.absorption[1],.5),this.cloudSize=De(Bi.default.cloudSize[0],Bi.default.cloudSize[1],.5),this.detailSize=De(Bi.default.detailSize[0],Bi.default.detailSize[1],.5),this.smoothness=De(Bi.default.smoothness[0],Bi.default.smoothness[1],.5),this.cloudHeight=De(Bi.default.cloudHeight[0],Bi.default.cloudHeight[1],.5),this.raymarchingSteps=Bi.default.raymarchingSteps,this._viewMatrix=Le(),this._dirty=!0,this.readyToRun=!0,this._configuration=new Qv}initialize(){const e=Yt(this.view.spatialReference);this._passParameters.cloudRadius=.5*e.radius;const t=()=>this.setDirty();this.addHandles([this.view.resourceController.scheduler.registerTask(mi.CLOUDS_GENERATOR,this),M(()=>this.coverage,t,Ee),M(()=>this.density,t,Ee),M(()=>this.absorption,t,Ee),M(()=>this.cloudSize,t,Ee),M(()=>this.detailSize,t,Ee),M(()=>this.smoothness,t,Ee),M(()=>this.cloudHeight,t,Ee),M(()=>this.raymarchingSteps,t,Ee)]);const i=nL(this._computeWeatherTile());let r=0;this.addHandles(M(()=>{const s=this._computeWeatherTile();return Y4(i,s)||(++r,fs(i,s)),r},t))}destroy(){this.destroyCubeMap(),this._passParameters.noiseTexture=Z(this._passParameters.noiseTexture)}_precompile(){this._configuration.steps=this.raymarchingSteps,this._configuration.writeTextureChannels=0,this.context.techniques.precompile(Ay,this._configuration),this._configuration.writeTextureChannels=1,this.context.techniques.precompile(Ay,this._configuration)}_acquireTechnique(){switch(this.raymarchingSteps){case 0:this._tilesPerSlice=1;break;case 1:this._tilesPerSlice=4;break;case 3:case 2:this._tilesPerSlice=8;break;default:na(this.raymarchingSteps)}return this._configuration.writeTextureChannels=1-this.parameters.readChannels,this._configuration.steps=this.raymarchingSteps,this.context.techniques.get(Ay,this._configuration)}_computeWeatherTile(){const{camera:e,environment:t}=this.view,{latitude:i,longitude:r}=e.position;if(i==null||r==null)return mp;Ki(Xs,(i+90)/180,(r+180)/360);const s=Math.floor(this._weatherTileCount*Math.abs(2*Xs[0]-1));Xs[0]=Math.floor(2*this._weatherTileCount*Xs[0]),Xs[1]=Math.floor(4*(this._weatherTileCount-s)*Xs[1]);let n=0,a=0;if(t?.lighting?.type!=="virtual"&&t?.lighting?.date!=null){const o=new Date(t.lighting.date);o.setUTCHours(t.lighting.date.getUTCHours()+(t.lighting.displayUTCOffset??0)),n=31*o.getUTCMonth()+o.getUTCDate(),a=o.getUTCFullYear()}return Xs[0]=(Xs[0]+n)%(2*this._weatherTileCount),Xs[1]=(Xs[1]+a%100)%(4*this._weatherTileCount),Xs}get state(){return this._state.value}set state(e){this._state.value=e}get usedMemory(){return(this._fbo?.usedMemory??0)+(this._passParameters.noiseTexture?.textureAtlas?.usedMemory??0)}_ensureNoiseTexture(){return this._passParameters.noiseTexture??=new zf({context:this.context}),this._passParameters.noiseTexture}_ensureFrameBufferCube(e){const t=this.context.renderContext.rctx;if(this._fbo==null){const i=new gt(e,e/2);i.target=35866,i.depth=6,i.wrapMode=33071,this._fbo=new Wo(t,i),this.parameters.data=this,this.parameters.absorption=this.absorption,this.parameters.coverage=this.coverage}return t.unbindTexture(this._fbo.colorTexture),this._fbo}get cubeMap(){return this._fbo}get parameters(){return this.context.renderContext.bind.clouds}destroyCubeMap(){this._fbo=ye(this._fbo),this.parameters.data=null}applyPreset(e,t){const i=e.median,r=s=>{const n=De(s[0],s[1],i);return t<.5?De(s[0],n,2*t):De(n,s[1],2*(t-.5))};this.coverage=r(e.coverage),this.density=r(e.density),this.absorption=r(e.absorption),this.cloudSize=r(e.cloudSize),this.detailSize=r(e.detailSize),this.smoothness=r(e.smoothness),this.cloudHeight=r(e.cloudHeight),this.raymarchingSteps=e.raymarchingSteps,this._precompile()}setDirty(){this._dirty=this.readyToRun=!0}runTask(e){if(this.state===3)return Fi;this._dirty&&(this._sliceIndex=this._tileIndex=0,this.state=1,this._passParameters.absorption=this.absorption,this._passParameters.density=this.density,this._passParameters.cloudSize=this.cloudSize,this._passParameters.detailSize=this.detailSize,this._passParameters.smoothness=this.smoothness,this._passParameters.cloudHeight=this.cloudHeight,this._passParameters.coverage=this.coverage,this._ensureNoiseTexture().updateWeatherMap(this._computeWeatherTile()),this._dirty=!1);const t=this._acquireTechnique();if(!this._ensureNoiseTexture().textureAtlas||!t.compiled)return Fi;const i=rV[this._sliceIndex],r=sV[this._sliceIndex];JI(this._viewMatrix,nV,i,r),G2(this._passParameters.viewMatrix,this._viewMatrix);const s=this.context.renderContext.rctx,n=s.getViewport(),a=Uh/this._tilesPerSlice,o=this._tileIndex*a;s.setViewport(0,o,Uh,a);const l=this._ensureFrameBufferCube(Uh);return s.bindFramebuffer(l),this._passParameters.lastSlice=this._sliceIndex===5,s.bindTechnique(t,this.context.renderContext.bind,this._passParameters),l.setColorTextureTarget(35866,Et,this._sliceIndex),s.screen.draw(),s.gl.flush(),s.setViewport(n.x,n.y,n.width,n.height),this.requestRender(),++this._tileIndex,this._sliceIndex===5&&this._tileIndex===this._tilesPerSlice?(this._sliceIndex=this._tileIndex=0,this.state=2,this.readyToRun=!1):this._tileIndex===this._tilesPerSlice&&(++this._sliceIndex,this._tileIndex=0),e.madeProgress(),Fi}};h([d({constructOnly:!0})],wr.prototype,"context",void 0),h([d({constructOnly:!0})],wr.prototype,"view",void 0),h([d({constructOnly:!0})],wr.prototype,"requestRender",void 0),h([d()],wr.prototype,"coverage",void 0),h([d()],wr.prototype,"density",void 0),h([d()],wr.prototype,"absorption",void 0),h([d()],wr.prototype,"cloudSize",void 0),h([d()],wr.prototype,"detailSize",void 0),h([d()],wr.prototype,"smoothness",void 0),h([d()],wr.prototype,"cloudHeight",void 0),h([d()],wr.prototype,"raymarchingSteps",void 0),h([d()],wr.prototype,"readyToRun",void 0),wr=h([D("esri.views.3d.environment.CloudsRenderer")],wr);const rV=[Is(1,0,0),Is(-1,0,0),Is(0,1,0),Is(0,-1,0),Is(0,0,1),Is(0,0,1)],sV=[Is(0,0,-1),Is(0,0,-1),Is(0,0,-1),Is(0,0,-1),Is(0,1,0),Is(0,1,0)],nV=S9(),Xs=aL();function wR(e){const t=new ut;return t.attributes.add("position","vec3"),t.attributes.add("instanceFeatureAttribute","float"),t.vertex.uniforms.add(new Pn("cameraPosition",i=>i.camera.eye),new Zr("offset",(i,r)=>aV(i,r)),new _e("width",i=>i.width),new _e("time",i=>i.time),new ps("proj",i=>i.camera.projectionMatrix),new ps("view",i=>i.camera.viewMatrix)),t.varyings.add("vUv","vec2"),t.vertex.code.add(_`vec3 hash31(float p){
vec3 p3 = fract(vec3(p) * vec3(0.1031, 0.1030, 0.0973));
p3 += dot(p3, p3.yzx + 33.33);
return fract((p3.xxy + p3.yzz) * p3.zyx);
}
float hash11(float p){
p = fract(p * 0.1031);
p *= p + 33.33;
p *= p + p;
return fract(p);
}
vec3 rotateVectorByQuaternion(vec3 v, vec4 q){
return 2.0 * cross(q.xyz, v * q.w + cross(q.xyz, v)) + v;
}`),t.vertex.main.add(_`
      vUv = position.xz;
      vec3 rand = hash31(instanceFeatureAttribute);

      // Set random position for all particles
      // The hash function space is not high resolution so offset particles by an additional random value
      // This creates grids of 1000 particles which are shifted by random hundredths of the tile width
      // overlaying multiple identical but offset grids
      vec3 randomPosition = 2.0 * (rand + (0.01 + 0.01 * rand) * floor(0.001 * instanceFeatureAttribute)) - 1.0;

      // Random orientation of rain drops
      float angle = 3.1415 * hash11(instanceFeatureAttribute);

      vec3 up = vec3(0, 0, 1);

      // Gravity and wind direction
      vec3 direction = normalize(cameraPosition);

      vec3 tangent = normalize(cross(direction, up));

      // Gravity
      vec3 animatedPos = randomPosition + direction * -time;

      // Rain particles fall straight down and are randomly oriented
      // Snow particles have random sinusoid trajectories and are rotated to face the camera
      ${e.type===0?_`
            // Random rotation for particle
            vec3 rotationAxis = up;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));
            vec3 transformedPos = rotateVectorByQuaternion(vec3(0.2, 0.2, 4.0) * (position - vec3(0.5, 0.0, 0.5)), quat);

            // Rotate particle to planetary position
            rotationAxis = tangent;
            angle = 0.5 * -acos(dot(direction, up));
            quat = vec4(rotationAxis * sin(angle), cos(angle));
            transformedPos = rotateVectorByQuaternion(transformedPos, quat);

            vec4 pos = mat4(mat3(view)) * vec4(transformedPos + (mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * pos;
      `:_`
            vec3 rotationAxis = direction;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));

            tangent = rotateVectorByQuaternion(tangent, quat);
            // Random sinusoid from friction
            animatedPos += tangent * 0.25 * sin(dot(animatedPos, direction));
            vec4 pos = mat4(mat3(view)) * vec4((mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * (0.5 * vec4(position.xzy, 0.0) + pos);
      `}
  `),t.fragment.uniforms.add(new _e("opacity",i=>i.opacity),new Pn("particleColor",i=>oV(i,e))),t.fragment.main.add(_`
    float d = length(vUv - vec2(0.5));

    ${e.type===0?_`d = 0.35 * smoothstep(0.5, 0.0, d);`:_`d = smoothstep(0.5, 0.1, d);`}
    fragColor = opacity * vec4(particleColor * d, d);
  `),t}function aV(e,t){const i=t.camera.eye,r=.5*e.width,s=1/e.width,n=zI(Yv,xe(Yv,(i[0]+r)*s,(i[1]+r)*s,(i[2]+r)*s));return ji(n,i,te(n,n,e.width))}function oV(e,t){const i=t.type===0?cV:lV,r=te(Yv,i,hV),s=e.camera.eye;me(Hx,s);const n=Math.max(0,$e(Hx,e.lighting.mainLight.direction));return Nt(r,r,i,n)}const Yv=w(),Hx=w(),lV=We(1,1,1),cV=We(.85,.85,.85),hV=.7,uV=Object.freeze(Object.defineProperty({__proto__:null,build:wR},Symbol.toStringTag,{value:"Module"}));let dV=class extends Kt{constructor(){super(...arguments),this.time=0,this.radius=1,this.width=500,this.opacity=0}},qx=class extends ct{constructor(e,t){super(e,t,new ht(uV,()=>k(()=>Promise.resolve().then(()=>QJ),void 0)),new Map([["position",0],["instanceFeatureAttribute",1]]))}initializePipeline(){return Ge({blending:fu,depthTest:{func:515},colorWrite:st})}},xR=class extends hr{constructor(){super(...arguments),this.type=0}};h([z({count:2})],xR.prototype,"type",void 0);let ea=class extends qo{constructor(){super(...arguments),this.produces="disabled",this.consumes={required:[ne.OPAQUE_ENVIRONMENT]}}_enable(){this.produces=ne.OPAQUE_ENVIRONMENT,this.requestRender(1)}_disable(){this.produces="disabled",this.requestRender(1)}};h([d()],ea.prototype,"produces",void 0),h([d()],ea.prototype,"consumes",void 0),ea=h([D("esri.views.3d.webgl-engine.effects.OpaqueEnvironment")],ea);let Xl=class extends ea{constructor(){super(...arguments),this.consumes={required:[ne.TRANSPARENT_ENVIRONMENT]}}_enable(){this.produces=ne.TRANSPARENT_ENVIRONMENT,this.requestRender(1)}};h([d()],Xl.prototype,"consumes",void 0),Xl=h([D("esri.views.3d.webgl-engine.effects.TransparentEnvironment")],Xl);const Ly=()=>$.getLogger("esri.views.webgl.VertexArrayObject");let Qa=class CR{constructor(t,i,r,s){this._context=t,this._indexBuffer=r,this._buffers=i instanceof Map?i:new Map([["geometry",i]]),this._baseInstances=s==null?new Map:typeof s=="number"?new Map([["geometry",s]]):s,this.locations=ec(mL(this._buffers))}get glName(){return this._glName}get context(){return this._context}get buffers(){return ec(this._buffers)}buffer(t="geometry"){return this.buffers.get(t)}get indexBuffer(){return this._indexBuffer}getByteLength(t){return this.buffer(t)?.sizeBytes??0}vertexCount(t){const i=this.buffer(t);return i?i.sizeBytes/i.layout[0].stride:0}get usedMemory(){return Array.from(this._buffers.values()).reduce((t,i)=>t+i.usedMemory,this._indexBuffer?.usedMemory??0+(this._buffers.size+(this._indexBuffer?1:0))*dL)}dispose(){this._context?(this._buffers.forEach(t=>t.dispose()),this._buffers.clear(),this._indexBuffer=ye(this._indexBuffer),this.disposeVAOOnly()):(this._glName||this._buffers.size>0)&&Ly().warn("Leaked WebGL VAO")}disposeVAOOnly(){this._context?(this._context.getBoundVAO()===this&&this._context.bindVAO(null),this._glName&&(this._context.gl.deleteVertexArray(this._glName),this._glName=null,this._context.instanceCounter.decrement(yi.VertexArrayObject,this)),this._context=null):this._glName&&Ly().warn("Leaked WebGL VAO")}bind(t=this.locations){const i=this._context.gl;this._glName?i.bindVertexArray(this._glName):(this._context.instanceCounter.increment(yi.VertexArrayObject,this),this._glName=i.createVertexArray(),i.bindVertexArray(this._glName),this._bindLayout(t))}_bindLayout(t){const{_buffers:i,_indexBuffer:r}=this;if(i||Ly().error("Vertex buffer dictionary is empty!"),i.forEach((s,n)=>GP(this._context,t,s,this._baseInstances.get(n)??0)),r!=null){const s=this._context.gl;this._context.gl.bindBuffer(s.ELEMENT_ARRAY_BUFFER,r.glName)}}unbind(){this._context.gl.bindVertexArray(null)}shallowCloneWithBaseInstances(t){return new CR(this._context,this._buffers,this._indexBuffer,t)}},Dn=class extends Qa{},kf=class extends Xl{constructor(e){super(e),this._hasSnowCover=!1,this._rainSpeed=.1,this._snowSpeed=.01,this._numParticles=0,this._passParameters=new dV,this._configuration=new xR;const{view:t,type:i}=e;this._configuration.type=i==="rainy"?0:1,t.stage.renderView.techniques.precompile(qx,this._configuration),this._passParameters.time=0,this._passParameters.radius=Yt(t.spatialReference).radius,this.addHandles([M(()=>t.environment.weather,r=>{r.type===i&&this.addHandles([M(()=>r.precipitation,s=>this._adjustParticles(s),Ve),M(()=>r.type==="snowy"&&r.snowCover==="enabled",s=>this._hasSnowCover=s,Ve)])},Ve)]),this.addHandles(M(()=>t.stage?.renderer.renderContext.bind.clouds.fadeFactor??1,r=>{this._passParameters.opacity=r,r===1&&(this.removeHandles("opacity"),this.addHandles(M(()=>t.stage?.renderer.renderContext.bind.clouds.opacity??1,s=>this._passParameters.opacity=s,Ve),"opacity"))},Ie),"opacity")}initialize(){this.addHandles([M(()=>this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),Ve)])}_adjustParticles(e){const t=e<.5?De(0,.35,2*e):De(.35,1,2*(e-.5));this._numParticles=Gx*t}destroy(){this._numParticles=0,this._vao=ye(this._vao),this._instanceIdBuffer=ye(this._instanceIdBuffer)}fadeOut(e){this.removeAllHandles(),this.addHandles(M(()=>this.renderContext?.bind.clouds.fadeFactor??1,t=>{this._passParameters.opacity=1-t,t===1&&(this.removeAllHandles(),e())}),"opacity")}get snowCover(){return this._hasSnowCover?this._passParameters.opacity:null}updateAnimation(e){const t=(this.type==="rainy"?this._rainSpeed:this._snowSpeed)*y2(e.time)%1e5;return this._passParameters.time!==t&&(this._passParameters.time=t,!0)}render(e){const t=this.renderingContext,i=Math.round(this._numParticles*this._passParameters.opacity),r=e.find(({name:a})=>a===ne.TRANSPARENT_ENVIRONMENT);if(i<1)return r;const s=this.techniques.get(qx,this._configuration);if(!s.compiled)return this.requestRender(1),r;const n=t.bindTechnique(s,this.bindParameters,this._passParameters);return this._vao??=pV(t),t.bindVAO(this._vao),this._bindInstanceIdBuffer(n.locations),n.assertCompatibleVertexAttributeLocations(this._vao,Ja($x)),t.drawArraysInstanced(St.TRIANGLES,0,3,i),t.unbindBuffer(34962),r}_bindInstanceIdBuffer(e){const t=this.renderingContext;if(this._instanceIdBuffer)return void t.bindBuffer(this._instanceIdBuffer);const i=nM(Gx);this._instanceIdBuffer=new ei(t,$x,new Float32Array(i)),GP(t,e,this._instanceIdBuffer,0)}};function pV(e){const t=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new Dn(e,new ei(e,Bs(mV),t))}h([d({constructOnly:!0})],kf.prototype,"type",void 0),kf=h([D("esri.views.3d.environment.Precipitation")],kf);const Gx=25e4,mV=Ka().vec3f("position").freeze(),$x=Bs(Ka().f32("instanceFeatureAttribute"),1);var Kv;let hd=Kv=class extends ca{constructor(e){super(e),this.type="cloudy",this.cloudCover=.5}clone(){return new Kv({cloudCover:this.cloudCover})}};h([_u({cloudy:"cloudy"}),d({json:{write:{isRequired:!0}}})],hd.prototype,"type",void 0),h([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],hd.prototype,"cloudCover",void 0),hd=Kv=h([D("esri.views.3d.environment.CloudyWeather")],hd);const fV=hd;var Jv;let ud=Jv=class extends ca{constructor(e){super(e),this.type="foggy",this.fogStrength=.5}clone(){return new Jv({fogStrength:this.fogStrength})}};h([_u({foggy:"foggy"}),d({json:{write:{isRequired:!0}}})],ud.prototype,"type",void 0),h([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],ud.prototype,"fogStrength",void 0),ud=Jv=h([D("esri.views.3d.environment.FoggyWeather")],ud);const gV=ud;var e1;let hh=e1=class extends ca{constructor(e){super(e),this.type="rainy",this.cloudCover=.5,this.precipitation=.5}clone(){return new e1({cloudCover:this.cloudCover,precipitation:this.precipitation})}};h([_u({rainy:"rainy"}),d({json:{write:{isRequired:!0}}})],hh.prototype,"type",void 0),h([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],hh.prototype,"cloudCover",void 0),h([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],hh.prototype,"precipitation",void 0),hh=e1=h([D("esri.views.3d.environment.RainyWeather")],hh);const _V=hh;var t1;let _l=t1=class extends ca{constructor(e){super(e),this.type="snowy",this.cloudCover=.5,this.precipitation=.5,this.snowCover="disabled"}clone(){return new t1({cloudCover:this.cloudCover,precipitation:this.precipitation,snowCover:this.snowCover})}};h([_u({snowy:"snowy"}),d({json:{write:{isRequired:!0}}})],_l.prototype,"type",void 0),h([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],_l.prototype,"cloudCover",void 0),h([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],_l.prototype,"precipitation",void 0),h([d({type:["enabled","disabled"],nonNullable:!0,json:{write:!0}})],_l.prototype,"snowCover",void 0),_l=t1=h([D("esri.views.3d.environment.SnowyWeather")],_l);const yV=_l;var i1;let dd=i1=class extends ca{constructor(e){super(e),this.type="sunny",this.cloudCover=.5}clone(){return new i1({cloudCover:this.cloudCover})}};h([_u({sunny:"sunny"}),d({json:{write:{isRequired:!0}}})],dd.prototype,"type",void 0),h([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],dd.prototype,"cloudCover",void 0),dd=i1=h([D("esri.views.3d.environment.SunnyWeather")],dd);const r1=dd,SR={key:"type",base:r1,typeMap:{sunny:r1,cloudy:fV,rainy:_V,snowy:yV,foggy:gV}},vV=Object.keys(SR.typeMap);function bV(e,t){return!!vV.includes(e)||(t.error(`"${e}" is not a valid weather type`),!1)}const Nl=1e4,wV=1e5,TR={required:[]},xV={required:[2]};let PR=class extends ie{precompile(e){return!!this.acquireTechniques(e)}consumes(){return TR}get usedMemory(){return 0}get renderOccludedFlags(){return 1}get isDecoration(){return!1}get readyToRun(){return!1}get numGeometries(){return 0}get hasOccludees(){return!1}get hasEmitters(){return!1}forEachGeometry(e){}},Zp=class extends PR{},xre=class extends PR{},yl=class extends Zp{constructor(e){super(e),this.produces=new Map([]),this._clouds=ar(null),this._incarnation=0,this._precipitation=null}initialize(){this.view.stage?.addRenderPlugin(this)}destroy(){this.removeHandles(),this.uninitializeRenderContext(),this.view?.stage?.removeRenderPlugin(this),this._set("view",null)}get updating(){return!!this._clouds.value?.readyToRun}get weatherAvailable(){return ge(this.view.state.camera.eye)-Yt(this.view.spatialReference).radius<=Nl}get usedMemory(){return this._clouds.value?.usedMemory??0}_fadeOutPrecipitation(){this._precipitation&&(this._precipitationOutgoing?.destroy(),this._precipitationOutgoing=this._precipitation,this._precipitationOutgoing.fadeOut(()=>this._precipitationOutgoing=Z(this._precipitationOutgoing)),this._precipitation=null,++this._incarnation)}get _snowCover(){return this._precipitationOutgoing?.snowCover??this._precipitation?.snowCover??0}get weather(){return this.view?.environmentManager?.weatherEnabled?this.view.environment.weather:null}initializeRenderContext(e){this._context=e;const t=this.view,i=()=>this._requestRender();this.addHandles([M(()=>this._precipitation,i,Ie),M(()=>this._clouds.value?.state,i,Ie),M(()=>t.state.mode,i,Ie),M(()=>this._updateClouds(),i,Ie),M(()=>this._updatePrecipitation(),i,Ie),M(()=>this.weather,r=>this._initWeather(r))])}uninitializeRenderContext(){this._context=null,this._clouds.value=Z(this._clouds.value),this._precipitation=Z(this._precipitation),this._precipitationOutgoing=Z(this._precipitationOutgoing)}prepareRender(e){const{bind:t,time:i}=e;if(this.view.state.viewingMode===1){if(t.clouds.data){t.clouds.fade(t.camera,i,this.view.qualitySettings.fadeDuration);const r=this._clouds.value;r&&r.state===0&&r.coverage===0&&!r.readyToRun&&r.destroyCubeMap()}t.snowCover=this._snowCover}}acquireTechniques(){return[]}render(){}_requestRender(){this._context?.requestRender()}_initWeather(e){const t=this._context;if(!e||!t)return void(this._clouds.value=Z(this._clouds.value));if(this._clouds.value)return;const i=this.view;this._clouds.value=new wr({context:t,view:i,requestRender:()=>this._requestRender()})}_updateClouds(){const e=this.view.environment.weather;return e==null||this._clouds.value==null||this._clouds.value.applyPreset(Bi[e.type],CV(e)),++this._incarnation}_updatePrecipitation(){const e=this.view.environment.weather;if(e.type===this._precipitation?.type)return this._incarnation;this._fadeOutPrecipitation();const t=e.type==="rainy"||e.type==="snowy",i=this._context;return t&&i&&(this._precipitation=new kf({view:this.view,type:e.type}),++this._incarnation),this._incarnation}hasHighlight(){return!1}get test(){}};function CV(e){switch(e.type){case"rainy":case"snowy":case"cloudy":case"sunny":return e.cloudCover;case"foggy":return e.fogStrength}}h([d({constructOnly:!0})],yl.prototype,"view",void 0),h([d({type:Boolean,readOnly:!0})],yl.prototype,"updating",null),h([d()],yl.prototype,"weatherAvailable",null),h([d()],yl.prototype,"_context",void 0),yl=h([D("esri.views.3d.environment.EnvironmentRenderer")],yl);var N_=Math.PI,Xt=Math.sin,Ii=Math.cos,pb=Math.tan,MR=Math.asin,mb=Math.atan2,RR=Math.acos,_i=N_/180,DR=864e5,OR=2440588,ER=2451545,SV={dec:0,ra:0};function TV(e){return e.valueOf()/DR-.5+OR}function _m(e){return new Date((e+.5-OR)*DR)}function Bf(e){return TV(e)-ER}var Hg=23.4397*_i;function AR(e,t){return mb(Xt(e)*Ii(Hg)-pb(t)*Xt(Hg),Ii(e))}function fb(e,t){return MR(Xt(t)*Ii(Hg)+Ii(t)*Xt(Hg)*Xt(e))}function IR(e,t,i){return mb(Xt(e),Ii(e)*Xt(t)-pb(i)*Ii(t))}function LR(e,t,i){return MR(Xt(t)*Xt(i)+Ii(t)*Ii(i)*Ii(e))}function FR(e,t){return _i*(280.16+360.9856235*e)-t}function VR(e){return _i*(357.5291+.98560028*e)}function zR(e){return _i*(1.9148*Xt(e)+.02*Xt(2*e)+3e-4*Xt(3*e))}function kR(e,t){return e+t+102.9372*_i+N_}function BR(e,t){var i=VR(e),r=kR(i,zR(i));return t||(t={dec:0,ra:0}),t.dec=fb(r,0),t.ra=AR(r,0),t}var Rr={PolarException:{NORMAL:0,MIDNIGHT_SUN:1,POLAR_NIGHT:2},getPosition:function(e,t,i,r){var s=_i*-i,n=_i*t,a=Bf(e),o=BR(a,SV),l=FR(a,s)-o.ra;return r||(r={azimuth:0,altitude:0}),r.azimuth=IR(l,n,o.dec),r.altitude=LR(l,n,o.dec),r}},Nf=[[-.83,"sunrise","sunset"]];Rr.addTime=function(e,t,i){Nf.push([e,t,i])};var NR=9e-4;function PV(e,t){return Math.round(e-NR-t/(2*N_))}function Wx(e,t,i){return NR+(e+t)/(2*N_)+i}function Zx(e,t,i){return ER+e+.0053*Xt(t)-.0069*Xt(2*i)}function MV(e,t,i){return RR((Xt(e)-Xt(t)*Xt(i))/(Ii(t)*Ii(i)))}function Qx(e){var t=_i*(134.963+13.064993*e),i=_i*(93.272+13.22935*e),r=_i*(218.316+13.176396*e)+6.289*_i*Xt(t),s=5.128*_i*Xt(i),n=385001-20905*Ii(t);return{ra:AR(r,s),dec:fb(r,s),dist:n}}Rr.getTimes=function(e,t,i){var r=_i*-i,s=_i*t,n=PV(Bf(e),r),a=Wx(0,r,n),o=VR(a),l=zR(o),c=kR(o,l),u=fb(c,0),p=Zx(a,o,c);function m(x){return Zx(Wx(MV(x,s,u),r,n),o,c)}function f(x){var T=(Xt(x)-Xt(s)*Xt(u))/(Ii(s)*Ii(u));return T<-1?Rr.PolarException.MIDNIGHT_SUN:T>1?Rr.PolarException.POLAR_NIGHT:Rr.PolarException.NORMAL}var g,y,v,C,b,S={solarNoon:_m(p),nadir:_m(p-.5),polarException:Rr.PolarException.NORMAL};for(g=0,y=Nf.length;g<y;g+=1)b=p-((C=m((v=Nf[g])[0]*_i))-p),S[v[1]]=_m(b),S[v[2]]=_m(C);return S.polarException=f(Nf[0][0]*_i),S},Rr.getMoonPosition=function(e,t,i){var r=_i*-i,s=_i*t,n=Bf(e),a=Qx(n),o=FR(n,r)-a.ra,l=LR(o,s,a.dec);return l+=.017*_i/pb(l+10.26*_i/(l+5.1*_i)),{azimuth:IR(o,s,a.dec),altitude:l,distance:a.dist}},Rr.getMoonFraction=function(e){var t=Bf(e),i=BR(t),r=Qx(t),s=149598e3,n=RR(Xt(i.dec)*Xt(r.dec)+Ii(i.dec)*Ii(r.dec)*Ii(i.ra-r.ra)),a=mb(s*Xt(n),r.dist-s*Ii(n));return(1+Ii(a))/2};const rr={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,directAtNoon:.65,directAtTwilight:.7},global:{altitude:8e5,ambient:.015,direct:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};let ym=class{constructor(e,t){this.direct=e,this.ambient=t}};function RV(e,t,i,r,s,n){xe(n.ambient.color,1,1,1),n.ambient.intensity=rr.global.ambient,xe(n.direct.color,1,1,1),n.direct.intensity=rr.global.direct;const a=t[2],o=j((Math.abs(a)-rr.local.altitude)/(rr.global.altitude-rr.local.altitude),0,1);let l;if(n.globalFactor=o,e!=null&&(l=Rr.getTimes(e,t[1],t[0])),o<1){let c;if(e!=null)c=FV(e,l,r);else{const u=UR(r);c={direct:{intensity:rr.local.directAtNoon*u.direct,color:We(1,1,1)},ambient:{intensity:rr.local.ambientAtNoon*u.ambient,color:We(1,1,1)},timeOfDay:"early afternoon"}}Nt(n.ambient.color,c.ambient.color,n.ambient.color,o),n.ambient.intensity=De(c.ambient.intensity,n.ambient.intensity,o),Nt(n.direct.color,c.direct.color,n.direct.color,o),n.direct.intensity=De(c.direct.intensity,n.direct.intensity,o),n.specularStrength=r==="rainy"||r==="snowy"||r==="foggy"?0:1,n.environmentStrength=r==="rainy"?.7:r==="snowy"||r==="foggy"?.75:1}n.noonFactor=e!=null?LV(e,l):1,e!=null?DV(e,t,i,n.direct.directionToLightSource):jR(s,i,n.direct.directionToLightSource)}function jR(e,t,i){t===1?me(ky,e.eye):xe(ky,0,0,1),te(By,e.viewForward,-1);const r=A_(By,ky),s=Math.max(r-2*Ny,0),n=.85*s/(s+1),a=Math.max(Ny,r-Ny-n);ko(oC,-a,e.viewRight),lt(i,By,oC),ce(i,i,te(VV,e.viewRight,zV)),me(i,i)}function DV(e,t,i,r){const s=IV,n=pp(AV);if(i===1)Rr.getPosition(e,0,0,s),xe(r,0,0,-1),dx(n,n,-s.azimuth),eL(n,n,-s.altitude),lt(r,r,n);else{const a=rr.planarDirection,o=a.globalAngles,l=t[2];let c=(Math.abs(l)-a.localAltitude)/(a.globalAltitude-a.localAltitude);c=j(c,0,1),c<1?(Rr.getPosition(e,t[1],t[0],s),s.azimuth=(1-c)*s.azimuth+c*o.azimuth,s.altitude=(1-c)*s.altitude+c*o.altitude):(s.azimuth=o.azimuth,s.altitude=o.altitude),xe(r,0,-1,0),Fv(n,n,-s.azimuth),dx(n,n,-s.altitude),lt(r,r,n)}}function OV(e,t){if(t===1)return!0;const i=rr.planarDirection;return Math.abs(e)<i.localAltitude}const EV=We(.5773502691896258,-.5773502691896258,.5773502691896258);let Xx=class{constructor(){this.ambient={color:We(1,1,1),intensity:.55},this.direct={color:We(1,1,1),intensity:.55,directionToLightSource:Mn(EV)},this.noonFactor=.5,this.globalFactor=0,this.specularStrength=1,this.environmentStrength=1}};const AV=Le(),IV={azimuth:0,altitude:0};function LV(e,t){const i=e.valueOf();let r,s;t.polarException===Rr.PolarException.MIDNIGHT_SUN?(r=i-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,s=r+432e6):t.polarException===Rr.PolarException.POLAR_NIGHT?(r=i-2,s=i-1):(r=t.sunrise.valueOf(),s=t.sunset.valueOf());const n=r+(s-r)/2;return 1-j(Math.abs(i-n)/432e5,0,1)}function UR(e){switch(e){case"disabled":case"sunny":case"cloudy":return new ym(1,1);case"rainy":return new ym(.4,1.2);case"snowy":return new ym(.5,1.3);case"foggy":return new ym(.2,1.6)}}function Yx(e,t){const i=(e[0]+e[1]+e[2])/3;e[0]+=(i-e[0])*t,e[1]+=(i-e[1])*t,e[2]+=(i-e[2])*t}const Fy=We(.01,.01,.01),s1=We(1,.6,.5),n1=We(1,.98,.98),Kx=We(1,1,1),Vy=We(.8,.8,1),a1=We(.8,.8,1),o1=We(.98,.98,1),Jx=We(1,1,1),zy=yu(.01,rr.local.ambientAtNight),l1=yu(rr.local.directAtTwilight,rr.local.ambientAtTwilight),c1=yu(.9*rr.local.directAtNoon,rr.local.ambientAtNoon),eC=yu(rr.local.directAtNoon,rr.local.ambientAtNoon),tC=c1,iC=n1,rC=o1,sC=l1,nC=s1,aC=a1;function FV(e,t,i){const r=e.valueOf();let s,n;t.polarException===Rr.PolarException.MIDNIGHT_SUN?(s=r-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,n=s+432e6):t.polarException===Rr.PolarException.POLAR_NIGHT?(s=r-2,n=r-1):(s=t.sunrise.valueOf(),n=t.sunset.valueOf());const a=n-s,o=s+a/2,l=a/4,c=o-l,u=o+l,p=.06*a,m=s-p/2,f=s+p/2,g=n-p/2,y=n+p/2,v=ze(),C=w(),b=w();let S="";if(r<m||r>y)fs(v,zy),q(C,Fy),q(b,Vy),S="night";else if(r<f){const P=(r-m)/(f-m);dn(v,zy,l1,P),Nt(C,Fy,s1,P),Nt(b,Vy,a1,P),S="sun rising"}else if(r<c){const P=(r-f)/(c-f);dn(v,l1,c1,P),Nt(C,s1,n1,P),Nt(b,a1,o1,P),S="early morning"}else if(r<o){const P=(r-c)/(o-c);dn(v,c1,eC,P),Nt(C,n1,Kx,P),Nt(b,o1,Jx,P),S="late morning"}else if(r<u){const P=(r-o)/(u-o);dn(v,eC,tC,P),Nt(C,Kx,iC,P),Nt(b,Jx,rC,P),S="early afternoon"}else if(r<g){const P=(r-u)/(g-u);dn(v,tC,sC,P),Nt(C,iC,nC,P),Nt(b,rC,aC,P),S="late afternoon"}else if(r<y){const P=(r-g)/(y-g);dn(v,sC,zy,P),Nt(C,nC,Fy,P),Nt(b,aC,Vy,P),S="sun setting"}let x=0;switch(i){case"rainy":case"foggy":x=.8;break;case"snowy":x=.5}x>0&&(Yx(C,x),Yx(b,x));const T=UR(i);return{direct:{intensity:v[0]*T.direct,color:C},ambient:{intensity:v[1]*T.ambient,color:b},timeOfDay:S}}const oC=Le(),ky=w(),By=w(),VV=w(),Ny=.25,zV=.2;let nn=class extends gu{constructor(e){super(e),this._tmpLightParameters=new Xx,this._defaultLightParameters=new Xx,this._tmpDate=new Date,this._tmpTz={hours:0,minutes:0,seconds:0},this._viewHandlesKey="viewHandles",this._trackingEnabled=!1,this._mainLight=new QA,this._ambientLight=new QP,this._moonLight=new XA,this._disableWeather=!1,this._renderer=null,this._resetReferencePosition()}destroy(){this.disconnectView()}get _view(){return this._renderer?.view}get updating(){return!!this._renderer?.updating||!this._canProjectCameraPosition}get weatherEnabled(){return this._view?.environment.atmosphereEnabled&&!this._disableWeather&&this._view?.state?.viewingMode===1&&C4(this._view.spatialReference)}get _weatherAvailable(){return this.weatherEnabled&&this._renderer?.weatherAvailable}get referencePositionGeographic(){return this._referencePositionGeographic}get _canProjectCameraPosition(){const e=this._view?.stateManager?.camera?.position?.spatialReference??At.WGS84,t=jx(e);return th(e,t)}connectView(e){if(this._renderer)return;this._renderer=new yl({view:e});const t=()=>this._updateRenderParameters(),i=()=>this._cameraHandler();this.addHandles([M(()=>e.environment.lighting,r=>this._updateLightingHandler(r),Ie),M(()=>e.environment.lighting.type!=="virtual"?e.environment.lighting.date:null,r=>this._lightingDateHandler(r),Ie),M(()=>e.environment.lighting.directShadowsEnabled,t,Ie),M(()=>e.qualitySettings.ambientOcclusion,t,Ie),M(()=>e.qualitySettings.reflections,t,Ie),M(()=>e.spatialReference,()=>this._resetReferencePosition(!0),Ie),M(()=>[e.environment.weather.type,this.weatherEnabled],()=>this._updateLighting(null,1),Ie),M(()=>e.environment.weather.type==="snowy"&&e.environment.weather.snowCover,t,Ie),M(()=>e.environment,r=>r.setComputeWeatherAvailable(()=>this._weatherAvailable),Ve),M(()=>e.viewingMode,()=>this._resetReferencePosition(!0),Ve),M(()=>e.environment.lighting.type!=="virtual"&&e.environment.lighting.cameraTrackingEnabled,r=>this._updateCameraTracking(r),Ve),M(()=>e.state.camera,i,Ve),Yr(()=>this._canProjectCameraPosition,i,Ie)],this._viewHandlesKey),this._updateRenderParameters(),this._updateLighting(),this._cameraHandler(),this.notifyChange("updating")}disconnectView(){this.removeHandles(this._viewHandlesKey),this._resetReferencePosition(),this._renderer=Z(this._renderer)}_updateLightingHandler(e){this._updateCameraTracking(e.type!=="virtual"&&e.cameraTrackingEnabled),this._lightingDateHandler(e.type!=="virtual"?e.date:null),this._updateRenderParameters()}_updateCameraTracking(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{const t=this._view.environment.lighting;t?.type!=="virtual"&&(t.positionTimezoneInfo.autoUpdated=!1)}}_lightingDateHandler(e){const t=this._view.environment.lighting;if(t?.type!=="virtual"){if(e){if(!t.positionTimezoneInfo.autoUpdated&&(this._preupdateTracking(e),this._referencePositionGeographic!=null)){const i=jw(this._referencePositionGeographic,this._tmpTz);i!=null&&(t.autoUpdate(null,i),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}this._updateLighting(e)}}else this._updateLighting()}_preupdateTracking(e){!this._trackingEnabled&&this._view.environment.lighting.type!=="virtual"&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)}_cameraHandler(e=null){const t=this._view;if(!t.ready)return;const i=t.stateManager.camera;if(!i)return;const{position:r}=i,s=r.spatialReference??At.WGS84,n=jx(s);if(!Ha(r,vm,n))return this._referencePositionGeographic==null?void 0:(this._referencePositionGeographic=null,void this._updateLighting());this._referencePositionGeographic?eu(this._referencePositionGeographic,vm)||(q(this._referencePositionGeographic,vm),this.notifyChange("referencePositionGeographic")):this._referencePositionGeographic=Mn(vm),this._autoUpdateTimezone(this._referencePositionGeographic,e)||this._updateLighting(e)}_updateLighting(e,t=0){const i=this._view,{lighting:r}=i.environment,s=r.type==="virtual",n=this._referencePositionGeographic,a=n!=null?this._tmpLightParameters:this._defaultLightParameters;if(n){e??=s?null:r.date;const m=this._weatherAvailable?i.environment.weather.type:"disabled";RV(e,n,i.state.viewingMode,m,i.state.camera,a)}else s&&jR(i.state.camera,i.state.viewingMode,a.direct.directionToLightSource);const o=this._mainLight,l=a.direct;te(o.intensity,l.color,l.intensity*Math.PI),q(o.direction,l.directionToLightSource),o.specularStrength=a.specularStrength,o.environmentStrength=a.environmentStrength;const c=this._ambientLight;te(c.intensity,a.ambient.color,a.ambient.intensity);const u=this._moonLight;Nt(u.intensity,kV,BV,a.globalFactor);const p=(1-.5*a.globalFactor)*(1-.4*a.noonFactor*(1-a.globalFactor));te(u.intensity,u.intensity,p),q(u.direction,l.directionToLightSource),this._view.stage?.renderer.updateLighting([o,c,u],a.noonFactor,a.globalFactor,this._weatherAvailable?t:0),this._updateRenderParameters()}_autoUpdateTimezone(e,t=null){if(this._view.environment.lighting.type==="virtual"||!this._view.environment.lighting.cameraTrackingEnabled||e==null)return!1;const i=this._tmpDate;i.setTime((t||this._view.environment.lighting.date).getTime());const r=jw(e,this._tmpTz);if(r==null)return!1;let s=this._view.environment.lighting.positionTimezoneInfo;if(s.autoUpdated){if(s.hours===r.hours&&s.minutes===r.minutes&&s.seconds===r.seconds)return!1}else s=r;const n=i.getUTCHours()-(r.hours-s.hours),a=i.getUTCMinutes()-(r.minutes-s.minutes),o=i.getUTCSeconds()-(r.seconds-s.seconds);return i.setUTCHours(n),i.setUTCMinutes(a),i.setUTCSeconds(o),!t&&this._view.environment.lighting.autoUpdate(i,r)}_updateRenderParameters(){const e=this._view.stage;if(!e)return;const t=this._referencePositionGeographic==null||OV(this._referencePositionGeographic[2],this._view.state.viewingMode);e.renderer.setParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&t,environment:this._view.environment,weatherVisible:this._weatherAvailable,qualitySettings:this._view.qualitySettings})}_resetReferencePosition(e=!1){this._referencePositionGeographic=null,e&&this._cameraHandler()}get test(){}};h([d({type:Boolean,readOnly:!0})],nn.prototype,"updating",null),h([d()],nn.prototype,"_disableWeather",void 0),h([d()],nn.prototype,"weatherEnabled",null),h([d()],nn.prototype,"_weatherAvailable",null),h([d()],nn.prototype,"referencePositionGeographic",null),h([d()],nn.prototype,"_referencePositionGeographic",void 0),h([d()],nn.prototype,"_renderer",void 0),h([d()],nn.prototype,"_canProjectCameraPosition",null),nn=h([D("esri.views.3d.environment.EnvironmentManager")],nn);const kV=We(.22,.22,.33),BV=We(.22,.22,.22),vm=w();var h1;let ws=class extends ca{static{h1=this}constructor(e){super(e),this.type="sun",this.date=null,this.directShadowsEnabled=!1,this.displayUTCOffset=null}readDate(e,t){return t.datetime!=null&&new Date(t.datetime)||null}writeDate(e,t,i){t[i]=e.getTime()}readDirectShadowsEnabled(e,t){return!!t.directShadows}writedirectShadowsEnabled(e,t,i){e&&(t[i]=e)}writeDisplayUTCOffset(e,t){e!=null&&(t.displayUTCOffset=e)}clone(){return new h1(this.cloneConstructProperties())}cloneConstructProperties(){const e={directShadowsEnabled:this.directShadowsEnabled,displayUTCOffset:this.displayUTCOffset!=null?this.displayUTCOffset:null};return this.date!=null&&(e.date=new Date(this.date)),e}};h([d({readOnly:!0,type:["sun"],json:{write:!0}})],ws.prototype,"type",void 0),h([d({type:Date,json:{type:Number,write:{target:"datetime"}}})],ws.prototype,"date",void 0),h([mx("date",["datetime"])],ws.prototype,"readDate",null),h([ly("date")],ws.prototype,"writeDate",null),h([d({type:Boolean,json:{default:!1,write:{target:"directShadows"}}})],ws.prototype,"directShadowsEnabled",void 0),h([mx("directShadowsEnabled",["directShadows"])],ws.prototype,"readDirectShadowsEnabled",null),h([ly("directShadowsEnabled")],ws.prototype,"writedirectShadowsEnabled",null),h([d({type:Number,json:{write:!0}})],ws.prototype,"displayUTCOffset",void 0),h([ly("displayUTCOffset")],ws.prototype,"writeDisplayUTCOffset",null),ws=h1=h([D("esri.webscene.SunLighting")],ws);const xp=ws;var uh;let dh=uh=class extends O_(xp){static calculateTimezoneOffset({hours:e,minutes:t,seconds:i}){return Math.round(e+t/60+i/3600)}constructor(e){super(e),this.cameraTrackingEnabled=!0,this.positionTimezoneInfo={hours:0,minutes:0,seconds:0,autoUpdated:!0};const t=new Date().getFullYear(),i=new Date("March 15, "+t+" 12:00:00 UTC");this._set("defaultDate",i),this._set("date",i)}get defaultDate(){return new Date(this._get("defaultDate"))}static fromWebsceneLighting(e){return new uh(e.cloneConstructProperties())}set defaultDate(e){const t=this._get("date")===this._get("defaultDate");e=new Date(e),this._set("defaultDate",e),t&&this._set("date",e)}set date(e){e!=null&&(this.positionTimezoneInfo.autoUpdated=!1,this._set("date",new Date(e)))}autoUpdate(e,t){const i=uh.calculateTimezoneOffset(this.positionTimezoneInfo);this.positionTimezoneInfo.hours=t.hours,this.positionTimezoneInfo.minutes=t.minutes,this.positionTimezoneInfo.seconds=t.seconds;let r=null;e!=null&&(this.positionTimezoneInfo.autoUpdated=!0,isNaN(e.getTime())?(r=this.defaultDate.getTime(),this._set("date",this.defaultDate)):(r=this.date&&this.date.getTime(),this._set("date",new Date(e))));const s=uh.calculateTimezoneOffset(this.positionTimezoneInfo);if(i!==s&&(bm.target=this,bm.timezoneOffset=s,this.emit("timezone-will-change",bm),bm.target=null),e!=null)return isNaN(e.getTime())||r!==e.getTime()}clone(){const e=this._get("date")===this._get("defaultDate"),t=new uh({...this.cloneConstructProperties(),defaultDate:this.defaultDate,cameraTrackingEnabled:this.cameraTrackingEnabled});return e&&t._set("date",t._get("defaultDate")),t.positionTimezoneInfo.autoUpdated=this.positionTimezoneInfo.autoUpdated,t.positionTimezoneInfo.hours=this.positionTimezoneInfo.hours,t.positionTimezoneInfo.minutes=this.positionTimezoneInfo.minutes,t.positionTimezoneInfo.seconds=this.positionTimezoneInfo.seconds,t}cloneWithWebsceneLighting(e){const t=this.clone();return e.date!=null&&(t.date=e.date),t.directShadowsEnabled=e.directShadowsEnabled,t.displayUTCOffset=e.displayUTCOffset,t}cloneNonPersistentConstructProperties(){return{cameraTrackingEnabled:this.cameraTrackingEnabled}}};h([d({type:Boolean})],dh.prototype,"cameraTrackingEnabled",void 0),h([d({type:Date})],dh.prototype,"defaultDate",null),h([d({type:Date})],dh.prototype,"date",null),dh=uh=h([D("esri.views.3d.environment.SunLighting")],dh);const bm={target:null,timezoneOffset:0},vl=dh;var u1;let pd=class extends ca{static{u1=this}constructor(e){super(e),this.type="virtual",this.directShadowsEnabled=!1}clone(){return new u1(this.cloneConstructProperties())}cloneConstructProperties(){return{directShadowsEnabled:this.directShadowsEnabled}}};h([d({readOnly:!0,type:["virtual"],json:{write:{isRequired:!0}}})],pd.prototype,"type",void 0),h([d({type:Boolean,json:{default:!1,name:"directShadows",write:!0}})],pd.prototype,"directShadowsEnabled",void 0),pd=u1=h([D("esri.webscene.VirtualLighting")],pd);const j_=pd;var jf;let Uf=jf=class extends O_(j_){constructor(e){super(e),this.cameraTrackingEnabled=!0}clone(){return new jf({...this.cloneConstructProperties(),cameraTrackingEnabled:this.cameraTrackingEnabled})}static fromWebsceneLighting(e){return new jf(e.cloneConstructProperties())}cloneWithWebsceneLighting(e){const t=this.clone();return t.directShadowsEnabled=e.directShadowsEnabled,t}cloneNonPersistentConstructProperties(){return{cameraTrackingEnabled:this.cameraTrackingEnabled}}};h([d({type:Boolean})],Uf.prototype,"cameraTrackingEnabled",void 0),Uf=jf=h([D("esri.views.3d.environment.VirtualLighting")],Uf);const md=Uf,NV={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:vl,virtual:md}},jV={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:xp,virtual:j_}};let Hf=class extends ca{constructor(e){super(e)}clone(){throw new Error("Subclasses of Background should implement their own clone method.")}};h([d({readOnly:!0,json:{read:!1}})],Hf.prototype,"type",void 0),Hf=h([D("esri.webscene.background.Background")],Hf);const HR=Hf;var d1;let fd=d1=class extends HR{constructor(e){super(e),this.type="color",this.color=new wi([0,0,0,1])}clone(){return new d1(this.cloneProperties())}cloneProperties(){return{color:this.color.clone()}}};h([_u({color:"color"},{readOnly:!0}),d({json:{write:{isRequired:!0}}})],fd.prototype,"type",void 0),h([d(_L({nonNullable:!0,colorRequiredOnWrite:!0}))],fd.prototype,"color",void 0),fd=d1=h([D("esri.webscene.background.ColorBackground")],fd);const qR=fd,lC={base:HR,key:"type",typeMap:{color:qR}};function UV(e){return(t,i,r)=>{if(!t)return t;for(const s in e.typeMap)if(t.type===s){const n=new e.typeMap[s];return n.read(t,r),n}}}const HV={types:lC,json:{read:UV(lC),write:{overridePolicy:(e,t,i)=>({enabled:!i?.isPresentation})}}};var p1;const cC=(e,t,i)=>({enabled:!i?.isPresentation});let _o=class extends ca{static{p1=this}constructor(e){super(e),this.lighting=new xp,this.background=null,this.atmosphereEnabled=!0,this.starsEnabled=!0}set weather(e){bV(e?.type,$.getLogger(this))&&this._set("weather",e)}clone(){return new p1(this.cloneConstructProperties())}cloneConstructProperties(){return{lighting:this.lighting&&this.lighting.type==="virtual"?j_.prototype.clone.call(this.lighting):xp.prototype.clone.call(this.lighting),background:Og(this.background),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,weather:this.weather.clone()}}};h([d({types:jV,nonNullable:!0,json:{write:!0}})],_o.prototype,"lighting",void 0),h([d(HV)],_o.prototype,"background",void 0),h([d({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:cC}}})],_o.prototype,"atmosphereEnabled",void 0),h([d({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:cC}}})],_o.prototype,"starsEnabled",void 0),h([d({types:SR,nonNullable:!0,json:{write:!0},value:new r1})],_o.prototype,"weather",null),_o=p1=h([D("esri.webscene.Environment")],_o);const GR=_o;var gd;let bl=class extends GR{static{gd=this}constructor(e){super(e),this.lighting=this.castLighting(),this._computeWeatherAvailable=void 0,this.cachedCameraTrackingEnabled=null}static fromWebsceneEnvironment(e){const t=e.cloneConstructProperties();return new gd({...t,lighting:t.lighting?t.lighting.type==="virtual"?md.fromWebsceneLighting(t.lighting):vl.fromWebsceneLighting(t.lighting):void 0})}get weatherAvailable(){return this._computeWeatherAvailable?.()??!1}setComputeWeatherAvailable(e){this._computeWeatherAvailable=e}castLighting(e){return this._convertLightingWithDestroy(e)}applyLighting(e){this.lighting=this._convertLightingWithDestroy(e)}_convertLightingWithDestroy(e){const t=this._convertLighting(e);return t!==e&&this.addHandles(x_(t)),t}_convertLighting(e){return e?e instanceof vl||e instanceof md?e:e instanceof xp?this.lighting&&this.lighting.type!=="virtual"?this.lighting.cloneWithWebsceneLighting(e):new vl({...e.cloneConstructProperties(),...this.lighting?.cloneNonPersistentConstructProperties()}):e instanceof j_?this.lighting&&this.lighting.type==="virtual"?this.lighting.cloneWithWebsceneLighting(e):new md({...e.cloneConstructProperties(),...this.lighting?.cloneNonPersistentConstructProperties()}):gA(NV,e):new vl}clone(){return new gd({lighting:this.lighting.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:Og(this.background)})}cloneWithWebsceneEnvironment(e){return new gd({weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:Og(this.background),...e.cloneConstructProperties(),lighting:this._getLighting(e)})}_getLighting(e){switch(e.lighting.type){case"sun":return this.lighting&&this.lighting.type==="sun"?this.lighting.cloneWithWebsceneLighting(e.lighting):vl.fromWebsceneLighting(e.lighting);case"virtual":return this.lighting&&this.lighting.type==="virtual"?this.lighting.cloneWithWebsceneLighting(e.lighting):md.fromWebsceneLighting(e.lighting);default:return na(e.lighting),vl.fromWebsceneLighting(e.lighting)}}};h([d({nonNullable:!0})],bl.prototype,"lighting",void 0),h([d()],bl.prototype,"_computeWeatherAvailable",void 0),h([d({readOnly:!0})],bl.prototype,"weatherAvailable",null),h([Ua("lighting")],bl.prototype,"castLighting",null),bl=gd=h([D("esri.views.3d.environment.SceneViewEnvironment")],bl);const ph=bl;let ys=class{constructor(e=15,t=0,i=0,r=null,s=null,n=0){this.selection=e,this.interactionType=t,this.interactionFactor=i,this.interactionStartCamera=r,this.interactionDirection=s,this.tiltMode=n}};function Cp(e,t){return(e&t)!==0}function qg(e,t,i,r,s,n){e!==0&&(i?(n.min=Math.min(n.min,t),n.max=Math.max(n.max,t)):r!=null?(n.min-=Math.max(0,(t-n.min)*(1-r)),n.max+=Math.max(0,(t-n.max)*(1-r))):s&&(n.min-=Math.max(0,t-n.min-s),n.max+=Math.max(0,t-n.max-s)))}const fc=new ys(0);function $R(e,t,i,r){return t=t||e.viewForward,q(r,t),te(r,r,Math.sign($e(t,i))),r}function Cre(e,t,i,r){return ZV(e,t,i,$V(r,t,i,!0))}function qV(e,t,i,r){const s=$e(i,de(e,r,t));return ce(e,t,te(e,i,s))}const GV={dir:w(),len:0,clip:ze()};function $V(e,t,i,r){const s=GV;return e?(i&&r&&(s.len=Gt(t,i)),q(s.dir,e)):(s.len=Gt(t,i),de(s.dir,i,t),te(s.dir,s.dir,1/s.len)),s}function WV(e,t,i){const r=$e(un(e),i.dir),s=-cs(e,t);if(s<0&&r>=0)return!1;if(r>-1e-6&&r<1e-6)return s>0;if((s<0||r<0)&&!(s<0&&r<0))return!0;const n=s/r;return r>0?n<i.clip[1]&&(i.clip[1]=n):n>i.clip[0]&&(i.clip[0]=n),i.clip[0]<=i.clip[1]}function ZV(e,t,i,r){r.clip[0]=0,r.clip[1]=i?r.len:Number.MAX_VALUE;for(let s=0;s<e.length;s++)if(!WV(e[s],t,r))return!1;return!0}function QV(e,t,i=fc){const r=gb(e,t,i);if(r===0)return!1;const s=e.renderCoordsHelper,n=s.getAltitude(t.eye)+r,a=$R(t,i.interactionDirection,KV(e,t,Math.sign(r),iz),tz),o=q(rz,t.viewForward),l=s.intersectInfiniteManifold(ru(t.eye,a),n,jy);return t.eye=l??s.setAltitude(jy,n,t.eye),t.center=qV(jy,t.eye,o,t.center),!0}function gb(e,t,i=fc){if(!XV(e,i)||!e.state.constraints.altitude)return 0;const r=JV(e.state.constraints.altitude,ez);YV(e,i,r);const s=e.renderCoordsHelper.getAltitude(t.eye),n=j(s,r.min,r.max)-s;return Math.abs(n)<=1e-6?0:n}function XV(e,t){const i=e.state.constraints.altitude;return!(!e.state.isGlobal||!i)&&(t.interactionType!==2||!Cp(t.selection,1))}function YV(e,t,i){const r=t.interactionType;if(r===0)return;const{min:s,max:n}=i,{interactionStartCamera:a,interactionFactor:o}=t;if(!a)return;const l=r===2||r===1,c=gb(e,a),u=c===0?0:e.renderCoordsHelper.getAltitude(a.eye);i.min=s,i.max=n,qg(c,u,l,o,.05*u,i)}function KV(e,t,i,r){return e.renderCoordsHelper.worldUpAtPosition(t.eye,r),te(r,r,i),r}function JV(e,t){return t.min=e.min,t.max=e.max,t}const ez={min:0,max:0},tz=w(),iz=w(),rz=w(),jy=w();function _b(e,t,i=fc){if(!e.state.isLocal)return 0;const r=e.state.constraints.distance;if(!e.pointsOfInterest.surfaceOrigin.renderLocation||r===1/0)return 0;wm.min=0,wm.max=r,nz(e,i,wm);const s=yb(e,t),n=wm.max-s;return n>=-1e-6?0:n}function sz(e,t,i=fc){const r=_b(e,t,i);if(r===0)return!1;const s=e.pointsOfInterest.surfaceOrigin;if(!s.renderLocation)return!1;const n=yb(e,t)+r,a=q(oz,t.eye),o=$R(t,i.interactionDirection,az(t,s.renderLocation,hz),cz);if(!F_(SL(s.renderLocation,n),ru(t.eye,o),xm))return!1;t.eye=xm;const l=de(lz,t.eye,a);t.center=ce(xm,t.center,l);const c=e.renderCoordsHelper.getAltitude(t.center),u=e.renderCoordsHelper.intersectInfiniteManifold(t.ray,c,xm);return u!=null&&(t.center=u),!0}function nz(e,t,i){const r=t.interactionType;if(r===0)return;const{min:s,max:n}=i,{interactionStartCamera:a,interactionFactor:o}=t;if(!a)return;const l=r===1||r===4,c=_b(e,a),u=c===0?0:yb(e,a);i.min=s,i.max=n,qg(c,u,l,o,.05*u,i)}function yb(e,t){const i=e.pointsOfInterest.surfaceOrigin;return i.renderLocation?Gt(t.eye,i.renderLocation):0}function az(e,t,i){return N2(i,e.eye,t)}const wm={min:0,max:0},oz=w(),lz=w(),cz=w(),hz=w(),xm=w();function vu(e,t,i=0){const r=e.state.constraints.collision;if(!r.enabled)return!1;const s=C2(e,t.eye),n=e.renderCoordsHelper.getAltitude(t.eye),a=s+r.elevationMargin;if(n>=a)return!1;const o=ge(t.eye);if(de(Cm,t.center,t.eye),t.eye=e.renderCoordsHelper.setAltitude(uz,a,t.eye),i===1)t.center=ce(Cm,t.eye,Cm);else if(i===2){const l=(o-n+a)/o;t.center=te(Cm,t.center,l)}return!0}const Cm=w(),uz=w();function WR(e,t,i,r=!0){Iu.eyeCenterDistance=0,Iu.requiresTwoSteps=!1;const s=vb(e,t,i,fc,Iu);if(s===0)return!1;switch(ko(Sm,-s,t.viewRight),i.tiltMode){case 1:lt(so,t.viewForward,Sm),te(so,so,Iu.eyeCenterDistance),t.center=ce(So,t.eye,so);break;case 0:de(so,t.center,t.eye),lt(so,so,Sm),t.eye=de(So,t.center,so);break;default:na(i.tiltMode)}return t.up=lt(So,t.up,Sm),!Iu.requiresTwoSteps||!r||WR(e,t,i,!1)}function vb(e,t,i,r=fc,s){if(!e.state.constraints.tilt)return 0;const n=Math.min(t.relativeElevation*qf,t.distance),a=e.state.constraints.tilt(n,wz);return bz(e,i,a),r.interactionType===2&&Cp(r.selection,2)&&ZR(e,r.interactionStartCamera,a),i.tiltMode===1||r.tiltMode===1?pz(e,t,a,s):dz(e,t,a)}function dz(e,t,i){const r=Fo(e.renderCoordsHelper,t.center,t.eye),s=r-j(r,i.min,i.max);return Sp(s)?s:0}function pz(e,t,i,r){switch(r&&(r.requiresTwoSteps=!1),e.viewingMode){case"global":return fz(e,t,i,r);case"local":return mz(e,t,i,r)}}function mz(e,t,i,r){const s=Fo(e.renderCoordsHelper,t.center,t.eye),n=j(s,i.min,i.max),a=s-n;if(!Sp(a))return 0;if(r){const o=Math.abs(e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude),l=e.renderCoordsHelper.getAltitude(t.eye)-o,c=Math.max(Math.cos(n),1e-4);Math.abs(c)>1e-4?r.eyeCenterDistance=l/c:r.eyeCenterDistance=t.distance}return a}function fz(e,t,i,r){const s=gz(e,t,xz),n=j(s.tiltAtCenter,i.min,i.max);if(!Sp(s.tiltAtCenter-n))return 0;let a,o;return s.centerIsOnSurface?(a=_z(s),o=yz(s,a)):(a=s.constraints.clampTilt(s.distance,s.tiltAtCenter),r&&a<Math.PI/2&&(r.requiresTwoSteps=!0,a=Math.PI/2-1e-5),o=vz(s,a)),r&&(r.eyeCenterDistance=m1(s,a)),o}function gz(e,t,i){const r=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,s=r+Yt(e.spatialReference).radius,n=e.renderCoordsHelper.intersectManifold(t.ray,r,So);return i.distance=Math.min(t.relativeElevation*qf,t.distance),i.centerIsOnSurface=!1,n!=null?(i.distance=Math.min(t.relativeElevation*qf,Gt(t.eye,n)),i.tiltAtCenter=Fo(e.renderCoordsHelper,n,t.eye),i.centerIsOnSurface=!0):e.state.isLocal?i.tiltAtCenter=Fo(e.renderCoordsHelper,t.center,t.eye):(L_(I_(Z2,s),t.ray,So),i.distance=Math.min(t.relativeElevation*qf,Gt(t.eye,So)),i.tiltAtCenter=qa(-$e(t.viewForward,me(So,So)))),i.radius=s,i.eyeRadius=ge(t.eye),i.constraints=e.state.constraints,i}function Sp(e){return Math.abs(e)>1e-9}function _z(e){const{constraints:t,distance:i,tiltAtCenter:r}=e;let s=r,n=t.clampTilt(i,r);const a=m1(e,n);if(t.clampTilt(a,r)===n)return n;let o=0;for(;o<10&&Sp(n-s);){const l=(s+n)/2,c=m1(e,l);Sp(t.clampTilt(c,l)-l)?s=l:n=l,o++}return n}function m1(e,t){if(!e.centerIsOnSurface)return e.distance;const i=Math.PI-j(t,0,Math.PI),r=cp(e.radius/e.eyeRadius*Math.sin(i)),s=Math.PI-i-r,n=Math.sin(s)/Math.sin(i);if(e.eyeRadius<e.radius&&n>1){const a=Math.PI-r,o=Math.PI-i-a;return Math.sin(o)/Math.sin(i)*e.eyeRadius}return n*e.eyeRadius}function yz(e,t){const i=cp(e.radius/e.eyeRadius*Math.sin(e.tiltAtCenter)),r=cp(e.radius/e.eyeRadius*Math.sin(t));return e.eyeRadius>e.radius?i-r:r-i}function vz(e,t){return e.tiltAtCenter-Math.PI/2-(t-Math.PI/2)}function bz(e,t,i){if(t.interactionType===0)return;const{interactionStartCamera:r,interactionFactor:s}=t;if(!r)return;const{min:n,max:a}=i,o=vb(e,r,fc,t),l=o===0?0:Fo(e.renderCoordsHelper,r.center,r.eye);i.min=n,i.max=a,t.interactionType===2?(Cp(t.selection,2)&&ZR(e,r,i),qg(o,l,!0,s,hC,i)):qg(o,l,!1,s,hC,i)}function ZR(e,t,i){const r=e.state.constraints;if(e.state.isLocal||!r.altitude||!t)return;const s=Wr(t.center),n=Math.sqrt(s),a=t.distance,o=Yt(e.spatialReference).radius,l=r.altitude.min+o,c=r.altitude.max+o,u=(l*l-a*a-s)/(-2*n*a),p=(c*c-a*a-s)/(-2*n*a);i.min=Math.max(i.min,Math.min(Math.PI-qa(p),i.max)),i.max=Math.min(i.max,Math.PI-qa(u))}const so=w(),Sm=Le(),So=w(),hC=rt(5),qf=30,wz={min:0,max:0},xz={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,distance:0,tiltAtCenter:0},Iu={eyeCenterDistance:0,requiresTwoSteps:!1},Cz=e=>e,Tp=e=>e*e,Gg=e=>1-Tp(1-e),uC=e=>e<.5?Tp(2*e)/2:(Gg(2*(e-.5))+1)/2,$g=e=>e*e*e,f1=e=>1-$g(1-e),g1=e=>e<.5?$g(2*e)/2:(f1(2*(e-.5))+1)/2,Wg=e=>e*e*e*e,_1=e=>1-Wg(1-e),dC=e=>e<.5?Wg(2*e)/2:(_1(2*(e-.5))+1)/2,Zg=e=>e*e*e*e*e,y1=e=>1-Zg(1-e),pC=e=>e<.5?Zg(2*e)/2:(y1(2*(e-.5))+1)/2,Qg=e=>1-Math.cos(e*Math.PI/2),v1=e=>1-Qg(1-e),mC=e=>e<.5?Qg(2*e)/2:(v1(2*(e-.5))+1)/2,Xg=e=>2**(10*(e-1)),ou=e=>1-Xg(1-e),fC=e=>e<.5?Xg(2*e)/2:(ou(2*(e-.5))+1)/2,Yg=e=>-(Math.sqrt(1-e*e)-1),b1=e=>1-Yg(1-e),gC=e=>e<.5?Yg(2*e)/2:(b1(2*(e-.5))+1)/2;function $s(e){const t=2*(e-Math.sqrt((e-1)*e)),i=t/2/e;return r=>r<i?e*r*r:t*r-t+1}function Ws(e,t){return(i,r)=>i<t?t*e(i/t,r):1-e((1-i)/(1-t),r)*(1-t)}const _C=Ws($s(1),1),yC=Ws($s(1),0),Kg=Ws($s(1),.5),vC=Ws($s(2),1),bC=Ws($s(2),0),wC=Ws($s(2),.5),xC=Ws($s(3),1),CC=Ws($s(3),0),SC=Ws($s(3),.5),TC=Ws($s(4),1),PC=Ws($s(4),0),MC=Ws($s(4),.5),Sz={linear:Cz,"in-quad":Tp,"out-quad":Gg,"in-out-quad":uC,"in-coast-quad":_C,"out-coast-quad":yC,"in-out-coast-quad":Kg,"in-cubic":$g,"out-cubic":f1,"in-out-cubic":g1,"in-coast-cubic":vC,"out-coast-cubic":bC,"in-out-coast-cubic":wC,"in-quart":Wg,"out-quart":_1,"in-out-quart":dC,"in-coast-quart":xC,"out-coast-quart":CC,"in-out-coast-quart":SC,"in-quint":Zg,"out-quint":y1,"in-out-quint":pC,"in-coast-quint":TC,"out-coast-quint":PC,"in-out-coast-quint":MC,"in-sine":Qg,"out-sine":v1,"in-out-sine":mC,"in-expo":Xg,"out-expo":ou,"in-out-expo":fC,"in-circ":Yg,"out-circ":b1,"in-out-circ":gC,"quad-in":Tp,"quad-out":Gg,"quad-in-out":uC,"quad-in-coast":_C,"quad-out-coast":yC,"quad-in-out-coast":Kg,"cubic-in":$g,"cubic-out":f1,"cubic-in-out":g1,"cubic-in-coast":vC,"cubic-out-coast":bC,"cubic-in-out-coast":wC,"quart-in":Wg,"quart-out":_1,"quart-in-out":dC,"quart-in-coast":xC,"quart-out-coast":CC,"quart-in-out-coast":SC,"quint-in":Zg,"quint-out":y1,"quint-in-out":pC,"quint-in-coast":TC,"quint-out-coast":PC,"quint-in-out-coast":MC,"sine-in":Qg,"sine-out":v1,"sine-in-out":mC,"expo-in":Xg,"expo-out":ou,"expo-in-out":fC,"circ-in":Yg,"circ-out":b1,"circ-in-out":gC,ease:e=>um.ease(e),"ease-in":e=>um.easeIn(e),"ease-out":e=>um.easeOut(e),"ease-in-out":e=>um.easeInOut(e)};function kt(e,t,i=Rz,r=t){r!==t&&r.copyFrom(t),r.computeUp(e.state.viewingMode);let s=!1;for(let o=0;o<Dz;o++){let l=0;for(const c of Mz)if(Cp(i.selection,c.type)){const u=Math.abs(c.error(e,r,i));c.apply(e,r,i)&&(s=!0,l+=u)}if(l===0)break}const n=Cp(i.selection,8),a=Tz(i.interactionType,e);return n&&vu(e,r,a)&&(s=!0),s&&r.computeUp(e.state.viewingMode),s}function Tz(e,t){switch(e){case 4:return 1;case 5:return t.state.isGlobal?2:1;default:return 0}}function Ls(e){const t=Math.min(1,e/150);return g1(t)}function Pz(e,t,i){return vb(e,t,i)*t.distance}const Mz=[{type:1,error:Pz,apply:WR},{type:2,error:gb,apply:QV},{type:4,error:_b,apply:sz}],Rz=new ys,Dz=5;let RC=class{get pitch(){return this._pitch}get yaw(){return this._yaw}get distance(){return this._distance}get fov(){return this._fov}get size(){return this._size}constructor(e){this.viewingMode=e,this.center=w(),this._pitch=0,this._yaw=0,this._distance=0,this.direction=Mn(DC),this._fov=55,this._size=1}pixelsPerPanAtZoom(e){return this._size/2/(this._zoomToPanScale*e)}zoomAtPixelsPerPan(e){return this._size/2/(this._zoomToPanScale*e)}pixelsPerRotate(){const e=Math.max(Math.cos(Math.abs(this._pitch)),.5);return this._size/2/e}compareTo(e,t){if(this.viewingMode===1){const s=(ge(this.center)+ge(e.center))/2;t.pan=A_(this.center,e.center)*s}else t.pan=Gt(this.center,e.center);let i=Math.abs(e._yaw-this._yaw);i>=Math.PI&&(i=2*Math.PI-i);const r=Math.abs(e._pitch-this._pitch);t.rotate=Math.max(i,r),t.fov=e.fov-this.fov,t.sourceZoom=this._distance,t.targetZoom=e._distance}interpolate(e,t,i){this.viewingMode===1?qI(e.center,t.center,i.pan,this.center):Nt(this.center,e.center,t.center,i.pan),this._distance=isFinite(t.distance)?De(e.distance,t.distance+i.zoomOffset,i.zoom):e.distance,this._pitch=De(e.pitch,t.pitch,i.rotate);let r=e._yaw;const s=t._yaw;Math.abs(s-r)>=Math.PI&&(r+=2*(r<s?1:-1)*Math.PI),this._yaw=De(r,s,i.rotate),this._fov=De(e.fov,t.fov,i.fov)}copyFrom(e){q(this.center,e.center),this._pitch=e.pitch,this._yaw=e.yaw,this._distance=e.distance,q(this.direction,e.direction),this._size=e.size,this._fov=e.fov,this._zoomToPanScale=Math.atan(.5*this._fov),this.viewingMode=e.viewingMode}copyFromRenderCamera(e){const t=this._lookAtOrientation(e.center,OC);q(this.center,e.center),de(zi,e.center,e.eye),_n(zi,zi,t),_n(ao,e.up,t),this._distance=ge(zi),this._distance!==0&&(zi[0]/=this._distance,zi[1]/=this._distance,zi[2]/=this._distance),this._pitch=Oz(zi),this._yaw=Ez(zi,ao),this._size=Math.sqrt(e.width*e.width+e.height*e.height),this._fov=e.fov,this._zoomToPanScale=Math.atan(.5*this._fov)}copyToRenderCamera(e){const t=this._lookAtOrientation(this.center,OC);Gp(t,t),this._axisAngleVec3(Gf,this._pitch-Math.PI/2,DC,zi),this._axisAngleVec3(jl,this._yaw,zi,zi),this._axisAngleVec3(Gf,this._pitch-Math.PI/2,jl,ao),this._axisAngleVec3(jl,this._yaw,ao,ao),te(zi,zi,this._distance),_n(zi,zi,t),_n(ao,ao,t),e.center=this.center,e.eye=de(zi,this.center,zi),e.up=ao,e.fov=this._fov}_axisAngleVec3(e,t,i,r){const s=Math.cos(t),n=Math.sin(t);return te(ts,i,s),ri(qr,e,i),te(qr,qr,n),te(no,e,(1-s)*$e(e,i)),ce(r,ce(r,ts,qr),no)}_lookAtOrientation(e,t=Rn()){return this._upAtLookAt(e,no),ri(ts,this.direction,no),me(ts,ts),ts[0]===0&&ts[1]===0&&ts[2]===0&&q(ts,Gf),ri(qr,no,ts),me(qr,qr),t[0]=ts[0],t[1]=qr[0],t[2]=no[0],t[3]=ts[1],t[4]=qr[1],t[5]=no[1],t[6]=ts[2],t[7]=qr[2],t[8]=no[2],t}_upAtLookAt(e,t){return this.viewingMode===2?q(t,jl):me(t,e)}};function Oz(e){return Math.PI-A_(jl,e)}function Ez(e,t){const i=Az;return Math.abs(t[2])<.5?(q(i,t),e[2]>0&&te(i,i,-1)):q(i,e),ri(qr,i,jl),me(qr,qr),A_(Gf,qr,jl)}const ts=w(),qr=w(),no=w(),zi=w(),ao=w(),Az=w(),jl=C9,DC=w9,Gf=x9,OC=Rn();let Iz=class{constructor(){this.pan=0,this.rotate=0,this.fov=0,this.sourceZoom=0,this.targetZoom=0}};const Jg={desiredScreenFlow:2,minDuration:Oe(500),maxDuration:Oe(8e3)};let Lz=class QR{constructor(t){this._createCamera=t,this.compared=new Iz,this.segmentStart=0,this.segmentEnd=1,this.settings={desiredScreenFlow:Jg.desiredScreenFlow},this.source=t(),this.target=t()}clone(){const t=new QR(this._createCamera);return t.copyFrom(this),t}copyFrom(t){this.update(t.source,t.target,t.settings)}update(t,i,r){this.source!==t&&this.source.copyFrom(t),this.target!==i&&this.target.copyFrom(i),this.source.compareTo(this.target,this.compared),this.settings.desiredScreenFlow=r.desiredScreenFlow??Jg.desiredScreenFlow,this.desiredPixelFlow=this.settings.desiredScreenFlow*this.target.size,this.halfWindowSize=this.target.size/2}halfWindowPanAtZoom(t){const i=this.target.pixelsPerPanAtZoom(t);return this.halfWindowSize/i}get hasZoom(){return Math.abs(this.compared.sourceZoom-this.compared.targetZoom)>1e-5}get hasPan(){return this.compared.pan>gy()}get hasFov(){return Math.abs(this.compared.fov)>gy()}get hasRotate(){return this.compared.rotate>gy()}},Fz=class{constructor(){this.pan=0,this.rotate=0,this.zoom=0,this.fov=0,this.zoomOffset=0}},Vz=class{constructor(){this.segments=new Array}get time(){return this.segments.reduce((e,t)=>Yi(e+t.time),Yi(0))}interpolateComponentsAt(e,t){e=Math.min(Math.max(e,0),1),e*=this.time;let i=0,r=0;const s=this.definition,n=this.segments.reduce((a,o)=>a||o.definition.hasZoom,!1);for(let a=0;a<this.segments.length;a++){const o=this.segments[a],l=o.definition;if(e<=o.time||a===this.segments.length-1){if(this.segmentInterpolateComponentsAt(o,o.time===0?0:e/o.time,t),s.hasPan&&!isNaN(t.pan)&&isFinite(s.compared.pan)?t.pan=(i+l.compared.pan*t.pan)/s.compared.pan:t.pan=1,s.hasRotate&&!isNaN(t.rotate)&&isFinite(s.compared.rotate)?t.rotate=(r+l.compared.rotate*t.rotate)/s.compared.rotate:t.rotate=1,n&&!isNaN(t.zoom)&&isFinite(l.compared.targetZoom)){const{sourceZoom:c,targetZoom:u}=l.compared,p=t.zoom*(u-c)+c,m=this.segments[0].definition.compared.sourceZoom,f=this.segments[this.segments.length-1].definition.compared.targetZoom,g=Math.abs(u-m)>Math.abs(c-m)?u:c;t.zoomOffset=g-f,t.zoom=(p-m)/(g-m)}else t.zoom=1;return t}e-=o.time,i+=l.compared.pan,r+=l.compared.rotate}}segmentInterpolateComponentsAt(e,t,i){e.interpolateComponentsAt(t,i)}},Uy=class{get time(){return this._time}constructor(e){e&&this.update(e)}update(e){e&&(this.definition?this.definition.copyFrom(e):this.definition=e.clone()),this._updatePrecomputedVariables(),this._updatePixelFlow()}_updatePrecomputedVariables(){const e=this.definition,t=e.compared,i=t.sourceZoom,r=t.targetZoom;this._zoomSign=i>r?1:-1,this._panPixelsAtSource=t.pan*e.source.pixelsPerPanAtZoom(i);const s=(e.source.pixelsPerRotate()+e.target.pixelsPerRotate())/2;this._rotatePixels=t.rotate*s}_updatePixelFlow(){const e=this.definition.compared.sourceZoom,t=this.definition.compared.targetZoom,{hasZoom:i,hasPan:r,hasRotate:s}=this.definition;let n=0,a=0;i&&(r&&(n=(t/e-1)/(-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2*this._panPixelsAtSource)),s&&(a=this._zoomSign*(Math.log(e/t)/Math.LN2)*this.definition.halfWindowSize/this._rotatePixels)),this._zoomPixelFlow=0,this._panPixelFlow=0,this._rotatePixelFlow=0;const o=this.definition.desiredPixelFlow;if(i&&r&&s){const l=n+a+n*a;this._zoomPixelFlow=n*a/l*o,this._panPixelFlow=a/l*o,this._rotatePixelFlow=n/l*o}else if(i&&r){const l=1+n;this._zoomPixelFlow=n/l*o,this._panPixelFlow=1/l*o}else if(i&&s){const l=1+a;this._zoomPixelFlow=a/l*o,this._rotatePixelFlow=1/l*o}else if(r&&s){const l=this._panPixelsAtSource/this._rotatePixels,c=1+l;this._panPixelFlow=l/c*o,this._rotatePixelFlow=1/c*o}else r?this._panPixelFlow=o:i?this._zoomPixelFlow=o:s&&(this._rotatePixelFlow=o);if(this._time=Yi(Math.max(this.rotateTime,this.zoomTime,this.panTime)),this.fovTime>this._time){const l=this.fovTime/this._time;this._time=this.fovTime,this._zoomPixelFlow/=l,this._panPixelFlow/=l,this._rotatePixelFlow/=l}}get rotateTime(){return this.definition.hasRotate?Yi(this._rotatePixels/this._rotatePixelFlow):Yi(0)}get zoomTime(){return this.definition.hasZoom?Yi(this._zoomSign*(Math.log(this.definition.compared.sourceZoom/this.definition.compared.targetZoom)/Math.LN2)*this.definition.halfWindowSize/this._zoomPixelFlow):Yi(0)}get fovTime(){return this.definition.hasFov?Yi(Math.abs(this.definition.compared.fov)/zz):Yi(0)}get panTime(){if(!this.definition.hasPan)return Yi(0);if(this.definition.hasZoom){const e=-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2,t=e*this._panPixelsAtSource;return Yi(Math.log(t*(this._zoomPixelFlow/this._panPixelFlow)+1)/(e*this._zoomPixelFlow))}return Yi(this._panPixelsAtSource/this._panPixelFlow)}_interpolateComponentsZoom(e){if(e===0||e===1)return e;if(this.definition.hasZoom){const t=this.definition.compared.sourceZoom,i=this.definition.compared.targetZoom;return(t*(t/i)**-e-t)/(i-t)}return e}_interpolateComponentsFov(e){if(e===0)return this.definition.segmentStart;if(e===1)return this.definition.segmentEnd;if(this.definition.hasFov){const{segmentStart:t,segmentEnd:i}=this.definition;return t+e*(i-t)}return this.definition.segmentStart}_interpolateComponentsPan(e){if(e===0||e===1)return e;if(this.definition.hasPan&&this.definition.hasZoom){const t=-1/(this._zoomSign*this.definition.halfWindowSize)*this._zoomPixelFlow;return 1/this._panPixelsAtSource*(this._panPixelFlow*(2**(t*e*this._time)-1))/(t*Math.LN2)}return e}_interpolateComponentsRotate(e){return e}interpolateComponentsAt(e,t){e=Math.min(Math.max(e,0),1),t.zoom=this._interpolateComponentsZoom(e),t.pan=this._interpolateComponentsPan(e),t.rotate=this._interpolateComponentsRotate(e),t.zoomOffset=0,t.fov=this._interpolateComponentsFov(e)}};const zz=rt(45);function kz(e,t,i){const r=t-e.compared.sourceZoom,s=e.halfWindowPanAtZoom(r);return-e.halfWindowSize*(i.ascensionFactor*Math.LN2*e.compared.pan+s)*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2*s)}function Bz(e,t,i){const r=1/t,s=Math.log(e.compared.sourceZoom*r),n=1/e.desiredPixelFlow,a=1/Math.LN2,o=t-e.compared.sourceZoom,l=1/o,c=(i.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(o))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*r*n*a*l*c-e.halfWindowSize*s*n*a*l+e.halfWindowSize*s*n*a*c/(o*o)}function Nz(e,t,i){const r=t-e.compared.sourceZoom,s=1/r,n=1/t,a=Math.log(e.compared.sourceZoom*n),o=(i.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(r))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*s*(-2*s*n*o+2*s*a+2*n-2*a*o/(r*r)-o/(t*t))/(e.desiredPixelFlow*Math.LN2)}function jz(e,t){return-e.halfWindowSize*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2)}function Uz(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)}function Hz(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)}function qz(e,t,i){return-e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t))}function Gz(e,t,i){return e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t))}function $z(e,t,i){return-2*e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t*t))}function Wz(e,t,i){return e.halfWindowSize*(-e.halfWindowPanAtZoom(t)-i.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*e.halfWindowPanAtZoom(-t+e.compared.targetZoom))}function Zz(e,t,i){const r=Math.log(t/e.compared.targetZoom),s=1/e.desiredPixelFlow,n=1/Math.LN2,a=-t+e.compared.targetZoom,o=1/a,l=(-e.halfWindowPanAtZoom(t)-i.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return-e.halfWindowSize*r*s*n*o+e.halfWindowSize*r*s*n*l/(a*a)+e.halfWindowSize*s*n*o*l/t}function Qz(e,t,i){const r=t-e.compared.targetZoom,s=1/r,n=1/t,a=Math.log(t/e.compared.targetZoom),o=(e.halfWindowPanAtZoom(t)+i.descensionFactor*Math.LN2*e.compared.pan-e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*s*(-2*s*n*o-2*s*a+2*n+2*a*o/(r*r)-o/(t*t))/(e.desiredPixelFlow*Math.LN2)}function Xz(e,t){return e.halfWindowSize*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2)}function Yz(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)}function Kz(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)}function Jz(e){const t=e.compared.sourceZoom-e.compared.targetZoom;if(t===0)return e.compared.pan*e.halfWindowSize/(e.desiredPixelFlow*e.halfWindowPanAtZoom(e.compared.sourceZoom));const i=Math.LN2*e.compared.pan,r=t,s=e.halfWindowPanAtZoom(r),n=e.halfWindowSize*Math.log(e.compared.sourceZoom/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*s);return e.compared.sourceZoom<=e.compared.targetZoom?n*(i-s):n*(i+s)}function ek(e,t){let i=tk(e,t);const r={ascensionFactor:t.ascensionFactor!=null?t.ascensionFactor:.5,descensionFactor:t.descensionFactor!=null?t.descensionFactor:.5},s=r.ascensionFactor===0,n=r.descensionFactor===0,a=s?jz:kz,o=s?Uz:Bz,l=s?Hz:Nz,c=n?Xz:Wz,u=n?Yz:Zz,p=n?Kz:Qz,m=x=>a(e,x,r)+qz(e,x,r)+c(e,x,r),f=x=>o(e,x,r)+Gz(e,x,r)+u(e,x,r),g=x=>l(e,x,r)+$z(e,x,r)+p(e,x,r);let y=m(i);const v=Jz(e);let C;const b=t.maximumIterations||20,S=t.maximumDistance!=null?t.maximumDistance:1/0;for(C=0;C<b;C++){const x=t.desiredSlope??1e-6;let T=f(i);Math.abs(T)>x&&(T+=x);const P=T/g(i);if(isNaN(P)||i>=S&&P<0){if(!isFinite(S))return null;i=S,y=m(i);break}if(i-=P,i<=e.compared.sourceZoom||i<=e.compared.targetZoom)return null;const R=m(i);if(Math.abs(R-y)/y<=.005)break;y=R}return isNaN(y)||y>v*(1-.3)||i<=e.compared.sourceZoom||i<=e.compared.targetZoom?null:i}function tk(e,t){const i=Math.max(e.compared.sourceZoom,e.compared.targetZoom),r=e.source.zoomAtPixelsPerPan(e.desiredPixelFlow/e.compared.pan)/2;return r<i?t.maximumDistance!=null?i+(t.maximumDistance-i)/2:1.5*i:t.maximumDistance?Math.min(t.maximumDistance,r):r}let ik=class extends Vz{constructor(e,t){super(),this._preallocSegments=[new Uy,new Uy,new Uy],this._ascensionSegment=null,this._descensionSegment=null,this.update(e,t)}update(e,t){if(!e)return;this.definition?this.definition.copyFrom(e):this.definition=e.clone();const i=t?.apex?ek(e,t.apex):null;this.segments.length=0,this._ascensionSegment=null,this._descensionSegment=null,i?this._updateWithApex(i,t?.apex):this._updateWithoutApex()}segmentInterpolateComponentsAt(e,t,i){e.interpolateComponentsAt(t,i),e===this._ascensionSegment?i.zoom=Gg(i.zoom):e===this._descensionSegment&&(i.zoom=Tp(i.zoom))}_updateWithApex(e,t){const[i,r,s]=this._preallocSegments,n=t?.ascensionFactor??.5,a=Math.min(1-n,t?.ascensionFactor!=null&&t.descensionFactor!=null?t.descensionFactor:.5),o=1-n-a;i.definition?i.definition.copyFrom(this.definition):i.definition=this.definition.clone(),i.definition.compared.targetZoom=e,i.definition.compared.pan=this.definition.compared.pan*n,i.definition.compared.rotate=this.definition.compared.rotate*n,i.definition.segmentEnd=n,i.update(),this._ascensionSegment=i,this.segments.push(i),o>0&&(r.definition?r.definition.copyFrom(this.definition):r.definition=this.definition.clone(),r.definition.copyFrom(this.definition),r.definition.compared.sourceZoom=e,r.definition.compared.targetZoom=e,r.definition.compared.pan=this.definition.compared.pan*o,r.definition.compared.rotate=this.definition.compared.rotate*o,r.definition.segmentStart=i.definition.segmentEnd,r.definition.segmentEnd=i.definition.segmentEnd+o,r.update(),this.segments.push(r)),s.definition?s.definition.copyFrom(this.definition):s.definition=this.definition.clone(),s.definition.compared.sourceZoom=e,s.definition.compared.pan=this.definition.compared.pan*a,s.definition.compared.rotate=this.definition.compared.rotate*a,s.definition.segmentStart=n+o,s.update(),this._descensionSegment=s,this.segments.push(s)}_updateWithoutApex(){const[e]=this._preallocSegments;e.update(this.definition),this.segments.push(e)}};const rk=new Fz;let sk=class{get time(){return this._time}get isLinear(){return this.path.segments.length===1}constructor(e){this._time=Oe(0),this._easing=Kg,this.definition=new Lz(e),this.path=new ik}update(e,t,i){this.definition.update(e,t,i),this.path.update(this.definition,i),this._time=this._applyTimeSettings(jP(isFinite(this.path.time)?this.path.time:Yi(0)),i),this._easing=i.easing??(this._time>=1e3?Kg:ou)}cameraAt(e,t){e=Math.min(Math.max(0,e),1),e=this._normalizedEasing(e);const i=this.path.interpolateComponentsAt(e,rk);t.interpolate(this.definition.source,this.definition.target,i)}_normalizedEasing(e){const t=this._easing(0,this._time),i=this._easing(1,this._time);return(this._easing(e,this._time)-t)/(i-t)}_applyTimeSettings(e,t){const i=t.speedFactor!=null?t.speedFactor:1,r=t.minDuration??Jg.minDuration/i,s=t.maxDuration??Jg.maxDuration/i;return e=t.duration!=null?Oe(t.duration):Oe(Math.min(Math.max(e/i,r),s))}},nk=class{get finished(){return this.currentTime>=this._animation.time}get time(){return this._animation.time}constructor(e){this.currentTime=Oe(0),this._animation=new sk(()=>new RC(e)),this._current=new RC(e)}update(e,t,i){const{source:r,target:s}=this._animation.definition,n=de(ak,t.center,e.center),a=ge(n);a>=1e-5?(n[0]/=a,n[1]/=a,n[2]/=a):(n[0]=0,n[1]=1,n[0]=0),q(r.direction,n),q(s.direction,n),r.copyFromRenderCamera(e),s.copyFromRenderCamera(t),this._current.copyFrom(r),this._animation.update(r,s,i),this.currentTime=Oe(0),e.almostEquals(t)&&(this.currentTime=this._animation.time)}cameraAt(e,t){this._animation.cameraAt(e,this._current),this._current.copyToRenderCamera(t)}step(e,t){this.finished||(this.currentTime=Oe(this.currentTime+jP(e)),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,t)}};const ak=w();let La=class extends ie{constructor(e){super(e),this.state=0}get running(){return this.state===2}get isInteractive(){return!1}get canStop(){return!1}stopController(){return!!this.destroyed||!!this.canStop&&(this.state=3,!0)}finishController(){this.state=4}};h([d({constructOnly:!0})],La.prototype,"view",void 0),h([d({readOnly:!0})],La.prototype,"running",null),h([d()],La.prototype,"state",void 0),h([d({readOnly:!0})],La.prototype,"isInteractive",null),La=h([D("esri.views.3d.state.controllers.CameraController")],La);let Pp=class extends La{constructor(){super(...arguments),this._asyncResult=null}get canStop(){return!0}set asyncResult(e){this._asyncResult&&(this._asyncResult.reject(Ui()),this._asyncResult=null),this.state===4||this.state===3?(zP(e),this.state===4?e.resolve():e.reject(Ui())):this._asyncResult=e}get asyncResult(){return this._asyncResult}onControllerStart(){this.state=2,this.viewAnimation!=null&&this.viewAnimation.when(()=>this.updateStateFromViewAnimation(),()=>this.updateStateFromViewAnimation())}updateStateFromViewAnimation(){!this.viewAnimation||this.state!==0&&this.state!==2||(this.viewAnimation.state===nu.state.FINISHED?this.finish():this.viewAnimation.state===nu.state.STOPPED&&(this.state=3))}onControllerEnd(e){this.viewAnimation==null||this.viewAnimation.done||(this.state===4?this.viewAnimation.finish():this.state===3&&this.viewAnimation.stop()),this._asyncResult&&(this.state===4?this._asyncResult.resolve():this._asyncResult.reject(Ui()))}finish(){this.finishController()}};Pp=h([D("esri.views.3d.state.controllers.AnimationController")],Pp);let Ul=class extends Pp{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.type="point-to-point",this.mode="interaction"}initialize(){this.animation=new nk(this.view.state.viewingMode),this.viewAnimation=this.mode==="interaction"?null:new nu}get isInteractive(){return this.mode==="interaction"}begin(e,t){this.stepController=(s,n)=>{this.animation.step(s,n),this.animation.finished&&this.finishController()};const i=this.animationSettings(t);_d.copyFrom(this.view.state.camera);const r=new Us(this.view.state.viewingMode);this._intersectionHelper.intersectRay(_d.ray,r,EC)&&(_d.center=EC),this.animation.update(_d,e,i),this.animation.finished&&this.finish()}finish(){this.animation.currentTime=this.animation.time,super.finish()}onControllerEnd(e){this.stepController&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,e),this.animation.currentTime=this.animation.time),super.onControllerEnd(e),this.stepController=void 0}animationSettings(e={}){return{apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0},...e,easing:typeof e.easing=="string"?Sz[e.easing]:e.easing}}};h([d({constructOnly:!0})],Ul.prototype,"mode",void 0),h([d({readOnly:!0})],Ul.prototype,"isInteractive",null),Ul=h([D("esri.views.3d.state.controllers.PointToPointAnimationController")],Ul);let _d=new vt;const EC=w();function ok(){_d=new vt}function AC(e){return e!=null&&"type"in e&&e.type==="point-to-point"}function U_(e=ck){return[e[0],e[1],e[2],e[3]]}function Mp(e,t){return lk(e[0],e[1],e[2],t,EL.get())}function lk(e,t,i,r,s=U_()){return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s}function bb(e,t,i){return ri(i,e,t),me(i,i),i[3]=lM(e,t),i}const ck=[0,0,1,0];function Sre(e,t,i=$o()){return wb(e,gn(t),i),me(i.direction,i.direction),i}function wb(e,t,i){return hk(e,e.screenToRender(t,Xh(yt.get())),i)}function hk(e,t,i){if(t==null)return null;const r=Xh(fs(yt.get(),t));if(r[2]=0,!e.unprojectFromRenderScreen(r,i.origin))return null;const s=Xh(fs(yt.get(),t));s[2]=1;const n=e.unprojectFromRenderScreen(s,yt.get());return n==null?null:(de(i.direction,n,i.origin),i)}function bu(e,t,i){return xb(e,e.screenToRender(t,Xh(yt.get())),i)}function xb(e,t,i){q(i.origin,e.eye);const r=xe(yt.get(),t[0],t[1],1),s=e.unprojectFromRenderScreen(r,yt.get());return s==null?null:(de(i.direction,s,i.origin),i)}function Cb(e,t,i,r){const s=bu(t,i,uk);return F_(e,s,r)}const uk=$o(),XR=30,e_=[1,3e8],YR=8,t_=[200,1508e5],KR=5,JR=50,dk=5,pk=10,Qp=80,Hy=90,Uo=1e-6,gc={exclude:new Set([Lo])};function Yl(e,t,i){return i[0]=t[0]/(e.fullWidth/e.pixelRatio),i[1]=t[1]/(e.fullHeight/e.pixelRatio),i}function w1(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function Ho(e,t,i){const r=ko(OL.get(),i[3],i);r==null||rL(r,vn)||(de(ot,e.eye,t),lt(ot,ot,r),e.eye=ce(ot,ot,t),de(ot,e.center,t),lt(ot,ot,r),e.center=ce(ot,ot,t),e.up=lt(ot,e.up,r))}function mk(e,t,i,r){return j2(e,wb(t,i,Pb),r)}function x1(e,t,i,r){return j2(e,bu(t,i,Pb),r)}function Sb(e,t,i,r){const s=yt.get();let n=1-i;de(s,t,e.eye);const a=ge(s);let o=a*(1-n);n>=0&&o<r&&(o=r,n=-(o-a)/a),Math.abs(a-o)<Uo||(te(s,s,n),e.eye=ce(ot,e.eye,s),e.center=Nt(ot,e.center,t,n))}function eD(e,t,i){t.getScreenCenter(IC),Cb(e,t,IC,ot)&&(t.center=ot);const r=t.distance,s=r*i;if(Math.abs(r-s)<Uo)return;const n=te(yt.get(),t.viewForward,s);t.eye=de(ot,t.center,n)}const IC=si();function qy(e,t){xe(t,0,0,0);for(const i of e)ce(t,t,i);te(t,t,1/e.length)}function $f(e,t,i,r){return Math.sin(e/ge(t))*(i+r.radius)}function LC(e,t,i,r){return $f(Math.PI/2,t,i,r)+(e-Math.PI/2)}const FC={Elevation:3e4,Angle:rt(16)},tD=rt(80);function iD(e,t,i,r,s,n){const a=w(),o=Kr();let l=!0,c=!0;return e.intersectScreen(i,a,n)?o[3]=ge(a):(c=!1,t.aboveGround&&s!==0?o[3]=Math.max(ge(t.center),.9*r):o[3]=ge(t.eye)-t.relativeElevation,s===1?Rp(o,t,i,a):l=Cb(o,t,i,a)),{sphere:o,scenePickPoint:l?a:null,hasGeometryIntersection:c}}function Xp(e,t,i,r){const s=e.relativeElevation;if(s>FC.Elevation&&r==="global")return 1;bu(e,t,$y);const n=Math.sign(s),a=i.worldUpAtPosition(e.eye,ot);return-n*$e(a,$y.direction)<Math.sin(FC.Angle)*ge($y.direction)?0:1}function rD(e,t,i){de(Gy,i,t),e.eye=de(ot,e.eye,Gy),e.center=de(ot,e.center,Gy)}const Gy=w();function Rp(e,t,i,r){const s=bu(t,i,Pb);return s!=null&&(L_(e,s,Tm),F_(e,s,r)?!(Do(Tm,s.origin)<Do(r,s.origin))||(q(r,Tm),!1):(de(Dc,t.eye,t.center),me(Dc,Dc),W4(Dc,-$e(me(Dc,Dc),Tm),VC),j2(VC,s,r),!1))}const Tm=w(),Dc=w(),VC=Ga();function sD(e,t,i,r,s,n){let a=0;if(ri(s_,e,t),de(Dm,e,t),ge(e)<=s||!r.aboveGround){ri(i,Dm,r.eye);const o=$e(e,t)/(ge(e)*ge(t));if(o<.9999)a=qa(o);else{const c=ge(ri(w(),e,t))/(ge(e)*ge(t));a=cp(c)}const l=Math.cos(j(Bo.normalize(rt(n)),0,tD));a=-a-Math.max(0,ge(t)-s)/(l*s)}else de(zC,r.eye,r.center),ri(i,Dm,zC),a=-ge(Dm)/s;return me(i,i),te(i,i,ge(s_)),a}const zC=w();function kC(e,t,i,r){let s,n;const a=Math.cos(j(Bo.normalize(rt(r)),0,tD));return s=t>i?-(t-i)/(a*i):t<-i?Math.PI-(t+i)/(a*i):qa(t/i),n=e>i?-(e-i)/(a*i):e<-i?Math.PI-(e+i)/(a*i):qa(e/i),(n-s)*i}function fk(e,t,i,r,s,n,a,o,l,c){const u=kC(e[2],t[2],n[3],o),p=l?kC(e[0],t[0],n[3],180):t[0]-e[0],m=Math.sin(a)*p-Math.cos(a)*u,f=Math.cos(a)*p+Math.sin(a)*u;me(ot,s);const g=l?m/Math.sqrt(Math.abs(n[3]**2-$e(i,ot)**2)):m/n[3],y=f/Math.sqrt(Math.abs(n[3]**2-$e(i,r)**2));Ki(c,g,y)}function nD(e,t,i,r,s,n,a,o,l,c){ri(s_,e,t),Av(n.up,n.eye,Pm,Mm,Rm),Av([0,0,1],n.eye,Na,Oo,cD),q(i,Oo),q(r,Na),me(i,i),te(i,i,ge(s_)),rx(e,me(Mm,Mm),me(Rm,Rm),me(Pm,Pm),BC),rx(t,Mm,Rm,Pm,NC),fk(BC,NC,e,Na,Oo,a,o,l,c,s)}function gk(e,t,i,r,s,n,a){ko(i_,s,r),ko(r_,a,n),lr(Rh,i_,r_),de(t,e,i),lt(t,t,Rh),ce(t,t,i)}function aD(e,t,i,r,s,n){ko(i_,r,i),ko(r_,n,s),lr(Rh,i_,r_),de(ot,e.eye,t),lt(ot,ot,Rh),e.eye=ce(ot,ot,t),de(ot,e.center,t),lt(ot,ot,Rh),e.center=ce(ot,ot,t),de(ot,e.up,t),lt(ot,ot,Rh),e.up=ce(ot,ot,t)}const Jo={Pole:.95,Angle:rt(18),Tilt:45,TiltHysteresisMargin:1e-7};let Oc=!1;function Tb(e,t,i,r,s,n){const a=Math.abs(r)>Math.PI-Jo.Angle||Math.abs(r)<Jo.Angle,o=(Math.abs(e[2])<i*Jo.Pole||Math.abs(t)>i)&&n;return a&&o?!Oc&&s<Jo.Tilt-Jo.TiltHysteresisMargin?Oc=!0:Oc&&s>Jo.Tilt+Jo.TiltHysteresisMargin&&(Oc=!1):Oc=!1,Oc}function oD(e,t,i,r,s,n){if(n)bb(i,r,jC),Ho(t,Gi(e),jC);else{const a=sD(i,r,UC,t,e[3],s);Ho(t,Gi(e),Mp(UC,a))}}function lD(e,t,i,r,s,n,a){const o=a?20:1,l=1e-12;let c,u;q(el,r),yd.copyFrom(t);for(let p=0;p<o&&Do(i,el)>l&&(c=Do(i,el),nD(i,el,Oo,Na,Lu,yd,e,s,n,a),aD(yd,Gi(e),Na,Lu[1],Oo,Lu[0]),gk(el,el,Gi(e),Na,Lu[1],Oo,Lu[0]),u=Do(i,el),u<c||p===0);p++)t.copyFrom(yd)}function _k(e,t,i,r,s,n,a){Tb(i,$e(t.up,i),e[3],-Bo.normalize(rt(s)),n,t.aboveGround)?lD(e,t,i,r,-Bo.normalize(rt(s)),n,a):oD(e,t,i,r,n,a)}function yk(e,t,i,r,s,n){const{eye:a}=e;Av([0,0,1],a,Na,Oo,cD);const o=t.translation[0]*i.pan,l=s.mode==="zoom"?0:t.translation[1]*i.pan,c=Math.max(Math.sqrt(Math.abs(1-$e(e.center,Na)**2/ge(e.center)**2)),.5),u=(Math.sin(n)*l+Math.cos(n)*o)/c,p=-Math.cos(n)*l+Math.sin(n)*o;switch(yn(r.pan.matrix,r.pan.matrix,u,Na),r.pan.enabled=!0,s.mode){case"pan":yn(r.pan.matrix,r.pan.matrix,p,Oo),r.pan.enabled=!0;break;case"zoom":r.zoom=-t.translation[1]*i.zoom}}function vk(e,t,i,r,s){const{eye:n,viewRight:a}=e,o=ri(yt.get(),a,n),l=t.translation[0]*i.pan;switch(l!==0&&(yn(r.pan.matrix,r.pan.matrix,-l,o),r.pan.enabled=!0),s.mode){case"pan":{const c=t.translation[1]*i.pan;c!==0&&(yn(r.pan.matrix,r.pan.matrix,c,a),r.pan.enabled=!0);break}case"zoom":r.zoom=-t.translation[1]*i.zoom}}function bk(e,t,i,r,s,n,a,o,l){Tb(e.center,$e(e.up,e.center),ge(e.center),-Bo.normalize(rt(n)),a,t.aboveGround)?yk(t,i,r,o,l,-Bo.normalize(rt(s))):vk(t,i,r,o,l)}function wu(e,t,i=1/0){const r=Math.abs($e(e,t));return Math.min(i,1/r)}const Na=w(),Oo=w(),cD=w(),Pm=w(),Mm=w(),Rm=w(),BC=w(),NC=w(),Lu=ze(),jC=U_(),i_=Le(),r_=Le(),Rh=Le(),el=w(),ot=w(),Dm=w();let yd=new vt;const s_=w(),UC=w();function wk(){yd=new vt}const Pb={origin:w(),direction:w()},$y={origin:w(),direction:w()},HC=.6,Wy=4,xk=60;let n_=class extends Ul{constructor(){super(...arguments),this._zoomLocation=w(),this._tmpCamera=new vt,this._tmpViewDir=w(),this._tmpRayDir=$o(),this._targetOnSphere=w(),this._tmpCenter=w(),this._beginCamera=new vt,this._constraintOptions=new ys(7,1,null,this._beginCamera),this._sphere=Kr()}initialize(){this._intersector=new Us(this.view.state.viewingMode)}step(e,t){if(!this.running)return;const i=this.view.state;this.animation.finished?this._beginCamera.copyFrom(i.camera):this.animation.cameraAt(1,this._beginCamera);let r=!1,s=!1;this._intersectionHelper.intersectScreen(t,this._zoomLocation,this.view.map.ground.opacity===0?gc:{})&&(r=e>0,s=!0),this._tmpCamera.copyFrom(i.camera),r?this._intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter):this._intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:q(this._zoomLocation,this._tmpCamera.center),this._updateCamera(this._tmpCamera,e,t,s),this.begin(this._tmpCamera)}animationSettings(){return{duration:Oe(600),easing:ou}}_updateCamera(e,t,i,r){const s=Xp(e,i,this.view.renderCoordsHelper,this.view.viewingMode),n=Math.abs(this.view.camera.position.z),a=this._zoomLocation;me(Em,e.eye),te(Em,Em,-1),bu(e,i,this._tmpRayDir),me(this._tmpRayDir.direction,this._tmpRayDir.direction);const o=j(wu(Em,this._tmpRayDir.direction,YR)*n,t_[0],t_[1]);if(s===1){let l=HC**t;this._sphere[3]=ge(a),de(this._tmpViewDir,e.center,e.eye);const c=Math.min(ge(this._tmpViewDir),o);let u=c*l;if(l<=1&&u<Wy&&(u=Wy,l=u/c),Math.abs(c-u)<Uo)return;const p=ge(e.center);if(this._sphere[3]!==p){const m=this._sphere[3]+l*(p-this._sphere[3]);e.center=te(Om,e.center,m/p)}te(this._tmpViewDir,this._tmpViewDir,-l),e.eye=ce(Om,e.center,this._tmpViewDir),kt(this.view,e,this._constraintOptions),Do(a,e.center)>1e-12&&Cb(this._sphere,e,i,this._targetOnSphere)&&_k(this._sphere,e,a,this._targetOnSphere,this.view.camera.heading,this.view.camera.tilt,!0)}else{let l=HC**Math.abs(t);const c=t>0?1:-1;de(this._tmpViewDir,a,e.eye);const u=ge(this._tmpViewDir);let m=this.view.stage.renderView.getMinimalDepthForArea(null,i[0],i[1],this.view.state.camera,xk)??o;r&&t>0&&(m=Math.min(m,u)),te(this._tmpRayDir.direction,this._tmpRayDir.direction,m),ce(a,this._tmpRayDir.origin,this._tmpRayDir.direction);let f=m*l;const g=Math.max(Wy,1.01*e.nearFar[0]);if(t>0&&f<g&&(f=g,l=f/m),Math.abs(m-f)<Uo)return;te(this._tmpRayDir.direction,this._tmpRayDir.direction,c*(1-l)),e.eye=ce(Om,e.eye,this._tmpRayDir.direction),e.center=ce(Om,e.center,this._tmpRayDir.direction),me(this._tmpRayDir.direction,this._tmpRayDir.direction),this._constraintOptions.interactionDirection=this._tmpRayDir.direction,kt(this.view,e,this._constraintOptions),this._constraintOptions.interactionDirection=null}vu(this.view,e)}};n_=h([D("esri.views.3d.state.controllers.ZoomStepControllerGlobal")],n_);const Om=w(),Em=w();let Wf,Zf=null;const Hh=new Map;async function Tre(e){Zf==null&&(Wf==null&&(Wf=k(()=>le(()=>import("./VoxelWasmPerSceneView-CLy8E53P-iIWohSvU.js"),__vite__mapDeps([449,1,2,3,7,8,4,15,6,9,10,12,167,19,20,14,192,69,38,170,87,169,86,166,168,171,172,173,174,175,176,13,177,36,37,178,179,180,181,101,27,182,183,184,34,11,92,185,186,187,91,93,26,89,94,188,193,194,25,5,28,29,30,31,32,33,35,39,40,41,42,43,195,97,196,360,223,21,16,22,23,112,113,189,190,191,128,197,75,198,200,46,201,202,203,146,51,204,205,206,143,207,208,209,68,210,50,47,48,211,212,213,18,214,215,141,82,83,84,81,80,70,216,160,131,217,221,226,227,233,234,121,199,165,218,219,220,98,99,222,224,225,79,228,229,230,231,232,235,236])),ue([450,1,7,8,5,6,2,15,4,9,10,12,183,19,20,14,207,70,39,186,88,185,87,182,184,187,188,189,190,191,192,13,193,37,38,194,195,196,197,102,28,198,199,200,35,11,93,201,202,203,92,94,27,90,95,204,208,209,26,3,29,30,31,32,33,34,36,40,41,42,43,44,210,98,211,361,237,21,16,22,23,24,113,114,205,206,175,129,122,52,212,76,213,214,180,47,18,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,166,132,231,232,233,234,99,100,235,236,238,239,80,240,241,242,243,244,245,246,247,248,249,250]))),Zf=await Wf);const t=e.view;let i=Hh.get(t);return i||(i=new Zf.default({view:t}),Hh.set(t,i)),i.addVoxelLayer(e)}function Dp(e){return Hh.get(e)}function Pre(e){const t=e.view,i=Hh.get(t);i&&i.removeVoxelLayer(e)<1&&(Hh.delete(t),Hh.size===0&&(Wf=null,Zf=null))}const Ck=.6,Sk=4,Tk=60;let a_=class extends Ul{constructor(){super(...arguments),this._zoomLocation=w(),this._tmpCamera=new vt,this._tmpRayDir=w(),this._tmpCenter=w(),this._beginCamera=new vt,this._constraintOptions=new ys(15,1,null,this._beginCamera)}step(e,t){if(!this.running)return;const i=this.view.state;this.animation.finished?this._beginCamera.copyFrom(i.camera):this.animation.cameraAt(1,this._beginCamera),this._tmpCamera.copyFrom(i.camera);const r=new Us(this.view.state.viewingMode);let s=!1;e>0?(s=this._intersectionHelper.intersectScreenFreePointFallback(t,this._zoomLocation,this.view.basemapTerrain.invisible?gc:{}),this._intersectionHelper.intersectRay(this._tmpCamera.ray,r,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter)):this._intersectionHelper.intersectRay(this._tmpCamera.ray,r,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:q(this._zoomLocation,this._tmpCamera.center);const n=Ck**e;let a=this.view.stage.renderView.getMinimalDepthForArea(Dp(this.view),t[0],t[1],this.view.state.camera,Tk);de(Am,this._tmpCamera.eye,this._zoomLocation),me(Am,Am);const o=Math.abs(this.view.camera.position.z),l=j(wu(Pk,Am,YR)*o,t_[0],t_[1]);a=a??l;const c=w();de(c,this._zoomLocation,this._tmpCamera.eye),(a<ge(c)||!s)&&(me(c,c),ce(this._zoomLocation,this._tmpCamera.eye,te(c,c,a))),this._updateCamera(this._tmpCamera,n,this._zoomLocation),this.begin(this._tmpCamera)}animationSettings(){return{duration:Oe(600),easing:ou}}_updateCamera(e,t,i){de(this._tmpRayDir,i,e.eye);const r=ge(this._tmpRayDir);let s=r*t;const n=t<=1,a=Math.max(Sk,1.01*e.nearFar[0]);s!==0&&(n&&s<a&&(s=a,t=s/r),Math.abs(r-s)<Uo||(te(this._tmpRayDir,this._tmpRayDir,t),e.eye=de(qC,i,this._tmpRayDir),e.center=Nt(qC,e.center,i,1-t),kt(this.view,e,this._constraintOptions)))}};a_=h([D("esri.views.3d.state.controllers.ZoomStepControllerLocal")],a_);const qC=w(),Pk=We(0,0,1),Am=w();function Mk(e,t){switch(t){case"primary":return e.pointerType==="touch"||e.button===0;case"secondary":return e.pointerType!=="touch"&&e.button===2;case"tertiary":return e.pointerType!=="touch"&&e.button===1}}function Mb(e,t){const{button:i,pointerType:r}=e;return r!=="touch"&&t.some(s=>s==="primary"&&i===0||s==="secondary"&&i===2||s==="tertiary"&&i===1)}function Zy(e,{dragPrimary:t,dragSecondary:i,dragTertiary:r}){return[{key:"primary",value:t},{key:"secondary",value:i},{key:"tertiary",value:r}].filter(s=>s.value===e).map(s=>s.key)}let Rk=class extends Wi{constructor(e,t){super(!0),this._view=e,this.registerIncoming("double-click",t,i=>this._handleDoubleClick(i))}_handleDoubleClick(e){const t=e.data;if(Mk(t,"primary")){const i=this._view.state.isGlobal?new n_({view:this._view,mode:"animation"}):new a_({view:this._view,mode:"animation"});this._view.state.switchCameraController(i),i.step(Math.log(.5)/Math.log(.6),si(t.x,t.y)),e.stopPropagation()}}},Qf=class extends ie{constructor(e){super(e)}initialize(){this.addHandles(this.view.elevationProvider.on("elevation-change",e=>this._handleElevationChangeEvent(e)))}_handleElevationChangeEvent(e){if(this.view.state.cameraController||e.context!=="ground")return;const t=this.view.state.camera;e.spatialReference!=null&&e4(this.view,t,e.extent,e.spatialReference)&&this._applyToCurrentCamera()}_applyToCurrentCamera(){this.view.state.updateCamera(e=>vu(this.view,e,1))}};h([d({constructOnly:!0})],Qf.prototype,"view",void 0),Qf=h([D("esri.views.3d.state.SurfaceCollisionConstraint")],Qf);let vd=class extends ie{constructor(e){super(e),this.nearFarHeuristic=s8(e.view.state.viewingMode,e.view.basemapTerrain,e.view.renderCoordsHelper.spatialReference)}initialize(){const e=()=>this._updateNearFar();this.addHandles([M(()=>[this.view.constraints.clipDistance.near,this.view.constraints.clipDistance.far],()=>this._clipDistanceNearFarChanged()),this.view.state.events.on("before-camera-change",({camera:t,sceneDepthRange:i})=>this._updateCameraNearFar(t,i)),M(()=>this.view.constraints.clipDistance.mode,e),M(()=>this.view.stage.renderer.sceneDepthRange.value,e,Ie),M(()=>this.view.renderDataExtent,e,Ie),M(()=>this.view.basemapTerrain.visibleElevationBounds,e,Ie),M(()=>[this.view.constraints.altitude.min,this.view.constraints.altitude.max],()=>this._updateAltitude(),Ie),M(()=>this.view.constraints.tilt.max,()=>this._updateTiltMax(),Ie),M(()=>this.view.constraints.tilt.mode,()=>this._updateTilt(),Ie),M(()=>this.view.state?.camera,()=>this._updateTiltAutoMax(),Ie),M(()=>[this.view.map?.ground?.navigationConstraint?.type,this.view.state.constraints.collision.enabled],()=>this._updateCollision(),Ie)]),this.view.state.isLocal&&this.addHandles(M(()=>this.view.renderDataExtent,t=>this._updateLocalSurfaceDistance(t),Ee)),this._updateNearFar(),this.view.state.viewingMode!==2&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new Qf({view:this.view}))}destroy(){this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}_clipDistanceNearFarChanged(){const e=this.view.constraints.clipDistance;e.mode!=="auto"&&this.view.state.updateCamera(t=>GC(t,e))}_updateNearFar(){this.view.state.updateCamera(e=>this._updateCameraNearFar(e))}_updateCameraNearFar(e,t){const i=this.view.constraints.clipDistance;i.mode==="manual"?GC(e,i):this._updateCameraNearFarAuto(e,i,t)}_updateCameraNearFarAuto(e,t,i=this.view.stage.renderer.sceneDepthRange.value){const r=C2(this.view,e.eye),s=this.nearFarHeuristic.compute(e,this.view.renderDataExtent,i,r);e.near=s.near,e.far=s.far,t&&t.autoUpdate(e.near,e.far)}_updateCollision(){const e=this.view.map?.ground?.navigationConstraint?.type,t=!e||e==="stay-above",i=this.view.state.constraints.collision;t!==i.enabled&&(i.enabled=t,t&&this._reapplyConstraints(8),this.view.constraints.tilt.mode==="auto"&&this._updateTiltAuto())}_updateAltitude(){const e=this.view.constraints.altitude;this.view.state.viewingMode===1?this.view.state.constraints.altitude={min:e.min,max:e.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()}_updateTiltMax(){const e=this.view.constraints.tilt;e.mode!=="auto"&&(this._updateTiltManual(e),this._reapplyConstraints())}_updateTilt(){const e=this.view.constraints.tilt;e.mode==="manual"?this._updateTiltManual(e):this._updateTiltAuto(),this._reapplyConstraints()}_updateTiltManual(e){const t=this.view.state.constraints;t.tilt=t.createConstantMaxTilt(rt(e.max))}_updateTiltAuto(){const e=this.view.state.constraints;e.tilt=e.createDefaultTilt(),this._updateTiltAutoMax()}_updateTiltAutoMax(){const e=this.view.constraints.tilt;if(e.mode!=="auto")return;const t=this.view.state.constraints;if(t.tilt){const i=t.tilt(this.view.state.camera.distance).max;e.autoUpdate(sc(i))}}_updateLocalSurfaceDistance(e){if(e==null)return;let t=Math.max(e.width,e.height);if(t<=0)return;e.zmax!=null&&e.zmin!=null&&(t=Math.max(t,e.zmax-e.zmin));const i=this.view.state,r=3*t/Math.atan(i.camera.fov/2);r!==i.constraints.distance&&(i.constraints.distance=r)}_reapplyConstraints(e=15){this.view.state.updateCamera(t=>kt(this.view,t,new ys(e,0,null)))}};function GC(e,t){t&&(e.near=t.near,e.far=t.far)}h([d({constructOnly:!0})],vd.prototype,"view",void 0),h([d({readOnly:!0})],vd.prototype,"surfaceCollisionConstraint",void 0),vd=h([D("esri.views.3d.state.ConstraintsManager")],vd);let Wd=class extends La{constructor(e){super(e)}set desiredCamera(e){this._set("desiredCamera",e.clone())}get canStop(){return!0}get constraintEnabled(){return this.view.state.constraints.collision.enabled}onControllerStart(){this.state=2,this.addHandles(this.view.elevationProvider.on("elevation-change",e=>this._elevationChangeEvent(e))),this._applyCorrection()}onControllerEnd(){this.removeAllHandles()}_elevationChangeEvent(e){e.spatialReference!=null&&!e4(this.view,this.desiredCamera,e.extent,e.spatialReference)||e.context!=="ground"||this._applyCorrection()}_applyCorrection(){this.view.state.updateCamera(e=>{e.copyViewFrom(this.desiredCamera),vu(this.view,e,1)||this.constraintEnabled||(this.state=3)})}};h([d({constructOnly:!0})],Wd.prototype,"desiredCamera",null),Wd=h([D("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],Wd);const Dk=.66;function hD(e){return 360-Q2.normalize(e)}function H_(e){return Q2.normalize(360-e)}function Ok(e,t,i){const r=t.camera;if(r!=null)return Ak(r,mc(e));const{targetGeometry:s}=t;if(s==null)return null;const{camera:n,mode:a}=uD(e,t.rotation,i);if(s.type==="point")return Lk(e,t,s,n,a);const o=s.extent;return o==null?null:Ff(e,o,n.heading,n.tilt,a)}async function Ek(e,t,i,r){const s=t.camera;if(s!=null)return Ik(s,mc(e),r);const{targetGeometry:n}=t;if(n==null)throw new Error("Viewpoint has no targetGeometry!");const{camera:a,mode:o}=uD(e,t.rotation,i);if(n.type==="point")return Fk(e,t,n,a,o,r);const l=n.extent;if(l==null)throw new Error("Target geometry has no extent!");return hR(e,l,a.heading,a.tilt,o,r)}function Ak(e,t){const i=e.position;let r;try{r=L4(i,t)}catch{return null}if(!r)return null;const s=e.clone();return s.position=r.clone(),s}async function Ik(e,t,i){const r=e.position,s=await Vo(r,t,{signal:i});qe(i);const n=e.clone();return n.position=s.clone(),n}function uD(e,t,i){const r=$h(e,e.state.camera);let s=1;return t!=null&&(r.heading=hD(t),s=0),i!=null&&(r.tilt=i),{camera:r,mode:s}}function Lk(e,t,i,r,s){const n=e.spatialReference;let a;try{a=L4(i.clone(),n)}catch{return null}if(!a)return null;const o=t.scale!=null?bp(e,t.scale):e.state.camera.distance;return S7(e,a,o,r,s)}async function Fk(e,t,i,r,s,n){const a=e.spatialReference,o=await Vo(i.clone(),a,{signal:n});qe(n);const l=t.scale!=null?bp(e,t.scale):e.state.camera.distance;return k_(e,o,l,r,s,n)}function Vk(e,t,i=null){return i==null&&(i=new jo),Db(e,null,t.clone(),i)}async function zk(e,t,i){const r=Wk(e,t);if(!r)throw new fe("viewpointutils-create:no-target","Missing target for creating viewpoint");const s=new Xr({fov:e.camera.fov}),n=new jo({camera:s});if(r.target instanceof jo)return tl(await Nk(e,r.target,r,i,n));if(r.target instanceof Xr)return tl(await pD(e,r.target,i,n));const a=r.scale!=null||r.zoom!=null;if(r.target instanceof sr){const c=r.target.xmin===r.target.xmax||r.target.ymin===r.target.ymax;return tl(a||c?await C1(e,r,r.target.center,s,i,n):await qk(e,r,r.target,s,i,n))}const o=new Qk,l=a?kk(e,r):void 0;if(await dD(e,r.target,l,o,i),isFinite(o.boundingBox[0])){let c;if(K2(o.boundingBox,qt),hs.x=qt[0],hs.y=qt[1],hs.z=qt[2],hs.spatialReference=e.spatialReference,isFinite(hs.z)&&o.hasZ?c=dM(o.boundingBox):(hs.z=void 0,c=K9(J2(o.boundingBox,Xk))),a||c)return tl(await C1(e,r,hs,s,i,n));const u=Zk(e,o.screenSpaceObjects);return tl(await $k(e,r,hs,o.boundingBox,u,s,i,n))}return r.position?tl(await Uk(e,r,s,n,i)):tl(await Hk(e,r,s,i,n))}function Rb(e,t){return t.scale==null&&t.zoom!=null?mR(e,t.zoom):t.scale}function kk(e,t){const i=Rb(e,t);return i?bI(i):void 0}function q_(e,t){let i=!1;return t.heading!=null?(e.heading=t.heading,i=!0):t.rotation!=null&&(e.heading=hD(t.rotation),i=!0),t.tilt!=null&&(e.tilt=t.tilt,i=!0),t.fov!=null&&(e.fov=t.fov),i}function Db(e,t,i,r){const s=e.spatialReference||At.WGS84;if(t??=Qn(e,i),t==null)return r;const n=new wt({spatialReference:s});return qp(t.center,e.renderSpatialReference,n)&&(r.targetGeometry=n,r.scale=oc(e,t.distance),r.rotation=H_(i.heading),r.camera=i),r}async function o_(e,t,i,r){const s=()=>new fe("viewpointutils:invalid-geometry","The target is missing a valid geometry");if(!t)throw s();t.type==="mesh"&&(t=t.extent);const n=e.basemapTerrain.spatialReference;if(!t.hasZ&&e.basemapTerrain){let p;switch(t.type){case"point":p=t;break;case"multipoint":case"polyline":p=t.extent?.center;break;case"extent":p=t.center;break;case"polygon":{const m=QI(t);p=m?wt.fromJSON(m):null;break}}p!=null&&n&&e.elevationProvider?(p=await Vo(p,n,{signal:r}),qt[2]=Jn(e.elevationProvider,p)??0):qt[2]=0}const a=Yk[t.type],o=new Array;if(a(t,t.hasZ?p=>{o.push([p[0],p[1],p[2]])}:p=>{o.push([p[0],p[1]])},qt),o.length===0)throw s();const l=t.spatialReference,c=e.spatialReference,u=await Vo(new uM({spatialReference:l,hasZ:t.hasZ,hasM:!1,points:o}),c,{signal:r});if(t.hasZ&&(i.hasZ=!0),t.hasZ)for(const[p,m,f]of u.points)qt[0]=p,qt[1]=m,qt[2]=f,Ng(i.boundingBox,qt);else for(const[p,m]of u.points)qt[0]=p,qt[1]=m,Ng(i.boundingBox,qt)}async function Bk(e,t,i,r,s){const n=await kg(e.whenViewForGraphic(t));if(n.ok===!1||n.value==null||!("whenGraphicBounds"in n.value))return void await o_(e,t.geometry,r,s);const a=n.value,o=await kg(a.whenGraphicBounds(t,{minDemResolution:i}));if(o.ok===!1||!o.value)return void await o_(e,t.geometry,r,s);const{screenSpaceObjects:l,boundingBox:c}=o.value;pM(r.boundingBox,c),l&&l.forEach(u=>{r.screenSpaceObjects.push(u)}),isFinite(c[2])&&(r.hasZ=!0)}async function dD(e,t,i,r,s){if(Array.isArray(t)&&t.length===2){const n=t[0],a=t[1];if(typeof n=="number"&&typeof a=="number")return hs.x=n,hs.y=a,hs.z=void 0,hs.spatialReference=e.spatialReference?.isGeographic?e.spatialReference:At.WGS84,void await o_(e,hs,r,s)}t&&"map"in t&&typeof t.map=="function"?await Promise.allSettled(t.map(n=>dD(e,n,i,r,s))):t instanceof c9?await o_(e,t,r,s):t instanceof Y2&&await Bk(e,t,i,r,s)}async function Nk(e,t,i,r,s){if(t.camera)return pD(e,t.camera,r,s);s.scale=t.scale,s.rotation=t.rotation,s.targetGeometry=t.targetGeometry!=null?t.targetGeometry.clone():null,s.camera=null,i.heading!=null?s.rotation=H_(i.heading):i.rotation!=null&&(s.rotation=i.rotation);const n=Rb(e,i);return n!=null&&(s.scale=n),s.camera=await Ek(e,s,i.tilt,r),s}async function pD(e,t,i,r){const s=e.spatialReference,n=await Vo(t.position,s,{signal:i}),a=t.clone();return a.position=n,Db(e,null,a,r)}async function jk(e,t,i,r,s,n,a){const o=e.renderSpatialReference;return await Vg(t,Qy,o,0,{signal:a}),await Vg(i,Lm,o,0,{signal:a}),n.targetGeometry=new wt(t),s.position=new wt(i),de(l_,Qy,Lm),P_(e,Lm,l_,r.up,s),n.scale=oc(e,Gt(Lm,Qy)),n.rotation=H_(s.heading),n.camera=s,n}async function C1(e,t,i,r,s,n){n.targetGeometry=i.clone();const a=pu(e);if(t.position)return jk(e,n.targetGeometry,t.position,a,r,n,s);if(t.zoomFactor){const l=a.distance/t.zoomFactor,c=te(qt,a.viewForward,-l);a.eye=ce(qt,a.center,c),n.scale=oc(e,l)}$h(e,a,r);const o=q_(r,t)?0:1;if(!t.zoomFactor){const l=Rb(e,t);if(l==null){await Vg(n.targetGeometry,qt,e.renderSpatialReference,0,{signal:s});const c=YL(a.frustum,qt)?Gt(a.eye,qt):a.distance;n.camera=await k_(e,n.targetGeometry,c,r,o),n.scale=oc(e,c)}else n.scale=l,n.camera=await C7(e,n.targetGeometry,n.scale,r,o,s)}return n}async function Uk(e,t,i,r,s){const n=pu(e);q(l_,n.viewForward),P_(e,n.eye,l_,n.up,Xy);const a=e.spatialReference,{position:o}=t;if(o){const l=await Vo(o,a,{signal:s});i.position=l}else i.position=new wt;return i.heading=t.heading!=null?t.heading:Xy.heading,i.tilt=t.tilt!=null?t.tilt:Xy.tilt,Db(e,null,i,r)}async function Hk(e,t,i,r,s){if(t.heading!=null||t.rotation!=null||t.scale!=null||t.tilt!=null||t.zoom!=null||t.zoomFactor!=null){const n=pu(e),{spatialReference:a,renderSpatialReference:o}=e,l=new wt({spatialReference:a});return qp(n.center,o,l)?C1(e,t,l,i,r,s):s}return s.scale=e.scale,s.camera=e.camera.clone(),q_(s.camera,t),s}async function qk(e,t,i,r,s,n){n.targetGeometry=i.clone();const a=pu(e);$h(e,a,r);const o=q_(r,t)?0:1;return n.camera=await hR(e,i,r.heading,r.tilt,o,s),n}function Gk(e,t,i,r,s){let n=0;i.z!=null?n=i.z:e.basemapTerrain&&e.elevationProvider&&(n=Jn(e.elevationProvider,i)),xe(qt,i.x,i.y,n),V_(e.spatialReference,qt,$C,e.renderSpatialReference),G2(Im,$C),Gp(Im,Im),Gs(Fu);const a=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];for(let g=0;g<a.length;g++){const y=a[g];let v=r[y[2]];isFinite(v)||(v=n),xe(qt,r[y[0]],r[y[1]],v),No(qt,e.spatialReference,qt,e.renderSpatialReference),Ng(Fu,_n(qt,qt,Im))}const o=qL(Fu),l=fM(Fu),c=GL(Fu),u=1/Math.tan(t.fovX/2),p=1/Math.tan(t.fovY/2),m=.5*Math.sqrt(o*o+c*c)*Math.max(p,u)+.5*l,f=.5*l*p+.5*Math.max(o,c);return Math.max(m,f)/s}async function $k(e,t,i,r,s,n,a,o){o.targetGeometry=i.clone();const l=pu(e),c=Gk(e,l,i,r,s);$h(e,l,n);const u=q_(n,t)?0:1;return o.camera=await k_(e,o.targetGeometry,c,n,u,a),o.scale=oc(e,c),o}function Wk(e,t){if(!t||!e.spatialReference)return null;const i={target:void 0};return"declaredClass"in t||Array.isArray(t)?i.target=t:(Object.assign(i,t),!i.target&&"center"in t&&t.center&&(i.target=t.center)),i}function tl(e){return e?.camera!=null&&(e.rotation=H_(e.camera.heading)),e}function Zk(e,t){const i=Dk;if(!t.length)return i;let r=Number.NEGATIVE_INFINITY;for(let s=0;s<t.length;s++){const n=t[s].screenSpaceBoundingRect;r=Math.max(r,Math.abs(n[0]),Math.abs(n[1]),Math.abs(n[2]),Math.abs(n[3]))}return i-r/Math.min(e.width,e.height)*2}let Qk=class{constructor(){this.hasZ=!1,this.boundingBox=Gs(),this.screenSpaceObjects=new Array}};const qt=w(),$C=Le(),Im=Rn(),Fu=eo(),Xk=Rt(),l_=w(),Lm=w(),Qy=w(),Xy={heading:0,tilt:0},hs=new wt,Yk={point(e,t,i){i[0]=e.x,i[1]=e.y,e.z!=null&&(i[2]=e.z),t(i)},polygon(e,t,i){const r=e.hasZ;for(let s=0;s<e.rings.length;s++){const n=e.rings[s];for(let a=0;a<n.length;a++)i[0]=n[a][0],i[1]=n[a][1],r&&(i[2]=n[a][2]),t(i)}},polyline(e,t,i){const r=e.hasZ;for(let s=0;s<e.paths.length;s++){const n=e.paths[s];for(let a=0;a<n.length;a++)i[0]=n[a][0],i[1]=n[a][1],r&&(i[2]=n[a][2]),t(i)}},multipoint(e,t,i){const r=e.points,s=e.hasZ;for(let n=0;n<r.length;n++)i[0]=r[n][0],i[1]=r[n][1],s&&(i[2]=r[n][2]),t(i)},extent(e,t,i){e.zmin!=null&&e.zmax!=null?(t(xe(i,e.xmin,e.ymin,e.zmin)),t(xe(i,e.xmax,e.ymin,e.zmin)),t(xe(i,e.xmin,e.ymax,e.zmin)),t(xe(i,e.xmax,e.ymax,e.zmin)),t(xe(i,e.xmin,e.ymin,e.zmax)),t(xe(i,e.xmax,e.ymin,e.zmax)),t(xe(i,e.xmin,e.ymax,e.zmax)),t(xe(i,e.xmax,e.ymax,e.zmax))):(t(xe(i,e.xmin,e.ymin,i[2])),t(xe(i,e.xmax,e.ymin,i[2])),t(xe(i,e.xmin,e.ymax,i[2])),t(xe(i,e.xmax,e.ymax,i[2])))}};let Kk=class{constructor(e,t,i){this._target=e,this._options=t,this.view=i,this.state="pending",this._animationController=null,this.promise=new Promise((r,s)=>{this._resolveCallback=r,this._rejectCallback=s;const n=new AbortController;this._options.signal!=null&&Ao(this._options.signal,()=>this.abort()),this._abortController=n,this._waitForReady()})}_resolve(e){if(this.state!=="finished")return this.state="finished",this._resolveCallback(e)}_reject(e){if(this.state!=="finished")return this.state="finished",this._rejectCallback(e)}abort(e=!1){this._abortController.abort(),this.state==="wait-for-animation-finish"&&!e&&this._animationController!=null&&this.view.state.cameraController===this._animationController&&this._animationController.running&&this._animationController.stopController(),this._reject(Ui())}async _waitForReady(){if(this.state="wait-for-ready",!this.view.ready)try{await lp(()=>this.view.ready,this._abortController.signal)}catch(e){return this._reject(e)}this._createViewPoint()}async _createViewPoint(){if(this.state!=="finished"){this.state="wait-for-viewpoint",this._animationController=this._options.animate?this._getAnimationController():null;try{const e=await zk(this.view,this._target,this._abortController.signal);if(this.state==="finished")return;const t=e?this._getCameraFromViewpoint(e):null;if(t==null)return;if(this._options.animate){if(this._animationController==null)return;this._startAnimation(t,this._animationController)}else this.view.stateManager.setStateCamera(t.camera,{applyConstraints:!t.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this._resolve()}catch(e){this._reject(e)}}}_getCameraFromViewpoint(e){const t=!!(this._target instanceof jo&&this._target.camera||this._target instanceof Xr),i=e.camera;if(i==null)return null;if(!this.view.stateManager.isCompatible(i)){const s=i.position,n=s&&s.spatialReference,a=n?n.wkid:"none",o=this.view.spatialReference?.wkid;return this._reject(new fe("GotoAnimation:incompatible-spatialreference",`Resulting camera has an incompatible spatial reference (camera: ${a}, view: ${o})`,{camera:i})),null}const r=Qn(this.view,i);return r==null?(this._reject(new fe("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:e,camera:r,isFullySpecified:t}}_startAnimation(e,t){this.state="wait-for-animation-finish";const i=t.viewAnimation;if(i==null)return void this._reject(new fe("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));if(i.update(e.viewpoint,"running"),!t.running||t.viewAnimation==null||t.viewAnimation.target!==e.viewpoint||this.view.state.cameraController!==t)return this.abort();let r;e.isFullySpecified?(r=new Wd({view:this.view,desiredCamera:e.camera}),vu(this.view,e.camera,1)):kt(this.view,e.camera),t.begin(e.camera,this._options);const s=()=>{const a=this.view.state.cameraController;r&&(a&&a.running?AC(a)&&a.viewAnimation!=null&&a.viewAnimation.target===e.viewpoint&&(this.view.state.cameraController=r):t.viewAnimation!=null&&t.viewAnimation.target===e.viewpoint&&t.state===4&&(this.view.state.cameraController=r))},n=a=>{if(this.view.state!=null)switch(t.state){case 4:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this._resolve()}break;case 0:case 1:case 2:case 3:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this._reject(a)}}};i.when(s,a=>n(a)),t.asyncResult={resolve:()=>n(),reject:a=>n(a)}}_getAnimationController(){let e=null,t=null;const i=this.view.state.cameraController;return AC(i)&&(i.updateStateFromViewAnimation(),i.running&&(e=i,t=e.viewAnimation)),e==null&&(e=new Ul({view:this.view,mode:"animation"}),t=e.viewAnimation,this.view.state.switchCameraController(e),e.state===1)?(t?.stop(),this._reject(new fe("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null):e}},Wt=class extends ie{constructor(e){super(e),this.ready=!1,this._windowDevicePixelRatio=1,this._devicePixelRatioOverride=null,this._idleTimeout=WC,this.test={viewStateManager:this,contentCameraResetState:new Map,setDevicePixelRatio:t=>this._devicePixelRatioOverride=t,getDevicePixelRatioOverride:()=>this._devicePixelRatioOverride,renderState:null,get maximumPixelRatio(){return this.viewStateManager.view.qualitySettings.maximumPixelRatio},get updatingIgnoreRenderState(){return this.renderState!=null},get idleTimeoutEnabled(){return this.viewStateManager._idleTimeout>0},set idleTimeoutEnabled(t){this.viewStateManager._idleTimeout=t?WC:0}},this._propertiesPool=new Za({frustum:()=>new YA(null)},this),this._cameraSetByUser=!1,this._gotoOperation=null,this._cameraChangeTime=0,this._tmpCanvasSize=new Jk}initialize(){this._cameraChangeTime=performance.now(),this.addHandles([Ir(()=>this.view.state.events,"before-camera-change",({camera:e})=>e&&this._updateElevation(e)),M(()=>this.view.state?.camera,(e,t)=>this._cameraChangedHandler(e,t),Ie)]),Yr(()=>this.view.state?.camera,e=>this._updateElevation(e),{once:!0,sync:!0}),this.addHandles([tc({prepare:()=>this._prepareFrame()}),M(()=>this.view.state.cameraController,()=>{this._cameraSetByUser=!0,this.removeHandles(Vm)}),Ir(()=>this.view.state.events,"camera-projection-changed",()=>this.notifyChange("scale"))])}destroy(){this.exit(),this._propertiesPool=Z(this._propertiesPool)}get camera(){const e=this._get("camera");if(!this.ready)return e;const t=$h(this.view,this.view.state.camera,Xf);return t&&e&&t.equals(e)?e:t.clone()}set camera(e){if(this._updatePropertyBeforeReady("camera",e))return;this.view.elevationProvider.enableCache(!0);const t=Qn(this.view,e);t?this.setStateCamera(t,{applyConstraints:!1})||$.getLogger(this).warnOnce("#camera=","There is a currently active camera controller that has priority."):$.getLogger(this).error("#camera=","Invalid camera",e),this.view.elevationProvider.enableCache(!1)}get contentCamera(){const e=this._get("contentCamera");if(!this.ready)return e;const t=$h(this.view,this.view.state.contentCamera,Xf);return t&&e&&t.equals(e)?e:t.clone()}set contentCamera(e){if(this._updatePropertyBeforeReady("contentCamera",e))return;const t=Qn(this.view,e);this.view.state.contentCamera=t??null}installContentCameraReset(e){if(this.removeHandles(Yy),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;const t=this.zoom,i=this.view.state.camera.distance**2,r=g9(this.view.state.camera.center),s=e.sticky?this.contentCamera.clone():null;return this.addHandles([M(()=>this.contentCamera,()=>{e.sticky||(this.removeHandles(Yy),this.test.contentCameraResetState.clear())}),M(()=>this.zoom,n=>{n!==void 0&&t!==void 0&&(this.test.contentCameraResetState.set("view.zoom",Math.abs(n-t)/2),Math.abs(n-t)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=s))}),M(()=>this.view.state.camera,n=>{const a=Do(r,n.center);this.test.contentCameraResetState.set("camera.center",a/i),a>i?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=s)})],Yy),!0}get center(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")}set center(e){this._updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this._centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():$.getLogger(this).error("#center=","Invalid center",e):$.getLogger(this).error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e):$.getLogger(this).error("#center=","Center may not be null or undefined"))}get visibleArea(){if(!this.ready){const e=this._get("extent");return e?Z4.fromExtent(e):null}return R7(this.view,this.view.pointsOfInterest.focus.renderLocation)}get extent(){if(!this.ready)return this._get("extent");const e=this.view;return uR(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation)??this._get("extent")}set extent(e){this._updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this._extentToCamera(e),{applyConstraints:!0})||$.getLogger(this).error("#extent=","Invalid extent",e):$.getLogger(this).error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e):$.getLogger(this).error("#extent=","Extent may not be null or undefined"))}get frustum(){const e=this._propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}get constraintsManager(){return this._constraintsManager}get _initialViewpoint(){const e=this.view.map;return e&&"initialViewProperties"in e?e.initialViewProperties?.viewpoint:void 0}get hasInitialView(){return!!this._initialViewpoint}get scale(){if(!this.ready)return this._get("scale");const e=this.view.basemapTerrain.tilingScheme,t=this.view.pointsOfInterest.cameraOnSurface.scale;return e&&t?KM(this.view,t,this.view.state.contentCamera,e):this._get("scale")}set scale(e){this._updatePropertyBeforeReady("scale",e)||this.setStateCamera(this._scaleToCamera(e),{applyConstraints:!0})||$.getLogger(this).error("#scale=","Invalid scale",e)}get padding(){if(!this.ready)return this._get("padding");const e=this.view.state.camera,t=e.padding,i=e.pixelRatio,r=this._get("padding"),s=Math.round(t[0]/i),n=Math.round(t[1]/i),a=Math.round(t[2]/i),o=Math.round(t[3]/i);return r!=null&&r.top===s&&r.right===n&&r.bottom===a&&r.left===o?r:{top:s,right:n,bottom:a,left:o}}set padding(e){this._updatePropertyBeforeReady("padding",e)||(this._paddingToArray(e,this.view.state.camera.pixelRatio,Fm),this.view.state.updateCamera(t=>t.padding=Fm))}_paddingToArray(e,t,i){e?cr(i,e.top||0,e.right||0,e.bottom||0,e.left||0):cr(i,0,0,0,0);for(let r=0;r<4;r++)i[r]=Math.round(i[r]*t)}get screenCenter(){const e=this.padding;return ms((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}get viewpoint(){return this.ready?Vk(this.view,this.camera):this._get("viewpoint")}set viewpoint(e){if(!this._updatePropertyBeforeReady("viewpoint",e))if(e){if(!this.isCompatible(e)){const t=e.camera!=null?e.camera.position:e.targetGeometry,i=t!=null&&t.spatialReference;return void $.getLogger(this).error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(i?i.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e)}this.setStateCamera(this._viewpointToCamera(e),{applyConstraints:!e.camera})||$.getLogger(this).error("#viewpoint=","Invalid viewpoint",e)}else $.getLogger(this).error("#viewpoint=","Viewpoint may not be null or undefined")}get zoom(){return this.ready?I7(this.view,this.scale):this._get("zoom")}set zoom(e){this._updatePropertyBeforeReady("zoom",e)||e===void 0||this.setStateCamera(this._zoomToCamera(e),{applyConstraints:!0})||$.getLogger(this).error("#zoom=","Invalid zoom",e)}_computeCanvasSize(){if(this._devicePixelRatioOverride)return this.view.state.contentPixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*this._devicePixelRatioOverride),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*this._devicePixelRatioOverride),this._tmpCanvasSize.pixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize;const e=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio),t=(this._usePhysicalPixelRendering?this._windowDevicePixelRatio:e)*this.view.resolutionScale;this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*t),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*t);const i=this.view.stage.renderView.renderingContext?.parameters.maxTextureSize;return i&&Bl(this._tmpCanvasSize,i),this._tmpCanvasSize.pixelRatio=this._tmpCanvasSize.width>0?this._tmpCanvasSize.width/this.view.surface.clientWidth*.5+this._tmpCanvasSize.height/this.view.surface.clientHeight*.5:t,this.view.state&&(this.view.state.contentPixelRatio=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)),this._tmpCanvasSize}get _rasterPixelRatio(){return this._devicePixelRatioOverride!=null?this._devicePixelRatioOverride:this._usePhysicalPixelRenderingAny?this._windowDevicePixelRatio:Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)}get _usePhysicalPixelRendering(){return this.view?.stage?.renderer.isFeatureEnabled(8)??!1}get _usePhysicalPixelRenderingAny(){const e=this.view?.stage?.renderer;return e&&(e.isFeatureEnabled(8,2)||e.isFeatureEnabled(8,1)||e.isFeatureEnabled(8,0))}preinit(e){return!(this._isOverridden("center")&&!th(this.center.spatialReference,e))&&!(this._isOverridden("camera")&&!th(this.camera.position.spatialReference,e))&&!(this._isOverridden("extent")&&!th(this.extent.spatialReference,e))&&!!(!this._isOverridden("viewpoint")||th(this.viewpoint.targetGeometry?.spatialReference,e)&&th(this.viewpoint.camera?.position?.spatialReference,e))}init(){this._constraintsManager=new vd({view:this.view}),this._prepareFrame();const e=this._getInitialProperties();this._cameraSetByUser=!1,this._set("ready",!0);for(const t of e)this.set(t.name,t.value);if(!this._cameraSetByUser){const t=this._initialViewpoint||this.view.initialExtent;t&&this.isCompatible(t)?this._setInitialView(t):this.view.state.viewingMode===2&&this.addHandles(Yr(()=>this.view.basemapTerrain.ready,()=>{this.removeHandles(Vm),this._setInitialView(this.view.dataExtent)},{once:!0,initial:!0}),Vm)}}exit(){this._cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this._cameraSetByUser=!1,this.removeHandles(Vm),this._constraintsManager=Z(this._constraintsManager))}async goTo(e,t){return t={animate:!0,...t},this._gotoOperation!=null&&this._gotoOperation.abort(t.animate),this._gotoOperation=new Kk(e,t,this.view),this.view.resourceController.scheduler.stopFrame(),this._gotoOperation.promise}debugSetCameraOnContent(){this.setStateCamera(pu(this.view),{applyConstraints:!1})}step(e){const t=this.view.state?.cameraController;t?.stepController&&this.view.state.updateCamera(i=>t.stepController(e,i))}_cancelGoToOperation(){this._gotoOperation!=null&&(this._gotoOperation.abort(),this._gotoOperation=null)}_getInitialProperties(){const e=new Set,t=[];for(const{propertyName:i,overrides:r}of tB){const s=e.has(i),n=this._isOverridden(i);!s&&n&&t.push({name:i,value:this._get(i)}),this._clearOverride(i),(s||n)&&r.forEach(a=>e.add(a))}return t}_setInitialView(e){if(e==null||this._cameraSetByUser)return;if(e instanceof Xr)return void this.setStateCamera(Qn(this.view,e),{applyConstraints:!1});if(e instanceof jo){if(e.targetGeometry instanceof sr){const s=Ff(this.view,e.targetGeometry,0,.5,0);return void(s!=null&&this.setStateCamera(Qn(this.view,s),{applyConstraints:!0}))}const i={applyConstraints:!e.camera},r=this._viewpointToCamera(e);return void this.setStateCamera(r,i)}const t=Ff(this.view,e,0,.5,0);t!=null&&this.setStateCamera(Qn(this.view,t),{applyConstraints:!0})}_updatePropertyBeforeReady(e,t){return!this.ready&&(this._override(e,t),t&&eB.has(e)&&this._override("hasInitialView",!0),!0)}isCompatible(e){return e!=null&&(e instanceof jo?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof Xr?this.isCompatible(e.position):e.spatialReference&&!j9(e.spatialReference,this.view.spatialReference))}_getPreservingHeadingTilt(e=iB){return this._cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e}_centerPointAtDistanceToCamera(e,t,i=xa){const{heading:r,tilt:s}=this._getPreservingHeadingTilt(),n=wp(this.view,r,s,e,t,1);return n==null?null:(i.copyFrom(this.view.state.camera),i.eye=n.eye,i.center=n.center,i.up=n.up,i)}_centerToCamera(e){let t;if(e.hasZ)t=this.view.state.camera.distance;else{const{centerOnContent:i}=this.view.pointsOfInterest;i.runTask(),t=i.distance}return this._centerPointAtDistanceToCamera(e,t)}_extentToCamera(e){const{heading:t,tilt:i}=this._getPreservingHeadingTilt(),r=Ff(this.view,e,t,i,1,Xf);return r?Qn(this.view,r):null}_scaleToCamera(e){if(e==null)return null;const t=this.view,i=t.pointsOfInterest.centerOnContent;i.runTask();const r=i.renderLocation,s=t.pointsOfInterest.cameraOnSurface.renderLocation,n=x7(t,e,r,s);return this._centerPointAtDistanceToCamera(r,n)}_zoomToCamera(e){return this._scaleToCamera(mR(this.view,e))}_viewpointToCamera(e){return Qn(this.view,Ok(this.view,e))}setStateCamera(e,t){return!(e==null||!this.view.state.stopActiveCameraController())&&(this._cameraSetByUser=!0,t.doNotCancelGoToOperation||this._cancelGoToOperation(),this.view.state.updateCamera(i=>{t.positionAndOrientationOnly?(i.eye=e.eye,i.center=e.center,i.up=e.up,i.fov=e.fov):i.copyFrom(e),t.applyConstraints&&kt(this.view,i)}),t.applyConstraints||(this.view.state.cameraController=new Wd({view:this.view,desiredCamera:e})),!0)}_prepareFrame(){const{surface:e,canvas:t,stage:i}=this.view;if(!e||!t||!i||i.destroyed||i.destroying)return;this._windowDevicePixelRatio=window.devicePixelRatio;const r=this._computeCanvasSize();if(r.width!==0&&r.height!==0&&(t.width===r.width&&t.height===r.height||(t.width=r.width,t.height=r.height),this.view.state)){const s=this.view.state.camera;s.fullWidth===r.width&&s.fullHeight===r.height&&s.pixelRatio===r.pixelRatio||(xa.copyFrom(s),xa.pixelRatio!==r.pixelRatio&&(this._paddingToArray(this.padding,r.pixelRatio,Fm),xa.padding=Fm),xa.fullWidth=r.width,xa.fullHeight=r.height,xa.pixelRatio=r.pixelRatio,this.view.state.camera=xa),this._updateState()}}_updateElevation(e){const t=this.view.renderCoordsHelper?.getAltitude(e.eye)??0,i=this.view.basemapTerrain?.spatialReference,r=i?C2(this.view,e.eye):0;e.relativeElevation=t-r}_updateState(){this.test.renderState!=null?this.view.state.mode=this.test.renderState:this.view.animation?this.view.state.mode=0:this.view.interacting?this.view.state.mode=1:(this.view.state.mode===0&&(this._cameraChangeTime=0),performance.now()-this._cameraChangeTime<this._idleTimeout?this.view.state.mode=1:this.view.state.mode=2),this.view.state.rasterPixelRatio=this._rasterPixelRatio}_cameraChangedHandler(e,t){e&&t&&e.almostEquals(t)||(this._cameraChangeTime=performance.now(),this._updateState())}};h([d({type:Xr,dependsOn:["view.state.camera","ready"]})],Wt.prototype,"camera",null),h([d({type:Xr,dependsOn:["view.state.contentCamera","ready"]})],Wt.prototype,"contentCamera",null),h([d({type:wt})],Wt.prototype,"center",null),h([d()],Wt.prototype,"visibleArea",null),h([d({type:sr})],Wt.prototype,"extent",null),h([d({readOnly:!0})],Wt.prototype,"frustum",null),h([d()],Wt.prototype,"_constraintsManager",void 0),h([d({readOnly:!0})],Wt.prototype,"constraintsManager",null),h([d()],Wt.prototype,"_initialViewpoint",null),h([d({readOnly:!0})],Wt.prototype,"hasInitialView",null),h([d({readOnly:!0,type:Boolean})],Wt.prototype,"ready",void 0),h([d({type:Number})],Wt.prototype,"scale",null),h([d()],Wt.prototype,"padding",null),h([d({readOnly:!0})],Wt.prototype,"screenCenter",null),h([d({constructOnly:!0})],Wt.prototype,"view",void 0),h([d({type:jo})],Wt.prototype,"viewpoint",null),h([d({type:Number})],Wt.prototype,"zoom",null),h([d({readOnly:!0})],Wt.prototype,"_rasterPixelRatio",null),h([d({readOnly:!0})],Wt.prototype,"_usePhysicalPixelRendering",null),h([d({readOnly:!0})],Wt.prototype,"_usePhysicalPixelRenderingAny",null),h([d()],Wt.prototype,"_windowDevicePixelRatio",void 0),h([d()],Wt.prototype,"_devicePixelRatioOverride",void 0),Wt=h([D("esri.views.3d.state.ViewStateManager")],Wt);let Jk=class{constructor(){this.width=0,this.height=0,this.pixelRatio=1}};const eB=new Set(["camera","viewpoint","extent","scale","center","zoom"]),tB=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],iB={heading:0,tilt:0};let Xf=new Xr,xa=new vt;const Fm=Vt(),Vm="pending-initial-view",Yy="content-camera-reset",WC=300,rB=100;function sB(){Xf=new Xr,xa=new vt}let wn=class extends La{constructor(){super(...arguments),this.startCamera=new vt,this.currentCamera=new vt,this._isInteractive=!1,this._interactingTimeoutHandle=void 0}get isInteractive(){return this._isInteractive}stepController(e,t){t.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(t)}onControllerStart(e){this.state=2,this.startCamera.copyFrom(e),this.currentCamera.copyFrom(e)}onControllerEnd(e){e.copyViewFrom(this.currentCamera)}commitCamera(){this._isInteractive=!0,this._interactingTimeoutHandle?.remove(),this._interactingTimeoutHandle=Vp.setTimeout(()=>{this._isInteractive=!1,this._interactingTimeoutHandle=void 0},rB),this.view.state.updateCamera(e=>this.stepController(Yi(0),e))}};h([d({readOnly:!0})],wn.prototype,"isInteractive",null),h([d()],wn.prototype,"_isInteractive",void 0),wn=h([D("esri.views.3d.state.controllers.InteractiveController")],wn);let Zd=class extends wn{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.pivot=0,this._rotScale=0,this._lastPoint=ze(),this._tmpWorldUp=w(),this._tmpViewDir=w(),this._tmpRotCurPoint=ze(),this._tmpTransf=Le(),this._tmpAxis=w(),this._tmpPivotPoint=w(),this._pivotPos=w(),this._constraintOptions=new ys(15,2,0,this.startCamera)}initialize(){this._rotScale=this.pivot===0?3:1.5}begin(e){if(this.running){switch(this.pivot){case 1:q(this._pivotPos,this.startCamera.eye),this._constraintOptions.interactionType=3,this._constraintOptions.tiltMode=1,this._constraintOptions.selection=0;break;case 0:{const t=this._intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this._pivotPos,this.view.basemapTerrain.invisible?gc:{});t||q(this._pivotPos,this.startCamera.center),this._constrainPivotPoint(e,t),this.startCamera.center=this._pivotPos,this._constraintOptions.interactionType=2,this._constraintOptions.tiltMode=0,this._constraintOptions.selection=11;break}}Yl(this.startCamera,e,this._lastPoint)}}_constrainPivotPoint(e,t){const i=this.startCamera,r=w();de(r,this._pivotPos,i.eye);const s=ge(r),n=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(i.eye,ZC);let a=Math.max(wu(ZC,i.viewForward,dk)*n,pk);t&&(a=Math.min(s,a));const o=si(i.width/i.pixelRatio*.5,i.height/i.pixelRatio*.5),l=Xp(this.startCamera,o,this.view.renderCoordsHelper,this.view.viewingMode);let c=this.view.stage.renderView.getMinimalDepthForArea(Dp(this.view),i.fullWidth/i.pixelRatio*.5,i.fullHeight/i.pixelRatio*.5,i,2.5*Hy,Hy),u=this.view.stage.renderView.getMinimalDepthForArea(Dp(this.view),e[0],e[1],i,Hy);c==null&&u==null||(c=c??u??0,u=u==null||l===1?c:u,a=c>u?u:c,a=t?Math.min(a,s):a),me(r,r),q(this._pivotPos,ce(this._tmpPivotPoint,i.eye,te(this._tmpPivotPoint,r,a)))}update(e){if(this.running){switch(this.pivot){case 1:this.currentCamera.center=this._applyRotation(this.currentCamera,e,this.currentCamera.center,this._pivotPos);break;case 0:this.currentCamera.center=this._pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,e,this.currentCamera.eye,this._pivotPos)}kt(this.view,this.currentCamera,this._constraintOptions),this.commitCamera()}}end(){this.running&&this.finishController()}_applyRotation(e,t,i,r){this.view.renderCoordsHelper.worldUpAtPosition(r,this._tmpWorldUp),Yl(e,t,this._tmpRotCurPoint);let s=(this._lastPoint[1]-this._tmpRotCurPoint[1])*this._rotScale,n=(this._tmpRotCurPoint[0]-this._lastPoint[0])*this._rotScale;de(this._tmpViewDir,i,r);const a=ge(this._tmpViewDir),o=qa($e(this._tmpViewDir,this._tmpWorldUp)/a);if(this.pivot===1){s*=-.5;const l=.5*Math.PI-o,c=.5*Math.PI*.99;s=l-Math.max(-c,Math.min(c,l+s))}return s=j(s+o,Ni.min,Ni.max)-o,ri(this._tmpAxis,e.up,this._tmpViewDir),this.pivot===0&&(n=-n),ko(this._tmpTransf,n,this._tmpWorldUp),yn(this._tmpTransf,this._tmpTransf,s,this._tmpAxis),lt(this._tmpViewDir,this._tmpViewDir,this._tmpTransf),e.up=lt(Ky,e.up,this._tmpTransf),ce(Ky,r,this._tmpViewDir),fs(this._lastPoint,this._tmpRotCurPoint),Ky}};h([d()],Zd.prototype,"pivot",void 0),Zd=h([D("esri.views.3d.state.controllers.RotateController")],Zd);const Ky=w(),ZC=w();let Jy=class extends Wi{constructor(e,t,i,r){super(!0),this._view=e,this.pointerActions=t,this._pivot=i,this.registerIncoming("drag",r,s=>this._handleDrag(s))}_handleDrag(e){const t=e.data;if(t.pointers.size>1||!Mb(e.data,this.pointerActions))return;const i=si(t.center.x,t.center.y);switch(t.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._cameraController=new Zd({view:this._view,pivot:this._pivot}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break;case"update":this._cameraController&&this._cameraController.update(i);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}};function nB(e){return e&&"nodeType"in e}function aB(e){return e&&typeof e.render=="function"}const QC={component:"esri-component"};let wl=class extends ie{constructor(){super(...arguments),this.widget=null}destroy(){this.node=null,this.widget?.destroy()}get id(){return this._get("id")??this.widget?.id??this.node?.id}set id(e){this._set("id",e)}set node(e){const t=this._get("node");e!==t&&(e&&e.classList.add(QC.component),t&&t.classList.remove(QC.component),this._set("node",e))}castNode(e){return this.widget?.destroy(),e?typeof e=="string"||nB(e)?(this._set("widget",null),L2(e)):(aB(e)&&!e.domNode&&(e.domNode=document.createElement("div")),this._set("widget",e),e.domNode):(this._set("widget",null),null)}};h([d()],wl.prototype,"id",null),h([d()],wl.prototype,"node",null),h([Ua("node")],wl.prototype,"castNode",null),h([d({readOnly:!0})],wl.prototype,"widget",void 0),wl=h([D("esri.views.ui.Component")],wl);const Qd=wl;function oB(e,t){return{type:Bp(t),value:e,unit:t}}function Mre(e){return{value:e}}function lB(e,t){return{type:Bp(t),value:e,unit:t}}function cB(e,t){return{type:Bp(t),value:e,unit:t}}function Rre(e,t){return{type:Bp(t),value:e,unit:t}}function G_(e,t,i="arithmetic"){return{type:Bp(t),value:e,unit:t,rotationType:i}}function Dre(e,t){const i=hB(e,t);return e.type==="angle"?G_(i,t,e.rotationType):oB(i,t)}function hB(e,t){return _s(e.value,e.unit,t)}function Ore(e,t){return e==null?t:t==null||e.value>_s(t.value,t.unit,e.unit)?e:t}function Ere(e,t){return e==null?null:{...e,value:e.value*t}}function uB(e,t,i){if(t===i)return e;switch(i){case"arithmetic":case"geographic":return 90-e}}const Are=lB(0,"meters"),Ire=cB(0,"square-meters");G_(0,"radians");const Lre=G_(0,"degrees"),Fre=G_(0,"degrees","geographic");function mD(e,t,i){return e.units[t][i]}function _c(e,t,i,r=2,s="abbr"){return`${z_(t,{minimumFractionDigits:r,maximumFractionDigits:r,signDisplay:t>0?"never":"exceptZero"})} ${mD(e,i,s)}`}function $_(e,t,i,r=2,s="abbr"){return`${z_(t,{minimumFractionDigits:r,maximumFractionDigits:r,signDisplay:"exceptZero"})} ${mD(e,i,s)}`}function Vre(e,t,i,r=2,s="abbr"){const n=v4(t,i);return _c(e,_s(t,i,n),n,r,s)}function zre(e,t,i,r=2,s="abbr"){const n=v4(t,i);return $_(e,_s(t,i,n),n,r,s)}function kre(e,t,i,r=2,s="abbr"){const n=S4(t,i);return _c(e,_s(t,i,n),n,r,s)}function Bre(e,t,i,r=2,s="abbr"){const n=S4(t,i);return $_(e,_s(t,i,n),n,r,s)}function Nre(e,t,i,r=2,s="abbr"){const n=b4(t,i);return _c(e,_s(t,i,n),n,r,s)}function jre(e,t,i,r=2,s="abbr"){const n=b4(t,i);return $_(e,_s(t,i,n),n,r,s)}function Ure(e,t,i,r=2,s="abbr"){const n=y4(t,i);return _c(e,_s(t,i,n),n,r,s)}function Hre(e,t,i,r=2,s="abbr"){const n=y4(t,i);return $_(e,_s(t,i,n),n,r,s)}function qre(e,t,i,r=2,s="abbr"){const n=r9(t,i);return _c(e,_s(t,i,n),n,r,s)}function Gre(e,t,i,r=2,s="abbr"){const n=s9(t,i);return _c(e,_s(t,i,n),n,r,s)}const dB=(e,t)=>({style:"unit",unitDisplay:"narrow",unit:"degree",maximumFractionDigits:t,minimumFractionDigits:t,signDisplay:e>0?"never":"exceptZero"});function pB(e,t,i,r,s,n=Q2,a=!0){let o=n.normalize(uB(_s(e,t,"degrees"),i,r),0,a);const l=dB(o,s??2);return o=mB(o,l),z_(o,l)}const XC=new Map;function mB(e,t){const i=JSON.stringify(t);let r=XC.get(i);return r||(r=new Intl.NumberFormat("en-US",t),XC.set(i,r)),/^[-+]?360\.?0*?$/.test(r.format(e))?0:e}const YC=["B","kB","MB","GB","TB"];function $re(e,t){let i=(t=Math.round(t))===0?0:Math.floor(Math.log(t)/Math.log(1024));i=j(i,0,YC.length-1);const r=z_(t/1024**i,{maximumFractionDigits:2});return nA(e.units.bytes[YC[i]],{fileSize:r})}const zm="esri-fov-overlay",km={base:zm,outer:`${zm}-outer`,reset:`${zm}-reset`,text:`${zm}-text`};let Ca=class extends Np{constructor(e){super(e),this.onReset=()=>{},this._messagesCommon=null,this._messagesUnits=null,this.fov=null}render(){return Hi("div",{class:km.outer},Hi("div",{class:km.base},Hi("p",{class:km.text},this._overlay),Hi("p",{class:km.reset,onclick:this.onReset,title:this._messagesCommon.reset},this._reset)))}get _overlay(){const{fov:e,_messagesUnits:t}=this;if(!t||e==null)return"";const i=pB(sc(e),"degrees","arithmetic","arithmetic",0),r=fB/(2*Math.tan(e/2));return`${i} | ${_c(t,r,"millimeters",0,"abbr")} |`}get _reset(){return this._messagesUnits&&this.fov!=null?"":""}};h([d()],Ca.prototype,"onReset",void 0),h([d(),Qh("esri/t9n/common")],Ca.prototype,"_messagesCommon",void 0),h([d(),Qh("esri/core/t9n/Units")],Ca.prototype,"_messagesUnits",void 0),h([d()],Ca.prototype,"fov",void 0),h([d()],Ca.prototype,"_overlay",null),h([d()],Ca.prototype,"_reset",null),Ca=h([D("esri.widgets.FovOverlay")],Ca);const fB=Math.sqrt(1872);let qh=class extends wn{constructor(e){super(e),this.onStop=null,this._timeOutId=void 0,this._onReset=()=>{this._startSize=this._lastDrag=null,this._setFov(gB),this.updateTimeout()},this._center=w(),this._viewForward=w(),this._constraints=new ys(15,1)}begin(e){vB(e)?this._showOverlay().fov=e.fov:(this._lastDrag=e[1],this._startSize=null,this._ensureStartSize(this.view.state.camera))}updateTimeout(){clearTimeout(this._timeOutId),this._timeOutId=setTimeout(this.onStop,1500)}update(e){if(this._lastDrag==null)return this._lastDrag=e[1],this._startSize=null,void this._ensureStartSize(this.view.state.camera);const t=-(this._lastDrag-e[1])/2;this._lastDrag=e[1],this.step(t)}step(e){if(!this.running)return void(this._startSize=this._lastDrag=null);const t=this.view.state,i=this.currentCamera.copyFrom(t.camera),r=sc(i.fov)+e,s=rt(j(r,_B,yB));s!==i.fov?this._setFov(s):this._showOverlay().fov=i.fov}finish(){this.running&&(this._startSize=this._lastDrag=null,this.finishController())}destroy(){this.hideOverlay()}onControllerEnd(e){super.onControllerEnd(e),this._startSize=this._lastDrag=null,this.hideOverlay()}_showOverlay(){return this._overlay||(this._overlay=new Qd({id:"esri.FovOverlay",node:new Ca({onReset:this._onReset})}),this.view.ui.add(this._overlay)),this._overlay.widget}hideOverlay(){this._overlay&&(this.view.ui.remove(this._overlay),this._overlay=Z(this._overlay))}_setFov(e){const t=this.view.state,i=this.currentCamera.copyFrom(t.camera),r=this._ensureStartSize(i)/Math.tan(e/2),s=ce(e0,this._center,te(e0,this._viewForward,-r));i.eye=s,i.fov=e,this._constraints.interactionStartCamera=t.camera,this._constraints.interactionFactor=Ls(this.currentCamera.height-t.camera.height),kt(this.view,this.currentCamera,this._constraints),this.begin(i),this.commitCamera()}_ensureStartSize(e){if(this._startSize==null){q(this._viewForward,e.viewForward);const t=this.view.stage.renderView.getMinimalDepthForArea(null,e.fullWidth/e.pixelRatio*.5,e.fullHeight/e.pixelRatio*.5,e,Qp),i=Gt(e.eye,this.view.pointsOfInterest.centerOnContent.renderLocation),r=t??i;ce(this._center,e.eye,te(e0,this._viewForward,r)),this._startSize=r*Math.tan(e.fov/2)}return this._startSize}};h([d()],qh.prototype,"onStop",void 0),qh=h([D("esri.views.3d.state.controllers.FovController")],qh);const gB=rt(new Xr().fov),_B=10,yB=150,e0=w();function vB(e){return!Array.isArray(e)}const KC=12;let S1=class extends wn{constructor(){super(...arguments),this._pickPoint=w(),this._tmpP0=ze(),this._panAxisAngle=U_(),this._tmpRayDir=w(),this._tmpRayDirPick=w(),this._targetOnSphere=w(),this._navigationMode=1,this._tmpRay={origin:w(),direction:w()},this.dragBeginPoint=si(),this._normalizedAnchorPoint=ze(),this._constraintOptions=new ys(7,1,0,this.startCamera),this._sphere=Kr(),this._hasPickPoint=!1}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.running)return;fs(this.dragBeginPoint,e),Yl(this.startCamera,e,this._normalizedAnchorPoint);const t=Yt(this.view.spatialReference),i=iD(this._intersectionHelper,this.startCamera,e,t.radius,0,this.view.basemapTerrain.invisible?gc:{});if(this._navigationMode=Xp(this.startCamera,e,this.view.renderCoordsHelper,this.view.viewingMode),this._navigationMode===1)this._hasPickPoint=!!i.scenePickPoint,this._pickPoint=i.scenePickPoint??this._pickPoint,this._sphere=i.sphere;else{let r;bu(this.startCamera,e,this._tmpRay),me(this._tmpRay.direction,this._tmpRay.direction),i.scenePickPoint!=null&&(de(this._tmpRayDirPick,this.startCamera.eye,i.scenePickPoint),r=ge(this._tmpRayDirPick));const s=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(this.startCamera.eye,JC);const n=j(wu(JC,this._tmpRay.direction,XR)*s,e_[0],e_[1]);let o=this.view.stage.renderView.getMinimalDepthForArea(null,e[0],e[1],this.view.state.camera,Qp)??n;r!=null&&(o=Math.min(o,r)),this._hasPickPoint=!0,te(this._tmpRay.direction,this._tmpRay.direction,o),ce(this._pickPoint,this._tmpRay.origin,this._tmpRay.direction)}}update(e){if(this.running){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,this._navigationMode===1){de(this._tmpRayDir,this.currentCamera.center,this.currentCamera.eye);const t=ge(this._tmpRayDir);Yl(this.currentCamera,e,this._tmpP0);const i=(this._normalizedAnchorPoint[1]-this._tmpP0[1])*KC;let r=t*2**i;const s=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<s&&(r=s),Math.abs(t-r)<Uo)return;if(this._hasPickPoint&&r<t){const n=1-(1-r/t)*(1-this._sphere[3]/ge(this.currentCamera.center));this.currentCamera.center=te(Bm,this.currentCamera.center,n)}te(this._tmpRayDir,this._tmpRayDir,-r/t),this.currentCamera.eye=ce(Bm,this.currentCamera.center,this._tmpRayDir),this._constraintOptions.interactionFactor=Ls(dp(this.dragBeginPoint,e)),kt(this.view,this.currentCamera,this._constraintOptions),this._hasPickPoint&&(Rp(this._sphere,this.currentCamera,this.dragBeginPoint,this._targetOnSphere),bb(this._pickPoint,this._targetOnSphere,this._panAxisAngle),Ho(this.currentCamera,Gi(this._sphere),this._panAxisAngle))}else{const t=ge(this._tmpRay.direction);Yl(this.currentCamera,e,this._tmpP0);const i=(this._normalizedAnchorPoint[1]-this._tmpP0[1])*KC;let r=t*2**i;const s=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<s&&(r=s),Math.abs(t-r)<Uo)return;te(this._tmpRayDir,this._tmpRay.direction,1-r/t),this.currentCamera.eye=ce(Bm,this.currentCamera.eye,this._tmpRayDir),this.currentCamera.center=ce(Bm,this.currentCamera.center,this._tmpRayDir),me(this._tmpRayDir,this._tmpRayDir),this._constraintOptions.interactionDirection=this._tmpRayDir,kt(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}vu(this.view,this.currentCamera),this.commitCamera()}}finish(){this.running&&this.finishController()}};S1=h([D("esri.views.3d.state.controllers.ZoomControllerGlobal")],S1);const Bm=w(),JC=w();let T1=class extends wn{constructor(){super(...arguments),this._tmpP=w(),this._tmpDir=w(),this._tmpN=w(),this._tmpP0=ze(),this._tmpPoi=w(),this._tmpRayDir=w(),this.dragBeginPoint=si(),this._normalizedAnchorPoint=ze(),this._constraintOptions=new ys(15,1,0,this.startCamera,w()),this._plane=Ga()}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.running)return;fs(this.dragBeginPoint,e),Yl(this.startCamera,e,this._normalizedAnchorPoint);const t=this._intersectionHelper.intersectScreenFreePointFallback(e,this._tmpP,this.view.basemapTerrain.invisible?gc:{});de(this._tmpDir,this._tmpP,this.startCamera.eye);const i=ge(this._tmpDir);me(this._tmpDir,this._tmpDir);const r=Math.abs(this.view.camera.position.z),s=j(wu(bB,this._tmpDir,XR)*r,e_[0],e_[1]);let a=this.view.stage.renderView.getMinimalDepthForArea(Dp(this.view),e[0],e[1],this.view.state.camera,Qp)??s;t&&(a=Math.min(a,i)),te(this._tmpDir,this._tmpDir,a),ce(this._tmpP,this.startCamera.eye,this._tmpDir),de(this._tmpN,this.startCamera.eye,this.startCamera.center),me(this._tmpN,this._tmpN),this._tmpN[1]<0&&za(this._tmpN,this._tmpN),$4(this._tmpP,this._tmpN,this._plane)}update(e){if(!this.running)return;mk(this._plane,this.currentCamera,this.dragBeginPoint,this._tmpPoi)||q(this._tmpPoi,this.currentCamera.center),Yl(this.currentCamera,e,this._tmpP0);let t=4*(this._tmpP0[1]-this._normalizedAnchorPoint[1]);fs(this._normalizedAnchorPoint,this._tmpP0),de(this._tmpRayDir,this._tmpPoi,this.currentCamera.eye);const i=ge(this._tmpRayDir);let r=i*(1-t);this._constraintOptions.interactionDirection&&(q(this._constraintOptions.interactionDirection,this._tmpRayDir),te(this._constraintOptions.interactionDirection,this._constraintOptions.interactionDirection,Math.sign(t)/i));const s=this.view.state.constraints.minimumPoiDistance;t>=0&&r<s&&(r=s,t=-(r-i)/i),Math.abs(i-r)<Uo||(te(this._tmpRayDir,this._tmpRayDir,t),this.currentCamera.eye=ce(il,this.currentCamera.eye,this._tmpRayDir),Nt(il,this.currentCamera.center,this._tmpPoi,t),this._tmpPoi[2]>this.startCamera.center[2]?il[2]=Math.max(this.startCamera.center[2],il[2]):il[2]=Math.min(this.startCamera.center[2],il[2]),this.currentCamera.center=il,this._constraintOptions.interactionFactor=Ls(dp(this.dragBeginPoint,e)),kt(this.view,this.currentCamera,this._constraintOptions),this.commitCamera())}finish(){this.running&&this.finishController()}};T1=h([D("esri.views.3d.state.controllers.ZoomControllerLocal")],T1);const il=w(),bB=We(0,0,1);let wB=class extends Wi{constructor(e,t,i){super(!0),this._view=e,this.pointerActions=t,this._fovModifier=i,this.registerIncoming("drag",[i],r=>this._handleZoom(r)),this.registerIncoming("drag",r=>this._handleZoom(r))}_handleZoom(e){const t=e.data;if(t.pointers.size>1||!Mb(e.data,this.pointerActions))return;const i=si(t.center.x,t.center.y);switch(t.action){case"start":{this._cameraController?.finish();const r=this._view,s=e.modifiers.has(this._fovModifier);this._cameraController=s?new qh({view:r,onStop:()=>this._stopController()}):r.state.isGlobal?new S1({view:r}):new T1({view:r}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break}case"update":this._cameraController?.update(i);break;case"end":this._cameraController instanceof qh?this._cameraController.updateTimeout():this._stopController()}e.stopPropagation()}_stopController(){this._cameraController?.finish(),this._cameraController=null}};function Ys(e){let t=e*e;return e<0&&(t*=-1),t}function e3(e,t,i){const r=i,s=e.state,n=e.device,a=t.tiltDirection==="forward-down"?1:-1,o=1;return n.deviceType==="standard"?(r.translation[0]=Ys(s.axes[0]),r.translation[1]=Ys(s.axes[1]),r.translation[2]=Ys(s.buttons[7])-Ys(s.buttons[6]),r.heading=Ys(s.axes[2]),r.tilt=Ys(s.axes[3])):n.deviceType==="spacemouse"&&(r.translation[0]=1.2*Ys(s.axes[0]),r.translation[1]=1.2*Ys(s.axes[1]),r.translation[2]=2*-Ys(s.axes[2]),r.heading=1.2*Ys(s.axes[5]),r.tilt=1.2*Ys(s.axes[3])),r.tilt*=a,te(r.translation,r.translation,o),r}function t3(e,t){const i=t;return i.translation[0]=e[1]-e[0],i.translation[1]=e[3]-e[2],i.translation[2]=e[4]-e[5],i.heading=e[7]-e[6],i.tilt=e[8]-e[9],i.zoom=e[10]-e[11],i}function t0(e){return e.translation[0]===0&&e.translation[1]===0&&e.translation[2]===0&&e.heading===0&&e.tilt===0&&e.zoom===0}let Hl=class extends wn{constructor(e){super(e),this._filteredSurfaceElevation=0,this._transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this._keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],this._tmpCamera=new vt,this._headingStart=0,this._constraintOptions=new ys(15,0,0,new vt,null,1)}handleEventGamepad(e){const t=e3(e,this.view.navigation.gamepad,this._transformation);(e.action==="end"||t0(t))&&this.finishController()}activateDirection(e){this._keysButtonState[e]=1,t3(this._keysButtonState,this._transformation)}directionActive(e){return this._keysButtonState[e]===1}countActiveDirections(){return this._keysButtonState.reduce((e,t)=>t>0?e+1:e,0)}deactivateDirection(e){this._keysButtonState[e]=0;const t=t3(this._keysButtonState,this._transformation);t0(t)&&this.finishController()}onControllerStart(e){this._filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this._headingStart=this.view.camera.heading,super.onControllerStart(e)}_updateFilteredSurfaceElevation(e){const t=this.view.pointsOfInterest.cameraOnSurface.location.z,i=1;this._filteredSurfaceElevation+=i*(t-this._filteredSurfaceElevation)*e}stepController(e,t){this._updateStartHeading(),this._updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(t),this._updateCameraCenter(),this._constraintOptions.interactionStartCamera?.copyFrom(this.currentCamera),this._calculateControlTransformation(e,this.currentCamera,rl),this._applyDisabledMovementTypes(rl),this._applyPan(rl.pan),this._applyRotate(rl.rotate),this._applyZoom(rl.zoom),this._applyAscend(rl.ascend),this._constraintOptions.interactionType=0,this._constraintOptions.selection=8,kt(this.view,this.currentCamera,this._constraintOptions),super.stepController(e,t)}_updateStartHeading(){this._transformation.heading!==0&&(this._headingStart=this.view.camera.heading)}_applyRotate(e){if(!e.enabled)return;const t=this.currentCamera;de(pr,t.center,t.eye),lt(pr,pr,e.matrix),t.center=ce(pr,pr,t.eye),t.up=lt(pr,t.up,e.matrix),this._constraintOptions.interactionType=3,this._constraintOptions.selection=7,kt(this.view,t,this._constraintOptions)}_applyPan(e,t=this.currentCamera){e.enabled&&(t.eye=lt(pr,t.eye,e.matrix),t.center=lt(pr,t.center,e.matrix),this.view.state.isGlobal&&(t.up=lt(pr,t.up,e.matrix)),this._constraintOptions.interactionType=4,this._constraintOptions.selection=15,kt(this.view,t,this._constraintOptions))}_applyZoom(e){if(!e)return;const t=this.currentCamera.viewForward;this.currentCamera.eye=ce(pr,this.currentCamera.eye,te(yt.get(),t,e)),q(Vu,t),za(Vu,Vu),this._constraintOptions.interactionDirection=Vu,this._constraintOptions.interactionType=1,this._constraintOptions.selection=7,kt(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_applyAscend(e){if(!e)return;const t=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,yt.get());if(this._constraintOptions.interactionDirection=q(Vu,t),this.view.state.isGlobal){const i=ge(this.currentCamera.eye),r=(i+e)/i;this.currentCamera.eye=te(pr,this.currentCamera.eye,r),this.currentCamera.center=te(pr,this.currentCamera.center,r)}else{const i=te(yt.get(),t,e);this.currentCamera.eye=ce(pr,this.currentCamera.eye,i),this.currentCamera.center=ce(pr,this.currentCamera.center,i)}this._updateCameraCenter(),this._constraintOptions.interactionType=5,this._constraintOptions.selection=8,kt(this.view,this.currentCamera,this._constraintOptions)&&this._updateCameraCenter(),this._constraintOptions.selection=7,kt(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_calculateControlTransformation(e,t,i){RB(i);const r=this._computeVelocities(e);this.view.state.isLocal?this._calculateControlTransformationLocal(r,t,i):this._calculateControlTransformationGlobal(r,t,i)}_updateCameraCenter(){const e=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,t=this.view.renderCoordsHelper,i=this.currentCamera.ray;this.currentCamera.center=t.intersectManifoldClosestSilhouette(i,e,pr)}_calculateControlTransformationLocal(e,t,i){const{viewRight:r,viewForward:s}=t,n=this._transformation,a=this.view.navigation.gamepad,o=xe(yt.get(),s[0],s[1],0);me(o,o);const l=n.translation[0]*e.pan;if(l!==0){const g=te(yt.get(),r,l);ac(i.pan.matrix,i.pan.matrix,g),i.pan.enabled=!0}switch(a.mode){case"pan":{const g=-n.translation[1]*e.pan;if(g!==0){const y=te(yt.get(),o,g);ac(i.pan.matrix,i.pan.matrix,y),i.pan.enabled=!0}i.zoom=n.zoom*e.zoom;break}case"zoom":i.zoom=(-n.translation[1]+n.zoom)*e.zoom;break;default:na(a.mode)}const c=n.translation[2]*e.ascend;i.ascend=c;const u=-n.heading*e.rotate;u!==0&&(yn(i.rotate.matrix,i.rotate.matrix,u,this.view.renderCoordsHelper.worldUpAtPosition(t.eye,yt.get())),i.rotate.enabled=!0);const p=n.tilt*e.rotate,m=Fo(this.view.renderCoordsHelper,t.center,t.eye),f=j(m+p,Ni.min,Ni.max)-m;f&&(yn(i.rotate.matrix,i.rotate.matrix,f,r),i.rotate.enabled=!0)}_calculateControlTransformationGlobal(e,t,i){const{eye:r,viewRight:s}=t,n=this._transformation,a=this.view.navigation.gamepad,o=ri(yt.get(),s,r);me(o,o),za(o,o),bk(this.startCamera,t,n,e,this.view.camera.heading,this._headingStart,this.view.camera.tilt,i,a),this._tmpCamera.copyFrom(this.currentCamera),this._applyPan(rl.pan,this._tmpCamera);const l=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,c=n.translation[2]*e.ascend;i.ascend=c;const u=-n.heading*e.rotate;u!==0&&(yn(i.rotate.matrix,i.rotate.matrix,u,this._tmpCamera.eye),i.rotate.enabled=!0);const p=n.tilt*e.rotate,m=this._clampTiltDeltaGlobalToValidRange(p,t.ray,l);m!==0&&(yn(i.rotate.matrix,i.rotate.matrix,m,this._tmpCamera.viewRight),i.rotate.enabled=!0),i.zoom+=n.zoom*e.zoom}_clampTiltDeltaGlobalToValidRange(e,t,i){const r=Yt(this.view.spatialReference),s=$f(Ni.min,t.origin,i,r);let n=0,a=0;const o=yt.get();if(this.view.renderCoordsHelper.intersectManifold(t,i,o)){const l=Fo(this.view.renderCoordsHelper,o,t.origin);n=$f(l,t.origin,i,r),a=$f(Ni.max,t.origin,i,r)}else{L_(I_(Z2,i+r.radius),t,o);const l=Math.PI+lM(t.direction,o);n=LC(l,t.origin,i,r),a=LC(Ni.max,t.origin,i,r)}return j(n+e,s,a)-n}_getPointAbsoluteSurfaceElevation(e,t,i){const{renderCoordsHelper:r}=this.view,s=r.getAltitude(e),n=t+Math.abs(s-t);return r.setAltitude(i,n,e),n}_clampedDistanceToSurface(e,t){const{renderCoordsHelper:i}=this.view,{camera:r}=this.view.state,{direction:s}=_7(this.view,t,0,fD,MB),n=i.intersectManifoldClosestSilhouette(ru(t,s),e,yt.get()),a=Gt(t,n),o=i.intersectManifoldClosestSilhouette(ru(t,N2(yt.get(),t,r.center)),e,yt.get()),l=Gt(t,o);return Math.min(a,l)}_computeHeadingRotateRadius(e){const{renderCoordsHelper:t,state:i}=this.view,{camera:r,isGlobal:s}=i,n=t.intersectManifoldClosestSilhouette(r.ray,this._filteredSurfaceElevation,yt.get());if(s){const a=de(yt.get(),e,n),o=ge(a);te(a,a,1/o);const l=me(yt.get(),e),c=qa($e(l,a));return o*Math.sin(Math.min(CB,c))}{const a=q(yt.get(),e);return t.setAltitude(a,this._filteredSurfaceElevation),Gt(n,a)}}_minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:SB}_computeVelocities(e){const t=this._filteredSurfaceElevation,i=t+Yt(this.view.spatialReference).radius,{camera:r,isGlobal:s}=this.view.state,n=yt.get(),a=this._getPointAbsoluteSurfaceElevation(r.eye,t,n),o=this._clampedDistanceToSurface(t,n),l=r.width/2,c=i3*r.width,u=i3*r.width,p=o*Math.tan(.5*r.fovX)/l,m=p/i,f=p/this._computeHeadingRotateRadius(n),g=a-t;return{pan:(s?m:p)*c*e,ascend:Math.max(this._minimumAscendVelocity()*e,2**(c*e/l)*g-g),zoom:2**(c*e/l)*o-o,rotate:j(f*u,TB,PB)*e}}_applyDisabledMovementTypes(e){this.disableMovements==null||this.disableMovements.mode!==void 0&&this.view.state.viewingMode!==this.disableMovements.mode||(e.zoom=this.disableMovements.zoom?0:e.zoom,e.ascend=this.disableMovements.ascend?0:e.ascend,e.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&pp(e.pan.matrix),e.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&pp(e.rotate.matrix))}static activatesFor(e,t){const i=e3(t,e.navigation.gamepad,xB);return!(t.action==="end"||t0(i))}};h([d({constructOnly:!0})],Hl.prototype,"gamepadDevice",void 0),h([d({constructOnly:!0})],Hl.prototype,"disableMovements",void 0),Hl=h([D("esri.views.3d.state.controllers.GamepadKeyboardController")],Hl);const xB={translation:[0,0,0],heading:0,tilt:0,zoom:0},fD=80,CB=rt(fD),i3=.75,SB=5,TB=rt(30),PB=rt(80),rl={zoom:0,ascend:0,pan:{enabled:!1,matrix:Le()},rotate:{enabled:!1,matrix:Le()}},pr=w(),Vu=w(),MB=h8();function RB(e){e.zoom=0,e.ascend=0,e.pan.enabled=!1,pp(e.pan.matrix),e.rotate.enabled=!1,pp(e.rotate.matrix)}let DB=class extends Wi{constructor(e){super(!0),this._view=e,this._watchHandles=new C_,this._handle=this.registerIncoming("gamepad",t=>this._handleEventGamepad(t)),this._handle.pause()}onInstall(e){super.onInstall(e),this._watchHandles.add([M(()=>this._view.navigation.gamepad.enabled,t=>{t?this._handle.resume():(this._handle.pause(),this._cameraControllerGamepad&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null))},Ee),M(()=>this._view.navigation.gamepad.device,t=>{this._cameraControllerGamepad&&t&&this._cameraControllerGamepad.gamepadDevice!==t&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null)})])}onUninstall(){this._watchHandles.removeAll(),super.onUninstall()}_handleEventGamepad(e){const t=this._view.navigation.gamepad.device;if(t&&e.data.device!==t)return;const i=this._cameraControllerGamepad?.running;if(i||Hl.activatesFor(this._view,e.data)){if(!i){const r=new Hl({view:this._view,gamepadDevice:e.data.device});this._view.state.switchCameraController(r),r.state!==1&&(this._cameraControllerGamepad=r)}this._cameraControllerGamepad&&this._cameraControllerGamepad.running&&this._cameraControllerGamepad.gamepadDevice===e.data.device&&this._cameraControllerGamepad.handleEventGamepad(e.data)}}};function OB(e){const t=()=>e(document.visibilityState==="visible");return document.addEventListener("visibilitychange",t),Sn(()=>document.removeEventListener("visibilitychange",t))}let EB=class extends Wi{constructor(e,t){super(!0),this._view=e,this._keyToDirection=new Map,this._keyToAction=new Map,this._disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:2},this._stickyKeyTimeoutHandle=void 0,this._stickyKeyDuration=200,this._addKeysMapping(t),this.registerIncoming("key-down",null,i=>this._handleKeyDown(i)),this.registerIncoming("key-up",null,i=>this._handleKeyUp(i)),this.registerIncoming("blur",null,()=>this._handleStop()),this._visibilityHandle=OB(i=>i?null:this._handleStop())}onUninstall(){this._visibilityHandle?.remove(),this._handleStop()}setStickyKeyDuration(e){this._stickyKeyDuration=e}_addKeysMapping(e){this._addKeyMapping(e.pan.left,0),this._addKeyMapping(e.pan.right,1),this._addKeyMapping(e.pan.forward,2),this._addKeyMapping(e.pan.backward,3),this._addKeyMapping(e.pan.up,4),this._addKeyMapping(e.pan.down,5),this._addKeyMapping(e.lookAround.headingLeft,6),this._addKeyMapping(e.lookAround.headingRight,7),this._addKeyMapping(e.lookAround.tiltUp,8),this._addKeyMapping(e.lookAround.tiltDown,9),this._addKeyMapping(e.zoom.zoomIn,10),this._addKeyMapping(e.zoom.zoomOut,11),this._addKeyAction(e.reset.heading,()=>this._resetHeading()),this._addKeyAction(e.reset.tilt,()=>this._resetTilt())}_addKeyMapping(e,t){for(const i of this._eachKey(e))this._keyToDirection.set(i,t)}*_eachKey(e){typeof e=="string"?yield e:yield*e}_addKeyAction(e,t){for(const i of this._eachKey(e))this._keyToAction.set(i,t)}_handleKeyDown(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this._keyToAction.get(e.data.key);if(t!=null)return e.stopPropagation(),void t();const i=this._keyToDirection.get(e.data.key);if(i!=null&&(this._cameraControllerKeyboard&&this._cameraControllerKeyboard.running||(this._cameraControllerKeyboard=new Hl({view:this._view,disableMovements:this._disableMovements}),this._view.state.switchCameraController(this._cameraControllerKeyboard)),this._cameraControllerKeyboard.running)){if(e.stopPropagation(),this._cameraControllerKeyboard.directionActive(i)||(this._cameraControllerKeyboard.activateDirection(i),this._cameraControllerKeyboard.countActiveDirections()>1||!this._isPanning(i)))return;this._stickyKeyDuration>0&&(this._stickyKeyTimeoutHandle=setTimeout(()=>{this._stickyKeyTimeoutHandle=void 0,this._stickyDirection!=null&&this._stickyDirection!==void 0&&(this._cameraControllerKeyboard?.deactivateDirection(this._stickyDirection),this._stickyDirection=void 0)},this._stickyKeyDuration))}}_handleStop(){this._cameraControllerKeyboard?.running&&(this._cameraControllerKeyboard.finishController(),this._cameraControllerKeyboard=null)}_handleKeyUp(e){if(e.data.native.ctrlKey||e.data.native.metaKey||!this._cameraControllerKeyboard?.running)return;const t=this._keyToDirection.get(e.data.key);if(t==null)return;e.stopPropagation();const i=this._stickyKeyTimeoutHandle===void 0;this._stickyKeyTimeoutHandle===void 0||this._cameraControllerKeyboard?.countActiveDirections()!==1?(this._cameraControllerKeyboard?.deactivateDirection(t),i&&(this._stickyDirection=void 0)):this._stickyDirection=t}_isPanning(e){return e<=3}_resetHeading(){this._view.goTo({heading:0}).catch(()=>{})}_resetTilt(){this._view.goTo({tilt:0}).catch(()=>{})}},AB=class extends Wi{constructor(e,t){super(!0),this._view=e,this.registerIncoming("mouse-wheel",[t],i=>this._handleFov(i)),this.registerIncoming("mouse-wheel",i=>this._handleZoom(i))}_handleZoom(e){if(!this._mouseWheelZoomEnabled)return;const t=e.data;this._zoomController?.running||(this._stopFovController(),this._zoomController=this._view.state.isGlobal?new n_({view:this._view,mode:"interaction"}):new a_({view:this._view,mode:"interaction"}),this._view.state.switchCameraController(this._zoomController)),this._zoomController.step(-t.deltaY/60,si(t.x,t.y)),e.preventDefault(),e.stopPropagation()}_handleFov(e){this._mouseWheelZoomEnabled&&(this._fovController?.running||(this._zoomController?.finish(),this._fovController?.hideOverlay(),this._fovController=new qh({view:this._view,onStop:()=>this._stopFovController()}),this._view.state.switchCameraController(this._fovController),this._fovController.state!==1)?(this._fovController.updateTimeout(),this._fovController.step(e.data.deltaY/20),e.preventDefault(),e.stopPropagation()):this._stopFovController())}get _mouseWheelZoomEnabled(){return this._view.navigation.actionMap.mouseWheel==="zoom"}_stopFovController(){this._fovController?.finish(),this._fovController=null}},c_=class{constructor(e){this._gain=e}reset(e){this._value=e}set gain(e){this._gain=e}get value(){return this._value===void 0?0:this._value}update(e){this._value===void 0?this._value=e:this._value=this._gain*e+(1-this._gain)*this._value}},lc=class extends Pp{constructor(){super(...arguments),this._beginCamera=new vt,this._elapsedTime=Yi(0),this.constraintOptions=new ys(15,4,0,this._beginCamera)}initialize(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new nu}onControllerStart(e){this._beginCamera.copyFrom(e),super.onControllerStart(e)}stepController(e,t){t.copyViewFrom(this._beginCamera),this._elapsedTime=Yi(this._elapsedTime+e),this.momentumStep(this._elapsedTime,t),kt(this.view,t,this.constraintOptions),this.momentum.isFinished(this._elapsedTime)&&this.finishController()}};lc=h([D("esri.views.3d.state.controllers.momentum.MomentumController")],lc);let Xd=class extends lc{constructor(e){super(e),this.interactionType=4,this._tmpPan=w()}momentumStep(e,t){const i=this.momentum.value(e);te(this._tmpPan,this.momentum.direction,i),t.eye=de(r3,t.eye,this._tmpPan),t.center=de(r3,t.center,this._tmpPan),this.constraintOptions.interactionDirection=this._tmpPan}};h([d({constructOnly:!0})],Xd.prototype,"momentum",void 0),Xd=h([D("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],Xd);const r3=w(),IB=w(),Nm=w();let Yf=class extends lc{constructor(e){super(e),this.interactionType=4}momentumStep(e,t){const i=this.momentum.value1(e),r=this.momentum.value2(e);q(Nm,t.eye),me(Nm,Nm),ri(this.momentum.axis2,Nm,this.momentum.axis1),aD(t,IB,this.momentum.axis1,i,this.momentum.axis2,r)}};h([d({constructOnly:!0})],Yf.prototype,"momentum",void 0),Yf=h([D("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],Yf);let Ll=class extends lc{constructor(e){super(e),this.interactionType=2}momentumStep(e,t){const i=this.momentum.value(e);Ho(t,this.center,Mp(this.axis,i))}set center(e){this._set("center",Mn(e))}set axis(e){this._set("axis",Mn(e))}};h([d({constructOnly:!0})],Ll.prototype,"center",null),h([d({constructOnly:!0})],Ll.prototype,"axis",null),h([d({constructOnly:!0})],Ll.prototype,"momentum",void 0),Ll=h([D("esri.views.3d.state.controllers.momentum.RotationMomentumController")],Ll);let Dh=class extends lc{constructor(e){super(e),this.interactionType=1,this.constraintOptions.interactionDirection=w()}momentumStep(e,t){const{interactionDirection:i}=this.constraintOptions;if(!i)return;q(i,t.eye);const r=this.momentum.valueDelta(0,e);Sb(t,this.zoomCenter,r,this.view.state.constraints.minimumPoiDistance),N2(i,t.eye,i)}set zoomCenter(e){this._set("zoomCenter",Mn(e))}};h([d({constructOnly:!0})],Dh.prototype,"momentum",void 0),h([d({constructOnly:!0})],Dh.prototype,"zoomCenter",null),Dh=h([D("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],Dh);let xl=class extends lc{constructor(e){super(e),this.radius=0,this.interactionType=1,this._tmpSceneCenter=w(),this._tmpZoomAxisAngle=U_(),this._sphere=Kr()}initialize(){this._sphere[3]=this.radius}momentumStep(e,t){const i=this.momentum.valueDelta(0,e);eD(this._sphere,t,i),this.constraintOptions.interactionType=1,kt(this.view,t,this.constraintOptions),Rp(this._sphere,t,this.screenCenter,this._tmpSceneCenter),bb(this.sceneCenter,this._tmpSceneCenter,this._tmpZoomAxisAngle),Ho(t,Gi(this._sphere),this._tmpZoomAxisAngle),this.constraintOptions.interactionType=4}set screenCenter(e){this._set("screenCenter",si(e[0],e[1]))}set sceneCenter(e){this._set("sceneCenter",Mn(e))}};h([d({constructOnly:!0})],xl.prototype,"momentum",void 0),h([d({constructOnly:!0})],xl.prototype,"radius",void 0),h([d({constructOnly:!0})],xl.prototype,"screenCenter",null),h([d({constructOnly:!0})],xl.prototype,"sceneCenter",null),xl=h([D("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],xl);let mn=class{constructor(e){this._gain=e,this.lastValue=void 0,this.filteredDelta=void 0}update(e){if(this.hasLastValue()){const t=this.computeDelta(e);this._updateDelta(t)}this.lastValue=e}reset(){this.lastValue=void 0,this.filteredDelta=void 0}hasLastValue(){return this.lastValue!==void 0}hasFilteredDelta(){return this.filteredDelta!==void 0}computeDelta(e){return this.lastValue===void 0?NaN:e-this.lastValue}_updateDelta(e){this.filteredDelta!==void 0?this.filteredDelta=(1-this._gain)*this.filteredDelta+this._gain*e:this.filteredDelta=e}},W_=class{constructor(e,t,i){this._initialVelocity=e,this._stopVelocity=t,this._friction=i,this._duration=Yi(Math.abs(Math.log(Math.abs(this._initialVelocity)/this._stopVelocity)/Math.log(1-this._friction)))}get duration(){return this._duration}isFinished(e){return e>this.duration}get friction(){return this._friction}value(e){return this.valueFromInitialVelocity(this._initialVelocity,e)}valueDelta(e,t){const i=this.value(e);return this.value(e+t)-i}valueFromInitialVelocity(e,t){t=Math.min(t,this.duration);const i=1-this.friction;return e*(i**t-1)/Math.log(i)}},LB=class extends W_{constructor(e,t,i,r,s){super(e,t,i),this._sceneVelocity=r,this.direction=s}value(e){return super.valueFromInitialVelocity(this._sceneVelocity,e)}},gD=class{constructor(e=300,t=12,i=.84){this._minimumInitialVelocity=e,this._stopVelocity=t,this._friction=i,this.enabled=!0,this._time=new mn(.6),this._screen=[new mn(.4),new mn(.4)],this._scene=[new mn(.6),new mn(.6),new mn(.6)],this._tmpDirection=w()}add(e,t,i){if(this.enabled){if(this._time.hasLastValue()&&this._time.computeDelta(i)<.015)return;this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._scene[0].update(t[0]),this._scene[1].update(t[1]),this._scene[2].update(t[2]),this._time.update(i)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._scene[0].reset(),this._scene[1].reset(),this._scene[2].reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta()||!this._time.hasFilteredDelta())return null;const e=this._screen[0].filteredDelta,t=this._screen[1].filteredDelta,i=e==null||t==null?0:Math.sqrt(e*e+t*t),r=this._time.filteredDelta,s=r==null||i==null?0:i/r;return Math.abs(s)<this._minimumInitialVelocity?null:this.createMomentum(s,this._stopVelocity,this._friction)}createMomentum(e,t,i){xe(this._tmpDirection,this._scene[0].filteredDelta??0,this._scene[1].filteredDelta??0,this._scene[2].filteredDelta??0);const r=ge(this._tmpDirection);r>0&&te(this._tmpDirection,this._tmpDirection,1/r);const s=this._time.filteredDelta;return new LB(e,t,i,s==null?0:r/s,this._tmpDirection)}},s3=class{constructor(e){this._gain=e}update(e){this.filteredValue!==void 0?this.filteredValue=(1-this._gain)*this.filteredValue+this._gain*e:this.filteredValue=e}reset(){this.filteredValue=void 0}get hasFilteredValue(){return this.filteredValue!==void 0}};const n3=1e-5;let FB=class extends W_{constructor(e,t,i,r,s,n=0,a){super(e,t,i),this._angularVelocity1=r,this.axis1=s,this.angularVelocity2=n,this.axis2=a}value1(e){return super.valueFromInitialVelocity(this._angularVelocity1,e)}value2(e){return super.valueFromInitialVelocity(this.angularVelocity2,e)}},VB=class{constructor(e=300,t=12,i=.84){this._minimumInitialVelocity=e,this._stopVelocity=t,this._friction=i,this.enabled=!0,this._tmpAxis1=w(),this._tmpAxis2=w(),this._tmpAngles=ze(),this._time=new mn(.3),this._screen=[new mn(.4),new mn(.4)],this._angle1=new s3(.6),this._angle2=new s3(.6),this._axis1=w(),this._axis2=w(),this._lastScene=w()}addMomentumDirectRotation(e,t,i,r,s,n){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(i)<.01)return;let a=sD(this._lastScene,t,this._tmpAxis2,r,s,n);this._angle2.update(0),Wr(this._tmpAxis2)<n3?a=0:me(this._axis1,this._tmpAxis2),this._angle1.update(a),q(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(i)}}addMomentumPreserveHeading(e,t,i,r,s,n,a){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(i)<.01)return;nD(this._lastScene,t,this._tmpAxis2,this._tmpAxis1,this._tmpAngles,r,s,n,a,!1),Wr(this._tmpAxis2)<n3?(this._angle1.update(0),this._angle2.update(0)):(this._angle1.update(this._tmpAngles[1]),this._angle2.update(this._tmpAngles[0]),me(this._axis1,this._tmpAxis1),me(this._axis2,this._tmpAxis2)),q(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(i)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._angle1.reset(),this._angle2.reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta())return null;const e=this._screen[0].filteredDelta,t=this._screen[1].filteredDelta,i=e==null||t==null?null:Math.sqrt(e*e+t*t),r=this._time.filteredDelta,s=i==null||r==null?0:i/r;return Math.abs(s)<this._minimumInitialVelocity?null:this.createMomentum(s,this._stopVelocity,this._friction)}createMomentum(e,t,i){const r=this._time.filteredDelta,s=this._angle1.filteredValue,n=this._angle2.filteredValue,a=r==null||n==null?0:n/r;return new FB(e,t,i,r==null||s==null?0:s/r,this._axis1,a,this._axis2)}},_D=class{constructor(e=2.5,t=.01,i=.95,r=12){this._minimumInitialVelocity=e,this._stopVelocity=t,this._friction=i,this._maxVelocity=r,this.enabled=!0,this.value=new mn(.8),this.time=new mn(.3)}add(e,t){if(this.enabled&&t!=null){if(this.time.hasLastValue()){if(this.time.computeDelta(t)<.01)return;if(this.value.hasFilteredDelta()){const i=this.value.computeDelta(e);this.value.filteredDelta*i<0&&this.value.reset()}}this.time.update(t),this.value.update(e)}}reset(){this.value.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.value.hasFilteredDelta()||!this.time.hasFilteredDelta())return null;let e=this.value.filteredDelta/this.time.filteredDelta;return e=j(e,-this._maxVelocity,this._maxVelocity),Math.abs(e)<this._minimumInitialVelocity?null:this.createMomentum(e,this._stopVelocity,this._friction)}createMomentum(e,t,i){return new W_(e,t,i)}},yD=class extends _D{constructor(e=3,t=.01,i=.95,r=12){super(e,t,i,r)}add(e,t){const i=this.value.lastValue;if(i!=null){let r=e-i;for(;r>Math.PI;)r-=2*Math.PI;for(;r<-Math.PI;)r+=2*Math.PI;e=i+r}super.add(e,t)}},zB=class extends W_{constructor(e,t,i){super(e,t,i)}value(e){const t=super.value(e);return Math.exp(t)}valueDelta(e,t){const i=super.value(e),r=super.value(e+t)-i;return Math.exp(r)}},vD=class extends _D{constructor(e=2.5,t=.01,i=.95,r=12){super(e,t,i,r)}add(e,t){super.add(Math.log(e),t)}createMomentum(e,t,i){return new zB(e,t,i)}},P1=class extends wn{constructor(){super(...arguments),this._smoothRotation=new c_(.05),this._rotationAxis=w(),this._beginAngle=0,this._beginHeading=0,this._panningPlane=Ga(),this._beginRadius=0,this._smoothScaling=new c_(.05),this._zoomCenterScreen=si(),this._zoomMomentumEstimator=new vD,this._rotationMomentumEstimator=new yD,this._panSphericalMomentumEstimator=new VB,this._panPlanarMomentumEstimator=new gD,this._adjustedSphere=Kr(),this._tmp3d=w(),this._tmpScreenPointArray=si(),this._beginScreenPoint=si(),this._beginScenePoint=w(),this._screenPickPoint=si(),this._scenePickPoint=w(),this._navigationMode=1,this._sphere=Kr(),this._pointerCount=0,this._tmpInteractionDirection=w(),this._beginCamera=new vt,this._constraintOptions=new ys(15,0,0,this._beginCamera)}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.running)return;this._zoomMomentumEstimator.enabled=this._rotationMomentumEstimator.enabled=this._panPlanarMomentumEstimator.enabled=this._panSphericalMomentumEstimator.enabled=this.view.navigation.momentumEnabled,this._beginHeading=-Bo.normalize(rt(this.view.camera.heading)),this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._smoothRotation.reset(),gn(e.center,this._screenPickPoint),fs(this._beginScreenPoint,this._screenPickPoint);const t=iD(this._intersectionHelper,this.startCamera,this._screenPickPoint,Yt(this.view.spatialReference).radius,1,this.view.basemapTerrain.invisible?gc:{});t.scenePickPoint!=null&&(this._scenePickPoint=t.scenePickPoint,this._sphere=t.sphere,q(this._beginScenePoint,this._scenePickPoint),this._navigationMode=Xp(this.startCamera,this._screenPickPoint,this.view.renderCoordsHelper,this.view.viewingMode),this._navigationMode===0&&this._preparePlanarPanMode(e,t.hasGeometryIntersection),this._beginCamera.copyFrom(this.startCamera))}update(e){if(!this.running)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1;this._navigationMode===1?(t&&this._zoomSpherical(e),this._panningSpherical(e),t&&this._rotateSpherical(e)):(t&&this._zoomPlanar(e),this._panningPlanar(e),t&&this._rotatePlanar(e)),this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return this._navigationMode===1?new xl({view:this.view,momentum:t,screenCenter:this._zoomCenterScreen,sceneCenter:this._beginScenePoint,radius:this._sphere[3]}):new Dh({view:this.view,momentum:t,zoomCenter:this._beginScenePoint});const i=this._rotationMomentumEstimator.evaluateMomentum();if(i)return new Ll({view:this.view,momentum:i,center:_p(this._sphere,w()),axis:this._rotationAxis});if(this._navigationMode===1){const r=this._panSphericalMomentumEstimator.evaluateMomentum();if(r)return new Yf({view:this.view,momentum:r})}else{const r=this._panPlanarMomentumEstimator.evaluateMomentum();if(r)return new Xd({view:this.view,momentum:r})}return null}_preparePlanarPanMode(e,t){const i=za(this._tmp3d,this.startCamera.viewForward);$4(this._scenePickPoint,i,this._panningPlane);const r=si(this._screenPickPoint[0],0),s=w(),n=ge(this.startCamera.eye);this._adjustedSphere[3]=n<this._sphere[3]?n-100:this._sphere[3],Rp(this._adjustedSphere,this.startCamera,r,s);const a=w(),o=w(),l=w();de(a,this._scenePickPoint,this.currentCamera.eye);const c=ge(a);me(a,a);const u=KR*Math.max(Math.abs(this.view.camera.position.z),JR);let m=this.view.stage.renderView.getMinimalDepthForArea(null,this._screenPickPoint[0],this._screenPickPoint[1],this.view.state.camera,Qp)??u;t&&(m=Math.min(m,c)),q(l,ce(o,this.currentCamera.eye,te(o,a,m))),this._panningPlane[3]=-$e(un(this._panningPlane),l),this.startCamera.center=ce(o,this.startCamera.eye,te(o,this.startCamera.viewForward,m));const f=gn(e.center,this._tmpScreenPointArray);x1(this._panningPlane,this.startCamera,f,this._beginScenePoint)}_zoomSpherical(e){const t=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=i,this._smoothScaling.update(t),eD(this._sphere,this.currentCamera,this._smoothScaling.value),gn(e.center,this._zoomCenterScreen),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),this._constraintOptions.interactionType=1,this._constraintOptions.interactionFactor=Ls(e.radius-this._beginRadius),kt(this.view,this.currentCamera,this._constraintOptions)}_panningSpherical(e){const t=gn(e.center,this._tmpScreenPointArray);Rp(this._sphere,this.currentCamera,t,this._tmp3d),Tb(this._beginScenePoint,$e(this.currentCamera.up,this._beginScenePoint),this._sphere[3],this._beginHeading,this.view.camera.tilt,this.startCamera.aboveGround)?(lD(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this._beginHeading,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumPreserveHeading(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere,this._beginHeading,this.view.camera.tilt)):(oD(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumDirectRotation(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere[3],this.view.camera.tilt)),this._constraintOptions.interactionType=4,this._constraintOptions.interactionFactor=Ls(dp(this._screenPickPoint,t)),kt(this.view,this.currentCamera,this._constraintOptions)}_rotateSpherical(e){me(this._rotationAxis,this._scenePickPoint),this.currentCamera.aboveGround||za(this._rotationAxis,this._rotationAxis);const t=this._smoothRotation.value,i=t+w1(e.angle-t),r=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=r,this._smoothRotation.update(i);const s=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(s,.001*e.timestamp),Ho(this.currentCamera,Gi(this._sphere),Mp(this._rotationAxis,s)),this._constraintOptions.interactionType=2,this._constraintOptions.interactionFactor=Ls(e.radius*i),kt(this.view,this.currentCamera,this._constraintOptions)}_panningPlanar(e){const t=gn(e.center,this._tmpScreenPointArray);x1(this._panningPlane,this.currentCamera,t,this._tmp3d)&&(rD(this.currentCamera,this._beginScenePoint,this._tmp3d),this._panPlanarMomentumEstimator.add(t,this._tmp3d,.001*e.timestamp),this._constraintOptions.interactionType=4,this._constraintOptions.interactionFactor=Ls(dp(this._beginScreenPoint,t)),this._constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this._tmpInteractionDirection),kt(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null)}_zoomPlanar(e){const t=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=i,this._smoothScaling.update(t),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),Sb(this.currentCamera,this._beginScenePoint,this._smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this._constraintOptions.interactionType=1,this._constraintOptions.interactionFactor=Ls(e.radius-this._beginRadius),kt(this.view,this.currentCamera,this._constraintOptions)}_rotatePlanar(e){q(this._rotationAxis,this._beginScenePoint),this.currentCamera.aboveGround||za(this._rotationAxis,this._rotationAxis);const t=this._smoothRotation.value;let i=e.angle-t;i=w1(i);const r=t+i,s=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=s,this._smoothRotation.update(r);const n=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(n,.001*e.timestamp),Ho(this.currentCamera,Gi(this._sphere),Mp(this._rotationAxis,n)),this._constraintOptions.interactionType=2,this._constraintOptions.interactionFactor=Ls(e.radius*n),kt(this.view,this.currentCamera,this._constraintOptions)}};P1=h([D("esri.views.3d.state.controllers.PinchAndPanControllerGlobal")],P1);const a3=We(0,0,1);let M1=class extends wn{constructor(){super(...arguments),this._rotationValueSmooth=new c_(.05),this._scalingValueSmooth=new c_(.05),this._planeHorizontal=Ga(),this._planeVertical=Ga(),this._rotationMomentumEstimator=new yD,this._panMomentumEstimator=new gD(300,12,.9),this._zoomMomentumEstimator=new vD,this._beginRadius=0,this._beginCenter=w(),this._beginAngle=0,this._tmpPoints=[],this._navigationMode=1,this._beginCenterScreen=si(),this._tmpCentroid3d=w(),this._tmpCentroid2d=si(),this._tmp2d=si(),this._pointerCount=0,this._beginCamera=new vt,this._constraintOptions=new ys(15,0,0,this._beginCamera)}begin(e){if(!this.running)return;const t=this.view.navigation.momentumEnabled;this._zoomMomentumEstimator.enabled=t,this._rotationMomentumEstimator.enabled=t,this._panMomentumEstimator.enabled=t,this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._rotationValueSmooth.reset(),this._scalingValueSmooth.reset(),gn(e.center,this._beginCenterScreen),W4(a3,0,this._planeHorizontal);const i=w(),r=this._intersectionHelper.intersectScreenFreePointFallback(this._beginCenterScreen,i,this.view.basemapTerrain.invisible?gc:{}),s=w();za(s,this.startCamera.viewForward);const n=w();q(n,a3);const a=$e(s,n);this._navigationMode=Xp(this.startCamera,this._beginCenterScreen,this.view.renderCoordsHelper,this.view.viewingMode);const o=wu(n,this.startCamera.viewForward,KR)*Math.max(Math.abs(this.view.camera.position.z),JR);cx(this._planeHorizontal,this._planeHorizontal,i),this.startCamera.aboveGround||HI(this._planeHorizontal,this._planeHorizontal);const l=w(),c=w(),u=w();de(l,i,this.currentCamera.eye);const p=ge(l);if(me(l,l),this._navigationMode===0){te(n,n,a),de(un(this._planeVertical),s,n),me(un(this._planeVertical),un(this._planeVertical)),cx(this._planeVertical,this._planeVertical,i);let f=this.view.stage.renderView.getMinimalDepthForArea(Dp(this.view),this._beginCenterScreen[0],this._beginCenterScreen[1],this.view.state.camera,Qp)??o;r&&(f=Math.min(f,p)),q(u,ce(c,this.currentCamera.eye,te(c,l,f))),this._planeVertical[3]=-$e(un(this._planeVertical),u),this._computePlanePoints(e.pointers,this._planeVertical,this.startCamera,this._tmpPoints),qy(this._tmpPoints,this._beginCenter)}else{const m=r?p:o;q(u,ce(c,this.currentCamera.eye,te(c,l,m))),this._planeHorizontal[3]=-$e(un(this._planeHorizontal),u),this._computePlanePoints(e.pointers,this._planeHorizontal,this.startCamera,this._tmpPoints),qy(this._tmpPoints,this._beginCenter)}this._beginCamera.copyFrom(this.startCamera)}update(e){if(!this.running)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1,i=this._navigationMode===1?this._planeHorizontal:this._planeVertical,r=this._beginCenter;if(t){const s=this._beginRadius/e.radius,n=.001875*Math.min(Math.max(e.radius,40),120);this._scalingValueSmooth.gain=n,this._scalingValueSmooth.update(s),Sb(this.currentCamera,r,this._scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this._zoomMomentumEstimator.add(this._scalingValueSmooth.value,.001*e.timestamp),this._constraintOptions.interactionType=1,this._constraintOptions.interactionFactor=Ls(Math.abs(e.radius-this._beginRadius)),kt(this.view,this.currentCamera,this._constraintOptions)}if(this._computePlanePoints(e.pointers,i,this.currentCamera,this._tmpPoints),qy(this._tmpPoints,this._tmpCentroid3d),gn(e.center,this._tmpCentroid2d),rD(this.currentCamera,r,this._tmpCentroid3d),this._panMomentumEstimator.add(this._tmpCentroid2d,this._tmpCentroid3d,.001*e.timestamp),this._constraintOptions.interactionType=4,this._constraintOptions.interactionFactor=Ls(dp(this._beginCenterScreen,this._tmpCentroid2d)),kt(this.view,this.currentCamera,this._constraintOptions),t){const s=r,n=this._rotationValueSmooth.value,a=n+w1(e.angle-n),o=.00125*Math.min(Math.max(e.radius,40),120);this._rotationValueSmooth.gain=o,this._rotationValueSmooth.update(a);const l=this._rotationValueSmooth.value-this._beginAngle;this._rotationMomentumEstimator.add(l,.001*e.timestamp);const c=un(this._planeHorizontal);Ho(this.currentCamera,s,Mp(c,l)),this._constraintOptions.interactionType=2,this._constraintOptions.interactionFactor=Ls(Math.abs(e.radius*l)),kt(this.view,this.currentCamera,this._constraintOptions)}this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return new Dh({view:this.view,momentum:t,zoomCenter:this._beginCenter});const i=this._rotationMomentumEstimator.evaluateMomentum();if(i)return new Ll({view:this.view,momentum:i,center:this._beginCenter,axis:un(this._planeHorizontal)});const r=this._panMomentumEstimator.evaluateMomentum();return r?new Xd({view:this.view,momentum:r}):null}_computePlanePoints(e,t,i,r){r.length=e.size;const s=this._tmp2d;let n=0;return e.forEach(a=>{s[0]=a.x,s[1]=a.y,r[n]===void 0&&(r[n]=w()),x1(t,i,s,r[n]),n+=1}),r}get _intersectionHelper(){return this.view.sceneIntersectionHelper}};M1=h([D("esri.views.3d.state.controllers.PinchAndPanControllerLocal")],M1);let o3=class extends Wi{constructor(e,t,i){super(!0),this._view=e,this.pointerActions=t,this._lastEndTimestamp=0,this._lastTimestamp=0,this.registerIncoming("drag",i,r=>this._handleDrag(r))}_handleDrag(e){if(e.data.pointerType==="mouse"&&!Mb(e.data,this.pointerActions))return;const t=e.timestamp-this._lastEndTimestamp,i=40,r=this._momentum&&this._momentum.running&&t<i;switch(e.data.action){case"start":case"update":if(r)break;this._controller&&this._controller.running?e.data.timestamp-this._lastTimestamp>2&&(this._controller.update(e.data),this._lastTimestamp=e.timestamp):this._startController(e);break;case"end":case"removed":this._endController(e,!0);break;case"added":this._endController(e,!1),this._startController(e)}e.stopPropagation()}_endController(e,t){if(this._controller?.running){this._lastEndTimestamp=e.timestamp;const i=this._controller.end(e.data);t&&i&&(this._momentum=i,this._view.state.switchCameraController(this._momentum))}this._controller=null}_startController(e){this._controller=this._createController(),this._view.state.switchCameraController(this._controller),this._controller.begin(e.data),this._lastTimestamp=e.timestamp}_createController(){return this._view.state.isGlobal?new P1({view:this._view}):new M1({view:this._view})}},kB=class extends Wi{constructor(e,t){super(!0),this.view=e,this.registerIncoming("pointer-down",t,()=>this.view.state.stopActiveCameraController())}},BB=class extends Wi{constructor(e,t=!1){super(!0),this._view=e,this._invert=t,this.registerIncoming("vertical-two-finger-drag",i=>this._handleTwoFinger(i))}_handleTwoFinger(e){const t=this._invert?-1:1,i=si(0,e.data.delta*t);switch(e.data.action){case"begin":this._cameraController?.end(),this._cameraController=new Zd({view:this._view,pivot:0}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break;case"update":this._cameraController?.update(i);break;case"end":this._cameraController?.end(),this._cameraController=null}}};function l3(e){const t=e.native;return t?{buttons:t.buttons.map(i=>i.pressed?i.value||1:0),axes:t.axes.map(i=>UB(i,e.axisThreshold))}:{buttons:[],axes:[]}}function NB(e,t){if(e.axes.length!==t.axes.length||e.buttons.length!==t.buttons.length)return!1;for(let i=0;i<e.axes.length;i++)if(e.axes[i]!==t.axes[i])return!1;for(let i=0;i<e.buttons.length;i++)if(e.buttons[i]!==t.buttons[i])return!1;return!0}function jB(e){for(let t=0;t<e.axes.length;t++)if(e.axes[t]!==0)return!1;for(let t=0;t<e.buttons.length;t++)if(e.buttons[t]!==0)return!1;return!0}function UB(e,t){const i=Math.abs(e);return i<t?0:Math.sign(e)*(i-t)/(1-t)}let HB=class{constructor(e,t){this._element=e,this._input=t,this._hasEventListeners=!1,this._onConnectGamepad=s=>{this._connectGamepad(s.gamepad)},this._onDisconnectGamepad=s=>{const n=s.gamepad,a=n.index,o=this._inputDevices[a];o&&(this._emitGamepadEvent(n,l3(o),!1),this._inputDevices.splice(a,1),this._latestUpdate.splice(a,1),this._input.gamepad.devices.remove(o),this.ensurePollingState())},this._frameTask=null,this._latestUpdate=new Array,this._inputDevices=new Array,this._callback=null;const i="getGamepads"in window.navigator,r=window.isSecureContext;this.supported=i&&r,this.supported&&(c3(s=>this._connectGamepad(s)),window.addEventListener("gamepadconnected",this._onConnectGamepad),window.addEventListener("gamepaddisconnected",this._onDisconnectGamepad),this.ensurePollingState())}destroy(){this.hasEventListeners=!1,this.supported&&(window.removeEventListener("gamepadconnected",this._onConnectGamepad),window.removeEventListener("gamepaddisconnected",this._onDisconnectGamepad))}set hasEventListeners(e){this._hasEventListeners!==e&&(this._hasEventListeners=e,this.ensurePollingState())}get _eventsEnabled(){return this.supported&&this._inputDevices.length>0&&this._hasEventListeners}set onEvent(e){this._callback=e}_connectGamepad(e){const t=new nb(e);t.deviceType!=="unknown"&&(this._inputDevices[e.index]=t,this._input.gamepad.devices.add(t)),this.ensurePollingState()}ensurePollingState(){this._eventsEnabled?this._startPolling():this._stopPolling()}_startPolling(){this._frameTask==null&&(this._frameTask=tc({update:()=>this._readGamepadState()}))}_stopPolling(){this._frameTask!=null&&(this._frameTask.remove(),this._frameTask=null,this._latestUpdate=new Array)}_readGamepadState(){const e=document.hasFocus(),t=this._element.contains(document.activeElement),i=this._input.gamepad.enabledFocusMode==="document"&&!e||this._input.gamepad.enabledFocusMode==="view"&&!t;c3(r=>{const s=this._inputDevices[r.index];if(!s)return;const n=this._latestUpdate[r.index],a=l3(s),o=i||jB(a);n&&(n.timestamp===r.timestamp||!n.active&&o||NB(n.state,a))||this._emitGamepadEvent(r,a,!o)})}_emitGamepadEvent(e,t,i){const r=this._latestUpdate[e.index],s=r&&r.active;if(!s&&!i)return;const n=!s&&i?"start":s&&i?"update":"end";this._latestUpdate[e.index]={timestamp:e.timestamp,state:t,active:i},this._callback&&this._callback({device:this._inputDevices[e.index],state:t,action:n})}};function qB(e){if(!e||!e.connected)return!1;for(let t=0;t<e.axes.length;t++)if(isNaN(e.axes[t]))return!1;return!0}function c3(e){for(const t of navigator.getGamepads())qB(t)&&e(t)}const h3=Qe("edge"),GB=Qe("chrome"),$B=Qe("ff"),WB=Qe("safari"),u3="esri-view-surface",Ec={touchNone:`${u3}--touch-none`,touchPan:`${u3}--touch-pan`};let ZB=class bD{static{this.test={disableSubpixelCoordinates:!1}}constructor(t,i){this._active={},this._callback=()=>{},this._activePointerCaptures=new Set,this._keyDownState=new Set,this._eventId=1,this._browserTouchPanningEnabled=!1,this._element=t,t.getAttribute("tabindex")||t.setAttribute("tabindex","0"),this._eventHandlers={"key-down":this._handleKey,"key-up":this._handleKey,"pointer-down":this._handlePointer,"pointer-move":this._handlePointerPreventDefault,"pointer-up":this._handlePointerPreventDefault,"pointer-enter":this._handlePointer,"pointer-leave":this._handlePointer,"pointer-cancel":this._handlePointer,"mouse-wheel":this._handleMouseWheel,"pointer-capture-lost":this._handlePointerCaptureLost},this._updateTouchAction(),this._element.addEventListener("keydown",this._preventAltKeyDefault),this._gamepadSource=new HB(t,i),this._gamepadSource.onEvent=r=>this._callback("gamepad",r)}destroy(){this._callback=()=>{},this.activeEvents=null,this._activePointerCaptures.forEach(t=>this._releasePointerCaptureSafe(t)),this._activePointerCaptures.clear(),this._gamepadSource=Z(this._gamepadSource),this._removeTouchAction(),this._element.removeEventListener("keydown",this._preventAltKeyDefault)}get browserTouchPanningEnabled(){return this._browserTouchPanningEnabled}set browserTouchPanningEnabled(t){this._browserTouchPanningEnabled=t,this._updateTouchAction(),this._updateTouchEventHandling()}set onEventReceived(t){this._callback=t}set activeEvents(t){for(const i in this._active)if(!t||!t.has(i)){const r=this._active[i];this._element.removeEventListener(i0[i],r),delete this._active[i]}t&&t.forEach(i=>{if(!this._active[i]&&i0[i]){const r=(this._eventHandlers[i]||this._handleDefault).bind(this,i);this._element.addEventListener(i0[i],r),this._active[i]=r}}),this._gamepadSource&&(this._gamepadSource.hasEventListeners=t?.has("gamepad")??!1)}setPointerCapture(t,i){i?this._setPointerCaptureSafe(t.pointerId):(this._releasePointerCaptureSafe(t.pointerId),this._activePointerCaptures.delete(t.pointerId))}_updateTouchAction(){this._element.classList.remove(this._browserTouchPanningEnabled?Ec.touchNone:Ec.touchPan),this._element.classList.add(this._browserTouchPanningEnabled?Ec.touchPan:Ec.touchNone)}_updateTouchEventHandling(){this._browserTouchPanningEnabled?this._element.addEventListener("touchmove",this._preventMultiTouchPanning):this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_removeTouchAction(){this._element.classList.remove(Ec.touchNone),this._element.classList.remove(Ec.touchPan),this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_setPointerCaptureSafe(t){try{this._element.setPointerCapture(t),this._activePointerCaptures.add(t)}catch{}}_releasePointerCaptureSafe(t){try{if(this._element.hasPointerCapture&&!this._element.hasPointerCapture(t))return;this._element.releasePointerCapture(t)}catch{}}_updateNormalizedPointerLikeEvent(t,i){const r=VM(this._element,t);return bD.test.disableSubpixelCoordinates&&(r.x=Math.round(r.x),r.y=Math.round(r.y)),i.x=r.x,i.y=r.y,i}_handleKey(t,i){const{key:r}=i;r&&t==="key-up"&&this._keyDownState.delete(r);const s={native:i,key:r,repeat:!!r&&this._keyDownState.has(r)};r&&t==="key-down"&&this._keyDownState.add(s.key),this._callback(t,s)}_handlePointer(t,i){const r=this._updateNormalizedPointerLikeEvent(i,{native:i,x:0,y:0,pointerType:i.pointerType,button:i.button,buttons:i.buttons,eventId:this._eventId++});this._callback(t,r)}_handlePointerPreventDefault(t,i){const r=this._updateNormalizedPointerLikeEvent(i,{native:i,x:0,y:0,pointerType:i.pointerType,button:i.button,buttons:i.buttons,eventId:this._eventId++});i.preventDefault(),this._callback(t,r)}_getDeltaFromTrackpadOrMouseWheel(t){return t.shiftKey&&Qe("mac")&&t.deltaY===0?t.deltaX:t.deltaY}_handleMouseWheel(t,i){let r=this._getDeltaFromTrackpadOrMouseWheel(i);switch(i.deltaMode){case 0:h3&&(r=r/document.documentElement.clientHeight*600);break;case 1:r*=30;break;case 2:r*=900}h3?r*=.7:GB||WB?r*=.6:$B&&(r*=1.375);const s=100,n=Math.abs(r);n>s&&(r=r/n*200/(1+Math.exp(-.02*(n-s))));const a=this._updateNormalizedPointerLikeEvent(i,{native:i,x:0,y:0,deltaY:r});this._callback(t,a)}_handlePointerCaptureLost(t,i){this._activePointerCaptures.delete(i.pointerId),this._handleDefault(t,i)}_handleDefault(t,i){const r={native:i};i.preventDefault(),this._callback(t,r)}_preventAltKeyDefault(t){t.key==="Alt"&&t.preventDefault()}_preventMultiTouchPanning(t){t.touches.length>1&&t.preventDefault()}};const i0={"key-down":"keydown","key-up":"keyup","pointer-down":"pointerdown","pointer-up":"pointerup","pointer-move":"pointermove","mouse-wheel":"wheel","pointer-capture-got":"gotpointercapture","pointer-capture-lost":"lostpointercapture","context-menu":"contextmenu","pointer-enter":"pointerenter","pointer-leave":"pointerleave","pointer-cancel":"pointercancel",focus:"focus",blur:"blur"};let QB=class extends Wi{constructor(){super(!0),this.registerIncoming("context-menu",e=>e.data.native.preventDefault())}};const wD=()=>({maximumClickDelay:300}),XB=(e={})=>({...wD(),movementUntilMouseDrag:1.5,movementUntilPenDrag:6,movementUntilTouchDrag:6,holdDelay:500,...e}),xD=(e={})=>({...wD(),maximumDoubleClickDistance:10,maximumDoubleTouchDistance:35,maximumDoubleClickDelay:250,maximumDoubleTouchDelay:350,...e});function R1(e,t){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)}function YB(e,t){const i=t.x-e.x,r=t.y-e.y;return Math.sqrt(i*i+r*r)}function KB(e,t){if(t?(t.radius=0,t.center.x=0,t.center.y=0):t={radius:0,center:ms()},e.length===0)return t;if(e.length===1)return t.center.x=e[0].x,t.center.y=e[0].y,t;if(e.length===2){const[S,x]=e,[T,P]=[x.x-S.x,x.y-S.y];return t.radius=Math.sqrt(T*T+P*P)/2,t.center.x=(S.x+x.x)/2,t.center.y=(S.y+x.y)/2,t}let i=0,r=0;for(let S=0;S<e.length;S++)i+=e[S].x,r+=e[S].y;i/=e.length,r/=e.length;const s=e.map(S=>S.x-i),n=e.map(S=>S.y-r);let a=0,o=0,l=0,c=0,u=0,p=0,m=0;for(let S=0;S<s.length;S++){const x=s[S],T=n[S],P=x*x,R=T*T;a+=P,o+=R,l+=x*T,c+=P*x,u+=R*T,p+=x*R,m+=T*P}const f=.5*(c+p),g=.5*(u+m),y=a*o-l*l,v=(f*o-g*l)/y,C=(a*g-l*f)/y,b=ms(v+i,C+r);return{radius:Math.sqrt(v*v+C*C+(a+o)/e.length),center:b}}function Yd(e){const{native:t}=e,{pointerId:i,button:r,pointerType:s}=t;return s==="mouse"?`${i}:${r}`:`${s}`}let JB=class extends Wi{constructor(e){super(!1),this._navigationTouch=e,this._startStateModifiers=new Set,this._activePointerMap=new Map,this._isDragging=!1,this._isCurrentDragSuppressed=!1,this._drag=this.registerOutgoing("drag"),this.registerIncoming("pointer-drag",this._handlePointerDrag.bind(this)),this.registerIncoming("pointer-up",this._handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-capture-lost",this._handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-cancel",this._handlePointerUpAndPointerLost.bind(this))}_createPayload(e,t,i,r){return{action:e,pointerType:this._pointerType,button:this._mouseButton,buttons:t.buttons,timestamp:r,pointers:eN(this._activePointerMap),pointer:t,angle:i.angle,radius:i.radius,center:i.center}}_addPointer(e){const t=e.native.pointerId,i=jm(this._activePointerMap).angle,r={event:e,initialAngle:0,lastAngle:0};this._activePointerMap.set(t,r);const s=Kf(r,CD(this._activePointerMap));r.initialAngle=s,r.lastAngle=s,this._updatePointerAngles(i)}_updatePointer(e){if(e&&e.x==null&&e.y==null)return;const t=e.native.pointerId,i=this._activePointerMap.get(t);i?i.event=e:this._addPointer(e)}_removePointer(e){const t=jm(this._activePointerMap).angle;this._activePointerMap.delete(e),this._updatePointerAngles(t)}_updatePointerAngles(e){const t=jm(this._activePointerMap);this._activePointerMap.forEach(i=>{i.initialAngle=Kf(i,t)-e,i.lastAngle=Kf(i,t)-e})}_emitEvent(e,t,i){const r=jm(this._activePointerMap);this._drag.emit(this._createPayload(e,t,r,i),void 0,this._startStateModifiers)}_handlePointerUpAndPointerLost(e){const t=e.data.native.pointerId,i=Oe(e.timestamp);this._activePointerMap.get(t)&&(this._activePointerMap.size===1?(this._updatePointer(e.data),!this._isCurrentDragSuppressed&&this._emitEvent("end",e.data,i),this._isDragging=!1,this._isCurrentDragSuppressed=!1,this._removePointer(t)):(this._removePointer(t),this._emitEvent("removed",e.data,Oe(e.timestamp))))}_handlePointerDrag(e){const t=e.data,i=t.currentEvent,r=Oe(e.timestamp);switch(t.action){case"start":case"update":this._isDragging?this._activePointerMap.has(i.native.pointerId)?(this._updatePointer(i),!this._isCurrentDragSuppressed&&this._emitEvent("update",i,r)):(this._addPointer(i),this._emitEvent("added",i,r),this._isCurrentDragSuppressed=this._isSuppressed):(this._updatePointer(i),this._pointerType=e.data.startEvent.pointerType,this._mouseButton=e.data.startEvent.button,this._startStateModifiers=e.modifiers,this._isDragging=!0,this._isCurrentDragSuppressed=this._isSuppressed,!this._isCurrentDragSuppressed&&this._emitEvent("start",i,r))}}get _isSuppressed(){return!!this._navigationTouch&&!this._navigationTouch.browserTouchPanEnabled&&this._pointerType==="touch"&&this._activePointerMap.size===1}};function CD(e){const t=[];return e.forEach(i=>{t.push(ms(i.event.x,i.event.y))}),KB(t)}function jm(e){const t=CD(e);let i=0;return e.forEach(r=>{let s=Kf(r,t),n=s-r.lastAngle;for(;n>Math.PI;)n-=2*Math.PI;for(;n<-Math.PI;)n+=2*Math.PI;s=r.lastAngle+n,r.lastAngle=s;const a=s-r.initialAngle;i+=a}),i/=e.size||1,{angle:i,radius:t.radius,center:t.center}}function eN(e){const t=new Map;return e.forEach((i,r)=>t.set(r,i.event)),t}function Kf(e,t){const i=e.event,r=i.x-t.center.x,s=i.y-t.center.y;return Math.atan2(s,r)}let tN=class extends Wi{constructor(e={},t=Vp){super(!1),this._clock=t,this._pointerState=new Map,this._parameters=xD(e),this._immediateDoubleClick=this.registerOutgoing("immediate-double-click"),this.registerIncoming("pointer-down",this._handlePointerDown.bind(this)),this.registerIncoming("pointer-up",this._handlePointerUp.bind(this))}onUninstall(){this._pointerState.forEach(e=>{e.immediateDoubleClick&&e.immediateDoubleClick.timeoutHandle.remove()}),super.onUninstall()}_handlePointerDown(e){const t=e.data,i=Yd(t);if(!this._pointerState.has(i)){const r={downButton:t.native.button,x:t.x,y:t.y,immediateDoubleClick:null};this._pointerState.set(i,r),this.startCapturingPointer(t.native)}}_handlePointerUp(e){const t=e.data,i=Yd(t),r=this._pointerState.get(i);if(r&&r.downButton===t.native.button){const s=r.immediateDoubleClick,n=e.data.native.pointerType==="touch"?this._parameters.maximumDoubleTouchDistance:this._parameters.maximumDoubleClickDistance;s?(s.timeoutHandle.remove(),R1(s,e.data)>n?this._startImmediateDoubleClick(e,r):(this._immediateDoubleClick.emit(e.data,void 0,s.modifiers),this._removeState(t))):R1(r,e.data)>n?this._removeState(t):this._startImmediateDoubleClick(e,r)}}_startImmediateDoubleClick(e,t){const i=e.data.native.pointerType==="touch"?this._parameters.maximumDoubleTouchDelay:this._parameters.maximumDoubleClickDelay;t.immediateDoubleClick={x:e.data.x,y:e.data.y,modifiers:e.modifiers,timeoutHandle:this._clock.setTimeout(()=>this._removeState(e.data),i)}}_removeState(e){const t=Yd(e);this._pointerState.delete(t),this.stopCapturingPointer(e.native),this.refreshHasPendingInputs()}},iN=class extends Wi{constructor(e={},t=Vp){super(!1),this._clock=t,this._pointerState=new Map,this._parameters=XB(e),this._pointerDrag=this.registerOutgoing("pointer-drag"),this._immediateClick=this.registerOutgoing("immediate-click"),this._pointerHold=this.registerOutgoing("hold"),this.registerIncoming("pointer-down",i=>this._handlePointerDown(i)),this.registerIncoming("pointer-up",i=>this._handlePointerLoss(i,"pointer-up")),this.registerIncoming("pointer-capture-lost",i=>this._handlePointerLoss(i,"pointer-capture-lost")),this.registerIncoming("pointer-cancel",i=>this._handlePointerLoss(i,"pointer-cancel")),this._moveHandle=this.registerIncoming("pointer-move",i=>this._handlePointerMove(i)),this._moveHandle.pause()}onUninstall(){this._pointerState.forEach(e=>{e.holdTimeout=xi(e.holdTimeout)}),super.onUninstall()}_handlePointerDown(e){const t=e.data,i=t.native.pointerId;let r=null;this._pointerState.size===0&&(r=this._clock.setTimeout(()=>{const n=this._pointerState.get(i);if(n){if(!n.isDragging){const a=n.previousEvent;this._pointerHold.emit(a,void 0,e.modifiers),n.holdEmitted=!0}n.holdTimeout=null}},this._parameters.holdDelay));const s={startEvent:t,previousEvent:t,startTimestamp:e.timestamp,isDragging:!1,downButton:t.native.button,holdTimeout:r,modifiers:new Set};this._pointerState.set(i,s),this.startCapturingPointer(t.native),this._moveHandle.resume(),this._pointerState.size>1&&this._startDragging(e)}_handlePointerMove(e){const t=e.data,i=t.native.pointerId,r=this._pointerState.get(i);r&&(r.isDragging?this._pointerDrag.emit(Um("update",r,t),void 0,r.modifiers):YB(t,r.startEvent)>this._getDragThreshold(t.native.pointerType)&&this._startDragging(e),r.previousEvent=t)}_getDragThreshold(e){switch(e){case"touch":return this._parameters.movementUntilTouchDrag;case"pen":return this._parameters.movementUntilPenDrag;default:return this._parameters.movementUntilMouseDrag}}_startDragging(e){const t=e.data,i=t.native.pointerId;this._pointerState.forEach(r=>{r.holdTimeout!=null&&(r.holdTimeout.remove(),r.holdTimeout=null),r.isDragging||(r.modifiers=e.modifiers,r.isDragging=!0,i===r.startEvent.native.pointerId?this._pointerDrag.emit(Um("start",r,t)):this._pointerDrag.emit(Um("start",r,r.previousEvent),e.timestamp))})}_handlePointerLoss(e,t){const i=e.data,r=i.native.pointerId,s=this._pointerState.get(r);s&&(s.holdTimeout!=null&&(s.holdTimeout.remove(),s.holdTimeout=null),s.isDragging?this._pointerDrag.emit(Um("end",s,t==="pointer-up"?i:s.previousEvent),void 0,s.modifiers):t==="pointer-up"&&s.downButton===i.native.button&&e.timestamp-s.startTimestamp<=this._parameters.maximumClickDelay&&!s.holdEmitted&&this._immediateClick.emit(i),this._pointerState.delete(r),this.stopCapturingPointer(i.native),this._pointerState.size===0&&this._moveHandle.pause())}};function Um(e,t,i){return{action:e,startEvent:t.startEvent,previousEvent:t.previousEvent,currentEvent:i}}let rN=class extends Wi{constructor(e={},t=Vp){super(!1),this._clock=t,this._pointerState=new Map,this._parameters=xD(e),this._click=this.registerOutgoing("click"),this._doubleClick=this.registerOutgoing("double-click"),this.registerIncoming("immediate-click",i=>this._handleImmediateClick(i)),this.registerIncoming("pointer-down",i=>this._handlePointerDown(i))}onUninstall(){this._pointerState.forEach(e=>e.doubleClickTimer=xi(e.doubleClickTimer))}get hasPendingInputs(){for(const e of this._pointerState.values())if(e.doubleClickTimer!=null)return!0;return!1}_clearDoubleClickTimer(e,t){const i=this._pointerState.get(e);i&&(i.doubleClickTimer=xi(i.doubleClickTimer),t&&this._click.emit(i.event.data,void 0,i.event.modifiers),this._pointerState.delete(e),this.refreshHasPendingInputs())}_doubleClickTimeoutExceeded(e){const t=this._pointerState.get(e);t.pointerDownCount===1&&this._click.emit(t.event.data,void 0,t.event.modifiers),t.doubleClickTimer=null,this._pointerState.delete(e),this.refreshHasPendingInputs()}_handleImmediateClick(e){const t=e.data,{pointerType:i}=t.native,r=sN(t);if(!this._pointerState.has(r))return void this._startClick(e);const s=this._pointerState.get(r),{data:n,modifiers:a}=s.event,o=i==="touch"?this._parameters.maximumDoubleTouchDistance:this._parameters.maximumDoubleClickDistance;R1(n,t)>o?(this._clearDoubleClickTimer(r,!0),this._startClick(e)):(this._clearDoubleClickTimer(r,!1),s.pointerDownCount===2&&this._doubleClick.emit(n,void 0,a))}_handlePointerDown(e){const t=Yd(e.data),i=this._pointerState.get(t);i&&(i.pointerDownCount+=1)}_startClick(e){const{data:t}=e,{native:{pointerType:i}}=t,r=Yd(t),s=i==="touch"?this._parameters.maximumDoubleTouchDelay:this._parameters.maximumDoubleClickDelay,n=this._clock.setTimeout(()=>this._doubleClickTimeoutExceeded(r),s);this._pointerState.set(r,{event:e,doubleClickTimer:n,pointerDownCount:1}),this.refreshHasPendingInputs()}};function sN(e){const{pointerId:t,pointerType:i,button:r}=e.native;return i==="mouse"?`${t}:${r}`:`${i}`}let nN=class{constructor(e){this._callbacks=e,this._currentCount=0,this._callbacks.condition||(this._callbacks.condition=()=>!0)}handle(e){const t=e.data,i=t.pointers.size;switch(t.action){case"start":this._currentCount=i,this._emitStart(e);break;case"added":this._emitEnd(this._previousEvent),this._currentCount=i,this._emitStart(e);break;case"update":this._emitUpdate(e);break;case"removed":this._startEvent&&this._emitEnd(this._previousEvent),this._currentCount=i,this._emitStart(e);break;case"end":this._emitEnd(e),this._currentCount=0}this._previousEvent=e}_emitStart(e){this._startEvent=e,this._callbacks.condition?.(this._currentCount,e)&&this._callbacks.start(this._currentCount,e,this._startEvent)}_emitUpdate(e){this._callbacks.condition?.(this._currentCount,e)&&this._callbacks.update(this._currentCount,e,this._startEvent)}_emitEnd(e){this._callbacks.condition?.(this._currentCount,e)&&this._callbacks.end(this._currentCount,e,this._startEvent),this._startEvent=null}},aN=class extends Wi{constructor(e=20,t=40){super(!1),this._threshold=e,this._maxDelta=t,this._state="ready",this._emittedArtificalEnd2=!1,this._vertical=this.registerOutgoing("vertical-two-finger-drag"),this._artificalDrag=this.registerOutgoing("drag"),this._dragEventSeparator=new nN({start:(i,r)=>this._observeStart(i,r),update:(i,r,s)=>this._observeUpdate(i,r,s),end:(i,r)=>this._observeEnd(r)}),this.registerIncoming("drag",i=>this._dragEventSeparator.handle(i))}get failed(){return this._state==="failed"}_observeStart(e,t){e===1&&this._emittedArtificalEnd2&&(this._emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),t.stopPropagation()),this._state=e===2?"ready":"failed"}_observeUpdate(e,t,i){if(this._state!=="failed"&&e===2)return this._state==="active"?(this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void t.stopPropagation()):void(this._checkMovementWithinLimits(t.data,i.data)?this._checkVerticalThresholdReached(t.data,i.data)&&(this._state="active",this._emittedArtificalEnd2=!0,this._thresholdReachedCenter=t.data.center,this._artificalDrag.emit({action:"end",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),t.stopPropagation()):this._state="failed")}_observeEnd(e){this._state==="active"&&(this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this._state="ready",e.stopPropagation())}_checkMovementWithinLimits(e,t){let i=-1/0,r=1/0,s=-1/0,n=1/0;for(const{x:g,y}of t.pointers.values())i=Math.max(i,g),r=Math.min(r,g),s=Math.max(s,y),n=Math.min(n,y);let a=-1/0,o=1/0,l=-1/0,c=1/0;for(const{x:g,y}of e.pointers.values())a=Math.max(a,g),o=Math.min(o,g),l=Math.max(l,y),c=Math.min(c,y);const u=i-r,p=s-n,m=a-o,f=l-c;return Math.abs(e.center.x-t.center.x)<this._threshold&&Math.abs(m-u)<=this._maxDelta&&Math.abs(f-p)<=this._maxDelta}_checkVerticalThresholdReached(e,t){let i=Math.abs(e.center.y-t.center.y);return e.pointers.forEach((r,s)=>{const n=t.pointers.get(s);i=Math.min(i,Math.abs(r.y-n.y))}),i>=this._threshold}},Sa=class extends ie{constructor(){super(...arguments),this.mode="default",this._updateMode=({mode:e,dragPrimary:t,dragSecondary:i,dragTertiary:r})=>{e==="pro"&&(i="zoom",r=t==="pan"?"rotate":"pan");const s={dragPrimary:t,dragSecondary:i,dragTertiary:r};this._modeDragPan&&(this._modeDragPan.pointerActions=Zy("pan",s)),this._modeDragRotate&&(this._modeDragRotate.pointerActions=Zy("rotate",s)),this._modeDragZoom&&(this._modeDragZoom.pointerActions=Zy("zoom",s))}}destroy(){this.disconnect()}get primaryDragAction(){return this.view.navigation.actionMap.dragPrimary}set primaryDragAction(e){const{actionMap:t}=this.view.navigation;t.dragPrimary=e,t.dragSecondary=e==="pan"?"rotate":"pan"}get updating(){return!!this._inputManager?.updating}get latestPointerInfo(){return this._inputManager?.latestPointerInfo}get multiTouchActive(){return this._inputManager?.multiTouchActive??!1}disconnect(){this.removeAllHandles(),this.view.viewEvents.disconnect(),this._modeDragPan=null,this._modeDragRotate=null,this._modeDragZoom=null,this._modeKeyboardNavigation=null,this._inputManager=Z(this._inputManager),this._source=Z(this._source)}connect(){const e=this.view;this._source=new ZB(this.view.surface,e.input);const t=[new tN,new iN,new rN,new JB(this.view.navigation),new aN],i=new sn({eventSource:this._source,recognizers:t});this._inputManager=i,i.installHandlers("prevent-context-menu",[new QB],ka.INTERNAL);const r={fov:"Shift",pan:{left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:["u","U"],down:["j","J"]},lookAround:{headingLeft:["a","A"],headingRight:["d","D"],tiltUp:["w","W"],tiltDown:["s","S"],modifier:"b"},zoom:{zoomIn:["+","="],zoomOut:["-","_"]},reset:{heading:["n","N"],tilt:["p","P"]}};this._modeDragPan=new o3(e,["primary"]),this._modeDragRotate=new Jy(e,["secondary"],0),this._modeDragZoom=new wB(e,["tertiary"],r.fov),this._modeKeyboardNavigation=new EB(e,r),i.installHandlers("navigation",[new kB(e),new Rk(e),new DB(e),new AB(e,r.fov),new Jy(e,["primary"],1,[r.lookAround.modifier]),new Jy(e,["secondary"],0,[r.lookAround.modifier]),new o3(e,["tertiary"],[r.lookAround.modifier]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,this._modeKeyboardNavigation,new BB(e)],ka.INTERNAL),this.view.viewEvents.connect(i),this.addHandles([M(()=>this.view.navigation?.browserTouchPanEnabled,s=>{this._source.browserTouchPanningEnabled=!s},Ee),M(()=>{const{actionMap:s}=this.view.navigation,{dragPrimary:n,dragSecondary:a,dragTertiary:o}=s;return{mode:this.mode,dragPrimary:n,dragSecondary:a,dragTertiary:o}},this._updateMode,Ve)])}isModifierKeyDown(e){return this._inputManager?.isModifierKeyDown(e)??!1}get test(){}};h([d()],Sa.prototype,"view",void 0),h([d({type:["default","pro"]})],Sa.prototype,"mode",void 0),h([d({readOnly:!0})],Sa.prototype,"updating",null),h([d()],Sa.prototype,"latestPointerInfo",null),h([d()],Sa.prototype,"multiTouchActive",null),h([d()],Sa.prototype,"_inputManager",void 0),Sa=h([D("esri.views.3d.input.SceneInputManager")],Sa);const oN=Sa;let Pi,lu,D1=!1,O1=!1,E1=!1,A1=!1,Kd=null;function lN(e){const t=O1?e():null;if(!t?.bins)return;SD();const i=lu;let r=0;for(let s=0;s<t.numX;s++)for(let n=0;n<t.numY;n++){const a=t.bins[s][t.numY-1-n];r+=a.length;const o=s*t.sizeX,l=(s+1)*t.sizeX,c=n*t.sizeY,u=(n+1)*t.sizeY;i.fillText(a.length.toFixed(),o+5,c+15),TD(o,l,c,u,"blue")}i.fillText("total totalShownLabels: "+r,70,40),i.fillText("total visible labels: "+t.numVisible,70,50),i.fillText("total numTests: "+t.numTests,70,30)}function cN(e){E1=bi.DECONFLICTOR_SHOW_VISIBLE,A1=bi.DECONFLICTOR_SHOW_INVISIBLE,D1=E1||A1,O1=bi.DECONFLICTOR_SHOW_GRID,Kd=null,D1||O1?(lu&&Pi&&lu.clearRect(0,0,Pi.width,Pi.height),Kd=()=>hN(e)):Pi&&(Pi.parentElement.removeChild(Pi),Pi=null)}function SD(){Kd&&(Kd(),Kd=null)}function hN(e){Pi==null&&(Pi=document.createElement("canvas"),Pi.setAttribute("id","debugCanvas2d"),e.surface.parentElement.style.position="relative",e.surface.parentElement.appendChild(Pi),Pi.style.position="absolute",Pi.style.width="100%",Pi.style.height="100%",Pi.style.display="block",Pi.style.pointerEvents="none",lu=Pi.getContext("2d"),lu.font="12px Arial");const{width:t,height:i}=e.state.camera;Pi.width=t,Pi.height=i}function TD(e,t,i,r,s){SD();const n=Pi.height,a=lu;a.beginPath(),a.lineWidth=1,a.strokeStyle=s,a.moveTo(e,n-i),a.lineTo(t,n-i),a.stroke(),a.lineTo(t,n-r),a.stroke(),a.lineTo(e,n-r),a.stroke(),a.lineTo(e,n-i),a.stroke(),a.closePath()}function PD(e,t,i=!1){D1&&(t&&E1||!t&&A1)&&TD(e[0],e[2],e[1],e[3],i?t?"pink":"grey":t?"green":"red")}let uN=class{constructor(e,t,i){this._setVisibility=e,this._canConflict=t,this._compare=i,this.done=!1,this._items=new Array,this._accBinsNumX=15,this._accBinsNumY=20,this._accBinsSizeX=0,this._accBinsSizeY=0,this._accBins=null}destroy(){this._generator=null,this._accBins=null,this._items.length=0}reset(e,t){this._initBins(e,t),this._items.length=0,this.done=!1,this._generator=null}add(e){this._items.push(e)}run(e){this._generator??=this._run(e),this.done=!!this._generator.next(e).done}*_run(e){yield*this._sort(e),yield*this._deconflict(e),lN(()=>({bins:this._accBins,numX:this._accBinsNumX,numY:this._accBinsNumY,sizeX:this._accBinsSizeX,sizeY:this._accBinsSizeY,numTests:0,numVisible:this._items.length}))}*_sort(e){for(const t of xA(this._items,0,this._items.length,this._compare))e.madeProgress(),e.done&&(e=yield)}_isConflicted(e){let t=!0;return this._forEachBin(e.aabr,i=>(t=!1,i.some(r=>this._canConflict(r,e)&&k4(r.aabr,e.aabr))))||t}*_deconflict(e){for(const t of this._items){e.done&&(e=yield);const i=!this._isConflicted(t);this._setVisibility(t,i),PD(t.aabr,i),i&&this._addToBins(t),e.madeProgress()}}_initBins(e,t){if(this._accBins==null){this._accBins=[];for(let i=0;i<this._accBinsNumX;i++){this._accBins.push([]);const r=this._accBins[this._accBins.length-1];for(let s=0;s<this._accBinsNumY;s++)r.push(new jt)}}else for(let i=0;i<this._accBinsNumX;i++)for(let r=0;r<this._accBinsNumY;r++)this._accBins[i][r].clear();this._accBinsSizeX=e/this._accBinsNumX,this._accBinsSizeY=t/this._accBinsNumY}_addToBins(e){this._forEachBin(e.aabr,t=>t.push(e))}_forEachBin(e,t){if(!this._accBins)return!1;const i=Math.max(Math.floor(e[0]/this._accBinsSizeX),0),r=Math.max(Math.floor(e[1]/this._accBinsSizeY),0),s=Math.min(Math.floor(e[2]/this._accBinsSizeX),this._accBinsNumX-1),n=Math.min(Math.floor(e[3]/this._accBinsSizeY),this._accBinsNumY-1);for(let a=i;a<=s;a++)for(let o=r;o<=n;o++)if(t(this._accBins[a][o]))return!0;return!1}},dN=class{constructor(e){this._gl=e,this._sync=e.fenceSync(e.SYNC_GPU_COMMANDS_COMPLETE,0)}poll(){const e=this._gl,t=e.clientWaitSync(this._sync,e.SYNC_FLUSH_COMMANDS_BIT,0);if(t===e.WAIT_FAILED)throw new Error("clientWaitSync failed");return t!==e.TIMEOUT_EXPIRED}destroy(){this._gl.deleteSync(this._sync),this._sync=null}},Cl=class extends qo{constructor(e){super(e),this.category=Ft.COMPOSITE,this.readyToRun=!1,this.done=!0,this._origin=w(),this._textureWidth=256,this._uploadBuffer=new Float32Array(3*this._textureWidth),this._counter=0,this._width=0,this._height=0,this._pixelBufferSize=0,this._pipeline=Ge({colorWrite:st}),this._format=0}initialize(){const e=this.view.resourceController.scheduler.registerTask(mi.GRAPHICS_CORE,this);this.addHandles(e),this.produces="disabled",this.consumes.required=[this.category],this.formatOverride&&(this._format=this.formatOverride)}destroy(){this._program=ye(this._program);const e=this.gl;this._sync=Z(this._sync),this._pixelBuffer&&(e.deleteBuffer(this._pixelBuffer),this._pixelBuffer=null,this._pixelBufferSize=0),this._texture=ye(this._texture)}precompile(){this._ensureProgram(this.renderingContext)}render(e){const t=e.find(({name:c})=>c===this.category);if(this._sync)return t;this.produces="disabled";const i=this.renderingContext,r=this.gl,s=t.getTexture(r.DEPTH_STENCIL_ATTACHMENT);if(!s)return t;const n=this.view.stage.renderer.fboCache.acquire(this._width,this._height,"hud visibility",9);i.bindFramebuffer(n.fbo),i.setPipelineState(this._pipeline);const a=this._ensureProgram(i);i.useProgram(a);const o=0;i.bindTexture(s,o),a.setUniform1i("depthTex",o);const l=1;return i.bindTexture(this._texture,l),a.setUniform1i("positionTex",l),lr(r0,this.camera.viewMatrix,eM(r0,this._origin)),a.setUniformMatrix4fv("view",r0),a.setUniformMatrix4fv("proj",this.camera.projectionMatrix),a.setUniform1i("count",this._counter),i.screen.draw(),this._pixelBuffer||(this._pixelBuffer=r.createBuffer()),this._format===0&&(this._format=r.getParameter(r.IMPLEMENTATION_COLOR_READ_FORMAT)===6403&&r.getParameter(r.IMPLEMENTATION_COLOR_READ_TYPE)===Tn.FLOAT?6403:6408),this._pixelBufferSize=this._width*this._height*(this._format===6403?4:16),r.bindBuffer(r.PIXEL_PACK_BUFFER,this._pixelBuffer),r.bufferData(r.PIXEL_PACK_BUFFER,this._pixelBufferSize,r.STREAM_READ),r.readPixels(0,0,this._width,this._height,this._format,Tn.FLOAT,0),this._sync=new dN(r),n.release(),setTimeout(()=>this.readyToRun=!0,0),t}runTask(){if(!this._sync)return void(this.readyToRun=!1);try{if(!this._sync.poll())return Fi}catch{return this.readyToRun=!1,void(this._sync=Z(this._sync))}this.readyToRun=!1,this._sync=Z(this._sync);const e=this.gl;e.bindBuffer(e.PIXEL_PACK_BUFFER,this._pixelBuffer),this._cpuBuffer=new Float32Array(this._width*this._height*(this._format===6403?1:4)),e.getBufferSubData(e.PIXEL_PACK_BUFFER,0,this._cpuBuffer),e.bindBuffer(e.PIXEL_PACK_BUFFER,null),this.done=!0}init(e,t){const i=this._textureWidth;if(this._width=i,this._height=Math.ceil(e/i),this._counter=0,this._texture?.dispose(),this._height===0)return;const r=new gt(this._width,this._height);r.pixelFormat=6407,r.dataType=ni.FLOAT,r.samplingMode=9728,this._texture=new bt(this.renderingContext,r),this.done=!1,xe(this._origin,Math.fround(t[0]),Math.fround(t[1]),Math.fround(t[2]))}addPosition(e){const t=this._width;if(this._counter>=t*this._height)return-1;const i=this._counter%t;return ji(Hm,e,this._origin),this._uploadBuffer[3*i+0]=Hm[0],this._uploadBuffer[3*i+1]=Hm[1],this._uploadBuffer[3*i+2]=Hm[2],i===t-1&&this._flush(),this._counter++}start(){if(this._width===0||this._height===0)return;const e=this._width;this._counter%e>0&&this._flush(),this.produces=this.category,this.requestRender(1)}getOcclusion(e){return this._cpuBuffer?.[this._format===6403?e:4*e]??-1}get usedMemory(){return(this._texture?.usedMemory??0)+this._pixelBufferSize+4*(this._uploadBuffer?.length??0)+4*(this._cpuBuffer?.length??0)}_flush(){const e=this._width,t=Math.floor(this._counter/e);this._texture?.updateData(0,0,t,e,1,this._uploadBuffer)}_ensureProgram(e){return this._program??=e.programCache.acquire(pN,mN,ai),this._program}};h([d()],Cl.prototype,"category",void 0),h([d()],Cl.prototype,"formatOverride",void 0),h([d()],Cl.prototype,"readyToRun",void 0),h([d()],Cl.prototype,"done",void 0),Cl=h([D("esri.views.3d.webgl-engine.lib.GPUPointOcclusionQuery")],Cl);const pN=`#version 300 es
precision highp float;
in vec2 position;

void main() {
    gl_Position = vec4(position, 0.0, 1.0);
}`,mN=`#version 300 es
precision highp float;
out highp vec4 fragColor;

uniform highp mat4 proj;
uniform highp mat4 view;

uniform highp int count;

uniform highp sampler2D depthTex;
uniform highp sampler2D positionTex;

float linearizeDepth(float depth) {
  float depthNdc = depth * 2.0 - 1.0;
  float c1 = proj[3][2];
  float c2 = proj[2][2];
  return -c1 / (depthNdc + c2 + 1e-7);
}

void main() {
  int u = int(floor(gl_FragCoord.x));
  int v = int(floor(gl_FragCoord.y));
  if (u + v * textureSize(positionTex, 0).x >= count) {
    fragColor = vec4(-1);
    return;
  }
  vec4 posWorld = vec4(texelFetch(positionTex, ivec2(u, v), 0).rgb, 1.0);

  vec4 posView = view * posWorld;
  vec4 projected = proj * posView;

  vec3 clipPos = projected.xyz / projected.w;

  if (clipPos.x < -1.0 || clipPos.x > 1.0 || clipPos.y < -1.0 || clipPos.y > 1.0) {
    fragColor = vec4(-1);
    return;
  }

  vec3 uvDepth = 0.5 * clipPos + vec3(0.5);

  float depth = texture(depthTex, uvDepth.xy).r;

  if (uvDepth.z <= depth) {
    fragColor = vec4(0);
    return;
  }

  fragColor = vec4(linearizeDepth(depth) - linearizeDepth(uvDepth.z));
}
`,Hm=w(),r0=Le(),da=w(),s0=w(),Ac=Vt(),zu=Vt(),n0=w(),fN=Le(),gN=Kr(),a0=$o(),_N=w(),yN=Rt();class vN{constructor(t){this.id=t,this.aabr=Rt(),this.altitude=0,this.distance=0,this.distanceToOccluder=0,this.culled=!1,this.visible=!1,this.priority=0}}function bN(e,t){const i=e.distanceToOccluder!==0&&e.distance>e.distanceToOccluder,r=t.distanceToOccluder!==0&&t.distance>t.distanceToOccluder;return i!==r?+i-+r:e.priority!==t.priority?t.priority-e.priority:e.distance!==t.distance?e.distance-t.distance:e.visible!==t.visible?+t.visible-+e.visible:e.id-t.id}class wN{constructor(t,i){this.graphics3DGraphic=t,this.slicePlaneEnabled=i,this._info=null,this._labelInfo=null}ensureInfo(t){let i=this.getInfo(t);return i||(i=new vN(this.graphics3DGraphic.graphic.uid),this._setInfo(t,i)),i}getInfo(t){return t===16?this._labelInfo:this._info}removeInfo(t){this._setInfo(t,null)}_setInfo(t,i){t===16?this._labelInfo=i:this._info=i}}class xN{constructor(){this.camera=new vt,this.slicePlane=E_(),this.slicePlaneEnabled=!1}copyFrom(t){this.camera.equals(t.camera)||this.camera.copyFrom(t.camera),V2(t.slicePlane,this.slicePlane),this.slicePlaneEnabled=t.slicePlaneEnabled}}let xo=class extends ie{get dirty(){return this._dirty}get state(){return this._state}constructor(e){super(e),this._dirty=!1,this._viewState=new xN,this._state=0,this._checkOcclusion=new Map,this._active=new Map,this._checkOcclusionIterator=null,this._activeIterator=null,this._occlusionQueryUids=new Array,this._updatingHandles=new dc,this._deconflictor=new uN((t,i)=>{t.visible=i,this._setGraphicVisibility(this._active.get(t.id),i)},(t,i)=>t.id!==i.id,bN),this._baseOccludedVisibility=10,this._altitudeFactor=2,this._minAltitudeDifference=100}initialize(){this._updatingHandles.add(()=>(this.view?.map?.ground?.opacity??0)>0,()=>this.setDirty()),this._updatingHandles.add(()=>this.view.ready,()=>{this._occlusionQuery=null,this.setDirty()})}destroy(){this._occlusionQuery=null,this._updatingHandles.destroy(),this._deconflictor.destroy(),this._checkOcclusion.clear(),this._active.clear()}setDirty(){!this._dirty&&(this._active.size>0||this._checkOcclusion.size>0)&&(this._dirty=!0,this.notifyChange("_readyToRun"))}setPriority(e,t){const i=this._active.get(e.graphic.uid)?.getInfo(this.visibilityGroup);i&&(i.priority=t)}get _readyToRun(){return this._state!==0||this._dirty}get updating(){return this._readyToRun||this._updatingHandles.updating}get updatingProgress(){if(!this.updating)return 1;const e=this._state/5;return this._dirty?.5*e:e}get readyToRun(){return this.view.ready&&this.view.state!=null&&this._readyToRun}get usedMemory(){return this._occlusionQuery?.usedMemory??0+4*(this._occlusionQueryUids?.length??0)}runTask(e){switch(this._state){case 0:this._startUpdate(),e.madeProgress();case 1:if(this._state=1,!this._processCheckOcclusion(e))return;case 2:if(this._state=2,this._occlusionQuery&&!this._occlusionQuery.done)return Fi;this._readOcclusionQueryResult(),e.madeProgress();case 3:if(this._state=3,!this._collectActiveGraphics(e))return;case 4:if(this._state=4,this._deconflictor.run(e),!this._deconflictor.done)return;default:this._state=0,this.notifyChange("_readyToRun")}}setGraphicsActive(e,t){t?e.forEach(i=>this.addToActiveGraphics(i)):e.forEach(i=>this.removeFromActiveGraphics(i))}layerSupportsDeconfliction(e){if(e==null||e.type!=="object3d")return!1;const t=e.stageObject;return(t?.geometries.length??0)!==1?!1:t?.geometries[0]?.material instanceof z2}_startUpdate(){cN(this.view),this._dirty=!1,this._viewState.copyFrom(this.viewState);const{fullWidth:e,fullHeight:t}=this._viewState.camera;this._deconflictor.reset(e,t),this._resetIterators(),this._occlusionQueryUids.length=0,this._checkOcclusion.size||(this._occlusionQuery=Z(this._occlusionQuery))}addToActiveGraphics(e){e.ensureInfo(this.visibilityGroup),this._active.set(e.graphics3DGraphic.graphic.uid,e),this.setDirty()}removeFromActiveGraphics(e){CN(e,this.visibilityGroup),e.removeInfo(this.visibilityGroup),this._active.delete(e.graphics3DGraphic.graphic.uid),this.setDirty()}addToCheckOcclusion(e){this._checkOcclusion.set(e.graphics3DGraphic.graphic.uid,e),this.setDirty()}removeFromCheckOcclusion(e){this._checkOcclusion.delete(e.graphics3DGraphic.graphic.uid)}_processCheckOcclusion(e){if(this._checkOcclusion.size===0)return!0;const t=this._ensureCheckOcclusionIterator(),i=this._viewState.camera,r=J4(fN,i.viewInverseTransposeMatrix),s=this.view.map.ground.opacity>0,n=this.view.viewingMode==="global"&&s&&i.relativeElevation>0?gN:null;let a=0;n!=null&&(gp(n,ia,i.viewMatrix),n[3]=Yt(this.view.spatialReference).radius,a=bL(n,ia));const o=Rt();for(;;){if(e.done)return!1;e.madeProgress();const l=t.next();if(l.done===!0)break;const c=l.value,u=c.graphics3DGraphic;if(u.destroyed||!u.isVisible(1,8))continue;const p=MN(u,this.visibilityGroup);let m=null,f=!0;for(const g of p){if(!this.layerSupportsDeconfliction(g))continue;m=RN,this._projectHudLayer(g,i,m),zo(o);const y=g.stageObject.geometries[0].material;if(this._expandBoundingRect(o,i,g,y,m),m.isOutsideScreen){f=!1;break}if(this._isCulledBySlice(c,m.positionView)){f=!1;break}if(n!=null&&PN(m,n,a)){f=!1;break}lt(s0,m.positionView,r),m.altitude=this.view.renderCoordsHelper.getAltitude(s0);const v=c.ensureInfo(this.visibilityGroup);if(v.altitude=m.altitude,v.distance=m.distance,v.distanceToOccluder=m.distanceToOccluder,v.culled=!1,Hp(v.aabr,o),y.parameters.occlusionTest)break;this._ensureOcclusionQuery().addPosition(s0)===this._occlusionQueryUids.length&&this._occlusionQueryUids.push(u.graphic.uid);break}if(this._active.has(u.graphic.uid)&&(!f||!m)){const g=c.ensureInfo(this.visibilityGroup);g.visible=!m,g.culled=!0}}return this._checkOcclusionIterator=null,this._occlusionQueryUids.length||(this._occlusionQuery=Z(this._occlusionQuery)),this._occlusionQuery?.start(),!0}_readOcclusionQueryResult(){if(!this._occlusionQuery||!this._occlusionQueryUids.length)return;const e=this._viewState.camera,t=this.view.renderCoordsHelper.getAltitude(e.eye);for(let i=0;i<this._occlusionQueryUids.length;i++){const r=this._occlusionQueryUids[i],s=this._checkOcclusion.get(r);if(!s)continue;const n=this._occlusionQuery.getOcclusion(i)??-1,a=s.getInfo(this.visibilityGroup);a&&(a.distanceToOccluder=n>0?a.distance-n:0);const o=n<=0||this._occludedVisibility(a?.distanceToOccluder??0,a?.distance??n,a?.altitude??0,t);this._active.has(r)?a&&(a.culled=!o,a.visible=o):this._setGraphicVisibility(s,o)}this._occlusionQueryUids.length=0}_collectActiveGraphics(e){const t=this._ensureActiveGraphicsIterator(),i=this.visibilityGroup===16;for(;!e.done;){e.madeProgress();const r=t.next();if(r.done===!0)return this._activeIterator=null,!0;const s=r.value,n=s.getInfo(this.visibilityGroup);n&&(!(!i||s.graphics3DGraphic.isVisible())||n.culled?(PD(n.aabr,!1,!0),this._setGraphicVisibility(s,n.visible)):this._deconflictor.add(n))}return!1}_occludedVisibility(e,t,i,r){const s=Math.max(this._minAltitudeDifference,Math.abs(i-r))-this._minAltitudeDifference;return e===0||t-e<=this._baseOccludedVisibility+this._altitudeFactor*s}_resetIterators(){this._checkOcclusionIterator=null,this._activeIterator=null}_ensureCheckOcclusionIterator(){return this._checkOcclusionIterator??=this._checkOcclusion.values(),this._checkOcclusionIterator}_ensureActiveGraphicsIterator(){return this._activeIterator??=this._active.values(),this._activeIterator}_ensureOcclusionQuery(){return this._occlusionQuery??=new Cl({view:this.view}),this._occlusionQueryUids.length||this._occlusionQuery.init(this._checkOcclusion.size,this._viewState.camera.eye),this._occlusionQuery}_projectHudLayer(e,t,i){const r=e.stageObject,s=r.geometries[0],n=s.material;lt(da,Gi(r.boundingVolumeWorldSpace.bounds),t.viewMatrix);const a=s.attributes,o=a.get("normal").data,l=a.get("centerOffsetAndDistance").data;n.applyShaderOffsetsView(da,o,r.transformation,l,t,i.screenSizePerspectiveEvaluators,da),cr(Ac,da[0],da[1],da[2],1),Bg(zu,Ac,t.projectionMatrix),te(i.positionNDC,zu,1/zu[3]),n.applyShaderOffsetsNDC(i.positionNDC,l,t,i.positionNDC,n0),i.distanceWithoutPolygonOffset=t.depthNDCToWorld(n0[2]),i.distance=n0[2]===i.positionNDC[2]?i.distanceWithoutPolygonOffset:t.depthNDCToWorld(i.positionNDC[2]),cr(zu,i.positionNDC[0],i.positionNDC[1],i.positionNDC[2],1),Bg(Ac,zu,t.inverseProjectionMatrix),X2(Ac,Ac,1/Ac[3]),xe(i.positionView,da[0],da[1],da[2])}_isCulledBySlice(e,t){return e.slicePlaneEnabled&&this._viewState.slicePlaneEnabled&&j4(this._viewState.slicePlane,t)}_expandBoundingRect(e,t,i,r,{positionNDC:s,screenSizePerspectiveEvaluators:n}){const a=i.getScreenSize(SN);n.evaluator.applyVec2(a,a),a[0]*=t.pixelRatio,a[1]*=t.pixelRatio;const o=Lg(r.calculateRelativeScreenBounds(a,n.alignmentEvaluator.apply(t.pixelRatio),yN),De(0,t.fullWidth,.5+.5*s[0]),De(0,t.fullHeight,.5+.5*s[1])),l=this.marginFactor;if(l!==0){const c=l*Math.min(ds(o),Kn(o));o[0]-=c,o[1]-=c,o[2]+=c,o[3]+=c}Nh(e,o,e)}_setGraphicVisibility(e,t){const i=e?.graphics3DGraphic;i&&!i.destroyed&&(i.setVisibilityFlag(this.visibilityGroup,8,t),this.visibilityGroup===16&&this.view.labeler.setLabelGraphicVisibility(i,t))}};function CN(e,t){const i=e.graphics3DGraphic;i.destroyed||i.setVisibilityFlag(t,8,!0)}h([d({constructOnly:!0})],xo.prototype,"view",void 0),h([d({type:Boolean,readOnly:!0})],xo.prototype,"_readyToRun",null),h([d({type:Boolean,readOnly:!0})],xo.prototype,"updating",null),h([d({readOnly:!0})],xo.prototype,"_updatingHandles",void 0),xo=h([D("esri.views.3d.layers.graphics.Deconflictor")],xo);const SN=ze();class TN{constructor(){this.positionView=w(),this.positionNDC=w(),this.altitude=0,this.distance=0,this.distanceToOccluder=0,this.distanceWithoutPolygonOffset=0,this.screenSizePerspectiveEvaluators=new y8}get isOutsideScreen(){const t=this.positionNDC;return t[0]<-1||t[1]<-1||t[2]<-1||t[0]>=1||t[1]>=1||t[2]>=1}}function PN(e,t,i){return q(a0.direction,e.positionView),xe(a0.origin,0,0,0),!!F_(t,a0,_N)&&e.distanceWithoutPolygonOffset>i}function MN(e,t){return t===16?e.labelLayers:e.layers}const RN=new TN,DN=2e3;let Jf=class extends xo{constructor(e){super(e),this.visibilityGroup=16,this.marginFactor=.05,this._lastDeconfliction=0}get viewState(){return this.parent.viewState}runTask(e){if(this.parent.readyToRun)return Fi;const t=performance.now();if(this.view.state.mode!==2&&t-this._lastDeconfliction<DN)return Fi;const i=super.runTask(e);return this.state===0&&(this._lastDeconfliction=t),i}};h([d({constructOnly:!0})],Jf.prototype,"parent",void 0),Jf=h([D("esri.views.3d.layers.graphics.LabelDeconflictor")],Jf);let I1=class extends xo{constructor(){super(...arguments),this._contexts=new Map,this.visibilityGroup=1,this._marginFactor=-.1,this.test={overrideMarginFactor:e=>{this._marginFactor=e,this.setDirty()}}}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this._updatingHandles.add(()=>this.view?.state?.camera,()=>{this._updateViewState(),this.setDirty()}),this._updatingHandles.add(()=>this.view?.slice?.plane,()=>{this._updateSlicePlane(),this._slicePlaneChanged(),this.setDirty()},Ee),this.addHandles(M(()=>this.view.basemapTerrain?.updating||this.view.graphicsView?.updating||this.view.allLayerViews.some(e=>e.updating),(e,t)=>{!e&&t&&this.setDirty()},Ie)),this._frameTask=this.view.resourceController.scheduler.registerTask(mi.GRAPHICS_DECONFLICTOR,this),this._labels=new Jf({view:this.view,parent:this})}destroy(){this._labels=Z(this._labels),this._frameTask=xi(this._frameTask)}get marginFactor(){return this._marginFactor}get usedMemory(){return super.usedMemory+this._labels.usedMemory}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty())}runTask(e){const t=super.runTask(e);return this.readyToRun||this._labels.setDirty(),t}_updateViewState(){this.view?.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this._updateSlicePlane())}_updateSlicePlane(){const e=this.view?.slice?.plane;e!=null&&aI(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=e!=null}_slicePlaneChanged(){for(const e of this._contexts.keys())if(e.symbolCreationContext.slicePlaneEnabled)return void this.setDirty()}addGraphicsOwner(e){const t=this._getGraphicsContext(e);return{addGraphic:i=>this._addGraphic(e,t,i),removeGraphic:i=>this._removeGraphic(t,i),labelingInfoChange:()=>this._labelsEnabledChanged(e,t),featureReductionChange:()=>this._enabledChanged(e,t),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(e,t),screenSizePerspectiveEnabledChanged:()=>this._screenSizePerspectiveEnabledChange(),clear:()=>t.forEach(i=>this._removeGraphic(t,i.graphics3DGraphic)),remove:()=>this._removeGraphicsOwner(e),setDirty:()=>this.setDirty()}}_removeGraphicsOwner(e){const t=this._contexts.get(e);t&&(t.forEach(i=>this._removeGraphic(t,i.graphics3DGraphic)),this._contexts.delete(e),this.setDirty())}_addGraphic(e,t,i){const r=i.graphic.uid,s=new wN(i,e.symbolCreationContext.slicePlaneEnabled);t.set(r,s),this.addToCheckOcclusion(s),o0(e)&&this.addToActiveGraphics(s),e.labelsEnabled&&(this._labels.addToCheckOcclusion(s),this._labels.addToActiveGraphics(s));const n=!this._graphicSupportsDeconfliction(i)||!o0(e);i.setVisibilityFlag(1,8,n)}_removeGraphic(e,t){const i=t.graphic.uid,r=e.get(i);r&&(this.removeFromActiveGraphics(r),this.removeFromCheckOcclusion(r),this._labels.removeFromActiveGraphics(r),this._labels.removeFromCheckOcclusion(r),e.delete(i),this.setDirty())}_enabledChanged(e,t){o0(e)?t.forEach(i=>this.addToActiveGraphics(i)):(t.forEach(i=>this.removeFromActiveGraphics(i)),ON(e))}_labelsEnabledChanged(e,t){e.labelsEnabled?(t.forEach(i=>this._labels.addToCheckOcclusion(i)),t.forEach(i=>this._labels.addToActiveGraphics(i))):(t.forEach(i=>this._labels.removeFromCheckOcclusion(i)),t.forEach(i=>this._labels.removeFromActiveGraphics(i)))}_slicePlaneEnabledChanged(e,t){const i=e.symbolCreationContext.slicePlaneEnabled;t.forEach(r=>r.slicePlaneEnabled=i),this.setDirty()}_screenSizePerspectiveEnabledChange(){this.setDirty()}_graphicSupportsDeconfliction(e){if(e.isDraped)return!1;const t=e.layers;if(!t?.length)return!1;for(const i of t)if(this.layerSupportsDeconfliction(i))return!0;return!1}_getGraphicsContext(e){const t=this._contexts.get(e);if(t)return t;const i=new Map;return this._contexts.set(e,i),this.setDirty(),i}};function o0(e){const t=e.layer;return!(!t?.featureReduction||t.featureReduction.type!=="selection")}function ON(e){const t=e.graphics3DGraphics;t&&t.forEach(i=>i.setVisibilityFlag(1,8,!0))}I1=h([D("esri.views.3d.layers.graphics.GraphicsDeconflictor")],I1);let EN=class{constructor(e,t){this.renderer=e,this.symbol=t,this.color=null,this.size=null,this.opacity=null,this.outlineSize=null,this.heading=null,this.tilt=null,this.roll=null}};function Wre(e,t,i,r,s,n,a,o,l,c,u){const p=kN[u.mode];let m,f,g=0;if(oa(e,t,i,r,l.spatialReference,s,o))return p?.requiresAlignment(u)?(g=p.applyElevationAlignmentBuffer(r,s,n,a,o,l,c,u),m=n,f=a):(m=r,f=s),oa(m,l.spatialReference,f,n,c.spatialReference,a,o)?g:void 0}function Ob(e,t,i,r,s){const n=(B4(e)?e.z:QM(e)?e.array[e.offset+2]:e[2])||0;switch(i.mode){case"on-the-ground":{const a=Jn(t,e,"ground")??0;return s.verticalDistanceToGround=0,s.sampledElevation=a,void(s.z=a)}case"relative-to-ground":{const a=Jn(t,e,"ground")??0,o=i.geometryZWithOffset(n,r);return s.verticalDistanceToGround=o,s.sampledElevation=a,void(s.z=o+a)}case"relative-to-scene":{const a=Jn(t,e,"scene")??0,o=i.geometryZWithOffset(n,r);return s.verticalDistanceToGround=o,s.sampledElevation=a,void(s.z=o+a)}case"absolute-height":{const a=i.geometryZWithOffset(n,r),o=Jn(t,e,"ground")??0;return s.verticalDistanceToGround=a-o,s.sampledElevation=o,void(s.z=a)}default:return void(s.z=0)}}function Zre(e,t,i,r){return Ob(e,t,i,r,Oh),Oh.z}function AN(e,t,i){return t==="on-the-ground"&&i==="on-the-ground"?e.staysOnTheGround:t===i||t!=="on-the-ground"&&i!=="on-the-ground"?t==null||i==null?e.definedChanged:1:e.onTheGroundChanged}function d3(e){return e==="relative-to-ground"||e==="relative-to-scene"}function Qre(e){return e!=="absolute-height"}function MD(e,t,i,r,s){Ob(t,i,s,r,Oh),RD(e,Oh.verticalDistanceToGround);const n=Oh.sampledElevation,a=ks(BN,e.transformation);return qm[0]=t.x,qm[1]=t.y,qm[2]=Oh.z,V_(t.spatialReference,qm,a,r.spatialReference)?e.transformation=a:console.warn("Could not locate symbol object properly, it might be misplaced"),n}function RD(e,t){for(let i=0;i<e.geometries.length;++i){const r=e.geometries[i].getMutableAttribute("centerOffsetAndDistance");r&&r.data[3]!==t&&(r.data[3]=t,e.geometryVertexAttributeUpdated(e.geometries[i],"centerOffsetAndDistance"))}}function IN(e,t,i,r,s,n){let a=0;const o=n.spatialReference;t*=3,r*=3;for(let l=0;l<s;++l){const c=e[t],u=e[t+1],p=e[t+2],m=n.getElevation(c,u,p,o,"ground")??0;a+=m,i[r]=c,i[r+1]=u,i[r+2]=m,t+=3,r+=3}return a/s}function LN(e,t,i,r,s,n,a,o){let l=0;const c=o.calculateOffsetRenderUnits(a),u=o.featureExpressionInfoContext,p=n.spatialReference;t*=3,r*=3;for(let m=0;m<s;++m){const f=e[t],g=e[t+1],y=e[t+2],v=n.getElevation(f,g,y,p,"ground")??0;l+=v,i[r]=f,i[r+1]=g,i[r+2]=u==null?y+v+c:v+c,t+=3,r+=3}return l/s}function FN(e,t,i,r,s,n,a,o){let l=0;const c=o.calculateOffsetRenderUnits(a),u=o.featureExpressionInfoContext,p=n.spatialReference;t*=3,r*=3;for(let m=0;m<s;++m){const f=e[t],g=e[t+1],y=e[t+2],v=n.getElevation(f,g,y,p,"scene")??0;l+=v,i[r]=f,i[r+1]=g,i[r+2]=u==null?y+v+c:v+c,t+=3,r+=3}return l/s}function VN(e){const t=e.meterUnitOffset,i=e.featureExpressionInfoContext;return t!==0||i!=null}function zN(e,t,i,r,s,n,a,o){const l=o.calculateOffsetRenderUnits(a),c=o.featureExpressionInfoContext;t*=3,r*=3;for(let u=0;u<s;++u){const p=e[t],m=e[t+1],f=e[t+2];i[r]=p,i[r+1]=m,i[r+2]=c==null?f+l:l,t+=3,r+=3}return 0}let DD=class{constructor(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}};const kN={"absolute-height":{applyElevationAlignmentBuffer:zN,requiresAlignment:VN},"on-the-ground":{applyElevationAlignmentBuffer:IN,requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:LN,requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:FN,requiresAlignment:()=>!0}},BN=Le(),Oh=new DD,qm=w();function OD(e){return e.mapPositions!=null}function Xre(e,t,i,r,s){const n=e.stageObject,a=n.geometries;let o=0;for(const l of a){if(!OD(l))continue;const{update:c,averageGeometrySampledElevation:u}=AD(l,t,i,r,s);o+=u,c&&n.geometryVertexAttributeUpdated(l,"position")}return o/a.length}function NN(e,t,i,r,s,n){const a=e.stageObject,o=t.centerInElevationSR;let l=0;r(o,Gr),a.usesVerticalDistanceToGround?(RD(a,Gr.verticalDistanceToGround),l=Gr.sampledElevation):t.mode!=="absolute-height"&&(l=Gr.sampledElevation);const c=ks(jN,n??a.transformation),u=xe(ED,c[12],c[13],c[14]);bi.TESTS_DISABLE_OPTIMIZATIONS?(Dr[0]=o[0],Dr[1]=o[1],Dr[2]=Gr.z,V_(i,Dr,c,s.spatialReference)&&(n?ks(n,c):a.transformation=c)):s.setAltitudeOfTransformation(Gr.z,c);const p=Eb/s.unitInMeters;return(Math.abs(c[12]-u[0])>=p||Math.abs(c[13]-u[1])>=p||Math.abs(c[14]-u[2])>=p)&&(n?ks(n,c):a.transformation=c),l}const jN=Le();function Yre(e,t,i,r,s){const n=e.graphics3DSymbolLayer.lodRenderer;if(n==null)return 0;const a=t.centerInElevationSR;r(a,Gr);const o=t.mode!=="absolute-height"?Gr.sampledElevation:0,l=n.instanceData,c=e.instanceIndex,u=UN;l.getGlobalTransform(c,u);const p=xe(ED,u[12],u[13],u[14]);bi.TESTS_DISABLE_OPTIMIZATIONS?(Dr[0]=a[0],Dr[1]=a[1],Dr[2]=Gr.z,V_(i,Dr,u,s.spatialReference)&&l.setGlobalTransform(c,u)):s.setAltitudeOfTransformation(Gr.z,u);const m=Eb/s.unitInMeters;return(bi.TESTS_DISABLE_OPTIMIZATIONS||Math.abs(u[12]-p[0])>=m||Math.abs(u[13]-p[1])>=m||Math.abs(u[14]-p[2])>=m)&&l.setGlobalTransform(c,u),o}function Kre(e,t,i,r,s){const n=e.stageObject,a=n.geometries;if(a.length===0)return 0;let o=0,l=null,c=0,u=!1;for(const p of a){if(!OD(p))continue;const m=p.attributes.get("position");if(m!==l){const{update:f,averageGeometrySampledElevation:g}=AD(p,t,i,r,s);c=g,l=m,u=f}u&&n.geometryVertexAttributeUpdated(p,"position"),o+=c}return o/a.length}const Eb=.01,Dr=w(),vs=w(),Ic=w(),UN=Le(),ED=w(),Gr=new DD;function AD(e,t,i,r,s){let n=!1;const a=e.transformation,o=t.requiresSampledElevationInfo;vs[0]=a[12],vs[1]=a[13],vs[2]=a[14],e.invalidateBoundingInfo();const l=e.getMutableAttribute("position"),c=l.data,u=l.size,p=c.length/u,m=new m7(e.mapPositions,i);let f=0,g=0;for(let y=0;y<p;y++){if(Ic[0]=c[f],Ic[1]=c[f+1],Ic[2]=c[f+2],r(m,Gr),o&&(g+=Gr.sampledElevation),bi.TESTS_DISABLE_OPTIMIZATIONS)c[f]=m.array[m.offset],c[f+1]=m.array[m.offset+1],c[f+2]=Gr.z,oa(c,i,f,c,s.spatialReference,f,1),c[f]-=vs[0],c[f+1]-=vs[1],c[f+2]-=vs[2],n=!0;else{Dr[0]=c[f]+vs[0],Dr[1]=c[f+1]+vs[1],Dr[2]=c[f+2]+vs[2],s.setAltitude(Dr,Gr.z),c[f]=Dr[0]-vs[0],c[f+1]=Dr[1]-vs[1],c[f+2]=Dr[2]-vs[2];const v=Eb/s.unitInMeters;(Math.abs(Ic[0]-c[f])>=v||Math.abs(Ic[1]-c[f+1])>=v||Math.abs(Ic[2]-c[f+2])>=v)&&(n=!0)}f+=u,m.offset+=3}return g/=p,{update:n,averageGeometrySampledElevation:g}}let HN=class{constructor(e,t,i){this.graphic=e,this.renderingInfo=t,this.layer=i}},Jre=class{constructor(e,t,i){this.baseMaterial=e,this.edgeMaterial=t,this.hasSlicePlane=i}},ID=class{get isElevationSource(){return!!this.stageObject.lastValidElevationBB}constructor(e,t,i,r,s,n=null){this.graphics3DSymbolLayer=e,this.stageObject=t,this._sharedResource=i,this.elevationAligner=r,this.elevationContext=s,this._edgeState=n,this.type="object3d",this._stageLayer=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.useObjectOriginAsAttachmentOrigin=!1}initialize(e){this._stageLayer=e}destroy(){if(!this._stageLayer)return;const e=this._stageLayer.stage;this._addedToStage&&(this._stageLayer.remove(this.stageObject),this._addedToStage=!1),e.renderer.edgeView?.removeObject(this.stageObject),this.stageObject.dispose(),this._sharedResource?.release(),this._visible=!1,this._stageLayer=null}get usedMemory(){return this.graphics3DSymbolLayer.usedMemory}layerOpacityChanged(e,t){const{stageObject:i,_edgeState:r,_stageLayer:s}=this;if(r==null)return;const n=p3(r.baseMaterial);r.edgeMaterial.objectTransparency!==n&&(r.edgeMaterial.objectTransparency=n,this.resetEdgeObject(t)),s.stage.renderer.withEdgeView(a=>a.updateAllComponentOpacities(i,[e]))}updateHighlights(e){}slicePlaneEnabledChanged(e,t){const{stageObject:i,_edgeState:r,_stageLayer:s}=this;r!=null&&s.stage.renderer.withEdgeView(n=>{n.updateAllComponentMaterials(i,r.edgeMaterial,e,!t),r.hasSlicePlane=e})}setVisibility(e){const{_edgeState:t,stageObject:i,_stageLayer:r}=this;r!=null&&this.visible!==e&&(this._visible=e,i.visible=e,e&&!this._addedToStage&&(r.add(i),this._addedToStage=!0),t!=null&&r.stage.renderer.withEdgeView(s=>{s.hasObject(i)?s.updateObjectVisibility(i,e):e&&this._addOrUpdateEdgeObject(t,s,!1)}))}get visible(){return this._visible}alignWithElevation(e,t,i){if(this.elevationAligner==null)return;const r=(s,n)=>Ob(s,e,this.elevationContext,t,n);this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,e.spatialReference,r,t),this.resetEdgeObject(i)}alignWithAbsoluteElevation(e,t,i){const r=(s,n)=>{n.sampledElevation=e,n.verticalDistanceToGround=0,n.z=e};this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,this.graphics3DSymbolLayer.view.spatialReference,r,t),this.resetEdgeObject(i)}getCenterObjectSpace(e=w()){return q(e,Gi(this.stageObject.boundingVolumeObjectSpace.bounds))}getBoundingBoxObjectSpace(e=eo()){const t=this.stageObject.boundingVolumeObjectSpace;return zL(e,t.min),kL(e,t.max),e}computeAttachmentOrigin(e){const t=this.stageObject.effectiveTransformation;if(this.useObjectOriginAsAttachmentOrigin)e.render.origin[0]+=t[12],e.render.origin[1]+=t[13],e.render.origin[2]+=t[14],e.render.num++;else for(const i of this.stageObject.geometries)i.computeAttachmentOrigin(pa)&&(lt(pa,pa,t),ce(e.render.origin,e.render.origin,pa),e.render.num++)}async getProjectedBoundingBox(e,t,i,r,s){const n=this.getBoundingBoxObjectSpace(s),a=qN,o=dM(n)?1:a.length;for(let c=0;c<o;c++){const u=a[c];oo[0]=n[u[0]],oo[1]=n[u[1]],oo[2]=n[u[2]],lt(oo,oo,this.stageObject.transformation),sl[3*c]=oo[0],sl[3*c+1]=oo[1],sl[3*c+2]=oo[2]}if(!e(sl,0,o))return null;Gs(n);let l=null;this.calculateRelativeScreenBounds&&(l=this.calculateRelativeScreenBounds());for(let c=0;c<3*o;c+=3){for(let u=0;u<3;u++)n[u]=Math.min(n[u],sl[c+u]),n[u+3]=Math.max(n[u+3],sl[c+u]);l&&i.push({location:sl.slice(c,c+3),screenSpaceBoundingRect:l})}if(t?.service&&this.elevationContext.mode!=="absolute-height"){K2(n,pa);const c=this.elevationContext.mode==="relative-to-scene"?"scene":"ground";let u=0;if(t.useViewElevation)u=t.service.getElevation(pa[0],pa[1],c)??0;else try{const p=tI(n,t.service.spatialReference,t);u=await t.service.queryElevation(pa[0],pa[1],r,p,c)??0}catch{}BL(n,0,0,-this.alignedSampledElevation+u)}return n}addObjectState(e){e.stateType===0&&e.addObject(this.stageObject,this.stageObject.highlight(e.highlightName)),e.stateType===1&&e.addObject(this.stageObject,this.stageObject.maskOccludee())}removeObjectState(e){e.removeByObject(this.stageObject)}resetEdgeObject(e){const{_edgeState:t,stageObject:i,_stageLayer:r,_visible:s}=this;t!=null&&r.stage.renderer.withEdgeView(n=>{s?this._addOrUpdateEdgeObject(t,n,e):n.removeObject(i)})}_addOrUpdateEdgeObject(e,t,i){const r=p3(e.baseMaterial);e.edgeMaterial.objectTransparency=r,t.addOrUpdateObject3D(this.stageObject,e.edgeMaterial,e.hasSlicePlane,!i).then(()=>this._stageLayer?.sync())}};function p3(e){return e.transparent?0:1}const sl=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],oo=w(),pa=w(),qN=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];let GN=class{constructor(e,t=null){this.labelText=t,this.elevationOffset=e??0}};const $N=3,WN=3,ZN=10;let Ds=class{constructor(e){this.estimated=!1,this.verticesPerFeature=e.verticesPerFeature??0,this.verticesPerCoordinate=e.verticesPerCoordinate??0,this.drawCallsPerFeature=e.drawCallsPerFeature??0,this.memory=e.memory??new LD}},Ab=class extends Ds{constructor(e){super(e),this.estimated=!0}},QN=class extends Ds{constructor(e,t){super(t),this.numComplexities=e}},XN=class extends Ab{constructor(e,t){super(t),this.numComplexities=e}},LD=class{constructor(){this.bytesPerFeature=0,this.bytesPerFeatureLabel=0,this.resourceBytes=0,this.draped={bytesPerFeature:0,bytesPerFeatureLabel:0}}};const FD=new Ab({});function ese(e){return e.type==="web-style"?FD:Ib(e.symbolLayers.toArray().map(t=>VD(e,t)))}function Ib(e){let t=0,i=0,r=0,s=!1,n=0;const a=new LD;for(const o of e)o!=null&&(t+=o.verticesPerFeature,i+=o.verticesPerCoordinate,r+=o.drawCallsPerFeature,a.bytesPerFeature+=o.memory.bytesPerFeature,a.bytesPerFeatureLabel+=o.memory.bytesPerFeatureLabel,a.resourceBytes+=o.memory.resourceBytes,a.draped.bytesPerFeature+=o.memory.bytesPerFeature,a.draped.bytesPerFeatureLabel+=o.memory.bytesPerFeatureLabel,s=s||o.estimated,++n);return s?new XN(n,{verticesPerFeature:t,verticesPerCoordinate:i,drawCallsPerFeature:r,memory:a}):new QN(n,{verticesPerFeature:t,verticesPerCoordinate:i,drawCallsPerFeature:r,memory:a})}function tse(e){const t=Ib(e);return t.numComplexities>0&&(t.verticesPerFeature/=t.numComplexities,t.verticesPerCoordinate/=t.numComplexities,t.drawCallsPerFeature/=t.numComplexities,t.memory.bytesPerFeature/=t.numComplexities,t.memory.bytesPerFeatureLabel/=t.numComplexities,t.memory.resourceBytes/=t.numComplexities,t.memory.draped.bytesPerFeature/=t.numComplexities,t.memory.draped.bytesPerFeatureLabel/=t.numComplexities),t}const l0={};function VD(e,t){const i=YN(e,t),r=hF(t)?2:0;switch(t.type){case"extrude":return new Ds({verticesPerFeature:-12,verticesPerCoordinate:12,drawCallsPerFeature:r,memory:i});case"fill":if(e.type==="mesh-3d")return new Ds({drawCallsPerFeature:r,memory:i});if(t.outline!=null&&t.outline.size>0)return new Ds({verticesPerFeature:-12,verticesPerCoordinate:9,memory:i});case"water":return new Ds({verticesPerFeature:-6,verticesPerCoordinate:3,memory:i});case"line":return new Ds({verticesPerFeature:-6,verticesPerCoordinate:6,memory:i});case"object":return t.resource?.href?new Ab({verticesPerFeature:100,memory:i}):{...KN(t.resource?.primitive??aF),memory:i};case"path":{let s=0,n=0;switch(t.profile){case"circle":s=ZN;break;case"quad":s=4;break;default:return void na(t.profile)}switch(t.join){case"round":n=$N;break;case"miter":case"bevel":n=1;break;default:return}const a=2*s,o=s*n*2,l=o+a;let c=-2*o-a;switch(t.cap){case"none":break;case"butt":case"square":c+=2*(s-1);break;case"round":c+=2*(s*(WN-1)*2+s);break;default:return}return new Ds({verticesPerFeature:c,verticesPerCoordinate:l,memory:i})}case"text":{const s=e.type==="label-3d"?0:2;return new Ds({verticesPerFeature:6,memory:i,drawCallsPerFeature:s})}case"icon":return new Ds({verticesPerFeature:6,memory:i});default:return}}function YN(e,t){const i=e.type==="point-3d";switch(t.type){case"extrude":return t.edges&&t.edges.size>0?Qi.EXTRUDE_EDGES:Qi.EXTRUDE;case"fill":return t.outline!=null&&t.outline.size>0?Qi.FILL_OUTLINE:Qi.FILL;case"water":return Qi.FILL;case"line":return t.join==="round"?Qi.LINE_ROUND:Qi.LINE_MITER;case"path":switch(t.join){case"round":switch(t.profile){case"circle":return Qi.PATH_ROUND_CIRCLE;case"quad":return Qi.PATH_ROUND_QUAD;default:return void na(t.profile)}case"miter":case"bevel":switch(t.profile){case"circle":return Qi.PATH_MITER_CIRCLE;case"quad":return Qi.PATH_MITER_QUAD;default:return void na(t.profile)}default:return}case"object":return i?Qi.OBJECT_POINT:Qi.OBJECT_POLYGON;case"icon":case"text":return i?Qi.ICON_POINT:Qi.ICON_POLYGON;default:return}}function KN(e){const t=l0[e];if(t)return t;const i=JN(nI(e,new $A({},{spherical:!0})).levels);return l0[e]=new Ds({verticesPerFeature:i}),l0[e]}function JN(e){return e.reduce((t,i,r)=>t+i.numVertices*(1/10**r),0)/e.reduce((t,i,r)=>t+1/10**r,0)}const Qi={ICON_POINT:{bytesPerFeature:2658,bytesPerFeatureLabel:3484,resourceBytes:0,draped:{bytesPerFeature:1845,bytesPerFeatureLabel:3498}},ICON_POLYGON:{bytesPerFeature:3086,bytesPerFeatureLabel:2996,resourceBytes:0,draped:{bytesPerFeature:2694,bytesPerFeatureLabel:3014}},OBJECT_POINT:{bytesPerFeature:497,bytesPerFeatureLabel:2933,resourceBytes:0,draped:{bytesPerFeature:497,bytesPerFeatureLabel:2933}},OBJECT_POLYGON:{bytesPerFeature:867,bytesPerFeatureLabel:2491,resourceBytes:0,draped:{bytesPerFeature:867,bytesPerFeatureLabel:2491}},LINE_MITER:{bytesPerFeature:2337,bytesPerFeatureLabel:2658,resourceBytes:0,draped:{bytesPerFeature:1864,bytesPerFeatureLabel:2656}},LINE_ROUND:{bytesPerFeature:2341,bytesPerFeatureLabel:2672,resourceBytes:0,draped:{bytesPerFeature:1873,bytesPerFeatureLabel:2643}},PATH_MITER_CIRCLE:{bytesPerFeature:22374,bytesPerFeatureLabel:2558,resourceBytes:0,draped:{bytesPerFeature:22374,bytesPerFeatureLabel:2558}},PATH_ROUND_CIRCLE:{bytesPerFeature:24004,bytesPerFeatureLabel:2598,resourceBytes:0,draped:{bytesPerFeature:24004,bytesPerFeatureLabel:2598}},PATH_MITER_QUAD:{bytesPerFeature:24040,bytesPerFeatureLabel:2940,resourceBytes:0,draped:{bytesPerFeature:24040,bytesPerFeatureLabel:2940}},PATH_ROUND_QUAD:{bytesPerFeature:23088,bytesPerFeatureLabel:2886,resourceBytes:0,draped:{bytesPerFeature:23088,bytesPerFeatureLabel:2886}},FILL:{bytesPerFeature:3059,bytesPerFeatureLabel:2838,resourceBytes:0,draped:{bytesPerFeature:2352,bytesPerFeatureLabel:2808}},FILL_OUTLINE:{bytesPerFeature:3093,bytesPerFeatureLabel:2632,resourceBytes:0,draped:{bytesPerFeature:2480,bytesPerFeatureLabel:2601}},EXTRUDE:{bytesPerFeature:5075,bytesPerFeatureLabel:2559,resourceBytes:0,draped:{bytesPerFeature:5075,bytesPerFeatureLabel:2559}},EXTRUDE_EDGES:{bytesPerFeature:2843,bytesPerFeatureLabel:2139,resourceBytes:0,draped:{bytesPerFeature:2843,bytesPerFeatureLabel:2139}}};if(Qe("esri-tests-disable-symbol-memory-estimators"))for(const e in Qi){const t=Qi[e];t.bytesPerFeature=0,t.bytesPerFeatureLabel=0,t.draped.bytesPerFeature=0,t.draped.bytesPerFeatureLabel=0}const ej=()=>$.getLogger("esri.views.3d.layers.graphics.featureExpressionInfoUtils");function tj(e){return{cachedResult:e.cachedResult,arcade:e.arcade?{func:e.arcade.func,context:e.arcade.modules.arcadeUtils.createExecContext(null,{sr:e.arcade.context.spatialReference}),modules:e.arcade.modules}:null}}function ise(e){const t=e?.expression;if(typeof t=="string"){const i=kD(t);if(i!=null)return{cachedResult:i}}return null}async function rse(e,t,i,r){const s=e?.expression;if(typeof s!="string")return null;const n=kD(s);if(n!=null)return{cachedResult:n};const a=await F9();qe(i);const o=a.arcadeUtils,l=o.createSyntaxTree(s);return o.dependsOnView(l)?(r?.error("Expressions containing '$view' are not supported on ElevationInfo"),{cachedResult:0}):{arcade:{func:o.createFunction(l),context:o.createExecContext(null,{sr:t}),modules:a}}}function ij(e,t,i){return e.arcadeUtils.createFeature(t.attributes,t.geometry,i)}function rj(e,t){if(e!=null&&!zD(e)){if(!t||!e.arcade)return void ej().errorOncePerTick("Arcade support required but not provided");const i=t;i._geometry&&(i._geometry=sI(i._geometry)),e.arcade.modules.arcadeUtils.updateExecContext(e.arcade.context,t)}}function sj(e){if(e!=null){if(zD(e))return e.cachedResult;const t=e.arcade;let i=t?.modules.arcadeUtils.executeFunction(t.func,t.context);return typeof i!="number"&&(e.cachedResult=0,i=0),i}return 0}function sse(e,t=!1){let i=e?.featureExpressionInfo;const r=i?.expression;return t||r==="0"||(i=null),i??null}const nj={cachedResult:0};function zD(e){return e.cachedResult!=null}function kD(e){return e==="0"?0:null}let m3=class BD{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit="meters",this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.mode=null,this.centerInElevationSR=null}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(t){this._unit=t,this._metersPerElevationInfoUnit=yM(t)}get requiresSampledElevationInfo(){return this.mode!=="absolute-height"}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit="meters"}set offsetMeters(t){this._meterUnitOffset=t,this._renderUnitOffset=0}set offsetElevationInfoUnits(t){this._meterUnitOffset=t*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}addOffsetRenderUnits(t){this._renderUnitOffset+=t}geometryZWithOffset(t,i){const r=this.calculateOffsetRenderUnits(i);return this.featureExpressionInfoContext!=null?r:t+r}calculateOffsetRenderUnits(t){let i=this._meterUnitOffset;const r=this.featureExpressionInfoContext;return r!=null&&(i+=sj(r)*this._metersPerElevationInfoUnit),i/t.unitInMeters+this._renderUnitOffset}setFromElevationInfo(t){this.mode=t.mode,this.unit=fF(t.unit)?t.unit:"meters",this.offsetElevationInfoUnits=t.offset??0}setFeatureExpressionInfoContext(t){this._featureExpressionInfoContext=t}updateFeatureExpressionInfoContextForGraphic(t,i,r){t.arcade?(this._featureExpressionInfoContext=tj(t),this.updateFeatureExpressionFeature(i,r)):this._featureExpressionInfoContext=t}updateFeatureExpressionFeature(t,i){const r=this.featureExpressionInfoContext;r?.arcade&&(r.cachedResult=void 0,rj(this._featureExpressionInfoContext,t.geometry?ij(r.arcade.modules,t,i):null))}static fromElevationInfo(t){const i=new BD;return t!=null&&i.setFromElevationInfo(t),i}},Lb=class{constructor(e){this.schedule=e,this._abortController=null,this._loadStatus=0,this._loadError=null,this._loader=null,this.logger=null}destroy(){this.abortLoad()}get loadStatus(){return this._loadStatus}load(e,t){return this._loadStatus===1?(e&&e(),this._loader??Promise.resolve()):this._loadStatus===2?(t&&t(this._loadError),this._loader??Promise.resolve()):(this._loader==null&&(this._abortController=new AbortController,this._loader=this.doLoad(this._abortController.signal).then(()=>{this._abortController=null,this._loadStatus=1},i=>{throw this._loadError=i,this._abortController=null,this._loadStatus=2,!js(i)&&this.logger&&i.message&&this.logger.warn(i.message),i})),this._loader.then(e,t).catch(()=>{}),this._loader)}abortLoad(){this._abortController!=null?this._abortController=Ar(this._abortController):this._loadStatus===0&&(this._loadStatus=2),this._loader=null}};const nl=()=>$.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer");let aj=class extends Lb{constructor(e,t,i,r,s=!0){super(i.schedule),this.symbol=e,this.symbolLayer=t,this._context=i,this._drivenOpacityFallbackAlwaysOpaque=s,this.ignoreDrivers=!1,this._drivenProperties={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1,rotation:!1},this._materials=[],this.logger=nl(),this._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0},this.skipHighSymbolLodsChanged=!0,this._renderPriority=r.renderPriority,this._renderPriorityStep=r.renderPriorityStep,this._elevationContext=new m3,this.updateComplexity(),this.ignoreDrivers=r.ignoreDrivers,this.ignoreDrivers||(this._drivenProperties=f3(this._context.renderer,s)),this._updateElevationContext()}destroy(){this.complexity=null,this._materials.length=0,super.destroy()}get view(){return this._context.stage.view}getCachedSize(){return null}get extentPadding(){return 0}get materials(){return this._materials}get estimatedMemory(){const{complexity:e}=this;return e==null?0:(this.draped?e.memory.draped:e.memory).bytesPerFeature}get usedMemory(){return this.estimatedMemory}_drivenPropertiesChanged(e){if(this.ignoreDrivers)return!1;const t=this._drivenProperties,i=f3(e,this._drivenOpacityFallbackAlwaysOpaque);return i.color!==t.color||i.opacity!==t.opacity||i.opacityAlwaysOpaque!==t.opacityAlwaysOpaque||i.size!==t.size||i.rotation!==t.rotation}get needsDrivenTransparentPass(){return this._hasDrivenColorOrOpacity&&!this._drivenProperties.opacityAlwaysOpaque}get _hasDrivenColorOrOpacity(){return this._drivenProperties.color||this._drivenProperties.opacity}_logGeometryCreationWarnings(e,t,i,r){const s=e.projectionSuccess,n="polygons"in e?e.polygons:null,a=`${r} geometry failed to be created`;s?!this._logGeometryValidationWarnings(t,i,r)&&n&&n.length===0&&i==="rings"&&t.length>0&&t[0].length>2&&nl().warnOncePerTick(`${a} (filled rings should use clockwise winding - try reversing the order of vertices)`):nl().warnOncePerTick(`${a} (failed to project geometry to view spatial reference)`)}get needsUpdateFocus(){return!1}_logGeometryValidationWarnings(e,t,i){const r=`${i} geometry failed to be created`;return!e.length||e.length===1&&!e[0].length?(nl().warnOncePerTick(`${r} (no ${t} were defined)`),!0):(!Array.isArray(e)||!Array.isArray(e[0]))&&(nl().warnOncePerTick(`${r} (${t} should be defined as a 2D array)`),!0)}_validateGeometry(e,t=null,i=null){if(t!=null&&!t.includes(e.type))return this.logger.warn("unsupported geometry type for "+i+` symbol: ${e.type}`),!1;switch(e.type){case"point":{const r=e;if(!isFinite(r.x)||!isFinite(r.y))return nl().warn("point coordinate is not a valid number, graphic skipped"),!1;break}case"polygon":GI(e)}return!0}_defaultElevationInfoNoZ(){return oj}_defaultElevationInfoZ(){return lj}_updateElevationContext(){this._elevationInfoOverride!=null?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.setFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.setFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset()}getDefaultElevationInfo(e){return e.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()}getGeometryElevationMode(e,t=this.getDefaultElevationInfo(e)){return this._elevationContext.mode||t.mode}setElevationInfoOverride(e){this._elevationInfoOverride=e,this._updateElevationContext()}createElevationContextForGraphic(e){const t=new m3;return this.updateElevationContextForGraphic(t,e),t}updateElevationContextForGraphic(e,t){const i=t.geometry,r=this.getDefaultElevationInfo(i);e.unit=this._elevationContext.unit!=null?this._elevationContext.unit:r.unit,e.mode=this.getGeometryElevationMode(i,r),e.offsetMeters=this._elevationContext.meterUnitOffset??r.offset??0;const s=!this._elevationOptions.supportsOnTheGround&&e.mode==="on-the-ground";s&&(e.mode="relative-to-ground",e.offsetMeters=0);const n=s?nj:this._elevationContext.featureExpressionInfoContext;n?e.updateFeatureExpressionInfoContextForGraphic(n,t,this._context.layer):e.setFeatureExpressionInfoContext(null)}prepareSymbolLayerPatch(e){}onRemoveGraphic(e){}_getLayerOpacity(){return this._context.graphicsCoreOwner&&"fullOpacity"in this._context.graphicsCoreOwner?this._context.graphicsCoreOwner.fullOpacity??0:this._context.layer.opacity??1}_getCombinedOpacity(e,t=g3){const i=this.draped?1:this._getLayerOpacity();return this._drivenProperties.color?i:e?i*(this._drivenProperties.opacity?1:e.a):t.hasIntrinsicColor?i:0}_getCombinedOpacityAndColor(e,t=g3){const i=this._getCombinedOpacity(e,t);if(this._drivenProperties.color)return py(null,i);const r=e!=null?wi.toUnitRGB(e):f9;return py(r,i)}_getDrivenUInt8Color({color:e,opacity:t},i,r){const{color:s,opacity:n}=this._drivenProperties,a=wi.toUnitRGBA(i)??(r?hM:di),o=s?e??a:null,l=e||i||r,c=s?null:a[3];return py(o,n&&l?t??c:null,255)}_getDrivenUInt8ColorWithNaNSupport({color:e,opacity:t},i,r){const s=i?LL(wi.toUnitRGBA(i)):Mi(NaN,NaN,NaN,r?NaN:0);return this._drivenProperties.color&&e!=null&&Zl(s,e),this._drivenProperties.opacity&&t!=null&&(s[3]=t),X2(s,s,255),cF(s,s)}isFastUpdatesEnabled(){return this._fastUpdates!=null}updateComplexity(){this.complexity=this.computeComplexity()}computeComplexity(){return VD(this.symbol,this.symbolLayer)}globalPropertyChanged(e,t,i){switch(e){case"opacity":return this.layerOpacityChanged(t,i),!0;case"screenSizePerspectiveEnabled":return this.layerScreenSizePerspectiveChanged(t,i),!0;case"elevationInfo":{const r=this._elevationContext.mode;return this._updateElevationContext(),this.layerElevationInfoChanged(t,i,r)!==2}case"slicePlaneEnabled":return this.slicePlaneEnabledChanged(t,i);case"physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case"pixelRatio":return this.pixelRatioChanged;case"skipHighSymbolLods":return this.skipHighSymbolLodsChanged;default:return!1}}get pixelRatioChanged(){return!0}updateGraphics3DGraphicElevationInfo(e,t,i){let r=1;return e?.forEach(s=>{const n=t(s);if(n!=null){const a=s.graphic;this.updateElevationContextForGraphic(n.elevationContext,a),n.needsElevationUpdates=i(n.elevationContext.mode)}else r=2}),r}applyRendererDiff(e,t){return 0}getFastUpdateAttrValues(e){if(!this._fastUpdates)return null;const t=this._fastUpdates.visualVariables,i=t.size?cy(t.size.field,e):0,r=t.color?cy(t.color.field,e):0,s=t.opacity?cy(t.opacity.field,e):0;return Mi(i,r,s,0)}get draped(){return this._draped}ensureDrapedStatus(e){return this._draped==null?(this._draped=e,!0):(e!==this.draped&&nl().warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary."),!1)}test(){const e=()=>({size:this._fastUpdates?.visualVariables.size?.field??null,color:this._fastUpdates?.visualVariables.color?.field??null,opacity:this._fastUpdates?.visualVariables.opacity?.field??null,rotation:this._fastUpdates?.visualVariables.rotation?.field??null});return{drivenProperties:this._drivenProperties,getVisVarFields:e}}};function f3(e,t){const i={color:!1,opacity:!1,opacityAlwaysOpaque:t,size:!1,rotation:!1};return e&&"visualVariables"in e&&e.visualVariables&&e.visualVariables.forEach(r=>{switch(r.type){case"color":if(i.color=!0,r.stops)for(let s=0;s<r.stops.length;s++){const n=r.stops[s].color;n&&n.a<1&&(i.opacityAlwaysOpaque=!1)}break;case"opacity":i.opacity=!0,i.opacityAlwaysOpaque=!1;break;case"size":i.size=!0;break;case"rotation":i.rotation=!0}}),i}const oj={mode:"on-the-ground",offset:0,unit:"meters"},lj={mode:"absolute-height",offset:0,unit:"meters"},g3={hasIntrinsicColor:!1},nse=Mi(NaN,NaN,NaN,NaN);function ND(e){return e==="position"}function cj(e,t){return e==null&&(e=[]),e.push(t),e}function hj(e,t){if(e==null)return null;const i=e.filter(r=>r!==t);return i.length===0?null:i}function ase(e,t,i,r,s){Gm[0]=e.get(t,0),Gm[1]=e.get(t,1),Gm[2]=e.get(t,2),VA(Gm,al,3),i.set(s,0,al[0]),r.set(s,0,al[1]),i.set(s,1,al[2]),r.set(s,1,al[3]),i.set(s,2,al[4]),r.set(s,2,al[5])}const Gm=w(),al=new Float32Array(6);let jD=class{constructor(e={}){this.id=uu(),this._highlightIds=new Set,this._shaderTransformation=null,this._visible=!0,this.castShadow=e.castShadow??!0,this.usesVerticalDistanceToGround=e.usesVerticalDistanceToGround??!1,this.graphicUid=e.graphicUid,this.layerViewUid=e.layerViewUid,e.isElevationSource&&(this.lastValidElevationBB=new UD),this._geometries=e.geometries?Array.from(e.geometries):new Array}dispose(){this._geometries.length=0}get layer(){return this._layer}set layer(e){Qt(this._layer==null||e==null,"Object3D can only be added to a single Layer"),this._layer=e}addGeometry(e){e.visible=this._visible,this._geometries.push(e);for(const t of this._highlightIds)e.addHighlight(t);this._emit("geometryAdded",{object:this,geometry:e}),this._highlightIds.size&&this._emit("highlightChanged",this),this._invalidateBoundingVolume()}removeGeometry(e){const t=this._geometries.splice(e,1)[0];if(t){for(const i of this._highlightIds)t.removeHighlight(i);this._emit("geometryRemoved",{object:this,geometry:t}),this._highlightIds.size&&this._emit("highlightChanged",this),this._invalidateBoundingVolume()}}removeAllGeometries(){for(;this._geometries.length>0;)this.removeGeometry(0)}geometryVertexAttributeUpdated(e,t,i=!1){this._emit("attributesChanged",{object:this,geometry:e,attribute:t,sync:i}),ND(t)&&this._invalidateBoundingVolume()}get visible(){return this._visible}set visible(e){if(this._visible!==e){this._visible=e;for(const t of this._geometries)t.visible=this._visible;this._emit("visibilityChanged",this)}}maskOccludee(){const e=new LA;for(const t of this._geometries)t.occludees=cj(t.occludees,e);return this._emit("occlusionChanged",this),e}removeOcclude(e){for(const t of this._geometries)t.occludees=hj(t.occludees,e);this._emit("occlusionChanged",this)}highlight(e){const t=new FA(e);for(const i of this._geometries)i.addHighlight(t);return this._emit("highlightChanged",this),this._highlightIds.add(t),t}removeHighlight(e){this._highlightIds.delete(e);for(const t of this._geometries)t.removeHighlight(e);this._emit("highlightChanged",this)}removeStateID(e){e.channel===0?this.removeHighlight(e):this.removeOcclude(e)}getCombinedStaticTransformation(e,t){return lr(t,this.transformation,e.transformation)}getCombinedShaderTransformation(e,t=Le()){return lr(t,this.effectiveTransformation,e.transformation)}get boundingVolumeWorldSpace(){return this._bvWorldSpace||(this._bvWorldSpace=this._bvWorldSpace||new _3,this._validateBoundingVolume(this._bvWorldSpace,0)),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._bvObjectSpace||(this._bvObjectSpace=this._bvObjectSpace||new _3,this._validateBoundingVolume(this._bvObjectSpace,1)),this._bvObjectSpace}_validateBoundingVolume(e,t){const i=t===1;for(const r of this._geometries){const s=r.boundingInfo;s&&uj(s,e,i?r.transformation:this.getCombinedShaderTransformation(r))}W2(e.bounds,Nt(c0,e.min,e.max,.5));for(const r of this._geometries){const s=r.boundingInfo;if(s==null)continue;const n=i?r.transformation:this.getCombinedShaderTransformation(r),a=hp(n);lt(c0,s.center,n);const o=Gt(c0,Gi(e.bounds)),l=s.radius*a;e.bounds[3]=Math.max(e.bounds[3],o+l)}}_invalidateBoundingVolume(){const e=this._bvWorldSpace?.bounds;this._bvObjectSpace=this._bvWorldSpace=void 0,this.layer&&e&&this.layer.notifyObjectBBChanged(this,e)}_emit(e,t){this.layer?.events.emit(e,t)}get geometries(){return this._geometries}get transformation(){return this._transformation??vn}set transformation(e){this._transformation=ks(this._transformation??Le(),e),this._invalidateBoundingVolume(),this._emit("transformationChanged",this)}get shaderTransformation(){return this._shaderTransformation}set shaderTransformation(e){this._shaderTransformation=e?ks(this._shaderTransformation??Le(),e):null,this._invalidateBoundingVolume(),this._emit("shaderTransformationChanged",this)}get effectiveTransformation(){return this.shaderTransformation??this.transformation}get test(){}},UD=class{constructor(){this._data=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE]}get min(){return We(this._data[0],this._data[1],this._data[2])}get max(){return We(this._data[3],this._data[4],this._data[5])}minWith(e){const{_data:t}=this;t[0]=Math.min(t[0],e[0]),t[1]=Math.min(t[1],e[1]),t[2]=Math.min(t[2],e[2])}maxWith(e){const{_data:t}=this;t[3]=Math.max(t[3],e[0]),t[4]=Math.max(t[4],e[1]),t[5]=Math.max(t[5],e[2])}assignMinMax(e,t){for(let i=0;i<3;++i)this._data[0+i]=e[i],this._data[3+i]=t[i]}isEmpty(){return this._data[3]<this._data[0]&&this._data[4]<this._data[1]&&this._data[5]<this._data[2]}},_3=class extends UD{constructor(){super(...arguments),this.bounds=Kr()}};function uj(e,t,i){const r=e.bbMin,s=e.bbMax;if(KI(i)){const n=xe(dj,i[12],i[13],i[14]);return ce(is,r,n),ce(Ks,s,n),t.minWith(is),void t.maxWith(Ks)}if(lt(is,r,i),Go(r,s))return t.minWith(is),void t.maxWith(is);lt(Ks,s,i),t.minWith(is),t.minWith(Ks),t.maxWith(is),t.maxWith(Ks);for(let n=0;n<3;++n)q(is,r),q(Ks,s),is[n]=s[n],Ks[n]=r[n],lt(is,is,i),lt(Ks,Ks,i),t.minWith(is),t.minWith(Ks),t.maxWith(is),t.maxWith(Ks)}const dj=w(),is=w(),Ks=w(),c0=w();function pj(e,t,i,r,s){if(HD(e,t))return null;i.localOrigin=gj(e,t);const n=new jD({geometries:[i],castShadow:!1,layerViewUid:e.layerViewUid,graphicUid:s,usesVerticalDistanceToGround:!0});return{object:n,sampledElevation:MD(n,t,e.elevationProvider,e.renderCoordsHelper,r)}}function ose(e,t,i,r){return HD(t,i)?null:MD(e,i,t.elevationProvider,t.renderCoordsHelper,r)}function HD(e,t){const i=e.clippingExtent;return!!i&&(Ha(t,Po,e.elevationProvider.spatialReference),!jL(i,Po))}function mj(e,t,i){const r=e.elevationContext,s=i.spatialReference;Ha(t,Po,s),r.centerInElevationSR=We(Po[0],Po[1],t.hasZ?Po[2]:0)}function fj(e){switch(e.type){case"point":return e;case"polygon":case"extent":return N4(e);case"polyline":{const t=e.paths[0];if(!t||t.length===0)return null;const i=$I(t,WI(t)/2);return VL(i[0],i[1],i[2],e.spatialReference)}case"mesh":return e.extent.center}return null}function gj(e,t){return Ha(t,Po,e.renderCoordsHelper.spatialReference),e.localOriginFactory.getOrigin(Po)}const Po=w();function _j(e){e.include(Xa),e.uniforms.add(new gs("geometryDepthTexture",t=>t.geometryDepth?.attachment)),e.code.add(_`bool geometryDepthTest(vec2 pos, float elementDepth) {
float geometryDepth = linearDepthFromTexture(geometryDepthTexture, pos);
return (elementDepth < (geometryDepth - 1.0));
}`)}function qD(e){const t=new ut,{vertex:i,fragment:r}=t,{terrainDepthTest:s}=e;return i.include(gI),t.include(_I,e),t.vertex.include(b8,e),t.attributes.add("uv0","vec2"),i.uniforms.add(new M_("viewport",n=>n.camera.fullViewport),new _e("lineSize",(n,a)=>n.size>0?Math.max(1,n.size)*a.camera.pixelRatio:0),new op("pixelToNDC",n=>Ki(y3,2/n.camera.fullViewport[2],2/n.camera.fullViewport[3])),new _e("borderSize",(n,a)=>n.borderColor?a.camera.pixelRatio:0),new qs("screenOffset",(n,a)=>Ki(y3,n.horizontalScreenOffset*a.camera.pixelRatio,0))),t.varyings.add("coverageSampling","vec4"),t.varyings.add("lineSizes","vec2"),s&&t.varyings.add("depth","float"),e.occlusionTestEnabled&&t.include(yI),e.hasScreenSizePerspective&&w8(i),i.main.add(_`
    ProjectHUDAux projectAux;
    vec4 endPoint = projectPositionHUD(projectAux);

    vec3 vpos = projectAux.posModel;
    if (rejectBySlice(vpos)) {
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
      return;
    }
    ${X(e.occlusionTestEnabled,_`if (!testHUDVisibility(endPoint)) {
             gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
             return;
           }`)}

    ${e.hasScreenSizePerspective?_`vec3 perspectiveFactor = screenSizePerspectiveScaleFactor(projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
               vec2 screenOffsetScaled = applyScreenSizePerspectiveScaleFactorVec2(screenOffset, perspectiveFactor);`:"vec2 screenOffsetScaled = screenOffset;"}
    // Add view dependent polygon offset to get exact same original starting point. This is mostly used to get the
    // correct depth value
    vec3 posView = (view * vec4(position, 1.0)).xyz;
    ${X(s,"depth = posView.z;")}

    applyHUDViewDependentPolygonOffset(centerOffsetAndDistance.w, projectAux.absCosAngle, posView);
    vec4 startPoint = proj * vec4(posView, 1.0);

    // Apply screen offset to both start and end point
    vec2 screenOffsetNorm = screenOffsetScaled * 2.0 / viewport.zw;
    startPoint.xy += screenOffsetNorm * startPoint.w;
    endPoint.xy += screenOffsetNorm * endPoint.w;

    // Align start and end to pixel origin
    vec4 startAligned = alignToPixelOrigin(startPoint, viewport.zw);
    vec4 endAligned = alignToPixelOrigin(endPoint, viewport.zw);
    ${X(e.hudDepth,e.hudDepthAlignStart?"endAligned = vec4(endAligned.xy / endAligned.w * startAligned.w, startAligned.zw);":"startAligned = vec4(startAligned.xy / startAligned.w * endAligned.w, endAligned.zw);")}
    vec4 projectedPosition = mix(startAligned, endAligned, uv0.y);

    // The direction of the line in screen space
    vec2 screenSpaceDirection = normalize(endAligned.xy / endAligned.w - startAligned.xy / startAligned.w);
    vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x);
    ${e.hasScreenSizePerspective?_`float lineSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(lineSize, perspectiveFactor);
               float borderSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(borderSize, perspectiveFactor);`:_`float lineSizeScaled = lineSize;
               float borderSizeScaled = borderSize;`}
    float halfPixelSize = lineSizeScaled * 0.5;

    // Compute full ndc offset, adding 1px padding for doing anti-aliasing and the border size
    float padding = 1.0 + borderSizeScaled;
    vec2 ndcOffset = (-halfPixelSize - padding + uv0.x * (lineSizeScaled + padding + padding)) * pixelToNDC;

    // Offset x/y from the center of the line in screen space
    projectedPosition.xy += perpendicularScreenSpaceDirection * ndcOffset * projectedPosition.w;

    // Compute a coverage varying which we can use in the fragment shader to determine
    // how much a pixel is actually covered by the line (i.e. to anti alias the line).
    // This works by computing two coordinates that can be linearly interpolated and then
    // subtracted to find out how far away from the line edge we are.
    float edgeDirection = (uv0.x * 2.0 - 1.0);

    float halfBorderSize = 0.5 * borderSizeScaled;
    float halfPixelSizeAndBorder = halfPixelSize + halfBorderSize;
    float outerEdgeCoverageSampler = edgeDirection * (halfPixelSizeAndBorder + halfBorderSize + 1.0);

    float isOneSided = float(lineSizeScaled < 2.0 && borderSize < 2.0);

    coverageSampling = vec4(
      // Edge coordinate
      outerEdgeCoverageSampler,

      // Border edge coordinate
      outerEdgeCoverageSampler - halfPixelSizeAndBorder * isOneSided,

      // Line offset
      halfPixelSize - 0.5,

      // Border offset
      halfBorderSize - 0.5 + halfPixelSizeAndBorder * (1.0 - isOneSided)
    );

    lineSizes = vec2(lineSizeScaled, borderSizeScaled);
    gl_Position = projectedPosition;`),r.uniforms.add(new $r("uColor",n=>n.color??di),new $r("borderColor",n=>n.borderColor??di)),s&&(r.include(_j,e),r.uniforms.add(new op("inverseViewport",n=>n.inverseViewport))),r.main.add(_`
    ${X(s,"if( geometryDepthTest(gl_FragCoord.xy * inverseViewport, depth) ){ discard; }")}

    vec2 coverage = min(1.0 - clamp(abs(coverageSampling.xy) - coverageSampling.zw, 0.0, 1.0), lineSizes);

    float borderAlpha = uColor.a * borderColor.a * coverage.y;
    float colorAlpha = uColor.a * coverage.x;

    float finalAlpha = mix(borderAlpha, 1.0, colorAlpha);
    ${X(!e.hudDepth,_`vec3 finalRgb = mix(borderColor.rgb * borderAlpha, uColor.rgb, colorAlpha);
           fragColor = vec4(finalRgb, finalAlpha);`)}`),t}const y3=ze(),yj=Object.freeze(Object.defineProperty({__proto__:null,build:qD},Symbol.toStringTag,{value:"Module"}));let vj=class extends ct{constructor(e,t){super(e,t,new ht(yj,()=>k(()=>Promise.resolve().then(()=>XJ),void 0)),GD.locations)}initializePipeline(e){const{hudDepth:t,terrainDepthTest:i}=e,r={func:i?519:513};return Ge(t?{depthTest:r,depthWrite:T2}:{blending:mu(1,770,771,771),depthTest:r,colorWrite:st})}};const GD=Ka().vec3f("position").vec3f("normal").vec2f16("uv0").vec4f("centerOffsetAndDistance");let yo=class extends S_{constructor(e){super(),this.spherical=e,this.screenCenterOffsetUnitsEnabled=!1,this.occlusionTestEnabled=!0,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.hudDepth=!1,this.hudDepthAlignStart=!1,this.terrainDepthTest=!1,this.draped=!1}};h([z()],yo.prototype,"screenCenterOffsetUnitsEnabled",void 0),h([z()],yo.prototype,"occlusionTestEnabled",void 0),h([z()],yo.prototype,"hasVerticalOffset",void 0),h([z()],yo.prototype,"hasScreenSizePerspective",void 0),h([z()],yo.prototype,"hudDepth",void 0),h([z()],yo.prototype,"hudDepthAlignStart",void 0),h([z()],yo.prototype,"terrainDepthTest",void 0);let h0=class extends UP{constructor(e,t){super(e,$D),this.intersectDraped=void 0,this.produces=new Map([[15,i=>or(i)],[16,i=>or(i)]]),this._configuration=new yo(t),this._uniqueMaterialIdentifier=L1(this.parameters)}passParameters(){return this.parameters}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.hasVerticalOffset=this.parameters.verticalOffset!=null,this._configuration.hasScreenSizePerspective=this.parameters.screenSizePerspective!=null,this._configuration.hudDepth=t.slot===16,this._configuration.hudDepthAlignStart=!!this.parameters.hudDepthAlignStart,this._configuration.screenCenterOffsetUnitsEnabled=this.parameters.centerOffsetUnits==="screen",this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.terrainDepthTest=t.terrainDepthTest,this._configuration}get visible(){return this.parameters.color[3]>=Or||(this.parameters.borderColor?.[3]??0)>=Or}intersect(){}createGLMaterial(e){return new bj(e)}createBufferWriter(){return new wj}validateParameters(e){this._uniqueMaterialIdentifier=L1(e)}get uniqueMaterialIdentifier(){return this._uniqueMaterialIdentifier}};function L1({renderOccluded:e,isDecoration:t,horizontalScreenOffset:i,color:r,size:s,occlusionTest:n,shaderPolygonOffset:a,hudDepthAlignStart:o,centerOffsetUnits:l,hasSlicePlane:c,screenSizePerspective:u,verticalOffset:p,borderColor:m}){return mA`${e}:${t}:${i}:[${r}]:${s}:${n}:${a}:${o}:${l}:${c}:${u!=null}:{${p?.screenLength}:${p?.minWorldLength}:${p?.maxWorldLength}}:[${m}]`}let bj=class extends ZP{beginSlot(e){return this.getTechnique(vj,e)}},$D=class extends WA{constructor(){super(...arguments),this.horizontalScreenOffset=0,this.color=Mi(0,0,0,1),this.size=1,this.occlusionTest=!1,this.shaderPolygonOffset=1e-5,this.hudDepthAlignStart=!1,this.centerOffsetUnits="world",this.hasSlicePlane=!1}};const v3=[Pc(0,0),Pc(1,0),Pc(0,1),Pc(1,0),Pc(1,1),Pc(0,1)];let wj=class{constructor(){this.layout=GD}elementCount(e){return 6*e.get("position").indices.length}write(e,t,i,r,s,n){t8(i.get("position"),e,s.position,n,6),i8(i.get("normal"),t,s.normal,n,6),r8(i.get("centerOffsetAndDistance"),s.centerOffsetAndDistance,n,6);for(let a=0;a<v3.length;++a)s.uv0.setVec(n+a,v3[a]);return null}},xj=class WD extends aj{static{this.elevationModeChangeTypes={definedChanged:1,staysOnTheGround:1,onTheGroundChanged:2}}constructor(t,i){super(t,null,i,Tj),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){this._materials[0]=new h0(this._materialParameters,this._context.spherical)}_perInstanceMaterialParameters(t){const i=this._materialParameters;return i.horizontalScreenOffset=t.horizontalScreenOffset??0,i.centerOffsetUnits=t.centerOffsetUnits||"world",i}get _materialParameters(){const t=new $D,i=this.symbol,r=i.callout;if(r.color){const a=wi.toUnitRGBA(r.color);a[3]*=this._getLayerOpacity(),t.color=a}else t.color=di;if(t.size=Ig(r.size||0),i.verticalOffset){const{screenLength:a,minWorldLength:o,maxWorldLength:l}=i.verticalOffset;t.verticalOffset={screenLength:Ig(a),minWorldLength:o||0,maxWorldLength:l??1/0}}t.borderColor=r.border?.color!=null?wi.toUnitRGBA(r.border.color):null;const s=i.symbolLayers.at(0).type==="object",n=i.type==="label-3d";return t.occlusionTest=!s&&!Qe("enable-feature:non-occluded-hud"),s&&(t.shaderPolygonOffset=0),t.hudDepthAlignStart=n,t.hasSlicePlane=this._context.slicePlaneEnabled,t.screenSizePerspective=this._context.screenSizePerspectiveEnabled?this.view.screenSizePerspective.parameters:null,t}_defaultElevationInfoNoZ(){return Sj}createGraphics3DGraphic(t,i){const r=t.renderingInfo,s=t.graphic,n=this.createElevationContextForGraphic(s,r.elevationOffset||0),a=r.symbol,o=this._elevationContext.mode==="on-the-ground"&&(a.type==="cim"||!a.symbolLayers.some(c=>c.type==="object"||c.type==="text"));if(a.type!=="label-3d"&&o||a.type==="point-3d"&&a.symbolLayers.every(c=>c.type==="text"&&!sF(c)))return null;const l=N4(s.geometry);return l==null?null:this._createAs3DShape(l,n,r,s.uid,i)}layerOpacityChanged(){this._materials[0]?.setParameters(this._materialParameters)}layerScreenSizePerspectiveChanged(){const t=this._context.screenSizePerspectiveEnabled?this.view.screenSizePerspective.parameters:null;this._materials[0]?.setParameters({screenSizePerspective:t})}layerElevationInfoChanged(t,i,r){const s=this._elevationContext.mode,n=AN(WD.elevationModeChangeTypes,r,s);return n!==1||t?.forEach(a=>{const o=i(a);o!=null&&this.graphics3DGraphicLayerElevationInfoChanged(a.graphic,o)}),n}slicePlaneEnabledChanged(){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}createElevationContextForGraphic(t,i=0){const r=super.createElevationContextForGraphic(t);return r.addOffsetRenderUnits(i),r}updateElevationContextForGraphic(t,i,r=0){super.updateElevationContextForGraphic(t,i),t.addOffsetRenderUnits(r)}graphics3DGraphicLayerElevationInfoChanged(t,i){const{elevationContext:r,metadata:s}=i;this.updateElevationContextForGraphic(r,t,s?.elevationOffset??0),i.needsElevationUpdates=d3(r.mode)}computeComplexity(){return new Ds({verticesPerFeature:6})}_getOrCreateMaterial(t,i){const r=this._perInstanceMaterialParameters(t),s=L1(r);if(s===this._materials[0]?.uniqueMaterialIdentifier)return this._materials[0];if(i){let n=i.get(s);return n==null&&(n=new h0(r,this._context.spherical),i.set(s,n)),n}return new h0(r,this._context.spherical)}_createAs3DShape(t,i,r,s,n){const a=this._context.layerViewUid,o=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:s,layerViewUid:a}),l=this._getOrCreateMaterial(r,n),c=new HP(l,Cj(r),null,1,o),u=pj(this._context,t,c,i,s);if(u==null)return null;const p=new ID(this,u.object,null,NN,i);return p.metadata=new GN(r.elevationOffset),p.alignedSampledElevation=u.sampledElevation,p.needsElevationUpdates=d3(i.mode),mj(p,t,this._context.elevationProvider),p}};function Cj(e){const{translation:t,centerOffset:i}=e,r=new Of(t?[t[0],t[1],t[2]]:[0,0,0],u0,3,!0),s=new Of(i?[i[0],i[1],i[2],i[3]]:[0,0,0,1],u0,4,!0);return[["position",r],["normal",new Of([0,0,1],u0,3,!0)],["centerOffsetAndDistance",s]]}const u0=[0],Sj={mode:"relative-to-ground",offset:0},Tj={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1};let Pj=class extends EN{constructor(e,t,i=w(),r=Vt(),s=0,n="world",a=0){super(e,t),this.translation=i,this.centerOffset=r,this.horizontalScreenOffset=s,this.centerOffsetUnits=n,this.elevationOffset=a}},Mj=class extends HN{};const b3=()=>$.getLogger("esri.views.3d.layers.graphics.Graphics3DCalloutSymbolLayerFactory");function Rj(e,t){if(!_M(e))return b3().error("Graphics3DCalloutSymbolLayerFactory#make",`symbol of type '${e.type}' does not support callouts`),null;if(!e.callout)return null;const i=Dj[e.callout.type];return i?new i(e,t):(b3().error("Graphics3DCalloutSymbolLayerFactory#make",`unknown or unsupported callout type ${e.callout.type}`),null)}const Dj={line:xj},w3=new Eo(()=>eo(),e=>mM(e,UL),null,10,5),Oj=Rt();let Ej=class{get labelLayers(){return this._labelLayers||oA}get extent(){return this._extent}get isElevationSource(){return this.layers.some(e=>e?.isElevationSource)}constructor(e,t,i){this.graphic=e,this.graphics3DSymbol=t,this.layers=i,this._visibleFlags=255,++t.referenced}initialize(e){this._layer=e,this._forEachSymbolLayerGraphic(t=>{t.initialize(e),t.setVisibility(this.isVisible())})}destroy(){this._forEachSymbolLayerGraphic(e=>e.destroy()),this._calloutLayer=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}get destroyed(){return this.layers==null}clearLabelGraphics(){this._forEachLabelGraphic(e=>e.destroy()),this._labelLayers=null}addLabelGraphic(e,t){this._labelLayers||(this._labelLayers=new Array),this._labelLayers.push(e),e.initialize(t),e.setVisibility(this.isVisible(16))}setCalloutGraphic(e){this._calloutLayer=e,this._layer&&(e.initialize(this._layer),e.setVisibility(this.isVisible()))}get calloutLayer(){return this._calloutLayer}get isDraped(){let e=!1;return this._forEachSymbolLayerGraphic(t=>{t.type==="draped"&&(e=!0)}),e}isVisible(e=1,t){const i=t?this._visibleFlags|t|16*t:this._visibleFlags;return e===1?!(15&~i):!(255&~i)}setVisibilityFlag(e,t,i){const r=this.isVisible(e);i?this._visibleFlags|=e*t:this._visibleFlags&=~(e*t);const s=this.isVisible(e);if(r===s)return!1;if(e===16)this._forEachLabelGraphic(n=>n.setVisibility(s));else{this._forEachSymbolLayerGraphic(a=>a.setVisibility(s));const n=this.isVisible(16);this._forEachLabelGraphic(a=>a.setVisibility(n))}return!0}getVisibilityFlag(e,t){return(this._visibleFlags&e*t)!==0}computeExtent(e){if(!this._extent){const t=this.graphic.geometry;if(t==null)return!1;this._extent=Rt(),PF(t,this._extent);const i=t.spatialReference;if(!rc(i,e)&&!sb(this._extent,i,this._extent,e))return this._extent=null,!1}return!0}getAsOptimizedGeometry(e,t){return this._optimizedGeometry||(this._optimizedGeometry=this._convertGraphicToOptimizedGeometry(this.graphic,e,t)),this._optimizedGeometry}_convertGraphicToOptimizedGeometry(e,t,i){let r=e.geometry;return r.type!=="mesh"&&r.type!=="extent"||(r=Z4.fromExtent(r.type==="mesh"?r.extent:r)),MF(r,t,i)}get usedMemory(){let e=pL(this.graphic.attributes);return this._forEachSymbolLayerGraphic(t=>e+=t.usedMemory),e}computeAttachmentOrigin(){const e={render:{origin:w(),num:0},draped:{origin:ze(),num:0}};for(const t of this.layers)t?.computeAttachmentOrigin(e);return e.render.num>1&&te(e.render.origin,e.render.origin,1/e.render.num),e.draped.num>1&&Ol(e.draped.origin,e.draped.origin,1/e.draped.num),e}async getProjectedBoundingBox(e,t,i,r,s){return s||(s={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),s.boundingBox?Gs(s.boundingBox):s.boundingBox=Gs(),s.requiresDrapedElevation=!1,await k2(this.layers,async n=>{if(n==null)return;const a=n.type==="draped"?t:e,o=w3.acquire(),l=await n.getProjectedBoundingBox(a,i,s.screenSpaceObjects,r,o);isFinite(l[2])&&isFinite(l[5])||(s.requiresDrapedElevation=!0),l&&pM(s.boundingBox,o),w3.release(o)}),NL(s.boundingBox)||Ov(J2(s.boundingBox,Oj))?s:null}needsElevationUpdates(){for(const e of this.layers)if(e!=null&&(e.type==="object3d"||e.type==="lod-instance")&&e.needsElevationUpdates)return!0;return this._labelLayers?.some(e=>e?.needsElevationUpdates??!1)??!1}alignWithElevation(e,t,i){this._forEachRenderedGraphic(r=>{r.type!=="object3d"&&r.type!=="lod-instance"||r.alignWithElevation(e,t,i)})}alignWithAbsoluteElevation(e,t,i){this._forEachRenderedGraphic(r=>{r.type==="object3d"&&r.alignWithAbsoluteElevation(e,t,i)})}addObjectStateSet(e){this._forEachSymbolLayerGraphic(t=>t.addObjectState(e))}removeObjectState(e){this._forEachSymbolLayerGraphic(t=>t.removeObjectState(e))}updateHighlights(e){this._forEachSymbolLayerGraphic(t=>t.updateHighlights(e))}_forEachGraphicList(e,t){e?.forEach(i=>i&&t(i))}_forEachSymbolLayerGraphic(e){this._forEachGraphicList(this.layers,e),this._calloutLayer&&e(this._calloutLayer)}_forEachLabelGraphic(e){this._forEachGraphicList(this.labelLayers,e)}_forEachRenderedGraphic(e){this._forEachSymbolLayerGraphic(e),this._forEachLabelGraphic(e)}get test(){}},lse=class{constructor(e,t,i,r){this.scheduler=e,this.schedule=t,this.layerViewUid=i,this.compressionTracker=r,this.sharedResources=null,this.streamDataRequester=null,this.elevationProvider=null,this.renderer=null,this.stage=null,this.clippingExtent=null,this.renderCoordsHelper=null,this.overlaySR=null,this.layer=null,this.drapeSourceRenderer=null,this.graphicsCoreOwner=null,this.localOriginFactory=null,this.featureExpressionInfoContext=null,this.screenSizePerspectiveEnabled=!0,this.slicePlaneEnabled=!1,this.physicalBasedRenderingEnabled=!1,this.skipHighSymbolLods=!1,this.isAsync=!1}get spherical(){return this.stage.view.state.viewingMode===1}},Aj=class{constructor(){this.renderPriority=0,this.renderPriorityStep=1,this.ignoreDrivers=!1}};const Ij=2216,Lj=4096;function ZD(e){return Ij+Lj*e.symbolLayers.length+e.complexity.memory.resourceBytes}let Fj=class extends Lb{set symbol(e){this._symbol=e,e.symbolLayers.forEach((t,i)=>{const r=this.symbolLayers[i];r!=null&&(r.symbol=e,r.symbolLayer=t)})}get symbol(){return this._symbol}constructor(e,t,i){super(t.schedule),this._symbol=e,this._context=t,this._backgroundLayers=i,this._destroyed=!1,this.symbolLayers=new Array,this.referenced=0,this._extentPadding=0}async doLoad(e){let t=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(t=this._backgroundLayers.concat(t));const i=t.length;for(;this.symbolLayers.length<t.length;)this.symbolLayers.push(null);this.symbolLayers.length=t.length;const r=[];if(!d0){const{make:s}=await k(()=>le(()=>import("./Graphics3DSymbolLayerFactory-C1ySNcVb-CLmGExA7.js"),__vite__mapDeps([450,1,2,3,444,7,8,351,19,9,20,14,69,6,4,10,38,167,181,101,27,36,37,168,233,13,291,306,56,25,5,11,12,15,26,28,29,30,31,32,33,34,35,39,40,41,42,43,192,170,87,169,86,166,171,172,173,174,175,176,177,178,179,180,182,183,184,92,185,186,187,91,93,89,94,188,193,194,195,97,196,414,415,165,227,46,80,81,70,82,83,84,451,452,453,98,229,74,215,16,141,216,113,160,18,374,164,163,217,59,60,230,73,72,68,75,328,413,408,390,454,236,455,456,457,458,272,459,460,461,224,225,79,257,64,462,57,51,58,463,221,213,386,256,21,22,23,112,189,190,191,128,197,198,200,201,202,203,146,204,205,206,143,207,208,209,210,50,47,48,211,212,214,131,226,234,121,199,218,219,220,99,222,223,228,231,232,235])),ue([451,1,445,7,8,5,6,352,19,9,20,14,70,4,2,10,39,183,197,102,28,37,38,184,247,13,292,307,57,26,3,11,12,15,27,29,30,31,32,33,34,35,36,40,41,42,43,44,207,186,88,185,87,182,187,188,189,190,191,192,193,194,195,196,198,199,200,93,201,202,203,92,94,90,95,204,208,209,210,98,211,415,416,166,241,47,81,82,71,83,84,85,452,453,454,99,243,75,229,16,142,230,114,161,18,375,165,164,231,60,61,244,74,73,69,76,329,414,409,391,455,250,456,457,458,459,273,460,461,462,238,239,80,258,65,463,58,52,59,464,235,227,387,257,21,22,23,24,113,205,206,175,129,122,212,213,214,180,215,216,217,147,218,219,220,144,221,222,223,224,51,48,49,225,226,228,132,232,233,234,100,236,237,240,242,245,246,248,249]));d0=s}for(let s=0;s<i;s++){const n=t.at(s);if(n.enabled===!1)continue;$m.renderPriority=1-(1+s)/i,$m.renderPriorityStep=1/i,$m.ignoreDrivers=n.ignoreDrivers;const a=d0(this.symbol,n,this._context,$m),o=tA(e,()=>{this.symbolLayers[s]=null,a.destroy()});o&&r.push(o),this.symbolLayers[s]=a}if(await k2(this.symbolLayers,async(s,n)=>{if(s!=null)try{await s.load(),this._extentPadding+=Math.max(this._extentPadding,s.extentPadding)}catch{this.symbolLayers[n]=null}}),r.forEach(s=>s.remove()),qe(e),this.symbolLayers.length&&!this.symbolLayers.some(s=>!!s))throw new Error}getSymbolLayerSize(e){const t=this.symbolLayers[e];return t!=null?t.getCachedSize():null}get extentPadding(){return this._extentPadding}get symbologySnappingSupported(){return this.symbolLayers.some(e=>e?.queryForSnapping)}get needsUpdateFocus(){return this.symbolLayers.some(e=>e?.needsUpdateFocus===!0)}createGraphics3DGraphic(e,t){const{graphic:i}=e,r=this.symbolLayers.map(s=>s?.createGraphics3DGraphic(e)??null);return new Ej(i,t||this,r)}get complexity(){return Ib(this.symbolLayers.map(e=>e?.complexity))}globalPropertyChanged(e,t){const i=this.symbolLayers.length;for(let r=0;r<i;r++){const s=this.symbolLayers[r],n=a=>{const o=a.layers[r];return o instanceof ID?o:null};if(s!=null&&!s.globalPropertyChanged(e,t,n))return!1}return!0}applyRendererDiff(e,t){return this.loadStatus!==1?0:this.symbolLayers.reduce((i,r)=>i!==0&&r!=null?Math.min(i,r.applyRendererDiff(e,t)):i,2)}prepareSymbolPatch(e){if(this.loadStatus===2||e.diff.type!=="partial")return;const t=e.diff.diff;if(!t.symbolLayers||t.symbolLayers.type!=="partial")return;const i=t.symbolLayers.diff;this.symbolLayers.forEach((r,s)=>{if(r==null)return;const n=i[s];if(n){const a={diff:n,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};r.prepareSymbolLayerPatch(a),e.symbolStatePatches.push(...a.symbolLayerStatePatches),a.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push((o,l)=>{const c=o.layers[s];c!=null&&a.graphics3DGraphicPatches.forEach(u=>u(c,l))})}})}updateGeometry(e){return this._updateGeometryOrTransform(e,(t,i)=>!!t.updateGeometry&&t.updateGeometry(e.graphic,i))}updateTransform(e,t,i,r){return this._updateGeometryOrTransform(e,(s,n)=>!!s.updateTransform&&s.updateTransform(n,t,i,r))}_updateGeometryOrTransform(e,t){for(let i=0;i<this.symbolLayers.length;i++){const r=this.symbolLayers[i];if(r==null)continue;const s=e.layers[i];if(!s||!t(r,s))return!1}return!0}onRemoveGraphic(e){for(let t=0;t<this.symbolLayers.length;t++){const i=this.symbolLayers[t];if(i==null)continue;const r=e.layers[t];r!=null&&i.onRemoveGraphic(r)}}getFastUpdateStatus(){let e=!1,t=!1;for(const i of this.symbolLayers)if(i!=null){if(i.loadStatus===0)return 3;i.isFastUpdatesEnabled()?t=!0:e=!0}return t?e?2:1:e?0:4}async queryForSnapping(e,t,i,r){const s=this.symbolLayers.filter(Dg).filter(a=>a.queryForSnapping!=null).map(a=>a.queryForSnapping(e,t,i,r)),n=await Promise.all(s);return qe(r),n.flat()}destroy(){if(!this.destroyed){super.destroy();for(const e of this.symbolLayers)e?.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}get usedMemory(){return ZD(this)}},d0=null;const $m=new Aj;let Vj=class extends Lb{constructor(e,t,i){super(t),this.symbol=e,this._convert=i,this.symbologySnappingSupported=!1,this.graphics3DSymbol=null,this.referenced=0}getSymbolLayerSize(e){return this.graphics3DSymbol!=null?this.graphics3DSymbol.getSymbolLayerSize(e):null}get symbolLayers(){return this.graphics3DSymbol!=null?this.graphics3DSymbol.symbolLayers:[]}get extentPadding(){return this.graphics3DSymbol!=null?this.graphics3DSymbol.extentPadding:0}async doLoad(e){const t=await this.symbol.fetchSymbol({signal:e});t.id=this.symbol.id,this.graphics3DSymbol=this._convert(t),this.graphics3DSymbol!=null&&await this.graphics3DSymbol.load()}createGraphics3DGraphic(e){return this.graphics3DSymbol!=null?this.graphics3DSymbol.createGraphics3DGraphic(e,this):null}get complexity(){return this.graphics3DSymbol!=null?this.graphics3DSymbol.complexity:FD}globalPropertyChanged(e,t){return this.graphics3DSymbol!=null&&this.graphics3DSymbol.globalPropertyChanged(e,t)}applyRendererDiff(e,t){return this.graphics3DSymbol!=null?this.graphics3DSymbol.applyRendererDiff(e,t):0}prepareSymbolPatch(e){this.graphics3DSymbol!=null&&this.graphics3DSymbol.prepareSymbolPatch(e)}updateGeometry(e){return this.graphics3DSymbol!=null&&this.graphics3DSymbol.updateGeometry(e)}updateTransform(e,t,i,r){return this.graphics3DSymbol?.updateTransform(e,t,i,r)??!1}onRemoveGraphic(){}get needsUpdateFocus(){return!1}getFastUpdateStatus(){return this.graphics3DSymbol?.getFastUpdateStatus()??3}destroy(){this.graphics3DSymbol!=null&&this.graphics3DSymbol.destroy(),this.graphics3DSymbol=void 0,super.destroy()}get destroyed(){return this.graphics3DSymbol===void 0}get usedMemory(){return ZD(this)}};function F1(e){return e instanceof Vj?e.graphics3DSymbol:e instanceof Fj?e:null}const cse=1.2,hse=di,zj=4;let kj=class{constructor(e,t="center",i=!1,r=ze(),s=Mi(0,0,0,-1),n="world",a=w(),o=0){this.verticalOffset=e,this.anchor=t,this.hasLabelVerticalOffset=i,this.screenOffset=r,this.centerOffset=s,this.centerOffsetUnits=n,this.translation=a,this.elevationOffset=o}},Bj=class{constructor(e,t="center",i="center",r=null,s=ze(),n=!0){this.placement=e,this.horizontalPlacement=t,this.verticalPlacement=i,this.text=r,this.displaySize=s,this.isFocused=n}};const ku=()=>$.getLogger("esri.views.3d.layers.graphics.labelPlacement");let x3=class{constructor(e,t,i,r=null){this._graphic=e,this._symbol=t,this._class=i,this._disablePlacement=r}get placement(){const e=this._verticalOffsetPlacement;if(e==null)return null;const t=this._getPlacementInfo(e);if(t==null)return null;const i=t.anchor,r=!!e.hasLabelVerticalOffset,s=e.verticalOffset,n=new kj(s,i,r);return this._calculatePlacementOffsets(n,t)}get _verticalOffsetPlacement(){const e=this._class.labelPlacement,{_symbol:t,_graphic:i}=this,r=F1(i.graphics3DSymbol),s=r?.symbol.type==="point-3d"?r.symbol:null,n=Fs[e]||this._defaultPlacementInfo;return s?.supportsCallout()&&s.hasVisibleVerticalOffset()&&!i.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:s.verticalOffset.clone(),anchor:null,normalizedOffset:null}:!t?.hasVisibleVerticalOffset()||s!=null&&s.supportsCallout()&&s.verticalOffset&&!i.isDraped?{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}:n&&Nj(n.placement)?{placement:"above-center",verticalOffset:t.verticalOffset.clone(),anchor:"bottom",normalizedOffset:[0,n.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(ku().errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+e+" placement)"),null)}_getPlacementInfo(e){if(e.anchor)return e;const t=this._class.labelPlacement,i=Fs[t],r=i||this._defaultPlacementInfo;return t&&!i&&ku().warnOnce(`the requested label placement '${t}' is currently unsupported in SceneView.`),this._validatePlacementInfo(r)}_calculatePlacementOffsets(e,t){const i=this._graphic.graphic.geometry;if(i==null)return null;switch(i.type){case"point":this._setPointSpecificPlacement(e,t);break;case"mesh":this._setMeshSpecificPlacement(e,t);break;case"polygon":this._setPolygonSpecificPlacement(e,t)}const r=zj-dI;return e.screenOffset[0]+=r*t.normalizedOffset[0],e.screenOffset[1]+=r*t.normalizedOffset[1],e}get _defaultPlacementInfo(){const e=this._graphic.graphic.geometry;if(e==null)return null;switch(e.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:ia,anchor:"center"};case"polygon":return this._firstSymbolLayer?.type==="extrude"?Fs["above-center"]:{placement:"center-center",normalizedOffset:ia,anchor:"center"};case"point":case"mesh":return Fs["above-center"];default:return}}_validatePlacementInfo(e){const t=this._graphic.graphic.geometry;if(t==null)return null;if(this._disablePlacement!=null){const r=this._class.labelPlacement;return r?(ku().warnOncePerTick(C3(r,this._disablePlacement.logEntityDescription)),this._defaultPlacementInfo):e}const i=t.type;switch(i){case"polyline":case"polygon":case"extent":case"multipoint":{const r=this._class.labelPlacement;if(r)return Fs[r]&&ku().warnOnce(C3(r,`'${i}' geometries`)),this._defaultPlacementInfo;break}case"point":case"mesh":return e}return e}_setPointSpecificPlacement(e,t){const i=this._firstSymbolLayer;if(i==null)return;const r=this._graphic.layers[0];switch(r!=null?r.getCenterObjectSpace(e.translation):xe(e.translation,0,0,0),i.type){case"icon":case"text":this._setHUDSpecificPlacement(e,t,r);break;case"object":p0(e,t,r)}}_setMeshSpecificPlacement(e,t){const i=this._firstSymbolLayer;i!=null&&i.type==="fill"&&p0(e,t,this._graphic.layers[0])}_setPolygonSpecificPlacement(e,t){const i=this._firstSymbolLayer;if(i!=null&&i.type==="extrude"){const r=this._graphic.layers[0];r!=null?(r.getBoundingBoxObjectSpace(Jd),K2(Jd,e.translation),e.translation[2]=fM(Jd)/2):xe(e.translation,0,0,0),p0(e,t,r)}}_setHUDSpecificPlacement(e,t,i){const{_graphic:r}=this,s=i!=null?i.getScreenSize():null;if(r.isDraped||s==null)e.hasLabelVerticalOffset||e.anchor==="center"||(Fs[this._class.labelPlacement]&&ku().warnOncePerTick(`the requested placement '${t.placement}' is currently unsupported for draped graphics`),e.anchor="center");else{const n=this._normalizedSymbolAnchorPos;e.screenOffset[0]=s[0]/2*(t.normalizedOffset[0]-n[0]);const a=s[1]/2*(t.normalizedOffset[1]-n[1]);e.hasLabelVerticalOffset?(e.centerOffset[1]=a,e.centerOffsetUnits="screen"):e.screenOffset[1]=a}}get _firstSymbolLayer(){const e=this._graphic.graphics3DSymbol,t=F1(e);return t!=null?t.symbol.symbolLayers.at(0):null}get _normalizedSymbolAnchorPos(){const e=this._graphic.layers[0],t=e?.stageObject.geometries[0].material??null;if(t&&t instanceof z2){const i=t.parameters.anchorPosition;Bu[0]=2*(i[0]-.5),Bu[1]=2*(i[1]-.5)}else Bu[0]=0,Bu[1]=0;return Bu}};function C3(e,t){return`the requested label placement '${e}' is currently unsupported for ${t} in SceneView.`}function p0(e,t,i){const r=i!=null?i.getBoundingBoxObjectSpace(Jd):Jd,s=We(r[3]-r[0],r[4]-r[1],r[5]-r[2]),n=Math.sqrt(s[0]*s[0]+s[1]*s[1]);e.centerOffset[0]=n/2*t.normalizedOffset[0];const a=e.translation[2],o=s[2]/2*t.normalizedOffset[1];e.translation[2]=0,e.elevationOffset=a+o;const l=ge(s);e.centerOffset[2]=l/2*t.normalizedOffset[2]}function Nj(e){return e==="above-center"}const Fs={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},S3={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const e in S3){const t=S3[e],i=Fs[e];t.forEach(r=>{Fs[r]=i})}Object.freeze&&(Object.freeze(Fs),Object.keys(Fs).forEach(e=>{Object.freeze(Fs[e]),Object.freeze(Fs[e]?.normalizedOffset)}));const Bu=[0,0],Jd=eo();let jj=class QD{constructor(t){this.definition=t,this.key=JSON.stringify(t),this.haloSize=Math.round(t.halo.size),this.textStyle=T3(t.color),this.haloStyle=Uj(t.halo.color),this.backgroundStyle=t.background.color[3]!==0?T3(t.background.color):null}fontString(t){const i=this.definition.font;return`${i.style} ${i.weight} ${t}px ${i.family}, sans-serif, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol, Noto Color Emoji`}setFontProperties(t,i){t.font=this.fontString(i),t.textAlign="left",t.textBaseline="alphabetic"}static async fromSymbol(t,i){const r=t?.material?.color,s=wi.toUnitRGBA(r)??di,n=t.size!=null?Ig(t.size):12,a=t.lineHeight,o=t.background!=null?wi.toUnitRGBA(t.background.color):di,l={family:t.font?.family??"sans-serif",decoration:t.font?.decoration??"none",weight:t.font?.weight??"normal",style:t.font?.style??"normal"},c=t.halo,u=c?.color!=null&&c.size>0?{size:Ig(c.size),color:wi.toUnitRGBA(c.color)}:{size:0,color:di},p=new QD({color:s,size:n,background:{color:o,padding:t.background!=null?[.65*n,.5*n]:[0,0],borderRadius:t.background!=null?n*(6/16):0},lineSpacingFactor:a,font:l,halo:u,pixelRatio:i});if(t.font){let m=!1;const f=p.fontString(n);try{m=(await document.fonts.load(f)).some(g=>!JL(g))}catch{$.getLogger("esri.views.3d.webgl-engine.lib.TextRenderParameters").warnOnce(`Failed to preload font '${f}'. Some text symbology may be rendered using the default browser font.`)}if(!m&&!Hj.has(t.font.family))try{await eF(t.font)}catch{}}return p}};function Uj(e){return`rgb(${e.slice(0,3).map(t=>Math.floor(255*t)).toString()})`}function T3(e){return`rgba(${e.slice(0,3).map(t=>Math.floor(255*t)).toString()},${e[3]})`}const Hj=new Set(["Arial","Times New Roman","Courier New","serif","sans-serif","monospace","cursive","fantasy","system-ui","ui-serif","ui-sans-serif","ui-monospace","ui-rounded","math","emoji","fangsong"]),lo=4096;let Eh=class extends ie{constructor(e){super(e),this.id=uu(),this.events=new uc,this._glTexture=null,this._atlas=new Gj(256,256),this._needsRepack=!1,this._canRepack=!0,this._elementsToRender=new Map,this._elements=new Map,this._uvCallbacks=new Map,this.updating=!1}initialize(){this._canvas=document.createElement("canvas"),this._canvas.setAttribute("id","textAtlasCanvas"),this._canvas.setAttribute("style","display:none"),this._ctx=this._canvas.getContext("2d"),this._stage=this.view.stage,this._stage.addTexture(this),this._updateCanvasElementSize(this._atlas),this._reset()}unload(){this._glTexture=ye(this._glTexture),this._frameWorker=xi(this._frameWorker),this.updating=!1,this.events.emit("unloaded")}get loaded(){return this._glTexture!=null}get glTexture(){return this._glTexture}static get maxSize(){return ep=0,[lo-co-ep,lo-co-ep-P3]}load(e){if(this._glTexture)return this._glTexture;const t=new gt;return t.wrapMode=33071,t.samplingMode=9987,t.hasMipmap=!0,t.preMultiplyAlpha=!0,t.maxAnisotropy=e.parameters.maxMaxAnisotropy,this._glTexture=new bt(e,t,this._canvas),this._frameWorker=this.view.resourceController.scheduler.registerTask(mi.TEXT_TEXTURE_ATLAS,this),this.setDirty(),this._glTexture}dispose(){this._elements.clear(),this._elementsToRender.clear(),this._frameWorker=xi(this._frameWorker),this._glTexture&&(this._stage.removeTexture(this),this._glTexture=ye(this._glTexture)),this._canvas.width=0,this._canvas.height=0,this._canvas=null,this._ctx=null}_updateCanvasElementSize(e){this._canvas.width=e.width,this._canvas.height=e.height}_resizeAtlas(e,t){const{width:i,height:r}=this._atlas;i===e&&r===t||(this._atlas.width=e,this._atlas.height=t,this._glTexture?.resize(e,t),this._glTexture?.updateData(0,0,0,i,r,this._canvas),this._updateCanvasElementSize(this._atlas),this._elements.forEach(s=>this._uvCallbacks.get(s.textRenderer.key)?.forEach(n=>n(s.uv))),this._reset())}_reset(){this._elementsToRender.clear(),this._atlas.reset(),this._needsRepack=!0,this.setDirty()}_addAtlasElement(e,t,i,r){const s=this._atlas;if(s.width<i||s.height<r)return!1;let n=s.cursors.get(r);if(!n){if(s.height<s.nextY+r)return!1;n=[new M3(s.nextY)],s.cursors.set(r,n),s.nextY+=r}let a=n.find(o=>s.width>=o.x+i);if(a==null){if(s.height<s.nextY+r)return!1;a=new M3(s.nextY),s.nextY+=r,n.push(a)}return e.setNewPosition(a),this._elements.set(t,e),this._elementsToRender.set(t,e),a.x+=i,!0}_ensureCallbacks(e){const t=this._uvCallbacks.get(e);if(t)return t;const i=new Set;return this._uvCallbacks.set(e,i),i}_addCallback(e,t){this._ensureCallbacks(e).add(t)}_removeCallback(e,t){const i=this._uvCallbacks.get(e);return!(!i?.delete(t)||i.size!==0)&&(this._uvCallbacks.delete(e),!0)}_processAddition(e){const t=e.textRenderer.key;if(this._needsRepack)return void this._elements.set(t,e);const i=this._atlas,r=e.textRenderer.renderedWidth,s=e.textRenderer.renderedHeight,n=r+co,a=s+co+P3;if(!this._addAtlasElement(e,t,n,a)){if(this._canRepack)this._reset();else if(i.width<n){const o=hy(Math.max(n,1.5*i.width),lo);this._resizeAtlas(o,i.height)}else{const o=i.nextY+a,l=hy(Math.max(o,1.5*i.height),lo);if(l>i.height)this._resizeAtlas(i.width,l);else if(i.width<lo){const c=hy(1.5*i.width,lo);this._resizeAtlas(c,i.height)}}this._elements.set(t,e)}}_renderElement(e){const t=e.commitNewPosition(),i=e.textRenderer;this._ctx.clearRect(t[0]-co,t[1]-co,i.renderedWidth+2*co,i.renderedHeight+2*co),i.render(this._ctx,t[0],t[1]),this._uvCallbacks.get(i.key)?.forEach(r=>r(e.uv))}get readyToRun(){return this.updating}runTask(e){if(this._glTexture==null)return Fi;for(;this._needsRepack&&(this._canRepack||this._atlas.height<lo&&this._atlas.height<lo);){this._canRepack=this._needsRepack=!1;const t=this._elements;this._elements=new Map,t.forEach(i=>this._processAddition(i)),e.madeProgress()}if(this._elementsToRender.size>0){for(const[t,i]of this._elementsToRender){if(e.done)break;this._renderElement(i),this._elementsToRender.delete(t),e.madeProgress()}this._glTexture.setData(this._canvas)}this.updating=this._elementsToRender.size>0}addText(e,t){const i=e.key;this._addCallback(i,t);let r=this._elements.get(i);return r?Mf(r.uv,di)||t(r.uv):(r=new qj(e),this._processAddition(r),this.setDirty()),{remove:()=>this._removeText(e,t)}}_removeText(e,t){const i=e.key;this._elements.get(i)&&this._removeCallback(i,t)&&(this._elements.delete(i),this._elementsToRender.delete(i),this._canRepack=!0)}setDirty(){this._glTexture&&(this.updating=!0)}get test(){}get usedMemory(){return(this._glTexture?.usedMemory??0)+(this._canvas?.width??0)*(this._canvas?.height??0)*4}};h([d({constructOnly:!0})],Eh.prototype,"view",void 0),h([d({type:Boolean})],Eh.prototype,"updating",void 0),Eh=h([D("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],Eh);const co=2,P3=2;let qj=class{constructor(e){this.textRenderer=e,this._uv=Vt(),this._newPosition=[0,0]}get uv(){if(this._xOffset==null||this._yOffset==null)return di;const{renderedWidth:e,renderedHeight:t}=this.textRenderer;return cr(this._uv,this._xOffset,this._yOffset+t,this._xOffset+e,this._yOffset)}setNewPosition(e){this._newPosition[0]=e.x,this._newPosition[1]=e.y}commitNewPosition(){return this._xOffset=this._newPosition[0],this._yOffset=this._newPosition[1],this._newPosition}get xOffset(){return this._xOffset}get yOffset(){return this._yOffset}},Gj=class{constructor(e,t){this.width=e,this.height=t,this.cursors=new Map,this.nextY=0}reset(){this.cursors.clear(),this.nextY=ep}},M3=class{constructor(e){this.y=e,this.x=ep}},ep=0;const $j=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","transformationChanged","shaderTransformationChanged","visibilityChanged","occlusionChanged","highlightChanged","geometryAdded","geometryRemoved","attributesChanged"];let XD=class{constructor(e,t,i=""){this.stage=e,this.apiLayerViewUid=i,this.id=uu(),this.events=new uc,this.visible=!0,this.sliceable=!1,this._objectsAdded=new Array,this._handles=new C_,this._objects=new Map,this._pickable=!0,this.visible=t?.visible??!0,this._pickable=t?.pickable??!0,this.updatePolicy=t?.updatePolicy??0,e.addLayer(this);for(const r of $j)this._handles.add(this.events.on(r,s=>e.handleEvent(r,s)))}destroy(){this._handles.size&&(this._handles.destroy(),this.stage.removeLayer(this),this.invalidateSpatialQueryAccelerator())}get objects(){return this._objects}getObject(e){return ec(this._objects.get(e))}set pickable(e){this._pickable=e}get pickable(){return this._pickable&&this.visible}add(e){this._objects.set(e.id,e),e.layer=this,this.events.emit("layerObjectAdded",e),this._octree!=null&&this._objectsAdded.push(e)}remove(e){this._objects.delete(e.id)&&(this.events.emit("layerObjectRemoved",e),e.layer=null,this._octree!=null&&(zs(this._objectsAdded,e)||this._octree.remove([e])))}addMany(e){for(const t of e)this._objects.set(t.id,t),t.layer=this;this.events.emit("layerObjectsAdded",e),this._octree!=null&&this._objectsAdded.push(...e)}removeMany(e){const t=new Array;for(const i of e)this._objects.delete(i.id)&&t.push(i);if(t.length!==0&&(this.events.emit("layerObjectsRemoved",t),t.forEach(i=>i.layer=null),this._octree!=null)){for(let i=0;i<t.length;)zs(this._objectsAdded,t[i])?(t[i]=t[t.length-1],t.length-=1):++i;this._octree.remove(t)}}commit(){this.stage.commitLayer(this)}sync(){this.updatePolicy!==1&&this.stage.syncLayer(this.id)}notifyObjectBBChanged(e,t){this._octree==null||this._objectsAdded.includes(e)||this._octree.update(e,t)}getSpatialQueryAccelerator(){return this._octree==null&&this._objects.size>50?(this._octree=new RF(e=>e.boundingVolumeWorldSpace.bounds),this._octree.add(this._objects.values())):this._octree!=null&&this._objectsAdded.length>0&&(this._octree.add(this._objectsAdded),this._objectsAdded.length=0),this._octree}invalidateSpatialQueryAccelerator(){this._octree=Z(this._octree),this._objectsAdded.length=0}get test(){}},R3=class{constructor(e,t){this.labelingContext=e,this.graphics3DGraphic=t,this.hasGraphics3DResources=!1,this.visible=!1,this.textureAtlasHandles=[],this.textInitialized=!1,this.textRenderers=new Array,this.textLabelPlacements=new Array}},Wj=class{constructor(e,t,i,r,s){this.labelClass=e,this.graphics3DSymbol=t,this.graphics3DCalloutSymbolLayer=i,this.textRenderParameters=r,this.labelFunction=s,this.calloutSymbolLayerIndex=0,this.graphics=new Map,this.scaleVisibility=null}},Zj=class{constructor(e,t,i,r,s,n,a,o){this.layer=t,this.graphics3DCore=i,this.scaleVisibility=r,this.emptySymbolLabelSupported=s,this.elevationInfoOverride=n,this.disablePlacement=a,this.active=o,this.labelClassAbortController=new AbortController,this._labelClassContexts=new Array,this.graphics=new Map,this.labelsToInitialize=new Map,this.stageLayer=new XD(e,{pickable:!0},i.owner.layerViewUid)}destroy(){this.stageLayer.destroy()}get labelClassContexts(){return this._labelClassContexts}setLabelClassContext(e,t){this._labelClassContexts[e]=t}resetLabelClassContext(){this._labelClassContexts.length=0}},Sl=class extends ie{constructor(e){super(e),this._hudMaterials=new Map,this._calloutMaterials=new Map,this._dirty=!1,this._focusAreasLabelsQueue=new Iv,this._labels=new Map,this._labelingContexts=new Array}setup(){this.dispose(),this.addHandles([M(()=>this.view.state?.camera,()=>this.setDirty()),M(()=>this.view.state?.rasterPixelRatio,()=>this._resetAllLabels()),M(()=>this.view.focusAreasView?.polygons,()=>this._updateFocus()),this.view.resourceController.scheduler.registerTask(mi.LABELER,this)]),Df()&&this.addHandles(M(()=>this.view.scale,()=>this._updateScaleVisibility())),this._textTextureAtlas=new Eh({view:this.view})}dispose(){this.removeAllHandles(),this._textTextureAtlas=ye(this._textTextureAtlas),this._hudMaterials.clear(),this._calloutMaterials.clear(),this._labelingContexts.length=0,this._labels.clear()}destroy(){this.dispose(),Js.graphic=null,Js.renderingInfo=null,Js.layer=null}_updateFocus(){this._focusAreasLabelsQueue.clear(),this._labelingContexts.forEach(e=>{e.graphics.forEach(t=>{this._focusAreasLabelsQueue.push({graphic3DGraphic:t,labelingContext:e})})})}_activateLabelingContext(e){e.graphics.forEach((t,i)=>{const r=new R3(e,t);this._labels.set(i,r),e.labelsToInitialize.set(i,r),t.setVisibilityFlag(16,1,!0)}),e.active=!0}_deactivateLabelingContext(e){e.graphics.forEach((t,i)=>{t.setVisibilityFlag(16,1,!1),this.setLabelGraphicVisibility(t,!1),t.clearLabelGraphics(),this._labels.delete(i)}),e.active=!1}_addLabelTextureToAtlas(e){if(this._textTextureAtlas)for(const t of e.graphics3DGraphic.labelLayers){if(!t.labelClass)continue;const i=e.textRenderers[t.labelClassContextIndex];i&&(e.textureAtlasHandles.push(this._textTextureAtlas.addText(i,r=>Xj(t.stageObject,r))),Qj(t.stageObject,i))}}_removeLabelTextureFromAtlas(e){e.textureAtlasHandles.forEach(t=>t.remove()),e.textureAtlasHandles.length=0}get readyToRun(){return this.view.ready&&(this._dirty||this.deconflictor.readyToRun||this._focusAreasLabelsQueue.length>0)}runTask(e){return this._updateLabels(e),this._applyFocusAreasUpdates(e),!this._dirty&&this.deconflictor.readyToRun&&this.deconflictor.runTask(e),Fi}_updateLabels(e){if(this._dirty){this._dirty=!1;for(const t of this._labelingContexts)if(t.active){if(Wm(t))this._dirty=!0;else if(m0(t.labelClassContexts)){if(t.labelClassContexts===null){this._deactivateLabelingContext(t);continue}this._createLabelClassContext(t),this._dirty=!0}else for(const[i,r]of t.labelsToInitialize)if(this._ensureGraphics3DResources(r)&&(this._labels.set(i,r),this.deconflictor.setDirty(),e.madeProgress()),(r.visible&&r.textInitialized||!r.visible&&r.hasGraphics3DResources)&&(t.labelsToInitialize.delete(i),e.madeProgress()),e.done){this._dirty=!0;break}}this._dirty||this.notifyChange("updating")}}_applyFocusAreasUpdates(e){for(;this._focusAreasLabelsQueue.length>0&&!e.done;){e.madeProgress();const{graphic3DGraphic:t,labelingContext:i}=this._focusAreasLabelsQueue.pop();if(t.labelLayers.length===0||!i.active)continue;const r=fj(t.graphic.geometry);if(r==null)continue;const s=this.view.focusAreasView?.containsGeometry(r)??!0;t.labelLayers.forEach(n=>{n.stageObject.geometries.some(a=>a.material.parameters.isFocused!==s)&&(this._removeGraphic(i,t),this._addGraphic(i,t),this.setDirty())})}this._focusAreasLabelsQueue.length===0&&(this.notifyChange("readyToRun"),this.notifyChange("updating"))}async _createLabelClassContextAsync(e){const t=e.labelClassAbortController?.signal;e.layer.when&&await e.layer.when(),qe(t),e.scaleVisibility?.updateScaleRangeActive();const i=e.graphics3DCore,r=i.layer,s=r.labelingInfo?.filter(n=>!!n.symbol);!s||s.length===0||(await k2(s,async(n,a)=>{const o=n.symbol,l=F1(i.getOrCreateGraphics3DSymbol(o));if(l==null)return void $.getLogger(this).error("Failed to create Graphics3DSymbol for label");await l.load(),qe(t);let c=null;_M(o)&&o.hasVisibleCallout()&&(c=Rj(o,i.symbolCreationContext),await c.load(),qe(t));const u=await kg(tF(n,e.layer.fieldsIndex,this.view.spatialReference));if(qe(t),u.ok===!0){const p=await this._createTextRenderParameters(l.symbol);qe(t);const m=new Wj(n,l,c,p,u.value);this._updateLabelClassContextVisibility(m),e.setLabelClassContext(a,m)}else $.getLogger(this).error(`Label expression failed to evaluate: ${u.error}`)}),qe(t))}async _createLabelClassContext(e){return e.labelClassPromise==null&&(e.labelClassPromise=this._createLabelClassContextAsync(e).catch(t=>{if(js(t))throw t;e.resetLabelClassContext()}).then(()=>{e.labelClassAbortController=null,this.notifyChange("updating")}).catch(()=>{}),this.notifyChange("updating")),e.labelClassPromise}async _createTextRenderParameters(e){const t=e.symbolLayers.at(0);return t?.type!=="text"?null:jj.fromSymbol(t,this.view.state.rasterPixelRatio)}_destroyLabelClassContext(e){for(const i of e.labelClassContexts)i&&--i.graphics3DSymbol.referenced;const t=e.labelClassAbortController;e.labelClassAbortController=new AbortController,Ar(t),e.resetLabelClassContext(),e.labelClassPromise=null,this.notifyChange("updating")}_createTextSymbolGraphic(e,t,i,r,s,n){if(!this._textTextureAtlas)return null;const a=new Bj(i,ix(i.anchor),oI(i.anchor),e.text,yu(e.displayWidth,e.displayHeight));return Js.graphic=t,Js.layer=r,Js.renderingInfo=null,s.createLabel(Js,a,this._hudMaterials,this._textTextureAtlas,()=>n.placement?.elevationOffset??null)}_createLineCalloutGraphic(e,t,i,r,s){Js.graphic=e,Js.layer=s;const n=r.screenOffset[0];return Js.renderingInfo=new Pj(null,t,r.translation,r.centerOffset,n,r.centerOffsetUnits,r.elevationOffset),i.createGraphics3DGraphic(Js,this._calloutMaterials)}_ensureGraphics3DResources(e){if(e.hasGraphics3DResources)return!1;const t=e.graphics3DGraphic;if(t.destroyed)return!1;this._ensureTextTextureResources(e);const i=e.labelingContext,r=i.labelClassContexts;if(m0(r)||!i.emptySymbolLabelSupported&&t.layers.length===0)return!1;let s=!1;const n=t.graphic,a=i.layer,o=Zm(i.layer);for(let l=0;l<r.length;l++){const c=e.textRenderers[l],u=e.textLabelPlacements[l],p=r[l];if(c==null||u==null||p==null)continue;const m=p.graphics3DSymbol,f=Yj(m),g=m.symbolLayers[0];if(!g)continue;g.setElevationInfoOverride(i.elevationInfoOverride);const y=new x3(t,f,p.labelClass),v=this._createTextSymbolGraphic(c,n,u,a,g,y);if(v==null)return!1;v.labelClass=p.labelClass,v.labelClassContextIndex=l,t.addLabelGraphic(v,i.stageLayer),this.deconflictor.setPriority(t,p.textRenderParameters?.definition.size??0),t.setVisibilityFlag(16,1,o),t.setVisibilityFlag(16,2,p.scaleVisibility??!0),t.setVisibilityFlag(16,8,!1),Df()&&p.graphics.set(n.uid,t),s=!0;const C=p.graphics3DCalloutSymbolLayer;if(C&&u.hasLabelVerticalOffset){C.setElevationInfoOverride(i.elevationInfoOverride);const b=this._createLineCalloutGraphic(n,f,C,u,a);b!=null&&(p.calloutSymbolLayerIndex=t.labelLayers.length,t.addLabelGraphic(b,i.stageLayer))}break}return s&&i.scaleVisibility?.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(e){const t=e.labelingContext.labelClassContexts;for(const i of e.graphics3DGraphic.labelLayers)i.labelClass!=null&&t[i.labelClassContextIndex].graphics3DSymbol.symbolLayers[0]?.onRemoveGraphic(i);e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}_ensureTextTextureResources(e){if(e.textInitialized)return;const t=e.labelingContext,i=t.labelClassContexts;if(m0(i))return;const r=e.graphics3DGraphic.graphic;for(let s=0;s<i.length;s++){const n=i[s];if(e.textRenderers[s]=null,e.textLabelPlacements[s]=null,n?.textRenderParameters==null)continue;const a=n.labelFunction;let o;if(a.type==="arcade")try{const v=a.needsHydrationToEvaluate()?lI(r,t.layer,null):r;o=a.evaluate(v)}catch{o=null}else o=a.evaluate(r);if(o==null||o===""||/^\s+$/.test(o))continue;const l=n.graphics3DSymbol;if(!l.symbolLayers[0])continue;const c=e.graphics3DGraphic,u=l.symbol?.type==="label-3d"?l.symbol:null,p=n.labelClass,m=t.disablePlacement,f=new x3(c,u,p,m).placement;if(f==null)continue;const g=ix(f.anchor),y=hI(g);e.textRenderers[s]=new cI(o,y,n.textRenderParameters,Eh.maxSize),e.textLabelPlacements[s]=f}e.textInitialized=!0}_destroyTextTextureResources(e){e.textInitialized=!1,e.textRenderers.length=0,e.textLabelPlacements.length=0}_addGraphic(e,t){const i=t.graphic.uid;if(e.graphics.set(i,t),e.active){const r=new R3(e,t);this._labels.set(i,r),e.labelsToInitialize.set(i,r)}this.setDirty(),this.deconflictor.setDirty()}_updateGraphicGeometry(e,t){const i=t.graphic.uid,r=this._labels.get(i);if(!r)return!0;for(const s of r.graphics3DGraphic.labelLayers)if(s.labelClass!=null&&!e.labelClassContexts[s.labelClassContextIndex].graphics3DSymbol.symbolLayers[0].updateGeometry(t.graphic,s))return!1;return this.setDirty(),this.deconflictor.setDirty(),!0}_removeGraphic(e,t){const i=t.graphic.uid,r=this._labels.get(i);e.graphics.delete(i),e.labelClassContexts.forEach(s=>s?.graphics.delete(i)),r&&(this._destroyGraphic(r,i),e.labelsToInitialize.delete(i),this.setDirty(),this.deconflictor.setDirty())}_destroyGraphic(e,t){this._labels.delete(t),e.textureAtlasHandles.length&&this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)}async _labelingInfoChange(e,t){if(!t)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const i of t){const r=e.graphics.get(i);r&&(this._removeGraphic(e,r),this._addGraphic(e,r))}}_globalPropertyChanged(e,t){for(const i of t.labelClassContexts){if(!i)continue;const r=new Map;t.graphics.forEach(n=>r.set(n.graphic.uid,n));const s=n=>n.labelLayers[0];if(i.graphics3DSymbol.symbolLayers[0].globalPropertyChanged(e,r,s),i.graphics3DCalloutSymbolLayer){const n=a=>a.labelLayers[i.calloutSymbolLayerIndex];i.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,r,n)}}}_visibilityInfoChange(e){const t=Zm(e.layer);t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty()}_resetAllLabels(){for(const e of this._labelingContexts)this._resetLabels(e)}_resetLabels(e){e.graphics.forEach((t,i)=>{const r=this._labels.get(i);r&&(this._destroyGraphic(r,i),r.visible=!1,e.labelsToInitialize.set(i,r))}),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}_findLabelingContext(e){for(const t of this._labelingContexts)if(t.graphics3DCore===e)return t;return null}addGraphicsOwner(e,t,i){const r=i?.emptySymbolLabelSupported||!1,s=i?.elevationInfoOverride||null,n=i?.disablePlacement||null;if(this._findLabelingContext(e))return;const a=e.layer,o=new Zj(this.view.stage,a,e,t,r,s,n,Zm(a));return this._labelingContexts.push(o),this.setDirty(),{addGraphic:l=>this._addGraphic(o,l),removeGraphic:l=>this._removeGraphic(o,l),updateGraphicGeometry:l=>this._updateGraphicGeometry(o,l),layerLabelsEnabled:()=>Zm(o.layer),labelingInfoChange:l=>this._labelingInfoChange(o,l),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",o),screenSizePerspectiveEnabledChanged:()=>this._globalPropertyChanged("screenSizePerspectiveEnabled",o),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",o),visibilityInfoChange:()=>this._visibilityInfoChange(o),reset:()=>this._resetLabels(o),remove:()=>this._removeGraphicsOwner(e),setDirty:()=>this.setDirty()}}_removeGraphicsOwner(e){const t=this._findLabelingContext(e);if(!t)return;const i=this._labelingContexts.indexOf(t);this._labelingContexts.splice(i,1),t.graphics.forEach(r=>this._removeGraphic(t,r)),t.destroy(),this.setDirty()}_updateScaleVisibility(){for(const e of this._labelingContexts)if(e.active&&!Wm(e))for(const t of e.labelClassContexts)this._updateLabelClassContextVisibility(t)}_updateLabelClassContextVisibility(e){if(!e||!Df())return;const{labelClass:t,graphics:i}=e,r={minScale:t.minScale,maxScale:t.maxScale},s=dF(r,this.view.scale),n=e.scaleVisibility==null||e.scaleVisibility!==s;e.scaleVisibility=s,n&&i.size&&(i.forEach(a=>a.setVisibilityFlag(16,2,s)),this.deconflictor.setDirty(),this.setDirty())}setLabelGraphicVisibility(e,t){const i=e.graphic.uid,r=this._labels.get(i);r&&r.visible!==t&&(t&&!r.textureAtlasHandles.length?(this._addLabelTextureToAtlas(r),r.textInitialized||r.labelingContext.labelsToInitialize.set(i,r)):!t&&r.textureAtlasHandles.length&&this._removeLabelTextureFromAtlas(r),r.visible=t,this.setDirty())}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._dirty||this._textTextureAtlas?.updating||this.deconflictor.updating||this._labelingContexts.some(e=>Wm(e))||this._focusAreasLabelsQueue.length>0}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce((t,i)=>t+(Wm(i)?0:1),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}get usedMemory(){return this._textTextureAtlas?.usedMemory??0}get test(){}};function Qj(e,t){e.geometries[0].setAttributeData("size",[t.displayWidth,t.displayHeight]),e.geometryVertexAttributeUpdated(e.geometries[0],"size")}function Xj(e,t){e.geometries[0].setAttributeData("uvi",t),e.geometryVertexAttributeUpdated(e.geometries[0],"uvi",!0)}function Wm(e){return!!e.labelClassPromise&&!!e.labelClassAbortController}function m0(e){return(e?.length??0)===0}function Yj(e){return e.symbol?.type==="label-3d"?e.symbol:null}function Zm(e){return!!e.labelsVisible&&!!e.labelingInfo?.some(t=>!!t.symbol)}h([d({constructOnly:!0})],Sl.prototype,"view",void 0),h([d({constructOnly:!0})],Sl.prototype,"deconflictor",void 0),h([d()],Sl.prototype,"_textTextureAtlas",void 0),h([d({type:Boolean,readOnly:!0})],Sl.prototype,"updating",null),Sl=h([D("esri.views.3d.layers.graphics.Labeler")],Sl);const Js=new Mj(null,null,null);let Kj=class{constructor(e){this._layerView=e,this._lodGlobalDirty=!1}destroy(){this._index=null,this._lodGlobalHandling=null,this._removeNodes=null}startNodeLoading(e,t,i){this._maxLodLevel=i.maxLodLevel,this._index=t,this._removeNodes=e}shouldLoadNode(e){if(e==null)return!1;const t=this._index.nodeTraversalState(e);return!!this._isChosenMaxLOD(t)||!!t.isChosen&&this._childrenRequireLoading(e)}setLodGlobalDirty(){this._lodGlobalDirty=!0}get requiresLODGlobalHandling(){return this._index!=null&&this._lodGlobalDirty===!0}lodGlobalHandling(e){if(!this.requiresLODGlobalHandling)return!1;this._lodGlobalDirty=!1;const t=this._layerView.view.resourceController.memoryController.usedMemory,i=Math.max(0,Math.floor(10*(t-1)));An.clear(),this._lodGlobalHandling(this._index.rootNode,i,!1,!!this._layerView.nodeCrossfadingEnabled);const r=An.length;this._removeNodes(An,e);const s=An.length<r;return An.length!==0&&(this._lodGlobalDirty=!0),An.clear(),s}_lodGlobalHandling(e,t,i,r){if(e==null)return!1;const s=e.index,n=this._index,a=this._layerView,o=n.nodeTraversalState(e),l=this._isChosenMaxLOD(o),c=e.resources.isEmpty;if(l&&c)return e.childrenLoaded>0&&this._removeChildrenRecursive(e),!0;const u=a.isNodeLoaded(s);if(r&&u&&l){const v=!i&&this.hasNoVisibleChildren(e);a.fadeNode(s,0,!v)}const p=u&&(!a.isNodeFullyFadedIn||a.isNodeFullyFadedIn(s));if(u&&(a.updateNodeState(s,l?1:0),l))return p&&this._removeChildrenRecursive(e),p;const m=e.childCount>0;let f=m;if(m)for(let v=0;v<e.childCount;v++){const C=n.getChildIndex(s,v),b=n.getNode(C);b!=null?!n.isGeometryVisible(C)||this._lodGlobalHandling(b,t,i||p,r)||(f=!1):n.isNodeVisible(C)&&(f=!1)}const g=u&&!l&&(f||An.length<t);g&&An.push(s),!r||g||!u||i||f||a.fadeNode(s,0,!1);const y=e.resources.isEmpty;return f||p&&!g||y}_removeChildrenRecursive(e){this._index.traverseDescendants(e,t=>((this._layerView.isNodeLoaded(t.index)||this._layerView.isNodeReloading(t.index))&&An.push(t.index),t.childrenLoaded>0))}hasNoVisibleChildren(e){let t=!0;return this._index.traverseDescendants(e,i=>!(!t||!this._index.isNodeVisible(i.index))&&(this._layerView.isNodeLoaded(i.index)?(t=!1,!1):i.childrenLoaded>0)),t}_childrenRequireLoading(e){let t=!1,i=!0;return this._index.traverseDescendants(e,r=>{if(!i||!this._index.isNodeVisible(r.index))return!1;const s=this._index.nodeTraversalState(r);return this._isChosenMaxLOD(s)&&this._index.isGeometryVisible(r.index)&&(t=!0),this._layerView.isNodeLoaded(r.index)?(i=!1,!1):r.childrenLoaded>0}),i&&t}_isChosenMaxLOD(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)}static cleanupI3SLodHandling(){An.prune()}};const An=new jt({deallocator:null});let YD=class{constructor(e="scene"){this.context=e,this.extent=zo(),this.spatialReference=null}};const Jj=1,D3=Symbol("layerHandles");let Lc=class extends gu{get spatialReference(){return this.view.spatialReference}constructor(e){super(e),this._elevationOffset=0}initialize(){this._renderCoordsHelper=this.view.renderCoordsHelper,this._intersectLayers=[this.stageLayer],this._intersector=new Us(this.view.state.viewingMode),this._intersector.options.store=0;const e=this._computeLayerExtent(this.spatialReference,this.stageLayer);this._zmin=e[2],this._zmax=e[5];const t=this.stageLayer.events;this.addHandles([t.on(["layerObjectAdded","layerObjectRemoved","transformationChanged","shaderTransformationChanged"],i=>this._objectChanged(i)),t.on(["geometryAdded","geometryRemoved"],({object:i})=>this._objectChanged(i)),t.on("attributesChanged",({attribute:i,object:r})=>ND(i)&&this._objectChanged(r))],D3)}destroy(){this.removeHandles(D3)}elevationInfoChanged(){const e=this.layer!=null?this.layer.elevationInfo:null;if(e!=null&&e.mode!=="on-the-ground"){const t=w4(this.layer.spatialReference),i=yM(e.unit??"meters");this._elevationOffset=(e.offset??0)*i/t}else this._elevationOffset=0}getElevation(e,t,i,r){if(mr[0]=e,mr[1]=t,mr[2]=i,!this._renderCoordsHelper.toRenderCoords(mr,r,mr))return $.getLogger(this).error("could not project point for elevation alignment"),null;const s=this._elevationOffset,n=this._zmin+s,a=this._zmax+s;this._renderCoordsHelper.setAltitude(O3,a,mr),this._renderCoordsHelper.setAltitude(E3,n,mr);const o=l=>!!l.lastValidElevationBB;return this._intersector.reset(O3,E3,null),this._intersector.intersect(this._intersectLayers,null,Jj,null,o),this._intersector.results.min.getIntersectionPoint(mr)?this._renderCoordsHelper.getAltitude(mr):null}_objectChanged(e){const t=this.spatialReference;if(!e.lastValidElevationBB||!t)return;Gs(ma);const i=e.lastValidElevationBB;i.isEmpty()||this._expandExtent(t,i.min,i.max,ma);const{min:r,max:s}=e.boundingVolumeWorldSpace;this._expandExtent(t,r,s,ma),J2(ma,bd.extent),this._zmin=Math.min(this._zmin,ma[2]),this._zmax=Math.max(this._zmax,ma[5]),bd.spatialReference=t,this.emit("elevation-change",bd),bd.spatialReference=null,i.assignMinMax(r,s)}_computeLayerExtent(e,t){return Gs(ma),e!=null&&t.objects.forEach(i=>this._expandExtent(e,i.boundingVolumeWorldSpace.min,i.boundingVolumeWorldSpace.max,ma)),ma}_expandExtent(e,t,i,r){for(let s=0;s<8;++s)mr[0]=1&s?t[0]:i[0],mr[1]=2&s?t[1]:i[1],mr[2]=4&s?t[2]:i[2],this._renderCoordsHelper.fromRenderCoords(mr,mr,e),Ng(r,mr);return r}};h([d({constructOnly:!0})],Lc.prototype,"layer",void 0),h([d({constructOnly:!0})],Lc.prototype,"stageLayer",void 0),h([d({constructOnly:!0})],Lc.prototype,"view",void 0),h([d()],Lc.prototype,"spatialReference",null),Lc=h([D("esri.views.3d.layers.support.StageLayerElevationProvider")],Lc);const ma=Gs(),bd=new YD;function eU(){bd.spatialReference=null}const mr=w(),O3=w(),E3=w();let wd=class extends ie{get parameters(){return this._parameters}get labelParameters(){return this._labelParameters}get _calculations(){return this.view.state.isGlobal?new iU(this.view.renderCoordsHelper?.referenceEllipsoid.radius??0):new tU}constructor(e){super(e),this._parameters=new Uw,this._labelParameters=new Uw}initialize(){this.addHandles([M(()=>({distance:this.view.pointsOfInterest?.centerOnSurfaceInfrequent?.distance??0,fovY:this.view.state.camera.fovY}),e=>this._update(e),Ve)])}_update(e){const t=this._updateParameters(this._parameters,eg,e),i=this._updateParameters(this._labelParameters,sU,e);return t||i}_updateParameters(e,t,i){if(e&&e.camera.fovY===i.fovY&&e.camera.distance===i.distance)return!1;const{scaleStart:r,scaleFallOffRange:s}=t,{fovY:n,distance:a}=i;this._calculations.calculateCurvatureDependentParameters(f0,t,i);const o=this._calculations.surfaceCoverageCompensation(i,f0),{tiltAngle:l,scaleFallOffFactor:c}=f0,u=Math.sin(l)*a,p=.5*Math.PI-l-n*(.5-r*o),m=u/Math.cos(p),f=p+n*s*o,g=(m-c*(u/Math.cos(f)))/(1-c);return e.camera.fovY=i.fovY,e.camera.distance=i.distance,e.offset=g,e.divisor=m-g,e.minPixelSize=t.minPixelSize,!0}};h([d({constructOnly:!0})],wd.prototype,"view",void 0),h([d()],wd.prototype,"_calculations",null),wd=h([D("esri.views.3d.state.ScreenSizePerspective")],wd);let tU=class{surfaceCoverageCompensation(e,t){return uI(t.tiltAngle,e.fovY)}calculateCurvatureDependentParameters(e,t){e.tiltAngle=t.curvatureDependent.min.tiltAngle,e.scaleFallOffFactor=t.curvatureDependent.min.scaleFallOffFactor}},iU=class{constructor(e){this._ellipsoidRadius=e}surfaceCoverageCompensation(e,t){return I_(A3,this._ellipsoidRadius),wL(A3,t.tiltAngle,e.distance,e.fovY)}calculateCurvatureDependentParameters(e,t,i){const r=t.curvatureDependent,s=1+i.distance/this._ellipsoidRadius,n=Math.sqrt(s*s-1),[a,o]=[r.min.curvature,r.max.curvature],l=j((n-a)/(o-a),0,1),[c,u]=[r.min,r.max];e.tiltAngle=De(c.tiltAngle,u.tiltAngle,l),e.scaleFallOffFactor=De(c.scaleFallOffFactor,u.scaleFallOffFactor,l)}},rU=class{constructor(){this.tiltAngle=0,this.scaleFallOffFactor=0}};const eg={curvatureDependent:{min:{curvature:rt(10),tiltAngle:rt(12),scaleFallOffFactor:.5},max:{curvature:rt(70),tiltAngle:rt(40),scaleFallOffFactor:.8}},scaleStart:.3,scaleFallOffRange:.65,minPixelSize:0},sU={...eg,curvatureDependent:{min:{...eg.curvatureDependent.min,scaleFallOffFactor:.7},max:{...eg.curvatureDependent.max,scaleFallOffFactor:.95}},minPixelSize:14},f0=new rU,A3=Kr();let Ot=class extends ie{constructor(e){super(e),this._propertiesPool=new Za({camera:()=>new vt},this),this._lastSeenCameraProjectionValues=new vt,this.mode=0,this._cssCamera=new vt,this._camera=new vt,this.rasterPixelRatio=1,this.contentPixelRatio=1,this.constraints=new wa({state:this}),this.events=new uc,this.fading=!1,this._cameraChanged=!1,this._updateQueue=new Array,this._processingUpdates=!1}reset(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new Za({camera:()=>new vt},this)}destroy(){this.cameraController=Z(this.cameraController),this._propertiesPool=Z(this._propertiesPool)}createInitialCamera(){if(this.viewingMode===1){const e=Yt(this.spatialReference).radius;this.camera=new vt({eye:We(4*e,0,0),center:We(e,0,0),up:We(0,0,1)})}else this.camera=new vt({eye:We(0,0,100),center:We(0,0,0),up:We(0,1,0)})}get animation(){return this.cameraController instanceof Pp&&this.cameraController.viewAnimation!=null?this.cameraController.viewAnimation:null}get cssCamera(){const e=this._cssCamera.copyFrom(this.camera),{height:t,width:i,pixelRatio:r}=this.camera;return e.pixelRatio=1,e.height=Math.round(t/r),e.width=Math.round(i/r),e}get camera(){return this._camera}set camera(e){e!==rs&&rs.copyFrom(e),rs.computeUp(this.viewingMode),this.events.emit("before-camera-change",{camera:rs});const t=this._camera;if(nU(this._lastSeenCameraProjectionValues,rs)&&(this._lastSeenCameraProjectionValues.copyFrom(rs),this.events.emit("camera-projection-changed",this._lastSeenCameraProjectionValues)),!t.equals(rs)&&(this._camera=this._propertiesPool.get("camera").copyFrom(rs),this._cameraChanged=!t.almostEquals(rs),this._cameraChanged)){const i=VP(()=>{this._cameraChanged=!1,i.remove()})}}get pixelRatio(){return this.camera.pixelRatio}get alignPixelEnabled(){return this.pixelRatio===this.rasterPixelRatio&&this.mode===2}get updating(){return this.mode!==2}get contentCamera(){return this._contentCamera??this.camera}set contentCamera(e){if(e==null)return void(this._contentCamera=null);const t=e.clone();this.events.emit("before-camera-change",{camera:t,sceneDepthRange:nr.Infinite}),this._contentCamera=t}get fixedContentCamera(){return this._contentCamera!=null}get isGlobal(){return this.viewingMode===1}get isLocal(){return this.viewingMode===2}get viewingMode(){return Gv(this.view.viewingMode)}get spatialReference(){return this.view.spatialReference}get highlights(){const e=this.view.highlights.items.slice(0,Z6);for(let t=0;t<e.length;){const i=e[t],r=e.findIndex(s=>s.name===i.name);r>=0&&t>r?e.splice(t,1):++t}return e}get highlightOrderMap(){const e=new Map;return this.highlights.forEach((t,i)=>e.set(t.name,i)),e}get navigating(){return!!this.cameraController?.isInteractive}get stationary(){return!this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(e){this.stopActiveCameraController()?(this.removeHandles(L3),this.cameraController?.destroy(),e&&(this.addHandles(Yr(()=>e.state===4||e.state===3,()=>{this.updateCamera(t=>e.onControllerEnd(t)),this.cameraController===e&&(this._set("cameraController",null),e.destroy())},{sync:!0,once:!0}),L3),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=1)}switchCameraController(e){this.cameraController=e}stopActiveCameraController(){return!this.cameraController||this.cameraController.stopController()}updateCamera(e){this._updateQueue.push(e),this._processUpdateQueue()}_processUpdateQueue(){if(this._updateQueue.length===0||this._processingUpdates)return;this._processingUpdates=!0;const e=this._updateQueue.shift();rs.copyFrom(this.camera),e(rs),this.camera=rs,this._processingUpdates=!1,this._processUpdateQueue()}static cleanupViewstate(){rs=new vt}};h([d({constructOnly:!0})],Ot.prototype,"view",void 0),h([d()],Ot.prototype,"mode",void 0),h([d({readOnly:!0,type:nu})],Ot.prototype,"animation",null),h([d({type:vt})],Ot.prototype,"cssCamera",null),h([d()],Ot.prototype,"_cssCamera",void 0),h([d({type:vt})],Ot.prototype,"camera",null),h([d()],Ot.prototype,"_camera",void 0),h([d({readOnly:!0})],Ot.prototype,"pixelRatio",null),h([d()],Ot.prototype,"rasterPixelRatio",void 0),h([d()],Ot.prototype,"contentPixelRatio",void 0),h([d({readOnly:!0})],Ot.prototype,"alignPixelEnabled",null),h([d({readOnly:!0})],Ot.prototype,"updating",null),h([d({})],Ot.prototype,"_contentCamera",void 0),h([d({type:vt})],Ot.prototype,"contentCamera",null),h([d({readOnly:!0})],Ot.prototype,"fixedContentCamera",null),h([d({readOnly:!0})],Ot.prototype,"events",void 0),h([d({readOnly:!0})],Ot.prototype,"isGlobal",null),h([d({readOnly:!0})],Ot.prototype,"isLocal",null),h([d({readOnly:!0})],Ot.prototype,"viewingMode",null),h([d({readOnly:!0})],Ot.prototype,"highlights",null),h([d({readOnly:!0})],Ot.prototype,"highlightOrderMap",null),h([d({readOnly:!0})],Ot.prototype,"navigating",null),h([d()],Ot.prototype,"fading",void 0),h([d({readOnly:!0})],Ot.prototype,"stationary",null),h([d()],Ot.prototype,"_cameraChanged",void 0),h([d()],Ot.prototype,"cameraController",null),Ot=h([D("esri.views.3d.state.ViewState")],Ot);const I3=Ot;function nU(e,t){return e.fov!==t.fov||e.fullViewport[0]!==t.fullViewport[0]||e.fullViewport[1]!==t.fullViewport[1]||e.fullViewport[2]!==t.fullViewport[2]||e.fullViewport[3]!==t.fullViewport[3]||e.padding[0]!==t.padding[0]||e.padding[1]!==t.padding[1]||e.padding[2]!==t.padding[2]||e.padding[3]!==t.padding[3]}let rs=new vt;const L3="ViewStateHandles",aU="OBJECTID";async function oU(e,t,i,r){const s=i?eO(e,i):r,n=si(t.x,t.y);s.requiresGroundFeedback=!0,s.enableDraped=!0;const a=new Us(e.state.viewingMode);a.options.selectionMode=!0,a.options.store=2,e.sceneIntersectionHelper.intersectIntersectorScreen(n,a,s);const o=await cU(e,a.results.all,s.graphics),l=a.results.ground,c=PM(l,e),u=c!=null&&"type"in c&&Yh(c)?c:null,p={screenPoint:t,results:o,ground:{mapPoint:h_(e,l),distance:SM(l)?l.distanceInRenderSpace:0,layer:u}};return bi.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(p.intersector=a),p}function lU(e,t,i,r){const s=i?eO(e,i):r,n=!(!s.graphics?.include&&!s.graphics?.exclude),a=!(!s.mediaElements?.include&&!s.mediaElements?.exclude),o=gn(t);s.enableDraped=s.include&&!s.include.has(Lo)||s.exclude?.has(Lo);const l=e.sceneIntersectionHelper,c=new Us(e.state.viewingMode);if(c.options.selectionMode=!0,c.options.store=n||a?2:0,c.options.excludeLabels=i?.excludeLabels??!1,l.intersectIntersectorScreen(o,c,s),n||a){for(const u of c.results.all){const p=TM(u,e);if(p==null||n&&(p.type!=="graphic"||KD(s.graphics,p.graphic))||a&&(p.type!=="media"||JD(s.mediaElements,p.element)))return h_(e,u)}return null}return h_(e,c.results.min)}async function cU(e,t,i){const r=new Array;let s,n=null;const a={defer(o){s=o()}};for(let o=0;o<t.length;o++){const l=t[o],c=PM(l,e);if(c!=null&&(c===e.map.ground||"type"in c&&Yh(c)))break;const u=TM(l,e,a)??await s;if(s=null,u==null)continue;if(u.type==="graphic"){if(n==null&&o!==t.length-1&&(n=new Set),n!=null){const f=Fb(u.graphic);if(n.has(f))continue;n.add(f)}if(!KD(i,u.graphic))continue}const p=h_(e,l),m=l.distanceInRenderSpace;if(u.type==="media"){const f=u.element.toSource(p);r.push({...u,mapPoint:p,distance:m,sourcePoint:f})}else r.push({...u,mapPoint:p,distance:m})}return r}function h_(e,t,i){return t.getIntersectionPoint(Ah)?(i=V1(e,Ah,i),t.intersector===7&&e.basemapTerrain&&(i.z=Jn(e.basemapTerrain,i)??0),i):null}function Fb(e){const t=e.getObjectId()??e.attributes?.[aU];return e.origin&&t!=null?`o-${e.origin.id}-${t}`:`u-${e.uid}`}function KD(e,t){return JD(e,Fb(t))}function JD(e,t){return e==null||(e.include==null||e.include.has(t))&&(e.exclude==null||!e.exclude.has(t))}function V1(e,t,i){let r=e.spatialReference||At.WGS84;return No(t,e.renderSpatialReference,Ah,r)?t=Ah:(r=At.WGS84,No(t,e.renderSpatialReference,Ah,r)&&(t=Ah)),i?(i.x=t[0],i.y=t[1],i.z=t[2],i.spatialReference=r):i=new wt(t,r),i}function eO(e,t){const i=z1(e,t.include,0),r=z1(e,t.exclude,1);return{include:i.layerViewUids,exclude:r.layerViewUids,graphics:{include:i.graphicUids,exclude:r.graphicUids},mediaElements:{include:i.mediaElements,exclude:r.mediaElements}}}function z1(e,t,i,r=new hU){if(!t)return r;if(t instanceof Y2)dU(r,Fb(t)),i===0&&(e.graphicsView!=null&&t.layer===e?tg(r,e.graphicsView.uid):t.layer&&g0(r,e,t.layer.uid));else if("layer"in t&&"element"in t)pU(r,t.element),i===0&&g0(r,e,t.layer.uid);else if(lA(t))for(const s of t)s===e.graphics&&e.graphicsView!=null?tg(r,e.graphicsView.uid):s===e.map.ground?tg(r,Lo):z1(e,s,i,r);else"layer"in t&&uU(r,e,t),"uid"in t&&g0(r,e,t.uid);return r}let hU=class{constructor(){this.layerViewUids=null,this.graphicUids=null,this.mediaElements=null}};function g0(e,t,i){const r=t.allLayerViews.find(s=>s.layer.uid===i);r&&tg(e,r.uid)}function tg(e,t){e.layerViewUids??=new Map,e.layerViewUids.set(t,!0)}function uU(e,t,i){const r=t.allLayerViews.find(n=>n.layer.uid===i.layer.uid);if(!r)return;e.layerViewUids??=new Map;const s=e.layerViewUids.get(r.uid);s!==!0&&(s?s.add(i.id):e.layerViewUids.set(r.uid,new Set([i.id])))}function dU(e,t){e.graphicUids??=new Set,e.graphicUids.add(t)}function pU(e,t){e.mediaElements??=new Set,e.mediaElements.add(t)}const Ah=w();function F3(e){return(t,i,r)=>!j4(e,Nt(mU,t,i,r))}const mU=w();let fU=class{constructor(e,t,i){this.viewingMode=e,this._forEachLayer=t,this._view=i,this._externalIntersectionHandlers=new jt,this._tolerance=Eg,this._tmpRay=$o(),this._tmpRegion=Rt(),this._validateHUDIntersector=new Us(this.viewingMode),this._validateHUDIntersector.options.hud=!1}destroy(){this._externalIntersectionHandlers.prune()}intersectScreen(e,t,i){return this.intersectRay(this._getPickRay(e,this._tmpRay),V3(this.viewingMode),t,i)}intersectScreenFreePointFallback(e,t,i){return this.intersectRayFreePointFallback(this._getPickRay(e,this._tmpRay),t,i)}intersectRayFreePointFallback(e,t,i){return this.intersectRay(e,V3(this.viewingMode),t,i)||this._intersectRayFreePointLocal(e,t)}intersectRay(e,t,i,r){return t.options.selectionMode=!1,t.options.store=0,this.computeIntersection(e,t,!1,r),!!t.results.min&&t.results.min.getIntersectionPoint(i)}getCenterRayWithSubpixelOffset(e,t,i=.5,r=.5){return e.getRenderCenter(Xm,i,r),Xm[0]+=.0466,Xm[1]-=.0123,xb(e,Xm,t)}intersectIntersectorScreen(e,t,i){this.computeIntersection(this._getPickRay(e,this._tmpRay),t,!1,i)}intersectToolIntersectorScreen(e,t,i){const r=this._getPickRay(e,this._tmpRay);this.intersectToolIntersectorRay(r,t,i)}intersectToolIntersectorRay(e,t,i){t.options.selectionMode=!0,this.computeIntersection(e,t,!1,i);const r=t.results.min;this._view.basemapTerrain&&this._view.basemapTerrain.opaque||SM(r)&&r.intersector!==7||(t.options.selectionMode=!1,this.computeIntersection(e,t,!1,i))}setTolerance(e=Eg){this._tolerance=e}addIntersectionHandler(e){this._externalIntersectionHandlers.push(e),this._externalIntersectionHandlers.sort((t,i)=>t.type===7?1:i.type===7?-1:0)}removeIntersectionHandler(e){this._externalIntersectionHandlers.removeUnordered(e)!=null&&this._externalIntersectionHandlers.sort((t,i)=>t.type===7?1:i.type===7?-1:0)}_getPickRay(e,t){const i=this._view.state.camera;return wb(i,e,t)}_intersectRayFreePointLocal(e,t){return this.viewingMode!==2||e==null||ce(t,e.origin,me(yt.get(),e.direction)),!1}intersectElevationFromScreen(e,t,i=0,r=null){return this._intersectElevation(this._getPickRay(e,this._tmpRay),t,i,r)}_intersectElevation(e,t,i=0,r=null){if(e==null)return null;const s=this._view,{renderCoordsHelper:n}=s,a=w4(s.spatialReference),o=t!=null?t.mode:"absolute-height",l=DF(t)/a,c=(o!=="on-the-ground"?l+i:0)*a/n.unitInMeters,{camera:u}=s.state;if(o==="absolute-height"){const S=n?.getAltitude(u.eye),x=$e(me(Nu,e.direction),n.worldUpAtPosition(u.eye,yU));if(S<c&&x<0||S>=c&&x>0)return null;if(n.intersectInfiniteManifold(e,c,Nu)){const T=V1(s,Nu);return T.z??=0,T.z-=l,T}return null}const p=u.projectToRenderScreen(e.origin,Xh(yt.get())),m=new z3(null,this._forEachLayer),f=s.slice.plane,g=f!=null?F3(f):null,y=new Us(this.viewingMode);y.options.store=0,y.options.verticalOffset=c,y.options.normalRequired=!1;const v=e.origin,C=ce(yt.get(),v,e.direction);y.reset(v,C,u),y.point=p;let b=null;if(r&&"type"in r&&r.type==="graphics"){const S=s.allLayerViews.find(x=>x.layer===r)?.uid;b=S?x=>x.layerViewUid===S:null}else r&&(b=S=>S.graphicUid!==r.uid);switch(o){case"relative-to-scene":{const S=x=>(!b||b(x))&&!!x.lastValidElevationBB;y.intersect(m.layers,p,this._tolerance,null,S),this._externalIntersectionHandlers.forAll(x=>{if(x.type===2||x.type===7||x.type===8){const T=x.slicePlaneEnabled?g:null;x.intersect(y,T,y.rayBegin,y.rayEnd,p,!1)}});break}case"on-the-ground":case"relative-to-ground":this._externalIntersectionHandlers.forAll(S=>{if(S.isGround){const x=S.slicePlaneEnabled?g:null;S.intersect(y,x,y.rayBegin,y.rayEnd,p,!1)}})}if(y.results.min.getIntersectionPoint(Nu)){const S=V1(s,Nu);return S.z=i,S}return null}computeIntersection(e,t,i,r){if(e==null)return;const s=this._view.state.camera,n=s.projectToRenderScreen(e.origin,Xh(yt.get())),a=new z3(r,this._forEachLayer);t.options.selectOpaqueTerrainOnly=!r||!("include"in r||"exclude"in r);const o=e.origin,l=ce(yt.get(),e.origin,e.direction);t.reset(o,l,s),t.intersect(a.layers,n,this._tolerance);const c=this._view.slice.plane,u=c!=null?F3(c):null;t.intersect(a.sliceableLayers,n,this._tolerance,u);const p=r&&(r.requiresGroundFeedback||r.enableDraped);this._externalIntersectionHandlers.forAll(y=>{const v=y.layerViewUid,C=y.sublayerId,b=Array.isArray(v),S=b?v:[v];b&&(t.options.filteredLayerViewUids=[]);let x=!1;for(const T of S)a.filterLayerViewUid(T,C)?x=!0:b&&t.options.filteredLayerViewUids.push(T);if(t.options.isFiltered=!x,y.isGround&&p||!t.options.isFiltered){const T=y.slicePlaneEnabled?u:null;y.intersect(t,T,o,l,n,i)}});const m=yt.get(),f=this._view,g=f.basemapTerrain;if(r&&r.enableDraped&&g.spatialReference!=null&&t.results.ground.getIntersectionPoint(m)){const y=f.overlayManager.renderer,v=f.renderCoordsHelper.spatialReference,C=yt.get();f.renderCoordsHelper.fromRenderCoords(m,C,g.spatialReference),C[2]=f.elevationProvider?.getElevation(m[0],m[1],m[2],v,"ground")??0,y.intersect(t,C,t.results.ground,b=>a.filterRenderGeometry(b))}t.sortResults(),this._processHUDResults(t)}_processHUDResults(e){const t=e.results.hud;Hp(this._tmpRegion,Z9);const i=this._view.state.camera,r=[],s=this._tmpRegion,n=v=>{const C=new _U(v),b=C.result.target.object.geometries.every(S=>S.material instanceof z2&&S.material.parameters.occlusionTest);r.push({item:C,occlusionTest:b}),b&&(i.projectToRenderScreen(v.target.center,C.screenPoint),C.screenPoint[0]=Math.floor(C.screenPoint[0]),C.screenPoint[1]=Math.floor(C.screenPoint[1]),Y9(s,C.screenPoint))};e.sortResults(t.all),t.min.distance!=null&&n(t.min);for(const v of t.all)t.min.target.object!==v.target.object&&t.max.target.object!==v.target.object&&n(v);if(t.max.distance!=null&&t.max.target.object!==t.min.target.object&&n(t.max),!r.length)return;s[0]===s[2]&&(s[2]+=1),s[1]===s[3]&&(s[3]+=1);const a=i.fullWidth,o=i.fullHeight,l=Math.max(0,s[0]-xd),c=Math.max(0,s[1]-xd),u=Math.min(ds(s)+2*xd,a-l),p=Math.min(Kn(s)+2*xd,o-c),m=u>0&&p>0?new Uint8Array(u*p*4):null;m&&this._view.stage.renderer.readHUDVisibility(l,c,u,p,m);let f=!0;const g=e.results.max.distance==null;let y=0;for(const{item:v,occlusionTest:C}of r){let b=!C;if(C&&m)for(const S of gU){const x=4*(Math.min(v.screenPoint[0]+S[0],a)-s[0]+(Math.min(v.screenPoint[1]+S[1],o)-s[1])*u);if(x>=0&&x<m.length&&m[x]){b=!0;break}}b&&(f&&(e.results.min.copy(v.result),f=!1),g&&e.results.max.copy(v.result),e.options.store===2&&e.results.all.splice(y++,0,v.result))}}};const xd=1,gU=(()=>{const e=[],t=xd;for(let i=-t;i<=t;i++)for(let r=-t;r<=t;r++)e.push([r+t,i+t]);return e})();let _U=class{constructor(e){this.result=e,this.screenPoint=Va()}},Qm;function V3(e){return Qm&&Qm.viewingMode===e||(Qm=new Us(e)),Qm}let z3=class{constructor(e,t){this.layers=new Array,this.sliceableLayers=new Array,this.include=e?.include,this.exclude=e?.exclude,t(i=>{i.pickable&&this.filterLayerViewUid(i.apiLayerViewUid)&&(i.sliceable?this.sliceableLayers:this.layers).push(i)})}filterLayerViewUid(e,t){const{include:i,exclude:r}=this;if(e==null)return i==null&&r==null;const s=i instanceof Map?i.get(e)??!1:i?.has(e),n=r instanceof Map?r.get(e)??!1:r?.has(e);return(s==null||(typeof s=="boolean"?s:t!=null&&s.has(t)))&&(n==null||!(typeof n=="boolean"?n:t!=null&&n.has(t)))}filterRenderGeometry(e){return this.filterLayerViewUid(e.layerViewUid)}};function k3(e){return typeof e=="object"&&"intersect"in e}const Nu=w(),yU=w(),Xm=Va();let use=class{constructor(e,t){this.spatialReference=e,this._view=t}getElevation(e,t,i){return this._view.elevationProvider.getElevation(e,t,0,this.spatialReference,i)}async queryElevation(e,t,i,r,s){return this._view.elevationProvider.queryElevation(e,t,0,this.spatialReference,s,i,r)}},vU=class{constructor(e,t,i,r){this.spatialReference=t,this._getElevationQueryProvider=i,this._queries=new Array,this._queryOptions={...r,ignoreInvisibleLayers:!0},this._frameTask=e.registerTask(mi.ELEVATION_QUERY,this)}destroy({completeTasks:e}={completeTasks:!1}){if(this._frameTask.remove(),this.readyToRun)if(e)this.runTask(bn);else for(const t of this._queries)t.result.reject(Ui())}queryElevation(e,t,i,r=0){const s=aa(),n={x:e,y:t,minDemResolution:r,result:s,signal:i};return this._queries.push(n),Ao(i,()=>{b2(this._queries,n),s.reject(Ui())}),s.promise}get readyToRun(){return this._queries.length>0}runTask(e){const t=this._queries;this._queries=[];const i=this._getElevationQueryProvider();if(!i)return t.forEach(c=>c.result.reject()),void e.madeProgress();const r=t.map(c=>[c.x,c.y]),s=t.reduce((c,u)=>Math.min(c,u.minDemResolution),1/0),n=new uM({points:r,spatialReference:this.spatialReference}),a=t.length>1&&t.some(c=>!!c.signal)?new AbortController:null,o=a!=null?a.signal:t[0].signal;if(a!=null){let c=0;t.forEach(u=>Ao(u.signal,()=>{c++,u.result.reject(Ui()),c===t.length&&a.abort()}))}const l={...this._queryOptions,minDemResolution:s,signal:o};i.queryElevation(n,l).then(c=>{t.forEach((u,p)=>{u.signal!=null&&u.signal.aborted?u.result.reject(Ui()):u.result.resolve(c.geometry.points[p][2])})}).catch(c=>{t.forEach(u=>u.result.reject(c))}),e.madeProgress()}get test(){}},u_=class{constructor(e=1/0,t=-1/0){this.elevationRangeMin=e,this.elevationRangeMax=t}get elevationRangeValid(){return!Number.isNaN(this.elevationRangeMin)}invalidateElevationRange(){this.elevationRangeMin=NaN}expandElevationRangeValues(e,t){this.elevationRangeMin=Math.min(this.elevationRangeMin,e),this.elevationRangeMax=Math.max(this.elevationRangeMax,t)}expandElevationRange(e){this.elevationRangeMin=Math.min(this.elevationRangeMin,e.elevationRangeMin),this.elevationRangeMax=Math.max(this.elevationRangeMax,e.elevationRangeMax)}setElevationRange(e){this.elevationRangeMin=e.elevationRangeMin,this.elevationRangeMax=e.elevationRangeMax}},Cd=class extends gu{get spatialReference(){return this.view.basemapTerrain?.spatialReference??this.view.spatialReference}constructor(e){super(e),this._providers=[new Array,new Array,new Array],this._lastResult=null,this._cacheEnabled=!1}reset(){this._cachedQuery?.destroy({completeTasks:!0}),this._cachedQuery=this._lastResult=null}enableCache(e){e||(this._lastResult=null),this._cacheEnabled=e}getElevation(e,t,i,r,s){const n=this._cacheEnabled&&this._lastResult;if(n&&e===n.x&&t===n.y&&i===n.z&&rc(r,n.spatialReference)&&s===n.queryContext)return n.result;let a=this._updateElevation(null,1,e,t,i,r,s);return s!=="im"&&a==null&&(a=this._updateElevation(null,0,e,t,i,r,s)),s==="scene"&&(a=this._updateElevation(a,2,e,t,i,r,s)),this._cacheEnabled&&(this._lastResult=new bU(e,t,i,r,s,a)),a}getSphereElevationBounds(e,t,i){let r=null;const s=n=>{for(const a of this._providers[n])if(a.getSphereElevationBounds){const o=a.getSphereElevationBounds(e,t,i);o!=null&&(r??=new u_,r.expandElevationRangeValues(o.elevationRangeMin,o.elevationRangeMax))}};return i!=="im"&&s(0),s(1),i==="scene"&&s(2),r}getRootElevationBounds(){return this._providers.reduce((e,t)=>t.reduce((i,r)=>{const s=r.getRootElevationBounds?.();return s!=null&&(i??=new u_,i.expandElevationRangeValues(s.elevationRangeMin,s.elevationRangeMax)),i},e),null)}async queryElevation(e,t,i,r,s,n=null,a=0){const o=this._getElevationQuery(r);try{const l=await o.queryElevation(e,t,n,a);return s==="scene"?this._updateElevation(l,2,e,t,i,r,s):l}catch(l){return fA(l),this.getElevation(e,t,i,r,s)}}register(e,t){this.addHandles(t.on("elevation-change",i=>this.emit("elevation-change",i)),t),this._providers[e].push(t),this.reset()}unregister(e){this.removeHandles(e);for(const t of this._providers){const i=t.indexOf(e);i>-1&&t.splice(i,1)}this.reset()}_getElevationQuery(e=this.view.spatialReference){const t=this._cachedQuery;if(t!=null&&rc(e,t.spatialReference))return t;t?.destroy({completeTasks:!0});const{wkid:i,wkt:r,wkt2:s,latestWkid:n}=e,a=new vU(this.view.resourceController.scheduler,new At({wkid:i,wkt:r,wkt2:s,latestWkid:n}),()=>this.view.map?.ground,{maximumAutoTileRequests:4});return this._cachedQuery=a,a}_updateElevation(e,t,i,r,s,n,a){return this._providers[t].reduce((o,l)=>{const c=l.getElevation(i,r,s,n,a);return c==null?o:Math.max(c,o??c)},e)}};h([d({constructOnly:!0})],Cd.prototype,"view",void 0),h([d()],Cd.prototype,"spatialReference",null),Cd=h([D("esri.views.3d.support.CombinedElevationProvider")],Cd);let bU=class{constructor(e,t,i,r,s,n){this.x=e,this.y=t,this.z=i,this.spatialReference=r,this.queryContext=s,this.result=n}},ig=class{static isValidProfile(e){return e in _0}static getDefaultProfile(){return Qe("esri-iPhone")?"low":"medium"}static apply(e,t){const i=_0[e];t.graphics3D.maxTotalNumberOfFeatures=i.graphics3D.maxTotalNumberOfFeatures,t.graphics3D.maxNumberOfDrawCalls=i.graphics3D.maxNumberOfDrawCalls,t.graphics3D.maxTotalNumberOfVertices=i.graphics3D.maxTotalNumberOfVertices,t.graphics3D.polygonLodFactor=i.graphics3D.polygonLodFactor,t.graphics3D.polylineLodFactor=i.graphics3D.polylineLodFactor,t.graphics3D.snapshotAvailable=i.graphics3D.snapshotAvailable,t.graphics3D.skipHighSymbolLods=i.graphics3D.skipHighSymbolLods;const r=t.sceneService.object,s=i.sceneService.object;r.lodFactor=s.lodFactor,t.sceneService.point.lodFactor=i.sceneService.point.lodFactor,t.sceneService.integratedMesh.lodFactor=i.sceneService.integratedMesh.lodFactor,t.sceneService.pointCloud.lodFactor=i.sceneService.pointCloud.lodFactor,t.tiledSurface.lodBias=i.tiledSurface.lodBias,t.tiledSurface.angledSplitBias=i.tiledSurface.angledSplitBias,t.tiledSurface.vtlContentZoom=i.tiledSurface.vtlContentZoom,t.tiledSurface.elevationLevelDelta=i.tiledSurface.elevationLevelDelta,t.tiledSurface.reduceTileLevelDifferences=i.tiledSurface.reduceTileLevelDifferences,t.gaussianSplat.minimumSplatPixelRadius=i.gaussianSplat.minimumSplatPixelRadius,t.gaussianSplat.minimumOpacity=i.gaussianSplat.minimumOpacity,t.gaussianSplat.maxAllowedVisibleGaussians=i.gaussianSplat.maxAllowedVisibleGaussians,t.heatmap.pixelRatio=i.heatmap.pixelRatio,t.heatmap.maxTotalNumberOfFeatures=i.heatmap.maxTotalNumberOfFeatures,t.flow3D.maxTotalNumberOfStreamlines=i.flow3D.maxTotalNumberOfStreamlines,t.flow3D.maxTracingResolution=i.flow3D.maxTracingResolution,t.fadeDuration=i.fadeDuration,t.antialiasingEnabled=i.antialiasingEnabled,t.physicallyBasedRenderingEnabled=i.physicalBasedRenderingEnabled,t.highQualityTransparency=i.highQualityTransparency,t.highResolutionAtmosphere=i.highResolutionAtmosphere,t.reflections=i.reflections,t.ambientOcclusion=i.ambientOcclusion,t.maxTexturePixels=i.maxTexturePixels,t.memoryLimit=i.memoryLimit,t.additionalCacheMemory=i.additionalCacheMemory,t.frameRate=i.frameRate,t.maximumPixelRatio=i.maximumPixelRatio}static{this.test={reset(){const e=tO();for(const t of Object.keys(e))_0[t]=e[t]}}}};const ju={IPhone12Pro:120,GalaxyS20:200,FullHD:240,SurfacePro7:300,FullHDRetina:430},_0=tO();function tO(){const e=!!Qe("esri-mobile"),t=!!Qe("ios"),i=Oe(400);return{low:{flow3D:{maxTotalNumberOfStreamlines:25e3,maxTracingResolution:1024},graphics3D:{maxTotalNumberOfFeatures:25e3,maxNumberOfDrawCalls:8e3,maxTotalNumberOfVertices:255e4,polygonLodFactor:.5,polylineLodFactor:1,snapshotAvailable:!1,skipHighSymbolLods:!0},heatmap:{pixelRatio:.125,maxTotalNumberOfFeatures:5e4},sceneService:{object:{lodFactor:.2},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5}},gaussianSplat:{minimumSplatPixelRadius:2,minimumOpacity:.1,maxAllowedVisibleGaussians:4e6},tiledSurface:{lodBias:-1,angledSplitBias:.5,vtlContentZoom:.75,elevationLevelDelta:3,reduceTileLevelDifferences:!0},fadeDuration:Oe(0),antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,maxTexturePixels:e?1048576:4194304,memoryLimit:200+ju.IPhone12Pro,additionalCacheMemory:0,frameRate:0,maximumPixelRatio:1},medium:{flow3D:{maxTotalNumberOfStreamlines:1e5,maxTracingResolution:2048},graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:625e4,polygonLodFactor:e?.8:1,polylineLodFactor:e?1.2:1.5,snapshotAvailable:!t,skipHighSymbolLods:!1},heatmap:{pixelRatio:.25,maxTotalNumberOfFeatures:13e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1}},gaussianSplat:{minimumSplatPixelRadius:1,minimumOpacity:.05,maxAllowedVisibleGaussians:8e6},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,elevationLevelDelta:3,reduceTileLevelDifferences:!Qe("disable-feature:reduce-map-tile-levels")},fadeDuration:i,antialiasingEnabled:!1,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,maxTexturePixels:e?4194304:4096**2,memoryLimit:e?600+ju.GalaxyS20:750+ju.FullHD,additionalCacheMemory:e?-100:150,frameRate:0,maximumPixelRatio:1},high:{flow3D:{maxTotalNumberOfStreamlines:1e5,maxTracingResolution:2048},graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:125e5,polygonLodFactor:e?1.2:2,polylineLodFactor:e?1.2:2,snapshotAvailable:!t,skipHighSymbolLods:!1},heatmap:{pixelRatio:.5,maxTotalNumberOfFeatures:23e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1}},gaussianSplat:{minimumSplatPixelRadius:.5,minimumOpacity:.005,maxAllowedVisibleGaussians:16e6},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,elevationLevelDelta:2,reduceTileLevelDifferences:!Qe("disable-feature:reduce-map-tile-levels")},fadeDuration:i,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!0,reflections:!0,ambientOcclusion:!0,maxTexturePixels:e?4096**2:1/0,memoryLimit:e?900+ju.SurfacePro7:1500+ju.FullHDRetina,additionalCacheMemory:e?-150:0,frameRate:0,maximumPixelRatio:e?1:1/0}}}async function wU(e,t){if(e.type==="2d")return e.hitTest(t);const i=await e.hitTest(t);if(i.results.length===0)return i;const r=i.results[0],s=(r.distance??0)*(1+xU),n=i.results.findIndex(a=>(a.distance??0)>s);return n!==-1&&(i.results=i.results.slice(0,n)),r&&i.ground.distance>s&&(i.ground.mapPoint=null),i}const xU=.05;function CU(e){return e?.type==="graphic"}function dse(e){return e.find(CU)??null}async function SU(e,t){const{results:i,ground:r}=await wU(e,t),s=(!r.layer||!Yh(r.layer))&&r.mapPoint,n=[],a=MU(e),o=s?TU(e,a):PU;let l=0,c=0;const u=()=>{const m=o.layerViews[c++];if(!s||!m||!("fetchPopupFeaturesAtLocation"in m))return;const f=r.mapPoint,g=m.layer;if(jh(g)&&"effectiveScaleRange"in g){const{minScale:y,maxScale:v}=g.effectiveScaleRange;if(pF(y,v)){if(H4(g)&&!_x(e.scale,y,v))return;const C=e.basemapTerrain.getScale(f);if(!_x(C,y,v))return}}n.push({mapPoint:f,layerView:m})};let p=null;for(;l<i.length||c<o.layerViews.length;){const m=i[l];if(m&&m.type!=="graphic")++l;else if(m?.layer?.type!=="scene"||m?.layer?.parent!==e?.map?.basemap)if(m){const f=m.layer?.uid,g=o.layerUids.has(f)&&m.distance===r.distance,y=a.get(m.layer?.uid);if(p??=m.mapPoint,c<o.layerViews.length&&(g||(m.distance??0)>r.distance)&&o.layerViews[c]!==y){u();continue}n.push({graphic:m.graphic,layerView:y}),++l}else u();else++l}return p??=r.mapPoint,{hits:n,location:p}}function TU(e,t){const i=new Set,r=new Set;for(let n=e.basemapTerrain.numLayers(1)-1;n>=0;n--){const a=e.basemapTerrain.layerViewByIndex(n,1);i.add(a.layer.uid),r.add(a)}const s=e.overlayManager.renderer.layers;for(const{uid:n}of s){const a=t.get(n);a&&(i.add(n),r.add(a))}return{layerUids:i,layerViews:Array.from(r).reverse()}}const PU={layerUids:new Set,layerViews:[]};function MU(e){const t=new Map;for(const i of e.allLayerViews){const r=i.layer.uid;t.set(r,i)}return t}let Ps=class extends ie{constructor(){super(...arguments),this.minTotalNumberOfFeatures=2e3,this.maxTotalNumberOfFeatures=5e4,this.maxNumberOfDrawCalls=17e3,this.maxTotalNumberOfVertices=17e5,this.snapshotAvailable=!0,this.polygonLodFactor=1,this.polylineLodFactor=1,this.skipHighSymbolLods=!1}};h([d()],Ps.prototype,"minTotalNumberOfFeatures",void 0),h([d()],Ps.prototype,"maxTotalNumberOfFeatures",void 0),h([d()],Ps.prototype,"maxNumberOfDrawCalls",void 0),h([d()],Ps.prototype,"maxTotalNumberOfVertices",void 0),h([d()],Ps.prototype,"snapshotAvailable",void 0),h([d()],Ps.prototype,"polygonLodFactor",void 0),h([d()],Ps.prototype,"polylineLodFactor",void 0),h([d()],Ps.prototype,"skipHighSymbolLods",void 0),Ps=h([D("esri.views.3d.support.QualitySettings.Graphics3DSettings")],Ps);let Fl=class{constructor(){this.minimumSplatPixelRadius=1,this.minimumOpacity=.05,this.maxAllowedVisibleGaussians=8e6}};h([d()],Fl.prototype,"minimumSplatPixelRadius",void 0),h([d()],Fl.prototype,"minimumOpacity",void 0),h([d()],Fl.prototype,"maxAllowedVisibleGaussians",void 0),Fl=h([D("esri.views.3d.support.QualitySettings.GaussianSplatSettings")],Fl);let xn=class extends ie{constructor(){super(...arguments),this.lodFactor=1}};h([d()],xn.prototype,"lodFactor",void 0),xn=h([D("esri.views.3d.support.QualitySettings.LoDFactorSettings")],xn);let Co=class extends ie{constructor(){super(...arguments),this.object=new xn,this.point=new xn,this.integratedMesh=new xn,this.pointCloud=new xn}};h([d({type:xn})],Co.prototype,"object",void 0),h([d({type:xn})],Co.prototype,"point",void 0),h([d({type:xn})],Co.prototype,"integratedMesh",void 0),h([d({type:xn})],Co.prototype,"pointCloud",void 0),Co=h([D("esri.views.3d.support.QualitySettings.SceneServiceSettings")],Co);let Ia=class extends ie{constructor(){super(...arguments),this.lodBias=0,this.angledSplitBias=1,this.vtlContentZoom=1,this.elevationLevelDelta=3,this.reduceTileLevelDifferences=!0}};h([d()],Ia.prototype,"lodBias",void 0),h([d()],Ia.prototype,"angledSplitBias",void 0),h([d()],Ia.prototype,"vtlContentZoom",void 0),h([d()],Ia.prototype,"elevationLevelDelta",void 0),h([d()],Ia.prototype,"reduceTileLevelDifferences",void 0),Ia=h([D("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],Ia);let Ih=class extends ie{constructor(){super(...arguments),this.pixelRatio=1,this.maxTotalNumberOfFeatures=5e4}};h([d()],Ih.prototype,"pixelRatio",void 0),h([d()],Ih.prototype,"maxTotalNumberOfFeatures",void 0),Ih=h([D("esri.views.3d.support.QualitySettings.HeatmapSettings")],Ih);let Lh=class extends ie{constructor(){super(...arguments),this.maxTotalNumberOfStreamlines=1e5,this.maxTracingResolution=2048}};h([d()],Lh.prototype,"maxTotalNumberOfStreamlines",void 0),h([d()],Lh.prototype,"maxTracingResolution",void 0),Lh=h([D("esri.views.3d.support.QualitySettings.Flow3DSettings")],Lh);let li=class extends ie{constructor(){super(...arguments),this.graphics3D=new Ps,this.sceneService=new Co,this.tiledSurface=new Ia,this.gaussianSplat=new Fl,this.heatmap=new Ih,this.flow3D=new Lh,this.fadeDuration=Oe(400),this.antialiasingEnabled=!0,this.physicallyBasedRenderingEnabled=!1,this.highQualityTransparency=!0,this.highResolutionAtmosphere=!1,this.reflections=!1,this.ambientOcclusion=!1,this.glow=!1,this.maxTexturePixels=1/0,this.memoryLimit=750,this.additionalCacheMemory=0,this.frameRate=void 0,this.maximumPixelRatio=1/0}};h([d({type:Ps})],li.prototype,"graphics3D",void 0),h([d({type:Co})],li.prototype,"sceneService",void 0),h([d({type:Ia})],li.prototype,"tiledSurface",void 0),h([d({type:Fl})],li.prototype,"gaussianSplat",void 0),h([d({type:Ih})],li.prototype,"heatmap",void 0),h([d({type:Lh})],li.prototype,"flow3D",void 0),h([d()],li.prototype,"fadeDuration",void 0),h([d()],li.prototype,"antialiasingEnabled",void 0),h([d()],li.prototype,"physicallyBasedRenderingEnabled",void 0),h([d()],li.prototype,"highQualityTransparency",void 0),h([d()],li.prototype,"highResolutionAtmosphere",void 0),h([d()],li.prototype,"reflections",void 0),h([d()],li.prototype,"ambientOcclusion",void 0),h([d()],li.prototype,"glow",void 0),h([d()],li.prototype,"maxTexturePixels",void 0),h([d()],li.prototype,"memoryLimit",void 0),h([d()],li.prototype,"additionalCacheMemory",void 0),h([d()],li.prototype,"frameRate",void 0),h([d()],li.prototype,"maximumPixelRatio",void 0),li=h([D("esri.views.3d.support.QualitySettings")],li);const B3=li,RU=(()=>{const e=new Array;return e[0]=10,e[1]=10,e[2]=10,e[3]=10,e[4]=5,e})(),DU=30;function OU(e){return"usedMemory"in e&&"unloadedMemory"in e&&"ignoresMemoryFactor"in e}function EU(e){return new tr({view:e})}const N3=.1,Ym=1,y0=1,AU=.75,IU=.6,j3=1.3,Km=!!Qe("esri-tests-disable-memory-pools");let tr=class extends ie{constructor(e){super(e),this._quality=1,this._usedMemory=0,this._updating=!1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._predictedMemory=0,this._cacheStorage=new AF,this._warnMemoryUsage=null,this._numQualityChanges=0,this._maxMemory=Km?4096:750,this._additionalCacheMemory=Km?-4096:0,this.addHandles(tc({prepare:()=>this._updateMemory()}))}destroy(){this._cacheStorage.destroy()}get maxMemory(){return this._maxMemory}set maxMemory(e){e==null||e<=0||Km||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(Ym),this._maxMemory=e)}get additionalCacheMemory(){return this._additionalCacheMemory}set additionalCacheMemory(e){e==null||Km||(this._additionalCacheMemory=e)}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._usedMemory}get usedCacheMemory(){return this._cacheStorage.size}newCache(e,t,i){return new IF(e,this._cacheStorage,t,i)}resetStableQuality(){this._stableQuality=0}disableMemCache(){this.additionalCacheMemory=-4096}update(){if(this._predictedMemory<=0&&!this._updating)return;let e=this._layersUpdating();if(this._predictedMemory<IU&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(Ym);else if(e){if(this._predictedMemory>1.1*y0||this._usedMemory>y0){if(this._stableQuality>0)this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality);else if(this._quality>N3&&this._downscaleMemoryUsed<this._usedMemory){if(this._compactAndUpdate())return;this._updateQuality(this._quality/j3),this._downscaleMemoryUsed=this._usedMemory,this._canFastRecover=!1}}}else if(this._downscaleMemoryUsed=0,this._usedMemory>y0){if(this._compactAndUpdate())return;this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/j3),this._downscaleMemoryUsed=this._predictedMemory}else this._stableQuality!==this._quality&&(this._usedMemory<AU&&this._quality<Ym?(this._stableQuality=this._quality,e=this._updateQuality(this._quality+.05)):this._quality<1&&(this._canFastRecover=!0));this._updating=e}_compactAndUpdate(){const e=hL(Oe(100)),t=this.view.stage.compact(e);return this.view.overlayManager.renderer.compact(e)||t}_updateQuality(e){return(e=Math.min(Math.max(e,N3),Ym))!==this._quality&&(this._quality=e,++this._numQualityChanges,!0)}_layersUpdating(){return this.view.allLayerViews.some(e=>!!e.updating)}_updateMemory(){if(!this.view?.updating||this.view.destroyed||this.view.destroying)return;this.view.stage?.renderer?.tick();const e=this.view.stage?.renderer?.usedMemory;let t=(this.view.basemapTerrain?.usedMemory??0)+(e?e.fbos+e.edges+e.plugins:0)+this.view.deconflictor?.usedMemory+this.view.labeler?.usedMemory,i=0;this.view.allLayerViews&&this.view.allLayerViews.forEach(a=>{if(OU(a)){const o=a.ignoresMemoryFactor?this._quality:1;t+=a.usedMemory*o,i+=a.unloadedMemory*o}});const r=this._warnMemoryUsage==null||Math.round(10*t)!==Math.round(10*this._warnMemoryUsage),s=1048576*this.maxMemory;if(t>s&&r){this._warnMemoryUsage=t;const a=l=>(l/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",o=Math.round(100*this._quality);$.getLogger(this).warn(`Memory Limit exceeded! Limit: ${a(s)} Current: ${a(t)} Projected: ${a(t+i)} Quality: ${o}%`)}this._usedMemory=t/s,this._predictedMemory=(t+i)/s;const n=s-t;this._cacheStorage.maxSize=Math.max(0,n+1048576*this.additionalCacheMemory)}get test(){}};h([d({constructOnly:!0})],tr.prototype,"view",void 0),h([d()],tr.prototype,"maxMemory",null),h([d()],tr.prototype,"additionalCacheMemory",null),h([d({readOnly:!0})],tr.prototype,"memoryFactor",null),h([d({readOnly:!0})],tr.prototype,"updating",null),h([d({readOnly:!0})],tr.prototype,"usedMemory",null),h([d({readOnly:!0})],tr.prototype,"usedCacheMemory",null),h([d()],tr.prototype,"_quality",void 0),h([d()],tr.prototype,"_usedMemory",void 0),h([d()],tr.prototype,"_updating",void 0),h([d()],tr.prototype,"_stableQuality",void 0),h([d()],tr.prototype,"_maxMemory",void 0),h([d()],tr.prototype,"_additionalCacheMemory",void 0),tr=h([D("esri.views.3d.support.MemoryController")],tr);let LU=class{constructor(e){this.client=e,this._cancelled=!1,this.size=0,this.duration=0}},FU=class{constructor(e){this.typeWorkerQuota=e,this.tasks=new Array,this.numWorkers=0,this.statistics=new VU}},VU=class{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0}},zU=class{constructor(e,t,i,r){this._workerFunc=e,this._callbackFunc=t,this._maxTotalNumWorkers=i,this._totalNumWorkers=0,this._clients=r.map(s=>new FU(s))}destroy(){this._clients.length=0}hasQuota(e){const t=this._clients[e];return!!t&&(this._totalNumWorkers<this._maxTotalNumWorkers||t.numWorkers+t.tasks.length<t.typeWorkerQuota)}push(e){const t=this._clients[e.client];t&&(this._totalNumWorkers<this._maxTotalNumWorkers?(t.numWorkers++,this._totalNumWorkers++,this._workerFunc(e,(i,r)=>this._taskCallback(i,r))):t.tasks.push(e))}cancel(e){this._taskFinished(e),e._cancelled=!0}_taskFinished(e){const t=this._clients[e.client];this._totalNumWorkers--,t&&(t.numWorkers--,t.statistics.requests++,t.statistics.size+=e.size||0,t.statistics.duration+=e.duration||0,t.statistics.speed=t.statistics.duration>0?t.statistics.size/t.statistics.duration:0,Qt(t.numWorkers>=0)),this._next()}_next(){for(const e of this._clients)if(e&&e.numWorkers<e.typeWorkerQuota&&this._processQueue(e))return;for(const e of this._clients)if(e&&this._processQueue(e))return}_processQueue(e){for(;e.tasks.length>0;)if(this._workerFunc(e.tasks.shift(),(t,i)=>this._taskCallback(t,i)))return e.numWorkers++,this._totalNumWorkers++,!0;return!1}_taskCallback(e,t){e._cancelled||(this._callbackFunc(e,t),this._taskFinished(e))}getStatsForType(e){const t=this._clients[e];return t?{quota:t.typeWorkerQuota,workers:t.numWorkers,queueSize:t.tasks.length,requestStats:t.statistics}:null}get test(){}},kU=class{constructor(e,t){this.element=e,this.type="image+type",this.isOpaque=t==="image/jpeg"}};function mh(e){return e!=null&&"type"in e&&e.type==="vector-tile"}function iO(e){return e!=null&&"type"in e&&e.type==="raster-tile"}function rO(e){return e!=null&&"type"in e&&e.type==="tile-texture"}function Z_(e){return e!=null&&"type"in e&&e.type==="image+type"}let rg=class extends ie{constructor(){super(...arguments),this._tasks=new Map,this._onLoadQueue=new Array,this._doneQueue=new Array,this.updating=!1}setup(e,t,i){this._loadQueue=new zU((r,s)=>this._startLoading(r,s),(r,s)=>this._doneLoadingCB(r,s),e,t),i&&(this._frameTask=i.registerTask(mi.STREAM_DATA_LOADER,this))}destroy(){this._frameTask=xi(this._frameTask),this._tasks.forEach(e=>Ar(e.abortController)),this._loadQueue=Z(this._loadQueue),this._onLoadQueue.length=0,this._onLoadQueue=null,this._doneQueue.length=0,this._doneQueue=null,this._tasks.forEach(e=>e.destroy()),this._tasks.clear(),this._tasks=null}hasDownloadSlots(e){return this._loadQueue.hasQuota(e)}request(e,t,i,r={}){const s=aa();return s.__signal=r!=null?r.signal:null,this._createOrUpdateTask(e,t,i,r,s),s.promise}_createTask(e,t,i,r,s,n){const a=new jU(e,t,i,r,s);return this._updateTask(a,n),this._tasks.set(s,a),this._tasks.size===1&&this._set("updating",!0),this._loadQueue.push(a),a}_cancelRequest(e,t){const i=this._tasks.get(e);i&&(zs(i.resolvers,t),t.reject(Ui()),i.resolvers.length===0&&(i.status===2&&this._loadQueue.cancel(i),i.status=4,this._removeTask(i)))}_updateTask(e,t){e.resolvers.push(t)}_createOrUpdateTask(e,t,i,r,s){const n=UU(r?.uid||e,t,i);let a=this._tasks.get(n);a?this._updateTask(a,s):(a=this._createTask(e,r,t,i,n,s),a.abortHandle=Ao(r,()=>this._cancelRequest(n,s)))}_doneLoadingCB(e,t){this._loadQueue&&(Qt(e.status===2),e.status=3,this._frameTask?this._doneQueue.push({task:e,err:t}):this._doneLoading(e,t))}get readyToRun(){return this._doneQueue.length>0||this._onLoadQueue.length>0}runTask(e){for(;!e.done&&this._onLoadQueue.length>0;){const t=this._onLoadQueue.shift();qe(t.task.abortController),t.task.abortController=null,t.callback(t.task),e.madeProgress()}for(;!e.done&&this._doneQueue.length>0;){const t=this._doneQueue.shift();t.task.status!==3&&(t.err=t.err||Ui()),this._doneLoading(t.task,t.err),e.madeProgress()}}_doneLoading(e,t){if(t&&!js(t)&&e.numRetries>0)return--e.numRetries,void this._loadQueue.push(e);let i=Z_(e.result)||e.result instanceof HTMLImageElement?0:e.resolvers.length;for(const r of e.resolvers)if(t)js(t)?r.reject(t):r.reject(new fe("stream-data-loader:request-error",`Failed to request resource at '${e.url}'. ${t}`,{url:e.url,error:t}));else{--i;const s=i>0?Og(e.result):e.result;r.resolve(s)}this._removeTask(e)}_removeTask(e){this._tasks.delete(e.key),e.destroy(),this._tasks.size===0&&this._set("updating",!1)}_startLoading(e,t){if(e.status===4)return!1;let i,r;switch(e.startTime=performance.now(),e.status=2,e.docType){case 1:r="array-buffer",i=0;break;case 2:r="image";break;case 3:r="array-buffer";break;default:r="json"}e.abortController=new AbortController;const s=e.abortController.signal;e.request=dy(e.url,{...e.options,responseType:r,timeout:i,signal:s});const n=o=>{e.duration=performance.now()-e.startTime,e.size=o instanceof ArrayBuffer?o.byteLength:e.size||0,e.result=o,this._frameTask?this._onLoadQueue.push({callback:t,task:e}):(e.abortController=null,t(e))},a=o=>{e.status===2&&t(e,o)};return e.docType!==3?(e.request.then(o=>n(o.data),a),!0):(e.request.then(o=>{const l=o.data,c=NU(l);if(r="image",e.size=l.byteLength,c==="unknown")return e.request=dy(e.url,{responseType:r,timeout:i,signal:s}),void e.request.then(m=>n(m.data),a);const u=new Blob([l],{type:c}),p=window.URL.createObjectURL(u);e.request=dy(p,{responseType:r,timeout:i,signal:s}),e.request.then(m=>n(new kU(m.data,c)),a).finally(()=>window.URL.revokeObjectURL(p))},a),!0)}get test(){}};h([d({readOnly:!0})],rg.prototype,"updating",void 0),rg=h([D("esri.views.3d.support.StreamDataLoader")],rg);const BU={numRetries:0};function NU(e){if(e.byteLength<2)return"unknown";const t=new Uint8Array(e,0,e.byteLength);return t[0]===137&&t[1]===80?"image/png":t[0]===71&&t[1]===73?"image/gif":t[0]===66&&t[1]===77?"image/bmp":t[0]===255&&t[1]===216?"image/jpeg":"unknown"}let jU=class extends LU{constructor(e,t,i,r,s){super(r),this.url=e,this.options=t,this.docType=i,this.key=s,this.abortHandle=null,this.result=null,this.status=1,this.request=null,this.abortController=null,this.resolvers=new Array,this.startTime=0,this.numRetries=BU.numRetries}destroy(){this.result=null,this.request=null,this.abortController?.abort(),this.abortController=null,this.resolvers.length=0,this.options=null,this.abortHandle=xi(this.abortHandle)}};function UU(e,t,i){return`${e}:${t}:${i}`}let HU=class{constructor(e,t){this._loader=e,this._clientType=t}request(e,t,i={}){return this._loader.request(e,t,this._clientType,i)}get busy(){return!this._loader.hasDownloadSlots(this._clientType)}},sg=class extends ie{constructor(){super(...arguments),this.updating=!1}};function qU(e){return new Hn({view:e})}h([d({readOnly:!0})],sg.prototype,"updating",void 0),sg=h([D("esri.views.3d.support.ResourceController.ResourceControllerMain")],sg);let Hn=class extends sg{constructor(){super(...arguments),this._immediateTask=fp,this._normalTask=fp,this._updatingObjects=ar([]),this._frameTask=null}get immediate(){return this._immediateTask}get normal(){return this._normalTask}initialize(){this._scheduler=cL(),this._memoryController=EU(this.view),this._streamDataLoader=new rg,this._streamDataLoader.setup(DU,RU,this._scheduler),this.addHandles([M(()=>this.view.stationary,()=>this._stationaryChangedHandler())]),this._frameTask=tc({update:e=>this._frame(e)}),this._immediateTask=this._scheduler.registerTask(mi.RESOURCE_CONTROLLER_IMMEDIATE),this._normalTask=this._scheduler.registerTask(mi.RESOURCE_CONTROLLER)}destroy(){this._immediateTask.remove(),this._normalTask.remove(),this._frameTask=xi(this._frameTask),this._streamDataLoader=Z(this._streamDataLoader),this._memoryController=Z(this._memoryController),this._scheduler=Z(this._scheduler),this.view=null}get updating(){return!!(this._memoryController?.updating||this._streamDataLoader?.updating||this._immediateTask?.updating)||this._updatingObjects?.value.some(e=>e.updating)}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}createStreamDataRequester(e){return new HU(this._streamDataLoader,e)}addUpdatingObject(e){const t=this._updatingObjects;return t.value=[...t.value,e],Sn(()=>{t.value=t.value.filter(i=>i!==e)})}_frame(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step(y2(e.deltaTime)),!this._scheduler)||(this._memoryController.update(),this.view.state&&(this._scheduler.state=this.view.state.fading?1:this.view.state.mode,this.view.state.fading=!1),this._scheduler.frame(e))}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}get test(){}};h([d()],Hn.prototype,"view",void 0),h([d()],Hn.prototype,"_scheduler",void 0),h([d()],Hn.prototype,"_memoryController",void 0),h([d()],Hn.prototype,"_streamDataLoader",void 0),h([d()],Hn.prototype,"_immediateTask",void 0),h([d()],Hn.prototype,"_normalTask",void 0),h([d({readOnly:!0})],Hn.prototype,"updating",null),Hn=h([D("esri.views.3d.support.ResourceController")],Hn);let pse=class{constructor(e,t=0,i=0,r=0,s=0,n=null){this.usedMemory=e,this.displayedFeatures=t,this.totalFeatures=i,this.maximumFeatures=r,this.nodes=s,this.core=n}};function GU(e){return"performanceInfo"in e}let $U=class{constructor(e){this.layer=null,this.memory=0,this.displayedNumberOfFeatures=0,this.maximumNumberOfFeatures=null,this.totalNumberOfFeatures=null,this.layer=e.layer;const t=e.performanceInfo;this.memory=t.usedMemory,this.displayedNumberOfFeatures=t.displayedFeatures,this.maximumNumberOfFeatures=t.maximumFeatures,this.totalNumberOfFeatures=t.totalFeatures}},WU=class{constructor(e){if(this.totalMemory=0,this.usedMemory=0,this.quality=1,this.load=0,this.terrainMemory=0,this.edgesMemory=0,this.layerPerformanceInfos=new Array,this.cachedMemory=0,this.fboMemory=0,e.resourceController!=null){const t=e.resourceController.memoryController;this.totalMemory=1048576*(t.maxMemory??0),this.usedMemory=Math.round(t.usedMemory*this.totalMemory),this.quality=e.quality,this.load=e.resourceController.scheduler.load,this.cachedMemory=t.usedCacheMemory}this.terrainMemory=e.basemapTerrain?.usedMemory??0,this.edgesMemory=e.stage?.renderer.usedMemory.edges??0,this.fboMemory=e.stage?.renderer.usedMemory.fbos??0,e.allLayerViews?.items.forEach(t=>{GU(t)&&this.layerPerformanceInfos.push(new $U(t))}),this.layerPerformanceInfos.sort((t,i)=>i.memory-t.memory)}},ZU=class{constructor(e){this._gltfLoading=new Map,this._wosrLoading=new Map,this._gltfCache=e("gltf-resources",()=>{}),this._wosrCache=e("wosr-resources",()=>{})}destroy(){this._gltfLoading.forEach(e=>e.abortController.abort()),this._wosrLoading.forEach(e=>e.abortController.abort()),this._gltfCache.destroy(),this._wosrCache.destroy()}loadGLTF(e,t,i){const r=i?`gltfPBR:${e}`:`gltf:${e}`,s=this._gltfCache.get(r);return s?Promise.resolve(s):U3(this._gltfLoading,this._gltfCache,r,async n=>{const{loadGLTF:a}=await k(()=>le(()=>import("./loader-CvLhmqYC-zMi5AUkS.js"),__vite__mapDeps([464,1,2,3,38,7,8,79,69,6,4,9,10,19,20,14,179,173,167,86,169,170,87,272,177])),ue([465,1,39,7,8,5,6,80,70,4,2,9,10,19,20,14,195,189,183,87,185,186,88,273,193]));return a(new LF(n.streamDataRequester),e,n,i)},t)}loadWOSR(e,t){const i=`wosr:${e}:${t.disableTextures}`,r=this._wosrCache.get(i);return r?Promise.resolve(r):U3(this._wosrLoading,this._wosrCache,i,s=>FF(e,s),t)}};async function U3(e,t,i,r,s){qe(s);const n=Ao(s,()=>QU(e,i));let a=e.get(i);if(a)a.refCount++;else{const o=new AbortController;a={refCount:1,abortController:o,promise:r({...s,signal:o.signal})},e.set(i,a)}try{const o=await a.promise;return t.put(i,o),e.delete(i),qe(s),o}finally{xi(n)}}function QU(e,t){const i=e.get(t);i!=null&&--i.refCount>0||(e.delete(t),i?.abortController.abort())}let Fh=class extends ie{constructor(e,t){super({}),this._stage=e,this._textureRequests=new Map,this._frameTask=t?.registerTask(mi.TEXTURE_UNLOAD)??fp}normalizeCtorArgs(){return{}}destroy(){super.destroy(),this._frameTask?.remove(),this._textureRequests?.forEach(e=>this._releaseTextureRequest(e)),this._textureRequests?.clear()}get updating(){return this._frameTask.updating}fromData(e,t){const i=this.makeUid(e);let r=this._textureRequests.get(i);if(!r){const s=new nO;s.texture=t(),this._stage&&(s.texture.load(this._stage.renderView.renderingContext),this._stage.addTexture(s.texture)),this._textureRequests.set(i,s),r=s}return r.referenceCount++,new sO(i,r.texture,()=>this._release(i))}_release(e){const t=this._textureRequests.get(e);t?(t.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+e),t.referenceCount--,t.referenceCount<1&&this._frameTask.schedule(()=>this._releaseNow(e))):console.warn(`TextureCollection: texture doesn't exist: '${e}'`)}get test(){}_releaseNow(e){if(!this._textureRequests)return;const t=this._textureRequests.get(e);!t||t.referenceCount>0||(t.texture?.unload(),this._releaseTextureRequest(t),this._textureRequests.delete(e))}_releaseTextureRequest(e){e.texture?this._stage?.removeTexture(e.texture):e.abortController&&(e.abortController.abort(),e.abortController=null)}makeUid(e,t=null){return t!=null?`${e}.${t}px`:e}};h([d()],Fh.prototype,"_frameTask",void 0),h([d()],Fh.prototype,"updating",null),Fh=h([D("esri.views.3d.support.TextureCollection")],Fh);let sO=class{constructor(e,t,i){this.uid=e,this.texture=t,this.release=i}},nO=class{constructor(){this.referenceCount=0}},XU=class extends Fh{constructor(e,t,i){super(t,i),this._streamDataRequester=e}async fromUrl(e,t,i){qe(i);const r=i?.signal,s=this.makeUid(e,t);let n=this._textureRequests.get(s);if(!n){const a=new AbortController,o=this._streamDataRequester.request(e,2,{uid:s,signal:a.signal});n=new nO,n.abortController=a;const l=n;this._textureRequests.set(s,n),n.textureAsync=o.then(async c=>{const u=this._createTexture(e,c,t);return l.texture=u,l.abortController=null,await u.load(this._stage.renderView.renderingContext),this._stage.addTexture(u),new sO(s,u,()=>this._release(s))},c=>{throw l.abortController=null,c})}n.referenceCount++;try{return await wA(n.textureAsync,r)}catch(a){throw this._release(s),a}}_createTexture(e,t,i){const r={width:t.width,height:t.height,wrap:{s:33071,t:33071},preMultiplyAlpha:!0,reloadable:!0};if(M4(e)){if(i||t.width===0&&t.height===0){const s=t.width?t.height/t.width:1;i=i||64,s>1?(t.width=Math.round(i/s),t.height=i):(t.width=i,t.height=Math.round(i*s))}this._stage.renderView?.renderingContext.driverTest.svgPremultipliesAlpha.result&&(r.preMultiplyAlpha=!1)}return new l8(t,r)}},YU=class{constructor(e){this.streamDataRequester=null,this.cimSymbolRasterizer=null,this.streamDataRequester=e.resourceController.createStreamDataRequester(4),this.objectResourceCache=new ZU((t,i)=>e.resourceController.memoryController.newCache(t,i)),this.textures=new XU(this.streamDataRequester,e.view.stage,e.resourceController.scheduler)}destroy(){this.textures.destroy(),this.streamDataRequester=null}},Sd=class extends ie{constructor(e){super(e),this._propertiesPool=new Za({plane:()=>E_()},this),this.isDecoration=!0,this.addHandles(x_(this._propertiesPool))}set plane(e){if(!e)return void this._set("plane",e);const t=this._propertiesPool.get("plane");V2(e,t),this._set("plane",t)}};h([d()],Sd.prototype,"plane",null),h([d()],Sd.prototype,"isDecoration",void 0),Sd=h([D("esri.views.3d.support.ViewSlice")],Sd);let KU=class{constructor(e){this.destination=e}hide(){this.graphic!=null&&(this.destination.remove(this.graphic),this.graphic=null)}},fh=class extends KU{constructor(e,t,i=""){super(e),this._symbol=new nF({symbolLayers:new Mt([new oF({material:{color:t},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new lF({text:i,halo:{color:"white",size:1/.75},material:{color:t},size:12})])})}show(e,t){if(!t)return;this.hide();const i=new wt({x:e[0],y:e[1],z:e[2],spatialReference:t});this.graphic=new Y2({geometry:i,symbol:this._symbol}),this.destination.add(this.graphic)}},To=class extends ie{constructor(e){super(e)}};h([d({constructOnly:!0})],To.prototype,"renderCoordsHelper",void 0),h([d({constructOnly:!0})],To.prototype,"surface",void 0),h([d({constructOnly:!0})],To.prototype,"state",void 0),To=h([D("esri.views.3d.support.pointsOfInterest.PointOfInterest")],To);let xs=class extends To{constructor(e){super(e),this._dirty=!1,this._propertiesPool=new Za({location:()=>new wt,renderLocation:()=>w()},this),this._estimatedSurfaceAltitude=0,this._elevationQueryController=null,this.renderLocation=w(),this._tmpPoint=new wt}initialize(){if(this.scheduler&&this.addHandles(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){const e=()=>this._setDirty();this.addHandles(Ir(()=>this.map?.ground?.layers,"change",e,{onListenerAdd:e,onListenerRemove:e}))}this._updateRenderLocation()}destroy(){this._cancelPendingRequest(),this._propertiesPool=Z(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}get scale(){const e=this._camera,t=Gt(e.eye,this.renderLocation),i={renderCoordsHelper:this.renderCoordsHelper,state:{camera:e}};return oc(i,t)}get updating(){return this._dirty||this._elevationQueryController!=null}updateRenderLocation(){this._setDirty(),this._updateRenderLocation()}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}_cancelPendingRequest(){const e=this._elevationQueryController;e&&(this._elevationQueryController=null,e.abort(),this.notifyChange("updating"))}get readyToRun(){return!this._elevationQueryController&&this._dirty}runTask(){if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!this.map?.ground)return this._updateSurfaceAltitude(0),Fi;const e=this.state.spatialReference;this._tmpPoint.spatialReference=e,this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this._tmpPoint);const t=(this._tmpPoint.z??0)>JU&&this.renderCoordsHelper.viewingMode===1&&(e.isWGS84||e.isWebMercator);let i=new AbortController;return this.map.ground.queryElevation(this._tmpPoint,{signal:i.signal,cache:this.cache,minDemResolution:t?eH:0}).then(r=>this._updateSurfaceAltitude(r.geometry.z??0)).catch(r=>{if(r.name===jI)if(this.integratedMeshElevationSampler){this._tmpPoint.spatialReference=this.integratedMeshElevationSampler.spatialReference,this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this._tmpPoint);const s=this.integratedMeshElevationSampler.elevationAt(this._tmpPoint.x,this._tmpPoint.y)??0;this._updateSurfaceAltitude(s===this.integratedMeshElevationSampler.noDataValue?0:s)}else this._updateSurfaceAltitude(0)}).catch(()=>{}).then(()=>{this._elevationQueryController===i&&(this._elevationQueryController=null,this.notifyChange("updating")),i=null}),this._elevationQueryController=i,Fi}_updateSurfaceAltitude(e){this._estimatedSurfaceAltitude!==e&&(this._estimatedSurfaceAltitude=e,this._updateRenderLocation())}_updateRenderLocation(){this.renderCoordsHelper.setAltitude(v0,this._estimatedSurfaceAltitude,this._camera.eye),Go(this._get("renderLocation"),v0)||(this._set("renderLocation",q(this._propertiesPool.get("renderLocation"),v0)),this.notifyChange("renderLocation"))}};h([d({constructOnly:!0})],xs.prototype,"scheduler",void 0),h([d({constructOnly:!0})],xs.prototype,"cache",void 0),h([d({constructOnly:!0})],xs.prototype,"map",void 0),h([d({constructOnly:!0})],xs.prototype,"task",void 0),h([d({constructOnly:!0})],xs.prototype,"integratedMeshElevationSampler",void 0),h([d()],xs.prototype,"location",null),h([d()],xs.prototype,"renderLocation",void 0),h([d()],xs.prototype,"scale",null),h([d()],xs.prototype,"updating",null),xs=h([D("esri.views.3d.support.pointsOfInterest.CameraOnSurface")],xs);const v0=w(),JU=1e5,eH=1e6;let Rs=class extends To{constructor(e){super(e),this._propertiesPool=new Za({location:()=>new wt,renderLocation:()=>w()},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.distance=0,this.renderLocation=w(),this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()}destroy(){this._frameWorker=xi(this._frameWorker),this._propertiesPool=Z(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool?.get("location");return e?(e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e):new wt}updateRenderLocation(){this.updating=!0,this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}get readyToRun(){return this.updating}runTask(){return this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1,Fi}_updateRenderLocation(){const e=iH;let t=this._calculateSurfaceIntersection(this._currentSurfaceAltitude,e);const i=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!t&&i&&(t=this._calculateSurfaceIntersection(this._latestSurfaceAltitude,e),t&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const r=rH;t&&this._latestSurfaceAltitudeChangesDistanceSignificantly(e,r)&&(q(e,r),this._currentSurfaceAltitude=this._latestSurfaceAltitude),t?this.distance=Gt(this._camera.eye,e):(te(e,this._camera.viewForward,this._get("distance")),ce(e,e,this._camera.eye)),Go(this._get("renderLocation"),e)||this._set("renderLocation",q(this._propertiesPool.get("renderLocation"),e))}_calculateSurfaceIntersection(e,t){const i=this._camera;if(!this.renderCoordsHelper.intersectInfiniteManifold(i.ray,e,t))return!1;if(this.state.isGlobal){const r=Yt(this.renderCoordsHelper.spatialReference).radius,s=r+e,n=Wr(i.eye),a=n<s*s,o=Gt(i.eye,t);if(a&&o>r/4){const l=s-Math.sqrt(n);return te(t,i.viewForward,l),ce(t,t,i.eye),!0}}else{const r=this.surface?.ready?this.surface.extentAABR:null;r!=null&&sb(r,this.surface?.spatialReference,Uu,this.renderCoordsHelper.spatialReference)&&(t[0]=j(t[0],Uu[0],Uu[2]),t[1]=j(t[1],Uu[1],Uu[3]))}return!0}_latestSurfaceAltitudeChangesDistanceSignificantly(e,t){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||e==null)return!1;if(this._calculateSurfaceIntersection(this._latestSurfaceAltitude,t)){if(bi.TESTS_DISABLE_OPTIMIZATIONS)return!0;const i=this._camera.eye,r=Gt(i,e),s=Gt(i,t);if(Math.abs(s-r)/r>tH)return!0}return!1}};h([d({constructOnly:!0})],Rs.prototype,"scheduler",void 0),h([d({constructOnly:!0})],Rs.prototype,"task",void 0),h([d()],Rs.prototype,"distance",void 0),h([d({constructOnly:!0})],Rs.prototype,"estimateSurfaceAltitudeAtCenter",void 0),h([d({readOnly:!0})],Rs.prototype,"location",null),h([d({readOnly:!0})],Rs.prototype,"renderLocation",void 0),h([d()],Rs.prototype,"updating",void 0),Rs=h([D("esri.views.3d.support.pointsOfInterest.CenterOnSurface")],Rs);const tH=.05,iH=w(),rH=w(),Uu=Rt();function aO(e,t,i){const r=i?.createCollection?.()??new Mt,s=i?.recycleItems?new sH:null,n=(l,c=0)=>{if(!l?.length)return;const u=r.splice(c,l.length);s?s.processRemoved(l):u.forEach(d_)},a=(l,c=0)=>{if(!l?.length)return;const u=[];for(const p of l){const m=s?.use(p);if(m)u.push(m);else{const f=t(p);s?.register(p,f),u.push(f)}}r.addMany(u,c)},o=Ir(e,"after-splice",({added:l,start:c,removed:u})=>{n(u,c),a(l,c)},{sync:!0,onListenerRemove:l=>n(l.items),onListenerAdd:l=>a(l.items)});return r.addHandles(o),r}let sH=class{constructor(){this._originalToMapped=new Map,this._removedItemCandidates=new Set,this._garbageCollectionQueued=!1}processRemoved(e){if(!e?.length)return;const{_removedItemCandidates:t}=this;for(const i of e)this._getItem(i)?.markRemoved()&&(t.add(i),this._queueGarbageCollection())}use(e){const t=this._getItem(e);return t&&(t.removed=!1),t?.item}register(e,t){this._originalToMapped.set(e,new nH(t))}_getItem(e){return this._originalToMapped.get(e)}_queueGarbageCollection(){this._garbageCollectionQueued||(this._garbageCollectionQueued=!0,queueMicrotask(()=>this._garbageCollectCandidates()))}_garbageCollectCandidates(){this._garbageCollectionQueued=!1;const{_removedItemCandidates:e}=this,t=Array.from(e);e.clear(),t.forEach(i=>this._garbageCollectIfRemoved(i))}_garbageCollectIfRemoved(e){const{_originalToMapped:t}=this,i=this._getItem(e);i?.removed&&(d_(i.item),t.delete(e))}},nH=class{constructor(e){this.item=e,this.removed=!1}markRemoved(){return this.removed=!0,!0}};function d_(e){typeof e=="object"&&e&&("destroy"in e&&typeof e.destroy=="function"?e.destroy():aA(e))}function mse(e,t,i){const r=new Mt,s=aO(e,l=>Ya(async c=>{const u=await t(l,c);if(Gl(c))throw d_(u),Ui();return u}),i),n=()=>null,a=async l=>{const c=await l.promise,u=s.indexOf(l);u<0||r.splice(u,1,c)};r.addMany(s.items.map(n));for(const l of s)Rg(a(l));const o=s.on("after-splice",({added:l,start:c,deleteCount:u})=>{const p=r.splice(c,u);for(const m of p)d_(m);if(l?.length){r.addMany(l.map(n),c);for(const m of l)Rg(a(m))}});return r.addHandles([x_(s),o]),r}let aH=class{constructor(e,t){this._handles=new C_,this.events=new uc,this._handles.add([x_(aO(()=>e,i=>i.on("visible-geometry-changed",r=>this.events.emit("request-update",r)))),Ir(t,"visible-geometry-changed",()=>this.events.emit("request-update"))])}destroy(){this._handles.destroy()}},an=class extends To{constructor(e){super(e),this._propertiesPool=new Za({location:()=>new wt,renderLocation:()=>w()},this),this._dirty=!0,this.renderLocation=this._propertiesPool.get("renderLocation")}initialize(){this.addHandles([M(()=>this.centerOnSurface.renderLocation,()=>this.updateRenderLocation(),{equals:Go}),M(()=>this.state.contentCamera,()=>this.updateRenderLocation())]),this.scheduler&&this.addHandles(this.scheduler.registerTask(mi.POINT_OF_INTEREST_FREQUENT,this))}destroy(){this._propertiesPool=Z(this._propertiesPool)}get updating(){return this._dirty||this.centerOnSurface.updating}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}get worldUnitsPerContentPixel(){const{camera:e,contentPixelRatio:t}=this.state;return e.computeRenderPixelSizeAt(this.renderLocation)*(e.pixelRatio/t)}get readyToRun(){return this._dirty}runTask(){const e=this._get("renderLocation"),t=this.centerOnSurface.renderLocation,i=this.renderCoordsHelper,r=this.state.contentCamera;this._dirty=!1,i.worldUpAtPosition(t,H3);const s=Math.max(0,(Math.acos($e(H3,r.viewForward))-.5*Math.PI)*(r.aboveGround?1:-1));if(Number.isNaN(s)){if(!e||!eu(e,t)){const l=this._propertiesPool.get("renderLocation");q(l,t),this._set("renderLocation",l)}return Fi}const n=1-j(s/(.5*Math.PI),0,1),a=n*n*n;this._calculateScreenHorizontalEdgeOnSurface(q3);const o=this._propertiesPool.get("renderLocation");return Nt(o,t,q3,a),e&&eu(e,o)||this._set("renderLocation",o),Fi}_calculateScreenHorizontalEdgeOnSurface(e){const t=this.state.contentCamera,i=t.getRenderCenter(Va());if(i[1]=t.aboveGround?t.padding[2]:t.fullHeight-t.padding[0],this.estimateSurfaceIntersectionAtRenderPoint(i,e))return e;const r=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(t.unprojectFromRenderScreen(i,Hu)){de(Hu,Hu,t.eye);const s=me(Hu,Hu);if(this.renderCoordsHelper.intersectInfiniteManifold(ru(t.eye,s),r,e))return e}return this.renderCoordsHelper.setAltitude(e,r,t.eye)}updateRenderLocation(){this._dirty=!0}};h([d()],an.prototype,"_dirty",void 0),h([d({constructOnly:!0})],an.prototype,"scheduler",void 0),h([d({constructOnly:!0})],an.prototype,"centerOnSurface",void 0),h([d({constructOnly:!0})],an.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),h([d()],an.prototype,"updating",null),h([d()],an.prototype,"location",null),h([d()],an.prototype,"renderLocation",void 0),h([d()],an.prototype,"worldUnitsPerContentPixel",null),an=h([D("esri.views.3d.support.pointsOfInterest.Focus")],an);const H3=w(),Hu=w(),q3=w();let Ta=class extends ie{constructor(e){super(e),this.location=null,this._updateController=null}initialize(){this.view.state.isLocal&&(this.addHandles([M(()=>[this._terrain?.spatialReference,this._terrain?.extent],()=>this._update()),Ir(()=>this._ground?.layers,"change",()=>this._update())]),this._update())}destroy(){this._updateController=Ar(this._updateController)}get renderLocation(){if(!this.location)return null;const e=w();return this.view.renderCoordsHelper.toRenderCoords(this.location,e),e}get _ground(){return this.view.map?.ground}get _terrain(){return this.view.basemapTerrain}_update(){if(this._updateController=Ar(this._updateController),this._terrain?.extent==null||this._terrain?.spatialReference==null)return void this._set("location",null);const e=z4(this._terrain.extent),t=new wt({x:e[0],y:e[1],z:0,spatialReference:this._terrain.spatialReference});this._ground&&this._ground.layers.length>0?(this._set("location",null),this._updateController=new AbortController,this._ground.queryElevation(t,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then(i=>{this._updateController=null,this._set("location",i.geometry)}).catch(i=>{})):this._set("location",t)}};h([d({constructOnly:!0})],Ta.prototype,"view",void 0),h([d({constructOnly:!0})],Ta.prototype,"cache",void 0),h([d({readOnly:!0})],Ta.prototype,"location",void 0),h([d({readOnly:!0})],Ta.prototype,"renderLocation",null),h([d()],Ta.prototype,"_ground",null),h([d()],Ta.prototype,"_terrain",null),Ta=h([D("esri.views.3d.support.pointsOfInterest.StableSurfaceCenter")],Ta);let Pa=class extends ie{constructor(e){super(e),this._tileGeometryUpdateExtent=zo(),this._tileGeometryUpdateSpatialReference=null,this.events=new uc,this.updating=!1}initialize(){this.addHandles([this.surface.on("elevation-change",e=>this._tileGeometryChanged(e)),this.scheduler.registerTask(mi.SURFACE_GEOMETRY_UPDATES,this)])}get readyToRun(){return this.updating}runTask(){return this.updating?(this._tileGeometryUpdateSpatialReference&&this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",oH),zo(this._tileGeometryUpdateExtent),this._set("updating",!1),Fi):Fi}_tileGeometryChanged(e){this._tileGeometryUpdateSpatialReference=e.spatialReference,Nh(this._tileGeometryUpdateExtent,e.extent,this._tileGeometryUpdateExtent),this._set("updating",!0)}_furthestCenterOnSurface(){let e=this.centerOnSurfaces[0];for(let t=1;t<this.centerOnSurfaces.length;t++){const i=this.centerOnSurfaces[t];i.distance>e.distance&&(e=i)}return e}_centerIntersectsExtent(e,t){const i=this.state.contentCamera.eye,r=lH,s=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(i,ol,t),this.renderCoordsHelper.fromRenderCoords(s.renderLocation,ll,t),ol[0]<ll[0]?(r[0]=ol[0],r[2]=ll[0]):(r[0]=ll[0],r[2]=ol[0]),ol[1]<ll[1]?(r[1]=ol[1],r[3]=ll[1]):(r[1]=ll[1],r[3]=ol[1]),k4(r,e)}};h([d({constructOnly:!0})],Pa.prototype,"state",void 0),h([d({constructOnly:!0})],Pa.prototype,"centerOnSurfaces",void 0),h([d({constructOnly:!0})],Pa.prototype,"renderCoordsHelper",void 0),h([d({constructOnly:!0})],Pa.prototype,"scheduler",void 0),h([d({constructOnly:!0})],Pa.prototype,"surface",void 0),h([d({readOnly:!0})],Pa.prototype,"updating",void 0),Pa=h([D("esri.views.3d.support.pointsOfInterest.SurfaceGeometryUpdates")],Pa);const oH={},ol=w(),ll=w(),lH=zo();let Tr=class extends ie{constructor(e){super(e),this.renderPointOfView=w(),this._pois=new Array,this._updatingHandles=new dc,this._debugCenters=null,this._tmpRay=$o(),this._centerRayDirty=!0,this._surfaceAltitudeAtCenter=0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenter=0,this._contentAltitudeAtCenterDirty=!0,this._propertiesPool=new Za({renderPointOfView:()=>w()},this),this._contentIntersector=new Us(e.view.state.viewingMode),this._surfaceIntersector=new Us(e.view.state.viewingMode),this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=0}initialize(){const{state:e,groundView:t,renderCoordsHelper:i,map:r}=this.view,s=()=>this._estimateSurfaceAltitudeAtCenter(),n=this.view.resourceController.scheduler,a=t?.elevationQueryCache,o={state:e,scheduler:n,surface:t,renderCoordsHelper:i};this._set("centerOnSurfaceInfrequent",new Rs({...o,task:mi.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:s})),this._set("centerOnSurfaceFrequent",new Rs({...o,task:mi.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:s})),this._set("centerOnContent",new Rs({...o,task:mi.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()}));const l=t.integratedMeshElevationSampler;this._set("cameraOnSurface",new xs({...o,cache:a,integratedMeshElevationSampler:l,task:mi.POINT_OF_INTEREST_INFREQUENT,map:r})),this._set("surfaceGeometryUpdates",new Pa({...o,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]})),this._set("contentGeometryUpdates",new aH(this.view.allLayerViews,()=>this.view.graphicsView)),this._set("surfaceOrigin",new Ta({cache:a,view:this.view})),this._set("focus",new an({state:e,scheduler:n,surface:t,renderCoordsHelper:i,centerOnSurface:this.centerOnSurfaceFrequent,estimateSurfaceIntersectionAtRenderPoint:(c,u)=>this._estimateSurfaceIntersectionAtRenderPoint(c,this.view.state.contentCamera,u)})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.cameraOnSurface,this.focus),this.addHandles([M(()=>e.contentCamera,c=>this._cameraChanged(c),Ie),this._updatingHandles.add(()=>t.extentAABR,()=>this._updateCenterPointsOfInterest()),this._updatingHandles.add(()=>this.view.map?.ground?.navigationConstraint?.type,c=>{this._surfaceIntersector.options.backfacesTerrain=c==="none"},Ee),Yr(()=>!t.updating,()=>this._updateCenterPointsOfInterest(),Ie),Ir(()=>this.surfaceGeometryUpdates.events,"request-update",()=>this._updateCenterPointsOfInterest()),Ir(()=>this.contentGeometryUpdates.events,"request-update",()=>this._updateCenterOnContent()),this._updatingHandles.add(()=>bi.SHOW_POI,c=>this._setDebug(c),Ee)]),this._cameraChanged(this.view.state.contentCamera);for(const c of this._pois)c.runTask()}destroy(){this._setDebug(!1),this._propertiesPool.destroy();for(const e of this._pois)e.destroy();this._pois.length=0,this.surfaceOrigin.destroy(),this._updatingHandles.destroy(),this._set("centerOnSurfaceInfrequent",null),this._set("centerOnSurfaceFrequent",null),this._set("centerOnContent",null),this._set("cameraOnSurface",null),this._set("surfaceGeometryUpdates",null),this._set("contentGeometryUpdates",null),this._set("surfaceOrigin",null),this._set("focus",null)}get updating(){return!(!this.surfaceGeometryUpdates?.updating&&!this._pois.some(e=>e.updating))||this._updatingHandles.updating}get _centerRay(){return this._centerRayDirty&&(this._centerRayCached=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.contentCamera,this._tmpRay),this._centerRayDirty=!1),this._centerRayCached}_estimateContentAltitudeAtCenter(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const e=this._centerRay;return e==null||(this.view.sceneIntersectionHelper.intersectRay(e,this._contentIntersector,Fc,hH)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(Fc):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}_estimateSurfaceAltitudeAtCenter(){const{view:e}=this,{groundView:t}=e;if(!t)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const i=this._centerRay;if(i==null)return this._surfaceAltitudeAtCenter;const r=i.origin,s=ce(Fc,i.origin,i.direction);return this._surfaceIntersector.resetWithRay(i,e.state.contentCamera),t.intersect(this._surfaceIntersector,null,r,s),this._surfaceIntersector.results.min.getIntersectionPoint(Fc)&&(this._surfaceAltitudeAtCenter=e.renderCoordsHelper.getAltitude(Fc)),this._surfaceAltitudeAtCenter}_estimateSurfaceIntersectionAtRenderPoint(e,t,i){const r=xb(t,e,cH);if(r==null)return null;const s=r.origin,n=ce(Fc,r.origin,r.direction);return this._surfaceIntersector.resetWithRay(r,t),this.view.groundView.intersect(this._surfaceIntersector,null,s,n),this._surfaceIntersector.results.min.getIntersectionPoint(i)?i:null}_cameraChanged(e){this._updateCenterPointsOfInterest();const t=e.eye;Go(this.renderPointOfView,t)||this._set("renderPointOfView",q(this._propertiesPool.get("renderPointOfView"),t))}_updateCenterPointsOfInterest(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;for(const e of this._pois)e.updateRenderLocation()}_updateCenterOnContent(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()}_setDebug(e){if(!e)return this._debugCenters?.forEach(t=>t.hide()),void this.removeHandles("debug");if(!this._debugCenters){this._debugCenters=new Map;const t=this.view.graphics;this._debugCenters.set(this.centerOnContent,new fh(t,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new fh(t,"red","CenterOnSurface")),this._debugCenters.set(this.centerOnSurfaceInfrequent,new fh(t,"red","CenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new fh(t,"blue","CameraOnSurface")),this._debugCenters.set(this.focus,new fh(t,"green","Focus"))}for(const t of this._pois)this.addHandles(this._updatingHandles.add(()=>t.renderLocation,i=>this._debugCenters?.get(t)?.show(i,t.renderCoordsHelper.spatialReference),Ee),"debug")}get test(){}};h([d()],Tr.prototype,"centerOnContent",void 0),h([d()],Tr.prototype,"centerOnSurfaceFrequent",void 0),h([d()],Tr.prototype,"centerOnSurfaceInfrequent",void 0),h([d()],Tr.prototype,"cameraOnSurface",void 0),h([d()],Tr.prototype,"focus",void 0),h([d()],Tr.prototype,"renderPointOfView",void 0),h([d()],Tr.prototype,"surfaceOrigin",void 0),h([d()],Tr.prototype,"contentGeometryUpdates",void 0),h([d()],Tr.prototype,"surfaceGeometryUpdates",void 0),h([d({constructOnly:!0})],Tr.prototype,"view",void 0),h([d()],Tr.prototype,"updating",null),Tr=h([D("esri.views.3d.support.pointsOfInterest.PointsOfInterest")],Tr);const Fc=w(),cH=$o(),hH={exclude:new Set([Lo])},uH=()=>$.getLogger("esri/core/MemCachePool");let Yp=class{constructor(e,t){this._cache=e(t,(i,r,s)=>{switch(r){case 0:return i.forEach(n=>n.dispose()),0;case 1:{const n=i.shift();return n?(s-=Math.round(n.usedMemory),n.dispose()):s>0&&(uH().warn("Encountered empty MemCachePool with non-zero memory."),s=0),s}}})}hitrate(){return this._cache.hitRate}destroy(){this._cache.destroy()}clear(){this._cache.clear()}getSize(e){return this._cache.getSize(e)}pop(e){const t=this._cache.peek(e);if(!t)return;const i=t.pop();return t.length>0?i&&(t.usedMemory=this._cache.getSize(e)-Math.round(i.usedMemory),this._cache.updateSize(e)):this._cache.pop(e),i}put(e,t,i=EF){const r=this._cache.peek(e);if(!r){const s=new dH(t);return void this._cache.put(e,s,i)}r.push(t),r.usedMemory=this._cache.getSize(e)+Math.round(t.usedMemory),this._cache.updateSize(e)}},dH=class extends Array{constructor(e){super(),this.item=e,this.usedMemory=e.usedMemory,this.push(e)}},pH=class{constructor(e){this._store=e}destroy(){this._store.destroy()}get(e){return this._store.get(e)}put(e,t){this._store.put(e,t)}};function fse(e,t,i){if(e==null||i==null)return!1;let r=!0;return ui[0]=e.xmin!=null?e.xmin:0,ui[1]=e.ymin!=null?e.ymin:0,ui[2]=e.zmin!=null?e.zmin:0,r=r&&oa(ui,e.spatialReference,0,t,i,0),ui[0]=e.xmax!=null?e.xmax:0,ui[1]=e.ymax!=null?e.ymax:0,ui[2]=e.zmax!=null?e.zmax:0,r=r&&oa(ui,e.spatialReference,0,t,i,3),e.xmin==null&&(t[0]=-1/0),e.ymin==null&&(t[1]=-1/0),e.zmin==null&&(t[2]=-1/0),e.xmax==null&&(t[3]=1/0),e.ymax==null&&(t[4]=1/0),e.zmax==null&&(t[5]=1/0),r}function mH(e,t,i){if(e==null||i==null)return!1;let r=!0;return ui[0]=e.xmin!=null?e.xmin:0,ui[1]=e.ymin!=null?e.ymin:0,ui[2]=e.zmin!=null?e.zmin:0,r=r&&oa(ui,e.spatialReference,0,ui,i,0),t[0]=ui[0],t[1]=ui[1],ui[0]=e.xmax!=null?e.xmax:0,ui[1]=e.ymax!=null?e.ymax:0,ui[2]=e.zmax!=null?e.zmax:0,r=r&&oa(ui,e.spatialReference,0,ui,i,0),t[2]=ui[0],t[3]=ui[1],e.xmin==null&&(t[0]=-1/0),e.ymin==null&&(t[1]=-1/0),e.xmax==null&&(t[2]=1/0),e.ymax==null&&(t[3]=1/0),r}const ui=w(),gse={value:.5,readOnly:!0},fH={readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}};let Vh=class{constructor(e=0,t=0){this.min=e,this.max=t,this.level=0,this.hasNoDataValues=!1}copyFrom(e){this.min=e.min,this.max=e.max,this.level=e.level,this.hasNoDataValues=e.hasNoDataValues}},gH=class{constructor(e,t,i){this.type="elevation",this.level=e[0],this.i=e[1],this.j=e[2],this.extent=t,this.samplerData=new NI(i,t)}computeMinMaxValue(e,t,i,r){r.min=1/0,r.max=-1/0,r.hasNoDataValues=!1;const s=e-this.level;if(s<=0)return r;const n=2**s;if(!(Math.floor(t/n)===this.i&&Math.floor(i/n)===this.j))return r;let a=1/0,o=-1/0;const l=this.samplerData.data.width,c=this.samplerData.data.values,u=.5*hb;let p=(l-1)/n,m=(i-this.j*n)*p,f=(t-this.i*n)*p;if(p<1){const g=Math.floor(m),y=Math.floor(f),v=g+y*l,C=c[v],b=c[v+1],S=c[v+l],x=c[v+l+1];if(C+b+S+x<u){const T=m-g,P=f-y,R=hm(C,b,S,x,T,P),O=hm(C,b,S,x,T+p,P),E=hm(C,b,S,x,T,P+p),A=hm(C,b,S,x,T+p,P+p);return r.min=Math.min(R,O,E,A),r.max=Math.max(R,O,E,A),r}m=g,f=y,p=1}else m=Math.floor(m),f=Math.floor(f),p=Math.ceil(p);for(let g=m;g<=m+p;g++)for(let y=f;y<=f+p;y++){const v=c[g+y*l];v<u?(a=Math.min(a,v),o=Math.max(o,v)):r.hasNoDataValues=!0}return r.min=a,r.max=o,r}};const _H=.5*hb;function zt(e,t,i){if(i==null)return null;for(const r of i){if(!r)continue;const s=r.safeWidth;let n=j(r.dy*(r.y1-t),0,s),a=j(r.dx*(e-r.x0),0,s);const o=Math.floor(n),l=Math.floor(a),c=r.data.width,u=o*c+l,p=r.data.values,m=p[u],f=p[u+1],g=u+c,y=p[g],v=p[g+1];if(m+y+f+v<_H){n-=o,a-=l;const C=m+(f-m)*a;return C+(y+(v-y)*a-C)*n}}return null}function oO(e){return Vb(e)||A2(e)||I2(e)}function Vb(e){return o9(e)||x4(e)}function yH(e,t,i,r){if(e==null)return cb();const s=e.spatialReference;return s.isGeographic&&!Vb(s)?new fe("tilingscheme:local-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in local scenes"):pn.checkUnsupported(e)??(i==null?new fe("tilingscheme:extent-not-exist","The layer does not provide a layer extent."):vH(e,i)||(t==null||s.equals(t)||t.isWGS84&&s.isWebMercator?null:new fe("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the local scene")))}function vH(e,t){const i=e.lods,r=i[0].resolution*2**i[0].level,s=[r*e.size[0],r*e.size[1]],n=[e.origin.x,e.origin.y],a=V4(t),o=Rt();pn.computeRowColExtent(a,s,n,o);const l=(o[2]-o[0])*(o[3]-o[1]);if(l>Th){const c=i[0].scale*2**i[0].level;let u=Math.max((a[3]-a[1])/e.size[1],(a[2]-a[0])/e.size[0])*c/r;const p=Math.floor(Math.log(u)/Math.log(10));return u=Math.ceil(u/10**p)*10**p,new fe("tilingscheme:too-many-root-tiles","Scale of level 0 of the tiling scheme (1:"+Math.floor(c).toLocaleString()+") is too large for the layer's extent. Suggested scale: 1:"+u.toLocaleString()+".",{level0Scale:c,suggestedLevel0Scale:u,requiredNumRootTiles:l,allowedNumRootTiles:Th})}return null}const bH=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:yH},Symbol.toStringTag,{value:"Module"}));function wH(e,t,i,r){if(e==null)return cb();const s=e?.lods.length-1,n=e.spatialReference;if(n.isWebMercator){if(!pn.makeWebMercatorAuxiliarySphere(s).compatibleWith(e,r))return new fe("tilingscheme:incompatible-global-web-mercator","The tiling scheme is not compatible with the ArcGIS Online Web Mercator tiling scheme")}else{if(!oO(n))return new fe("tilingscheme:global-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in global scenes");if(!pn.makeGCSWithTileSize(e.spatialReference,e.size[0],s).compatibleWith(e,r))return e.spatialReference.isWGS84?new fe("tilingscheme:incompatible-global-wgs84","The tiling scheme is not compatible with the ArcGIS Online WGS84 tiling scheme"):new fe("tilingscheme:incompatible-global","The tiling scheme is not compatible with the ArcGIS Online tiling scheme")}return t==null||e.spatialReference.equals(t)?null:new fe("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the global scene")}const xH=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:wH},Symbol.toStringTag,{value:"Module"})),CH={1:xH,2:bH};function Si(e,t){e||console.warn("Terrain: "+t)}let vi=!1,p_=!1;function SH(e){p_=e,vi=vi||e}function TH(e){vi=e}function N(e,t){if(vi&&!e){const i=new Error().stack?.slice(5);throw console.warn("Terrain internal: "+(t??"")+" at "+i),new Error("Assertion failed"+(t?": "+t:""))}}function m_(e){return e?.type==="imagery-tile"||e?.type==="wcs"}function Q_(e){return e?.type==="imagery-tile-3d"}function lO(e){return e?.type==="tile-3d"}function cu(e){return e?.type==="vector-tile-3d"}function cO(e){return e?.type==="wmts-3d"}function k1(e){return e?.type==="elevation-3d"}function qu(e){return e?.type==="group"}function Op(e){return e&&(lO(e)||cO(e)||Q_(e)||cu(e))}function B1(e){return e&&(lO(e)||Q_(e)||cu(e)||cO(e))}function N1(e){return B1(e)||k1(e)}function PH(e){return iO(e?.sourceLayerInfo?.data)}function MH(e){return hO(e?.sourceLayerInfo)||!!e?.isVTLBackground}function RH(e){return rO(e?.sourceLayerInfo?.data)}function DH(e){const t=e?.sourceLayerInfo?.data;return Z_(t)||t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof ImageData}function hO(e){return mh(e?.data)}function Gh(e){return e!=null&&"release"in e&&e.release(),null}function _se(e){return e.fetchTile&&e.hasOverriddenFetchTile!==!1}function zb(e,t,i,r,s){return CH[r].checkIfTileInfoSupportedForViewSR(e,i,t,s)}function X_(e,t,i){let r=null,s=null;if(e?.type==="wmts"){const a=OH(e,t,i);r=a.tileInfo,s=a.fullExtent}else{s=m_(e)?e.getCompatibleFullExtent(t):e.fullExtent;const a=i===2;m_(e)?r=e.getCompatibleTileInfo(t,s,a):e?.type==="vector-tile"?r=a&&!EH(t)||AH.force512VTL?e.tileInfo:e.tileInfo.getCompatibleForVTL(256):r=e.tileInfo}const n="tilemapCache"in e?e.tilemapCache?.effectiveMaxLOD:void 0;return r!=null&&s!=null&&zb(r,s,t,i,n)==null?{tileInfo:r,fullExtent:s}:null}function OH(e,t,i){const r=wI(e);if(r!=null){if(!Mt.isCollection(r))return{tileInfo:r.tileInfo,fullExtent:r.fullExtent};{const s=r.find(n=>zb(n.tileInfo,n.fullExtent,t,i)==null);if(s)return{tileInfo:s.tileInfo,fullExtent:s.fullExtent}}}return{tileInfo:null,fullExtent:null}}function EH(e){return e.isWGS84||e.isWebMercator||x4(e)||!C4(e)}const AH={force512VTL:!1};function G3(e){return"["+e[0]+","+e[1]+","+e[2]+"]"}function fa(e){return"("+e[0]+","+e[1]+","+e[2]+")"}function Vs(e,t,i=FH){return Math.abs(e-t)<i}function f_(e){return e===1?5:e===7?3:e===5?1:7}function kb(e){return e===0?4:e===2?6:e===4?0:2}function IH(e){return e===7||e===5}function LH(e){return e===7||e===1}function $3(e){return e===7||e===6||e===5}function W3(e){return e===1||e===2||e===3}function Z3(e){return e===3||e===4||e===5}function Q3(e){return e===1||e===0||e===7}const Cn=[0,2,4,6],g_=[1,3,5,7],FH=1e-5;let Ms=class extends ie{constructor(e){super(e)}initialize(){this.addHandles([this.layerViews.on("change",()=>this.notifyChange("stencilEnabledExtents"))])}destroy(){}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents()}_computeStencilEnabledExtents(){const e=[];return this.layerViews.forEach(t=>{const i=t.layer;if(Yh(i)&&this.viewSpatialReference!=null){const r=uO(i.fullExtent,this.viewSpatialReference);r!=null&&e.push(V4(r))}}),e}};function VH(e,t){return e===1?new j1(t):new U1(t)}h([d({readOnly:!0})],Ms.prototype,"layerViewsExtent",null),h([d({readOnly:!0})],Ms.prototype,"tiledLayersExtent",null),h([d({readOnly:!0})],Ms.prototype,"stencilEnabledExtents",null),h([d()],Ms.prototype,"viewSpatialReference",void 0),h([d()],Ms.prototype,"tilingScheme",void 0),h([d()],Ms.prototype,"defaultTiledLayersExtent",void 0),h([d({constructOnly:!0})],Ms.prototype,"layers",void 0),h([d({constructOnly:!0})],Ms.prototype,"layerViews",void 0),Ms=h([D("esri.views.3d.terrain.ExtentHelper")],Ms);let j1=class extends Ms{_computeLayerViewsExtent(){return this._globalExtent}_computeTiledLayersExtent(){return this._globalExtent}get _globalExtent(){return this.viewSpatialReference.isWebMercator?gR:V7}};j1=h([D("esri.views.3d.terrain.ExtentHelper.ExtentHelperGlobal")],j1);let U1=class extends Ms{_computeLayerViewsExtent(){const e=zo(),t=this.viewSpatialReference;this.layerViews.forEach(s=>{const n=s.layer;if(s.isResolved()&&(n.type!=="graphics"||!n.internal)){const a=uO("fullExtentInLocalViewSpatialReference"in s&&s.fullExtentInLocalViewSpatialReference||s.layer.fullExtent,t);Nh(e,a,e)}});const i=Ov(e)?e:null,r=this._get("layerViewsExtent");return $l(i,r)?r:i}_computeTiledLayersExtent(){const e=this.tilingScheme;if(!e)return null;const t=this.viewSpatialReference,i=zo();this.layers.forEach(n=>{if(n.loaded&&jh(n)){const a=X_(n,t,2);if(a==null)return;const{tileInfo:o,fullExtent:l}=a,c="tilemapCache"in n?n.tilemapCache?.effectiveMaxLOD:void 0;o!=null&&l!=null&&(m_(n)||e.compatibleWith(o,c)&&l.spatialReference.equals(e.spatialReference))&&Nh(i,l,i)}}),Nh(i,this.defaultTiledLayersExtent,i);const r=Ov(i)?i:null,s=this._get("tiledLayersExtent");return $l(r,s)?s:r}};function uO(e,t){return e==null||e.spatialReference.equals(t)?e:q9(e,e.spatialReference,t)}U1=h([D("esri.views.3d.terrain.ExtentHelper.ExtentHelperLocal")],U1);const gh=[0,1];let zH=class{constructor(e,t){this.vec3=e,this.id=t}};function __(e,t,i,r){return new zH(We(e,t,i),r)}let X3=class{constructor(){this._extent=Rt(),this.resolution=0,this.renderLocalOrigin=__(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new kH}get extent(){return this._extent}setExtent(e){Zl(this._extent,e)}setupGeometryViews(e){if(this._setupGeometryView(),!e)return;const t=.001*e.range;if(this._extent[0]-t<=e.min){const i=this.canvasGeometries.extents[this.canvasGeometries.numViews++];Lg(this._extent,e.range,0,i)}if(this._extent[2]+t>=e.max){const i=this.canvasGeometries.extents[this.canvasGeometries.numViews++];Lg(this._extent,-e.range,0,i)}}_setupGeometryView(){this.canvasGeometries.numViews=1,Hp(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const t=this.canvasGeometries.extents[e];if(t[0]!==t[2]&&t[1]!==t[3])return!0}return!1}},kH=class{constructor(){this.extents=[Rt(),Rt(),Rt()],this.numViews=0}},BH=class{constructor(e,t,i){this._fbos=e,this._format=t,this._name=i}get valid(){return this._handle?.getTexture()!=null}dispose(){this._handle=Ht(this._handle)}get texture(){return this._handle?.getTexture()}ensureFramebuffer(e,t){this._handle&&this._handle.fbo?.width===e&&this._handle.fbo?.height===t||(this._handle?.release(),this._handle=this._fbos.acquire(e,t,this._name,this._format))}bind(e){e.bindFramebuffer(this._handle?.fbo)}generateMipMap(){this._handle?.getTexture()?.descriptor?.hasMipmap&&this._handle?.getTexture()?.generateMipmap()}},Vc=class{constructor(e,t,i,r,s=1,n=6){this.output=i,this.content=r,this.redrawOnRequest=s,this.fbo=new BH(e,n,t)}handleRenderRequest(e){return e===1||e===this.redrawOnRequest}get valid(){return this.fbo.valid}},NH=class{constructor(e){this.targets=[new Vc(e,"overlay color",0,0),new Vc(e,"overlay IM color",0,1),new Vc(e,"overlay highlight",9,2,1,3),new Vc(e,"overlay water",3,3,0),new Vc(e,"overlay occluded",0,4)],Io()&&this.targets.push(new Vc(e,"overlay olid",10,5,1,5))}getTexture(e){return this.targets[e]?.fbo.texture}dispose(e){if(e!==0)for(const t of this.targets)t.fbo.dispose();else this.targets[3].fbo.dispose()}computeValidity(){return this.targets.reduce((e,t,i)=>t.valid?e|=1<<i:e,0)}},Bb=class extends Kt{constructor(){super(...arguments),this.color=We(1,1,1)}};function dO(){const e=new ut;return e.include($i),e.fragment.uniforms.add(new Ne("tex",t=>t.texture),new Zr("uColor",t=>t.color)),e.fragment.main.add(_`vec4 texColor = texture(tex, uv);
fragColor = texColor * vec4(uColor, 1.0);`),e}const jH=Object.freeze(Object.defineProperty({__proto__:null,TextureOnlyPassParameters:Bb,build:dO},Symbol.toStringTag,{value:"Module"}));let Y3=class extends ha{constructor(e,t){super(e,"ivec2",1,(i,r,s)=>i.setUniform2iv(e,t(r,s)))}},xu=class extends ha{constructor(e,t){super(e,"usampler2D",1,(i,r,s)=>i.bindTexture(e,t(r,s)))}},Nb=class extends Kt{};function pO(){const e=new ut,{outputs:t,fragment:i}=e;return e.include($i),i.uniforms.add(new xu("highlightTexture",r=>r.highlightTexture)),i.constants.add("outlineWidth","int",Math.ceil(Ep)),i.constants.add("cellSize","int",Mo),t.add("fragGrid","uvec2"),i.main.add(_`ivec2 inputTextureSize = textureSize(highlightTexture, 0);
ivec2 cellBottomLeftCornerInput = ivec2(ivec2(floor(gl_FragCoord.xy) * vec2(cellSize)));
ivec2 coordMid =  cellBottomLeftCornerInput + ivec2(cellSize >> 1);
uvec2 centreTexel = texelFetch(highlightTexture, coordMid, 0).rg & uvec2(0x55u);
float marginSquare = float(outlineWidth*outlineWidth);
uvec2 outputValue = centreTexel & uvec2(0x55u);
for(int y = -outlineWidth; y <= cellSize + outlineWidth; y+=2) {
int dy = y < 0 ? -y : y > cellSize ? y-cellSize : 0;
int xMargin = dy > 0 ? int(ceil(sqrt(marginSquare - float(dy*dy)))) : outlineWidth;
for(int x = -xMargin; x <= cellSize + xMargin; x+=2) {
ivec2 coord = cellBottomLeftCornerInput + ivec2(x, y);
uvec2[4] texels = uvec2[4] (
texelFetch(highlightTexture,coord+ivec2(0,0),0).rg & uvec2(0x55u),
texelFetch(highlightTexture,coord+ivec2(1,0),0).rg & uvec2(0x55u),
texelFetch(highlightTexture,coord+ivec2(0,1),0).rg & uvec2(0x55u),
texelFetch(highlightTexture,coord+ivec2(1,1),0).rg & uvec2(0x55u)
);
if (texels[0] == texels[1] && texels[1] == texels[2] && texels[2] == texels[3] && texels[3] ==  centreTexel) {
continue;
}
for (int i=0; i<4; ++i){
outputValue |= ((texels[i] ^ centreTexel) << 1);
outputValue |= texels[i];
}
}
}
fragGrid = outputValue;`),e}const Mo=32,Ep=9,jb=.4,UH=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:Nb,blurSize:jb,build:pO,gridCellPixelSize:Mo,outlineSize:Ep},Symbol.toStringTag,{value:"Module"}));function Ub(e){const{vertex:t}=e;t.uniforms.add(new xu("coverageTexture",i=>i.coverageTexture),new Y3("highlightRenderCellCount",i=>Ki(K3,i.horizontalCellCount,i.verticalCellCount)),new Y3("highlightTextureResolution",({highlightTexture:i})=>Ki(K3,i.descriptor.width,i.descriptor.height)),new hc("highlightLevel",i=>i.highlightLevel)).constants.add("cellSize","int",Mo),e.varyings.add("sUV","vec2"),e.varyings.add("vOutlinePossible","float"),t.code.add(_`const ivec2 cellVertices[4] = ivec2[4](ivec2(0,0), ivec2(1,0), ivec2(0,1), ivec2(1,1));`),t.main.add(_`int cellIndex = gl_InstanceID;
int cellX = cellIndex % highlightRenderCellCount[0];
int cellY = (cellIndex - cellX) / highlightRenderCellCount[0];
ivec2 cellPos = ivec2(cellX, cellY);
uvec2 covTexel = texelFetch(coverageTexture, cellPos, 0).rg;
int channelIndex = (highlightLevel >> 2) & 3;
uint channelValue = covTexel[channelIndex];
int highlightIndex = (highlightLevel & 3) << 1;
bool covered = ((channelValue >> highlightIndex) & 1u) == 1u;
if (!covered) {
gl_Position = vec4(0.0);
return;
}
vOutlinePossible = (((channelValue >> highlightIndex) & 2u) == 2u) ? 1.0 : 0.0;
ivec2 iPosInCell = cellVertices[gl_VertexID];
vec2 sPos = vec2(cellPos * cellSize + iPosInCell * (cellSize));
vec2 vPos = sPos / vec2(highlightTextureResolution);
sUV = vPos;
gl_Position = vec4(2.0 * vPos - vec2(1.0), 0.0, 1.0);`)}const K3=ze();function mO(){const e=new ut;e.include(Ub);const{fragment:t}=e;return t.uniforms.add(new Ne("blurInput",i=>i.highlightBlurTexture),new m4("blurSize",i=>i.blurSize),new xu("highlightTexture",i=>i.highlightTexture),new Ne("highlightOptionsTexture",i=>i.highlightOptionsTexture),new hc("highlightLevel",i=>i.highlightLevel),new _e("occludedIntensityFactor",i=>i.occludedFactor)),t.constants.add("inner","float",1-(Ep-jb)/Ep),e.include(p4),t.main.add(_`vec2 highlightTextureSize = vec2(textureSize(highlightTexture,0));
vec2 uv = sUV;
vec2 center = texture(blurInput, uv).rg;
vec2 blurredHighlightValue = (vOutlinePossible == 0.0)
? center
: center * 0.204164
+ texture(blurInput, uv + blurSize * 1.407333).rg * 0.304005
+ texture(blurInput, uv - blurSize * 1.407333).rg * 0.304005
+ texture(blurInput, uv + blurSize * 3.294215).rg * 0.093913
+ texture(blurInput, uv - blurSize * 3.294215).rg * 0.093913;
float highlightIntensity = blurredHighlightValue.r;
float occlusionWeight = blurredHighlightValue.g;
if (highlightIntensity <= 0.01) {
discard;
}
vec4 fillColor    = texelFetch(highlightOptionsTexture, ivec2(highlightLevel, 0), 0);
vec4 outlineColor = texelFetch(highlightOptionsTexture, ivec2(highlightLevel, 1), 0);
uvec2 centerTexel = texelFetch(highlightTexture, ivec2(uv * highlightTextureSize), 0).rg;
uint centerBits = readLevelBits(centerTexel, highlightLevel);
bool centerFilled = (centerBits & 1u) == 1u;
bool centerOccluded = (centerBits & 3u) == 3u;
bool occluded = centerOccluded || (0.5 * highlightIntensity < occlusionWeight);
float occlusionFactor = occluded ? occludedIntensityFactor : 1.0;
float outlineFactor = centerFilled ? 1.0 : smoothstep(0.0, inner, highlightIntensity);
float fillFactor = centerFilled ? 1.0 : 0.0;
vec4 baseColor = mix(outlineColor, fillColor, fillFactor);
float intensity = baseColor.a * occlusionFactor * outlineFactor;
fragColor = vec4(baseColor.rgb, intensity);`),e}const HH=Object.freeze(Object.defineProperty({__proto__:null,build:mO},Symbol.toStringTag,{value:"Module"}));let J3=class extends ct{constructor(e,t){super(e,t,new ht(HH,()=>k(()=>Promise.resolve().then(()=>YJ),void 0)),Ja(R_))}initializePipeline(){return Ge({blending:ja,colorWrite:st})}},Hb=class extends Kt{constructor(){super(...arguments),this.blurSize=ze()}};function fO(){const e=new ut;return e.include(Ub),e.outputs.add("fragHighlight","vec2",0),e.fragment.uniforms.add(new m4("blurSize",t=>t.blurSize),new tb("blurInput",t=>t.blurInput)).main.add(_`vec2 highlightTextureSize = vec2(textureSize(blurInput,0));
vec2 center = texture(blurInput, sUV).rg;
if (vOutlinePossible == 0.0) {
fragHighlight = center;
} else {
vec2 sum = center * 0.204164;
sum += texture(blurInput, sUV + blurSize * 1.407333).rg * 0.304005;
sum += texture(blurInput, sUV - blurSize * 1.407333).rg * 0.304005;
sum += texture(blurInput, sUV + blurSize * 3.294215).rg * 0.093913;
sum += texture(blurInput, sUV - blurSize * 3.294215).rg * 0.093913;
fragHighlight = sum;
}`),e}const qH=Object.freeze(Object.defineProperty({__proto__:null,HighlightBlurDrawParameters:Hb,build:fO},Symbol.toStringTag,{value:"Module"}));let eS=class extends ct{constructor(e,t){super(e,t,new ht(qH,()=>k(()=>Promise.resolve().then(()=>KJ),void 0)),Ja(R_))}initializePipeline(){return Ge({colorWrite:st})}},b0=class extends ct{constructor(e,t){super(e,t,new ht(UH,()=>k(()=>Promise.resolve().then(()=>JJ),void 0)),ai)}initializePipeline(){return Ge({colorWrite:st})}},GH=class extends Kt{constructor(){super(...arguments),this.occludedFactor=G6,this.verticalCellCount=0,this.horizontalCellCount=0,this.highlightLevel=0,this.pixelRatio=1}};function gO(){const e=new ut;e.include(Ub),e.include(p4);const{fragment:t}=e;return e.outputs.add("fragSingleHighlight","vec2",0),t.uniforms.add(new xu("highlightTexture",i=>i.highlightTexture),new hc("highlightLevel",i=>i.highlightLevel)),t.main.add(_`ivec2 iuv = ivec2(gl_FragCoord.xy);
uvec2 inputTexel = texelFetch(highlightTexture, iuv, 0).rg;
uint bits = readLevelBits(inputTexel, highlightLevel);
bool hasHighlight = (bits & 1u) == 1u;
bool hasOccluded  = (bits & 2u) == 2u;
fragSingleHighlight = vec2(hasHighlight ? 1.0 : 0.0, hasOccluded ? 1.0 : 0.0);`),e}const $H=Object.freeze(Object.defineProperty({__proto__:null,build:gO},Symbol.toStringTag,{value:"Module"}));let tS=class extends ct{constructor(e,t){super(e,t,new ht($H,()=>k(()=>Promise.resolve().then(()=>eee),void 0)),Ja(R_))}initializePipeline(){return Ge({colorWrite:st})}},Td=class extends qo{constructor(){super(...arguments),this.produces=ne.HIGHLIGHTS,this.consumes={required:[ne.HIGHLIGHTS,"highlights"]},this._downsampleDrawParameters=new Nb,this._passParameters=new GH,this._highlightBlurDrawParameters=new Hb,this._grid=new WH}initialize(){this.addHandles([M(()=>this._updateOptionsTexture(),()=>{},Ee)])}destroy(){this._grid.coverage=Ht(this._grid.coverage),this._grid.vao=ye(this._grid.vao),this._passParameters.highlightOptionsTexture=Ht(this._passParameters.highlightOptionsTexture)}_updateOptionsTexture(){if(this._passParameters.highlightOptionsTexture==null){const e=new gt(16,2);e.internalFormat=6408,e.samplingMode=9728,this._passParameters.highlightOptionsTexture=new bt(this.renderingContext,e,null)}this._passParameters.highlightOptionsTexture.setData(ZH(this.view.state.highlights)),this.requestRender(1)}precompile(){this.techniques.precompile(b0),this.techniques.precompile(tS),this.techniques.precompile(eS),this.techniques.precompile(J3)}render(e){const t=e.find(({name:n})=>n===ne.HIGHLIGHTS),{techniques:i,bindParameters:r}=this;if(!r.decorations)return t;if(!i.get(b0).compiled)return this.requestRender(1),t;const s=e.find(({name:n})=>n==="highlights").getTexture();return this._renderHighlightPostprocess(s,t),t}_prepareAndDownSample(e){this._gridUpdateResources(e);const t=this.techniques.get(b0),i=this._gridComputeCoverage(t,e),{horizontalCellCount:r,verticalCellCount:s}=i,n=this._passParameters;return n.horizontalCellCount=r,n.verticalCellCount=s,n.coverageTexture=i.coverage?.getTexture(),i}_renderGrid(e){const t=e.verticalCellCount*e.horizontalCellCount;this.renderingContext.bindVAO(e.vao),this.renderingContext.drawElementsInstanced(St.TRIANGLES,6,Tn.UNSIGNED_BYTE,0,t)}_renderHighlightPostprocess(e,t){const{fboCache:i,techniques:r,bindParameters:s,_passParameters:n,renderingContext:a}=this,o=r.get(tS),l=r.get(eS),c=r.get(J3);if(!c.compiled||!l.compiled||!o.compiled)return void this.requestRender(1);n.highlightTexture=e;const u=this._prepareAndDownSample(e),{width:p,height:m}=e.descriptor;n.highlightTexture=e;const{camera:f}=s,{fullWidth:g,fullHeight:y,pixelRatio:v,fullViewport:C}=f,b=Math.ceil(g/v),S=Math.ceil(y/v),{_highlightBlurDrawParameters:x}=this,T=this.view.stage.renderView.renderer,{highlights:P}=s;for(let R=0;R<P.length;++R){const{name:O}=P[R];if(!T.hasHighlight(O))continue;n.highlightLevel=R,a.setClearColor(0,0,0,0);const E=i.acquire(p,m,"single highlight",2);a.bindFramebuffer(E.fbo),a.setViewport(0,0,p,m),a.clear(16384),a.bindTechnique(o,s,n),this._renderGrid(u),x.blurInput=E.getTexture(),Ki(x.blurSize,1/b,0);const A=i.acquire(b,S,"single highlight blur",2);a.unbindTexture(A.fbo?.colorTexture),a.bindFramebuffer(A.fbo),a.setViewport(0,0,b,S),a.clear(16384),a.bindTechnique(l,s,n,x),this._renderGrid(u),E.release(),Ki(x.blurSize,0,1/S),n.highlightBlurTexture=A.getTexture(),a.bindFramebuffer(t.fbo),a.setViewport4fv(C),a.bindTechnique(c,s,n,x),this._renderGrid(u),A.release()}n.coverageTexture=n.highlightTexture=null}_gridUpdateResources(e){const t=this._grid,{width:i,height:r}=e.descriptor;if(t.horizontalCellCount=Math.ceil(i/Mo),t.verticalCellCount=Math.ceil(r/Mo),t.vao)return;const s=this.renderingContext,n=Hs.createIndex(s,35044,YH);t.vao=new Dn(s,new ei(s,R_),n)}_gridComputeCoverage(e,t){const i=this.renderingContext,r=this._grid,s=t.descriptor,n=Math.ceil(s.width/Mo),a=Math.ceil(s.height/Mo);this._downsampleDrawParameters.input=t;const{highlights:o}=this.bindParameters;r.coverage?.release();const l=this.fboCache.acquire(n,a,"highlight coverage",o.length>qb?3:1);return r.coverage=l,i.bindFramebuffer(l.fbo),i.bindTechnique(e,this.bindParameters,this._passParameters,this._downsampleDrawParameters),i.setViewport(0,0,n,a),i.screen.draw(),r}get test(){}};h([d()],Td.prototype,"produces",void 0),h([d()],Td.prototype,"consumes",void 0),Td=h([D("esri.views.3d.webgl-engine.effects.highlight.Highlight")],Td);let WH=class{constructor(){this.coverage=null,this.vao=null,this.verticalCellCount=0,this.horizontalCellCount=0,this.viewportWidth=0,this.viewportHeight=0}};function ZH(e){const t=new Uint8Array(128);let i=0;for(const r of e){const s=4*i,n=4*i+64;++i;const{color:a}=r,o=r.haloColor??a;t[s+0]=a.r,t[s+1]=a.g,t[s+2]=a.b,t[s+3]=r.fillOpacity*a.a*255,t[n+0]=o.r,t[n+1]=o.g,t[n+2]=o.b,t[n+3]=r.haloOpacity*o.a*255}return t}let QH=0;function XH(e){let t=0;for(const r of e){const{name:s}=r;t+=s.length;const{color:n,fillOpacity:a,haloColor:o,haloOpacity:l}=r;t+=n.r+n.g+n.b+n.a+a,t+=o?o.r+o.g+o.b+o.a+l:0}const i=e.at(0);if(i){const{shadowOpacity:r,shadowDifference:s,shadowColor:n}=i;t+=r+s+n.r+n.g+n.b+n.a}return QH+++(t>=0?0:1)}const YH=new Uint8Array([0,1,2,2,1,3]);function _O(e,t,i,r,s,n=0){const{highlights:a}=r,o=a.length>1?t.acquire(i.width,i.height,"highlight mix",a.length>qb?3:1):null,{gl:l}=e;if(o){const u=e.getBoundFramebufferObject();e.bindFramebuffer(o.fbo),l.clearBufferuiv(l.COLOR,0,[0,0,0,0]),e.bindFramebuffer(u)}const c=o?.getTexture();r.highlightMixTexture=c,Ki(r.highlightMixOrigin,n,0),a.forEach((u,p)=>{if(p>0){const m=bt.TEXTURE_UNIT_FOR_UPDATES;e.bindTexture(c,m),e.setActiveTexture(m),l.copyTexSubImage2D(3553,0,0,0,n,0,i.width,i.height),e.bindTexture(null,m)}e.clear(256),r.highlightLevel=p,s()}),r.highlightLevel=null,r.highlightMixTexture=null,o?.release()}const qb=4;let KH=class{constructor(e,t,i,r){this.material=e,this.output=t,this.techniques=i,this.textures=r}},yO=class{constructor(e,t,i,r){this._textures=e,this._techniques=t,this.materialChanged=i,this.requestRender=r,this._id2glMaterialRef=new $a}dispose(){this._textures.destroy()}acquire(e,t,i){if(this._ownMaterial(e),!e.produces.get(t)?.(i))return null;let r=this._id2glMaterialRef.get(i,e.id);if(r==null){const s=e.createGLMaterial(new KH(e,i,this._techniques,this._textures));r=new JH(s),this._id2glMaterialRef.set(i,e.id,r)}return r.ref(),r.glMaterial}release(e,t){const i=this._id2glMaterialRef.get(t,e.id);i!=null&&(i.unref(),i.referenced||(ye(i.glMaterial),this._id2glMaterialRef.delete(t,e.id)))}_ownMaterial(e){e.repository&&e.repository!==this&&$.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),e.repository=this}},JH=class{constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,Qt(this._refCnt>=0)}get referenced(){return this._refCnt>0}};const iS=8;function eq(e,t){const{vertex:i,attributes:r}=e;i.uniforms.add(new _e("intrinsicWidth",a=>a.width));const{hasScreenSizePerspective:s,spherical:n}=t;s?(e.include(BA,t),NA(i),w2(i,t),i.uniforms.add(new $P("inverseViewMatrix",(a,o)=>tu(rS,ac(rS,o.camera.viewMatrix,a.origin)))),i.code.add(_`
      float applyLineSizeScreenSizePerspective(float size, vec3 pos) {
        vec3 worldPos = (inverseViewMatrix * vec4(pos, 1)).xyz;
        vec3 groundUp = ${n?_`normalize(worldPos + localOrigin)`:_`vec3(0.0, 0.0, 1.0)`};
        float absCosAngle = abs(dot(groundUp, normalize(worldPos - cameraPosition)));

        return screenSizePerspectiveScaleFloat(size, absCosAngle, length(pos), screenSizePerspective);
      }
    `)):i.code.add(_`float applyLineSizeScreenSizePerspective(float size, vec3 pos) {
return size;
}`),t.hasVVSize?(r.add("sizeFeatureAttribute","float"),i.uniforms.add(new Zr("vvSizeMinSize",a=>a.vvSize.minSize),new Zr("vvSizeMaxSize",a=>a.vvSize.maxSize),new Zr("vvSizeOffset",a=>a.vvSize.offset),new Zr("vvSizeFactor",a=>a.vvSize.factor),new Zr("vvSizeFallback",a=>a.vvSize.fallback)),i.code.add(_`
    float getSize(${X(s,"vec3 pos")}) {
      float size = isnan(sizeFeatureAttribute)
        ? vvSizeFallback.x
        : intrinsicWidth * clamp(vvSizeOffset + sizeFeatureAttribute * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).x;

      return ${X(s,"applyLineSizeScreenSizePerspective(size, pos)","size")};
    }
    `)):(r.add("size","float"),i.code.add(_`
    float getSize(${X(s,"vec3 pos")}) {
      float fullSize = intrinsicWidth * size;
      return ${X(s,"applyLineSizeScreenSizePerspective(fullSize, pos)","fullSize")};
    }
    `)),t.hasVVOpacity?(r.add("opacityFeatureAttribute","float"),i.constants.add("vvOpacityNumber","int",8),i.uniforms.add(new us("vvOpacityValues",a=>a.vvOpacity.values,iS),new us("vvOpacityOpacities",a=>a.vvOpacity.opacityValues,iS),new _e("vvOpacityFallback",a=>a.vvOpacity.fallback,{supportsNaN:!0})),i.code.add(_`
    float interpolateOpacity(float value) {
      if (value <= vvOpacityValues[0]) {
        return vvOpacityOpacities[0];
      }

      for (int i = 1; i < vvOpacityNumber; ++i) {
        if (vvOpacityValues[i] >= value) {
          float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
          return mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f);
        }
      }

      return vvOpacityOpacities[vvOpacityNumber - 1];
    }

    vec4 applyOpacity(vec4 color) {
      if (isnan(opacityFeatureAttribute)) {
        // If there is a color vv then it will already have taken care of applying the fallback
        return ${X(t.hasVVColor,"color","vec4(color.rgb, vvOpacityFallback)")};
      }

      return vec4(color.rgb, interpolateOpacity(opacityFeatureAttribute));
    }
    `)):i.code.add(_`vec4 applyOpacity(vec4 color) {
return color;
}`),t.hasVVColor?(e.include(jA,t),r.add("colorFeatureAttribute","float"),i.code.add(_`vec4 getColor() {
vec4 color = interpolateVVColor(colorFeatureAttribute);
if (isnan(color.r)) {
return vec4(0);
}
return applyOpacity(color);
}`)):(r.add("color","vec4"),i.code.add(_`vec4 getColor() {
return applyOpacity(color);
}`))}const rS=Le();function tq(e){e.vertex.code.add("#define noPerspectiveWrite(x, w) (x * w)")}function H1(e){e.fragment.code.add("#define noPerspectiveRead(x) (x * gl_FragCoord.w)")}let vO=class{constructor(e,t,i){this._createTexture=e,this._parametersKey=t,this._repository=new Map,this._orphanCache=i.newCache(`procedural-texture-repository:${uu()}`,r=>r.dispose())}destroy(){for(const{texture:e}of this._repository.values())e.dispose();this._repository.clear(),this._orphanCache.destroy()}swap(e,t=null){const i=this._acquire(e);return this.release(t),i}release(e){if(e==null)return;const t=this._parametersKey(e),i=this._repository.get(t);if(i&&(i.refCount--,i.refCount===0)){this._repository.delete(t);const{texture:r}=i;this._orphanCache.put(t,r)}}_acquire(e){if(e==null)return null;const t=this._parametersKey(e),i=this._repository.get(t);if(i)return i.refCount++,i.texture;const r=this._orphanCache.pop(t)??this._createTexture(e),s=new iq(r);return this._repository.set(t,s),r}},iq=class{constructor(e){this.texture=e,this.refCount=1}};function rq(e,t){return new vO(i=>{const{data:r,textureSize:s}=sq(i),n=new gt(s,1);return n.dataType=ni.FLOAT,n.pixelFormat=6403,n.internalFormat=Lr.R16F,n.wrapMode=10497,new bt(e,n,r)},i=>`${i.pattern.join(",")}-r${i.pixelRatio}`,t)}function sq(e){const t=bO(e),i=1/e.pixelRatio,r=wO(e),s=[];let n=1;for(const o of t){for(let l=0;l<o;l++){const c=n*(Math.min(l,o-1-l)+.5)*i;s.push(c)}n=-n}const a=Math.round(t[0]/2);return{data:new Float32Array([...s.slice(a),...s.slice(0,a)]),textureSize:r}}function bO(e){return e.pattern.map(t=>Math.round(t*e.pixelRatio))}function wO(e){if(e==null)return 1;const t=bO(e);return Math.floor(t.reduce((i,r)=>i+r))}function nq(e){return e==null?di:e.length===4?e:cr(aq,e[0],e[1],e[2],1)}const aq=Vt();function oq(e,t){if(!t.stippleEnabled)return void e.fragment.code.add(_`float getStippleAlpha(float lineWidth) { return 1.0; }
void discardByStippleAlpha(float stippleAlpha, float threshold) {}
vec4 blendStipple(vec4 color, float stippleAlpha) { return color; }`);const i=!(t.draped&&t.stipplePreferContinuous),{vertex:r,fragment:s}=e;t.draped||(w2(r,t),r.uniforms.add(new Er("worldToScreenPerDistanceRatio",({camera:n})=>1/n.perScreenPixelRatio)).code.add(_`float computeWorldToScreenRatio(vec3 segmentCenter) {
float segmentDistanceToCamera = length(segmentCenter - cameraPosition);
return worldToScreenPerDistanceRatio / segmentDistanceToCamera;
}`)),e.varyings.add("vStippleDistance","float"),e.varyings.add("vStippleDistanceLimits","vec2"),e.varyings.add("vStipplePatternStretch","float"),r.code.add(_`
    float discretizeWorldToScreenRatio(float worldToScreenRatio) {
      float step = ${_.float(lq)};

      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);
      return discreteWorldToScreenRatio;
    }
  `),x2(r),r.code.add(_`
    vec2 computeStippleDistanceLimits(float startPseudoScreen, float segmentLengthPseudoScreen, float segmentLengthScreen, float patternLength) {

      // First check if the segment is long enough to support fully screen space patterns.
      // Force sparse mode for segments that are very large in screen space even if it is not allowed,
      // to avoid imprecision from calculating with large floats.
      if (segmentLengthPseudoScreen >= ${i?"patternLength":"1e4"}) {
        // Round the screen length to get an integer number of pattern repetitions (minimum 1).
        float repetitions = segmentLengthScreen / (patternLength * pixelRatio);
        float flooredRepetitions = max(1.0, floor(repetitions + 0.5));
        float segmentLengthScreenRounded = flooredRepetitions * patternLength;

        float stretch = repetitions / flooredRepetitions;

        // We need to impose a lower bound on the stretch factor to prevent the dots from merging together when there is only 1 repetition.
        // 0.75 is the lowest possible stretch value for flooredRepetitions > 1, so it makes sense as lower bound.
        vStipplePatternStretch = max(0.75, stretch);

        return vec2(0.0, segmentLengthScreenRounded);
      }
      return vec2(startPseudoScreen, startPseudoScreen + segmentLengthPseudoScreen);
    }
  `),s.uniforms.add(new Ne("stipplePatternTexture",n=>n.stippleTexture),new _e("stipplePatternPixelSizeInv",n=>1/xO(n))),t.stippleOffColorEnabled&&s.uniforms.add(new $r("stippleOffColor",n=>nq(n.stippleOffColor))),e.include(H1),s.code.add(_`float getStippleSDF(out bool isClamped) {
float stippleDistanceClamped = noPerspectiveRead(clamp(vStippleDistance, vStippleDistanceLimits.x, vStippleDistanceLimits.y));
float lineSizeInv = noPerspectiveRead(vLineSizeInv);
vec2 aaCorrectedLimits = vStippleDistanceLimits + vec2(1.0, -1.0) / gl_FragCoord.w;
isClamped = vStippleDistance < aaCorrectedLimits.x || vStippleDistance > aaCorrectedLimits.y;
float u = stippleDistanceClamped * stipplePatternPixelSizeInv * lineSizeInv;
u = fract(u);
float sdf = texture(stipplePatternTexture, vec2(u, 0.5)).r;
return (sdf - 0.5) * vStipplePatternStretch + 0.5;
}
float getStippleSDF() {
bool ignored;
return getStippleSDF(ignored);
}
float getStippleAlpha(float lineWidth) {
bool isClamped;
float stippleSDF = getStippleSDF(isClamped);
float antiAliasedResult = clamp(stippleSDF * lineWidth + 0.5, 0.0, 1.0);
return isClamped ? floor(antiAliasedResult + 0.5) : antiAliasedResult;
}`),s.code.add(_`
    void discardByStippleAlpha(float stippleAlpha, float threshold) {
     ${X(!t.stippleOffColorEnabled,"if (stippleAlpha < threshold) { discard; }")}
    }

    vec4 blendStipple(vec4 color, float stippleAlpha) {
      return ${t.stippleOffColorEnabled?"mix(color, stippleOffColor, stippleAlpha)":"vec4(color.rgb, color.a * stippleAlpha)"};
    }
  `)}function xO(e){const t=e.stipplePattern;return t?wO(e.stipplePattern)/t.pixelRatio:1}const lq=.4,y_=64,CO=y_/2,SO=CO/5,cq=y_/SO,yse=.25;function hq(e,t){const i=pI(e,y_,CO,SO),r=new gt(y_);return r.internalFormat=Lr.R16F,r.dataType=ni.FLOAT,r.pixelFormat=6403,r.wrapMode=33071,new bt(t,r,i)}function uq(e,t){const i=e.vertex,r=t.hasScreenSizePerspective;x2(i),i.uniforms.get("markerScale")==null&&i.constants.add("markerScale","float",1),i.constants.add("markerSizePerLineWidth","float",cq).code.add(_`
  float getLineWidth(${X(r,"vec3 pos")}) {
     return max(getSize(${X(r,"pos")}), 1.0) * pixelRatio;
  }

  float getScreenMarkerSize(float lineWidth) {
    return markerScale * markerSizePerLineWidth * lineWidth;
  }
  `),t.space===2&&(i.constants.add("maxSegmentLengthFraction","float",.45),i.uniforms.add(new Er("perRenderPixelRatio",s=>s.camera.perRenderPixelRatio)),i.code.add(_`
  bool areWorldMarkersHidden(vec3 pos, vec3 other) {
    vec3 midPoint = mix(pos, other, 0.5);
    float distanceToCamera = length(midPoint);
    float screenToWorldRatio = perRenderPixelRatio * distanceToCamera * 0.5;
    float worldMarkerSize = getScreenMarkerSize(getLineWidth(${X(r,"pos")})) * screenToWorldRatio;
    float segmentLen = length(pos - other);
    return worldMarkerSize > maxSegmentLengthFraction * segmentLen;
  }

  float getWorldMarkerSize(vec3 pos) {
    float distanceToCamera = length(pos);
    float screenToWorldRatio = perRenderPixelRatio * distanceToCamera * 0.5;
    return getScreenMarkerSize(getLineWidth(${X(r,"pos")})) * screenToWorldRatio;
  }
  `))}function dq(e,t){if(!t.hasAnimation)return;const{attributes:i,varyings:r,vertex:s,fragment:n}=e;i.add("timeStamps","vec4"),r.add("vTimeStamp","float"),r.add("vFirstTime","float"),r.add("vLastTime","float"),r.add("vTransitionType","float"),s.main.add(_`vTimeStamp = timeStamps.x;
vFirstTime = timeStamps.y;
vLastTime = timeStamps.z;
vTransitionType = timeStamps.w;`);const{animation:a}=t;a===3&&n.constants.add("decayRate","float",2.3),n.code.add(_`
    float getTrailOpacity(float x) {
      ${pq(a)}
    }`),n.uniforms.add(new _e("timeElapsed",o=>o.timeElapsed),new _e("trailLength",o=>o.trailLength),new _e("speed",o=>o.animationSpeed),new $r("timingOptions",o=>cr(mq,o.startTime,o.endTime,o.fadeInTime,o.fadeOutTime))),n.code.add(_`float fadeIn(float x) {
return smoothstep(0.0, timingOptions[2], x);
}
float fadeOut(float x) {
return isinf(timingOptions[3]) ? 1.0 : smoothstep(timingOptions[3], 0.0, x);
}`),n.code.add(_`vec4 animate(vec4 color) {
float startTime = timingOptions[0];
float endTime = timingOptions[1];
float totalTime = vLastTime - vFirstTime;
float actualEndTime = int(vTransitionType) == 2 ? min(endTime, startTime + vLastTime / speed) : endTime;
vec4 animatedColor = color;
if (speed == 0.0) {
animatedColor.a *= getTrailOpacity((totalTime - (vTimeStamp - vFirstTime)) / trailLength);
animatedColor.a *= isinf(actualEndTime) ? 1.0 : fadeOut(timeElapsed - actualEndTime);
animatedColor.a *= fadeIn(timeElapsed - startTime);
return animatedColor;
}
float relativeStartTime = mod(startTime, totalTime);
float vHeadRelativeToFirst = mod((timeElapsed - relativeStartTime) * speed - vFirstTime, totalTime);
float vRelativeToHead = vHeadRelativeToFirst + vFirstTime - vTimeStamp;
bool inPreviousCycle = vRelativeToHead < 0.0;
vRelativeToHead += inPreviousCycle ? totalTime : 0.0;
float vAbsoluteTime = timeElapsed - vRelativeToHead / speed;
if (vAbsoluteTime > actualEndTime) {
vRelativeToHead = (timeElapsed - relativeStartTime) * speed - vTimeStamp;
vAbsoluteTime = timeElapsed - vRelativeToHead / speed;
}
animatedColor *= step(startTime, vAbsoluteTime);
animatedColor *= step(vAbsoluteTime, actualEndTime);
animatedColor.a *= isinf(actualEndTime) ? 1.0 : fadeOut(timeElapsed - actualEndTime);
animatedColor.a *= inPreviousCycle ? fadeOut(vHeadRelativeToFirst / speed) : 1.0;
animatedColor.a *= getTrailOpacity(vRelativeToHead / trailLength);
animatedColor.a *= int(vTransitionType) == 0 ? fadeIn(vAbsoluteTime - startTime) : 1.0;
animatedColor.a *= fadeIn(vTimeStamp - vFirstTime);
return animatedColor;
}`)}function pq(e){switch(e){case 2:return"return x >= 0.0 && x <= 1.0 ? 1.0 : 0.0;";case 3:return`float cutOff = exp(-decayRate);
        return (exp(-decayRate * x) - cutOff) / (1.0 - cutOff);`;default:return"return 1.0;"}}const mq=Vt(),Ap=1;function TO(e){const t=new ut,{attributes:i,varyings:r,vertex:s,fragment:n}=t,{applyMarkerOffset:a,draped:o,output:l,capType:c,stippleEnabled:u,falloffEnabled:p,roundJoins:m,wireframe:f,innerColorEnabled:g,hasAnimation:y,hasScreenSizePerspective:v}=e;n.include(i4),t.include(eq,e),t.include(oq,e),t.include(c8,e),t.include(r4,e),t.include(dq,e);const C=a&&!o;C&&(s.uniforms.add(new _e("markerScale",R=>R.markerScale)),t.include(uq,{space:2,hasScreenSizePerspective:v})),s4(s,e),s.uniforms.add(new ps("inverseProjectionMatrix",R=>R.camera.inverseProjectionMatrix),new op("nearFar",R=>R.camera.nearFar),new _e("miterLimit",R=>R.join!=="miter"?0:R.miterLimit),new M_("viewport",R=>R.camera.fullViewport)),s.constants.add("LARGE_HALF_FLOAT","float",65500),i.add("position","vec3"),i.add("previousDelta","vec4"),i.add("nextDelta","vec4"),i.add("lineParameters","vec2"),i.add("u0","float"),r.add("vColor","vec4"),r.add("vpos","vec3",{invariant:!0}),r.add("vLineDistance","float"),r.add("vLineWidth","float");const b=u;b&&r.add("vLineSizeInv","float");const S=c===2,x=u&&S,T=p||x;T&&r.add("vLineDistanceNorm","float"),S&&(r.add("vSegmentSDF","float"),r.add("vReverseSegmentSDF","float")),s.code.add(_`vec2 perpendicular(vec2 v) {
return vec2(v.y, -v.x);
}
float interp(float ncp, vec4 a, vec4 b) {
return (-ncp - a.z) / (b.z - a.z);
}
vec2 rotate(vec2 v, float a) {
float s = sin(a);
float c = cos(a);
mat2 m = mat2(c, -s, s, c);
return m * v;
}`),s.code.add(_`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= viewport.zw / posNdc.w;
return posNdc;
}`),s.code.add(_`void clip(
inout vec4 pos,
inout vec4 prev,
inout vec4 next,
bool isStartVertex
) {
float vnp = nearFar[0] * 0.99;
if (pos.z > -nearFar[0]) {
if (!isStartVertex) {
if (prev.z < -nearFar[0]) {
pos = mix(prev, pos, interp(vnp, prev, pos));
next = pos;
} else {
pos = vec4(0.0, 0.0, 0.0, 1.0);
}
} else {
if (next.z < -nearFar[0]) {
pos = mix(pos, next, interp(vnp, pos, next));
prev = pos;
} else {
pos = vec4(0.0, 0.0, 0.0, 1.0);
}
}
} else {
if (prev.z > -nearFar[0]) {
prev = mix(pos, prev, interp(vnp, pos, prev));
}
if (next.z > -nearFar[0]) {
next = mix(next, pos, interp(vnp, next, pos));
}
}
}`),x2(s),s.constants.add("aaWidth","float",u?0:1).main.add(_`bool isStartVertex = abs(abs(lineParameters.y) - 3.0) == 1.0;
vec3 prevPosition = position + previousDelta.xyz * previousDelta.w;
vec3 nextPosition = position + nextDelta.xyz * nextDelta.w;
float coverage = 1.0;
if (lineParameters.y == 0.0) {
gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
}
else {
vec4 pos  = view * vec4(position, 1.0);
vec4 prev = view * vec4(prevPosition, 1.0);
vec4 next = view * vec4(nextPosition, 1.0);
bool isJoin = abs(lineParameters.y) < 3.0;`),C&&s.main.add(_`vec4 other = isStartVertex ? next : prev;
bool markersHidden = areWorldMarkersHidden(pos.xyz, other.xyz);
if (!isJoin && !markersHidden) {
pos.xyz += normalize(other.xyz - pos.xyz) * getWorldMarkerSize(pos.xyz) * 0.5;
}`),t.include(tq),s.main.add(_`
      clip(pos, prev, next, isStartVertex);

      vec3 clippedPos = pos.xyz;
      vec3 clippedCenter = mix(pos.xyz, isStartVertex ? next.xyz : prev.xyz, 0.5);

      forwardViewPosDepth(pos.xyz);

      pos = projectAndScale(pos);
      next = projectAndScale(next);
      prev = projectAndScale(prev);

      vec2 left = (pos.xy - prev.xy);
      vec2 right = (next.xy - pos.xy);

      float leftLen = length(left);
      float rightLen = length(right);

      float lineSize = getSize(${X(v,"clippedPos")});
      ${X(u&&v,"float patternLineSize = getSize(clippedCenter);")}
      ${X(u&&!v,"float patternLineSize = lineSize;")}

      if (lineSize < 1.0) {
        coverage = lineSize; // convert sub-pixel coverage to alpha
        lineSize = 1.0;
      }
      lineSize += aaWidth;

      float lineWidth = lineSize * pixelRatio;
      vLineWidth = noPerspectiveWrite(lineWidth, pos.w);
      ${b?_`vLineSizeInv = noPerspectiveWrite(1.0 / lineSize, pos.w);`:""}
  `),(u||S)&&s.main.add(_`
      float isEndVertex = float(!isStartVertex);
      vec2 segmentOrigin = mix(pos.xy, prev.xy, isEndVertex);
      vec2 segment = mix(right, left, isEndVertex);
      ${S?_`vec2 segmentEnd = mix(next.xy, pos.xy, isEndVertex);`:""}
    `),s.main.add(_`left = (leftLen > 0.001) ? left/leftLen : vec2(0.0, 0.0);
right = (rightLen > 0.001) ? right/rightLen : vec2(0.0, 0.0);
vec2 capDisplacementDir = vec2(0, 0);
vec2 joinDisplacementDir = vec2(0, 0);
float displacementLen = lineWidth;
if (isJoin) {
bool isOutside = (left.x * right.y - left.y * right.x) * lineParameters.y > 0.0;
joinDisplacementDir = normalize(left + right);
joinDisplacementDir = perpendicular(joinDisplacementDir);
if (leftLen > 0.001 && rightLen > 0.001) {
float nDotSeg = dot(joinDisplacementDir, left);
displacementLen /= length(nDotSeg * left - joinDisplacementDir);
if (!isOutside) {
displacementLen = min(displacementLen, min(leftLen, rightLen)/abs(nDotSeg));
}
}
float subdivisionFactor = lineParameters.x;
if (isOutside && (displacementLen > miterLimit * lineWidth)) {`),m?s.main.add(_`
        vec2 startDir = leftLen < 0.001 ? right : left;
        startDir = perpendicular(startDir);

        vec2 endDir = rightLen < 0.001 ? left : right;
        endDir = perpendicular(endDir);

        float factor = ${u?_`min(1.0, subdivisionFactor * ${_.float((Ap+2)/(Ap+1))})`:_`subdivisionFactor`};

        float rotationAngle = acos(clamp(dot(startDir, endDir), -1.0, 1.0));
        joinDisplacementDir = rotate(startDir, -sign(lineParameters.y) * factor * rotationAngle);
      `):s.main.add(_`if (leftLen < 0.001) {
joinDisplacementDir = right;
}
else if (rightLen < 0.001) {
joinDisplacementDir = left;
}
else {
joinDisplacementDir = (isStartVertex || subdivisionFactor > 0.0) ? right : left;
}
joinDisplacementDir = perpendicular(joinDisplacementDir);`);const P=c!==0;return s.main.add(_`
        displacementLen = lineWidth;
      }
    } else {
      // CAP handling ---------------------------------------------------
      joinDisplacementDir = isStartVertex ? right : left;
      joinDisplacementDir = perpendicular(joinDisplacementDir);

      ${P?_`capDisplacementDir = isStartVertex ? -right : left;`:""}
    }
  `),s.main.add(_`
    // Displacement (in pixels) caused by join/or cap
    vec2 dpos = joinDisplacementDir * sign(lineParameters.y) * displacementLen + capDisplacementDir * displacementLen;
    float lineDistNorm = noPerspectiveWrite(sign(lineParameters.y), pos.w);

    vLineDistance = lineWidth * lineDistNorm;
    ${T?_`vLineDistanceNorm = lineDistNorm;`:""}

    pos.xy += dpos;
  `),S&&s.main.add(_`vec2 segmentDir = normalize(segment);
vSegmentSDF = noPerspectiveWrite((isJoin && isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentOrigin, segmentDir)), pos.w);
vReverseSegmentSDF = noPerspectiveWrite((isJoin && !isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentEnd, -segmentDir)), pos.w);`),u&&(o?s.uniforms.add(new Er("worldToScreenRatio",R=>1/R.screenToPCSRatio)):s.main.add(_`vec3 segmentCenter = mix((nextPosition + position) * 0.5, (position + prevPosition) * 0.5, isEndVertex);
float worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);`),s.main.add(_`float segmentLengthScreenDouble = length(segment);
float segmentLengthScreen = segmentLengthScreenDouble * 0.5;
float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);
float segmentLengthRender = length(mix(nextPosition - position, position - prevPosition, isEndVertex));
vStipplePatternStretch = worldToScreenRatio / discreteWorldToScreenRatio;`),o?s.main.add(_`float segmentLengthPseudoScreen = segmentLengthScreen / pixelRatio * discreteWorldToScreenRatio / worldToScreenRatio;
float startPseudoScreen = u0 * discreteWorldToScreenRatio - mix(0.0, segmentLengthPseudoScreen, isEndVertex);`):s.main.add(_`float startPseudoScreen = mix(u0, u0 - segmentLengthRender, isEndVertex) * discreteWorldToScreenRatio;
float segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;`),s.uniforms.add(new _e("stipplePatternPixelSize",R=>xO(R))),s.main.add(_`float patternLength = patternLineSize * stipplePatternPixelSize;
vStippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, segmentLengthScreen, patternLength);
vStippleDistance = mix(vStippleDistanceLimits.x, vStippleDistanceLimits.y, isEndVertex);
if (segmentLengthScreenDouble >= 0.001) {
vec2 stippleDisplacement = pos.xy - segmentOrigin;
float stippleDisplacementFactor = dot(segment, stippleDisplacement) / (segmentLengthScreenDouble * segmentLengthScreenDouble);
vStippleDistance += (stippleDisplacementFactor - isEndVertex) * (vStippleDistanceLimits.y - vStippleDistanceLimits.x);
}
vStippleDistanceLimits = noPerspectiveWrite(vStippleDistanceLimits, pos.w);
vStippleDistance = noPerspectiveWrite(vStippleDistance, pos.w);
vStippleDistanceLimits = isJoin ?
vStippleDistanceLimits :
isStartVertex ?
vec2(-1e34, vStippleDistanceLimits.y) :
vec2(vStippleDistanceLimits.x, 1e34);`)),s.main.add(_`
      // Convert back into NDC
      pos.xy = (pos.xy / viewport.zw) * pos.w;

      vColor = getColor();
      vColor.a = noPerspectiveWrite(vColor.a * coverage, pos.w);

      ${f&&!o?"pos.z -= 0.001 * pos.w;":""}

      // transform final position to camera space for slicing
      vpos = (inverseProjectionMatrix * pos).xyz;
      gl_Position = pos;
      forwardObjectAndLayerIdColor();
    }`),t.fragment.include(n4,e),t.include(a4,e),n.include(S2),n.main.add(_`discardBySlice(vpos);
discardByTerrainDepth();`),t.include(H1),n.main.add(_`
    float lineWidth = noPerspectiveRead(vLineWidth);
    float lineDistance = noPerspectiveRead(vLineDistance);
    ${X(T,_`float lineDistanceNorm = noPerspectiveRead(vLineDistanceNorm);`)}
  `),f?n.main.add(_`vec4 finalColor = vec4(1.0, 0.0, 1.0, 1.0);`):(S&&n.main.add(_`
        float sdf = noPerspectiveRead(min(vSegmentSDF, vReverseSegmentSDF));
        vec2 fragmentPosition = vec2(min(sdf, 0.0), lineDistance);

        float fragmentRadius = length(fragmentPosition);
        float fragmentCapSDF = (fragmentRadius - lineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
        float capCoverage = clamp(0.5 - fragmentCapSDF, 0.0, 1.0);

        if (capCoverage < ${_.float(Or)}) {
          discard;
        }
      `),x?n.main.add(_`
      vec2 stipplePosition = vec2(
        min(getStippleSDF() * 2.0 - 1.0, 0.0),
        lineDistanceNorm
      );
      float stippleRadius = length(stipplePosition * lineWidth);
      float stippleCapSDF = (stippleRadius - lineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
      float stippleCoverage = clamp(0.5 - stippleCapSDF, 0.0, 1.0);
      float stippleAlpha = step(${_.float(Or)}, stippleCoverage);
      `):n.main.add(_`float stippleAlpha = getStippleAlpha(lineWidth);`),l!==10&&n.main.add(_`discardByStippleAlpha(stippleAlpha, ${_.float(Or)});`),t.include(H1),n.uniforms.add(new $r("intrinsicColor",R=>R.color)).main.add(_`vec4 color = intrinsicColor * vColor;
color.a = noPerspectiveRead(color.a);`),g&&n.uniforms.add(new $r("innerColor",R=>R.innerColor??R.color),new _e("innerWidth",(R,O)=>R.innerWidth*O.camera.pixelRatio)).main.add(_`float distToInner = abs(lineDistance) - innerWidth;
float innerAA = clamp(0.5 - distToInner, 0.0, 1.0);
float innerAlpha = innerColor.a + color.a * (1.0 - innerColor.a);
color = mix(color, vec4(innerColor.rgb, innerAlpha), innerAA);`),n.main.add(_`vec4 finalColor = blendStipple(color, stippleAlpha);`),p&&(n.uniforms.add(new _e("falloff",R=>R.falloff)),n.main.add(_`finalColor.a *= pow(max(0.0, 1.0 - abs(lineDistanceNorm)), falloff);`)),u||n.main.add(_`float featherStartDistance = max(lineWidth - 2.0, 0.0);
float value = abs(lineDistance);
float feather = (value - featherStartDistance) / (lineWidth - featherStartDistance);
finalColor.a *= 1.0 - clamp(feather, 0.0, 1.0);`),y&&n.main.add(_`
        finalColor = animate(finalColor);

        ${X(l!==10,_`
            if (finalColor.a <= ${_.float(Or)}) {
              discard;
            }`)}
      `)),n.main.add(_`outputColorHighlightOID(finalColor, vpos, finalColor.rgb);`),t}const fq=Object.freeze(Object.defineProperty({__proto__:null,build:TO,ribbonlineNumRoundJoinSubdivisions:Ap},Symbol.toStringTag,{value:"Module"}));let gq=class extends ct{constructor(e,t){super(e,t,new ht(fq,()=>k(()=>Promise.resolve().then(()=>tee),void 0)),PO(t).locations),this.primitiveType=t.wireframe?St.LINES:St.TRIANGLE_STRIP}_makePipelineState(e,t){const{oitPass:i,output:r,hasOccludees:s,hasPolygonOffset:n}=e,a=i===0,o=i===2;return Ge({blending:or(r)?JP(i):null,depthTest:{func:KP(i)},depthWrite:GA(e),drawBuffers:Sh(r,Gd(i,r)),colorWrite:st,stencilWrite:s?Cv:null,stencilTest:s?t?Hw:YP:null,polygonOffset:a||o?n?sS:null:XP})}initializePipeline(e){if(e.occluder){const t=e.hasPolygonOffset?sS:null,{output:i,hasOccludees:r}=e;this._occluderPipelineTransparent=Ge({blending:ja,polygonOffset:t,depthTest:qw,depthWrite:null,colorWrite:st,stencilWrite:null,stencilTest:r?KA:null,drawBuffers:Sh(i)}),this._occluderPipelineOpaque=Ge({blending:ja,polygonOffset:t,depthTest:r?qw:Gw,depthWrite:null,colorWrite:st,stencilWrite:r?e8:null,stencilTest:r?JA:null,drawBuffers:Sh(i)}),this._occluderPipelineMaskWrite=Ge({blending:null,polygonOffset:t,depthTest:Gw,depthWrite:null,colorWrite:null,stencilWrite:r?Cv:null,stencilTest:r?Hw:null,drawBuffers:Sh(i)})}return this._occludeePipeline=this._makePipelineState(e,!0),this._makePipelineState(e,!1)}getPipeline(e,t){if(e)return this._occludeePipeline;switch(t){case 11:return this._occluderPipelineTransparent??super.getPipeline();case 10:return this._occluderPipelineOpaque??super.getPipeline();default:return this._occluderPipelineMaskWrite??super.getPipeline()}}};const sS={factor:0,units:-4};function PO(e){const t=Ka().vec3f("position").vec4f16("previousDelta").vec4f16("nextDelta").f32("u0").vec2f16("lineParameters");return e.hasVVColor?t.f32("colorFeatureAttribute"):t.vec4u8("color",{glNormalized:!0}),e.hasVVSize?t.f32("sizeFeatureAttribute"):t.f32("size"),e.hasVVOpacity&&t.f32("opacityFeatureAttribute"),Io()&&t.vec4u8("olidColor"),e.hasAnimation&&t.vec4f16("timeStamps"),t}let Jt=class extends S_{constructor(e){super(),this.spherical=e,this.capType=0,this.emissionSource=0,this.hasPolygonOffset=!1,this.writeDepth=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stipplePreferContinuous=!0,this.roundJoins=!1,this.applyMarkerOffset=!1,this.hasVVSize=!1,this.hasVVColor=!1,this.hasVVOpacity=!1,this.falloffEnabled=!1,this.innerColorEnabled=!1,this.hasOccludees=!1,this.occluder=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.wireframe=!1,this.discardInvisibleFragments=!1,this.animation=2,this.hasScreenSizePerspective=!1,this.textureCoordinateType=0,this.occlusionPass=!1,this.hasVVInstancing=!1,this.hasSliceTranslatedView=!0,this.overlayEnabled=!1,this.snowCover=!1}get hasAnimation(){return this.animation!==0}};h([z({count:3})],Jt.prototype,"capType",void 0),h([z({count:8})],Jt.prototype,"emissionSource",void 0),h([z()],Jt.prototype,"hasPolygonOffset",void 0),h([z()],Jt.prototype,"writeDepth",void 0),h([z()],Jt.prototype,"draped",void 0),h([z()],Jt.prototype,"stippleEnabled",void 0),h([z()],Jt.prototype,"stippleOffColorEnabled",void 0),h([z()],Jt.prototype,"stipplePreferContinuous",void 0),h([z()],Jt.prototype,"roundJoins",void 0),h([z()],Jt.prototype,"applyMarkerOffset",void 0),h([z()],Jt.prototype,"hasVVSize",void 0),h([z()],Jt.prototype,"hasVVColor",void 0),h([z()],Jt.prototype,"hasVVOpacity",void 0),h([z()],Jt.prototype,"falloffEnabled",void 0),h([z()],Jt.prototype,"innerColorEnabled",void 0),h([z()],Jt.prototype,"hasOccludees",void 0),h([z()],Jt.prototype,"occluder",void 0),h([z()],Jt.prototype,"terrainDepthTest",void 0),h([z()],Jt.prototype,"cullAboveTerrain",void 0),h([z()],Jt.prototype,"wireframe",void 0),h([z()],Jt.prototype,"discardInvisibleFragments",void 0),h([z({count:4})],Jt.prototype,"animation",void 0),h([z()],Jt.prototype,"hasScreenSizePerspective",void 0);let _q=class extends UP{constructor(e,t){super(e,vq),this.produces=new Map([[2,i=>bF(i)||or(i)&&this.parameters.renderOccluded===8],[3,i=>wF(i)],[10,i=>vx(i)&&this.parameters.renderOccluded===8],[11,i=>vx(i)&&this.parameters.renderOccluded===8],[4,i=>or(i)&&this.parameters.writeDepth&&this.parameters.renderOccluded!==8],[8,i=>or(i)&&!this.parameters.writeDepth&&this.parameters.renderOccluded!==8],[18,i=>xF(i)]]),this._configuration=new Jt(t)}getConfiguration(e,t){super.getConfiguration(e,t,this._configuration),this._configuration.oitPass=t.oitPass,this._configuration.draped=t.slot===18;const i=this.parameters.stipplePattern!=null&&e!==9;return this._configuration.stippleEnabled=i,this._configuration.stippleOffColorEnabled=i&&this.parameters.stippleOffColor!=null,this._configuration.stipplePreferContinuous=i&&this.parameters.stipplePreferContinuous,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.roundJoins=this.parameters.join==="round",this._configuration.capType=this.parameters.cap,this._configuration.applyMarkerOffset=this.parameters.markerParameters!=null&&wq(this.parameters.markerParameters),this._configuration.hasPolygonOffset=this.parameters.hasPolygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasVVSize=this.parameters.hasVVSize,this._configuration.hasVVColor=this.parameters.hasVVColor,this._configuration.hasVVOpacity=this.parameters.hasVVOpacity,this._configuration.innerColorEnabled=this.parameters.innerWidth>0&&this.parameters.innerColor!=null,this._configuration.falloffEnabled=this.parameters.falloff>0,this._configuration.hasOccludees=t.hasOccludees,this._configuration.occluder=this.parameters.renderOccluded===8,this._configuration.terrainDepthTest=t.terrainDepthTest&&or(e),this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration.wireframe=this.parameters.wireframe,this._configuration.animation=this.parameters.animation,this._configuration.emissionSource=this.hasEmissions?1:0,this._configuration.hasScreenSizePerspective=!!this.parameters.screenSizePerspective,this._configuration}get visible(){return this.parameters.color[3]>=Or||this.parameters.stipplePattern!=null&&(this.parameters.stippleOffColor?.[3]??0)>Or}setParameters(e,t){e.animation=this.parameters.animation,super.setParameters(e,t)}intersectDraped({attributes:e,screenToWorldRatio:t},i,r,s,n){if(!i.options.selectionMode)return;const a=e.get("size");let o=this.parameters.width;if(this.parameters.vvSize){const y=e.get("sizeFeatureAttribute").data[0];Number.isNaN(y)?o*=this.parameters.vvSize.fallback[0]:o*=j(this.parameters.vvSize.offset[0]+y*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else a&&(o*=a.data[0]);const l=r[0],c=r[1],u=(o/2+4)*t;let p=Number.MAX_VALUE,m=0;const f=e.get("position").data,g=q1(this.parameters,e)?f.length-2:f.length-5;for(let y=0;y<g;y+=3){const v=f[y],C=f[y+1],b=(y+3)%f.length,S=l-v,x=c-C,T=f[b]-v,P=f[b+1]-C,R=j((T*S+P*x)/(T*T+P*P),0,1),O=T*R-S,E=P*R-x,A=O*O+E*E;A<p&&(p=A,m=y/3)}p<u*u&&s(n.distance,n.normal,m)}intersect(e,t,i,r,s,n){const{options:a,camera:o,rayBegin:l,rayEnd:c}=i;if(!a.selectionMode||!e.visible||!o)return;if(!gF(t))return void $.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial").error("intersection assumes a translation-only matrix");const u=e.attributes,p=u.get("position").data;let m=this.parameters.width;if(this.parameters.vvSize){const b=u.get("sizeFeatureAttribute").data[0];Number.isNaN(b)||(m*=j(this.parameters.vvSize.offset[0]+b*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0]))}else u.has("size")&&(m*=u.get("size").data[0]);const f=xq;fs(f,i.point);const g=m*o.pixelRatio/2+4*o.pixelRatio;xe(Gu[0],f[0]-g,f[1]+g,0),xe(Gu[1],f[0]+g,f[1]+g,0),xe(Gu[2],f[0]+g,f[1]-g,0),xe(Gu[3],f[0]-g,f[1]-g,0);for(let b=0;b<4;b++)if(!o.unprojectFromRenderScreen(Gu[b],ga[b]))return;cm(o.eye,ga[0],ga[1],x0),cm(o.eye,ga[1],ga[2],C0),cm(o.eye,ga[2],ga[3],S0),cm(o.eye,ga[3],ga[0],T0);let y=Number.MAX_VALUE,v=0;const C=q1(this.parameters,u)?p.length-2:p.length-5;for(let b=0;b<C;b+=3){fr[0]=p[b]+t[12],fr[1]=p[b+1]+t[13],fr[2]=p[b+2]+t[14];const S=(b+3)%p.length;if(gr[0]=p[S]+t[12],gr[1]=p[S+1]+t[13],gr[2]=p[S+2]+t[14],cs(x0,fr)<0&&cs(x0,gr)<0||cs(C0,fr)<0&&cs(C0,gr)<0||cs(S0,fr)<0&&cs(S0,gr)<0||cs(T0,fr)<0&&cs(T0,gr)<0)continue;const x=o.projectToRenderScreen(fr,Cq),T=o.projectToRenderScreen(gr,Sq);if(x==null||T==null)continue;if(x[2]<0&&T[2]>0){de(In,fr,gr);const R=o.frustum,O=-cs(R[4],fr)/$e(In,un(R[4]));if(te(In,In,O),ce(fr,fr,In),!o.projectToRenderScreen(fr,x))continue}else if(x[2]>0&&T[2]<0){de(In,gr,fr);const R=o.frustum,O=-cs(R[4],gr)/$e(In,un(R[4]));if(te(In,In,O),ce(gr,gr,In),!o.projectToRenderScreen(gr,T))continue}else if(x[2]<0&&T[2]<0)continue;x[2]=0,T[2]=0;const P=$L(yy(x,T,oS),f);P<y&&(y=P,q(nS,fr),q(aS,gr),v=b/3)}if(y<g*g){let b=Number.MAX_VALUE;if(WL(yy(nS,aS,oS),yy(l,c,Tq),cl)){de(cl,cl,l);const S=ge(cl);te(cl,cl,1/S),b=S/Gt(l,c)}n(b,cl,v)}}get hasEmissions(){return this.parameters.emissiveStrength>0}createBufferWriter(){return new bq(PO(this.parameters),this.parameters)}createGLMaterial(e){return new yq(e)}validateParameters(e){e.join!=="miter"&&(e.miterLimit=0),e.markerParameters!=null&&(e.markerScale=e.markerParameters.width/e.width)}update(e){const{hasAnimation:t}=this.parameters;return!!t&&(this.setParameters({timeElapsed:y2(e.time)},!1),e.dt!==0)}},yq=class extends ZP{constructor(){super(...arguments),this._stipplePattern=null}dispose(){super.dispose(),this._stippleTextures?.release(this._stipplePattern),this._stipplePattern=null}beginSlot(e){const t=this._material.parameters.stipplePattern;return this._stipplePattern!==t&&(this._material.setParameters({stippleTexture:this._stippleTextures.swap(t,this._stipplePattern)}),this._stipplePattern=t),this.getTechnique(gq,e)}},vq=class extends qA{constructor(){super(...arguments),this.width=0,this.color=hM,this.join="miter",this.cap=0,this.miterLimit=5,this.writeDepth=!0,this.hasPolygonOffset=!1,this.stippleTexture=null,this.stipplePreferContinuous=!0,this.markerParameters=null,this.markerScale=1,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.isClosed=!1,this.falloff=0,this.innerWidth=0,this.wireframe=!1,this.timeElapsed=0,this.animation=0,this.animationSpeed=1,this.trailLength=1,this.startTime=0,this.endTime=1/0,this.fadeInTime=0,this.fadeOutTime=1/0,this.emissiveStrength=0}get transparent(){return this.color[3]<1||this.hasAnimation||this.stipplePattern!=null&&(this.stippleOffColor?.[3]??0)<1}get hasAnimation(){return this.animation!==0}},bq=class{constructor(e,t){this.layout=e,this._parameters=t;const i=t.stipplePattern?1:0;switch(this._parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=i;break;case"round":this.numJoinSubdivisions=Ap+i}}_isClosed(e){return q1(this._parameters,e)}allocate(e){return this.layout.createBuffer(e)}elementCount(e){const t=e.get("position").indices.length/2+1,i=this._isClosed(e);let r=i?2:4;return r+=((i?t:t-1)-(i?0:1))*(2*this.numJoinSubdivisions+4),r+=2,this._parameters.wireframe&&(r=2+4*(r-2)),r}write(e,t,i,r,s,n){const a=this.layout,o=i.get("position"),l=o.indices,c=o.data.length/3,u=i.get("distanceToStart")?.data;l&&l.length!==2*(c-1)&&console.warn("RibbonLineMaterial does not support indices");const p=a.fields.has("sizeFeatureAttribute");let m=1,f=null;if(p){const se=i.get("sizeFeatureAttribute");se.data.length===1?m=se.data[0]:f=se.data}else m=i.get("size")?.data[0]??1;let g=[1,1,1,1],y=0,v=null;const C=a.fields.has("colorFeatureAttribute");if(C){const se=i.get("colorFeatureAttribute");se.data.length===1?y=se.data[0]:v=se.data}else g=i.get("color")?.data??g;const b=i.get("timeStamps")?.data,S=b&&a.fields.has("timeStamps"),x=a.fields.has("opacityFeatureAttribute");let T=0,P=null;if(x){const se=i.get("opacityFeatureAttribute");se.data.length===1?T=se.data[0]:P=se.data}const R=new Float32Array(s.buffer),O=vM(s.buffer),E=new Uint8Array(s.buffer),A=a.stride/4;let F=n*A;const L=F;let H=0;const V=u?(se,Re,Pe)=>H=u[Pe]:(se,Re,Pe)=>H+=Gt(se,Re),I=R.BYTES_PER_ELEMENT/O.BYTES_PER_ELEMENT,B=4/I,ee=Io(),G=(se,Re,Pe,Ae,Dt,Bt,Fe,et)=>{R[F++]=Re[0],R[F++]=Re[1],R[F++]=Re[2],Nw(se,Re,O,F*I),F+=B,Nw(Pe,Re,O,F*I),F+=B,R[F++]=et;let je=F*I;if(O[je++]=Dt,O[je++]=Bt,F=Math.ceil(je/I),C)R[F]=v?.[Fe]??y;else{const we=Math.min(4*Fe,g.length-4),Ke=4*F;E[Ke]=255*g[we],E[Ke+1]=255*g[we+1],E[Ke+2]=255*g[we+2],E[Ke+3]=255*g[we+3]}if(F++,R[F++]=f?.[Fe]??m,x&&(R[F++]=P?.[Fe]??T),ee){let we=4*F;r?(E[we++]=r[0],E[we++]=r[1],E[we++]=r[2],E[we++]=r[3]):(E[we++]=0,E[we++]=0,E[we++]=0,E[we++]=0),F=Math.ceil(.25*we)}S&&(je=F*I,O[je++]=Ae[0],O[je++]=Ae[1],O[je++]=Ae[2],O[je++]=Ae[3],F=Math.ceil(je/I))};F+=A,xe(Ut,o.data[0],o.data[1],o.data[2]),S&&cr(_r,b[0],b[1],b[2],b[3]),e&&lt(Ut,Ut,e);const be=this._isClosed(i);if(be){const se=o.data.length-3;xe(ki,o.data[se],o.data[se+1],o.data[se+2]),e&&lt(ki,ki,e)}else xe(fi,o.data[3],o.data[4],o.data[5]),e&&lt(fi,fi,e),G(Ut,Ut,fi,_r,1,-4,0,0),G(Ut,Ut,fi,_r,1,4,0,0),q(ki,Ut),q(Ut,fi),S&&cr(_r,b[4],b[5],b[6],b[7]);const ae=be?0:1,Xe=be?c:c-1;for(let se=ae;se<Xe;se++){const Re=(se+1)%c*3;xe(fi,o.data[Re],o.data[Re+1],o.data[Re+2]),e&&lt(fi,fi,e),V(ki,Ut,se),G(ki,Ut,fi,_r,0,-1,se,H),G(ki,Ut,fi,_r,0,1,se,H);const Pe=this.numJoinSubdivisions;for(let Ae=0;Ae<Pe;++Ae){const Dt=(Ae+1)/(Pe+1);G(ki,Ut,fi,_r,Dt,-1,se,H),G(ki,Ut,fi,_r,Dt,1,se,H)}if(G(ki,Ut,fi,_r,1,-2,se,H),G(ki,Ut,fi,_r,1,2,se,H),q(ki,Ut),q(Ut,fi),S){const Ae=(se+1)%c*4;cr(_r,b[Ae],b[Ae+1],b[Ae+2],b[Ae+3])}}return be?(xe(fi,o.data[3],o.data[4],o.data[5]),e&&lt(fi,fi,e),H=V(ki,Ut,Xe),G(ki,Ut,fi,_r,0,-1,ae,H),G(ki,Ut,fi,_r,0,1,ae,H)):(H=V(ki,Ut,Xe),G(ki,Ut,Ut,_r,0,-5,Xe,H),G(ki,Ut,Ut,_r,0,5,Xe,H)),w0(R,L+A,R,L,A),F=w0(R,F-A,R,F,A),this._parameters.wireframe&&this._addWireframeVertices(s,L,F,A),null}_addWireframeVertices(e,t,i,r){const s=new Float32Array(e.buffer,i*Float32Array.BYTES_PER_ELEMENT),n=new Float32Array(e.buffer,t*Float32Array.BYTES_PER_ELEMENT,i-t);let a=0;const o=l=>a=w0(n,l,s,a,r);for(let l=0;l<n.length-1;l+=2*r)o(l),o(l+2*r),o(l+1*r),o(l+2*r),o(l+1*r),o(l+3*r)}};function w0(e,t,i,r,s){for(let n=0;n<s;n++)i[r++]=e[t++];return r}function q1(e,t){return e.isClosed?t.get("position").indices.length>2:!1}function wq(e){return e.anchor===1&&e.hideOnShortSegments&&e.placement==="begin-end"&&e.worldSpace}const fr=w(),gr=w(),In=w(),cl=w(),xq=w(),Cq=Va(),Sq=Va(),nS=w(),aS=w(),oS=gM(),Tq=gM(),ki=w(),Ut=w(),fi=w(),_r=Vt(),Gu=[Va(),Va(),Va(),Va()],ga=[w(),w(),w(),w()],x0=Ga(),C0=Ga(),S0=Ga(),T0=Ga();let MO=class{constructor(e){this._originSR=e,this._rootOriginId="root/"+uu(),this._origins=new Map,this._objects=new Map,this._gridSize=5e5}getOrigin(e){const t=this._origins.get(this._rootOriginId);if(t==null){const c=__(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,c),c}const i=this._gridSize,r=Math.round(e[0]/i),s=Math.round(e[1]/i),n=Math.round(e[2]/i),a=`${r}/${s}/${n}`;let o=this._origins.get(a);const l=.5*i;if(de(Di,e,t.vec3),Di[0]=Math.abs(Di[0]),Di[1]=Math.abs(Di[1]),Di[2]=Math.abs(Di[2]),Di[0]<l&&Di[1]<l&&Di[2]<l){if(o){const c=Math.max(...Di);if(de(Di,e,o.vec3),Di[0]=Math.abs(Di[0]),Di[1]=Math.abs(Di[1]),Di[2]=Math.abs(Di[2]),Math.max(...Di)<c)return o}return t}return o||(o=__(r*i,s*i,n*i,a),this._origins.set(a,o)),o}_drawOriginBox(e,t=Mi(1,1,0,1)){const i=window.view,r=i.stage,s=t.toString();if(!this._objects.has(s)){this._material=new _q({width:2,color:t},!1);const m=new XD(r,{pickable:!1}),f=new jD({castShadow:!1});m.add(f),this._objects.set(s,f)}const n=this._objects.get(s),a=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],o=a.length,l=new Array(3*o),c=new Array,u=.5*this._gridSize;for(let m=0;m<o;m++)l[3*m]=e[0]+(1&a[m]?u:-u),l[3*m+1]=e[1]+(2&a[m]?u:-u),l[3*m+2]=e[2]+(4&a[m]?u:-u),m>0&&c.push(m-1,m);oa(l,this._originSR,0,l,i.renderSpatialReference,0,o);const p=new HP(this._material,[["position",new Of(l,c,3,!0)]],null,2);n.addGeometry(p)}get test(){}};const Di=w();function Pq(e){return e!=null&&!e.readyToRun}let Mq=class{constructor(){this.startTime=0,this._data=ar(null),this.coverage=0,this.absorption=0,this._readChannels=0,this.parallax=new lS,this.parallaxNew=new lS,this._anchorPoint=w(),this._fadeState=ar(0),this._fadeFactor=ar(1)}get data(){return this._data.value}set data(e){this._data.value=e}get readChannels(){return this._readChannels}get fadeState(){return this._fadeState.value}get fadeFactor(){return this._fadeFactor.value}get opacity(){switch(this.fadeState){case 0:return 0;case 4:return 1-this.fadeFactor;case 1:return this.fadeFactor;case 2:case 3:return 1}}fade(e,t,i){this.isFading&&this.fadeFactor<1&&(this._fadeFactor.value=i?j((t-this.startTime)/(Dq*i),0,1):1,this.fadeFactor===1&&this._endFade()),this._evaluateState(e,t),this._updateParallax(e)}_evaluateState(e,t){const i=e.relativeElevation,r=this._updateAnchorPoint(e);(i>1.7*Nl||i<-Nl||r>hS)&&this.opacity>0?this._startFade(0,t):this.isFading||(i>Nl||i<-.35*Nl||r>Oq*hS?this.opacity>0&&this._startFade(4,t):Pq(this.data)&&(this.opacity===0?this._startFade(1,t):this.data.state===2&&(this.fadeState===2?this._startFade(3,t):this._startFade(2,t))))}_updateParallax(e){const t=Wr(e.eye);this.parallax.radiusCurvatureCorrection=.84*Math.sqrt(Math.max(t-Li.radius*Li.radius,0))/Math.sqrt(t),bx(cS,this.parallax.anchorPoint,zc),yn(this.parallax.transform,vn,zc[3],wx(zc)),bx(cS,this.parallaxNew.anchorPoint,zc),yn(this.parallaxNew.transform,vn,zc[3],wx(zc))}_updateAnchorPoint(e){return me(this._anchorPoint,e.eye),te(this._anchorPoint,this._anchorPoint,Li.radius),this.fadeState===0&&this.data?.state===2?(q(this.parallax.anchorPoint,this._anchorPoint),0):ge(de(Rq,this.parallax.anchorPoint,this._anchorPoint))}requestFade(){this._fadeFactor.value=0}_startFade(e,t){switch(this._fadeState.value=e,this.startTime=t,e){case 3:this.requestFade(),this._switchReadChannels(),q(this.parallaxNew.anchorPoint,this._anchorPoint);break;case 1:this.requestFade(),this._switchReadChannels(),q(this.parallax.anchorPoint,this._anchorPoint),q(this.parallaxNew.anchorPoint,this._anchorPoint);break;case 4:this.requestFade();break;case 2:this._switchReadChannels(),q(this.parallax.anchorPoint,this._anchorPoint),q(this.parallaxNew.anchorPoint,this._anchorPoint),this._endFade();break;case 0:this._endFade()}}_endFade(){switch(this._fadeFactor.value=1,this.data&&this.data.state!==2&&(this.data.state=0),this.fadeState){case 3:q(this.parallax.anchorPoint,this.parallaxNew.anchorPoint),this._fadeState.value=2;break;case 1:this._fadeState.value=2;break;case 4:this._fadeState.value=0;break;case 2:case 0:break;default:na(this.fadeState)}}_switchReadChannels(){this.data?.state===2&&(this._readChannels=1-this._readChannels,this.data.state=3)}get isFading(){return this.fadeState===4||this.fadeState===1||this.fadeState===3}},lS=class{constructor(){this.anchorPoint=w(),this.radiusCurvatureCorrection=0,this.transform=Le()}};const cS=We(0,0,1),zc=VF(),Rq=w(),Dq=1.25,Oq=.5,hS=2e5;let Eq=class{constructor(e,t){this.width=e,this.height=t}},Gb=class{constructor(e){this.shadowMap=e,this.slot=2,this.slicePlane=null,this.hasOccludees=!1,this.enableFillLights=!0,this.oitPass=0,this.alignPixelEnabled=!1,this.decorations=!0,this.overlayStretch=1,this.viewshedEnabled=!1,this.cutFillEnabled=!1,this._camera=new vt,this._inverseViewport=ze(),this._oldLighting=new uy,this._newLighting=new uy,this._fadedLighting=new uy,this._lighting=this._newLighting,this.ssr=new Aq,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.highlights=new Array,this.highlightOrderMap=new Map,this.highlightMixOrigin=ze(),this.highlightMixTexture=null,this.hudRenderStyle=0,this.hudOccludedFragmentOpacity=1,this.snowCover=0,this.clouds=new Mq,this.shadowHighlightsVisible=!1}destroy(){this._camera=null,this.contentCamera=null,this.depth=null,this.geometryDepth=null,this.mainDepth=null,this.overlay=null,this.ssao=null,this.terrainDepth=null}get camera(){return this._camera}set camera(e){this._camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}fadeLighting(){switch(this.clouds.fadeFactor){case 0:this._lighting=this._oldLighting;break;default:this._fadedLighting.lerpLighting(this._oldLighting,this._newLighting,this.clouds.fadeFactor),this._lighting=this._fadedLighting;break;case 1:this._lighting=this._newLighting,this._oldLighting.copyFrom(this._newLighting)}}updateLighting(e,t,i,r){this._oldLighting.copyFrom(this.lighting),this._newLighting.noonFactor=t,this._newLighting.globalFactor=i,this._newLighting.set(e),this._oldLighting.updateLegacy(),r===1&&this.clouds.requestFade(),this.fadeLighting()}get highlight(){return this.highlightLevel==null?null:this.highlights[this.highlightLevel]}},Aq=class{constructor(){this.fadeFactor=1,this.reprojectionMatrix=Le()}},RO=class{constructor(e,t,i){this.rctx=e,this.techniques=i,this.lastFrameCamera=new vt,this.output=0,this.renderOccludedMask=Ip,this.time=Oe(0),this.bind=new Gb(t),this.bind.alignPixelEnabled=!0}};const Ip=13;let Pd=class extends vt{constructor(){super(...arguments),this._projectionMatrix=Le()}get projectionMatrix(){return this._projectionMatrix}};h([d()],Pd.prototype,"_projectionMatrix",void 0),h([d({readOnly:!0})],Pd.prototype,"projectionMatrix",null),Pd=h([D("esri.views.3d.webgl-engine.lib.CascadeCamera")],Pd);let Jm=class{constructor(){this.camera=new Pd,this.lightMat=Le()}},Iq=class{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}},$b=class{constructor(e,t){this._fbos=e,this._viewingMode=t,this._snapshots=new Array,this._textureHeight=0,this._numCascades=1,this.settings=new Iq,this._projectionView=Le(),this._projectionViewInverse=Le(),this._modelViewLight=Le(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=Vt(),this._cascades=[new Jm,new Jm,new Jm,new Jm],this._lastOrigin=null,this._enabled=!1,this._maxTextureWidth=Math.min(Qe("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}get depthTexture(){return this._handle?.getTexture(qi)}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return cr(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}disposeMainBuffer(){this._handle=Ht(this._handle)}disposeOffscreenBuffers(){this.disposeMainBuffer(),this._discardSnapshots()}set maxCascades(e){this.settings.maxNumCascadesHighQuality=j(Math.floor(e),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(e){this._enabled=e,e||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&this.depthTexture!=null}get cascades(){for(let e=0;e<this._numCascades;++e)ng[e]=this._cascades[e];return ng.length=this._numCascades,ng}start(e,t,i,r,s){Qt(this.enabled);const{near:n,far:a}=Nq(i);this._computeCascadeDistances(n,a,r),this._textureHeight=this._computeTextureHeight(e,s,r),this._setupMatrices(e,t);const{viewMatrix:o,projectionMatrix:l}=e;for(let c=0;c<this._numCascades;++c)this._constructCascade(c,l,o,t);this._lastOrigin=null,this.clear()}finish(){Qt(this.enabled)}getShadowMapMatrices(e){if(!this._lastOrigin||!Go(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||w(),q(this._lastOrigin,e);for(let t=0;t<this._numCascades;++t){ac(gS,this._cascades[t].lightMat,e);for(let i=0;i<16;++i)_S[16*t+i]=gS[i]}}return _S}moveSnapshot(e){Qt(this.enabled),this._snapshots[e]?.release(),this._snapshots[e]=this._handle,this._handle?.setName(e===0?"shadow map highlight":"shadow map excluding highlight"),this._handle=null}copySnapshot(e){if(!this.enabled||!this._handle?.getTexture(qi)?.descriptor)return;this._snapshots[e]?.release();const t=e===0?"shadow map highlight":"shadow map excluding highlight",i=this._acquireFBO(t);this._snapshots[e]=i;const r=this._handle?.fbo;if(!r||!i?.fbo)return void console.error("No FBO");const{rctx:s}=this._fbos;s.blitFramebuffer(r,i.fbo,256)}getSnapshot(e){return this.enabled?this._snapshots[e]?.getTexture(qi):null}clear(){this._ensureFbo(),this.bindFbo(),this._fbos.rctx.clear(256)}_computeTextureHeight({pixelRatio:e,fullWidth:t,fullHeight:i},r,s){const n=Math.min(window.devicePixelRatio,r)/e,a=s?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality;return Wh(Math.max(t,i)*n*a,this._maxTextureWidth/this._numCascades)}_ensureFbo(){this._handle?.fbo?.width===this._textureWidth&&this._handle?.fbo.height===this._textureHeight||(this._handle?.release(),this._handle=this._acquireFBO("shadow map"))}_acquireFBO(e){const t=this._fbos.acquire(this._textureWidth,this._textureHeight,e,12);return t.getTexture(qi)?.setShadowFiltering(!0),t}_discardSnapshot(e){this._snapshots[e]=Ht(this._snapshots[e])}_discardSnapshots(){for(let e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0}bindFbo(){this._fbos.rctx.bindFramebuffer(this._handle?.fbo)}_constructCascade(e,t,i,r){const s=this._cascades[e],n=-this._cascadeDistances[e],a=-this._cascadeDistances[e+1],o=(t[10]*n+t[14])/Math.abs(t[11]*n+t[15]),l=(t[10]*a+t[14])/Math.abs(t[11]*a+t[15]);Qt(o<l);for(let m=0;m<8;++m){cr(uS,m%4==0||m%4==3?-1:1,m%4==0||m%4==1?-1:1,m<4?o:l,1);const f=Os[m];Bg(f,uS,this._projectionViewInverse),f[0]/=f[3],f[1]/=f[3],f[2]/=f[3]}za(P0,Os[0]),s.camera.viewMatrix=ac(Lq,this._modelViewLight,P0);for(let m=0;m<8;++m)lt(Os[m],Os[m],s.camera.viewMatrix);let c=Os[0][2],u=Os[0][2];for(let m=1;m<8;++m)c=Math.min(c,Os[m][2]),u=Math.max(u,Os[m][2]);c-=200,u+=200,s.camera.near=-u,s.camera.far=-c,Bq(i,r,c,u,s.camera),lr(s.lightMat,s.camera.projectionMatrix,s.camera.viewMatrix);const p=this._textureHeight;s.camera.viewport=[e*p,0,p,p]}_setupMatrices(e,t){lr(this._projectionView,e.projectionMatrix,e.viewMatrix),tu(this._projectionViewInverse,this._projectionView);const i=this._viewingMode===1?e.eye:xe(P0,0,0,1);tM(this._modelViewLight,[0,0,0],[-t[0],-t[1],-t[2]],i)}_computeCascadeDistances(e,t,i){const r=i?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor(yF(t/e,4)),r);const s=(t-e)/this._numCascades,n=(t/e)**(1/this._numCascades);let a=e,o=e;for(let l=0;l<this._numCascades+1;++l)this._cascadeDistances[l]=De(a,o,this.settings.splitSchemeLambda),a*=n,o+=s}get test(){}};const Lq=Le(),uS=Vt(),Os=[];for(let e=0;e<8;++e)Os.push(Vt());const dS=ze(),pS=ze(),Fq=ze(),mS=ze(),fS=ze(),P0=w(),ng=[];function Vq(){ng.length=0}const gS=Le(),_S=vn.concat(vn,vn,vn),ss=ze(),kc=ze(),hl=[ze(),ze(),ze(),ze()],gi=ze(),M0=ze(),ho=ze(),$u=ze(),Bc=ze(),Nc=ze(),ef=ze();function zq(e,t,i,r,s,n,a,o){Ki(ss,0,0);for(let T=0;T<4;++T)Ko(ss,ss,e[T]);Ol(ss,ss,.25),Ki(kc,0,0);for(let T=4;T<8;++T)Ko(kc,kc,e[T]);Ol(kc,kc,.25),dn(hl[0],e[4],e[5],.5),dn(hl[1],e[5],e[6],.5),dn(hl[2],e[6],e[7],.5),dn(hl[3],e[7],e[4],.5);let l=0,c=hx(hl[0],ss);for(let T=1;T<4;++T){const P=hx(hl[T],ss);P<c&&(c=P,l=T)}El(gi,hl[l],e[l+4]);const u=gi[0];let p,m;gi[0]=-gi[1],gi[1]=u,El(M0,kc,ss),Xi(M0,gi)<0&&XI(gi,gi),dn(gi,gi,M0,i),ux(gi,gi),p=m=Xi(El(ho,e[0],ss),gi);for(let T=1;T<8;++T){const P=Xi(El(ho,e[T],ss),gi);P<p?p=P:P>m&&(m=P)}fs(r,ss),Ol(ho,gi,p-t),Ko(r,r,ho);let f=-1,g=1,y=0,v=0;for(let T=0;T<8;++T){El($u,e[T],r),ux($u,$u);const P=gi[0]*$u[1]-gi[1]*$u[0];P>0?P>f&&(f=P,y=T):P<g&&(g=P,v=T)}Tc(f>0,"leftArea"),Tc(g<0,"rightArea"),Ol(Bc,gi,p),Ko(Bc,Bc,ss),Ol(Nc,gi,m),Ko(Nc,Nc,ss),ef[0]=-gi[1],ef[1]=gi[0];const C=dm(r,e[v],Nc,Ko(ho,Nc,ef),1,s),b=dm(r,e[y],Nc,ho,1,n),S=dm(r,e[y],Bc,Ko(ho,Bc,ef),1,a),x=dm(r,e[v],Bc,ho,1,o);Tc(C,"rayRay"),Tc(b,"rayRay"),Tc(S,"rayRay"),Tc(x,"rayRay")}function He(e,t){return 3*t+e}const yS=ze();function Br(e,t){return Ki(yS,e[t],e[t+3]),yS}const yr=ze(),re=Rn();function kq(e,t,i,r,s){El(yr,i,r),Ol(yr,yr,.5),re[0]=yr[0],re[1]=yr[1],re[2]=0,re[3]=yr[1],re[4]=-yr[0],re[5]=0,re[6]=yr[0]*yr[0]+yr[1]*yr[1],re[7]=yr[0]*yr[1]-yr[1]*yr[0],re[8]=1,re[He(0,2)]=-Xi(Br(re,0),e),re[He(1,2)]=-Xi(Br(re,1),e);let n=Xi(Br(re,0),i)+re[He(0,2)],a=Xi(Br(re,1),i)+re[He(1,2)],o=Xi(Br(re,0),r)+re[He(0,2)],l=Xi(Br(re,1),r)+re[He(1,2)];n=-(n+o)/(a+l),re[He(0,0)]+=re[He(1,0)]*n,re[He(0,1)]+=re[He(1,1)]*n,re[He(0,2)]+=re[He(1,2)]*n,n=1/(Xi(Br(re,0),i)+re[He(0,2)]),a=1/(Xi(Br(re,1),i)+re[He(1,2)]),re[He(0,0)]*=n,re[He(0,1)]*=n,re[He(0,2)]*=n,re[He(1,0)]*=a,re[He(1,1)]*=a,re[He(1,2)]*=a,re[He(2,0)]=re[He(1,0)],re[He(2,1)]=re[He(1,1)],re[He(2,2)]=re[He(1,2)],re[He(1,2)]+=1,n=Xi(Br(re,1),t)+re[He(1,2)],a=Xi(Br(re,2),t)+re[He(2,2)],o=Xi(Br(re,1),i)+re[He(1,2)],l=Xi(Br(re,2),i)+re[He(2,2)],n=-.5*(n/a+o/l),re[He(1,0)]+=re[He(2,0)]*n,re[He(1,1)]+=re[He(2,1)]*n,re[He(1,2)]+=re[He(2,2)]*n,n=Xi(Br(re,1),t)+re[He(1,2)],a=Xi(Br(re,2),t)+re[He(2,2)],o=-a/n,re[He(1,0)]*=o,re[He(1,1)]*=o,re[He(1,2)]*=o,s[0]=re[0],s[1]=re[1],s[2]=0,s[3]=re[2],s[4]=re[3],s[5]=re[4],s[6]=0,s[7]=re[5],s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=re[6],s[13]=re[7],s[14]=0,s[15]=re[8]}function Bq(e,t,i,r,s){const n=1/Os[0][3],a=1/Os[4][3];Qt(n<a);let o=n+Math.sqrt(n*a);const l=Math.sin(qa(e[2]*t[0]+e[6]*t[1]+e[10]*t[2]));o/=l,zq(Os,o,l,dS,pS,Fq,mS,fS),kq(dS,pS,mS,fS,s.projectionMatrix),s.projectionMatrix[10]=2/(i-r),s.projectionMatrix[14]=-(i+r)/(i-r)}function Nq(e){let{near:t,far:i}=e;return t<2&&(t=2),i<2&&(i=2),t>=i&&(t=2,i=4),{near:t,far:i}}let vS=class extends ct{constructor(e,t){super(e,t,new ht(jH,()=>k(()=>Promise.resolve().then(()=>iee),void 0)),ai)}initializePipeline(e){return e.hasAlpha?Ge({blending:ja,colorWrite:st}):Ge({colorWrite:st})}},DO=class extends hr{constructor(){super(...arguments),this.hasAlpha=!1}};h([z()],DO.prototype,"hasAlpha",void 0);let Wb=class extends Kt{constructor(){super(...arguments),this.overlayIndex=0,this.opacity=1}};function OO(){const e=new ut;return e.include($i),e.fragment.uniforms.add(new Ne("tex",t=>t.texture)),e.fragment.uniforms.add(new hc("overlayIdx",t=>t.overlayIndex)),e.fragment.uniforms.add(new _e("opacity",t=>t.opacity)),e.fragment.main.add(_`vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);
fragColor = texture(tex, overlayUV) * opacity;`),e}const jq=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:Wb,build:OO},Symbol.toStringTag,{value:"Module"}));let bS=class extends ct{constructor(e,t){super(e,t,new ht(jq,()=>k(()=>Promise.resolve().then(()=>ree),void 0)),ai)}},qn=class extends Zp{constructor(e){super(e),this._overlays=null,this._renderTargets=null,this._overlayParameters=new Wb,this.hasHighlights=!1,this.renderOccludedFlags=1,this._hasWater=!1,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new jt,this._passParameters=new Bb,this._screenToWorldRatio=1,this._localOriginFactory=null,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._camera=new vt,this.events=new uc,this.longitudeCyclical=null,this.produces=new Map([[18,t=>t!==9||this.hasHighlights],[19,()=>this._hasWater]]),this._hasTargetWithoutRasterImage=!1,this._hasDrapedFeatureSource=!1,this._hasDrapedRasterSource=!1,this._hasDrapedFlowSource=!1}initialize(){const e=this._view,t=e.stage,i=t.renderer.fboCache,{waterTextures:r,techniques:s}=t.renderView;this._renderContext=new RO(this._rctx,new $b(i,e.state.viewingMode),s),this.addHandles([M(()=>r.updating,()=>this.events.emit("content-changed"),Ve),M(()=>this._spatialReference,o=>this._localOriginFactory=new MO(o),Ve),Ir(()=>e.allLayerViews,"after-changes",()=>this._sortedDrapeSourceRenderersDirty=!0),M(()=>XH(e.state.highlights),()=>this._sortedDrapeSourceRenderersDirty=!0,Ee),M(()=>e.state.highlights,o=>{this._bindParameters.highlights=o,this._bindParameters.highlightOrderMap=e.state.highlightOrderMap},Ee),e.resourceController.scheduler.registerTask(mi.OVERLAY_RENDERER,this)]);const{_bindParameters:n,_camera:a}=this;a.near=1,a.far=1e4,a.relativeElevation=null,n.slot=18,n.mainDepth=null,n.camera=a,n.oitPass=0,n.updateLighting([new QP(v9())],0,0,0)}destroy(){this._renderers.forEach(e=>e.destroy()),this._renderers.clear(),this._passParameters.texture=ye(this._passParameters.texture),this.disposeOverlays(),this._renderContext=null,this._sortedRenderers.prune()}get _bindParameters(){return this._renderContext.bind}get _rctx(){return this._stage.renderView.renderingContext}get _view(){return this.parent.view}get _stage(){return this.parent.view.stage}get _spatialReference(){return this.parent.spatialReference}get _techniques(){return this._stage.renderView.techniques}get rctx(){return this._rctx}get materials(){return this._pluginContext.materials}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}get pluginContext(){return this._pluginContext}initializeRenderContext(e){const t=new yO(this._view.stage.renderView.textures,this._techniques,()=>{this._onMaterialOrContentChanged(),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")},()=>this.events.emit("content-changed"));this._pluginContext={...e,materials:t},this._techniques.precompile(bS)}uninitializeRenderContext(){}acquireTechniques(){return[]}render(){}get updating(){return this._sortedDrapeSourceRenderersDirty||fn(this._renderers,e=>e.updating||e.canCompact)}get hasOverlays(){return this._overlays!=null&&this._renderTargets!=null}getMaterialRenderer(e){for(const t of this._renderers.values()){const i=t.getMaterialRenderer(e);if(i)return i}return null}get layers(){return this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers(),SA(this._sortedRenderers.map(e=>e.drapeSource.layer).filter(e=>!!e))}registerDrapeSource(e,t){this._renderers.get(e)?.destroy(),this._renderers.set(e,t),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in e&&this.addHandles(M(()=>e.fullOpacity,()=>this.events.emit("content-changed")),e)}removeDrapeSourceRenderer(e){if(e==null)return;const t=this._renderers.get(e);t!=null&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(e),this.removeHandles(e),t.destroy())}computeValidity(){return this._renderTargets?.computeValidity()??0}releaseRenderTargets(e){this._renderTargets?.dispose(e)}get overlays(){return this._overlays??[]}ensureDrapeTargets(e){this._hasTargetWithoutRasterImage=!!this._overlays&&sm(e,t=>t.drapeTargetType===1)}ensureDrapeSources(e){this._overlays?(this._hasDrapedFeatureSource=sm(e,t=>t.drapeSourceType===1),this._hasDrapedRasterSource=sm(e,t=>t.drapeSourceType===0),this._hasDrapedFlowSource=sm(e,t=>t.drapeSourceType===2)):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=this._hasDrapedFlowSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(e,t,i=this._bindParameters.overlayStretch){this._overlays==null&&(this._renderTargets=new NH(this._stage.renderer.fboCache),this._overlays=[new X3,new X3]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t),this._bindParameters.overlayStretch=i}disposeOverlays(){this._overlays=null,this._renderTargets?.dispose(1),this._renderTargets=null,this.events.emit("textures-disposed")}_useOverlayColorInsteadOfColorNoRasterImage(e){return e===1&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource}getTexture(e){const t=this._useOverlayColorInsteadOfColorNoRasterImage(e);return this._renderTargets?.getTexture(t?0:e)}get readyToRun(){return this.updating}runTask(e){this._processDrapeSources(e,()=>!0)}_onMaterialOrContentChanged(){this.renderOccludedFlags=fn(this._renderers,e=>e.hasOccluders)?tp:1}_processDrapeSources(e,t){let i=!1;for(const[r,s]of this._renderers){if(e.done)break;(r.destroyed||t(r))&&s.commitChanges()&&(i=!0,e.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,i=!0,this._updateSortedDrapeSourceRenderers(),e.madeProgress()),this.compact(e),i&&(this._overlays!=null&&this._renderers.size===0&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this._onMaterialOrContentChanged(),this.hasHighlights=fn(this._renderers,r=>r.hasHighlights),this.events.emit("content-changed"))}compact(e){let t=!1;for(const i of this._renderers.values()){if(e.done)break;t=i.compact(e)||t}return t&&this.notifyChange("updating"),t}hasHighlight(e){return fn(this._renderers,t=>t.hasHighlight(e))}processSyncDrapeSources(){this._processDrapeSources(bn,e=>e.updatePolicy===1)}get isEmpty(){return!bi.OVERLAY_DRAW_DEBUG_TEXTURE&&wv(this._renderers,e=>e.isEmpty)}get hasWater(){const e=fn(this._renderers,({hasWater:t})=>t);return e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water")),this._hasWater}renders(e){if(bi.OVERLAY_DRAW_DEBUG_TEXTURE&&e!==4&&e!==2)return!0;if(!this._overlays)return!1;const t=this._overlays[0];for(const s of this._overlays)s.setupGeometryViews(this.longitudeCyclical);if(!t.hasSomeSizedView())return!1;const i=this._renderContext.output;this._renderContext.output=this._renderTargets?.targets.find(s=>s.content===e)?.output??0,++this._techniques.precompiling;const r=this._sortedRenderers.some(({renderer:s})=>s.precompile(this._renderContext));return--this._techniques.precompiling,this._renderContext.output=i,r}get mode(){return this.isEmpty?0:this.hasWater&&this.renders(3)?2:this._renderTargets?.getTexture(0)?1:0}updateAnimation(e){let t=!1;return this._renderers.forEach(i=>t=i.updateAnimation(e)||t),t&&this.parent.requestRender(0),t}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}precompileShaders(e){if(!this._overlays||!this._renderTargets)return!1;const t=this._bindParameters;t.alignPixelEnabled=e.alignPixelEnabled,++this._techniques.precompiling;for(const i of this._renderTargets.targets){if(i.content===1&&!this._needsColorWithoutRasterImage)continue;const{output:r}=i;this._renderContext.output=r,t.slot=r===3?19:18,r===9&&(t.highlightMixTexture=t.highlights.length>1?this._rctx.emptyTexture:null);const s=this._renderContext.renderOccludedMask;i.content===4&&(this._renderContext.renderOccludedMask=tp),this._sortedRenderers.forAll(({drapeSource:n,renderer:a})=>{i.content===1&&n.drapeSourceType===0||i.content===4&&a.hasOnlyOccluders||a.precompile(this._renderContext)}),this._renderContext.renderOccludedMask=s,t.highlightMixTexture=null}return--this._techniques.precompiling,!0}drawOverlays(e,t){if(!this._overlays||!this._renderTargets)return;for(const r of this._overlays)r.setupGeometryViews(this.longitudeCyclical);this._bindParameters.alignPixelEnabled=e.alignPixelEnabled;const i=this.allSourcesOccluders;for(const r of this._renderTargets.targets){if(!(r.content===0&&this._hasDrapedFlowSource)&&!r.handleRenderRequest(t)||r.content===1&&!this._needsColorWithoutRasterImage||r.content===4&&i)continue;const s=this._drawTarget(0,r),n=this._drawTarget(1,r);(s||n)&&r.fbo.generateMipMap()}}_drawTarget(e,t){const i=this._overlays[e],r=i.canvasGeometries;if(r.numViews===0)return!1;const s=this._view.state.contentPixelRatio;this._screenToWorldRatio=s*i.mapUnitsPerPixel/this._bindParameters.overlayStretch;const{output:n}=t;if(this.isEmpty||n===3&&!this.hasWater||!i.hasSomeSizedView())return!1;const{_rctx:a,_camera:o,_renderContext:l,_bindParameters:c}=this;if(o.pixelRatio=i.pixelRatio*s,l.output=n,c.screenToWorldRatio=this._screenToWorldRatio,c.screenToPCSRatio=this._screenToWorldRatio*this.parent.worldToPCSRatio,c.slot=n===3?19:18,t.content===4&&(l.renderOccludedMask=tp),!this.renders(t.content))return l.renderOccludedMask=Ip,!1;const{resolution:u}=i,p=e===0,m=p?0:u;if(a.setViewport(m,0,u,u),this._bindTargetFBO(t),p)if(t.output!==9)a.setClearColor(0,0,0,0),a.clear(16384);else{const{gl:f}=a;f.clearBufferuiv(f.COLOR,0,[0,0,0,0])}if(bi.OVERLAY_DRAW_DEBUG_TEXTURE&&t.content!==4&&t.content!==2){this._techniques.precompile(vS,G1);const f=this._techniques.get(vS,G1);for(let g=0;g<r.numViews;g++)this._setViewParameters(r.extents[g],i),this._ensureDebugPatternResources(i.resolution,Hq[e]),a.bindTechnique(f,c,this._passParameters),a.screen.draw()}if(t.output===9){const{fboCache:f}=this._stage.renderer,g=this._resolution;this._bindTargetFBO(t),_O(a,f,{width:g,height:g},c,()=>this._renderAllGeometry(e,t),m)}else this._renderAllGeometry(e,t);return a.bindFramebuffer(null),l.renderOccludedMask=Ip,!0}get allSourcesOccluders(){return wv(this._renderers,e=>e.hasOnlyOccluders)}_renderAllGeometry(e,t){const i=this._overlays[e],r=i.canvasGeometries;this._sortedRenderers.forAll(({drapeSource:s,renderer:n})=>{if(t.content===1&&s.drapeSourceType===0)return;const{fullOpacity:a}=s,o=a!=null&&a<1&&t.output===0&&this._bindTemporaryFBO();for(let l=0;l<r.numViews;l++)this._setViewParameters(r.extents[l],i),n.render(this._renderContext);if(o){this._bindTargetFBO(t),this._overlayParameters.texture=o.getTexture(),this._overlayParameters.opacity=a,this._overlayParameters.overlayIndex=e;const l=this._techniques.get(bS);this._rctx.bindTechnique(l,this._bindParameters,this._overlayParameters),this._rctx.screen.draw(),o.release()}})}_bindTargetFBO(e){const t=this._resolution,i=2*t;e.fbo.ensureFramebuffer(i,t),e.fbo.bind(this._rctx)}_bindTemporaryFBO(){const e=this._resolution,t=2*e,i=this._stage.renderer.fboCache,r=i.acquire(t,e,"overlay tmp");return i.rctx.bindFramebuffer(r.fbo),i.rctx.clear(16384),r}get _resolution(){return this._overlays?.[0].resolution??0}notifyContentChanged(){this.events.emit("content-changed")}intersect(e,t,i,r){this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers();let s=0;for(const{renderer:n}of this._sortedRenderers)s=n.intersect?.(e,t,i,r,s)??s}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),this._renderers.size===0)return;const e=this._view.map.allLayers.map(i=>i.uid),t=e.length;this._renderers.forEach((i,r)=>{const s=e.indexOf(r.layer?.uid),n=s>=0,a=r.renderGroup??(n?0:1),o=r.drapeSourcePriorityOffset??0,l=t*a+(n?s:0)+o;this._sortedRenderers.push(new Uq(r,i,l))}),this._sortedRenderers.sort((i,r)=>i.index-r.index)}_setViewParameters(e,t){const i=this._camera;i.viewport=[0,0,t.resolution,t.resolution],tL(i.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],i.near,i.far),eM(i.viewMatrix,[-e[0],-e[1],0])}_ensureDebugPatternResources(e,t){if(xe(this._passParameters.color,t[0],t[1],t[2]),this._passParameters.texture)return;const i=new Uint8Array(e*e*4);let r=0;for(let n=0;n<e;n++)for(let a=0;a<e;a++){const o=Math.floor(a/10),l=Math.floor(n/10);o<2||l<2||10*o>e-20||10*l>e-20?(i[r++]=255,i[r++]=255,i[r++]=255,i[r++]=255):(i[r++]=255,i[r++]=255,i[r++]=255,i[r++]=1&o&&1&l?1&a^1&n?0:255:1&o^1&l?0:128)}const s=new gt(e);s.samplingMode=9728,this._passParameters.texture=new bt(this._rctx,s,i)}get test(){}};h([d()],qn.prototype,"hasHighlights",void 0),h([d()],qn.prototype,"renderOccludedFlags",void 0),h([d()],qn.prototype,"_sortedDrapeSourceRenderersDirty",void 0),h([d({constructOnly:!0})],qn.prototype,"parent",void 0),h([d({readOnly:!0})],qn.prototype,"_techniques",null),h([d({type:Boolean,readOnly:!0})],qn.prototype,"updating",null),h([d()],qn.prototype,"isEmpty",null),qn=h([D("esri.views.3d.terrain.OverlayRenderer")],qn);let Uq=class{constructor(e,t,i){this.drapeSource=e,this.renderer=t,this.index=i}};const Hq=[[1,.5,.5],[.5,.5,1]],vse=-2,tp=4,G1=new DO;G1.hasAlpha=!0;let $1=class{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}clear(){this.adds.length=0,this.removes.length=0,this.updates.length=0}prune(){this.clear()}get empty(){return this.adds.length===0&&this.removes.length===0&&this.updates.length===0}},qq=class{},Gq=class{constructor(e){this.pending=e,this.adds=new Array,this.removes=new Array,this.updates=new Array}clearAddsAndRemoves(){this.adds.forEach(e=>zs(this.pending.adds,e)),this.removes.forEach(e=>zs(this.pending.removes,e)),this.adds.length=0,this.removes.length=0}clearUpdates(){this.updates.forEach(e=>zs(this.pending.updates,e)),this.updates.length=0}clear(){this.clearUpdates(),this.clearAddsAndRemoves()}};function $q(e){const t=new Map,i=r=>{let s=t.get(r);return s||(s=new Gq(e),t.set(r,s)),s};return e.removes.forEach(r=>{R0(r)&&i(r.material).removes.push(r)}),e.adds.forEach(r=>{R0(r)&&i(r.material).adds.push(r)}),e.updates.forEach(r=>{R0(r.renderGeometry)&&i(r.renderGeometry.material).updates.push(r)}),t}function R0(e){return e.geometry.indexCount>=1}let Zb=class{constructor(e=0,t=0){this.from=e,this.to=t}get numElements(){return this.to-this.from}};function wS(e){if(e.length<2)return;const t=new Map;e.forAll(r=>t.set(r.from,r));let i=!0;for(;i;){i=!1;for(let r=0;r<e.length;++r){const s=e.data[r],n=t.get(s.to);n&&(s.to=n.to,t.delete(n.from),e.removeUnordered(n),i=!0)}}}let xS=class extends Zb{constructor(e,t,i,r){super(t,i),this.geometry=e,this._highlightName=null,this.updateHighlightOptions(r)}updateHighlightOptions(e){const{geometry:t}=this;if(!t.hasHighlights)return void(this._highlightName=null);let i=-1,r=null;t.foreachHighlightOptions(s=>{const n=e.get(s)??-1;n>i&&(i=n,r=s)}),this._highlightName=r}get highlightName(){return this._highlightName}get isVisible(){return this.geometry.visible}get hasHighlights(){return this.isVisible&&this.geometry.hasHighlights}get hasOccludees(){return this.geometry.occludees!=null}},Wq=class{constructor(e){this.baseInstanceData=e,this.dataByOrigin=new Map}get id(){return this.baseInstanceData?.baseInstance.id??qd}dispose(){for(const e of this.dataByOrigin.values())e.dispose();this.dataByOrigin.clear(),this.baseInstanceData?.dispose()}},Zq=class{constructor(e,t,i){this.baseInstance=e,this.baseInstanceBuffer=t,this.baseCommand=i}dispose(){this.baseInstanceBuffer.dispose()}},EO=class{constructor(){this.first=0,this.count=0}},Qq=class{constructor(e,t){this.vao=e,this.instanceCount=t}dispose(){this.vao.disposeVAOOnly()}},Xq=class{constructor(){this.commandVAOs=new $a,this.drawCommandsDefault=new Array,this.drawCommandsHighlights=new Map,this.drawCommandsOccludees=new Array,this.drawCommandsShadowHighlightRest=new Array}clear(){this.commandVAOs.clear(),this.drawCommandsDefault.length=0,this.drawCommandsHighlights.clear(),this.drawCommandsOccludees.length=0,this.drawCommandsShadowHighlightRest.length=0}dispose(){for(const e of this.commandVAOs.values())e.dispose();this.clear()}},CS=class{constructor(e){this.targetBuffer=e,this.vaoEndElement=0,this._numElements=0,this._instances=new Map,this.holes=new jt({allocator:t=>t||new Zb,deallocator:null}),this.hasHiddenInstances=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.highlightNames=new Set,this.drawCommandsDefault=tf(),this.drawCommandsHighlights=new Map,this.drawCommandsOccludees=tf(),this.drawCommandsShadowHighlightRest=tf(),this._instancedCommandVAOs=null}get numElements(){return this._numElements}get instances(){return this._instances}get writeableInstances(){return this._instances}get hasHighlights(){return this.highlightNames.size>0}get instancedCommandVAOs(){return this._instancedCommandVAOs}resetInstanceSummary(){this.hasHiddenInstances=!1,this.hasOccludees=!1,this.highlightNames.clear()}updateIfDrawCommandsDirty(e){if(this.drawCommandsDirty){this.resetInstanceSummary();for(const t of this.instances.values())this.updateDrawState(t);this.updateDrawCommands(e)}}addInstance(e,t){this.deleteInstance(e),this._instances.set(e,t),this._numElements+=t.numElements}deleteInstance(e){const t=this._instances.get(e);t&&(this._numElements-=t.numElements,this._instances.delete(e))}updateInstances(){let e=0;for(const t of this._instances.values())e+=t.numElements,this.updateDrawState(t);this._numElements=e}updateDrawState(e){if(e.isVisible){const{highlightName:t}=e;t&&this.highlightNames.add(t),e.hasOccludees&&(this.hasOccludees=!0)}else this.hasHiddenInstances=!0}updateDrawCommands(e){this._updateDrawCommands(e),this._updateInstancedCommandVAOs()}_updateDrawCommands(e){if(this.drawCommandsDefault.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsDirty=!1,this._instances.size===0)return;const{sortedInstances:t}=this;if(this._updateHighlightDrawCommands(e,t),!this.needsMultipleCommands){const i=this.drawCommandsDefault.pushNew(),r=this.holes.front();return this.vao&&this.holes.length===1&&r.to===this.vaoEndElement?(i.first=0,void(i.count=r.from)):(i.first=1/0,i.count=0,this._instances.forEach(s=>{i.first=Math.min(i.first,s.from),i.count=Math.max(i.count,s.to)}),void(i.count-=i.first))}for(const i of t)i.isVisible&&D0(i.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,i)}get sortedInstances(){return Array.from(this._instances.values()).sort((e,t)=>e.from===t.from?e.to-t.to:e.from-t.from)}updateHighlights(e){this.highlightNames.clear();const t=this.sortedInstances;for(const i of t)i.updateHighlightOptions(e),i.isVisible&&i.highlightName&&this.highlightNames.add(i.highlightName);this._updateHighlightDrawCommands(e),this._updateInstancedCommandVAOs()}_updateHighlightDrawCommands(e,t=this.sortedInstances){const{drawCommandsHighlights:i,drawCommandsShadowHighlightRest:r}=this;i.clear(),r.clear();for(const s of t){if(s.updateHighlightOptions(e),!s.isVisible)continue;const{highlightName:n}=s;n&&(this.highlightNames.add(n),D0(Fa(i,n,tf),s)),n&&n===la||D0(r,s)}}_updateInstancedCommandVAOs(){const e=this.vao;if(this.targetBuffer==="geometry"||e==null)return;this._instancedCommandVAOs??=new Xq;const t=this._instancedCommandVAOs,i=t.commandVAOs.copy();t.clear();const r=t.commandVAOs,s=(n,a)=>{for(const o of n){const{first:l,count:c}=o,u=r.get(l,c)??i.pop(l,c)??new Qq(e.shallowCloneWithBaseInstances(new Map([["instances",o.first]])),o.count);r.set(l,c,u),a.push(u)}};s(this.drawCommandsDefault,t.drawCommandsDefault);for(const[n,a]of this.drawCommandsHighlights){const o=new Array;s(a,o),t.drawCommandsHighlights.set(n,o)}s(this.drawCommandsOccludees,t.drawCommandsOccludees),s(this.drawCommandsShadowHighlightRest,t.drawCommandsShadowHighlightRest);for(const n of i.values())n.dispose();i.clear()}get needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}};function Yq(e){return e.vao!=null}function SS(e){return e?"instances":"geometry"}function tf(){return new jt({allocator:e=>e||new EO,deallocator:e=>e})}function D0(e,t){const i=e.back();if(i==null){const r=e.pushNew();return r.first=t.from,void(r.count=t.numElements)}if(Kq(i,t)){const r=t.from-i.first+t.numElements;i.count=r}else{const r=e.pushNew();r.first=t.from,r.count=t.numElements}}function Kq(e,t){return e.first+e.count>=t.from}let Jq=class{constructor(e,t){this.origin=e,this.isInstanced=t,this.buffers=new Array}dispose(){if(this.isInstanced)for(const e of this.buffers)e.vao.buffer("instances")?.dispose(),e.vao.disposeVAOOnly(),e.instancedCommandVAOs?.dispose();else for(const e of this.buffers)e.vao.dispose();this.buffers.length=0}findBuffer(e){return this.buffers.find(t=>t.instances.has(e))}},TS=class{constructor(e,t){this._rctx=t,this._bufferWriter=e.createBufferWriter(),this._vaoCache=t.getVaoCache(Bs(this._bufferWriter.layout))}maxElements(e){return Math.floor(E0/this._targetStrideFloats(e))}_targetStrideFloats(e){return this._targetStrideBytes(e)/4}_targetStrideBytes(e){return this._targetLayout(e)?.stride??0}_targetLayout(e){return e==="geometry"?this._bufferWriter.layout:this._bufferWriter.instanceLayout}endElement(e){return Math.floor((e.vao?.getByteLength(e.targetBuffer)??0)/this._targetStrideBytes(e.targetBuffer))}evaluateBufferAllocation(e,t,i,r){const s=this._targetStrideFloats(r.targetBuffer),n=t.reduce((u,{geometry:p})=>u+this.elementCount(p),0),a=i.reduce((u,{geometry:p})=>u+this.elementCount(p),0),o=Math.min((e+n-a)*s,E0),l=r.vao?.buffer(r.targetBuffer),c=(l?.sizeBytes??0)/4;return o>ip&&o<c/2?0:o>c?1:2}deleteBuffer(e){if(e.targetBuffer==="instances")return e.instancedCommandVAOs?.dispose(),e.vao?.buffer("instances")?.dispose(),e.vao?.disposeVAOOnly(),void(e.vao=null);this._vaoCache.deleteVao(e.vao)}createBaseInstanceData(e){const{_bufferWriter:t}=this;if(e==null||t.writeBaseInstance==null||t.elementCountBaseInstance==null)return null;const i=t.layout,r=t.elementCountBaseInstance(e.attributes),s=r*this._targetStrideFloats("geometry"),n=new ei(this._rctx,Bs(i));n.setSize(Math.ceil(4*s));const a=ul(s),o=i.createView(a.buffer);t.writeBaseInstance(e.attributes,o),n.setSubData(a,0,0,s);const l=new EO;return l.first=0,l.count=r,new Zq(e,n,l)}_allocateInstanceBuffer(e){const t=this._bufferWriter.instanceLayout;Qt(t!=null,"Trying to allocate an instance buffer, but the BufferWriter does not support instancing");const i=e*this._targetStrideFloats("instances"),r=new ei(this._rctx,Bs(t,1));return r.setSize(A0(i)),r}_createInstancedVao(e,t){return new Dn(this._rctx,new Map([["geometry",e],["instances",t]]))}reallocateBuffer(e,t,i){if(this.deleteBuffer(t),e!=null){const s=e.baseInstanceBuffer,n=this._allocateInstanceBuffer(i);return this._createInstancedVao(s,n)}const r=i*this._targetStrideFloats("geometry");return this._vaoCache.newVao(A0(r))}elementCount(e){return this._bufferWriter.elementCount(e.attributes)}canGrow(e,t){const{targetBuffer:i,vao:r}=e;if(r==null)return!0;const s=4*(t*this._targetStrideFloats(i));return r.getByteLength(i)<A0(E0-ip)&&s>r.getByteLength(i)}clearHoles(e,{vao:t,targetBuffer:i}){const r=this._targetStrideFloats(i),s=e.reduce((o,l)=>Math.max(o,l.numElements),0)*r,n=ul(s);n.fill(0,0,s);const a=t.buffer(i);for(const o of e)a?.setSubData(n,o.from*r,0,o.numElements*r)}clearHolesMetal(e,t,i,{vao:r,targetBuffer:s}){const n=this._targetStrideFloats(s),a=(i-t)*n,o=ul(a),l=this._targetLayout(s).createView(o.buffer);o.fill(0,0,a);for(const c of e){if(!(c.from>=t&&c.to<=i))continue;const u=c.from-t;this._writeGeometry(c.geometry,l,u)}r.buffer(s)?.setSubData(o,t*n,0,a)}writeRandomInstances(e,t,{vao:i,targetBuffer:r}){const s=this._targetStrideFloats(r),n=ul(e*s),a=this._targetLayout(r).createView(n.buffer);let o=0,l=0,c=0;const u=i.buffer(r);for(const m of t){if(c!==m.from){const f=c-l;f>0&&u?.setSubData(n,l*s,0,f*s),l=m.from,o=0}this._writeGeometry(m.geometry,a,o),o+=m.numElements,c=m.to}const p=c-l;p>0&&u?.setSubData(n,l*s,0,p*s)}writeInstanceRangeMetal(e,t,i,{vao:r,targetBuffer:s}){const n=this._targetStrideFloats(s),a=e-t,o=a*n,l=ul(o),c=this._targetLayout(s).createView(l.buffer);l.fill(0,0,o);for(const u of i){if(!(u.from>=t&&u.to<=e))continue;const p=u.from-t;this._writeGeometry(u.geometry,c,p)}a>0&&r.buffer(s)?.setSubData(l,t*n,0,o)}rebuildInstances(e,t,{vao:i,targetBuffer:r}){const s=this._targetStrideFloats(r),n=ul(e*s),a=this._targetLayout(r).createView(n.buffer);let o=0;for(const l of t){this._writeGeometry(l.geometry,a,o);const c=o;o+=this.elementCount(l.geometry.geometry),l.from=c,l.to=o}return i?.buffer(r)?.setSubData(n,0,0,o*s),o}updateInstance(e,{vao:t,targetBuffer:i}){const{_bufferWriter:r}=this,s=this._targetStrideFloats(i),n=ul(r.elementCount(e.geometry.geometry.attributes)*s),a=this._targetLayout(i).createView(n.buffer);this._writeGeometry(e.geometry,a,0),t.buffer(i)?.setSubData(n,e.from*s,0,e.numElements*s)}updateInstancesMetal(e){for(const[t,i]of e){let r=1/0,s=-1/0;for(const n of i)r=Math.min(r,n.from),s=Math.max(s,n.to);this.writeInstanceRangeMetal(s,r,t.instances.values(),t)}}_writeGeometry(e,t,i){const{_bufferWriter:r}=this;r!=null&&(ks(jc,e.transformation),jc[12]-=e.localOrigin.vec3[0],jc[13]-=e.localOrigin.vec3[1],jc[14]-=e.localOrigin.vec3[2],tu(rf,jc),J4(rf,rf),r.write(jc,rf,e.geometry.attributes,e.geometry.olidColor,t,i))}static prune(){ag=new Float32Array(ip)}};const jc=Le(),rf=Le(),ip=65536,O0=4*ip,PS=1024,AO=16777216,E0=AO/4;let ag=new Float32Array(ip);function ul(e){return ag.length<e&&(ag=new Float32Array(e)),ag}function A0(e){const t=4*e;return t<=PS?PS:t<O0?II(t):Math.max(Math.min(Math.ceil(1.5*t/O0)*O0,AO),t)}let Vl=class extends ie{constructor(e){super(e),this._vaoWriter=null,this._useMetalWorkaround=!1,this._hasOccludees=!1}destroy(){this.uninitializeRenderContext()}initializeRenderContext(e){this._useMetalWorkaround=e.renderContext.rctx.isAssumedMetalDriver,this._vaoWriter=new TS(this.material,e.renderContext.rctx)}uninitializeRenderContext(){this._useMetalWorkaround=!1,this._vaoWriter=null}get hasOccludees(){return this._hasOccludees}modify(e,t){this._applyUpdates(e,t),this._applyAddsAndRemoves(e),this._updateDrawCommands()}get canCompact(){for(const e of this.dataByBaseInstance.values())for(const t of e.dataByOrigin.values())if(t.buffers.some(i=>i.holes.length>1))return!0;return!1}compact(e){if(!this.canCompact)return!1;let t=!1;for(const i of this.dataByBaseInstance.values())for(const r of i.dataByOrigin.values()){const s=new Array;for(let n=0;n<r.buffers.length&&!e.done;){const a=r.buffers[n];a.holes.length<=1?++n:(a.instances.forEach(({geometry:o})=>s.push(o)),this._vaoWriter?.deleteBuffer(a),zs(r.buffers,a,void 0,{last:n}),e.madeProgress())}if(s.length>0){const{baseInstanceData:n}=i;r.buffers.forEach(o=>this._applyAdds(n,o,s));const a=SS(n!=null);for(;s.length>0;)r.buffers.push(this._applyAndRebuild(n,new CS(a),s,null));t=!0}}return t}updateHighlights(e){this.highlightOrderMap=e;for(const t of this.dataByBaseInstance.values())for(const i of t.dataByOrigin.values())for(const r of i.buffers)r.updateHighlights(e)}_applyUpdates(e,t){const i=this._vaoWriter;if(i==null)return void e.clearUpdates();let r;const s=this._useMetalWorkaround?(n,a)=>{r??=new Map;let o=r.get(a);o||(o=[],r.set(a,o)),o.push(n)}:(n,a)=>i.updateInstance(n,a);for(const n of e.updates){if(t.done)return;const{renderGeometry:a,updateType:o}=n;zs(e.pending.updates,n),t.madeProgress();const l=this.dataByBaseInstance.get(a.geometry.baseGeometry?.id??qd),c=l?.dataByOrigin.get(a.localOrigin.id)?.findBuffer(a.id);if(c==null)return;const u=c.instances.get(a.id);6&o&&s(u,c),25&o&&(c.drawCommandsDirty=!0)}r&&i.updateInstancesMetal(r)}_computeDeltas(e,t){const i=new Map;for(const r of e){const s=r.localOrigin;if(s==null)continue;const n=r.geometry.baseGeometry,a=Fa(i,n??null,RS);let o=a.get(s,null);o==null&&(o=new MS(s.vec3,n),a.set(s,null,o)),o.changes.push(r)}for(const r of t){const s=r.localOrigin;if(s==null)continue;const n=r.geometry.baseGeometry,a=this.dataByBaseInstance.get(n?.id??qd),o=a?.dataByOrigin.get(s.id)?.findBuffer(r.id);if(o==null)continue;const l=Fa(i,n??null,RS);let c=l.get(s,o);c==null&&(c=new MS(s.vec3,n),l.set(s,o,c)),c.changes.push(r)}return i}_applyAddsAndRemoves(e){const{_vaoWriter:t,dataByBaseInstance:i}=this;if(t==null)return void e.clearAddsAndRemoves();const r=this._computeDeltas(e.adds,e.removes);for(const[s,n]of r){const a=Fa(i,s?.id??qd,()=>new Wq(t.createBaseInstanceData(s))),o=s!=null;for(const[l,c]of n.outerMap()){const u=c.get(null),p=u?.changes??[];n.delete(l,null);const m=Fa(a.dataByOrigin,l.id,()=>new Jq(l.vec3,o));for(const[f,g]of c){if(n.delete(l,f),f==null&&Qt(!1,"No VAO for removed geometries"),f.instances.size===g.changes.length){t.deleteBuffer(f),zs(m.buffers,f),m.buffers.length===0&&p.length===0&&a.dataByOrigin.delete(l.id);continue}const y=f.numElements;switch(t.evaluateBufferAllocation(y,p,g.changes,f)){case 0:g.changes.forEach(({id:v})=>f.deleteInstance(v)),f.instances.forEach(({geometry:v})=>p.push(v)),t.deleteBuffer(f),zs(m.buffers,f);break;case 1:this._applyAndRebuild(a.baseInstanceData,f,p,g);break;case 2:this._applyRemoves(f,g)}}if(p.length>0){const{baseInstanceData:f}=a,g=SS(o);for(const y of m.buffers)this._applyAdds(f,y,p);for(;p.length>0;)m.buffers.push(this._applyAndRebuild(f,new CS(g),p,null))}}a.dataByOrigin.size===0&&(a.dispose(),i.delete(a.id))}e.clearAddsAndRemoves()}_updateDrawCommands(){this._hasOccludees=!1;for(const e of this.dataByBaseInstance.values())for(const t of e.dataByOrigin.values())for(const i of t.buffers)i.updateIfDrawCommandsDirty(this.highlightOrderMap),this._hasOccludees||=i.hasOccludees}_applyAndRebuild(e,t,i,r){if(r)for(const c of r.changes)t.deleteInstance(c.id);const s=this._vaoWriter,n=s.maxElements(t.targetBuffer);let a=t.numElements;for(;i.length>0;){const c=i.pop(),u=s.elementCount(c.geometry);if(a+u>n&&a>0){i.push(c);break}a+=u;const p=new xS(c,0,0,this.highlightOrderMap);Qt(t.instances.get(c.id)==null),t.addInstance(c.id,p)}t.resetInstanceSummary(),t.vao=s.reallocateBuffer(e,t,a),t.vaoEndElement=s.endElement(t);const o=s.rebuildInstances(a,t.writeableInstances.values(),t);t.updateInstances(),t.holes.clear();const l=t.holes.pushNew();return l.from=o,l.to=t.vaoEndElement,t.updateDrawCommands(this.highlightOrderMap),t}_applyRemoves(e,t){const{_vaoWriter:i}=this;if(t.changes.length===0||i==null)return;let r=1/0,s=-1/0;for(const n of t.changes){const a=n.id,o=e.instances.get(a);if(!o)continue;e.deleteInstance(a),this._useMetalWorkaround&&(r=Math.min(r,o.from),s=Math.max(s,o.to));const l=_a.back();if(l){if(l.to===o.from){l.to=o.to;continue}if(l.from===o.to){l.from=o.from;continue}}const c=_a.pushNew();c.from=o.from,c.to=o.to}wS(_a),this._useMetalWorkaround?i.clearHolesMetal(e.instances.values(),r,s,e):i.clearHoles(_a,e),e.holes.pushArray(_a.data,_a.length),_a.forAll((n,a)=>_a.data[a]=null),_a.clear(),e.drawCommandsDirty=!0}_applyAdds(e,t,i){if(i.length===0||this._vaoWriter==null)return;if(!Yq(t))return void this._applyAndRebuild(e,t,i,null);const r=this._vaoWriter,s=t.numElements,n=i.reduce((p,{geometry:m})=>p+r.elementCount(m),0),a=Math.min(s+n,r.maxElements(t.targetBuffer));if(r.canGrow(t,a))return void this._applyAndRebuild(e,t,i,null);wS(t.holes);const o=new Array;let l=1/0,c=-1/0;for(const{geometry:p}of i){const m=r.elementCount(p),f=eG(t.holes,m);o.push(f),this._useMetalWorkaround&&f!=null&&(l=Math.min(f,l),c=Math.max(f+m,c))}const u=this._addInstances(i,t,o);if(this._useMetalWorkaround){for(const p of u);r.writeInstanceRangeMetal(c,l,t.instances.values(),t)}else r.writeRandomInstances(a,u,t);v2(i,(p,m)=>o[m]==null)}*_addInstances(e,t,i){const r=e.length,s=this._vaoWriter;for(let n=0;n<r;++n){const a=i[n];if(a==null)continue;const o=e[n],l=s.elementCount(o.geometry),c=new xS(o,a,a+l,this.highlightOrderMap);Qt(t.instances.get(o.id)==null),t.addInstance(o.id,c),t.drawCommandsDirty=!0,yield c}}static prune(){TS.prune()}};h([d({constructOnly:!0})],Vl.prototype,"dataByBaseInstance",void 0),h([d({constructOnly:!0})],Vl.prototype,"material",void 0),h([d()],Vl.prototype,"highlightOrderMap",void 0),Vl=h([D("esri.views.3d.webgl-engine.materials.renderers.MergedBuffer")],Vl);let MS=class{constructor(e,t){this.origin=e,this.baseInstance=t,this.changes=new Array}};function eG(e,t){const i=e.find(s=>s.numElements>=t);if(i==null)return null;const r=i.from;return i.from+=t,i.from>=i.to&&e.removeUnordered(i),r}const _a=new jt({allocator:e=>e||new Zb,deallocator:null});function RS(){return new $a}let tG=class{constructor(e,t){this._material=e,this._repository=t,this._map=new Map}dispose(){this._map.forEach((e,t)=>{e!=null&&this._repository.release(this._material,t)})}load(e,t,i){if(!this._material.produces.get(t)?.(i))return null;this._map.has(i)||this._map.set(i,this._repository.acquire(this._material,t,i));const r=this._map.get(i);if(r){if(r.ensureResources(e)===2)return r;this._repository.requestRender()}return null}},IO=class extends zA{constructor(e=w()){super(),this.origin=e}get slicePlaneLocalOrigin(){return this.origin}},Md=class extends ie{constructor(e){super(e),this._glMaterials=null,this._drawParameters=new IO,this._highlightNames=new Set,this._produces=new Map}initialize(){this._updateProduces()}destroy(){this.uninitializeRenderContext()}get _hasHighlights(){return this._highlightNames.size>0}hasHighlight(e){return this._highlightNames.has(e)}get produces(){return this._produces}_updateProduces(){this.material.produces.forEach((e,t)=>{this._produces.set(t,i=>!(this.dataByBaseInstance.size===0||!(i!==9&&i!==5||this._hasHighlights))&&e(i))})}initializeRenderContext(e){this._glMaterials=new tG(this.material,e.materials)}uninitializeRenderContext(){this._glMaterials=ye(this._glMaterials)}acquireTechniques(e){if(!this.material.shouldRender(e))return null;const{output:t,bind:i}=e;if(!this.material.produces.get(i.slot)?.(t))return null;const{highlight:r,slot:s}=i,n=t===5,a=t===9,o=a||n,l=r?.name;if(o&&(this._highlightNames.size===0||a&&l&&!this._highlightNames.has(l)))return null;const c=m=>a&&!!l&&!m.has(l),u=t===6,p=!(o||u);for(const m of this.dataByBaseInstance.values())for(const f of m.dataByOrigin.values())for(const g of f.buffers){if(c(g.highlightNames))continue;const y=n?g.drawCommandsHighlights.get(la):o?l?g.drawCommandsHighlights.get(l):g.drawCommandsHighlights.size>0:((u&&g.needsMultipleCommands?g.drawCommandsShadowHighlightRest:g.drawCommandsDefault)||null)?.length??!1,v=p&&g.drawCommandsOccludees||null;if(y||v?.length){const C=this._glMaterials.load(e.rctx,s,t),b=C?.beginSlot(i);if(b)return b}}return null}render(e,t){const{output:i,bind:r}=e,{slot:s,highlight:n}=r,a=i===9,o=n?.name??"";if(a&&!n)return;const l=i===5,c=a||l,u=i===6,p=!(c||u),m=s===10||s===11?s:null,{rctx:f}=e;f.runAppleAmdDriverHelper();const g=f.bindTechnique(t,r,this.material.parameters);for(const y of this.dataByBaseInstance.values()){const{baseInstanceData:v}=y,C=v!=null,b=C?nG:sG,S=C?rG:iG;for(const x of y.dataByOrigin.values()){this._drawParameters.origin=x.origin;for(const T of x.buffers){if(a&&(!T.hasHighlights||!T.drawCommandsHighlights.has(o))||l&&(!T.hasHighlights||!T.drawCommandsHighlights.has(la)))continue;const P=S(T),R=aG(P,T.needsMultipleCommands,o,l,c,u),O=oG(P,p);(R?.length||O?.length)&&(g.bindDraw(r,this.material.parameters,this._drawParameters),b(f,T,v,t,R,O,m))}}}}updateHighlights(){const{_highlightNames:e}=this;e.clear();for(const t of this.dataByBaseInstance.values())for(const i of t.dataByOrigin.values())for(const r of i.buffers)for(const s of r.highlightNames)e.add(s);this._updateProduces()}get test(){}};h([d({constructOnly:!0})],Md.prototype,"material",void 0),h([d({constructOnly:!0})],Md.prototype,"dataByBaseInstance",void 0),Md=h([D("esri.views.3d.webgl-engine.materials.renderers.VaoRenderer")],Md);const iG=e=>e,rG=e=>e.instancedCommandVAOs,sG=(e,{vao:t},i,r,s,n,a)=>{r.ensureAttributeLocations(t),e.bindVAO(t),DS(e,r,s,a,!1),DS(e,r,n,a,!0)},nG=(e,t,{baseCommand:i},r,s,n,a)=>{OS(e,r,i,s,a,!1),OS(e,r,i,n,a,!0)};function DS(e,t,i,r,s){if(i?.length){e.setPipelineState(t.getPipeline(s,r));for(const n of i)e.drawArrays(t.primitiveType,n.first,n.count)}}function OS(e,t,{first:i,count:r},s,n,a){if(s?.length){e.setPipelineState(t.getPipeline(a,n));for(const{vao:o,instanceCount:l}of s)t.ensureAttributeLocations(o),e.bindVAO(o),e.drawArraysInstanced(t.primitiveType,i,r,l)}}function aG(e,t,i,r,s,n){const a=s&&!r?e.drawCommandsHighlights.get(i)??null:null;return r?e.drawCommandsHighlights.get(la):s?a:n&&t?e.drawCommandsShadowHighlightRest:e.drawCommandsDefault}function oG(e,t){return t&&e.drawCommandsOccludees||null}let zh=class extends Zp{constructor(e){super(e),this._dataByBaseInstance=new Map,this._buffer=null,this._renderer=null,this.drapedPriority=0}initialize(){this._buffer=new Vl({material:this.material,dataByBaseInstance:this._dataByBaseInstance,highlightOrderMap:this.highlightOrderMap}),this._renderer=new Md({material:this.material,dataByBaseInstance:this._dataByBaseInstance})}destroy(){for(const e of this._dataByBaseInstance.values())e.dispose();this._dataByBaseInstance.clear(),this._buffer.destroy(),this._renderer.destroy()}hasHighlight(e){return this._renderer.hasHighlight(e)}initializeRenderContext(e){this._buffer.initializeRenderContext(e),this._renderer.initializeRenderContext(e)}uninitializeRenderContext(){this._buffer.uninitializeRenderContext(),this._renderer.uninitializeRenderContext()}get produces(){return this._renderer.produces}get hasOccludees(){return this._buffer.hasOccludees}get hasOnlyOccluders(){return!!(-2&this.renderOccludedFlags)}get hasEmitters(){return this.material.hasEmissions}get isDecoration(){return this.material.parameters.isDecoration}get renderOccludedFlags(){return this.material.renderOccludedFlags}get numGeometries(){let e=0;for(const t of this._dataByBaseInstance.values())for(const i of t.dataByOrigin.values())e+=i.buffers.reduce((r,s)=>r+s.instances.size,0);return e}get usedMemory(){let e=0;for(const t of this._dataByBaseInstance.values())for(const i of t.dataByOrigin.values())e+=i.buffers.reduce((r,s)=>r+s.vao.usedMemory,0);return e}forEachGeometry(e){for(const t of this._dataByBaseInstance.values())for(const i of t.dataByOrigin.values())for(const r of i.buffers)for(const{geometry:s}of r.instances.values())e(s)}modify(e,t){this._buffer.modify(e,t),this._renderer.updateHighlights()}get canCompact(){return this._buffer.canCompact}compact(e){return this._buffer.compact(e)}updateHighlights(e){this.highlightOrderMap=e,this._buffer.updateHighlights(e),this._renderer.updateHighlights()}updateAnimation(e){return this.material.update(e)}acquireTechniques(e){return this._renderer.acquireTechniques(e)}render(e,t){return this._renderer.render(e,t)}static prune(){Vl.prune()}get test(){}};h([d({constructOnly:!0})],zh.prototype,"material",void 0),h([d()],zh.prototype,"highlightOrderMap",void 0),zh=h([D("esri.views.3d.webgl-engine.materials.renderers.MergedRenderer")],zh);let rp=class extends ie{constructor(e){super(e),this._renderers=new Map}destroy(){this._renderers.forEach(e=>!e.destroyed&&e.destroy()),this._renderers.clear()}initialize(){this.addHandles(M(()=>this.stage.view.state.highlights,()=>this.updateHighlights()))}getMaterialRenderer(e){return this._renderers.get(e)}updateHighlights(){this._renderers.forEach(e=>e.updateHighlights(this.stage.view.state.highlightOrderMap))}commit(e,t,i){const{adds:r,removes:s,updates:n}=e;if(r.length===0&&s.length===0&&n.length===0)return!1;$q(e).forEach((o,l)=>{if(t.done)return;let c=this._renderers.get(l);c==null&&o.adds.length>0&&(c=new zh({material:l,highlightOrderMap:this.stage.view.state.highlightOrderMap}),c.initializeRenderContext(i),this.rendererAdded(c),this._renderers.set(l,c)),c?(c.modify(o,t),c.updateHighlights(this.stage.view.state.highlightOrderMap),c.numGeometries===0&&(this._renderers.delete(c.material),this.rendererRemoved(c),c.destroy())):(o.clear(),t.madeProgress())});let a=0;for(const o of this._renderers.values())o.drapedPriority=a++;return!0}get canCompact(){for(const e of this._renderers.values())if(e.canCompact)return!0;return!1}compact(e){let t=!1;for(const i of this._renderers.values()){if(e.done)return t;t=i.compact(e)||t}return t}get renderers(){return this._renderers}};h([d({constructOnly:!0})],rp.prototype,"stage",void 0),rp=h([D("esri.views.3d.webgl-engine.lib.RendererBase")],rp);let Gn=class extends rp{constructor(e){super(e),this._pending=new lG,this._changes=new $1,this._sortedRenderers=new jt,this._geometries=new Map,this._hasHighlights=!1,this._hasWater=!1}destroy(){this.destroyed||(this._changes.prune(),this._sortedRenderers.prune(),this._geometries.clear(),this._pending.clear())}get updating(){return!this._pending.empty||this._changes.updates.length>0}get rctx(){return this.rendererContext.rctx}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}hasHighlight(e){return fn(this.renderers,t=>t.hasHighlight(e))}get hasWater(){return this._hasWater}get hasOccluders(){return this.renderers&&fn(this.renderers,e=>e.hasOnlyOccluders)}get hasOnlyOccluders(){return wv(this.renderers,e=>e.hasOnlyOccluders)}get isEmpty(){return!this.updating&&this.renderers.size===0&&this._geometries.size===0}get sortedRenderers(){return this._sortedRenderers}commitChanges(){return!!this.updating&&(this._processAddsRemoves(),this.commit(this._changes,bn,this.rendererContext.pluginContext)&&(this._updateSortedMaterialRenderers(),this._hasHighlights=fn(this.renderers,e=>{const t=e.produces.get(18);return!!t&&t(9)}),this._hasWater=fn(this.renderers,e=>{const t=e.produces.get(19);return!!t&&t(3)})),this.notifyChange("updating"),!0)}rendererAdded(){this._sortedRenderers.clear()}rendererRemoved(){this._sortedRenderers.clear()}addGeometries(e,t){if(e.length===0)return;const i=this._validateRenderGeometries(e);for(const s of i)this._geometries.set(s.id,s);const r=this._pending.empty;for(const s of i)this._pending.adds.add(s);switch(r&&this.notifyChange("updating"),t){case 0:this._notifyGraphicVisibilityChanged(e);break;case 1:this._notifyGraphicGeometryChanged(e)}}removeGeometries(e,t){if(this.destroyed)return;const i=this._pending.empty,r=this._pending.adds;for(const s of e)r.has(s)?(this._pending.removed.add(s),r.delete(s)):this._pending.removed.has(s)||this._pending.removes.add(s),this._geometries.delete(s.id);i&&!this._pending.empty&&this.notifyChange("updating"),t===1&&this._notifyGraphicGeometryChanged(e)}modifyGeometries(e,t){const i=this._changes.updates.length===0;for(const r of e){const s=new qq;this._changes.updates.push(s),s.renderGeometry=this._ensureValidRenderGeometry(r),s.updateType=t}switch(i&&this._changes.updates.length>0&&this.notifyChange("updating"),t){case 4:case 2:return this._notifyGraphicGeometryChanged(e);case 1:return this._notifyGraphicVisibilityChanged(e)}}updateAnimation(e){let t=!1;return this._sortedRenderers.forAll(i=>t=!!i.updateAnimation&&i.updateAnimation(e)||t),t}precompile(e){return this._sortedRenderers.reduce((t,i)=>i.precompile(e)||t,!1)}render(e){this._sortedRenderers.forAll(t=>{const i=t.acquireTechniques(e);i&&t.render(e,i)})}intersect(e,t,i,r,s){for(const n of this._geometries.values()){if(!r(n))continue;this._intersectRenderGeometry(n,i,t,0,e,s);const a=this.rendererContext.longitudeCyclical;a&&(n.boundingSphere[0]-n.boundingSphere[3]<a.min&&this._intersectRenderGeometry(n,i,t,a.range,e,s),n.boundingSphere[0]+n.boundingSphere[3]>a.max&&this._intersectRenderGeometry(n,i,t,-a.range,e,s)),s++}return s}_updateSortedMaterialRenderers(){if(!(this._sortedRenderers.length>0)){for(const e of this.renderers.values())this._sortedRenderers.push(e);this._sortedRenderers.sort((e,t)=>t.material?.renderPriority===e.material?.renderPriority?e.drapedPriority-t.drapedPriority:(t.material?.renderPriority||0)-(e.material?.renderPriority||0))}}_processAddsRemoves(){this._changes.adds.length=0,this._changes.removes.length=0,Vw(this._changes.adds,Array.from(this._pending.adds)),Vw(this._changes.removes,Array.from(this._pending.removes)),v2(this._changes.updates,({renderGeometry:e})=>!this._pending.has(e)),this._pending.clear()}_intersectRenderGeometry(e,t,i,r,s,n){if(!e.visible||!e.material.visible||!e.material.intersectDraped)return;let a=0;r+=e.transformation[12],a=e.transformation[13],I0[0]=i[0]-r,I0[1]=i[1]-a,e.screenToWorldRatio=this.rendererContext.screenToWorldRatio,e.material.intersectDraped(e,s,I0,(o,l,c)=>{cG(t,c,n,e.material.renderPriority,s,e.layerViewUid,e.graphicUid)},t)}_notifyGraphicGeometryChanged(e){if(this.drapeSource.notifyGraphicGeometryChanged==null)return;let t;for(const{graphicUid:i}of e)i!=null&&i!==t&&(this.drapeSource.notifyGraphicGeometryChanged(i),t=i)}_notifyGraphicVisibilityChanged(e){if(this.drapeSource.notifyGraphicVisibilityChanged==null)return;let t;for(const{graphicUid:i}of e)i!=null&&i!==t&&(this.drapeSource.notifyGraphicVisibilityChanged(i),t=i)}_validateRenderGeometries(e){for(const t of e)this._ensureValidRenderGeometry(t);return e}_ensureValidRenderGeometry(e){return e.localOrigin==null&&(e.localOrigin=this._localOriginFactory.getOrigin(Gi(e.boundingSphere))),e}get test(){}};h([d({constructOnly:!0})],Gn.prototype,"drapeSource",void 0),h([d({constructOnly:!0})],Gn.prototype,"rendererContext",void 0),h([d()],Gn.prototype,"updating",null),h([d()],Gn.prototype,"rctx",null),h([d()],Gn.prototype,"_localOriginFactory",null),h([d({readOnly:!0})],Gn.prototype,"isEmpty",null),h([d()],Gn.prototype,"_geometries",void 0),Gn=h([D("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],Gn);let lG=class{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return this.adds.size===0&&this.removes.size===0&&this.removed.size===0}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}};function cG(e,t,i,r,s,n,a){const o=new OF(n,a,t),l=c=>{c.set(5,o,e.distance,e.normal,e.transformation,i,r)};if((s.results.min.drapedLayerOrder==null||i>=s.results.min.drapedLayerOrder)&&(s.results.min.distance==null||s.results.ground.distance<=s.results.min.distance)&&l(s.results.min),s.options.store!==0&&(s.results.max.drapedLayerOrder==null||i<s.results.max.drapedLayerOrder)&&(s.results.max.distance==null||s.results.ground.distance>s.results.max.distance)&&l(s.results.max),s.options.store===2){const c=new CM(s.ray);l(c),s.results.all.push(c)}}const I0=ze();function LO(){const e=globalThis.require?.modules;if(e){const t=Object.keys(e);for(const i of t)i.includes(".glsl")&&delete e[i]}}let ES=class{constructor(e,t){this.screen=e,this.olid=t}};const FO=1.3,hG=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let dl,xr=class extends ie{constructor(e){super(e),this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Set,this._drapeTargets=new Set,this._placementDirty=!1,this._contentUpdated=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._latestOriginId=0,this.groundView=e.view.groundView}initialize(){const{view:e}=this;this.renderer=new qn({parent:this}),e.stage.renderer.plugins.add(this.renderer);const t=()=>this.requestRender();this._groundIntersector=new Us(e.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this.addHandles([M(()=>this.renderer.hasHighlights,t),this.renderer.events.on("has-water",()=>e.stage?.renderer.updateHasFlags()),this.renderer.events.on("content-changed",t),M(()=>e.state.camera.pixelRatio,t),M(()=>e.state.alignPixelEnabled,t),this.renderer.events.on("textures-disposed",()=>this.groundView.requestRender(1)),M(()=>[e.pointsOfInterest?.renderPointOfView,e.pointsOfInterest?.centerOnSurfaceFrequent?.location],()=>this.setPlacementDirty()),M(()=>[e.state?.pixelRatio,e.state?.contentPixelRatio],()=>this.setPlacementDirty(),Ie),Yr(()=>this.groundView,i=>i.on("elevation-change",()=>this.setPlacementDirty())),e.on("resize",()=>this.setPlacementDirty()),e.resourceController.scheduler.registerTask(mi.OVERLAY,this)]),e.stage.renderer.overlay=this}destroy(){this.view?.stage&&(this.view.stage.renderer.plugins.remove(this.renderer),this.view.stage.renderer.overlay=null,Z(this.renderer)),dl&&(dl.hide(),dl=null),this.renderer=null}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.renderer.longitudeCyclical=null;const t=this.view.renderSpatialReference;e!=null&&t!=null?(this._renderSR=t,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical&&(this.renderer.longitudeCyclical=G4(e))):this.renderer.disposeOverlays()}get readyToRun(){return this._placementDirty&&(this._drapeSources.size>0||this.view.graphics.length>0||bi.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&(this.terrainSurface.ready||!this.terrainSurface.enabled)}get _isSpherical(){return this.view.state.isGlobal}get worldToPCSRatio(){return this._spatialReference!=null&&this._spatialReference.isGeographic&&!this.view.state.isLocal?Yt(this._spatialReference).metersPerDegree:1}get _overlayStretch(){return FO/this.view.resolutionScale}get longitudeCyclical(){return this.renderer.longitudeCyclical}get suspended(){return this.terrainSurface.enabled&&this.terrainSurface.suspended}get updating(){return this.readyToRun||!!this.renderer?.updating||this._contentUpdated}render(){return this._contentUpdated=!1,this.renderer.processSyncDrapeSources(),this.renderer.precompileShaders(this.view.state)?this._drawOverlays():null}get hasOverlays(){return this.renderer.hasOverlays}registerDrapeSource(e,t){this._drapeSources.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources),this.renderer.registerDrapeSource(e,t),this._updateDrapeSourceExtent(e),this._setContentDirty(),this.notifyChange("readyToRun")}registerGeometryDrapeSource(e){const t=new Gn({stage:this.view.stage,drapeSource:e,rendererContext:this.renderer});return this.registerDrapeSource(e,t),t}_updateDrapeSourceExtent(e){this.renderer.overlays.length===2&&e.setDrapingExtent!=null&&this._spatialReference!=null&&e.setDrapingExtent(this.renderer.overlays,this._spatialReference)}unregisterDrapeSource(e){this._drapeSources.has(e)&&(this._drapeSources.delete(e),this.renderer.removeDrapeSourceRenderer(e),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("readyToRun"))}registerDrapeTarget(e){this._drapeTargets.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)}unregisterDrapeTarget(e){this._drapeTargets.delete(e),this.renderer.ensureDrapeTargets(this._drapeTargets)}_setContentDirty(){this.setPlacementDirty(),this.requestRender()}setPlacementDirty(){this._placementDirty=!0}runTask(e){return this.updateOverlays(e,this.view.state.contentCamera,1)}updateOverlays(e,t,i){if(!this._spatialReference)return Fi;const r=this._computeOverlayHeight(t);this._computeOverlayExtents(t,r,Ln),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources,Ln.stretch);const s=this._updateOverlay(0,Ln.inner,r,1*Ln.pixelRatioAdjustment,Ln.mapUnitsPerPixel),n=ds(Ln.inner)/ds(Ln.outer),a=this._updateOverlay(1,Ln.outer,r,n*Ln.pixelRatioAdjustment,Ln.mapUnitsPerPixel);s!==1&&a!==1||(this._drapeSources.forEach(o=>this._updateDrapeSourceExtent(o)),this.groundView.updateOverlayParameters(),this.groundView.requestRender(i)),s===0&&a===0||this.requestRender(),this._placementDirty=!1,e.madeProgress()}_computeOverlayHeight(e){const t=this.view.state.contentPixelRatio*this.view.resolutionScale,i=e.fullWidth/e.pixelRatio*t,r=e.fullHeight/e.pixelRatio*t,s=Math.ceil(1.5*Math.max(i,r)),{maxPreferredTexturePixels:n,maxTextureSize:a}=this.view.stage.renderView.renderingContext.parameters,o=.5*a;return Wh(n8({width:s,height:s},{maxPreferredTexturePixels:2*n,maxTextureSize:o})[1],o)}get overlays(){return this.renderer.overlays}_updateOverlay(e,t,i,r,s){if(this.renderer.overlays.length===0)return 0;const n=this.renderer.overlays[e],a=n.mapUnitsPerPixel;if(n.mapUnitsPerPixel=s,n.pixelRatio=r,uG(t,n.extent)&&i===n.resolution)return a===s?0:2;n.setExtent(t),n.resolution=i;const o=z4(n.extent);return n.renderLocalOrigin=__(o[0],o[1],0,"OV_"+this._latestOriginId++),1}overlayPixelSizeInMapUnits(e,t){if(this.renderer.overlays.length===0)return t();const i=this.renderer.overlays[0],r=this.renderer.overlays[1],s=this._pointIsInExtent(e,i.extent)?i:r;return(s.extent[2]-s.extent[0])/s.resolution}reloadShaders(){LO(),this.requestRender(),this.runTask(bn)}requestRender(e=1){this.renderer.hasOverlays?(e===1?(this._contentUpdated=!0,this._drawTexturesDirty=!0):this._drawTexturesAnimateDirty=!0,this.view.stage.renderView.requestRender(e)):this.setPlacementDirty()}_intersectGroundFromView(e,t,i,r,s){const n=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,fG,t,i);if(n==null)return!1;const a=n.origin,o=ce(sf,n.origin,n.direction);this._groundIntersector.reset(a,o,e),this._groundIntersector.intersect([]),this.view.groundView.intersect(this._groundIntersector,null,a,o);const l=this._groundIntersector.results.min;return l.getIntersectionPoint(s)&&l.withinDistance(r)}_findHorizonBasedPointOfInterest(e,t){let i=.5;const r=.55,s=this.view.renderCoordsHelper.getAltitude(e.eye),n=this.view.pointsOfInterest.centerOnSurfaceFrequent,a=1e-5,o=j(n.estimatedSurfaceAltitude,e.aboveGround?-1/0:s+a,e.aboveGround?s-a:1/0),l=e.aboveGround;if(this.view.viewingMode==="global"){const c=sf;L_(I_(Z2,Yt(this.view.spatialReference).radius+o),ru(e.eye,e.viewForward),c),de(c,c,e.eye);const u=Bo.normalize(DL(e.viewForward,c,e.viewRight))/e.fovY+.5,p=u<=0||u>=1?.5:r;i=l?p*u:u+p*(1-u)}else{const c=.5*Math.PI-Math.acos(-e.viewForward[2]),u=Math.tan(c),p=Mi(0,u,1,0),m=Bg(p,p,e.projectionMatrix)[1],f=j(.5+.5*m,0,1);i=f===1||f===0?.5:l?f*r:1-(1-f)*r}return this._intersectGroundFromView(e,.5,i,n.distance,t)}_computeOverlayExtents(e,t,i){const{view:r}=this,s=r.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,n=w();this._findHorizonBasedPointOfInterest(e,n)||q(n,s);const a=this._renderSR;bi.OVERLAY_SHOW_CENTER?(dl==null&&(dl=new fh(r.graphics,"red")),dl.show(n,a)):dl?.hide();const o=Math.max(.1,Gt(e.eye,n)),l=Fo(r.renderCoordsHelper,s,e.eye),c=this._spatialReference;this._overlaySREqualsRenderSR||No(n,a,n,c);const u=this._isSpherical,p=this.groundView.extentAABR,m=!u&&c?.isGeographic,f=m&&c?1/Yt(c).metersPerDegree:1,g=r.state.contentPixelRatio,y=e.perScreenPixelRatio/g*o*f;i.mapUnitsPerPixel=y/this.worldToPCSRatio,i.stretch=this._overlayStretch;let v=t*y/2*i.stretch,C=!1,b=m?90:1/0;u&&p&&c&&(c.isWebMercator?(v/=Math.cos(Rv(n[1])),b=p[3]):(C=!0,v/=Yt(c).metersPerDegree,b=90),v>=b&&(v=b,n[1]=0,c.isWebMercator&&(n[0]=0)));let S=1;C&&(S=1/Math.max(.2,Math.cos(Math.abs(rt(n[1])))),v*S>180&&(S=180/v),i.mapUnitsPerPixel*=S);const x=Math.log(2)/12;v=Math.exp(Math.round(Math.log(v)/x)*x);const T=v*S,P=32,R=.5*t/(P*T),O=.5*t/(P*v);n[0]=Math.round(n[0]*R)/R,n[1]=Math.round(n[1]*O)/O;const E=i.inner;E[0]=n[0]-T,E[1]=n[1]-v,E[2]=n[0]+T,E[3]=n[1]+v,u&&this._shiftExtentToFitBounds(E,1/0,b);const A=i.outer;if(6*T>ds(p))Hp(A,p);else if(Math.PI/2-Math.abs(l-Math.PI/2)<=.25*Math.PI)A[0]=E[0]-T,A[1]=E[1]-v,A[2]=E[2]+T,A[3]=E[3]+v;else{No(e.eye,a,sf,c),El(pl,n,sf);let L=-Math.atan2(pl[1],pl[0])+.125*Math.PI;L<0&&(L+=2*Math.PI);const H=Math.floor(L/(.25*Math.PI));X2(pl,hG[H],2*v),pl[0]*=S,pl[2]*=S,AL(A,E,pl)}if(u)A[0]=this.longitudeCyclical.clamp(A[0]),A[2]=this.longitudeCyclical.clamp(A[2]),A[1]=Math.max(A[1],-b),A[3]=Math.min(A[3],b);else{const L=Ev(E,p,pG),H=Ev(A,p,mG);Q9(L,H)&&(A[2]=A[0],A[3]=A[1])}const F=Math.abs(E[2]-E[0])/t;i.mapUnitsPerPixel=Math.max(i.mapUnitsPerPixel,F),i.pixelRatioAdjustment=i.mapUnitsPerPixel/F}_drawOverlays(e=this.view.state){if(!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return this.renderer;const t=!this._drawTexturesDirty&&this._drawTexturesAnimateDirty?0:1;this._drawTexturesDirty=this._drawTexturesAnimateDirty=!1;const i=this.renderer.computeValidity();return this.renderer.releaseRenderTargets(t),this.renderer.drawOverlays(e,t),i!==this.renderer.computeValidity()&&(this.groundView.updateOverlayParameters(),this.groundView.requestRender(1)),this.groundView.requestRender(t),t===1&&this.terrainSurface.requestUpdate(),this.renderer}_pointIsInExtent(e,t){if(this.longitudeCyclical)return this.longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];const i=e.x,r=e.y;return i>t[0]&&i<t[2]&&r>t[1]&&r<t[3]}_shiftExtentToFitBounds(e,t,i){let r=0,s=0;e[0]<-t?r=e[0]+t:e[2]>t&&(r=t-e[2]),e[1]<-i?s=e[1]+i:e[3]>i&&(s=i-e[3]),Lg(e,r,s)}get test(){}};function uG(e,t){const i=bi.TESTS_DISABLE_OPTIMIZATIONS?0:1e-5*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]);return Math.abs(t[0]-e[0])<=i&&Math.abs(t[1]-e[1])<=i&&Math.abs(t[2]-e[2])<=i&&Math.abs(t[3]-e[3])<=i}h([d()],xr.prototype,"_spatialReference",void 0),h([d({readOnly:!0})],xr.prototype,"readyToRun",null),h([d()],xr.prototype,"_placementDirty",void 0),h([d()],xr.prototype,"_contentUpdated",void 0),h([d()],xr.prototype,"_isSpherical",null),h([d()],xr.prototype,"worldToPCSRatio",null),h([d()],xr.prototype,"renderer",void 0),h([d({constructOnly:!0})],xr.prototype,"view",void 0),h([d({constructOnly:!0})],xr.prototype,"groundView",void 0),h([d({constructOnly:!0})],xr.prototype,"terrainSurface",void 0),h([d()],xr.prototype,"suspended",null),h([d()],xr.prototype,"updating",null),xr=h([D("esri.views.3d.terrain.OverlayManager")],xr);let dG=class{constructor(){this.inner=Rt(),this.outer=Rt(),this.mapUnitsPerPixel=0,this.pixelRatioAdjustment=1,this.stretch=FO}};const pl=Vt(),sf=w(),Ln=new dG,pG=Rt(),mG=Rt(),fG=$o();let gG=class{constructor(){this.sinLonLUT=new Array(od+1),this.cosLonLUT=new Array(od+1),this.sinLatLUT=new Array(od+1),this.cosLatLUT=new Array(od+1)}update(e,t,i){const r=t[0],s=t[2];for(let n=0;n<=e;n++){const a=n/e,o=r*(1-a)+s*a;this.sinLonLUT[n]=Math.sin(o),this.cosLonLUT[n]=Math.cos(o);const l=i(a);this.sinLatLUT[n]=Math.sin(l),this.cosLatLUT[n]=Math.cos(l)}}},_G=class{constructor(){this.numVerticesPerSide=0,this.samplerData=null,this.samplerDataVersion=0,this.clippingArea=null,this.wireframe=!1,this.cornerPeerNeighbors=[null,null,null,null],this.cornerNeighborCornerTiles=[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],this.cornerNeighborCornerTileSamplerVersions=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],this.edgeResolutions=[-1,-1,-1,-1],this.edgePeerNeighbors=[null,null,null,null],this.edgePeerNeighborSamplerVersions=[-1,-1,-1,-1]}},yG=class{constructor(){this.indices=null,this.indexCount=0,this.edgeIndicesStartIndex=0,this.poleIndicesStartIndex=0,this.vertexAttributes=null,this.edgeVerticesStartIndex=0,this.poleVerticesStartIndex=0,this.maxEdgeVertexCount=0,this.boundingBox=Gs(),this.numVerticesPerSide=0,this.minu=0,this.minv=0,this.maxu=1,this.maxv=1,this.outerEdgesOffsetAndLength=[0,0,0,0,0,0,0,0]}release(){this.vertexAttributes=Ht(this.vertexAttributes),this.indices=null}reset(){this.indices=null,this.vertexAttributes=null,Gs(this.boundingBox),this.numVerticesPerSide=0}getEdgeFirstVertexIndex(e){return this.outerEdgesOffsetAndLength[2*e]}getEdgeCount(e){return this.outerEdgesOffsetAndLength[2*e+1]}getEdgeVertexIndex(e,t){return this.getEdgeAttributeIndex(e,t)}getEdgeVertexPosition(e,t,i,r){this._getEdgeVertexRaw(this.getEdgeAttributeIndex(e,r),t),ce(t,t,i)}getEdgeNormal(e,t,i){const{typedBuffer:r,typedBufferStride:s}=this.vertexAttributes.normalCompressed;kF(t,r,this.getEdgeAttributeIndex(e,i),s)}setEdgeNormalFromValues(e,t,i,r,s){this._setNormal(this.getEdgeAttributeIndex(e,t),i,r,s)}setEdgeVertexFromValuesRawPositionUV(e,t,i,r,s,n,a){const o=this.getEdgeAttributeIndex(e,t);this.vertexAttributes.position.setValues(o,i,r,s),this._setUV(o,n,a)}setEdgeVertexFromValuesRawPositionUVNormal(e,t,i,r,s,n,a,o,l,c){const u=this.getEdgeAttributeIndex(e,t);this.vertexAttributes.position.setValues(u,i,r,s),this._setUV(u,n,a),this._setNormal(u,o,l,c)}_getEdgeVertexRaw(e,t){this.vertexAttributes.position.getVec(e,t)}_setNormal(e,t,i,r){const{typedBuffer:s,typedBufferStride:n}=this.vertexAttributes.normalCompressed;vp(s,e,t,i,r,n)}_setUV(e,t,i){this.vertexAttributes.uv0.setValues(e,Math.round(t*pi),Math.round(i*pi))}getEdgeAttributeIndex(e,t){return N(0<=t&&t<this.getEdgeCount(e)),this.getEdgeFirstVertexIndex(e)+t}},vG=class og{constructor(t){this._getFadeDuration=t,this._fadeStart=0,this._delayedTime=0}clear(){this._current=Z(this._current),this._next=Z(this._next),this._waiting=Z(this._waiting),this._delayed=Z(this._delayed)}get current(){if(this._current==null)return null;if(!this._isFadingEnabled){let i=null;this._delayed?(i=this._delayed,this._delayed=null):this._waiting?(i=this._waiting,this._waiting=null):this._next&&(i=this._next,this._next=null),i&&(this.clear(),this._current=i)}let t=og.test.fadeMoment;if(this._delayed&&(t=t||performance.now(),t>=this._delayedTime&&(this._push(this._delayed,0),this._delayed=null)),this._next){t=t||performance.now();const i=this._fadeDuration,r=this._current!=null&&this._next.texture===this._current.texture,s=this._next.type!==0,n=t-this._fadeStart>=i;(r||s||n)&&(Z(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(t))}return this._current}get next(){return this._next}get fadeFactor(){if(this._next==null)return 1;const t=og.test.fadeMoment||performance.now(),i=Math.max(0,t-this._fadeStart),r=this._fadeDuration;return i>r?0:1-i/r}get isFading(){return this._next!=null||this._delayed!=null}push(t,i=0){this._delayed=Z(this._delayed),this._push(t,i)}_push(t,i){if(this._isFadingEnabled||this.clear(),this._current==null)return void(this._current=t);const r=og.test.fadeMoment||performance.now();return i!==0?(this._delayed=t,void(this._delayedTime=r+i)):this._next==null?(this._next=t,void(this._fadeStart=this._alignFadeStart(r))):void(t!=null&&(Z(this._waiting),this._waiting=t))}get _fadeDuration(){const t=this._getFadeDuration();return this._waiting?.5*t:t}_alignFadeStart(t){const i=this._getFadeDuration();return t+i-t%i}get _isFadingEnabled(){return this._getFadeDuration()>0}static{this.test={fadeMoment:0}}},lg=class{constructor(e,t,i,r,s,n){this.texture=e,this.type=t,this.offsetAndScale=i,e.retain(),this.opacities=We(r,s,n)}destroy(){this.texture.release()}},bG=class{constructor(){this._scales=Mi(-1,-1,-1,-1),this._offsets=Mi(-1,-1,-1,-1)}clear(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}setScale(e,t,i){this._scales[2*e]=t,this._scales[2*e+1]=i}setOffset(e,t,i){this._offsets[2*e]=t,this._offsets[2*e+1]=i}get scales(){return this._scales}get offsets(){return this._offsets}},VO=class{constructor(){this._queue=new jt,this.remove=()=>{}}get done(){return this._queue.length===0&&(!this._last||this._last.leaf)}resetOne(e){this._queue.clear(),this._queue.push(e),this._last=void 0}reset(e=null){this._queue.clear(),e!=null&&this._queue.pushArray(e),this._last=void 0}skipSubtree(){this._last=void 0}next(){const e=this._last?.children;return e?.[0]&&this._queue.pushArray(e),this._last=this._queue.pop(),this._last}},wG=class{constructor(){this._q=new jt}get done(){return this._q.length===0}reset(e){if(this._q.clear(),e!=null){this._q.pushArray(e);for(let t=0;t<this._q.length;++t){const i=this._q.data[t];i.leaf||this._q.pushArray(i.children)}}}next(){return this._q.pop()}};function Kl(e,t){if(t==null||t.destroyed)return!1;const i=xG(t);if(i?.fullExtent==null)return!1;const r=i.fullExtent,s=e.extent;if(r.xmin>s[2]||r.ymin>s[3]||r.xmax<s[0]||r.ymax<s[1])return!1;const n=e.surface.tilingScheme.levels[e.level].scale,a=i.minScale;if(a>0&&n>1.00000001*a)return!1;const o=i.maxScale;return!(o>0&&n<.99999999*o)}function xG(e){return Q_(e)?{fullExtent:e.fullExtent,minScale:e.layer.minScale,maxScale:e.layer.maxScale}:e.layer}function CG(e){return!Q_(e)&&e.layer&&"tilemapCache"in e.layer?e.layer.tilemapCache:null}function ta(e,t){const i=e.lij,r=t.lij;return i[0]-r[0]||i[1]-r[1]||i[2]-r[2]}function zO(e,t=null){return t==null||t.length===0?e.sort(SG):e.sort((i,r)=>TG(i,r,t))}function SG(e,t){const i=e.screenDepth-t.screenDepth;if(i!==0)return i;const r=e.lij,s=t.lij;return r[0]-s[0]||r[1]-s[1]||r[2]-s[2]}function kO(e,t){const i=e.screenDepth,r=t.screenDepth;return i<r?-1:i>r?1:ta(e,t)}function TG(e,t,i){return AS(e,i)===AS(t,i)?kO(e,t):e?1:-1}function AS(e,t){for(const i of t)if(e.intersectsExtent(i))return!0;return!1}function PG(e,t){const i=e.distanceToPOI-t.distanceToPOI;if(i!==0)return i;const r=e.lij,s=t.lij;return r[0]-s[0]||r[1]-s[1]||r[2]-s[2]}function MG(e,t){const i=e.length;for(let r=0;r<i;++r)e.at(r).updateDistanceToPOI(t);e.sort(PG)}function RG(e,t,i){let r=1,s=0,n=0;for(;e!==t;)if(r*=.5,s*=.5,n*=.5,1&e.lij[2]&&(s+=.5),1&e.lij[1]||(n+=.5),(e=e.parent)==null)throw new Error("tile was not a descendant of upsampleTile");i.init(t,s,n,r)}function DG(e){for(let t=0;t<e.length;t++){const i=e[t],r=i.parent;if(r)for(let s=0;s<4;s++){const n=r.children[s];if(n&&n!==i)return!0}}return!1}function bse(e,t){if(!e||!t||e[0]===t[0])return!1;const i=e[0]<t[0],r=i?e:t,s=i?t:e,n=1<<s[0]-r[0];return Math.floor(s[1]/n)===r[1]&&Math.floor(s[2]/n)===r[2]}let OG=class{constructor(){this.geometry=new yG,this.geometryState=null,this._texture=null,this._textureOpacity=1,this._textureRef=new vG(()=>this._tile.surface.fadeDuration),this.overlay=new bG,this._localOrigin=null,this._geometryStateChangedSinceLastUpdate=!0,this._hasGeometry=!1,this._modifiedFlags=0}get tile(){return this._tile}get localOrigin(){return this._localOrigin}init(e,t){this.clear(),this._tile=e,this.geometry.reset(),this.intersectionData=null,this.geometryState=new _G,this._localOrigin=t,this.overlay.clear()}clear(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear(),this._tile=null,this.intersectionData=null,this.geometryState=null}updateGeometryIfNeeded(e){if((!this._vao||this._geometryStateChangedSinceLastUpdate||this.wireframeChanged||this.clippingAreaChanged||this.samplerDataChanged||this.numVerticesPerSideChanged||this.dirtyCorners||this.dirtyEdgeResolutions||this.dirtyEdges)&&(this._updateGeometry(e),this._geometryStateChangedSinceLastUpdate=!1),vi&&this.tile.intersectsClippingArea)for(let t=0;t<4;++t)N(this.geometry.getEdgeCount(t)===this.geometryState.edgeResolutions[t]+1)}_calculateEdgeResolution(e,t){const i=this.tile,r=this.geometryState.numVerticesPerSide-1;if(!i.surface.isGlobal){const o=i.surface.extent;if(o!=null&&(e===0&&i.extent[3]>o[3]||e===1&&i.extent[2]>o[2]||e===2&&i.extent[1]<o[1]||e===3&&i.extent[0]<o[0]))return r}const s=i.level,n=Cn[e];if(!t)return N(i.surface?.rootTiles==null||i.surface.updatingRootTiles||!i.shouldHaveNeighbor(n)),r;if(t.loaded){const o=t,l=o.renderData.geometryState,c=s-o.level;if(N(c>=0),c===0){const m=l.numVerticesPerSide-1;return Math.max(m,r)}const u=2**c,p=l.edgeResolutions[(e+2)%4]/u;return Math.max(1,p)}N(!t.leaf);let a=r;return t.forAllSubtreeOnSide(kb(n),o=>o===i||(o.loaded?(a=Math.max(a,2**(o.level-s)),!0):(N(!o.leaf),!1))),a}updateNeighborData(){const e=this.tile;if(!e.intersectsClippingArea)return;const t=e.renderData.geometryState,i=n=>(n.loaded||n.level===e.level)&&n?.intersectsClippingArea,r=t.edgePeerNeighbors,s=t.edgePeerNeighborSamplerVersions;for(let n=0;n<4;++n){const a=e.findNeighborTile(Cn[n],i),o=zl(e,a),l=o?.renderData?.geometryState.samplerDataVersion??-1,c=r[n],u=o!==zl(e,c),p=s[n]!==l;vi&&a&&(N(e.level>=a.level),N(e.level-a.level<=hi)),r[n]=a,(u||p)&&(s[n]=l,this._markEdgeDirty(n));const m=t.edgeResolutions[n],f=this._calculateEdgeResolution(n,a);N(nc(f)),N(f>=1),t.edgeResolutions[n]=f,m!==f&&this._markEdgeResolutionDirty(n)}for(let n=0;n<4;++n){const a=e.findNeighborTile(g_[n],i);t.cornerPeerNeighbors[n]=a;const o=zl(e,r[n]),l=zl(e,r[(n+1)%4]),c=zl(e,a);en[n]=c,en[(n+1)%4]=l,en[(n+2)%4]=e,en[(n+3)%4]=o,N(en.some(f=>f?.loaded||f===e));const u=en.reduce((f,g)=>Math.min(f,g?.level??1/0),1/0);en.forEach((f,g)=>{f&&f?.level>u&&(en[g]=null)}),N(en.some(f=>f?.loaded||f===e));const p=t.cornerNeighborCornerTiles,m=t.cornerNeighborCornerTileSamplerVersions;for(let f=0;f<4;++f){const g=en[f],y=g?.renderData.geometryState.samplerDataVersion??-1,v=4*n+f,C=p[v]!==g,b=!C&&m[v]!==y;(C||b)&&(p[v]=g,m[v]=y,this._markCornerDirty(n))}vi&&N(Qb.some(f=>p[4*n+f]?.loaded||p[4*n+f]===e))}vi&&N(this.geometryState.edgeResolutions.every(n=>n>0));for(let n=0;n<4;++n)en[n]=null}_updateGeometry(e){if(!this.tile.intersectsClippingArea)return;vi&&N(!this.tile.intersectsClippingArea||this.geometryState.edgeResolutions.every(m=>m>0)),this.intersectionData=null;const{tile:t,_vao:i,geometry:r,geometryState:s}=this,n=!i||!1||this.wireframeChanged||this.samplerDataChanged||this.clippingAreaChanged||this.numVerticesPerSideChanged,a=this.dirtyEdgeResolutions!==0,o=s.edgeResolutions.reduce((m,f)=>m+f+1,0),l=n||a&&o>(r?.maxEdgeVertexCount??0),c=!l&&a,u=!c&&(this.dirtyEdges!==0||a),p=!u&&this.dirtyCorners!==0;l?(this.releaseGeometry(),this._createGeometry(e)):c?t.updateEdgeElevationsAndResolutions():u||p?t.updateEdgeElevations():p?t.updateCornerElevations():console.warn("Update for no reason?"),this._modifiedFlags=0}get hasGeometry(){return this._hasGeometry}releaseGeometry(){return this._hasGeometry=!1,this.intersectionData=null,!!this._vao&&(this._vao=ye(this._vao),this.geometry.release(),!0)}ensureTexture(e,t,i,r){const s=t?6408:6407;return this._texture!=null&&(i===0&&this._tile.surface.fadeDuration>0&&this._isTextureVisible(this._texture)||this._texture.descriptor.width!==e||this._texture.descriptor.pixelFormat!==s)&&this.releaseTexture(),this._texture==null&&(this._texture=r(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){this._texture&&(this._texture=Ht(this._texture),this.tile.setMemoryDirty())}reuseTexture(e,t){return!(!e||!this._texture)&&(e.setTextureReference(new lg(this._texture,0,t,this._textureOpacity,0,1)),!0)}get numVerticesPerSideChanged(){return(this._modifiedFlags&AG)!==0}get samplerDataChanged(){return(this._modifiedFlags&IG)!==0}get clippingAreaChanged(){return(this._modifiedFlags&LG)!==0}get wireframeChanged(){return(this._modifiedFlags&FG)!==0}get dirtyEdges(){return this._modifiedFlags>>L0&15}get dirtyCorners(){return this._modifiedFlags>>F0&15}get dirtyEdgeResolutions(){return this._modifiedFlags>>V0&15}_markCornerDirty(e){const t=1<<e<<F0;this._modifiedFlags|=t}_markEdgeDirty(e){const t=1<<e<<L0;this._modifiedFlags|=t,this._markCornerDirty((e+0)%4),this._markCornerDirty((e+3)%4)}_markEdgeResolutionDirty(e){const t=1<<e<<V0;this._modifiedFlags|=t,this._markEdgeDirty(e)}_markAllEdgesAndCornersDirty(){this._modifiedFlags|=15<<F0|15<<L0|15<<V0}updateGeometryState(){const e=this._elevationInfo,t=this.tile,i=e.samplerData?t.getElevationVerticesPerSide(e.maxTileLevel):t.minimumVerticesPerSide,r=Math.max(i,5);let s=t.clippingArea;t.intersectsClippingArea&&!t.withinClippingArea||(s=null);const n=this.geometryState;let a=!1;n.numVerticesPerSide!==r&&(this._modifiedFlags|=1,n.numVerticesPerSide=r,n.samplerDataVersion++,a=!0),e.changed&&(this._modifiedFlags|=2,n.samplerData=e.samplerData,n.samplerDataVersion++,a=!0),TA(n.clippingArea,s)||(this._modifiedFlags=4,n.clippingArea=s,a=!0);const o=t.surface.wireframe;return n.wireframe!==o&&(this._modifiedFlags=8,n.wireframe=o,a=!0),this._geometryStateChangedSinceLastUpdate||=a,a&&this._markAllEdgesAndCornersDirty(),this._hasGeometry=!0,this._geometryStateChangedSinceLastUpdate}_createGeometry(e){this.tile.createGeometry();const{vertexAttributes:t,indices:i}=this.geometry,r=e.gl;this._vao=new Dn(e,new ei(e,Bs(t.layout),t.buffer),Hs.createIndex(e,r.STATIC_DRAW,i)),this._hasGeometry=!0}get vao(){return this._vao}setTextureReference(e,t=0){e?.texture===this._texture?this._textureOpacity=e.opacities[0]:this.releaseTexture(),this._textureRef.push(e,t)}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_isTextureVisible(e){return this._textureRef.current?.texture===e||this._textureRef.next?.texture===e&&this._textureRef.fadeFactor<1}get _elevationInfo(){const e=this.geometryState.samplerData,t=this.tile.layerInfo[0],i=t.length,r=new Array(i);let s=0,n=0,a=!1;for(let c=0;c<i;c++){const u=t[c],p=u.upsampleInfo?.tile;if(p){const m=p.layerInfo[0][c].data,f=m&&m.samplerData;e&&e[s]===f||(a=!0),r[s++]=f,n=Math.max(n,p.lij[0])}else if(u.data){const m=this.tile.surface.layerViewByIndex(c,0);if(Kl(this.tile,m)){const f=u.data;e&&e[s]===f.samplerData||(a=!0),r[s++]=f.samplerData,n=this.tile.level}}}e!=null&&e.length!==s&&(a=!0);const o=s>0,l=o?r:null;return o&&(r.length=s),{changed:a,samplerData:l,maxTileLevel:n}}get estimatedGeometryMemoryUsage(){const e=this.intersectionData?.estimatedMemoryUsage??0;return(this.geometry.indices?.byteLength??0)+(this.geometry.vertexAttributes?.byteLength??0)+e}get texture(){return this._texture}get test(){}checkGeometryWaterproofness(){if(!vi)return;const e=this.tile;if(!e.loaded||!e.intersectsClippingArea||e.level===0)return void N(e?.loaded);const t=e.surface.extent;if(t!=null&&!e.intersectsExtent(t))return;const i=Cn.map((a,o)=>t!=null&&(o<2?-1:1)*(e.extent[3-o]-t[3-o])<0),r=e.level;N(this.dirtyCorners===0),N(this.dirtyEdges===0),N(this.dirtyEdgeResolutions===0),N(!this.numVerticesPerSideChanged),N(!this.samplerDataChanged),N(!this.clippingAreaChanged),N(!this.wireframeChanged);const s=g_.map(a=>e.findNeighborCornerTileExact(a,o=>!o.intersectsClippingArea||o.loaded||o.level===e.level)??null).map(a=>a?.intersectsClippingArea?a:null),n=this.geometryState;for(let a=0;a<4;++a){const o=n.cornerPeerNeighbors[a],l=s[a];N(l===o,`Tile[${e.lij}].corner[${a}] out of date: cur=[${o?.lij}] exp=[${l?.lij}]`)}Cn.forEach((a,o)=>{if(i[o])return;const l=e.findNeighborTile(a,ae=>(ae.level===r||ae?.loaded)&&ae?.intersectsClippingArea);if(!l){const ae=!e.surface.updatingRootTiles&&e.surface.rootTiles!=null&&e.surface.rootTiles.length>0&&e.shouldHaveNeighbor(a);return void N(!ae)}N(l.loaded||l.level===e.level),N(l===this.geometryState.edgePeerNeighbors[o]);const c=r-l.level;if(!l.loaded)return N(!l.leaf),void N(c===0);const u=l.renderData;N(e.isEdgeNeighbor(l,a)),N(c>=0);const p=2**c;if(c<0)return void N(!1);const m=e.renderData,f=m.geometry,g=m.localOrigin,y=f.getEdgeCount(o),v=f.numVerticesPerSide-1,C=u.geometry;if(!C)return void N(!1);const b=u.localOrigin,S=this.geometryState.edgePeerNeighbors[o];if(S?.loaded){const ae=S.renderData;N(m.geometryState.edgePeerNeighborSamplerVersions[o]===ae.geometryState.samplerDataVersion),N(this.geometryState.edgePeerNeighborSamplerVersions[o]===ae.geometryState.samplerDataVersion)}const x=(o+2)%4,T=C.getEdgeCount(x),P=y-1,R=T-1;N(P*p===R,`Tile[${e.lij}]:e${o},res=${P} edgeRes mismatch with Neighbor[${l.lij}]:e${x},res=${R} (expected:${P*p})`);const O=e.extent,E=a===0||a===4,A=T-1,F=A>>c,L=y-1;if(F<1)return void N(L===1);N(F===L),N(nc(F));const H=C.numVerticesPerSide-1;N(c>0||F===Math.max(H,v));const V=e.getNeighborEdgeStartVertexIndex(o,l);N(0<=V&&V<p);const I=V*F;N(0<=I&&I<=A-F);let B=0,ee=I;f.getEdgeVertexPosition(o,Fn,g,0),f.getEdgeVertexPosition(o,Vn,g,y-1);const G=Gt(Fn,Vn),be=Math.max(EG,1e-4*G);for(let ae=0;ae<=F;++ae){f.getEdgeVertexPosition(o,Fn,g,B),C.getEdgeVertexPosition(x,Vn,b,ee);const Xe=ae/F,se=E?O[0]+Xe*(O[2]-O[0]):a===6?O[0]:O[2],Re=E?a===4?O[1]:O[3]:O[1]+Xe*(O[3]-O[1]),Pe=e.surface.extent;if(Pe==null||J9(Pe,se,Re)){const Ae=B2(Fn,Vn),Dt=cn(Fn)-Li.radius,Bt=cn(Vn)-Li.radius,Fe=Ae<be;if(!Fe){console.warn(`Tile edge vertex position mismatch: between [${e.lij}].edge${o}[${B}/${y}] and [${l.lij}].edge${x}[${ee}/${T}]`),Pe!=null&&console.warn("  surface extent= ",Pe," x,y=",se,",",Re);const we=w();de(we,m.localOrigin,u.localOrigin),cn(we)>0&&console.warn(`   localOrigins: ${m.localOrigin} vs ${u.localOrigin} d=${cn(we)} [${we}]`),(()=>{const Y=Mn(Fn),W=Mn(Vn);e.updateEdgeElevations(),l.updateEdgeElevations(),f.getEdgeVertexPosition(o,Fn,g,B),C.getEdgeVertexPosition(x,Vn,b,ee);const U=w();ji(U,Fn,Y),cn(U)>0&&console.warn(`  XXX Tile[${e.lij}] edge out of date: ${Y} vs ${Fn} d=${cn(U)} [${U}]`),ji(U,Vn,W),cn(U)>0&&console.warn(`  XXX Neighbor[${l.lij}] edge out of date: ${W} vs ${Vn} d=${cn(U)} [${U}]`)})();const Ke=f.getEdgeCount(o),nt=C.getEdgeCount(T);N(Fe,`Mismatch in tile [${e.lij}].edge[${o}][${B}/${Ke}] vs neighbor [${l.lij}].edge[${x}][${ee}/${nt}] ${fa(Fn)} vs ${fa(Vn)}  dist=${Ae} h(t|n|d)=${Dt}|${Bt}|${Bt-Dt}`)}f.getEdgeNormal(o,Uc,B),C.getEdgeNormal(x,Hc,ee),me(IS,Uc),me(LS,Hc);const et=$e(IS,LS),je=1-et<.01||!1||e===l;if(!je){const we=w();ji(we,Uc,Hc);const Ke=()=>`Mismatch in tile edge normal ${G3(e.lij)} (${B}/${y-1}) edge ${o} vs neighbor ${G3(l.lij)}  (${ee}/${T-1}) nedge ${x} :${fa(Uc)} vs ${fa(Hc)}  dot = ${et} : ${fa(we)}`;console.warn("Mismatch in tile edge normal: ",Ke());{e.updateEdgeElevations(),l.updateEdgeElevations();const nt=w(),Y=w();f.getEdgeNormal(o,nt,B),C.getEdgeNormal(x,Y,ee),eu(Uc,nt)||console.warn("Missing update in tile normal: ",fa(Uc)," => ",fa(nt)),eu(Hc,Y)||console.warn("Missing update in neighbor normal: ",fa(Hc)," => ",fa(Y))}N(je,Ke())}}B+=1,ee+=1}})}};const Fn=w(),Vn=w(),Uc=w(),Hc=w(),IS=w(),LS=w(),EG=1,en=[null,null,null,null];function zl(e,t){return t?.loaded||t===e?t:null}const AG=1,IG=2,LG=4,FG=8,L0=4,F0=8,V0=12,Qb=[0,1,2,3];let Xb=class{get updating(){return!!this._tileRequested}init(e,t,i,r){this.tile=e,this._layerIdx=t,this._layerClass=i,this._suspended=r,this._tileLayerInfo=e.getLayerInfo(t,i),this._tileRequested=null;const s=this._findAncestorWithData();this._setUpsampleTile(s)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(e,t){this._setUpsampleTile(e,t),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass,0,t):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return e!=null?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}_findNextDownload(){const e=this._layerIdx,t=this._layerClass,i=this.tile.surface.layerViewByIndex(e,t),{minLevel:r,maxLevel:s}=i.dataLevelRange,n=this._desiredMinLevelDelta,a=this._progressiveLevelModulo+n,o=this._scaleRangeEnabled?Kl:()=>!0;let l=this.tile;const c=l.level;let u;const p=this._tileLayerInfo.upsampleInfo,m=p?.tile?.level??-1,f=p!=null&&m-c>=n,g=CG(i),y=i.type==="vector-tile-3d"?i.schemaHelper:null;for(;l&&o(l,i)&&l.level>=r;){const v=l.level,C=c-v,b=l.layerInfo[t][e];if(b.data&&C>=n){(!f||v>m)&&this._setUpsampleTile(l),b.dataInvalidated&&(u=l);break}const S=y?.getLevelRowColumn(l.lij)??l.lij;if(g?.getAvailability(S[0],S[1],S[2])!=="unavailable"&&v<=s&&!b.data&&!b.dataMissing&&((!u||l.level===r||v%fR===0||c-u.level<n)&&(u=l),C>=a))break;l=l.parent}if(u!=null&&c-u.level<n)if(p)u=null;else{const v=this._findAncestorWithData();v!=null&&(this._setUpsampleTile(v),u=v.layerInfo[t][e].dataInvalidated?v:null)}return u}_findAncestorWithData(){const e=this.tile.elevationLevel,t=this._desiredMinLevelDelta;let i;for(let r=this.tile;r;r=r.parent)if(r.hasLayerData(this._layerIdx,this._layerClass)){if(e-r.level>=t)return r;i=r}return i}_setUpsampleTile(e,t){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass,0,t)}get test(){}},VG=class extends Xb{constructor(){super(...arguments),this.type="none"}get _desiredMinLevelDelta(){throw FS}get _progressiveLevelModulo(){throw FS}dispose(){}};const FS=new Error("Abstract method called on TileAgent"),Nr=new VG;let zG=class extends Xb{constructor(){super(...arguments),this.type="elevation",this._scaleRangeEnabled=!1}get _desiredMinLevelDelta(){return this.tile.elevationLevelDelta-(this.tile.elevationLevel-this.tile.level)}get _progressiveLevelModulo(){return 0}};function kG(e){return e.type==="elevation"}let BG=class{constructor(e){this.tile=e}get usedMemory(){return this.tile.mapDataMemory}},NG=class extends Xb{constructor(){super(),this.type="map",this._scaleRangeEnabled=!0}get _desiredMinLevelDelta(){return 0}get _progressiveLevelModulo(){return fR}};function jG(e){return e.type==="map"}let cg=class{constructor(){this.waitingAgents=new jt,this.pendingUpdates=0}static acquire(e){const t=hg.acquire();return t._init(e),t}release(){this.dispose(),sp.delete(this),hg.release(this)}dispose(){this.loadingAgent=ye(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=Gh(this._data)}static prune(){hg.prune(0)}_init(e){this.waitingAgents.clear(),this._data=Gh(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=e,this.elevationBounds=null}invalidateSourceData(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}abortRequest(){this.requestAbort=Ar(this.requestAbort),this.requestPromise=null}_unsetUpsampleInfo(){this.upsampleInfo&&(this.upsampleInfo.tile?.unrefMapData(),this._pool.release(this.upsampleInfo),this.upsampleInfo=null)}setUpsampleInfo(e,t){if(e!==t&&t!=null){if(this.upsampleInfo==null)this.upsampleInfo=this._pool.acquire();else{if(this.upsampleInfo.tile===t)return;this.upsampleInfo.tile?.unrefMapData()}t.refMapData(),RG(e,t,this.upsampleInfo)}else this._unsetUpsampleInfo()}get data(){return this._data}set data(e){Gh(this._data),this._data=e}};const hg=new Eo(()=>new cg,null,()=>{}),sp=new Map;function UG(){sp.size>0&&(console.log(`${sp.size} live TilePerLayerInfo allocations:`),sp.forEach(e=>console.log(e,`
`)))}function HG(){hg.prune(),sp.clear()}const qG=.1;class Yb{constructor(){this._lij=[0,0,0],this._children=[null,null,null,null],this._pendingUpdates=0,this._dirty=!0,this._previouslyRendered=!1,this.extent=Rt(),this._elevationBoundsMin=NaN,this._elevationBoundsMax=0,this.layerInfo=[[],[]],this.extentInRadians=Rt(),this.centerAtSeaLevel=w(),this._center=[w(),Kr(),w()],this.up=y9(),this._withinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=0,this._rasterTileMemory=0,this._vectorTileMemory=0,this._mapDataRefCount=0,this.screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0,this.onCompressionFinished=()=>{this.setPendingUpdate(16),this.setMemoryDirty()},this.extentMidX=0,this.extentMidY=0,this.distanceToPOI=-1,this._lastPOI=w(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0}get lij(){return this._lij}get spatialReference(){return this._surface.spatialReference??this._surface.tilingScheme.spatialReference}get elevationLevelDelta(){return this._surface.getElevationLevelDelta(this.level)}static prune(){Kb.prune(0),Jb.prune(0),cg.prune()}get _cached(){return!this.leaf&&this._mapDataRefCount<=0}get withinClippingArea(){return this._withinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBoundsMin(){return this._elevationBoundsMin}get elevationBoundsMax(){return this._elevationBoundsMax}get level(){return this._lij[0]}get key(){return`${this._lij[0]}/${this._lij[1]}/${this._lij[2]}`}get edgeLen(){return this._edgeLen}get radius(){return this._center[1][3]}get visible(){return this._dirty&&this.computeVisibility(),this._visible}get frustumVisibility(){return this._dirty&&this.computeVisibility(),this._frustumVisibility}computeVisibility(){this._dirty=!1;const t=this.parent,i=t?.frustumVisibility??1;this._frustumVisibility=i===0?0:i===2?2:this._calculateFrustumVisibility(this.surface.frustum);const r=this._frustumVisibility!==2&&this._intersectsClippingArea;r!==this._visible&&(this._visible=r,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setDirty(),this.updateAgentSuspension())}get _loadable(){return this.visible||this._surface.view.state.fixedContentCamera}get rendered(){const t=!!this.renderData;return t!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=t,this._surface.renderer.setDirty()),t}init(t,i,r,s,n){this._lij[0]=t,this._lij[1]=i,this._lij[2]=r,this.ellipsoid=Yt(n.tilingScheme.spatialReference),n.tilingScheme.getExtent(t,i,r,this.extent),n.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this.extentMidX=.5*(this.extent[0]+this.extent[2]),this.extentMidY=.5*(this.extent[1]+this.extent[3]),this._withinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,n.upsampleMapCache.pop(this.key),this._edgeLen=0,this._edgeLen2=0,this._center[1][3]=0,this.elevationLevel=t,s&&!Number.isNaN(s.elevationBoundsMin)?(this._elevationBoundsMin=s.elevationBoundsMin,this._elevationBoundsMax=s.elevationBoundsMax):(this._elevationBoundsMin=0,this._elevationBoundsMax=0),this._pendingUpdates=0,this.renderData=null,this.screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=s,this.clearChildren(),this._surface=n,this.updateVisibility(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0;for(const a of gh){const o=n.numLayers(a),l=this.layerInfo[a];for(const c of l)c.release();l.length=o;for(let c=0;c<o;c++)l[c]=cg.acquire(this._surface.upsampleInfoPool),a===0&&this.findElevationBoundsForLayer(c,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(n.tilingScheme.pixelSize,od)}dispose(){Si(!this.renderData,"tile.renderData was not unloaded"),this._surface?.upsampleMapCache.pop(this.key),this.layerInfo.forEach(t=>{t.forEach(i=>i.release()),t.length=0}),this._surface=this._parent=null,this.clearChildren(),this.setMemoryDirty()}refMapData(){++this._mapDataRefCount,this._cached||this._surface.upsampleMapCache.pop(this.key)}unrefMapData(){--this._mapDataRefCount,this._cached&&this.cachedMemory>0&&this._surface.upsampleMapCache.put(this.key,new BG(ec(this)))}setMemoryDirty(){this._usedMemory=0}get usedMemory(){return this._ensureUsedMemory()+(this._cached?0:this.mapDataMemory)}get cachedMemory(){return this._ensureUsedMemory(),this._surface==null?this.usedMemory:this._cached?this.mapDataMemory:0}get mapDataMemory(){return this._rasterTileMemory+this._vectorTileMemory}get _cpuImageMemorySize(){const t=this._surface.tilingScheme.pixelSize;return t*t*4}_ensureUsedMemory(){if(this._usedMemory>0)return this._vectorTileMemory=this.layerInfo[1].reduce((t,{data:i})=>t+(mh(i)?i.usedMemoryPerReference:0),0),this._usedMemory;this._usedMemory=this._baseUsedMemory,this._rasterTileMemory=0,this._vectorTileMemory=0;for(const{data:t}of this.layerInfo[1])mh(t)?this._vectorTileMemory+=t.usedMemoryPerReference:this._rasterTileMemory+=this.getTerrainDataMemory(t);for(const t of this.layerInfo[0])this._usedMemory+=t.data?this._cpuImageMemorySize:0;return this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._rasterTileMemory+=this.renderData.texture?.usedMemory??0),this._cached&&this._surface.upsampleMapCache.updateSize(this.key),this._usedMemory}getUsedMemoryForLayer(t,i){const r=this.layerInfo[t][i];return r?.data?t===1?this._cached?0:this.getTerrainDataMemory(r.data):t===0?this._cpuImageMemorySize:0:0}getTerrainDataMemory(t){return rO(t)?t.texture.usedMemory:iO(t)?t.memoryUsage:mh(t)?t.usedMemoryPerReference:Z_(t)||t instanceof HTMLImageElement?this._cpuImageMemorySize:0}updateScreenDepth(t){const i=this._center[1],r=t,s=i[0],n=i[1],a=i[2],o=r[2]*s+r[6]*n+r[10]*a+r[14];this.screenDepth=o<0?0:o/(r[3]*s+r[7]*n+r[11]*a+r[15])}shouldSplit(t,i,r){if(!this.visible||t.frustum&&(!this._intersectsClippingArea||this._calculateFrustumVisibility(t.frustum)===2))return 0;const s=this.level;de(af,Gi(this._center[1]),i);let n=Wr(af),a=af,o=_p(this._center[1],w());de(z0,this._center[0],i);const l=Wr(z0);l<n&&(n=l,a=z0,o=this._center[0]),de(k0,this._center[2],i);const c=Wr(k0);if(c<n&&(n=c,a=k0,o=this._center[2]),this._edgeLen2>n&&s<t.maxLod)return 1;const u=Math.sqrt(n),p=t.fovX*u*2,m=this._edgeLen/p,f=()=>{if(s<t.maxLod)return this.elevationLevel=s,0;const R=s+Math.ceil(-Math.log2(t.relativeWidthLimit/m));return R!==this.elevationLevel?(this.elevationLevel=R,2):0},g=r!=null?r-s:1/0;if(g<=.5)return f();const y=$e(this.up,af),v=this._elevationBoundsMax-this._elevationBoundsMin,C=v/this.edgeLen;if(t.aboveGround&&y>0&&C<.001&&y/u-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-C>0)return 0;const b=r!=null?3-Math.min(g,2):1;if(m*b<t.relativeWidthLimit||s>=t.maxLod)return f();if(s<7)return 1;te(Oi,this.up,y),de(Oi,Oi,a);const S=Wr(Oi);if(S<=this.radius*this.radius)return 1;te(Oi,Oi,this.radius/Math.sqrt(S)),ce(Oi,Oi,o),de(Oi,i,Oi);const x=Math.min(1,(Math.abs($e(Oi,this.up))+.5*v+this._curvatureHeight)/ge(Oi)),T=qG/t.angledSplitBias,P=t.fovY*u*2;return x*(this._edgeLen/P*b)<T*t.relativeHeightLimit?0:1}createChildren(){const t=this._children,i=this.lij[0]+1,r=2*this.lij[1],s=2*this.lij[2];return t[0]=this.surface.createTile(i,r,s,this),t[1]=this.surface.createTile(i,r,s+1,this),t[2]=this.surface.createTile(i,r+1,s,this),t[3]=this.surface.createTile(i,r+1,s+1,this),t}clearChildren(){this._children[0]=this._children[1]=this._children[2]=this._children[3]=null}get loaded(){return this.renderData?.hasGeometry??!1}load(){this.refMapData();for(const t of gh)this._createOrUpdateAgents(0,t);this.surface.renderer.loadTile(this)}unload(){this.renderData&&this.unrefMapData(),this.surface.renderer.unloadTile(this);for(const t of gh){const i=this.layerInfo[t];for(const r of i)r.loadingAgent&&r.loadingAgent!==Nr&&(nf(r.loadingAgent),r.loadingAgent=null),r.pendingUpdates=0}this.resetPendingUpdate(8),this.resetPendingUpdate(16),this.resetPendingUpdate(32)}unloadMapData(){const t=this.layerInfo[1];for(const i of t)i.loadingAgent&&i.loadingAgent!==Nr&&(nf(i.loadingAgent),i.loadingAgent=null),i.pendingUpdates=0,i.invalidateSourceData();this.renderData?.releaseTexture(),this.setMemoryDirty()}updateClippingStatus(t){if($l(t,this._clippingArea))return!1;const i=this._intersectsClippingArea,r=this._withinClippingArea;t!=null?(this._intersectsClippingArea=this.intersectsExtent(t),this._withinClippingArea=this._isWithinExtent(t)):(this._intersectsClippingArea=!0,this._withinClippingArea=!0),this._clippingArea=t,this.updateVisibility();const s=r&&this._withinClippingArea,n=!(r||i||this._withinClippingArea||this._intersectsClippingArea);return!this.renderData||s||n||this.setPendingUpdate(8),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty()}getLayerInfo(t,i){return this.layerInfo[i][t]}hasLayerData(t,i){const r=this.layerInfo[i][t];return!(!r?.data||r.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return!0;for(const t of gh){const i=this.layerInfo[t];for(const r of i)if(r.loadingAgent&&r.loadingAgent!==Nr&&r.loadingAgent.updating)return!0}return!1}_isSuspended(t){return!!this.hasPendingUpdate(1)||t!==0&&!this._loadable}get hasPendingUpdates(){return this._pendingUpdates!==0}hasPendingUpdate(t){return(this._pendingUpdates&t)===t}setPendingUpdate(t){const i=this._pendingUpdates;return this._pendingUpdates|=t,t===1||t===4?this._surface.setTileTreeDirty():this._surface.requestUpdate(),i!==this._pendingUpdates}resetPendingUpdate(t){return!!this.hasPendingUpdate(t)&&(this._pendingUpdates&=~t,!0)}requestLayerData(t,i,r){const s=this.layerInfo[i][t];if(s.waitingAgents.has(r))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),r.tile.lij.toString(),i,t),!0;if(s.waitingAgents.push(r),s.data&&!s.dataInvalidated){console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),r.tile.lij.toString(),i,t);const o=mh(s.data);return r.dataArrived(this,o),!0}if(s.requestPromise)return!0;Ar(s.requestAbort),s.requestAbort=new AbortController;const n=this._surface.requestTileData(this,t,i,s.requestAbort);if(!n)return s.requestAbort=null,!1;const a=()=>{s.requestPromise===n&&(s.requestPromise=null,s.requestAbort=null)};return s.requestPromise=n,n.then(a,a),!0}get leaf(){return this._children[0]==null}hasLij(t){return this._lij[0]===t[0]&&this._lij[1]===t[1]&&this._lij[2]===t[2]}findByLij(t){if(this.hasLij(t))return this;const i=this._children;return i[0]?i[0].findByLij(t)||i[1].findByLij(t)||i[2].findByLij(t)||i[3].findByLij(t):null}distanceToSquared(t){return Wr(de(Oi,Gi(this._center[1]),t))}containsPoint(t){const i=this.extent;return t[0]>=i[0]&&t[1]>=i[1]&&t[0]<=i[2]&&t[1]<=i[3]}containsPointXY(t,i){const r=this.extent;return t>=r[0]&&i>=r[1]&&t<=r[2]&&i<=r[3]}unrequestLayerData(t,i,r){const s=this.layerInfo[i][t],n=s.waitingAgents,a=n.removeUnordered(r)!=null;Si(a,"agent has not requested this piece of map data"),n.length<1&&(s.abortRequest(),this.setMemoryDirty())}dataArrived(t,i,r){const s=mh(r),n=this.layerInfo[i][t];n.data=r,n.dataInvalidated=!1,n.waitingAgents.forAll(a=>a.dataArrived(this,s)),n.waitingAgents.clear(),this.setMemoryDirty()}dataMissing(t,i){const r=this.layerInfo[i][t];r.dataMissing=!0,r.waitingAgents.forAll(s=>s.dataMissing()),r.waitingAgents.clear(),this.setMemoryDirty()}updateRenderData(t,i,r){switch(r&&this.forEachLoadedNeighbor(s=>s.updateRenderData(t,i)),t){case 1:return this._updateTexture(i);case 0:return this._updateGeometry()}}_updateTexture(t){this.renderData&&(this.resetPendingUpdate(t===0?16:32),this.setPendingUpdate(t===0?32:16))}_updateGeometry(){this.setPendingUpdate(8);for(const t of this.layerInfo[0])t.pendingUpdates|=8}invalidateLayerData(t,i){this.layerInfo[i][t].invalidateSourceData(),this.restartAgents(i)}computeElevationBounds(){const t=this._elevationBoundsMin,i=this._elevationBoundsMax;let r=1/0,s=-1/0;const n=this.layerInfo[0];let a=!0;for(const o of n)o.elevationBounds!=null&&(r=Math.min(r,o.elevationBounds.min),s=Math.max(s,o.elevationBounds.max),o.elevationBounds.hasNoDataValues||(a=!1));a&&(r=Math.min(r,0),s=Math.max(s,0)),t===r&&i===s||(this._elevationBoundsMin=r,this._elevationBoundsMax=s,this.updateRadiusAndCenter(),this._surface.setTileTreeDirty())}_updateCenter(){const t=this._elevationBoundsMin,i=this._elevationBoundsMax,r=.5*(t+i),s=this._center;te(Oi,this.up,r),W2(s[1],ce(ZG,this.centerAtSeaLevel,Oi)),te(Oi,this.up,t),ce(s[0],this.centerAtSeaLevel,Oi),te(Oi,this.up,i),ce(s[2],this.centerAtSeaLevel,Oi)}findElevationBoundsForLayer(t,i){const r=this.layerInfo[0][t],s=this.elevationLevelDelta,n=Math.max(this.elevationLevel-s,0),a=r.elevationBounds;if(a!=null&&a.level>=i&&a.level<=n)return;const o=this._surface.layerViewByIndex(t,0);if(!Kl(this,o))return;const l=$G;let c=!1;const u=r.data;if(u&&u.level<=n){const p=r.data;l.min=p.samplerData.data.minValue,l.max=p.samplerData.data.maxValue,l.hasNoDataValues=p.samplerData.data.hasNoDataValues,l.level=this.level,c=!0}else{let p,m,f=0;for(let g=this._parent;g&&(!m||f<s)&&(f=this.elevationLevel-g.level,p=m||p,m=g.layerInfo[0][t].data,!(!m&&p&&g.level<=n));g=g.parent);m=m||p,m&&(m.computeMinMaxValue(this._lij[0],this._lij[1],this._lij[2],l),l.min!==1/0&&(l.level=m.level,c=!0))}c&&(r.elevationBounds==null&&(r.elevationBounds=new Vh),r.elevationBounds.copyFrom(l))}modifyLayers(t,i,r){const s=this.layerInfo[r];for(const o of s)o.loadingAgent&&o.loadingAgent!==Nr&&(nf(o.loadingAgent),o.loadingAgent=null),o.waitingAgents.clear();for(let o=0;o<s.length;++o)t[o]===void 0&&s[o].release();const n=new Array(...s),a=i.length;s.length=a;for(let o=0;o<a;o++){const l=i[o];s[o]=l>-1?n[l]:cg.acquire(this._surface.upsampleInfoPool)}this.setMemoryDirty()}restartAgents(t){this.renderData&&(this._createOrUpdateAgents(0,t),this.updateRenderData(t,0))}updateAgents(t){if(this.renderData){const i=this.layerInfo[t];for(const r of i)r.loadingAgent===Nr&&(r.loadingAgent=null);this._createOrUpdateAgents(0,t)}}updateAgentSuspension(){for(const t of gh){const i=this._isSuspended(t);for(const r of this.layerInfo[t])r.loadingAgent&&r.loadingAgent!==Nr&&(r.loadingAgent.setSuspension(i),r.loadingAgent===Nr&&this.updateRenderData(t,0))}}removeLayerAgent(t,i){const r=this.layerInfo[i][t];r.loadingAgent&&r.loadingAgent!==Nr&&r.loadingAgent.dispose(),r.loadingAgent=null}agentDone(t,i){const r=this.layerInfo[i][t];r.loadingAgent=Nr,r.data||r.upsampleInfo!=null||this._createOrUpdateAgents(t+1,i)}_hasBlendableAncestor(t){return t.blendMode!=="normal"||Kh(t.parent)&&this._hasBlendableAncestor(t.parent)}_hasBlendModes(t,i,r){for(let s=t;s<i;++s){const n=this._surface.layerViewByIndex(s,r);if(Op(n)&&n?.layer?.blendMode!=="normal"||Kh(n?.layer?.parent)&&this._hasBlendableAncestor(n?.layer?.parent))return!0}return!1}_createOrUpdateAgents(t,i){const r=this.layerInfo[i];if(r.length===0)return;const s=this._isSuspended(i);for(let n=t;n<r.length;++n){const a=r[n],o=this._surface.layerViewByIndex(n,i);let l=!1;if(a.loadingAgent?Kl(this,o)?(a.loadingAgent!==Nr&&a.loadingAgent.setSuspension(s),a.loadingAgent!==Nr&&(l=a.loadingAgent.update())):a.dispose():Kl(this,o)&&(a.loadingAgent=GG(this,n,i,s),l=a.loadingAgent.startLoading(),l?a.loadingAgent===Nr&&this.setPendingUpdate(8):(nf(a.loadingAgent),a.loadingAgent=Nr)),a.loadingAgent===Nr&&this.updateRenderData(i,0),!o.destroyed&&!this._hasBlendModes(t,r.length,i)&&l&&o.isOpaque)return}}_isWithinExtent(t){const i=this.extent;return i[0]>=t[0]&&t[2]>=i[2]&&i[1]>=t[1]&&t[3]>=i[3]}intersectsExtent(t){const i=this.extent;return i[2]>=t[0]&&t[2]>=i[0]&&i[3]>=t[1]&&t[3]>=i[1]}getElevationVerticesPerSide(t){const i=this.elevationLevel-this.level,r=Math.max(this.level-t,this.elevationLevelDelta-i),s=j(1+(this._maxTesselation>>r),2,this._maxTesselation+1),n=this.minimumVerticesPerSide;return Math.max(s,n)}_findLIJ(t,i){if(!t)return null;const r=this.surface.rootTiles;if(r!=null){for(const s of r)if(WG(s,t)){let n=s,a=t[0]-n.level-1;for(;a>=0&&!n.leaf&&!i(n);){const o=t[1]>>a&1,l=t[2]>>a&1;n=n.children[2*o+l],a--}return i(n)?n:null}}return null}findNeighborTile(t,i){const r=this._lij,s=this._getNeighborLIJ(r,t);return s?ug(r,s)?i(this)?this:null:this._findLIJ(s,i):null}findCorner(t,i){const r=t===1?1:t===7?0:t===5?2:3;let s=this;for(;s.children[0]&&(!i||!i(s));)s=s.children[r];return s}findNeighborCornerTileExact(t,i){return this.findNeighborTile(t,r=>i(r)||r.level===this.level)?.findCorner(f_(t),i)||null}forAllSubtreeOnSide(t,i){const r=t===0?[0,1]:t===1?[1]:t===2?[1,3]:t===3?[3]:t===4?[2,3]:t===5?[2]:t===6?[0,2]:[0],s=n=>{const a=n.children;!i(n)&&a[0]&&r.forEach(o=>s(a[o]))};s(this)}getNeighborEdgeStartVertexIndex(t,i){if(!i)return 0;const r=this.level-i.level;if(N(!vi||r>=0),r===0)return 0;const s=2**r,n=!(1&~t),a=n?0:1,o=i.lij[a+1]*s,l=this._lij[a+1],c=l-o,u=n?s-1-c:c;return vi&&(N(o<=l&&l<o+s),N(0<=u&&u<s)),u}forEachLoadedNeighbor(t){const i=this.level,r=s=>s.level===i||s.loaded;Cn.forEach(s=>{const n=this.findNeighborTile(s,r);n!=null&&n!==this&&n.forAllSubtreeOnSide(kb(s),a=>!!a.loaded&&(t(a,s),!0))}),g_.forEach(s=>{const n=this.findNeighborTile(s,r)?.findCorner(f_(s),a=>a.loaded);N(!n||W1(this,n,s)),n?.loaded&&t(n,s)})}_getNeighborLIJ(t,i){const r=Q3(i)?-1:Z3(i)?1:0,s=$3(i)?-1:W3(i)?1:0,n=[t[0],t[1]+r,t[2]+s];return n[1]<0?null:this.surface.isGlobal?this._wrapLIJ(n):n[2]<0?null:n}_wrapLIJ(t){return!t||t[1]<0||t[1]>=2**t[0]?null:this.surface.wrapEastWest(t)}isEdgeNeighbor(t,i){if(t==null)return!1;if(this.level===0&&t.level===0&&(this._eastEnd&&t._westEnd&&i===2||this._westEnd&&t._eastEnd&&i===6))return!0;const r=Math.max(1e-6*(this.extent[2]-this.extent[0]),1);switch(i){case 0:return Vs(this.extent[3],t.extent[1],r);case 4:return Vs(this.extent[1],t.extent[3],r);case 2:return Vs(this.extent[2],t.extent[0],r)||Vs(this.extent[2],-t.extent[0],r);case 6:return Vs(this.extent[0],t.extent[2],r)||Vs(this.extent[0],-t.extent[2],r)}}get _eastEnd(){return this._lij[2]===this.surface.lijEastEnd(this.level)-1}get _westEnd(){return this._lij[2]===0}checkGeometryWaterproofness(){p_&&(N(this.loaded),this.renderData?.checkGeometryWaterproofness())}shouldHaveNeighbor(t){const i=this.extent,r=this.surface.rootTilesExtent,s=.25*(i[2]-i[0]);if(Q3(t)&&i[3]+s>=r[3]||Z3(t)&&i[1]-s<=r[1])return!1;const n=this.surface.isGlobal;return!(!n&&$3(t)&&i[0]-s<=r[0])&&!(!n&&W3(t)&&i[2]+s>=r[2])}updateDistanceToPOI(t){const i=this._lastPOI;if(this.distanceToPOI>=0&&i[0]===t[0]&&i[1]===t[1]&&i[2]===t[2])return;q(this._lastPOI,t);const r=this._center[1],s=t[0]-r[0],n=t[1]-r[1],a=t[2]-r[2];this.distanceToPOI=s*s+n*n+a*a}updateOverlayParameters(t){const{renderData:i}=this;if(!i)return;const{overlays:r,longitudeCyclical:s}=t,n=i.overlay;if(r.length===0)this._clearTileOverlayData(0,n),this._clearTileOverlayData(1,n);else{const[a,o]=r,l=this.extent;X9(a.extent,l,s)||tx(l,a.extent,s)||tx(l,o.extent,s)?(this._setOverlayData(r,s,l,0,n),this._setOverlayData(r,s,l,1,n)):(this._clearTileOverlayData(0,n),this._clearTileOverlayData(1,n))}}_setOverlayData(t,i,r,s,n){const a=t[s].extent,o=ds(a),l=Kn(a);let c=r[0];if(i){c=i.minimalMonotonic(a[0],c);const u=i.minimalMonotonic(a[0],r[2]);c>u&&(c=u-(r[2]-r[0]))}n.setScale(s,ds(r)/o,Kn(r)/l),n.setOffset(s,(c-a[0])/o,(r[1]-a[1])/l)}_clearTileOverlayData(t,i){i.setScale(t,-1,-1),i.setOffset(t,-1,-1)}}function GG(e,t,i,r){const s=i===0?Jb.acquire():Kb.acquire();return s.init(e,t,i,r),s}function nf(e){e.dispose(),kG(e)?Jb.release(e):jG(e)&&Kb.release(e)}const Kb=new Eo(()=>new NG),Jb=new Eo(()=>new zG),$G=new Vh;function WG(e,t){const i=e.lij,r=t[0]-i[0];return!(r<0)&&t[1]>>r===i[1]&&t[2]>>r===i[2]}function ug(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function W1(e,t,i){return e!=null&&t!=null&&t!==e&&(e.level>=t.level?VS(e,t,i):VS(t,e,f_(i)))}function VS(e,t,i){N(e.level>=t.level);const r=IH(i),s=LH(i),n=e.extent,a=t.extent,o=[r?n[0]:n[2],s?n[3]:n[1]],l=[r?a[2]:a[0],s?a[1]:a[3]],c=1e-5*(n[2]-n[0]),u=Vs(o[0],l[0],c)||e.surface.isGlobal&&Vs(o[0],-l[0],c),p=Vs(o[1],l[1],c);if(u&&p)return!0;if(e.level===t.level||!u&&!p)return N(!1),!1;const m=u?zS(a[1],a[3],n[1],n[3],c):zS(a[0],a[2],n[0],n[2],c);return N(m),m}function zS(e,t,i,r,s){return e-s<=i&&i<=r&&r<=t+s}const af=w(),z0=w(),k0=w(),Oi=w(),ZG=w(),QG=65536;function XG(e,t){const{tile:i,geometry:r,geometryState:s}=e,{extentInRadians:n,surface:a}=i,{isWebMercator:o,renderer:l}=a,{numVerticesPerSide:c,wireframe:u}=s,p=c-1,m=(c-2)**2,f=o&&(t===2||t===3),g=o&&(t===1||t===3),y=((f?1:0)+(g?1:0))*dg*c,v=JO(s),C=m+y+4*v,b=l.tileGeometryCache.acquire(C);r.numVerticesPerSide=c,r.vertexAttributes=b,r.maxEdgeVertexCount=v;const{boundingBox:S}=r;Gs(S);const x=tw(e);Ei.update(p,n,x),KG(e),r.poleVerticesStartIndex=m;const T=YG(e,f,g);r.edgeVerticesStartIndex=m+y,rw(e),ew(e),GO(r,T,u),e.intersectionData=null}function YG(e,t,i){const{tile:r,localOrigin:s,geometry:n}=e,{extent:a,ellipsoid:o}=r,{boundingBox:l,numVerticesPerSide:c,vertexAttributes:u,poleVerticesStartIndex:p}=n,m=c-1,f=s[0],g=s[1],y=s[2],v=o.radius,C=a[1],b=a[3],S=[];let x=p;const T=(P,R)=>{const O=R*c;Ns(-f,-g,P*v-y,l),S.push(new g$(P===1,O,P===1?0:2,x,dg));const E=jO(P===-1?C:b,v),A=P*Math.PI/2-E,F=.99*(P===1?1:-1),L=v+0,{position:H,uv0:V}=u,{typedBuffer:I,typedBufferStride:B}=u.normalCompressed;for(let ee=1;ee<=dg;++ee){const G=E+A*(ee/dg),be=Math.cos(G),ae=Math.sin(G);for(let Xe=0;Xe<=m;Xe++){const se=Xe/m,Re=Ei.sinLonLUT[Xe],Pe=Ei.cosLonLUT[Xe]*be,Ae=Re*be,Dt=ae,Bt=Pe*L-f,Fe=Ae*L-g,et=Dt*L-y;Ns(Bt,Fe,et,l),H.setValues(x,Bt,Fe,et),V.setValues(x,Math.round(se*pi),Math.round(F*pi)),vp(I,x,Pe,Ae,Dt,B),++x}}};return t&&T(-1,0),i&&T(1,m),S}function KG(e){const{tile:t}=e;if(!t.intersectsClippingArea)return;const{geometry:i,geometryState:r,localOrigin:s}=e,{numVerticesPerSide:n,samplerData:a}=r,o=n-2,l=n-1,{vertexAttributes:c,boundingBox:u}=i,{position:p,uv0:m}=c,{typedBuffer:f,typedBufferStride:g}=c.normalCompressed,{extent:y}=t,v=y[0],C=y[2],b=y[1],S=y[3],x=t.ellipsoid.radius,T=s[0],P=s[1],R=s[2],O=p.typedBuffer,E=p.typedBufferStride,A=1/l;let F=0;if(1<=o){const L=A,H=b*(1-L)+S*L,V=Ei.sinLatLUT[1],I=Ei.cosLatLUT[1];for(let B=1;B<=o;B++){const ee=B*A,G=v*(1-ee)+C*ee,be=Ei.sinLonLUT[B],ae=Ei.cosLonLUT[B],Xe=x+zt(G,H,a),se=Xe*ae*I-T,Re=Xe*be*I-P,Pe=Xe*V-R;Ns(se,Re,Pe,u);const Ae=(B-1)*E;O[Ae]=se,O[Ae+1]=Re,O[Ae+2]=Pe,m.setValues(B-1,Math.round(ee*pi),Math.round(L*pi))}}for(let L=1;L<=o;L++){const H=L*A,V=b*(1-H)+S*H,I=Ei.sinLatLUT[L],B=Ei.cosLatLUT[L],ee=L+1,G=ee*A,be=b*(1-G)+S*G,ae=Ei.sinLatLUT[ee],Xe=Ei.cosLatLUT[ee],se=Ei.sinLonLUT[0],Re=Ei.cosLonLUT[0],Pe=x+zt(v,V,a);let Ae=Re*B*Pe-T,Dt=se*B*Pe-P,Bt=I*Pe-R;const Fe=F*E;let et=O[Fe],je=O[Fe+1],we=O[Fe+2];for(let Ke=1;Ke<=o;Ke++){const nt=Ke*A,Y=v*(1-nt)+C*nt,W=Ei.sinLonLUT[Ke],U=Ei.cosLonLUT[Ke];let pe=0,Me=0,Te=0;if(Ke<o){const _t=(F+1)*E;pe=O[_t],Me=O[_t+1],Te=O[_t+2]}else{const _t=Ei.sinLonLUT[l],$t=Ei.cosLonLUT[l],ti=x+zt(C,V,a);pe=$t*B*ti-T,Me=_t*B*ti-P,Te=I*ti-R}const Ue=Ae,he=Dt,K=Bt;Ae=et,Dt=je,Bt=we,et=pe,je=Me,we=Te;const J=pe-Ue,Ce=Me-he,ke=Te-K;let Tt=0,Pt=0,at=0;if(L>1){const _t=(F-o)*E;Tt=O[_t],Pt=O[_t+1],at=O[_t+2]}else{const _t=Ei.sinLatLUT[0],$t=Ei.cosLatLUT[0],ti=x+zt(Y,b,a);Tt=U*$t*ti-T,Pt=W*$t*ti-P,at=_t*ti-R}const dt=x+zt(Y,be,a),xt=U*Xe*dt-T,Ze=W*Xe*dt-P,Ye=ae*dt-R;if(L<o){const _t=F+o,$t=_t*E;O[$t]=xt,O[$t+1]=Ze,O[$t+2]=Ye,Ns(xt,Ze,Ye,u),m.setValues(_t,Math.round(nt*pi),Math.round(G*pi))}const ve=Tt-xt,Je=Pt-Ze,Be=at-Ye;let pt=U*B,mt=W*B,It=I;It*It<.999&&(pt=ke*Je-Ce*Be,mt=J*Be-ke*ve,It=Ce*ve-J*Je);const ft=1/Math.sqrt(pt*pt+mt*mt+It*It);vp(f,F,pt*ft,mt*ft,It*ft,g),++F}}}function JG(e){e.tile.intersectsClippingArea&&(ew(e),Cu(e),e.intersectionData=null)}function e$(e){e.tile.intersectsClippingArea&&(ZO(e),ew(e),Cu(e),YO(e),e.intersectionData=null)}function t$(e){e.tile.intersectsClippingArea&&(NO(e),BO(e,!0),Cu(e),e.intersectionData=null)}function ew(e){e.tile.intersectsClippingArea&&(NO(e),BO(e))}function BO(e,t=!1){const{geometry:i,geometryState:r,tile:s,localOrigin:n}=e,{level:a,extent:o,extentInRadians:l,ellipsoid:c}=s,u=c.radius,p=l[0],m=l[2],f=l[1],g=l[3],{samplerData:y}=r,v=o[0],C=o[2],b=o[1],S=o[3],x=tw(e),{boundingBox:T,vertexAttributes:P}=i,R=n[0],O=n[1],E=n[2],{position:A,uv0:F}=P,L=A.typedBuffer,H=A.typedBufferStride;for(let V=0;V<4;++V){const I=V===1||V===3,B=r.edgeResolutions[V];N(nc(B));const ee=B+1,G=zl(s,r.edgePeerNeighbors[V]);if(KO(s,G,V)){QO(e,V,G);continue}const be=G!=null;N(!be||G.level===s.level),N(!be||ta(s,G)<=0);const ae=G?.renderData,Xe=ae?.geometryState;if(vi){const J=s.surface;if(!G&&J&&!J.updatingRootTiles){const Ce=Cn[V],ke=s.findNeighborTile(Ce,Tt=>Tt.loaded||Tt.leaf||Tt.level===s.level);ke?ke.intersectsClippingArea&&(N(!ke.loaded),N(!ke.leaf),N(ke.level===a)):N(J?.rootTiles==null||!s.shouldHaveNeighbor(Ce))}}const se=V===1?o[2]:o[0],Re=G?.extent,Pe=Re&&I?V===1?Re[0]:Re[2]:se,Ae=V===0?o[3]:o[1],Dt=V===1?1:0,Bt=V===0?1:0,Fe=V===1?m:p,et=V===0?g:f,je=Math.sin(Fe),we=Math.cos(Fe),Ke=Math.sin(et),nt=Math.cos(et),Y=Xe?.samplerData,W=be?(J,Ce,ke)=>.5*(zt(J,Ce,y)+zt(ke,Ce,Y)):(J,Ce,ke)=>zt(J,Ce,y),U=i.outerEdgesOffsetAndLength[2*V+0],pe=t&&ee>3?ee-3:1,Me=y!=null&&y.some(J=>J!=null),Te=Y!=null&&Y.some(J=>J!=null),Ue=Me||Te,he=1/B,K=U;N(!Re||Vs(Re[2]-Re[0],o[2]-o[0])),(()=>{const J=V===1?-1:V===3?1:0,Ce=V===0?-1:V===2?1:0,ke=(o[2]-o[0])*he,Tt=J*ke,Pt=Ce*ke,at=I?J*((m-p)*he):0,dt=I?0:Ce*he,xt=Bt,Ze=I?Fe+at:Fe,Ye=I?Math.sin(Ze):je,ve=I?Math.cos(Ze):we,Je=I?Fe-at:Fe,Be=I?Math.sin(Je):je,pt=I?Math.cos(Je):we,mt=I?et:x(xt+dt),It=I?Ke:Math.sin(mt),ft=I?nt:Math.cos(mt),_t=I?et:x(xt-dt),$t=I?Ke:Math.sin(_t),ti=I?nt:Math.cos(_t);let Zi=0,Jr=0,ur=0;{const tt=0*he,oi=I?se:v*(1-tt)+C*tt,ii=I?Pe:oi,Vi=I?b*(1-tt)+S*tt:Ae,Ri=I?Fe:p*(1-tt)+m*tt,ua=I?je:Math.sin(Ri),Zs=I?we:Math.cos(Ri),Fr=I?x(tt):et,Qs=I?Math.sin(Fr):Ke,Vr=I?Math.cos(Fr):nt,dr=u+W(oi,Vi,ii);Zi=Zs*Vr*dr,Jr=ua*Vr*dr,ur=Qs*dr}let es=0,Ji=0,Ci=0;{const tt=1*he,oi=I?se:v*(1-tt)+C*tt,ii=I?Pe:oi,Vi=I?b*(1-tt)+S*tt:Ae,Ri=I?Fe:p*(1-tt)+m*tt,ua=I?je:Math.sin(Ri),Zs=I?we:Math.cos(Ri),Fr=I?x(tt):et,Qs=I?Math.sin(Fr):Ke,Vr=I?Math.cos(Fr):nt,dr=u+W(oi,Vi,ii);es=Zs*Vr*dr,Ji=ua*Vr*dr,Ci=Qs*dr}for(let tt=1;tt<ee-1;tt+=pe){let oi=0,ii=0,Vi=0;{const zr=(tt+1)*he,On=I?se:v*(1-zr)+C*zr,to=I?Pe:On,er=I?b*(1-zr)+S*zr:Ae,io=I?Fe:p*(1-zr)+m*zr,xc=I?je:Math.sin(io),Cc=I?we:Math.cos(io),Qo=I?x(zr):et,tm=I?Math.sin(Qo):Ke,Mu=I?Math.cos(Qo):nt,Sc=u+W(On,er,to);oi=Cc*Mu*Sc,ii=xc*Mu*Sc,Vi=tm*Sc}const Ri=oi,ua=ii,Zs=Vi,Fr=es,Qs=Ji,Vr=Ci;es=Ri,Ji=ua,Ci=Zs;{const zr=K+tt,On=zr*H,to=Fr-R,er=Qs-O,io=Vr-E;L[On]=to,L[On+1]=er,L[On+2]=io,Ns(to,er,io,T);const xc=tt*he,Cc=I?Dt:xc,Qo=I?xc:Bt;F.setValues(zr,Math.round(Cc*pi),Math.round(Qo*pi))}const dr=Zi,J5=Jr,eA=ur;Zi=Fr,Jr=Qs,ur=Vr;const Tu=Fr,Pu=Qs,yc=Vr,em=1/Math.sqrt(Tu*Tu+Pu*Pu+yc*yc),Pw=yc*em;let vc=0,bc=0,wc=0;if(Ue&&Pw*Pw<.999){let zr=0,On=0,to=0;{const er=V===0?-1:1;zr=er*(Ri-dr),On=er*(ua-J5),to=er*(Zs-eA)}{const er=tt*he,io=I?se:v*(1-er)+C*er,xc=I?Pe:io,Cc=I?b*(1-er)+S*er:Ae,Qo=I?Fe:p*(1-er)+m*er,tm=I?je:Math.sin(Qo),Mu=I?we:Math.cos(Qo),Sc=I?x(er):et,Mw=I?Math.sin(Sc):Ke,Rw=I?Math.cos(Sc):nt;let ry=Tu,sy=Pu,ny=yc;if(be){const Xo=u+zt(xc-Tt,Cc-Pt,Y),Ru=I?Rw:ti;ry=(I?pt:Mu)*Ru*Xo,sy=(I?Be:tm)*Ru*Xo,ny=(I?Mw:$t)*Xo}{const Xo=u+zt(io+Tt,Cc+Pt,y),Ru=I?Rw:ft,Dw=(I?ve:Mu)*Ru*Xo,Ow=(I?Ye:tm)*Ru*Xo,Ew=(I?Mw:It)*Xo;be||(ry=2*Tu-Dw,sy=2*Pu-Ow,ny=2*yc-Ew);const ay=V===3?-1:1,Aw=ay*(ry-Dw),Iw=ay*(sy-Ow),Lw=ay*(ny-Ew);vc=to*Iw-On*Lw,bc=zr*Lw-to*Aw,wc=On*Aw-zr*Iw;const oy=1/Math.sqrt(vc*vc+bc*bc+wc*wc);vc*=oy,bc*=oy,wc*=oy}}}else vc=Tu*em,bc=Pu*em,wc=yc*em;i.setEdgeNormalFromValues(V,tt,vc,bc,wc)}})()}}function NO(e){XO(e)}function jO(e,t){return Math.PI/2-2*Math.atan(Math.exp(-e/t))}function i$(e,t,i,r){return jO(e*(1-r)+t*r,i)}function r$(e,t,i){return e*(1-i)+t*i}function tw(e){const{tile:t}=e;if(t.surface.isWebMercator){const r=t.extent,s=t.ellipsoid.radius;return n=>i$(r[1],r[3],s,n)}const i=t.extentInRadians;return r=>r$(i[1],i[3],r)}function s$(e,t){const{tile:i,geometryState:r,geometry:s}=e,{extent:n,surface:a}=i,{wireframe:o}=r,l=n[0],c=n[1],u=n[2]-l,p=n[3]-c,{numVerticesPerSide:m,clippingArea:f}=r,g=f!=null?Math.max(0,(f[0]-l)/u):0,y=f!=null?Math.max(0,(f[1]-c)/p):0,v=f!=null?Math.min(1,(f[2]-l)/u):1,C=f!=null?Math.min(1,(f[3]-c)/p):1,b=(m-2)**2,S=JO(r),x=b+4*S,T=a.renderer.tileGeometryCache.acquire(x),{boundingBox:P}=s;Gs(P),s.numVerticesPerSide=m,s.vertexAttributes=T,s.maxEdgeVertexCount=S,s.minu=g,s.minv=y,s.maxu=v,s.maxv=C,n$(e),s.edgeVerticesStartIndex=b,rw(e),iw(e),GO(s,[],o),e.intersectionData=null}function n$(e){const t=e.tile;if(!t.intersectsClippingArea)return;const{geometry:i,geometryState:r,localOrigin:s}=e,{samplerData:n,clippingArea:a,numVerticesPerSide:o}=r,{surface:l,extent:c,ellipsoid:u}=t,{isWebMercatorOnPlateCarree:p}=l,m=a??sw,f=c[0],g=c[1],y=c[2],v=c[3],C=Math.max(f,m[0]),b=Math.min(y,m[2]),S=Math.max(g,m[1]),x=Math.min(v,m[3]),T=u.radius,P=t.horizontalScale,R=o-1,O=o-2,{minu:E,minv:A,maxu:F,maxv:L,boundingBox:H,vertexAttributes:V}=i,{position:I,uv0:B}=V,{typedBuffer:ee,typedBufferStride:G}=V.normalCompressed,be=s[0],ae=s[1],Xe=s[2],se=I.typedBuffer,Re=I.typedBufferStride;let Pe=0;const Ae=j(g,S,x),Dt=p?(Math.PI/2-2*Math.atan(Math.exp(-Ae/T)))*T:Ae*P,Bt=1/R,Fe=j(g*(1-Bt)+v*Bt,S,x);let et=Dt,je=p?(Math.PI/2-2*Math.atan(Math.exp(-Fe/T)))*T:Fe*P;for(let we=1;we<=O;we++){const Ke=we/R,nt=j(g*(1-Ke)+v*Ke,S,x),Y=j(Ke,A,L),W=je,U=(we-1)/R,pe=j(g*(1-U)+v*U,S,x),Me=et,Te=(we+1)/R,Ue=j(g*(1-Te)+v*Te,S,x),he=p?(Math.PI/2-2*Math.atan(Math.exp(-Ue/T)))*T:Ue*P,K=j(Te,A,L);et=je,je=he;const J=j(f,C,b);let Ce=J*P,ke=zt(J,nt,n);const Tt=1/R,Pt=j(Tt,E,F),at=j(f*(1-Pt)+y*Pt,C,b);let dt=Pt,xt=at,Ze=at*P,Ye=zt(at,nt,n);if(we===1){const ve=Ze-be,Je=et-ae,Be=Ye-Xe,pt=0*Re;se[pt]=ve,se[pt+1]=Je,se[pt+2]=Be,Ns(ve,Je,Be,H);const mt=j(Tt,E,F);B.setValues(Pe,Math.round(mt*pi),Math.round(Y*pi))}for(let ve=1;ve<=O;ve++){const Je=Ze,Be=Ye,pt=(ve+1)/R,mt=j(pt,E,F),It=j(f*(1-pt)+y*pt,C,b),ft=xt;xt=It;{const Ji=Pe+1,Ci=Ji*Re;if(we===1||ve===O){const tt=It*P,oi=zt(It,nt,n);if(we===1&&ve<O){const ii=tt-be,Vi=W-ae,Ri=oi-Xe;se[Ci]=ii,se[Ci+1]=Vi,se[Ci+2]=Ri,Ns(ii,Vi,Ri,H),B.setValues(Ji,Math.round(mt*pi),Math.round(Y*pi))}Ze=tt,Ye=oi}else Ze=se[Ci]+be,Ye=se[Ci+2]+Xe}const _t=Ze,$t=Ye,ti=Ce,Zi=ke;Ce=Je,ke=Be;const Jr=(Pe-O)*Re,ur=we===1?zt(ft,pe,n):se[Jr+2]+Xe,es=zt(ft,Ue,n);if(we<O){const Ji=Pe+O,Ci=Ji*Re,tt=Je-be,oi=he-ae,ii=es-Xe;se[Ci]=tt,se[Ci+1]=oi,se[Ci+2]=ii,Ns(tt,oi,ii,H);const Vi=dt;dt=mt,B.setValues(Ji,Math.round(Vi*pi),Math.round(K*pi))}{const Ji=_t-ti,Ci=Me-he,tt=Ci*($t-Zi),oi=Ji*(ur-es),ii=-Ci*Ji,Vi=tt*tt+oi*oi+ii*ii;if(Vi===0)vp(ee,Pe,0,0,1,G);else{const Ri=1/Math.sqrt(Vi);vp(ee,Pe,tt*Ri,oi*Ri,ii*Ri,G)}}++Pe}}}function a$(e,t){e.tile.intersectsClippingArea&&(HO(e),UO(e,!0),Cu(e),e.intersectionData=null)}function o$(e,t){e.tile.intersectsClippingArea&&(ZO(e),iw(e),Cu(e),YO(e),e.intersectionData=null)}function l$(e,t){e.tile.intersectsClippingArea&&(iw(e),Cu(e),e.intersectionData=null)}function iw(e,t){e.tile.intersectsClippingArea&&(HO(e),UO(e,!1))}function UO(e,t){const{geometry:i,geometryState:r,localOrigin:s}=e,n=e.tile,{surface:a,extent:o}=n,{clippingArea:l,samplerData:c}=r,u=l??sw,p=o[0],m=o[2],f=o[1],g=o[3],y=[g>u[3],m>u[2],f<u[1],p<u[0]],v=n.horizontalScale,C=qO(a.isWebMercatorOnPlateCarree,n.ellipsoid.radius,v),{minu:b,minv:S,maxu:x,maxv:T,boundingBox:P}=i,R=Math.max(p,u[0]),O=Math.min(m,u[2]),E=Math.max(f,u[1]),A=Math.min(g,u[3]),F=s[0],L=s[1],H=s[2];for(let V=0;V<4;++V){const I=V===1||V===3,B=r.edgeResolutions[V];N(nc(B));const ee=B+1,G=y[V],be=zl(n,r.edgePeerNeighbors[V]);if(!G&&KO(n,be,V)){QO(e,V,be);continue}const ae=be!=null&&!G,Xe=be?.renderData,se=Xe?.geometryState;if(vi&&(N(!ae||be.level===n.level),N(!ae||ta(n,be)<=0),n&&!be&&!a.updatingRootTiles)){const he=Cn[V],K=n.findNeighborTile(he,J=>J.loaded||J.leaf||J.level===n.level);a.updatingRootTiles||(K?K.intersectsClippingArea&&(N(!K.loaded),N(!K.leaf),N(K.level===n.level)):N(a?.rootTiles==null||!n.shouldHaveNeighbor(he)))}const Re=j(V===1?m:p,R,O),Pe=j(V===0?g:f,E,A),Ae=se?.samplerData,Dt=t&&ee>3?ee-3:1,Bt=j(V===1?1:0,b,x),Fe=j(V===0?1:0,S,T),et=ae?(he,K)=>.5*(zt(he,K,Ae)+zt(he,K,c)):(he,K)=>zt(he,K,c),je=(m-p)/B,we=I?V===1?je:-je:0,Ke=I?0:V===0?je:-je,nt=-we,Y=-Ke;let W=0,U=0,pe=0;{const he=0/B,K=I?Re:j(p*(1-he)+m*he,R,O),J=I?j(f*(1-he)+g*he,E,A):Pe,Ce=et(K,J);W=K*v,U=C(J),pe=Ce}let Me=0,Te=0,Ue=0;{const he=1/B,K=I?Re:j(p*(1-he)+m*he,R,O),J=I?j(f*(1-he)+g*he,E,A):Pe,Ce=et(K,J);Me=K*v,Te=C(J),Ue=Ce}for(let he=1;he<ee-1;he+=Dt){const K=he/B,J=Me,Ce=Te,ke=Ue;{const Be=I?Bt:j(K,b,x),pt=I?j(K,S,T):Fe,mt=J-F,It=Ce-L,ft=ke-H;Ns(J,It,ft,P),i.setEdgeVertexFromValuesRawPositionUV(V,he,mt,It,ft,Be,pt)}{const Be=(he+1)/B,pt=I?Re:j(p*(1-Be)+m*Be,R,O),mt=I?j(f*(1-Be)+g*Be,E,A):Pe,It=et(pt,mt);Me=pt*v,Te=C(mt),Ue=It}const Tt=Me,Pt=Ue,at=W,dt=U,xt=pe;W=J,U=Ce,pe=ke;let Ze=0,Ye=0,ve=0;if(I){const Be=Te-Ce,pt=Pt-ke,mt=dt-Ce,It=xt-ke,ft=j(f*(1-K)+g*K,E,A),_t=Re+nt,$t=_t*v-J,ti=zt(_t,ft,c)-ke,Zi=V===3?-1:1;if(Ze=Zi*(-mt+Be)*ti,Ye=Zi*$t*(-It+pt),ve=-Zi*$t*(-mt+Be),ae){const Jr=Re+we,ur=Jr*v-J;Ze=(-mt+Be)*(ti-(zt(Jr,ft,Ae)-ke)),Ye=($t-ur)*(-It+pt),ve=-($t-ur)*(-mt+Be)}}else{const Be=Tt-J,pt=Pt-ke,mt=at-J,It=xt-ke,ft=j(p*(1-K)+m*K,R,O),_t=Pe+Y,$t=zt(ft,_t,c)-ke,ti=C(_t)-Ce,Zi=V===2?-1:1;if(Ze=Zi*ti*(-It+pt),Ye=Zi*(-mt+Be)*$t,ve=-Zi*ti*(-mt+Be),ae){const Jr=ft,ur=Pe+Ke,es=C(ur)-Ce;Ze=(-ti+es)*(-It+pt),Ye=(-mt+Be)*(-$t+(zt(Jr,ur,Ae)-ke)),ve=-(-ti+es)*(-mt+Be)}}const Je=1/Math.sqrt(Ze*Ze+Ye*Ye+ve*ve);i.setEdgeNormalFromValues(V,he,Ze*Je,Ye*Je,ve*Je)}}}function HO(e,t){XO(e)}function c$(e,t){return(Math.PI/2-2*Math.atan(Math.exp(-e/t)))*t}function h$(e,t){return e*t}function qO(e,t,i){return e?r=>c$(r,t):r=>h$(r,i)}function GO(e,t,i){const{numVerticesPerSide:r,vertexAttributes:s,maxEdgeVertexCount:n}=e,a=r-1,o=s.count,l=2*(r-3)*(r-3),c=4*(a+n-3),u=Qb.reduce((y,v)=>y+(a+e.getEdgeCount(v)-3),0),p=t.reduce((y,v)=>y+a*(2*(v.latitudeResolution-1)+1),0),m=3*(i?2:1),f=(l+c+p)*m,g=o>=QG?new Uint32Array(f):new Uint16Array(f);for(let y=0;y<f;++y)g[y]=0;e.indices=g,e.indexCount=(l+u+p)*m,e.poleIndicesStartIndex=l*m,e.edgeIndicesStartIndex=(l+p)*m,i?(p$(e),m$(e,t),WO(e)):(u$(e),d$(e,t),$O(e))}function u$(e){const{numVerticesPerSide:t,indices:i,vertexAttributes:r}=e,{position:s}=r,{typedBuffer:n,typedBufferStride:a}=s,o=t-2,l=t-3,c=0,u=t-3;let p=0;for(let m=0;m<l;++m){const f=m*o;for(let g=c;g<u;++g){const y=f+g,v=y+1,C=v+o,b=C-1;eE(y,v,C,b,a,n)?(i[p]=y,i[p+1]=v,i[p+2]=C,i[p+3]=C,i[p+4]=b,i[p+5]=y):(i[p]=y,i[p+1]=v,i[p+2]=b,i[p+3]=b,i[p+4]=v,i[p+5]=C),p+=6}}}function d$(e,t){const{numVerticesPerSide:i,indices:r,poleIndicesStartIndex:s}=e,n=i-1;let a=s;for(const o of t){const l=o.isNorth?1:2,c=o.isNorth?2:1,u=o.isNorth?3:4,p=o.isNorth?4:3;let m=e.getEdgeVertexIndex(o.connectedOuterEdgeOffset,0),f=1;for(let g=0;g<o.latitudeResolution;++g){const y=g===0?o.rowOffset:m+i;for(let v=0;v<n;v++){const C=y+v;r[a]=m,r[a+l]=m+1,r[a+c]=C,g<o.latitudeResolution-1?(r[a+u]=m+1,r[a+p]=C+1,r[a+5]=C,a+=6):a+=3,m+=f}m=y,f=1}}}function $O(e){const{indices:t,numVerticesPerSide:i,edgeIndicesStartIndex:r}=e,s=i-1,n=s-2;let a=r;for(let o=0;o<4;++o){const l=nw[o];let c=0,u=0;const p=e.getEdgeCount(o),m=l.count;N(m===s-1);const f=o===1||o===2,g=f?1:2,y=f?2:1,v=e.getEdgeFirstVertexIndex(o),C=1,b=l.vertex0Index,S=l.stride;for(;c<p-1||u<m-1;){const x=b+u*S,T=v+c*C,P=c<p-1,R=u<m-1,O=P&&(!R||(P?0+s*(c+.5)/(p-1):0)<=(R?1+n*(u+.5)/(m-1):0));O?++c:++u;const E=O?T+C:x+S;t[a]=x,t[a+g]=T,t[a+y]=E,a+=3}}e.indexCount=a}function p$(e){const{indices:t,numVerticesPerSide:i,vertexAttributes:r}=e,{position:s}=r,{typedBuffer:n,typedBufferStride:a}=s,o=i-2;let l=0;for(let c=0;c<i-3;++c){const u=c*o;for(let p=0;p<i-3;++p){const m=c*o+p,f=m+1,g=f+o,y=g-1,v=u+p,C=v+1,b=C+o;eE(v,C,b,b-1,a,n)?(kh(t,l,m,f,g),l+=6,kh(t,l,g,y,m)):(kh(t,l,m,f,y),l+=6,kh(t,l,y,g,f)),l+=6}}}function m$(e,t){const{indices:i,numVerticesPerSide:r,poleIndicesStartIndex:s}=e,n=r-1;let a=s;for(const o of t){const l=o.connectedOuterEdgeOffset;let c=e.getEdgeVertexIndex(l,0),u=1;for(let p=0;p<o.latitudeResolution;++p){const m=p===0?o.rowOffset:c+r;for(let f=0;f<n;f++)kh(i,a,c,c+1,m+f),a+=6,p<o.latitudeResolution-1&&(kh(i,a,c+1,m+f+1,m+f),a+=6),c+=u;c=m,u=1}}}function WO(e){const{indices:t,numVerticesPerSide:i,edgeIndicesStartIndex:r}=e,s=i-1,n=s-2;let a=r;for(let o=0;o<4;++o){const l=nw[o];let c=0,u=0;const p=e.getEdgeCount(o),m=l.count;N(m===s-1);const f=o===1||o===2,g=f?1:3,y=f?3:1,v=e.getEdgeFirstVertexIndex(o),C=1,b=l.vertex0Index,S=l.stride;for(;c<p-1||u<m-1;){const x=b+u*S,T=v+c*C,P=c<p-1,R=u<m-1,O=P&&(!R||(P?0+s*(c+.5)/(p-1):0)<=(R?1+n*(u+.5)/(m-1):0));O?++c:++u;const E=O?T+C:x+S;t[a]=x,t[a+g]=T,t[a+g+1]=T,t[a+y]=E,t[a+y+1]=E,t[a+5]=x,a+=6}}e.indexCount=a}function rw(e){const{geometry:t,geometryState:i}=e,{edgeResolutions:r}=i,{numVerticesPerSide:s,edgeVerticesStartIndex:n}=t,a=s-2;let o=n;for(let l=0;l<4;++l){{const c=l===0||l===2,u=(l===0?a-1:0)*a+(l===1?a-1:0),p=(c?0:1)*a+(c?1:0),m=nw[l];m.vertex0Index=u,m.stride=p,m.count=a}{const c=r[l]+1;t.outerEdgesOffsetAndLength[2*l+0]=o,t.outerEdgesOffsetAndLength[2*l+1]=c,o+=c}}}function ZO(e){rw(e),e.geometryState.wireframe?WO(e.geometry):$O(e.geometry)}function QO(e,t,i){const{geometryState:r,geometry:s,tile:n,localOrigin:a}=e,o=t===1||t===3,l=r.edgeResolutions[t];N(nc(l));const c=l+1,{boundingBox:u,minu:p,minv:m,maxu:f,maxv:g,vertexAttributes:y}=s,v=j(t===1?1:0,p,f),C=j(t===0?1:0,m,g),b=i.renderData,S=b.geometryState,x=b.geometry,T=(t+2)%4,P=x.getEdgeCount(T),R=n.getNeighborEdgeStartVertexIndex(t,i)*l,O=l*2**(n.level-i.level);N(S.edgeResolutions[T]===O),N(P-1===O);const E=b.localOrigin[0]-a[0],A=b.localOrigin[1]-a[1],F=b.localOrigin[2]-a[2],L=s.getEdgeFirstVertexIndex(t),{position:H,uv0:V}=y,I=H.typedBuffer,B=H.typedBufferStride,ee=y.normalCompressed,G=ee.typedBuffer,be=ee.typedBufferStride,ae=x.vertexAttributes,Xe=x.getEdgeFirstVertexIndex(T),se=ae.position.typedBuffer,Re=ae.position.typedBufferStride,Pe=ae.normalCompressed.typedBuffer,Ae=ae.normalCompressed.typedBufferStride;for(let Dt=1;Dt<c-1;++Dt){const Bt=L+Dt,Fe=Xe+(R+Dt),et=Bt*B,je=Fe*Re,we=se[je]+E,Ke=se[je+1]+A,nt=se[je+2]+F;I[et]=we,I[et+1]=Ke,I[et+2]=nt,Ns(we,Ke,nt,u);const Y=Bt*be,W=Fe*Ae;G[Y]=Pe[W],G[Y+1]=Pe[W+1];const U=Dt/l,pe=o?v:j(U,p,f),Me=o?j(U,m,g):C;V.setValues(Bt,Math.round(pe*pi),Math.round(Me*pi))}}function XO(e){const{geometry:t,geometryState:i,localOrigin:r}=e,{clippingArea:s,samplerData:n}=i,{minu:a,minv:o,maxu:l,maxv:c,boundingBox:u,vertexAttributes:p}=t,m=e.tile,{surface:f,ellipsoid:g,extent:y,extentInRadians:v,horizontalScale:C}=m,b=f.view?.viewingMode==="local",S=g.radius;let x=0,T=0,P=0;const R=(Y,W,U)=>{const pe=v[W===0?1:3],Me=v[Y===0?0:2],Te=Math.cos(pe),Ue=Math.sin(pe),he=Math.sin(Me),K=Math.cos(Me),J=S+U;x=K*Te*J,T=he*Te*J,P=Ue*J},O=b?(()=>{const Y=s,W=Y!=null&&(y[3]>Y[3]||y[2]>Y[2]||y[1]<Y[1]||y[0]<Y[0]),U=qO(f.isWebMercatorOnPlateCarree,S,C);return(pe,Me,Te)=>{const Ue=pe===0?y[0]:y[2],he=Me===0?y[1]:y[3],K=W?j(Ue,Y[0],Y[2]):Ue,J=W?j(he,Y[1],Y[3]):he,Ce=Te;x=K*C,T=U(J),P=Ce}})():R;let E=0,A=0,F=0,L=0,H=0,V=0,I=0,B=0,ee=0;const G=b&&f.isWebMercatorOnPlateCarree,be=(Y,W,U,pe,Me)=>{let Te=0,Ue=0,he=0;if(b){const K=W*C,J=G?(Math.PI/2-2*Math.atan(Math.exp(-U/S)))*S:U*C;Te=K-x,Ue=J-T,he=pe-P}else{const K=tw(Y),J=Y.tile,Ce=J.extent,ke=J.extentInRadians,Tt=(W-Ce[0])/(Ce[2]-Ce[0]),Pt=(U-Ce[1])/(Ce[3]-Ce[1]),at=ke[0]*(1-Tt)+ke[2]*Tt,dt=K(Pt),xt=Math.cos(dt),Ze=Math.sin(dt),Ye=Math.sin(at),ve=Math.cos(at),Je=S+pe;Te=ve*xt*Je-x,Ue=Ye*xt*Je-T,he=Ze*Je-P}switch(Me){case 0:I+=Te,B+=Ue,ee+=he;break;case 1:L-=Te,H-=Ue,V-=he;break;case 2:I-=Te,B-=Ue,ee-=he;break;case 3:L+=Te,H+=Ue,V+=he}},ae=s??sw,Xe=y[0],se=y[2],Re=y[1],Pe=y[3],Ae=[Pe>ae[3],se>ae[2],Re<ae[1],Xe<ae[0]],Dt=Math.max(Xe,ae[0]),Bt=Math.min(se,ae[2]),Fe=Math.max(Re,ae[1]),et=Math.min(Pe,ae[3]),je=Y=>Math.max(ae[0],Math.min(ae[2],Y)),we=Y=>Math.max(ae[1],Math.min(ae[3],Y)),Ke=Y=>{const W=i.cornerNeighborCornerTiles;E=0,A=0,F=1,L=0,H=0,V=0,I=0,B=0,ee=0;let U=1/0;for(let K=0;K<4;++K){const J=W[4*Y+K];U=Math.min(U,J?.level??1/0)}for(let K=0;K<4;++K){const J=W[4*Y+K];Wu[K]=J?.level===U?J:null}let pe=1,Me=0;for(let K=0;K<4;++K){const J=Wu[K];J&&(pe=Math.max(pe,J?.renderData.geometryState.numVerticesPerSide),Me=J.extent[2]-J.extent[0])}const Te=Me,Ue=pe;N(Ue>1);const he=Te/Ue;for(let K=0;K<4;++K){const J=Wu[(K+3)%4],Ce=Wu[K%4];if(!J&&!Ce)continue;const ke=K===0?1:K===1?2:K===2?3:0,Tt=K===0?2:K===1?3:K===2?0:1;if(J&&Ce){const Pt=B0[K][0]*he,at=B0[K][1]*he,dt=J.extent,xt=je(dt[ke===0||ke===1?2:0]+Pt),Ze=we(dt[ke===0||ke===3?3:1]+at),Ye=Ce.extent,ve=je(Ye[Tt===0||Tt===1?2:0]+Pt),Je=we(Ye[Tt===0||Tt===3?3:1]+at),Be=J.renderData,pt=Ce.renderData,mt=zt(xt,Ze,Be.geometryState.samplerData),It=zt(ve,Je,pt.geometryState.samplerData);be(Be,xt,Ze,.5*(mt+It),K)}else{const Pt=J??Ce,at=J?ke:Tt,dt=Pt.extent,xt=B0[K],Ze=je(dt[at===0||at===1?2:0]+xt[0]*he),Ye=we(dt[at===0||at===3?3:1]+xt[1]*he),ve=Pt.renderData,Je=zt(Ze,Ye,ve.geometryState.samplerData);be(ve,Ze,Ye,Je,K)}}if(!b){const K=Math.sqrt(x*x+T*T+P*P);E=x/K,A=T/K,F=P/K}if(b||F*F<.999){const K=Math.sqrt(L*L+H*H+V*V);L/=K,H/=K,V/=K;const J=Math.sqrt(I*I+B*B+ee*ee);I/=J,B/=J,ee/=J,E=V*B-H*ee,A=L*ee-V*I,F=H*I-L*B;const Ce=1/Math.sqrt(E*E+A*A+F*F);E*=Ce,A*=Ce,F*=Ce}},nt=i.cornerNeighborCornerTiles;for(let Y=0;Y<4;++Y){const W=Y,U=(Y+1)%4,pe=Y===0||Y===1?1:0,Me=Y===0||Y===3?1:0,Te=j(pe,a,l),Ue=j(Me,o,c),he=t.getEdgeFirstVertexIndex(W),K=t.getEdgeCount(W),J=Y===0||Y===3?K-1:0,Ce=t.getEdgeFirstVertexIndex(U),ke=t.getEdgeCount(U),Tt=Y===0||Y===1?ke-1:0;let Pt=-1;for(let xt=0;xt<4;++xt){const Ze=nt[4*Y+xt],Ye=nt[4*Y+Pt];Ze&&(Pt===-1||ta(Ye,Ze)>0)&&(Pt=xt)}const at=Pt,dt=nt[4*Y+at];if(dt!==m){const xt=m.level-dt.level,Ze=2**xt,Ye=[dt.lij[0]+xt,dt.lij[1]*Ze,dt.lij[2]*Ze],ve=[Ye[1]+Ze===m.lij[1],Y===0&&(at===1||at===0&&dt!==nt[4*Y+3])||Y===1&&(at===0||at===1&&dt!==nt[4*Y+2]),Ye[1]===m.lij[1]+1,Y===2&&(at===3||at===2&&dt!==nt[4*Y+1])||Y===3&&(at===2||at===3&&dt!==nt[4*Y+0])],Je=ve.reduce((ft,_t)=>ft+(_t?1:0),0);N(Je===1||Je===2);let Be=-1,pt=-1;const mt=dt.renderData;if(Je===1){const ft=ve.findIndex($t=>$t);N(0<=ft&&ft<=3),Be=(ft+2)%4;const _t=i.edgeResolutions[ft];pt=m.getNeighborEdgeStartVertexIndex(ft,dt)*_t+_t*(ft===0&&Y===0||ft===1&&Y===0||ft===2&&Y===1||ft===3&&Y===3?1:0)}else{N(ve[1]||ve[3]),Be=ve[1]?3:1;const ft=mt.geometryState.edgeResolutions[Be];pt=Y===0||Y===3?0:ft}const It=mt.geometry;{const ft=he+J,_t=Ce+Tt,$t=It.getEdgeFirstVertexIndex(Be)+pt,ti=It.vertexAttributes,Zi=mt.localOrigin,Jr=ti.position,ur=Jr.typedBuffer,es=$t*Jr.typedBufferStride,Ji=ur[es]+Zi[0]-r[0],Ci=ur[es+1]+Zi[1]-r[1],tt=ur[es+2]+Zi[2]-r[2];Ns(Ji,Ci,tt,u);const oi=p.position,ii=oi.typedBuffer,Vi=ft*oi.typedBufferStride;ii[Vi]=Ji,ii[Vi+1]=Ci,ii[Vi+2]=tt;const Ri=_t*oi.typedBufferStride;ii[Ri]=Ji,ii[Ri+1]=Ci,ii[Ri+2]=tt;const ua=p.uv0;ua.setValues(ft,Math.round(Te*pi),Math.round(Ue*pi)),ua.setValues(_t,Math.round(Te*pi),Math.round(Ue*pi));{const Zs=ti.normalCompressed.typedBuffer,Fr=$t*ti.normalCompressed.typedBufferStride,Qs=p.normalCompressed,Vr=Qs.typedBuffer;{const dr=ft*Qs.typedBufferStride;Vr[dr]=Zs[Fr],Vr[dr+1]=Zs[Fr+1]}{const dr=_t*Qs.typedBufferStride;Vr[dr]=Zs[Fr],Vr[dr+1]=Zs[Fr+1]}}}}else{const xt=Ae[W],Ze=Ae[U];let Ye;if(xt||Ze){const pt=j(Xe*(1-pe)+se*pe,Dt,Bt),mt=j(Re*(1-Me)+Pe*Me,Fe,et);Ye=zt(pt,mt,n)}else Ye=f$(nt,Y);O(pe,Me,Ye),Ke(Y);const ve=x-r[0],Je=T-r[1],Be=P-r[2];Ns(ve,Je,Be,u),t.setEdgeVertexFromValuesRawPositionUVNormal(W,J,ve,Je,Be,Te,Ue,E,A,F),t.setEdgeVertexFromValuesRawPositionUVNormal(U,Tt,ve,Je,Be,Te,Ue,E,A,F)}}for(let Y=0;Y<4;++Y)Wu[Y]=null}function f$(e,t){const i=4*t,r=Qb.reduce((o,l)=>Math.min(o,e[i+l]?.level??1/0),1/0);vi&&(N(!e[i+0]||!e[i+2]||W1(e[i+0],e[i+2],5)),N(!e[i+1]||!e[i+3]||W1(e[i+1],e[i+3],7)));let s=0,n=0;for(let o=0;o<4;++o){const l=e[i+o];if(l&&l.level===r){const c=o===0||o===1,u=o===0||o===3,p=l.extent,m=p[c?0:2],f=p[u?1:3],g=l.renderData?.geometryState?.samplerData;n+=zt(m,f,g),s++}}const a=s?n/s:0;return N(a!=null),a}function Cu(e){const{vao:t,geometry:i}=e,{vertexAttributes:r,edgeVerticesStartIndex:s}=i,n=r.position.typedBuffer;t.buffer()?.setSubData(n,s,s,n.length)}function YO(e){const{vao:t,geometry:i}=e,{indices:r,indexCount:s,edgeIndicesStartIndex:n}=i;t.indexBuffer.setSubData(r,n,n,s)}class g${constructor(t,i,r,s,n){this.isNorth=t,this.connectedRowOffset=i,this.connectedOuterEdgeOffset=r,this.rowOffset=s,this.latitudeResolution=n}}const B0=[[0,1],[1,0],[0,-1],[-1,0]],Ei=new gG,sw=eI(-1/0,-1/0,1/0,1/0),Wu=[null,null,null,null];function KO(e,t,i){if(!t)return!1;const r=ta(e,t);return r>0||r===0&&i>=2}let of=class{constructor(){this.vertex0Index=0,this.stride=1,this.count=0}getVertexIndex(e){return N(0<=e&&e<this.count),this.vertex0Index+this.stride*e}};const nw=[new of,new of,new of,new of];function Ns(e,t,i,r){e<r[0]?r[0]=e:e>r[3]&&(r[3]=e),t<r[1]?r[1]=t:t>r[4]&&(r[4]=t),i<r[2]?r[2]=i:i>r[5]&&(r[5]=i)}function JO(e){const{edgeResolutions:t,numVerticesPerSide:i}=e,r=1+Math.max(...t);return Math.max(i,r)}function eE(e,t,i,r,s,n){const a=e*s,o=n[a],l=n[a+1],c=n[a+2],u=t*s,p=n[u],m=n[u+1],f=n[u+2],g=i*s,y=n[g],v=n[g+1],C=n[g+2],b=r*s,S=n[b],x=n[b+1],T=n[b+2];return(p-S)*(p-S)+(m-x)*(m-x)+(f-T)*(f-T)>(o-y)*(o-y)+(l-v)*(l-v)+(c-C)*(c-C)}function kh(e,t,i,r,s){e[t]=i,e[t+1]=r,e[t+2]=r,e[t+3]=s,e[t+4]=s,e[t+5]=i}const dg=6;let _$=class extends Yb{constructor(e,t,i,r,s){super(),this._horizontalScaleFactor=1,this._extentInRenderSR=Rt(),this._baseUsedMemory=900,this._subtreeGeometryElevationBoundMin=0,this._subtreeGeometryElevationBoundMax=0,this.init(e,t,i,r,s)}init(e,t,i,r,s){super.init(e,t,i,r,s);const n=s.view.renderSpatialReference,a=s.spatialReference,o=n!=null&&P4(n)&&a!=null&&a.isGeographic?this.ellipsoid.radius*Math.PI/180:1;this._horizontalScaleFactor=o;const{isWebMercatorOnPlateCarree:l}=s,c=this._extentInRenderSR,u=this.extent;if(l){const p=We(u[0],u[1],0);No(p,At.WebMercator,p,At.PlateCarree);const m=We(u[2],u[3],0);No(m,At.WebMercator,m,At.PlateCarree),c[0]=p[0],c[1]=p[1],c[2]=m[0],c[3]=m[1]}else for(let p=0;p<4;++p)c[p]=u[p]*o;this.centerAtSeaLevel[0]=.5*(c[0]+c[2]),this.centerAtSeaLevel[1]=.5*(c[1]+c[3]),this.centerAtSeaLevel[2]=0,this._edgeLen=Math.max(c[2]-c[0],c[3]-c[1]),this._edgeLen2=this._edgeLen*this._edgeLen,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateCenter();const e=this._extentInRenderSR,t=.5*(e[2]-e[0]),i=.5*(e[3]-e[1]),r=Math.sqrt(t*t+i*i),s=.5*(this.elevationBoundsMax-this.elevationBoundsMin),n=Math.max(r,s);this._center[1][3]=n}_calculateFrustumVisibility(e){const t=this._aabb(),i=t[0],r=t[1],s=t[2],n=t[3],a=t[4],o=t[5];let l=!0;for(let c=0;c<6;c++){const u=e[c],p=u[0],m=u[1],f=u[2],g=u[3];if(p*(p>0?i:n)+m*(m>0?r:a)+f*(f>0?s:o)+g>=0)return 2;l=l&&p*(p<0?i:n)+m*(m<0?r:a)+f*(f<0?s:o)+g<=0}return l?0:1}_aabb(){const e=this._extentInRenderSR;return HL(e[0],e[1],Math.min(this.elevationBoundsMin,this._subtreeGeometryElevationBoundMin),e[2],e[3],Math.max(this.elevationBoundsMax,this._subtreeGeometryElevationBoundMax))}intersectsRay(e,t,i,r){return lf[0]=1/t[0],lf[1]=1/t[1],lf[2]=1/t[2],t4(this._aabb(),e,lf,i,r)}createGeometry(){s$(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds(),this.setMemoryDirty()}_updateSubtreeGeometryElevationsBounds(){const e=this._subtreeGeometryElevationBoundMin,t=this._subtreeGeometryElevationBoundMax,i=this.renderData;let r=e,s=t;if(i){const n=i.geometry.boundingBox;r=n[2],s=n[5]}else if(!this.leaf){r=1/0,s=-1/0;for(const n of this.children){const a=n;r=Math.min(r,a._subtreeGeometryElevationBoundMin),s=Math.max(s,a._subtreeGeometryElevationBoundMax)}}(r!==this._subtreeGeometryElevationBoundMin||s!==this._subtreeGeometryElevationBoundMax)&&(this._subtreeGeometryElevationBoundMin=r,this._subtreeGeometryElevationBoundMax=s,this.parent?._updateSubtreeGeometryElevationsBounds())}get minimumVerticesPerSide(){return this.level<9?3:2}updateCornerElevations(){a$(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}updateEdgeElevations(){l$(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}updateEdgeElevationsAndResolutions(){o$(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}get horizontalScale(){return this._horizontalScaleFactor}};const lf=w();let y$=class{constructor(e){this.capacity=e,this._head=0,this._tail=0,this._data=new Array(e)}push(e){const t=this._tail;if(!(t<this.capacity))throw new Error("Queue full");this._data[t]=e,this._tail=t+1}pushAll(e){const t=e.length;if(t===0)return;const i=this._tail;if(!(i+t<=this.capacity))throw new Error("Queue full");for(let r=0;r<t;++r)this._data[i+r]=e[r];this._tail=i+t}pop(){const e=this._head;if(e<this._tail){const t=this._data[e];return this._head=e+1,t}}get empty(){return this._head>=this._tail}get full(){return this._tail>=this._data.length}},v$=class{constructor(){this.extent=Vt(),this.minLevel=0,this.maxLevel=0,this.callback=null}},pg=class extends ie{constructor(){super(...arguments),this._queries=new jt({initialSize:10}),this._queriesInvPtr=0,this._queryQueue=new jt({initialSize:30}),this._queryPool=new Eo(()=>new v$)}queryVisibleLevelRange(e,t,i,r){const s=this._queryPool.acquire();Zl(s.extent,e),s.minLevel=t??-Number.MAX_VALUE,s.maxLevel=i??Number.MAX_VALUE,s.callback=r,this._queryQueue.push(s),this.notifyChange("updating")}get updating(){return this._queryQueue.length!==0}prepare(){for(;this._queries.length<this._queries.data.length&&this._queryQueue.length>0;){const e=this._queryQueue.pop();this._queries.push(e)}this._queriesInvPtr=this._queries.length}process(){for(let e=0;e<this._queries.length;e++){const t=this._queries.data[e];this._queryPool.release(t),t.callback(e>=this._queriesInvPtr),t.callback=null}this._queries.clear(),this.notifyChange("updating")}queriesForTile(e){const t=e.level;let i=0;for(;i<this._queriesInvPtr;){const r=this._queries.data[i],s=r.extent;t>=r.minLevel&&t<=r.maxLevel&&s[0]<=e.extent[2]&&s[2]>=e.extent[0]&&s[1]<=e.extent[3]&&s[3]>=e.extent[1]?(this._queries.swapElements(i,this._queriesInvPtr-1),this._queriesInvPtr--):i++}}};h([d()],pg.prototype,"updating",null),pg=h([D("esri.views.3d.terrain.ScaleRangeQueries")],pg);function b$(e,t,i,r){const s=Math.cos(i);e[0]=Math.cos(t)*s*r,e[1]=Math.sin(t)*s*r,e[2]=Math.sin(i)*r}let w$=class extends Yb{constructor(e,t,i,r,s){super(),this._convexHull=new Array(24),this._boundingSphere=Kr(),this._baseUsedMemory=1816,this.init(e,t,i,r,s)}init(e,t,i,r,s){super.init(e,t,i,r,s);const n=this.ellipsoid.radius,a=this.extentInRadians[0],o=this.extentInRadians[1],l=this.extentInRadians[2],c=this.extentInRadians[3],u=De(o,c,.5),p=De(a,l,.5),m=e===0?0:Math.min(Math.abs(o),Math.abs(c));this._edgeLen=(l-a)*Math.cos(m)*n,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=n-Math.sqrt(n*n-this._edgeLen2/4),b$(this.centerAtSeaLevel,p,u,this.ellipsoid.radius),me(this.up,this.centerAtSeaLevel),this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateBoundingVolumes();const e=this._center;if(this.lij[0]===0)xL(e[1],0,0,0),xe(e[0],0,0,0),xe(e[2],0,0,0),e[1][3]=this.ellipsoid.radius+this.elevationBoundsMax;else{this._updateCenter();const t=e[1],i=this.convexHull;let r=0;const s=Gi(t);for(let n=0;n<8;++n)r=Math.max(r,x$(s,i,3*n));e[1][3]=Math.sqrt(r)}}_calculateFrustumVisibility(e){if(!eb(e,this._boundingSphere))return 2;if(this.lij[0]<10)return 1;const t=this.convexHull,i=this.surface.view.state.camera.near;let r=!0;for(let s=0;s<XL;s++){const n=s===4,a=e[s],o=a[0],l=a[1],c=a[2],u=a[3]-(n?i:0);let p=!1;for(let m=0;m<8;++m){const f=3*m;if(o*t[f]+l*t[f+1]+c*t[f+2]+u<0){if(p=!0,!r)break}else r=!1}if(!p)return 2}return r?0:1}computeElevationBounds(){super.computeElevationBounds(),this._updateBoundingVolumes()}createGeometry(){XG(this.renderData,this._getPatchType()),this._updateBoundingVolumes(),this.setMemoryDirty()}_updateBoundingVolumes(){this._updateConvexHull(),this._updateBoundingSphere(),vi&&this._checkBVs()}_updateBoundingSphere(){const e=this._boundingSphere,t=this.elevationBoundsMin,i=this.elevationBoundsMax,r=this.ellipsoid.radius,s=i;if(this.level===0)CL(e,0,0,0,r+s);else{const n=this.extentInRadians,a=.5*(n[0]+n[2]),o=n[1],l=n[3];ml(NS,a,o,r),ml(jS,a,l,r),ce(qc,NS,jS),te(qc,qc,(r+.5*(t+i))/cn(qc));const c=this.convexHull;let u=0;const p=(m,f)=>{const g=m[0]-c[3*f],y=m[1]-c[3*f+1],v=m[2]-c[3*f+2];return Math.sqrt(g*g+y*y+v*v)};for(let m=0;m<8;++m){const f=p(qc,m);u=Math.max(u,f)}oM(e,qc,u+2)}}_updateConvexHull(){const e=this.extentInRadians,t=this.ellipsoid.radius;if(this.level===0)return;const i=this.elevationBoundsMin,r=this.elevationBoundsMax,s=this._getPatchType(),n=this.surface.isWebMercator,a=n&&s===1,o=n&&s===2,l=o||a,c=Math.PI/2,u=e[0],p=e[2],m=o?-c:e[1],f=a?c:e[3],g=.5*(u+p),y=i,v=t+(l?Math.min(0,y-1):y),C=(B,ee,G)=>ml(B,ee,G,v),b=w(),S=w(),x=w(),T=w();C(b,u,m),C(S,u,f),C(x,p,f),C(T,p,m);const P=(B,ee)=>{for(let G=0;G<3;++G)this._convexHull[3*ee+G]=B[G]};P(b,0),P(S,1),P(x,2),P(T,3);const R=r,O=t+(l?Math.max(0,R+1):R),E=w(),A=w(),F=w();ml(A,g,f,v),ml(F,g,m,v),ce(E,A,F),me(E,E);const L=w(),H=w(),V=(B,ee)=>{ji(H,B,ee),me(H,H);const G=-$e(B,L)/$e(H,L);N(G>=0),te(H,H,G),ce(B,B,H)};if(2**this.lij[0]>2*this.lij[1]){const B=F,ee=w();ri(ee,BS,B),me(ee,ee),ri(L,B,ee),me(L,L),N(Vs($e(L,B)/cn(B),0)),V(b,S),V(T,x),P(b,0),P(T,3)}else if(2**this.lij[0]!==2*this.lij[1]){const B=A,ee=w();ri(ee,BS,B),me(ee,ee),ri(L,ee,B),me(L,L),V(S,b),V(x,T),P(S,1),P(x,2)}const I=(B,ee)=>{const G=O/$e(ee,E);for(let be=0;be<3;++be)this._convexHull[3*B+be]=ee[be]*G};I(4,b),I(5,S),I(6,x),I(7,T)}_getPatchType(){const e=this.lij[1],t=e===0,i=e===(1<<this.level)-1;return t?i?3:1:i?2:0}intersectsRay(e,t,i,r){const s=this._boundingSphere,n=s[3]+i,a=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],o=s[0]-e[0],l=s[1]-e[1],c=s[2]-e[2],u=(o*t[0]+l*t[1]+c*t[2])/a,p=t[0]*u-o,m=t[1]*u-l,f=t[2]*u-c;return p*p+m*m+f*f<n*n}get minimumVerticesPerSide(){return this.level<kS.length?kS[this.level]+1:2}updateCornerElevations(){t$(this.renderData),this._updateBoundingVolumes()}updateEdgeElevations(){JG(this.renderData),this._updateBoundingVolumes()}updateEdgeElevationsAndResolutions(){e$(this.renderData),this._updateBoundingVolumes()}_checkBVs(){if(!vi||this.level<=2)return;const e=this._boundingSphere,t=e[3],i=_p(e,w()),r=w(),s=this.ellipsoid.radius,n=this.elevationBoundsMin,a=this.elevationBoundsMax,o=s+n,l=1,c=0,u=this._center[1];_p(u,w());const p=u[3],m=this.convexHull,f=(W,U)=>{for(let pe=0;pe<3;++pe)W[pe]=m[3*U+pe]};{const W=w(),U=w(),pe=w(),Me=w(),Te=w(),Ue=(he,K,J,Ce)=>{f(U,he),f(pe,K),f(Me,J),ji(U,U,pe),ji(Me,Me,pe),ri(W,U,Me),me(W,W);const ke=$e(W,pe);f(Te,Ce);const Tt=$e(W,Te),Pt=Math.abs(Tt-ke);N(Vs(Pt,0),`Non coplanar ${he},${K},${J},${Ce} diff = ${Pt}`)};Ue(0,1,2,3),Ue(4,5,6,7),Ue(0,1,4,5),Ue(1,2,5,6),Ue(2,3,6,7),Ue(3,0,7,4)}const g=zv(24),y=(W,U,pe)=>{const Me=4*W;for(let Te=0;Te<3;++Te)g[Me+Te]=U[Te];g[Me+3]=pe},v=w(),C=w(),b=w(),S=w(),x=(W,U,pe,Me)=>{f(v,U),f(C,pe),f(b,Me),ji(v,v,C),me(v,v),ji(b,b,C),me(b,b),ri(S,v,b),me(S,S);const Te=$e(S,C);y(W,S,Te)};x(0,0,1,2),x(1,1,0,4),x(2,1,5,2),x(3,3,2,6),x(4,4,0,3),x(5,4,6,5);const T=(W,U,pe,Me)=>{const Te=4*W;return g[Te]*U+g[Te+1]*pe+g[Te+2]*Me-g[Te+3]},P=(W,U,pe,Me)=>T(W,U,pe,Me)>=-1,R=(W,U)=>P(W,U[0],U[1],U[2]),O=2**this.lij[0]>2*this.lij[1],E=(W,U,pe)=>Math.sqrt(tE(W,U,pe,i[0],i[1],i[2]))<t,A=W=>E(W[0],W[1],W[2]),F=(W,U)=>E(W[U],W[U+1],W[U+2]),L=this.extentInRadians,H=.5*(L[0]+L[2]),V=L[1],I=L[3],B=w(),ee=w();ml(B,H,I,o),ml(ee,H,V,o);const G=O?"Upper":"Lower";let be=!0;for(let W=0;W<6;++W){for(let U=0;U<8;++U){const pe=3*U,Me=P(W,m[pe],m[pe+1],m[pe+2]);be&&=Me,N(Me,`Tile[${this.lij}] Convex hull point ${U} outside of plane ${W}`)}N(R(W,ee),`Tile[${this.lij}] (${G}) bottom mid outside of plane ${W}`),N(R(W,B),`Tile[${this.lij}] (${G}) top mid outside of plane ${W}`)}N(be,"Not all convex hull points are inside  convex hull polyhedron"),N(A(ee),`Tile[${this.lij}] (${G}) bottom mid outside of bounding sphere`),N(A(B),`Tile[${this.lij}] (${G}) top mid outside of bounding sphere`);for(let W=0;W<8;++W){const U=F(m,3*W);N(U,`Tile[${this.lij}] Convex hull point ${W} outside of bounding sphere`)}for(let W=0;W<6;++W)for(let U=0;U<8;++U){const pe=3*U;P(W,m[pe],m[pe+1],m[pe+2])||console.error(`Tile[${this.lij}] Convex hull point ${U} outside of plane ${W}`)}const{extentInRadians:ae}=this,Xe=Math.max(ae[2]-ae[0],ae[3]-ae[1]),se=Math.round(Xe*s),{renderData:Re}=this;if(!Re)return;const{geometry:Pe,geometryState:Ae,localOrigin:Dt}=Re,Bt=Pe.vertexAttributes?.position;if(!Bt)return;const Fe=w(),et=Pe.numVerticesPerSide-2,{indices:je,indexCount:we,edgeVerticesStartIndex:Ke,poleVerticesStartIndex:nt}=Pe;if(!je)return;const Y=new Set;for(let W=0;W<we;++W){const U=je[W];if(Y.has(U))continue;Y.add(U);const pe=U<nt,Me=U>=Ke;let Te=!1,Ue=-1;if(Me){let ve=Ke;for(let Je=0;Je<4;++Je){const Be=Ae.edgeResolutions[Je];if(U===ve||U===ve+Be-1){Te=!0;break}if(ve+=Be,U<ve){Ue=Je;break}}}const he=Me?Ae.edgePeerNeighbors[Ue]:null,K=Me&&he&&ta(this,he)>0;Bt.getVec(U,r),ce(Fe,r,Dt);const J=cn(Fe)-s;let Ce=0,ke=!1;const Tt=n-J,Pt=J-a,at=Tt>l,dt=Pt>l,xt=at||dt,Ze=()=>{const ve=pe?"internal":Me&&!Te?"edge":Te?"corner":"pole";return`Tile[${this.lij}].vertex[${U}]:${ve}`+(at?"(below)":dt?"(above)":"")+(K?"(Neighbor)":"")},Ye=B2(Fe,i);if(Ye>=t+c){const ve=Ye-t;xt||(console.error(`${Ze()} is out of the bounding sphere by ${ve.toFixed(0)} / ${t.toFixed(0)}[tol=${c}] h=${J.toFixed(0)} / [${n.toFixed(0)}..${a.toFixed(0)}] (${(ve/t).toFixed(0)})`),ke=!0)}for(let ve=0;ve<6;++ve)if(!P(ve,Fe[0],Fe[1],Fe[2])){const Je=T(ve,Fe[0],Fe[1],Fe[2]),Be=U%et,pt=(U-Be)/et;ve===0&&Tt||ve===5&&Pt||(console.error(`${Ze()} (${Be},${pt})|${et}] is out of the bounding trapezoid plane ${ve} h=${Math.round(J)} / [${Math.round(n)}..${Math.round(a)}] dist=${Math.round(Je)} radii = ${Math.round(t)}/${Math.round(p)}} : maxL = ${se}`),++Ce)}if(ke||Ce>0)break}}get convexHull(){return this._convexHull}};const kS=[128,64,64,32,16,8,8,4];function x$(e,t,i){return tE(e[0],e[1],e[2],t[i],t[i+1],t[i+2])}function tE(e,t,i,r,s,n){const a=r-e,o=s-t,l=n-i;return a*a+o*o+l*l}const ml=(e,t,i,r)=>{const s=Math.cos(t),n=Math.sin(t),a=Math.cos(i),o=Math.sin(i);e[0]=r*a*s,e[1]=r*a*n,e[2]=r*o},BS=[0,0,1],NS=w(),jS=w(),qc=w();let on=class extends ie{constructor(){super(...arguments),this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0}};h([d()],on.prototype,"fovX",void 0),h([d()],on.prototype,"fovY",void 0),h([d()],on.prototype,"relativeWidthLimit",void 0),h([d()],on.prototype,"relativeHeightLimit",void 0),h([d()],on.prototype,"maxLod",void 0),h([d()],on.prototype,"angledSplitBias",void 0),h([d()],on.prototype,"aboveGround",void 0),h([d()],on.prototype,"frustum",void 0),on=h([D("esri.views.3d.terrain.SplitLimits")],on);const iE=Ka().vec3f("position").vec2u16("uv0",{glNormalized:!0}).vec2i16("normalCompressed",{glNormalized:!0});let C$=class{constructor(e){this._storage=new Yp((t,i)=>e.newCache(t,i),"TileGeometry")}acquire(e){const t=Math.ceil(e/4)*4,i=this._storage,r=S$(t),s=i.pop(r);if(s)return s;const n=iE.createBuffer(t);return n.release=()=>i.put(r,n),n}clear(){this._storage.clear()}destroy(){this._storage.destroy()}};function S$(e){return e.toString()}function US(e){return H4(e.layer)}let rE=class extends Kt{constructor(){super(...arguments),this.scale=1,this.offset=mp}};function sE(e){e.attributes.add("position","vec2"),e.attributes.add("uv0","vec2"),e.varyings.add("uv","vec2"),e.varyings.add("vuv","vec2"),e.vertex.uniforms.add(new _e("scale",t=>t.scale),new qs("offset",t=>t.offset)).main.add(_`gl_Position = vec4(position, 0.0, 1.0);
uv = uv0 * scale + offset;
vuv = uv0;`)}function aw(e){e.code.add(_`
    float lineFactorAtPosition(float value) {
      float pos = value * ${_.float(257)};
      if(pos < 0.5 || pos > ${_.float(257-.5)}) {
        return 1.0;
      }

      pos = pos + 0.5;
      float modulo = mod(pos, 16.0);
      return modulo <= 2.0 ?  1.0 - abs(modulo - 1.0) : 0.0;
    }

    float lineFactorAtUV(vec2 uv) {
      return max(lineFactorAtPosition(uv.x), lineFactorAtPosition(uv.y));
    }

    float lineFactor(vec2 uv) {
      vec2 offset = fwidth(uv) * 0.25;
      return (lineFactorAtUV(vec2(uv.x + offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x + offset.x, uv.y - offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y - offset.y))) / 4.0;
    }

    vec3 gridColor(vec2 uv) {
      float line = lineFactor(uv) * 0.1 + 0.9;
      return vec3(1.0, 0.972, 0.918) * line;
    }`)}function T$(e,t){const i=t.blendMode;i!==0&&(i===30&&e.code.add(_`float reflectBlend(in float cb, in float cl) {
return (cl == 1.0) ? cl : min(cb * cb / (1.0 - cl), 1.0);
}`),i!==6&&i!==13||e.code.add(_`float colorDodge(in float cb, in float cl) {
return (cb == 0.0) ? 0.0 : (cl == 1.0) ? 1.0 : min(1.0, cb / (1.0 - cl));
}`),i!==9&&i!==13||e.code.add(_`float colorBurn(in float cb, in float cl) {
return (cb == 1.0) ? 1.0 : (cl == 0.0) ? 0.0 : 1.0 - min(1.0, (1.0 - cb) / cl);
}`),i===10&&e.code.add(_`float overlay(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (1.0 - 2.0 * (1.0 - cl ) * (1.0 - cb)) + step(0.5, cl) * (2.0 * cl * cb);
}`),i===12&&e.code.add(_`float hardLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (2.0 * cl * cb) + step(0.5, cl) * (1.0 - 2.0 * (1.0 - cl) * (1.0 - cb));
}`),i===11&&e.code.add(_`float softLight(in float cb, in float cl) {
if (cl <= 0.5) {
return cb - (1.0 - 2.0 * cl) * cb * (1.0 - cb);
}
if (cb <= 0.25) {
return cb + (2.0 * cl - 1.0) * cb * ((16.0 * cb - 12.0) * cb + 3.0);
}
return cb + (2.0 * cl - 1.0) * (sqrt(cb) - cb);
}`),i===13&&e.code.add(_`float vividLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * colorBurn(cb, 2.0 * cl) + step(0.5, cl) * colorDodge(cb, (2.0 * (cl - 0.5)));
}`),i!==14&&i!==15&&i!==17&&i!==16||(e.code.add(_`float minv3(in vec3 c) {
return min(min(c.r, c.g), c.b);
}
float maxv3(in vec3 c) {
return max(max(c.r, c.g), c.b);
}
float lumv3(in vec3 c) {
return dot(c, vec3(0.3, 0.59, 0.11));
}
vec3 clipColor(vec3 color) {
float lum = lumv3(color);
float mincol = minv3(color);
float maxcol = maxv3(color);
if (mincol < 0.0) {
color = lum + ((color - lum) * lum) / (lum - mincol);
}
if (maxcol > 1.0) {
color = lum + ((color - lum) * (1.0 - lum)) / (maxcol - lum);
}
return color;
}
vec3 setLum(vec3 cbase, vec3 clum) {
return clipColor(cbase + vec3(lumv3(clum) - lumv3(cbase)));
}`),i!==14&&i!==15||e.code.add(_`float satv3(vec3 c) {
return maxv3(c) - minv3(c);
}
vec3 setLumSat(vec3 cbase, vec3 csat, vec3 clum)
{
float minbase = minv3(cbase);
float sbase = satv3(cbase);
float ssat = satv3(csat);
return setLum(sbase > 0.0 ? (cbase - minbase) * ssat / sbase : vec3(0.0), clum);
}`)),e.code.add(_`
    vec4 applyBlendMode(vec3 cl, float ol, vec3 cb, float ob) {
      ${i===8?_`return vec4(cl * ol * cb * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===1?_`return vec4((cb + cl) * 0.5 * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===2?_`return vec4(max(cb, cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===7?_`return vec4(min(cl, cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===3?_`return vec4(cl * ol + cb * ob, ol + ob);`:i===4?_`return clamp(vec4(cl.rgb + cb.rgb, ol + ob), 0.0, 1.0);`:i===28?_`return vec4(clamp(vec3(cb.rgb - cl.rgb), 0.0, 1.0), ob * ol);`:i===5?_`return vec4((cl + cb - cl * cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===26?_`return vec4(abs(cb - cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===29?_`return vec4((1.0 - cb) * ol * ob + cb * ob * (1.0 - ol), ob);`:i===18?_`return vec4(cl * ol * (1.0 - ob) + cb * ob, ol + ob - ol * ob);`:i===19?_`return vec4(cl * ol * (1.0 - ob) + cb * ob * ol, ol);`:i===21?_`return vec4(cb * ob * (1.0 - ol), ob * (1.0 - ol));`:i===22?_`return vec4(cl * ol * ob + cb * ob * (1.0 - ol), ob);`:i===24?_`return vec4(cl * ol * (1.0 - ob), ol * (1.0 - ob));`:i===25?_`return vec4(cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), ol * (1.0 - ob) + ob * (1.0 - ol));`:i===20?_`return vec4(cb * ob * ol, ol * ob);`:i===23?_`return vec4(cl * ol * ob, ol * ob);`:i===14?_`
          vec3 f = setLumSat(cl, cb, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===15?_`
          vec3 f = setLumSat(cb, cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===17?_`
          vec3 f = setLum(cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===16?_`
          vec3 f = setLum(cb, cl);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===27?_`
          vec3 f = cl + cb - 2.0 * cl * cb;
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===30?_`
          vec3 f = vec3(reflectBlend(cb.r, cl.r), reflectBlend(cb.g, cl.g), reflectBlend(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===6?_`
          vec3 f = vec3(colorDodge(cb.r, cl.r), colorDodge(cb.g, cl.g), colorDodge(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===9?_`
          vec3 f = vec3(colorBurn(cb.r, cl.r), colorBurn(cb.g, cl.g), colorBurn(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===10?_`
          vec3 f = vec3(overlay(cb.r, cl.r), overlay(cb.g, cl.g), overlay(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===11?_`
          vec3 f = vec3(softLight(cb.r, cl.r), softLight(cb.g, cl.g), softLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===12?_`
          vec3 f = vec3(hardLight(cb.r, cl.r), hardLight(cb.g, cl.g), hardLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===13?_`
          vec3 f = vec3(vividLight(cb.r, cl.r), vividLight(cb.g, cl.g), vividLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:_``}
    }
  `))}function nE(e,t){const{output:i,blendMode:r,baseOpacityMode:s,premultipliedSource:n}=t,a=e.fragment,o=s===1;o&&a.uniforms.add(new _e("baseOpacity",p=>p.baseOpacity));const l=r!==0,c=!l&&n!==1&&(i===1&&!o||i===4);a.include(T$,t);let u="";switch(i){case 4:case 0:u=_`vec4(0.0)`;break;case 2:a.uniforms.add(new Zr("backgroundColor",p=>p.backgroundColor)),u=_`vec4(backgroundColor, 1.0)`;break;case 3:a.include(aw),u=_`vec4(gridColor(uv), 1.0)`;break;case 1:a.uniforms.add(new Ne("fboColor",p=>p.fboTexture)),u=_`texelFetch(fboColor, ivec2(gl_FragCoord.xy), 0)`}a.code.add(_`
    vec4 getBackground(vec2 uv) {
      return ${X(o,_`baseOpacity *`)} ${u};
    }

    vec4 blendLayers(vec2 bgUV, vec4 colorLayer, float opacity) {
      ${l?_`
          vec3 cl = colorLayer.a == 0.0 ? colorLayer.rgb : colorLayer.rgb / colorLayer.a;
          vec4 bgColor = getBackground(bgUV);
          vec3 cb = bgColor.a == 0.0 ? bgColor.rgb : bgColor.rgb / bgColor.a;
          return applyBlendMode(clamp(cl, vec3(0.0), vec3(1.0)), colorLayer.a * opacity, cb, bgColor.a);`:_`
          float composeAlpha = colorLayer.a * opacity;
          ${c?_`return colorLayer * opacity;`:_`
            vec4 bgColor = getBackground(bgUV);
            return bgColor * (1.0 - composeAlpha) + colorLayer * opacity;`}`}
    }`)}function aE(e){const t=new ut,i=t.fragment;if(t.include(sE),e.background===1){const r=e.output===2;return r?i.uniforms.add(new Zr("backgroundColor",s=>s.backgroundColor)):i.include(aw),i.main.add(_`fragColor = vec4(${r?_`backgroundColor`:_`gridColor(uv)`}, 1.0);`),t}return t.include(nE,e),i.uniforms.add(new Ne("tex",r=>r.texture),new _e("opacity",r=>r.opacity)),i.main.add(_`fragColor = blendLayers(uv, texture(tex, uv), opacity);`),t}const P$=Object.freeze(Object.defineProperty({__proto__:null,build:aE},Symbol.toStringTag,{value:"Module"}));let M$=class extends rE{constructor(){super(...arguments),this.opacity=1,this.baseOpacity=1,this.texture=null,this.fboTexture=null,this.backgroundColor=ia}},HS=class extends ct{constructor(e,t){super(e,t,new ht(P$,()=>k(()=>Promise.resolve().then(()=>see),void 0)),Ja(zp))}};function Jl(){const e=new Float32Array(9);return e[0]=1,e[4]=1,e[8]=1,e}function oE(e){const t=new Float32Array(9);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t}function R$(e,t,i,r,s,n,a,o,l){const c=new Float32Array(9);return c[0]=e,c[1]=t,c[2]=i,c[3]=r,c[4]=s,c[5]=n,c[6]=a,c[7]=o,c[8]=l,c}Object.freeze(Object.defineProperty({__proto__:null,clone:oE,create:Jl,fromValues:R$},Symbol.toStringTag,{value:"Module"}));let D$=class{constructor(e,t){this.sourceTile=t,this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.featureIndex=0,this.uniqueSymbol=null,this._colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=e}colliders(){return this._colliders}},O$=class{constructor(e){this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1,this.lastShow=!1,this.tileSymbols=[e],this.id=e.id}};function E$(e,t,i,r){return lE(e,t,i.level,i.col,r.key.level,r.key.col)}function A$(e,t,i,r){return lE(e,t,i.level,i.row,r.level,r.row)}function lE(e,t,i,r,s,n){const a=i-s;if(a>=0)return(t>>a)+(r-(n<<a))*(e>>a);const o=-a;return t-(n-(r<<o))*(e>>o)<<o}let cE=class{constructor(e,t,i){this._rows=Math.ceil(t/i),this._columns=Math.ceil(e/i),this._cellSize=i,this.cells=new Array(this._rows);for(let r=0;r<this._rows;r++){this.cells[r]=new Array(this._columns);for(let s=0;s<this._columns;s++)this.cells[r][s]=[]}}getCell(e,t){const i=Math.min(Math.max(Math.floor(t/this._cellSize),0),this._rows-1),r=Math.min(Math.max(Math.floor(e/this._cellSize),0),this._columns-1);return this.cells[i]&&this.cells[i][r]||null}getCellSpan(e,t,i,r){return[Math.min(Math.max(Math.floor(e/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(t/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(i/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(r/this._cellSize),0),this.rows-1)]}get cellSize(){return this._cellSize}get columns(){return this._columns}get rows(){return this._rows}};function I$(e,t,i,r,s,n,a){const o=t[r++];for(let l=0;l<o;l++){const c=new D$(n,a);c.xTile=t[r++],c.yTile=t[r++],c.hash=t[r++],c.priority=t[r++],c.featureIndex=t[r++];const u=t[r++],p=c.colliders();for(let g=0;g<u;g++){const y=t[r++],v=t[r++],C=t[r++],b=t[r++],S=!!t[r++],x=t[r++],T=i[r++],P=i[r++],R=t[r++],O=t[r++];p.push({xTile:y,yTile:v,dxPixels:C,dyPixels:b,hard:S,partIndex:x,width:R,height:O,minLod:T,maxLod:P})}const m=e[r++];for(let g=0;g<m;g++)c.textVertexRanges.push([e[r++],e[r++]]);const f=e[r++];for(let g=0;g<f;g++)c.iconVertexRanges.push([e[r++],e[r++]]);s.push(c)}return r}function L$(e,t,i){for(const[r,s]of e.symbols)F$(e,t,i,s,r)}function F$(e,t,i,r,s){const n=e.layerData.get(s);if(n.type===3){for(const a of r){const o=a.uniqueSymbol;let l;if(a.selectedForRendering){const c=o.parts[0];c.startOpacity;const u=c.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&u===0;const p=u?255:0;l=p<<24|p<<16|p<<8|p}else l=0;for(const[c,u]of a.iconVertexRanges)for(let p=c;p<c+u;p+=4)n.iconOpacity[p/4]=l;if(a.selectedForRendering){const c=o.parts[1];c.startOpacity;const u=c.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&u===0;const p=u?255:0;l=p<<24|p<<16|p<<8|p}else l=0;for(const[c,u]of a.textVertexRanges)for(let p=c;p<c+u;p+=4)n.textOpacity[p/4]=l}n.lastOpacityUpdate=t,n.opacityChanged=!0}}function V$(e,t,i,r){const s=e.colliders();let n,a,o,l;for(const c of s)if(e.uniqueSymbol?.show&&e.uniqueSymbol.parts[c.partIndex].show&&(n=c.xScreen-r[0]+c.dxScreen,a=c.yScreen-r[1]+c.dyScreen,o=n+c.width,l=a+c.height,NF(i,t.x,t.y,n,a,o,l)))return!0;return!1}let z$=class{constructor(e,t,i,r,s,n){this._symbols=e,this._styleRepository=r,this._zoom=s,this._currentLayerCursor=0,this._currentSymbolCursor=0,this._styleProps=new Map,this._allNeededMatrices=new Map,this._gridIndex=new cE(t,i,BF),this._si=Math.sin(Math.PI*n/180),this._co=Math.cos(Math.PI*n/180),r.cachedStyles&&(this._styleProps=r.cachedStyles);for(const a of e)for(const o of a.symbols)this._allNeededMatrices.has(o.tile)||this._allNeededMatrices.set(o.tile,oE(o.tile.transforms.tileUnitsToPixels))}work(e){const t=performance.now();for(;this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0){const i=this._symbols[this._currentLayerCursor],r=this._getProperties(i.styleLayerUID),s=this._styleRepository.layerContexts?.get(i.styleLayerUID);for(;this._currentSymbolCursor<i.symbols.length;this._currentSymbolCursor++){if(this._currentSymbolCursor%100==99&&performance.now()-t>e)return!1;const n=i.symbols[this._currentSymbolCursor];if(!n.uniqueSymbol?.show)continue;const a=this._computeCoordinates(n,r,s),o=n.uniqueSymbol;if(!o.show)continue;const{iconAllowOverlap:l,textAllowOverlap:c}=r;for(const u of a){if(!u.enabled)continue;const p=o.parts[u.partIndex];p.show&&!(u.partIndex?c:l)&&this._doesCollide(u)&&(u.hard?o.show=!1:p.show=!1)}o.show&&this._insertColliders(o.parts,a,r)}}return!0}_insertColliders(e,t,i){const{iconIgnorePlacement:r,textIgnorePlacement:s}=i;for(const n of t){if(!n.enabled||(n.partIndex?s:r)||!e[n.partIndex].show)continue;const a=n.xScreen+n.dxScreen,o=n.yScreen+n.dyScreen,l=a+n.width,c=o+n.height,[u,p,m,f]=this._gridIndex.getCellSpan(a,o,l,c);for(let g=p;g<=f;g++)for(let y=u;y<=m;y++)this._gridIndex.cells[g][y].push(n)}}_computeCoordinates(e,t,i){const{iconRotationAlignment:r,textRotationAlignment:s,iconTranslate:n,iconTranslateAnchor:a,textTranslate:o,textTranslateAnchor:l}=t,c=this._si,u=this._co,p=this._zoom,m=this._allNeededMatrices.get(e.tile),f=e.uniqueSymbol,g=e.colliders(i);let y=0;for(const v of g){const[C,b]=v.partIndex===0?n:o,S=v.partIndex===0?a:l,x=v.minLod<=p&&p<=v.maxLod;y+=x?0:1,v.enabled=x,v.xScreen=v.xTile*m[0]+v.yTile*m[3]+m[6],v.yScreen=v.xTile*m[1]+v.yTile*m[4]+m[7],S===0?(v.xScreen+=u*C-c*b,v.yScreen+=c*C+u*b):(v.xScreen+=C,v.yScreen+=b),(v.partIndex===0?r:s)===1?(v.dxScreen=v.dxPixels,v.dyScreen=v.dyPixels):(v.dxScreen=u*(v.dxPixels+v.width/2)-c*(v.dyPixels+v.height/2)-v.width/2,v.dyScreen=c*(v.dxPixels+v.width/2)+u*(v.dyPixels+v.height/2)-v.height/2)}return g.length>0&&y===g.length&&f&&(f.show=!1),g}_getProperties(e){const t=this._styleProps.get(e);if(t)return t;const i=this._styleRepository.getLayerStyleProperties?.(e,this._zoom);return this._styleProps.set(e,i),i}_doesCollide(e){const t=e.xScreen+e.dxScreen,i=e.yScreen+e.dyScreen,r=t+e.width,s=i+e.height,[n,a,o,l]=this._gridIndex.getCellSpan(t,i,r,s);for(let c=a;c<=l;c++)for(let u=n;u<=o;u++){const p=this._gridIndex.cells[c][u];for(const m of p){if(m.labelId!=null&&e.labelId!=null&&m.labelId===e.labelId)continue;const f=m.xScreen+m.dxScreen,g=m.yScreen+m.dyScreen,y=f+m.width,v=g+m.height;if(!(r<f||t>y||s<g||i>v))return!0}}return!1}},Y_=class{constructor(e,t){this.layerUIDs=[],this.isDestroyed=!1,this._data=e;let i=1;const r=new Uint32Array(e);this.layerUIDs=[];const s=r[i++];for(let n=0;n<s;n++)this.layerUIDs[n]=r[i++];this.bufferDataOffset=i,t&&(this.layer=t.getStyleLayerByUID(this.layerUIDs[0]))}get isPreparedForRendering(){return this._data==null}get offset(){return this.bufferDataOffset}get data(){return this._data}destroy(){this.isDestroyed||(this.doDestroy(),this._data=null,this.isDestroyed=!0)}prepareForRendering(e){this._data!=null&&(this.doPrepareForRendering(e,this._data,this.bufferDataOffset),this._data=null)}},k$=class extends Y_{constructor(e,t){super(e,t),this.type=2,this.lineIndexStart=0,this.lineIndexCount=0;const i=new Uint32Array(e);let r=this.bufferDataOffset;this.lineIndexStart=i[r++],this.lineIndexCount=i[r++];const s=i[r++];if(s>0){this.patternMap=new Map;for(let n=0;n<s;n++){const a=i[r++],o=i[r++],l=i[r++];this.patternMap.set(a,[o,l])}}this.bufferDataOffset=r}get usedMemory(){return(this.data?.byteLength??0)+(this.vao?.usedMemory??0)}hasData(){return this.lineIndexCount>0}triangleCount(){return this.lineIndexCount/3}doDestroy(){this.vao=ye(this.vao)}doPrepareForRendering(e,t,i){const r=new Uint32Array(t),s=new Int32Array(r.buffer),n=r[i++],a=this.layer.lineMaterial,o=new ei(e,a.geometryLayout,new Int32Array(s.buffer,4*i,n));i+=n;const l=r[i++],c=Hs.createIndex(e,35044,new Uint32Array(r.buffer,4*i,l));i+=l,this.vao=new Qa(e,o,c)}},B$=class extends Y_{constructor(e,t){super(e,t),this.type=1,this.fillIndexStart=0,this.fillIndexCount=0,this.outlineIndexStart=0,this.outlineIndexCount=0;const i=new Uint32Array(e);let r=this.bufferDataOffset;this.fillIndexStart=i[r++],this.fillIndexCount=i[r++],this.outlineIndexStart=i[r++],this.outlineIndexCount=i[r++];const s=i[r++];if(s>0){this.patternMap=new Map;for(let n=0;n<s;n++){const a=i[r++],o=i[r++],l=i[r++];this.patternMap.set(a,[o,l])}}this.bufferDataOffset=r}get usedMemory(){return(this.data?.byteLength??0)+(this.fillVAO?.usedMemory??0)+(this.outlineVAO?.usedMemory??0)}hasData(){return this.fillIndexCount>0||this.outlineIndexCount>0}triangleCount(){return(this.fillIndexCount+this.outlineIndexCount)/3}doDestroy(){this.fillVAO=ye(this.fillVAO),this.outlineVAO=ye(this.outlineVAO)}doPrepareForRendering(e,t,i){const r=new Uint32Array(t),s=new Int32Array(r.buffer),n=r[i++],a=this.layer,o=a.fillMaterial,l=new ei(e,o.geometryLayout,new Int32Array(s.buffer,4*i,n));i+=n;const c=r[i++],u=Hs.createIndex(e,35044,new Uint32Array(r.buffer,4*i,c));i+=c;const p=r[i++],m=a.outlineMaterial,f=new ei(e,m.geometryLayout,new Int32Array(s.buffer,4*i,p));i+=p;const g=r[i++],y=Hs.createIndex(e,35044,new Uint32Array(r.buffer,4*i,g));i+=g,this.fillVAO=new Qa(e,l,u),this.outlineVAO=new Qa(e,f,y)}},N$=class extends Y_{constructor(e,t,i){super(e,t),this.type=3,this.iconPerPageElementsMap=new Map,this.glyphPerPageElementsMap=new Map,this.symbolInstances=[],this.isIconSDF=!1,this.opacityChanged=!1,this.lastOpacityUpdate=0,this.symbols=[];const r=new Uint32Array(e),s=new Int32Array(e),n=new Float32Array(e);let a=this.bufferDataOffset;this.isIconSDF=!!r[a++];const o=r[a++],l=r[a++],c=r[a++],u=new ib(o,l,c,0),p=r[a++];for(let y=0;y<p;y++){const v=r[a++],C=r[a++],b=r[a++];this.iconPerPageElementsMap.set(v,[C,b])}const m=r[a++];for(let y=0;y<m;y++){const v=r[a++],C=r[a++],b=r[a++];this.glyphPerPageElementsMap.set(v,[C,b])}const f=r[a++],g=r[a++];this.iconOpacity=new Int32Array(f),this.textOpacity=new Int32Array(g),a=I$(r,s,n,a,this.symbols,i,u),this.bufferDataOffset=a}get usedMemory(){return(this.data?.byteLength??0)+(this.iconVAO?.usedMemory??0)+(this.textVAO?.usedMemory??0)+px(this.iconOpacity)+px(this.textOpacity)}hasData(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0}triangleCount(){let e=0;for(const t of this.iconPerPageElementsMap.values())e+=t[1];for(const t of this.glyphPerPageElementsMap.values())e+=t[1];return e/3}doDestroy(){this.iconVAO=ye(this.iconVAO),this.textVAO=ye(this.textVAO)}updateOpacityInfo(){if(!this.opacityChanged)return;this.opacityChanged=!1;const e=this.iconOpacity,t=this.iconVAO.buffer("opacity");e.length>0&&e.byteLength===t.usedMemory&&t.setSubData(e,0,0,e.length);const i=this.textOpacity,r=this.textVAO.buffer("opacity");i.length>0&&i.byteLength===r.usedMemory&&r.setSubData(i,0,0,i.length)}doPrepareForRendering(e,t,i){const r=new Uint32Array(t),s=new Int32Array(r.buffer),n=r[i++],a=this.layer,o=a.iconMaterial,l=new ei(e,o.geometryLayout,new Int32Array(s.buffer,4*i,n));i+=n;const c=r[i++],u=Hs.createIndex(e,35044,new Uint32Array(r.buffer,4*i,c));i+=c;const p=r[i++],m=a.textMaterial,f=new ei(e,m.geometryLayout,new Int32Array(s.buffer,4*i,p));i+=p;const g=r[i++],y=Hs.createIndex(e,35044,new Uint32Array(r.buffer,4*i,g));i+=g;const v=new ei(e,o.opacityLayout,this.iconOpacity.buffer),C=new ei(e,m.opacityLayout,this.textOpacity.buffer);this.iconVAO=new Qa(e,new Map([["geometry",l],["opacity",v]]),u),this.textVAO=new Qa(e,new Map([["geometry",f],["opacity",C]]),y)}},j$=class extends Y_{constructor(e,t){super(e,t),this.type=4,this.circleIndexStart=0,this.circleIndexCount=0;const i=new Uint32Array(e);let r=this.bufferDataOffset;this.circleIndexStart=i[r++],this.circleIndexCount=i[r++],this.bufferDataOffset=r}get usedMemory(){return(this.data?.byteLength??0)+(this.vao?.usedMemory??0)}hasData(){return this.circleIndexCount>0}triangleCount(){return this.circleIndexCount/3}doDestroy(){this.vao=ye(this.vao)}doPrepareForRendering(e,t,i){const r=new Uint32Array(t),s=new Int32Array(r.buffer),n=r[i++],a=this.layer.circleMaterial,o=new ei(e,a.geometryLayout,new Int32Array(s.buffer,4*i,n));i+=n;const l=r[i++],c=Hs.createIndex(e,35044,new Uint32Array(r.buffer,4*i,l));i+=l,this.vao=new Qa(e,o,c)}},$n=class extends ie{constructor(e){super(e),this.computedOpacity=1,this.computedVisible=!0,this.opacity=1,this.visible=!0,this._fadeOutResolver=null,this._fadeInResolver=null}get transitioning(){return(this._fadeOutResolver||!this.visible?0:this.opacity)!==this.computedOpacity}endTransition(){this._fadeInResolver?.(),this._fadeOutResolver?.(),this._fadeInResolver=this._fadeOutResolver=null,this.computedOpacity=this.visible?this.opacity:0}fadeIn(){return this._fadeInResolver||(this.opacity=1,this.computedOpacity=0,this._fadeOutResolver?.(),this._fadeOutResolver=null,this._fadeInResolver=aa()),this._fadeInResolver.promise}fadeOut(){return this._fadeOutResolver||(this.opacity=0,this._fadeInResolver?.(),this._fadeInResolver=null,this._fadeOutResolver=aa()),this._fadeOutResolver.promise}transitionStep(e,t){const i=Qe("mapview-transitions-duration"),r=i?1/i:0;if(r===0)this.computedOpacity=this.opacity,this.computedVisible=this.visible;else{const s=this._fadeOutResolver||!this.visible?0:this.opacity,n=this.computedOpacity;if(n===s)this.computedVisible=this.visible;else{const a=e*r;this.computedOpacity=n>s?Math.max(s,n-a):Math.min(s,n+a),this.computedVisible=this.computedOpacity>0}}this.transitioning||(this._fadeInResolver?.(),this._fadeOutResolver?.(),this._fadeOutResolver=this._fadeInResolver=null)}};h([d()],$n.prototype,"computedOpacity",void 0),h([d()],$n.prototype,"computedVisible",void 0),h([d()],$n.prototype,"opacity",void 0),h([d()],$n.prototype,"visible",void 0),h([d()],$n.prototype,"transitioning",null),h([d()],$n.prototype,"_fadeOutResolver",void 0),h([d()],$n.prototype,"_fadeInResolver",void 0),$n=h([D("esri.views.2d.engine.transitions.FadeTransition")],$n);let U$=class extends A9{constructor(){super(...arguments),this._transitionables=null,this._clips=null,this._fadeTransition=null,this._isReady=!1,this._opacity=1,this.parent=null,this._stage=null,this._visible=!0}get computedOpacity(){return this._fadeTransition?.computedOpacity??this.opacity}get clips(){return this._clips}set clips(e){this._clips=e,this.requestRender()}get fadeTransitionEnabled(){return this._fadeTransition!==null}set fadeTransitionEnabled(e){!this._fadeTransition&&e?(this._fadeTransition=new $n({opacity:this.opacity,visible:this.visible}),this.addTransitionable(this._fadeTransition)):this._fadeTransition&&!e&&(this.removeTransitionable(this._fadeTransition),this._fadeTransition=null)}get inFadeTransition(){return this._fadeTransition?.transitioning??!1}get isReady(){return this._isReady}get opacity(){return this._opacity}set opacity(e){this._opacity!==e&&(this._opacity=Math.min(1,Math.max(e,0)),this._fadeTransition&&(this._fadeTransition.opacity=this._opacity),this.requestRender())}get stage(){return this._stage}set stage(e){if(this._stage===e)return;const t=this._stage;this._stage=e,e?this._stage?.untrashDisplayObject(this)||(this.onAttach(),this.emit("attach")):t?.trashDisplayObject(this)}get transforms(){return this._transforms==null&&(this._transforms=this._createTransforms()),this._transforms}get transitioning(){return this.isTransitioning()}get usedMemory(){return 0}get visible(){return this._visible}set visible(e){this._visible!==e&&(this._visible=e,this._fadeTransition&&(this._fadeTransition.visible=this._visible),this.requestRender())}get hasLabels(){return!1}get hasHighlight(){return!1}get hasBlending(){return!1}addTransitionable(e){this._transitionables??=[],this._transitionables.push(e),this.requestRender()}removeTransitionable(e){e.endTransition(),this._transitionables&&b2(this._transitionables,e),this.requestRender()}fadeIn(){this.fadeTransitionEnabled=!0;const e=this._fadeTransition.fadeIn();return this.opacity=1,this.requestRender(),e}fadeOut(){this.fadeTransitionEnabled=!0;const e=this._fadeTransition.fadeOut();return this.opacity=0,this.requestRender(),e}endTransitions(){if(this._transitionables){for(const e of this._transitionables)e.endTransition();this.requestRender()}}beforeRender(e){this.transitionStep(e.deltaTime,e.state.scale),this.setTransform(e.state)}afterRender(e){this.transitioning&&this.requestRender()}remove(){this.parent?.removeChild(this)}setTransform(e){}processRender(e){this.stage&&(this._fadeTransition?.computedVisible??this.visible)&&this.doRender(e)}requestRender(){this.stage&&this.stage.requestRender()}processDetach(){this.endTransitions(),this.onDetach(),this.emit("detach")}isTransitioning(){return this._transitionables?.some(e=>e.transitioning)??!1}transitionStep(e,t){if(this._transitionables)for(const i of this._transitionables)i.transitionStep(e,t)}onAttach(){}onDetach(){}doRender(e){}ready(){this._isReady||(this._isReady=!0,this.emit("isReady"),this.requestRender())}},hE=class extends U${constructor(e,t,i,r,s,n,a=s,o=n){super(),this.tileDebugInfoTexture=null,this.debugInfo={display:{length:0,minOrderedLength:0,minUnorderedLength:0,triangleCount:0},memory:{bytesUsed:0,bytesReserved:0}},this._destroyed=!1,this.key=new ib(e),this.resolution=t,this.x=i,this.y=r,this.width=s,this.height=n,this.rangeX=a,this.rangeY=o}destroy(){super.destroy(),this.tileDebugInfoTexture&&(this.tileDebugInfoTexture.dispose(),this.tileDebugInfoTexture=null),this._destroyed=!0}get debugSlot(){let e=this;for(;e.parent!==this._stage;){if(!e.parent)return 0;e=e.parent}return this._stage.children.indexOf(e)}setTransform(e){const t=this.resolution/(e.resolution*e.pixelRatio),i=this.transforms.tileMat3,[r,s]=e.toScreenNoRotation([0,0],[this.x,this.y]),n=this.width/this.rangeX*t,a=this.height/this.rangeY*t;Q4(i,n,0,0,0,a,0,r,s,1),X4(this.transforms.displayViewScreenMat3,e.displayViewMat3,i)}get destroyed(){return this._destroyed}},H$=class uE extends hE{constructor(t,i,r,s,n,a,o,l=null){super(t,i,r,s,n,a,yp,yp),this.styleRepository=o,this._owner=l,this.type="vector-tile",this._referenced=1,this._hasSymbolBuckets=!1,this._usedMemory=256,this.layerData=new Map,this.status="loading",this.allSymbolsFadingOut=!1,this.lastOpacityUpdate=0,this.symbols=new Map,this.isCoverage=!1,this.neededForCoverage=!1,this.decluttered=!1,this.parentTile=null,this.childrenTiles=new Set,this.featureIndex=null,this.triangleCount=0,this._processed=!1,this.id=t.id}get styleLayerUIDs(){return Array.from(this.layerData.keys())}get hasSymbolBuckets(){return this._hasSymbolBuckets}get isFading(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<kv}get isHoldingForFade(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<kv)}get wasRequested(){return this.status==="errored"||this.status==="loaded"||this.status==="reloading"}setData(t){this.changeDataImpl(t),this.requestRender(),this.ready(),this._processed=!0}deleteLayerData(t){let i=!1;for(const r of t){const s=this.layerData.get(r);s&&(this._usedMemory-=s.usedMemory,s.type===3&&this.symbols.delete(r)&&(i=!0),s.destroy(),this.layerData.delete(r))}this._owner?.updateTileSize(this),i&&(this.featureIndex?.clear(),this.emit("symbols-changed")),this.requestRender()}processed(){return this._processed}hasData(){return this.layerData.size>0}hasFeatures(){const t=this.layerData.values();for(const i of t)if(i.hasData())return!0;return!1}dispose(){this.status!=="unloaded"&&(uE._destroyRenderBuckets(this.layerData),this.layerData.clear(),this.featureIndex=null,this._usedMemory=0,this.destroy(),this.status="unloaded")}release(){--this._referenced===0&&(this._owner?.onDisposeTile(this),this.dispose(),this.stage=null)}retain(){++this._referenced}get usedMemory(){return this._usedMemory}get usedMemoryPerReference(){return this._usedMemory/(this._referenced||1)}changeDataImpl(t){this.featureIndex?.clear();let i=!1;if(t){const{bucketsWithData:r,emptyBuckets:s}=t,n=this._createRenderBuckets(r);if(s&&s.byteLength>0){const a=new Uint32Array(s);for(const o of a)this._deleteLayerData(o)}for(const[a,o]of n)this._deleteLayerData(a),o.type===3&&(this.symbols.set(a,o.symbols),i=!0),this._usedMemory+=o.usedMemory,this.layerData.set(a,o);this._owner?.updateTileSize(this)}this._hasSymbolBuckets=!1;for(const r of this.layerData.values())r.type===3&&(this._hasSymbolBuckets=!0);i&&this.emit("symbols-changed")}attachWithContext(t){this.stage={context:t,trashDisplayObject(i){i.processDetach()},untrashDisplayObject:()=>!1}}setTransform(t){super.setTransform(t);const i=this.resolution/(t.resolution*t.pixelRatio),r=this.width/this.rangeX*i,s=this.height/this.rangeY*i,n=[0,0];t.toScreen(n,[this.x,this.y]);const a=this.transforms.tileUnitsToPixels;U2(a),up(a,a,n),H2(a,a,Math.PI*t.rotation/180),q2(a,a,[r,s,1])}_createTransforms(){return{displayViewScreenMat3:Jl(),tileMat3:Jl(),tileUnitsToPixels:Jl()}}static _destroyRenderBuckets(t){if(!t)return;const i=new Set;for(const r of t.values())i.has(r)||(r.destroy(),i.add(r));t.clear()}_createRenderBuckets(t){const i=new Map,r=new Map;for(const s of t){const n=this._deserializeBucket(s,r);for(const a of n.layerUIDs)i.set(a,n)}return i}_deserializeBucket(t,i){let r=i.get(t);if(r)return r;switch(new Uint32Array(t)[0]){case 1:r=new B$(t,this.styleRepository);break;case 2:r=new k$(t,this.styleRepository);break;case 3:r=new N$(t,this.styleRepository,this);break;case 4:r=new j$(t,this.styleRepository)}return i.set(t,r),r}_deleteLayerData(t){if(!this.layerData.has(t))return;const i=this.layerData.get(t);this._usedMemory-=i.usedMemory,i.destroy(),this.layerData.delete(t)}};function cf(e){return(e.uniqueSymbol?.show&&e.uniqueSymbol?.lastShow)??!1}function q$(e,t){if(e.priority-t.priority)return e.priority-t.priority;if(cf(e)&&!cf(t))return-1;if(cf(t)&&!cf(e))return 1;const i=e.tile.key,r=t.tile.key;return i.world-r.world?i.world-r.world:i.level-r.level?i.level-r.level:i.row-r.row?i.row-r.row:i.col-r.col?i.col-r.col:e.xTile-t.xTile?e.xTile-t.xTile:e.yTile-t.yTile}let G$=class{get running(){return this._running}constructor(e,t,i,r,s,n,a,o){this.selectionMode=e,this._visibleTiles=t,this._symbolRepository=i,this._styleRepository=r,this._createCollisionJob=s,this._assignTileSymbolsOpacity=n,this._symbolLayerSorter=a,this._isLayerVisible=o,this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}setScreenSize(e,t){this._screenWidth===e&&this._screenHeight===t||this.restart(),this._screenWidth=e,this._screenHeight=t}restart(){this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}continue(e){if(this._selectionJob||(this._selectionJob=this._createSelectionJob()),!this._selectionJobCompleted){const t=performance.now();if(!this._selectionJob.work(e)||(this._selectionJobCompleted=!0,(e=Math.max(0,e-(performance.now()-t)))===0))return!1}if(this._collisionJob||(this._collisionJob=this._createCollisionJob(this._selectionJob.sortedSymbols,this._screenWidth,this._screenHeight)),!this._collisionJobCompleted){const t=performance.now();if(!this._collisionJob.work(e)||(this._collisionJobCompleted=!0,(e=Math.max(0,e-(performance.now()-t)))===0))return!1}if(this._opacityJob||(this._opacityJob=this._createOpacityJob()),!this._opacityJobCompleted){const t=performance.now();if(!this._opacityJob.work(e)||(this._opacityJobCompleted=!0,(e=Math.max(0,e-(performance.now()-t)))===0))return!1}return this._running=!1,!0}_isFeatureFiltered(e,t,i){const r=t.getFilterFlags(e),s=r&UF,n=i.featureEffect==null||i.featureEffect.excludedLabelsVisible||r&jF;return!(s&&n)}_getFilteredByLayer(){let e;if(this._styleRepository?.layerContexts)for(const t of this._symbolRepository.uniqueSymbols){const i=this._styleRepository.layerContexts?.get(t.styleLayerUID);if(i?.attributeView)for(const r of t.uniqueSymbols){e??=new Map,e.get(t.styleLayerUID)||e.set(t.styleLayerUID,new Set);const s=e.get(t.styleLayerUID),n=i.attributeView,a=i.layerView;this._isFeatureFiltered(r.id,n,a)&&s.add(r.id)}}return e}_resetSelection(){for(let e=0;e<this._symbolRepository.uniqueSymbols.length;e++){const t=this._symbolRepository.uniqueSymbols[e];for(let i=0;i<t.uniqueSymbols.length;i++){const r=t.uniqueSymbols[i];for(const s of r.tileSymbols)s.selectedForRendering=!1}}}_createSelectionJob(){const e=this.selectionMode==="feature-tile"?W$:Z$,t=this._symbolRepository.uniqueSymbols;this._resetSelection();const i=[];let r=0,s=0;const n=this._isLayerVisible,a=this._getFilteredByLayer(),o=this._styleRepository?.layerContexts;function l(u){let p;const m=performance.now();for(;s<t.length;s++,r=0){const f=t[s],g=f.styleLayerUID,y=a?.get(g);let v=0;if(o){const b=o.get(g).layerView;v=b.view.allLayerViews.items.indexOf(b)}if(!n(g)){i[s]||(i[s]={styleLayerUID:g,layerOrder:v,symbols:[]});continue}i[s]||={styleLayerUID:g,symbols:[],layerOrder:v};const C=i[s];for(;r<f.uniqueSymbols.length;r++){if(p=f.uniqueSymbols[r],r%100==99&&performance.now()-m>u)return!1;if(p.lastShow=p.show,p.id&&y?.has(p.id)){p.show=!1,p.parts[0].show=!1,p.parts[1].show=!1;continue}const b=e(p);if(b){b.selectedForRendering=!0,C.symbols.push(b),p.show=!0;for(const S of p.parts)S.show=!0}else p.show=!1}}for(const f of i)f.symbols.sort(q$);return i.sort((f,g)=>g.layerOrder-f.layerOrder),!0}const c=this._symbolLayerSorter;return{work:l,get sortedSymbols(){return i.sort(c)}}}_createOpacityJob(){const e=this._assignTileSymbolsOpacity,t=this._visibleTiles;let i=0;function r(s,n){for(const a of s.symbols.values())$$(a,n);e(s,n);for(const a of s.childrenTiles)r(a,n)}return{work(s){const n=performance.now();for(;i<t.length;i++){if(performance.now()-n>s)return!1;const a=t[i];if(a.parentTile!=null)continue;const o=performance.now();a instanceof H$?r(a,o):e(a,o)}return!0}}}};function $$(e,t){for(const i of e){const r=i.uniqueSymbol;for(const s of r.parts){const n=s.targetOpacity>.5?1:-1;s.startOpacity+=n*((t-s.startTime)/kv),s.startOpacity=Math.min(Math.max(s.startOpacity,0),1),s.startTime=t,s.targetOpacity=r.show&&s.show?1:0}}}function W$(e){let t=null,i=null,r=null;for(const s of e.tileSymbols){const n=s.tile;n.isReady&&n.isCoverage?t=s:n.isReady?i=s:n.rendering&&(r=s)}return t??i??r}function Z$(e){let t=null,i=!1,r=!1;for(const s of e.tileSymbols)if(!r||!i){const n=s.tile;(!t||n.isCoverage||n.neededForCoverage&&!i)&&(t=s,(n.neededForCoverage||n.isCoverage)&&(r=!0),n.isCoverage&&(i=!0))}return r?t:null}let Q$=class Z1{static fromSymbols(t,i){let r=t.length;if(r>=X$){let s=i;do s/=2,r/=4;while(r>Y$&&s>K$);const n=new cE(i,i,s);for(const a of t)n.getCell(a.xTile,a.yTile).push(a);return new Z1(i,t,n)}return new Z1(i,t,null)}constructor(t,i,r){this.tileCoordRange=t,this._symbols=i,this._index=r}addSymbols(t){for(const i of t)this._symbols.push(i);if(this._index)for(const i of t)this._index.getCell(i.xTile,i.yTile).push(i)}removeSymbols(t){const i=new Set(t);if(this._symbols=this._symbols.filter(r=>!i.has(r)),this._index)for(const r of this._index.cells)for(let s=0;s<r.length;s++)r[s]=r[s].filter(n=>!i.has(n))}getSymbols(){return this._symbols}getCandidate(t,i,r,s){if(!this._index){for(const u of this._symbols)if(r===u.hash&&Math.abs(t-u.xTile)<=s&&Math.abs(i-u.yTile)<=s)return u;return null}const n=this._index.getCellSpan(t-s,i-s,t+s,i+s),[a,o,l,c]=n;for(let u=o;u<=c;u++)for(let p=a;p<=l;p++){const m=this._index.cells[u][p];for(const f of m)if(r===f.hash&&Math.abs(t-f.xTile)<=s&&Math.abs(i-f.yTile)<=s)return f}return null}};const X$=32,Y$=8,K$=64,qS=20;let J$=class{constructor(e,t){this.tileCoordRange=e,this._visibleTiles=t,this._indexMapByTile=new Map,this._uniqueSymbolsByStyleLayerId=new Map}get uniqueSymbols(){return this._uniqueSymbolLayerArray==null&&(this._uniqueSymbolLayerArray=this._createUniqueSymbolLayerArray()),this._uniqueSymbolLayerArray}registerVectorTile(e,t){const i=this._ensureIndexMap(e),r=t?.values()??i.keys();for(const s of r){const n=i.get(s);n&&(this._removeSymbols(s,n.getSymbols()),i.delete(s))}this._addSymbols(e.key,i,e.symbols),this._invalidate()}unregisterVectorTile(e){this._removeTile(e),this._invalidate()}registerFeatureTile(e){this._ensureIndexMap(e),this._invalidate()}unregisterFeatureTile(e){this._removeTile(e),this._invalidate()}insertFeatureTileMetrics(e,t){const i=this._indexMapByTile.get(e);if(!i)throw new Error(`tile ${e.id} not registered!`);this._addSymbols(e.key,i,GS(t)),this._invalidate()}removeFeatureTileMetrics(e,t){const i=this._indexMapByTile.get(e);if(!i)return;const r=GS(t);for(const[s,n]of i.entries()){const a=r.get(s);a&&(n.removeSymbols(a),this._removeSymbols(s,a))}this._invalidate()}deleteStyleLayers(e){for(const t of this._indexMapByTile.values())for(const i of e){const r=t.get(i);r&&(this._removeSymbols(i,r.getSymbols()),t.delete(i))}this._invalidate()}querySymbols(e,t,i,r){const s=[];for(const[n,a]of this._uniqueSymbolsByStyleLayerId.entries())for(const o of a){const l=o.tileSymbols.find(c=>c.selectedForRendering);l&&V$(l,e,t*(window.devicePixelRatio||1),i)&&s.push({vtlSymbol:l,styleLayerUID:n,tileKey:l.tile.key})}return s}_ensureIndexMap(e){let t=this._indexMapByTile.get(e);return t||(t=new Map,this._indexMapByTile.set(e,t)),t}_invalidate(){this._uniqueSymbolLayerArray=null}_addSymbols(e,t,i){for(const[r,s]of i){let n=t.get(r);n?n.addSymbols(s):(n=Q$.fromSymbols(s,this.tileCoordRange),t.set(r,n))}this._updateUniqueSymbols(e,i)}_removeTile(e){const t=this._indexMapByTile.get(e);if(t){for(const[i,r]of t.entries())this._removeSymbols(i,r.getSymbols());this._indexMapByTile.delete(e),this._invalidate()}}_removeSymbols(e,t){for(const i of t){const r=i.uniqueSymbol;if(r){if(r.tileSymbols=r.tileSymbols.filter(s=>s!==i),r.tileSymbols.length===0){const s=this._uniqueSymbolsByStyleLayerId.get(e);s.delete(r),s.size===0&&this._uniqueSymbolsByStyleLayerId.delete(e)}i.uniqueSymbol=null}}}_updateUniqueSymbols(e,t){if(t.size!==0){for(const i of this._visibleTiles)i.parentTile||i.key.world!==e.world||i.key.level===e.level&&!i.key.equals(e)||this._matchSymbols(i,e,t);for(const[i,r]of t)for(const s of r)if(!s.uniqueSymbol){s.uniqueSymbol=new O$(s);let n=this._uniqueSymbolsByStyleLayerId.get(i);n||(n=new Set,this._uniqueSymbolsByStyleLayerId.set(i,n)),n.add(s.uniqueSymbol)}}}_matchSymbols(e,t,i){if(e.key.level>t.level){const s=e.key.level-t.level;if(e.key.row>>s!==t.row||e.key.col>>s!==t.col)return}if(t.level>e.key.level){const s=t.level-e.key.level;if(t.row>>s!==e.key.row||t.col>>s!==e.key.col)return}const r=new Map;for(const[s,n]of i){const a=[],o=e.key.level<t.level?1:1<<Math.abs(e.key.level-t.level),l=this._indexMapByTile.get(e),c=l?.get(s);if(c)for(const u of n){if(u.uniqueSymbol)continue;const p=E$(this.tileCoordRange,u.xTile,t,e.key),m=A$(this.tileCoordRange,u.yTile,t,e.key),f=-qS,g=this.tileCoordRange+qS;if(!(p>=f&&p<g&&m>=f&&m<g)){a.push(u);continue}const y=c.getCandidate(p,m,u.hash,o),v=y?.uniqueSymbol;v?(u.uniqueSymbol=v,v.tileSymbols.push(u)):a.push(u)}a.length>0&&r.set(s,a)}for(const s of e.childrenTiles||[])this._matchSymbols(s,t,r)}_createUniqueSymbolLayerArray(){const e=this._uniqueSymbolsByStyleLayerId,t=new Array(e.size);let i,r=0;for(const[s,n]of e){const a=new Array(n.size);i=0;for(const o of n)a[i++]=o;t[r]={styleLayerUID:s,uniqueSymbols:a},r++}return t}};function GS(e){const t=new Map;for(const i of e){const r=i.labelClassId;let s=t.get(r);s||(s=[],t.set(r,s)),s.push(i)}return t}function eW(e,t){const i=e.transforms.tileUnitsToPixels,r=K4(t),s=Math.cos(r),n=Math.sin(r),a=Math.ceil(512*(Math.abs(n)+Math.abs(s)));U2(zn),up(zn,zn,[a/2,a/2]),H2(zn,zn,r),up(zn,zn,[-256,-256]),q2(zn,zn,[1/8,1/8,1]),e.transforms.tileUnitsToPixels=zn;const o=[],l=new J$(yp,o),c=new G$("vector-tile",o,l,null,(u,p,m)=>new z$(u,p,m,e.styleRepository,e.key.level,t),(u,p)=>{L$(u,p,!1)},()=>0,u=>{const p=e.styleRepository.getStyleLayerByUID(u).getLayoutProperty("visibility");return!p||p.getValue()!==1});o.push(e),l.registerVectorTile(e),c.setScreenSize(a,a),c.continue(1/0),l.unregisterVectorTile(e),e.transforms.tileUnitsToPixels=i}const zn=Jl();let tW=class extends hE{_createTransforms(){return{displayViewScreenMat3:Jl(),tileMat3:Jl()}}},iW=class{constructor(){this._candidateTiles=[]}schedule(e){this._candidateTiles.includes(e)||this._candidateTiles.push(e)}reshuffle(e){const t=[];for(const i of this._candidateTiles)e>0?(i.reshuffle(),e--):t.push(i);this._candidateTiles=t}},rW=class{constructor(){this._renderParams={reshuffleManager:new iW,context:null,drawPhase:1,state:new sW,stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,requestRender:null,allowDelayedRender:!1,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1,highlightGradient:null,stencilSymbols:!0,is3D:!0,backgroundColor:null,animationsEnabled:!0},this._backgroundTile=new tW(new ib(0,0,0,0),0,0,0,fx,fx,yp,yp),this._heading=0,this._declutteredForHeading=new WeakMap}dispose(){this._renderParams=null}renderBackground(e,t,i,r,s,n,a,o,l,c){const u=this._backgroundTile;this._updateRenderParameters(e,t,u,i,s,n,a,o,l,c),this._renderParams.stencilSymbols=!1,i.drawBackground(this._renderParams,u,r)}renderContent(e,t,i,r,s,n,a,o,l,c,u,p){this._declutter(i),r.forAll(({sourceLayerInfo:{data:g}})=>this._declutter(g));const m=r.length>0;m&&this._stencilSymbols(e,t,i,r,s,n,a,o,l,c,u,p);let f=1;i.stencilRef=m?f:0,e.setStencilFunction(514,i.stencilRef,255),this._render(e,t,i,s,n,a,o,l,c,u,p),r.forAll(({sourceLod:g,offset:y,sourceLayerInfo:{data:v}})=>{v.stencilRef=++f,this._renderSymbols(e,g,v,s,n,a,o,y,c,u,p)})}_stencilSymbols(e,t,i,r,s,n,a,o,l,c,u,p){let m=1;i.stencilRef=m,e.setDepthTestEnabled(!1),e.setDepthWriteEnabled(!1),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!1),e.setStencilOp(7680,7680,7681),e.setStencilWriteMask(255),e.setStencilFunction(519,i.stencilRef,255),this._stencilTileSymbols(e,t,i,s,n,a,o,l,c,u,p),r.forAll(({sourceLod:f,offset:g,sourceLayerInfo:{data:y}})=>{y.stencilRef=++m,e.setStencilFunction(519,y.stencilRef,255),this._stencilTileSymbols(e,f,y,s,n,a,o,g,c,u,p)}),e.setStencilWriteMask(0),e.setBlendingEnabled(!0),e.setDepthTestEnabled(!0),e.setColorMask(!0,!0,!0,!0)}_renderSymbols(e,t,i,r,s,n,a,o,l,c,u){e.setStencilFunction(514,i.stencilRef,255),this._render(e,t,i,r,s,n,a,o,l,c,u,3)}_render(e,t,i,r,s,n,a,o,l,c,u,p){this._updateRenderParameters(e,t,i,r,n,a,o,l,c,u),this._renderParams.stencilSymbols=!1,r.drawTile(this._renderParams,i,s,p)}_stencilTileSymbols(e,t,i,r,s,n,a,o,l,c,u){this._updateRenderParameters(e,t,i,r,n,a,o,l,c,u),this._renderParams.stencilSymbols=!0,i.triangleCount=0,r.drawSymbols(this._renderParams,i,s)}_updateRenderParameters(e,t,i,r,s,n,a,o,l,c){"type"in i&&i.type==="vector-tile"&&!i.stage&&i.attachWithContext(e);const u=t[0]-s.getLevelShift(t[0]),p=this._renderParams;p.context=e,p.painter=r,p.glyphMosaic=r.glyphMosaic,p.spriteMosaic=r.spriteMosaic,p.pixelRatio=l*c,p.displayLevel=u,p.requiredLevel=u;const m=s.getScale(t[0]),[f,g]=s.getOffset(t,n*m),y=PL*n*m/o,v=i.transforms.displayViewScreenMat3;v[0]=y,v[4]=-y,v[6]=-1-f-a[0]*n*2,v[7]=1+g+(1-a[1])*n*2-2;const C=p.state,b=o/c;C.size[0]=b,C.size[1]=b,C.pixelRatio=c,C.rotation=(360-this._heading)%360;const S=2/b;Q4(C.displayViewMat3,S,0,0,0,-S,0,-1,1,1);const x=U2(C.displayMat3),T=K4(this._heading);up(x,x,[b/2,b/2]),H2(x,x,T),up(x,x,[-b/2,-b/2]),X4(x,C.displayViewMat3,x)}updateHeading(e){this._heading=e}_declutter(e){this._declutteredForHeading.get(e)!==this._heading&&(eW(e,(360-this._heading)%360),this._declutteredForHeading.set(e,this._heading))}},sW=class{constructor(){this.size=[0,0],this.pixelRatio=1,this.rotation=0,this.displayMat3=Rn(),this.displayViewMat3=Rn(),this.transform=null,this.inverseTransform=null,this.viewMat2d=null,this.viewMat3=null,this.id=0,this.extent=null,this.center=null,this.scale=1,this.resolution=0,this.worldScreenWidth=0,this.spatialReference=null,this.viewpoint=null,this.getScreenTransform=null,this.toMap=null,this.toScreen=null,this.clone=null,this.copy=null,this.toJSON=null}},dE=class extends hr{constructor(){super(...arguments),this.blendMode=0}};h([z({count:31})],dE.prototype,"blendMode",void 0);let np=class extends dE{constructor(){super(...arguments),this.output=1,this.baseOpacityMode=0,this.premultipliedSource=0}};h([z({count:5})],np.prototype,"output",void 0),h([z({count:2})],np.prototype,"baseOpacityMode",void 0),h([z({count:2})],np.prototype,"premultipliedSource",void 0);let pE=class extends np{constructor(){super(...arguments),this.background=0}};h([z({count:2})],pE.prototype,"background",void 0);function nW(e){e.fragment.uniforms.add(new Ne("u_colormap",t=>t.u_colormap),new _e("u_colormapOffset",t=>t.colormap.u_colormapOffset),new _e("u_colormapMaxIndex",t=>t.colormap.u_colormapMaxIndex),new _e("u_opacity",t=>t.common.u_opacity)),e.fragment.code.add(_`vec4 colormap(vec4 currentPixel, bool isFloat) {
float colorIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;
vec4 result;
if (currentPixel.a == 0.0 || colorIndex > u_colormapMaxIndex) {
result = vec4(0.0, 0.0, 0.0, 0.0);
} else {
vec2 texelCoordinates = vec2((colorIndex + 0.5), 0.5);
result = texelFetch(u_colormap, ivec2(texelCoordinates), 0);
}
return result;
}`)}function aW(e){e.fragment.uniforms.add(new Ne("u_transformGrid",t=>t.u_transformGrid),new qs("u_transformSpacing",t=>t.common.u_transformSpacing),new qs("u_targetImageSize",t=>t.common.u_targetImageSize)),e.fragment.code.add(_`vec2 projectPixelLocation(vec2 coords) {
vec2 index_image = floor(coords * u_targetImageSize);
vec2 oneTransformPixel = vec2(4.0, 1.0);
vec2 index_transform = floor(index_image / u_transformSpacing) * oneTransformPixel;
vec2 pos = fract((index_image + 0.5) / u_transformSpacing);
vec2 transform_location = index_transform + 0.5;
vec2 srcLocation;
if (pos.s <= pos.t) {
vec3 ll_abc = texelFetch(u_transformGrid, ivec2(transform_location), 0).rgb;
vec3 ll_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 1.0, transform_location.t), 0).rgb;
srcLocation.s = dot(ll_abc, vec3(pos, 1.0));
srcLocation.t = dot(ll_def, vec3(pos, 1.0));
} else {
vec3 ur_abc = texelFetch(u_transformGrid, ivec2(transform_location.s + 2.0, transform_location.t), 0).rgb;
vec3 ur_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 3.0, transform_location.t), 0).rgb;
srcLocation.s = dot(ur_abc, vec3(pos, 1.0));
srcLocation.t = dot(ur_def, vec3(pos, 1.0));
}
return srcLocation;
}`)}let oW=class extends rE{constructor(e,t,i){super(),this.common=e,this.u_image=t,this.u_transformGrid=i}};function lW(e,t){e.include(aW),e.fragment.uniforms.add(new Ne("u_image",r=>r.u_image),new au("u_flipY",r=>r.common.u_flipY),new au("u_applyTransform",r=>r.common.u_applyTransform));const{requireBilinearWithNN:i}=t;i&&e.fragment.uniforms.add(new qs("u_srcImageSize",r=>r.common.u_srcImageSize)),e.fragment.code.add(_`vec2 getPixelLocation(vec2 coords) {
vec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;
if (!u_applyTransform) {
return targetLocation;
}
return projectPixelLocation(targetLocation);
}
bool isOutside(vec2 coords){
if (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {
return true;
} else {
return false;
}
}`),i?e.fragment.code.add(_`vec4 sampleBilinear(sampler2D sampler, vec2 coords, vec2 texSize) {
vec2 texelStart = floor(coords * texSize);
vec2 coord0 = texelStart / texSize;
vec2 coord1 = (texelStart +  vec2(1.0, 0.0)) / texSize;
vec2 coord2 = (texelStart +  vec2(0.0, 1.0)) / texSize;
vec2 coord3 = (texelStart +  vec2(1.0, 1.0)) / texSize;
vec4 color0 = texture(sampler, coord0);
vec4 color1 = texture(sampler, coord1);
vec4 color2 = texture(sampler, coord2);
vec4 color3 = texture(sampler, coord3);
vec2 blend = fract(coords * texSize);
vec4 color01 = mix(color0, color1, blend.x);
vec4 color23 = mix(color2, color3, blend.x);
vec4 color = mix(color01, color23, blend.y);
float alpha = floor(color0.a * color1.a * color2.a * color3.a + 0.5);
color = color * alpha + (1.0 - alpha) * texture(sampler, coords);
return color;
}
vec4 getPixel(vec2 pixelLocation) {
return sampleBilinear(u_image, pixelLocation, u_srcImageSize);
}`):e.fragment.code.add(_`vec4 getPixel(vec2 pixelLocation) {
return texture(u_image, pixelLocation);
}`)}let K_=class extends oW{constructor(e,t,i,r,s,n){super(e,r,s),this.colormap=t,this.symbolizer=i,this.u_colormap=n,this.backgroundColor=ia,this.fboTexture=null,this.baseOpacity=1}},mE=class extends K_{},fE=class extends K_{};function gE(e){const t=new ut;return t.include(sE),t.include(lW,e),t.include(nW,e),t.include(nE,e),t.fragment.code.add(_`vec4 applyBackgroundBlend(vec4 layerColor) {
return blendLayers(vuv, layerColor, u_opacity);
}`),e.colorizerType===0?hW(t,e):e.colorizerType===1?cW(t):e.colorizerType===2&&uW(t,e),t}function cW(e){e.fragment.main.add(_`vec2 pixelLocation = getPixelLocation(uv);
if (isOutside(pixelLocation)) {
fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
return;
}
vec4 currentPixel = getPixel(pixelLocation);
fragColor = applyBackgroundBlend(colormap(currentPixel, true));`)}function hW(e,t){e.fragment.uniforms.add(new hc("u_bandCount",r=>r.symbolizer.u_bandCount),new us("u_minCutOff",r=>r.symbolizer.u_minCutOff,3),new us("u_maxCutOff",r=>r.symbolizer.u_maxCutOff,3),new us("u_factor",r=>r.symbolizer.u_factor,3),new _e("u_minOutput",r=>r.symbolizer.u_minOutput),new _e("u_maxOutput",r=>r.symbolizer.u_maxOutput),new au("u_useGamma",r=>r.symbolizer.u_useGamma),new us("u_gamma",r=>r.symbolizer.u_gamma,3),new us("u_gammaCorrection",r=>r.symbolizer.u_gammaCorrection,3),new _e("u_opacity",r=>r.common.u_opacity)),e.fragment.code.add(_`float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {
if (val >= maxCutOff) {
return maxOutput;
} else if (val <= minCutOff) {
return minOutput;
}
float stretchedVal;
if (useGamma) {
float tempf = 1.0;
float outRange = maxOutput - minOutput;
float relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);
if (gamma > 1.0) {
tempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);
}
stretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;
} else {
stretchedVal = minOutput + (val - minCutOff) * factor;
}
return stretchedVal;
}`);const i=t.applyColormap?_`fragColor = applyBackgroundBlend(colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma));`:_`fragColor = applyBackgroundBlend(vec4(grayVal, grayVal, grayVal, currentPixel.a));`;e.fragment.main.add(_`
    vec2 pixelLocation = getPixelLocation(uv);
    if (isOutside(pixelLocation)) {
      fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
      return;
    }

    vec4 currentPixel = getPixel(pixelLocation);
    ${t.stretchType===0?_`fragColor = applyBackgroundBlend(currentPixel);`:_`
    if (currentPixel.a == 0.0) {
      fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
      return;
    }
    if (u_bandCount == 1) {
      float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
      ${i}
    } else {
      float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
      float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);
      float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);
      fragColor = applyBackgroundBlend(vec4(redVal, greenVal, blueVal, currentPixel.a));
    }`}`)}function uW(e,t){const i=e.fragment;i.uniforms.add(new Ne("u_image",s=>s.u_image),new hc("u_hillshadeType",s=>s.symbolizer.u_hillshadeType),new us("u_sinZcosAs",s=>s.symbolizer.u_sinZcosAs,6),new us("u_sinZsinAs",s=>s.symbolizer.u_sinZsinAs,6),new us("u_cosZs",s=>s.symbolizer.u_cosZs,6),new us("u_weights",s=>s.symbolizer.u_weights,6),new qs("u_factor",s=>s.symbolizer.u_factor),new _e("u_minValue",s=>s.symbolizer.u_minValue),new _e("u_maxValue",s=>s.symbolizer.u_maxValue),new qs("u_srcImageSize",s=>s.common.u_srcImageSize)),i.include(S2),i.code.add(_`vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {
val = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);
vec4 color = colormap(vec4(val, val, val, 1.0), false);
vec3 hsv = rgb2hsv(color.rgb);
hsv.z = hillshade;
return vec4(hsv2rgb(hsv), 1.0) * alpha * color.a;
}`),i.code.add(_`float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){
if (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {
return 0.0;
}  else {
return e;
}
}`);const r=t.applyColormap?_`fragColor = applyBackgroundBlend(overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha));`:_`hillshade *= alpha;
fragColor = applyBackgroundBlend(vec4(hillshade, hillshade, hillshade, alpha));`;i.main.add(_`
      vec2 pixelLocation = getPixelLocation(uv);
      if (isOutside(pixelLocation)) {
        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      vec4 currentPixel = getPixel(pixelLocation);
      if (currentPixel.a == 0.0) {
        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      //mirror edge pixels
      vec2 axy = vec2(-1.0, -1.0);
      vec2 bxy = vec2(0.0, -1.0);
      vec2 cxy = vec2(1.0, -1.0);
      vec2 dxy = vec2(-1.0, 0.0);
      vec2 fxy = vec2(1.0, 0.0);
      vec2 gxy = vec2(-1.0, 1.0);
      vec2 hxy = vec2(0.0, 1.0);
      vec2 ixy = vec2(1.0, 1.0);
      vec2 onePixel = 1.0 / u_srcImageSize;
      if (pixelLocation.s < onePixel.s) {
        axy[0] = 1.0;
        dxy[0] = 1.0;
        gxy[0] = 1.0;
      }
      if (pixelLocation.t < onePixel.t) {
        axy[1] = 1.0;
        bxy[1] = 1.0;
        cxy[1] = 1.0;
      }
      if (pixelLocation.s > 1.0 - onePixel.s) {
        cxy[0] = -1.0;
        fxy[0] = -1.0;
        ixy[0] = -1.0;
      }
      if (pixelLocation.t > 1.0 - onePixel.t) {
        gxy[1] = -1.0;
        hxy[1] = -1.0;
        ixy[1] = -1.0;
      }

      // calculate hillshade
      vec4 va = texture(u_image, pixelLocation + onePixel * axy);
      vec4 vb = texture(u_image, pixelLocation + onePixel * bxy);
      vec4 vc = texture(u_image, pixelLocation + onePixel * cxy);
      vec4 vd = texture(u_image, pixelLocation + onePixel * dxy);
      vec4 ve = texture(u_image, pixelLocation);
      vec4 vf = texture(u_image, pixelLocation + onePixel * fxy);
      vec4 vg = texture(u_image, pixelLocation + onePixel * gxy);
      vec4 vh = texture(u_image, pixelLocation + onePixel * hxy);
      vec4 vi = texture(u_image, pixelLocation + onePixel * ixy);

      // calculate the rate of z change along the x, y, and diagonal direction
      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;
      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;
      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);
      float hillshade = 0.0;

      // traditional single light source
      if (u_hillshadeType == 0){
        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;
        float z = (u_cosZs[0] + cosDelta) / dzd;
        if (z < 0.0)  z = 0.0;
        hillshade = z;
      } else {
        // multi-directional with 6 light sources
        for (int k = 0; k < 6; k++) {
        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;
        float z = (u_cosZs[k] + cosDelta) / dzd;
        if (z < 0.0) z = 0.0;
        hillshade = hillshade + z * u_weights[k];
        if (k == 5) break;
        }
      }

      // set color
      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);
      alpha *= u_opacity;
      ${r}`)}const dW=Object.freeze(Object.defineProperty({__proto__:null,ColorizerHillshadeUniforms:fE,ColorizerStretchUniforms:mE,ColorizerUniforms:K_,build:gE},Symbol.toStringTag,{value:"Module"}));let $S=class extends ct{constructor(e,t){super(e,t,new ht(dW,()=>k(()=>Promise.resolve().then(()=>nee),void 0)),Ja(zp))}},Rd=class extends np{constructor(){super(...arguments),this.colorizerType=0,this.stretchType=0,this.applyColormap=!0,this.requireBilinearWithNN=!1}};h([z({count:3})],Rd.prototype,"colorizerType",void 0),h([z({count:2})],Rd.prototype,"stretchType",void 0),h([z()],Rd.prototype,"applyColormap",void 0),h([z()],Rd.prototype,"requireBilinearWithNN",void 0);let WS=class{constructor(e){this._rctx=e,this._fbos=new Map}get(e){return this._getPool(e)}dispose(){this._fbos.forEach(e=>e.dispose()),this._fbos.clear()}_getPool(e){const t=this._fbos.get(e);if(t)return t;const i=new Wo(this._rctx,new gt(e),new X7(iu.DEPTH24_STENCIL8,e));return this._fbos.set(e,i),i}};function Zo(e,t=0,i=-1,r=1){const s=t===1,n=s?vy?new Float32Array([i,i,0,r,i,0,i,r,0,r,r,0]):new Float32Array([i,i,0,0,r,i,1,0,i,r,0,1,r,r,1,1]):new Float32Array([i,i,r,i,i,r,r,r]);if(s&&vy){const a=vM(n.buffer);a[10]=a[17]=a[22]=a[23]=1}return new Dn(e,new ei(e,s?vy?zp:kA:qP,n))}const pW=4;function _E(e){const t=new gt(pW);return t.samplingMode=9728,new bt(e,t)}const mW=()=>$.getLogger("esri.views.3d.terrain");let fW=class{constructor(e,t){this._rctx=e,this._techniques=t,this._fbos=[],this._vectorTileHelper=new rW,this._bindParameters=new Gb(null),this._blendConfiguration=new pE,this._current=0,this._lastUsedIds=new Array,this._lastCreatedBufferId=0,this._onHoldIds=new Array,this._vao=Zo(this._rctx,1)}dispose(){this._fbos.forEach(ye),this._fbos=null,this._vtFBO=ye(this._vtFBO),this._vao=ye(this._vao),this._vectorTileHelper=ye(this._vectorTileHelper)}updateHeading(e){this._vectorTileHelper?.updateHeading(e)}_acquireBlendTechnique(e,t,i,r=0,s=0){return this._blendConfiguration.output=t,this._blendConfiguration.blendMode=e,this._blendConfiguration.baseOpacityMode=i,this._blendConfiguration.premultipliedSource=r,this._blendConfiguration.background=s,this._techniques.precompile(HS,this._blendConfiguration),this._techniques.get(HS,this._blendConfiguration)}drawBackground(e,t){const i=this._acquireBlendTechnique(0,t?2:3,0,0,1),r=this._rctx.bindTechnique(i,this._bindParameters,e);this._render(r)}_render(e){this._rctx.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),this._rctx.drawArrays(St.TRIANGLE_STRIP,0,this._vao.vertexCount("geometry"))}drawGroup(e,t,i,r,s=1){t===1&&(e.fboTexture=this._fbos[this.getLastOnHoldId()].get(i).colorTexture,e.fboTexture==null&&(e.fboTexture=this._rctx.emptyTexture)),e.texture=this.currentFBO(i).colorTexture,this.closeGroup(i);const n=e.baseOpacity<1?1:0,a=this._acquireBlendTechnique(r,t,n,s),o=this._rctx.bindTechnique(a,this._bindParameters,e);this._render(o)}drawImageData(e,t,i,r,s=0){if(e.texture==null)return;const n=e.baseOpacity<1?1:0;e.fboTexture=t===4||r===0&&n===0&&s===0?null:this.switch(i).colorTexture,e.fboTexture==null&&(e.fboTexture=this._rctx.emptyTexture);const a=this._acquireBlendTechnique(r,t,n,s),o=this._rctx.bindTechnique(a,this._bindParameters,e);this._render(o)}drawRasterData(e,t,i,r,s){const n=s.sourceLayerInfo.data;if(!n.source||(s.tile.surface.layerViewByIndex(s.layerIndex,1).ensureSymbolizerParameters(n),!n.bind(this._rctx)))return;const a=e.baseOpacity<1?1:0;e.fboTexture=r===0&&a===0?null:this.switch(i).colorTexture;const o=this._acquireRasterTechnique(n,t,r,a);if(!o)return;n.opacity=e.opacity;const l=n.getUniforms(this._rctx);l.scale=s.scale,l.offset=s.offset,l.backgroundColor=e.backgroundColor,l.fboTexture=e.fboTexture,l.baseOpacity=e.baseOpacity;const c=this._rctx.bindTechnique(o,this._bindParameters,l);this._render(c)}_acquireRasterTechnique(e,t,i,r){if(!this._rctx.capabilities.colorBufferFloat)return null;const s=e.symbolizerParameters,n=["stretch","lut","hillshade"].indexOf(s.type);return this._rasterConfiguration??=new Rd,this._rasterConfiguration.output=t,this._rasterConfiguration.blendMode=i,this._rasterConfiguration.baseOpacityMode=r,this._rasterConfiguration.colorizerType=n,this._rasterConfiguration.applyColormap=!!s.colormap,this._rasterConfiguration.requireBilinearWithNN=e.isBilinearWithStretchColorRamp,this._rasterConfiguration.stretchType=e.hasStretchTypeNone()?0:1,this._techniques.precompile($S,this._rasterConfiguration),this._techniques.get($S,this._rasterConfiguration)}drawVectorData(e,t,i,r,s,n,a,o){const l=this._rctx,c=s.sourceLayerInfo.data,u=s.tile.surface.layerViewByIndex(s.layerIndex,1),p=e.baseOpacity<1?1:0,m=p===1||e.opacity<1||r!==0||t!==1,f=m?1:0,g=this._acquireBlendTechnique(r,t,p,f);l.setPipelineState(g.getPipeline());let y=null,v=null;m?(v=this.currentFBO(i),this._vtFBO==null&&(this._vtFBO=new WS(this._rctx)),y=this._vtFBO.get(i),l.bindFramebuffer(y),this._clearCurrentFBO()):o&&l.clear(256);try{this._vectorTileHelper.renderBackground(l,s.sourceLod,u.painter,u.layer.styleRepository,u.schemaHelper,Math.round(1/s.scale),s.offset,a,n,u.contentZoom),c&&this._vectorTileHelper.renderContent(l,s.sourceLod,c,s.vtlNeighborInfos,u.painter,u.layer.styleRepository,u.schemaHelper,Math.round(1/s.scale),s.offset,a,n,u.contentZoom)}catch(C){mW().warnOnce("A render call containing vector tiles did not resolve correctly.",C)}return!y||(l.bindFramebuffer(v),e.texture=y.colorTexture,e.offset=mp,e.scale=1,this.drawImageData(e,t,i,r,f),o)}copyFBOToTexture(e){const t=this._rctx,i=t.bindTexture(e.texture,bt.TEXTURE_UNIT_FOR_UPDATES),r=e.descriptor;t.gl.copyTexImage2D(3553,0,r.pixelFormat,0,0,r.width,r.height,0),e.generateMipmap(),t.bindTexture(i,bt.TEXTURE_UNIT_FOR_UPDATES)}_clearCurrentFBO(){this._rctx.setStencilWriteMask(255),this._rctx.setClearColor(0,0,0,0),this._rctx.setClearDepth(1),this._rctx.setClearStencil(0),this._rctx.clear(17664)}_initFBO(e,t,i){this._rctx.bindFramebuffer(e),i&&(this._rctx.setViewport(0,0,t,t),this._clearCurrentFBO())}ensureBuffer(e){this._lastUsedIds.length=0,this._lastUsedIds.push(1),this._lastCreatedBufferId=1,this._onHoldIds.length=0,this.bind(e)}bind(e,t=0,i=!0){if(this._current=t,t>=this._fbos.length)for(let r=this._fbos.length;r<=t;r++)this._fbos.push(new WS(this._rctx));this._initFBO(this._fbos[t].get(e),e,i)}_bindNextFreeBuffer(e){this._lastUsedIds.length>0?this.bind(e,this._lastUsedIds.pop()):(this._lastCreatedBufferId++,this.bind(e,this._lastCreatedBufferId))}openGroup(e){this._onHoldIds.push(this._current),this._bindNextFreeBuffer(e)}switch(e){const t=this.currentFBO(e),i=this._current;return this._bindNextFreeBuffer(e),this._lastUsedIds.push(i),t}getLastOnHoldId(){return this._onHoldIds[this._onHoldIds.length-1]}closeGroup(e){const t=this._current;this._bindNextFreeBuffer(e),this._lastUsedIds.push(t),this._lastUsedIds.push(this._onHoldIds.pop())}unbind(){this._rctx.bindFramebuffer(null)}currentFBO(e){return this._fbos[this._current].get(e)}},gW=class{constructor(){this.sourceLod=[0,0,0],this.offset=[0,0],this.scale=1,this.layerIndex=0,this.isVTLBackground=!1,this.vtlNeighborInfos=new jt({allocator:e=>e||new _W})}},_W=class{constructor(){this.sourceLayerInfo=null,this.sourceLod=[0,0,0],this.offset=[-1,0]}},ZS=class{constructor(e,t){this._texture=e,this._cache=t,this.type="tile-texture",this._refCount=1,this._texture.descriptor.context.instanceCounter.increment(yi.TileTexture,this)}retain(){++this._refCount}release(){--this._refCount,this._refCount===0&&(this._cache?(this._texture.abortCompression(),this._cache.put(Q1(this.descriptor),this)):this.dispose())}dispose(){this._texture.descriptor.context.instanceCounter.decrement(yi.TileTexture,this),this._texture.dispose()}get texture(){return this._texture}generateMipmap(){this._texture.generateMipmap()}get descriptor(){return this._texture.descriptor}get usedMemory(){return this._texture.usedMemory}};function Q1(e,t=p8(e.internalFormat)){return`${e.width} ${e.pixelFormat} ${t}`}const X1={normal:0,average:1,lighten:2,lighter:3,screen:5,plus:4,"color-dodge":6,darken:7,multiply:8,"color-burn":9,overlay:10,"soft-light":11,"hard-light":12,"vivid-light":13,hue:14,saturation:15,luminosity:16,color:17,difference:26,exclusion:27,minus:28,invert:29,reflect:30,"destination-over":18,"destination-atop":19,"destination-in":20,"destination-out":21,"source-atop":22,"source-in":23,"source-out":24,xor:25};function yW(e){return e===18||e===19||e===20||e===21||e===22||e===23||e===24||e===25}function yE(e,t){let i=t.width,r=t.height;return(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement)&&(i=e.width,r=e.height),(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof Uint8Array)&&(t.pixelFormat===6408||t.pixelFormat===6407)&&nc(i)&&nc(r)&&i>=16&&r>=16}let vW=class extends HF{constructor(e){super("TextureCompressionWorker","compress",{compress:t=>[t.data]},e)}async destroyWorkerAndSelf(){await this.broadcast({},"destroy"),this.destroy()}isCompressible(e,t){return yE(e,t)}},bW=class{constructor(e,t,i,r,s,n){this.start=e,this.end=t,this.blendMode=i,this.opacity=r,this.output=s,this.baseOpacity=n}},wW=class{constructor(e,t,i,r,s){this._rctx=e,this.tileSize=t,this._techniques=i,this._cache=r,this._compressionTracker=s,this._passParameters=new M$,this._backgroundColor=null,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._compositor=new fW(this._rctx,this._techniques)}dispose(){this._compositor=ye(this._compositor),this._backgroundTexture=Ht(this._backgroundTexture)}get backgroundIsGrid(){return this._backgroundColor==null}get backgroundColor(){return this._backgroundColor}updateHeading(e){this._compositor?.updateHeading(e)}updateTileTexture(e,t){if(!e.renderData)return;const i=e.surface,r=i.baseOpacity;let s=0,n=0,a=this.tileSize,o=!1,l=!1;const c=i.view.state.contentPixelRatio;let u=!1;v_.clear(),Gc.length=0;const p=e.layerInfo[1];let m=0,f=null;for(;m<p.length;m++){const y=i.layerViewByIndex(m,1),v=y.layer,C=!Kl(e,y),b=v.opacity,S=y.fullOpacity;if(l=l||Tf(v),US(y))continue;if(Op(y)){let P=y.layer.blendMode!=="normal";if(Kh(v.parent)){const R=v.parent.uid;R!=null&&R!==""&&(P=vE(v.parent)||P)}P&&(u=P,o=!1)}if((C||b===0)&&!u){p[m].pendingUpdates&=-1;continue}++n;const x=cu(y),T=N0(e,m,x);if(T){if(p[m].pendingUpdates&=-1,Kh(v.parent)){const P=v.parent.uid;P!=null&&P!==""&&bE(v.parent,m)}x?a=Math.max(a,this.tileSize*c):r===1&&S===1&&(y.isOpaque||this._dataToTexture(T,my(v))&&T.sourceLayerInfo.data.descriptor.isOpaque)&&(o=!0),++s,f===null&&(f=m)}}const g=a/this.tileSize;s!==0&&f!==null?s===1&&!u&&this._useLayerTexture(e,f)||this._composeLayers(e,t,m-1,l,a,g,!o||u,v_,u):this._useBackgroundTexture(e,n,t!==0)}setBackground(e){this._backgroundColor!==e&&(this._backgroundColor=e,this._backgroundTexture&&this._drawBackgroundTexture(this._backgroundTexture))}_ensureBackgroundTexture(){return this._backgroundTexture==null&&(this._backgroundTexture=this._buildTexture(this.tileSize,!1),this._drawBackgroundTexture(this._backgroundTexture)),this._backgroundTexture}_drawBackgroundTexture(e){this._compositor.bind(this.tileSize),this._passParameters.offset=mp,this._passParameters.scale=1,this._passParameters.opacity=1,this.backgroundColor&&(this._passParameters.backgroundColor=this.backgroundColor),this._compositor.drawBackground(this._passParameters,this.backgroundColor!=null),this._compositor.copyFBOToTexture(e),this._compositor.unbind()}_useBackgroundTexture(e,t,i){const r=e.renderData,s=!i&&r.textureReference!=null&&(e.surface.view.layerViewManager.updating||t>0)?5e3:0,n=this._ensureBackgroundTexture();r.setTextureReference(new lg(n,0,QS,e.surface.baseOpacity,0,1),s)}_useLayerTexture(e,t){const i=e.surface.layerViewByIndex(t,1),r=Tf(i.layer),s=r?e.surface.baseOpacity:1,n=r?1:e.surface.baseOpacity,a=i.fullOpacity,o=N0(e,t,!1);return!!this._dataToTexture(o,my(i.layer))&&(e.renderData.setTextureReference(new lg(o.sourceLayerInfo.data,0,Mi(o.offset[0],o.offset[1],o.scale,o.scale),s,n,a)),!0)}_composeLayers(e,t,i,r,s,n,a,o,l){this._compositor.ensureBuffer(s);const c=e.surface.baseOpacity;let u=!1,p=9987,m=!1,f=0;for(let C=i;C>=0;C--){const b=e.surface.layerViewByIndex(C,1),S=b.layer,x=cu(b),T=N0(e,C,x),P=S.opacity,R=!Kl(e,b);if(!T||(P===0||R)&&!l||US(b))continue;const O=!Tf(S)&&!u;O&&(u=!0);let E=!1;o.forEach(L=>{L.start===C&&(L.output=r?1:a&&O?this.backgroundIsGrid?3:2:1,L.baseOpacity=O?c:1,Gc.push(L),this._compositor.openGroup(s),E=!0)});const A=E?4:a&&f===0?this.backgroundIsGrid?3:2:1,F=X1[Op(b)?b.layer.blendMode:"normal"];for(this._passParameters.baseOpacity=O&&!E&&c<1?c:1,this._passParameters.opacity=P,MH(T)?m=this._compositor.drawVectorData(this._passParameters,A,s,F,T,n,this.tileSize,m):PH(T)?(this._compositor.drawRasterData(this._passParameters,A,s,F,T),xW(T)&&(p=9728)):this._dataToTexture(T,my(S))&&(this._passParameters.texture=T.sourceLayerInfo.data.texture,this._passParameters.offset=T.offset,this._passParameters.scale=T.scale,this._compositor.drawImageData(this._passParameters,A,s,F));Gc.length>0&&Gc[Gc.length-1].end===C;){const L=Gc.pop();this._passParameters.baseOpacity=L.baseOpacity,this._passParameters.opacity=L.opacity,this._passParameters.offset=mp,this._passParameters.scale=1,this._compositor.drawGroup(this._passParameters,L.output,s,X1[L.blendMode])}f++}const g=e.renderData,y=l||u&&c<1,v=g.ensureTexture(s,y,t,()=>this._buildTexture(s,y,p));this._compositor.copyFBOToTexture(v),this._compositor.unbind(),g.setTextureReference(new lg(v,t,QS,u?1:c,0,1))}_dataToTexture(e,t){if(DH(e)){const i=e.sourceLayerInfo,r=e.scale===1&&!t;i.data=this._buildTexture(i.data,!0,r,e.tile.onCompressionFinished),e.tile.setMemoryDirty()}return RH(e)}_buildTexture(e,t,i=9987,r=()=>{}){if(e==null)return null;const s=new gt;s.wrapMode=33071,s.samplingMode=typeof i=="boolean"?9987:i,s.maxAnisotropy=this._maxAnisotropy,s.preMultiplyAlpha=!0,s.flipped=!0,s.hasMipmap=!0,t||(s.pixelFormat=6407);const n=this._rctx,a=typeof i=="boolean"&&i;let o;if(typeof e=="number")s.width=s.height=e,o=this._buildTileTexture(s);else if(Z_(e))s.isOpaque=e.isOpaque,s.isOpaque&&(s.pixelFormat=6407),s.width=e.element.width,s.height=e.element.height,o=this._buildTileTexture(s,a,r,e.element);else try{s.width=e.width,s.height=e.height,o=this._buildTileTexture(s,a,r,e)}catch{o=new ZS(_E(n)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const l=n.bindTexture(o.texture,bt.TEXTURE_UNIT_FOR_UPDATES);return o.generateMipmap(),n.bindTexture(l,bt.TEXTURE_UNIT_FOR_UPDATES),o}_buildTileTexture(e,t=!1,i=()=>{},r){const s=this._cache.pop(Q1(e,!1))??this._cache.pop(Q1(e,!0));if(t&&=yE(r,e),s)return s.retain(),t?s.texture.enableCompression({compressionTracker:this._compressionTracker,compressionCallback:i}):s.texture.disableCompression(),s.texture.setData(r),s;e.compress=t?{compressionTracker:this._compressionTracker,compressionCallback:i}:void 0;const n=new bt(this._rctx,e,r);return new ZS(n,this._cache)}get test(){}};function N0(e,t,i){Ti.layerIndex=t,Ti.vtlNeighborInfos.clear();const r=e.layerInfo[1][t];if(Ki(Ti.offset,0,0),Ti.tile=e,Ti.scale=1,Ti.sourceLod=e.lij,Ti.sourceLayerInfo=r,Ti.isVTLBackground=i,r.data)return i&&e.forEachLoadedNeighbor((a,o)=>{if(a.level!==e.level)return;const l=a.layerInfo[1][t];if(!hO(l)||r.data===l.data)return;const c=Ti.vtlNeighborInfos.pushNew();c.offset=Ma[o],c.sourceLod=a.lij,c.sourceLayerInfo=l}),Ti;const s=r.upsampleInfo,n=s?.tile?.layerInfo[1][t];return n&&s.tile?(Ti.tile=s.tile,fs(Ti.offset,s.offset),Ti.scale=s.scale,Ti.sourceLod=s.tile.lij,Ti.sourceLayerInfo=n,Ti):i?Ti:null}function xW(e){const t=e.sourceLayerInfo.data;return!!t.source&&t.interpolation==="nearest"}function vE(e){let t=e.blendMode!=="normal";return Kh(e.parent)&&(t=vE(e.parent)||t),t}function bE(e,t){Kh(e.parent)&&bE(e.parent,t);const i=e.uid;if(i!=null&&i!==""){const r=v_.get(i);r?r.start=t:v_.set(i,new bW(t,t,e.blendMode,e.opacity,1,1))}}const v_=new Map,Gc=new Array,Ti=new gW,QS=Mi(0,0,1,1),Ma=new Array;function CW(){Ti.sourceLayerInfo=null,Ti.tile=null,Ti.vtlNeighborInfos.prune()}Ma[0]=[0,-1],Ma[1]=[-1,-1],Ma[2]=[-1,0],Ma[3]=[-1,1],Ma[4]=[0,1],Ma[5]=[1,1],Ma[6]=[1,0],Ma[7]=[1,-1];const SW=200,j0=40,TW=.8,PW=10,Dd=1e-6;function MW(e,t,i){const r=t,s=i;let n=0,a=1/0;for(let o=0;o<3;++o){{const l=e[o];if(r[o]<l){if(s[o]<=Dd)return!1;const c=(l-r[o])/s[o];n=Math.max(n,c)}else if(s[o]<=-Dd){const c=(l-r[o])/s[o];a=Math.min(a,c)}if(n>a)return!1}{const l=e[o+3];if(r[o]>l){if(s[o]>=-Dd)return!1;const c=(l-r[o])/s[o];n=Math.max(n,c)}else if(s[o]>=Dd){const c=(l-r[o])/s[o];a=Math.min(a,c)}if(n>a)return!1}}return!0}let XS=class{constructor(e,t,i,r,s){this.aabb=e,this.axis=t,this.d=i,this.midStartIndex=r,this.rightStartIndex=s}},wE=class Y1{constructor(t,i,r,s){this.globalTriangleVertexIndices=t,this.firstTriangleIndex=i,this.positions=s,this._rayDirection=w(),this._callback=KS,this._intersectionOptions=YS,this.bspNodeTree=new Array;const n=r-i,a=new(n<AW?Uint8Array:n<IW?Uint16Array:Uint32Array)(n);this.triangleIndexMap=a;for(let o=0;o<n;++o)a[o]=o;{const o=EW(t,i,r,s.data,s.stride),l=j(Math.log2(n/j0),2,PW),c=(u,p,m)=>{const f=DW(a,o,u,p),g=p-u;if(g<=j0){const x=new XS(f,void 0,0,u,p);return this.bspNodeTree.push(x),x}const{axis:y,midValue:v}=OW(f),C=RW(a,o,u,p,y,v),b=(x,T)=>{if(m>l)return;const P=T-x;return P<j0||P>=TW*g?void 0:c(x,T,m+1)},S=new XS(f,y,v,C.next,C.mid);return this.bspNodeTree.push(S),S.leftNode=b(u,C.next),S.rightNode=b(C.mid,p),S};c(0,n,0)}}intersectRayTriangleRange(t,i){if(t>=i)return;const r=this.positions;h4(this._rayFrom,this._rayDirection,t,i,this.globalTriangleVertexIndices,r.data,r.stride,this._intersectionOptions.normalRequired,this._callback,this.triangleIndexMap,this.firstTriangleIndex),Y1.numFacesTested+=i-t}intersectRay(t,i,r,s){Y1.numFacesTested=0;const n=t,a=i,o=a[0]-n[0],l=a[1]-n[1],c=a[2]-n[2];if(o*o+l*l+c*c<Dd)return;this._rayFrom=n;const u=this._rayDirection;u[0]=o,u[1]=l,u[2]=c;const p=this.triangleIndexMap.length;this._callback=s,this._intersectionOptions=r,this.intersectRayBSP(this.bspNodeTree[0],0,p),this._callback=KS,this._intersectionOptions=YS}intersectRayBSP(t,i,r){const s=this._rayFrom,n=this._rayDirection;if(!MW(t.aabb,s,n))return;const a=t.axis,o=t.d;if(s[a]<o||n[a]<0){const l=i,c=t.midStartIndex;if(l<c){const u=t.leftNode;u!==void 0?this.intersectRayBSP(u,l,c):this.intersectRayTriangleRange(l,c)}}if(this.intersectRayTriangleRange(t.midStartIndex,t.rightStartIndex),s[a]>o||n[a]>0){const l=t.rightStartIndex,c=r;if(l<c){const u=t.rightNode;u!==void 0?this.intersectRayBSP(u,l,c):this.intersectRayTriangleRange(l,c)}}}static{this.numFacesTested=0}get estimatedMemoryUsage(){return this.triangleIndexMap.byteLength}};const $c=[1/0,1/0,1/0],Wc=[-1/0,-1/0,-1/0];function RW(e,t,i,r,s,n){let a=i,o=r;for(;a<o;){const c=e[a];t[6*c+s+3]<=n?++a:(--o,e[a]=e[o],e[o]=c)}let l=a;for(o=r;l<o;){const c=e[o-1];t[6*c+s]>=n?--o:(e[o-1]=e[l],e[l]=c,++l)}return{next:a,mid:l}}function DW(e,t,i,r){if(r<=i)return gx(NaN,NaN,NaN,NaN,NaN,NaN);{const s=6*e[i];for(let n=0;n<3;++n)$c[n]=t[s+0+n],Wc[n]=t[s+3+n]}for(let s=i+1;s<r;++s){const n=6*e[s];for(let a=0;a<3;++a)$c[a]=Math.min($c[a],t[n+0+a]),Wc[a]=Math.max(Wc[a],t[n+3+a])}return gx($c[0],$c[1],$c[2],Wc[0],Wc[1],Wc[2])}function OW(e){const t=e[3]-e[0],i=e[4]-e[1],r=e[5]-e[2],s=t>i?t>r?0:i>r?1:2:i>r?1:r>t?2:0;return{axis:s,midValue:(e[s]+e[s+3])/2}}function EW(e,t,i,r,s){const n=i-t,a=new Float32Array(6*n);for(let o=0;o<n;++o){const l=3*(o+t),c=e[l]*s,u=e[l+1]*s,p=e[l+2]*s;for(let m=0;m<3;++m){const f=r[c+m],g=r[u+m],y=r[p+m];a[6*o+m]=Math.min(f,g,y),a[6*o+3+m]=Math.max(f,g,y)}}return a}const AW=255,IW=65535,YS=new P2,KS=()=>{};function wse(e){e.code.add(_`float normals2FoamIntensity(vec3 n, float waveStrength){
float normalizationFactor =  max(0.015, waveStrength);
return max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);
}`)}function LW(e){e.code.add(_`vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){
return foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;
}`)}function FW(e,t){if(!t.screenSpaceReflections)return;const i=e.fragment;i.include(Xa),i.uniforms.add(new op("nearFar",r=>r.camera.nearFar),new gs("depthMap",r=>r.depth?.attachment),new ps("proj",r=>r.camera.projectionMatrix),new Er("invResolutionHeight",r=>1/r.camera.height),new ps("reprojectionMatrix",r=>r.ssr.reprojectionMatrix)).code.add(_`
  vec2 reprojectionCoordinate(vec3 projectionCoordinate)
  {
    vec4 zw = proj * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);
    vec4 reprojectedCoord = reprojectionMatrix * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);
    reprojectedCoord.xy /= reprojectedCoord.w;
    return reprojectedCoord.xy * 0.5 + 0.5;
  }

  const int maxSteps = ${t.highStepCount?"150":"75"};

  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)
  {
    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);
    projectedCoord.xy /= projectedCoord.w;
    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;
    return projectedCoord;
  }

  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)
  {
    vec3 viewPos = startPosition;
    vec3 viewPosEnd = startPosition;

    // Project the start position to the screen
    vec4 projectedCoordStart = applyProjectionMat(proj, viewPos);
    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space
    float k0 = 1.0/ projectedCoordStart.w;

    // advance the position in the direction of the reflection
    viewPos += dir;

    vec4 projectedCoordVanishingPoint = applyProjectionMat(proj, dir);

    // Project the advanced position to the screen
    vec4 projectedCoordEnd = applyProjectionMat(proj, viewPos);
    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space
    float k1 = 1.0/ projectedCoordEnd.w;

    // calculate the reflection direction in the screen space
    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);
    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);

    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);

    float projectedCoordDirLength = length(projectedCoordDir);
    float maxSt = float(maxSteps);

    // normalize the projection direction depending on maximum steps
    // this determines how blocky the reflection looks
    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);

    // Normalize the homogeneous camera space coordinates
    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);
    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);

    // initialize the variables for ray marching
    vec2 P = projectedCoordStart.xy;
    vec3 Q = Q0;
    float k = k0;
    float rayStartZ = -startPosition.z; // estimated ray start depth value
    float rayEndZ = -startPosition.z;   // estimated ray end depth value
    float prevEstimateZ = -startPosition.z;
    float rayDiffZ = 0.0;
    float dDepth;
    float depth;
    float rayDiffZOld = 0.0;

    // early outs
    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)
      return vec3(P, 0.0);
    float dDepthBefore = 0.0;

    for(int i = 0; i < maxSteps-1; i++)
    {
      depth = -linearDepthFromTexture(depthMap, P); // get linear depth from the depth buffer

      // estimate depth of the marching ray
      rayStartZ = prevEstimateZ;
      dDepth = -rayStartZ - depth;
      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));
      rayDiffZ = rayEndZ- rayStartZ;
      prevEstimateZ = rayEndZ;

      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )
      {
        return vec3(P, 0.);
      }

      // If we detect a hit - return the intersection point, two conditions:
      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth
      //  - if difference between dDepth and rayDiffZOld is not too large
      //  - if difference between dDepth and 0.025/abs(k) is not too large
      //  - if the sampled depth is not behind far plane or in front of near plane

      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)
      {
        float weight = dDepth / (dDepth - dDepthBefore);
        vec2 Pf = mix(P - dP, P, 1.0 - weight);
        if (abs(Pf.y - projectedCoordStart.y) > invResolutionHeight) {
          return vec3(Pf, depth);
        }
        else {
          return vec3(P, depth);
        }
      }

      // continue with ray marching
      P = clamp(P + dP, vec2(0.0), vec2(0.999));
      Q.z += dQ.z;
      k += dk;
      rayDiffZOld = rayDiffZ;
      dDepthBefore = dDepth;
    }
    return vec3(P, 0.0);
  }
  `)}function VW(e){e.fragment.uniforms.add(new Er("cloudAbsorption",t=>t.clouds.absorption),new Er("cloudCoverage",t=>t.clouds.coverage)).code.add(_`vec4 lookupCloudsFromTextureArray(sampler2DArray cubeMap, vec3 rayDir) {
int faceIndex;
vec2 uv;
if(rayDir.z <= 0.0) {
float hazeFactor = smoothstep(-0.01, mix(0.0, 0.075, cloudCoverage), abs(dot(rayDir, vec3(0, 0, 1))));
float shading = clamp(1.0 - cloudAbsorption, 0.6, 1.0) * (1.0 - hazeFactor);
float totalTransmittance = hazeFactor;
return vec4(shading, totalTransmittance, shading, totalTransmittance);
}
if (abs(rayDir.x) >= abs(rayDir.y) && abs(rayDir.x) >= abs(rayDir.z)) {
if(rayDir.x > 0.0) {
faceIndex = 0;
uv = rayDir.yz / rayDir.x;
uv = vec2(-uv.x, uv.y);
} else {
faceIndex = 1;
uv = rayDir.yz / rayDir.x;
uv = vec2(-uv.x, -uv.y);
}
} else if (abs(rayDir.y) >= abs(rayDir.x) && abs(rayDir.y) >= abs(rayDir.z)) {
if(rayDir.y > 0.0) {
faceIndex = 2;
uv = rayDir.xz / rayDir.y;
} else {
faceIndex = 3;
uv = rayDir.xz / rayDir.y;
uv = vec2(uv.x, -uv.y);
}
} else {
if(rayDir.y < 0.0) {
faceIndex = 4;
uv = rayDir.xy / rayDir.z;
uv = vec2(uv.x, -uv.y);
} else {
faceIndex = 5;
uv = rayDir.xy / rayDir.z;
uv = vec2(uv.x, -uv.y);
}
}
uv = 0.5 * (uv + 1.0);
if(faceIndex != 5) {
uv.y = uv.y - 0.5;
}
uv.y = uv.y * 2.0;
vec4 s = texture(cubeMap, vec3(uv, float(faceIndex)));
return s;
}`)}let zW=class extends ha{constructor(e,t){super(e,"sampler2DArray",0,(i,r)=>i.bindTexture(e,t(r)))}};function xE(e){const t=e.fragment;t.constants.add("radiusCloudsSquared","float",kW).code.add(_`vec3 intersectWithCloudLayer(vec3 dir, vec3 cameraPosition, vec3 spherePos) {
float B = 2.0 * dot(cameraPosition, dir);
float C = dot(cameraPosition, cameraPosition) - radiusCloudsSquared;
float det = B * B - 4.0 * C;
float pointIntDist = max(0.0, 0.5 *(-B + sqrt(det)));
return (cameraPosition + dir * pointIntDist) - spherePos;
}`),t.uniforms.add(new Er("radiusCurvatureCorrection",({clouds:r})=>r.parallax.radiusCurvatureCorrection)).code.add(_`vec3 correctForPlanetCurvature(vec3 dir) {
dir.z = dir.z * (1.0 - radiusCurvatureCorrection) + radiusCurvatureCorrection;
return dir;
}`),t.code.add(_`vec3 rotateDirectionToAnchorPoint(mat4 rotMat, vec3 inVec) {
return (rotMat * vec4(inVec, 0.0)).xyz;
}`),cc(t),T_(t);const i=We(.28,.175,.035);t.constants.add("RIM_COLOR","vec3",i),t.code.add(_`
    vec3 calculateCloudColor(vec3 cameraPosition, vec3 worldSpaceRay, vec4 clouds) {
      float upDotLight = dot(cameraPosition, mainLightDirection);
      float dirDotLight = max(dot(worldSpaceRay, mainLightDirection), 0.0);
      float sunsetTransition = clamp(pow(max(upDotLight, 0.0), ${_.float(.3)}), 0.0, 1.0);

      // Base color of the clouds that depends on lighting of the sun and sky
      vec3 ambientLight = calculateAmbientIrradiance(cameraPosition,  0.0);
      vec3 combinedLight = clamp((mainLightIntensity + ambientLight )/PI, vec3(0.0), vec3(1.0));
      vec3 baseCloudColor = pow(combinedLight * pow(clouds.xyz, vec3(GAMMA)), vec3(INV_GAMMA));

      // Rim light around the edge of the clouds simulating scattering of the direct lun light
      float scatteringMod = max(clouds.a < 0.5 ? clouds.a / 0.5 : - clouds.a / 0.5 + 2.0, 0.0);
      float rimLightIntensity = 0.5 + 0.5 * pow(max(upDotLight, 0.0), 0.35);
      vec3 directSunScattering = RIM_COLOR * rimLightIntensity * (pow(dirDotLight, ${_.float(140)})) * scatteringMod;

      // Brighten the clouds around the sun at the sunsets
      float additionalLight = ${_.float(.2)} * pow(dirDotLight, ${_.float(10)}) * (1. - pow(sunsetTransition, ${_.float(.3)})) ;

      return vec3(baseCloudColor * (1.0 + additionalLight) + directSunScattering);
    }
  `),e.include(VW),t.uniforms.add(new Bw("readChannelsRG",r=>r.clouds.readChannels===0),new zW("cubeMap",r=>r.clouds.data?.cubeMap?.colorTexture)).code.add(_`vec4 sampleCloud(vec3 rayDir, bool readOtherChannel) {
vec4 s = lookupCloudsFromTextureArray(cubeMap, rayDir);
bool readRG = readChannelsRG ^^ readOtherChannel;
s = readRG ? vec4(vec3(s.r), s.g) : vec4(vec3(s.b), s.a);
return length(s) == 0.0 ? vec4(s.rgb, 1.0) : s;
}`),t.uniforms.add(new Pn("anchorPoint",r=>r.clouds.parallax.anchorPoint),new Pn("anchorPointNew",r=>r.clouds.parallaxNew.anchorPoint),new ps("rotationClouds",r=>r.clouds.parallax.transform),new ps("rotationCloudsNew",r=>r.clouds.parallaxNew.transform),new Er("cloudsOpacity",r=>r.clouds.opacity),new Er("fadeFactor",r=>r.clouds.fadeFactor),new Bw("crossFade",r=>r.clouds.fadeState===3)).code.add(_`vec4 renderClouds(vec3 worldRay, vec3 cameraPosition) {
vec3 intersectionPoint = intersectWithCloudLayer(worldRay, cameraPosition, anchorPoint);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = sampleCloud(worldRayRotatedCorrected, crossFade);
vec3 cameraPositionN = normalize(cameraPosition);
vec4 cloudColor = vec4(calculateCloudColor(cameraPositionN, worldRay, cloudData), cloudData.a);
if(crossFade) {
intersectionPoint = intersectWithCloudLayer(worldRay, cameraPosition, anchorPointNew);
worldRayRotated = rotateDirectionToAnchorPoint(rotationCloudsNew, normalize(intersectionPoint));
worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
cloudData = sampleCloud(worldRayRotatedCorrected, false);
vec4 cloudColorNew = vec4(calculateCloudColor(cameraPositionN, worldRay, cloudData), cloudData.a);
cloudColor = mix(cloudColor, cloudColorNew, fadeFactor);
}
float totalTransmittance = length(cloudColor.rgb) == 0.0 ?
1.0 :
clamp(cloudColor.a * cloudsOpacity + (1.0 - cloudsOpacity), 0.0 , 1.0);
return vec4(cloudColor.rgb, totalTransmittance);
}`)}const kW=(Li.radius+wV)**2;function BW(e,t){const i=e.fragment;i.include(UA,t),i.include(pc),i.include(LW),t.cloudReflections&&e.include(xE),e.include(FW,t),i.include(kp,t),i.constants.add("fresnelSky","vec3",[.02,1,15]),i.constants.add("fresnelMaterial","vec2",[.02,.1]),i.constants.add("roughness","float",.015),i.constants.add("foamIntensityExternal","float",1.7),i.constants.add("ssrIntensity","float",.65),i.constants.add("ssrHeightFadeStart","float",HA),i.constants.add("ssrHeightFadeEnd","float",WP),i.constants.add("waterDiffusion","float",.92),i.constants.add("waterSeaColorMod","float",.8),i.constants.add("correctionViewingPowerFactor","float",.4),i.constants.add("skyZenitColor","vec3",[.52,.68,.9]),i.constants.add("skyColor","vec3",[.67,.79,.9]),i.constants.add("cloudFresnelModifier","vec2",[1.2,.01]),i.code.add(_`PBRShadingWater shadingInfo;
vec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {
float exponent = pow((1.0 - cosTheta), fresnelSky[2]);
return mix(zenit, horizon, exponent);
}`),i.uniforms.add(new Er("lightingSpecularStrength",r=>r.lighting.mainLight.specularStrength),new Er("lightingEnvironmentStrength",r=>r.lighting.mainLight.environmentStrength)),i.code.add(_`vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 viewPosition, vec3 position) {
float reflectionHit = 0.0;
float reflectionHitDiffused = 0.0;
vec3 seaWaterColor = linearizeGamma(color);
vec3 h = normalize(l + v);
shadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);
shadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);
shadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);
shadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);
shadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);
float upDotV = max(dot(localUp,v), 0.0);
vec3 skyHorizon = linearizeGamma(skyColor);
vec3 skyZenit = linearizeGamma(skyZenitColor);
vec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );
float upDotL = max(dot(localUp,l),0.0);
float daytimeMod = 0.1 + upDotL * 0.9;
skyColor *= daytimeMod;
float shadowModifier = clamp(shadow, 0.8, 1.0);
vec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);
vec3 reflSky = lightingEnvironmentStrength * fresnelModifier * skyColor * shadowModifier;
vec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;
vec3 specular = vec3(0.0);
if(upDotV > 0.0 && upDotL > 0.0) {
vec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);
vec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;
float NdotL = clamp(dot(n, l), 0.0, 1.0);
specular = lightingSpecularStrength * NdotL * incidentLight * specularSun;
}
vec3 foam = vec3(0.0);
if(upDotV > 0.0) {
foam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);
}
float correctionViewingFactor = pow(max(dot(v, localUp), 0.0), correctionViewingPowerFactor);
vec3 normalCorrectedClouds = mix(localUp, n, correctionViewingFactor);
vec3 reflectedWorld = normalize(reflect(-v, normalCorrectedClouds));`),t.cloudReflections&&i.uniforms.add(new Er("cloudsOpacity",r=>r.clouds.opacity)).code.add(_`vec4 cloudsColor = renderClouds(reflectedWorld, position);
cloudsColor.a = 1.0 - cloudsColor.a;
cloudsColor = pow(cloudsColor, vec4(GAMMA));
cloudsColor *= clamp(fresnelModifier.y * cloudFresnelModifier[0] - cloudFresnelModifier[1], 0.0, 1.0) * cloudsOpacity;`),t.screenSpaceReflections?i.uniforms.add(new ps("view",r=>r.camera.viewMatrix),new gs("lastFrameColorTexture",r=>r.ssr.lastFrameColor?.getTexture()),new Er("fadeFactorSSR",r=>r.ssr.fadeFactor)).code.add(_`vec3 viewDir = normalize(viewPosition);
vec4 viewNormalVectorCoordinate = view * vec4(n, 0.0);
vec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);
vec4 viewUp = view * vec4(localUp, 0.0);
vec3 viewNormalCorrectedSSR = mix(viewUp.xyz, viewNormal, correctionViewingFactor);
vec3 reflected = normalize(reflect(viewDir, viewNormalCorrectedSSR));
vec3 hitCoordinate = screenSpaceIntersection(reflected, viewPosition, viewDir, viewUp.xyz);
vec3 reflectedColor = vec3(0.0);
if (hitCoordinate.z > 0.0)
{
vec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);
vec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));
float heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -viewPosition.z);
reflectionHit = clamp(1.0 - (1.3 * dCoords.y), 0.0, 1.0) * heightMod * fadeFactorSSR;
reflectionHitDiffused = waterDiffusion * reflectionHit;
reflectedColor = linearizeGamma(texture(lastFrameColorTexture, reprojectedCoordinate).xyz) *
reflectionHitDiffused * fresnelModifier.y * ssrIntensity;
}
float seaColorMod =  mix(waterSeaColorMod, waterSeaColorMod * 0.5, reflectionHitDiffused);
vec3 waterRenderedColor = tonemapACES((1.0 - reflectionHitDiffused) * reflSky + reflectedColor +
reflSea * seaColorMod + specular + foam);`):i.code.add(_`vec3 waterRenderedColor = tonemapACES(reflSky + reflSea * waterSeaColorMod + specular + foam);`),t.cloudReflections?t.screenSpaceReflections?i.code.add(_`return waterRenderedColor * (1.0 - (1.0 - reflectionHit) * cloudsColor.a) + (1.0 - reflectionHit) * cloudsColor.xyz;
}`):i.code.add(_`return waterRenderedColor * (1.0 - cloudsColor.a) + cloudsColor.xyz;
}`):i.code.add(_`return waterRenderedColor;
}`)}function NW(e,t){const{vertex:i,fragment:r}=e;i.uniforms.add(new zg("overlayTexOffset",(s,n)=>HW(s,n)),new zg("overlayTexScale",(s,n)=>qW(s,n))),r.constants.add("overlayOpacity","float",1),r.uniforms.add(new Ne("ovColorTex",(s,n)=>jW(s,n))),CE(e,t)}function jW(e,t){return e.identifier===0&&or(e.output)?e.occludedGround?t.overlay?.allSourcesOccluders?t.overlay?.getTexture(1):t.overlay?.getTexture(4):t.overlay?.getTexture(1):e.identifier===0&&e.output===10?t.overlay?.getTexture(5):e.identifier===2?t.overlay?.getTexture(2):null}function Zu(e,t){const{vertex:i,fragment:r}=e,{output:s}=t;i.uniforms.add(new JS("overlayTexOffset"),new JS("overlayTexScale")),r.uniforms.add(new _e("overlayOpacity",n=>n.overlayOpacity)),s!==9&&r.uniforms.add(new Ne("ovColorTex",(n,a)=>a.overlay?.getTexture(n.overlayContent))),CE(e,t)}function UW(e,t){switch(e){case 0:case 1:return t.slot!==9||t.overlay?.allSourcesOccluders?0:4;case 2:case 3:return 0;case 9:return 2;case 4:case 6:case 7:case 8:return null;case 10:return 5}return null}function CE(e,t){const i=t.pbrMode===3||t.pbrMode===4||t.pbrMode===6;i&&e.include(BW,t);const{vertex:r,fragment:s,varyings:n}=e;n.add("vtcOverlay","vec4");const{output:a}=t,o=a===9;r.code.add(_`void setOverlayVTC(in vec2 uv) {
vtcOverlay = vec4(uv, uv) * overlayTexScale + overlayTexOffset;
}`),s.code.add(_`bool isValid(vec2 uv, vec2 dxdy) {
return (uv.x >= 0.0 + dxdy.x) && (uv.x <= 1.0 - dxdy.x) && (uv.y >= 0.0 + dxdy.y) && (uv.y <= 1.0 - dxdy.y);
}
vec4 getOverlayColor(sampler2D ov0Tex, vec4 texCoords) {
vec4 color0 = texture(ov0Tex, vec2(texCoords.x * 0.5, texCoords.y));
vec4 color1 = texture(ov0Tex, vec2(texCoords.z * 0.5 + 0.5, texCoords.w));
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`),o?s.uniforms.add(new xu("overlayHighlightTexture",(l,c)=>c.overlay?.getTexture(2))).code.add(_`uvec2 getAllOverlayHighlightValuesEncoded() {
vec4 texCoords = vtcOverlay;
vec2 uvInner = texCoords.xy;
vec2 uvOuter = texCoords.zw;
bool isValidInner = isValid(uvInner, fwidth(uvInner));
bool isValidOuter = isValid(uvOuter, vec2(0.0, 0.0));
vec2 texelCoordInner = uvInner * vec2(0.5, 1.0);
vec2 texelCoordOuter = uvOuter * vec2(0.5, 1.0) + vec2(0.5,0.0);
vec2 texDim =  vec2(textureSize(overlayHighlightTexture, 0));
uvec2 texelValueInner = texelFetch(overlayHighlightTexture, ivec2(texelCoordInner * texDim), 0).rg;
uvec2 texelValueOuter = texelFetch(overlayHighlightTexture, ivec2(texelCoordOuter * texDim), 0).rg;
return
isValidInner ? texelValueInner :
isValidOuter ? texelValueOuter :
uvec2(0);
}`):(s.code.add(_`vec4 getCombinedOverlayColor() {
return overlayOpacity * getOverlayColor(ovColorTex, vtcOverlay);
}`),s.code.add(_`vec4 getOverlayColorTexel() {
vec4 texCoords = vtcOverlay;
vec2 texDim =  vec2(textureSize(ovColorTex, 0));
vec4 color0 = texelFetch(ovColorTex, ivec2(vec2(texCoords.x * 0.5, texCoords.y) * texDim), 0);
vec4 color1 = texelFetch(ovColorTex, ivec2(vec2(texCoords.z * 0.5 + 0.5, texCoords.w) * texDim), 0);
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`)),i&&(cc(s),T_(s),s.code.add(_`vec4 getOverlayWaterColor(vec4 maskInput, vec4 colorInput, vec3 vposEyeDir,
float shadow, vec3 localUp, mat3 tbn, vec3 position, vec3 positionWorld) {
vec3 n = normalize(tbn *  (2.0 * maskInput.rgb - vec3(1.0)));
vec3 v = vposEyeDir;
vec3 final = getSeaColor(n, v, mainLightDirection, colorInput.rgb, mainLightIntensity, localUp, 1.0 - shadow, maskInput.w, position, positionWorld);
return vec4(final, colorInput.w);
}`))}function HW(e,t){const i=t.overlay?.overlays[0]?.extent;Fg(i)&&(Yn[0]=e.toMapSpace[0]/ds(i)-i[0]/ds(i),Yn[1]=e.toMapSpace[1]/Kn(i)-i[1]/Kn(i));const r=t.overlay?.overlays[1]?.extent;return Fg(r)&&(Yn[2]=e.toMapSpace[0]/ds(r)-r[0]/ds(r),Yn[3]=e.toMapSpace[1]/Kn(r)-r[1]/Kn(r)),Yn}function qW(e,t){const i=t.overlay?.overlays[0]?.extent;Fg(i)&&(Yn[0]=e.toMapSpace[2]/ds(i),Yn[1]=e.toMapSpace[3]/Kn(i));const r=t.overlay?.overlays[1]?.extent;return Fg(r)&&(Yn[2]=e.toMapSpace[2]/ds(r),Yn[3]=e.toMapSpace[3]/Kn(r)),Yn}const Yn=Vt();let JS=class extends ha{constructor(e){super(e,"vec4")}};function GW(e,t){e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),t.spherical?e.vertex.code.add(_`void forwardVertexTangent(vec3 n) {
tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));
tbnBiTangent = normalize(cross(n, tbnTangent));
}`):e.vertex.code.add(_`void forwardVertexTangent(vec3 n) {
tbnTangent = vec3(1.0, 0.0, 0.0);
tbnBiTangent = normalize(cross(n, tbnTangent));
}`),e.fragment.code.add(_`mat3 getTBNMatrix(vec3 n) {
return mat3(tbnTangent, tbnBiTangent, n);
}`)}function SE(e,t){t.output===9&&(e.include(O2,t),e.fragment.code.add(_`
    void calculateOcclusionAndOutputHighlight(uvec2 highlightToAdd) {
      uint levelBits = readLevelBits(highlightToAdd, highlightLevel);
      if ((levelBits & 1u) == 0u) discard;
      outputHighlight(isHighlightOccluded());
    }
  `))}function $W(e,t){t.spherical?e.vertex.code.add(_`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return normalize(pos + origin);
}`):e.vertex.code.add(_`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return vec3(0.0, 0.0, 1.0);
}`),t.spherical?e.vertex.code.add(_`mat3 getTBNMatrix(in vec3 n) {
vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`):e.vertex.code.add(_`mat3 getTBNMatrix(in vec3 n) {
vec3 t = vec3(1.0, 0.0, 0.0);
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`)}let WW=class extends R2{constructor(){super(...arguments),this.overlayOpacity=1}};function ZW(e,t){const{vertex:i,fragment:r,varyings:s}=e;s.add("vtc","vec2"),i.uniforms.add(new eT("texOffsetAndScale")),r.uniforms.add(new tT("tex")),r.uniforms.add(new U0("textureOpacities"));const n=t.textureFadingEnabled&&!t.renderOccluded;n&&(i.uniforms.add(new eT("nextTexOffsetAndScale")),s.add("nvtc","vec2"),r.uniforms.add(new tT("texNext")),r.uniforms.add(new U0("nextTexOpacities")),r.uniforms.add(new QW("fadeFactor")));const a=t.tileBlendInput===1,o=t.tileBlendInput===2;o&&r.include(aw),a&&r.uniforms.add(new U0("backgroundColor")),i.code.add(_`
  void forwardTextureCoordinatesWithTransform(in vec2 uv) {
    vtc = texOffsetAndScale.xy + uv * texOffsetAndScale.zw;
    ${X(n,"nvtc = nextTexOffsetAndScale.xy + uv * nextTexOffsetAndScale.zw;")}
  }`),r.code.add(_`
    vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
      ${X(o||a,_`if (opacities.y <= 0.0) {
           return color * opacities.z * opacities.x;
         }
         vec4 bg = vec4(${a?_`backgroundColor`:_`gridColor(uv)`} * opacities.y, opacities.y);
         vec4 layer = color * opacities.z;
         return (bg * (1.0 - layer.a) + layer) * opacities.x;`,"return color;")}
    }`),n?r.code.add(_`vec4 getTileColor() {
vec4 color = getColor(texture(tex, vtc), vtc, textureOpacities);
if (fadeFactor >= 1.0) {
return color;
}
vec4 nextColor = getColor(texture(texNext, nvtc), nvtc, nextTexOpacities);
return mix(nextColor, color, fadeFactor);
}`):r.code.add(_`vec4 getTileColor() {
return getColor(texture(tex, vtc), vtc, textureOpacities);
}`)}let QW=class extends ha{constructor(e){super(e,"float")}},U0=class extends ha{constructor(e){super(e,"vec3")}},eT=class extends ha{constructor(e){super(e,"vec4")}},tT=class extends ha{constructor(e){super(e,"sampler2D")}},ow=class extends WW{};function TE(e){const t=new ut,{attributes:i,vertex:r,fragment:s,varyings:n}=t;i.add("position","vec3"),t.include(x8,e),t.include(wM,e);const a=()=>{t.include($W,e),r.code.add(_`vec3 getNormal() {
float z = 1.0 - abs(normalCompressed.x) - abs(normalCompressed.y);
vec3 n = vec3(normalCompressed + vec2(normalCompressed.x >= 0.0 ? 1.0 : -1.0,
normalCompressed.y >= 0.0 ? 1.0 : -1.0) * min(z, 0.0), z);
return normalize(n);
}`)};s4(r,e),t.include(u4);const{output:o,pbrMode:l,overlayMode:c,tileBorders:u,spherical:p,transparencyMode:m,overlayEnabled:f}=e,g=m===2||m===3,y=f&&g;switch(o){case 1:case 0:{t.include(ZW,e),t.include(Ag,e),f&&(e.pbrMode=l===5?6:3,t.include(Zu,e),e.pbrMode=l);const v=c===2;v&&t.include(GW,e),n.add("vnormal","vec3"),n.add("vpos","vec3",{invariant:!0}),n.add("vup","vec3"),a(),r.main.add(_`
          vpos = position;
          vec3 positionWorld = position + localOrigin;
          gl_Position = transformPosition(proj, view, vpos);
          vnormal = getNormal();
          vup = getLocalUp(position, localOrigin);
          ${X(v,_`forwardVertexTangent(vnormal);`)}

          forwardTextureCoordinatesWithTransform(uv0);
          ${X(f,"setOverlayVTC(uv0);")}
          ${X(u,"forwardTextureCoordinates();")}
          forwardLinearDepthToReadShadowMap();`),t.include(P8,e),s.include(n4,e),t.include(Ag,e),s.include(M8,e),w2(s,e),R8(s),Tv(s),s.uniforms.add(r.uniforms.get("localOrigin"),new Pn("viewDirection",({camera:b})=>me(iT,xe(iT,b.viewMatrix[12],b.viewMatrix[13],b.viewMatrix[14])))),v&&s.uniforms.add(new gs("ovWaterTex",b=>b.overlay?.getTexture(3)),new $P("view",({origin:b},{camera:S})=>ac(XW,S.viewMatrix,b)));const C=.2;s.code.add(_`float lum(vec3 c) {
return (min(min(c.r, c.g), c.b) + max(max(c.r, c.g), c.b)) * 0.5;
}`),cc(s),T_(s),s.main.add(_`
          vec3 normal = normalize(vnormal);
          float vndl = dot(normal, mainLightDirection);

          float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl*2.5, 0.0, 1.0));
          float shadow = readShadow(additionalAmbientScale, vpos);
          float ssao = evaluateAmbientOcclusionInverse();
          vec4 tileColor = getTileColor();

          ${X(f,_`vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
                   vec4 overlayColor = overlayOpacity * overlayColorOpaque;
                   ${X(g,`if (overlayColor.a < ${_.float(Or)}) { discard; }`)}
                   vec4 groundColor = tileColor;
                   tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;`)}

          // If combined alpha is 0 we can discard pixel. The performance impact by having a discard here
          // is neglectable because terrain typically renders first into the framebuffer.
          if(tileColor.a < ${_.float(Or)}) {
            discard;
          }

          bool sliced = rejectBySlice(vpos);
          if (sliced) {
            tileColor *= ${_.float(C)};
          }

          vec3 albedo = tileColor.rgb;

          // heuristic shading function used in the old terrain, now used to add ambient lighting

          vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

          ${l===5||l===6?_`fragColor = vec4(evaluatePBRSimplifiedLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight, normalize(vpos - cameraPosition), vup), tileColor.a);`:_`fragColor = vec4(evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);`}
          ${X(v,_`vec4 overlayWaterMask = getOverlayColor(ovWaterTex, vtcOverlay);
                   float waterNormalLength = length(overlayWaterMask);
                   if (waterNormalLength > 0.95) {
                     mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);
                     vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);
                     vec4 viewPosition = view*vec4(vpos, 1.0);
                     vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - cameraPosition), shadow, vnormal, tbnMatrix, viewPosition.xyz,  vpos + localOrigin);
                     vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                     float opacity = sliced ? ${_.float(C)} : 1.0;
                     // un-gamma the ground color to mix in linear space
                     fragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w) * opacity;
                   }`)}
          ${X(e.visualizeNormals,p?_`
                  vec3 localUp = normalize(vpos + localOrigin);
                  vec3 right = normalize(cross(vec3(0.0, 0.0, 1.0), localUp));
                  vec3 forward = normalize(cross(localUp, right));
                  mat3 tbn = mat3(right, forward, localUp);
                  vec3 tNormal = normalize(normal * tbn);
                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);`:_`
                  vec3 tNormal = normalize(normal);
                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);`)}
          ${X(u,_`vec2 dVuv = fwidth(vuv0);
                 vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv0, 1.0 - vuv0));
                 float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);
                 fragColor = mix(fragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);`)}
          fragColor = applySlice(fragColor, vpos);`)}break;case 2:y&&t.include(Zu,e),r.main.add(_`
        ${X(y,"setOverlayVTC(uv0);")}
        gl_Position = transformPosition(proj, view, position);`),s.main.add(`${X(y,`if (getCombinedOverlayColor().a < ${_.float(Or)}) discard;`)}`);break;case 4:case 5:case 6:case 7:case 8:t.include(d4,e),S8(t),T8(t),r.main.add(_`gl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);`),s.main.add(_`outputDepth(linearDepth);`);break;case 3:y&&t.include(Zu,e),n.add("vnormal","vec3"),C8(r),a(),r.main.add(_`
        ${X(y,"setOverlayVTC(uv0);")}
        gl_Position = transformPosition(proj, view, position);
        vnormal = normalize((viewNormal * vec4(getNormal(), 1.0)).xyz);`),s.main.add(_`
        ${X(y,`if (getCombinedOverlayColor().a < ${_.float(Or)}) discard;`)}
        vec3 normal = normalize(vnormal);
        if (gl_FrontFacing == false) {
          normal = -normal;
        }
        fragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);`);break;case 9:f&&(t.include(Zu,e),t.include(SE,e)),r.main.add(_`
        ${X(f,"setOverlayVTC(uv0);")}
        gl_Position = transformPosition(proj, view, position);`),t.include(O2,e),s.main.add(_`
        ${X(f,_`
           calculateOcclusionAndOutputHighlight(getAllOverlayHighlightValuesEncoded());`,"calculateOcclusionAndOutputHighlight();")}
      `)}if(o===10)if(f)e.pbrMode=0,t.include(Zu,e),e.pbrMode=l,r.main.add(_`gl_Position = transformPosition(proj, view, position);
setOverlayVTC(uv0);`),s.main.add(_`fragColor = getOverlayColorTexel();`);else{const v=m===0;r.main.add(_`${X(v,"gl_Position = transformPosition(proj, view, position);")}`),s.main.add(_`fragColor = vec4(0.0);`)}return t}const XW=Le(),iT=w(),YW=Object.freeze(Object.defineProperty({__proto__:null,TerrainPassParameters:ow,build:TE},Symbol.toStringTag,{value:"Module"}));let KW=class extends ct{constructor(e,t){super(e,t,new ht(YW,()=>k(()=>Promise.resolve().then(()=>aee),void 0)),iE.locations),this.type="TerrainTechnique",this.useStencil=!1}initializePipeline(e){return this._stencilPipelineState=this._createPipeline(e,!0),this._createPipeline(e,!1)}_createPipeline(e,t){const{renderOccluded:i,output:r}=e,s=e.backfaceCullingEnabled&&!i;return Ge({blending:i?fu:null,culling:s?o4:null,depthTest:i?null:{func:513},depthWrite:i?null:T2,colorWrite:st,stencilTest:t?m8(1):null,drawBuffers:Sh(r)})}getPipeline(){return this.useStencil?this._stencilPipelineState:super.getPipeline()}},Hr=class extends S_{constructor(e){super(),this.spherical=e,this.overlayMode=0,this.tileBlendInput=0,this.transparencyMode=0,this.pbrMode=5,this.receiveShadows=!1,this.backfaceCullingEnabled=!1,this.textureFadingEnabled=!1,this.renderOccluded=!1,this.screenSpaceReflections=!1,this.cloudReflections=!1,this.receiveAmbientOcclusion=!1,this.tileBorders=!1,this.visualizeNormals=!1,this.normalType=1,this.textureCoordinateType=1,this.highStepCount=!1,this.useCustomDTRExponentForWater=!1,this.useFillLights=!1,this.hasColorTexture=!0,this.draped=!1}get overlayEnabled(){return this.overlayMode!==0}};h([z({count:3})],Hr.prototype,"overlayMode",void 0),h([z({count:3})],Hr.prototype,"tileBlendInput",void 0),h([z({count:4})],Hr.prototype,"transparencyMode",void 0),h([z({count:7})],Hr.prototype,"pbrMode",void 0),h([z()],Hr.prototype,"receiveShadows",void 0),h([z()],Hr.prototype,"backfaceCullingEnabled",void 0),h([z()],Hr.prototype,"textureFadingEnabled",void 0),h([z()],Hr.prototype,"renderOccluded",void 0),h([z()],Hr.prototype,"screenSpaceReflections",void 0),h([z()],Hr.prototype,"cloudReflections",void 0),h([z()],Hr.prototype,"receiveAmbientOcclusion",void 0),h([z()],Hr.prototype,"tileBorders",void 0),h([z()],Hr.prototype,"visualizeNormals",void 0);const H0=7,JW=10,q0=eo();let Cs=class extends Zp{get visibleTiles(){return Array.from(this._visiblePatchesByOrigin.values()).flat()}get _isGlobal(){return this._stage.viewingMode===1}get _techniques(){return this._context.techniques}get _rctx(){return this._context.renderContext.rctx}constructor(e,t,i,r,s){super({}),this._overlayRenderer=e,this._stage=t,this._allTiles=i,this._compressionTracker=r,this.type=7,this.isGround=!0,this._passParameters=new ow,this._drawParameters=new IO,this._renderDataPool=new Eo(()=>new OG),this._visiblePatchesByOrigin=new Map,this._allPatchesByOrigin=new Map,this._patchesByOriginDirty=!0,this._patchSortingDirty=!0,this._tileIterator=new VO,this._castShadows=!1,this._inViewshed=!1,this._cutFillEnabled=!1,this._tileRenderer=null,this._stencilEnabledLayerExtents=new Array,this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0,this.renderOccludedFlags=1,this.produces=new Map([[1,()=>this._produces()&&this.transparency===0],[6,()=>this._produces()&&(this.transparency===1||this.transparency===2)],[9,()=>this._produces()&&this.renderOccludedFlags===tp]]),this._tileSize=256,this._configuration=new Hr(t.viewingMode===1),this._tileTextureCache=new Yp((n,a)=>s.newCache(n,a),"TileTexture"),this.tileGeometryCache=new C$(s)}normalizeCtorArgs(){return{}}initialize(){this._stage.addRenderPlugin(this),this.addHandles(M(()=>this._overlayRenderer.renderOccludedFlags,e=>{this.renderOccludedFlags=e,this.setNeedsRender()},Ie))}destroy(){this._stage.removeRenderPlugin(this),this._tileTextureCache.destroy(),this.tileGeometryCache.destroy(),this._allTiles.prune(),this._tileRenderer=null}_produces(){return this.visible&&!!this._rootTiles&&!this.renderingDisabled}consumes(){return this._overlayRenderer.hasWater?xV:TR}set renderingDisabled(e){this._set("renderingDisabled",!!e),this.setDirty()}set visible(e){this._set("visible",!!e),this.setDirty()}updateHeading(e){this._tileRenderer?.updateHeading(e)}set transparency(e){this._configuration.transparencyMode!==e&&(this._configuration.transparencyMode=e,this.setNeedsRender())}get transparency(){return this._configuration.transparencyMode}get renderPatchBorders(){return this._configuration.tileBorders}set renderPatchBorders(e){this._configuration.tileBorders!==e&&(this._configuration.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get visualizeNormals(){return this._configuration.visualizeNormals}set visualizeNormals(e){this._configuration.visualizeNormals!==e&&(this._configuration.visualizeNormals=e,this.setNeedsRender(),this.notifyChange("visualizeNormals"))}get cullBackFaces(){return this._configuration.backfaceCullingEnabled}set cullBackFaces(e){this._configuration.backfaceCullingEnabled!==e&&(this._configuration.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}get layerViewUid(){return Lo}get slicePlaneEnabled(){return this._configuration.hasSlicePlane}set slicePlaneEnabled(e){this._configuration.hasSlicePlane!==e&&(this._configuration.hasSlicePlane=e,this.setNeedsRender())}set textureFadingEnabled(e){this._configuration.textureFadingEnabled!==e&&(this._configuration.textureFadingEnabled=e,this.setNeedsRender())}set pbrMode(e){this._configuration.pbrMode!==e&&(this._configuration.pbrMode=e,this.setNeedsRender())}setRootTiles(e){this._rootTiles=e,this.setDirty()}setStencilEnabledLayerExtents(e){this._stencilEnabledLayerExtents=e,this._setSortingDirty()}set tileSize(e){this._tileSize=e,this._tileRenderer!=null&&(this._tileRenderer.tileSize=e),this.setDirty()}get tileSize(){return this._tileSize}_ensureRenderData(e){e.renderData||(e.renderData=this._renderDataPool.acquire(),e.renderData.init(e,this._getLocalOriginOfTile(e)))}loadTile(e){this._ensureRenderData(e),this.updateTileGeometryState(e),this.reuseTextureFromParent(e)||this.updateTileTexture(e,32)}reuseTextureFromParent(e){const t=e.parent;if(!t)return!1;const i=Mi(1&e.lij[2]?.5:0,1&e.lij[1]?0:.5,.5,.5);return t.renderData?.reuseTexture(e.renderData,i)??!1}updateTileTexture(e,t){this._tileRenderer!=null&&(this._tileRenderer.updateTileTexture(e,t===32?0:2),this.setNeedsRender(),e.resetPendingUpdate(t))}updateTileGeometryState(e){for(const i of e.layerInfo[0])i.pendingUpdates&=-9;e.resetPendingUpdate(8);const t=e.renderData.updateGeometryState();return t&&this.setDirty(),t}updateGeometryIfNeeded(e){e.loaded&&e.renderData.updateGeometryIfNeeded(this._rctx)}unloadTile(e){const t=e.renderData;t&&(t.releaseGeometry(),this._renderDataPool.release(t),t.clear(),e.renderData=null,e.setMemoryDirty(),this.setDirty())}_getLocalOriginOfTile(e){const t=JW-H0,i=Math.max(0,Math.floor((e.level-t)/H0)*H0);if(this._isGlobal&&i===0)return ia;for(;e.parent&&e.level>i;)e=e.parent;return e.centerAtSeaLevel}getStats(){return{numTilesRendered:this._numTilesRendered,numTilesCulled:this._numTilesCulled,numOriginsRendered:this._numOriginsRendered}}set wireframe(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.setNeedsRender())}setDirty(e=1){this._patchesByOriginDirty=!0,this._context.requestRender(e)}_setSortingDirty(e=1){this._patchSortingDirty=!0,this._context.requestRender(e)}setNeedsRender(e=1){this._context.requestRender(e)}initializeRenderContext(e){this._context=e,this._tileRenderer=new wW(this._rctx,this._tileSize,this._techniques,this._tileTextureCache,this._compressionTracker),this.updateTileBackground()}uninitializeRenderContext(){this._tileRenderer=ye(this._tileRenderer)}intersect(e,t,i,r){if(!this._rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&this.transparency!==0)return;const s=eZ,n=tZ;de(s,r,i),xe(n,1/s[0],1/s[1],1/s[2]);const a=e.results.min,o=e.results.max,l=e.results.ground,c=e.options.store===0,u=!!e.results.ground.target,p=a8(e.verticalOffset),m=e.tolerance;let f,g=c&&a.distance!=null?a.distance:1/0;const y=e.options,v=y.normalRequired||!y.backfacesTerrain,C=new P2(m,!1,v),b=x=>{const T=x.renderData;if(!T?.vao)return;const P=T.geometry;mM(q0,P.boundingBox);const R=T.localOrigin;p!=null&&(p.localOrigin=R,p.applyToAabb(q0));const O=q0;if(Zc[0]=i[0]-R[0],Zc[1]=i[1]-R[1],Zc[2]=i[2]-R[2],!t4(O,Zc,n,m,g))return;const E=(G,be,ae)=>{G.set(this.type,x,be,ae),g=c&&a.distance!=null?a.distance:1/0},A=(G,be,ae)=>{if((!v||ae!=null)&&G>=0&&(y.backfacesTerrain||$e(ae,s)<0)&&(y.invisibleTerrain||!y.selectionMode||t==null||t(i,r,G))){if((l.distance==null||G<l.distance)&&E(l,G,ae),y.isFiltered)return;y.store===2&&(f==null?(f=new CM(e.ray),E(f,G,ae),e.results.all.push(f)):G<f.distance&&E(f,G,ae)),(a.distance==null||G<a.distance)&&E(a,G,ae),y.store!==0&&(o.distance==null||G>o.distance)&&E(o,G,ae)}},F=iZ;de(F,r,R);const{indices:L,indexCount:H}=P,V=P.vertexAttributes,I=V.getField("position",_F),B=new bM(I.typedBuffer,3,V.stride/4),ee=H/3;if(!p&&ee>SW){const G=x.renderData;G.intersectionData==null&&(G.intersectionData=new wE(L,0,ee,B)),G.intersectionData.intersectRay(Zc,F,C,A)}else d8(Zc,F,0,ee,L,B,p,C,A)},S=this._rootTiles;S!=null&&(()=>{const x=this._tileIterator;x.reset(S);const T=e.options.invisibleTerrain;for(let P=x.next();P;P=x.next())!(P.visible||T&&P.intersectsClippingArea)||p==null&&!P.intersectsRay(i,s,m,g)||u&&this._useStencilForTile(P)?x.skipSubtree():b(P)})()}processScaleRangeQueries(e,t){if(!t.done&&e)for(this._updatePatchGroups();e.updating&&!t.done;){e.prepare();for(const i of this._visiblePatchesByOrigin.values())for(const r of i)r.renderData?.textureReference!=null&&e.queriesForTile(r);e.process(),t.madeProgress()}}acquireTechniques(e){const t=!!Qe("enable-feature:terrain-shadows")&&e.bind.shadowMap.enabled;t!==this._castShadows&&(this._castShadows=t,this._patchesByOriginDirty=!0);const i=e.bind.viewshedEnabled;this._inViewshed!==i&&(this._inViewshed=i,this._patchesByOriginDirty=!0);const r=e.bind.cutFillEnabled;if(this._cutFillEnabled!==r&&(this._cutFillEnabled=r,this._patchesByOriginDirty=!0),e.bind.slot===9){if((e.renderOccludedMask&tp)===0)return null}else{const n=this.transparency===0?1:6;if(e.bind.slot!==n)return null}if(this.transparency===3)return null;const s=this._configuration;switch(s.screenSpaceReflections=s.cloudReflections=s.receiveShadows=s.receiveAmbientOcclusion=s.renderOccluded=s.hasHighlightMixTexture=!1,s.overlayMode=this._overlayRenderer.mode,e.output){case 0:case 1:{s.screenSpaceReflections=e.bind.ssr.lastFrameColor!=null,s.cloudReflections=e.bind.clouds.data!=null;const n=e.bind.slot===9;return s.receiveShadows=e.bind.shadowMap.ready&&!n,s.renderOccluded=n,s.receiveAmbientOcclusion=!n&&e.bind.ssao!=null,this._acquireTechnique(e.output)}case 4:case 6:return this._castShadows?this._acquireTechnique(4):null;case 7:return this._inViewshed?this._acquireTechnique(7):null;case 8:return this._cutFillEnabled?this._acquireTechnique(8):null;case 2:case 3:return this._acquireTechnique(e.output);case 10:return this._acquireTechnique(10);case 9:return s.hasHighlightMixTexture=e.bind.highlightMixTexture!=null,this._overlayRenderer.hasHighlights?this._acquireTechnique(9):null}return null}render(e,t){switch(this._updatePatchGroups(),t.useStencil=!1,this._passParameters.overlayContent=UW(e.output,e.bind),e.output){case 0:case 1:this._renderMaterialPass(e,t);break;case 2:case 3:case 10:this._renderAuxiliaryPass(e,t,this._visiblePatchesByOrigin);break;case 9:{const i=e.bind.highlight?.name;i&&this._overlayRenderer.hasHighlights&&this._overlayRenderer.renders(2)&&this._overlayRenderer.hasHighlight(i)&&this._renderAuxiliaryPass(e,t,this._visiblePatchesByOrigin);break}case 4:case 6:case 7:case 8:this._renderAuxiliaryPass(e,t,this._allPatchesByOrigin)}}updateTileBackground(e){if(this._tileRenderer==null)return;const t=this._tileRenderer;let i;if(e!=null){const r=wi.toUnitRGBA(e);i=We(r[0]||0,r[1]||0,r[2]||0)}t.setBackground(i),this._allTiles.forAll(r=>t.updateTileTexture(r,0)),this._configuration.tileBlendInput=t.backgroundIsGrid?2:t.backgroundColor!=null?1:0,this.setNeedsRender()}_updatePatchGroups(){if(this._patchesByOriginDirty&&(this._rebuildPatchGroups(),this._patchesByOriginDirty=!1,this._patchSortingDirty=!0),this._patchSortingDirty){const e=Array.from(this._visiblePatchesByOrigin.values()),t=this._stencilEnabledLayerExtents;for(const i of e)zO(i,t);e.sort((i,r)=>kO(i[0],r[0])),this._visiblePatchesByOrigin=new Map(e.map(i=>[i[0].renderData.localOrigin,i])),this.notifyChange("visibleTiles"),this._patchSortingDirty=!1}}_rebuildPatchGroups(){const e=this._rootTiles;if(e!=null){e[0]?.surface.checkAllTilesWaterproofness(),this._visiblePatchesByOrigin.clear(),this._allPatchesByOrigin.clear();for(const t of e)this._rebuildPatchGroupsForRootTile(t)}}_rebuildPatchGroupsForRootTile(e){const t=this._tileIterator;for(t.resetOne(e);!t.done;){const i=t.next(),r=i.renderData;if(!r){this._numTilesCulled++;continue}const s=r.localOrigin;if(this._castShadows||this._inViewshed||this._cutFillEnabled){let a=this._allPatchesByOrigin.get(s);a||(a=[],this._allPatchesByOrigin.set(s,a)),a.push(i)}if(!i.visible){this._numTilesCulled++,t.skipSubtree();continue}let n=this._visiblePatchesByOrigin.get(s);n||(n=[],this._visiblePatchesByOrigin.set(s,n)),n.push(i),t.skipSubtree()}}_useStencilForTile(e){for(const t of this._stencilEnabledLayerExtents)if(e.intersectsExtent(t))return!0;return!1}_renderAuxiliaryPass(e,t,i){const{rctx:r,bind:s}=e;r.bindTechnique(t,s,this._passParameters);const n=this._stencilEnabledLayerExtents.length>0;i.forEach(a=>{this._drawParameters.origin=a[0].renderData.localOrigin,t.program.bindDraw(s,this._passParameters,this._drawParameters);for(let o=0;o<a.length;o++)this._renderPatch(r,t,a[o],St.TRIANGLES,n,this._passParameters.overlayContent===null)}),r.bindVAO(null)}_renderMaterialPass(e,t){const{rctx:i,bind:r}=e;i.bindTechnique(t,r,this._passParameters),this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0;const s=t.program,n=this._stencilEnabledLayerExtents.length>0,a=r.slot===9;a&&(s.bindTexture("tex",i.emptyTexture),s.setUniform3fv("textureOpacities",ia),s.setUniform4fv("texOffsetAndScale",di));const o=this._tileRenderer?.backgroundColor!=null?this._tileRenderer.backgroundColor:ia;this._configuration.tileBlendInput===1&&s.setUniform3fv("backgroundColor",o);const l=this.wireframe?St.LINES:St.TRIANGLES;this._configuration.textureFadingEnabled&&s.bindTexture("texNext",i.emptyTexture);const c=this._visiblePatchesByOrigin;for(const u of c.values()){const p=u[0].renderData.localOrigin;this._drawParameters.origin=p,t.program.bindDraw(r,this._passParameters,this._drawParameters),this._numOriginsRendered++;for(const m of u){const f=m.renderData,g=f.textureReference;if(g!=null){if(!a){s.setUniform4fv("texOffsetAndScale",g.offsetAndScale),s.bindTexture("tex",g.texture.texture);const y=f.textureFadeFactor,v=y<1?f.nextTextureReference:null;this._configuration.textureFadingEnabled&&v&&y<1?(s.setUniform1f("fadeFactor",y),s.setUniform4fv("nextTexOffsetAndScale",v.offsetAndScale),s.setUniform3fv("nextTexOpacities",v.opacities),s.bindTexture("texNext",v.texture.texture)):s.setUniform1f("fadeFactor",1),f.textureIsFading&&this.setNeedsRender(2),s.setUniform3fv("textureOpacities",g.opacities)}this._renderPatch(i,t,m,l,n),m.renderOrder=this._numTilesRendered,this._numTilesRendered++}}}i.bindVAO(null)}_renderPatch(e,t,i,r,s,n=!1){const a=i.renderData,o=a.vao,l=o?.indexBuffer;if(!o||l==null)return void(vi&&console.error("Rendered tile with no indices: ",i.lij," : ",a));const c=t.program;n||this._overlayRenderer.isEmpty||this._bindOverlayPatchData(c,a.overlay),s&&(t.useStencil=this._useStencilForTile(i),e.setPipelineState(t.getPipeline()));const u=a.geometry.indexCount;e.bindVAO(o),c.assertCompatibleVertexAttributeLocations(o),e.drawElements(r,u,l.indexType,0)}_bindOverlayPatchData(e,t){e.setUniform4fv("overlayTexOffset",t.offsets),e.setUniform4fv("overlayTexScale",t.scales)}_acquireTechnique(e){return this._configuration.output=e,this._techniques.get(KW,this._configuration)}get test(){}hasHighlight(e){return this._overlayRenderer.hasHighlight(e)}};h([d({readOnly:!0})],Cs.prototype,"visibleTiles",null),h([d({readOnly:!0})],Cs.prototype,"_isGlobal",null),h([d()],Cs.prototype,"renderOccludedFlags",void 0),h([d({value:!1})],Cs.prototype,"renderingDisabled",null),h([d({value:!0})],Cs.prototype,"visible",null),h([d()],Cs.prototype,"renderPatchBorders",null),h([d()],Cs.prototype,"visualizeNormals",null),h([d()],Cs.prototype,"cullBackFaces",null),h([d()],Cs.prototype,"wireframe",null),Cs=h([D("esri.views.3d.terrain.TerrainRenderer")],Cs);const eZ=w(),tZ=w(),Zc=w(),iZ=w();let rZ=class{constructor(){this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array}},Wn=class extends ie{constructor(e){super(e)}initialize(){this.addHandles([this.layers.on("change",()=>this._update()),M(()=>this.extentHelper.layerViewsExtent,()=>this._setAdHocTilingScheme())]),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._waitTask=null,this.layers.destroy()}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this.layers.some(t=>!(!jh(t)||t.isRejected())&&!(t.isFulfilled()&&!sZ(t,this.viewSpatialReference,this.viewingMode))&&(e=t,!(t?.type==="vector-tile"||m_(t)))),e)if(e.isResolved()){const t=X_(e,this.viewSpatialReference,this.viewingMode);if(t!=null){const i=new pn(t.tileInfo);this._lockTilingScheme(i)}}else this._updateWhen(e)}_updateWhen(e){const t=e.when().catch(()=>{}).then(()=>{t!==this._waitTask||this.destroyed||this._update()});this._waitTask=t}_lockTilingScheme(e){if(this.viewingMode===1){const t=e.levels.length-1,i=e.spatialReference;i.isWebMercator?e=pn.makeWebMercatorAuxiliarySphere(t):Vb(i)&&(e=pn.makeGCSWithTileSize(e.spatialReference,e.pixelSize,t))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this.removeAllHandles(),this.addHandles(M(()=>this.extentHelper.tiledLayersExtent,()=>this._updateTiledLayerExtent()))}_updateTiledLayerExtent(){this._set("extent",this.extentHelper.tiledLayersExtent)}_setAdHocTilingScheme(){if(this.viewingMode===1){const e=this.extentHelper.viewSpatialReference;e.isWebMercator?this.tilingScheme=pn.WebMercatorAuxiliarySphere:oO(e)&&(this.tilingScheme=pn.makeGCSWithTileSize(e,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{const e=this.extentHelper.layerViewsExtent;e==null||$l(e,this.extent)||(this.tilingScheme=pn.fromExtent(e,this.extentHelper.viewSpatialReference),this._set("extent",e))}}get test(){}};function sZ(e,t,i){return X_(e,t,i)!=null}h([d()],Wn.prototype,"tilingScheme",void 0),h([d({readOnly:!0})],Wn.prototype,"extent",void 0),h([d({value:!1})],Wn.prototype,"tilingSchemeLocked",void 0),h([d({constructOnly:!0})],Wn.prototype,"viewSpatialReference",void 0),h([d({constructOnly:!0})],Wn.prototype,"layers",void 0),h([d({constructOnly:!0})],Wn.prototype,"extentHelper",void 0),h([d({constructOnly:!0})],Wn.prototype,"viewingMode",void 0),Wn=h([D("esri.views.3d.terrain.TilingSchemeLogic")],Wn);let nZ=class{constructor(){this._offset=ze(),this.scale=0}get offset(){return this._offset}init(e,t,i,r){this.tile=e,this._offset[0]=t,this._offset[1]=i,this.scale=r}dispose(){this.tile=null,this._offset[0]=0,this._offset[1]=0,this.scale=0}},aZ=class{constructor(){this._pendingCompressionTasks=ar(0)}get compressing(){return!!this._pendingCompressionTasks.value}increment(){this._pendingCompressionTasks.value++}decrement(){this._pendingCompressionTasks.value--}};var mg;let Se=class extends gu{static{mg=this}get allTiles(){return ec(this._allTiles)}get renderedTiles(){return zO(v2(this._allTiles.toArray(),e=>e.visible&&e.rendered))}get demResolution(){const{_allTiles:e,tilingScheme:t}=this;if(e.length===0)return{min:1,max:1};const i=Zh(t.spatialReference);let r=Number.POSITIVE_INFINITY,s=Number.NEGATIVE_INFINITY;for(const n of e){const a=t.resolutionAtLevel(n.level)*i;r=Math.min(r,a),s=Math.max(s,a)}return{min:r,max:s}}constructor(e){super(e),this.terrainTextureCompressionTracker=new aZ,this._iteratorPool=new Eo(()=>new VO,i=>i.remove=()=>this._iteratorPool.release(i)),this._postorderIterator=new wG,this._hasPendingUpdates=!1,this._pendingUpdates=0,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._usedMemory=null,this._performanceInfo=new rZ,this._viewChanged=!1,this.heading=0,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._eyePosRenderSR=w(),this._eyePosSurfaceSR=w(),this._splitLimits=new on,this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._watchUpdatingTracking=new dc,this._frameTask=fp,this._allTiles=new jt,this._upsampleInfoPool=new Eo(()=>new nZ),this._shouldEmitChangeEvent=!1,this._rootTilesExtent=Rt(),this.updatingProgress=.5,this._maxNumUpdating=1,this.maxTextureScale=1.2,this._spatialReference=At.WebMercator,this._elevationProjectorCache=new Map,this.visibleElevationBounds=new Vh(1/0,-1/0),this.rootTileElevationBounds=new Vh(1/0,-1/0),this._projectorCache=new Map,this._tilingSchemeSpatialReference=null,this._updatingRootTiles=!1,this._pendingTilesForElevationUpdateEvent=new Set,this._pendingTilesToUpdate=new Set,this.totalGeometryUpdates=0,this.totalTileUpdates=0,this._oneBatchPerFrameTask=!0,this._layerViewsDirty=!1,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._isWebMercator=!1,this._isWebMercatorOnPlateCarree=!1,this.enabled=!0;const{view:t}=e;this.overlayManager=new xr({...e,terrainSurface:this}),this._isGlobal=!t.state?.isLocal,this._isGeographic=this._spatialReference?.isGeographic??!1,this._tileConstructor=this._isGlobal?w$:_$,this._ellipsoid=Yt(t.spatialReference),this._renderer=new Cs(this.overlayManager.renderer,t.stage,this._allTiles,this.terrainTextureCompressionTracker,t.resourceController.memoryController),Df()||(this._scaleRangeQueries=new pg)}initialize(){const{view:e}=this,{resourceController:t}=e,{memoryController:i}=t;this._tileCache=new Yp((l,c)=>i.newCache(l,c),"terrain-tile"),this._upsampleMapCache=i.newCache("terrain-upsample",({tile:l})=>l.unloadMapData()),this._elevationQueryCache=new pH(i.newCache("elevation-query"));const r=this.overlayManager;this.addHandles([M(()=>r.renderer.isEmpty,()=>this._evaluateTransparency()),M(()=>this.renderer.visible,l=>this.suspended=!l),M(()=>this.heading,l=>{this._renderer.updateHeading(l),this._updateTileTextures(0)}),M(()=>({heading:e.camera?.heading,state:e.state?.mode}),({heading:l,state:c})=>{if(l==null)return;if(this.isGlobal&&this.isGeographic||this.isWebMercatorOnPlateCarree)return void(this.heading=90*Math.round(l/90)%360);const u=Math.round(l)%360,p=Math.abs(u-this.heading);(c===2||Math.min(p,360-p)>=30)&&(this.heading=u)})],"overlayManager"),this.addHandles([M(()=>this.baseOpacity,()=>{this._handleLayerViewChanges(),this._updateTileTextures(this._evaluateTransparency()?1:2)},Ve),M(()=>this.hasCompositeBlendMode,()=>this._updateTileTextures(this._evaluateTransparency()?1:2),Ve),M(()=>this.backgroundColor,(l,c)=>{l?.equals(c)||(this._handleLayerViewChanges(),this._renderer.updateTileBackground(l))},Ie),M(()=>this.snapLevel,()=>this._viewChanged=!0,Ie),M(()=>this.view.pointsOfInterest,l=>{this._renderer.pointsOfInterest=l,this._watchUpdatingTracking.removeAll(),l&&this._watchUpdatingTracking.add(()=>l.focus?.renderLocation,()=>this._allTilesSorted=!1,{equals:Go})}),M(()=>bi.TERRAIN_TILE_TREE_SHOW_TILES,l=>{l&&!this._treeDebugger?k(async()=>{const{TerrainTileTree3DDebugger:c}=await le(()=>import("./TerrainTileTree3DDebugger-DLG2XTCo-Cu-oK0va.js"),__vite__mapDeps([465,3,4,19,9,7,1,2,8,20,14,466,13,25,5,6,10,11,12,15,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43]));return{TerrainTileTree3DDebugger:c}},ue([466,1,2,19,9,7,8,5,6,20,14,467,13,26,3,4,10,11,12,15,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44])).then(({TerrainTileTree3DDebugger:c})=>{!this._treeDebugger&&bi.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new c({view:e}))}):l||(this._treeDebugger=Z(this._treeDebugger))},Ee)]);const{spatialReference:s}=e;this._extentHelper=VH(this.viewingMode,{layers:e.map.allLayers,layerViews:e.allLayerViews,viewSpatialReference:s});const n=new q4({getCollections:()=>e.defaultsFromMap?.mapCollections?.map(({layers:l})=>l),getChildrenFunction:l=>l&&"layers"in l?l.layers:null}),a=new Wn({layers:n,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:s});this._set("tilingSchemeLogic",a),this._updateTilingScheme(),this._elevationDataRequester=t.createStreamDataRequester(0),this._mapDataRequester=t.createStreamDataRequester(1);const o=t.scheduler;this._frameTask=o.registerTask(mi.TERRAIN_SURFACE,this),this.addHandles([M(()=>this._extentHelper.stencilEnabledExtents,l=>this._renderer.setStencilEnabledLayerExtents(l),Ee),M(()=>this.tilingSchemeLogic.tilingScheme,()=>this._updateTilingScheme(),Ie),M(()=>this.extent,()=>this._updateRootTiles(),Ee),e.on("resize",()=>this._viewChangeUpdate()),M(()=>{const l=e.state;return[this._lodBias,this.lodSnappingEnabled,e.quality,l.camera,l.contentCamera,l.fixedContentCamera]},()=>this._viewChangeUpdate(),Ve),M(()=>e.qualitySettings?.fadeDuration,l=>this._renderer.textureFadingEnabled=l>0,Ee),M(()=>e.qualitySettings?.physicallyBasedRenderingEnabled,l=>this._renderer.pbrMode=l?5:0,Ee),M(()=>e.qualitySettings?.tiledSurface.elevationLevelDelta,()=>this._updateAllTileGeometries()),M(()=>this._userClippingExtent,()=>this._updateClippingExtent(),Ie)]),this.addHandles(e.allLayerViews.on("after-changes",()=>this._layerViewsDirty=!0)),this._layerViewsDirty=!0,this._handleLayerViewChanges(),this._renderer.updateTileBackground(this.backgroundColor)}clearHandles(){this._watchUpdatingTracking?.removeAll(),this.removeAllHandles(),this._basemapLayerViewHandles.forEach((e,t)=>this._unregisterTiledLayerView(t)),this._basemapLayerViewHandles.clear()}destroy(){this._frameTask.remove(),this._frameTask=fp,this._watchUpdatingTracking?.destroy(),this._removeAllTiles(),this._set("tilingSchemeLogic",Z(this.tilingSchemeLogic)),this._basemapLayerViewHandles.forEach((e,t)=>this._unregisterTiledLayerView(t)),this._basemapLayerViewHandles.clear(),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",Z(this.overlayManager)),this._tileCache=Z(this._tileCache),this._allTiles.prune(),Yb.prune(),this._treeDebugger=Z(this._treeDebugger),this._renderer.destroyed||this._renderer.destroy(),this._renderer=null,this._iteratorPool=Z(this._iteratorPool),this._upsampleMapCache=Z(this._upsampleMapCache),this._elevationQueryCache=Z(this._elevationQueryCache),this._set("view",null),this._extentHelper=Z(this._extentHelper),this._upsampleInfoPool=Z(this._upsampleInfoPool),UG(),this._layerViews.forEach(e=>e.length=0),this._performanceInfo=null}get renderer(){return this._renderer}get frustum(){return this.view.state.camera.frustum}get snapLevel(){return this.lodSnappingEnabled?this.view.terrainLevel:null}get lodSnappingEnabled(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get hasStencilEnabledExtents(){return this._extentHelper.stencilEnabledExtents.length>0}get _userClippingExtent(){const{spatialReference:e}=this,t=this.view?.clippingArea;if(t==null||e==null)return null;const i=Rt(),r=mH(t,i,e)?i:null,s=this._get("extent");return $l(r,s)?s:r}get rootTilesExtent(){return this._rootTilesExtent}get extent(){const e=Ev(this.groundExtent,this._userClippingExtent,Rt()),t=this._get("extent");return $l(e,t)?t:e}get groundExtent(){return this._tilingSchemeExtent!=null?this._tilingSchemeExtent:this._rootTilesExtent}get _tilingSchemeExtent(){return this.tilingSchemeLogic?.extent}get updating(){return this._hasPendingUpdates||(this._maxNumUpdating=1),this.enabled&&!!((this.readyToRun||this._watchUpdatingTracking?.updating||this._asyncWorkItems>0)&&this.ready&&!this.suspended||this.overlayManager?.updating||this.terrainTextureCompressionTracker.compressing)}get readyToRun(){return this.enabled&&(this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||!this._allTilesSorted||this._layerViewsDirty||this._scaleRangeQueries?.updating||this._frameTask.updating)&&this.ready&&!this.suspended}get updatingProgressValue(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}get baseOpacity(){return this.view?.map?.ground?.opacity??1}set baseOpacity(e){this.view.map.ground.opacity=e}get viewingMode(){return this.view.state.viewingMode}get ready(){return!this.enabled||this._rootTiles!=null}get rootTiles(){return this._rootTiles}get spatialReference(){return this.tilingScheme?.spatialReference??null}get backgroundColor(){return this.view?.map?.ground?.surfaceColor}set backgroundColor(e){this.view.map.ground.surfaceColor=e}set slicePlaneEnabled(e){this._renderer.slicePlaneEnabled=e,this._set("slicePlaneEnabled",e),this._evaluateTransparency()}get tilingSchemeLocked(){return this.tilingSchemeLogic?.tilingSchemeLocked??!1}get wireframe(){return this._renderer?.wireframe}set wireframe(e){e!==this._renderer.wireframe&&(this._renderer.wireframe=e,this._updateAllTileGeometries())}get opaque(){return this._renderer.transparency===0}get invisible(){return this._renderer.transparency===3}set suspended(e){this._set("suspended",e),this._viewChangeUpdate()}get fadeDuration(){return this.view.qualitySettings.fadeDuration??0}intersect(e,t,i,r){this._renderer.intersect(e,t,i,r)}getElevationLevelDelta(e){return e<4?3:this.view.qualitySettings.tiledSurface.elevationLevelDelta}get _xNormalizer(){return G4(this._spatialReference)}getElevation(e,t,i,r){const s=this._rootTiles;if(!s?.length||!this.enabled||s[0].layerInfo[0].length===0)return null;let n=this._elevationProjectorCache.get(r);if(n===void 0&&(n=Jw(r,this._spatialReference)??null,this._elevationProjectorCache.set(r,n)),n==null)return $.getLogger(this).error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;const a=xe(Qu,e,t,i);return n(a,0,a,0),sT(s,this._xNormalizer?.normalize(a[0])??a[0],a[1])}getElevations(e,t,i){const r=this._rootTiles,s=r?r[0].layerInfo[0].length:0;if(r?.length&&s!==0&&this.enabled)for(let n=0;n<t;++n){const a=3*n;i(n,sT(r,e[a],e[a+1]))}else for(let n=0;n<t;++n)i(n,null)}getLayerIndexByUID(e,t){return this._layerIndexByUid[e].get(t)}getScale(e){if(!this.tilingScheme)return null;if(!Ha(e,Qu,this.spatialReference))return $.getLogger(this).error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;const t=this._rootTiles;if(t!=null){for(const i of t)if(i?.containsPoint(Qu)){let r=i;for(;r.children[0]&&!r.rendered;){const s=r.children[0].extent;let n=0;Qu[0]>s[2]&&(n+=1),Qu[1]<s[1]&&(n+=2),r=r.children[n]}return this._getLodBiasCorrectedScale(r.level)}}return 1/0}_ensureProjector(e){const t=this._projectorCache.get(e);if(t)return t;const i=Jw(e,this._tilingSchemeSpatialReference)??null;return this._projectorCache.set(e,i),i}getSphereElevationBounds(e,t){if(!this.enabled||this._rootTiles==null)return null;const i=this._ensureProjector(t);if(i==null)return $.getLogger(this).error("TerrainSurface.getSphereElevationBounds(): could not project given point to tiling scheme coordinate system"),null;vL(e,Qc);const r=_p(Qc,w());i(r,0,r,0),W2(Qc,r);const s=new u_,n=this._rootTiles;if(n!=null){const a=[];for(const l of n)a.push(l);let o=0;for(;o<a.length;){const l=a[o];if(++o,!ex(l.extent,Qc))continue;const c=l.children;if(c[0]==null||l.rendered)s.expandElevationRangeValues(l.elevationBoundsMin,l.elevationBoundsMax);else for(const u of c)a.push(u)}}return s}getRootElevationBounds(){return this.enabled&&this._rootTiles!=null?new u_(this.rootTileElevationBounds.min,this.rootTileElevationBounds.max):null}getLowerBoundRadius(){const e=(this._ellipsoid.radius+this.visibleElevationBounds.min)*T4;return Math.min(e,this._ellipsoid.radius)}getSphereScale(e,t){if(!this.tilingScheme)return null;if(!Ha(e,aT,this.spatialReference))return $.getLogger(this).error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;oM(Qc,aT,t);let i=null;const r=n=>{if(n&&ex(n.extent,Qc)){const a=n.children;if(a[0]&&!n.rendered)for(const o of a)r(o);else{const o=this._getLodBiasCorrectedScale(n.level);i=i==null?o:Math.min(i,o)}}},s=this._rootTiles;if(s!=null)for(const n of s)r(n);return i}queryVisibleScaleRange(e,t,i,r){if(!this._scaleRangeQueries)return;const s=t?this.tilingScheme.levelAtScale(t):0,n=i?this.tilingScheme.levelAtScale(i):1/0,a=this._lodBias;this._scaleRangeQueries.queryVisibleLevelRange(e,s+a,n+a,r)}_evaluateTransparency(){const e=this.baseOpacity,t=this.overlayManager.renderer.isEmpty,i=this._renderer.transparency,r=this._isFullyTransparent?t?3:2:e>=1&&!this.hasCompositeBlendMode&&!this._renderer.slicePlaneEnabled?0:1;return this._renderer.transparency=r,i!==r}_updateTilingScheme(){const{tilingScheme:e}=this.tilingSchemeLogic;if(e===this.tilingScheme)return;Si(!!e,"tiling scheme cannot be reset to undefined"),this._isGlobal=!this.view?.state?.isLocal,this.tilingScheme&&this._removeAllTiles();const t=e?.spatialReference??At.WebMercator;this._spatialReference=t,this._isWebMercator=!!t?.isWebMercator,this._isWebMercatorOnPlateCarree=this._isWebMercator&&P4(this.view?.renderSpatialReference),this._isGeographic=t?.isGeographic??!1,this._set("tilingScheme",e),this._tilingSchemeSpatialReference=this.tilingScheme?.spatialReference,this._projectorCache.clear(),this._updateClippingExtent(),e&&(this._updateTiledLayers(),this._renderer.tileSize=e.pixelSize,this.overlayManager.spatialReference=e.spatialReference,this._updateRootTiles())}static{this._tileMemcacheKey="TerrainTileMemcache"}_acquireTile(e,t,i,r){const s=this._tileCache.pop(mg._tileMemcacheKey);return s?(s.init(e,t,i,r,this),s):new this._tileConstructor(e,t,i,r,this)}get updatingRootTiles(){return this._updatingRootTiles}_updateRootTiles(){const{extent:e,tilingScheme:t}=this;if(!t)return;const i=oZ;let r=t.rootTilesInExtent(e,i,5*Th);if(this._rootTiles!=null){if(r.length>Th)return void $.getLogger(this).warn(z7);const s=this._rootTiles.map(a=>a.lij),n=xv(s,r,ug);if(this._updatingRootTiles=!0,n.removed.length>0||n.added.length>0){const a=this._rootTiles.filter(o=>!(n.removed.findIndex(l=>ug(l,o.lij))>-1)||(this._purgeTile(o),!1));n.added.forEach(o=>a.push(this._newRootTile(o))),this._setRootTiles(a)}}else this._updatingRootTiles=!0,r.length>Th&&($.getLogger(this).warn(k7),r=t.rootTilesInExtent(e,i,Th)),this._setRootTiles(r.map(s=>this._newRootTile(s)));$l(i,this._rootTilesExtent)||(this._rootTilesExtent=Rt(i)),this.renderer.visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready"),this._updateAllTileGeometries(),this._updatingRootTiles=!1,this.checkAllTilesWaterproofness()}_updateAllTileGeometries(){const e=this._allTiles.filter(t=>t.loaded&&t.intersectsClippingArea);e.sort(ta),e.forEach(t=>this._renderer.updateTileGeometryState(t)),e.forEach(t=>t.renderData.updateNeighborData()),this._updateTilesGeometries(e),this._pendingTilesToUpdate.clear()}_updateTilesGeometries(e){if(e.length===0)return;e.sort(ta);const t=this.renderer;e.forEach(i=>t.updateGeometryIfNeeded(i)),e.forEach(i=>this._pendingTilesForElevationUpdateEvent.add(i))}_shouldSplit(e){return e.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.snapLevel)===1}_newRootTile(e){const t=this._acquireTile(0,e[1],e[2],null);return this._shouldSplit(t)&&t.setPendingUpdate(1),this._loadTile(t),this._markTileToUpdate(t),this._updateRootTileElevationBounds(),t}_setRootTiles(e){if(this._rootTiles=e,this._allTiles.clear(),e!=null){const t=this._iteratorPool.acquire();for(t.reset(e);!t.done;)this._allTiles.push(t.next());t.remove()}this._renderer.setRootTiles(this._rootTiles),this._updateTilesVisibility(e),this.notifyChange("demResolution"),this.emit("tiles-changed",{allTiles:this.allTiles})}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}_viewChangeUpdate(){this.view&&!this.suspended&&this.tilingScheme&&this.renderer.visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateTilesVisibility(this._rootTiles)))}_updateClippingStatus(e){e.updateClippingStatus(this.extent)&&e.resetPendingUpdate(8)&&this._updateTileGeometryState(e)}_updateTilesVisibility(e){if(e==null)return;const t=DG(e),i=this.visibleElevationBounds;let r=t?i.min:1/0,s=t?i.max:-1/0;const n=this.extent,a=this.view.state.contentCamera.viewProjectionMatrix;this.setTileTreeDirty();const o=this._iteratorPool.acquire();for(o.reset(e);!o.done;){const l=o.next();l.updateClippingStatus(n)&&l.resetPendingUpdate(8)&&this._updateTileGeometryState(l),l.computeVisibility(),l.updateScreenDepth(a),l.renderData&&(r=Math.min(l.elevationBoundsMin,r),s=Math.max(l.elevationBoundsMax,s))}o.remove(),this._viewChanged=!0,this._allTilesDirty=!0,this._updatePendingTileGeometries(),isFinite(r)&&isFinite(s)&&(i.min!==r||i.max!==s)&&(this.visibleElevationBounds=new Vh(r,s))}_updateRootTileElevationBounds(){let e=1/0,t=-1/0;this._rootTiles?.forEach(({elevationBoundsMin:s,elevationBoundsMax:n})=>{e=Math.min(e,s),t=Math.max(t,n)});const r=this.rootTileElevationBounds;r.min===e&&r.max===t||(this.rootTileElevationBounds=new Vh(e,t))}_updateViewDependentParameters(){const{camera:e,contentCamera:t}=this.view.state,i=Math.tan(.5*t.fovX),r=Math.tan(.5*t.fovY),s=this.tilingScheme.pixelSize,n=2**-this._lodBias*e.pixelRatio;this._splitLimits.aboveGround=e.aboveGround,this._splitLimits.fovX=i,this._splitLimits.fovY=r,this._splitLimits.relativeWidthLimit=s/e.width*this.maxTextureScale*n,this._splitLimits.relativeHeightLimit=s/e.height*this.maxTextureScale*n,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?this._splitLimits.frustum=ZL(this._splitLimits.frustum??QL(),t.frustum):this._splitLimits.frustum=null,q(this._eyePosRenderSR,t.eye),No(e.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}_updateTileGeometryState(e){e.updateVisibility(),this._renderer.updateTileGeometryState(e)&&this._markTileToUpdate(e),this.setMemoryDirty()}_markAllTileNeighborsForUpdate(e){e.forEachLoadedNeighbor(t=>{this._layerViews[1].some(cu)&&t.setPendingUpdate(32),this._pendingTilesToUpdate.add(t)})}_updateTileTexture(e,t){const i=e.resetPendingUpdate(32)?32:!!e.resetPendingUpdate(16)&&16;i&&(this._renderer.updateTileTexture(e,i),this._usedMemory=null,t.madeProgress())}_emitElevationUpdateEventForTiles(){if(!this._shouldEmitChangeEvent)return;const e=G0.extent;zo(e),this._pendingTilesForElevationUpdateEvent.forEach(t=>Nh(e,t.extent,e)),this._pendingTilesForElevationUpdateEvent.clear(),G0.spatialReference=this.spatialReference,this.emit("elevation-change",G0),this._shouldEmitChangeEvent=!1}runTask(e){this._handleLayerViewChanges(e),this._frameTask.processQueue(e),this.renderer.processScaleRangeQueries(this._scaleRangeQueries,e),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateAllTilesStatus(e),this._sortTiles(e);const t=!this.view.state.fixedContentCamera;if(this._mergeAndSplit(e,t),this._updateElevation(e),this._updateTextures(e),t||this._mergeAndSplit(e,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),this._updatePendingTileGeometries(),this._emitElevationUpdateEventForTiles(),e.done&&e.hasProgressed&&this.requestUpdate(),this.notifyChange("updatingProgressValue"),vi&&this._checkTileInvariant(),!e.hasProgressed)return Fi}_checkTileInvariant(){const e=new Map;this._allTiles.forAll(t=>e.set(t,new Set)),this._allTiles.forAll(t=>{if(Si(t.rendered===t.leaf,` rendered ${t.rendered} != ${t.leaf} leaf`),!t.leaf){const i=s=>s.unmergableChildCount===0&&s.maxLevelDeltaNeighborCount===0,r=t.children.reduce((s,n)=>s+(i(n)?0:1),0);if(Si(t.unmergableChildCount===r,` Tile[${t.lij.toString()}] unmergeable child count mismatch: actual ${t.unmergableChildCount} vs ${r}`),t.hasPendingUpdate(4)){Si(!t.hasPendingUpdate(1),"Tile can be both split and merge at the same time");for(const s of t.children)Si(s.leaf||s.hasPendingUpdate(4),"Child of tile to merge must also merge")}}for(let i=0;i<4;++i){if(t.rendered){const a=t.renderData?.geometryState.edgePeerNeighbors[i];if(a!=null){{const o=t.level-a.level<=hi;o||(console.log(`tile level delta [${t.lij.toString()}] vs [${a.lij.toString()}] > ${hi}  (edge[${i}])`),Si(o,`tile level delta [${t.level}] vs [${a.level}] > ${hi}`))}Si(t.level-a.level<=hi,`Max tile lod delta exceeded: [${t.lij.toString()}] vs [${a.lij.toString()}]`)}}const r=t.level-hi,s=a=>a.leaf||a.level===t.level,n=t.findNeighborTile(Cn[i],s);if(n!=null){if(t.leaf&&t.level>=hi){let a=n;for(;t.level-a.level<hi;)a=a.parent;const o=[r,t.lij[1]>>hi,t.lij[2]>>hi];if(!ug(o,a.lij)){const l=e.get(a);Si(!l.has(t),"Cannot already have neighbor"),l.add(t)}}Si(n.rendered||n.level===t.level,"Non-same-level-neighbor of rendered must be rendered"),Si(t.level-n.level<=hi,`Tile level delta [${t.level}] vs [${n.level}] > ${hi}`)}}}),this._allTiles.forAll(t=>{const i=t.maxLevelDeltaNeighborCount,r=e.get(t);Si(i===r.size,`Tile[${t.lij.toString()}] merge-blocker mismatch: actual ${i} vs ${r.size}`)})}_updateAllTilesStatus(e){if(!this._viewChanged||!this._rootTiles||e.done)return;this._viewChanged=!1;const t=new y$(this._allTiles.length);t.pushAll(this._rootTiles);const i=this.snapLevel,r=this._splitLimits,s=this._eyePosRenderSR;this._allTiles.forAll(a=>{a.maxLevelDeltaNeighborCount=0,a.unmergableChildCount=0});const n=this.view.state.contentCamera.viewProjectionMatrix;for(;!t.empty;){const a=t.pop(),o=a.parent,l=o?.hasPendingUpdate(4),c=l?4:a.shouldSplit(r,s,i),u=c===1;a.leaf?$0(a,u):t.pushAll(a.children),l?(a.resetPendingUpdate(1),a.leaf||a.setPendingUpdate(4),this._updateClippingStatus(a),a.updateVisibility(),a.updateScreenDepth(n)):u?(a.resetPendingUpdate(4),a.leaf&&a.setPendingUpdate(1)):(a.resetPendingUpdate(1)&&a.updateAgentSuspension(),c===2&&a.updateAgents(0),a.leaf||(a.setPendingUpdate(4),a.resetPendingUpdate(1)))}this.requestUpdate(),(this._shortBatches||!this._oneBatchPerFrameTask)&&this._updatePendingTileGeometries(),e.madeProgress()}_sortTiles(e){e.done||this._allTilesSorted||!this.view.pointsOfInterest?.focus||(MG(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger?.update(),e.madeProgress())}_markTileToUpdate(e){N(e.loaded),e.intersectsClippingArea&&(this._pendingTilesToUpdate.add(e),this._markAllTileNeighborsForUpdate(e))}_updatePendingTileGeometries(){const e=this._pendingTilesToUpdate,t=Array.from(e.keys()).filter(s=>s.loaded&&s.intersectsClippingArea);if(t.length===0)return void e.clear();const i=(s,n)=>{!n?.loaded||!n.intersectsClippingArea||n.level<s.level||e.has(n)||(e.add(n),t.push(n),n.renderData.updateNeighborData())};t.sort(ta);const r=t.length;for(let s=0;s<r;++s){const n=t[s];N(n.loaded),N(n.intersectsClippingArea);const a=n.renderData;a.updateNeighborData();const o=a.dirtyEdgeResolutions,l=a.geometryState,c=u=>{const p=g_[u];i(n,l.cornerPeerNeighbors[u]?.findCorner(f_(p),m=>m.loaded))};for(let u=0;u<4;++u)if(o&1<<u){const p=a.geometryState.edgePeerNeighbors[u];p&&p?.level>=n.level&&p.forAllSubtreeOnSide(kb(Cn[u]),m=>!(!m.loaded||!m.intersectsClippingArea)&&(N(e.has(m)||ta(n,m)<0),i(n,m),!0)),c((u+1)%4),c(u)}}e.clear(),this._updateTilesGeometries(t),this._shouldEmitChangeEvent=!0,vi&&p_&&this.checkAllTilesWaterproofness()}_mergeAndSplit(e,t){if(this.suspended||e.done||!this._allTilesDirty)return;this._allTilesDirty=!1,this.requestUpdate();let i=!1;const r=this.view.state.fixedContentCamera;let s=!1;for(;!e.done;){s=!0;let n=!1;const a=!this._allTiles.some(o=>{if(!i&&!r&&!o.visible)return e.done;let l=o;if(o.hasPendingUpdate(4)){if(!t||o.unmergableChildCount>0)return e.done;for(o.resetPendingUpdate(4);l.parent!=null&&l.parent.unmergableChildCount===0&&l.parent.resetPendingUpdate(4);)l=l.parent;this._mergeTile(l),n=!0,e.madeProgress()}else if(o.resetPendingUpdate(1)){let c=!0;const u=o.level;if(u>=hi){const p=m=>m.leaf||u-m.level<hi;for(let m=0;m<4;++m){const f=o.findNeighborTile(Cn[m],p);f!=null&&u-f.level===hi&&(c=!1,vi&&(N(f.leaf),N(f.hasPendingUpdate(1))))}}c?(this._splitTile(o),e.madeProgress(),n=!0):o.setPendingUpdate(1)}return e.done});if(n&&(this._allTilesSorted=!1,this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries()),a){if(!i){i=!0;continue}if(!n)break}else this._allTilesDirty=!0}s?e.madeProgress():this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries(),this._sortTiles(e)}_updateElevation(e){e.done||(this._allTiles.some(t=>(t.resetPendingUpdate(8)&&(this._updateTileGeometryState(t),this._shortBatches&&this._updatePendingTileGeometries(),e.madeProgress()),e.done)),!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries())}_updateTextures(e){e.done||this._allTiles.some(t=>(this._updateTileTexture(t,e),e.done))}_updateClippingExtent(){this.spatialReference&&(this.updateOverlayParameters(),this.requestRender(1),this.overlayManager.setPlacementDirty(),this._updateRootTiles())}get _lodBias(){const e=this.view.quality;return this.view.qualitySettings.tiledSurface.lodBias-(1-e)*F7}_getLodBiasCorrectedScale(e){const t=this.tilingScheme.levels,i=j(e-this._lodBias,0,t.length-1),r=i-Math.floor(i);return t[Math.floor(i)].scale*(1-r)+t[Math.ceil(i)].scale*r}_removeAllTiles(){this._rootTiles!=null&&(this._rootTiles.forEach(e=>this._purgeTile(e)),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.notifyChange("demResolution"),this.emit("tiles-changed",{allTiles:this.allTiles}),this.renderer.visible=!1}_purgeSubtree(e){const t=e.children;t[0]&&(this._purgeTile(t[0]),this._purgeTile(t[1]),this._purgeTile(t[2]),this._purgeTile(t[3]),e.clearChildren())}_purgeTile(e){e.leaf?nT(e):this._purgeSubtree(e),this._allTiles.removeUnordered(e),this._unloadTile(e),e.dispose(),this._tileCache.put(mg._tileMemcacheKey,e),this.notifyChange("demResolution"),this.emit("tiles-changed",{allTiles:this.allTiles})}_unloadTile(e){this._pendingTilesToUpdate.delete(e),this._pendingTilesForElevationUpdateEvent.delete(e),e.unload()}_splitTile(e){Si(e.leaf,"Tile that is already split should not be split again!"),Si(e.rendered,"Tile marked to split is not rendered"),nT(e);const t=e.createChildren();this._allTiles.pushArray(t),this.notifyChange("demResolution"),this.emit("tiles-changed",{allTiles:this.allTiles}),e.updateAgentSuspension(),Si(e.rendered,"parent should be rendered"),t.forEach(i=>this._loadTile(i)),t.forEach(i=>this._pendingTilesToUpdate.add(i)),this._unloadTile(e),this._markAllTileNeighborsForUpdate(e),this._emitTileScaleChange(e,e.level+1),this._allTilesDirty=!0,this._shortBatches&&this._updatePendingTileGeometries(),t.forEach(i=>$0(i,i.hasPendingUpdate(1))),++this._performanceInfo.numSplit}_emitTileScaleChange(e,t=e.level){hf.spatialReference=this.spatialReference,hf.extent=e.extent,hf.scale=this._getLodBiasCorrectedScale(t),this.emit("scale-change",hf)}createTile(e,t,i,r){Si(!!r,"createTile sanity check");const s=this._acquireTile(e,t,i,r);return s.updateClippingStatus(this.extent),s.updateScreenDepth(this.view.state.contentCamera.viewProjectionMatrix),this._shouldSplit(s)&&s.setPendingUpdate(1),s}get _shortBatches(){return this.view.state.mode!==2}_mergeTile(e){Si(!e.hasPendingUpdate(1),"_mergeTile sanity check"),Si(!e.leaf,"Cannot merge a leaf"),e.leaf||(this._purgeSubtree(e),Si(!e.renderData,"Merging tile with existing render data?"),this._loadTile(e),this._markTileToUpdate(e),this._emitTileScaleChange(e),this._shortBatches&&this._updatePendingTileGeometries(),$0(e,!1),this._allTilesDirty=!0,++this._performanceInfo.numMerged)}_loadTile(e){e.load(),this.requestUpdate(),this._allTilesDirty=!0,this.overlayManager?.hasOverlays&&e.updateOverlayParameters(this.overlayManager)}_handleLayerViewChanges(e=bn){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let t=!1;const i=new Set;let r=-1;for(let s=this.view.allLayerViews.length-1;s>=0;s--){const n=this.view.allLayerViews.items[s];if(i.add(n.uid),N1(n)||qu(n))if(this._basemapLayerViewHandles.has(n.uid)&&!qu(n)){const a=this._layerClassFromLayerView(n),o=this.getLayerIndexByUID(a,n.uid);o!=null&&((o<r||r==null)&&(t=!0),r=o)}else this._registerTiledLayerView(n),n.layer.loaded&&(t=!0)}this._basemapLayerViewHandles.forEach((s,n)=>{i.has(n)||(this._unregisterTiledLayerView(n),t=!0)}),t&&this._updateTiledLayers(),this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._evaluateTransparency(),e.madeProgress()}get _isFullyTransparent(){if(this.view.map?.ground?.opacity>0)return!1;for(const e of this.view.allLayerViews.items)if(B1(e)&&!Tf(e.layer)&&e.fullOpacity!==0)return!1;return!0}_hasCompositeBlendMode(){for(const e of this.view.allLayerViews.items)if((Op(e)||qu(e))&&yW(X1[e.layer.blendMode]))return!0;return!1}_layerClassFromLayerView(e){return k1(e)?0:1}_registerTiledLayerView(e){const t=[];if((Op(e)||qu(e))&&t.push(M(()=>e.layer.blendMode,()=>{this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._updateTileTextures(2)})),!qu(e)){const i=this._layerClassFromLayerView(e);t.push(M(()=>!e.destroyed&&e.suspended,()=>this._updateTiledLayers())),t.push(M(()=>!e.destroyed&&e.fullOpacity,()=>this._updateTileTextures(2)));const{layer:r}=e;"effectiveScaleRange"in r&&t.push(M(()=>!e.destroyed&&r.effectiveScaleRange,()=>this._restartAllAgents(i))),t.push(e.on("data-changed",()=>{const s=this.getLayerIndexByUID(i,e.uid);s!=null&&this._invalidateLayerData(s,i)}))}this._unregisterTiledLayerView(e.uid),this._basemapLayerViewHandles.set(e.uid,t)}_unregisterTiledLayerView(e){const t=this._basemapLayerViewHandles.get(e);if(t){for(const i of t)i.remove();this._basemapLayerViewHandles.delete(e)}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;const e=this.view.allLayerViews,t=[[],[]];let i=null;e.forEach(r=>{if(!r.layer||r.suspended||!N1(r)||!r.fullExtent)return;const s=this._layerClassFromLayerView(r);if(s===1){const n=r.displayLevelRange.maxLevel;n!==1/0&&(i===null||n>i)&&(i=n)}t[s].push(r)});for(const r of gh){const s=this._layerViews[r],n=t[r];n.reverse();const a=n.length;let o=s.length!==a;const l=new Array(a),c=new Array(s.length);this._layerIndexByUid[r].clear();for(let u=0;u<a;u++){const p=n[u].uid;this._layerIndexByUid[r].set(p,u);const m=s.indexOf(n[u]);l[u]=m,u!==m&&(o=!0),m>-1&&(c[m]=u)}if(o){const u=this._postorderIterator;for(u.reset(this._rootTiles);!u.done;)u.next().modifyLayers(c,l,r);this._layerViews[r]=n,this._restartAllAgents(r),this._updateTilesVisibility(this._rootTiles)}}this.tilingScheme.ensureMaxLod(i)&&(this._viewChangeUpdate(),this.notifyChange("tilingScheme"))}_restartAllAgents(e){const t=this._postorderIterator;for(t.reset(this._rootTiles);!t.done;){const i=t.next();i.restartAgents(e),e===0&&i.computeElevationBounds()}this._updateRootTileElevationBounds()}layerViewByIndex(e,t){return this._layerViews[t][e]}numLayers(e){return this._layerViews[e].length}_updateTileTextures(e){this._allTiles.forAll(t=>{t.updateAgents(1),e===1?this.renderer.updateTileTexture(t,16):t.updateRenderData(1,e)}),this._evaluateTransparency()}_invalidateLayerData(e,t){this._allTiles.forAll(i=>i.removeLayerAgent(e,t)),this._allTiles.forAll(i=>i.invalidateLayerData(e,t))}setTileTreeDirty(){this._allTilesDirty=!0}requestRender(e=1){this.renderer.setNeedsRender(e)}requestUpdate(){++this._pendingUpdates===1&&(this._hasPendingUpdates=!0)}requestTileData(e,t,i,r){const s=this.layerViewByIndex(t,i),n=s.layer;return!n.tilemapCache||cu(s)?this._requestTileData(e,i,s,r):(++this._asyncWorkItems,n.tilemapCache.fetchAvailability(e.level,e.lij[1],e.lij[2],{...r,timeout:6e3}).then(()=>--this._asyncWorkItems).catch(a=>{throw--this._asyncWorkItems,qe(r),js(a)||this._dataMissing(e,i,s),a}).then(()=>this._frameTask.schedule(()=>this._requestTileData(e,i,s,r),r.signal)))}_requestTileData(e,t,i,r){if(this.destroying)return Promise.resolve();const s=t===0;return r.requester??=s?this._elevationDataRequester:this._mapDataRequester,s?k1(i)?this._requestElevationTileData(e,i,r):Promise.reject():B1(i)?this._requestMapTileData(e,i,r):Promise.reject()}_requestElevationTileData(e,t,i){++this._asyncWorkItems;const r=n=>{!Gl(i)&&n&&(this.setMemoryDirty(),this.requestUpdate(),this._elevationDataArrived(e,t,n))},s=n=>{js(n)||($.getLogger(this).error(`Tile ${e.lij.toString()} layer 0/${t.uid} error ${n}`),this._dataMissing(e,0,t),this.requestUpdate())};return t.fetchElevationTile(e,i).then(n=>this._frameTask.schedule(()=>r(n)),s).finally(()=>--this._asyncWorkItems)}_elevationDataArrived(e,t,i){const r=this._layerIndexByUid[0].get(t.uid);if(r==null)return void $.getLogger(this).warn("TerrainSurface: received data from unknown layer %d %s",0,e.lij.toString());const s=new gH(e.lij,e.extent,i);e.dataArrived(r,0,s),this.emit("tile-data-changed",{tile:e,layerIndex:r,layerClass:0});const n=[e],a=e.level,o=this._iteratorPool.acquire();for(o.reset(n);!o.done;){const l=o.next();l.findElevationBoundsForLayer(r,a),l.computeElevationBounds()}a===0&&this._updateRootTileElevationBounds(),o.remove(),this._updateTilesVisibility(n)}_requestMapTileData(e,t,i){++this._asyncWorkItems;const r=(o,l)=>{Gh(l),Gl(i)||(console.error(`Tile ${e.lij.toString()} layer 1/${t.uid} error ${o}`),this._dataMissing(e,1,t),this.requestUpdate())},s=o=>l=>r(l,o),n=o=>this._frameTask.schedule(()=>{this.requestUpdate(),Gl(i)?Gh(o):this._mapTileDataArrived(e,t,o)},i.signal,s(o)).catch(s(o)),a=(o,l=null)=>this._frameTask.schedule(()=>r(o,l));return t.fetchTile(e.lij,i).then(n,a).finally(()=>--this._asyncWorkItems)}_mapTileDataArrived(e,t,i){const r=this.getLayerIndexByUID(1,t.uid);if(r==null)return Gh(i),void $.getLogger(this).warn("TerrainSurface: received data from unknown layer");e.dataArrived(r,1,i),this.emit("tile-data-changed",{tile:e,layerIndex:r,layerClass:1})}_dataMissing(e,t,i){const r=this.getLayerIndexByUID(t,i.uid);r!=null?(e.dataMissing(r,t),this.emit("tile-data-changed",{tile:e,layerIndex:r,layerClass:t})):$.getLogger(this).warn("TerrainSurface: received data from unknown layer")}get performanceInfo(){const e=this._performanceInfo;return e.numNodes=this._allTiles.length,e.numLeaves=e.numVisible=e.numRendered=e.numLoadedPerLevel.length=e.numRenderedPerLevel.length=0,this._allTiles.forAll(t=>{t.leaf&&e.numLeaves++;const i=t.level;t.renderData&&(e.numLoadedPerLevel[i]=(e.numLoadedPerLevel[i]||0)+1),t.visible&&(e.numVisible++,t.rendered&&(e.numRenderedPerLevel[i]=(e.numRenderedPerLevel[i]||0)+1,e.numRendered++))}),e}setMemoryDirty(){this._usedMemory=null}get usedMemory(){return this.tilingScheme?(this._usedMemory==null&&(this._usedMemory=this._recalculateUsedMemory()),this._usedMemory??0):0}_recalculateUsedMemory(){return this.tilingScheme?Math.round(this._allTiles.reduce((e,t)=>e+t.usedMemory,0)):null}getUsedMemoryForLayerView(e){let t=0;const i=this._layerClassFromLayerView(e),r=this.getLayerIndexByUID(i,e.uid);return r!=null&&this._allTiles.forAll(s=>t+=s.getUsedMemoryForLayer(i,r)),t}get renderPatchBorders(){return this._renderer.renderPatchBorders}set renderPatchBorders(e){this._renderer.renderPatchBorders=e}get visualizeNormals(){return this._renderer.visualizeNormals}set visualizeNormals(e){this._renderer.visualizeNormals=e}get renderingDisabled(){return this._renderer.renderingDisabled}set renderingDisabled(e){this._renderer.renderingDisabled=e}get test(){}checkAllTilesWaterproofness(){if(!p_)return;const e=this._rootTiles;if(e==null)return;const t=n=>n?.renderData?.geometry?.indices?.length>0,i=(n,a)=>{t(n)&&console.error("Tile[",n.lij,"] has geometry although parent[",a.lij,"] has geom")},r=n=>{if(n.intersectsClippingArea)if(n.renderData&&!n.renderData.geometryState&&console.error("Tile[",n.lij,"] has renderData but not geometryState"),n.renderData&&!n.renderData.geometry&&console.error("Tile[",n.lij,"] has renderData but not geometryInfo"),!n.renderData?.geometry||(n.renderData.geometry.indices?.length??0)>0||console.error("Tile[",n.lij,"] has renderData but no indices - geometryInfo: ",n.renderData.geometry),t(n)){n.checkGeometryWaterproofness();for(const a of n.children)i(a,n)}else if(n.leaf)console.error("Tile[",n.lij,"] has no geometry and no children, from root to leaf");else for(const a of n.children)r(a)},s=n=>{const a=n.parent?.visible??!0,o=n.visible;n.computeVisibility();const l=n.visible;if(o!==l&&a&&console.error(" Tile[",n.lij,"] has out of date visibility: ",o," instead of ",l),!n.leaf)for(const c of n.children)s(c)};for(const n of e)r(n),s(n)}get isGlobal(){return this._isGlobal}get isGeographic(){return this._isGeographic}get isWebMercator(){return this._isWebMercator}get isWebMercatorOnPlateCarree(){return this._isWebMercatorOnPlateCarree}isEastEndWrap(e){return this._isGlobal&&e[2]===this.lijEastEnd(e[0])-1}isWestEndWrap(e){return this._isGlobal&&e[2]===0}lijEastEnd(e){return 1<<e+(this._isGeographic?1:0)}wrapEastWest(e){const t=this.lijEastEnd(e[0]),i=e[2];if(0<=i&&i<t)return e;if(!this._isGlobal)return null;const r=(i+(i<0?t:0))%t;return[e[0],e[1],r]}enableInternalChecks(e){TH(e)}enableWaterproofnessChecks(e){SH(e)}static cleanupTerrainSurface(){lZ.prune()}enable(e){e!==this.enabled&&(e?(this._updateRootTiles(),this.suspended=!1):(this.suspended=!0,this._removeAllTiles(),this._setRootTiles(null)),this._set("enabled",e),this.notifyChange("ready"))}updateOverlayParameters(){const{overlayManager:e}=this;this.allTiles.forAll(t=>t.updateOverlayParameters(e))}};h([d()],Se.prototype,"_renderer",void 0),h([d({constructOnly:!0})],Se.prototype,"_scaleRangeQueries",void 0),h([d({constructOnly:!0})],Se.prototype,"view",void 0),h([d({constructOnly:!0})],Se.prototype,"overlayManager",void 0),h([d({constructOnly:!0})],Se.prototype,"terrainTextureCompressionTracker",void 0),h([d()],Se.prototype,"_hasPendingUpdates",void 0),h([d()],Se.prototype,"_asyncWorkItems",void 0),h([d()],Se.prototype,"_allTilesDirty",void 0),h([d()],Se.prototype,"_allTilesSorted",void 0),h([d()],Se.prototype,"_viewChanged",void 0),h([d({type:Number})],Se.prototype,"heading",void 0),h([d()],Se.prototype,"_splitLimits",void 0),h([d({readOnly:!0})],Se.prototype,"_watchUpdatingTracking",void 0),h([d()],Se.prototype,"_frameTask",void 0),h([d()],Se.prototype,"demResolution",null),h([d({readOnly:!0})],Se.prototype,"snapLevel",null),h([d({readOnly:!0})],Se.prototype,"lodSnappingEnabled",null),h([d()],Se.prototype,"_userClippingExtent",null),h([d()],Se.prototype,"_rootTilesExtent",void 0),h([d({readOnly:!0})],Se.prototype,"extent",null),h([d({readOnly:!0})],Se.prototype,"groundExtent",null),h([d({readOnly:!0})],Se.prototype,"_tilingSchemeExtent",null),h([d({readOnly:!0})],Se.prototype,"updating",null),h([d({readOnly:!0})],Se.prototype,"readyToRun",null),h([d(fH)],Se.prototype,"updatingProgress",void 0),h([d({readOnly:!0})],Se.prototype,"updatingProgressValue",null),h([d()],Se.prototype,"_maxNumUpdating",void 0),h([d()],Se.prototype,"baseOpacity",null),h([d()],Se.prototype,"hasCompositeBlendMode",void 0),h([d({readOnly:!0})],Se.prototype,"viewingMode",null),h([d()],Se.prototype,"maxTextureScale",void 0),h([d({readOnly:!0})],Se.prototype,"ready",null),h([d({readOnly:!0})],Se.prototype,"rootTiles",null),h([d()],Se.prototype,"_rootTiles",void 0),h([d({readOnly:!0})],Se.prototype,"spatialReference",null),h([d({type:wi})],Se.prototype,"backgroundColor",null),h([d({value:!1})],Se.prototype,"slicePlaneEnabled",null),h([d({readOnly:!0})],Se.prototype,"tilingScheme",void 0),h([d({readOnly:!0})],Se.prototype,"tilingSchemeLocked",null),h([d({readOnly:!0})],Se.prototype,"tilingSchemeLogic",void 0),h([d()],Se.prototype,"wireframe",null),h([d({value:!1})],Se.prototype,"suspended",null),h([d()],Se.prototype,"fadeDuration",null),h([d()],Se.prototype,"_xNormalizer",null),h([d()],Se.prototype,"visibleElevationBounds",void 0),h([d()],Se.prototype,"rootTileElevationBounds",void 0),h([d()],Se.prototype,"_layerViewsDirty",void 0),h([d()],Se.prototype,"renderPatchBorders",null),h([d()],Se.prototype,"visualizeNormals",null),h([d()],Se.prototype,"renderingDisabled",null),h([d({readOnly:!0})],Se.prototype,"enabled",void 0),Se=mg=h([D("esri.views.3d.terrain.TerrainSurface")],Se);const rT=Se,Qu=w(),Qc=Kr(),oZ=Rt(),lZ=new jt,G0=new YD("ground"),hf={spatialReference:null,extent:null,scale:0};function sT(e,t,i){for(const r of e){if(!r.containsPointXY(t,i))continue;let s=r;for(;s&&!s.renderData;){const a=(t>s.extentMidX?1:0)+(i<s.extentMidY?2:0);s=s.children[a]}const n=s?.renderData?.geometryState.samplerData??null;return zt(t,i,n)}return null}function $0(e,t){!e.leaf||e.level<hi||lw(e,i=>{t&&PE(i);const r=K1(i);if(i.maxLevelDeltaNeighborCount++,r){let s=i.parent;for(;s;){const n=K1(s);if(s.unmergableChildCount++,!n)break;s=s.parent}}})}function PE(e){if(e.hasPendingUpdate(1))return;let t=e.parent;for(;t?.resetPendingUpdate(4);)t=t.parent;e.resetPendingUpdate(4),e.leaf&&e.setPendingUpdate(1),e.level<hi||lw(e,i=>{PE(i)})}function nT(e){e.level<hi||lw(e,t=>{if(t.maxLevelDeltaNeighborCount--,t.maxLevelDeltaNeighborCount===0&&t.unmergableChildCount===0){let i=t.parent;for(;i&&(i.unmergableChildCount--,K1(i));)i=i.parent}})}function K1(e){return e.maxLevelDeltaNeighborCount===0&&e.unmergableChildCount===0}function lw(e,t){if(e.level<hi)return;const i=e.level-hi,r=e.lij[1]>>hi,s=e.lij[2]>>hi,n=a=>a.leaf||a.level===i;for(let a=0;a<4;++a){const o=e.findNeighborTile(Cn[a],n);if(!o||o.level!==i)continue;const l=o.lij;l[1]===r&&l[2]===s||t(o)}}const aT=w();let cZ=class{constructor(e,t,i,r){this.operation=e,this.geometry=t,this.states=i,this.sync=r}},Od=class extends ie{constructor(e){super(e),this._residentGeomRecords=new $a,this._dirtyGeomRecords=new $a,this._dirtyRecordCount=0}get dirty(){return this._dirtyRecordCount>0}commitLayer(e,t){const i=this._dirtyGeomRecords.getInner(e),r=this.model.getLayer(e);if(!i||!r)return;let s=0;i.forEach((n,a)=>{const o=this._ensureGeomRecord(e,a);this._dirtyGeomRecords.delete(e,a),s+=n.size,n.forEach(({geometry:l,operation:c,states:u},p)=>{let m=!1;if(c===1){const f=o.get(p);if(f){if(4&u){const g=r.getObject(a);this.model.updateRenderGeometryTransformation(g,l,f)&&(m=!0)}m||t.updates.push({renderGeometry:f,updateType:u})}else Qt(!1,"ModelDirtySet.commitLayer: invalid update")}if(c===2||m){const f=o.get(p);f?(t.removes.push(f),o.delete(p)):c===2&&Qt(!1,"ModelDirtySet.commitLayer: invalid remove")}if(c===0||m){const f=r.getObject(a);if(f!=null){const g=this.model.getRenderGeometry(f,l);t.adds.push(g),o.set(p,g)}}}),o.size===0&&this._residentGeomRecords.delete(e,a)}),this._dirtyRecordCount-=s}commitSyncUpdates(e,t){const i=this._dirtyGeomRecords.getInner(e),r=this.model.getLayer(e);i&&r&&i.forEach((s,n)=>{const a=this._ensureGeomRecord(e,n);s.forEach(({geometry:o,operation:l,states:c,sync:u},p)=>{let m=!1;if(l===1&&u){const f=a.get(p);if(f){if(4&c){const g=r.getObject(n);this.model.updateRenderGeometryTransformation(g,o,f)&&(m=!0)}m||t.updates.push({renderGeometry:f,updateType:c})}else Qt(!1,"ModelDirtySet.commitSyncUpdates: invalid update")}})})}_objectStateChanged(e,t){for(const i of t.geometries)this._updateOrCreateDirtyRecord(t,i,1,e)}visibilityChanged(e){this._objectStateChanged(1,e)}highlightChanged(e){this._objectStateChanged(8,e)}occlusionChanged(e){this._objectStateChanged(16,e)}attributesChanged({object:e,geometry:t,sync:i}){this._updateOrCreateDirtyRecord(e,t,1,2,i)}layerAdded(e){e.objects.forEach(t=>this.layerObjectAdded(t))}layerRemoved(e){e.objects.forEach(t=>this.layerObjectRemoved(t))}layerObjectAdded(e){for(const t of e.geometries)this._geometryAdded(e,t)}layerObjectRemoved(e){for(const t of e.geometries)this._geometryRemoved(e,t)}layerObjectsAdded(e){for(const t of e)this.layerObjectAdded(t)}layerObjectsRemoved(e){for(const t of e)this.layerObjectRemoved(t)}transformationChanged(e){const t=this._getLayerId(e),i=e.id;this._ensureGeomRecord(t,i).forEach(({geometry:r})=>this._updateOrCreateDirtyRecord(e,r,1,4))}shaderTransformationChanged(e){const t=this._getLayerId(e),i=e.id;this._ensureGeomRecord(t,i).forEach(r=>r.objectShaderTransformationChanged(e.shaderTransformation))}geometryAdded(e){this._geometryAdded(e.object,e.geometry)}_geometryAdded(e,t){this._updateOrCreateDirtyRecord(e,t,0)}geometryRemoved(e){this._geometryRemoved(e.object,e.geometry)}_geometryRemoved(e,t){this._updateOrCreateDirtyRecord(e,t,2)}_updateOrCreateDirtyRecord(e,t,i,r=0,s=!1){const n=this._getLayerId(e),a=e.id,o=t.id,l=this._ensureDirtyRecord(n,a),c=l.get(o);if(c){const u=c.operation;u===2&&i===0&&c.states!==0?c.operation=1:u===2&&i===0||u===0&&i===2?(l.delete(o),this._dirtyRecordCount--):u!==1||i!==2&&i!==1?(Qt((u===2||u===0)&&i===1,"ModelDirtySet.objectGeometryAdded: inconsistent state"),c.states|=r):(c.operation=i,c.states|=r),c.sync=c.sync||s}else l.set(o,new cZ(i,t,r,s)),this._dirtyRecordCount++}_ensureGeomRecord(e,t){let i=this._residentGeomRecords.get(e,t);return i||(i=new Map,this._residentGeomRecords.set(e,t,i)),i}assertLayerClean(e){Qt(this._dirtyGeomRecords.getInner(e)==null,"Dirty geometry records for removed layer")}_ensureDirtyRecord(e,t){const i=this.model.getLayer(e);Qt(i!=null,"Updating geometry record for an unregistered layer");let r=this._dirtyGeomRecords.get(e,t);return r||(r=new Map,this._dirtyGeomRecords.set(e,t,r)),r}_getLayerId(e){return e.layer?.id??qd}formatDebugInfo(){const e=["ADD","UPD",void 0,"REM"];let t="";return this._dirtyGeomRecords.forAll((i,r,s)=>{t.length>0&&(t+=`
`),t+=r+"."+s;const n=[];i.forEach(a=>{const o=a.operation;n[o]||(n[o]=[]),n[o].push(a.geometry.id)});for(let a=0;a<n.length;a++)if(n[a]){t+=" "+e[a-1]+": ";for(let o=0;o<n[a].length;o++)t+=n[a][o]+", "}}),t}get test(){}};h([d({constructOnly:!0})],Od.prototype,"model",void 0),h([d()],Od.prototype,"_dirtyRecordCount",void 0),Od=h([D("esri.views.3d.webgl-engine.lib.ModelDirtySet")],Od);const hZ=Od;let uZ=class{constructor(e,t={}){this.geometry=e,this.screenToWorldRatio=1,this._transformation=Le(),this._shaderTransformation=null,this._boundingSphere=null,this.id=uu(),this.layerViewUid=t.layerViewUid,this.graphicUid=t.graphicUid,this.castShadow=t.castShadow??!1,t.objectShaderTransformation&&this.objectShaderTransformationChanged(t.objectShaderTransformation)}get transformation(){return this._transformation}set transformation(e){ks(this._transformation,e),this._boundingSphere=null}get boundingInfo(){return this.geometry.boundingInfo}objectShaderTransformationChanged(e){e==null?this._shaderTransformation=null:(this._shaderTransformation??=Le(),lr(this._shaderTransformation,e,this.geometry.transformation)),this._boundingSphere=null}get boundingSphere(){return this.boundingInfo?(this._boundingSphere==null&&(this._boundingSphere??=Kr(),gp(this._boundingSphere,this.boundingInfo.center,this.shaderTransformation),this._boundingSphere[3]=this.boundingInfo.radius*hp(this.shaderTransformation)),this._boundingSphere):yL}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){return this._shaderTransformation??this.transformation}get attributes(){return this.geometry.attributes}get positionAttribute(){return this.geometry.positionAttribute}foreachHighlightOptions(e){this.geometry.foreachHighlightOptions(e)}get hasHighlights(){return this.geometry.hasHighlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(e){this.geometry.visible=e}},fg=class extends ie{constructor(){super(...arguments),this.dirtySet=new hZ({model:this}),this._originFactory=new MO(null),this._textures=new Map,this._layers=new Map}hasTexture(e){return this._textures.has(e.id)}getTexture(e){return e==null?null:this._textures.get(e)}addTexture(e){const t=e.id;Qt(!this._textures.has(t),"Model/Stage already contains texture to be added"),this._textures.set(t,e)}removeTexture(e){return this._textures.delete(e.id)}addTextures(e){for(const t of e)t&&(Qt(!this._textures.has(t.id),"Model/Stage already contains object to be added"),this._textures.set(t.id,t))}removeTextures(e){for(const t of e)t&&(Qt(this._textures.has(t.id),"Model/Stage doesn't contain object to be removed"),this._textures.delete(t.id))}forEachTexture(e){this._textures.forEach(t=>e(t))}hasLayer(e){return this._layers.has(e.id)}getLayer(e){return e==null?null:this._layers.get(e)}addLayer(e){const t=e.id;Qt(!this._layers.has(t),"Model/Stage already contains layer to be added"),this._layers.set(t,e)}removeLayer(e){return this._layers.delete(e.id)}getRenderGeometry(e,t){const i=new uZ(t,{castShadow:e.castShadow,objectShaderTransformation:e.shaderTransformation}),r=t.localOrigin;return i.transformation=e.getCombinedStaticTransformation(t,oT),i.localOrigin=r??this._originFactory.getOrigin(Gi(i.boundingSphere)),i}updateRenderGeometryTransformation(e,t,i){if(e==null)return!1;i.transformation=e.getCombinedStaticTransformation(t,oT);const r=this._originFactory.getOrigin(Gi(i.boundingSphere));return i.localOrigin!==r}get test(){}};h([d({constructOnly:!0})],fg.prototype,"dirtySet",void 0),fg=h([D("esri.views.3d.webgl-engine.parts.Model")],fg);const oT=Le();let ME=class extends Kt{constructor(){super(...arguments),this.radii=ze(),this.heightParameters=Vt()}};function dZ(e){e.uniforms.add(new qs("radii",t=>t.radii),new $r("heightParameters",t=>t.heightParameters)),e.constants.add("scaleHeight","float",Li.scaleHeight*Li.atmosphereHeight),e.code.add(_`float chapmanApproximation(float thickness, float height, float cosZenith) {
float c = sqrt(thickness + height);
float cExpH = c * exp(-height);
if (cosZenith >= 0.0) {
return cExpH / (c * cosZenith + 1.0);
} else {
float x0 = sqrt(1.0 - cosZenith * cosZenith) * (thickness + height);
float c0 = sqrt(x0);
return 2.0 * c0 * exp(thickness - x0) - cExpH / (1.0 - c * cosZenith);
}
}`),e.code.add(_`float getOpticalDepth(vec3 position, vec3 dir, float h) {
return scaleHeight * chapmanApproximation(radii[0] / scaleHeight, h, dot(normalize(position), dir));
}`),e.code.add(_`vec4 planetIntersect(vec3 cameraPos, vec3 rayDir) {
float reducedPlanetRadius = radii[0] - 20000.0;
float rayPlanetDistance = heightParameters[1] - reducedPlanetRadius * reducedPlanetRadius;
vec2 rayPlanetIntersect = sphereIntersect(cameraPos, rayDir, rayPlanetDistance);
vec2 rayAtmosphereIntersect = sphereIntersect(cameraPos, rayDir, heightParameters[2]);
bool hitsAtmosphere = (rayAtmosphereIntersect.x <= rayAtmosphereIntersect.y) && rayAtmosphereIntersect.x > 0.0;
bool insideAtmosphere = heightParameters[0] < radii[1];
if (!(hitsAtmosphere || insideAtmosphere)) {
return vec4(1.0, 0.0, 0.0, 0.0);
}
bool hitsPlanet = (rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.x > 0.0;
float start = insideAtmosphere ? 0.0 : rayAtmosphereIntersect.x;
if (heightParameters[0] < reducedPlanetRadius) {
if (dot(rayDir, normalize(cameraPos)) < -0.025) {
return vec4(1.0, 0.0, 0.0, 0.0);
}
start = rayPlanetIntersect.y;
}
float end = hitsPlanet ? rayPlanetIntersect.x : rayAtmosphereIntersect.y;
return vec4(0.0, hitsPlanet ? 1.0 : 0.0, start, end);
}`)}function RE(e,t){e.include(dZ);const i=6;e.uniforms.add(new Pn("cameraPosition",r=>r.camera.eye)),e.constants.add("betaRayleigh","vec3",H8),e.constants.add("betaCombined","vec3",q8),e.constants.add("betaMie","float",G8),e.code.add(_`
    vec3 raymarchAtmosphere(vec3 cameraPos, vec3 rayDir, vec3 lightDir, float terrainDepth) {
      vec4 ray = planetIntersect(cameraPos, rayDir);
      if(ray.x == 1.0) {
        return vec3(0);
      }
      ${X(t,"if (terrainDepth != -1.0) { ray.w = terrainDepth; }")}

      vec3 samplePoint = cameraPos + rayDir * ray.w;
      float multiplier = ray.y == 1.0 ? -1.0 : 1.0;

      vec3 scattering = vec3(0);
      float scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
      float lastOpticalDepth = getOpticalDepth(samplePoint, rayDir, scaleFract);
      float stepSize = (ray.w - ray.z) / ${_.float(i)};

      for (int i = 0; i < ${_.int(i)}; i++) {
        samplePoint -= stepSize * rayDir;
        scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
        float opticalDepth = multiplier * getOpticalDepth(samplePoint, rayDir * multiplier, scaleFract);

        if (i > 0) {
          scattering *= exp(-(mix(betaCombined, betaRayleigh, 0.5) + betaMie) * max(0.0, (opticalDepth - lastOpticalDepth)));
          ${X(!t,"scattering *= mix(2.5, 1.0, clamp((length(cameraPos) - radii[0]) / 50e3, 0.0, 1.0))")};
        }

        if (dot(normalize(samplePoint), lightDir) > -0.3) {
          float scale = exp(-scaleFract);
          float lightDepth = getOpticalDepth(samplePoint, lightDir, scaleFract);
          scattering += scale * exp(-(betaCombined + betaMie) * lightDepth);
          ${X(!t,"scattering += scale * exp(-(0.25 * betaCombined ) * lightDepth);")}
        }
        lastOpticalDepth = opticalDepth;
      }

      float mu = dot(rayDir, lightDir);
      float mumu = 1.0 + mu * mu;

      float phaseRayleigh = 0.0596831 * mumu;
      ${t?"return 3.0 * scattering * stepSize * phaseRayleigh * betaRayleigh;":_`const float g = 0.8;
             const float gg = g * g;
             float phaseMie = 0.1193662 * ((1.0 - gg) * mumu) / (pow(1.0 + gg - 2.0 * mu * g, 1.5) * (2.0 + gg));
             phaseMie = clamp(phaseMie, 0.0, 128.0);
             return 3.0 * scattering * stepSize * (phaseRayleigh * betaRayleigh + 0.025 * phaseMie * betaMie);`}
    }`)}function Kp(e,t={needUVs:!0,needEyeDirection:!0}){e.attributes.add("position","vec2"),e.varyings.add("worldRay","vec3");const{needUVs:i,needEyeDirection:r}=t;i&&e.varyings.add("uv","vec2"),r&&e.varyings.add("eyeDir","vec3"),e.vertex.uniforms.add(new ps("inverseProjectionMatrix",s=>s.camera.inverseProjectionMatrix),new ps("inverseViewMatrix",s=>sL(pZ,s.camera.viewMatrix))),e.vertex.main.add(_`
    vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1.0, 1.0)).xyz;
    ${X(r,"eyeDir = posViewNear;")}
    worldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;
    ${X(i,"uv = position * 0.5 + vec2(0.5);")}
    gl_Position = vec4(position, 1, 1);
  `)}const pZ=Le();function DE(e){const t=new ut;t.include(Kp);const{reduced:i}=e,{fragment:r}=t;return cc(r),r.include(pc),r.include(Wp),r.include(kp),r.include(RE,!1),r.uniforms.add(new Zr("backgroundColor",s=>s.backgroundColor),new _e("innerFadeDistance",s=>s.innerFadeDistance),new _e("altitudeFade",s=>s.altitudeFade),new gs("depthTexture",s=>s.mainDepth)).code.add(_`vec4 applyUndergroundAtmosphere(vec3 rayDir, vec3 lightDirection, vec4 fragColor) {
float rayPlanetDistance = heightParameters[1] - radii[0] * radii[0];
vec2 rayPlanetIntersect = sphereIntersect(cameraPosition, rayDir, rayPlanetDistance);
if (!((rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.y > 0.0)) {
return fragColor;
}
float lightAngle = dot(lightDirection, normalize(cameraPosition + rayDir * max(0.0, rayPlanetIntersect.x)));
vec4 surfaceColor = vec4(vec3(max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)))), 1.0 - altitudeFade);
float relDist = (rayPlanetIntersect.y - max(0.0, rayPlanetIntersect.x)) / innerFadeDistance;
if (relDist > 1.0) {
return surfaceColor;
}
return mix(fragColor, surfaceColor, smoothstep(0.0, 1.0, relDist * relDist));
}
float getGlow(float dist, float radius, float intensity) {
return pow(radius / max(dist, 1e-6), intensity);
}
vec3 getSun(vec3 cameraPos, vec3 rayDir, vec3 lightDir){
float scaleFract = (length(cameraPos) - radii[0]) / scaleHeight;
float sunOpticalDepth = getOpticalDepth(cameraPos, rayDir, max(scaleFract, 0.0));
vec3 sunTransmittance = exp(-(mix(betaCombined, betaRayleigh, 0.5)) * max(0.0, sunOpticalDepth));
float mu = clamp(dot(rayDir, lightDir), 0.0, 1.0);
float sunDisc = 256.0 * smoothstep(0.0, 128.0, clamp(getGlow(1.0 - mu, 3e-5, 3.0), 0.0, 128.0));
return normalize(sunTransmittance) * sunDisc;
}`).main.add(_`
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;
      ${X(!i,_`float depthSample = texture(depthTexture, uv).r;
             if (depthSample != 1.0) {
                fragColor = vec4(0);
                return;
             }`)}

      vec3 col = linearizeGamma(backgroundColor);
      col += raymarchAtmosphere(cameraPosition, rayDir, mainLightDirection, terrainDepth);
      col += getSun(cameraPosition, rayDir, mainLightDirection);
      float alpha = smoothstep(0.0, mix(0.15, 0.01, heightParameters[3]), length(col));

      col = tonemapACES(col);
      fragColor = delinearizeGamma(vec4(col, alpha));
      fragColor = applyUndergroundAtmosphere(rayDir, mainLightDirection, fragColor);
  `),t}const mZ=Object.freeze(Object.defineProperty({__proto__:null,build:DE},Symbol.toStringTag,{value:"Module"}));let fZ=class extends ME{constructor(){super(...arguments),this.innerFadeDistance=0,this.altitudeFade=0,this.backgroundColor=w()}},W0=class extends ct{constructor(e,t){super(e,t,new ht(mZ,()=>k(()=>Promise.resolve().then(()=>oee),void 0)),Ja(zp))}initializePipeline(e){return Ge({blending:e.reduced?D2:M2(770,771),depthTest:{func:e.reduced?519:515},colorWrite:st})}},OE=class extends hr{constructor(){super(...arguments),this.reduced=!1}};h([z()],OE.prototype,"reduced",void 0);let cw=class extends Kt{};function EE(){const e=new ut;return e.include($i),e.fragment.uniforms.add(new Ne("colorTexture",t=>t.color),new gs("depthTexture",t=>t.mainDepth)),e.fragment.main.add(_`float depthSample = texture(depthTexture, uv).r;
if (depthSample != 1.0 ) {
fragColor = vec4(0);
return;
}
fragColor = texture(colorTexture, uv);`),e}const gZ=Object.freeze(Object.defineProperty({__proto__:null,AtmosphereCompositingPassParameters:cw,build:EE},Symbol.toStringTag,{value:"Module"}));let lT=class extends ct{constructor(e,t){super(e,t,new ht(gZ,()=>k(()=>Promise.resolve().then(()=>lee),void 0)),ai)}initializePipeline(){return Ge({blending:M2(770,771),depthTest:{func:519},colorWrite:st})}},J1=class extends ea{constructor(){super(...arguments),this.requireGeometryDepth=!0,this._compositingPassParameters=new cw,this._vao=null,this._passParameters=new fZ,this._configuration=new OE}initialize(){this.techniques.precompile(W0,this._configuration),this.techniques.precompile(lT),this._configuration.reduced=!0,this.techniques.precompile(W0,this._configuration),this._configuration.reduced=!1,this.addHandles([M(()=>this.view.environment.background,e=>{const t=e instanceof qR?rb(e.color):di;xe(this._passParameters.backgroundColor,t[0]*t[3],t[1]*t[3],t[2]*t[3])},Ve),M(()=>this.view.stage?.renderer?.fullResolutionAtmosphere,e=>this._configuration.reduced=!e,Ve),M(()=>this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),Ve)])}destroy(){this._vao=ye(this._vao)}render(e){const t=e.find(({name:y})=>y===ne.OPAQUE_ENVIRONMENT);if(!this.bindParameters.mainDepth)return t;const i=this.renderingContext;this._vao??=Zo(i,1);const r=t.getAttachment(qi);this._update();const s=this.techniques.get(W0,this._configuration);if(!s.compiled)return this.requestRender(1),t;if(!this._configuration.reduced)return t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(s,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(St.TRIANGLE_STRIP,0,4),t.attachDepth(r),t;const n=this.techniques.get(lT);if(!n.compiled)return this.requestRender(1),t;const a=i.getViewport(),o=this.bindParameters.camera,l=ge(o.eye)-Li.radius;let c;const u=Li.atmosphereHeight;if(l<u){const y=Math.min(1,Math.max(0,l/u));c=De(.2,.3,y)}else{const y=Math.min(1,Math.max(0,(l-u)/(15*u)));c=De(.3,.6,y)}const p=this.renderingContext.parameters.maxTextureSize,m=Wh(Math.round(c*o.fullViewport[2]),p),f=Wh(Math.round(c*o.fullViewport[3]),p);i.setViewport(0,0,m,f);const g=this.fboCache.acquire(m,f,"chapman",5);return i.bindFramebuffer(g.fbo),i.clearFramebuffer([0,0,0,1],!0,!0),i.bindTechnique(s,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(St.TRIANGLE_STRIP,0,4),i.setViewport(a.x,a.y,a.width,a.height),this._compositingPassParameters.color=g.getTexture(),t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(n,this.bindParameters,this._compositingPassParameters),i.screen.draw(),t.attachDepth(r),g.release(),t}_update(){const e=this.bindParameters.camera,t=Wr(e.eye),i=Math.sqrt(t),r=t-this._passParameters.radii[1]**2,s=j((i-this._passParameters.radii[0])/Li.atmosphereHeight,0,1);cr(this._passParameters.heightParameters,i,t,r,s);const n=this.view.basemapTerrain?.getLowerBoundRadius()??0;Ki(this._passParameters.radii,n,n+Li.atmosphereHeight),this._passParameters.innerFadeDistance=2*Math.sqrt((2*n-Sv)*Sv),this._passParameters.altitudeFade=l4(i-n)}};J1=h([D("esri.views.3d.environment.ChapmanAtmosphere")],J1);function AE(){const e=new ut,{fragment:t}=e;return e.include(Kp,{needUVs:!1,needEyeDirection:!1}),t.include(S2),e.include(j8,{pbrMode:0,lightingSphericalHarmonicsOrder:2}),t.include(i4),t.include(pc),e.include(xE),t.uniforms.add(new Pn("cameraPosition",i=>i.camera.eye),new Er("cloudsOpacity",i=>i.clouds.opacity)).main.add(_`vec4 cloudsColor = renderClouds(normalize(worldRay), cameraPosition);
fragColor = vec4(cloudsOpacity * cloudsColor.rgb, cloudsColor.a);`),e}const _Z=Object.freeze(Object.defineProperty({__proto__:null,build:AE},Symbol.toStringTag,{value:"Module"}));let cT=class extends ct{constructor(e,t){super(e,t,new ht(_Z,()=>k(()=>Promise.resolve().then(()=>cee),void 0)),ai)}initializePipeline(){return Ge({blending:mu(1,0,770,1),depthTest:{func:515},colorWrite:st})}},e2=class extends ea{constructor(e){super(e),this._planetRadius=Yt(e.view.spatialReference).radius}initialize(){this.techniques.precompile(cT),this.addHandles([M(()=>this.view.environment.weather!=null&&this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),Ee)])}destroy(){this._vao=ye(this._vao)}render(e){const t=e.find(({name:a})=>a===ne.OPAQUE_ENVIRONMENT),i=this.bindParameters.clouds;if(!i.data)return t;const r=this.techniques.get(cT);if(!r.compiled)return this.requestRender(1),t;const s=this.renderingContext;this._vao??=Zo(s);const n=s.bindTechnique(r,this.bindParameters);return s.bindVAO(this._vao),n.assertCompatibleVertexAttributeLocations(this._vao),s.drawArrays(St.TRIANGLE_STRIP,0,4),i.isFading&&this.requestRender(2),t}};e2=h([D("esri.views.3d.environment.CloudsComposition")],e2);let IE=class extends Kt{constructor(){super(...arguments),this.atmosphereC=1}};function LE(e){e.include(Wp),e.uniforms.add(new _e("atmosphereC",t=>t.atmosphereC),new Pn("cameraPosition",t=>t.camera.eye)),e.code.add(_`float getDistanceFalloff(float dist, vec3 rayDir, float weight) {
if(dist == -1.0){
dist = 0.055 * sphereIntersect(cameraPosition, rayDir, atmosphereC).y;
}
return (1.0 - exp(-dist * weight));
}`)}let hw=class extends IE{constructor(){super(...arguments),this.color=w(),this.strength=4e-6,this.amount=0,this.fogColorDistanceWeight=1}};function FE(e){const t=new ut;t.include(Kp,{needUVs:!0,needEyeDirection:!0});const i=t.fragment,{hasEmissive:r}=e;return i.uniforms.add(new gs("depthTexture",s=>s.mainDepth),new _e("fogStrength",s=>s.strength),new _e("fogAmount",s=>s.amount),new Zr("fogColor",s=>s.color),new _e("fogColorDistanceWeight",s=>s.fogColorDistanceWeight)),r&&i.uniforms.add(new Ne("emissionTexture",s=>s.emission)),i.include(LE),i.include(pc),i.include(kp),i.include(Xa),i.main.add(_`
    vec3 rayDir = normalize(worldRay);
    float terrainDepth = -1.0;

    float depthSample = depthFromTexture(depthTexture, uv);
    if(depthSample < 1.0 && depthSample > 0.0){
      vec3 cameraSpaceRay = normalize(eyeDir);
      cameraSpaceRay /= cameraSpaceRay.z;
      cameraSpaceRay *= linearizeDepth(depthSample);
      terrainDepth = max(0.0, length(cameraSpaceRay));
    }

    float fogAmount = fogAmount * getDistanceFalloff(terrainDepth, rayDir, fogStrength);

    ${X(r,_`vec3 emission = texture(emissionTexture, uv).rgb;
           vec3 emissionDistanceCorrected = mix(emission, vec3(0.0), fogAmount * fogColorDistanceWeight);
           vec3 finalFogColor = fogColor * fogAmount + emissionDistanceCorrected;
           vec4 fog = vec4(finalFogColor, fogAmount);`,_`vec4 fog = vec4(fogColor, 1.0) * fogAmount;`)}
    fragColor = delinearizeGamma(vec4(tonemapACES(fog.rgb), fog.a));`),t}const yZ=Object.freeze(Object.defineProperty({__proto__:null,FogPassParameters:hw,build:FE},Symbol.toStringTag,{value:"Module"}));let Z0=class extends ct{constructor(e,t){super(e,t,new ht(yZ,()=>k(()=>Promise.resolve().then(()=>hee),void 0)),ai)}initializePipeline(){return Ge({blending:mu(770,0,771,1),colorWrite:st})}},VE=class extends hr{constructor(){super(...arguments),this.hasEmissive=!1}};h([z()],VE.prototype,"hasEmissive",void 0);function zE(e){e.code.add(_`const float MAX_RGBA_FLOAT =
255.0 / 256.0 +
255.0 / 256.0 / 256.0 +
255.0 / 256.0 / 256.0 / 256.0 +
255.0 / 256.0 / 256.0 / 256.0 / 256.0;
const vec4 FIXED_POINT_FACTORS = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);
vec4 float2rgba(const float value) {
float valueInValidDomain = clamp(value, 0.0, MAX_RGBA_FLOAT);
vec4 fixedPointU8 = floor(fract(valueInValidDomain * FIXED_POINT_FACTORS) * 256.0);
const float toU8AsFloat = 1.0 / 255.0;
return fixedPointU8 * toU8AsFloat;
}`),e.code.add(_`const vec4 RGBA_TO_FLOAT_FACTORS = vec4(
255.0 / (256.0),
255.0 / (256.0 * 256.0),
255.0 / (256.0 * 256.0 * 256.0),
255.0 / (256.0 * 256.0 * 256.0 * 256.0)
);
float rgbaTofloat(vec4 rgba) {
return dot(rgba, RGBA_TO_FLOAT_FACTORS);
}`),e.code.add(_`const vec4 uninterpolatedRGBAToFloatFactors = vec4(
1.0 / 256.0,
1.0 / 256.0 / 256.0,
1.0 / 256.0 / 256.0 / 256.0,
1.0 / 256.0 / 256.0 / 256.0 / 256.0
);
float uninterpolatedRGBAToFloat(vec4 rgba) {
return (dot(round(rgba * 255.0), uninterpolatedRGBAToFloatFactors) - 0.5) * 2.0;
}`),e.code.add(_`const vec3 uninterpolatedRGBToFloatFactors = vec3(
1.0 / 256.0,
1.0 / 256.0 / 256.0,
1.0 / 256.0 / 256.0 / 256.0
);
float uninterpolatedRGBToFloat(vec3 rgb) {
return (dot(round(rgb * 255.0), uninterpolatedRGBToFloatFactors) - 0.5) * 2.0;
}`)}let J_=class extends Kt{constructor(){super(...arguments),this.opacity=1}};function kE(e){const t=new ut,{blitEmissiveMode:i,blitMode:r,hasOpacityFactor:s}=e;t.include($i),t.fragment.uniforms.add(new Ne("tex",o=>o.texture)),s&&t.fragment.uniforms.add(new _e("opacity",o=>o.opacity));const n=r===3;n&&(t.fragment.uniforms.add(new op("nearFar",o=>o.camera.nearFar)),t.fragment.include(Xa),t.fragment.include(zE));const a=i===1;return a&&(t.outputs.add("fragColor","vec4",0),t.outputs.add("fragEmission","vec4",1)),t.fragment.main.add(_`
    ${n?_`
          float normalizedLinearDepth = (-linearDepthFromTexture(tex, uv) - nearFar[0]) / (nearFar[1] - nearFar[0]);
          fragColor = float2rgba(normalizedLinearDepth);`:_`
          fragColor = texture(tex, uv) ${s?"* opacity":""};`}
    ${X(a,"fragEmission = vec4(0.0, 0.0, 0.0, fragColor.a);")}`),t}const vZ=Object.freeze(Object.defineProperty({__proto__:null,CompositingPassParameters:J_,build:kE},Symbol.toStringTag,{value:"Module"}));let Xn=class extends ct{constructor(e,t){super(e,t,new ht(vZ,()=>k(()=>Promise.resolve().then(()=>uee),void 0)),ai)}initializePipeline(e){const{blitMode:t,blitEmissiveMode:i}=e,r=i?1:0;switch(t){case 0:case 3:return Ge({colorWrite:st,drawBuffers:Gd(0,r)});case 1:return Ge({blending:ja,colorWrite:st,drawBuffers:Gd(0,r)});default:return Ge({blending:fu,colorWrite:st,drawBuffers:Gd(0,r)})}}},ap=class extends hr{constructor(){super(...arguments),this.blitMode=0,this.blitEmissiveMode=0,this.hasOpacityFactor=!1}};h([z({count:4})],ap.prototype,"blitMode",void 0),h([z({count:4})],ap.prototype,"blitEmissiveMode",void 0),h([z()],ap.prototype,"hasOpacityFactor",void 0);let uw=class{constructor(e,t=0){this._techniques=e,this._parameters=new J_,this._configuration=new ap,this._configuration.blitMode=t,e.precompile(Xn,this._configuration),this._configuration.hasOpacityFactor=!0,e.precompile(Xn,this._configuration),this._configuration.hasOpacityFactor=!1}blit(e,t,i,r){this.blitTexture(e,t.getTexture(),i,r)}blitTexture(e,t,i,r){e.bindFramebuffer(i.fbo),e.setClearColor(0,0,0,1),e.clear(16384),this._parameters.texture=t;const s=this._techniques.get(Xn,this._configuration);e.bindTechnique(s,r,this._parameters),e.screen.draw()}blend(e,t,i,r,s=1){this._configuration.hasOpacityFactor=s<1;const n=this._techniques.get(Xn,this._configuration);return!!n.compiled&&(e.bindFramebuffer(i.fbo),this._parameters.texture=t.getTexture(),this._parameters.opacity=s,e.bindTechnique(n,r,this._parameters),e.screen.draw(),!0)}};const bZ=.95,wZ=1;let gg=class extends Xl{constructor(e){super(e),this.consumes={required:[ne.TRANSPARENT_ENVIRONMENT]},this._configuration=new VE,this.requireGeometryDepth=!0,this._newParameters=new Q0,this._oldParameters=new Q0,this._fadedParameters=new Q0,this._parameters=this._newParameters,this._passParameters=new hw,this._blit=null;const t=Yt(e.view.spatialReference);this._planetRadius=t.radius,this._atmosphereRadius=t.radius+t.atmosphereHeight;const i=e.view.stage.renderView.techniques;i.precompile(Z0,this._configuration),this._configuration.hasEmissive=!this._configuration.hasEmissive,i.precompile(Z0,this._configuration),this._configuration.hasEmissive=!this._configuration.hasEmissive}toogle(){this.view.environment.atmosphereEnabled&&this.view.environment.weather?this._enable():this._disable()}initialize(){this.addHandles([M(()=>this.view.environment.atmosphereEnabled,()=>this.toogle(),Ve),M(()=>this.view.environment.weather,()=>this.toogle(),Ve),M(()=>this._updateFogParameters(),()=>{},Ve)]),this.addHandles(M(()=>this._fadeFactor,e=>this._fade(e),Ve))}get _fadeFactor(){return this.view.stage?.renderer.renderContext.bind.clouds.fadeFactor??1}_fade(e){const{_newParameters:t,_oldParameters:i}=this;e>=1?(this._parameters=t,this._oldParameters.copyFrom(this._newParameters)):e<=0?this._parameters=i:(this._fadedParameters.lerp(i,t,e),this._parameters=this._fadedParameters)}_updateFogParameters(){const e=this.view.environment.weather,t=e.type==="foggy"||e.type==="snowy"||e.type==="rainy";this._newParameters.strength=e.type==="foggy"?De(3e-5,.005,e.fogStrength**3):e.type==="snowy"||e.type==="rainy"?De(4e-6,2e-4,(e.precipitation??0)**3):0,this._newParameters.amount=t?1:0,e.type!=="foggy"&&e.type!=="snowy"||q(this._newParameters.color,CZ),e.type==="rainy"&&q(this._newParameters.color,xZ),this._fadeFactor>=1&&this._oldParameters.copyFrom(this._newParameters),this.requestRender(1)}render(e){const t=e.find(({name:p})=>p===ne.TRANSPARENT_ENVIRONMENT);if(this._parameters.amount===0||(this._update(),this._passParameters.amount<=0))return t;const i=t.getAttachment(Qr);this._configuration.hasEmissive=i!=null;const r=this.techniques.get(Z0,this._configuration);if(!r.compiled)return this.requestRender(1),t;const s=t.getAttachment(qi),n=this.renderingContext,{fullWidth:a,fullHeight:o}=this.bindParameters.camera,l=a,c=o;let u=null;return i&&(u=this.fboCache.acquire(l,c,"glow horizontal",8),this._blit??=new uw(this.techniques),this._blit.blitTexture(n,i?.attachment,u,this.bindParameters)),t.attachDepth(null),n.bindFramebuffer(t.fbo),i&&(this._passParameters.emission=u?.getTexture()),n.bindTechnique(r,this.bindParameters,this._passParameters),n.screen.draw(),t.attachDepth(s),u?.release(),t}_update(){const e=this.bindParameters.camera;me(hT,e.eye);const t=Math.max(0,$e(hT,this.bindParameters.lighting.mainLight.direction)),i=this._parameters.color;te(uT,i,.1),Nt(this._passParameters.color,uT,i,t);const r=ge(e.eye);this._passParameters.atmosphereC=r**2-this._atmosphereRadius**2,this._passParameters.amount=(1-Jh(bZ*Nl,wZ*Nl,Math.abs(r-this._planetRadius)))*this._parameters.amount,this._passParameters.strength=this._parameters.strength}get test(){return{parameters:this._passParameters}}};h([d()],gg.prototype,"consumes",void 0),gg=h([D("esri.views.3d.environment.Fog")],gg);let Q0=class{constructor(){this.color=w(),this.strength=0,this.amount=0}copyFrom(e){this.amount=e.amount,this.strength=e.strength,q(this.color,e.color)}lerp(e,t,i){this.amount=De(e.amount,t.amount,i),this.strength=De(e.strength,t.strength,i),Nt(this.color,e.color,t.color,i)}};const hT=w(),uT=w(),xZ=We(.5,.5,.5),CZ=We(1.5,1.5,1.5);let ey=class extends Kt{constructor(){super(...arguments),this.texV=ze(),this.altitudeFade=0,this.innerScale=0,this.undergroundFadeAlpha=0,this.silhouette=new dw}},dw=class{constructor(){this.center=w(),this.v1=w(),this.v2=w()}};function BE(e){const t=new ut,{vertex:i,fragment:r}=t;if(cc(i),e.geometry===2)t.attributes.add("position","vec2"),t.varyings.add("color","vec4"),i.uniforms.add(new Pn("cameraPosition",s=>s.camera.eye),new _e("undergroundFadeAlpha",s=>s.undergroundFadeAlpha)),i.main.add(_`float ndotl = dot(normalize(cameraPosition), mainLightDirection);
float lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));
color = vec4(vec3(lighting), undergroundFadeAlpha);
gl_Position = vec4(position.xy, 1.0, 1.0);`),r.main.add(_`fragColor = color;`);else{t.include(u4),t.attributes.add("position","vec3"),t.varyings.add("vtc","vec2"),t.varyings.add("falloff","float");const s=e.geometry===1;i.uniforms.add(new ps("proj",o=>o.camera.projectionMatrix),new ps("view",o=>o.camera.viewMatrix)),s||(t.varyings.add("innerFactor","float"),i.uniforms.add(new Zr("silCircleCenter",o=>o.silhouette.center)),i.uniforms.add(new Zr("silCircleV1",o=>o.silhouette.v1)),i.uniforms.add(new Zr("silCircleV2",o=>o.silhouette.v2)),i.uniforms.add(new qs("texV",o=>o.texV)),i.uniforms.add(new _e("innerScale",o=>o.innerScale)));const n=6.2831853,a=1/128;i.main.add(_`
      ${s?_`
      vec3 pos = position;
      float ndotl = mainLightDirection.z;
      vtc = vec2(0.0, position.z + 0.05);`:_`
      innerFactor = clamp(-position.z, 0.0, 1.0);
      float scale = position.y * (1.0 + innerFactor * innerScale);
      float phi = position.x * ${_.float(n*a)} + 1.0;
      vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;
      float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), mainLightDirection);
      vtc.x = position.x  * ${_.float(a)};
      vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;
      `}
      falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));

		  gl_Position = transformPosition(proj, view, pos);
		  gl_Position.z = gl_Position.w; // project atmosphere onto the far plane
	  `),r.uniforms.add(new Ne("tex",o=>o.texture)),s||r.uniforms.add(new _e("altitudeFade",o=>o.altitudeFade)),r.main.add(_`
			vec4 atmosphereColor = texture(tex, vtc) * falloff;
      ${s?_`fragColor = atmosphereColor;`:_`
			vec4 innerColor = vec4(atmosphereColor.rgb, 1.0 - altitudeFade);
			fragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));`}`)}return t}const SZ=Object.freeze(Object.defineProperty({__proto__:null,SilhouetteCircle:dw,SimpleAtmospherePassParameters:ey,build:BE},Symbol.toStringTag,{value:"Module"}));let Bh=class extends ct{constructor(e,t){super(e,t,new ht(SZ,()=>k(()=>Promise.resolve().then(()=>dee),void 0)),Lp.locations)}initializePipeline(e){const t=e.geometry===1;return Ge({blending:ja,culling:t?o4:void 0,depthTest:{func:515},colorWrite:st})}};const Lp=Ka().vec3f("position").freeze();let pw=class extends S_{constructor(){super(...arguments),this.geometry=0}};h([z({count:3})],pw.prototype,"geometry",void 0);const TZ=new Uint8ClampedArray([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,16,0,0,16,16,0,0,16,16,0,0,16,16,0,0,16,15,0,0,17,15,0,0,17,15,0,0,17,15,0,0,17,14,0,0,18,14,0,0,18,14,0,0,18,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,20,13,0,0,20,13,0,0,20,13,0,0,20,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,22,12,0,0,22,12,0,0,22,12,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,27,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,29,18,0,0,29,18,0,0,29,17,0,0,30,17,0,0,30,17,0,0,30,17,0,0,30,16,0,0,31,16,0,0,31,16,0,0,31,16,0,0,32,16,0,0,32,16,0,0,32,15,0,0,33,15,0,0,33,15,0,0,33,15,0,0,34,15,8,0,34,15,8,0,34,15,8,0,34,15,7,0,35,15,7,0,35,15,7,0,35,21,7,0,36,21,7,0,36,21,7,0,36,21,7,0,37,21,7,0,37,21,7,0,37,20,7,0,38,20,7,0,38,20,7,0,38,20,7,0,39,20,7,0,39,20,7,0,39,20,7,0,39,19,6,0,40,19,6,0,40,19,6,0,40,19,6,0,41,19,6,0,41,19,6,0,41,18,6,0,42,18,6,0,42,18,6,0,42,24,6,0,43,24,6,0,43,24,6,0,43,23,6,0,44,23,6,0,44,23,6,0,44,23,6,0,45,23,6,0,45,23,6,0,45,22,6,0,46,22,6,0,46,22,6,0,46,22,5,0,47,22,5,0,47,22,5,0,47,21,5,0,48,21,5,0,48,21,5,0,48,21,5,0,49,21,5,0,49,26,5,0,49,25,5,0,50,25,5,0,50,25,5,0,50,25,5,0,51,25,5,0,51,25,5,0,51,25,5,0,52,25,5,0,52,25,5,0,52,24,5,0,53,24,5,0,53,24,5,0,53,24,9,0,54,28,9,0,54,28,9,0,54,28,9,0,55,28,9,0,55,27,9,0,56,27,9,0,56,27,9,0,56,27,9,4,57,27,9,4,57,27,9,4,57,26,9,4,58,26,9,4,58,26,9,4,58,26,9,4,59,26,9,4,59,26,9,4,59,26,8,4,60,30,8,4,60,30,8,4,60,29,8,4,61,29,8,4,61,29,8,4,62,29,8,4,62,29,8,4,62,28,8,4,63,28,8,4,63,28,8,4,63,28,12,4,64,28,12,4,64,28,12,4,64,27,12,4,65,27,12,8,65,27,12,8,65,31,12,8,66,31,12,8,66,30,11,8,67,30,11,8,67,30,11,8,67,30,11,8,68,30,11,8,68,30,11,8,68,30,15,7,69,30,15,7,69,30,15,7,69,33,15,11,70,33,15,11,70,32,14,11,71,32,14,11,71,32,14,11,71,32,18,14,72,32,18,14,72,32,18,14,72,31,17,14,73,35,17,14,73,34,17,17,74,34,21,17,74,34,21,17,74,34,20,17,75,34,20,20,75,34,20,20,75,34,23,20,76,34,23,20,76,36,23,23,77,36,23,23,77,36,23,23,77,36,23,23,78,36,26,26,78,36,26,26,78,36,26,26,79,36,26,29,79,38,26,29,80,38,29,29,80,38,29,29,80,38,28,31,81,38,28,31,81,38,31,31,81,37,31,34,82,37,31,34,82,37,31,37,83,40,34,37,83,40,34,37,83,39,33,39,84,39,33,39,84,39,36,42,84,39,36,42,85,39,36,42,85,39,36,42,85,39,39,44,86,39,39,44,86,41,38,47,87,41,41,47,87,41,41,50,87,41,41,49,88,41,41,52,88,40,43,52,89,43,43,52,89,43,43,54,89,42,45,54,90,42,45,57,90,42,45,57,90,42,45,59,91,42,48,59,91,44,47,61,92,44,47,61,92,44,50,61,92,44,49,63,93,44,49,63,93,44,52,66,93,43,52,65,94,46,54,68,94,46,54,70,95,46,54,70,95,46,54,70,95,45,56,72,96,45,56,72,96,45,58,74,97,47,58,76,97,47,58,76,97,47,60,78,98,47,60,78,98,47,60,81,98,49,62,80,99,49,62,82,99,48,61,84,100,48,64,84,100,48,64,84,100,50,63,86,101,50,66,86,101,50,66,88,101,50,65,90,102,52,67,89,103,51,69,91,104,51,68,92,105,52,69,93,107,52,71,94,108,54,70,96,109,53,71,96,111,52,73,98,112,54,72,98,114,53,73,100,115,54,72,100,117,54,73,102,118,55,74,104,120,55,76,105,121,56,77,106,123,56,76,107,124,57,79,107,126,58,78,110,128,57,79,111,129,56,80,113,131,58,79,112,132,57,82,114,134,58,81,116,136,60,82,117,137,59,83,117,139,60,83,119,141,59,84,120,142,60,85,122,144,59,86,122,146,60,86,126,148,62,87,127,149,61,88,127,151,62,88,128,153,63,89,130,155,62,90,131,156,63,90,132,158,64,91,134,160,65,91,135,162,64,92,136,163,63,93,138,165,66,95,139,167,65,95,140,169,66,95,142,171,67,96,142,172,66,97,144,174,67,99,145,176,67,97,148,178,67,99,147,180,68,100,149,181,68,100,150,183,69,101,152,185,70,102,153,187,71,103,155,188,70,103,156,190,70,104,157,192,71,105,158,194,71,106,160,195,72,106,161,197,72,108,161,199,73,108,163,200,73,109,164,202,74,109,165,204,74,110,167,206,75,111,168,207,74,112,170,209,75,112,170,210,76,113,171,212,76,114,173,214,77,115,174,215,78,115,175,217,78,116,175,218,78,117,177,220,78,118,178,221,79,118,180,223,80,120,180,224,81,120,181,226,81,120,182,227,82,121,184,229,82,122,185,230,84,123,186,232,83,123,187,233,84,124,189,234,84,125,188,235,85,126,189,237,86,126,190,238,86,127,191,239,87,127,192,240,87,129,193,242,88,129,194,243,89,130,195,244,90,131,196,245,90,132,197,246,91,132,197,247,92,133,198,248,92,134,199,249,93,135,200,250,94,136,201,251,95,137,202,252,96,138,203,253,97,140,204,254,98,141,205,254,99,142,206,255,101,143,207,255,102,144,208,255,103,146,209,255,104,147,209,255,106,148,210,255,107,149,211,255,108,151,212,255,110,152,213,255,111,153,213,255,112,154,214,255,114,156,215,255,115,157,215,255,117,158,216,255,118,160,217,255,120,161,217,255,121,162,218,255,123,164,218,255,124,165,219,255,125,166,219,255,127,167,220,255,129,169,220,255,130,170,221,255,132,171,221,255,133,173,222,255,134,174,222,255,136,175,223,255,139,178,224,255,142,180,224,255,144,182,225,255,147,185,226,255,150,187,226,255,153,189,227,255,155,191,228,255,158,194,228,255,160,196,229,255,163,198,229,255,165,200,230,255,168,202,231,255,170,203,231,255,172,205,232,255,174,207,232,255,176,209,233,255,178,210,234,255,180,212,234,255,182,214,235,255,184,215,236,255,186,217,237,255,188,219,238,255,190,220,238,255,192,221,239,255,193,222,240,255,194,224,240,255,196,225,241,255,197,226,241,255,198,226,242,255,199,227,242,255,200,228,242,255,201,228,243,255,202,229,243,255,203,230,243,255,204,230,244,255,205,231,244,255,207,232,244,255,208,233,245,255,209,233,245,255,211,234,246,255,213,235,246,255,217,238,247,255,222,240,248,255,226,242,249,255,231,245,250,255,236,247,251,255,241,249,252,255,245,251,253,255,249,252,254,255,255,255,255,255]);let t2=class extends ea{constructor(){super(...arguments),this._configuration=new pw,this._passParameters=new ey,this._vao=null,this._vaoCount=0}initialize(){this._configuration.geometry=1,this.addHandles([M(()=>this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),Ee)])}destroy(){this._passParameters.texture=ye(this._passParameters.texture),this._vao=ye(this._vao)}precompile(){this.techniques.precompile(Bh,this._configuration)}render(e){const t=e.find(({name:n})=>n===ne.OPAQUE_ENVIRONMENT),i=this.techniques.get(Bh,this._configuration);if(!i.compiled)return this.requestRender(1),t;const r=this.renderingContext;if(this._vao||(this._vao=PZ(r),this._vaoCount=this._vao.vertexCount("geometry")),!this._passParameters.texture){const n=new gt(1,512);n.wrapMode=33071,n.flipped=!0,this._passParameters.texture=new bt(r,n,TZ)}const s=r.bindTechnique(i,this.bindParameters,this._passParameters);return MZ(dT,this.bindParameters.camera.viewMatrix),s.setUniformMatrix4fv("view",dT),r.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao),r.drawArrays(St.TRIANGLES,0,this._vaoCount),t}};function PZ(e){const t=fI(1,2,!1),{data:i,indices:r}=t[0][1],s=Lp.createBuffer(r.length),n=s.position;for(let a=0;a<r.length;++a){const o=3*r[a%3==0?a+2:a%3==2?a-2:a];n.set(a,0,i[o]),n.set(a,1,i[o+1]),n.set(a,2,i[o+2])}return new Dn(e,new ei(e,Bs(Lp),s.buffer))}function MZ(e,t){ks(e,t),e[12]=0,e[13]=0,e[14]=0,e[15]=1}t2=h([D("esri.views.3d.environment.LocalAtmosphere")],t2);const dT=Le(),RZ=new Uint8ClampedArray([0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,16,0,0,0,16,0,0,0,16,0,0,0,17,0,0,0,17,0,0,0,18,0,0,0,18,0,0,0,19,0,0,0,19,0,0,0,19,0,0,0,20,0,0,0,20,0,0,0,21,0,0,0,21,0,0,0,22,0,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,28,9,0,0,28,9,0,0,29,9,0,0,29,8,0,0,30,8,0,0,30,8,0,0,31,8,0,0,31,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,33,8,0,0,33,8,0,0,34,7,0,0,35,7,0,0,35,7,0,0,36,7,0,0,36,7,7,0,37,7,7,0,37,7,7,0,38,7,7,0,38,13,7,0,39,13,7,0,39,13,6,0,40,13,6,0,40,12,6,0,41,12,6,0,41,12,6,0,41,12,6,0,42,12,6,0,42,12,6,0,43,12,6,0,43,12,6,0,44,12,6,0,44,11,6,0,45,11,6,6,45,11,6,6,46,11,5,5,47,11,5,5,47,11,5,5,48,11,5,5,48,10,5,5,49,10,5,5,49,10,5,5,50,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,52,15,5,5,52,14,5,5,53,14,5,5,54,14,5,5,54,14,5,5,55,14,5,5,55,14,5,5,56,13,4,4,57,13,4,4,57,13,4,4,58,13,4,4,58,13,4,4,59,13,4,4,59,17,4,4,60,17,4,4,60,17,4,4,60,17,4,4,61,17,4,4,61,16,4,4,62,16,4,4,63,16,4,4,63,16,8,4,64,16,8,4,64,16,8,4,65,15,8,4,66,15,8,4,66,15,8,4,67,19,8,4,68,19,8,4,68,18,7,4,69,18,7,4,69,18,7,4,69,18,7,4,70,18,7,4,70,18,7,4,71,18,7,4,71,18,7,4,72,17,7,3,73,17,7,3,73,21,7,3,74,21,7,3,74,20,7,3,75,20,7,3,76,20,7,3,76,20,7,3,77,20,7,3,77,20,7,3,78,20,7,3,78,20,7,7,78,19,6,6,79,19,10,6,80,19,10,6,80,22,9,6,81,22,9,6,81,22,9,6,82,22,9,6,83,22,9,6,83,21,9,6,84,21,9,6,84,21,9,6,85,21,9,6,86,21,9,6,86,23,9,6,87,23,9,6,87,23,9,6,87,23,9,6,88,23,9,6,88,23,9,6,89,23,8,6,90,23,8,6,90,22,8,6,91,22,8,6,91,25,8,6,92,25,8,5,93,25,8,5,93,24,8,5,94,24,8,5,94,24,11,5,95,24,11,5,96,24,11,5,96,26,11,5,97,26,11,5,97,26,11,5,97,26,10,5,98,26,10,5,98,26,10,5,99,25,10,5,100,25,10,5,100,25,10,5,101,25,10,5,101,25,10,5,102,27,10,5,103,27,10,5,103,27,10,5,104,27,10,5,104,27,12,5,105,26,12,5,106,26,12,5,106,29,12,5,106,29,12,5,106,29,12,7,107,28,12,7,108,28,12,7,108,28,12,7,109,28,12,7,109,30,12,7,110,30,11,7,111,30,11,7,111,30,11,7,112,30,11,7,112,29,11,7,113,29,11,7,114,29,11,7,114,31,11,7,115,31,11,7,115,31,11,7,115,31,11,7,116,31,11,7,116,33,13,7,117,33,13,9,117,32,13,9,118,32,13,9,118,32,13,9,119,34,15,8,120,34,15,8,120,34,15,8,121,36,15,8,121,36,15,8,122,36,15,8,122,35,15,8,123,37,14,8,124,37,14,8,124,37,14,8,124,37,14,8,124,39,14,8,125,39,16,8,125,38,16,8,126,38,16,8,127,38,16,8,127,40,16,10,128,40,16,10,128,40,16,10,129,42,18,10,129,41,18,10,130,41,18,10,130,43,18,10,131,43,18,10,131,42,17,10,132,42,17,12,132,42,17,12,133,44,17,12,133,44,17,12,133,46,17,11,134,46,17,11,134,45,19,11,135,45,19,11,135,47,19,11,136,47,19,11,136,47,19,11,137,47,19,11,137,48,20,11,138,48,20,11,138,50,20,13,139,50,20,13,139,49,20,13,140,49,22,13,140,51,22,13,141,51,22,13,141,50,22,13,142,52,22,13,142,52,21,12,143,53,21,12,143,53,21,12,143,53,21,12,143,53,21,14,144,53,23,14,144,55,23,14,145,55,23,14,145,56,23,14,146,56,23,14,146,57,24,14,147,57,24,14,147,59,24,16,148,59,24,16,148,58,24,15,149,58,26,15,149,58,26,15,149,60,26,15,150,60,26,15,150,61,25,15,151,61,25,15,151,62,25,17,152,62,25,17,152,64,25,17,152,64,27,17,152,63,27,17,153,63,27,17,153,65,27,17,153,66,28,17,154,66,28,17,154,67,28,16,155,67,28,16,155,67,30,16,155,69,29,18,156,69,29,18,156,68,29,18,157,70,29,18,157,70,29,18,157,71,31,18,158,71,31,18,158,72,30,19,159,72,30,19,159,74,30,19,159,73,30,19,160,73,32,19,160,74,32,19,161,74,32,21,161,76,32,21,161,78,33,21,161,78,33,21,161,79,35,20,162,78,34,20,163,79,34,22,164,81,36,22,164,82,36,22,165,81,35,22,166,82,37,21,167,84,37,21,167,85,36,21,168,86,38,23,169,88,38,23,169,88,38,23,170,88,39,23,170,89,39,24,171,91,40,24,171,92,40,24,172,93,40,24,173,94,41,25,173,95,41,25,174,96,42,25,175,98,42,25,175,99,43,26,176,99,43,26,177,101,45,26,177,102,44,26,178,103,46,27,179,104,46,27,179,105,46,27,179,106,45,28,180,108,47,28,180,108,46,28,181,109,48,28,182,111,48,29,182,111,49,29,183,114,49,29,184,114,50,30,184,114,50,30,185,116,51,30,185,117,51,30,186,119,52,31,187,119,53,31,187,121,53,31,188,122,54,33,188,123,54,32,189,124,55,32,189,125,55,32,189,126,56,34,190,128,56,34,190,128,57,33,191,130,57,33,191,131,58,35,192,131,58,35,192,133,59,34,193,134,60,35,194,135,60,35,194,136,61,37,195,139,61,37,195,139,62,36,196,141,62,36,196,141,63,38,197,142,63,38,197,143,64,39,198,144,64,39,198,146,66,39,198,146,67,39,198,147,67,38,199,147,68,40,199,149,68,40,200,150,69,40,200,152,70,41,201,154,71,41,201,154,71,42,202,155,72,42,202,156,73,41,203,157,73,43,203,158,74,42,204,160,75,44,204,161,76,44,204,162,77,44,205,164,77,45,205,165,78,45,206,166,79,45,206,168,80,46,207,169,81,46,207,170,83,47,207,171,83,47,207,172,83,47,207,174,85,48,208,175,85,48,208,177,85,48,209,178,87,49,209,180,87,49,210,181,87,49,210,182,89,50,210,182,89,50,211,185,91,50,211,186,91,51,212,186,93,51,212,189,94,52,212,190,95,51,213,192,96,51,213,193,96,53,213,194,97,52,214,195,98,54,214,197,98,55,215,198,100,55,215,199,101,55,215,200,102,55,216,202,103,55,216,203,104,55,216,204,105,57,216,205,106,57,216,207,107,58,216,208,108,58,217,209,109,59,217,210,110,60,217,211,111,60,218,212,112,61,218,213,113,61,218,214,114,62,219,217,115,63,219,217,116,64,219,218,118,64,220,219,119,65,220,220,121,66,220,222,121,67,221,222,122,67,221,222,123,68,221,223,124,69,222,224,125,70,222,225,127,71,222,226,128,72,223,228,129,73,223,228,130,74,223,229,132,75,223,230,135,79,224,231,138,81,224,233,141,84,224,233,144,87,225,235,147,91,225,236,150,94,225,237,154,97,225,238,158,102,225,239,161,107,225,239,165,110,225,240,168,114,226,241,172,118,226,241,176,122,226,241,181,126,226,242,183,130,227,243,186,135,227,243,190,139,227,244,194,143,227,244,197,147,228,244,200,150,228,245,204,154,228,245,207,157,228,245,210,161,229,246,212,164,229,246,215,167,229,246,217,169,229,246,220,172,230,247,221,174,230]),uf=128,pT=-Sv,mT=0,X0=50,DZ=()=>1-511/512,OZ=Pf([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);let i2=class extends ea{constructor(e){super(e),this._passParameters=new ey,this._configuration=new pw,this._vao=null,this._fadeVao=null,this._texV1=1;const t=e.view,i=Yt(t.spatialReference),{outerAtmosphereRimWidth:r,radius:s}=i;this._planetRadius=s,this._innerRimFactor=1+pT/s,this._middleRimFactor=1+mT/s,this._outerRimFactor=1+r/s,this._texV0=mT/r,this._texVScale=this._texV1-this._texV0;const n=t.stage.renderView.techniques;n.precompile(Bh,this._configuration),this._configuration.geometry=2,n.precompile(Bh,this._configuration)}initialize(){this.addHandles(M(()=>this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),Ee))}destroy(){this._passParameters.texture=ye(this._passParameters.texture),this._fadeVao=ye(this._fadeVao),this._vao=ye(this._vao)}render(e){const t=e.find(({name:r})=>r===ne.OPAQUE_ENVIRONMENT);this._update();const i=this.renderingContext;if(!this._passParameters.texture){const r=new gt(1,512);r.wrapMode=33071,r.flipped=!0,this._passParameters.texture=new bt(i,r,RZ)}if(this._passParameters.undergroundFadeAlpha<1){this._vao??=this._createRibbon(i),this._configuration.geometry=0;const r=this.techniques.get(Bh,this._configuration);if(!r.compiled)return this.requestRender(1),t;i.bindTechnique(r,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(St.TRIANGLES,0,this._vao.vertexCount("geometry"))}if(this._passParameters.undergroundFadeAlpha>0){this._fadeVao??=Zo(i),this._configuration.geometry=2;const r=this.techniques.get(Bh,this._configuration);if(!r.compiled)return this.requestRender(1),t;i.bindTechnique(r,this.bindParameters,this._passParameters),i.bindVAO(this._fadeVao),i.drawArrays(St.TRIANGLE_STRIP,0,this._fadeVao.vertexCount("geometry"))}return t}_update(){const e=this.bindParameters.camera,t=w(),i=this._planetRadius,r=ge(e.eye),s=r-i;if(s<0){const m=Math.min(-s/5e3,1);this._passParameters.undergroundFadeAlpha=m}else this._passParameters.undergroundFadeAlpha=0;const n=Math.max(X0,s),a=i+pT;this._passParameters.innerScale=EZ(i+n,i,a)-1,this._passParameters.altitudeFade=l4(s),te(t,e.eye,(i+X0)/r),fT(t,e.center,e.up,i,this._passParameters.silhouette);const o=this._computeScreenRimWidth(e,t,e.up,this._passParameters.silhouette),l=DZ(),c=OZ(s);let u=this._texV0+l*this._texVScale,p=this._texV0+o*c*this._texVScale;if(s>X0){fT(e.eye,e.center,e.up,i,this._passParameters.silhouette);const m=this._computeScreenRimWidth(e,e.eye,e.up,this._passParameters.silhouette),f=j((m-1.5)/(o-1.5),0,1);u=this._texV0+f*l*this._texVScale,p=this._texV0+De(this._texV1,o*c,f)*this._texVScale}Ki(this._passParameters.texV,u,p)}_createRibbon(e){const t=c4(3+3*uf*3),i=new Uint32Array(3*uf*5);t[0]=0,t[1]=0,t[2]=-1;for(let n=0;n<uf;n++){const a=9*n+3;t[a]=n,t[a+1]=this._innerRimFactor,t[a+2]=-1,t[a+3]=n,t[a+4]=this._middleRimFactor,t[a+5]=0,t[a+6]=n,t[a+7]=this._outerRimFactor,t[a+8]=1;const o=3*n+1,l=n===uf-1?1:o+3,c=15*n;i[c]=o,i[c+1]=o+1,i[c+2]=l+1,i[c+3]=l+1,i[c+4]=l,i[c+5]=o,i[c+6]=o+1,i[c+7]=o+2,i[c+8]=l+2,i[c+9]=l+2,i[c+10]=l+1,i[c+11]=o+1,i[c+12]=o,i[c+13]=l,i[c+14]=0}const r=Lp.createBuffer(i.length),s=r.position;for(let n=0;n<i.length;++n){const a=3*i[n];s.set(n,0,t[a]),s.set(n,1,t[a+1]),s.set(n,2,t[a+2])}return new Dn(e,new ei(e,Bs(Lp),r.buffer))}_computeScreenRimWidth(e,t,i,r){return ce(Xc,r.center,r.v2),te(df,Xc,this._outerRimFactor),tM(Y0,t,Xc,i),yx(Xc,Y0,e.projectionMatrix,e.viewport,Xc),yx(df,Y0,e.projectionMatrix,e.viewport,df),Gt(Xc,df)/e.height}};function fT(e,t,i,r,s){const n=ge(e),a=r*Math.sqrt(n*n-r*r)/n,o=Math.sqrt(r*r-a*a),l=s.v1,c=s.v2;return te(s.center,e,o/n),ri(l,e,t),Wr(l)<1&&ri(l,e,i),te(l,l,a/ge(l)),ri(c,l,e),te(c,c,a/ge(c)),a}i2=h([D("esri.views.3d.environment.MarsAtmosphere")],i2);const Y0=Le(),Xc=w(),df=w();function EZ(e,t,i){return e*e/(Math.sqrt(e*e-t*t)*Math.sqrt(e*e-i*i)+t*i)}let AZ=class{constructor(e){this._totalCount=e,this._componentCountCache=-1,this._indexRanges=[0,e]}allVisible(){return this.componentCount===this._totalCount}allInvisible(){return this._indexRanges.length===0}isVisible(e){if(e<0||e>=this._totalCount)return!1;if(this.allVisible())return!0;const t=this._indexRanges;let i=0,r=t.length/2;if(e<t[2*i]||e>t[2*r]+t[2*r+1])return!1;for(;r-i>0;){const s=Math.floor(.5*(i+r)),n=t[2*s];if(e<n){if(r-i===1)return!1;r=s;continue}if(e<n+t[2*s+1])return!0;if(r-i===1)return!1;i=s+1}return!1}get componentCount(){if(this._componentCountCache===-1){const e=this._indexRanges;let t=0;for(let i=0;i<e.length;i+=2)t+=e[i+1];this._componentCountCache=t}return this._componentCountCache}reset(e){e==="all"||e.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=IZ(e),this._componentCountCache=-1}forEachComponent(e){const t=this._indexRanges;for(let i=0;i<t.length;i+=2){const r=t[i],s=r+t[i+1];for(let n=r;n<s;n++)if(!e(n))return!1}return!0}forEachComponentRange(e){const t=this._indexRanges;for(let i=0;i<t.length;i+=2){const r=t[i];if(!e(r,r+t[i+1]))return!1}return!0}computeOffsetRanges(e){const t=new Array(this._indexRanges.length),i=this._indexRanges;for(let r=0;r<i.length;r+=2){const s=i[r],n=s+i[r+1],a=e[s],o=e[n];t[r]=a,t[r+1]=o-a}return t}};function IZ(e){const t=new Array;if(e.length===0)return t;let i=e[0],r=1;for(let s=1;s<e.length;s++){const n=e[s];i+r===n?r+=1:(t.push(i),t.push(r),i=n,r=1)}return t.push(i),t.push(r),t}let LZ=class{constructor(e,t){this.offsets=t,this._highlightsInOrder=[],this.pickability=null,this.componentHighlights=new Map,this.verticalOffsets=null,this._cachedGeometryRanges=null,this._cachedHighlightRangesMap=null,this._cachedShadowmapRanges=null;const i=this.count;this.visibility=new AZ(i),this.materialDataBuffer=e.getBuffer(i),this.materialDataIndices=new Uint16Array(i);for(let r=0;r<i;r++)this.materialDataIndices[r]=this.materialDataBuffer.acquireIndex()}destroy(){for(let e=0;e<this.count;e++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[e])}get count(){return this.offsets.length-1}get geometryRanges(){return this._cachedGeometryRanges==null&&(this._cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this._cachedGeometryRanges}get highlightRangesMap(){return this.componentHighlights.size===0?null:(this._updateCachedHighlightRanges(),this._cachedHighlightRangesMap)}get shadowmapRanges(){return this.componentHighlights.size===0?this.geometryRanges:(this._updateCachedHighlightRanges(),this._cachedShadowmapRanges)}markHighlightsDirty(){this._cachedHighlightRangesMap=null,this._cachedShadowmapRanges=null}markVisibilityDirty(){this._cachedGeometryRanges=null,this.markHighlightsDirty()}updateHighlights(e){this._updateHighlightOrder(e)&&(this.markHighlightsDirty(),this._updateCachedHighlightRanges())}_updateHighlightOrder(e){const{_highlightsInOrder:t}=this;let i=t.length!==e.length;t.length=Math.min(e.length,8);for(let r=0;r<e.length;++r){const s=e.at(r).name;t.length<r?(i=!0,t.push(s)):t[r]!==s&&(t[r]=s,i=!0)}return i}_updateCachedHighlightRanges(){if(this._cachedHighlightRangesMap==null||this._cachedShadowmapRanges==null){const{highlightRangesMap:e,shadowmapRangesMap:t}=FZ(this.componentHighlights,this.visibility,this.offsets,this._highlightsInOrder);this._cachedHighlightRangesMap=e,this._cachedShadowmapRanges=t}}};function FZ(e,t,i,r){const s=new Map,n=[];if(e.size>0){let a=i.length;t.forEachComponent(o=>{let l=!1;for(let c=r.length-1;c>=0;--c){const u=r[c];if((e.get(u)?.[o]??0)>0){const p=Fa(s,u,()=>[]),m=i[o],f=i[o+1];p.push(m),p.push(f-m),l||=u===la;break}}return l||(a!==o-1&&(n.length>0&&n.push(i[a+1]-n[n.length-1]),n.push(i[o])),a=o),!0}),n.length>0&&n.push(i[a+1]-n[n.length-1])}return{highlightRangesMap:s,shadowmapRangesMap:n}}let VZ=class{constructor(e,t,i,r,s,n){this.transform=e,this.toMapSpace=t,this.obb=i,this.componentData=r,this.renderable=s,this.intersectionGeometry=n,this.visible=!1,this.offsetObb=null,this._aabbInWorldCoordinates=null}destroy(){this.intersectionGeometry=Z(this.intersectionGeometry),this.renderable=Z(this.renderable),this.componentData=Z(this.componentData)}get aabbInWorldCoordinates(){let e=this._aabbInWorldCoordinates;return e||(e=this._computeAabbInWorldCoordinates(),this._aabbInWorldCoordinates=e),e}_computeAabbInWorldCoordinates(){const e=eo(),{positions:t}=this.intersectionGeometry;if(Math.floor(t.length/3)>0){const{rotationScale:i,position:r}=this.transform;let s=1/0,n=1/0,a=1/0,o=-1/0,l=-1/0,c=-1/0;const u=w();for(let p=0;p<t.length;p+=3)xe(u,t[p+0],t[p+1],t[p+2]),_n(u,u,i),ce(u,u,r),s=Math.min(s,u[0]),n=Math.min(n,u[1]),a=Math.min(a,u[2]),o=Math.max(o,u[0]),l=Math.max(l,u[1]),c=Math.max(c,u[2]);e[0]=s,e[1]=n,e[2]=a,e[3]=o,e[4]=l,e[5]=c}return e}};function zZ(e,t,i,r,s,n,a){const o=n-a,l=t-e,c=new Float64Array(4*l);for(let u=0;u<l;++u){const p=3*(u+e),m=s*i[p+0],f=r[m+0],g=r[m+1],y=o/(r[m+2]-a),v=f*y,C=g*y,b=s*i[p+1],S=r[b+0],x=r[b+1],T=o/(r[b+2]-a),P=S*T,R=x*T,O=s*i[p+2],E=r[O+0],A=r[O+1],F=o/(r[O+2]-a),L=E*F,H=A*F,V=4*u;c[V+0]=Math.min(v,P,L),c[V+1]=Math.min(C,R,H),c[V+2]=Math.max(v,P,L),c[V+3]=Math.max(C,R,H)}return c}function kZ(e,t,i,r,s){const n=t-e,a=new Float64Array(4*n);for(let o=0;o<n;++o){const l=3*(o+e),c=s*i[l+0],u=r[c+0],p=r[c+1],m=s*i[l+1],f=r[m+0],g=r[m+1],y=s*i[l+2],v=r[y+0],C=r[y+1],b=4*o;a[b+0]=Math.min(u,f,v),a[b+1]=Math.min(p,g,C),a[b+2]=Math.max(u,f,v),a[b+3]=Math.max(p,g,C)}return a}function BZ(e,t){return new(NZ(e))(t)}function NZ(e){return e<128?Uint8Array:e<32768?Uint16Array:e<1<<31?Uint32Array:Array}function gT(e,t,i,r){const[s,n,a]=r??e,o=a-i,l=t/Math.sqrt(s*s+n*n+o*o);e[0]+=s*l,e[1]+=n*l,e[2]+=o*l}let NE=class{constructor(e,t){this.elementCount=e,this.model=t,this._elementIndexMap=null,this._bspNodes=[],this._generatedBVH=!1,this.localMode=t.localMode,this.planetCenterZ=t.planetCenterZ,this.geometryMinZ=t.geometryMinZ,this.planetCenter=We(0,0,this.planetCenterZ),this.maxBspNodeDepth=t.maxBspNodeDepth??8,this.minElementCountForBVH=t.minElementCountForBVH??15,this.minBspNodeElementCount=t.minBspNodeElementCount??5}get elementIndexMap(){return this._ensureBVH(),this._elementIndexMap}get _skipBVH(){return this.elementCount<this.minElementCountForBVH||this.geometryMinZ<.5*this.planetCenterZ}_ensureBVH(){this._generatedBVH||this._skipBVH||this._bspNodes.length===0&&this._generateBsp()}intersectRay(e,t,i){this.elementCount<1||(this._skipBVH?this._intersectRayWithoutBVH(i):this._intersectRayWithBVH(e,t,i))}_intersectRayWithoutBVH(e){this._intersectRange(0,this.elementCount)}_intersectRange(e,t){this.model.intersectRange(e,t)}_intersectRayWithBVH(e,t,i){this._ensureBVH(),i?this._intersectGeometryWithBVHVerticalRay(e):this._intersectGeometryWithBVHGeneralRay(e,t)}_intersectGeometryWithBVHVerticalRay(e){let t=e[0],i=e[1];if(!this.localMode){const{geometryMinZ:n,planetCenterZ:a}=this,o=(n-a)/(e[2]-a);t=e[0]*o,i=e[1]*o}const{_bspNodes:r}=this;let s=0;for(;s>=0;){const n=r[s],{d:a,dim:o,minIndexIndex:l,minMidIndexIndex:c,maxMidIndexIndex:u,maxIndexIndex:p,aabb2D:m}=n;if(t<m[0]||t>m[2]||i<m[1]||i>m[3])break;if(o===-1||n.child0===-1&&n.child1===-1){this._intersectRange(l,p);break}{this._intersectRange(c,u);const f=(o===0?t:i)-a;if(f<0){if(n.child0===-1){this._intersectRange(l,c);break}s=n.child0}else{if(!(f>0))break;if(n.child1===-1){this._intersectRange(u,p);break}s=n.child1}}}}_intersectGeometryWithBVHGeneralRay(e,t){let i=e[0],r=e[1],s=t[0],n=t[1];const{geometryMinZ:a}=this;if(!this.localMode){let f=0,g=1;const y=Math.min(.5*this.planetCenterZ,a),v=e[2],C=t[2];if(v<y&&C<y||(v<y&&(f=(y-v)/(C-v)),C<y&&(g=(y-v)/(C-v)),f>g))return;const b=(1-f)*e[0]+f*t[0],S=(1-f)*e[1]+f*t[1],x=(1-f)*e[2]+f*t[2],T=(1-g)*e[0]+g*t[0],P=(1-g)*e[1]+g*t[1],R=(1-g)*e[2]+g*t[2],{planetCenterZ:O}=this,E=a-O,A=E/(x-O);i=b*A,r=S*A;const F=E/(R-O);s=T*F,n=P*F}const o=s-i,l=n-r,c=this._bspNodes;let u=1;{const{aabb2D:f}=c[0],g=(C,b,S,x)=>{if(Math.abs(b)<1e-5*Math.max(x-S,1))return!1;const T=b>0,P=T?x:S,R=C+u*b;return(T?R<P:R>P)&&(u=Math.max((P-C)/b,u),!0)},y=()=>g(i,o,f[0],f[2]),v=()=>g(r,l,f[1],f[3]);Math.abs(o)>=Math.abs(l)?y()||v():v()||y()}const p=[0,0,u];let m=0;for(;m<p.length;){const f=p[m];let g=p[m+1],y=p[m+2];if(m+=3,g>y)continue;const v=c[f],{minIndexIndex:C,maxIndexIndex:b}=v,{child0:S,child1:x,minMidIndexIndex:T,maxMidIndexIndex:P,aabb2D:R,d:O,dim:E}=v;{const A=i+g*o,F=i+y*o,L=Math.min(A,F),H=Math.max(A,F),V=R[0],I=R[2];if(H<V||I<L)continue;if(L<V){const B=(V-i)/o;o>0?g=Math.max(g,B):y=Math.min(y,B)}if(I<H){const B=(I-i)/o;o>0?y=Math.min(y,B):g=Math.max(g,B)}}{const A=r+g*l,F=r+y*l,L=Math.min(A,F),H=Math.max(A,F),V=R[1],I=R[3];if(H<V||I<L)continue;if(L<V){const B=(V-r)/l;l>0?g=Math.max(g,B):y=Math.min(y,B)}if(I<H){const B=(I-r)/l;l>0?y=Math.min(y,B):g=Math.max(g,B)}}if(S===-1&&x===-1)this._intersectRange(C,b);else{const A=E===0?i:r,F=E===0?o:l,L=A+g*F,H=A+y*F,V=Math.min(L,H),I=Math.max(L,H),B=j((O-A)/F,0,u);C<T&&V<=O&&(S!==-1?(p.push(S),p.push(F>=0?g:Math.max(g,B)),p.push(F>=0?Math.min(y,B):y)):this._intersectRange(C,T)),this._intersectRange(T,P),P<b&&O<=I&&(x!==-1?(p.push(x),p.push(F>=0?Math.max(g,B):g),p.push(F>=0?y:Math.min(y,B))):this._intersectRange(P,b))}}}_generateBsp(){const{elementCount:e}=this;if(e<1)return;const t=BZ(e,e);this._elementIndexMap=t;for(let m=0;m<e;++m)t[m]=m;const i=this.model.getAabbs2D();let r=0;const s=this._bspNodes;s.length=0;const{localMode:n}=this;let a=!1;if(!n){const{planetCenterZ:m,geometryMinZ:f}=this;a=m>=0||f<.5*m}const o=[],l=(m,f,g,y,v)=>{o.push(m),o.push(f),o.push(g),o.push(y<0?-1:(v?0:1)+2*y)},{maxBspNodeDepth:c,minBspNodeElementCount:u}=this,p=(m,f,g,y,v)=>{const C=s.length;if(C>0&&(a||g>=c||f-m<u))return;const b=Rt();qZ(b,m,f,t,i);const{d:S,dim:x}=n?jZ(b):UZ(b),{rangeMidStart:T,rangeMidEnd:P}=HZ(m,f,x,S,t,i),R=g===c-1,O=!R&&T>=m+u,E=!R&&f>=P+u;if(O||E||C===0){const A=new GZ(m,T,P,f,x,S,b);if(O&&l(m,T,g+1,C,!0),E&&l(P,f,g+1,C,!1),s.push(A),y!==-1){const F=s[y];v?F.child0=C:F.child1=C}}};for(l(0,e,0,-1,!1);r<o.length;){const m=o[r],f=o[r+1],g=o[r+2],y=o[r+3];r+=4;const v=y>>1;p(m,f,g,v,y-(v<<1)==0)}this._generatedBVH=!0}};function jZ(e){const t=e[0],i=e[1],r=e[2],s=e[3];let n,a;return r-t>=s-i?(a=.5*(t+r),n=0):(a=.5*(i+s),n=1),{d:a,dim:n}}function UZ(e){const t=e[0],i=e[1],r=e[2],s=e[3];let n,a;return r-t>=s-i?(n=0,a=.5*(t+r)):(n=1,a=.5*(i+s)),{dim:n,d:a}}function HZ(e,t,i,r,s,n){let a=e;{let u=t;for(;a<u;){const p=s[a];_T(p,i,r,n)<0?++a:(--u,s[a]=s[u],s[u]=p)}}const o=a;let l=a,c=t;for(;l<c;){const u=s[c-1];_T(u,i,r,n)>0?--c:(s[c-1]=s[l],s[l]=u,++l)}return{rangeMidStart:o,rangeMidEnd:c}}function _T(e,t,i,r){const s=4*e,n=r[s+0+t];return r[s+2+t]<i?-1:n>i?1:0}function qZ(e,t,i,r,s){let n=1/0,a=1/0,o=-1/0,l=-1/0;for(let c=t;c<i;++c){const u=4*r[c];n=Math.min(n,s[u+0]),a=Math.min(a,s[u+1]),o=Math.max(o,s[u+2]),l=Math.max(l,s[u+3])}e[0]=n,e[1]=a,e[2]=o,e[3]=l}let GZ=class{constructor(e,t,i,r,s,n,a){this.minIndexIndex=e,this.minMidIndexIndex=t,this.maxMidIndexIndex=i,this.maxIndexIndex=r,this.dim=s,this.d=n,this.aabb2D=a,this.child0=-1,this.child1=-1}},$Z=class{constructor(e,t,i,r,s,n,a,o,l){this.componentIndex=e,this.vertexData=t,this.vertexStride=i,this.indexData=r,this.startTriangleNumber=s,this.endTriangleNumber=n,this.geometryMinZ=a,this.planetCenterZ=o,this.localMode=l,this.maxBspNodeDepth=8,this.minElementCountForBVH=20,this.minBspNodeElementCount=10,this.rayDirection=w(),this.ray0=w(),this.isVerticalRay=!1,this._triangleHitCallback=yT,this.totalElevationOffset=0,this.normalRequired=!1,this._bvh=new NE(n-s,this)}getAabbs2D(){return this.localMode?kZ(this.startTriangleNumber,this.endTriangleNumber,this.indexData,this.vertexData,this.vertexStride):zZ(this.startTriangleNumber,this.endTriangleNumber,this.indexData,this.vertexData,this.vertexStride,this.geometryMinZ,this.planetCenterZ)}get numTriangles(){return this.endTriangleNumber-this.startTriangleNumber}intersectRay(e,t,i,r,s,n){q(this.ray0,e),ji(this.rayDirection,t,e),this.isVerticalRay=i,this.totalElevationOffset=r,this.normalRequired=n,this._triangleHitCallback=s,this._bvh.intersectRay(e,t,i),this._triangleHitCallback=yT}intersectRange(e,t){const i=this._bvh.elementIndexMap;jE(this.ray0,this.rayDirection,e,t,this.indexData,this.vertexData,this.vertexStride,this.totalElevationOffset,this.planetCenterZ,this.normalRequired,this._triangleHitCallback,i,this.startTriangleNumber)}getTriangleElevationOffset(e){return this.totalElevationOffset}};function jE(e,t,i,r,s,n,a,o,l,c,u,p=null,m=0){o!==0?U8(e,t,i,r,s,n,a,o,l,c,u,p,m):h4(e,t,i,r,s,n,a,c,u,p,m)}function yT(){}function WZ(e,t,i){const r=e.count;if(t>=r)return;e.pickability??=new Uint32Array(0);let s=e.pickability;const n=HE(s),a=t/n|0,o=t-n*a,l=(r-1)/n|0,c=s;if(!(t<c.length*n)&&!i){const u=a+1,p=Math.ceil(c.length*DA),m=l+1;let f=Math.max(u,p);f=Math.min(f,m),e.pickability=s=new Uint32Array(f),s.set(c)}a<s.length&&(s[a]=QZ(s[a],o,!i))}function UE(e,t){if(e==null)return!0;const i=HE(e);return!(t<e.length*i)||ZZ(e,t,i)}function ZZ(e,t,i){const r=t/i|0,s=t-r*i;return!XZ(e[r],s)}function HE(e){return e.BYTES_PER_ELEMENT*8}function QZ(e,t,i){return e&~(1<<t)|(i?1:0)<<t}function XZ(e,t){return!!(e&1<<t)}let YZ=class{constructor(e,t,i,r,s,n,a,o){this.vertexData=e,this.vertexStride=t,this.indexData=i,this._components=r,this._componentAabbs3D=s,this.geometryMinZ=n,this.planetCenterZ=a,this.localMode=o,this.maxBspNodeDepth=6,this.minElementCountForBVH=10,this.minBspNodeElementCount=3,this._ray0=tQ,this._ray1=iQ,this._invDir=w(),this._componentVerticalOffsets=null,this._verticalOffset=null,this._tolerance=0,this._intersectionOptions=rQ,this._callback=vT,this.rayDirectionC=w(),this._componentIndexMap=null,this._bvh=new NE(r.count,this),this.componentIntersectionData=new Array(r.count)}get numComponents(){return this._components.count}get minZGlobal(){return this.geometryMinZ-this.planetCenterZ}getAabbs2D(){return this.localMode?this.getAabbs2DLocal():this.getAabbs2DGlobal()}getAabbs2DGlobal(){const{numComponents:e,planetCenterZ:t,minZGlobal:i}=this,r=zv(4*e),s=this._componentAabbs3D;for(let n=0;n<e;++n){const a=6*n,o=s[a+0],l=s[a+1],c=s[a+2],u=s[a+3],p=s[a+4],m=i/(c-t),f=i/(s[a+5]-t),g=Math.min(o*m,o*f),y=Math.min(l*m,l*f),v=Math.max(u*m,u*f),C=Math.max(p*m,p*f),b=4*n;r[b+0]=g,r[b+1]=y,r[b+2]=v,r[b+3]=C}return r}getAabbs2DLocal(){const{numComponents:e}=this,t=zv(4*e),i=this._componentAabbs3D;for(let r=0;r<e;++r){const s=6*r,n=i[s+0],a=i[s+1],o=i[s+3],l=i[s+4],c=4*r;t[c+0]=n,t[c+1]=a,t[c+2]=o,t[c+3]=l}return t}intersectRay(e,t,i,r,s,n){const{isVerticalRay:a}=i;this._ray0=e,this._ray1=t,this._componentVerticalOffsets=s??null,this._verticalOffset=n??null,this._tolerance=i.tolerance,this._intersectionOptions=i,this._componentIndexMap=this._bvh.elementIndexMap,L8(e,t,this._invDir),this._callback=r,this._bvh.intersectRay(e,t,a),this._callback=vT}intersectRange(e,t){const i=this._componentIndexMap,{pickability:r,visibility:s}=this._components;for(let n=e;n<t;++n){const a=i?i[n]:n;UE(r,a)&&s.isVisible(a)&&this._intersectComponent(a)}}getComponentTriangleCount(e){const t=this._components.offsets,i=t[e]/3;return t[e+1]/3-i}getComponentAabb3D(e,t){const i=this._componentAabbs3D,r=6*e;return t[0]=i[r],t[1]=i[r+1],t[2]=i[r+2],t[3]=i[r+3],t[4]=i[r+4],t[5]=i[r+5],t}_intersectComponent(e){const t=this.getComponentAabb3D(e,KZ);let i=!1;const{localMode:r,_componentVerticalOffsets:s,_verticalOffset:n,_ray0:a,_ray1:o,_invDir:l,planetCenterZ:c,_tolerance:u,rayDirectionC:p,componentIntersectionData:m}=this,{isVerticalRay:f}=this._intersectionOptions,g=this._components.offsets,y=q(JZ,a),v=q(eQ,o),C=s?.[e]??0,b=C+(n?.offset??0);if(b!==0&&(r?(y[2]=a[2]-b,v[2]=o[2]-b,i=!0):(n!=null&&(n.componentOffset=C),f&&(gT(y,-b,c,a),gT(v,-b,c,o),i=!0))),n==null||i||b===0||n.applyToAabb(t),!F8(t,y,l,u))return;ji(p,v,y);const S=g[e]/3,x=g[e+1]/3,T=x-S,P=(L,H,V)=>{this._callback(L,H,e,V)},{vertexData:R,vertexStride:O,indexData:E,_intersectionOptions:A}=this,{normalRequired:F}=A;if(T>sQ){let L=m[e];L==null&&(L=new $Z(e,R,O,E,S,x,this.geometryMinZ,c,r),m[e]=L),L.intersectRay(y,v,f,i?0:b,P,F)}else jE(y,p,S,x,E,R,O,i?0:b,c,F,P)}};const KZ=eo(),JZ=w(),eQ=w(),tQ=w(),iQ=w(),vT=()=>{},rQ=new P2,sQ=40;let nQ=class{constructor(e,t,i,r,s,n){this._componentOffsets=n,this._accelerationData=new wE(i,r,s,new bM(e,3,t))}intersectRay(e,t,i,r){const s=(n,a,o)=>{const l=aQ(this._componentOffsets,a);r(n,a,l,o)};this._accelerationData.intersectRay(e,t,i,s)}};function aQ(e,t){const{length:i}=e;if(i===0||t<e[0])return-1;if(t>e[i-1])return i;let r=0,s=i-1;for(;s-r>1;){const n=Math.round(.5*(r+s));t<=e[n]?s=n:r=n}return r}let oQ=class{constructor(e,t,i,r){this.viewingMode=e,this.positionData=t,this._components=i,this._needsElevationAlignment=r,this.verticalOffset=null,this.componentVerticalOffsets=null,this._planetCenter=w(),this._componentBvh=null,this._aabb=eo(),this._indices=t.indices?aM(t.indices):nM(t.positions.length/3),this._positions=t.positions}destroy(){this._positions=null,this._indices=null,this._perComponentAabbs=null,this._componentBvh=null}getComponentAabb(e,t){const i=this._ensureComponentAabbs(),r=6*e;return t[0]=i[r],t[1]=i[r+1],t[2]=i[r+2],t[3]=i[r+3],t[4]=i[r+4],t[5]=i[r+5],t}getComponentAabbs(){return this._ensureComponentAabbs()}_ensureComponentAabbs(){return this._perComponentAabbs||(this._perComponentAabbs=this._computePerComponentAabbs()),this._perComponentAabbs}getComponentPositions(e,t){t.indices=this._indices,t.data=this._positions,t.stride=3,t.startIndex=this._components.offsets[e],t.endIndex=this._components.offsets[e+1]}intersect(e,t,i,r,s,n,a){this.verticalOffset=i,this.componentVerticalOffsets=r;const{position:o}=s,l=ji(lQ,e,o),c=ji(cQ,t,o),u=$2(hQ,s.rotationScale);_n(l,l,u),_n(c,c,u);const p=Gp(dQ,u);if(this.viewingMode===1){const f=this._planetCenter;za(f,o),_n(f,f,u)}const m=(f,g,y,v)=>{a(y,f,v?_n(uQ,v,p):null,g)};this._intersectComponents(l,c,r,i,m,n)}_computePerComponentAabbs(){const e=this._aabb,t=.5*(e[0]+e[3]),i=.5*(e[1]+e[4]),r=.5*(e[2]+e[5]),s=this._components.count,n=c4(6*s),a=this._indices,o=this._positions,l=this._components.offsets;let c=0,u=1/0,p=1/0,m=1/0,f=-1/0,g=-1/0,y=-1/0;for(let v=0;v<s;v++){const C=l[v],b=l[v+1];let S=1/0,x=1/0,T=1/0,P=-1/0,R=-1/0,O=-1/0;if(C<b)for(let E=C;E<b;E++){const A=3*a[E],F=o[A],L=o[A+1],H=o[A+2];S=Math.min(S,F),x=Math.min(x,L),T=Math.min(T,H),P=Math.max(P,F),R=Math.max(R,L),O=Math.max(O,H)}else S=t,x=i,T=r,P=t,R=i,O=r;n[c++]=S,n[c++]=x,n[c++]=T,n[c++]=P,n[c++]=R,n[c++]=O,u=Math.min(u,S),p=Math.min(p,x),m=Math.min(m,T),f=Math.max(f,P),g=Math.max(g,R),y=Math.max(y,O)}return this._aabb[0]=u,this._aabb[1]=p,this._aabb[2]=m,this._aabb[3]=f,this._aabb[4]=g,this._aabb[5]=y,n}_intersectComponents(e,t,i,r,s,n){let a=this._componentBvh;a==null&&(a=this._needsElevationAlignment?new YZ(this._positions,bT,this._indices,this._components,this._ensureComponentAabbs(),this.geometryMinZ,this.planetCenterZ,this.localMode):new nQ(this._positions,bT,this._indices,0,this.numTriangles,this._components.offsets),this._componentBvh=a),a.intersectRay(e,t,n,s,i??void 0,r??void 0)}get geometryMinZ(){return this._aabb[2]}get planetCenterZ(){return this._planetCenter[2]}get numTriangles(){return this._indices.length/3}get localMode(){return this.viewingMode===2}get positions(){return this._positions}get indices(){return this._indices}get aabb(){return this._ensureComponentAabbs(),this._aabb}};const lQ=w(),cQ=w(),hQ=Rn(),uQ=w(),dQ=Rn(),bT=3;let pQ=class{constructor(e,t,i){this.material=e,this.geometry=t,this.meta=i}destroy(){this.material.dispose(),this.geometry.dispose()}},mQ=class{constructor(e,t,i,r){this.vao=e,this.primitiveType=t,this.parameters=i,this.indexed=r}dispose(){this.vao.dispose()}};function fQ(e,t){const i=new nr,{eye:r,frustum:s,viewForward:n}=e;t.forAll(a=>{const o=a.offsetObb!=null?a.offsetObb:a.obb,l=$e(ji(ls,o.center,r),n),c=o.projectedRadius(n);if(i.within(l-c)&&i.within(l+c))return;const u=bQ(o,s);if(u===-1)return;if(u===0)return ya.far=l+c,ya.near=l-c,void i.union(ya);const p=pf.pushNew();p.near=l-c,p.far=l+c,p.mask=u,p.object=a});for(let a=0;a<pf.length;a++){const o=pf.data[a];i.within(o.near)&&i.within(o.far)||(ya.far=o.far,ya.near=1/0,vQ(o.object.offsetObb!=null?o.object.offsetObb:o.object.obb,r,gQ,l=>{let c=_Q;for(let u=0;u<qE&&l.length>0;u++){if(!(o.mask&1<<u))continue;yQ(s[u],l,c);const p=l;l=c,c=p}for(let u=0;u<l.length;u+=3){xe(Pr,l.data[u],l.data[u+1],l.data[u+2]);const p=$e(ji(Pr,Pr,r),n);ya.near=Math.min(ya.near,p)}})===0&&(ya.near=0),i.union(ya))}return pf.length=0,i}const pf=new jt({allocator:e=>e||{near:1/0,far:-1/0,mask:0,object:null},deallocator:e=>(e.object=null,e)}),ya=new nr,Pr=w(),fl=w(),gQ=new jt({deallocator:null}),_Q=new jt({deallocator:null});function yQ(e,t,i){i.length=0;const r=t.length-3;K0(Pr,t,r);const s=cs(e,Pr);s<=0&&(i.push(Pr[0]),i.push(Pr[1]),i.push(Pr[2]));let n=0,a=s;for(;n<r;n+=3){K0(fl,t,n);const o=cs(e,fl);a*o<0&&(Nt(Pr,fl,Pr,o/(o-a)),Mr(i,Pr)),o<=0&&Mr(i,fl),a=o,q(Pr,fl)}a*s<0&&(K0(fl,t,r),Nt(Pr,fl,Pr,s/(s-a)),Mr(i,Pr))}function K0(e,t,i){return xe(e,t.data[i],t.data[i+1],t.data[i+2])}function Mr(e,t){e.push(t[0]),e.push(t[1]),e.push(t[2])}function vQ(e,t,i,r){ML(xT,e.quaternion),ji(ls,t,e.center),VI(ls,ls,xT);const s=e.halfSize,n=8*((ls[0]<-s[0]?-1:ls[0]>s[0]?1:0)+3*(ls[1]<-s[1]?-1:ls[1]>s[1]?1:0)+9*(ls[2]<-s[2]?-1:ls[2]>s[2]?1:0)+13),a=wT[n];if(a===0)return a;YI(mf,e.quaternion),q2(mf,mf,e.halfSize);const o=(l,c)=>{const u=wT[n+c+1];return xe(l,((1&u)<<1)-1,(2&u)-1,((4&u)>>1)-1),_n(l,l,mf),ce(l,e.center,l)};return i.length=0,Mr(i,o(J0,0)),Mr(i,o(CT,1)),Mr(i,o(ls,2)),Mr(i,o(ST,3)),r(i),a===1||(i.length=0,Mr(i,J0),Mr(i,ST),Mr(i,o(ls,4)),Mr(i,o(TT,5)),r(i),a===2||(i.length=0,Mr(i,J0),Mr(i,TT),Mr(i,o(ls,6)),Mr(i,CT),r(i))),a}const wT=(()=>{const e=new Array(216);let t=0;const i=r=>{for(let s=0;s<r.length;s++)e[t+s]=r[s];t+=8};return i([3,0,6,2,3,1,5,4]),i([2,0,2,3,1,5,4,0]),i([3,1,0,2,3,7,5,4]),i([2,0,1,3,2,6,4,0]),i([1,0,1,3,2,0,0,0]),i([2,1,5,7,3,2,0,0]),i([3,2,0,1,3,7,6,4]),i([2,2,0,1,3,7,6,0]),i([3,3,0,1,5,7,6,2]),i([2,0,1,5,4,6,2,0]),i([1,0,1,5,4,0,0,0]),i([2,1,3,7,5,4,0,0]),i([1,0,2,6,4,0,0,0]),i([0,0,0,0,0,0,0,0]),i([1,1,3,7,5,0,0,0]),i([2,2,3,7,6,4,0,0]),i([1,2,3,7,6,0,0,0]),i([2,3,1,5,7,6,2,0]),i([3,4,0,1,5,7,6,2]),i([2,5,7,6,4,0,1,0]),i([3,5,0,1,3,7,6,4]),i([2,4,5,7,6,2,0,0]),i([1,4,5,7,6,0,0,0]),i([2,5,1,3,7,6,4,0]),i([3,6,0,2,3,7,5,4]),i([2,6,2,3,7,5,4,0]),i([3,7,6,2,3,1,5,4]),e})(),qE=4;function bQ(e,t){let i=0;for(let r=0;r<qE;r++){const s=e.intersectPlane(t[r]);if(s>0)return-1;s===0&&(i|=1<<r)}return i}const mf=Rn(),xT=RL(),ls=w(),J0=w(),CT=w(),ST=w(),TT=w();let wQ=class{constructor(e){this._objects=e}destroy(){this._objects=null}submit(e,t){this._objects.preSubmit(t),this._objects.visibleObjects.forAll(i=>i.renderable.material.submit(e,t,i))}queryDepthRange(e){return this._objects.visibleObjects.length?fQ(e,this._objects.visibleObjects):null}get hasEmissions(){return this._objects.visibleObjects.some(e=>e.renderable.material.hasEmissions)}hasHighlight(e){return this._objects.hasHighlight(e)}},xse=class{constructor(e,t,i,r){this.vertices=e,this.positionData=t,this.indices=i,this.componentOffsets=r}},Cse=class extends Kt{constructor(e,t,i,r,s){super(),this.hasVertexColors=e,this.textureCoordinateType=t,this.hasNormals=i,this.shadeNormals=r,this.applySSAO=s}};function GE(e){const t=Ka().vec3f("position");return e.hasNormals&&t.vec2i16("normalCompressed",{glNormalized:!0}),e.textureCoordinateType===1?t.vec2f("uv0"):e.textureCoordinateType===2&&(t.vec2f("uv0"),t.vec4u16("uvRegion",{glNormalized:!0})),e.hasVertexColors&&t.vec4u8("color",{glNormalized:!0}),t.freeze()}let xQ=class{constructor(){this.externalColor=Vt(),this.externalColorMixMode=1,this.castShadows=!0,this.pickable=!0,this.elevationOffset=0,this.emissiveStrength=CF,this.emissiveSource=0}};function CQ(e){e.vertex.code.add(_`
    vec4 decodeSymbolColor(vec4 symbolColor, out int colorMixMode) {
      float symbolAlpha = 0.0;

      const float maxTint = 85.0;
      const float maxReplace = 170.0;
      const float scaleAlpha = 3.0;

      if (symbolColor.a > maxReplace) {
        colorMixMode = ${_.int(1)};
        symbolAlpha = scaleAlpha * (symbolColor.a - maxReplace);
      } else if (symbolColor.a > maxTint) {
        colorMixMode = ${_.int(3)};
        symbolAlpha = scaleAlpha * (symbolColor.a - maxTint);
      } else if (symbolColor.a > 0.0) {
        colorMixMode = ${_.int(4)};
        symbolAlpha = scaleAlpha * symbolColor.a;
      } else {
        colorMixMode = ${_.int(1)};
        symbolAlpha = 0.0;
      }

      return vec4(symbolColor.r, symbolColor.g, symbolColor.b, symbolAlpha);
    }
  `)}let SQ=class extends ha{constructor(e,t){super(e,"int",2,(i,r,s)=>i.setUniform1i(e,t(r,s)))}};const $E=429496.7296;function TQ(e,t){KL(e/$E*.5+.5,t)}const WE=1e6;function PQ(e,t){rF(e/WE*.5+.5,t)}function ZE(){return 3+(Io()?1:0)}function MQ(e,t){switch(t.componentData){case 1:return RQ(e,t);case 0:return DQ(e,t);case 2:return;default:na(t.componentData)}}function RQ(e,t){const{vertex:i,fragment:r}=e;i.include(zE),i.uniforms.add(new tb("componentColorTex",o=>o.componentParameters.texture.texture)),e.attributes.add("componentIndex","float"),e.varyings.add("vExternalColorMixMode","mediump float"),e.varyings.add("vExternalColor","vec4");const{output:s}=t,n=s===10;n&&e.varyings.add("vObjectAndLayerIdColor","vec4");const a=s===1;a&&(e.varyings.add("emissiveStrength","float"),e.varyings.add("emissiveSource","int")),e.include(CQ),i.constants.add("stride","float",ZE()),i.code.add(_`vec2 getComponentTextureCoordinates(float componentIndex, float typeOffset) {
float index = componentIndex * stride + typeOffset;
float texSize = float(textureSize(componentColorTex, 0).x);
float coordX = mod(index, texSize);
float coordY = floor(index / texSize);
return vec2(coordX, coordY) + 0.5;
}`),i.code.add(_`
  vec4 _readComponentColor() {
    vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 0.0);
    return texelFetch(componentColorTex, ivec2(textureCoordinates), 0);
   }

  float readElevationOffset() {
    vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 1.0);
    vec4 encodedElevation = texelFetch(componentColorTex, ivec2(textureCoordinates), 0);
    return uninterpolatedRGBAToFloat(encodedElevation) * ${_.float($E)};
  }

  void forwardEmissiveStrength() {
    ${X(a,_`vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 2.0);
           vec4 encodedEmissive = texelFetch(componentColorTex, ivec2(textureCoordinates), 0);
           emissiveStrength = uninterpolatedRGBToFloat(encodedEmissive.rgb) * ${_.float(WE)};
           emissiveSource = encodedEmissive.a == 0.0 ? 0 : 1;`)}
  }

  void forwardObjectAndLayerIdColor() {
    ${X(n,_`vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 3.0);
           vObjectAndLayerIdColor = texelFetch(componentColorTex, ivec2(textureCoordinates), 0);`)}
  }

  vec4 forwardExternalColor(out bool castShadows) {
    vec4 componentColor = _readComponentColor() * 255.0;

    float shadowFlag = mod(componentColor.b * 255.0, 2.0);
    componentColor.b -= shadowFlag;
    castShadows = shadowFlag >= 1.0;

    int decodedColorMixMode;
    vExternalColor = decodeSymbolColor(componentColor, decodedColorMixMode) * 0.003921568627451; // = 1/255;
    vExternalColorMixMode = float(decodedColorMixMode) + 0.5; // add 0.5 to avoid interpolation artifacts

    return vExternalColor;
  }
`),r.code.add(_`
  void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {
    externalColor = vExternalColor;
    externalColorMixMode = int(vExternalColorMixMode);
  }

  void outputObjectAndLayerIdColor() {
     ${n?_`fragColor = vObjectAndLayerIdColor;`:""}
  }
`)}function DQ(e,t){const{vertex:i,fragment:r}=e;e.varyings.add("vExternalColor","vec4"),r.uniforms.add(new xM("emissiveStrength",n=>n.componentParameters.emissiveStrength)),i.uniforms.add(new zg("externalColor",n=>n.componentParameters.externalColor)).code.add(_`float readElevationOffset() {
return 0.0;
}
void forwardObjectAndLayerIdColor() {}
void forwardEmissiveStrength() {}
vec4 forwardExternalColor(out bool castShadows) {
vExternalColor = externalColor;
castShadows = true;
return externalColor;
}`);const s=t.output===10;r.uniforms.add(new SQ("externalColorMixMode",n=>n.componentParameters.externalColorMixMode)).code.add(_`
    void readExternalColor(out vec4 color, out int colorMixMode) {
      color = vExternalColor;
      colorMixMode = externalColorMixMode;
    }

    void outputObjectAndLayerIdColor() {
      ${X(s,"fragColor = vec4(0, 0, 0, 0);")}
    }
  `)}function PT(e,t){const i=e.fragment;switch(t.doubleSidedMode){case 0:i.code.add(_`vec3 _adjustDoublesided(vec3 normal) {
return normal;
}`);break;case 1:e.include(Sf,t),i.code.add(_`vec3 _adjustDoublesided(vec3 normal) {
return dot(normal, vPositionWorldCameraRelative) > 0.0 ? -normal : normal;
}`);break;case 2:i.code.add(_`vec3 _adjustDoublesided(vec3 normal) {
return gl_FrontFacing ? normal : -normal;
}`);break;default:na(t.doubleSidedMode);case 3:}switch(t.normalType){case 0:case 1:e.include(g4,t),i.main.add(_`vec3 fragmentFaceNormal = _adjustDoublesided(normalize(vNormalWorld));
vec3 fragmentFaceNormalView = gl_FrontFacing ? normalize(vNormalView) : -normalize(vNormalView);`);break;case 2:e.include(Sf,t),i.main.add(_`vec3 fragmentFaceNormal = normalize(cross(dFdx(vPositionWorldCameraRelative), dFdy(vPositionWorldCameraRelative)));
vec3 fragmentFaceNormalView = normalize(cross(dFdx(vPosition_view), dFdy(vPosition_view)));`)}t.shadeNormals?i.main.add(_`vec3 fragmentShadingNormal = fragmentFaceNormal;`):t.spherical?(e.include(Sf,t),i.main.add(_`vec3 fragmentShadingNormal = normalize(positionWorld());`)):i.main.add(_`vec3 fragmentShadingNormal = vec3(0.0, 0.0, 1.0);`)}function OQ(e,t){e.include(_4,t),e.fragment.include(t9);const i=e.fragment;i.uniforms.add(new zg("baseColor",r=>r.baseColor)),i.uniforms.add(new xM("objectOpacity",r=>r.objectOpacity)),t.hasVertexColors?i.code.add(_`vec3 _baseColor() {
return baseColor.rgb * vColor.rgb;
}
float _baseOpacity() {
return baseColor.a * vColor.a;
}`):i.code.add(_`vec3 _baseColor() {
return baseColor.rgb;
}
float _baseOpacity() {
return baseColor.a;
}`),i.code.add(_`vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {
vec3 baseColor = _baseColor();
float baseOpacity = _baseOpacity();
vec3 color = mixExternalColor(
baseColor,
textureColor.rgb,
externalColor.rgb,
externalColorMixMode
);
float opacity = objectOpacity * mixExternalOpacity(
baseOpacity,
textureColor.a,
externalColor.a,
externalColorMixMode
);
return vec4(color, opacity);
}`)}function EQ(e,t){const i=t.hasColorTexture&&(or(t.output)||t.alphaDiscardMode!==1);i&&(e.include(TF,t),e.fragment.uniforms.add(new tb("baseColorTexture",r=>r.texture))),e.fragment.code.add(_`
    vec4 readBaseColorTexture() {
      return ${i?"textureLookup(baseColorTexture, vuv0)":"vec4(1.0)"};
    }
  `)}function AQ(e,t){e.fragment.uniforms.add(new M_("heightParameters",i=>{const r=i.camera,s=Wr(r.eye),n=Math.sqrt(s),a=t.radius,o=s-a*a;let l=Jh(4e6,5e6,n-a);return l=Math.min(l,.98),Mi(l,o,0,0)}),new Pn("cameraPosition",i=>i.camera.eye)),e.fragment.include(Wp),e.fragment.code.add(_`float sphereFade() {return heightParameters[0];}
float sphereDepthInterpolate(vec3 worldRay, vec3 viewRay, float currentLinearDepth) {
vec2 rayPlanetIntersect = sphereIntersect(cameraPosition, worldRay, heightParameters[1]);
bool hitsPlanet = (rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.x > 0.0;
if (hitsPlanet) {
float sphereDepth = rayPlanetIntersect.x;
viewRay *= viewRay.z*sphereDepth;
float linearDepth = length(viewRay);
float sphereFade = heightParameters[0];
return (-linearDepth)*sphereFade + currentLinearDepth*(1.0-sphereFade);
}
return currentLinearDepth;
}`)}function QE(e){const t=new ut,{vertex:i,fragment:r}=t;t.include(Sf,e),t.include(g4,e),t.include(_4,e),t.include(wM,e),t.include(MQ,e),t.include(Z8,e),r.include(Q8,e),t.include(EQ,e),t.include(r4,e);const{output:s,pbrMode:n,hasNormalTexture:a,snowCover:o,receiveShadows:l,shadeNormals:c,spherical:u,ellipsoidMode:p,overlayEnabled:m,componentData:f,vertexDiscardMode:g,renderOccluded:y}=e,v=n===1||n===2;v&&(t.include(X8,e),a&&t.include(Y8,e));const C=s===4||s===5||s===6,b=C&&f===1,S=p===1,x=p===1?Li.radius:S?d9.radius:p9.radius;m&&(t.include(Ag,e),t.include(NW,e),i.code.add(`
      ${X(u,`const float invRadius = ${_.float(1/x)};`)}
      vec2 projectOverlay(vec3 pos) { return pos.xy ${X(u,"/ (1.0 + invRadius * pos.z);")}; }`));const T=m&&or(s)&&n===4;T&&(t.varyings.add("tbnTangent","vec3"),t.varyings.add("tbnBiTangent","vec3"),t.varyings.add("groundNormal","vec3"));const P=g===0,R=g===2,O=1-1/255;if(t.include(K8,e),t.include(J8,e),i.main.add(_`
    bool castShadows;
    vec4 externalColor = forwardExternalColor(castShadows);
    ${X(b,"if(!castShadows) { gl_Position = vec4(vec3(1e38), 1.0); return; }")}

    ${X(!P,`{ if (externalColor.a ${R?">":"<="} ${_.float(O)}) { gl_Position = vec4(vec3(1e38), 1.0); return; } }`)}

    ${X(s===10,"externalColor.a = 1.0;")}

    forwardPosition(readElevationOffset());
    forwardViewPosDepth(vPosition_view);
    forwardNormal();
    forwardTextureCoordinates();
    forwardVertexColor();
    forwardLinearDepthToReadShadowMap();
    forwardLinearDepthToWriteShadowMap();
    forwardEmissiveStrength();
    forwardObjectAndLayerIdColor();
    ${X(T,u?_`
            groundNormal = normalize(positionWorld());
            tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));
            tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`:_`
            groundNormal = vec3(0.0, 0.0, 1.0);
            tbnTangent = vec3(1.0, 0.0, 0.0);
            tbnBiTangent = vec3(0.0, 1.0, 0.0);`)}
    ${X(m,"setOverlayVTC(projectOverlay(position));")}

    if (externalColor.a < ${_.float(Or)}) {
      // Discard this vertex
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
      return;
    }
  `),or(s))return t.include(OQ,e),t.include(PT,e),t.include(Ag,e),t.include(a4,e),r.include(e9,e),r.code.add(_`
      float evaluateShadow() {
        return ${l?"readShadowMap(vPositionWorldCameraRelative, linearDepth)":"0.0"};
      }`),r.main.add(_`
      discardBySlice(vPositionWorldCameraRelative);
      discardByTerrainDepth();

      vec4 textureColor = readBaseColorTexture();
      discardOrAdjustAlpha(textureColor);

      /* When rendering the occluded overlay, we still need to read the base color texture
       * because we need to use the same discard logic. However after that to render only the
       * draped overlay, we simply set the base texture color to zero. */
      ${X(y,_`textureColor = vec4(0);`)}

      ${X(m,_`vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);`)}

      /* Early discard to only emit when we have overlay */
      ${X(m&&y,_`if (overlayColor.a < ${_.float(Or)}) { discard; }`)}

      vec4 externalColor;
      int externalColorMixMode;
      readExternalColor(externalColor, externalColorMixMode);

      vec4 materialColor = computeMaterialColor(textureColor, externalColor, externalColorMixMode);
    `),v?(T_(r),u&&Tv(r),r.main.add(_`
        applyPBRFactors();
        ${X(n===1,_`if (externalColorMixMode == 3) {
              mrr = vec3(0.0, 0.6, 0.2);
            }`)}
        float additionalIrradiance = 0.02 * mainLightIntensity[2];
        ${X(a,"mat3 tangentSpace = computeTangentSpace(fragmentFaceNormal, vPositionWorldCameraRelative, vuv0);")}
        vec3 shadingNormal = ${a?"computeTextureNormal(tangentSpace, vuv0)":"fragmentShadingNormal"};
        vec3 groundNormal = ${u?_`normalize(positionWorld())`:_`vec3(0.0, 0.0, 1.0)`};

        vec3 viewDir = normalize(vPositionWorldCameraRelative);
        float ssao = 1.0 - occlusion * evaluateAmbientOcclusionInverse();
        ${X(o,_`float snow = getSnow(fragmentFaceNormal, normalize(positionWorld()));
                 materialColor.rgb = mix(materialColor.rgb, vec3(1.1), snow);
                 ssao = mix(ssao, 0.5 * ssao, snow);
                 shadingNormal = mix(shadingNormal, fragmentFaceNormal, snow);`)}
        ${X(m,"materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;")}

        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());
        ${X(u,"float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());")}
        ${u?_`float shadow = max(lightingGlobalFactor * (1.0 - additionalAmbientScale), evaluateShadow());`:"float shadow = evaluateShadow();"}
        vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, shadow, ssao, additionalLight, viewDir, groundNormal, mrr, additionalIrradiance), materialColor.a);
        `)):(cc(r),u&&Tv(r),T&&r.uniforms.add(new gs("ovNormalTex",H=>H.overlay?.getTexture(3))),r.main.add(_`
        ${X(u,"float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());")}
        float shadow = ${l?u?"max(lightingGlobalFactor * (1.0 - additionalAmbientScale), evaluateShadow())":"evaluateShadow()":u?"lightingGlobalFactor * (1.0 - additionalAmbientScale)":"0.0"};

        ${X(l&&!c,_`
            float dotFL = dot(fragmentFaceNormal, mainLightDirection);
            if( dotFL <= 0.0) shadow = 1.0;
        `)}
        ${X(o,_`float snow = getSnow(fragmentFaceNormal, normalize(positionWorld()));
               materialColor.rgb = mix(materialColor.rgb, vec3(1), snow);`)}

        // At global scale we create some additional ambient light based on the main light to simulate global illumination
        float ssao = evaluateAmbientOcclusion();
        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());

        ${X(m,"materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;")}

        vec4 shadedColor = vec4(evaluateSceneLighting(fragmentShadingNormal, materialColor.rgb, shadow, ssao, additionalLight), materialColor.a);
        ${X(T,_`vec4 overlayWaterMask = getOverlayColor(ovNormalTex, vtcOverlay);
                 float waterNormalLength = length(overlayWaterMask);
                 if (waterNormalLength > 0.95) {
                   mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);
                   vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, overlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, vPosition_view, positionWorld());
                   vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                   // un-gamma the ground color to mix in linear space
                   shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);
                 }`)}
      `)),r.main.add(`outputColorHighlightOID(shadedColor, vPositionWorldCameraRelative, materialColor.rgb ${X(o,", snow")});`),e.sphereDepthInterpolate&&(t.include(AQ,{radius:x*T4}),t.fragment.include(Xa),r.main.add(_`if (sphereFade()>0.0) {
vec3 worldRay = normalize(vPositionWorldCameraRelative);
vec3 viewRay = normalize(vPosition_view);
gl_FragDepth = delinearizeDepth(sphereDepthInterpolate(worldRay, viewRay, linearizeDepth(gl_FragCoord.z)));
} else {
gl_FragDepth = gl_FragCoord.z;
}`)),t;const E=s===3,A=s===10,F=s===9,L=C||s===7||s===8;return L&&t.include(d4,e),E&&t.include(PT,e),m&&t.include(SE,e),t.include(O2,e),r.main.add(_`
    discardBySlice(vPositionWorldCameraRelative);

    vec4 textureColor = readBaseColorTexture();
    discardOrAdjustAlpha(textureColor);

    ${X(L,"outputDepth(linearDepth);")}
    ${X(E,_`fragColor = vec4(vec3(0.5) + 0.5 * fragmentFaceNormalView, 1.0);`)}
    ${X(A,m?"fragColor = getOverlayColorTexel();":"outputObjectAndLayerIdColor();")}
    ${X(F,X(m,_`calculateOcclusionAndOutputHighlight(getAllOverlayHighlightValuesEncoded());`,_`calculateOcclusionAndOutputHighlight();`))}`),t}const IQ=Object.freeze(Object.defineProperty({__proto__:null,build:QE},Symbol.toStringTag,{value:"Module"}));let LQ=class extends ct{constructor(e,t){super(e,t,new ht(IQ,()=>k(()=>Promise.resolve().then(()=>pee),void 0)),fL([Bs(GE(t)),XE]))}initializePipeline(e){const{integratedMeshMode:t,output:i,blendingEnabled:r,cullFace:s,hasOccludees:n,hasPolygonOffset:a,oitPass:o,renderOccluded:l}=e,c=t!==0,u=o===0,p=o===2;return Ge({blending:l?fu:or(i)&&r?JP(o):null,culling:z8(s),depthTest:l?null:{func:KP(o)},depthWrite:l||!u&&!p?null:T2,drawBuffers:Sh(i,Gd(o,i)),colorWrite:st,stencilWrite:!l&&c||n?Cv:null,stencilTest:c?V8(1):n?YP:null,polygonOffset:u||p?a?{factor:2,units:2}:null:XP})}};const XE=Bs(Ka().u16("componentIndex"));let it=class extends hr{constructor(e){super(),this.spherical=e,this.output=0,this.textureCoordinateType=0,this.componentData=0,this.cullFace=2,this.vertexDiscardMode=0,this.doubleSidedMode=2,this.alphaDiscardMode=1,this.integratedMeshMode=0,this.oitPass=0,this.ellipsoidMode=1,this.pbrMode=0,this.normalType=0,this.emissionSource=0,this.hasVertexColors=!1,this.hasNormals=!1,this.shadeNormals=!0,this.hasSlicePlane=!1,this.hasColorTexture=!1,this.hasHighlightMixTexture=!1,this.receiveAmbientOcclusion=!0,this.receiveShadows=!0,this.blendingEnabled=!0,this.screenSpaceReflections=!1,this.hasPolygonOffset=!1,this.hasMetallicRoughnessTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.hasNormalTextureTransform=!1,this.cloudReflections=!0,this.snowCover=!1,this.olidColor=!1,this.renderOccluded=!1,this.sphereDepthInterpolate=!1,this.discardInvisibleFragments=!1,this.occlusionPass=!1,this.bindType=2,this.useCustomDTRExponentForWater=!1,this.hasVertexTangents=!1,this.highStepCount=!1,this.instanced=!1,this.instancedDoublePrecision=!1,this.hasModelTransformation=!1,this.useFillLights=!0,this.draped=!1}get overlayEnabled(){return(this.integratedMeshMode===2||this.integratedMeshMode===3)&&SF(this.output)}};h([z({count:11})],it.prototype,"output",void 0),h([z({count:3})],it.prototype,"textureCoordinateType",void 0),h([z({count:2})],it.prototype,"componentData",void 0),h([z({count:3})],it.prototype,"cullFace",void 0),h([z({count:3})],it.prototype,"vertexDiscardMode",void 0),h([z({count:3})],it.prototype,"doubleSidedMode",void 0),h([z({count:4})],it.prototype,"alphaDiscardMode",void 0),h([z({count:4})],it.prototype,"integratedMeshMode",void 0),h([z({count:3})],it.prototype,"oitPass",void 0),h([z({count:4})],it.prototype,"ellipsoidMode",void 0),h([z({count:7})],it.prototype,"pbrMode",void 0),h([z({count:3})],it.prototype,"normalType",void 0),h([z({count:8})],it.prototype,"emissionSource",void 0),h([z()],it.prototype,"hasVertexColors",void 0),h([z()],it.prototype,"hasNormals",void 0),h([z()],it.prototype,"shadeNormals",void 0),h([z()],it.prototype,"hasSlicePlane",void 0),h([z()],it.prototype,"hasColorTexture",void 0),h([z()],it.prototype,"hasHighlightMixTexture",void 0),h([z()],it.prototype,"receiveAmbientOcclusion",void 0),h([z()],it.prototype,"receiveShadows",void 0),h([z()],it.prototype,"blendingEnabled",void 0),h([z()],it.prototype,"screenSpaceReflections",void 0),h([z()],it.prototype,"hasPolygonOffset",void 0),h([z()],it.prototype,"hasMetallicRoughnessTexture",void 0),h([z()],it.prototype,"hasOcclusionTexture",void 0),h([z()],it.prototype,"hasNormalTexture",void 0),h([z()],it.prototype,"hasOccludees",void 0),h([z()],it.prototype,"terrainDepthTest",void 0),h([z()],it.prototype,"cullAboveTerrain",void 0),h([z()],it.prototype,"hasNormalTextureTransform",void 0),h([z()],it.prototype,"cloudReflections",void 0),h([z()],it.prototype,"snowCover",void 0),h([z()],it.prototype,"olidColor",void 0),h([z()],it.prototype,"renderOccluded",void 0),h([z()],it.prototype,"sphereDepthInterpolate",void 0);let FQ=class extends Kt{constructor(){super(...arguments),this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){if(this._dirty=!1,this._parameterBlocks!=null)for(const e of this._parameterBlocks)this[e]._setClean()}get dirty(){return this._dirty||this._checkParameterBlocksDirty()}_checkParameterBlocksDirty(){if(this._parameterBlocks==null)return!1;for(const e of this._parameterBlocks)if(this[e].dirty)return!0;return!1}},mw=class{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){this._dirty=!1}get dirty(){return this._dirty}};function Ct(e={}){return(t,i)=>{const r=t._parameterCount??0;if(t._parameterCount=r+1,e.vectorOps){const s=e.vectorOps;Object.defineProperty(t,i,{get(){return this[r]},set(n){const a=this[r];if(a==null)this[r]=Array.from(n);else{if(s.equals(a,n))return;s.copy(a,n)}this._setDirty()}})}else Object.defineProperty(t,i,{get(){return this[r]},set(s){this[r]!==s&&(e.dispose&&this[r]&&this[r].dispose(),this[r]=s,this._setDirty())}})}}function MT(){return(e,t)=>{const i=e._parameterCount??0;e._parameterCount=i+1,e._parameterBlocks=e._parameterBlocks||[],e._parameterBlocks.push(i),Object.defineProperty(e,t,{get(){return this[i]},set(r){this[i]!==r&&(this[i]=r,this._setDirty())}})}}let YE=class{constructor(e){this._low=w(),this._high=w(),e&&this.set(e)}get low(){return this._low}get high(){return this._high}set(e){q(this._low,q(RT,e));const t=ji(RT,e,this._low);q(this._high,t)}get(e){return ce(e,this._low,this._high)}getLowScaled(e){return te(e,this._low,1)}};const RT=oL();let ci=class extends FQ{constructor(e,t){super(),this.toMapSpace=t,this.baseColor=FL(1,1,1,1),this.usePBR=!1,this.hasParametersFromSource=!1,this.sphereDepthInterpolate=!1,this.mrrFactors=v8,this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.normalTexture=null,this.occlusionTexture=null,this.emissionTexture=null,this.emissiveBaseColor=b9(0,0,0),this.emissiveStrength=0,this.commonMaterialParameters=new _g,this.componentParameters=new kl,this.objectOpacity=1,this.textureAlphaCutoff=Or,this.alphaDiscardMode=1,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=1,this.hasOccludees=!1;const i=new YE(e.position),r=ZI(e.rotationScale);$2(r,r),Gp(r,r),this.transformNormalGlobalFromModel=r,this.transformWorldFromModelTL=i.low,this.transformWorldFromModelTH=i.high,this.transformWorldFromModelRS=e.rotationScale}dispose(){this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}get _hasEmissiveBase(){return this.emissionTexture!=null||!Go(this.emissiveBaseColor,ia)}get _hasEmissiveStrength(){return this.componentParameters.emissiveOverride!==2}get hasEmissions(){return this._hasEmissiveStrength&&(this._hasEmissiveBase||this.componentParameters.emissiveSourceOverride!==2)}get texture(){return this.baseColorTexture?.glTexture}get textureMetallicRoughness(){return this.metallicRoughnessTexture?.glTexture}get textureEmissive(){return this.emissionTexture?.glTexture}get textureOcclusion(){return this.occlusionTexture?.glTexture}get textureNormal(){return this.normalTexture?.glTexture}acquireTechnique(e,t,i,r){const s=new it(e.context.spherical);s.renderOccluded=i.slot===9,s.hasVertexColors=r.hasVertexColors,s.hasNormals=r.hasNormals,s.textureCoordinateType=r.textureCoordinateType,s.hasMetallicRoughnessTexture=this.metallicRoughnessTexture!=null,s.hasOcclusionTexture=this.occlusionTexture!=null,s.hasNormalTexture=this.normalTexture!=null,s.sphereDepthInterpolate=this.sphereDepthInterpolate&&e.viewingMode===1,s.oitPass=t.identifier===0&&i.oitPass!=null?i.oitPass:0,s.terrainDepthTest=t.identifier===0&&i.terrainDepthTest,s.cullAboveTerrain=t.identifier===0&&i.cullAboveTerrain,s.ellipsoidMode=this.ellipsoidMode,s.componentData=this.componentParameters.type,s.cullFace=this.commonMaterialParameters.cullFace,s.doubleSidedMode=this.commonMaterialParameters.doubleSided?1:0,s.hasColorTexture=this.baseColorTexture!=null;const n=this._computeWhichMaterialPass();s.blendingEnabled=n===1||n===2,s.alphaDiscardMode=this.alphaDiscardMode,s.integratedMeshMode=this.isIntegratedMesh?kQ(i)?zQ(i)?3:2:1:0,s.hasPolygonOffset=this.polygonOffsetEnabled,s.pbrMode=s.integratedMeshMode===3?4:this.usePBR?this.hasParametersFromSource?r.shadeNormals&&this.isIntegratedMesh?0:2:1:0;const a=this.componentParameters.emissiveSourceOverride===1,o=this.componentParameters.emissiveSourceOverride===2,l=this.emissionTexture!=null;if(s.emissionSource=this.hasEmissions?this._hasEmissiveBase&&s.pbrMode===1?o?l?4:2:a?l?5:7:6:a?7:6:0,s.shadeNormals=r.shadeNormals,s.normalType=s.hasNormals?1:2,s.hasSlicePlane=i.slicePlane!=null&&this.commonMaterialParameters.hasSlicePlane,s.receiveAmbientOcclusion=s.hasOccludees=s.receiveShadows=s.screenSpaceReflections=s.cloudReflections=s.hasHighlightMixTexture=!1,t.identifier===1)s.output=4,s.vertexDiscardMode=0;else if(t.identifier===3)s.output=7,s.vertexDiscardMode=0;else if(t.identifier===2)s.output=9,s.vertexDiscardMode=0,s.hasHighlightMixTexture=i.highlightMixTexture!=null;else{switch(s.vertexDiscardMode=n===2?t.transparent?2:1:0,s.output=t.output,t.output){case 0:case 1:s.receiveAmbientOcclusion=r.applySSAO&&i.ssao?.getTexture()!=null,s.hasOccludees=i.hasOccludees,s.receiveShadows=i.shadowMap.ready,s.screenSpaceReflections=i.ssr.lastFrameColor!=null,s.cloudReflections=i.clouds.data?.cubeMap?.colorTexture!=null;break;case 10:s.olidColor=!0}s.snowCover=i.snowCover>0}const c=e.get(LQ,s);return this._setClean(),c}submit(e,t,i){if(this.objectOpacity<=0)return;const{componentData:r,renderable:s}=i,{geometry:n}=s,a=s.meta.cameraDepthSquared;r.updateHighlights(t.highlights);const{geometryRanges:o,highlightRangesMap:l,shadowmapRanges:c}=r;switch(this._computeWhichMaterialPass()){case 0:e.opaque.submitDraw(this,n,o,a);break;case 1:e.transparent.submitDraw(this,n,o,a);break;case 2:e.opaque.submitDraw(this,n,o,a),e.transparent.submitDraw(this,n,o,a);break;case 3:e.integratedMesh.submitDraw(this,n,o,a),BQ(t)&&e.occludedGround.submitDraw(this,n,o,a),VQ(t)&&e.highlightIntegratedMesh.submitDraw(this,n,o,a);break;case 4:e.transparentIntegratedMesh.submitDraw(this,n,o,a)}if(this.componentParameters.castShadows!==2){if(l!=null)for(const u of l)u[0]===la&&e.highlightShadowMap.submitDraw(this,n,u[1],a,u[0]);c!=null&&e.defaultShadowMap.submitDraw(this,n,c,a),e.shadowMap.submitDraw(this,n,o,a)}if(l!=null)for(const u of l)e.highlight.submitDraw(this,n,u[1],a,u[0]);t.viewshedEnabled&&e.viewshedShadowMap.submitDraw(this,n,o,a)}_computeWhichMaterialPass(){if(this.isIntegratedMesh&&this.objectOpacity>=1)return 3;if(this.isIntegratedMesh&&this.objectOpacity<1)return 4;if(this.objectOpacity<1)return 1;if(this.componentParameters.opaqueOverride===0)return 0;if(this.baseColor[3]<1||this.alphaDiscardMode===0||this.alphaDiscardMode===3)return 1;switch(this.componentParameters.transparent){case 2:return 0;case 0:return 1;case 1:return 2}}};h([Ct({vectorOps:cM})],ci.prototype,"baseColor",void 0),h([Ct()],ci.prototype,"usePBR",void 0),h([Ct()],ci.prototype,"hasParametersFromSource",void 0),h([Ct()],ci.prototype,"sphereDepthInterpolate",void 0),h([Ct({vectorOps:lx})],ci.prototype,"mrrFactors",void 0),h([Ct({dispose:!0})],ci.prototype,"baseColorTexture",void 0),h([Ct({dispose:!0})],ci.prototype,"metallicRoughnessTexture",void 0),h([Ct({dispose:!0})],ci.prototype,"normalTexture",void 0),h([Ct({dispose:!0})],ci.prototype,"occlusionTexture",void 0),h([Ct({dispose:!0})],ci.prototype,"emissionTexture",void 0),h([Ct({vectorOps:lx})],ci.prototype,"emissiveBaseColor",void 0),h([Ct()],ci.prototype,"emissiveStrength",void 0),h([MT()],ci.prototype,"commonMaterialParameters",void 0),h([MT()],ci.prototype,"componentParameters",void 0),h([Ct()],ci.prototype,"objectOpacity",void 0),h([Ct()],ci.prototype,"textureAlphaCutoff",void 0),h([Ct()],ci.prototype,"alphaDiscardMode",void 0),h([Ct()],ci.prototype,"isIntegratedMesh",void 0),h([Ct()],ci.prototype,"polygonOffsetEnabled",void 0),h([Ct()],ci.prototype,"ellipsoidMode",void 0),h([Ct()],ci.prototype,"hasOccludees",void 0);let _g=class extends mw{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=2,this.hasSlicePlane=!0}};h([Ct()],_g.prototype,"doubleSided",void 0),h([Ct()],_g.prototype,"cullFace",void 0),h([Ct()],_g.prototype,"hasSlicePlane",void 0);let kl=class extends mw{constructor(){super(...arguments),this.externalColor=Mi(1,1,1,1),this.externalColorMixMode=1,this.emissiveStrength=0,this.emissiveSource=0,this.castShadows=0}get transparent(){return this.externalColor[3]<1?0:2}get opaqueOverride(){return this.externalColorMixMode===3&&this.externalColor[3]===1?0:2}get emissiveOverride(){return this.emissiveStrength>0?0:2}get emissiveSourceOverride(){return this.emissiveSource===1?0:2}get visible(){return this.externalColor[3]>0?0:2}get type(){return 0}};h([Ct({vectorOps:cM})],kl.prototype,"externalColor",void 0),h([Ct()],kl.prototype,"externalColorMixMode",void 0),h([Ct()],kl.prototype,"emissiveStrength",void 0),h([Ct()],kl.prototype,"emissiveSource",void 0),h([Ct()],kl.prototype,"castShadows",void 0);let Tl=class extends mw{constructor(){super(...arguments),this.texture=null,this.transparent=2,this.opaqueOverride=2,this.emissiveOverride=2,this.emissiveSourceOverride=2,this.castShadows=2}get type(){return 1}};function VQ(e){return e.overlay?.getTexture(2)!=null}function zQ(e){return e.overlay?.getTexture(3)!=null}function kQ(e){return e.overlay?.getTexture(1)!=null}function BQ(e){return e.overlay?.getTexture(e.overlay?.allSourcesOccluders?1:4)!=null}h([Ct()],Tl.prototype,"texture",void 0),h([Ct()],Tl.prototype,"transparent",void 0),h([Ct()],Tl.prototype,"opaqueOverride",void 0),h([Ct()],Tl.prototype,"emissiveOverride",void 0),h([Ct()],Tl.prototype,"emissiveSourceOverride",void 0),h([Ct()],Tl.prototype,"castShadows",void 0);let NQ=class{constructor(e){this._maxCount=e,this._nextIndex=0,this._recycledIndices=[]}get activeCount(){return this._nextIndex-this._recycledIndices.length}get availableCount(){return this._recycledIndices.length+this._maxCount-this._nextIndex}acquire(){return this._recycledIndices.length>0?this._recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}release(e){this._recycledIndices.push(e)}},jQ=class{constructor(e,t=1){this._rctx=e,this._fieldCount=t,this.textureWidth=4096,this._dirty=!0;const i=new gt(this.textureWidth,1);i.samplingMode=9728,i.wrapMode=33071,this._texture=new bt(this._rctx,i),this._data=new jg(new ArrayBuffer(4*this.textureWidth))}dispose(){this._texture.dispose(),this._texture=void 0,this._data=void 0}setData(e,t,i,r,s,n){const a=e*this._fieldCount+t;this._dirty=!0,this._data.set(a,0,i),this._data.set(a,1,r),this._data.set(a,2,s),this._data.set(a,3,n)}setDataElement(e,t,i,r){const s=e*this._fieldCount+t;this._dirty=!0,this._data.set(s,i,r)}getDataElement(e,t,i){const r=e*this._fieldCount+t;return this._dirty=!0,this._data.get(r,i)}resizeToFit(e){const t=(e+1)*this._fieldCount;if(t>this._data.count){const i=Math.ceil(t/this.textureWidth)*this.textureWidth,r=new jg(new ArrayBuffer(4*i));r.typedBuffer.set(this._data.typedBuffer),this._data=r}}updateTexture(){if(!this._dirty)return;const e=this._texture.descriptor.width,t=this._texture.descriptor.height;this._data.count>e*t&&this._texture.resize(e,this._data.count/e),this._texture.setData(this._data.typedBuffer),this._dirty=!1}get texture(){return this._texture}};const KE=65536;let UQ=class{constructor(e,t=1){this.textureBuffer=new jQ(e,t),this._indexManager=new NQ(KE)}dispose(){this.textureBuffer.dispose(),this.textureBuffer=void 0}get availableCount(){return this._indexManager.availableCount}get activeCount(){return this._indexManager.activeCount}acquireIndex(){const e=this._indexManager.acquire();return this.textureBuffer.resizeToFit(e),e}releaseIndex(e){this._indexManager.release(e)}},HQ=class{constructor(e,t=1){this._rctx=e,this._fieldCount=t,this._buffers=[]}garbageCollect(){this._buffers=this._buffers.filter(e=>e.activeCount!==0||(e.dispose(),!1))}destroy(){this._buffers.forEach(e=>e.dispose()),this._buffers=[]}getBuffer(e){for(const i of this._buffers)if(i.availableCount>=e)return i;if(e>KE)return null;const t=new UQ(this._rctx,this._fieldCount);return this._buffers.push(t),t}updateTextures(){for(const e of this._buffers)e.textureBuffer.updateTexture()}};const ff=()=>$.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");let qQ=class{constructor(e,t){this._renderManager=e,this._viewingMode=t,this._elevationRangeCacheVerticalOffset=NaN,this._elevationRangeCacheMin=NaN,this._elevationRangeCacheMax=NaN,this._activeHighlightOptions=new Map,this._visible=new jt,this._hidden=new jt,this._renderSubmit=new wQ(this),this._renderManager.register(this._renderSubmit),this._componentBufferManager=new HQ(e.rctx,ZE())}destroy(){Qt(this._hidden.length===0&&this._visible.length===0,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy(),this._componentBufferManager=null,this._visible.forAll(e=>e.destroy()),this._visible.prune(),this._hidden.forAll(e=>e.destroy()),this._hidden.prune(),this._renderSubmit.destroy()}createObject(e){const{geometry:t}=e,i=new LZ(this._componentBufferManager,aM(t.componentOffsets)),r=this._createRenderable(e,i),s=new oQ(this._viewingMode,t.positionData,i,e.elevationAlignable),n=new VZ(e.transform,e.toMapSpace,e.obb.clone(),i,r,s);return(n.visible?this._visible:this._hidden).push(n),n}destroyObject(e){const t=e;(t.visible?this._visible:this._hidden).removeUnordered(t),t.destroy(),this._notifyDirty()}setObjectVisibility(e,t){const i=e;t!==i.visible&&(t?(this._hidden.removeUnordered(i),this._visible.push(i)):(this._visible.removeUnordered(i),this._hidden.push(i)),i.visible=t,this._notifyDirty())}preSubmit(e){const t=e.camera.eye;this.visibleObjects.forAll(i=>i.renderable.meta.cameraDepthSquared=Do(t,i.obb.center))}getMaterial(e){return e.renderable.material}updateMaterial(e,t){const i=e.renderable.material;t(i),i.dirty&&this._notifyDirty()}setAllComponentVisibilities(e,t){const i=e;i.componentData.visibility.reset(t),i.componentData.markVisibilityDirty(),this._notifyDirty()}forEachVisibleComponent(e,t){return e.componentData.visibility.forEachComponent(t)}getComponentCount(e){const t=e,i=t.componentData.visibility.componentCount;return{visible:i,invisible:t.componentData.count-i}}setComponentData(e,t){const i=e,{renderable:r,componentData:s}=i,n=r.material,a=s.materialDataBuffer,o=s.materialDataIndices,l=new xQ,c=a.textureBuffer,u=new Uint8Array(4),p=new Uint32Array(u.buffer);let m=0,f=0,g=0,y=0,v=0,C=s.verticalOffsets,b=1/0,S=-1/0,x=!1,T=!1,P=!1,R=0;for(let O=0;O<s.count;O++){t(O,l),m+=+(l.externalColor[3]<1),f+=+(l.externalColorMixMode===3&&l.externalColor[3]===1),y+=+(l.emissiveStrength>0),v+=+(l.emissiveSource===1),T||=l.emissiveStrength!==1,g+=+l.castShadows,mF(l.externalColor,l.externalColorMixMode,u),u[2]=254&u[2]|+l.castShadows,c.setData(o[O],0,u[0],u[1],u[2],u[3]),x||=O>0&&R!==p[0],R=p[0],P||=l.elevationOffset!==0,P&&C==null&&(C=new Array(O).fill(0)),C!=null&&(C[O]=l.elevationOffset),b=Math.min(b,l.elevationOffset),S=Math.max(S,l.elevationOffset),TQ(l.elevationOffset,u),c.setData(o[O],1,u[0],u[1],u[2],u[3]),PQ(l.emissiveStrength,u),c.setData(o[O],2,u[0],u[1],u[2],l.emissiveSource===0?0:255);const E=l.olidColor;E!=null&&c.setData(o[O],3,E[0],E[1],E[2],E[3]),l.pickable!==UE(s.pickability,O)&&WZ(s,O,l.pickable)}s.verticalOffsets=P?C:null,i.offsetObb=P?vF(i.obb,b,S,this._viewingMode,i.offsetObb??i.obb.clone()):null,x||P||Io()||(T||v>0)&&y>0?(n.componentParameters=new Tl,n.componentParameters.castShadows=Xu(g,s.count),n.componentParameters.transparent=Xu(m,s.count),n.componentParameters.opaqueOverride=Xu(f,s.count),n.componentParameters.emissiveOverride=Xu(y,s.count),n.componentParameters.emissiveSourceOverride=Xu(v,s.count),n.componentParameters.texture=c,c.updateTexture()):(n.componentParameters=new kl,n.componentParameters.castShadows=l.castShadows?0:2,n.componentParameters.externalColor=l.externalColor,n.componentParameters.externalColorMixMode=l.externalColorMixMode,n.componentParameters.emissiveStrength=l.emissiveStrength,n.componentParameters.emissiveSource=l.emissiveSource),this._elevationRangeCacheVerticalOffset=NaN,this._notifyDirty()}getComponentAabb(e,t,i,r=!1){e.intersectionGeometry.getComponentAabb(t,i);const s=e,n=s.componentData.verticalOffsets;if(r||n==null)return i;const a=n[t];if(this._viewingMode===2||a===0)return i[2]+=a,i[5]+=a,i;const o=$w(a);return o.localOrigin=s.transform.position,o.applyToAabb(i)}getComponentObb(e){return e.obb}getObjectTransform(e){return e.transform}getComponentPositions(e,t,i){return e.intersectionGeometry.getComponentPositions(t,i)}expandRangeWithComponentObjectElevationRange(e,t,i,r){Number.isNaN(this._elevationRangeCacheVerticalOffset)||this._elevationRangeCacheVerticalOffset!==t||r.expandElevationRangeValues(this._elevationRangeCacheMin,this._elevationRangeCacheMax);const s=e,n=s.componentData,a=n.count,o=n.verticalOffsets,l=s.intersectionGeometry,c=this._viewingMode===2,u=l.getComponentAabbs(),p=GQ;let m=1/0,f=-1/0;for(let g=0;g<a;g++){const y=6*g,v=o?.[g]??0;let C=1/0,b=-1/0;if(c)C=u[y+2]+v+t,b=u[y+5]+v+t;else{if(p[0]=u[y],p[1]=u[y+1],p[2]=u[y+2],p[3]=u[y+3],p[4]=u[y+4],p[5]=u[y+5],v!==0){const P=$w(v);P.localOrigin=s.transform.position,P.applyToAabb(p)}const S=Math.max(Math.abs(p[3]),Math.abs(p[0])),x=Math.max(Math.abs(p[4]),Math.abs(p[1])),T=t+p[5]+i;r.expandElevationRangeValues(t+p[2],Math.sqrt(S*S+x*x+T*T)-i)}r.expandElevationRangeValues(C,b),m=Math.min(m,C),f=Math.max(f,b)}this._elevationRangeCacheVerticalOffset=t,this._elevationRangeCacheMin=m,this._elevationRangeCacheMax=f}intersect(e,t,i,r,s,n){const a=e,{transform:o,componentData:l,intersectionGeometry:c}=a;return r!=null&&(r.localOrigin=o.position),c.intersect(t,i,r,l.verticalOffsets,o,s,n)}addEdges(e,t,i,r,s){const n=e,{indices:a,positions:o}=n.intersectionGeometry,l=n.componentData.offsets;return t.addComponentObject(n,o,a,l,i,r,s)}async extractEdgeInformation(e,t,i){const r=e,s=r.componentData.visibility;if(s.allInvisible()){const{extractComponentsEdgeLocationsLayout:m}=await k(()=>le(()=>import("./edgeProcessing-XRp0V_T8-C5tvOlj0.js"),__vite__mapDeps([467,415,14,168,3,182,169,19,9,7,1,2,8,20,167,6,4,10,86,170,87,183,177,184,468,227])),ue([468,416,14,184,1,198,185,19,9,7,8,5,6,20,183,4,2,10,87,186,88,199,193,200,469,241]));return{buffer:m.createBuffer(0),origin:[0,0,0]}}const{indices:n,positions:a}=r.intersectionGeometry,o=r.componentData.offsets,{EdgeInputBufferLayout:l}=await k(async()=>{const{EdgeInputBufferLayout:m}=await le(()=>import("./bufferLayouts-f-kO2Y2_-BEmDeZBp.js"),__vite__mapDeps([468,182,169,19,3,9,7,1,2,8,20,14,167,6,4,10,86,170,87,183,177,184]));return{EdgeInputBufferLayout:m}},ue([469,198,185,19,1,9,7,8,5,6,20,14,183,4,2,10,87,186,88,199,193,200])),c=l.createBuffer(a.length/3);GF(c.position.typedBuffer,a,c.position.typedBufferStride,3),qF(c.position,c.position,r.transform.rotationScale),this._setComponentIndices(c.componentIndex,n,o);const u=c.count,p=this._computeVisibilityIndices(n,s,o,u);return{origin:Mn(r.transform.position),buffer:await t.extractComponentsEdgeLocations({indices:p,indicesLength:p.length,skipDeduplicate:!0,data:c,writerSettings:{reducedPrecision:!1,variants:0}},i)}}_setComponentIndices(e,t,i){let r=0;for(let s=0;s<i.length-1;s++){const n=i[s],a=i[s+1];for(let o=n;o<a;o++){const l=t?t[o]:o;e.set(l,r)}r++}}_computeVisibilityIndices(e,t,i,r){if(e&&t.allVisible())return e;let s=0;t.forEachComponentRange((o,l)=>(s+=i[l]-i[o],!0));const n=MA(e)?e?.BYTES_PER_ELEMENT===2||r<=65536?new Uint16Array(s):new Uint32Array(s):new Array(s);let a=0;return t.forEachComponentRange((o,l)=>{const c=i[o],u=i[l];for(let p=c;p<u;p++)n[a++]=e?e[p]:p;return!0}),n}addComponentHighlight(e,t,i){const r=e.componentData,s=Fa(r.componentHighlights,i,()=>new Uint32Array(r.count+1));{const n=this._activeHighlightOptions.get(i)??0;this._activeHighlightOptions.set(i,n+1)}s[t]++===0&&(r.markHighlightsDirty(),this._notifyDirty()),s[r.count]++}removeComponentHighlight(e,t,i){const{componentData:r}=e,s=r.componentHighlights.get(i);if(s===void 0)return void ff().warn("Removing non-existing highlight.");const n=s[t];if(n===0)return void ff().warn("Removing non-existing highlight.");this._removeActiveHighlight(i);const a=s[r.count];if(n>1)return s[t]=n-1,void(s[r.count]=a-1);s[t]=0,a===1?r.componentHighlights.delete(i):s[r.count]=a-1,r.markHighlightsDirty(),this._notifyDirty()}_removeActiveHighlight(e,t=1){const i=this._activeHighlightOptions.get(e);if(i===void 0)ff().warn("Removing non-existing highlight.");else{const r=i-t;r<0&&ff().warn("Removing non-existing highlight."),r<=0?this._activeHighlightOptions.delete(e):this._activeHighlightOptions.set(e,r)}}clearHighlights(e){const{componentData:t}=e,{componentHighlights:i}=t;if(i.size>0){for(const r of i)this._removeActiveHighlight(r[0],r[1][t.count]);i.clear(),t.markHighlightsDirty(),this._notifyDirty()}}hasHighlight(e){return this._activeHighlightOptions.has(e)}getObjectGPUMemoryUsage(e){return e.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._visible}_createRenderable(e,t){const i=this._renderManager.rctx,r=e.geometry,s=r.vertices.layoutParameters,n=Bs(GE(s)),a=new ei(i,n,r.vertices.data),o=r.indices?Hs.createIndex(i,35044,r.indices):null,l=new Uint16Array(r.vertices.count);for(let g=0;g<t.count;g++){const y=t.offsets[g],v=t.offsets[g+1],C=t.materialDataIndices[g];if(r.indices!=null)for(let b=y;b<v;b++)l[r.indices[b]]=C;else for(let b=y;b<v;b++)l[b]=C}const c=new ei(i,XE,l.buffer),u=new ci(e.transform,e.toMapSpace),p=new Dn(i,new Map([["geometry",a],["componentIndices",c]]),o),m=new mQ(p,St.TRIANGLES,s,o!=null),f={cameraDepthSquared:.5,gpuMemoryEstimate:a.usedMemory+c.usedMemory+(o!=null?o.usedMemory:0)};return new pQ(u,m,f)}_notifyDirty(){this._renderManager.notifyDirty()}};function Xu(e,t){return e===t?0:e===0?2:1}const GQ=eo();let $Q=class{constructor(e,t,i,r,s){this.rctx=e,this.viewingMode=t,this.stippleTextures=i,this.waterTextures=r,this.markerTextures=s}get spherical(){return this.viewingMode===1}},WQ=class{constructor(e){this._context=e,this._debug=!1,this._precompiling=this._debug?0:1,this._cache=new $a}get context(){return this._context}get precompiling(){return this._precompiling}set precompiling(e){this._precompiling=e,e===0&&this.context.rctx.gl.flush()}get viewingMode(){return this.context.viewingMode}destroy(){this._cache.forAll(e=>e.destroy()),this._cache.clear(),this._context=null}precompile(e,t=DT){++this.precompiling,this.get(e,t),--this.precompiling}get(e,t=DT){const i=t.key.code;let r=this._cache.get(e,i);if(r==null){if(this._precompiling===0){let s=`Uncached shader compile in ${new Error().stack}
  for configuration
${t.decode()}`;const n=this._cache.getInner(e);throw n?.size&&(s+=`

  cached configurations:
`,s+=Array.from(n.values()).map(a=>t.decode(a.key)).sort().join(`

`)),console.log(s),new fe("shader:uncached-compile",s)}r=new e(this.context,t),this._cache.set(e,i,r)}return r}async reloadAll(){const e=new Array;this._cache.forEach(t=>e.push(ZQ(t))),await Promise.all(e)}};async function ZQ(e){let t=!0;e.forEach(async i=>{await i.reload(t),t=!1})}const DT=new hr;let Ed=class extends qo{constructor(e){super(e),this.consumes={required:["olid"]},this.produces="olid"}destroy(){}render(e){const t=e.find(({name:r})=>r==="olid"),i=this.renderingContext;return i.bindFramebuffer(t.fbo),i.clearFramebuffer(di,!0,!0),this.view.stage.renderer.renderAllGeometry(10),i.clear(1280),this.view.stage.renderer.renderHUD(1),t}};h([d()],Ed.prototype,"consumes",void 0),h([d()],Ed.prototype,"produces",void 0),Ed=h([D("esri.views.3d.webgl-engine.effects.geometry.ObjectAndLayerIDRenderNode")],Ed);let Ad=class extends qo{constructor(e){super(e),this.consumes={required:[ne.OCCLUDED]},this.produces=ne.OCCLUDED,this._blit=new uw(e.view.stage.renderView.techniques,2)}precompile(){const e=this.view.stage.renderer;e.plugins.plugins.forEach(t=>{e.precompileSlots(t,9,11),t.material&&e.precompileOccludedSlots(t,s2)})}render(e){const t=e.find(({name:i})=>i===this.produces);return this._renderOccludedAndTransparentStencil(t),this._renderOccludedComposite(t),t}_renderOccludedAndTransparentStencil(e){const t=this.view.stage.renderer,i=r2;i.clear();for(const r of t.plugins.plugins)8&r.renderOccludedFlags&&i.push(r);i.length!==0&&(t.renderSlots(i,10),this._renderAndComposite(e,e.getAttachment(qi),.5,()=>t.renderSlots(i,11),!1,!1),i.clear())}_renderOccludedComposite(e){const t=this.view.stage.renderer,i=r2;i.clear();let r=0;for(const a of t.plugins.plugins){const o=a.renderOccludedFlags&XQ;r|=o,o&&i.push(a)}if(!r)return void i.clear();const s=this._getDepthStencilAttachment(e);let n=s.clearStencil;for(const a of s2)r&a&&(this._renderAndComposite(e,s.depth,a===16?1:.5,()=>t.renderOccludedSlots(i,a),!0,n),n=!1);s.release(),i.clear()}_renderAndComposite(e,t,i,r,s,n){const a=this.renderingContext,{width:o,height:l}=e.fbo,c=this.fboCache.acquire(o,l,"tmp color");c.attachDepth(t),a.bindFramebuffer(c.fbo),a.clearFramebuffer(di,s,n),r(),c.detachDepth(),this._blit.blend(a,c,e,this.bindParameters,i),c.release()}_getDepthStencilAttachment(e){const{width:t,height:i}=e.fbo;if(!this.view.stage.renderer.occludedRequiresIntegratedMeshStencil){const s=this.fboCache.acquireDepth(13,t,i,"retained stencil");return{depth:s,release:()=>s.release(),clearStencil:!0}}const r=this.fboCache.acquire(t,i,"retained stencil",13);return this.renderingContext.blitFramebuffer(e.fbo,r.fbo,1024),{depth:r.getAttachment(qi),release:()=>r.release(),clearStencil:!1}}};h([d()],Ad.prototype,"consumes",void 0),h([d()],Ad.prototype,"produces",void 0),Ad=h([D("esri.views.3d.webgl-engine.effects.geometry.RenderOccludedRenderNode")],Ad);const r2=new jt;function QQ(){r2.prune()}const s2=[4,2,16],XQ=s2.reduce((e,t)=>e|t,0);function JE(){return new Float32Array(4)}function YQ(e){const t=new Float32Array(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function Su(e,t,i,r){const s=new Float32Array(4);return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s}function e5(){return JE()}function t5(){return Su(1,1,1,1)}function i5(){return Su(1,0,0,0)}function r5(){return Su(0,1,0,0)}function s5(){return Su(0,0,1,0)}function n5(){return Su(0,0,0,1)}const ty=e5(),KQ=t5(),JQ=i5(),eX=r5(),tX=s5(),iX=n5();Object.freeze(Object.defineProperty({__proto__:null,ONES:KQ,UNIT_W:iX,UNIT_X:JQ,UNIT_Y:eX,UNIT_Z:tX,ZEROS:ty,clone:YQ,create:JE,fromValues:Su,ones:t5,unitW:n5,unitX:i5,unitY:r5,unitZ:s5,zeros:e5},Symbol.toStringTag,{value:"Module"}));const yg={sunny:.0022,rainy:.0022,cloudy:.0022,snowy:.0022,foggy:.0022};let OT=class{constructor(e){this.presets=e,this.presets=a5(e)}};const b_={minDisperse:new OT([.8,.12,.06,.02,0,0]),maxDisperse:new OT([0,0,.06,.12,.25,.57])};function a5(e,t=1){const i=e[0]+e[1]+e[2]+e[3]+e[4]+e[5];return i<=t?e:[e[0]/i,e[1]/i,e[2]/i,e[3]/i,e[4]/i,e[5]/i]}let fw=class extends Kt{constructor(){super(...arguments),this.blurRadius=yg.sunny}};function o5(e){const t=new ut,i=t.fragment;t.include($i),i.include(pc),i.uniforms.add(new Ne("colorTexture",l=>l.emissionsToDownsample),new _e("blurRadius",l=>l.blurRadius));let r="";const s=15;for(let l=0;l<s;l++)r+=`locations1D[${l}] = ${(l/(s-1)*2-1).toFixed(3).toString()};`;const n=2;let a="";for(let l=0;l<s;l++)a+=`locations1DWeights[${l}] = ${LI(l-Math.floor(s/2),n).toFixed(7).toString()};`;const o=e.glowStage===0;return i.code.add(_`
    float locations1D[${_.int(s)}];
    float locations1DWeights[${_.int(s)}];

    vec3 blurUniformSamples(sampler2D toBlur) {
      vec3 res = vec3(0.0);
      vec2 size = vec2(textureSize(toBlur, 0));
      vec2 aspectCorrection = vec2(1.0, size.x / size.y);
      vec2 uvInPixel = uv * size;

      ${r}
      ${a}
      vec2 pixelCenterShift = 0.5 / size;

      for(int i=0;i < ${_.int(s)}; i++) {
        float uv1D = locations1D[i] + ${o?"pixelCenterShift.x":"pixelCenterShift.y"};
        vec2 uvOffset = ${o?"vec2(uv1D, 0.0)":"vec2(0.0, uv1D)"};

        vec2 uvDistorted = uv + uvOffset * blurRadius * aspectCorrection;
        vec3 sampleColor = texture(toBlur, uvDistorted).rgb;
        res += sampleColor * locations1DWeights[i];
      }
      return res;
    }
  `).main.add(_`fragColor = vec4(blurUniformSamples(colorTexture), 0.0);`),t}const rX=Object.freeze(Object.defineProperty({__proto__:null,GlowBlurPassParameters:fw,build:o5},Symbol.toStringTag,{value:"Module"}));let gf=class extends ct{constructor(e,t){super(e,t,new ht(rX,()=>k(()=>Promise.resolve().then(()=>mee),void 0)),ai)}initializePipeline(){return Ge({colorWrite:st})}},n2=class extends hr{constructor(){super(...arguments),this.glowStage=0}};h([z({count:2})],n2.prototype,"glowStage",void 0);let gw=class extends IE{constructor(){super(...arguments),this.lodFactors=[0,0,0,0,0,0],this.glowLod=-1,this.dispersionWeight=1,this.distanceModifier=1e-4}};function l5(e){const t=new ut,i=t.fragment,{blurEnabled:r,tonemappingEnabled:s}=e;return t.include(Kp,{needUVs:!0,needEyeDirection:!0}),i.include(pc),i.include(LE),i.include(Xa),t.outputs.add("fragColor","vec4",0),t.outputs.add("fragEmission","vec3",1),i.include(kp),i.uniforms.add(new Ne("colorTexture",n=>n.color),new Ne("emissionTexture",n=>n.emission)),r?(i.uniforms.add(new gs("depthTexture",n=>n.mainDepth),new _e("distanceModifier",n=>n.distanceModifier),new Ne("lodTexture0",n=>n.lodTexture0),new Ne("lodTexture1",n=>n.lodTexture1),new Ne("lodTexture2",n=>n.lodTexture2),new Ne("lodTexture3",n=>n.lodTexture3),new Ne("lodTexture4",n=>n.lodTexture4),new hc("glowLod",n=>n.glowLod),new us("minDisperse",()=>b_.minDisperse.presets,6),new us("maxDisperse",()=>b_.maxDisperse.presets,6),new _e("dispersionWeight",n=>n.dispersionWeight)).main.add(_`
    vec4 color = texture(colorTexture, uv);
    color = vec4(linearizeGamma(color.rgb), color.a);

    vec3 lod0 = texture(emissionTexture, uv).rgb;
    vec3 lod1 = texture(lodTexture0, uv).rgb;
    vec3 lod2 = texture(lodTexture1, uv).rgb;
    vec3 lod3 = texture(lodTexture2, uv).rgb;
    vec3 lod4 = texture(lodTexture3, uv).rgb;
    vec3 lod5 = texture(lodTexture4, uv).rgb;

    float terrainDepth = -1.0;
    float depthSample = depthFromTexture(depthTexture, uv);
    if(depthSample < 1.0 && depthSample > 0.0){
      vec3 cameraSpaceRay = normalize(eyeDir);
      cameraSpaceRay /= cameraSpaceRay.z;
      cameraSpaceRay *= linearizeDepth(depthSample);
      terrainDepth = max(0.0, length(cameraSpaceRay));
    }
    vec3 rayDir = normalize(worldRay);
    float dispersionByDistance = getDistanceFalloff(terrainDepth, rayDir, distanceModifier);
    float dispersionPerPixel = dispersionWeight * dispersionByDistance;

    float lodFactor0 = mix(minDisperse[0], maxDisperse[0], dispersionPerPixel);
    float lodFactor1 = mix(minDisperse[1], maxDisperse[1], dispersionPerPixel);
    float lodFactor2 = mix(minDisperse[2], maxDisperse[2], dispersionPerPixel);
    float lodFactor3 = mix(minDisperse[3], maxDisperse[3], dispersionPerPixel);
    float lodFactor4 = mix(minDisperse[4], maxDisperse[4], dispersionPerPixel);
    float lodFactor5 = mix(minDisperse[5], maxDisperse[5], dispersionPerPixel);

    vec3 emission = lodFactor0 * lod0;
    emission += lodFactor1 * lod1;
    emission += lodFactor2 * lod2;
    emission += lodFactor3 * lod3;
    emission += lodFactor4 * lod4;
    emission += lodFactor5 * lod5;

    // only for glow editor lod debugging
    emission = glowLod == 0 ? lodFactor0 * lod0 : glowLod == 1 ? lodFactor1 * lod1 : glowLod == 2 ? lodFactor2 * lod2 : glowLod == 3 ? lodFactor3 * lod3 : glowLod == 4 ? lodFactor4 * lod4 : glowLod == 5 ? lodFactor5 * lod5 : emission;

    fragEmission = emission;
    // tonemapping is only applied to the emissive part since main color values are not in HDR.
    ${X(s,"emission = tonemapACES(emission);")}

    fragColor = delinearizeGamma(vec4(color.rgb + emission.rgb, color.w));
  `),t):(i.main.add(_`
      vec4 color = texture(colorTexture, uv);
      color = vec4(linearizeGamma(color.rgb), color.a);

      // emission is already in linear color space here.
      vec3 emission = texture(emissionTexture, uv).rgb;

      ${X(s,"emission = tonemapACES(emission);")}
      fragColor = delinearizeGamma(vec4(color.rgb + emission, color.w));
    `),t)}const sX=Object.freeze(Object.defineProperty({__proto__:null,GlowCompositionPassParameters:gw,build:l5},Symbol.toStringTag,{value:"Module"}));let _f=class extends ct{constructor(e,t){super(e,t,new ht(sX,()=>k(()=>Promise.resolve().then(()=>fee),void 0)),ai)}initializePipeline(e){return Ge({colorWrite:st,drawBuffers:{buffers:e.blurEnabled?[Et,Qr]:[Et]}})}},a2=class extends hr{constructor(){super(...arguments),this.blurEnabled=!1,this.tonemappingEnabled=!0}};h([z()],a2.prototype,"blurEnabled",void 0),h([z()],a2.prototype,"tonemappingEnabled",void 0);let ql=class extends Xl{constructor(e){super(e),this.consumes={required:[ne.TRANSPARENT_ENVIRONMENT,"emissive"]},this.produces=ne.TRANSPARENT_ENVIRONMENT,this._blurHorizontalConfiguration=new n2,this._blurVerticalConfiguration=new n2,this._compositionConfiguration=new a2,this._compositionParameters=new gw,this._blurParameters=new fw,this._blurScale=3.06,this._glowEnabled=!1,this._glowResults=new Array;const t=Yt(e.view.spatialReference);this._atmosphereRadius=t.radius+t.atmosphereHeight,e.view.stage.renderView.techniques.precompile(_f,this._compositionConfiguration)}initialize(){this.addHandles([M(()=>this._updateFogParameters(),()=>{},Ve),M(()=>this.view.qualitySettings.glow,e=>{this._glowEnabled=e,this.precompile(),this.requestRender(1)},Ve)])}_updateFogParameters(){const e=this.view.environment.weather;if(e.type==="sunny"||e.type==="cloudy")this._blurParameters.blurRadius=yg[e.type],this._compositionParameters.distanceModifier=0;else{const t=e.type==="foggy"?e.fogStrength:e.precipitation;this._blurParameters.blurRadius=De(yg.cloudy,yg[e.type],t),this._compositionParameters.distanceModifier=e.type==="foggy"?De(3e-5,.005,e.fogStrength**3):De(4e-6,2e-4,(e.precipitation??0)**3)}this._computeLodFactors(),this.requestRender(1)}_computeLodFactors(e=b_.minDisperse.presets,t=b_.maxDisperse.presets){e.forEach((i,r)=>{this._compositionParameters.lodFactors[r]=De(i,t[r],this._compositionParameters.dispersionWeight)})}precompile(){this._glowEnabled&&(this.techniques.precompile(gf,this._blurHorizontalConfiguration),this._blurVerticalConfiguration.glowStage=1,this.techniques.precompile(gf,this._blurVerticalConfiguration)),this._compositionConfiguration.blurEnabled=this._glowEnabled,this.techniques.precompile(_f,this._compositionConfiguration)}render(e){const t=e.find(({name:x})=>x===ne.TRANSPARENT_ENVIRONMENT),i=t.getAttachment(Qr);if(!i?.attachment)return t;const r=t.getAttachment(qi);if(!this._glowEnabled){const x=this.techniques.get(_f,this._compositionConfiguration);if(!x.compiled)return this.requestRender(1),t;const T=t.getTexture(),P=this.fboCache,{fullWidth:R,fullHeight:O}=this.bindParameters.camera,E=this.renderingContext,A=P.acquire(T.descriptor.width,T.descriptor.height,this.produces);return this._prepareFBO(A,R,O),this._compositionParameters.color=T,this._compositionParameters.emission=i.attachment,E.bindTechnique(x,this.bindParameters,this._compositionParameters),E.screen.draw(),A.attachDepth(r),A.attachColor(i,Qr),A}const s=this.techniques.get(gf,this._blurHorizontalConfiguration),n=this.techniques.get(gf,this._blurVerticalConfiguration),a=this.techniques.get(_f,this._compositionConfiguration);if(!s.compiled||!n.compiled||!a.compiled)return this.requestRender(1),t;const o=t.getTexture(),l=this.fboCache,{fullWidth:c,fullHeight:u}=this.bindParameters.camera,p=this.renderingContext;let m=i.attachment,f=Math.ceil(c/2),g=Math.ceil(u/2);const y=5,v=this._blurParameters.blurRadius;for(let x=0;x<y;x++){const T=l.acquire(f,g,"glow horizontal",8);this._blurParameters.emissionsToDownsample=m,this._prepareFBO(T,f,g),p.bindTechnique(s,this.bindParameters,this._blurParameters),p.screen.draw();const P=l.acquire(f,g,"glow vertical",8);this._blurParameters.emissionsToDownsample=T.getTexture(),this._prepareFBO(P,f,g),p.bindTechnique(n,this.bindParameters,this._blurParameters),p.screen.draw(),T.release(),this._glowResults[x]=P,f=Math.ceil(f/2),g=Math.ceil(g/2),m=this._glowResults[x].getTexture(),this._blurParameters.blurRadius*=this._blurScale}this._blurParameters.blurRadius=v;const C=this.bindParameters.camera,b=ge(C.eye);this._compositionParameters.atmosphereC=b**2-this._atmosphereRadius**2,this._compositionParameters.color=o,this._compositionParameters.emission=i.attachment,this._compositionParameters.lodTexture0=this._glowResults[0].getTexture(),this._compositionParameters.lodTexture1=this._glowResults[1].getTexture(),this._compositionParameters.lodTexture2=this._glowResults[2].getTexture(),this._compositionParameters.lodTexture3=this._glowResults[3].getTexture(),this._compositionParameters.lodTexture4=this._glowResults[4].getTexture();const S=l.acquire(o.descriptor.width,o.descriptor.height,this.produces);return S.acquireColor(Qr,8,"emissive glow"),this._prepareFBO(S,c,u,!0),p.bindTechnique(a,this.bindParameters,this._compositionParameters),p.screen.draw(),this._glowResults.forEach(x=>x.release()),S.attachDepth(r),S}_prepareFBO(e,t,i,r=!1){const s=this.renderingContext;s.bindFramebuffer(e.fbo),s.setViewport(0,0,t,i),s.setClearColor(0,0,0,0),s.clear(16384),r&&s.clearBuffer(1,ty)}get test(){return{compositionParameters:this._compositionParameters,blurParameters:this._blurParameters,setBlurLodCombination:e=>{this._compositionParameters.dispersionWeight=e,this._computeLodFactors()},setLodFactors:e=>{this._computeLodFactors(a5(e))},toggleTonemapping:e=>{this._compositionConfiguration.tonemappingEnabled=e,this.requestRender(1)}}}};h([d()],ql.prototype,"consumes",void 0),h([d()],ql.prototype,"produces",void 0),ql=h([D("esri.views.3d.webgl-engine.effects.glow.GlowRenderNode")],ql);let _w=class extends Kt{};function c5(){const e=new ut;return e.include($i),e.fragment.uniforms.add(new Ne("colorTexture",t=>t.color),new gs("depthTexture",t=>t.mainDepth)),e.fragment.main.add(_`float depthSample = texture(depthTexture, uv).r;
if (depthSample == 1.0 ) {
fragColor = vec4(0);
return;
}
fragColor = texture(colorTexture, uv);`),e}const nX=Object.freeze(Object.defineProperty({__proto__:null,HazeCompositingPassParameters:_w,build:c5},Symbol.toStringTag,{value:"Module"}));let ET=class extends ct{constructor(e,t){super(e,t,new ht(nX,()=>k(()=>Promise.resolve().then(()=>gee),void 0)),ai)}initializePipeline(){return Ge({blending:mu(1,0,769,1),depthTest:{func:519},colorWrite:st})}};function h5(e){const t=new ut,{fragment:i}=t;t.include(Kp),cc(i),i.include(pc),i.include(Xa),i.include(Wp),i.include(kp),i.include(RE,!0),i.uniforms.add(new gs("depthTexture",s=>s.mainDepth),new _e("hazeStrength",s=>s.hazeStrength));const{reduced:r}=e;return r&&i.code.add(_`float getDepth(vec2 uv){
return linearDepthFromTexture(depthTexture, uv);
}
float textureBilinear(vec2 uv) {
vec2 depthTextureSize = vec2(textureSize(depthTexture, 0));
vec2 texelSize = 1.0 / depthTextureSize;
vec2 depthUV = (uv * depthTextureSize) - vec2(0.5);
vec2 f = fract(depthUV);
vec2 snapUV = (floor(depthUV) + vec2(0.5)) / depthTextureSize;
float d0 = getDepth(snapUV);
float d1 = getDepth(snapUV + vec2(texelSize.x, 0.0));
float d2 = getDepth(snapUV + vec2(0.0, texelSize.y));
float d3 = getDepth(snapUV + texelSize);
return mix(mix(d0, d1, f.x), mix(d2, d3, f.x), f.y);
}`),i.main.add(_`
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;

      float depthSample = texture(depthTexture, uv).r;
      if (depthSample != 1.0) {
        vec3 cameraSpaceRay = normalize(eyeDir);
        cameraSpaceRay /= cameraSpaceRay.z;

        cameraSpaceRay *= ${X(r,"-textureBilinear(uv)","-linearDepthFromTexture(depthTexture, uv)")};
        terrainDepth = max(0.0, length(cameraSpaceRay));
      } else {
        discard;
      }

      // Alpha is ignored for haze blending
      vec3 col = vec3(0);
      float fadeOut = smoothstep(-10000.0, -15000.0, heightParameters[0] - radii[0]);
      if(depthSample != 1.0){
        col = (1.0 - fadeOut) * hazeStrength * raymarchAtmosphere(cameraPosition, rayDir, mainLightDirection, terrainDepth);
      }
      float alpha = 1.0;

      col = tonemapACES(col);
      fragColor = delinearizeGamma(vec4(col, alpha));
  `),t}const aX=Object.freeze(Object.defineProperty({__proto__:null,build:h5},Symbol.toStringTag,{value:"Module"}));let oX=class extends ME{constructor(){super(...arguments),this.hazeStrength=1}},ev=class extends ct{constructor(e,t){super(e,t,new ht(aX,()=>k(()=>Promise.resolve().then(()=>_ee),void 0)),Ja(zp))}initializePipeline(e){return e.reduced?Ge({blending:D2,depthTest:{func:519},colorWrite:st}):Ge({blending:mu(1,0,769,1),colorWrite:st})}},vg=class extends hr{constructor(){super(...arguments),this.reduced=!1}};h([z()],vg.prototype,"reduced",void 0);let o2=class extends Xl{constructor(e){super(e),this._compositingPassParameters=new _w,this._passParameters=new oX,this._hazeConfiguration=new vg,this.requireGeometryDepth=!0,this._oldAmount=1,this._newAmount=1,this._amount=this._newAmount;const t=e.view.stage.renderView.techniques;t.precompile(ev,new vg);const i=new vg;i.reduced=!0,t.precompile(ev,i),t.precompile(ET)}initialize(){this.addHandles([M(()=>this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),Ve),M(()=>this.view.stage?.renderer.renderContext.bind.clouds.fadeFactor??1,e=>this._fade(e),Ve),M(()=>this.view.environment.weather.type,e=>this._newAmount=e==="rainy"?0:1,Ve),M(()=>this.view.stage.renderer?.fullResolutionAtmosphere,e=>this._hazeConfiguration.reduced=!e,Ve)])}_fade(e){e>=1?(this._amount=this._newAmount,this._oldAmount=this._newAmount):this._amount=e<=0?this._oldAmount:De(this._oldAmount,this._newAmount,e)}destroy(){this._vao=ye(this._vao)}render(e){const t=e.find(({name:y})=>y===ne.TRANSPARENT_ENVIRONMENT);if(!this.bindParameters.mainDepth)return t;const i=this.renderingContext,r=this.techniques.get(ev,this._hazeConfiguration);if(!r.compiled)return t;const s=t.getAttachment(qi);if(this._update(),!this._hazeConfiguration.reduced)return t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(r,this.bindParameters,this._passParameters),this._renderCommon(i),t.attachDepth(s),t;const n=this.techniques.get(ET);if(!n.compiled)return t;const a=i.getViewport(),o=this.camera,l=ge(o.eye)-Li.radius;let c;const u=Li.atmosphereHeight;if(l<u){const y=Math.min(1,Math.max(0,l/u));c=De(.4,.5,y)}else{const y=Math.min(1,Math.max(0,(l-u)/(15*u)));c=De(.5,1,y)}const p=this.renderingContext.parameters.maxTextureSize,m=Wh(Math.round(c*o.fullViewport[2]),p),f=Wh(Math.round(c*o.fullViewport[3]),p);i.setViewport(0,0,m,f);const g=this.fboCache.acquire(m,f,"haze",5);return i.bindFramebuffer(g.fbo),i.clearFramebuffer([0,0,0,1],!0,!0),i.bindTechnique(r,this.bindParameters,this._passParameters),this._renderCommon(i),i.setViewport(a.x,a.y,a.width,a.height),this._compositingPassParameters.color=g.getTexture(),t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(n,this.bindParameters,this._compositingPassParameters),i.screen.draw(),t.attachDepth(s),g.release(),t}_renderCommon(e){this._vao??=Zo(e,1),e.bindVAO(this._vao),e.drawArrays(St.TRIANGLE_STRIP,0,4)}_update(){const e=this.bindParameters.camera,t=Wr(e.eye),i=Math.sqrt(t),r=t-this._passParameters.radii[1]*this._passParameters.radii[1],s=j((i-this._passParameters.radii[0])/Li.atmosphereHeight,0,1);cr(this._passParameters.heightParameters,i,t,r,s);const n=this.view.basemapTerrain?.getLowerBoundRadius()??0;Ki(this._passParameters.radii,n,n+Li.atmosphereHeight),this._passParameters.hazeStrength=De(De(.6,1,Jh(9500,10500,i-Li.radius)),1,this._amount)}};o2=h([D("esri.views.3d.webgl-engine.effects.haze.Haze")],o2);function tv(e){if(!e.highlights)return null;const t=e.highlights.findIndex(i=>i.name==="default");return t===-1?null:e.highlights.items[t]}function lX(e){const t=e.fragment;e.include(E2),t.include(Xa),t.code.add(_`vec3 normalFromDepth(sampler2D depthMap, vec3 pixelPos, vec2 fragCoord, vec2 uv) {
ivec2 iuv = ivec2(uv * vec2(textureSize(depthMap, 0)));
float leftPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(-1, 0), 0).r);
float rightPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(1, 0), 0).r);
float bottomPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(0, -1), 0).r);
float topPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(0, 1), 0).r);
bool pickLeft = abs(pixelPos.z - leftPixelDepth) < abs(pixelPos.z - rightPixelDepth);
bool pickBottom = abs(pixelPos.z - bottomPixelDepth) < abs(pixelPos.z - topPixelDepth);
vec3 fragCoordHorizontal = pickLeft
? vec3(fragCoord + vec2(-1.0, 0.0), leftPixelDepth)
: vec3(fragCoord + vec2(1.0, 0.0), rightPixelDepth);
vec3 fragCoordVertical = pickBottom
? vec3(fragCoord + vec2(0.0, -1.0), bottomPixelDepth)
: vec3(fragCoord + vec2(0.0, 1.0), topPixelDepth);
vec3 verticalPixelPos = reconstructPosition(fragCoordHorizontal.xy, fragCoordHorizontal.z);
vec3 horizontalPixelPos = reconstructPosition(fragCoordVertical.xy, fragCoordVertical.z);
vec3 normal = normalize(cross(verticalPixelPos - pixelPos, horizontalPixelPos - pixelPos));
return pickLeft == pickBottom ? normal : -normal;
}`)}function u5(e){e.include($8),cX(e)}function cX(e){e.fragment.include(Xa),e.include(E2),e.fragment.uniforms.add(new ps("inverseViewMatrix",({camera:t})=>tu(AT,ac(AT,t.viewMatrix,t.center)))).code.add(_`vec3 calculateUVZShadowAndPixelPosFromDepth(
in vec2 _uv,
ivec2 shadowMapSize,
in sampler2D _depthMap,
out vec4 currentPixelPos
) {
float depth = depthFromTexture(_depthMap, _uv);
if (depth >= 1.0 || depth <= 0.0) {
return invalidShadowmapUVZ;
}
float currentPixelDepth = linearizeDepth(depth);
currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;
float linearDepth = -currentPixelDepth;
return calculateUVZShadow(worldSpacePos.xyz, linearDepth, shadowMapSize);
}
vec3 calculateUVZShadowFromDepth(
in vec2 _uv,
ivec2 shadowMapSize,
in sampler2D _depthMap
) {
vec4 currentPixelPos;
return calculateUVZShadowAndPixelPosFromDepth(_uv, shadowMapSize, _depthMap, currentPixelPos);
}`)}const AT=Le(),hX=.025;function d5(){const e=new ut;e.include(u5),e.include(f4),e.include($i),e.include(lX);const t=e.fragment;return t.uniforms.add(new Pv("shadowMapExcludingHighlight",i=>i.shadowMap.getSnapshot(1)),new Pv("shadowMapHighlight",i=>i.shadowMap.getSnapshot(0)),new gs("depthMap",i=>i.depth?.attachment),new xu("highlightTexture",i=>i.highlightTexture),new $r("uColor",i=>i.shadowColor),new _e("opacity",i=>i.shadowOpacity),new _e("occludedOpacity",i=>i.occludedShadowOpacity),new _e("terminationFactor",i=>i.opacityElevation*i.dayNightTerminator),new Pn("lightingMainDirectionView",({lighting:i,camera:r})=>me(IT,lt(IT,i.mainLight.direction,r.viewInverseTransposeMatrix)))),t.main.add(_`
    ivec2 highlightTextureSize = textureSize(highlightTexture, 0);
    ivec2 highlightIUV = ivec2(uv * vec2(highlightTextureSize));
    uvec2 highlightInfo = texelFetch(highlightTexture, highlightIUV, 0).rg;

    fragColor = vec4(0.0);

    // Calculate bit mask to check if pixel is highlit unoccluded at any level
    uint ored = (highlightInfo.r << 0) | (highlightInfo.g << 8);

    bool visiblyHighlighted = ((ored & ~(ored >> 1)) & (1u+4u+16u+64u)) != 0u;
    if (visiblyHighlighted) {
      return;
    }

    vec4 currentPixelPos;
    vec3 uvzShadow = calculateUVZShadowAndPixelPosFromDepth(uv, textureSize(shadowMapHighlight,0), depthMap, currentPixelPos);
    if (uvzShadow.z < 0.0) {
      return;
    }

    float shadowHighlightFactor = readShadowMapUVZ(uvzShadow, shadowMapHighlight);
    if (shadowHighlightFactor == 0.0) {
      return;
    }

    float shadowExcludingHighlightFactor = readShadowMapUVZ(uvzShadow, shadowMapExcludingHighlight);

    vec3 normal = normalFromDepth(depthMap, currentPixelPos.xyz, gl_FragCoord.xy, uv);
    bool shaded = dot(normal, lightingMainDirectionView) < ${_.float(hX)};

    float occludedFactor = max(shadowExcludingHighlightFactor, shaded ? 1.0 : 0.0);
    float fragOpacity = mix(opacity, occludedOpacity, occludedFactor);
    fragColor = vec4(uColor.rgb, uColor.a * fragOpacity * terminationFactor);
  `),e}const IT=w(),uX=Object.freeze(Object.defineProperty({__proto__:null,build:d5},Symbol.toStringTag,{value:"Module"}));let dX=class extends R2{constructor(){super(...arguments),this.shadowColor=Mi(1,0,1,1),this.shadowOpacity=.2,this.occludedShadowOpacity=.1,this.opacityElevation=1,this.dayNightTerminator=1}},LT=class extends ct{constructor(e,t){super(e,t,new ht(uX,()=>k(()=>Promise.resolve().then(()=>yee),void 0)),ai),this.primitiveType=St.TRIANGLE_STRIP}initializePipeline(){return Ge({blending:ja,colorWrite:st,depthTest:null,depthWrite:null})}};const pX=1/512,mX=4e4,fX=5e4;let _h=class extends qo{constructor(e){super(e),this.produces=Ft.COMPOSITE,this.consumes={required:[Ft.COMPOSITE,"highlights"]},this._passParameters=new dX,this._maxOpacity=1,this._shadowDifference=.2}initialize(){this.addHandles([M(()=>tv(this.view)?.shadowOpacity,e=>{this._passParameters.shadowOpacity=e??kM,this._updateOccludedShadowOpacity(),this._ensureMaxOpacity()},Ve),M(()=>tv(this.view)?.shadowDifference,e=>{this._shadowDifference=e??BM,this._updateOccludedShadowOpacity(),this._ensureMaxOpacity()},Ve),M(()=>tv(this.view)?.shadowColor,e=>{this._passParameters.shadowColor=rb(e??zM),this._ensureMaxOpacity()},Ve)])}_updateOccludedShadowOpacity(){this._passParameters.occludedShadowOpacity=this._passParameters.shadowOpacity*(1-this._shadowDifference)}_ensureMaxOpacity(){const e=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity);this._maxOpacity=e*this._passParameters.shadowColor[3],this.requestRender(1)}precompile(){this.techniques.precompile(LT)}render(e){const t=e.find(({name:n})=>n===Ft.COMPOSITE),i=this.bindParameters;if(!i.shadowHighlightsVisible||!i.depth||!this._ensureIfVisible(i.camera,i.lighting.mainLight.direction))return t;const r=this.techniques.get(LT);if(!r.compiled)return this.requestRender(1),t;this._passParameters.highlightTexture=e.find(({name:n})=>n==="highlights")?.getTexture(),this._passParameters.origin=i.camera.center;const s=this.renderingContext;return s.bindFramebuffer(t.fbo),s.bindTechnique(r,i,this._passParameters),s.screen.draw(),t}_ensureIfVisible(e,t){this._passParameters.opacityElevation=1-Jh(mX,fX,e.relativeElevation);const i=this.viewingMode===1?me(FT,e.center):xe(FT,0,0,1),r=$e(i,t);return this._passParameters.dayNightTerminator=Jh(0,1,j(30*r,0,1)),this._maxOpacity*this._passParameters.opacityElevation*this._passParameters.dayNightTerminator>=pX}};h([d()],_h.prototype,"produces",void 0),h([d()],_h.prototype,"consumes",void 0),h([d({constructOnly:!0})],_h.prototype,"viewingMode",void 0),_h=h([D("esri.views.3d.webgl-engine.effects.highlight.ShadowHighlight")],_h);const FT=w();let yw=class extends Kt{constructor(){super(...arguments),this.mask=null,this.overlay=null,this.input=null,this.size=0}};function p5(){const e=new ut;return e.attributes.add("position","vec2"),e.vertex.uniforms.add(new $r("drawPosition",(t,i)=>gX(t,i))),e.varyings.add("vUV","vec2"),e.vertex.main.add(_`vUV = position;
gl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);`),e.fragment.uniforms.add(new Ne("textureInput",t=>t.input)),e.fragment.uniforms.add(new Ne("textureMask",t=>t.mask)),e.fragment.uniforms.add(new Ne("textureOverlay",t=>t.overlay)),e.fragment.uniforms.add(new au("maskEnabled",t=>t.magnifier.maskEnabled)),e.fragment.uniforms.add(new au("overlayEnabled",t=>t.magnifier.overlayEnabled)),e.fragment.code.add(_`const float barrelFactor = 1.1;
vec2 barrel(vec2 uv) {
vec2 uvn = uv * 2.0 - 1.0;
if (uvn.x == 0.0 && uvn.y == 0.0) {
return vec2(0.5, 0.5);
}
float theta = atan(uvn.y, uvn.x);
float r = pow(length(uvn), barrelFactor);
return r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;
}`),e.fragment.main.add(_`float mask = maskEnabled ? texture(textureMask, vUV).a : 1.0;
vec4 inputColor = texture(textureInput, barrel(vUV)) * mask;
vec4 overlayColor = overlayEnabled ? texture(textureOverlay, vUV) : vec4(0);
fragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;`),e}function gX(e,t){const i=t.camera.pixelRatio,r=e.magnifier.offset.x*i,s=e.magnifier.offset.y*i;gn(e.magnifier.position,VT);const n=t.camera.screenToRender(VT,_X),a=Math.ceil(i*e.magnifier.size),{fullWidth:o,fullHeight:l}=t.camera;return cr(yX,(n[0]+r)/o*2-1,(n[1]-s)/l*2-1,a/o*2,a/l*2)}const VT=si(),_X=O4(),yX=Vt(),vX=Object.freeze(Object.defineProperty({__proto__:null,MagnifierPassParameters:yw,build:p5},Symbol.toStringTag,{value:"Module"}));let zT=class extends ct{constructor(e,t){super(e,t,new ht(vX,()=>k(()=>Promise.resolve().then(()=>vee),void 0)),ai)}initializePipeline(){return Ge({blending:fu,depthTest:null,depthWrite:null,colorWrite:st})}};async function bX(e){const t=k(()=>le(()=>import("./mask-svg-BZIDpTf0-BZIDpTf0.js"),[]),[]),i=k(()=>le(()=>import("./overlay-svg-DKwEt0oU-DKwEt0oU.js"),[]),[]),r=ic((await t).default,{signal:e}),s=ic((await i).default,{signal:e}),n={mask:await r,overlay:await s};return qe(e),n}let Pl=class extends qo{constructor(){super(...arguments),this.produces=ne.MAGNIFIER,this.consumes={required:[ne.MAGNIFIER]},this._imageSources=null,this._imageLoadTask=null,this._passParameters=new yw,this._magnifier=null,this._tmpScreenPoint=si(),this._tmpRenderPoint=O4()}initialize(){this.addHandles([M(()=>this.view.magnifier,e=>this._update(e),Ve)])}_update(e){if(e===this._magnifier)return;this.removeAllHandles(),this._magnifier=e;const t=()=>{const i=this._validMagnifier;i?(this._loadResources(i),this.produces=ne.MAGNIFIER):this.produces="disabled",this.requestRender()};this._magnifier&&this.addHandles(M(()=>this._magnifier?.version,t)),t()}get _validMagnifier(){return this._magnifier?.visible&&this._magnifier?.position&&this._magnifier?.size>0?this._magnifier:null}get _factor(){return this._magnifier?.factor||1}destroy(){this._magnifier=null,this._imageLoadTask!=null&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeTextures(),this._vao=ye(this._vao)}_disposeTextures(){this._passParameters.mask=ye(this._passParameters.mask),this._passParameters.overlay=ye(this._passParameters.overlay),this._passParameters.input=ye(this._passParameters.input)}precompile(){this._imageSources&&this.techniques.precompile(zT)}render(e){const t=this._validMagnifier,i=e.find(({name:v})=>v===ne.MAGNIFIER);if(t==null)return i;if(this._imageSources==null)return this.requestRender(1),i;const r=this.renderingContext,s=this.camera.pixelRatio,n=Math.ceil(s*t.size);this._vao??=Zo(r,0,0,1);const a=this.techniques.get(zT);if(this._ensureTextureResources(r,n),!a.compiled||!this._passParameters.input)return this.requestRender(1),i;const o=Math.ceil(1/this._factor*n),l=this._passParameters.input;l.resize(o,o),gn(t.position,this._tmpScreenPoint);const c=this.camera.screenToRender(this._tmpScreenPoint,this._tmpRenderPoint),u=this.camera.fullWidth,p=this.camera.fullHeight,m=.5*o,f=.5*o;c[0]=j(c[0],m,u-m-1),c[1]=j(c[1],f,p-f-1);const g=Math.floor(c[0]-m),y=Math.floor(c[1]-f);return r.bindFramebuffer(i.fbo),a.program.bindTexture("textureInput",l),r.gl.copyTexImage2D(l.descriptor.target,0,l.descriptor.pixelFormat,g,y,o,o,0),this._passParameters.magnifier=t,r.bindTechnique(a,this.bindParameters,this._passParameters),r.bindVAO(this._vao),r.drawArrays(St.TRIANGLE_STRIP,0,4),i}_loadResources(e){const{maskUrl:t,overlayUrl:i}=e;this._imageLoadTask?.maskUrl===t&&this._imageLoadTask?.overlayUrl===i||(this._imageLoadTask?.task.abort(),this._imageLoadTask=this._imageSources=null),this._imageSources||this._imageLoadTask||(this._imageLoadTask={maskUrl:t,overlayUrl:i,task:Ya(async r=>{const s=t==null||i==null?bX(r):null,n=t!=null?ic(t,{signal:r}):s.then(o=>o.mask),a=i!=null?ic(i,{signal:r}):s.then(o=>o.overlay);this._imageSources={mask:await n,overlay:await a}})})}_ensureTextureResources(e,t){this._imageSources==null||this._passParameters.size===t&&this._passParameters.input&&this._passParameters.mask&&this._passParameters.overlay||(this._disposeTextures(),this._imageSources.overlay.width=this._imageSources.mask.width=t,this._imageSources.overlay.height=this._imageSources.mask.height=t,this._passParameters.overlay=new bt(e,this._createTextureDescriptor(t,6408,this._imageSources.overlay),this._imageSources.overlay),this._passParameters.mask=new bt(e,this._createTextureDescriptor(t,6406,this._imageSources.mask),this._imageSources.mask),this._passParameters.input=new bt(e,this._createTextureDescriptor(t,6408,null)))}_createTextureDescriptor(e,t,i){const r=this.renderingContext,s=new gt(e);return s.pixelFormat=s.internalFormat=t,s.wrapMode=33071,s.flipped=!!i,s.preMultiplyAlpha=!(t!==6408||!i||M4(i.src)&&r.driverTest.svgPremultipliesAlpha.result),s}};h([d()],Pl.prototype,"produces",void 0),h([d()],Pl.prototype,"consumes",void 0),h([d()],Pl.prototype,"_imageSources",void 0),h([d()],Pl.prototype,"_imageLoadTask",void 0),Pl=h([D("esri.views.3d.webgl-engine.effects.magnifier.Magnifier")],Pl);const Yu=8,wX=16;function m5(){const e=new ut;e.include($i),e.fragment.uniforms.add(new Ne("edgesTexture",i=>i.inputTexture),new Ne("areaTexture",i=>i.areaTexture),new Ne("searchTexture",i=>i.searchTexture)),e.fragment.constants.add("smaaAreaTexPixelSize","vec2",[1/160,1/560]);const t=1/7;return e.fragment.code.add(_`
    vec4 sampleLevelZeroOffset(vec2 coord, vec2 offset, vec2 resolution) {
      return texture(edgesTexture, coord + offset.x * resolution);
    }

    float searchLength(vec2 e, float bias, float scale) {
      e.r = bias + e.r * scale;
      return 255.0 * texture(searchTexture, e).r;
    }

    float searchLeft(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(0.0, 1.0);
      for (int i = 0; i < ${_.int(Yu)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord -= vec2(2.0, 0.0) * resolution;
        if (! (texcoord.x > end && e.g > 0.8281 && e.r == 0.0)) break;
      }
      texcoord.x += 0.25 * resolution.x;
      texcoord.x += resolution.x;
      texcoord.x += 2.0 * resolution.x;
      texcoord.x -= resolution.x * searchLength(e, 0.0, 0.5);
      return texcoord.x;
    }

    float searchRight(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(0.0, 1.0);
      for (int i = 0; i < ${_.int(Yu)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord += vec2(2.0, 0.0) * resolution;
        if (! (texcoord.x < end && e.g > 0.8281 && e.r == 0.0)) break;
      }
      texcoord.x -= 0.25 * resolution.x;
      texcoord.x -= resolution.x;
      texcoord.x -= 2.0 * resolution.x;
      texcoord.x += resolution.x * searchLength(e, 0.5, 0.5);
      return texcoord.x;
    }

    float searchUp(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(1.0, 0.0);
      for (int i = 0; i < ${_.int(Yu)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord += vec2(0.0, 2.0) * resolution;
        if (! (texcoord.y > end && e.r > 0.8281 && e.g == 0.0)) break;
      }
      texcoord.y -= 0.25 * resolution.y;
      texcoord.y -= resolution.y;
      texcoord.y -= 2.0 * resolution.y;
      texcoord.y += resolution.y * searchLength(e.gr, 0.0, 0.5);
      return texcoord.y;
    }

    float searchDown(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(1.0, 0.0);
      for (int i = 0; i < ${_.int(Yu)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord -= vec2(0.0, 2.0) * resolution;
        if (! (texcoord.y < end && e.r > 0.8281 && e.g == 0.0)) break;
      }
      texcoord.y += 0.25 * resolution.y;
      texcoord.y += resolution.y;
      texcoord.y += 2.0 * resolution.y;
      texcoord.y -= resolution.y * searchLength(e.gr, 0.5, 0.5);
      return texcoord.y;
    }

    vec2 getArea(sampler2D areaTex, vec2 dist, float e1, float e2, float offset) {
      vec2 texcoord = float(${_.int(wX)}) * round(4.0 * vec2(e1, e2)) + dist;
      texcoord = smaaAreaTexPixelSize * texcoord + (0.5 * smaaAreaTexPixelSize);
      texcoord.y += ${_.float(t)} * offset;
      return texture(areaTex, texcoord).rg;
    }`),e.fragment.main.add(_`
    vec2 size = vec2(textureSize(edgesTexture, 0));
    vec2 resolution = 1.0 / size;
    vec2 pixelCoord = uv * size;
    vec4 offsets[2];
    offsets[0] = uv.xyxy + resolution.xyxy * vec4(-0.25, 0.125, 1.25, 0.125);
    offsets[1] = uv.xyxy + resolution.xyxy * vec4(-0.125, 0.25, -0.125, -1.25);
    vec4 maxOffset = vec4(offsets[0].xz, offsets[1].yw) + vec4(-2.0, 2.0, -2.0, 2.0) * resolution.xxyy * float(${_.int(Yu)});
    ivec4 subsampleIndices = ivec4(0.0);
    vec4 weights = vec4(0.0);
    vec2 e = texture(edgesTexture, uv).rg;
    if (e.r > 0.0) {
      vec2 d;
      vec2 coords;
      coords.y = searchUp(offsets[1].xy, maxOffset.z, resolution);
      coords.x = offsets[0].x;
      d.x = coords.y;
      float e1 = texture(edgesTexture, coords).g;
      coords.y = searchDown(offsets[1].zw, maxOffset.w, resolution);
      d.y = coords.y;
      d = d * size.y - pixelCoord.y;
      vec2 sqrt_d = sqrt(abs(d));
      coords.y -= 1.0 * resolution.y;
      float e2 = sampleLevelZeroOffset(coords, vec2(0.0, 1.0), resolution).g;
      weights.ba = getArea(areaTexture, sqrt_d, e1, e2, float(subsampleIndices.x));
      // for some reason the following lines are necessary to prevent
      // texture lookup precision issues on some Intel integrated graphics chips
      vec4 dbg = (offsets[0] + offsets[1] + maxOffset + coords.xyyx);
      weights.r += 0.00000001 * dot(vec4(0, 1, 0, 1), dbg);
    }
    if (e.g > 0.0) {
      vec2 d;
      vec2 coords;
      coords.x = searchLeft(offsets[0].xy, maxOffset.x, resolution);
      coords.y = offsets[1].y;
      d.x = coords.x;
      float e1 = texture(edgesTexture, coords).r;
      coords.x = searchRight(offsets[0].zw, maxOffset.y, resolution);
      d.y = coords.x;
      d = d * size.x - pixelCoord.x;
      vec2 sqrt_d = sqrt(abs(d));
      coords.y -= 1.0 * resolution.y;
      float e2 = sampleLevelZeroOffset(coords, vec2(1.0, 0.0), resolution).r;
      weights.rg = getArea(areaTexture, sqrt_d, e1, e2, float(subsampleIndices.y));
    }
    fragColor = weights;
  `),e}const xX=Object.freeze(Object.defineProperty({__proto__:null,build:m5},Symbol.toStringTag,{value:"Module"}));let kT=class extends ct{constructor(e,t){super(e,t,new ht(xX,()=>k(()=>Promise.resolve().then(()=>bee),void 0)),ai)}initializePipeline(){return Ge({colorWrite:st})}};function f5(){const e=new ut;return e.include($i),e.fragment.uniforms.add(new Ne("blendWeightsTexture",t=>t.inputTexture),new Ne("colorTexture",t=>t.color)),e.fragment.main.add(_`vec2 resolution = 1.0 / vec2(textureSize(colorTexture, 0));
vec4 offsets = vec4(uv.x + resolution.x, uv.y, uv.x, uv.y - resolution.y);
vec4 a;
a.rb = texture(blendWeightsTexture, uv).rb;
a.g = texture(blendWeightsTexture, offsets.zw).g;
a.a = texture(blendWeightsTexture, offsets.xy).a;
if ( dot(a, vec4(1.0)) < 1e-5 ) {
fragColor = texture( colorTexture, uv, 0.0 );
} else {
vec2 offset;
offset.x = a.a > a.b ? a.a : -a.b;
offset.y = a.g > a.r ? -a.g : a.r;
if ( abs( offset.x ) > abs( offset.y )) {
offset.y = 0.0;
} else {
offset.x = 0.0;
}
vec4 C = texture( colorTexture, uv, 0.0 );
vec4 Cop = texture( colorTexture, uv + sign( offset ) * resolution.xy, 0.0 );
float s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );
fragColor = mix(C, Cop, s);
}`),e}const CX=Object.freeze(Object.defineProperty({__proto__:null,build:f5},Symbol.toStringTag,{value:"Module"}));let BT=class extends ct{constructor(e,t){super(e,t,new ht(CX,()=>k(()=>Promise.resolve().then(()=>wee),void 0)),ai)}initializePipeline(){return Ge({colorWrite:st})}};const SX=.05,TX=2;function g5(){const e=new ut;return e.include($i),e.outputs.add("fragEdges","vec2"),e.fragment.code.add(_`float absMax3(vec3 v) {
vec3 t = abs(v);
return max(max(t.r, t.g), t.b);
}`),e.fragment.uniforms.add(new Ne("colorTexture",t=>t.color)).main.add(_`
    vec2 resolution = 1.0 / vec2(textureSize(colorTexture, 0));
    vec4 offsets[3];
    offsets[0] = vec4(uv.x - resolution.x, uv.y, uv.x, uv.y + resolution.y);
    offsets[1] = vec4(uv.x + resolution.x, uv.y, uv.x, uv.y - resolution.y);
    offsets[2] = vec4(uv.x - 2.0 * resolution.x, uv.y, uv.x, uv.y + 2.0 * resolution.y);

    // Calculate color deltas:
    vec3 C = texture(colorTexture, uv).rgb;
    vec3 Cleft = texture(colorTexture, offsets[0].xy).rgb;
    vec3 Ctop = texture(colorTexture, offsets[0].zw).rgb;
    vec2 delta = vec2(absMax3(C - Cleft), absMax3(C - Ctop));
    vec2 edges = step(vec2(${_.float(SX)}), delta);

    // discard if there is no edge:
    if (dot(edges, vec2(1.0)) == 0.0) {
      fragEdges = vec2(0.0);
    }
    else {
      // Calculate right and bottom deltas:
      vec3 Cright = texture(colorTexture, offsets[1].xy).rgb;
      float horizontal = absMax3(C - Cright);

      vec3 Cbottom  = texture(colorTexture, offsets[1].zw).rgb;
      float vertical = absMax3(C - Cbottom);

      // Calculate the maximum delta in the direct neighborhood:
      float maxDelta = max(max(max(delta.x, delta.y), horizontal), vertical);

      // Calculate left-left and top-top deltas:
      vec3 Cleftleft  = texture(colorTexture, offsets[2].xy).rgb;
      horizontal = absMax3(C - Cleftleft);

      vec3 Ctoptop = texture(colorTexture, offsets[2].zw).rgb;
      vertical = absMax3(C - Ctoptop);

      // Calculate the final maximum delta:
      maxDelta = max(max(maxDelta, horizontal), vertical);

      // Local contrast adaptation in action:
      fragEdges = edges * step(maxDelta, float(${_.float(TX)}) * delta);
    }
  `),e}const PX=Object.freeze(Object.defineProperty({__proto__:null,build:g5},Symbol.toStringTag,{value:"Module"}));let NT=class extends ct{constructor(e,t){super(e,t,new ht(PX,()=>k(()=>Promise.resolve().then(()=>xee),void 0)),ai)}initializePipeline(){return Ge({colorWrite:st})}},MX=class extends Kt{},Ml=class extends qo{constructor(e){super(e),this.produces="disabled",this.consumes={required:[ne.ANTIALIASING],optional:[Ft.COMPOSITE]},this._areaTexture=null,this._searchTexture=null,this._smaaParameters=new MX}initialize(){this.addHandles([M(()=>this.isEnabled(),e=>e?this.enable():this.disable(),Ve)])}async enable(){if(this.destroyed||(this.produces=ne.ANTIALIASING,this.requestRender(1),this._abortController||this._areaTexture&&this._searchTexture))return;this._abortController=new AbortController;const e=this._abortController.signal;try{const t=await k(()=>le(()=>import("./SMAAData-DCEZ61Cs-DCEZ61Cs.js"),[]),[]);qe(e),await this._loadTextures(t,e),qe(e),this.requestRender(1)}catch(t){js(t)||$.getLogger(this).errorOnce(t)}this._abortController=null}async _loadTextures(e,t){qe(t);const[i,r]=await Promise.allSettled([ic(e.areaTexture,{signal:t}),ic(e.searchTexure,{signal:t})]);if(qe(t),i.status!=="fulfilled"||r.status!=="fulfilled")return;const s=this.renderingContext;this._areaTexture=jT(s,9729,6407,i.value),this._searchTexture=jT(s,9728,6409,r.value)}disable(){this.produces="disabled",this.requestRender(1)}destroy(){this._abortController=Ar(this._abortController),this._searchTexture=ye(this._searchTexture),this._areaTexture=ye(this._areaTexture)}precompile(){this.techniques.precompile(NT),this.techniques.precompile(kT),this.techniques.precompile(BT)}render(e){const t=e.find(({name:m})=>m===ne.ANTIALIASING),i=e.find(({name:m})=>m===Ft.COMPOSITE);if(!i)return t;if(!this._areaTexture||!this._searchTexture)return this.view.stage.renderer.blitFBO(i,t,!1),this.requestRender(1),t;const r=this.techniques.get(NT),s=this.techniques.get(kT),n=this.techniques.get(BT);if(!r.compiled||!s.compiled||!n.compiled)return this.view.stage.renderer.blitFBO(i,t,!1),this.requestRender(1),t;const a=i.fbo.width,o=i.fbo.height,l=this.renderingContext;l.setViewport(0,0,a,o);const c=this.fboCache.acquire(a,o,"smaa edges",2);l.bindFramebuffer(c.fbo),l.setClearColor(0,0,0,1),l.clear(16384),this._smaaParameters.color=i.getTexture();const u=this.bindParameters;l.bindTechnique(r,u,this._smaaParameters),l.screen.draw();const p=this.fboCache.acquire(a,o,"smaa blend");return l.bindFramebuffer(p.fbo),l.setClearColor(0,0,1,1),l.clear(16384),this._smaaParameters.inputTexture=c.getTexture(),this._smaaParameters.areaTexture=this._areaTexture,this._smaaParameters.searchTexture=this._searchTexture,l.bindTechnique(s,u,this._smaaParameters),l.screen.draw(),c.release(),l.bindFramebuffer(t.fbo),l.setClearColor(0,1,0,1),l.clear(16384),this._smaaParameters.inputTexture=p.getTexture(),l.bindTechnique(n,u,this._smaaParameters),l.screen.draw(),p.release(),t}};function jT(e,t,i,r){const s=new gt(r.width,r.height);return s.pixelFormat=i,s.wrapMode=33071,s.samplingMode=t,new bt(e,s,r)}h([d()],Ml.prototype,"produces",void 0),h([d()],Ml.prototype,"consumes",void 0),h([d({constructOnly:!0})],Ml.prototype,"isEnabled",void 0),h([d()],Ml.prototype,"_abortController",void 0),Ml=h([D("esri.views.3d.webgl-engine.effects.smaa.SMAA")],Ml);function _5(){const e=new ut;return e.attributes.add("position","vec3"),e.attributes.add("color","vec4"),e.attributes.add("size","float"),e.varyings.add("vcolor","vec4"),e.varyings.add("vsize","float"),e.vertex.uniforms.add(new N8("transform",(t,i)=>RX(t,i)),new M_("viewport",t=>t.camera.fullViewport),new Er("pixelRatio",t=>t.camera.pixelRatio)),e.vertex.main.add(_`gl_Position = transform * vec4(position, 0);
vcolor = color / 1.2;
vsize = size * 5.0 * pixelRatio;
gl_PointSize = vsize;`),e.fragment.main.add(_`float cap = 0.7;
float scale = 1.0 / cap;
float helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);
float alpha = clamp((cap - helper) * scale, 0.0, 1.0);
float intensity = alpha * alpha * alpha;
if (vsize < 3.0) {
intensity *= 0.5;
}
fragColor = vec4(vcolor.xyz, intensity);`),e}function RX(e,t){return ks(uo,t.camera.projectionMatrix),uo[10]=24e-8-1,uo[11]=-1,uo[14]=(24e-8-2)*t.camera.near,lr(uo,uo,t.camera.viewMatrix),lr(uo,uo,e.modelMatrix)}const uo=Le(),DX=Object.freeze(Object.defineProperty({__proto__:null,build:_5},Symbol.toStringTag,{value:"Module"}));let OX=class extends Kt{constructor(){super(...arguments),this.modelMatrix=Le()}},UT=class extends ct{constructor(e,t){super(e,t,new ht(DX,()=>k(()=>Promise.resolve().then(()=>Cee),void 0)),l2.locations)}initializePipeline(){return Ge({blending:ja,depthTest:{func:515},colorWrite:st})}};const l2=Ka().vec3f("position").vec4u8("color").f32("size").freeze();let c2=class extends ea{constructor(){super(...arguments),this._numPoints=0,this._passParameters=new OX}initialize(){this.addHandles([M(()=>this.view.environment.starsEnabled,e=>e?this._enable():this._disable(),Ee),M(()=>this.view.environment.lighting.type==="virtual"?null:this.view.environment.lighting.date,e=>this._update(e),Ve)])}_enable(){super._enable(),this._loadDataTask=this._createLoadDataTask()}get loading(){return!!this._loadDataTask&&!this._loadDataTask.finished}destroy(){this._loadDataTask=Ar(this._loadDataTask),this._numPoints=0,this._vao=ye(this._vao),this._starData=null}precompile(){this.techniques.precompile(UT)}render(e){const t=e.find(({name:s})=>s===ne.OPAQUE_ENVIRONMENT),i=this.renderingContext;if(this.loading)return this.requestRender(1),t;if(!this._starData)return t;this._vao??=this._ensureResources(this._starData,i);const r=this.techniques.get(UT);return r.compiled?(i.bindTechnique(r,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(St.POINTS,0,this._numPoints),t):(this.requestRender(1),t)}_ensureResources(e,t){return this._numPoints=e.byteLength/y5,EX(t,new Float32Array(e,0,2*this._numPoints),new Uint8Array(e,2*this._numPoints*4,this._numPoints),this._numPoints)}_update(e){if(!e)return;const t=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,i=2*AX(e),r=ks(this._passParameters.modelMatrix,kX);Fv(r,r,-i*Math.PI),lr(r,zX,r),Fv(r,r,-t*Math.PI),this.requestRender(1)}_createLoadDataTask(){if(this._starData)return null;const e=Ya(async t=>{const{data:i}=await l9("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:t});IX(i),this._starData=i});return e.promise.catch(t=>{js(t)||$.getLogger(this).error(t)}).then(()=>{this.destroyed||this.requestRender(1)}),e}};function EX(e,t,i,r){const s=l2.createBuffer(r),n=s.position,a=s.color,o=s.size;for(let l=0;l<r;l++){const c=t[2*l],u=t[2*l+1];n.set(l,0,-Math.cos(c)*Math.sin(u)),n.set(l,1,-Math.sin(c)*Math.sin(u)),n.set(l,2,-Math.cos(u));const p=FX(i[l]),m=LX(VX[p[1]]);a.set(l,0,255*m[0]),a.set(l,1,255*m[1]),a.set(l,2,255*m[2]),a.set(l,3,255),o.set(l,p[0])}return new Dn(e,new ei(e,Bs(l2),s.buffer))}function AX(e){const t=e,i=new Date(e.getFullYear(),0,1,11,58,56);return(+t-+i)/(+new Date(e.getFullYear()+1,0,1,11,58,55)-+i)}function IX(e){if(!e)throw new fe("stars:no-data-received","Failed to create stars because star catalogue is missing");const t=e.byteLength/y5;if(t%1!=0||t>5e4||t<5e3)throw new fe("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}function LX(e){return[parseInt(e.slice(0,2),16),parseInt(e.slice(2,4),16),parseInt(e.slice(4,6),16)]}function FX(e){return e>=192?[2.9,e-192]:e>=160?[2.5,e-160]:e>=128?[2,e-128]:e>=96?[1.5,e-96]:e>=64?[1,e-64]:e>=32?[.7,e-32]:[.4,e]}c2=h([D("esri.views.3d.webgl-engine.effects.stars.Stars")],c2);const VX=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],zX=iM(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),kX=iM(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),y5=9;let vw=class extends Kt{};function v5(){const e=new ut;return e.include($i),e.fragment.uniforms.add(new Ne("tex",t=>t.texture)),e.fragment.main.add(_`fragColor = vec4(1.0 - texture(tex, uv).a);`),e}const BX=Object.freeze(Object.defineProperty({__proto__:null,HUDCompositingPassParameters:vw,build:v5},Symbol.toStringTag,{value:"Module"}));let HT=class extends ct{constructor(e,t){super(e,t,new ht(BX,()=>k(()=>Promise.resolve().then(()=>See),void 0)),ai)}initializePipeline(){return Ge({colorWrite:{r:!1,g:!0,b:!1,a:!1}})}},NX=class{constructor(e,t){this._rctx=e,this._techniques=t,this._configuration=new ap,this._passParameters=new J_,this._hudParameters=new vw,this._configuration.blitMode=2,this._techniques.precompile(Xn,this._configuration),this._configuration.blitEmissiveMode=1,this._techniques.precompile(Xn,this._configuration),this._configuration.blitMode=1,this._techniques.precompile(Xn,this._configuration),this._configuration.blitEmissiveMode=0,this._techniques.precompile(Xn,this._configuration),this._configuration.blitMode=3,this._techniques.precompile(Xn,this._configuration),this._techniques.precompile(HT)}compositeHUD(e,t){this._hudParameters.texture=t;const i=this._techniques.get(HT);this._rctx.bindTechnique(i,e,this._hudParameters),this._rctx.screen.draw()}compositePreMultipliedAlpha(e,t,i){this._composite(e,t,2,i)}composite(e,t,i){this._composite(e,t,1,i)}blitDepthToLinearDepth(e,t){this._composite(e,t,3)}_composite(e,t,i,r=0){this._configuration.blitMode=i,this._configuration.blitEmissiveMode=r,this._passParameters.texture=t;const s=this._techniques.get(Xn,this._configuration);this._rctx.bindTechnique(s,e,this._passParameters),this._rctx.screen.draw()}},jX=class{constructor(){this.declaredClass="esri.views.3d.webgl-engine.lib.ObjectAndLayerIdRenderHelper",this.colorZero=new jg(new ArrayBuffer(4)),this._layerToOidToColor=new $a,this._colorToUID=new Map,this._layerViewUidToGraphicsUidToObjectId=new $a,this._layerViewUidToLayerId=new Map,this._layerViewUidToPopupEnabled=new Map}setUidToObjectAndLayerId(e,t,i,r,s,n=null,a=null,o=null){e&&t&&i&&r&&(this._layerViewUidToLayerId.set(r,i),this._layerViewUidToPopupEnabled.set(r,s),s&&this._layerViewUidToGraphicsUidToObjectId.set(r,t,{objectId:e,attributeNodeId:n,attributeIndex:a,subLayerId:o}))}getObjectAndLayerIdColor(e){const t=this.getObjectAndLayerIdColorArray(e);return Mi(t.get(0,1),t.get(0,2),t.get(0,3),255)}getObjectAndLayerIdColorArray(e){if(!e.layerViewUid||!e.graphicUid)return this.colorZero;const t=this._layerViewUidToPopupEnabled.get(e.layerViewUid);if(t===void 0)return this.colorZero;if(t===!1)return this.colorZero;const i=this._layerViewUidToGraphicsUidToObjectId.get(e.layerViewUid,e.graphicUid)?.objectId;if(!i)return this.colorZero;let r=this._layerToOidToColor.get(e.layerViewUid,i);if(!r){if(Qe("enable-feature:objectAndLayerId-screenshot-testing"))r=i;else for(;!r;){const n=Math.floor(16777214*Math.random())+1;this._colorToUID.has(n)||(r=n)}if(r>16777215)throw new Error("Object ID Overflow");this._layerToOidToColor.set(e.layerViewUid,i,r),this._colorToUID.set(r,e)}const s=new ArrayBuffer(4);return new DataView(s).setUint32(0,r,!1),new jg(s)}getColorToObjectAndLayerIdMapping(){const e=new Map;for(const[t,i]of this._colorToUID.entries()){const r=this._layerViewUidToGraphicsUidToObjectId.get(i.layerViewUid,i.graphicUid),s=this._layerViewUidToLayerId.get(i.layerViewUid);r&&s&&e.set(t,r.attributeNodeId?{type:"object-and-layer-and-i3s-id",olid:r.objectId,lid:s,attrId:r.attributeNodeId,attrIdx:r.attributeIndex,subLayerId:r.subLayerId}:{type:"object-and-layer-id",olid:r.objectId,lid:s})}return e}},b5=class{constructor(e,t){this.key=e,this._free=t,this.incarnation=0,this._refCount=1}retain(e=1){this._refCount+=e}release(){return this._refCount===0?(console.log(`Releasing already released FBO attachment "${this.name}" in ${new Error().stack}`),!0):(--this._refCount,this._refCount===0&&(this._free(),!0))}get test(){}},w5=class extends b5{constructor(e,t,i){super(e,i),this.attachment=t,this.name=""}dispose(){this.attachment.dispose()}get usedMemory(){return this.attachment.usedMemory}},UX=class extends w5{constructor(e,t,i){super(e,t,i),this.attachment=t,this.type=2}},HX=class extends w5{constructor(){super(...arguments),this.type=1}},qX=class extends HX{constructor(e,t,i){super(e,t,i),this.attachment=t}};function GX(e){return e?.attachment.type===1}let x5=class extends b5{constructor(e,t,i,r,s,n){super(e,n),this.fbo=i,this.type=0,this._colors=new Map,this._name=Ft.COMPOSITE,this.acquireColor=null,this.acquireDepth=null,this._name=t,this.acquireColor=r,this.acquireDepth=s}dispose(){this.fbo?.dispose()}get usedMemory(){return this.fbo?.usedMemory||0}get numberOfColorAttachments(){return this._colors.size}get name(){return this._name}setName(e){this._name=e}getTexture(e=Et){return e===qi?this.fbo?.depthStencilTexture:this.fbo?.getColorTexture(e)}get depthTexture(){return this.getTexture(qi)}getAttachment(e=Et){return e===qi?this._depth:this._colors.get(e)}hasAttachment(e){return fn(this._colors,t=>t.name===e)}attachDepth(e){return e?.retain(),this.detachDepth(),e&&this.fbo?.attachDepthStencil(e.attachment),this._depth=e,this}detachDepth(){this.fbo?.detachDepthStencilTexture(),this.fbo?.detachDepthStencilBuffer(),this._depth=Ht(this._depth)}obtainDepthTexture(){const e=this._depth;return GX(e)?(this.fbo?.detachDepthStencilTexture(),this._depth=null,e):null}attachColor(e,t){return e.retain(),this.detachColor(t),this.fbo?.attachColorTexture(e.attachment,t),this._colors.set(t,e),this}detachColor(e){this.fbo?.detachColorTexture(e);const t=this._colors.get(e);this._colors.delete(e),t?.release()}detachAllColors(){this._colors.forEach((e,t)=>this.detachColor(t))}detachAll(){this.detachAllColors(),this.detachDepth()}detachAllColorsBut0(){this._colors.forEach((e,t)=>{t!==Et&&this.detachColor(t)})}detachAllButColor0(){this.detachAllColorsBut0(),this.detachDepth()}};function $X(e){switch(e){case 0:return"R8UNORM";case 1:return"R8UINT";case 2:return"RG8UNORM";case 3:return"RG8UINT";case 4:return"RGBA4UNORM";case 5:return"RGBA8UNORM";case 6:return"RGBA8UNORM_MIPMAP";case 7:return"R16FLOAT";case 8:return"RGBA16FLOAT";case 9:return"R32FLOAT";case 10:return"RG32FLOAT";case 11:return"RGBA32UINT";case 12:return"COUNT"}}function WX(e){switch(e){case 12:return"DEPTH16";case 13:return"DEPTH24_STENCIL8"}}function iv(e){return h2(e)?WX(e):$X(e)}function h2(e){return e>=12}const bg=new gt;bg.pixelFormat=6403,bg.internalFormat=Lr.R8,bg.wrapMode=33071;const Id=new gt;Id.pixelFormat=36244,Id.internalFormat=Lr.R8UI,Id.wrapMode=33071,Id.samplingMode=9728;const wg=new gt;wg.pixelFormat=33319,wg.internalFormat=Lr.RG8,wg.wrapMode=33071;const Ld=new gt;Ld.pixelFormat=33320,Ld.internalFormat=Lr.RG8UI,Ld.wrapMode=33071,Ld.samplingMode=9728;const xg=new gt;xg.internalFormat=Lr.RGBA4,xg.dataType=ni.UNSIGNED_SHORT_4_4_4_4,xg.wrapMode=33071;const C5=new gt;C5.wrapMode=33071;const Fd=new gt;Fd.wrapMode=33071,Fd.samplingMode=9987,Fd.hasMipmap=!0,Fd.maxAnisotropy=8;const Vd=new gt;Vd.pixelFormat=6403,Vd.dataType=ni.HALF_FLOAT,Vd.internalFormat=Lr.R16F,Vd.samplingMode=9728;const Cg=new gt;Cg.dataType=ni.HALF_FLOAT,Cg.internalFormat=Lr.RGBA16F,Cg.wrapMode=33071;const zd=new gt;zd.pixelFormat=6403,zd.dataType=ni.FLOAT,zd.internalFormat=Lr.R32F,zd.samplingMode=9728;const kd=new gt;kd.pixelFormat=33319,kd.dataType=ni.FLOAT,kd.internalFormat=Lr.RG32F,kd.samplingMode=9728;const yh=new gt;yh.pixelFormat=36249,yh.dataType=ni.UNSIGNED_INT,yh.internalFormat=Lr.RGBA32UI,yh.samplingMode=9728,yh.wrapMode=33071;const ZX={0:bg,1:Id,2:wg,3:Ld,4:xg,5:C5,6:Fd,7:Vd,8:Cg,9:zd,10:kd,11:yh,12:null},QX={[Wl.DEPTH_COMPONENT16]:ni.UNSIGNED_SHORT,[Wl.DEPTH_COMPONENT24]:ni.UNSIGNED_INT,[Wl.DEPTH_COMPONENT32F]:ni.FLOAT,[iu.DEPTH24_STENCIL8]:ni.UNSIGNED_INT_24_8,[iu.DEPTH32F_STENCIL8]:ni.FLOAT_32_UNSIGNED_INT_24_8_REV},XX={13:qT(iu.DEPTH24_STENCIL8),12:qT(Wl.DEPTH_COMPONENT16)};function qT(e){const t=new gt;return t.pixelFormat=D8(e)?6402:34041,t.dataType=QX[e],t.samplingMode=9728,t.wrapMode=33071,t.internalFormat=e,t.hasMipmap=!1,t.isImmutable=!0,t}let rv=class{constructor(e,t){this._last=new jt,this._incarnation=0,this._cache=new Yp(e,t)}destroy(){this._last?.forAll(e=>e.dispose()),this._last?.prune(),this._last=null,this._cache.destroy()}set interactive(e){e&&!this._last?this._last=new jt:e||(this._last?.forAll(t=>t.dispose()),this._last=null)}clean(){this._last?.filterInPlace(e=>!(e.incarnation<this._incarnation)||(this._cache.put(e.key,e),!1))}frame(){++this._incarnation}pop(e){if(this._last){const t=this._last.find(i=>i.key===e);if(t)return this._last.removeUnordered(t),t}return this._cache.pop(e)}put(e){e.incarnation=this._incarnation,this._last?this._last.push(e):this._cache.put(e.key,e)}get usedMemory(){return this._last?.reduce((e,t)=>e+t.usedMemory,0)??0}},YX=class{constructor(e){this.rctx=e,this._interactive=!1,this._usage=new Map,this._acquired=new Set,this._cache=new rv(e.newCache,"FBOCache"),this._depthCache=new rv(e.newCache,"DepthAttachmentCache"),this._colorCache=new rv(e.newCache,"ColorAttachmentCache")}destroy(){this._cache.destroy(),this._depthCache.destroy(),this._colorCache.destroy()}clean(){this._cache.clean(),this._colorCache.clean(),this._depthCache.clean()}frameStart(){this._cache.frame(),this._colorCache.frame(),this._depthCache.frame(),this.debugCallback?.(),this._usage.clear()}frameEnd(){const{debugCallback:e}=this;e&&this._acquired.forEach(t=>e(t.name,t.fbo,this._usage))}get usedMemory(){return Array.from(this._acquired.values()).reduce((e,t)=>e+t.usedMemory,this._cache.usedMemory+this._colorCache.usedMemory+this._depthCache.usedMemory)}set interactive(e){this._cache.interactive=this._colorCache.interactive=this._depthCache.interactive=e,this._interactive=e}get interactive(){return this._interactive}acquire(e,t,i,r=5){const s=sv(r,e,t);let n=this._cache.pop(s);const{rctx:a}=this;if(n){n.retain(),n.setName(i);const o=n.getAttachment(qi);o&&(o.name=$T(i));const l=n.getAttachment(Et);l&&(l.name=GT(i,0));const c=n.fbo;c?a.temporaryBindFramebufferObject(c,()=>{a.setDrawBuffers([Et]),a.unbindTexture(c.colorTexture)}):$.getLogger("esri.views.3d.webgl-engine.core.FBOCache").errorOnce("Encountered an invalid cached framebuffer")}else{const o=new Wo(a),l=(p,m,f)=>{m??=5;const g=this._acquireColor(m,e,t,f??GT(n.name,p-Et));return this.rctx.unbindTexture(g.attachment),n.attachColor(g,p),g.release(),n},c=p=>{p??=13;const m=this.acquireDepth(p,e,t,$T(n.name));return n.attachDepth(m),m.release(),n},u=()=>{if(!n)return;this.debugCallback?.(n.name,n.fbo),this._acquired.delete(n);const p=h2(r);p&&n.getAttachment(qi)!=null||!p&&n.getAttachment(Et)!=null?(p?(n.fbo?.invalidateAttachments([qi]),n.detachAllColors()):(n.fbo?.invalidateAttachments([Et]),n.detachAllButColor0()),this._cache.put(n)):n.dispose()};n=new x5(s,i,o,l,c,u),h2(r)?n.acquireDepth(r):n.acquireColor(Et,r,i)}return this._trackUsage(n,"fbo "+iv(r),e,t),this._trackHandle(n)}acquireDepth(e,t,i,r){const s=sv(e,t,i);let n=this._depthCache.pop(s);if(n)n.retain(),n.attachment.setShadowFiltering(!1);else{const a=new bt(this.rctx,{...XX[e],width:t,height:i});n=new qX(s,a,()=>this._depthCache.put(n))}return n.name=r,this._trackUsage(n,"depth "+iv(e),t,i),n}_acquireColor(e,t,i,r){const s=sv(e,t,i);let n=this._colorCache.pop(s);if(n)n.retain();else{const a=new bt(this.rctx,{...ZX[e],width:t,height:i});n=new UX(s,a,()=>this._colorCache.put(n))}return n.name=r,this._trackUsage(n,"color "+iv(e),t,i),n}_trackHandle(e){return this._acquired.add(e),e}_trackUsage(e,t,i,r){this.debugCallback&&(this._usage.has(e)?this._usage.get(e)[2].push(e.name):this._usage.set(e,[t,`${i}x${r}`,[e.name]]))}};function GT(e,t=0){return`${e}.color${t}`}function $T(e){return`${e}.depth`}const hu=new x5("default","default",null,()=>hu,()=>hu,()=>{});function sv(e,t,i){return`${t}x${i}:${e}`}hu.release=()=>!1;let tn=class{constructor(e,t,i=0){this._rctx=e,this._techniques=t,this._sorting=i,this._draws=new jt({allocator:r=>r??{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._previouslyBoundDraw=new Map}submitDraw(e,t,i,r,s){const n=this._draws.pushNew();n.geometry=t,n.geometryRanges=i,n.material=e,n.depthSquaredHint=r,n.indexType=(t.indexed?t.vao.indexBuffer.indexType:null)??0,n.highlightName=s}acquire(e,t){return this._draws.map(i=>i.material.acquireTechnique(this._techniques,e,t,i.geometry.parameters))}dispatch(e,t,i){const r=this._rctx;this._previouslyBoundDraw.clear();let s=null;const n=this._draws.length,a=t.highlight?.name;for(let o=0;o<n;o++){const l=this._draws.data[o];if(e.identifier===2){const v=l.highlightName;if(v){if(v!==a)continue}else if(!a||!t.overlay?.hasHighlight(a))continue}const c=i[o];c===s&&t.oitPass===0||(r.bindTechnique(c,t,e),s=c);const{geometryRanges:u,indexType:p,geometry:m,material:f}=l;r.bindVAO(m.vao),this._previouslyBoundDraw.get(c)!==f&&(c.program.bindDraw(t,e,f),this._previouslyBoundDraw.set(c,f));const g=u.length,{primitiveType:y}=m;for(let v=0;v<g;v+=2){const C=u[v],b=u[v+1];if(p!==0){const S=Sg.get(p);r.drawElements(y,b,p,C*S)}else r.drawArrays(y,C,b)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){const e=this._sorting===0?1:-1;this._draws.sort((t,i)=>e*(t.depthSquaredHint-i.depthSquaredHint)||t.geometry.vao.usedMemory-i.geometry.vao.usedMemory)}get count(){return this._draws.length}};const Sg=new Map;Sg.set(Tn.UNSIGNED_BYTE,1),Sg.set(Tn.UNSIGNED_SHORT,2),Sg.set(Tn.UNSIGNED_INT,4);let KX=class{constructor(e){const t=e.renderContext.rctx,i=e.techniques;this.opaque=new tn(t,i),this.transparent=new tn(t,i,1),this.integratedMesh=new tn(t,i),this.transparentIntegratedMesh=new tn(t,i),this.occludedGround=new tn(t,i),this.shadowMap=new tn(t,i),this.highlight=new tn(t,i),this.highlightIntegratedMesh=new tn(t,i),this.highlightShadowMap=new tn(t,i),this.viewshedShadowMap=new tn(t,i),this.defaultShadowMap=new tn(t,i)}},iy=class extends B8{constructor(){super(...arguments),this.slicePlaneLocalOrigin=w(),this.origin=this.slicePlaneLocalOrigin}},JX=class extends iy{constructor(){super(...arguments),this.identifier=0,this.output=0,this.transparent=!1,this.occludedGround=!1}},eY=class extends iy{constructor(){super(...arguments),this.identifier=1}},tY=class extends iy{constructor(){super(...arguments),this.identifier=2}},iY=class extends iy{constructor(){super(...arguments),this.identifier=3}},u2=class extends Zp{constructor(){super(...arguments),this.produces=new Map([[2,e=>this._produces(e,2)],[4,e=>this._produces(e,4)],[0,e=>this._produces(e,0)],[7,e=>this._produces(e,7)],[9,e=>this._produces(e,9)]]),this._materialPassParameters=new JX,this._shadowPassParameters=new eY,this._highlightPassParameters=new tY,this._viewshedPassParameters=new iY,this._systems=new Set}initializeRenderContext(e){this._context=e,this._passes=new KX(e)}get rctx(){return this._context.renderContext.rctx}uninitializeRenderContext(){}dispose(){this._context=null,this._systems.clear(),this._passes=null}register(e){this._systems.add(e)}_produces(e,t){return!!this._invoke(e,t,i=>i.count>0)}prepareRender(e){const{_systems:t,_passes:i}=this;if(t.size!==0&&i!=null){for(const r of Object.values(i))r.prepareSubmit();t.forEach(r=>r.submit(i,e.bind));for(const r of Object.values(i))r.finishSubmit()}}acquireTechniques(e){if(this._systems.size===0)return null;const t=e.output===4||e.output===5||e.output===6?this._shadowPassParameters:e.output===7?this._viewshedPassParameters:e.output===9?this._highlightPassParameters:this._materialPassParameters,i=e.bind;return this._updateParameters(i.camera,t,i.slot),this._materialPassParameters.output=e.output,this._invoke(e.output,e.bind.slot,(r,s)=>r.acquire(s,e.bind))}render(e,t){this._invoke(e.output,e.bind.slot,(i,r)=>i.dispatch(r,e.bind,t))}_invoke(e,t,i){if(this._passes==null)return null;switch(t){case 2:switch(e){case 0:case 1:case 2:case 3:case 10:return i(this._passes.opaque,this._materialPassParameters);case 9:return i(this._passes.highlight,this._highlightPassParameters);case 4:return i(this._passes.shadowMap,this._shadowPassParameters);case 5:return i(this._passes.highlightShadowMap,this._shadowPassParameters);case 6:return i(this._passes.defaultShadowMap,this._shadowPassParameters);case 7:return i(this._passes.viewshedShadowMap,this._viewshedPassParameters)}break;case 4:switch(e){case 0:case 1:case 2:case 3:case 10:return i(this._passes.transparent,this._materialPassParameters)}break;case 0:switch(e){case 0:case 1:case 2:case 3:case 10:case 8:return i(this._passes.integratedMesh,this._materialPassParameters);case 9:return i(this._passes.highlightIntegratedMesh,this._highlightPassParameters)}break;case 7:switch(e){case 0:case 1:return i(this._passes.transparentIntegratedMesh,this._materialPassParameters)}break;case 9:switch(e){case 0:case 1:case 2:case 3:case 10:return i(this._passes.occludedGround,this._materialPassParameters)}}return null}notifyDirty(){this._context.requestRender()}queryDepthRange(e){const t=new nr;return this._systems.forEach(i=>t.union(i.queryDepthRange(e))),t}get hasEmitters(){let e=!1;return this._systems.forEach(t=>e=t.hasEmissions||e),e}_updateParameters(e,t,i){const r=e.viewInverseTransposeMatrix,s=i===4,n=i===9;xe(nv,r[3],r[7],r[11]),av.set(nv),q(t.transformWorldFromViewTH,av.high),q(t.transformWorldFromViewTL,av.low),q(t.slicePlaneLocalOrigin,nv),G2(t.transformViewFromCameraRelativeRS,e.viewMatrix),ks(t.transformProjFromView,e.projectionMatrix),t.identifier===0&&(this._materialPassParameters.transparent=s,this._materialPassParameters.occludedGround=n,Gp(WT,t.transformViewFromCameraRelativeRS),$2(t.transformNormalViewFromGlobal,WT))}hasHighlight(e){for(const t of this._systems)if(t.hasHighlight(e))return!0;return!1}};u2=h([D("esri.views.3d.webgl-engine.core.renderPasses.RenderPassManager")],u2);const nv=w(),WT=Rn(),av=new YE;function rY(e){return e.name}let sY=class{constructor(e){this._context=e,this._nodes=new jt}destroy(){this._nodes.forEach(e=>e.destroy()),this._nodes.prune()}add(e){this._nodes.push(e)}remove(e){this._nodes.remove(e)}produces(e){return this._nodes.some(({produces:t})=>t===e)}require(e,...t){const i=this._nodes,r=s=>i.reduce((n,{consumes:a,produces:o})=>n+(!a.required.includes(e)||s!=null&&o!==s?0:1),0);return t.length===0?r():t.reduce((s,n)=>s+r(n),0)}optional(e,...t){const i=this._nodes,r=s=>i.reduce((n,{consumes:a,produces:o})=>n+(!a.optional?.includes(e)||s!=null&&o!==s?0:1),0);return t.length===0?r():t.reduce((s,n)=>s+r(n),0)}updateAnimation(e){return this._nodes.reduce((t,i)=>i.updateAnimation(e)||t,!1)}precompile(...e){++this._context.techniques.precompiling;for(const t of e)this._nodes.forEach(i=>{i.produces===t&&i.precompile()});--this._context.techniques.precompiling}render(e,t,i=()=>{}){return this._render(e,t,i)??(rY(e)?e:hu)}produce(e,t,i=()=>{}){return this._render(e,t,i)}_render(e,t,i=()=>{}){const r=typeof e=="string"?e:e.name,s=this._nodes.filter(({produces:a})=>a===r);if(s.length===0)return;let n=typeof e=="string"?null:e;return s.some(a=>{const o=n?[n]:[],l=n==null;for(const c of a.consumes.required){if(c===r){if(l)return!1;continue}const u=t.get(c);if(u)o.push(u);else if(c!=="emissive"||!t.get(r)?.hasAttachment(c))return i?.(o),!1}if(a.consumes.optional)for(const c of a.consumes.optional){if(c===r)continue;const u=t.get(c);u&&o.push(u)}try{const c=a.doRender(o);c&&c!==n&&(r!==c.name&&($.getLogger(a).errorOnce(`RenderNode produced ${c.name}, expected ${r}`),c.setName(r)),n?.release(),n=c,t.set(r,n))}catch(c){$.getLogger(a).errorOnce(c)}return i?.(o),l&&n!=null}),this._context.rctx.enforceState(),n}requireGeometryDepth(){return this._nodes.some(e=>e.produces!=="disabled"&&e.requireGeometryDepth)}get test(){return{nodes:this._nodes}}},nY=class{constructor(e){this.context=e,this._renderPlugins=new Array,this._slots=new Array,this._version=ar(0);for(let t=0;t<21;++t)this._slots[t]=[]}destroy(){this._renderPlugins.forEach(e=>e.destroy()),this._renderPlugins.length=0}get plugins(){return this._renderPlugins}add(e,t){const i=()=>{if(t?.aborted)throw e.uninitializeRenderContext(),Ui();this._renderPlugins.push(e),e.produces.forEach((s,n)=>this._slots[n].push(e)),this.context.requestRender(),this._version.value++},r=e.initializeRenderContext(this.context,t);if(Fp(r))return r.then(i);i()}remove(e){zs(this._renderPlugins,e),e.uninitializeRenderContext();for(let t=0;t<this._slots.length;++t)this._slots[t]=this._slots[t].filter(i=>i!==e);this.context.requestRender(),this._version.value++}prepareRender(){this._renderPlugins.forEach(e=>{e.prepareRender&&e.prepareRender(this.context.renderContext)})}updateAnimation(e){let t=!1;return this._renderPlugins.forEach(i=>t=i.updateAnimation?.(e)||t),t}precompile(...e){++this.context.techniques.precompiling;const t=this.context.renderContext.bind.slot;for(const i of e)this.context.renderContext.bind.slot=i,this._forEachRender(()=>{});this.context.renderContext.bind.slot=t,--this.context.techniques.precompiling}render(...e){for(const t of e)this.context.renderContext.bind.slot=t,this._forEachRender((i,r)=>i.render(this.context.renderContext,r))}_forEachRender(e){const t=this.context.renderContext.bind.slot,i=this.context.renderContext.output;this._slots[t].forEach(r=>{if(!r.produces.get(t)?.(i)||r.isDecoration&&!this.context.renderContext.bind.decorations)return;const s=r.acquireTechniques(this.context.renderContext);s&&e(r,s)})}queryDepthRange(e){const t=new nr;return this._renderPlugins.forEach(i=>{const r=i.queryDepthRange?.(e);t.union(r)}),t}get updating(){return this._version.value>=0&&this._renderPlugins.some(e=>e.readyToRun)}produces(e,...t){return t.some(i=>this._slots[i].some(r=>{const s=r.produces.get(i);return!!s&&s(e)}))}consumes(e){return this._renderPlugins.some(t=>t.consumes().required.includes(e))}hasHighlight(e){return aY.some(t=>this._slots[t].some(i=>i.hasHighlight(e)))}get hasDecorations(){return this._renderPlugins.some(e=>e.isDecoration)}get hasOccludees(){return this._renderPlugins.some(e=>e.hasOccludees)}get hasEmitters(){return this._renderPlugins.some(e=>e.hasEmitters)}get renderOccludedFlags(){return this._renderPlugins.reduce((e,t)=>e|(t.renderOccludedFlags??0),0)}get usedMemory(){return this._renderPlugins.reduce((e,t)=>t.material?e:e+(t.usedMemory??0),0)}get test(){}};const aY=[2,4,18,13,14];let bw=class extends Kt{};function S5(e){const t=new ut;t.include($i);const{hasEmitters:i,dimEmissive:r}=e,s=t.fragment;return s.uniforms.add(new Ne("colorTexture",n=>n.colorTexture),new Ne("alphaTexture",n=>n.alphaTexture)),t.outputs.add("fragColor","vec4",0),i&&t.outputs.add("fragEmission","vec4",1),r?(s.main.add(_`float srcAlpha = texture(alphaTexture, uv).r;
vec4 srcColor = texture(colorTexture, uv);
srcColor.rgb = clamp(srcColor.rgb, vec3(0.0), srcColor.rgb);
vec3 dimming = srcAlpha > 1.0 ? mix(vec3(1.0), srcColor.rgb, 1.0 / srcAlpha) : mix(vec3(1.0), srcColor.rgb, srcAlpha);
fragEmission = vec4(dimming, 0.0);`),t):(s.uniforms.add(new Ne("frontFaceTexture",n=>n.frontFaceTexture)),i&&(s.uniforms.add(new Ne("emissionTexture",n=>n.emissionTexture)),s.uniforms.add(new Ne("emissionFrontFaceTexture",n=>n.emissionFrontFaceTexture))),s.main.add(_`
      float srcAlpha = texture(alphaTexture, uv).r;
      if(srcAlpha == 0.0){
        fragColor = vec4(0.0);
        ${X(i,"fragEmission = vec4(0.0);")}
        return;
      }

      vec4 srcColor = texture(colorTexture, uv);
      vec4 frontFace = texture(frontFaceTexture, uv);
      fragColor = vec4(mix(srcColor.rgb / srcAlpha, frontFace.rgb, frontFace.a), 1.0 - srcColor.a);

      ${X(i,`vec4 emission = texture(emissionTexture, uv);
         vec4 emissionFrontFace = texture(emissionFrontFaceTexture, uv);

         // Modulate transparent emitter by front faces. This case is important for surfaces which contain emitter and 
         // non-emitter at the same time. Non-emitter surface parts need to modulate emissions as well.
         emission.rgb = emission.rgb * (1.0 - frontFace.a);

         fragEmission = vec4(mix(emission.rgb / srcAlpha, emissionFrontFace.rgb, emissionFrontFace.a), 1.0 - srcColor.a);`)}
    `),t)}const oY=Object.freeze(Object.defineProperty({__proto__:null,OITBlendPassParameters:bw,build:S5},Symbol.toStringTag,{value:"Module"}));let Ku=class extends ct{constructor(e,t){super(e,t,new ht(oY,()=>k(()=>Promise.resolve().then(()=>Tee),void 0)),ai)}initializePipeline(e){return Ge({blending:e.dimEmissive?E8:ja,colorWrite:st,drawBuffers:e.dimEmissive?{buffers:[Vv,Qr]}:e.hasEmitters?{buffers:[Et,Qr]}:{buffers:[Et]}})}},d2=class extends hr{constructor(){super(...arguments),this.hasEmitters=!1,this.dimEmissive=!1}};h([z()],d2.prototype,"hasEmitters",void 0),h([z()],d2.prototype,"dimEmissive",void 0);let lY=class{constructor(e){this._techniques=e,this._parameters=new bw,this._configuration=new d2,e.precompile(Ku,this._configuration),this._configuration.hasEmitters=!0,e.precompile(Ku,this._configuration),this._configuration.dimEmissive=!0,e.precompile(Ku,this._configuration),this._configuration.dimEmissive=!1,this._configuration.hasEmitters=!1}blend(e,t,i,r,s,n){if(this._parameters.colorTexture=t.getTexture(),this._parameters.alphaTexture=t.getTexture(s?sM:Qr),this._parameters.frontFaceTexture=i.getTexture(),this._configuration.hasEmitters=s,s&&n){this._configuration.dimEmissive=!0;const o=this._techniques.get(Ku,this._configuration);e.bindTechnique(o,r,this._parameters),e.screen.draw(),this._configuration.dimEmissive=!1}s&&(this._parameters.emissionTexture=t.getTexture(Qr),this._parameters.emissionFrontFaceTexture=i.getTexture(Qr));const a=this._techniques.get(Ku,this._configuration);e.bindTechnique(a,r,this._parameters),e.screen.draw()}},cY=class{constructor(e,t){this._camera=e,this._dt=Oe(0),this._time=Oe(0),this._lastUpdate=Oe(0),this._lastUpdate=t,this._time=t}advance(e,t,i){const r=Oe(t-this._lastUpdate);this._dt=Oe(r/i),this._time=Oe(this._time+r),this._lastUpdate=t,this._camera=e}get camera(){return this._camera}get dt(){return this._dt}get time(){return this._time}},hY=class{constructor(){this._step=XT,this._dilation=1,this._firstIdleTime=Oe(0)}frame(e,t){if(t?this._firstIdleTime===0&&(this._firstIdleTime=Oe(performance.now())):this._firstIdleTime=Oe(0),Qe("disable-feature:high-quality-idle"))this._dilation=1;else{const r=t?performance.now()-this._firstIdleTime:0;if(r>=ZT+dY)return this._step=Oe(1/0),void(this._dilation=1);this._dilation=r>=ZT?pY:1}const i=j(e/uY,XT,fY);this._step===1/0?this._step=Oe(i):this._step=Oe(this._step*QT+i*(1-QT))}get value(){return this._step}get timeDilation(){return this._dilation}clear(){this._step=this._firstIdleTime=Oe(0)}};const uY=.5,ZT=Oe(12e4),dY=Oe(1e4),pY=10,QT=.9,mY=30,XT=Oe(1e3/1),fY=Oe(1e3/mY),gY=1e4,p2=100,_Y=500,yY=500,vY=.1;function YT(e,t,i,r){let s=0;if(!t.some(a=>!!a.material&&(s+=a.numGeometries,s>=gY)))return RY.compute(e,t,r);const n=new nr;return i.forEach(a=>n.union(bY(e,a))),n}function bY(e,t){if(!t.visible)return;const i=new nr,r=t.getSpatialQueryAccelerator();return r?wY(i,e,r):xY(i,e,t.objects),i}function wY(e,t,i){const{eye:r,viewForward:s,frustum:n}=t,a=l=>l.visible,o=i.objectCount;if(o<_Y)Es.set(t.near,Math.min(e.near,t.far)),i.forEachInDepthRange(r,s,1,Es,(l,c)=>{m2(e,t,l),Es.far=e.near,c.setRange(Es)},n,a),Es.set(Math.max(e.far,t.near),t.far),i.forEachInDepthRange(r,s,-1,Es,(l,c)=>{m2(e,t,l),Es.near=e.far,c.setRange(Es)},n,a);else{const l=Math.max(Math.min(o,yY),Math.ceil(o*vY)),c=i.findClosest(s,1,n,a,l),u=i.findClosest(s,-1,n,a,l);c&&u&&(KT(e,t,c.boundingVolumeWorldSpace.bounds),KT(e,t,u.boundingVolumeWorldSpace.bounds))}}function xY(e,t,i){Yc.clear(),i.forEach(r=>{r.visible&&r.geometries.length!==0&&Yc.add(r)}),Yc.empty||(Yc.sort(t),Es.set(t.near,Math.min(e.near,t.far)),Yc.forEachInDepthRange(Es,1,(r,s)=>{s<e.near&&m2(e,t,r)}),Es.set(Math.max(e.far,t.near),t.far),Yc.forEachInDepthRange(Es,-1,(r,s,n)=>{e.far=Math.max(e.far,n)}))}function m2(e,t,i){if(!i.visible||!eb(t.frustum,i.boundingVolumeWorldSpace.bounds))return;const r=i.transformation,s=MY;i.geometries.forEach(n=>{lr(s,r,n.transformation);const a=hp(s);T5(e,t,n.boundingInfo,s,a)})}function T5(e,t,i,r,s){if(i==null)return;gp(Ai,i.center,r);const{eye:n,viewForward:a}=t,o=a[0]*(Ai[0]-n[0])+a[1]*(Ai[1]-n[1])+a[2]*(Ai[2]-n[2]);if(Ai[3]=i.radius*s,!(o-Ai[3]>e.near&&o+Ai[3]<e.far)&&eb(t.frustum,Ai))if(i.radius>p2&&i.getChildren())for(const l of i.getChildren())T5(e,t,l,r,s);else f2.unionDepthRangeWithAABB(e,t.viewProjectionMatrix,r,i.bbMin,i.bbMax)}function KT(e,t,i){const r=t.eye,s=t.viewForward,n=(i[0]-r[0])*s[0]+(i[1]-r[1])*s[1]+(i[2]-r[2])*s[2];e.near=Math.min(e.near,n-i[3]),e.far=Math.max(e.far,n+i[3])}let CY=class{constructor(){this._items=new jt({allocator:e=>e||{object:null,distance:0,near:0,far:0},deallocator:e=>(e.object=null,e.distance=0,e.near=0,e.far=0,e)})}get length(){return this._items.length}get empty(){return this._items.length===0}clear(){this._items.clear()}add(e){this._items.pushNew().object=e}sort(e){const t=e.eye,i=e.viewForward;this._items.forAll(r=>{const s=r.object.boundingVolumeWorldSpace.bounds,n=(s[0]-t[0])*i[0]+(s[1]-t[1])*i[1]+(s[2]-t[2])*i[2];r.distance=n,r.near=n-s[3],r.far=n+s[3]}),this._items.sort((r,s)=>r.distance-s.distance)}forEachInDepthRange(e,t,i){if(t===1)for(let r=0;r<this._items.length;++r){const s=this._items.data[r];s.far<e.near||s.near>e.far||i(s.object,s.near,s.far)}else for(let r=this._items.length-1;r>=0;--r){const s=this._items.data[r];s.far<e.near||s.near>e.far||i(s.object,s.near,s.far)}}};class SY{constructor(){this._geometries=new Array,this._near=[],this._far=[],this._nearCandidates=[],this._farCandidates=[],this._looseRange=new nr(0,0)}compute(t,i,r){this._reset();const{viewMatrix:s}=t;i.forEach(c=>{c.forEachGeometry(u=>{if(!u.visible||r===0&&!u.castShadow)return;const p=u.boundingSphere,m=s[2]*p[0]+s[6]*p[1]+s[10]*p[2]+s[14],f=m-p[3],g=m+p[3];this._geometries.push(u),this._near.push(-g),this._far.push(-f)})});const n=new nr;if(this._geometries.length===0)return n;for(let c=0;c<this._geometries.length;++c)this._near[c]>n.far&&(n.far=this._near[c]),this._near[c]>2&&this._far[c]<n.near&&(n.near=this._far[c]);const a=this._looseRange;a.near=Math.max(.5*n.near,2),a.far=2*n.far;let o=0,l=0;for(let c=0;c<this._geometries.length;++c)this._near[c]<n.near&&(this._near[c]>=a.near?n.near=this._near[c]:this._nearCandidates[o++]=c),this._far[c]>n.far&&(this._far[c]<=a.far?n.far=this._far[c]:this._farCandidates[l++]=c);if(this._nearCandidates.length===0&&this._farCandidates.length===0)return n;this._nearCandidates.sort((c,u)=>this._near[c]<this._near[u]?-1:this._near[c]>this._near[u]?1:0),this._farCandidates.sort((c,u)=>this._far[c]<this._far[u]?1:this._far[c]>this._far[u]?-1:0);for(let c=0;c<this._nearCandidates.length;++c){const u=this._nearCandidates[c];if(this._near[u]<n.near){const p=this._geometries[u],{boundingInfo:m,shaderTransformation:f}=p;this._includeNearBoundingInfoRec(t,m,f,n)}}for(let c=0;c<this._farCandidates.length;++c){const u=this._farCandidates[c];if(this._far[u]>n.far){const p=this._geometries[u],{boundingInfo:m,shaderTransformation:f}=p;this._includeFarBoundingInfoRec(t,m,f,n)}}return this._reset(),n}_reset(){this._geometries.length=0,this._near.length=0,this._far.length=0,this._nearCandidates.length=0,this._farCandidates.length=0}_isOutsideSidePlanes(t,i){const r=Gi(t),s=TL(t);return i[0][0]*r[0]+i[0][1]*r[1]+i[0][2]*r[2]+i[0][3]>s||i[1][0]*r[0]+i[1][1]*r[1]+i[1][2]*r[2]+i[1][3]>s||i[2][0]*r[0]+i[2][1]*r[1]+i[2][2]*r[2]+i[2][3]>s||i[3][0]*r[0]+i[3][1]*r[1]+i[3][2]*r[2]+i[3][3]>s}_includeNearBoundingInfoRec(t,i,r,s){if(i==null)return;const n=i.center;gp(Ai,n,r),Ai[3]=i.radius*hp(r);const{frustum:a}=t;if(this._isOutsideSidePlanes(Ai,a))return;const o=Ai[0],l=Ai[1],c=Ai[2],u=Ai[3],{viewMatrix:p}=t,m=p[2]*o+p[6]*l+p[10]*c+p[14],f=m+u;if(!(-(m-u)<2||-f>=s.near))if(-f>this._looseRange.near)s.near=-f;else{if(u>p2){const g=i.getChildren();if(g!==void 0){for(const y of g)this._includeNearBoundingInfoRec(t,y,r,s);return}}f2.unionDepthRangeWithAABB(s,t.viewProjectionMatrix,r,i.bbMin,i.bbMax)}}_includeFarBoundingInfoRec(t,i,r,s){if(i==null)return;const n=i.center;gp(Ai,n,r),Ai[3]=i.radius*hp(r);const{frustum:a}=t;if(this._isOutsideSidePlanes(Ai,a))return;const[o,l,c,u]=Ai,{viewMatrix:p}=t,m=p[2]*o+p[6]*l+p[10]*c+p[14]-u;if(!(-m<=s.far))if(-m<this._looseRange.far)s.far=-m;else{if(u>p2){const f=i.getChildren();if(f!==void 0){for(const g of f)this._includeFarBoundingInfoRec(t,g,r,s);return}}f2.unionDepthRangeWithAABB(s,t.viewProjectionMatrix,r,i.bbMin,i.bbMax)}}}let TY=class{constructor(){this._modelViewProj=Le(),this._clipPosition=[Vt(),Vt(),Vt(),Vt(),Vt(),Vt(),Vt(),Vt()]}unionDepthRangeWithAABB(e,t,i,r,s){const n=this._modelViewProj;lr(n,t,i);let a=!1;for(let o=0;o<8;++o){const l=this._clipPosition[o],c=o===0||o===3||o===4||o===7?r[0]:s[0],u=o===0||o===1||o===4||o===5?r[1]:s[1],p=o<4?r[2]:s[2];l[0]=n[0]*c+n[4]*u+n[8]*p+n[12],l[1]=n[1]*c+n[5]*u+n[9]*p+n[13],l[2]=n[2]*c+n[6]*u+n[10]*p+n[14],l[3]=n[3]*c+n[7]*u+n[11]*p+n[15]}for(let o=0;o<12;++o){const l=PY(this._clipPosition[lv[o][0]],this._clipPosition[lv[o][1]],this._clipPosition[lv[o][2]]);let c=!0;for(let u=0;u<l.length;++u)if(l[u][3]>=2){c=!1;break}if(!c){a=!0;for(let u=0;u<l.length;++u){const p=l[u][3];Number.isFinite(p)&&(e.near=Math.min(p,e.near),e.far=Math.max(p,e.far))}}}return a}};function PY(e,t,i){let r=[e,t,i];for(let s=0;s<4;++s){const n=r;r=[];for(let a=0;a<n.length;++a){const o=n[a],l=n[(a+1)%n.length];ov(l,s)?(ov(o,s)||r.push(JT(o,l,s)),r.push(l)):ov(o,s)&&r.push(JT(o,l,s))}}return r}function ov(e,t){return t===0?e[0]>=-e[3]:t===1?e[1]>=-e[3]:t===2?e[0]<=e[3]:t===3?e[1]<=e[3]:void Qt(!1)}function JT(e,t,i){let r=0;return i===0?r=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):i===1?r=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):i===2?r=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):i===3&&(r=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),IL(Vt(),e,t,r)}const lv=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],Ai=Kr(),MY=Le(),Es=new nr,Yc=new CY,RY=new SY,f2=new TY,DY={idleOpacity:.8,navigatingOpacity:.4,maxDelta:.1,tiltFadeStart:20,tiltFadeEnd:30,altitudeStart:1e4,altitudeEnd:2e4};let OY=class{constructor(e){this._fbos=e,this._requiresEmission=!1,this._size=new Eq(0,0),this._clearColor=Vt()}dispose(){this._color=Ht(this._color),this.releaseDepth()}initialize(e,t,i,r){this._size.width=e,this._size.height=t,Bl(this._size,this._fbos.rctx.parameters.maxTextureSize);const s=this._color;return this._color=null,this.releaseDepth(),this._requiresEmission=r,Zl(this._clearColor,i),s}releaseDepth(){this._color?.detachDepth(),this._depth=Ht(this._depth)}update(e){const t=this._ensureColor();t.attachDepth(this.depth),this._color=e(t)}bind(){const{rctx:e}=this._fbos,t=this._color==null;this.color.attachDepth(this.depth),e.bindFramebuffer(this.color.fbo),t&&(e.setClearStencil(0),e.setClearColor(this._clearColor[0],this._clearColor[1],this._clearColor[2],this._clearColor[3]),e.clear(17664),this._requiresEmission&&e.clearBuffer(1,ty))}_acquireColor(){return this._requiresEmission?this._fbos.acquire(this._size.width,this._size.height,"main color").acquireColor(Qr,8,"emissive"):this._fbos.acquire(this._size.width,this._size.height,"main color")}_acquireDepth(){return this._fbos.acquireDepth(13,this._size.width,this._size.height,"main depth")}get size(){return this._size}get color(){return this._ensureColor()}get depth(){return this._depth??=this._acquireDepth(),this._depth}_ensureColor(){return this._color??=this._acquireColor(),this._color}};function eP(e=!Qe("disable-feature:high-quality-idle"),t=null){const i=new $a;return e?(i.set(2,0,t!=="low"),i.set(2,3,t!=="low"),i.set(2,1,!0),i.set(2,4,!0),i.set(2,5,!0),i.set(2,8,!0)):(i.set(0,6,!0),i.set(0,7,!0),i.set(1,6,!0),i.set(1,7,!0)),i.set(2,6,!0),i.set(2,7,!0),i.set(2,2,!0),i}let EY=class{constructor(){this._inputs=new Map}set(e,t){this._inputs.set(e,t)}get(e){return this._inputs.get(e)}has(e){return this._inputs.has(e)}release(e){this._inputs.get(e)?.release()&&this._inputs.delete(e)}};function AY(e){e.code.add(`
  vec4 blendColorsPremultiplied(vec4 source, vec4 dest) {
    float oneMinusSourceAlpha = 1.0 - source.a;
    return source + dest * oneMinusSourceAlpha;
  }
  `)}function Ju(e,t){return e[0]=t[0]*t[3],e[1]=t[1]*t[3],e[2]=t[2]*t[3],e[3]=t[3],e}const Jp=255,IY=1/Jp;function P5(e){const t=new ut,{fragment:i}=t;t.include($i),t.include(u5),t.include(f4),i.uniforms.add(new Pv("shadowMap",s=>s.shadowMap.depthTexture),new gs("depthMap",s=>s.depth?.attachment)),i.constants.add("sampleValue","float",IY);const r=e.index===1?"vec2":"float";return t.outputs.add("sampleCount",r),i.main.add(_`
    sampleCount = ${r}(0.0);

    vec3 uvzShadow = calculateUVZShadowFromDepth(uv, textureSize(shadowMap,0), depthMap);
    if (uvzShadow.z < 0.0) {
      return;
    }

    // The shadow map sampler returns a value between 0 and 1, we take the midpoint as we count discrete samples
    bool shadow = readShadowMapUVZ(uvzShadow, shadowMap) > 0.5;

    if (shadow) {
      sampleCount = ${r}(sampleValue); // Add 1 to the sample count
    }
  `),t}const LY=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastMaxSamples:Jp,build:P5},Symbol.toStringTag,{value:"Module"}));let ww=class extends Kt{constructor(e){super(),this._data=e,this.sampleScale=ze(),this.opacityFromElevation=1,this.gradientColor=Rf(FY),this.thresholdColor=Rf(VY),this.bandedGradientColor=Rf(zY),this.bandSize=.1,this.threshold=.5}get shadowCastMap(){return this._data.shadowCastTexture}};const xw=.7,cv=50/255,FY=Mi(0,0,1,xw),VY=Mi(1,0,0,xw),zY=Mi(cv,cv,cv,xw);function M5(e){const t=new ut,i=t.fragment;t.include(E2),t.include($i);const{visualization:r}=e;i.constants.add("inverseSampleValue","float",Jp),i.uniforms.add(new Ne("shadowCastMap",u=>u.shadowCastMap),new qs("sampleScale",u=>u.sampleScale),new _e("opacityFromElevation",u=>u.opacityFromElevation));const s=r===2,n=r===3,a=r===1;switch(n&&i.include(AY),r){case 0:i.uniforms.add(new $r("uColor",u=>Ju(ed,u.gradientColor)));break;case 1:i.uniforms.add(new $r("uColor",u=>Ju(ed,u.bandedGradientColor)),new _e("bandSize",u=>u.bandSize));break;case 3:i.uniforms.add(new $r("uColor",u=>Ju(ed,u.thresholdColor)),new $r("gradientColor",u=>Ju(ed,u.gradientColor)),new _e("threshold",u=>u.threshold));break;case 2:i.uniforms.add(new $r("uColor",u=>Ju(ed,u.thresholdColor)),new _e("threshold",u=>u.threshold))}const{type:o,selector:l,thresholdStrengthSelector:c}=n?{type:"vec2",selector:"rg",thresholdStrengthSelector:"strength.x"}:{type:"float",selector:"r",thresholdStrengthSelector:"strength"};return i.main.add(_`
    ${o} numSamples = texture(shadowCastMap, uv).${l} * inverseSampleValue;

    fragColor = vec4(0.0);

    // early out if we do not have any samples in one or more channels
    if (dot(numSamples, ${o}(1)) < 1.0) {
      return;
    }

    // sampleScale is the number of total samples taken, so this brings strength to a 0-1 range.
    // note that sampleScale is always a vec2 even if we have only the primary channel.
    ${o} strength = numSamples * sampleScale.${l};

    // in threshold mode, step the strength to 0 if we are at or below the threshold, 1 otherwise.
    ${X(s||n,_`
      ${c} = 1.0 - step(${c}, threshold);
    `)}

    // bail out if we are below the threshold
    ${X(s,_`if (${c} == 0.0) { return; }`)}

    ${X(a,_`strength = ceil(strength / bandSize) * bandSize;`)}

    ${o} attenuation = opacityFromElevation * strength;

    // in ThresholdAndGradient mode we blend the threshold color on top of the gradient color
    fragColor = ${X(n,_`blendColorsPremultiplied(uColor * attenuation.r, gradientColor * attenuation.g)`,_`uColor * attenuation`)};
  `),t}const ed=Vt(),kY=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastVisualizePassParameters:ww,build:M5},Symbol.toStringTag,{value:"Module"}));let tP=class extends ct{constructor(e,t){super(e,t,new ht(kY,()=>k(()=>Promise.resolve().then(()=>Pee),void 0)),ai),this.primitiveType=St.TRIANGLE_STRIP}initializePipeline(){return Ge({blending:fu,colorWrite:st,depthTest:null,depthWrite:null})}},R5=class extends hr{constructor(){super(...arguments),this.visualization=0}};h([z({count:4})],R5.prototype,"visualization",void 0);const BY=4e4,NY=5e4,D5=1/512;let Tg=class extends ie{constructor(e,t,i,r){super({}),this._techniques=e,this._rctx=t,this._data=i,this._requestRender=r,this._passParameters=new ww(this._data),this._configuration=new R5,this._enabled=!1,this._vao=Zo(t)}dispose(){this._stop(),this._vao=ye(this._vao)}precompile(){this._showVisualization&&this._techniques.precompile(tP,this._configuration)}render(e){if(!this._showVisualization)return;const[t,i]=this._data.computedSamples;this._passParameters.sampleScale=[t?1/t:0,i?1/i:0];const r=this._techniques.get(tP,this._configuration);this._rctx.bindVAO(this._vao),this._rctx.bindTechnique(r,e,this._passParameters),this._rctx.drawArrays(r.primitiveType,0,this._vao.vertexCount("geometry"))}setOptions(e){e.enabled!==void 0&&this._setEnabled(e.enabled),e.thresholdColor!==void 0&&this._setThresholdColor(e.thresholdColor),e.gradientColor!==void 0&&this._setGradientColor(e.gradientColor),e.bandedGradientColor!==void 0&&this._setBandedGradientColor(e.bandedGradientColor),e.threshold!==void 0&&(this._threshold=e.threshold),e.visualization!==void 0&&(this._visualization=e.visualization),e.bandSize!==void 0&&(this._bandSize=e.bandSize)}get opacityFromElevation(){return this._passParameters.opacityFromElevation}set opacityFromElevation(e){this._passParameters.opacityFromElevation!==e&&(this._passParameters.opacityFromElevation=e,this.notifyChange("opacityFromElevation"))}get _showVisualization(){return this._enabled&&(this._data.computedSamples[0]>0||this._data.computedSamples[1]>0)&&this.opacityFromElevation>D5}get _threshold(){return this._passParameters.threshold}set _threshold(e){this._threshold!==e&&(this._passParameters.threshold=e,this._requestRenderIfEnabled())}get _visualization(){return this._configuration.visualization}set _visualization(e){e!==this._visualization&&(this._configuration.visualization=e,this._requestRenderIfEnabled())}get _bandSize(){return this._passParameters.bandSize}set _bandSize(e){e!==this._bandSize&&(this._passParameters.bandSize=e,this._requestRenderIfEnabled())}_setThresholdColor(e){const t=this._passParameters.thresholdColor;Mf(e,t)||(Zl(this._passParameters.thresholdColor,e),this._requestRenderIfEnabled())}_setGradientColor(e){const t=this._passParameters.gradientColor;Mf(e,t)||(Zl(this._passParameters.gradientColor,e),this._requestRenderIfEnabled())}_setBandedGradientColor(e){const t=this._passParameters.bandedGradientColor;Mf(e,t)||(Zl(this._passParameters.bandedGradientColor,e),this._requestRenderIfEnabled())}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop())}_requestRenderIfEnabled(){this._enabled&&this._requestRender()}_start(){this._enabled=!0,this._requestRender()}_stop(){this._enabled=!1,this._requestRender()}};h([d()],Tg.prototype,"opacityFromElevation",null),Tg=h([D("esri.views.3d.webgl-engine.lib.ShadowCastRenderer")],Tg);let O5=class extends ct{constructor(e,t){super(e,t,new ht(LY,()=>k(()=>Promise.resolve().then(()=>Mee),void 0)),ai),this.primitiveType=St.TRIANGLE_STRIP}initializePipeline(e){const t={r:e.index===0,g:e.index===1,b:!1,a:!1};return Ge({blending:O8,colorWrite:t,depthTest:null,depthWrite:null})}},g2=class extends hr{constructor(e){super(),this.index=0,this.index=e}};h([z({count:2})],g2.prototype,"index",void 0);function E5(e){const t=new ut,{fragment:i}=t;t.include($i);const r=e.index===1?"vec2":"float",s="value";return t.outputs.add(s,r),i.main.add(_`${s} = ${r}(0.0);`),t}const jY=Object.freeze(Object.defineProperty({__proto__:null,build:E5},Symbol.toStringTag,{value:"Module"}));let A5=class extends ct{constructor(e,t){super(e,t,new ht(jY,()=>k(()=>Promise.resolve().then(()=>Ree),void 0)),ai),this.primitiveType=St.TRIANGLE_STRIP}initializePipeline(e){const t={r:e.index===0,g:e.index===1,b:!1,a:!1};return Ge({blending:null,colorWrite:t,depthTest:null,depthWrite:null})}},Cr=class extends ie{updateDepthRange(e){this._depthRange.equals(e)||(this._depthRange=e)}constructor(e,t,i,r,s,n){super({}),this.fbos=e,this._techniques=t,this._stage=i,this._prepareForShadowMapPass=r,this._renderToShadowMap=s,this._requestRender=n,this._primarySet=new rP(new g2(0),()=>this._requestRenderIfEnabled()),this._contextSet=new rP(new g2(1),()=>this._requestRenderIfEnabled()),this._passParameters=new R2,this._depthRange=nr.Zero,this._previewing=!1,this._shadowAccumulatorKey=Symbol("shadowAccumulator"),this._rctx=e.rctx,this._bindParameters=new Gb(new $b(e,i.viewingMode)),this._bindParameters.shadowMap.enabled=!0,this._vao=Zo(this._rctx),this._accumulationRenderer=new Tg(t,this._rctx,this,n);const a=this._stage.view.resourceController.scheduler;this.addHandles([a.registerTask(mi.SHADOW_ACCUMULATOR,this),M(()=>this._previewing,()=>this._requestRenderIfEnabled(),Ie),M(()=>this._numActive===2,()=>this._numActiveChanged(),Ie),M(()=>this._depthRange,()=>this._invalidateAccumulationSets(),Ie)],this._shadowAccumulatorKey);for(const o of this._accumulationSets())o.precompile(t)}*_accumulationSets(){yield this._primarySet,yield this._contextSet}normalizeCtorArgs(){return{}}destroy(){this._disable(),this.removeHandles(this._shadowAccumulatorKey),this._accumulationRenderer=ye(this._accumulationRenderer),this._bindParameters.shadowMap.dispose(),this._fbo=ye(this._fbo),this._vao=ye(this._vao);for(const e of this._accumulationSets())e.destroy();this._contextSet=null,this._primarySet=null,this._bindParameters.destroy()}get computedSamples(){return[this._primarySet.progress,this._contextSet.progress]}get shadowCastTexture(){return this._fbo?.colorTexture}get accumulating(){return this.active&&this._previewing||this._refining}get _refining(){return this.active&&!this._doneAccumulating&&!this._previewing}get active(){return this._fbo!=null&&[...this._accumulationSets()].some(e=>e.active)}get canAccumulate(){return this._bindParameters.depth!=null&&this._depthRange!==nr.Zero&&this._opacityFromElevation>D5}get _doneAccumulating(){return[...this._accumulationSets()].every(e=>e.doneAccumulating)}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(e){this._accumulationRenderer.opacityFromElevation=e}get _numActive(){return[...this._accumulationSets()].reduce((e,t)=>e+(t.active?1:0),0)}get _pixelFormat(){return this._numActive===2?{pixelFormat:33319,internalFormat:Lr.RG8}:{pixelFormat:6403,internalFormat:Lr.R8}}get readyToRun(){return this._refining&&this.canAccumulate&&[...this._accumulationSets()].some(e=>e.running)}runTask(e){this._clearBuffersOnAccumulationStart(),this._prepareForShadowMapPass(this._bindParameters);let t=!1;for(const i of this._accumulationSets())this._runTaskForSet(i,e)&&(t=!0);t&&this._requestRender()}_runTaskForSet(e,t){let i=!1;for(;!t.done&&!e.doneAccumulating;)this._accumulateShadow(e),t.madeProgress(),i=!0;return i}renderAccumulation(e,t,i,r){return this._updateCamera(t),this._bindParameters.contentCamera=i,this._bindParameters.depth=e,this._passParameters.origin=this._bindParameters.camera.center,this.notifyChange("canAccumulate"),!(!this.accumulating||!this.canAccumulate)&&(this._previewing||r?(this._clearFramebuffer(),this._reset()):this._clearBuffersOnAccumulationStart(),this._accumulateSetsForRenderFrame(r))}_clearBuffersOnAccumulationStart(){if([...this._accumulationSets()].every(e=>e.progress===0))this._clearFramebuffer();else for(const e of this._accumulationSets())e.progress===0&&this._clearFramebufferForSet(this._fbo,e)}_accumulateSetsForRenderFrame(e){let t=!1;for(const i of this._accumulationSets())this._accumulateSetForRenderFrame(i,e)&&(t=!0);return t&&this._requestRender(),t}_accumulateSetForRenderFrame(e,t){let i=t?e.sampleCount:Math.min(UY,e.sampleCount);i-=e.progress;for(let r=0;r<i;++r)this._accumulateShadow(e);return i>0}precompile(){this._accumulationRenderer.precompile()}render(e){this._accumulationRenderer.render(e)}setOptions(e){e.previewing!==void 0&&(this._previewing=e.previewing),e.lightDirections!==void 0&&(this._primarySet.lightDirections=e.lightDirections),e.lightDirectionsContext!==void 0&&(this._contextSet.lightDirections=e.lightDirectionsContext),e.enabled===!0?this._enable():e.enabled===!1&&this._disable(),this._accumulationRenderer.setOptions(e)}readAccumulatedShadow(e,t){const i=this._primarySet.progress;return!this.active||!this._fbo||i<1||e<0||e>=this._fbo.width||t<0||t>=this._fbo.height?0:(this._fbo.readPixels(e,t,1,1,6408,ni.UNSIGNED_BYTE,iP),iP[0]/i)}_numActiveChanged(){if(!this._fbo)return;const e=this._numActive===2,t=this._createFBO();t.resize(this._fbo.width,this._fbo.height),e&&(this._clearFramebuffer(t),this._contextSet.reset()),this._fbo.width&&this._fbo.height&&this._rctx.blitFramebuffer(this._fbo,t),this._fbo.dispose(),this._fbo=t,this._requestRender()}_enable(){this._fbo||(this._fbo=this._createFBO(),this._invalidateAccumulationSets())}_createFBO(){const{pixelFormat:e,internalFormat:t}=this._pixelFormat,i=new gt;return i.pixelFormat=e,i.internalFormat=t,i.wrapMode=33071,new Wo(this._rctx,i)}_invalidateAccumulationSets(){for(const e of this._accumulationSets())e.reset();this._requestRenderIfEnabled()}_disable(){this._fbo&&(this._fbo=ye(this._fbo),this._requestRender())}_reset(){for(const e of this._accumulationSets())e.reset()}_clearFramebuffer(e=this._fbo){e&&e.width&&e.height&&(this._rctx.bindFramebuffer(e),this._rctx.setClearColor(0,0,0,0),this._rctx.clear(16384))}_clearFramebufferForSet(e,t){if(!e)return;const i=this._techniques.get(A5,t.configuration);this._rctx.bindFramebuffer(e),this._rctx.bindTechnique(i,this._bindParameters,this._passParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(i.primitiveType,0,this._vao.vertexCount("geometry"))}_accumulateShadow(e){this._renderToShadowMap(this._bindParameters,e.lightDirections[e.progress++],this._depthRange);const t=this._techniques.get(O5,e.configuration);this._rctx.bindFramebuffer(this._fbo),this._rctx.bindTechnique(t,this._bindParameters,this._passParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(t.primitiveType,0,this._vao.vertexCount("geometry"))}_updateCamera(e){const t=this._fbo;if(t==null)return;const i=this._bindParameters.camera;e.equals(i)||i.copyFrom(e),t.resize(e.fullWidth,e.fullHeight),this._opacityFromElevation=1-Jh(BY,NY,e.relativeElevation)}_requestRenderIfEnabled(){this._fbo&&this._requestRender()}get test(){}};h([d()],Cr.prototype,"_fbo",void 0),h([d()],Cr.prototype,"_depthRange",void 0),h([d()],Cr.prototype,"_previewing",void 0),h([d()],Cr.prototype,"_accumulationRenderer",void 0),h([d()],Cr.prototype,"_refining",null),h([d()],Cr.prototype,"active",null),h([d()],Cr.prototype,"canAccumulate",null),h([d()],Cr.prototype,"_doneAccumulating",null),h([d()],Cr.prototype,"_opacityFromElevation",null),h([d()],Cr.prototype,"_numActive",null),h([d()],Cr.prototype,"_pixelFormat",null),h([d()],Cr.prototype,"readyToRun",null),Cr=h([D("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],Cr);const UY=6,iP=new Uint8Array(4);let rP=class{constructor(e,t){this.configuration=e,this._notifyChange=t,this._cachedLightDirections=[],this._progress=ar(0),this._sampleCount=ar(0)}get progress(){return this._progress.value}set progress(e){this._progress.value=e}get sampleCount(){return this._sampleCount.value}get doneAccumulating(){return this.progress>=this.sampleCount}get running(){return this.progress>0}get active(){return this.sampleCount>0}get lightDirections(){return this._cachedLightDirections}set lightDirections(e){const t=this._cachedLightDirections,i=Math.min(Jp,e.length);if(!EA(t,0,t.length,e,0,i,eu)){t.length=i,this._sampleCount.value=i;for(let r=0;r<i;++r)t[r]=q(t[r]??w(),e[r]);this.reset(),this._notifyChange()}}destroy(){this._cachedLightDirections.length=0,this._sampleCount.value=0}reset(){this.progress=0}precompile(e){e.precompile(O5,this.configuration),e.precompile(A5,this.configuration)}};const HY=E_();let qY=class{constructor(){this._plane=E_(),this._isDecoration=!0}get plane(){return this._plane}get isDecoration(){return this._isDecoration}update({plane:e,isDecoration:t}){let i=!1;return this._isDecoration!==t&&(this._isDecoration=t,i=!0),e??=HY,mI(e,this._plane)?i:(V2(e,this._plane),!0)}},sP=class{constructor(e,t,i,r,s,n,a,o,l){this.createQuery=e,this.deleteQuery=t,this.resultAvailable=i,this.getResult=r,this.disjoint=s,this.beginTimeElapsed=n,this.endTimeElapsed=a,this.createTimestamp=o,this.timestampBits=l}},Ra=!1;function GY(e,t){if(t.disjointTimerQuery)return null;let i=e.getExtension("EXT_disjoint_timer_query_webgl2");return i?new sP(()=>e.createQuery(),r=>{e.deleteQuery(r),Ra=!1},r=>e.getQueryParameter(r,e.QUERY_RESULT_AVAILABLE),r=>e.getQueryParameter(r,e.QUERY_RESULT),()=>e.getParameter(i.GPU_DISJOINT_EXT),r=>{Ra||(Ra=!0,e.beginQuery(i.TIME_ELAPSED_EXT,r))},()=>{e.endQuery(i.TIME_ELAPSED_EXT),Ra=!1},r=>i.queryCounterEXT(r,i.TIMESTAMP_EXT),()=>e.getQuery(i.TIMESTAMP_EXT,i.QUERY_COUNTER_BITS_EXT)):(i=e.getExtension("EXT_disjoint_timer_query"),i?new sP(()=>i.createQueryEXT(),r=>{i.deleteQueryEXT(r),Ra=!1},r=>i.getQueryObjectEXT(r,i.QUERY_RESULT_AVAILABLE_EXT),r=>i.getQueryObjectEXT(r,i.QUERY_RESULT_EXT),()=>e.getParameter(i.GPU_DISJOINT_EXT),r=>{Ra||(Ra=!0,i.beginQueryEXT(i.TIME_ELAPSED_EXT,r))},()=>{i.endQueryEXT(i.TIME_ELAPSED_EXT),Ra=!1},r=>i.queryCounterEXT(r,i.TIMESTAMP_EXT),()=>i.getQueryEXT(i.TIMESTAMP_EXT,i.QUERY_COUNTER_BITS_EXT)):null)}function $Y(e,t){const i=e.capabilities.disjointTimerQuery;return i==null?null:new WY(i,t)}let WY=class{constructor(e,t){this._timer=e,this._queryPool=new Array,this._queryResults=new Map,this._currentQuery=null,t.forEach(i=>{const r=this._timer.createQuery(),s=this._timer.createQuery();this._queryPool.push(r,s),this._queryResults.set(i,null)})}start(){Ra||(this._currentQuery=this._queryPool.pop(),this._currentQuery!=null&&(this._timer.disjoint(),this._timer.beginTimeElapsed(this._currentQuery)))}stop(e){if(this._timer.disjoint()||this._currentQuery==null||!this._queryResults.has(e))return this.abort(),null;this._timer.endTimeElapsed();const t=this._queryResults.get(e);if(t==null)return this._queryResults.set(e,this._currentQuery),this._currentQuery=null,null;if(!this._timer.resultAvailable(t))return this._queryPool.unshift(this._currentQuery),this._currentQuery=null,null;const i=this._timer.getResult(t)/1e6;return this._queryPool.unshift(t),this._queryResults.set(e,this._currentQuery),this._currentQuery=null,i}abort(){this._currentQuery!=null&&(this._timer.deleteQuery(this._currentQuery),this._queryPool.unshift(this._timer.createQuery()),this._currentQuery=null)}dispose(){this._currentQuery!=null&&this._timer.deleteQuery(this._currentQuery),this._queryPool.forEach(e=>{this._timer.deleteQuery(e)}),this._queryResults.forEach(e=>{e!=null&&this._timer.deleteQuery(e)})}};const Zt={OVERLAY:"overlay",PREPARE:"prepare",SHADOW_MAP:"shadow map",DEPTH:"depth",ACCUMULATED_SHADOWS:"accumulated shadows",APPLY_ACCUMULATED_SHADOWS:"apply accumulated shadows",OBJECT_AND_LAYER_ID_COLOR:"object/layer id color",NORMALS:"normals",SSAO:"SSAO",HIGHLIGHTS:"highlights",OPAQUE_EDGES:"opaque edges",VOXEL:"voxel",TRANSPARENT:"transparent",TRANSPARENT_EDGES:"transparent edges",HUD_VISIBILITY:"HUD visibility",TRANSPARENT_TERRAIN:"transparent terrain",TRANSPARENT_MATERIAL_WITHOUT_DEPTH:"transparent material without depth",OPAQUE_ENVIRONMENT:"opaque environment",TRANSPARENT_ENVIRONMENT:"transparent environment",OCCLUDED:"occluded",HUD:"HUD",HUD_OCCLUDED:"HUD occluded",FINISH:"finish",FOCUS_AREA_MASK:"focus area mask"},hv=Object.values(Ft).concat(Object.values(ne)).concat(Object.values(Zt)),nP="Total";let ZY=class{constructor(e){this._rctx=e,this._startTimeStampCPU=Oe(0),this._lastTimeStampCPU=Oe(0),this._totalCPUTime=new nm(nP),this._cpuTimeSamplers=new Map(hv.map(t=>[t,new nm(t)])),this._enableGPUTimer=0,this._totalGPUTime=new nm("GPU"),this._gpuTimeSamplers=new Map(hv.map(t=>[t,new nm(t)])),this._totalTime=Oe(0),this._totalFrameCount=0}get totalCPUTimeSampler(){return this._totalCPUTime}get cpuTimeSamplers(){return Array.from(this._cpuTimeSamplers.values())}get totalGPUTimeSampler(){return this._totalGPUTime}get gpuTimeSamplers(){return Array.from(this._gpuTimeSamplers.values())}get gpuSamplingEnabled(){return this._gpuTimerPool!=null}get totalTime(){return this._totalTime}get totalFrameCount(){return this._totalFrameCount}get elapsedTime(){return Oe(performance.now()-this._startTimeStampCPU)}enableGPUPerformanceInfo(){if(this._gpuTimerPool==null){const t=[...hv,nP];this._gpuTimerPool=$Y(this._rctx,t)}if(this._gpuTimerPool==null)return{hasGPUTimerSupport:!1,remove:()=>{}};++this._enableGPUTimer;let e=!1;return{hasGPUTimerSupport:!0,remove:()=>{e||(e=!0,--this._enableGPUTimer,this._enableGPUTimer===0&&(this._gpuTimerPool=ye(this._gpuTimerPool)))}}}startFrame(){this._startTimeStampCPU=this._lastTimeStampCPU=Oe(performance.now()),this._gpuTimerPool&&(this._gpuTimeSamplers.forEach(e=>e.push(0)),this._gpuTimerPool.start())}advance(e){const t=Oe(performance.now());if(this._cpuTimeSamplers.get(e).push(t-this._lastTimeStampCPU),this._lastTimeStampCPU=t,this._gpuTimerPool){const i=this._gpuTimerPool.stop(e);this._gpuTimeSamplers.get(e).set(i),this._gpuTimerPool.start()}}finishFrame(){if(this._gpuTimerPool){const t=this._gpuTimerPool.stop(Zt.FINISH);this._gpuTimeSamplers.get(Zt.FINISH).set(t),this._rctx.gl.flush()}const e=Oe(performance.now()-this._startTimeStampCPU);this._totalTime=Oe(this._totalTime+e),this._totalCPUTime.push(e),this._gpuTimerPool&&this._totalGPUTime.push(this.gpuTimeSamplers.reduce((t,i)=>t+(i.last||0),0)),++this._totalFrameCount}},vh=class extends rp{constructor(e,t,i,r,s,n){super({stage:e}),this._techniques=i,this._rctx=r,this._compositingHelper=s,this._requestRender=n,this._pluginsHas={hudElements:!1,water:!1},this.renderPassManager=new u2,this._isRendering=!1,this._inGlobeView=!1,this._backgroundColor=Mi(0,0,0,1),this._sliceHelper=new qY,this._blit=null,this._oitblend=null,this.sceneDepthRange=ar(nr.Infinite),this._state=ar(2),this._highQualityTransparencyEnabled=!0,this._ssrEnabled=!1,this._hasAnimations=!1,this._animationTimestep=new hY,this._loadEdgeViewTask=null,this._edgeViewCallbacks=[],this._reprojectionMatrixVersion=ar(0),this._lastFrameTime=Oe(0),this._renderHiddenTransparentEdges=()=>{},this._pluginInput=new EY,this._releaseNormals=a=>{a.some(({name:o})=>o==="normals")&&this._pluginInput.release("normals")},this._debugNeedsDepth=!1,this._fboCache=new YX(r),this._renderStateFeatures=ar(eP(!Qe("disable-feature:high-quality-idle"),e.view.qualityProfile)),this._framebuffer=new OY(this.fboCache),this._performanceInfo=new ZY(this._rctx),this._shadowMap=new $b(this.fboCache,e.viewingMode),this._shadowAccumulator=new Cr(this.fboCache,i,e,a=>{const o=this.shadowsEnabled;this._shadowMap.enabled=!0,this._ensureBindParametersCamera(a.camera,a.contentCamera),this._plugins.prepareRender(),this._shadowMap.enabled=o},(a,o,l)=>{const c=e.view.qualitySettings.maximumPixelRatio;a.shadowMap.start(a.camera,o,l,!0,c),this._renderShadowCascades(4,a.shadowMap),a.shadowMap.finish(),a.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(a.camera,a.contentCamera)},n),this._renderContext=new RO(this._rctx,this._shadowMap,i),this._nodes=new sY(this._renderContext),this._plugins=new nY({renderContext:this._renderContext,techniques:i,materials:t,requestRender:n,controller:e,fbos:this.fboCache,isFeatureEnabled:a=>this.isFeatureEnabled(a)}),this._plugins.add(this.renderPassManager),this.addHandles([M(()=>e.view.state.camera,()=>n(),Ve),M(()=>bi.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES,a=>{this._renderHiddenTransparentEdges=a?()=>this._renderEdges(0):()=>{},n()},Ee),M(()=>e.view.environment.background?.color,a=>{const o=a?rb(a):di;cr(this._backgroundColor,o[0]*o[3],o[1]*o[3],o[2]*o[3],o[3]),n()},Ve),M(()=>e.view.state.camera.relativeElevation,a=>this._inGlobeView=(a??1/0)>=WP,Ve),M(()=>this._bindParameters.clouds.fadeFactor,()=>{this._bindParameters.fadeLighting(),this._requestRender(2)},Ie),M(()=>this._bindParameters.clouds.data?.state,()=>n(),Ie),M(()=>e.view.state.highlights,a=>{this._bindParameters.highlights=a,n()},Ee)])}destroy(){this._gpuTimerHandle=xi(this._gpuTimerHandle),this._nodes.destroy(),this._framebuffer.dispose(),this._shadowMap.dispose(),this._shadowAccumulator.destroy(),this._shadowAccumulator=null,this._loadEdgeViewTask=Ar(this._loadEdgeViewTask),this._edgeView=Z(this._edgeView),this.renderPassManager.dispose(),this._releaseFBOs(),this._disposeOffscreenBuffers(),this._fboCache.destroy(),this._fboCache=null,this._plugins.destroy(),this._plugins=null,this._pluginInput=null,this._blit=null,this._oitblend=null,this._compositingHelper=null,this._nodes=null,this._framebuffer=null,this._shadowMap=null,this._renderContext=null,this._performanceInfo=null,f8.prune(),zh.prune(),uL()}get renderContext(){return this._renderContext}get _bindParameters(){return this._renderContext.bind}get _framebufferSize(){return this._framebuffer.size}get performanceInfo(){return this._performanceInfo}updateRenderFeatures(e=null,t=!Qe("disable-feature:high-quality-idle")){this._renderStateFeatures.value=eP(t,e),this._requestRender()}isFeatureEnabled(e,t=this._state.value){return this._renderStateFeatures.value.get(t,e)??!1}setFeatureEnabled(e,t,i){this._renderStateFeatures.mutate(r=>r.set(t,e,i)),this._requestRender()}get _highQualityTransparency(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(1)}get hasReflections(){return this._pluginsHas.water&&(this._ssrEnabled||this.isFeatureEnabled(5))}get _hasHighlights(){return this._plugins.produces(9,2,4,18,13,14)}hasHighlight(e){return this._plugins.hasHighlight(e)}get _hasHUDHighlights(){return this._plugins.produces(9,13,14)}get hasSSAO(){return(this.stage.view.qualitySettings.ambientOcclusion||this.isFeatureEnabled(4))&&!this._inGlobeView}get hasSMAA(){return this.stage.view.qualitySettings.antialiasingEnabled||this.isFeatureEnabled(0)}get hasEmitters(){return this._plugins.hasEmitters&&this.stage.view.qualitySettings.physicallyBasedRenderingEnabled}get fullResolutionAtmosphere(){return this.stage.view.qualitySettings.highResolutionAtmosphere||this.isFeatureEnabled(3)}get fboCache(){return this._fboCache}_releaseFBOs(){this._bindParameters.ssr.lastFrameColor=Ht(this._bindParameters.ssr.lastFrameColor),this._bindParameters.terrainDepth=Ht(this._bindParameters.terrainDepth),this._bindParameters.geometryDepth=Ht(this._bindParameters.geometryDepth)}_disposeOffscreenBuffers(){this._framebuffer.dispose(),this._disposeBindBuffers()}_disposeBindBuffers(){this._shadowMap.disposeOffscreenBuffers(),this._bindParameters.depth=Ht(this._bindParameters.depth),this._bindParameters.hudVisibility=Ht(this._bindParameters.hudVisibility)}get updating(){return this._loadEdgeViewTask&&!this._loadEdgeViewTask.finished||this._edgeView?.updating||this._shadowAccumulator.readyToRun||this._plugins.updating||!this.isCameraFinal}loadEdgeView(){return this._loadEdgeViewTask||(this._loadEdgeViewTask=Ya(async e=>{const{EdgeView:t}=await k(()=>le(()=>import("./EdgeView-BleGvDNY-CWq-AQWV.js"),__vite__mapDeps([469,3,14,19,9,7,1,2,8,20,38,167,6,4,10,200,171,69,87,172,173,170,234,178,179,86,180,181,101,27,175,468,182,169,183,177,184,166,168,174,176,13,36,37,34,11,12,92,185,186,187,91,93,26,89,94,188,470,231,112,113,16,471,467,415,227,215,141,82,83,84,81,80,70,216,160,18,28,21,22,23,189,190,191,25,5,15,29,30,31,32,33,35,39,40,41,42,43,128,192,193,194,195,97,196,197,75,198,46,201,202,203,146,51,204,205,206,143,207,208,209,68,210,50,47,48,211,212,213,214,131,217,221,226,233,121,199,165,218,219,220,98,99,222,223,224,225,79,228,229,230,232,235,236])),ue([470,1,14,19,9,7,8,5,6,20,39,183,4,2,10,180,187,70,88,188,189,186,248,194,195,87,196,197,102,28,191,469,198,185,199,193,200,182,184,190,192,13,37,38,35,11,12,93,201,202,203,92,94,27,90,95,204,471,245,113,114,16,472,468,416,241,229,142,83,84,85,82,81,71,230,161,18,29,21,22,23,24,205,206,175,26,3,15,30,31,32,33,34,36,40,41,42,43,44,129,207,208,209,210,98,211,122,52,212,76,213,214,47,215,216,217,147,218,219,220,144,221,222,223,69,224,51,48,49,225,226,227,228,166,132,231,232,233,234,99,100,235,236,237,238,239,80,240,242,243,244,246,247,249,250]));qe(e);const i=this._edgeView=new t({rctx:this._rctx,renderSR:this.stage.view.renderSpatialReference,viewingMode:this.stage.view.stage.viewingMode,techniques:this._techniques,setNeedsRender:()=>this._requestRender(),schedule:KY(this.stage.view.resourceController)});return this.addHandles(M(()=>i.updating,()=>this._requestRender(),Ie)),this._requestRender(),this._edgeViewCallbacks.forEach(r=>r(i)),this._edgeViewCallbacks.length=0,i})),this._loadEdgeViewTask.promise}withEdgeView(e){this.loadEdgeView(),this._edgeView==null?this._edgeViewCallbacks.push(e):e(this._edgeView)}get edgeView(){return this._edgeView}get isCameraFinal(){return this._reprojectionMatrixVersion.value>=0&&iL(this._bindParameters.ssr.reprojectionMatrix,vn)}set _reprojectionMatrix(e){PA(this._bindParameters.ssr.reprojectionMatrix,e)&&this._reprojectionMatrixVersion.value++}get shadowsEnabled(){return!!this._shadowMap?.enabled}setParameters(e){const{_shadowMap:t,_bindParameters:i}=this;if(e.qualitySettings?.reflections!==void 0&&this._ssrEnabled!==e.qualitySettings.reflections&&(this._ssrEnabled=e.qualitySettings.reflections,this._requestRender()),e.shadowMap!==void 0&&this._shadowMap.enabled!==e.shadowMap&&(this._shadowMap.enabled=e.shadowMap,this._requestRender()),e.shadowMapMaxCascades!==void 0&&t.maxCascades!==e.shadowMapMaxCascades&&(t.maxCascades=e.shadowMapMaxCascades,this._requestRender()),e.environment){e.environment.weather!==void 0&&(this._bindParameters.weather=e.environment.weather);const r=e.environment.lighting.type!=="virtual";i.enableFillLights!==r&&(i.enableFillLights=r,this._requestRender())}e.highQualityTransparency!==void 0&&this._highQualityTransparencyEnabled!==e.highQualityTransparency&&(this._highQualityTransparencyEnabled=e.highQualityTransparency,this._requestRender()),e.shadowCast!==void 0&&this._shadowAccumulator.setOptions(e.shadowCast)}set slice(e){this._sliceHelper.update(e)&&this._requestRender()}get plugins(){return this._plugins}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlend.result}get _oitEnabled(){return this._highQualityTransparency&&this._hasOITSupport}commit(e,t){return this._isRendering&&console.warn("Renderer.modify called while rendering"),!!super.commit(e,t,this._plugins.context)&&(this.updateHasFlags(),!0)}rendererAdded(e){this._plugins.add(e)}rendererRemoved(e){this._plugins.remove(e)}get occludedRequiresStencil(){return this.occludedRequiresOccludeeStencil||this.occludedRequiresIntegratedMeshStencil}get occludedRequiresOccludeeStencil(){return this._bindParameters.hasOccludees&&!!(8&this.plugins.renderOccludedFlags)}get occludedRequiresIntegratedMeshStencil(){return this._plugins.produces(0,0)&&this._plugins.produces(0,9)}updateHasFlags(){const e=this._pluginsHas;e.hudElements=this._plugins.produces(0,...id),e.water=this._plugins.produces(3,19),this._bindParameters.hasOccludees=this._plugins.hasOccludees,this._requestRender()}updateAnimation(e,t){this._animationTimer??=new cY(e.camera,t),this._animationTimer.advance(e.camera,t,this._animationTimeDilation);const i=this._hasAnimations;return this._hasAnimations=this._plugins.updateAnimation(this._animationTimer),this._hasAnimations=this._nodes.updateAnimation(this._animationTimer)||this._hasAnimations,this._hasAnimations!==i&&(this._gpuTimerHandle=i?xi(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo()),this._hasAnimations}get animationTimestep(){return this._animationTimestep.value}get _animationTimeDilation(){return this._animationTimestep.timeDilation}resetAnimation(){this._animationTimestep.clear()}tick(){this.fboCache.clean()}render(e,t,i,r=!1){try{return this._isRendering=!0,this._render(e,t,i,r)}catch(s){console.error(`Exception during rendering: ${s}`)}finally{this._isRendering=!1}return new ES(this._pluginInput.get(Ft.FINAL),null)}_updateHUDOccludedFragmentOpacity(e,t){const{idleOpacity:i,navigatingOpacity:r,maxDelta:s,tiltFadeStart:n,tiltFadeEnd:a,altitudeStart:o,altitudeEnd:l}=DY,c=this.stage.view,u=c.stateManager.camera,p=c.qualitySettings.fadeDuration,m=e===2?i:r,f=j((u.tilt-n)/(a-n),0,1),g=j(((u.position.z??0)-o)/(l-o),0,1),y=De(De(1,m,f),1,g),v=this._bindParameters.hudOccludedFragmentOpacity;if(p<=0||v===y||this._lastFrameTime===0||this._lastFrameTime>t)return this._bindParameters.hudOccludedFragmentOpacity=y,void(this._lastFrameTime=t);const C=t-this._lastFrameTime;this._lastFrameTime=t;const b=Math.max(1-i,Math.abs(i-r)),S=Math.min(b*C/p,s);S>=Math.abs(y-v)?this._bindParameters.hudOccludedFragmentOpacity=y:(this._bindParameters.hudOccludedFragmentOpacity=v+Math.sign(y-v)*S,this._requestRender())}_render(e,t,i,r){const s=i===0;this.performanceInfo.startFrame(),this.fboCache.frameStart(),this.fboCache.interactive=s,this._disposeBindBuffers();const{camera:n,contentCamera:a,mode:o,alignPixelEnabled:l}=e;this._state.value=o;const c=this._nodes.produces("magnifier-color"),u=this._nodes.produces(Ft.FINAL),p=this.hasEmitters,m=p?1:0;this._renderContext.time=t,this._renderContext.output=m,this._bindParameters.oitPass=0,this._bindParameters.alignPixelEnabled=l,this._bindParameters.decorations=!r,this._bindParameters.mainDepth=null;const f=!r||!this._sliceHelper.isDecoration;this._bindParameters.slicePlane=f?this._sliceHelper.plane:null,this._bindParameters.viewshedEnabled=this._nodes.produces(ne.VIEWSHED),this._bindParameters.cutFillEnabled=this._nodes.produces(ne.CUTFILL_DEPTH),this._renderOverlay(),n.setGLViewport(this._rctx);const g=this._framebuffer,y=g.initialize(n.fullWidth,n.fullHeight,this._backgroundColor,p);this.hasReflections?(y?.setName("last frame color"),this._bindParameters.ssr.lastFrameColor=y):y?.release(),this._ensureBindParametersCamera(n,a),this._updateHUDOccludedFragmentOpacity(o,t),this._plugins.prepareRender(),this._bindParameters.shadowHighlightsVisible=this._needsShadowHighlight&&!r;const v=this._highQualityTransparency&&this._hasTransparentTerrain,C=this._plugins.produces(0,...td);this._precompilePrepasses(),this.performanceInfo.advance(Zt.PREPARE);const b=this._computeShadowDepthRange(n);this._renderShadowMap(n,this._bindParameters.lighting.mainLight.direction,b),this._pluginInput.set("normals",this._renderNormals()),this._renderRemainingGeometryDepth(),this._renderShadowAccumulation(b,n,a,!s),this._ensureBindParametersSSR(t),this._precompileShaders(v,C,m),this._renderContext.output=m,g.bind(),this._bindParameters.mainDepth=g.depth.attachment,this._renderOpaque(v),this._renderTransparent(C,v,m),this._shadowMap.disposeMainBuffer(),this._pluginInput.set(ne.FOCUSAREA,this._renderFocusAreaGeometry()),this._pluginInput.set(ne.CUTFILL_DEPTH,this._renderCutFillDepth()),g.update(A=>this._renderNodes(ne.TRANSPARENT_ENVIRONMENT,A)),g.update(A=>this._renderNodes(ne.VIEWSHED,A)),g.update(A=>this._renderNodes(ne.LASERLINES,A)),g.update(A=>this._renderNodes(ne.FOCUSAREA_COLOR,A)),this._pluginInput.release(ne.FOCUSAREA),this._pluginInput.release(ne.CUTFILL_DEPTH),g.update(A=>this._renderNodes(ne.OCCLUDED,A)),this._pluginInput.set("highlights",this._renderHighlightPrepass()),this._renderHighlightShadowMap(n,this._bindParameters.lighting.mainLight.direction,b);const S=i===2?this._renderObjectAndLayerIdColor():null;g.update(A=>this._renderNodes(Ft.COMPOSITE,A)),this._shadowMap.disposeOffscreenBuffers();const x=s&&!u&&!(c&&!r),T=this._pluginInput.get(Ft.COMPOSITE),P=x?hu:this.fboCache.acquire(T.fbo.width,T.fbo.height,ne.ANTIALIASING),R=this._nodes.produces(ne.ANTIALIASING)?this._renderNodes(ne.ANTIALIASING,P):this.blitFBO(T,P,!1);let O;this._pluginInput.set(ne.ANTIALIASING,R),this._hasHUDHighlights?(this._renderHUD(1,R,m),O=this._renderNodes(ne.HIGHLIGHTS,R)):(O=this._renderNodes(ne.HIGHLIGHTS,R),this._renderHUD(1,O,m));const E=this._renderNodes(ne.MAGNIFIER,O);return s&&c&&!r&&!u&&this.blitFBO(E),u?(E.attachDepth(g.depth),this.blitFBO(this._renderNodes(Ft.FINAL,E)),E.detachDepth()):this._pluginInput.set(Ft.FINAL,E),this._pluginInput.release("highlights"),this.onPostRender&&this.onPostRender(),this._releaseFBOs(),g.releaseDepth(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this.fboCache.frameEnd(),this.performanceInfo.finishFrame(),s||(this._releaseFBOs(),this._disposeOffscreenBuffers()),new ES(this._pluginInput.get(Ft.FINAL),S)}_precompileShaders(e,t,i){++this._plugins.context.techniques.precompiling,this._renderContext.output=i,this._precompileOpaqueGeometry(),this._nodes.precompile(ne.OPAQUE_ENVIRONMENT),this._bindParameters.terrainDepthTest=e,this._bindParameters.cullAboveTerrain=e,this._renderContext.output=2,this._plugins.precompile(6),this._plugins.precompile(7),e&&(this._precompileOpaqueGeometry(),this._precompileTransparentGeometry()),this._renderContext.output=i,this._plugins.precompile(6),this._plugins.precompile(7),t&&(this._precompileTransparentGeometry(),this._hasTransparentTerrain&&(this._bindParameters.cullAboveTerrain=!1,this._precompileTransparentGeometry(),this._bindParameters.cullAboveTerrain=e)),this._nodes.precompile(ne.FOCUSAREA),this._needsHUDVisibility&&this._plugins.precompile(12),this._plugins.precompile(15),this._precompileHUD(0),this._bindParameters.terrainDepthTest=!1,this._bindParameters.cullAboveTerrain=!1,this._nodes.precompile(ne.VIEWSHED,ne.CUTFILL_DEPTH,ne.CUTFILL_COLOR,ne.LASERLINES,ne.FOCUSAREA_COLOR,ne.OCCLUDED,ne.ANTIALIASING,ne.HIGHLIGHTS);const r=this._bindParameters;r.highlightMixTexture=r.highlights.length>1?this._rctx.emptyTexture:null,this._precompileHUD(1),this._hasHighlights&&(r.highlights.forEach((s,n)=>{r.highlightLevel=n,this._precompileAllGeometry(9)}),r.highlightLevel=null),r.highlightMixTexture=null,this._nodes.precompile(Ft.COMPOSITE,ne.MAGNIFIER),this._shadowAccumulator.precompile(),this._plugins.precompile(8),--this._plugins.context.techniques.precompiling}_renderFocusAreaGeometry(){const e=this._nodes.produce(ne.FOCUSAREA,this._pluginInput);return e&&this.performanceInfo.advance(Zt.FOCUS_AREA_MASK),e}_renderObjectAndLayerIdColor(){if(!this._nodes.produces("olid"))return null;const e=this._renderContext.output;++this._techniques.precompiling;const t=this._framebufferSize;let i=this.fboCache.acquire(t.width,t.height,"olid");return i.acquireDepth(13),i=this._nodes.render(i,this._pluginInput),--this._techniques.precompiling,this.performanceInfo.advance(Zt.OBJECT_AND_LAYER_ID_COLOR),this._renderContext.output=e,i}finish(e){this._hasAnimations||this._animationTimestep.clear();const t=this.performanceInfo.gpuSamplingEnabled,i=e===0;if(i||t){const r=i?this.performanceInfo.elapsedTime:0;let s=0;t?s=this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.finish();const n=Math.max(r,s);this._animationTimestep.frame(n,i)}}readMainDepth(e,t){const{mainDepth:i,camera:r}=this._bindParameters;if(!i)return;const s=this.fboCache.acquire(this._framebufferSize.width,this._framebufferSize.height,"linear depth");this._rctx.bindFramebuffer(s.fbo),r.setGLViewport(this._rctx),this._rctx.setScissorRect(e[0],e[1],e[2],e[3]),this._rctx.setScissorTestEnabled(!0),this._rctx.clearFramebuffer(di),this._compositingHelper.blitDepthToLinearDepth(this._bindParameters,i),this._rctx.setScissorTestEnabled(!1),this._rctx.setScissorRect(0,0,this._rctx.gl.canvas.width,this._rctx.gl.canvas.width),s.fbo?.readPixels(e[0],e[1],e[2],e[3],6408,ni.UNSIGNED_BYTE,t),s.release()}readHUDVisibility(e,t,i,r,s){this._bindParameters.hudVisibility?.fbo?.readPixels(e,t,i,r,6408,ni.UNSIGNED_BYTE,s)}readAccumulatedShadow(e){return this._shadowAccumulator.readAccumulatedShadow(e[0],e[1])}_renderEdges(e){const t=this._edgeView;if(!t?.shouldRender())return;const i=this._renderContext.output,r=this._framebufferSize,s=this.fboCache.acquire(r.width,r.height,"edges"),n=()=>t.render(this._bindParameters,e),a=this._bindParameters.geometryDepth;this.renderToTargets(n,s,a??this._framebuffer.depth,di),this._framebuffer.bind(),this._compositingHelper.composite(this._bindParameters,s.getTexture(),by(i)?1:0),s.release(),this.performanceInfo.advance(e===1?Zt.OPAQUE_EDGES:Zt.TRANSPARENT_EDGES)}_renderOverlay(){this._bindParameters.overlay=this.overlay?.render(),this._bindParameters.overlay&&this.performanceInfo.advance(Zt.OVERLAY)}_renderShadowMap(e,t,i){if(!this.shadowsEnabled)return;const{contentCamera:r}=this._bindParameters,s=this._shadowMap;s.start(e,t,i,this.isFeatureEnabled(6),this.stage.view.qualitySettings.maximumPixelRatio),this._needsShadowHighlight?(this._renderShadowCascades(6,this._shadowMap),s.copySnapshot(1),this._renderShadowCascades(5,this._shadowMap)):this._renderShadowCascades(4),s.finish(),e.setGLViewport(this._rctx),this._ensureBindParametersCamera(e,r),this.performanceInfo.advance(Zt.SHADOW_MAP)}_renderHighlightShadowMap(e,t,i){if(!this.shadowsEnabled||!this._needsShadowHighlight)return;const{contentCamera:r}=this._bindParameters,s=this._shadowMap;s.start(e,t,i,this.isFeatureEnabled(6),this.stage.view.qualitySettings.maximumPixelRatio),this._renderShadowCascades(5,this._shadowMap),s.moveSnapshot(0),s.finish(),e.setGLViewport(this._rctx),this._ensureBindParametersCamera(e,r),this.performanceInfo.advance(Zt.SHADOW_MAP)}_renderCutFillDepth(){return this._nodes.produce(ne.CUTFILL_DEPTH,this._pluginInput)}_precompileShadowCascades(e){for(const t of this._shadowMap.cascades)t.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(t.camera,t.camera),this._precompileAllGeometry(e)}_renderShadowCascades(e,t=this._shadowMap){t.bindFbo();for(const i of t.cascades)i.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(i.camera,i.camera),this.renderAllGeometry(e)}get _needsDepth(){return this._plugins.consumes(2)||this._nodes.requireGeometryDepth()||this.hasReflections||this._needsShadowHighlight||this._shadowAccumulator.active||this._debugNeedsDepth}_renderRemainingGeometryDepth(){const e=this._pluginInput.get("normals");e?(this._pluginInput.set(ne.SSAO,this._renderSSAO()),this._needsDepth?(this._rctx.bindFramebuffer(e.fbo),this._rctx.clear(1024),this._renderGeometryWithoutNormals(2),Ht(this._bindParameters.depth),this._bindParameters.depth=e.obtainDepthTexture(),this.performanceInfo.advance(Zt.DEPTH)):(e.detachDepth(),this._bindParameters.depth=Ht(this._bindParameters.depth)),this.hasSSAO&&this._pluginInput.release("normals")):this._renderAllGeometryDepth()}_renderAllGeometryDepth(){if(!this._needsDepth)return void(this._bindParameters.depth=Ht(this._bindParameters.depth));const e=this._framebufferSize,t=this.fboCache.acquire(e.width,e.height,"geometry depth",13);this._rctx.bindFramebuffer(t.fbo),this._rctx.clear(1280),this.renderAllGeometry(2),Ht(this._bindParameters.depth),this._bindParameters.depth=t.obtainDepthTexture(),t.release(),this.performanceInfo.advance(Zt.DEPTH)}_renderTerrainDepth(e){if(this._bindParameters.terrainDepthTest=e,this._bindParameters.cullAboveTerrain=e,!e)return void(this._bindParameters.terrainDepth=Ht(this._bindParameters.terrainDepth));const t=this._renderContext.output;this._renderContext.output=2;const i=this._framebufferSize,r=this.fboCache.acquire(i.width,i.height,"terrain depth",13);this._rctx.bindFramebuffer(r.fbo),this._rctx.clear(1280),this._renderTransparentTerrain(),Ht(this._bindParameters.terrainDepth),this._bindParameters.terrainDepth=r.obtainDepthTexture(),this._renderContext.output=t,r.release()}_renderGeometryDepth(e){if(!e)return void(this._bindParameters.geometryDepth=Ht(this._bindParameters.geometryDepth));const t=this._renderContext.output,{width:i,height:r}=this._framebufferSize,s=this.fboCache.acquire(i,r,"geometry depth",13);this._rctx.bindFramebuffer(s.fbo),this._rctx.clear(1280),this._renderOpaqueAndTransparentGeometry(2),this._renderContext.output=t,Ht(this._bindParameters.geometryDepth),this._bindParameters.geometryDepth=s.obtainDepthTexture(),s.release()}get _needsShadowDepthRange(){return this._shadowMap.enabled||this._shadowAccumulator.active}_computeShadowDepthRange(e){if(!this._needsShadowDepthRange)return nr.Zero;const t=YT(e,this._plugins.plugins,this.stage.layers,0);return t.union(this._plugins.queryDepthRange(e)),t.near=Math.max(e.near,t.near),t.far=Math.min(e.far,t.far),t}updateSceneDepthRange(e){if(!this.stage.view.state.isGlobal)return void(this.sceneDepthRange.value=nr.Infinite);if((this.stage.view.renderCoordsHelper?.getAltitude(e.eye)??0)<g8)return void(this.sceneDepthRange.value=nr.Infinite);const t=e.clone();t.near=_8,t.far=1e10;const i=YT(t,this._plugins.plugins,this.stage.layers,1);i.union(this._plugins.queryDepthRange(t)),this.sceneDepthRange.value.equals(i)||(this.sceneDepthRange.value=i)}get _normalsRequired(){const e=this._nodes.require("normals",Ft.FINAL,Ft.COMPOSITE,Ft.OPAQUE,Ft.TRANSPARENT,ne.VIEWSHED,ne.LASERLINES);return(this.hasSSAO?1:0)+e}_precompilePrepasses(){this._normalsRequired&&this._precompileAllGeometry(3),this._needsDepth&&this._precompileAllGeometry(2),this.shadowsEnabled&&(this._needsShadowHighlight?(this._precompileShadowCascades(5),this._precompileShadowCascades(6),this._precompileShadowCascades(5)):this._precompileShadowCascades(4)),this._shadowAccumulator.active&&this._precompileAllGeometry(4)}_renderNormals(){const e=this._normalsRequired;if(e===0)return;const t=this._framebufferSize,i=this.fboCache.acquire(t.width,t.height,"normals",5);i.acquireDepth(13),this._rctx.bindFramebuffer(i.fbo),this._rctx.clearFramebuffer(di,!0,!0),this._renderGeometryWithNormals(3);const r=this._nodes.optional("normals",Ft.FINAL,Ft.COMPOSITE,Ft.OPAQUE,Ft.TRANSPARENT,ne.VIEWSHED);return i.retain(e+r-1),this.performanceInfo.advance(Zt.NORMALS),i}_renderSSAO(){const e=this._pluginInput.get("normals");if(!this.hasSSAO||!e)return;const t=this._nodes.produce(ne.SSAO,this._pluginInput);return this._bindParameters.ssao=t,t&&this.performanceInfo.advance(Zt.SSAO),t}_precompileAllGeometry(e){const t=this._renderContext.output;this._renderContext.output=e,this._precompileOpaqueGeometry(),this._precompileTransparentGeometry(),this._plugins.precompile(6),this._plugins.precompile(7),this._renderContext.output=t}renderAllGeometry(e){this._renderContext.output=e,this._renderOpaqueAndTransparentGeometry(e),this._renderTransparentTerrain()}precompileSlots(e,...t){for(const i of t)this._bindParameters.slot=i,e.precompile(this._renderContext)}precompileOccludedSlots(e,t){for(const i of t)this._renderContext.renderOccludedMask=i,this.precompileSlots(e,...aP);this._renderContext.renderOccludedMask=Ip}renderSlots(e,...t){for(const i of t)this._bindParameters.slot=i,e.forAll(r=>{const s=r.acquireTechniques(this._renderContext);s&&r.render(this._renderContext,s)})}renderOccludedSlots(e,t){this._renderContext.renderOccludedMask=t,this.plugins.renderOccludedFlags>1&&this._plugins.render(9),this.renderSlots(e,...aP),this._renderContext.renderOccludedMask=Ip}renderHUD(e){this._bindParameters.hudRenderStyle=e,this._plugins.render(13)}precompileViewshedShadowMap(){this._precompileAllGeometry(7)}precompileCutFill(){const e=this._renderContext.output;this._renderContext.output=8,this._plugins.precompile(0,1,6),this._renderContext.output=e}renderViewshedShadowMap(e){const{camera:t,contentCamera:i}=this._bindParameters,r=this._renderContext.output;e.setGLViewport(this._rctx),this._ensureBindParametersCamera(e,e),this.renderAllGeometry(7),this._ensureBindParametersCamera(t,i),this._bindParameters.camera.setGLViewport(this._rctx),this._renderContext.output=r}renderCutFillReferenceDepth(e){const{camera:t,contentCamera:i}=this._bindParameters,r=this._renderContext.output;e.setGLViewport(this._rctx),this._ensureBindParametersCamera(e,e),this._renderContext.output=8,this._plugins.render(0,1),this._plugins.render(6),this._ensureBindParametersCamera(t,i),t.setGLViewport(this._rctx),this._renderContext.output=r}_renderOpaqueAndTransparentGeometry(e){this._renderContext.output=e,this._renderOpaqueGeometry(),this._renderTransparentGeometry()}_renderGeometryWithNormals(e){this._renderContext.output=e,this._plugins.render(...QY),this._renderTransparentTerrain()}_renderGeometryWithoutNormals(e){this._renderContext.output=e,this._plugins.render(...XY)}_precompileOpaqueGeometry(){this._plugins.precompile(...uv),this._nodes.precompile("opaque-color")}_renderOpaqueGeometry(){this._plugins.render(...uv)}_renderTransparentGeometry(){this._plugins.render(...td)}get _hasTransparentTerrain(){return this._plugins.produces(0,6)}get _hasTransparentIntegratedMesh(){return this._plugins.produces(this._renderContext.output,7)}_renderTransparentTerrain(){const e=()=>this._plugins.render(6);if(!or(this._renderContext.output))return void e();const t=this._framebufferSize,i=this.fboCache.acquire(t.width,t.height,"transparent terrain");return this.renderToTargets(e,i,this._framebuffer.depth,di),i}_renderTransparentIntegratedMesh(){const e=()=>this._plugins.render(7);if(!or(this._renderContext.output))return void e();const t=this._framebufferSize,i=this.fboCache.acquire(t.width,t.height,"transparent integrated mesh");return this.renderToTargets(e,i,this._framebuffer.depth,di),i}get _needsHUDVisibility(){return this._plugins.produces(this._renderContext.output,12)}_renderHUDVisibility(){if(!this._needsHUDVisibility)return void(this._bindParameters.hudVisibility=Ht(this._bindParameters.hudVisibility));const{width:e,height:t}=this._framebufferSize;let i=this._bindParameters.hudVisibility;i?.fbo?.width===e&&i?.fbo?.height===t||(i?.release(),i=this.fboCache.acquire(e,t,"hud visibility",4),this._bindParameters.hudVisibility=i);const r=this._bindParameters.geometryDepth;i.attachDepth(r||this._framebuffer.depth),this._rctx.bindFramebuffer(i.fbo),this._rctx.clearFramebuffer([0,1,0,1]),this._plugins.render(12),i.detachDepth(),this._framebuffer.bind(),this.performanceInfo.advance(Zt.HUD_VISIBILITY)}_renderLineCallouts(e){if(this._bindParameters.hudRenderStyle=e,e===0){const t=()=>this._plugins.render(15),i=this._framebufferSize,r=this.fboCache.acquireDepth(12,i.width,i.height,"line callouts");this.renderToTargets(t,this._framebuffer.color,r,void 0,!0,!0),r.release()}else this._plugins.render(15)}_precompileHUD(e){if(this._precompileHUDOutput(e),this._hasHighlights){const t=this._renderContext.output;this._renderContext.output=9,this._precompileHUDOutput(e),this._renderContext.output=t}}_precompileHUDOutput(e){const t=this._bindParameters.hudRenderStyle;this._bindParameters.hudRenderStyle=e,this._oitEnabled&&or(this._renderContext.output)?(this._bindParameters.oitPass=1,this._plugins.precompile(...id),this._bindParameters.oitPass=2,this._plugins.precompile(...id),this._bindParameters.oitPass=0):this._plugins.precompile(...id),this._bindParameters.hudRenderStyle=t}_renderHUD(e,t,i){if(this._pluginsHas.hudElements){if(this._oitEnabled){const r=this._renderOIT(1,i,e);this._rctx.bindFramebuffer(t.fbo),this._compositingHelper.compositePreMultipliedAlpha(this._bindParameters,r.getTexture(),0),r.release()}else if(this._renderContext.output=i,e===0){const r=()=>this._renderHUDElements(e),s=this._framebufferSize,n=this.fboCache.acquireDepth(12,s.width,s.height,"hud");this.renderToTargets(r,this._framebuffer.color,n,void 0,!0,!0),n.release()}else t.acquireDepth(12),this._rctx.bindFramebuffer(t.fbo),this._renderHUDElements(e),t.detachDepth();this.performanceInfo.advance(e===0?Zt.HUD_OCCLUDED:Zt.HUD)}}_renderHUDElements(e){this._bindParameters.hudRenderStyle=e,this._plugins.render(...id)}get _needsShadowHighlight(){return this.shadowsEnabled&&this._plugins.produces(5,2)}_renderHighlightPrepass(){if(!this._hasHighlights)return;const{fboCache:e,_rctx:t,_bindParameters:i}=this,r=this._framebufferSize,{highlights:s}=i,n=e.acquire(r.width,r.height,"highlights",s.length>qb?3:1);n.acquireDepth(13);const a=this._plugins.produces(9,0);return a&&this._framebuffer.color.fbo&&n.fbo&&t.blitFramebuffer(this._framebuffer.color.fbo,n.fbo,1024),t.bindFramebuffer(n.fbo),t.gl.clearBufferuiv(6144,0,[0,0,0,0]),a||t.clear(1024),this._renderContext.output=9,t.bindFramebuffer(n.fbo),_O(t,e,r,i,()=>this._renderHighlightGeometries()),n.detachDepth(),this.performanceInfo.advance(Zt.HIGHLIGHTS),n}_renderHighlightGeometries(){this._plugins.render(...YY),this._rctx.clear(256),this._renderHUDElements(2)}_renderShadowAccumulation(e,t,i,r){this._shadowAccumulator.updateDepthRange(e),this._shadowAccumulator.accumulating&&this._bindParameters.depth&&this._shadowAccumulator.renderAccumulation(this._bindParameters.depth,t,i,r)&&this.performanceInfo.advance(Zt.ACCUMULATED_SHADOWS)}_precompileTransparentGeometry(){this._oitEnabled&&or(this._renderContext.output)?(this._bindParameters.oitPass=1,this._plugins.precompile(...td),this._bindParameters.oitPass=2,this._plugins.precompile(...td),this._bindParameters.oitPass=0):this._plugins.precompile(...td)}_renderOIT(e,t,i=2){const r=e===1,s=this._framebufferSize,n=r?this.fboCache.acquire(s.width,s.height,"oit hud composite"):null,a=r?()=>this._renderHUDElements(i):()=>this._renderTransparentGeometry(),o=this._bindParameters,l=this._renderContext.output;this._renderContext.output=t,o.oitPass=1;const c=n?"oit hud color+alpha":"oit color+alpha",u=this.fboCache.acquire(s.width,s.height,c,8),p=t===1;p&&u.acquireColor(Qr,8,"oit emissive"),u.acquireColor(p?sM:Qr,7),n||u.attachDepth(this._framebuffer.depth),this._rctx.bindFramebuffer(u.fbo),this._rctx.clearFramebuffer([0,0,0,1]),p&&this._rctx.clearBuffer(1,ty),a(),u.detachDepth(),o.oitPass=2;const m=this.fboCache.acquire(s.width,s.height,n?"oit hud front":"oit front");return p&&m.acquireColor(Qr,8,"oit emissive front"),n?m.acquireDepth(12):m.attachDepth(this._framebuffer.depth),this._rctx.bindFramebuffer(m.fbo),this._rctx.clearFramebuffer(di,!!n),a(),m.detachDepth(),o.oitPass=0,n?(this._rctx.bindFramebuffer(n.fbo),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clear(16384)):this._framebuffer.bind(),this._oitblend??=new lY(this._techniques),this._oitblend.blend(this._rctx,u,m,o,p,!r),n?.detachDepth(),m.release(),u.release(),this._renderContext.output=l,n}_renderOpaque(e){const t=this.plugins.produces(0,...uv);if(t){this._plugins.render(0,1);const r=this._framebuffer;r.update(s=>this._renderNodes(ne.CUTFILL_COLOR,s)),r.update(s=>this._renderNodes(ne.OPAQUE_TERRAIN,s)),r.bind(),this._plugins.render(2,3)}const i=this._framebuffer;this._renderTerrainDepth(e),i.update(r=>this._renderNodes(Ft.OPAQUE,r,t)),this.fboCache.debugCallback?.(Ft.OPAQUE,i.color.fbo),i.update(r=>this._renderNodes(ne.OPAQUE_ENVIRONMENT,r)),this.fboCache.debugCallback?.(ne.OPAQUE_ENVIRONMENT,i.color.fbo),this._renderEdges(1)}_renderTransparent(e,t,i){const r=this._framebuffer;r.bind(),this._renderPlugins(20,Zt.VOXEL),this._renderHiddenTransparentEdges(),e&&(this._oitEnabled?this._renderOIT(0,i):this._renderTransparentGeometry()),r.update(a=>this._renderNodes(Ft.TRANSPARENT,a,e)),this.fboCache.debugCallback?.(Ft.TRANSPARENT,r.color.fbo),this._renderGeometryDepth(t),this._renderHUDVisibility(),t||this._plugins.render(15),this._renderEdges(0);const s=this._hasTransparentTerrain?this._renderTransparentTerrain():null;s&&(this.performanceInfo.advance(Zt.TRANSPARENT_TERRAIN),this._bindParameters.hudVisibility&&(t?this._renderLineCallouts(0):(this._rctx.bindFramebuffer(this._bindParameters.hudVisibility?.fbo),this._compositingHelper.compositeHUD(this._bindParameters,s.getTexture())),this._renderHUD(0,r.color,i))),this._bindParameters.cullAboveTerrain=!1,s&&(r.bind(),this._compositingHelper.compositePreMultipliedAlpha(this._bindParameters,s.getTexture(),by(i)?1:0),s.release(),t&&(this._renderEdges(1),e&&(this._oitEnabled?this._renderOIT(0,i):this._renderTransparentGeometry(),this.performanceInfo.advance(Zt.TRANSPARENT)),this._renderEdges(0)));const n=this._hasTransparentIntegratedMesh?this._renderTransparentIntegratedMesh():null;n&&(r.bind(),this._compositingHelper.composite(this._bindParameters,n.getTexture(),by(i)?1:0),n.release()),this._bindParameters.ssao=Ht(this._bindParameters.ssao),t&&this._renderLineCallouts(1),this._bindParameters.terrainDepthTest=!1,this._renderTransparentEnvironment()}_renderTransparentEnvironment(){this._shadowAccumulator.render(this._bindParameters),this.performanceInfo.advance(Zt.APPLY_ACCUMULATED_SHADOWS),this._framebuffer.bind(),this._plugins.render(8),this.performanceInfo.advance(Zt.TRANSPARENT_MATERIAL_WITHOUT_DEPTH)}_renderPlugins(e,t){this._plugins.produces(this._renderContext.output,e)&&(this._plugins.render(e),this.performanceInfo.advance(t))}_renderNodes(e,t,i=!1){if(t.setName(e),this._pluginInput.set(e,t),!this._nodes.produces(e))return i&&this.performanceInfo.advance(e),t;const r=this._nodes.render(t,this._pluginInput,this._releaseNormals);return this.performanceInfo.advance(e),r}blitFBO(e,t=hu,i=!0){return this._blit??=new uw(this._techniques),this._blit.blit(this._rctx,e,t,this._bindParameters),this._pluginInput.set(e.name,t),i&&e.release(),t}_ensureBindParametersCamera(e,t){this._bindParameters.camera=e,this._bindParameters.contentCamera=t}_ensureBindParametersSSR(e){if(this._bindParameters.ssr.lastFrameColor){this._ssrEnableTime==null&&(this._ssrEnableTime=e),this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=vn:(tu(lP,this._bindParameters.camera.viewMatrix),tu(oP,this._bindParameters.camera.projectionMatrix),lr(Kc,lP,oP),lr(Kc,this._renderContext.lastFrameCamera.viewMatrix,Kc),lr(Kc,this._renderContext.lastFrameCamera.projectionMatrix,Kc),this._reprojectionMatrix=Kc);const t=this.stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=t>0?Math.min(t,e-this._ssrEnableTime)/t:1,this._bindParameters.ssr.fadeFactor<1&&this._requestRender()}else this._reprojectionMatrix=vn,this._ssrEnableTime=null}addRenderNode(e){this._nodes.add(e),this._requestRender()}removeRenderNode(e){this._nodes.remove(e),this._requestRender()}updateLighting(e,t,i,r){this._bindParameters.updateLighting(e,t,i,r),this._requestRender(1)}get usedMemory(){return{fbos:this.fboCache.usedMemory,plugins:this._plugins.usedMemory,edges:this.edgeView?.usedMemory??0}}renderToTargets(e,t,i,r,s=!1,n=!1){t.attachDepth(i),this._rctx.bindFramebuffer(t.fbo),this._rctx.clearFramebuffer(r,s,n),e(),t.detachDepth()}get test(){}};h([d({readOnly:!0})],vh.prototype,"fullResolutionAtmosphere",null),h([d()],vh.prototype,"_edgeView",void 0),h([d()],vh.prototype,"updating",null),vh=h([D("esri.views.3d.webgl-engine.lib.Renderer")],vh);const QY=[0,1,2,4],XY=[3,5],uv=[0,1,2,3],td=[4,5],aP=[2,4,8],id=[16,13,14],YY=[4,5,2,3,6,0,1],oP=Le(),lP=Le(),Kc=Le();function KY(e){return t=>e.immediate.schedule(t)}let JY=class{constructor(e){this._rctx=e,this._vao=eK(e)}destroy(){this._vao=ye(this._vao)}draw(){this._vao!=null&&(this._rctx.bindVAO(this._vao),this._rctx.drawArrays(St.TRIANGLES,0,3))}get test(){}};function eK(e){const t=new Float32Array([-1,-1,3,-1,-1,3]);return new Dn(e,new ei(e,qP,t))}let tK=class{constructor(e,t){this._rctx=e,this._layout=t,this._cache=new Yp(e.newCache,"VAOCache")}dispose(){this._cache.destroy()}newVao(e){const t=e.toString();let i=this._cache.pop(t);return i||(i=new Dn(this._rctx,new ei(this._rctx,this._layout)),i.buffer()?.setSize(e),i)}deleteVao(e){if(e==null)return;const t=e.getByteLength("geometry").toString();this._cache.put(t,e)}},I5=class L5{constructor(t){this._rctx=t,this._indexBuffer=this._createIndexbuffer(),this._program=this._createHelperProgram()}static getShaderSources(){return{vertex:`#version 300 es
    precision highp float;

    void main(void) {
      gl_Position = vec4(0.0, 0.0, float(gl_VertexID)-2.0, 1.0);
    }`,fragment:`#version 300 es
    precision highp float;

    out vec4 fragColor;

    void main(void) {
      fragColor = vec4(0.0, 0.0, 0.0, 1.0);
    }`}}_createHelperProgram(){const t=L5.getShaderSources();return this._rctx.programCache.acquire(t.vertex,t.fragment,new Map([]))}_createIndexbuffer(){return Hs.createIndex(this._rctx,35044,new Uint32Array([0]))}run(){this._program.compiled&&this._indexBuffer&&(this._rctx.bindVAO(null),this._rctx.useProgram(this._program),this._rctx.bindBuffer(this._indexBuffer,34963),this._rctx.drawElements(St.POINTS,1,Tn.UNSIGNED_INT,0))}dispose(){this._program.dispose(),this._indexBuffer.dispose()}get test(){}},cP=class{constructor(){this.blend=!1,this.blendColor={r:0,g:0,b:0,a:0},this.blendFunction={srcRGB:1,dstRGB:0,srcAlpha:1,dstAlpha:0},this.blendEquation={mode:32774,modeAlpha:32774},this.colorMask={r:!0,g:!0,b:!0,a:!0},this.faceCulling=!1,this.cullFace=1029,this.frontFace=2305,this.scissorTest=!1,this.scissorRect={x:0,y:0,width:0,height:0},this.depthTest=!1,this.depthFunction=513,this.clearDepth=1,this.depthWrite=!0,this.depthRange={zNear:0,zFar:1},this.viewport=null,this.stencilTest=!1,this.polygonOffsetFill=!1,this.polygonOffset=[0,0],this.stencilFunction={face:1032,func:519,ref:0,mask:1},this.clearStencil=0,this.stencilWriteMask=1,this.stencilOperation={face:1032,fail:7680,zFail:7680,zPass:7680},this.clearColor={r:0,g:0,b:0,a:0},this.program=null,this.vertexBuffer=null,this.indexBuffer=null,this.uniformBuffer=null,this.pixelPackBuffer=null,this.pixelUnpackBuffer=null,this.copyReadBuffer=null,this.copyWriteBuffer=null,this.transformFeedbackBuffer=null,this.uniformBufferBindingPoints=new Array,this.transformBufferBindingPoints=new Array,this.readFramebuffer=null,this.drawFramebuffer=null,this.drawBuffers={defaultFramebuffer:[rh],fbos:new WeakMap},this.renderbuffer=null,this.activeTexture=0,this.textureUnitMap=new Array,this.vertexArrayObject=null}},iK=class{constructor(){for(this._current=new Array,this._allocations=null;this._current.length<yi.COUNT;)this._current.push(0)}increment(e,t,i=1){this._current[e]+=i,this._allocations?.add(t)}decrement(e,t,i=1){this._current[e]-=i,this._allocations?.remove(t)}get current(){return this._current}get total(){return this.current.reduce((e,t,i)=>e+(i<yi.UNCOUNTED?t:0),0)}get resourceInformation(){let e="";if(this.total>0){e+=`Live objects:
`;for(let t=0;t<yi.COUNT;++t){const i=this._current[t];i>0&&(e+=`${AA(yi,t)}: ${i}
`)}}return e+=this._allocations?.resetLog(),e}},hP=class{constructor(e,t,i){const r=t.textureFilterAnisotropic;this.versionString=e.getParameter(e.VERSION),this.maxVertexTextureImageUnits=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.maxVertexAttributes=e.getParameter(e.MAX_VERTEX_ATTRIBS);const s=i.maxAnisotropy;this.maxMaxAnisotropy=r?Math.min(e.getParameter(r.MAX_TEXTURE_MAX_ANISOTROPY),s):1,this.maxTextureImageUnits=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this.maxPreferredTexturePixels=i.maxPreferredTexturePixels,this.maxRenderbufferSize=e.getParameter(e.MAX_RENDERBUFFER_SIZE),this.maxViewportDims=e.getParameter(e.MAX_VIEWPORT_DIMS),this.maxUniformBufferBindings=e.getParameter(e.MAX_UNIFORM_BUFFER_BINDINGS),this.maxVertexUniformBlocks=e.getParameter(e.MAX_VERTEX_UNIFORM_BLOCKS),this.maxFragmentUniformBlocks=e.getParameter(e.MAX_FRAGMENT_UNIFORM_BLOCKS),this.maxUniformBlockSize=e.getParameter(e.MAX_UNIFORM_BLOCK_SIZE),this.uniformBufferOffsetAlignment=e.getParameter(e.UNIFORM_BUFFER_OFFSET_ALIGNMENT),this.maxArrayTextureLayers=e.getParameter(e.MAX_ARRAY_TEXTURE_LAYERS),this.maxSamples=e.getParameter(e.MAX_SAMPLES),this.maxDrawBuffers=e.getParameter(e.MAX_DRAW_BUFFERS)}};const rK=["layout","centroid","smooth","case","mat2x2","mat2x3","mat2x4","mat3x2","mat3x3","mat3x4","mat4x2","mat4x3","mat4x4","uint","uvec2","uvec3","uvec4","samplerCubeShadow","sampler2DArray","sampler2DArrayShadow","isampler2D","isampler3D","isamplerCube","isampler2DArray","usampler2D","usampler3D","usamplerCube","usampler2DArray","coherent","restrict","readonly","writeonly","resource","atomic_uint","noperspective","patch","sample","subroutine","common","partition","active","filter","image1D","image2D","image3D","imageCube","iimage1D","iimage2D","iimage3D","iimageCube","uimage1D","uimage2D","uimage3D","uimageCube","image1DArray","image2DArray","iimage1DArray","iimage2DArray","uimage1DArray","uimage2DArray","image1DShadow","image2DShadow","image1DArrayShadow","image2DArrayShadow","imageBuffer","iimageBuffer","uimageBuffer","sampler1DArray","sampler1DArrayShadow","isampler1D","isampler1DArray","usampler1D","usampler1DArray","isampler2DRect","usampler2DRect","samplerBuffer","isamplerBuffer","usamplerBuffer","sampler2DMS","isampler2DMS","usampler2DMS","sampler2DMSArray","isampler2DMSArray","usampler2DMSArray","trunc","round","roundEven","isnan","isinf","floatBitsToInt","floatBitsToUint","intBitsToFloat","uintBitsToFloat","packSnorm2x16","unpackSnorm2x16","packUnorm2x16","unpackUnorm2x16","packHalf2x16","unpackHalf2x16","outerProduct","transpose","determinant","inverse","texture","textureSize","textureProj","textureLod","textureOffset","texelFetch","texelFetchOffset","textureProjOffset","textureLodOffset","textureProjLod","textureProjLodOffset","textureGrad","textureGradOffset","textureProjGrad","textureProjGradOffset"],sK=["precision","highp","mediump","lowp","attribute","const","uniform","varying","break","continue","do","for","while","if","else","in","out","inout","float","int","void","bool","true","false","discard","return","mat2","mat3","mat4","vec2","vec3","vec4","ivec2","ivec3","ivec4","uvec2","uvec3","uvec4","bvec2","bvec3","bvec4","sampler1D","sampler2D","sampler3D","usampler1D","usampler2D","usampler3D","samplerCube","sampler1DShadow","sampler2DShadow","struct","asm","class","union","enum","typedef","template","this","packed","goto","switch","default","inline","noinline","volatile","public","static","extern","external","interface","long","short","double","half","fixed","unsigned","input","output","hvec2","hvec3","hvec4","dvec2","dvec3","dvec4","fvec2","fvec3","fvec4","sampler2DRect","sampler3DRect","sampler2DRectShadow","sizeof","cast","namespace","using"],uP=["<<=",">>=","++","--","<<",">>","<=",">=","==","!=","&&","||","+=","-=","*=","/=","%=","&=","^^","^=","|=","(",")","[","]",".","!","~","*","/","%","+","-","<",">","&","^","|","?",":","=",",",";","{","}"],nK=["abs","acos","all","any","asin","atan","ceil","clamp","cos","cross","dFdx","dFdy","degrees","distance","dot","equal","exp","exp2","faceforward","floor","fract","gl_BackColor","gl_BackLightModelProduct","gl_BackLightProduct","gl_BackMaterial","gl_BackSecondaryColor","gl_ClipPlane","gl_ClipVertex","gl_Color","gl_DepthRange","gl_DepthRangeParameters","gl_EyePlaneQ","gl_EyePlaneR","gl_EyePlaneS","gl_EyePlaneT","gl_Fog","gl_FogCoord","gl_FogFragCoord","gl_FogParameters","gl_FragColor","gl_FragCoord","gl_FragData","gl_FragDepth","gl_FragDepthEXT","gl_FrontColor","gl_FrontFacing","gl_FrontLightModelProduct","gl_FrontLightProduct","gl_FrontMaterial","gl_FrontSecondaryColor","gl_LightModel","gl_LightModelParameters","gl_LightModelProducts","gl_LightProducts","gl_LightSource","gl_LightSourceParameters","gl_MaterialParameters","gl_MaxClipPlanes","gl_MaxCombinedTextureImageUnits","gl_MaxDrawBuffers","gl_MaxFragmentUniformComponents","gl_MaxLights","gl_MaxTextureCoords","gl_MaxTextureImageUnits","gl_MaxTextureUnits","gl_MaxVaryingFloats","gl_MaxVertexAttribs","gl_MaxVertexTextureImageUnits","gl_MaxVertexUniformComponents","gl_ModelViewMatrix","gl_ModelViewMatrixInverse","gl_ModelViewMatrixInverseTranspose","gl_ModelViewMatrixTranspose","gl_ModelViewProjectionMatrix","gl_ModelViewProjectionMatrixInverse","gl_ModelViewProjectionMatrixInverseTranspose","gl_ModelViewProjectionMatrixTranspose","gl_MultiTexCoord0","gl_MultiTexCoord1","gl_MultiTexCoord2","gl_MultiTexCoord3","gl_MultiTexCoord4","gl_MultiTexCoord5","gl_MultiTexCoord6","gl_MultiTexCoord7","gl_Normal","gl_NormalMatrix","gl_NormalScale","gl_ObjectPlaneQ","gl_ObjectPlaneR","gl_ObjectPlaneS","gl_ObjectPlaneT","gl_Point","gl_PointCoord","gl_PointParameters","gl_PointSize","gl_Position","gl_ProjectionMatrix","gl_ProjectionMatrixInverse","gl_ProjectionMatrixInverseTranspose","gl_ProjectionMatrixTranspose","gl_SecondaryColor","gl_TexCoord","gl_TextureEnvColor","gl_TextureMatrix","gl_TextureMatrixInverse","gl_TextureMatrixInverseTranspose","gl_TextureMatrixTranspose","gl_Vertex","greaterThan","greaterThanEqual","inversesqrt","length","lessThan","lessThanEqual","log","log2","matrixCompMult","max","min","mix","mod","normalize","not","notEqual","pow","radians","reflect","refract","sign","sin","smoothstep","sqrt","step","tan","texture2D","texture2DLod","texture2DProj","texture2DProjLod","textureCube","textureCubeLod","texture2DLodEXT","texture2DProjLodEXT","textureCubeLodEXT","texture2DGradEXT","texture2DProjGradEXT","textureCubeGradEXT","textureSize","texelFetch"];var rn=999,dP=9999,dv=0,pv=1,pP=2,mP=3,fP=4,yf=5,aK=6,oK=7,lK=8,gP=9,cK=10,_P=11,hK=["block-comment","line-comment","preprocessor","operator","integer","float","ident","builtin","keyword","whitespace","eof","integer"];function uK(){var e,t,i,r=0,s=0,n=rn,a=[],o=[],l=1,c=0,u=0,p=!1,m=!1,f="";return function(L){return o=[],L!==null?y(L.replace?L.replace(/\r\n/g,`
`):L):v()};function g(L){L.length&&o.push({type:hK[n],data:L,position:u,line:l,column:c})}function y(L){var H;for(r=0,i=(f+=L).length;e=f[r],r<i;){switch(H=r,n){case dv:r=T();break;case pv:r=x();break;case pP:r=S();break;case mP:r=P();break;case fP:r=E();break;case _P:r=O();break;case yf:r=A();break;case dP:r=F();break;case gP:r=b();break;case rn:r=C()}H!==r&&(f[H]===`
`?(c=0,++l):++c)}return s+=r,f=f.slice(r),o}function v(L){return a.length&&g(a.join("")),n=cK,g("(eof)"),o}function C(){return a=a.length?[]:a,t==="/"&&e==="*"?(u=s+r-1,n=dv,t=e,r+1):t==="/"&&e==="/"?(u=s+r-1,n=pv,t=e,r+1):e==="#"?(n=pP,u=s+r,r):/\s/.test(e)?(n=gP,u=s+r,r):(p=/\d/.test(e),m=/[^\w_]/.test(e),u=s+r,n=p?fP:m?mP:dP,r)}function b(){return/[^\s]/g.test(e)?(g(a.join("")),n=rn,r):(a.push(e),t=e,r+1)}function S(){return e!=="\r"&&e!==`
`||t==="\\"?(a.push(e),t=e,r+1):(g(a.join("")),n=rn,r)}function x(){return S()}function T(){return e==="/"&&t==="*"?(a.push(e),g(a.join("")),n=rn,r+1):(a.push(e),t=e,r+1)}function P(){if(t==="."&&/\d/.test(e))return n=yf,r;if(t==="/"&&e==="*")return n=dv,r;if(t==="/"&&e==="/")return n=pv,r;if(e==="."&&a.length){for(;R(a););return n=yf,r}if(e===";"||e===")"||e==="("){if(a.length)for(;R(a););return g(e),n=rn,r+1}var L=a.length===2&&e!=="=";if(/[\w_\d\s]/.test(e)||L){for(;R(a););return n=rn,r}return a.push(e),t=e,r+1}function R(L){for(var H,V,I=0;;){if(H=uP.indexOf(L.slice(0,L.length+I).join("")),V=uP[H],H===-1){if(I--+L.length>0)continue;V=L.slice(0,1).join("")}return g(V),u+=V.length,(a=a.slice(V.length)).length}}function O(){return/[^a-fA-F0-9]/.test(e)?(g(a.join("")),n=rn,r):(a.push(e),t=e,r+1)}function E(){return e==="."||/[eE]/.test(e)?(a.push(e),n=yf,t=e,r+1):e==="x"&&a.length===1&&a[0]==="0"?(n=_P,a.push(e),t=e,r+1):/[^\d]/.test(e)?(g(a.join("")),n=rn,r):(a.push(e),t=e,r+1)}function A(){return e==="f"&&(a.push(e),t=e,r+=1),/[eE]/.test(e)||e==="-"&&/[eE]/.test(t)?(a.push(e),t=e,r+1):/[^\d]/.test(e)?(g(a.join("")),n=rn,r):(a.push(e),t=e,r+1)}function F(){if(/[^\d\w_]/.test(e)){var L=a.join("");return n=sK.indexOf(L)>-1?lK:nK.indexOf(L)>-1?oK:aK,g(a.join("")),n=rn,r}return a.push(e),t=e,r+1}}function dK(e){var t=uK(),i=[];return i=(i=i.concat(t(e))).concat(t(null))}function pK(e){return dK(e)}function mK(e){return e.map(t=>t.type!=="eof"?t.data:"").join("")}const mv=new Set(["GL_OES_standard_derivatives","GL_EXT_frag_depth","GL_EXT_draw_buffers","GL_EXT_shader_texture_lod"]);function fK(e,t="100",i="300 es"){const r=/^\s*#version\s+([0-9]+(\s+[a-zA-Z]+)?)\s*/;for(const s of e)if(s.type==="preprocessor"){const n=r.exec(s.data);if(n){const a=n[1].replaceAll(/\s{2,}/g," ");if(a===i)return a;if(a===t)return s.data="#version "+i,t;throw new Error("unknown glsl version: "+a)}}return e.splice(0,0,{type:"preprocessor",data:"#version "+i},{type:"whitespace",data:`
`}),null}function gK(e,t){for(let i=t-1;i>=0;i--){const r=e[i];if(r.type!=="whitespace"&&r.type!=="block-comment"){if(r.type!=="keyword")break;if(r.data==="attribute"||r.data==="in")return!0}}return!1}function Bd(e,t,i,r){r=r||i;for(const s of e)if(s.type==="ident"&&s.data===i)return r in t?t[r]++:t[r]=0,Bd(e,t,r+"_"+t[r],r);return i}function F5(e,t,i="afterVersion"){function r(l,c){for(let u=c;u<l.length;u++){const p=l[u];if(p.type==="operator"&&p.data===";")return u}return null}function s(l){let c=-1,u=0,p=-1;for(let m=0;m<l.length;m++){const f=l[m];if(f.type==="preprocessor"&&(/#(if|ifdef|ifndef)\s+.+/.test(f.data)?++u:/#endif\s*.*/.test(f.data)&&--u),i!=="afterVersion"&&i!=="afterPrecision"||f.type==="preprocessor"&&f.data.startsWith("#version")&&(p=Math.max(p,m)),i==="afterPrecision"&&f.type==="keyword"&&f.data==="precision"){const g=r(l,m);if(g===null)throw new Error("precision statement not followed by any semicolons!");p=Math.max(p,g)}c<p&&u===0&&(c=m)}return c+1}const n={data:`
`,type:"whitespace"},a=l=>l<e.length&&/[^\r\n]$/.test(e[l].data);let o=s(e);a(o-1)&&e.splice(o++,0,n);for(const l of t)e.splice(o++,0,l);a(o-1)&&a(o)&&e.splice(o,0,n)}function _K(e,t,i,r="lowp"){F5(e,[{type:"keyword",data:"out"},{type:"whitespace",data:" "},{type:"keyword",data:r},{type:"whitespace",data:" "},{type:"keyword",data:i},{type:"whitespace",data:" "},{type:"ident",data:t},{type:"operator",data:";"}],"afterPrecision")}function yK(e,t,i,r,s="lowp"){F5(e,[{type:"keyword",data:"layout"},{type:"operator",data:"("},{type:"keyword",data:"location"},{type:"whitespace",data:" "},{type:"operator",data:"="},{type:"whitespace",data:" "},{type:"integer",data:r.toString()},{type:"operator",data:")"},{type:"whitespace",data:" "},{type:"keyword",data:"out"},{type:"whitespace",data:" "},{type:"keyword",data:s},{type:"whitespace",data:" "},{type:"keyword",data:i},{type:"whitespace",data:" "},{type:"ident",data:t},{type:"operator",data:";"}],"afterPrecision")}function vK(e,t){let i,r,s=-1;for(let n=t;n<e.length;n++){const a=e[n];if(a.type==="operator"&&(a.data==="["&&(i=n),a.data==="]")){r=n;break}a.type==="integer"&&(s=parseInt(a.data,10))}return i&&r&&e.splice(i,r-i+1),s}function yP(e,t){if(e.startsWith("#version 300"))return e;const i=pK(e);if(fK(i,"100","300 es")==="300 es")return e;let r=null,s=null;const n={},a={};for(let o=0;o<i.length;++o){const l=i[o];switch(l.type){case"keyword":t===35633&&l.data==="attribute"?l.data="in":l.data==="varying"&&(l.data=t===35633?"out":"in");break;case"builtin":if(/^texture(2D|Cube)(Proj)?(Lod|Grad)?(EXT)?$/.test(l.data.trim())&&(l.data=l.data.replaceAll(/(2D|Cube|EXT)/g,"")),t===35632&&l.data==="gl_FragColor"&&(r||(r=Bd(i,n,"fragColor"),_K(i,r,"vec4")),l.data=r),t===35632&&l.data==="gl_FragData"){const c=vK(i,o+1),u=Bd(i,n,"fragData");yK(i,u,"vec4",c,"mediump"),l.data=u}else t===35632&&l.data==="gl_FragDepthEXT"&&(s||(s=Bd(i,n,"gl_FragDepth")),l.data=s);break;case"ident":if(rK.includes(l.data)){if(t===35633&&gK(i,o))throw new Error("attribute in vertex shader uses a name that is a reserved word in glsl 300 es");l.data in a||(a[l.data]=Bd(i,n,l.data)),l.data=a[l.data]}}}for(let o=i.length-1;o>=0;--o){const l=i[o];if(l.type==="preprocessor"){const c=l.data.match(/#extension\s+(.*):/);if(c?.[1]&&mv.has(c[1].trim())){const m=i[o+1];i.splice(o,m&&m.type==="whitespace"?2:1)}const u=l.data.match(/#ifdef\s+(.*)/);u?.[1]&&mv.has(u[1].trim())&&(l.data="#if 1");const p=l.data.match(/#ifndef\s+(.*)/);p?.[1]&&mv.has(p[1].trim())&&(l.data="#if 0")}}return bK(e,mK(i))}function bK(e,t){return t}const wK=4294967295,xK=!!Qe("esri-tests-disable-gpu-memory-measurements");let CK=class{constructor(e,t,i,r,s=new Map,n=[]){this._context=e,this._refCount=1,this._compiled=!1,this._linesOfCode=0,this._nameToUniformLocation=new Map,this._nameToUniform1=new Map,this._nameToUniform1v=new Map,this._nameToUniform2=new Map,this._nameToUniform3=new Map,this._nameToUniform4=new Map,this._nameToUniformMatrix3=new Map,this._nameToUniformMatrix4=new Map,e||console.error("RenderingContext isn't initialized!"),t.length===0&&console.error("Shaders source should not be empty!"),t=yP(t,35633),i=yP(i,35632),this._vShader=vP(this._context,35633,t),this._fShader=vP(this._context,35632,i),this._vShader&&this._fShader||console.error("Error loading shaders!"),e.instanceCounter.increment(yi.Shader,this),Mv()&&(this.vertexShader=t,this.fragmentShader=i),this.usedMemory=xK?0:t.length+i.length;const a=this._context.gl,o=a.createProgram();a.attachShader(o,this._vShader),a.attachShader(o,this._fShader),r.forEach((l,c)=>a.bindAttribLocation(o,l,c)),this.hasTransformFeedbackVaryings=!!n?.length,this.hasTransformFeedbackVaryings&&a.transformFeedbackVaryings(o,n,a.SEPARATE_ATTRIBS),a.linkProgram(o),Mv()&&!a.getProgramParameter(o,a.LINK_STATUS)&&console.error(`Could not link shader
validated: ${a.getProgramParameter(o,a.VALIDATE_STATUS)}, gl error ${a.getError()}, vertex: ${a.getShaderParameter(this._vShader,a.COMPILE_STATUS)}, fragment: ${a.getShaderParameter(this._fShader,a.COMPILE_STATUS)}, info log: ${a.getProgramInfoLog(o)}, vertex source: ${this.vertexShader}, fragment source: ${this.fragmentShader}`);for(const[l,c]of s){const u=a.getUniformBlockIndex(o,l);u<wK&&a.uniformBlockBinding(o,u,c)}this._glName=o,e.instanceCounter.increment(yi.Program,this)}get glName(){return this._glName}get hasGLName(){return this._glName!=null}get compiled(){return!!this._compiled||(this._context.capabilities.parallelShaderCompile&&this.glName!=null?(this._compiled=!!this._context.gl.getProgramParameter(this.glName,37297),this._compiled):(this._compiled=!0,!0))}dispose(){if(--this._refCount>0)return;const e=this._context.gl,t=this._context.instanceCounter;this._nameToUniformLocation.forEach(i=>i&&t.decrement(yi.Uniform,i)),this._nameToUniformLocation.clear(),this._vShader&&(this._linesOfCode>0&&(t.decrement(yi.LinesOfCode,this._vShader,this._linesOfCode),this._linesOfCode=0),e.deleteShader(this._vShader),this._vShader=null,t.decrement(yi.Shader,this)),this._fShader&&(e.deleteShader(this._fShader),this._fShader=null),this._glName&&(e.deleteProgram(this._glName),this._glName=null,t.decrement(yi.Program,this))}ref(){++this._refCount}_getUniformLocation(e){const t=this._nameToUniformLocation.get(e);if(t!==void 0)return t;if(this.glName){const i=this._context.gl.getUniformLocation(this.glName,e);return this._nameToUniformLocation.set(e,i),i&&this._context.instanceCounter.increment(yi.Uniform,i),i}return null}hasUniform(e){return this._getUniformLocation(e)!=null}setUniform1i(e,t,i){rd(i,t);const r=this._nameToUniform1.get(e);r!==void 0&&t===r||(this._context.gl.uniform1i(this._getUniformLocation(e),t),this._nameToUniform1.set(e,t))}setUniform1iv(e,t,i){Ss(i,t),kn(this._nameToUniform1v,e,t)&&this._context.gl.uniform1iv(this._getUniformLocation(e),t)}setUniform2iv(e,t,i){Ss(i,t),kn(this._nameToUniform2,e,t)&&this._context.gl.uniform2iv(this._getUniformLocation(e),t)}setUniform3iv(e,t,i){Ss(i,t),kn(this._nameToUniform3,e,t)&&this._context.gl.uniform3iv(this._getUniformLocation(e),t)}setUniform4iv(e,t,i){Ss(i,t),kn(this._nameToUniform4,e,t)&&this._context.gl.uniform4iv(this._getUniformLocation(e),t)}setUniform1f(e,t,i){rd(i,t);const r=this._nameToUniform1.get(e);r!==void 0&&t===r||(this._context.gl.uniform1f(this._getUniformLocation(e),t),this._nameToUniform1.set(e,t))}setUniform1fv(e,t,i){Ss(i,t),kn(this._nameToUniform1v,e,t)&&this._context.gl.uniform1fv(this._getUniformLocation(e),t)}setUniform2f(e,t,i,r){rd(r,t,i);const s=this._nameToUniform2.get(e);s===void 0?(this._context.gl.uniform2f(this._getUniformLocation(e),t,i),this._nameToUniform2.set(e,[t,i])):t===s[0]&&i===s[1]||(this._context.gl.uniform2f(this._getUniformLocation(e),t,i),s[0]=t,s[1]=i)}setUniform2fv(e,t,i){Ss(i,t),kn(this._nameToUniform2,e,t)&&this._context.gl.uniform2fv(this._getUniformLocation(e),t)}setUniform3f(e,t,i,r,s){rd(s,t,i,r);const n=this._nameToUniform3.get(e);n===void 0?(this._context.gl.uniform3f(this._getUniformLocation(e),t,i,r),this._nameToUniform3.set(e,[t,i,r])):t===n[0]&&i===n[1]&&r===n[2]||(this._context.gl.uniform3f(this._getUniformLocation(e),t,i,r),n[0]=t,n[1]=i,n[2]=r)}setUniform3fv(e,t,i){Ss(i,t);const r=this._getUniformLocation(e);r!=null&&kn(this._nameToUniform3,e,t)&&this._context.gl.uniform3fv(r,t)}setUniform4f(e,t,i,r,s,n){rd(n,t,i,r,s);const a=this._nameToUniform4.get(e);a===void 0?(this._context.gl.uniform4f(this._getUniformLocation(e),t,i,r,s),this._nameToUniform4.set(e,[t,i,r,s])):a!==void 0&&t===a[0]&&i===a[1]&&r===a[2]&&s===a[3]||(this._context.gl.uniform4f(this._getUniformLocation(e),t,i,r,s),a[0]=t,a[1]=i,a[2]=r,a[3]=s)}setUniform4fv(e,t,i){Ss(i,t);const r=this._getUniformLocation(e);r!=null&&kn(this._nameToUniform4,e,t)&&this._context.gl.uniform4fv(r,t)}setUniformMatrix3fv(e,t,i=!1,r){Ss(r,t);const s=this._getUniformLocation(e);s!=null&&kn(this._nameToUniformMatrix3,e,t)&&this._context.gl.uniformMatrix3fv(s,i,t)}setUniformMatrix4fv(e,t,i=!1,r){Ss(r,t);const s=this._getUniformLocation(e);if(s!=null){const n=this._nameToUniformMatrix4,a=n.get(e);let o=!1;if(a){const l=t.length;if(a.length!==l)n.set(e,Array.from(t)),o=!0;else for(let c=0;c<l;++c){const u=t[c];if(a[c]!==u){for(a[c]=u;c<l;++c)a[c]=t[c];o=!0;break}}}else n.set(e,Array.from(t)),o=!0;o&&this._context.gl.uniformMatrix4fv(s,i,t)}}setUniformMatrices4fv(e,t,i=!1,r){Ss(r,t);const s=this._getUniformLocation(e);s!=null&&kn(this._nameToUniformMatrix4,e,t)&&this._context.gl.uniformMatrix4fv(s,i,t)}stop(){}};function vP(e,t,i){const r=e.gl,s=r.createShader(t);return r.shaderSource(s,i),r.compileShader(s),Mv()&&!r.getShaderParameter(s,r.COMPILE_STATUS)&&(console.error("Compile error in ".concat(t===35633?"vertex":"fragment"," shader")),console.error(r.getShaderInfoLog(s)),console.error(SK(i))),s}function SK(e){let t=2;return e.replaceAll(`
`,()=>`
`+TK(t++)+":")}function TK(e){return e>=1e3?e.toString():("  "+e).slice(-3)}function kn(e,t,i){const r=e.get(t);if(!r)return e.set(t,Array.from(i)),!0;const s=i.length;if(r.length!==s)return e.set(t,Array.from(i)),!0;for(let n=0;n<s;++n){const a=i[n];if(r[n]!==a){for(r[n]=a;n<s;++n)r[n]=i[n];return!0}}return!1}const rd=hn()?(e,...t)=>Ss(e,t):()=>{},Ss=hn()?(e,t)=>{if(e?.supportsNaN)return;const i=t.length;for(let r=0;r<i;++r){const s=t[r];Number.isNaN(s)&&console.error(`Got ${s} as uniform value from ${new Error().stack}`)}}:()=>{};let PK=class{constructor(e){this._rctx=e,this._store=new Map}dispose(){this._store.forEach(e=>e.dispose()),this._store.clear()}acquire(e,t,i,r){const s=e+t+JSON.stringify(Array.from(i.entries())),n=this._store.get(s);if(n!=null)return n.ref(),n;const a=new CK(this._rctx,e,t,i,r);return a.ref(),this._store.set(s,a),a}get test(){}},Cw=class{constructor(){this._result=!1}dispose(){this._program=ye(this._program)}get result(){return this._program!=null&&(this._result=this._test(this._program),this.dispose()),this._result}},MK=class extends Cw{constructor(e){super(),this._rctx=e,this._helperProgram=null,Qe("mac")&&Qe("chrome")&&(this._program=this._prepareProgram(),this._helperProgram=this._prepareHelperProgram())}dispose(){super.dispose(),this._helperProgram?.dispose(),this._helperProgram=null}_test(e){const t=this._rctx,i=t.getBoundFramebufferObject(),{x:r,y:s,width:n,height:a}=t.getViewport();t.resetState();const o=new gt(1);o.wrapMode=33071,o.samplingMode=9728;const l=new Wo(t,o),c=Hs.createIndex(this._rctx,35044,new Uint8Array([0]));t.bindFramebuffer(l),t.setViewport(0,0,1,1),t.useProgram(this._helperProgram),t.bindBuffer(c,34963),t.drawElements(St.POINTS,1,Tn.UNSIGNED_BYTE,0),t.useProgram(e),t.bindVAO(null),t.drawArrays(St.TRIANGLES,0,258);const u=new Uint8Array(4);return l.readPixels(0,0,1,1,6408,ni.UNSIGNED_BYTE,u),t.setViewport(r,s,n,a),t.bindFramebuffer(i),l.dispose(),c.dispose(),u[0]===255}_prepareProgram(){const e=`#version 300 es
    precision highp float;

    out float triangleId;

    const vec3 triangleVertices[3] = vec3[3](vec3(-0.5, -0.5, 0.0), vec3(0.5, -0.5, 0.0), vec3(0.0, 0.5, 0.0));

    void main(void) {
      triangleId = floor(float(gl_VertexID)/3.0);

      vec3 position = triangleVertices[gl_VertexID % 3];
      float offset = triangleId / ${_.float(85)};
      position.z = 0.5 - offset;

      gl_Position = vec4(position, 1.0);
    }
    `,t=`#version 300 es
    precision highp float;

    in float triangleId;

    out vec4 fragColor;

    void main(void) {
      fragColor = triangleId == ${_.float(85)} ? vec4(0.0, 1.0, 0.0, 1.0) : vec4(1.0, 0.0, 0.0, 1.0);
    }
    `;return this._rctx.programCache.acquire(e,t,new Map([]))}_prepareHelperProgram(){const e=I5.getShaderSources();return this._rctx.programCache.acquire(e.vertex,e.fragment,new Map([]))}};const Sw=[new gL("position",2,Tn.UNSIGNED_SHORT,0,4)],V5=Ja(Sw);let RK=class extends Cw{constructor(e){if(super(),this._rctx=e,!e.gl||!(e.capabilities.colorBufferFloat?.textureFloat&&e.capabilities.colorBufferFloat?.floatBlend))return;const t=`
    precision highp float;
    attribute vec2 position;

    void main() {
      gl_Position = vec4(position * 2.0 - 1.0, 0.0, 1.0);
    }
    `,i=`
     precision highp float;

     void main() {
      gl_FragColor = vec4(0.5, 0.5, 0.5, 0.5);
     }
    `;this._program=e.programCache.acquire(t,i,V5)}_test(e){const t=this._rctx,i=new gt(1);i.wrapMode=33071,i.dataType=ni.FLOAT,i.internalFormat=Lr.RGBA32F,i.samplingMode=9728;const r=new Wo(t,i),s=new ei(t,Sw,new Uint16Array([0,0,1,0,0,1,1,1])),n=new Qa(t,s);t.gl.getError(),t.useProgram(e);const a=t.getBoundFramebufferObject(),{x:o,y:l,width:c,height:u}=t.getViewport();t.bindFramebuffer(r),t.setViewport(0,0,1,1),t.bindVAO(n),t.drawArrays(St.TRIANGLE_STRIP,0,4);const p=Ge({blending:W8});t.setPipelineState(p),t.drawArrays(St.TRIANGLE_STRIP,0,4);const m=t.gl.getError();return t.setViewport(o,l,c,u),t.bindFramebuffer(a),n.dispose(),r.dispose(),m!==t.gl.INVALID_OPERATION||(console.warn("Device claims support for WebGL extension EXT_float_blend but does not support it. Using fall back."),!1)}},DK=class extends Cw{constructor(e){super(),this._rctx=e;const t=`
    precision highp float;

    attribute vec2 position;
    varying vec2 v_uv;

    void main() {
      v_uv = position;
      gl_Position = vec4(position * 2.0 - 1.0, 0.0, 1.0);
    }
    `,i=`
    precision highp float;

    varying vec2 v_uv;

    uniform sampler2D u_texture;

    void main() {
      gl_FragColor = texture2D(u_texture, v_uv);
    }
    `;this._program=e.programCache.acquire(t,i,V5)}dispose(){super.dispose()}_test(e){const t=this._rctx;if(!t.gl)return e.dispose(),!0;const i=new gt(1);i.wrapMode=33071,i.samplingMode=9728;const r=new Wo(t,i),s=new ei(t,Sw,new Uint16Array([0,0,1,0,0,1,1,1])),n=new Qa(t,s),a=new gt;a.samplingMode=9729,a.wrapMode=33071;const o=new bt(t,a,Nd);t.useProgram(e),t.bindTexture(o,0),e.setUniform1i("u_texture",0);const l=t.getBoundFramebufferObject(),{x:c,y:u,width:p,height:m}=t.getViewport();t.bindFramebuffer(r),t.setViewport(0,0,1,1),t.setClearColor(0,0,0,0),t.setBlendingEnabled(!1),t.clear(16384),t.bindVAO(n),t.drawArrays(St.TRIANGLE_STRIP,0,4);const f=new Uint8Array(4);return r.readPixels(0,0,1,1,6408,ni.UNSIGNED_BYTE,f),n.dispose(),r.dispose(),o.dispose(),t.setViewport(c,u,p,m),t.bindFramebuffer(l),f[0]!==255}};const Nd=new Image;Nd.src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='5' height='5' version='1.1' viewBox='0 0 5 5' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='5' height='5' fill='%23f00' fill-opacity='.5'/%3E%3C/svg%3E%0A",Nd.width=5,Nd.height=5,Nd.decode();let OK=class{constructor(e){this.rctx=e,this.floatBufferBlend=new RK(e),this.svgPremultipliesAlpha=new DK(e),this.drawArraysRequiresIndicesTypeReset=new MK(e)}dispose(){this.svgPremultipliesAlpha.dispose(),this.floatBufferBlend.dispose(),this.drawArraysRequiresIndicesTypeReset.dispose()}};function EK(e,t){if(t.compressedTextureETC)return null;const i=e.getExtension("WEBGL_compressed_texture_etc");return i?{COMPRESSED_R11_EAC:i.COMPRESSED_R11_EAC,COMPRESSED_SIGNED_R11_EAC:i.COMPRESSED_SIGNED_R11_EAC,COMPRESSED_RG11_EAC:i.COMPRESSED_RG11_EAC,COMPRESSED_SIGNED_RG11_EAC:i.COMPRESSED_SIGNED_RG11_EAC,COMPRESSED_RGB8_ETC2:i.COMPRESSED_RGB8_ETC2,COMPRESSED_SRGB8_ETC2:i.COMPRESSED_SRGB8_ETC2,COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:i.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:i.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_RGBA8_ETC2_EAC:i.COMPRESSED_RGBA8_ETC2_EAC,COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:i.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC}:null}function AK(e,t){if(t.compressedTextureS3TC)return null;const i=e.getExtension("WEBGL_compressed_texture_s3tc");return i?{COMPRESSED_RGB_S3TC_DXT1:i.COMPRESSED_RGB_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT1:i.COMPRESSED_RGBA_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT3:i.COMPRESSED_RGBA_S3TC_DXT3_EXT,COMPRESSED_RGBA_S3TC_DXT5:i.COMPRESSED_RGBA_S3TC_DXT5_EXT}:null}function IK(e,t){if(t.textureFilterAnisotropic)return null;const i=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");return i?{MAX_TEXTURE_MAX_ANISOTROPY:i.MAX_TEXTURE_MAX_ANISOTROPY_EXT,TEXTURE_MAX_ANISOTROPY:i.TEXTURE_MAX_ANISOTROPY_EXT}:null}function LK(e,t){const i=!t.colorBufferHalfFloat&&e.getExtension("EXT_color_buffer_half_float")||!t.colorBufferFloat&&e.getExtension("EXT_color_buffer_float"),r=!t.colorBufferFloat&&e.getExtension("EXT_color_buffer_float"),s=!t.floatBlend&&!t.colorBufferFloat&&e.getExtension("EXT_float_blend");return i||r||s?{textureFloat:!!r,textureHalfFloat:!!i,floatBlend:!!s,R16F:e.R16F,RG16F:e.RG16F,RGBA16F:e.RGBA16F,R32F:e.R32F,RG32F:e.RG32F,RGBA32F:e.RGBA32F,R11F_G11F_B10F:e.R11F_G11F_B10F,RGB16F:e.RGB16F}:null}function bP(e,t,i,r,s){if(t[i])return!1;for(const n of s)if(e.getExtension(n))return!0;return!1}function FK(e,t){if(t.textureNorm16)return null;const i=e.getExtension("EXT_texture_norm16");return i?{R16:i.R16_EXT,RG16:i.RG16_EXT,RGB16:i.RGB16_EXT,RGBA16:i.RGBA16_EXT,R16_SNORM:i.R16_SNORM_EXT,RG16_SNORM:i.RG16_SNORM_EXT,RGB16_SNORM:i.RGB16_SNORM_EXT,RGBA16_SNORM:i.RGBA16_SNORM_EXT}:null}function VK(e,t){const i=t.loseContext&&e.getExtension("WEBGL_lose_context");return i?{loseRenderingContext:()=>i.loseContext()}:null}let zK=class{constructor(e,t){this._gl=e,this._compressedTextureETC=null,this._compressedTextureS3TC=null,this._textureFilterAnisotropic=null,this._colorBufferFloat=null,this._loseContext=null,this._textureNorm16=null,this._textureFloatLinear=null,this._parallelShaderCompile=null,this._rendererInfo=null,this._disabledExtensions=t.disabledExtensions,this._debugWebGLExtensions=t.debugWebGLExtensions}get compressedTextureETC(){return this._compressedTextureETC??=EK(this._gl,this._disabledExtensions),this._compressedTextureETC}get compressedTextureS3TC(){return this._compressedTextureS3TC??=AK(this._gl,this._disabledExtensions),this._compressedTextureS3TC}get textureFilterAnisotropic(){return this._textureFilterAnisotropic??=IK(this._gl,this._disabledExtensions),this._textureFilterAnisotropic}get disjointTimerQuery(){return this._disjointTimerQuery??=GY(this._gl,this._disabledExtensions),this._disjointTimerQuery}get colorBufferFloat(){return this._colorBufferFloat??=LK(this._gl,this._disabledExtensions),this._colorBufferFloat}get textureNorm16(){return this._textureNorm16??=FK(this._gl,this._disabledExtensions),this._textureNorm16}get textureFloatLinear(){return this._textureFloatLinear??=bP(this._gl,this._disabledExtensions,"textureFloatLinear",!1,["OES_texture_float_linear"]),this._textureFloatLinear}get parallelShaderCompile(){return this._parallelShaderCompile??=bP(this._gl,this._disabledExtensions,"parallelShaderCompile",!1,["KHR_parallel_shader_compile"]),this._parallelShaderCompile}get loseContext(){return this._loseContext??=VK(this._gl,this._debugWebGLExtensions),this._loseContext}get rendererInfo(){return this._rendererInfo??=WF(this._gl),this._rendererInfo}enable(e){return this[e]}},kK=class{constructor(e,t){this.gl=e,this.instanceCounter=new iK,this._programCache=new PK(this),this._transformFeedbackRequestInfo=null,this._state=new cP,this._numOfDrawCalls=0,this._numOfTriangles=0,this._options=t,this.configure(t)}configure(e){this._options=e,this._capabilities=new zK(this.gl,e),this._parameters=new hP(this.gl,this._capabilities,e),bt.TEXTURE_UNIT_FOR_UPDATES=this._parameters.maxTextureImageUnits-1;const t=this.gl.getParameter(this.gl.VIEWPORT);this._state=new cP,this._state.viewport={x:t[0],y:t[1],width:t[2],height:t[3]},this._stateTracker=new A8({setBlending:i=>{if(i){this.setBlendingEnabled(!0),this.setBlendEquationSeparate(i.opRgb,i.opAlpha),this.setBlendFunctionSeparate(i.srcRgb,i.dstRgb,i.srcAlpha,i.dstAlpha);const r=i.color;this.setBlendColor(r.r,r.g,r.b,r.a)}else this.setBlendingEnabled(!1)},setCulling:i=>{i?(this.setFaceCullingEnabled(!0),this.setCullFace(i.face),this.setFrontFace(i.mode)):this.setFaceCullingEnabled(!1)},setPolygonOffset:i=>{i?(this.setPolygonOffsetFillEnabled(!0),this.setPolygonOffset(i.factor,i.units)):this.setPolygonOffsetFillEnabled(!1)},setDepthTest:i=>{i?(this.setDepthTestEnabled(!0),this.setDepthFunction(i.func)):this.setDepthTestEnabled(!1)},setStencilTest:i=>{if(i){this.setStencilTestEnabled(!0);const r=i.function;this.setStencilFunction(r.func,r.ref,r.mask);const s=i.operation;this.setStencilOp(s.fail,s.zFail,s.zPass)}else this.setStencilTestEnabled(!1)},setDepthWrite:i=>{i?(this.setDepthWriteEnabled(!0),this.setDepthRange(i.zNear,i.zFar)):this.setDepthWriteEnabled(!1)},setColorWrite:i=>{i?this.setColorMask(i.r,i.g,i.b,i.a):this.setColorMask(!1,!1,!1,!1)},setStencilWrite:i=>{i?this.setStencilWriteMask(i.mask):this.setStencilWriteMask(0)},setDrawBuffers:i=>{if(i)this.setDrawBuffers(i.buffers);else{const{drawFramebuffer:r}=this._state;r===null?this.setDrawBuffers([rh]):r.colorAttachments.length===0?this.setDrawBuffers([Vv]):this.setDrawBuffers([Et])}}}),this.enforceState(),ye(this._driverTest),this._driverTest=new OK(this)}updateOptions(e){this._options={...this._options,...e},this._parameters=new hP(this.gl,this._capabilities,this._options)}dispose(){this._driverTest=ye(this._driverTest),this._programCache=ye(this._programCache),this.bindVAO(null),this.unbindBuffer(34962),this.unbindBuffer(34963),this.unbindBuffer(35345),this._state.uniformBufferBindingPoints.length=0,this.unbindBuffer(35051),this.unbindBuffer(35052),this.unbindBuffer(36662),this.unbindBuffer(36663),this._state.textureUnitMap.length=0,this._state=null,this._capabilities=null,this._stateTracker=null,hn()&&console.log(this.instanceCounter.resourceInformation)}get driverTest(){return this._driverTest}get contextAttributes(){return this.gl.getContextAttributes()}get parameters(){return this._parameters}get programCache(){return this._programCache}setPipelineState(e){this._stateTracker.setPipeline(e)}setBlendingEnabled(e){this._state.blend!==e&&(e===!0?this.gl.enable(this.gl.BLEND):this.gl.disable(this.gl.BLEND),this._state.blend=e,this._stateTracker.invalidateBlending())}externalProgramUpdate(){this._state.program?.stop(),this._state.program=null}externalTextureUnitUpdate(e,t){for(let i=0;i<e.length;++i)this._state.textureUnitMap[e[i]]=null;t>=0&&(this._state.activeTexture=t)}externalVertexArrayObjectUpdate(){this.gl.bindVertexArray(null),this._state.vertexArrayObject=null,this._state.vertexBuffer=null,this._state.indexBuffer=null}externalVertexBufferUpdate(){this._state.vertexBuffer=null}externalIndexBufferUpdate(){this._state.indexBuffer=null}setBlendColor(e,t,i,r){e===this._state.blendColor.r&&t===this._state.blendColor.g&&i===this._state.blendColor.b&&r===this._state.blendColor.a||(this.gl.blendColor(e,t,i,r),this._state.blendColor.r=e,this._state.blendColor.g=t,this._state.blendColor.b=i,this._state.blendColor.a=r,this._stateTracker.invalidateBlending())}setBlendFunction(e,t){e===this._state.blendFunction.srcRGB&&t===this._state.blendFunction.dstRGB||(this.gl.blendFunc(e,t),this._state.blendFunction.srcRGB=e,this._state.blendFunction.srcAlpha=e,this._state.blendFunction.dstRGB=t,this._state.blendFunction.dstAlpha=t,this._stateTracker.invalidateBlending())}setBlendFunctionSeparate(e,t,i,r){this._state.blendFunction.srcRGB===e&&this._state.blendFunction.srcAlpha===i&&this._state.blendFunction.dstRGB===t&&this._state.blendFunction.dstAlpha===r||(this.gl.blendFuncSeparate(e,t,i,r),this._state.blendFunction.srcRGB=e,this._state.blendFunction.srcAlpha=i,this._state.blendFunction.dstRGB=t,this._state.blendFunction.dstAlpha=r,this._stateTracker.invalidateBlending())}setBlendEquation(e){this._state.blendEquation.mode!==e&&(this.gl.blendEquation(e),this._state.blendEquation.mode=e,this._state.blendEquation.modeAlpha=e,this._stateTracker.invalidateBlending())}setBlendEquationSeparate(e,t){this._state.blendEquation.mode===e&&this._state.blendEquation.modeAlpha===t||(this.gl.blendEquationSeparate(e,t),this._state.blendEquation.mode=e,this._state.blendEquation.modeAlpha=t,this._stateTracker.invalidateBlending())}setColorMask(e,t,i,r){this._state.colorMask.r===e&&this._state.colorMask.g===t&&this._state.colorMask.b===i&&this._state.colorMask.a===r||(this.gl.colorMask(e,t,i,r),this._state.colorMask.r=e,this._state.colorMask.g=t,this._state.colorMask.b=i,this._state.colorMask.a=r,this._stateTracker.invalidateColorWrite())}setClearColor(e,t,i,r){this._state.clearColor.r===e&&this._state.clearColor.g===t&&this._state.clearColor.b===i&&this._state.clearColor.a===r||(this.gl.clearColor(e,t,i,r),this._state.clearColor.r=e,this._state.clearColor.g=t,this._state.clearColor.b=i,this._state.clearColor.a=r)}setFaceCullingEnabled(e){this._state.faceCulling!==e&&(e===!0?this.gl.enable(this.gl.CULL_FACE):this.gl.disable(this.gl.CULL_FACE),this._state.faceCulling=e,this._stateTracker.invalidateCulling())}setPolygonOffsetFillEnabled(e){this._state.polygonOffsetFill!==e&&(e===!0?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL),this._state.polygonOffsetFill=e,this._stateTracker.invalidatePolygonOffset())}setPolygonOffset(e,t){this._state.polygonOffset[0]===e&&this._state.polygonOffset[1]===t||(this._state.polygonOffset[0]=e,this._state.polygonOffset[1]=t,this.gl.polygonOffset(e,t),this._stateTracker.invalidatePolygonOffset())}setCullFace(e){this._state.cullFace!==e&&(this.gl.cullFace(e),this._state.cullFace=e,this._stateTracker.invalidateCulling())}setFrontFace(e){this._state.frontFace!==e&&(this.gl.frontFace(e),this._state.frontFace=e,this._stateTracker.invalidateCulling())}setScissorTestEnabled(e){this._state.scissorTest!==e&&(e===!0?this.gl.enable(this.gl.SCISSOR_TEST):this.gl.disable(this.gl.SCISSOR_TEST),this._state.scissorTest=e)}setScissorRect(e,t,i,r){this._state.scissorRect.x===e&&this._state.scissorRect.y===t&&this._state.scissorRect.width===i&&this._state.scissorRect.height===r||(this.gl.scissor(e,t,i,r),this._state.scissorRect.x=e,this._state.scissorRect.y=t,this._state.scissorRect.width=i,this._state.scissorRect.height=r)}setDepthTestEnabled(e){this._state.depthTest!==e&&(e===!0?this.gl.enable(this.gl.DEPTH_TEST):this.gl.disable(this.gl.DEPTH_TEST),this._state.depthTest=e,this._stateTracker.invalidateDepthTest())}setClearDepth(e){this._state.clearDepth!==e&&(this.gl.clearDepth(e),this._state.clearDepth=e)}setDepthFunction(e){this._state.depthFunction!==e&&(this.gl.depthFunc(e),this._state.depthFunction=e,this._stateTracker.invalidateDepthTest())}setDepthWriteEnabled(e){this._state.depthWrite!==e&&(this.gl.depthMask(e),this._state.depthWrite=e,this._stateTracker.invalidateDepthWrite())}setDepthRange(e,t){this._state.depthRange.zNear===e&&this._state.depthRange.zFar===t||(this.gl.depthRange(e,t),this._state.depthRange.zNear=e,this._state.depthRange.zFar=t,this._stateTracker.invalidateDepthWrite())}setStencilTestEnabled(e){this._state.stencilTest!==e&&(e===!0?this.gl.enable(this.gl.STENCIL_TEST):this.gl.disable(this.gl.STENCIL_TEST),this._state.stencilTest=e,this._stateTracker.invalidateStencilTest())}setClearStencil(e){e!==this._state.clearStencil&&(this.gl.clearStencil(e),this._state.clearStencil=e)}setStencilFunction(e,t,i){this._state.stencilFunction.func===e&&this._state.stencilFunction.ref===t&&this._state.stencilFunction.mask===i||(this.gl.stencilFunc(e,t,i),this._state.stencilFunction.face=1032,this._state.stencilFunction.func=e,this._state.stencilFunction.ref=t,this._state.stencilFunction.mask=i,this._stateTracker.invalidateStencilTest())}setStencilFunctionSeparate(e,t,i,r){this._state.stencilFunction.face===e&&this._state.stencilFunction.func===t&&this._state.stencilFunction.ref===i&&this._state.stencilFunction.mask===r||(this.gl.stencilFuncSeparate(e,t,i,r),this._state.stencilFunction.face=e,this._state.stencilFunction.func=t,this._state.stencilFunction.ref=i,this._state.stencilFunction.mask=r,this._stateTracker.invalidateStencilTest())}setStencilWriteMask(e){this._state.stencilWriteMask!==e&&(this.gl.stencilMask(e),this._state.stencilWriteMask=e,this._stateTracker.invalidateStencilWrite())}setStencilOp(e,t,i){this._state.stencilOperation.face===1032&&this._state.stencilOperation.fail===e&&this._state.stencilOperation.zFail===t&&this._state.stencilOperation.zPass===i||(this.gl.stencilOp(e,t,i),this._state.stencilOperation.face=1032,this._state.stencilOperation.fail=e,this._state.stencilOperation.zFail=t,this._state.stencilOperation.zPass=i,this._stateTracker.invalidateStencilTest())}setStencilOpSeparate(e,t,i,r){this._state.stencilOperation.face===e&&this._state.stencilOperation.fail===t&&this._state.stencilOperation.zFail===i&&this._state.stencilOperation.zPass===r||(this.gl.stencilOpSeparate(e,t,i,r),this._state.stencilOperation.face=e,this._state.stencilOperation.fail=t,this._state.stencilOperation.zFail=i,this._state.stencilOperation.zPass=r,this._stateTracker.invalidateStencilTest())}setActiveTexture(e,t=!1){const i=this._state.activeTexture;return e>=0&&(t||e!==this._state.activeTexture)&&(this.gl.activeTexture(_y+e),this._state.activeTexture=e),i}setDrawBuffers(e){const{drawFramebuffer:t}=this._state,i=t===null,r=i?this._state.drawBuffers.defaultFramebuffer:this._state.drawBuffers.fbos.get(t);if(r?.length!==e.length||!r.every((s,n)=>s===e[n]))if(e.length>this.parameters.maxDrawBuffers)console.error("Setting more active draw buffers than GL.MAX_DRAW_BUFFERS allows.");else{if(i){if(e.length>1)return void console.error("The default framebuffer can only have one active draw buffer.");if(e[0]!==rh&&e[0]!==Vv)return void console.error("The default framebuffer can only use the constants GL.BACK or GL.NONE as draw buffers.")}i||!e.includes(rh)?(this.gl.drawBuffers(e),i?this._state.drawBuffers.defaultFramebuffer=e:this._state.drawBuffers.fbos.set(t,e),this._stateTracker.invalidateDrawBuffers()):console.error("A framebuffer object can only use the constants GL.COLOR_ATTACHMENTi or GL.NONE as draw buffers.")}}clear(e,t=255){if(e){if(16384&e){const i=this._state.drawFramebuffer?.colorAttachments;i&&this.setDrawBuffers(i),this.setColorMask(!0,!0,!0,!0)}256&e&&this.setDepthWriteEnabled(!0),1024&e&&this.setStencilWriteMask(t),this.gl.clear(e)}}clearFramebuffer(e,t=!1,i=!1){let r=0;if(e){const s=Math.max(1e-13,e[3]);this.setClearColor(e[0],e[1],e[2],s),r|=16384}t&&(r|=256),i===!1?i=0:(i===!0&&(i=255),r|=1024),r&&this.clear(r,i)}clearBuffer(e,t,i=6144,r=void 0){this.gl.clearBufferfv(i,e,t,r)}clearBufferInteger(e,t,i=6144,r=void 0){this.gl.clearBufferiv(i,e,t,r)}clearBufferUnsignedInteger(e,t,i=6144,r=void 0){this.gl.clearBufferuiv(i,e,t,r)}drawArrays(e,t,i){if(this._transformFeedbackRequestInfo){if(e!==this._transformFeedbackRequestInfo.primitiveType)throw new Error("DrawArrays called during transform feedback, but primitiveType does not match that of the current transform feedback request");if(this._state.program?.hasTransformFeedbackVaryings==null)throw new Error("DrawArrays called during transform feedback, but the shader program was not linked with a transform feedback varying")}if(hn()&&(this._numOfDrawCalls++,this._numOfTriangles+=wP(e,i),Qe("enable-feature:webgl-debug:textureReadWrite"))){const r=this._state.textureUnitMap;for(let s=0;s<r.length;s++){const n=r[s];if(n!=null&&n===this._state.drawFramebuffer?.colorTexture)throw new Error(`Detected readWrite. Texture already bound at index ${s}`)}}this.gl.drawArrays(e,t,i),Cf(this.gl)}drawArraysInstanced(e,t,i,r){this.gl.drawArraysInstanced(e,t,i,r),Cf(this.gl)}drawElements(e,t,i,r){if(this._transformFeedbackRequestInfo)throw new Error("Cannot called drawElements during a transform feedback request");if(hn()&&(this._numOfDrawCalls++,this._numOfTriangles+=wP(e,t)),this.gl.drawElements(e,t,i,r),hn()){const s=I8(this.gl);if(s){const n=this.getBoundVAO(),a=n?.indexBuffer,o=n?.buffers,l={indexBuffer:a,vertexBuffers:o},c={mode:e,count:t,type:i,offset:r},u=a?.size??0,p=r+t,m=u<p?`. Buffer is too small. Attempted to draw index ${p} of ${u}`:"";console.error(`drawElements: ${s}${m}`,{args:c,vao:l})}}}drawElementsInstanced(e,t,i,r,s){this.gl.drawElementsInstanced(e,t,i,r,s),Cf(this.gl)}logInfo(){hn()&&console.log(`DrawCalls: ${this._numOfDrawCalls}, Triangles: ${this._numOfTriangles}`)}resetInfo(){hn()&&(this._numOfDrawCalls=0,this._numOfTriangles=0)}get capabilities(){return this._capabilities}setViewport(e,t,i,r){i=Math.max(Math.round(i),1),r=Math.max(Math.round(r),1);const s=this._state.viewport;s.x===e&&s.y===t&&s.width===i&&s.height===r||(s.x=e,s.y=t,s.width=i,s.height=r,this.gl.viewport(e,t,i,r))}setViewport4fv(e){this.setViewport(e[0],e[1],e[2],e[3])}restoreViewport({x:e,y:t,width:i,height:r}){this.setViewport(e,t,i,r)}getViewport(){const e=this._state.viewport;return{x:e.x,y:e.y,width:e.width,height:e.height}}useProgram(e){this._state.program!==e&&(this._state.program?.stop(),this._state.program=e,this.gl.useProgram(e?.glName??null))}bindTexture(e,t,i=!1){(t>=this.parameters.maxTextureImageUnits||t<0)&&console.error("Input texture unit is out of range of available units!");const r=this._state.textureUnitMap[t];return e?.glName==null?(r!=null&&(this.setActiveTexture(t,i),this.gl.bindTexture(r.descriptor.target,null)),this._state.textureUnitMap[t]=null,r):i||r!==e?(this.setActiveTexture(t,i),this.gl.bindTexture(e.descriptor.target,e.glName),e.applyChanges(),this._state.textureUnitMap[t]=e,r):(e.isDirty&&(this.setActiveTexture(t,i),e.applyChanges()),r)}unbindTexture(e){if(e!=null)for(let t=0;t<this.parameters.maxTextureImageUnits;t++)this._state.textureUnitMap[t]===e&&(this.bindTexture(null,t),this._state.textureUnitMap[t]=null)}bindFramebuffer(e,t=!1){if(t||this._state.readFramebuffer!==e||this._state.drawFramebuffer!==e){if(this._stateTracker.invalidateDrawBuffers(),e==null)return this.gl.bindFramebuffer(36160,null),void(this._state.readFramebuffer=this._state.drawFramebuffer=null);e.initializeAndBind(36160),this._state.readFramebuffer=e,this._state.drawFramebuffer=e}}bindFramebufferSeparate(e,t,i=!1){const r=t===36008,s=r?this._state.readFramebuffer:this._state.drawFramebuffer;(i||s!==e)&&(e==null?this.gl.bindFramebuffer(t,null):e.initializeAndBind(t),r?this._state.readFramebuffer=e??null:(this._stateTracker.invalidateDrawBuffers(),this._state.drawFramebuffer=e??null))}blitFramebuffer(e,t,i=16384,r=9728,s=0,n=0,a=e.width,o=e.height,l=0,c=0,u=t.width,p=t.height){this.bindFramebufferSeparate(e,36008,!0),this.bindFramebufferSeparate(t,36009,!0),this.gl.blitFramebuffer(s,n,a,o,l,c,u,p,i,r)}bindBuffer(e,t){if(e)switch(t??=e.bufferType,t){case 34962:this._state.vertexBuffer=vr(this.gl,e,t,this._state.vertexBuffer);break;case 34963:this._state.indexBuffer=vr(this.gl,e,t,this._state.indexBuffer);break;case 35345:this._state.uniformBuffer=vr(this.gl,e,t,this._state.uniformBuffer);break;case 35051:this._state.pixelPackBuffer=vr(this.gl,e,t,this._state.pixelPackBuffer);break;case 35052:this._state.pixelUnpackBuffer=vr(this.gl,e,t,this._state.pixelUnpackBuffer);break;case 36662:this._state.copyReadBuffer=vr(this.gl,e,t,this._state.copyReadBuffer);break;case 36663:this._state.copyWriteBuffer=vr(this.gl,e,t,this._state.copyWriteBuffer);break;case 35982:this._state.transformFeedbackBuffer=vr(this.gl,e,t,this._state.transformFeedbackBuffer)}}bindRenderbuffer(e){const t=this.gl;e||(t.bindRenderbuffer(t.RENDERBUFFER,null),this._state.renderbuffer=null),this._state.renderbuffer!==e&&(t.bindRenderbuffer(t.RENDERBUFFER,e.glName),this._state.renderbuffer=e)}_getBufferBinding(e,t){if(t>=this.parameters.maxUniformBufferBindings||t<0)return console.error("Uniform buffer binding point is out of range!"),null;const i=e===35345?this._state.uniformBufferBindingPoints:this._state.transformBufferBindingPoints;let r=i[t];return r==null&&(r={buffer:null,offset:0,size:0},i[t]=r),r}bindBufferBase(e,t,i){const r=this._getBufferBinding(e,t);r!=null&&(r.buffer===i&&r.offset===0&&r.size===0||(this.gl.bindBufferBase(e,t,i?i.glName:null),r.buffer=i,r.offset=0,r.size=0))}bindBufferRange(e,t,i,r,s){const n=this._getBufferBinding(e,t);n!=null&&(n.buffer===i&&n.offset===r&&n.size===s||(r%this._parameters.uniformBufferOffsetAlignment===0?(this.gl.bindBufferRange(e,t,i.glName,r,s),n.buffer=i,n.offset=r,n.size=s):console.error("Uniform buffer binding offset is not a multiple of the context offset alignment")))}bindUBO(e,t,i,r){t!=null?(hn()&&(r??t.byteLength)>this._parameters.maxUniformBlockSize&&console.error("Attempting to bind more data than the maximum uniform block size"),t.initialize(),i!==void 0&&r!==void 0?this.bindBufferRange(35345,e,t.buffer,i,r):this.bindBufferBase(35345,e,t.buffer)):this.bindBufferBase(35345,e,null)}unbindUBO(e){for(let t=0,i=this._state.uniformBufferBindingPoints.length;t<i;t++){const r=this._state.uniformBufferBindingPoints[t];r!=null&&r.buffer===e.buffer&&this.bindBufferBase(35345,t,null)}}unbindBuffer(e){switch(e){case 34962:this._state.vertexBuffer=vr(this.gl,null,e,this._state.vertexBuffer);break;case 34963:this._state.indexBuffer=vr(this.gl,null,e,this._state.indexBuffer);break;case 35345:this._state.uniformBuffer=vr(this.gl,null,e,this._state.uniformBuffer);break;case 35051:this._state.pixelPackBuffer=vr(this.gl,null,e,this._state.pixelPackBuffer);break;case 35052:this._state.pixelUnpackBuffer=vr(this.gl,null,e,this._state.pixelUnpackBuffer);break;case 36662:this._state.copyReadBuffer=vr(this.gl,null,e,this._state.copyReadBuffer);break;case 36663:this._state.copyWriteBuffer=vr(this.gl,null,e,this._state.copyWriteBuffer)}}bindVAO(e,t){if(e==null)return this._state.vertexArrayObject?.unbind(),void(this._state.vertexArrayObject=null);this._state.vertexArrayObject!==e&&(e.bind(t),this._state.vertexArrayObject=e)}bindTransformFeedback(e){const{gl:t}=this;t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,e.glName)}beginTransformFeedback(e,t){if(this._transformFeedbackRequestInfo)throw new Error("Already in a transform feedback request");const{gl:i}=this;i.bindTransformFeedback(i.TRANSFORM_FEEDBACK,e.glName),i.beginTransformFeedback(t),this._transformFeedbackRequestInfo={primitiveType:t}}endTransformFeedback(){if(!this._transformFeedbackRequestInfo)throw new Error("Not in a transform feedback request");const{gl:e}=this;e.endTransformFeedback(),e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,null),this._transformFeedbackRequestInfo=null}async clientWaitAsync(e=Oe(10)){const{gl:t}=this,i=t.fenceSync(37143,0);if(!i)throw new Error("Client wait failed, could not create sync object");let r;this.instanceCounter.increment(yi.Sync,i),t.flush();do await NP(e),r=t.clientWaitSync(i,0,0);while(r===37147);if(this.instanceCounter.decrement(yi.Sync,i),t.deleteSync(i),r===37149)throw new Error("Client wait failed")}getBoundFramebufferObject(e=36160){return e===36008?this._state.readFramebuffer:this._state.drawFramebuffer}temporaryBindFramebufferObject(e,t,i=!1){const r=this.getBoundFramebufferObject();try{this.bindFramebuffer(e,i),t()}finally{this.bindFramebuffer(r,i)}}getBoundVAO(){return this._state.vertexArrayObject}resetState(){this.useProgram(null),this.bindVAO(null),this.bindFramebuffer(null,!0),this.unbindBuffer(34962),this.unbindBuffer(34963),this.unbindBuffer(35345),this._state.uniformBufferBindingPoints.length=0,this.unbindBuffer(35051),this.unbindBuffer(35052),this.unbindBuffer(36662),this.unbindBuffer(36663);for(let e=0;e<this.parameters.maxTextureImageUnits;++e)this.bindTexture(null,e);this.setBlendingEnabled(!1),this.setBlendFunction(1,0),this.setBlendEquation(32774),this.setBlendColor(0,0,0,0),this.setFaceCullingEnabled(!1),this.setCullFace(1029),this.setFrontFace(2305),this.setPolygonOffsetFillEnabled(!1),this.setPolygonOffset(0,0),this.setScissorTestEnabled(!1),this.setScissorRect(0,0,this.gl.canvas.width,this.gl.canvas.height),this.setDepthTestEnabled(!1),this.setDepthFunction(513),this.setDepthRange(0,1),this.setStencilTestEnabled(!1),this.setStencilFunction(519,0,0),this.setStencilOp(7680,7680,7680),this.setClearColor(0,0,0,0),this.setClearDepth(1),this.setClearStencil(0),this.setColorMask(!0,!0,!0,!0),this.setStencilWriteMask(4294967295),this.setDepthWriteEnabled(!0),this.setDrawBuffers([rh]),this.setViewport(0,0,this.gl.canvas.width,this.gl.canvas.height)}enforceState(){const{gl:e}=this;e.bindVertexArray(null);for(let i=0;i<this.parameters.maxVertexAttributes;i++)e.disableVertexAttribArray(i);this._state.vertexBuffer?e.bindBuffer(this._state.vertexBuffer.bufferType,this._state.vertexBuffer.glName):e.bindBuffer(34962,null),this._state.indexBuffer?e.bindBuffer(this._state.indexBuffer.bufferType,this._state.indexBuffer.glName):e.bindBuffer(34963,null),this._state.uniformBuffer?e.bindBuffer(this._state.uniformBuffer.bufferType,this._state.uniformBuffer.glName):e.bindBuffer(35345,null);for(let i=0;i<this._parameters.maxUniformBufferBindings;i++){const r=this._state.uniformBufferBindingPoints[i];if(r!=null){const{buffer:s,offset:n,size:a}=r;s!==null?n===0&&a===0?e.bindBufferBase(35345,i,s.glName):e.bindBufferRange(35345,i,s.glName,n,a):e.bindBufferBase(35345,i,null)}}if(this._state.pixelPackBuffer?e.bindBuffer(this._state.pixelPackBuffer.bufferType,this._state.pixelPackBuffer.glName):e.bindBuffer(35051,null),this._state.pixelUnpackBuffer?e.bindBuffer(this._state.pixelUnpackBuffer.bufferType,this._state.pixelUnpackBuffer.glName):e.bindBuffer(35052,null),this._state.copyReadBuffer?e.bindBuffer(this._state.copyReadBuffer.bufferType,this._state.copyReadBuffer.glName):e.bindBuffer(36662,null),this._state.copyWriteBuffer?e.bindBuffer(this._state.copyWriteBuffer.bufferType,this._state.copyWriteBuffer.glName):e.bindBuffer(36663,null),e.bindFramebuffer(36008,null),e.readBuffer(e.BACK),this._state.readFramebuffer&&(e.bindFramebuffer(36008,this._state.readFramebuffer.glName),e.readBuffer(Et)),e.bindFramebuffer(36009,this._state.drawFramebuffer?.glName??null),this._state.drawFramebuffer===null){const i=this._state.drawBuffers.defaultFramebuffer;e.drawBuffers(i??[rh])}else{const i=this._state.drawBuffers.fbos.get(this._state.drawFramebuffer);e.drawBuffers(i??[Et])}if(this._state.vertexArrayObject){const i=this._state.vertexArrayObject;this._state.vertexArrayObject&&(this._state.vertexArrayObject.unbind(),this._state.vertexArrayObject=null),this.bindVAO(i)}e.useProgram(this._state.program?.glName??null),e.blendColor(this._state.blendColor.r,this._state.blendColor.g,this._state.blendColor.b,this._state.blendColor.a),e.bindRenderbuffer(e.RENDERBUFFER,this._state.renderbuffer?.glName??null),this._state.blend===!0?e.enable(this.gl.BLEND):e.disable(this.gl.BLEND),e.blendEquationSeparate(this._state.blendEquation.mode,this._state.blendEquation.modeAlpha),e.blendFuncSeparate(this._state.blendFunction.srcRGB,this._state.blendFunction.dstRGB,this._state.blendFunction.srcAlpha,this._state.blendFunction.dstAlpha),e.clearColor(this._state.clearColor.r,this._state.clearColor.g,this._state.clearColor.b,this._state.clearColor.a),e.clearDepth(this._state.clearDepth),e.clearStencil(this._state.clearStencil),e.colorMask(this._state.colorMask.r,this._state.colorMask.g,this._state.colorMask.b,this._state.colorMask.a),e.cullFace(this._state.cullFace),e.depthFunc(this._state.depthFunction),e.depthRange(this._state.depthRange.zNear,this._state.depthRange.zFar),this._state.depthTest===!0?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),e.depthMask(this._state.depthWrite),e.frontFace(this._state.frontFace),e.lineWidth(1),this._state.faceCulling===!0?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),e.polygonOffset(this._state.polygonOffset[0],this._state.polygonOffset[1]),this._state.polygonOffsetFill===!0?e.enable(e.POLYGON_OFFSET_FILL):e.disable(e.POLYGON_OFFSET_FILL),e.scissor(this._state.scissorRect.x,this._state.scissorRect.y,this._state.scissorRect.width,this._state.scissorRect.height),this._state.scissorTest===!0?e.enable(e.SCISSOR_TEST):e.disable(e.SCISSOR_TEST),e.stencilFunc(this._state.stencilFunction.func,this._state.stencilFunction.ref,this._state.stencilFunction.mask),e.stencilOpSeparate(this._state.stencilOperation.face,this._state.stencilOperation.fail,this._state.stencilOperation.zFail,this._state.stencilOperation.zPass),this._state.stencilTest===!0?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),e.stencilMask(this._state.stencilWriteMask);for(let i=0;i<this.parameters.maxTextureImageUnits;i++){e.activeTexture(_y+i),e.bindTexture(3553,null),e.bindTexture(34067,null),e.bindTexture(32879,null),e.bindTexture(35866,null);const r=this._state.textureUnitMap[i];r!=null&&e.bindTexture(r.descriptor.target,r.glName)}e.activeTexture(_y+this._state.activeTexture);const t=this._state.viewport;e.viewport(t.x,t.y,t.width,t.height),this.resetInfo()}};function vr(e,t,i,r){return t?r!==t&&e.bindBuffer(i,t.glName):e.bindBuffer(i,null),t}function wP(e,t){switch(e){case St.POINTS:return 2*t;case St.TRIANGLES:return t/3;case St.TRIANGLE_STRIP:case St.TRIANGLE_FAN:return t-2;default:return 0}}let BK=class extends kK{constructor(e,t){super(e,t),this.emptyTexture=_E(this),this._vaoCaches=new Map,this._appleAmdDriverHelper=null,this._refCount=1,this._newCache=t.newCache,this._screen=new JY(this)}configure(e){super.configure(e),this._newCache=e.newCache}destroy(){this._vaoCaches.forEach(e=>e.dispose()),this._vaoCaches.clear(),--this._refCount>0||this.dispose()}ref(){++this._refCount}get refCount(){return this._refCount}dispose(){this.emptyTexture.dispose(),this._screen.destroy(),this._screen=null,super.dispose(),this._appleAmdDriverHelper?.dispose(),this._vaoCaches.forEach(e=>e.dispose()),this._vaoCaches.clear()}get newCache(){return this._newCache}get screen(){return this._screen}getVaoCache(e){const t=JSON.stringify(e),i=this._vaoCaches.get(t);if(i)return i;const r=new tK(this,e);return this._vaoCaches.set(t,r),r}bindTechnique(e,t,i,r){return this.useProgram(e.program),this.setPipelineState(e.getPipeline()),e.program.bind(t),i&&(e.program.bindPass(i,t),r&&e.program.bindDraw(t,i,r)),e.program}runAppleAmdDriverHelper(){this.driverTest.drawArraysRequiresIndicesTypeReset.result&&(this._appleAmdDriverHelper??=new I5(this),this._appleAmdDriverHelper.run())}get isAssumedMetalDriver(){if(this._isAssumedMetalDriver==null&&(this._isAssumedMetalDriver=!!Qe("ios")||!!Qe("safari"),!this._isAssumedMetalDriver&&Qe("mac")&&Qe("chrome"))){const e=this.capabilities.rendererInfo?.getUnmaskedRenderer().toLowerCase(),t=e?.includes("apple")&&e?.includes("angle")&&e?.includes("metal");this._isAssumedMetalDriver=t??!0}return this._isAssumedMetalDriver}get test(){}},NK=class{constructor(e={},t={},i=8,r=1/0){this.disabledExtensions=e,this.debugWebGLExtensions=t,this.maxAnisotropy=i,this.maxPreferredTexturePixels=r}},jK=class extends NK{constructor(e){super(e.options.deactivatedWebGLExtensions||{},e.options.debugWebGLExtensions||{},8,e.view.qualitySettings.maxTexturePixels),this.newCache=(t,i)=>e.view.resourceController.memoryController.newCache(t,i)}};function xP(e){return!!e.update}let UK=class{constructor(){this._updating=new Map}destroy(){this._updating.clear()}add(e){this._updating.set(e.id,new HK(e))}remove(e){this._updating.delete(e.id)}run(){let e=!1;return this._updating.forEach(t=>{const i=t.texture.update(t.previousToken);i>=0&&i!==t.previousToken&&(t.previousToken=i,e=!0)}),e}},HK=class{constructor(e){this.texture=e,this.previousToken=-1}},bh=class extends ie{constructor(e){super({}),this._stage=e,this._textures=new Map,this._loadingCount=0,this.events=new uc,this.updater=new UK,this._frameTask=e.view.resourceController.scheduler.registerTask(mi.TEXTURE_UNLOAD)}normalizeCtorArgs(){return{}}destroy(){this._frameTask.remove(),this.updater.destroy(),this._textures.forEach(e=>e.unload())}get updating(){return this._loadingCount>0||this._frameTask.updating}acquire(e){const t=this._textures.get(e);return t?(t.ref(),t.loadingPromise??t):this._createNewRef(e)}update(){this.updater.run()&&this.events.emit("changed",0)}_createNewRef(e){const t=this._stage.getTexture(e);if(t==null)return null;const i=t.events.on("unloaded",()=>{i.remove(),this._onTextureUnloaded(t)}),r=new qK(t,()=>{this._frameTask.schedule(()=>{r.isUnreferenced&&t.unload()})});return this._textures.set(e,r),r.ref(),t.loaded?(this._updateGLTexture(r,t.glTexture),xP(t)&&this.updater.add(t),r):(this._loadingCount++,r.loadingPromise=this._stage.schedule(()=>{const s=t.load(this._stage.renderView.renderingContext),n=o=>(this._loadingCount--,r.loadingPromise=null,this._updateGLTexture(r,o),xP(t)&&this.updater.add(t),r),a=o=>(t.unload(),this._loadingCount--,r.loadingPromise=null,js(o)||$.getLogger(this).error(o),null);return Fp(s)?s.then(n,a):n(s)}),r.loadingPromise)}_updateGLTexture(e,t){e.glTexture=t,this.events.emit("changed",1)}_onTextureUnloaded(e){this._textures.delete(e.id),this.updater.remove(e)}};h([d()],bh.prototype,"_loadingCount",void 0),h([d()],bh.prototype,"_frameTask",void 0),h([d()],bh.prototype,"updating",null),bh=h([D("esri.views.3d.webgl-engine.lib.TextureRepository")],bh);let qK=class{constructor(e,t){this._texture=e,this._release=t,this._refCount=0}get id(){return this._texture.id}get isUnreferenced(){return this._refCount===0}ref(){++this._refCount}release(){--this._refCount,this._refCount>0||(this._refCount!==0?($.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository.RefCountedTextureImpl").error("Cannot dereference texture that has no references!"),this._refCount=0):this._release())}unload(){this._texture.unload()}};function GK(e,t){return new vO(i=>hq(i,e),i=>i,t)}let jd=class extends ie{constructor(){super(...arguments),this._passParameters=new $K,this._resourcesTask=null}get passParameters(){return this._passParameters}destroy(){this._resourcesTask=Ar(this._resourcesTask),this._passParameters.waveNormal=ye(this._passParameters.waveNormal),this._passParameters.wavePerturbation=ye(this._passParameters.wavePerturbation)}get updating(){return!!this._resourcesTask&&!this._resourcesTask.finished}ensureResources(e){return this._resourcesTask||(this._resourcesTask=Ya(async t=>{await Promise.allSettled([this._loadImageResource(e,Zw("esri/images/materials/water/normals.jpg"),i=>this._passParameters.waveNormal=i,t),this._loadImageResource(e,Zw("esri/images/materials/water/perturbation.jpg"),i=>this._passParameters.wavePerturbation=i,t)])})),this._resourcesTask.finished?2:1}async _loadImageResource(e,t,i,r){try{const s=await ic(t,{signal:r});qe(r);const n=new gt(s.width,s.height);n.pixelFormat=6407,n.samplingMode=9987,n.hasMipmap=!0,n.maxAnisotropy=8,i(new bt(e,n,s))}catch(s){$.getLogger(this).error("Failed to load water material normal texture.",s)}}};h([d()],jd.prototype,"_resourcesTask",void 0),h([d({type:Boolean,readOnly:!0})],jd.prototype,"updating",null),jd=h([D("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],jd);let $K=class extends Kt{};const CP=2048,WK=1.5,ZK=8;function z5(e,t){const{format:i,quality:r,rotation:s,disableDecorations:n}=e||{},a=Tw(e,t.padding),o=rJ(e,{width:t.width-a.left-a.right,height:t.height-a.top-a.bottom}),{width:l,height:c}=iJ(e,o),u=U5(i),p=H5[u];return{format:u,quality:j(r??p,0,100),area:o,width:l,height:c,rotation:s,disableDecorations:!!n,ignoreBackground:!!e?.ignoreBackground,ignorePadding:!!e?.ignorePadding}}function QK(e,t){const i=z5(e,t),r=i.area,s=i.width/r.width,n=Tw(i,t.padding),a=n.left+n.right,o=n.top+n.bottom,l=t.width-a,c=t.height-o,u=Math.floor(l*s+a),p=Math.floor(c*s+o),m=e?.layers??[],f=i.ignoreBackground,g=i.ignorePadding;return{framebufferWidth:u,framebufferHeight:p,region:{x:Math.floor(r.x*s)+n.left,y:Math.floor(r.y*s)+n.top,width:i.width,height:i.height},format:i.format,quality:i.quality,rotation:i.rotation,pixelRatio:s,layers:m,disableDecorations:i.disableDecorations,ignoreBackground:f,ignorePadding:g,olidColor:!1}}function XK(e,t,i){const{ctx:r,canvas:s}=k5(e,i),n=r.getImageData(0,0,e.width,e.height),a=N5(s,t);return B5(s),{dataUrl:a,data:n}}function YK(e,t){const{ctx:i,canvas:r}=k5(e,t),s=i.getImageData(0,0,e.width,e.height);return B5(r),s}function k5(e,t){const i=KK();t.premultipliedAlpha&&oJ(e),i.width=e.width,i.height=e.height;const r=i.getContext("2d",{willReadFrequently:!0});return r.putImageData(e,0,0),t.flipY&&aJ(r),{ctx:r,canvas:i}}function B5(e){e.width=0,e.height=0}function KK(){return fv==null&&(fv=document.createElement("canvas")),fv}let fv=null;function N5(e,t){const i=lJ[t.format],r=t.quality/100;return e.toDataURL(i,r)}function JK(e,t){const i=U5(e),r=H5[i];return{format:i,quality:j(t??r,0,100)}}function eJ(e,t){return t/Math.max(e[0],e[1])}function j5(e,t,i,r=0,s=0,n=e.width-r,a=e.height-s,o=!1){const{data:l}=e,{width:c,height:u,data:p}=t,m=n/c,f=a/u,g=Math.ceil(m/2),y=Math.ceil(f/2),v=e.width;for(let C=0;C<u;C++)for(let b=0;b<c;b++){const S=4*(b+(o?u-C-1:C)*c);let x=0,T=0,P=0,R=0,O=0,E=0;const A=(C+.5)*f;for(let F=Math.floor(C*f);F<(C+1)*f;F++){const L=Math.abs(A-(F+.5))/y,H=(b+.5)*m,V=L*L;for(let I=Math.floor(b*m);I<(b+1)*m;I++){const B=Math.abs(H-(I+.5))/g,ee=Math.sqrt(V+B*B);if(ee>=1)continue;let G=2*ee*ee*ee-3*ee*ee+1;const be=4*(r+I+(s+F)*v);E+=G*l[be+3],T+=G,!i&&l[be+3]<255&&(G=G*l[be+3]/255),P+=G*l[be],R+=G*l[be+1],O+=G*l[be+2],x+=G}}p[S]=P/x,p[S+1]=R/x,p[S+2]=O/x,p[S+3]=E/T}return t}function tJ(e,t,i){if(!t)return e;const{framebufferWidth:r,framebufferHeight:s,pixelRatio:n,region:a}=e,o=Tw(e,i),l=o.left+o.right,c=o.top+o.bottom,u=r-l,p=s-c,m=Math.min(ZK,Math.min((CP-l)/u,(CP-c)/p));return m<WK?e:{...e,framebufferWidth:Math.round(u*m)+l,framebufferHeight:Math.round(p*m)+c,pixelRatio:n*m,resample:{region:{x:Math.round((a.x-o.left)*m)+o.left,y:Math.round((a.y-o.top)*m)+o.top,width:Math.round(a.width*m),height:Math.round(a.height*m)},width:r,height:s}}}function iJ(e,t){if(!e)return t;const i=e.width,r=e.height;if(i!=null&&r!=null)return{width:Math.floor(i),height:Math.floor(r)};if(i==null&&r==null)return t;const s=t.width/t.height;return r==null?{width:Math.floor(i),height:Math.floor(i/s)}:{width:Math.floor(r*s),height:Math.floor(r)}}function rJ(e,t){const i={x:0,y:0,width:t.width,height:t.height};if(e?.area){e.area.x!=null&&(i.x=Math.floor(e.area.x)),e.area.y!=null&&(i.y=Math.floor(e.area.y));const r=e.area.width!=null?Math.floor(e.area.width):null,s=e.area.height!=null?Math.floor(e.area.height):null;if(i.width=t.width-i.x,i.height=t.height-i.y,r!=null&&s!=null)i.width=Math.min(i.width,r),i.height=Math.min(i.height,s);else if(r==null&&s!=null){const n=Math.min(i.width,r);i.height=n/i.width*i.height,i.width=n}else if(r!=null&&s==null){const n=Math.min(i.height,s);i.width=n/i.height*i.width,i.height=n}}return sJ(nJ(i,e),t)}function sJ(e,t){const i=Math.floor(Math.max(e.x,0)),r=Math.floor(Math.max(e.y,0)),s={x:i,y:r,width:Math.floor(Math.min(e.width,t.width-i)),height:Math.floor(Math.min(e.height,t.height-r))},n=s.width/s.height,a=e.width/e.height;if(a===n)return s;if(a>n){const c=Math.floor(s.width/a),u=s.height-c;return{x:s.x,y:Math.floor(s.y+u/2),width:s.width,height:c}}const o=Math.floor(s.height*a),l=s.width-o;return{x:Math.floor(s.x+l/2),y:s.y,width:o,height:s.height}}function nJ(e,t){if(t?.width==null||t.height==null)return e;const i=t.width/t.height,r=e.width/e.height;if(r===i)return e;if(r<i){const n=Math.floor(e.height*i);return e.x-=(n-e.width)/2,e.width=n,e}const s=Math.floor(e.width/i);return e.y-=(s-e.height)/2,e.height=s,e}function Tw(e,t){return!t||e?.ignorePadding?hJ:t}function U5(e){switch(e){case"png":case"jpg":case"jpeg":return e;default:return cJ}}function aJ(e){e.save(),e.globalCompositeOperation="copy",e.scale(1,-1),e.translate(0,-e.canvas.height),e.drawImage(e.canvas,0,0),e.restore()}function oJ(e){const t=e.data,i=t.length;for(let r=0;r<i;r+=4){const s=t[r+3];if(s!==255&&s>0){const n=255/s;t[r]=t[r]*n,t[r+1]=t[r+1]*n,t[r+2]=t[r+2]*n}}}const lJ={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg"},SP=98,cJ="png",H5={png:100,jpg:SP,jpeg:SP},hJ={top:0,right:0,bottom:0,left:0},sd=Object.freeze(Object.defineProperty({__proto__:null,completeUserSettings:z5,createEmptyImageData:Ef,encode:XK,encodeData:YK,getFormatAndQuality:JK,getMaximumResolutionScale:eJ,resampleHermite:j5,screenshotSuperSampleSettings:tJ,toDataUrl:N5,toRenderSettings:QK},Symbol.toStringTag,{value:"Module"}));let uJ=class{constructor(e,t){this.parameters=e,this.fbos=t}},dJ=class{constructor(e,t,i){this._rctx=e,this._renderFunctions=t,this._forceCameraHook=i,this.supersample=!0,this._screenshotQueue=new Array}destroy(){this._rctx=null}async takeScreenshot(e){await this._renderFunctions.prepareOverlay(),this._renderFunctions.requestRenderScene(0);const t=aa();return this._screenshotQueue.push({settings:e,resolver:t}),t.promise}update(e,t){for(const i of this._screenshotQueue){if(this._rctx==null){i.resolver.reject();continue}const r={...i.settings,pixelRatio:i.settings.pixelRatio*e.parameters.camera.pixelRatio},s=this._renderScreenshot(e,r,t);i.resolver(s)}this._screenshotQueue.length=0}_renderScreenshotOverlay(e,t,i){e.width=t.width,e.height=t.height;const r=e.getContext("2d",{willReadFrequently:!0}),s=i.pixelRatio;return r.save(),r.translate(0,t.height),r.scale(1,-1),i.region&&r.translate(-i.region.x,-i.region.y),r.scale(s,s),t=this._renderFunctions.renderOverlay(e,i.disableDecorations,t),r.restore(),t}_readbackScreenshot(e,t){return e.resample?this._readbackScreenshotResampled({...e,resample:e.resample},t):this._readbackScreenshotImmediate(e,t)}_readbackScreenshotResampled(e,t){const{framebufferWidth:i,framebufferHeight:r,region:s,resample:n}=e,a=this._ensureScreenshotEncodeCanvas();let o=Ef(i,r,a);this._rctx.gl.readPixels(0,0,i,r,6408,Tn.UNSIGNED_BYTE,new Uint8Array(o.data.buffer)),t(),o=this._renderScreenshotOverlay(a,o,{...e,region:void 0});const l=Ef(s.width,s.height,a);return j5(o,l,!0,n.region.x,r-(n.region.y+n.region.height),n.region.width,n.region.height)}_readbackScreenshotImmediate(e,t){const{framebufferHeight:i,region:r}=e,s=this._ensureScreenshotEncodeCanvas(),n=Ef(r.width,r.height,s);return this._rctx.gl.readPixels(r.x,i-(r.y+r.height),r.width,r.height,6408,Tn.UNSIGNED_BYTE,new Uint8Array(n.data.buffer)),t(),this._renderScreenshotOverlay(s,n,e)}_renderScreenshot(e,t,i){const r=e.parameters.camera,{framebufferWidth:s,framebufferHeight:n,ignorePadding:a,pixelRatio:o,disableDecorations:l,olidColor:c}=t,u={width:s,height:n};Bl(u,Math.min(this._rctx.parameters.maxTextureSize,this._rctx.parameters.maxRenderbufferSize));let p=!1;const m=u.width!==r.fullWidth||u.height!==r.fullHeight,f=a&&r.pixelRatio!==o,g=m||l||f||c;let y=null,v=null;if(g){const x=r.clone();if(a){const E=Rf(x.padding);for(let A=0;A<4;A++)E[A]=Math.round(E[A]/x.pixelRatio*o);x.padding=E}x.fullWidth=u.width,x.fullHeight=u.height,x.pixelRatio=o;const T=r.fovX-x.fovX,P=r.fovY-x.fovY;T<0&&T<P?x.fovX=r.fovX:P<0&&P<T&&(x.fovY=r.fovY);const R={camera:x,contentCamera:x,mode:2,alignPixelEnabled:!0,contentPixelRatio:x.pixelRatio};this._forceCameraHook(R),p=!0;const O=this._renderFunctions.renderScene(R,i,c?2:1,l);v=O.screen,y=O.olid}const C=()=>{this._rctx.bindFramebuffer(null),v?.release()};this._rctx.bindFramebuffer(v?.fbo);const b=this._readbackScreenshot(t,C);let S=null;if(c){const x=()=>{this._rctx.bindFramebuffer(null),y?.release()};this._rctx.bindFramebuffer(y?.fbo),S=this._readbackScreenshot(t,x),this._rctx.bindFramebuffer(null)}if(g&&!this._rctx.contextAttributes.alpha)for(let x=3;x<b.data.length;x+=4)b.data[x]=255;if(S&&!this._rctx.contextAttributes.alpha)for(let x=3;x<S.data.length;x+=4)S.data[x]=255;return p&&this._forceCameraHook(e.parameters),[b,S]}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas??=document.createElement("canvas"),this._screenshotEncodeCanvas}},ir=class extends ie{constructor(e){super(e),this._waterTextures=new jd,this.olidRenderHelper=Io()?new jX:null,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._needsWaterReflectionUpdate=!1,this._lastAnimationUpdate=0,this.glow=null,this.fog=null,this.test=null;const t=e.stage;try{this._initializeContext(t)}catch(n){return void console.error("Failed to initialize context",n)}const{memoryController:i}=t.view.resourceController;this._stippleTextures=rq(this._rctx,i),this.notifyChange("stippleTextures"),this._markerTextures=GK(this._rctx,i),this.notifyChange("markerTextures"),this._techniques=new WQ(new $Q(this._rctx,t.viewingMode,this.stippleTextures,this.waterTextures,this.markerTextures)),this._textures=new bh(t),this.addHandles(this._textures.events.on("changed",n=>this.requestRender(n)));const r=new yO(this._textures,this._techniques,()=>this.requestRender(),()=>this.requestRender());this._compositingHelper=new NX(this._rctx,this._techniques),this._renderer=new vh(t,r,this._techniques,this._rctx,this._compositingHelper,n=>this.requestRender(n)),this.notifyChange("renderer"),this.addHandles([M(()=>t.view.ready,n=>{n&&this._createRenderNodes()},Ee),M(()=>this.waterTextures?.updating,()=>this.requestRender(),Ee),M(()=>t.view.qualityProfile,n=>this.renderer?.updateRenderFeatures(n),Ve)]);const s={renderScene:(n,a,o,l)=>this.renderer.render(n,a,o,l),requestRenderScene:n=>this.requestRender(n),prepareOverlay:()=>t.options.screenshot.prepareOverlay(),renderOverlay:(n,a,o)=>t.options.screenshot.renderOverlay(n,a,o)};this._screenshotManager=new dJ(this._rctx,s,n=>t.view.overlayManager.updateOverlays(bn,n.camera,0)),this._registerFrameTask(t)}destroy(){const e=this.stage?.container;e?.contains(this._canvas)&&e.removeChild(this._canvas),this._frameTask=xi(this._frameTask),this._techniques=Z(this._techniques),this._componentObjectCollection=Z(this._componentObjectCollection),this._set("componentObjectCollection",null),this._screenshotManager=Z(this._screenshotManager),Z(this.renderer),this._textures=Z(this._textures),Z(this.waterTextures),Z(this.markerTextures),Z(this.stippleTextures),this._waterTextures=null,this._markerTextures=null,this._stippleTextures=null,this._canvas=null,this._rctx=Z(this._rctx),this._compositingHelper=null,this._renderer=null,this._set("renderer",null),this.test?.destroy()}_createRenderNodes(){const{view:e,viewingMode:t}=this.stage;new c2({view:e}),I2(e.spatialReference)||(t===2?(new t2({view:e}),this.glow=new ql({view:e})):A2(e.spatialReference)?(new i2({view:e}),this.glow=new ql({view:e})):(new J1({view:e}),new e2({view:e}),this.glow=new ql({view:e}),new o2({view:e}),this.fog=new gg({view:e}))),new o8({view:e,isEnabled:()=>this.renderer.hasSSAO}),new Ml({view:e,isEnabled:()=>this.renderer.hasSMAA}),new Pl({view:e}),new Td({view:e}),new _h({view:e,viewingMode:t}),new Ad({view:e}),Io()&&new Ed({view:e})}requestRender(e=1){switch(e){case 2:this.stage.view.state.fading=!0;case 1:this._needsUpdate=!0;case 0:this._needsRender=!0}}get updating(){return this._needsUpdate||this._needsWaterReflectionUpdate||this.renderer.updating||this._textures.updating||this.waterTextures.updating}get textures(){return this._textures}get techniques(){return this._techniques}get compositingHelper(){return this._compositingHelper}setIdleSuspend(e){this._idleSuspend!==e&&(this._idleSuspend=e,this.requestRender())}get renderingContext(){return this._rctx}get capabilities(){return this._rctx.capabilities}get canvas(){return this._canvas}takeScreenshot(e){return this._screenshotManager.takeScreenshot(ec(e))}getAlpha(){return!!this._rctx.contextAttributes.alpha}getMinimalDepthForArea(e,t,i,r,s,n=s){const a=r.constrainWindowSize(t,i,s*r.pixelRatio,n*r.pixelRatio),o=this._ensureLinearDepthArrayBuffer(a);this.renderer.readMainDepth(a,o);const l=(u,p,m)=>iF(p,u)*(m[1]-m[0])+m[0];let c=Number.MAX_VALUE;for(let u=0;u<a[2]*a[3];u++){const p=l(4*u,o,r.nearFar);c>p&&p!==r.nearFar[0]&&p!==r.nearFar[1]&&(c=p)}if(e){const u=e.pickDepth(t*r.pixelRatio,i*r.pixelRatio,r);u!=null&&c>u&&u!==r.nearFar[0]&&u!==r.nearFar[1]&&(c=u)}return c===Number.MAX_VALUE?void 0:c}_ensureLinearDepthArrayBuffer(e){const t=4*e[2]*e[3];return(this._tmpDepthBuffer==null||this._tmpDepthBuffer.byteLength<t)&&(this._tmpDepthBuffer=new Uint8Array(t)),this._tmpDepthBuffer}async reloadShaders(){LO(),await this._techniques.reloadAll(),this.renderer.overlay?.reloadShaders(),this.requestRender()}_registerFrameTask(e){const t=e.view.state;let i=!1,r=0,s=!1;const n={preRender:({time:a})=>{i=this.updating,r=this._needsUpdate?1:0,this._needsRender&&this.renderer.updateSceneDepthRange(t.camera),e.commitSyncLayers(),a=this.test?.time??a,(Oe(a-this._lastAnimationUpdate)>this.renderer.animationTimestep||i||this._needsRender)&&(this.renderer.updateAnimation(t,a)&&this.requestRender(0),this._lastAnimationUpdate=a)},render:({time:a})=>{if((this._needsRender||!this._idleSuspend||!this.renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&t.camera.fullWidth>0&&t.camera.fullHeight>0){const o=this._needsUpdate&&this._idleSuspend&&this.renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,a=this.test?.time??a,this.renderer.render(t,a,0),s=!0,o&&this.renderer.hasReflections&&(this.requestRender(0),this._needsWaterReflectionUpdate=!0)}},update:({time:a})=>{this._textures.update();const o=new uJ(t,this.renderer.fboCache);a=this.test?.time??a,this._screenshotManager.update(o,a)},finish:()=>{s&&(this.renderer.finish(t.mode===2?r:1),s=!1)}};this._frameTask=tc(n)}_initializeContext(e){const{options:t}=e,i=t.canvas??document.createElement("canvas");i.setAttribute("style","width: 100%; height:100%; display:block;"),this._canvas=i;const r={alpha:t.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:t.stencil??!0,powerPreference:"high-performance",preserveDrawingBuffer:t.preserveDrawingBuffer??!1},s=i.getContext("webgl2",r);if(s==null)return void $.getLogger(this).error("A WebGL2 context could not be created.");Cf(s,!0),this._rctx=pJ(s,e),this._loadShaderOnlyExtensions(),!t.alpha&&this._rctx.contextAttributes.alpha&&$.getLogger(this).error("WebGL context has alpha channel even though no alpha channel was requested");const{container:n}=e;!this._rctx.contextAttributes.alpha&&Qe("safari")>=11&&(n.style.backgroundColor="black"),n.contains(i)||n.appendChild(i)}_loadShaderOnlyExtensions(){this._rctx.capabilities.enable("textureFloatLinear")}get _viewingMode(){return this.stage.viewingMode}get stippleTextures(){return this._stippleTextures}get markerTextures(){return this._markerTextures}get waterTextures(){return this._waterTextures}getObjectAndLayerIdColor(e){return this.olidRenderHelper?.getObjectAndLayerIdColor(e)}get renderer(){return this._renderer}get componentObjectCollection(){return this._componentObjectCollection==null&&(this._componentObjectCollection=new qQ(this.renderer.renderPassManager,this._viewingMode)),this._componentObjectCollection}set componentObjectCollection(e){this._componentObjectCollection=e}updateQualitySettings(e){this.test?.time!=null&&(this.test.savedFadeDuration=e.fadeDuration,e.fadeDuration=Oe(0)),this._rctx.updateOptions({maxPreferredTexturePixels:this.stage.view.qualitySettings.maxTexturePixels})}};function pJ(e,t){const i=new jK(t);return new BK(e,i)}h([d({type:Boolean,readOnly:!0})],ir.prototype,"updating",null),h([d({constructOnly:!0})],ir.prototype,"stage",void 0),h([d({readOnly:!0})],ir.prototype,"stippleTextures",null),h([d({readOnly:!0})],ir.prototype,"markerTextures",null),h([d({readOnly:!0})],ir.prototype,"waterTextures",null),h([d({readOnly:!0})],ir.prototype,"olidRenderHelper",void 0),h([d()],ir.prototype,"_textures",void 0),h([d({readOnly:!0})],ir.prototype,"renderer",null),h([d()],ir.prototype,"_screenshotManager",void 0),h([d()],ir.prototype,"componentObjectCollection",null),h([d()],ir.prototype,"_componentObjectCollection",void 0),h([d()],ir.prototype,"_needsUpdate",void 0),h([d()],ir.prototype,"_needsWaterReflectionUpdate",void 0),ir=h([D("esri.views.3d.webgl-engine.parts.RenderView")],ir);let Ts=class extends ie{constructor(e){super(e),this._model=new fg,this._canCompact=ar(!1),this._layers=new Array,this._asyncChangeSet=new $1,this._syncChangeSet=new $1,this._layerSyncSet=new Set,this._textures=new Fh(this,e.view.resourceController.scheduler),this._frameTask=e.view.resourceController.scheduler.registerTask(mi.STAGE,this),this.addHandles(this._frameTask)}initialize(){this._renderView=new ir({stage:this})}destroy(){this.removeAllHandles(),this._textures.destroy(),this._set("textures",null),this._renderView=Z(this._renderView),this._set("renderView",null),this._layers.length=0,this._model=null,this._set("renderer",null),this.options.canvas=null,this._set("options",null)}get viewingMode(){return this.view.state.viewingMode}get updating(){return!this.destroyed&&!this.destroying&&(this.readyToRun||this.renderView.updating||this._frameTask.updating||this.textures.updating)}get renderView(){return this._renderView}get renderer(){return this.renderView?.renderer}get textures(){return this._textures}addTexture(e){this._model.addTexture(e),this.renderView.requestRender()}removeTexture(e){e!=null&&!this.destroyed&&this._model.hasTexture(e)&&(this._model.removeTexture(e),this.renderView.requestRender())}addTextures(e){e!=null&&(this._model.addTextures(e),this.renderView.requestRender())}removeTextures(e){e!=null&&(this._model?.removeTextures(e),this.renderView.requestRender())}forEachTexture(e){this._model.forEachTexture(e)}getTexture(e){return this._model.getTexture(e)}addLayer(e){this._layers.includes(e)||(this._model.addLayer(e),this._layers.push(e),this._model.dirtySet.layerAdded(e),this.renderView.requestRender())}removeLayer(e){e!=null&&!this.destroyed&&this._model.hasLayer(ec(e))&&(this._model.dirtySet.layerRemoved(e),this.commitLayer(e),zs(this._layers,e),this._model.dirtySet.assertLayerClean(e.id),this._model.removeLayer(e),this.renderView.requestRender())}getLayer(e){return this._model.getLayer(e)}handleEvent(e,t){this.destroyed||(this._model.dirtySet[e](t),this.renderView.requestRender())}get readyToRun(){return this._model.dirtySet.dirty||!this._asyncChangeSet.empty||this._canCompact.value}runTask(e){if(this._frameTask.processQueue(e),this._commit(e),this.renderer.compact(e),this._canCompact.value=this.renderer.canCompact,!e.hasProgressed)return Fi}compact(e){return this._canCompact.value=!1,this.renderer.compact(e)}_commit(e){const t=this._model.dirtySet;this._asyncChangeSet.empty||e.done||(this.renderer.commit(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()),this._layers.forEach(i=>{if(e.done)return;const r=this._layerSyncSet.has(i.id)||i.updatePolicy===1,s=r?this._syncChangeSet:this._asyncChangeSet;t.commitLayer(i.id,s),this._layerSyncSet.delete(i.id),s.empty||(this.renderer.commit(s,r?bn:e),this.renderView.requestRender(),e.madeProgress())}),this._syncChangeSet.empty||(this.renderer.commit(this._syncChangeSet,bn),this.renderView.requestRender(),e.madeProgress()),this._layers.forEach(i=>{e.done||this._layerSyncSet.has(i.id)||i.updatePolicy!==0||(t.commitLayer(i.id,this._asyncChangeSet),this._asyncChangeSet.empty||(this.renderer.commit(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()))}),this._layerSyncSet.clear(),this.notifyChange("readyToRun")}commitSyncLayers(){const e=this._model.dirtySet;this._layers.forEach(t=>{this._layerSyncSet.has(t.id)||t.updatePolicy===1?(e.commitLayer(t.id,this._syncChangeSet),this._layerSyncSet.delete(t.id)):e.commitSyncUpdates(t.id,this._syncChangeSet)});for(const t of this._layerSyncSet)e.commitLayer(t,this._syncChangeSet);this._layerSyncSet.clear(),this._syncChangeSet.empty||(this.renderer.commit(this._syncChangeSet,bn),this.renderView.requestRender())}commitLayer(e){this._model.dirtySet.commitLayer(e.id,this._syncChangeSet),this._layerSyncSet.delete(e.id),this._syncChangeSet.empty||(this.renderer.commit(this._syncChangeSet,bn),this.renderView.requestRender())}schedule(e,t){return this._frameTask.schedule(e,t)}reschedule(e,t){return this._frameTask.reschedule(e,t)}syncLayer(e){this._layerSyncSet.add(e),this.renderView.requestRender()}get layers(){return this._layers}addRenderPlugin(e,t){const i=this.renderer.plugins.add(e,t),r=()=>{k3(e)&&this.view.sceneIntersectionHelper.addIntersectionHandler(e)};if(Fp(i))return i.then(r);r()}removeRenderPlugin(e){this.destroyed||(k3(e)&&this.view.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderer.plugins.remove(e))}get test(){}};h([d({constructOnly:!0})],Ts.prototype,"view",void 0),h([d({constructOnly:!0})],Ts.prototype,"options",void 0),h([d({readOnly:!0})],Ts.prototype,"viewingMode",null),h([d({constructOnly:!0})],Ts.prototype,"container",void 0),h([d({readOnly:!0})],Ts.prototype,"updating",null),h([d({readOnly:!0})],Ts.prototype,"renderView",null),h([d({readOnly:!0})],Ts.prototype,"renderer",null),h([d({readOnly:!0})],Ts.prototype,"textures",null),h([d({readOnly:!0})],Ts.prototype,"readyToRun",null),Ts=h([D("esri.views.3d.webgl-engine.Stage")],Ts);const TP=Symbol("analyses-owner-handles");let vo=class extends ie{constructor(e){super(e),this._allAnalysisViews=new Mt,this._creatingViewCount=0,this._attachedToViewResolver=PP(),this._items=new Map,this._moduleMap=new Map,this._scheduledUpdateHandle=null,this._emitOnView=(t,i)=>this.view.emit(t,i)}destroy(){this._disconnectOwners(),this._attachedToViewResolver.reject(Ui("AnalysisViewManager was destroyed")),this._set("view",null)}attach(){this._connectOwners(),this._attachedToViewResolver.resolve()}detach(){this._disconnectOwners(),this._attachedToViewResolver.reject(Ui()),this._attachedToViewResolver=PP()}get updating(){return!this.view.ready||this._creatingViewCount!==0||this._allAnalysisViews.some(e=>e.updating)}get testInfo(){}async whenAnalysisView(e){await this._attachedToViewResolver.promise;const t=this._items.get(e);if(t==null||t.state.list===1)throw new fe("AnalysisViewManager:no-analysis-view-for-analysis","The analysis does not exist in view.analyses",{analysis:e});return t.createAnalysisViewTask.promise}_connectOwners(){this.addHandles(this._connectAnalysesCollection(this.view.analyses),TP)}_disconnectOwners(){this.removeHandles(TP),this._update(),this._creatingViewCount=0}_connectAnalysesCollection(e){for(const r of e)this._addAnalysis(r);const t=e.on("after-add",r=>this._addAnalysis(r.item)),i=e.on("after-remove",r=>this._removeAnalysis(r.item));return Sn(()=>{t.remove(),i.remove();for(const r of e)this._removeAnalysis(r)})}_addAnalysis(e){const t=this._items.get(e);if(t==null){const i={state:{view:0,list:0},analysis:e,view:null,createAnalysisViewTask:null};this._items.set(e,i),i.createAnalysisViewTask=Ya(r=>this._createAnalysisViewPromise(i,r).then(s=>(this._emitOnView("analysis-view-create",{analysis:e,analysisView:s}),s),s=>{throw this._emitOnView("analysis-view-create-error",{analysis:e,error:s}),s}))}else t.state.list=0}_removeAnalysis(e){const t=this._items.get(e);t!=null?(t.state.list=1,this._scheduleUpdate()):$.getLogger(this).error("Trying to remove analysis which was not added")}_scheduleUpdate(){this._scheduledUpdateHandle==null&&(this._scheduledUpdateHandle=BP(()=>this._update()))}_update(){this._scheduledUpdateHandle=xi(this._scheduledUpdateHandle),this._items.forEach(e=>{if(e.state.list!==1)return;const{analysis:t,view:i}=e;switch(this._items.delete(t),e.state.view){case 0:e.createAnalysisViewTask=Ar(e.createAnalysisViewTask);break;case 1:i!=null&&(this._allAnalysisViews.remove(i),e.view=Z(i),e.createAnalysisViewTask=null,this._emitOnView("analysis-view-destroy",{analysis:t,analysisView:i}))}})}async _createAnalysisViewPromise(e,t){const{analysis:i}=e;if(this._creatingViewCount+=1,!this._moduleMap.has(i.type))try{this._moduleMap.set(i.type,await this.importAnalysisViewModule(i))}catch{throw this._creatingViewCount-=1,new fe("AnalysisViewManager:no-analysis-view-for-analysis",`Analysis of type "${i.type}" is not supported`)}if(Gl(t))throw this._creatingViewCount-=1,Ui("AnalysisView creation aborted");const r=new(this._moduleMap.get(i.type)).default({analysis:i,view:this.view});let s=!0;Ao(t,()=>{s&&this._destroyAnalysisView(i,r)});try{await r.when()}catch(n){throw s=!1,this._destroyAnalysisView(i,r),n}if(Gl(t))throw Ui();return s=!1,e.view=r,e.state.view=1,this._allAnalysisViews.add(r),this._creatingViewCount-=1,r}_destroyAnalysisView(e,t){t.destroyed||(this._creatingViewCount-=1,t.destroy(),this._emitOnView("analysis-view-destroy",{analysis:e,analysisView:t}))}};h([d()],vo.prototype,"updating",null),h([d({constructOnly:!0})],vo.prototype,"importAnalysisViewModule",void 0),h([d({constructOnly:!0})],vo.prototype,"view",void 0),h([d()],vo.prototype,"_allAnalysisViews",void 0),h([d()],vo.prototype,"_creatingViewCount",void 0),vo=h([D("esri.views.support.AnalysisViewManager")],vo);const mJ=vo;function PP(){const e=aa();return e.promise.catch(()=>{}),e}function gv(e,t){return t?"xoffset"in t&&t.xoffset?Math.max(e,Math.abs(t.xoffset)):"yoffset"in t&&t.yoffset?Math.max(e,Math.abs(t.yoffset||0)):e:e}function fJ(e){let t=0,i=0;for(let r=0;r<e.length;r++){const s=e[r].size;typeof s=="number"&&(t+=s,i++)}return t/i}function MP(e,t){return typeof e=="number"?e:e?.stops?.length?fJ(e.stops):t}function gJ(e,t){if(!t)return e;const i=t.filter(a=>a.type==="size").map(a=>{const{maxSize:o,minSize:l}=a;return(MP(o,e)+MP(l,e))/2});let r=0;const s=i.length;if(s===0)return e;for(let a=0;a<s;a++)r+=i[a];const n=Math.floor(r/s);return Math.max(n,e)}function _J(e){const t=e?.renderer,i=e?.pointerType,r=i==="touch"?9:6;if(!t)return r;const s="visualVariables"in t?gJ(r,t.visualVariables):r;if(t.type==="simple")return gv(s,t.symbol);if(t.type==="unique-value"){let n=s;return t.uniqueValueInfos?.forEach(a=>{n=gv(n,a.symbol)}),n}if(t.type==="class-breaks"){let n=s;return t.classBreakInfos.forEach(a=>{n=gv(n,a.symbol)}),n}return t.type==="dot-density"||t.type,s}function yJ(e,t,i,r=new sr){let s=0;if(i.type==="2d")s=t*(i.resolution??0);else if(i.type==="3d"){const u=i.overlayPixelSizeInMapUnits(e),p=i.basemapSpatialReference;s=p==null||p.equals(i.spatialReference)?t*u:Zh(p)/Zh(i.spatialReference)}const n=e.x-s,a=e.y-s,o=e.x+s,l=e.y+s,{spatialReference:c}=i;return r.xmin=Math.min(n,o),r.ymin=Math.min(a,l),r.xmax=Math.max(n,o),r.ymax=Math.max(a,l),r.spatialReference=c,r}function Sse(e,t,i){const r=i.toMap(e);return r==null?!1:yJ(r,_J(),i,q5).intersects(t)}let q5=new sr;function vJ(){q5=new sr}function bJ(e){return t=>{if(e.destroyed){const r=t(bn);return Fp(r)?r:Promise.resolve(r)}if(e.immediate)return e.immediate.schedule(t);const i="No immediate scheduler";throw console.error(i),new Error(i)}}const w_=new Set,G5=()=>$.getLogger("esri/views/support/TextureCompressionHelper");function wJ(e,t){return bt.compressionWorkerHandle??=new vW(bJ(t)),w_.has(e)?G5().warn("Repeated texture compression worker initialization by the same view."):w_.add(e),bt.compressionWorkerHandle}function xJ(e){const t=bt.compressionWorkerHandle;t&&(w_.delete(e)||G5().warn("Unknown view attempted to destroy the texture compression worker."),w_.size||(t.destroyWorkerAndSelf(),bt.compressionWorkerHandle=null))}function CJ(e){const t=$F();return t.available?e==="3d"&&t.majorPerformanceCaveat?new fe("webgl:major-performance-caveat-detected",`Your WebGL implementation (${t.unmaskedRenderer}) doesn't seem to support hardware accelerated rendering. Check your browser settings or if your GPU is in a blocklist.`):t.supportsHighPrecisionFragment?t.supportsVertexShaderSamplers?null:new fe("webgl:vertex-shader-samplers-required","WebGL support for vertex shader samplers is required but not supported."):new fe("webgl:high-precision-fragment-required","WebGL support for high precision fragment shaders is required but not supported."):new fe("webgl:required","WebGL2 is required but not supported.",new Error().stack)}const SJ={left:0,top:0,bottom:0,right:0},$5={bottom:30,top:15,right:15,left:15},va="esri-ui",jr={ui:va,corner:`${va}-corner`,innerContainer:`${va}-inner-container`,manualContainer:`${va}-manual-container`,cornerContainer:`${va}-corner-container`,topLeft:`${va}-top-left`,topRight:`${va}-top-right`,bottomLeft:`${va}-bottom-left`,bottomRight:`${va}-bottom-right`};function TJ(e){return e&&!e._started&&typeof e.postMixInProperties=="function"&&typeof e.buildRendering=="function"&&typeof e.postCreate=="function"&&typeof e.startup=="function"}function vf(e){return e===0?"0":`${e}px`}function _v(e){const t=typeof e=="object"&&e!==null&&Object.getPrototypeOf(e);return(t===null||t===Object.prototype)&&("component"in e||"index"in e||"position"in e)?e:null}function yv(e,{top:t,bottom:i,left:r,right:s}){e.style.top=t,e.style.bottom=i,e.style.left=r,e.style.right=s}let Zn=class extends gu{constructor(e){super(e),this._cornerNameToContainerLookup={},this._positionNameToContainerLookup={},this._components=new Array,this._componentMap=new Map,this._removeWidgetHandleKey=Symbol("componentOnRemoveSymbol"),this._locale=I9(),this.view=null,this._applyViewPadding=()=>{const t=this.container;t&&yv(t,this._toPixelPosition(this._getViewPadding()))},this._applyUIPadding=()=>{const t=this._innerContainer;t&&yv(t,this._toPixelPosition(this.padding))},this._initContainers()}initialize(){this.addHandles([M(()=>[this.view?.padding,this.container],this._applyViewPadding,Ee),M(()=>this.padding,this._applyUIPadding,Ee),M(()=>[this.container,this._locale],([e,t])=>{e&&e.setAttribute("lang",t)},Ee),L9(e=>{this._locale=e})])}destroy(){this.removeAllHandles(),this.container=null;for(const e of this._components)e.destroy();this._components.length=0,this._componentMap.clear(),this.view=null,this._set("view",null)}set container(e){const t=this._get("container");e!==t&&(e&&(e.classList.add(jr.ui),R9(e),this._attachContainers(e)),t&&(t.classList.remove(jr.ui),yv(t,{top:"",bottom:"",left:"",right:""}),t.textContent=""),this._set("container",e))}get height(){const e=this.view?.height??0;if(e===0)return e;const t=this._getViewPadding(),{top:i,bottom:r}=t;return Math.max(e-i-r,0)}get padding(){return this._get("padding")}set padding(e){this._overrideIfSome("padding",e)}castPadding(e){return typeof e=="number"?{bottom:e,top:e,right:e,left:e}:{...$5,...e}}get width(){const e=this.view?.width??0;if(e===0)return e;const t=this._getViewPadding(),{left:i,right:r}=t;return Math.max(e-i-r,0)}add(e,t){let i,r,s;if(Array.isArray(e))return void e.forEach(a=>this.add(a,t));const n=_v(e);n&&({index:i,position:t,component:e,key:r}=n),t&&typeof t=="object"&&({index:i,key:r,position:t,internal:s}=t),!e||t&&!this._isValidPosition(t)||this._add(e,t,i??this._getNumComponentsAtPosition(t),r,s)}remove(e,t){if(!e)return;if(Array.isArray(e))return e.map(r=>this.remove(r,t));const i=this._find(e);if(i){const r=this._componentMap.get(i);if(!r||r.key!==t)return;const s=this._components.indexOf(i);return i.node.parentNode?.removeChild(i.node),this._componentMap.delete(i),i.widget?.removeHandlesReference(this._removeWidgetHandleKey),this._components.forEach(n=>{const a=this._componentMap.get(n);a&&a.position===r.position&&a.index>r.index&&a.index--}),this._components.splice(s,1)[0]}}empty(e,t={removeInternal:!1}){if(Array.isArray(e)){for(const s of e)this.empty(s,t);return}const i=this._positionNameToContainerLookup[e??"manual"],r=Array.prototype.slice.call(i.children).map(s=>this._findByNode(s)).filter(s=>s==null?!1:!(this._componentMap.get(s)?.internal??!1)||t.removeInternal);for(const s of r)this.remove(s)}move(e,t){if(Array.isArray(e)&&e.forEach(n=>this.move(n,t)),!e)return;let i;const r=_v(e)||_v(t);if(r&&(i=r.index,t=r.position,e=r.component||e),t&&!this._isValidPosition(t))return;const s=this.remove(e);s&&this.add(s,{position:t,index:i})}find(e){if(!e)return null;const t=this._findById(e);return t&&(t.widget||t.node)}getComponents(e,t={includeInternal:!1}){return e?Array.isArray(e)?e.flatMap(i=>this._getComponentsAtPosition(i,t)):this._getComponentsAtPosition(e,t):this._components.filter(i=>t.includeInternal||!this._componentMap.get(i)?.internal).map(({widget:i,node:r})=>i??r)}getPosition(e){for(const t in this._positionNameToContainerLookup)if(this._positionNameToContainerLookup[t].contains(e))return t;return null}_add(e,t,i,r,s){e instanceof Qd||(e=new Qd({node:e}));const{widget:n}=e;n!=null&&n instanceof ie&&n.addHandles(Sn(()=>{queueMicrotask(()=>this.remove(e))}),this._removeWidgetHandleKey);const a=this._positionNameToContainerLookup[t];this._components.some(o=>{const l=this._componentMap.get(o)?.position,c=l?this._positionNameToContainerLookup[l]:null;return a===c&&this._componentMap.get(o)?.index===i})&&this._components.forEach(o=>{const l=this._componentMap.get(o),c=l?.position,u=c?this._positionNameToContainerLookup[c]:null;l&&u===a&&l.index>=i&&l.index++}),this._place({component:e,position:t,index:i}),this._components.push(e),this._componentMap.set(e,{key:r,position:t,internal:s,index:i})}_find(e){return e?e instanceof Qd?this._findByComponent(e):typeof e=="string"?this._findById(e):"domNode"in e?this._findByNode(e.domNode):this._findByNode(e):null}_getViewPadding(){return this.view?.padding??SJ}_attachContainers(e){e.appendChild(this._innerContainer),e.appendChild(this._manualContainer)}_initContainers(){const e=document.createElement("div");e.classList.add(jr.innerContainer,jr.cornerContainer);const t=document.createElement("div");t.classList.add(jr.innerContainer,jr.manualContainer);const i=document.createElement("div");i.classList.add(jr.topLeft,jr.corner),e.appendChild(i);const r=document.createElement("div");r.classList.add(jr.topRight,jr.corner),e.appendChild(r);const s=document.createElement("div");s.classList.add(jr.bottomLeft,jr.corner),e.appendChild(s);const n=document.createElement("div");n.classList.add(jr.bottomRight,jr.corner),e.appendChild(n),this._innerContainer=e,this._manualContainer=t;const a=D9();this._cornerNameToContainerLookup={"top-left":i,"top-right":r,"bottom-left":s,"bottom-right":n,"top-leading":a?r:i,"top-trailing":a?i:r,"bottom-leading":a?n:s,"bottom-trailing":a?s:n},this._positionNameToContainerLookup={manual:t,...this._cornerNameToContainerLookup}}_isValidPosition(e){return!!this._positionNameToContainerLookup[e]}_place(e){const t=e.position??"manual",{component:i,index:r}=e,s=this._positionNameToContainerLookup[t],n=r!=null&&r>-1;if(TJ(i.widget)&&i.widget.startup(),!n)return void s.appendChild(i.node);const a=Array.from(s.children);if(a.length!==0){for(const o of a){const l=this._findByNode(o);if(l&&r<(this._componentMap.get(l)?.index??0))return void o.parentNode?.insertBefore(i.node,o)}s.appendChild(i.node)}else s.appendChild(i.node)}_toPixelPosition(e){return{top:vf(e.top),left:vf(e.left),right:vf(e.right),bottom:vf(e.bottom)}}_findByComponent(e){return this._components.find(t=>t===e)??null}_findById(e){return this._components.find(({id:t})=>t===e)??null}_findByNode(e){return e?this._components.find(({node:t})=>t===e):null}_getComponentsAtPosition(e,t){const i=this._positionNameToContainerLookup[e];return Array.prototype.slice.call(i.children).map(r=>this._findByNode(r)).filter(Dg).filter(r=>t.includeInternal||!this._componentMap.get(r)?.internal).map(({widget:r,node:s})=>r??s)}_getNumComponentsAtPosition(e){return this._positionNameToContainerLookup[e]?.children.length??0}};h([d()],Zn.prototype,"_locale",void 0),h([d()],Zn.prototype,"container",null),h([d()],Zn.prototype,"height",null),h([d({value:$5})],Zn.prototype,"padding",null),h([Ua("padding")],Zn.prototype,"castPadding",null),h([d()],Zn.prototype,"view",void 0),h([d()],Zn.prototype,"width",null),Zn=h([D("esri.views.ui.UI")],Zn);const PJ=Zn,Tse=-1,MJ=-2;let Ud,Hd=null;const Ro=new Map;async function Pse(e){Hd==null&&(Ud==null&&(Ud=k(()=>le(()=>import("./Lyr3DWasmPerSceneView-C8ajBbu--BrJE_FPC.js"),__vite__mapDeps([472,3,7,1,2,8,4,231,112,113,10,16,12,473,222,131,11,166,38,167,6,9,19,20,14,168,169,86,170,87,171,69,172,173,174,175,176,13,177,36,37,178,179,180,181,101,27,182,183,184,34,92,185,186,187,91,93,26,89,94,188,28,21,22,23,189,190,191,25,5,15,29,30,31,32,33,35,39,40,41,42,43,128,192,193,194,195,97,196,197,75,198,200,46,201,202,203,146,51,204,205,206,143,207,208,209,68,210,50,47,48,211,212,213,18,214,215,141,82,83,84,81,80,70,216,160,217,221,226,227,233,234,121,199,165,218,219,220,98,99,223,224,225,79,228,229,230,232,235,236])),ue([473,1,7,8,5,6,2,245,113,114,10,16,12,474,236,132,11,182,39,183,4,9,19,20,14,184,185,87,186,88,187,70,188,189,190,191,192,13,193,37,38,194,195,196,197,102,28,198,199,200,35,93,201,202,203,92,94,27,90,95,204,29,21,22,23,24,205,206,175,26,3,15,30,31,32,33,34,36,40,41,42,43,44,129,207,208,209,210,98,211,122,52,212,76,213,214,180,47,18,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,166,231,232,233,234,99,100,235,237,238,239,80,240,241,242,243,244,246,247,248,249,250]))),Hd=await Ud);const t=e.view;let i=Ro.get(t);i||(i=new Hd.default({view:t}),Ro.set(t,i));const r=!!t.stage.renderView.renderingContext.capabilities.compressedTextureS3TC,s=!!t.stage.renderView.renderingContext.capabilities.compressedTextureETC;await i.initializeWasm(r,s);const n=i.addLayerView(e);if(n.wasmLayerId<0)throw i.getValidLayerViewCount()<1&&(Ro.delete(t),Ro.size===0&&(Ud=null,Hd=null)),n.wasmLayerId===MJ?new fe("tiles3d:addLayer-failure","The 3d tiles layer web assembly module failed to download.",{}):new fe("tiles3d:addLayer-failure",n.check?.errorDescription??"The 3d tiles layer description was invalid.",{});return n.wasmLayerId}function RJ(e){return Ro.get(e)}function Mse(e){const t=e.view,i=Ro.get(t);i&&i.removeLayerView(e)<1&&(Ro.delete(t),Ro.size===0&&(Ud=null,Hd=null))}function RP(e,t){return e&&"copyright"in e&&(!t||typeof e.originOf=="function"&&e.originOf("copyright")==="user")}function DJ(e,t){return e.length!==t.length||e.some((i,r)=>i.text!==t[r].text)}function bf(e,t,i){!i||!t||e.find(r=>r.layerView===t&&r.text===i)||e.push({text:i,layerView:t})}function OJ(e){return e.type==="bing-maps"}const Bn=[];let wh=class extends ie{constructor(e){super(e),this._clear=()=>{this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.removeHandles("suspension"),this.notifyChange("state")},this._pendingAttributions=new Set,this._fetchedAttributionData=new Map,this.items=new Mt,this.view=null,this._allLayerViewsChange=t=>{this.removeHandles("suspension"),this.removeHandles("visible-geometry-changed");const i=this.view?.allLayerViews;i&&(this.addHandles(i.map(r=>M(()=>[r.suspended,r.layer?.attributionVisible],()=>this._updateAttributionItems())).toArray(),"suspension"),i.forEach(r=>{r.declaredClass==="esri.views.3d.layers.IntegratedMesh3DTilesLayerView3D"&&this.addHandles(r.on("visible-geometry-changed",()=>this._updateAttributionItems()),"visible-geometry-changed")})),t?.removed&&t.removed.forEach(r=>{this._pendingAttributions.delete(r),this._fetchedAttributionData.delete(r)}),this._updateAttributionItems()},this.addHandles([Ir(()=>this.view?.allLayerViews,"change",t=>this._allLayerViewsChange(t),{onListenerAdd:()=>this._allLayerViewsChange(),onListenerRemove:this._clear}),Yr(()=>this.view?.stationary===!0,()=>this._updateAttributionItems())])}destroy(){this.view=null,this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.items.removeAll()}get state(){return this.view?.ready?this._pendingAttributions.size>0?"loading":"ready":"disabled"}_updateAttributionItems(){const e=this.view,t=e?.allLayerViews;Bn.length=0;let i=!1,r=null;if(!e||!t)return void this._clear();t.forEach(n=>{if(n.suspended||!n.layer?.attributionVisible)return;const a=n.layer;if(RP(a,"user"))return void bf(Bn,n,a.copyright);if(a.type==="integrated-mesh-3dtiles"&&a.hasGoogleUrl&&(i=!0,r=n),a.hasAttributionData){if(this._fetchedAttributionData.has(n)){const l=this._fetchedAttributionData.get(n);return void(l?bf(Bn,n,this._getDynamicAttribution(l,e,a)):RP(a)&&bf(Bn,n,a.copyright))}return void this._fetchAttributionData(n)}const o="portalItem"in a?a.portalItem?.accessInformation:void 0;bf(Bn,n,o||a.copyright)});const s=t.find(n=>n.layer?.type==="integrated-mesh-3dtiles");if(this.view&&s){const n=RJ(this.view);if(n){const a=n.getAttributionText();for(let o=a.length-1;o>-1;--o)Bn.unshift({text:a[o],layerView:s})}}i&&r&&Bn.unshift({text:"Google Maps",layerView:r}),DJ(this.items,Bn)&&(this.items.removeAll(),this.items.addMany(Bn)),Bn.length=0,this.notifyChange("state")}async _fetchAttributionData(e){if(this._pendingAttributions.has(e))return;this._pendingAttributions.add(e);const t=await kg(e.layer.fetchAttributionData());if(this._pendingAttributions.has(e)){const i=t.ok?this._createContributionIndex(t.value,OJ(e.layer)):null;this._pendingAttributions.delete(e),this._fetchedAttributionData.set(e,i)}this._updateAttributionItems()}_createContributionIndex(e,t){const i=e.contributors,r={};if(!i)return r;for(let s=0;s<i.length;s++){const n=i[s],a=n.coverageAreas;if(!a)return;for(const o of a){const l=o.bbox,c=o.zoomMin-(t&&o.zoomMin?1:0),u=o.zoomMax-(t&&o.zoomMax?1:0),p=new sr({xmin:l[1],ymin:l[0],xmax:l[3],ymax:l[2],spatialReference:At.WGS84}),m={extent:h9(p),attribution:n.attribution||"",score:o.score!=null?o.score:100,id:s};for(let f=c;f<=u;f++)r[f]??=[],r[f].push(m)}}return r.maxKey=Math.max.apply(null,Object.keys(r)),r}_getDynamicAttribution(e,t,i){const{extent:r,scale:s}=t;let n=i.tileInfo?.scaleToZoom(s)??0;if(n=Math.min(e.maxKey??0,Math.round(n)),!r||n==null||n<=-1)return"";const a=e[n],o=u9(r.center.clone().normalize(),At.WebMercator),l=new Set;return a?a.filter(c=>{const u=c.id,p=!l.has(u)&&o&&c.extent&&N9(c.extent,o);return p&&l.add(u),p}).sort((c,u)=>u.score-c.score||c.objectId-u.objectId).map(c=>c.attribution).join(", "):""}};h([d({readOnly:!0,type:Mt})],wh.prototype,"items",void 0),h([d({readOnly:!0})],wh.prototype,"state",null),h([d()],wh.prototype,"view",void 0),wh=h([D("esri.widgets.Attribution.AttributionViewModel")],wh);const W5=wh,sa={button:"esri-button",buttonDisabled:"esri-button--disabled",buttonHalf:"esri-button--half",buttonSecondary:"esri-button--secondary",buttonSmall:"esri-button--small",buttonTertiary:"esri-button--tertiary",buttonThird:"esri-button--third",empty:"esri-widget__content--empty",heading:"esri-widget__heading",interactive:"esri-interactive",panel:"esri-widget--panel",table:"esri-widget__table",widget:"esri-widget",widgetButton:"esri-widget--button"};function EJ(){return function(e,t){if(!e[t])throw new TypeError(`Cannot auto bind undefined function '${String(t)}'`);return{value:IJ(e[t])}}}function AJ(e){const t=e?.type;return e instanceof KeyboardEvent||t==="keyup"||t==="keydown"||t==="keypress"}function IJ(e){return function(t,...i){AJ(t)?O9(t.key)&&(t.preventDefault(),t.stopPropagation(),t.target.click()):e.call(this,t,...i)}}const Jc="esri-attribution",eh={base:Jc,poweredBy:`${Jc}__powered-by`,sources:`${Jc}__sources`,open:`${Jc}--open`,sourcesOpen:`${Jc}__sources--open`,link:`${Jc}__link`};let Sr=class extends Np{constructor(e,t){super(e,t),this._isOpen=!1,this._attributionTextOverflowed=!1,this._prevSourceNodeHeight=0,this._sourcesNode=null,this._overflowRequestAnimationFrame=null,this._resizeObserver=new ResizeObserver(i=>{i.forEach(({target:r})=>{this._scheduleOverflowCheck(r)})}),this._mutationObserver=new MutationObserver(i=>{let r=!1;for(const s of i)if(s.type==="childList"||s.type==="characterData"||s.type==="attributes"){r=!0;break}r&&this._sourcesNode&&this._scheduleOverflowCheck(this._sourcesNode)}),this.itemDelimiter=" | ",this.messages=null,this.viewModel=new W5}initialize(){this.addHandles(Ir(()=>this.viewModel?.items,"change",()=>this.scheduleRender()))}destroy(){this._resizeObserver?.disconnect(),this._mutationObserver?.disconnect(),this._overflowRequestAnimationFrame!=null&&(cancelAnimationFrame(this._overflowRequestAnimationFrame),this._overflowRequestAnimationFrame=null)}get _isInteractive(){return this._isOpen||this._attributionTextOverflowed}_scheduleOverflowCheck(e){this._overflowRequestAnimationFrame==null&&(this._overflowRequestAnimationFrame=requestAnimationFrame(()=>{this._overflowRequestAnimationFrame=null,this._checkSourceTextOverflow(e)}))}get attributionText(){return this.viewModel.items.reduce((e,t)=>(e.includes(t.text)||e.push(t.text),e),[]).join(this.itemDelimiter)}get icon(){return"description"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}render(){const e={[eh.open]:this._isOpen};return Hi("div",{bind:this,class:this.classes(eh.base,sa.widget,e),dir:"ltr",onclick:this._toggleState,onkeydown:this._toggleState},this._renderSourcesNode(),this._renderPoweredBy())}_renderPoweredBy(){return Hi("div",{class:eh.poweredBy},"Powered by"," ",Hi("a",{class:eh.link,href:"https://www.esri.com/",rel:"noreferrer",target:"_blank"},"Esri"))}_renderSourcesNode(){const e=this._isOpen,t=this._isInteractive,i=t?0:void 0,{attributionText:r}=this,s={[eh.sourcesOpen]:e,[sa.interactive]:t};return Hi("div",{afterCreate:this._afterSourcesNodeCreate,bind:this,class:this.classes(eh.sources,s),innerHTML:r,tabIndex:i})}_afterSourcesNodeCreate(e){this._prevSourceNodeHeight=e.clientWidth,this._sourcesNode=e,this._resizeObserver.observe(e),this._mutationObserver.observe(e,{subtree:!0,childList:!0,characterData:!0,attributes:!0}),this._scheduleOverflowCheck(e)}_checkSourceTextOverflow(e){let t=!1;const{clientHeight:i,clientWidth:r,scrollWidth:s}=e,n=s>r,a=this._attributionTextOverflowed!==n;if(this._attributionTextOverflowed=n,a&&(t=!0),this._isOpen){const o=i<this._prevSourceNodeHeight;this._prevSourceNodeHeight=i,o&&(this._isOpen=!1,t=!0)}t&&this.scheduleRender()}_toggleState(){this._isInteractive&&(this._isOpen=!this._isOpen)}};h([d()],Sr.prototype,"_isOpen",void 0),h([d()],Sr.prototype,"_isInteractive",null),h([d()],Sr.prototype,"_attributionTextOverflowed",void 0),h([d()],Sr.prototype,"_prevSourceNodeHeight",void 0),h([d({readOnly:!0,dependsOn:["viewModel.items.length","itemDelimiter"]})],Sr.prototype,"attributionText",null),h([d()],Sr.prototype,"icon",null),h([d()],Sr.prototype,"itemDelimiter",void 0),h([d()],Sr.prototype,"label",null),h([d(),Qh("esri/widgets/Attribution/t9n/Attribution")],Sr.prototype,"messages",void 0),h([d()],Sr.prototype,"view",null),h([d({type:W5})],Sr.prototype,"viewModel",void 0),h([EJ()],Sr.prototype,"_toggleState",null),Sr=h([D("esri.widgets.Attribution")],Sr);const LJ=Sr;function FJ(){const e=Qe("mapview-essential-goto-duration");return e==null?e:Oe(e)}function VJ(e){return e?.spatialReference?.isWebMercator||e?.spatialReference?.isGeographic||!1}function zJ(e,t,i){return e.goTo(t,i)}const kJ=e=>{const t=e;let i=class extends t{constructor(...r){super(...r),this.goToOverride=null,this.view=null}callGoTo(r){const{view:s}=this;return zP(s),this.goToOverride?this.goToOverride(s,r):zJ(s,r.target,r.options)}};return h([d()],i.prototype,"goToOverride",void 0),h([d()],i.prototype,"view",void 0),i=h([D("esri.widgets.support.GoTo")],i),i};let Rl=class extends kJ(ie){constructor(e){super(e),this.orientation={x:0,y:0,z:0},this.view=null,this._updateForCamera=this._updateForCamera.bind(this),this._updateForRotation=this._updateForRotation.bind(this),this._updateRotationWatcher=this._updateRotationWatcher.bind(this)}initialize(){this._watchForView(Ee)}destroy(){this.view=null}get canShowNorth(){return VJ(this.view)}get state(){return!this.view?.ready||this.view.type==="2d"&&!this.view.constraints.rotationEnabled?"disabled":this.canShowNorth?"compass":"rotation"}reset(){this.view?.ready&&(this.view?.type==="2d"?this.callGoTo({target:{rotation:0},options:{animationMode:"always",duration:FJ()}}):this.callGoTo({target:{heading:0}}))}_updateForRotation(e){e!=null&&this._set("orientation",{z:e})}_updateForCamera(e){if(!e)return;const t=-e.heading;this._set("orientation",{x:0,y:0,z:t})}_updateRotationWatcher(e){this.removeAllHandles(),this._watchForView(),e&&this.addHandles(e.type==="2d"?M(()=>e?.rotation,this._updateForRotation,Ee):M(()=>e?.camera,this._updateForCamera,Ee))}_watchForView(e){this.addHandles(M(()=>this.view,this._updateRotationWatcher,e))}};h([d({readOnly:!0})],Rl.prototype,"canShowNorth",null),h([d({readOnly:!0})],Rl.prototype,"orientation",void 0),h([d({readOnly:!0})],Rl.prototype,"state",null),h([d()],Rl.prototype,"view",void 0),Rl=h([D("esri.widgets.Compass.CompassViewModel")],Rl);const Z5=Rl,DP="esri-compass",OP={base:DP,iconContainer:`${DP}__icon-container`};let Da=class extends Np{constructor(e,t){super(e,t),this.messages=null,this.viewModel=new Z5,this._reset=()=>{this.viewModel.reset()},this._toRotationTransform=i=>({transform:`rotateZ(${i.z}deg)`})}loadDependencies(){return F2({button:()=>k(()=>le(()=>import("./index-E6-DofOg-CMLF7D_5.js"),__vite__mapDeps([474,475,21,3,16,12,4,7,1,2,8,22,23,476,477,478,479,480,481,482,483,484,485,486,487])),ue([475,476,21,1,16,12,2,7,8,5,6,22,23,24,477,478,479,480,481,482,483,484,485,486,487,488])),icon:()=>k(()=>le(()=>import("./index-DPItRse1-DsqzxNyn.js"),__vite__mapDeps([479,21,3,16,12,4,7,1,2,8,22,23,480,481])).then(e=>e.i),ue([480,21,1,16,12,2,7,8,5,6,22,23,24,481,482]))})}get goToOverride(){return this.viewModel.goToOverride}set goToOverride(e){this.viewModel.goToOverride=e}get icon(){return this.viewModel.state==="rotation"?"arrow-up":"compass-needle"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}reset(){return this.viewModel.reset()}render(){const{orientation:e,state:t}=this.viewModel,{messages:i}=this;return Hi("div",{class:this.classes(OP.base,sa.widget)},Hi("calcite-button",{class:sa.widgetButton,disabled:t==="disabled",kind:"neutral",label:i.reset,onclick:this._reset,round:!0,scale:"s",title:i.reset},Hi("div",{"aria-hidden":"true",class:OP.iconContainer,title:i.reset},Hi("calcite-icon",{icon:this.icon,styles:this._toRotationTransform(e)}))))}};h([d()],Da.prototype,"goToOverride",null),h([d()],Da.prototype,"icon",null),h([d()],Da.prototype,"label",null),h([d(),Qh("esri/widgets/Compass/t9n/Compass")],Da.prototype,"messages",void 0),h([d()],Da.prototype,"view",null),h([d({type:Z5})],Da.prototype,"viewModel",void 0),Da=h([D("esri.widgets.Compass")],Da);const BJ=Da,EP="esri-navigation-toggle",AP={base:EP,isLayoutHorizontal:`${EP}--horizontal`};let xh=class extends ie{constructor(e){super(e),this._navigationMode="pan",this.view=null,e?.isDefaultViewModel||OA($.getLogger(this),"Navigation Toggle","arcgis-navigation-toggle",{version:"4.33"})}normalizeCtorArgs(e={}){const{isDefaultViewModel:t,...i}=e;return i}initialize(){this.addHandles(Yr(()=>this.view?.navigation?.actionMap,()=>this._updateNavigationActionMap()))}destroy(){this.view=null}get state(){return this.view?.ready&&this.view?.type==="3d"?"ready":"disabled"}get navigationMode(){return this._navigationMode}set navigationMode(e){this._navigationMode=e,this._updateNavigationActionMap()}toggle(){this.state!=="disabled"&&(this.navigationMode=this.navigationMode!=="pan"?"pan":"rotate")}_updateNavigationActionMap(){const e=this.view?.navigation?.actionMap;if(!e)return;const t=this._navigationMode==="pan";e.dragPrimary=t?"pan":"rotate",e.dragSecondary=t?"rotate":"pan"}};h([d({readOnly:!0})],xh.prototype,"state",null),h([d()],xh.prototype,"_navigationMode",void 0),h([d()],xh.prototype,"view",void 0),xh=h([D("esri.widgets.NavigationToggle.NavigationToggleViewModel")],xh);const Q5=xh;let Oa=class extends Np{constructor(e,t){super(e,t),this.messages=null,this.viewModel=new Q5({isDefaultViewModel:!0}),this.toggle=()=>this.viewModel.toggle(),this._panButton=null,this._rotateButton=null,this._toggle=()=>{const i=this.viewModel?.navigationMode==="pan"?this._rotateButton:this._panButton;M9(i),this.toggle()},e?.isDefaultUI||RA($.getLogger(this),"Navigation Toggle","arcgis-navigation-toggle",{version:"4.32"})}normalizeCtorArgs(e={}){const{isDefaultUI:t,...i}=e;return i}loadDependencies(){return F2({button:()=>k(()=>le(()=>import("./index-E6-DofOg-CMLF7D_5.js"),__vite__mapDeps([474,475,21,3,16,12,4,7,1,2,8,22,23,476,477,478,479,480,481,482,483,484,485,486,487])),ue([475,476,21,1,16,12,2,7,8,5,6,22,23,24,477,478,479,480,481,482,483,484,485,486,487,488]))})}get icon(){return"move"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}set layout(e){e!=="horizontal"&&(e="vertical"),this._set("layout",e)}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}render(){const e=this.viewModel?.state==="disabled",t=this.viewModel?.navigationMode==="pan",i=this.messages.toggle;return Hi("div",{class:this.classes(AP.base,sa.widget,{[AP.isLayoutHorizontal]:this.layout==="horizontal"})},Hi("calcite-button",{afterCreate:r=>{this._panButton=r},appearance:t?"outline-fill":"solid",class:sa.widgetButton,disabled:e,iconStart:"move",kind:"neutral",label:i,onclick:this._toggle,tabIndex:t?void 0:-1,title:i}),Hi("calcite-button",{afterCreate:r=>{this._rotateButton=r},appearance:t?"solid":"outline-fill",class:sa.widgetButton,disabled:e,iconStart:"rotate",kind:"neutral",label:i,onclick:this._toggle,tabIndex:t?-1:void 0,title:i}))}};h([d()],Oa.prototype,"icon",null),h([d()],Oa.prototype,"label",null),h([d({value:"vertical"})],Oa.prototype,"layout",null),h([d(),Qh("esri/widgets/NavigationToggle/t9n/NavigationToggle")],Oa.prototype,"messages",void 0),h([d()],Oa.prototype,"view",null),h([d({type:Q5})],Oa.prototype,"viewModel",void 0),Oa=h([D("esri.widgets.NavigationToggle")],Oa);const NJ=Oa;let Dl=class extends ie{get canZoomIn(){if(!this.view?.ready)return!1;const e=this.view?.constraints?.effectiveMaxScale;return e===0||this._scale>e}get canZoomOut(){const{view:e}=this;if(!e?.ready)return!1;const t=e.constraints?.effectiveMinScale;return t===0||this._scale<t}get _scale(){const e=this.view?.animation?.target;return(e&&"then"in e?void 0:e?.scale)??this.view?.scale??0}};h([d({readOnly:!0})],Dl.prototype,"canZoomIn",null),h([d({readOnly:!0})],Dl.prototype,"canZoomOut",null),h([d()],Dl.prototype,"view",void 0),h([d()],Dl.prototype,"_scale",null),Dl=h([D("esri.widgets.Zoom.ZoomConditions2D")],Dl);const jJ=Dl;let Ch=class extends ie{get canZoomIn(){return!!this.view.ready}get canZoomOut(){return!!this.view.ready}};h([d({readOnly:!0})],Ch.prototype,"canZoomIn",null),h([d({readOnly:!0})],Ch.prototype,"canZoomOut",null),h([d()],Ch.prototype,"view",void 0),Ch=h([D("esri.widgets.Zoom.ZoomConditions3D")],Ch);const UJ=Ch;let bo=class extends ie{constructor(e){super(e)}destroy(){this.view=null}get canZoomIn(){return this._zoomConditions!=null&&this._zoomConditions.canZoomIn}get canZoomOut(){return this._zoomConditions!=null&&this._zoomConditions?.canZoomOut}get state(){return this.view?.ready?"ready":"disabled"}set view(e){e?e.type==="2d"?this._zoomConditions=new jJ({view:e}):e.type==="3d"&&(this._zoomConditions=new UJ({view:e})):this._zoomConditions=null,this._set("view",e)}zoomIn(){const e=this.view;this.canZoomIn&&e&&(e.type==="2d"?e.mapViewNavigation.zoomIn():Rg(e.goTo({zoomFactor:2})))}zoomOut(){const e=this.view;this.canZoomOut&&e&&(e.type==="2d"?e.mapViewNavigation.zoomOut():Rg(e.goTo({zoomFactor:.5})))}};h([d()],bo.prototype,"_zoomConditions",void 0),h([d()],bo.prototype,"canZoomIn",null),h([d()],bo.prototype,"canZoomOut",null),h([d({readOnly:!0})],bo.prototype,"state",null),h([d()],bo.prototype,"view",null),bo=h([D("esri.widgets.Zoom.ZoomViewModel")],bo);const X5=bo,IP={base:"esri-zoom",horizontalLayout:"esri-zoom--horizontal"};let Ea=class extends Np{constructor(e,t){super(e,t),this.messages=null,this.viewModel=new X5,this.zoomIn=()=>this.viewModel.zoomIn(),this.zoomOut=()=>this.viewModel.zoomOut()}loadDependencies(){return F2({button:()=>k(()=>le(()=>import("./index-E6-DofOg-CMLF7D_5.js"),__vite__mapDeps([474,475,21,3,16,12,4,7,1,2,8,22,23,476,477,478,479,480,481,482,483,484,485,486,487])),ue([475,476,21,1,16,12,2,7,8,5,6,22,23,24,477,478,479,480,481,482,483,484,485,486,487,488]))})}get icon(){return"magnifying-glass-plus"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}set layout(e){e!=="horizontal"&&(e="vertical"),this._set("layout",e)}set view(e){this.viewModel.view=e}get view(){return this.viewModel.view}render(){const e={[IP.horizontalLayout]:this.layout==="horizontal"},{canZoomIn:t,canZoomOut:i}=this.viewModel,{zoomIn:r,zoomOut:s}=this.messages;return Hi("div",{class:this.classes(IP.base,sa.widget,e)},Hi("calcite-button",{class:sa.widgetButton,disabled:!t,iconStart:"plus",kind:"neutral",label:r,onclick:this.zoomIn,title:r}),Hi("calcite-button",{class:sa.widgetButton,disabled:!i,iconStart:"minus",kind:"neutral",label:s,onclick:this.zoomOut,title:s}))}};h([d()],Ea.prototype,"icon",null),h([d()],Ea.prototype,"label",null),h([d({value:"vertical"})],Ea.prototype,"layout",null),h([d(),Qh("esri/widgets/Zoom/t9n/Zoom")],Ea.prototype,"messages",void 0),h([d()],Ea.prototype,"view",null),h([d({type:X5})],Ea.prototype,"viewModel",void 0),Ea=h([D("esri.widgets.Zoom")],Ea);const HJ=Ea;function qJ(e){return e?.view!==void 0}let Pg=class extends PJ{constructor(e){super(e),this._defaultPositionLookup={attribution:"manual",compass:"top-left","navigation-toggle":"top-left",zoom:"top-left"},this.components=[],this._updateViewAwareWidgets=t=>{this.components.forEach(i=>{const r=this._find(i),s=r?.widget;qJ(s)&&(s.view=t)})},this._componentsWatcher=(t,i)=>{this._removeComponents(i),this._addComponents(t),this._adjustPadding(t)}}initialize(){this.addHandles([M(()=>this.components,this._componentsWatcher,Ee),M(()=>this.view,this._updateViewAwareWidgets,Ee)])}_add(e,t,i,r,s){let n=e;if(typeof e=="string"&&this._defaultPositionLookup[e]){if(this._find(e))return;n=this._createComponent(e)}super._add(n,t,i,r,s)}_removeComponents(e){e.forEach(t=>{const i=this._find(t);i&&(this.remove(i),i.destroy())})}_adjustPadding(e){if(!e.includes("attribution")&&!this._isOverridden("padding")){const{top:t}=this.padding;this.padding=t}}_addComponents(e){this.constructed&&e.forEach(t=>this.add(this._createComponent(t),this._defaultPositionLookup[t]))}_createComponent(e){const t=this._createWidget(e);return new Qd({id:e,node:t})}_createWidget(e){const t=this.view;switch(e){case"attribution":return new LJ({view:t});case"compass":return new BJ({view:t});case"navigation-toggle":return new NJ({view:t,isDefaultUI:!0});case"zoom":return new HJ({view:t})}}};h([d()],Pg.prototype,"components",void 0),Pg=h([D("esri.views.ui.DefaultUI")],Pg);const Y5=Pg;let Mg=class extends Y5{constructor(e){super(e),this.components=["attribution","zoom","navigation-toggle","compass"]}};h([d()],Mg.prototype,"components",void 0),Mg=h([D("esri.views.ui.3d.DefaultUI3D")],Mg);const K5=Mg;var _2;const LP=Symbol(),vv=Symbol();let Q=class extends XF(f6(t6(Lx))){static{_2=this}constructor(e){super(e),this._userClippingArea=null,this._clippingArea=null,this._initialDefaultSpatialReference=null,this._overrideDefaultEnvironmentOnly=!0,this._resolveWhenReady=[],this._resourceController=qU(this),this.deconflictor=new I1({view:this}),this.labeler=new Sl({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.analyses=new su,this.animationsEnabled=!0,this.basemapTerrain=null,this.elevationProvider=new Cd({view:this}),this._canvas=null,this.constraints=new Il,this._environment=new ph,this.environmentManager=new nn,this.floors=new Mt,this.fullOpacity=1,this.graphicsView=null,this.analysisViewManager=new mJ({importAnalysisViewModule:i=>U7(i),view:this}),this.groundView=null,this.map=null,this._featureTileTreeClients=new ZF,this._featureTiles=null,this._featureTreeDebugger=null,this.state=new I3({view:this}),this.slice=new Sd,this.spatialReference=null,this.preserveDrawingBufferEnabled=!1,this.supersampleScreenshotsEnabled=!0,this.type="3d",this.ui=new K5,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this._importControllers=new Map,z9();const t=(i=null)=>{i!=null&&i.type===4||(this._updatingChanged(),this.map?.allLayers.forEach(async r=>{try{await r.when()}catch{}this._updatingChanged()}))};this.addHandles([Ir(()=>this.map?.allLayers,"after-changes",i=>t(i),{onListenerAdd:()=>t(),onListenerRemove:()=>t(),sync:!0}),this.allLayerViews.on("after-changes",i=>this._updateUpdatingMonitors(i)),M(()=>this.scene,i=>i?.load().catch(()=>{}))]),this.inputManager=new oN({view:this}),this.stateManager=new Wt({view:this}),this.screenSizePerspective=new wd({view:this})}initialize(){if(Qe("enable-feature:esri-compress-textures")&&Qe("wasm-simd")){const e=wJ(this,this.resourceController);this.addResolvingPromise(e.promise)}this.groundView=new os({view:this}),this._updateUpdatingMonitors(),this.updatingHandles.add(()=>this.qualitySettings.memoryLimit,e=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=e)},Ee),this.updatingHandles.add(()=>this.qualitySettings.additionalCacheMemory,e=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=e)},Ee),this.updatingHandles.add(()=>this.qualitySettings.frameRate??0,e=>cA(e>0?1e3/Math.ceil(e):0),Ee),this.addHandles([M(()=>this.spatialReference,()=>this.notifyChange("clippingArea"),Ie),M(()=>({plane:this.slice.plane,isDecoration:this.slice.isDecoration}),()=>this._updateSlice(),Ie)])}destroy(){this.destroyed||(xJ(this),this.updatingHandles.removeAll(),this.basemapTerrain?.clearHandles(),this.elevationProvider.destroy(),this.ui.removeAllHandles(),this.layerViewManager.clearHandles(),this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._set("analysisViewManager",Z(this.analysisViewManager)),this._exitSurface(),this._disposeGraphicsView(),this._disposeFocusAreasView(),this.sharedSymbolResources=Z(this.sharedSymbolResources),this._set("labeler",Z(this.labeler)),this._set("deconflictor",Z(this.deconflictor)),this._resourceController=Z(this._resourceController),this._set("stateManager",Z(this.stateManager)),this._set("inputManager",Z(this.inputManager)),this.state.destroy(),this.highlights.destroy(),this.removeHandles("updatingMonitors"),this._set("environmentManager",Z(this.environmentManager)),this._set("environment",Z(this.environment)),this.groundView=Z(this.groundView),this.slice.destroy(),this._updatingObjectsWithProgress.length=0,this._updatingObjects.length=0,this.ui?.destroy(),this._set("ui",null),this._set("renderCanvas",null),this._set("canvas",null),this._canvas=null,this.screenSizePerspective.destroy())}get stage(){return this._stage}get renderSpatialReference(){return this.renderCoordsHelper?.spatialReference}get basemapSpatialReference(){return this.basemapTerrain?.spatialReference}get animation(){return this.state?.animation}get overlayManager(){return this.basemapTerrain?.overlayManager}get camera(){return this.stateManager?.camera}set camera(e){this.stateManager&&(this.stateManager.camera=e)}get contentCamera(){return this.stateManager?.contentCamera}set contentCamera(e){this.stateManager&&(this.stateManager.contentCamera=e)}installContentCameraReset(e={sticky:!1}){return this.stateManager.installContentCameraReset(e)}get canvas(){return this._canvas}get center(){return this.stateManager?.center}set center(e){this.stateManager&&(this.stateManager.center=e)}get clippingArea(){if(this.viewingMode==="global")return null;const e=this.map;let t=this._userClippingArea||zw(e,"clippingArea");return!this._userClippingArea&&!zw(e,"clippingEnabled")||t==null?(this._clippingArea=null,null):t instanceof sr?this.spatialReference&&(t=wf(t,this.spatialReference),t==null)?($.getLogger(this).error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(t=t.clone(),t.intersection(this._groundAndLayersExtent)==null&&(t.xmin=t.xmax,t.ymin=t.ymax),t.zmin=void 0,t.zmax=void 0,t.equals(this._clippingArea)||(this._clippingArea=t),this._clippingArea):($.getLogger(this).error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)}set clippingArea(e){this.ready&&this.viewingMode==="global"&&e!=null?$.getLogger(this).error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=e}get renderDataExtent(){if(this.state.viewingMode===1)return null;const e=this.renderSpatialReference,t=this.dataExtent;return t==null||e==null||t.spatialReference.equals(e)?t:wf(t,e)}get tileInfo(){return this.basemapTerrain?.tilingScheme?.toTileInfo()}get dataExtent(){let e=this._groundAndLayersExtent;const t=this.spatialReference||At.WGS84,i=wf(this.clippingArea,t);i!=null&&(e=e!=null?e.intersection(i):i);const r=this._get("dataExtent");return e!=null&&e.equals(r)?r:e}get _groundAndLayersExtent(){const e=this.spatialReference||At.WGS84;let t;const i=a=>{const o=wf(a,e);o!=null&&(t!=null?t.union(o):t=o.clone())},{basemapTerrain:r}=this;if(r?.spatialReference){const a=r.groundExtent;i(new sr({xmin:a[0],ymin:a[1],zmin:0,xmax:a[2],ymax:a[3],zmax:0,spatialReference:r.spatialReference}))}const s=a=>{a.fullExtent==null||a.type==="graphics"&&a.internal||i(a.fullExtent)};if(this.map?.allLayers.forEach(a=>s(a)),t==null)return null;t.hasZ?(t.zmin=Math.min(0,t.zmin??0),t.zmax=Math.max(0,t.zmax??0)):(t.zmin=0,t.zmax=0);const n=this._get("_groundAndLayersExtent");return t.equals(n)?n:t}get environment(){return this._environment}set environment(e){if(this._environment===e)return;const{_environment:t}=this;this._environment=null,t?.destroy(),this._environment=e,this.notifyChange("environment")}castEnvironment(e){return e?e instanceof ph?e:e instanceof GR?this.environment?.cloneWithWebsceneEnvironment(e)??ph.fromWebsceneEnvironment(e):hA(ph,e):new ph}get extent(){return this.stateManager?.extent}set extent(e){this.stateManager&&(this.stateManager.extent=e)}get screenCenter(){return this.stateManager?.screenCenter}get frustum(){return this.stateManager?.frustum}get layerviewCollections(){return[this.basemapView?.baseLayerViews,this.basemapView?.groundLayerViews,this.groundView?.layerViews,this.layerViews,this.basemapView?.referenceLayerViews]}get _layerToLayerviewMapping(){return _2._layerToLayerview}static{this._layerToLayerview=Lx._layerToLayerview.concat([["view.map.ground.layers","view.groundView.layerViews"]])}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get defaultsFromMapSettings(){return{required:{tileInfo:!1,heightModelInfo:!0,extent:!1}}}get interacting(){return this.navigating||(this.toolViewManager?.interacting??!1)}get stationary(){return!this.animation&&!this.resizing&&(this.state?.stationary??!0)}get navigating(){return this.state?.navigating??!1}get scene(){return this.map&&TI in this.map?this.map:null}get padding(){return this.stateManager?.padding}set padding(e){this.stateManager&&(this.stateManager.padding=e)}get featureTiles(){return this._featureTiles}set qualityProfile(e){ig.isValidProfile(e)&&(ig.apply(e,this.qualitySettings),this.stage?.renderView.updateQualitySettings(this.qualitySettings),this._set("qualityProfile",e))}get qualityProfile(){return this._get("qualityProfile")||ig.getDefaultProfile()}_updateSlice(){this.stage!=null&&(this.stage.renderer.slice=this.slice)}get typeSpecificPreconditionsReady(){return!!this.viewingMode&&!!this.stateManager?.preinit(this.spatialReference)}get resolution(){return this.spatialReference!=null?vI(this.scale,this.spatialReference):0}get scale(){return this.stateManager?.scale}set scale(e){this.stateManager&&(this.stateManager.scale=e)}get terrainLevel(){const e=this.basemapTerrain?.tilingScheme,{scale:t}=this;if(!e||!t)return null;const i=e.levelAtScale(t)+this.qualitySettings.tiledSurface.lodBias,r=e.getMaxLod();return i<=0?null:Math.max(0,Math.min(i,r||1/0))}get heightModelInfo(){const e=this.getDefaultHeightModelInfo();return e!=null?jp.deriveUnitFromSR(e,this.spatialReference):null}get alphaCompositingEnabled(){return this._get("alphaCompositingEnabled")}set alphaCompositingEnabled(e){this._stage&&$.getLogger(this).warn("alphaCompositingEnabled cannot be changed after the view has become ready"),this._set("alphaCompositingEnabled",e)}get updating(){if(this.destroying||this.destroyed)return!1;let e=0,t=this.layerViewManager.updating,i=t?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach(s=>{if(s.isFulfilled()){if(s.updating){if(t=!0,s.suspended||N1(s))return;++i,e+=s.updatingProgress}}else++i});for(const s of this._updatingObjects)s!=null&&s.updating&&(i+=.1,e+=.5*.1);for(const s of this._updatingObjectsWithProgress)s!=null&&s.updating&&(++i,e+=s.updatingProgress);const r=!this.stateManager.test.updatingIgnoreRenderState&&this.state.updating;if(t=!!(t||i>0||this.updatingHandles.updating||!this.ready||!this.stationary||r||this._importControllers.size>0||this.inputManager?.updating||this.map?.allLayers?.some(s=>!s.isFulfilled())),t?(this._numUpdating=Math.max(i,this._numUpdating),e+=this._numUpdating-i):this._numUpdating=0,this._numUpdating>0?e/=this._numUpdating:e=t?0:1,this._get("updatingProgress")!==e){const s=performance.now();if(e<1){const n=Math.min((s-this._lastUpdateTime)/2e3,1);e=this.updatingProgress*(1-n)+e*n}this._set("updatingProgress",e),this._lastUpdateTime=t&&e<1?s:0}return t}get _updatingObjects(){return[this.graphicsView,this.basemapView,this._resourceController,this.stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this._featureTreeDebugger,this.toolViewManager,this.analysisViewManager]}get _updatingObjectsWithProgress(){return[this.deconflictor,this.labeler,this.basemapTerrain]}get viewingMode(){const e=this._predeterminedViewingMode;if(e!=null)return Oy(e);const t=this.spatialReference;return t?this.defaultsFromMap?.viewingMode!=null&&t.equals(this.defaultsFromMap.spatialReference)?Oy(this.defaultsFromMap.viewingMode):$v(t,1)?"global":"local":"global"}set viewingMode(e){this.ready?$.getLogger(this).error("#viewingMode","viewingMode cannot be set once view is ready"):this._overrideIfSome("viewingMode",e)}get viewpoint(){return this.stateManager?.viewpoint}set viewpoint(e){this.stateManager&&(this.stateManager.viewpoint=e)}get visibleArea(){return this.stateManager?.visibleArea}get zoom(){return this.stateManager.zoom}set zoom(e){this.stateManager&&(this.stateManager.zoom=e)}get highlightOptions(){return this.highlights.find(({name:e})=>e===la)??new Ql}set highlightOptions(e){for(let t=0;t<this.highlights.length;++t)if(this.highlights.at(t).name===la)return void this.highlights.items[t].assignFrom(e)}get resourceController(){return this._resourceController}get quality(){return this._resourceController?.memoryController?.memoryFactor??1}get resolutionScale(){return Math.sqrt(Math.min(1,this.quality/.75))}get performanceInfo(){return new WU(this)}on(e,t,i,r){return this.viewEvents.on(e,t,i,r)||super.on(e,t)}hasEventListener(e){return super.hasEventListener(e)||this.viewEvents.hasHandler(e)}toMap(e,t){if(!this.ready)return $.getLogger(this).error("#toMap()","Scene view cannot be used before it is ready"),null;const i=Dx(e)?Rx(this,e):e;return lU(this,i,t,this._defaultToMapOptions)}toScreen(e){if(!this.ready)return $.getLogger(this).error("#toScreen()","Scene view cannot be used before it is ready"),null;const t=(e.z==null?Jn(this.elevationProvider,e):null)??0;return Ha(e,xf,this.renderSpatialReference,t),this.state.camera.projectToScreen(xf,bv),ms(bv[0],bv[1])}pixelSizeAt(e,t){if(!this.ready)return $.getLogger(this).error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null;if(!e)return 0;const i=this.renderSpatialReference;Ha(e,xf,i);const r=this.state.camera.computeScreenPixelSizeAt(xf);return t&&i!==t?r*Zh(i)/Zh(t):r}overlayPixelSizeInMapUnits(e){return this.overlayManager?.overlayPixelSizeInMapUnits(e,()=>this.pixelSizeAt(e))??1}hitTest(e,t){if(!this.ready)return $.getLogger(this).error("#hitTest()","Scene view cannot be used before it is ready"),null;const i=Dx(e)?Rx(this,e):e;return oU(this,i,t,this._defaultHitTestOptions)}async popupHitTest(e){return SU(this,e)}goTo(e,t){return this.updatingHandles.addPromise(this.stateManager.goTo(e,t))}async whenAnalysisView(e){if(e.parent==null)throw new fe("view:no-analysisview-for-analysis","The analysis does not exist in view.analyses",{analysis:e});switch(e.parent.type){case"line-of-sight":case"dimension":case"viewshed":return(await this.whenLayerView(e.parent)).whenAnalysisView();default:return this.analysisViewManager.whenAnalysisView(e)}}whenLayerView(e){return super.whenLayerView(e)}async takeScreenshot(e){const t=await this._completeSettings(e);await this.whenReady();const i=(await this.stage.renderView.takeScreenshot(t))[0];return(await k(async()=>{const{encode:r}=await Promise.resolve().then(()=>sd);return{encode:r}},void 0)).encode(i,t,this._pixelFormat())}async _takeScreenshot(e){const t=await this._completeSettings(e);await this.whenReady();const i=(await this.stage.renderView.takeScreenshot(t))[0];return(await k(async()=>{const{encodeData:r}=await Promise.resolve().then(()=>sd);return{encodeData:r}},void 0)).encodeData(i,this._pixelFormat())}async _takeScreenshotWithObjectAndLayerId(e){const t=await this._completeSettings(e);t.olidColor=!0,await this.whenReady();const i=await this.stage.renderView.takeScreenshot(t),{encodeData:r}=await k(async()=>{const{encodeData:s}=await Promise.resolve().then(()=>sd);return{encodeData:s}},void 0);return[r(i[0],this._pixelFormat()),r(i[1],this._pixelFormat())]}async _completeSettings(e){const{toRenderSettings:t,screenshotSuperSampleSettings:i}=await k(()=>Promise.resolve().then(()=>sd),void 0),r=t(e,this);return r.pixelRatio/=this.state.pixelRatio,i(r,this.supersampleScreenshotsEnabled,this.padding)}_pixelFormat(){return{flipY:!0,premultipliedAlpha:this.stage?.renderView.getAlpha()??!1}}get test(){}async takeScreenshotWithObjectAndLayerId(e){if(!Io())throw new fe("360vr:objectAndLayerId-rendering-disabled","has enable-feature:objectAndLayerId-rendering must be true");const{encode:t}=await k(()=>Promise.resolve().then(()=>sd),void 0),i=await this._completeSettings(e);i.olidColor=!0,await this.whenReady();const r=await this.stage.renderView.takeScreenshot(i),s=t(r[0],i,this._pixelFormat()),n=await this._completeSettings(e);return n.format="png",[s,t(r[1],n,this._pixelFormat())]}getColorToObjectAndLayerIdMapping(){const e=this.stage.renderView.olidRenderHelper;if(e)return e.getColorToObjectAndLayerIdMapping();throw new fe("360vr:objectAndLayerId-rendering-disabled","has enable-feature:objectAndLayerId-rendering must be true")}addUpdatingPromise(e){return this.updatingHandles.addPromise(e)}importLayerView(e){return Bx.importLayerView(e)}hasLayerViewModule(e){return Bx.hasLayerViewModule(e)}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){return this.scene?.initialViewProperties?.spatialReference||this.defaultsFromMap?.spatialReference||this.defaultsFromMap?.ready&&this._initialDefaultSpatialReference||null}getSurface(){return this.surface}async validate(){let e=CJ(this.type);const t=Qe("safari");if(t&&t<9&&(e=new fe("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:t})),e!=null)throw $.getLogger(this).warn("#validate()",e.message),e}get _predeterminedViewingMode(){const e=this._isOverridden("viewingMode")?this._get("viewingMode"):this.scene?.initialViewProperties?.viewingMode;return e!=null?Gv(e):null}getSpatialReferenceSupport(e,t){const i=this._predeterminedViewingMode;if(i!=null)return this._validateSpatialReferenceForViewingMode(e,t,i)?{constraints:this._makeSpatialReferenceConstraints(e,t,i)}:null;const r=this._validateSpatialReferenceForViewingMode(e,t,2),s=this._validateSpatialReferenceForViewingMode(e,t,1);return r||s?r&&s?{constraints:this._makeSpatialReferenceConstraints(e,t,null)}:r?{constraints:this._makeSpatialReferenceConstraints(e,t,2)}:{constraints:this._makeSpatialReferenceConstraints(e,t,1)}:null}_validateSpatialReferenceForViewingMode(e,t,i){return!!$v(e,i)&&(t==null||!!sx(t)||(!jh(t)||X_(t,e,i)!=null)&&(!nx(t)||i!==1))}_makeSpatialReferenceConstraints(e,t,i){if(t==null)return[{spatialReference:e,viewingMode:i}];const{isWebMercator:r,isWGS84:s}=e;return sx(t)&&(r||s)?!s||i===2||zb(t.tileInfo,t.fullExtent,e,1)===null?[{spatialReference:e,viewingMode:i},{spatialReference:At.WebMercator,viewingMode:i}]:[{spatialReference:r?At.WGS84:At.WebMercator,viewingMode:i}]:jh(t)||nx(t)||!r&&!s?jh(t)&&r&&i!==1?[{spatialReference:e,viewingMode:i},{spatialReference:At.WGS84,viewingMode:2}]:[{spatialReference:e,viewingMode:i}]:[{spatialReference:e,viewingMode:i},{spatialReference:r?At.WGS84:At.WebMercator,viewingMode:i}]}_validateSpatialReference(e){const t=this.getSpatialReferenceSupport(e)!=null,i=this._predeterminedViewingMode;return t||(i!=null?$.getLogger(this).warnOnce(`Spatial reference defined on view not supported in ${Oy(i)} viewing mode.`):e.isGeographic&&$.getLogger(this).warnOnce("Spatial reference is geographic but not supported.")),t}whenReady(){return new Promise(e=>{this.ready?e(this):this._resolveWhenReady.push(e)})}trackGraphicState(e){if(!e.graphic)return $.getLogger(this).error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;const t=this.getViewForGraphic(e.graphic);let i=null,r=!1;const s=n=>{!r&&n!=null&&"processor"in n&&n.processor?.type==="graphics-3d"&&n.processor.graphicsCore&&(i=n.processor.graphicsCore.trackGraphicState(e))};return t!=null?s(t):this.whenViewForGraphic(e.graphic,{waitForLayer:!0}).then(n=>s(n),()=>{}).catch(()=>{}),Sn(()=>{r=!0,i!=null&&(i.remove(),i=null)})}maskOccludee(e){if(!e)return $.getLogger(this).error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;const t=this.getViewForGraphic(e);let i=null,r=!1;const s=n=>{!r&&n!=null&&uF(n)&&(i=n.maskOccludee(e))};return t!=null?s(t):this.whenViewForGraphic(e,{waitForLayer:!0}).then(n=>s(n),()=>{}).catch(()=>{}),Sn(()=>{r=!0,i!=null&&(i.remove(),i=null)})}getViewForGraphic(e){return e.layer===this?this.graphicsView:e.layer?this.allLayerViews.filter(t=>t.type!=="media-3d").find(t=>t.layer===e.layer):null}graphicChanged(e){this.graphicsView!=null&&this.graphicsView.graphicChanged(e)}async whenViewForGraphic(e,t){return e.layer===this?(await lp(()=>this.graphicsView),this.graphicsView):e.layer&&this.map?t&&t.waitForLayer&&!this.map.allLayers.includes(e.layer)?new Promise((i,r)=>{const s=this.map.allLayers.on("change",n=>{n.added.includes(e.layer)&&(s.remove(),this.whenLayerView(e.layer).then(i,r))})}):this.whenLayerView(e.layer):null}enableFeatureTiles(){const e=Symbol();return this._featureTileTreeClients.add(e),Sn(()=>this._featureTileTreeClients.delete(e))}async _importModule(e,t){const i=new AbortController;this._importControllers.set(e,i),this._updatingChanged();try{const r=await GJ[e]();if(t&&(uA(this),qe(i.signal),await t(i.signal)),this.destroyed)throw Ui();return qe(i.signal),r}catch{return null}finally{this._importControllers.delete(e),this._updatingChanged()}}_abortImport(e){this._importControllers.get(e)?.abort(),this._importControllers.delete(e),this._updatingChanged()}_initBasemapTerrain(){this._set("basemapTerrain",new rT({view:this})),this.elevationProvider.register(0,this.basemapTerrain)}_exitBasemapTerrain(){const{basemapTerrain:e,elevationProvider:t}=this;e&&(this._set("basemapTerrain",null),t.unregister(e),e.destroy())}_initGlobe(){this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new Tr({view:this})),this.addHandles([this.updatingHandles.add(()=>bi.FEATURE_TILE_TREE_SHOW_TILES,e=>{e&&!this._featureTreeDebugger?this.updatingHandles.addPromise(k(()=>le(()=>import("./FeatureTileTree3DDebugger-x3eaKSD9-D-SAT6rW.js"),__vite__mapDeps([488,3,4,200,19,9,7,1,2,8,20,14,466,13,25,5,6,10,11,12,15,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43])),ue([489,1,2,180,19,9,7,8,5,6,20,14,467,13,26,3,4,10,11,12,15,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44]))).then(({FeatureTileTree3DDebugger:t})=>{!this._featureTreeDebugger&&bi.FEATURE_TILE_TREE_SHOW_TILES&&(this._featureTreeDebugger=new t({view:this}))}):e||(this._featureTreeDebugger=Z(this._featureTreeDebugger))},Ve),this.updatingHandles.add(()=>({basemapExtent:this.basemapTerrain?.extent,basemapSpatialReference:this.basemapTerrain?.spatialReference,clippingArea:this.clippingArea,featureTiles:this._featureTiles}),({basemapExtent:e,basemapSpatialReference:t,clippingArea:i,featureTiles:r})=>{if(!r)return;const s=!!e;if(i||s)if(s&&t){const n=e&&t?Up(F4(e,t),this.spatialReference):null;r.filterExtent=i?i.intersection(n):n}else r.filterExtent=i;else r.filterExtent=null},Ve),this.updatingHandles.add(()=>this._featureTileTreeClients.size>0,e=>{e?this.updatingHandles.addPromise(this._ensureFeatureTileTree()):this._featureTiles=Z(this._featureTiles)},Ie)],LP),this.stateManager.init()}async _ensureFeatureTileTree(){if(this._featureTiles||this._importControllers.has("FeatureTileTree3D"))return;const e=(await this.updatingHandles.addPromise(this._importModule("FeatureTileTree3D")))?.FeatureTileTree3D;e&&(this._featureTiles=new e({renderCoordsHelper:this.renderCoordsHelper,pointsOfInterest:this.pointsOfInterest,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}),this._updatingChanged())}_exitTerrain(){this.stateManager.exit(),this.removeHandles(vv),this.removeHandles(LP),this._featureTiles=Z(this.featureTiles),this._set("pointsOfInterest",Z(this.pointsOfInterest)),this._exitBasemapTerrain(),this.state.reset(),this._exitCoordinateSystem()}_initCoordinateSystem(){if(this.spatialReference){const e=this.spatialReference,t=this.state.isGlobal,i=iI(t,e);i!==this.renderSpatialReference&&(this._set("renderCoordsHelper",rI.create(this.state.viewingMode,i)),t||this.addHandles(M(()=>this.basemapTerrain?.extent,r=>{const s=this.renderCoordsHelper.spatialReference;r==null||r[0]===0&&r[1]===0&&r[2]===0&&r[3]===0||!sb(r,this.basemapTerrain.spatialReference,FP,s)||(this.renderCoordsHelper.extent=FP)},Ie),vv),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(Eg/this.renderCoordsHelper.unitInMeters))}else this._set("renderCoordsHelper",null)}_exitCoordinateSystem(){this.removeHandles(vv),this._set("renderCoordsHelper",null)}_updatingChanged(){this.notifyChange("updating")}_updateUpdatingMonitors(e=null){e!=null&&e.type===4||(this.removeHandles("updatingMonitors"),this.allLayerViews.forEach(t=>{t.destroyed||(this.addHandles(M(()=>[t.updating,t.updatingProgress],()=>this._updatingChanged(),Ie),"updatingMonitors"),t.when(()=>this._updatingChanged(),()=>this._updatingChanged()))}),this._updatingChanged())}async _prepareScreenshotOverlay(){this.overlay&&await this.overlay.prepare()}_renderScreenshotOverlay(e,t,i){if(!this.overlay||!this.overlay.hasVisibleItems)return i;const r=e.getContext("2d",{willReadFrequently:!0});return r.putImageData(i,0,0),this.overlay.renderCanvas(e,{disableDecorations:t}),r.getImageData(0,0,i.width,i.height)}_initStage(){const e={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,preserveDrawingBuffer:this.preserveDrawingBufferEnabled,canvas:this.renderCanvas,screenshot:{prepareOverlay:()=>this._prepareScreenshotOverlay(),renderOverlay:(r,s,n)=>this._renderScreenshotOverlay(r,s,n)}},t=new fU(this.state.viewingMode,r=>this.stage.layers.forEach(r),this);this._set("sceneIntersectionHelper",t);const i=L2(this.surface);this._stage=new Ts({view:this,options:e,container:i}),this.notifyChange("stage"),this._updateSlice(),this.addHandles([this.updatingHandles.add(()=>this.qualitySettings.highQualityTransparency,r=>this.stage.renderer.setParameters({highQualityTransparency:r}),Ee),this.on("pointer-move",()=>this.stage?.renderer.resetAnimation()),kP(this.stage.renderView.canvas,"webglcontextlost",r=>{this.fatalError=new fe("webgl-context-lost",r.statusMessage)})],"stage"),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(Eg/this.renderCoordsHelper.unitInMeters),this._set("canvas",this.stage.renderView.canvas)}_exitStage(){this.sceneIntersectionHelper?.destroy(),this._set("sceneIntersectionHelper",null),this._stage=Z(this.stage),this._set("stage",null),this.removeHandles("stage"),this._set("canvas",null)}_initSurface(){this._exitSurface(),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new YU({view:this,resourceController:this._resourceController})}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitTerrain(),this._exitStage())}async _ensureGraphicsView(){if(this.graphicsView||this._importControllers.has("GraphicsView3D")||this.graphics.length===0)return;this.removeHandles("GraphicsView3D");const e=(await this.updatingHandles.addPromise(this._importModule("GraphicsView3D",t=>lp(()=>this.basemapTerrain?.ready,t))))?.default;e&&this._set("graphicsView",new e({view:this,getGraphics:()=>this.graphics})),this._updatingChanged()}_disposeGraphicsView(){this._abortImport("GraphicsView3D"),this.removeHandles("GraphicsView3D"),this.graphicsView&&(this.removeHandles(this.graphicsView.processor.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}_disposeFocusAreasView(){this._abortImport("FocusAreasView"),this.removeHandles("FocusAreasView"),this.focusAreasView=Z(this.focusAreasView)}async _ensureFocusAreasView(e){if(this.focusAreasView||this._importControllers.has("FocusAreasView")||e===0)return;this.removeHandles("FocusAreasView");const t=(await this.updatingHandles.addPromise(this._importModule("FocusAreasView")))?.FocusAreasView;t&&(this.focusAreasView=new t({view:this})),this._updatingChanged()}_startup(){Gv(this.viewingMode)===1&&(this._clippingArea=null),this._initSurface(),this._set("ready",!0),this.addHandles(Ir(()=>this.graphics,"after-changes",()=>this._ensureGraphicsView()),"GraphicsView3D"),this._ensureGraphicsView(),this.addHandles(M(()=>this.map?.focusAreas?.areas.length??0,r=>this._ensureFocusAreasView(r),{initial:!0}),"FocusAreasView");const e=this.scene?.initialViewProperties??null,t=e?.environment;t&&(this._overrideDefaultEnvironmentOnly?MM(this.environment,t):this.environment=this.environment.cloneWithWebsceneEnvironment(t)),this.timeExtent=e?.timeExtent,e?.analyses.applyTo(this),this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect();const i=this._resolveWhenReady;this._resolveWhenReady=[],i.forEach(r=>r(this))}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this._overrideDefaultEnvironmentOnly=!1,this.labeler.dispose(),this._disposeGraphicsView(),this._disposeFocusAreasView(),this._exitSurface(),this._set("ready",!1)}get _defaultToMapOptions(){const e={include:new Set};if(!this.map)return e;this.map.ground&&e.include.add(Lo);for(const t of this.allLayerViews)Yh(t.layer)&&e.include.add(t.uid);return e}get _defaultHitTestOptions(){const e={exclude:new Set};if(!this.map)return e;this.map.ground&&this.map.ground.opacity<1&&e.exclude.add(Lo);for(const t of this.allLayerViews)Yh(t.layer)&&t.layer.opacity<1&&e.exclude.add(t.uid);return e}static{this.type="3d"}static clearStatics(){P9(),dA(),V9(),zF(),sB(),i9(),eU(),G9(),vJ(),T9(),CW(),Vq(),ok(),wk(),k9(),pA(),QQ(),HG(),Kj.cleanupI3SLodHandling(),SI.cleanupTilemapCache(),I3.cleanupViewstate(),rT.cleanupTerrainSurface()}};function wf(e,t){return e!=null&&I4(e.spatialReference,t)?Up(e,t):null}h([d()],Q.prototype,"_userClippingArea",void 0),h([d()],Q.prototype,"_resourceController",void 0),h([d()],Q.prototype,"stage",null),h([d({readOnly:!0})],Q.prototype,"deconflictor",void 0),h([d({readOnly:!0})],Q.prototype,"labeler",void 0),h([d(Dv(su,"analyses"))],Q.prototype,"analyses",void 0),h([d({type:nu,readOnly:!0})],Q.prototype,"animation",null),h([d()],Q.prototype,"animationsEnabled",void 0),h([d({readOnly:!0})],Q.prototype,"basemapTerrain",void 0),h([d({readOnly:!0})],Q.prototype,"overlayManager",null),h([d({readOnly:!0})],Q.prototype,"elevationProvider",void 0),h([d()],Q.prototype,"camera",null),h([d({type:Xr})],Q.prototype,"contentCamera",null),h([d({readOnly:!0})],Q.prototype,"canvas",null),h([d({type:wt})],Q.prototype,"center",null),h([d({type:sr})],Q.prototype,"clippingArea",null),h([d({type:Il,nonNullable:!0})],Q.prototype,"constraints",void 0),h([d({type:sr,readOnly:!0})],Q.prototype,"renderDataExtent",null),h([d({readOnly:!0})],Q.prototype,"tileInfo",null),h([d({type:sr,readOnly:!0})],Q.prototype,"dataExtent",null),h([d({type:sr,readOnly:!0})],Q.prototype,"_groundAndLayersExtent",null),h([d({type:ph})],Q.prototype,"environment",null),h([Ua("environment")],Q.prototype,"castEnvironment",null),h([d({readOnly:!0})],Q.prototype,"environmentManager",void 0),h([d({type:sr})],Q.prototype,"extent",null),h([d({type:Mt})],Q.prototype,"floors",void 0),h([d()],Q.prototype,"screenCenter",null),h([d()],Q.prototype,"frustum",null),h([d({type:Number,readOnly:!0})],Q.prototype,"fullOpacity",void 0),h([d({readOnly:!0})],Q.prototype,"graphicsView",void 0),h([d()],Q.prototype,"analysisViewManager",void 0),h([d()],Q.prototype,"groundView",void 0),h([d({readOnly:!0})],Q.prototype,"layerviewCollections",null),h([d({type:Boolean})],Q.prototype,"initialExtentRequired",null),h([d()],Q.prototype,"defaultsFromMapSettings",null),h([d()],Q.prototype,"interacting",null),h([d()],Q.prototype,"stationary",null),h([d()],Q.prototype,"navigating",null),h([d()],Q.prototype,"map",void 0),h([d()],Q.prototype,"padding",null),h([d({type:Tr,readOnly:!0})],Q.prototype,"pointsOfInterest",void 0),h([d()],Q.prototype,"_featureTiles",void 0),h([d()],Q.prototype,"featureTiles",null),h([d()],Q.prototype,"_featureTreeDebugger",void 0),h([d({constructOnly:!0})],Q.prototype,"deactivatedWebGLExtensions",void 0),h([d({constructOnly:!0})],Q.prototype,"debugWebGLExtensions",void 0),h([d({constructOnly:!0})],Q.prototype,"renderCanvas",void 0),h([d({constructOnly:!0})],Q.prototype,"state",void 0),h([d()],Q.prototype,"screenSizePerspective",void 0),h([d({readOnly:!0})],Q.prototype,"inputManager",void 0),h([d({readOnly:!0})],Q.prototype,"stateManager",void 0),h([d({type:["low","medium","high"]})],Q.prototype,"qualityProfile",null),h([d({type:B3,get(){let e=this._get("qualitySettings");return e||(e=new B3,ig.apply(this.qualityProfile,e)),e}})],Q.prototype,"qualitySettings",void 0),h([d()],Q.prototype,"slice",void 0),h([d({readOnly:!0})],Q.prototype,"typeSpecificPreconditionsReady",null),h([d({readOnly:!0})],Q.prototype,"renderCoordsHelper",void 0),h([d({readOnly:!0})],Q.prototype,"sceneIntersectionHelper",void 0),h([d({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],Q.prototype,"resolution",null),h([d({type:Number})],Q.prototype,"scale",null),h([d({readOnly:!0,type:Number})],Q.prototype,"terrainLevel",null),h([d()],Q.prototype,"heightModelInfo",null),h([d()],Q.prototype,"spatialReference",void 0),h([d({type:Boolean,value:!1})],Q.prototype,"alphaCompositingEnabled",null),h([d({constructOnly:!0})],Q.prototype,"preserveDrawingBufferEnabled",void 0),h([d({type:Boolean})],Q.prototype,"supersampleScreenshotsEnabled",void 0),h([d({readOnly:!0})],Q.prototype,"type",void 0),h([d(),Ua(e=>e instanceof Y5?e:IA(K5,e))],Q.prototype,"ui",void 0),h([d({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.updating","toolViewManager.updating","analysisViewManager.updating","state.updating","textures.updating"]})],Q.prototype,"updating",null),h([d()],Q.prototype,"_updatingObjects",null),h([d()],Q.prototype,"_updatingObjectsWithProgress",null),h([d({type:Number,readOnly:!0,dependsOn:["updating"]})],Q.prototype,"updatingProgress",void 0),h([d({type:["global","local"]})],Q.prototype,"viewingMode",null),h([d({type:jo})],Q.prototype,"viewpoint",null),h([d({readOnly:!0})],Q.prototype,"visibleArea",null),h([d({type:Number})],Q.prototype,"zoom",null),h([d({type:Ql})],Q.prototype,"highlightOptions",null),h([d({readOnly:!0})],Q.prototype,"quality",null),h([d({readOnly:!0})],Q.prototype,"resolutionScale",null),h([d()],Q.prototype,"focusAreasView",void 0),h([d()],Q.prototype,"_defaultToMapOptions",null),h([d()],Q.prototype,"_defaultHitTestOptions",null),Q=_2=h([D("esri.views.SceneView")],Q);const xf=w(),bv=si(),FP=Rt(),GJ={GraphicsView3D:()=>k(()=>le(()=>import("./GraphicsView3D-BCaFUj4d-IymUVp7y.js"),__vite__mapDeps([489,3,4,15,1,2,7,8,6,9,10,12,322,25,5,11,13,14,26,27,19,20,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,62,200,192,69,170,167,87,169,86,166,168,171,172,173,174,175,176,177,178,179,180,181,101,182,183,184,92,185,186,187,91,93,89,94,188,193,194,195,97,196,306,56,275,75,113,218,219,47,48,61,53,54,55,57,51,58,59,60,63,64,68,16,98,276,46,189,190,247,213,18,165,307,280,281,21,22,23,112,191,128,197,198,201,202,203,146,204,205,206,143,207,208,209,210,50,211,212,214,215,141,82,83,84,81,80,70,216,160,131,217,221,226,227,233,234,121,199,220,99,222,223,224,225,79,228,229,230,231,232,235,236])),ue([490,1,2,15,5,6,7,8,4,9,10,12,323,26,3,11,13,14,27,28,19,20,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,63,180,207,70,186,183,88,185,87,182,184,187,188,189,190,191,192,193,194,195,196,197,102,198,199,200,93,201,202,203,92,94,90,95,204,208,209,210,98,211,307,57,276,76,114,232,233,48,49,62,54,55,56,58,52,59,60,61,64,65,69,16,99,277,47,205,206,178,227,18,166,308,281,282,21,22,23,24,113,175,129,122,212,213,214,215,216,217,147,218,219,220,144,221,222,223,224,71,161,51,225,226,228,229,142,83,84,85,82,81,230,132,231,234,100,235,236,237,238,239,80,240,241,242,243,244,245,246,247,248,249,250])),FocusAreasView:()=>k(()=>le(()=>import("./FocusAreasView-tRUpT6rS-BY6xzyQn.js"),__vite__mapDeps([490,3,6,1,2,7,8,4,9,10,351,38,101,27,19,20,14,491,423,420,418,421,422,424,428,425,426,181,69,37,168,233,13,444,167,36,291,306,56,25,5,11,12,15,26,28,29,30,31,32,33,34,35,39,40,41,42,43,192,170,87,169,86,166,171,172,173,174,175,176,177,178,179,180,182,183,184,92,185,186,187,91,93,89,94,188,193,194,195,97,196,414,415,165,227,412,222,131,130,393,385,394,328,413,18,21,16,22,23,112,113,189,190,191,128,197,75,198,200,46,201,202,203,146,51,204,205,206,143,207,208,209,68,210,50,47,48,211,212,213,214,215,141,82,83,84,81,80,70,216,160,217,221,226,234,121,199,218,219,220,98,99,223,224,225,79,228,229,230,231,232,235,236])),ue([491,1,4,5,6,7,8,2,9,10,352,39,102,28,19,20,14,492,424,421,419,422,423,425,429,426,427,197,70,38,184,247,13,445,183,37,292,307,57,26,3,11,12,15,27,29,30,31,32,33,34,35,36,40,41,42,43,44,207,186,88,185,87,182,187,188,189,190,191,192,193,194,195,196,198,199,200,93,201,202,203,92,94,90,95,204,208,209,210,98,211,415,416,166,241,413,236,132,131,394,386,395,329,414,18,21,16,22,23,24,113,114,205,206,175,129,122,52,212,76,213,214,180,47,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,231,232,233,234,99,100,235,237,238,239,80,240,242,243,244,245,246,248,249,250])),FeatureTileTree3D:()=>k(()=>le(()=>import("./FeatureTileTree3D-BvDvMsKe-CUYj04kl.js"),__vite__mapDeps([492,3,6,1,2,7,8,4,9,10,18,20,14,301,167,19,174,171,69,87,172,38,173,170,86,175,180,101,27,166,168,169,176,13,177,36,37,178,179,181,182,183,184,34,11,12,92,185,186,187,91,93,26,89,94,188,213,28,21,16,22,23,112,113,189,190,191,25,5,15,29,30,31,32,33,35,39,40,41,42,43,128,192,193,194,195,97,196,197,75,198,200,46,201,202,203,146,51,204,205,206,143,207,208,209,68,210,50,47,48,211,212,214,215,141,82,83,84,81,80,70,216,160,131,217,221,226,227,233,234,121,199,165,218,219,220,98,99,222,223,224,225,79,228,229,230,231,232,235,236])),ue([493,1,4,5,6,7,8,2,9,10,18,20,14,302,183,19,190,187,70,88,188,39,189,186,87,191,196,102,28,182,184,185,192,13,193,37,38,194,195,197,198,199,200,35,11,12,93,201,202,203,92,94,27,90,95,204,227,29,21,16,22,23,24,113,114,205,206,175,26,3,15,30,31,32,33,34,36,40,41,42,43,44,129,207,208,209,210,98,211,122,52,212,76,213,214,180,47,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,228,229,142,83,84,85,82,81,230,166,132,231,232,233,234,99,100,235,236,237,238,239,80,240,241,242,243,244,245,246,247,248,249,250]))},$J=Q,Rse=Object.freeze(Object.defineProperty({__proto__:null,default:$J},Symbol.toStringTag,{value:"Module"})),WJ=Object.freeze(Object.defineProperty({__proto__:null,CloudsPassParameters:ub,build:_R,cubeMapSize:Uh},Symbol.toStringTag,{value:"Module"})),ZJ=Object.freeze(Object.defineProperty({__proto__:null,NoiseTextureAtlasPassParameters:db,build:yR},Symbol.toStringTag,{value:"Module"})),QJ=Object.freeze(Object.defineProperty({__proto__:null,build:wR},Symbol.toStringTag,{value:"Module"})),XJ=Object.freeze(Object.defineProperty({__proto__:null,build:qD},Symbol.toStringTag,{value:"Module"})),YJ=Object.freeze(Object.defineProperty({__proto__:null,build:mO},Symbol.toStringTag,{value:"Module"})),KJ=Object.freeze(Object.defineProperty({__proto__:null,HighlightBlurDrawParameters:Hb,build:fO},Symbol.toStringTag,{value:"Module"})),JJ=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:Nb,blurSize:jb,build:pO,gridCellPixelSize:Mo,outlineSize:Ep},Symbol.toStringTag,{value:"Module"})),eee=Object.freeze(Object.defineProperty({__proto__:null,build:gO},Symbol.toStringTag,{value:"Module"})),tee=Object.freeze(Object.defineProperty({__proto__:null,build:TO,ribbonlineNumRoundJoinSubdivisions:Ap},Symbol.toStringTag,{value:"Module"})),iee=Object.freeze(Object.defineProperty({__proto__:null,TextureOnlyPassParameters:Bb,build:dO},Symbol.toStringTag,{value:"Module"})),ree=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:Wb,build:OO},Symbol.toStringTag,{value:"Module"})),see=Object.freeze(Object.defineProperty({__proto__:null,build:aE},Symbol.toStringTag,{value:"Module"})),nee=Object.freeze(Object.defineProperty({__proto__:null,ColorizerHillshadeUniforms:fE,ColorizerStretchUniforms:mE,ColorizerUniforms:K_,build:gE},Symbol.toStringTag,{value:"Module"})),aee=Object.freeze(Object.defineProperty({__proto__:null,TerrainPassParameters:ow,build:TE},Symbol.toStringTag,{value:"Module"})),oee=Object.freeze(Object.defineProperty({__proto__:null,build:DE},Symbol.toStringTag,{value:"Module"})),lee=Object.freeze(Object.defineProperty({__proto__:null,AtmosphereCompositingPassParameters:cw,build:EE},Symbol.toStringTag,{value:"Module"})),cee=Object.freeze(Object.defineProperty({__proto__:null,build:AE},Symbol.toStringTag,{value:"Module"})),hee=Object.freeze(Object.defineProperty({__proto__:null,FogPassParameters:hw,build:FE},Symbol.toStringTag,{value:"Module"})),uee=Object.freeze(Object.defineProperty({__proto__:null,CompositingPassParameters:J_,build:kE},Symbol.toStringTag,{value:"Module"})),dee=Object.freeze(Object.defineProperty({__proto__:null,SilhouetteCircle:dw,SimpleAtmospherePassParameters:ey,build:BE},Symbol.toStringTag,{value:"Module"})),pee=Object.freeze(Object.defineProperty({__proto__:null,build:QE},Symbol.toStringTag,{value:"Module"})),mee=Object.freeze(Object.defineProperty({__proto__:null,GlowBlurPassParameters:fw,build:o5},Symbol.toStringTag,{value:"Module"})),fee=Object.freeze(Object.defineProperty({__proto__:null,GlowCompositionPassParameters:gw,build:l5},Symbol.toStringTag,{value:"Module"})),gee=Object.freeze(Object.defineProperty({__proto__:null,HazeCompositingPassParameters:_w,build:c5},Symbol.toStringTag,{value:"Module"})),_ee=Object.freeze(Object.defineProperty({__proto__:null,build:h5},Symbol.toStringTag,{value:"Module"})),yee=Object.freeze(Object.defineProperty({__proto__:null,build:d5},Symbol.toStringTag,{value:"Module"})),vee=Object.freeze(Object.defineProperty({__proto__:null,MagnifierPassParameters:yw,build:p5},Symbol.toStringTag,{value:"Module"})),bee=Object.freeze(Object.defineProperty({__proto__:null,build:m5},Symbol.toStringTag,{value:"Module"})),wee=Object.freeze(Object.defineProperty({__proto__:null,build:f5},Symbol.toStringTag,{value:"Module"})),xee=Object.freeze(Object.defineProperty({__proto__:null,build:g5},Symbol.toStringTag,{value:"Module"})),Cee=Object.freeze(Object.defineProperty({__proto__:null,build:_5},Symbol.toStringTag,{value:"Module"})),See=Object.freeze(Object.defineProperty({__proto__:null,HUDCompositingPassParameters:vw,build:v5},Symbol.toStringTag,{value:"Module"})),Tee=Object.freeze(Object.defineProperty({__proto__:null,OITBlendPassParameters:bw,build:S5},Symbol.toStringTag,{value:"Module"})),Pee=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastVisualizePassParameters:ww,build:M5},Symbol.toStringTag,{value:"Module"})),Mee=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastMaxSamples:Jp,build:P5},Symbol.toStringTag,{value:"Module"})),Ree=Object.freeze(Object.defineProperty({__proto__:null,build:E5},Symbol.toStringTag,{value:"Module"}));export{Ure as $,qre as A,vse as B,Gre as C,zb as D,wb as E,zre as F,Zre as G,uB as H,G_ as I,_q as J,Are as K,hb as L,jre as M,sse as N,rse as O,Ob as P,DD as Q,cB as R,Zp as S,MJ as T,_se as U,bJ as V,Tse as W,Sse as X,mse as Y,aj as Z,Qre as _,Wre as a,YQ as a$,jD as a0,Jre as a1,ID as a2,OD as a3,m7 as a4,XD as a5,aU as a6,Ore as a7,ka as a8,Nn as a9,_J as aA,lB as aB,Mre as aC,Ire as aD,Lre as aE,hB as aF,Qi as aG,bse as aH,dse as aI,RM as aJ,Fj as aK,Rj as aL,Pj as aM,tse as aN,ese as aO,Za as aP,lse as aQ,use as aR,MO as aS,ND as aT,Lc as aU,fj as aV,HN as aW,Vj as aX,cq as aY,vre as aZ,Su as a_,mH as aa,YD as ab,u_ as ac,aZ as ad,Pse as ae,Mse as af,RJ as ag,Cse as ah,GE as ai,xse as aj,yre as ak,_re as al,iO as am,K_ as an,yJ as ao,Sre as ap,tG as aq,Dn as ar,xre as as,ase as at,sa as au,IO as av,_3 as aw,mre as ax,Cre as ay,sb as az,bre as b,Yre as b$,ise as b0,Kj as b1,Gv as b2,DU as b3,N3 as b4,Zm as b5,Fre as b6,H$ as b7,R$ as b8,Jl as b9,zE as bA,$E as bB,YE as bC,HQ as bD,TQ as bE,AY as bF,uw as bG,pn as bH,Gn as bI,Wo as bJ,Zo as bK,xu as bL,e7 as bM,Rre as bN,hse as bO,ose as bP,gj as bQ,mj as bR,AN as bS,d3 as bT,pj as bU,NN as bV,nse as bW,Kre as bX,YN as bY,Ds as bZ,JN as b_,Qa as ba,EH as bb,AH as bc,eO as bd,KD as be,pH as bf,B6 as bg,fre as bh,gre as bi,mD as bj,Ere as bk,$re as bl,kJ as bm,xP as bn,fse as bo,V1 as bp,Jn as bq,eq as br,uq as bs,tq as bt,y_ as bu,H1 as bv,CO as bw,yse as bx,_7 as by,hk as bz,la as c,ZN as c0,$W as c1,$N as c2,WN as c3,Xre as c4,Eh as c5,jj as c6,kj as c7,Bj as c8,GN as c9,wse as ca,BW as cb,Rse as cc,pse as d,gse as e,aO as f,i7 as g,uZ as h,Tre as i,Dp as j,Pre as k,EN as l,ZF as m,_c as n,m3 as o,wre as p,Nre as q,cse as r,Dre as s,fH as t,$_ as u,Bre as v,Hre as w,Vre as x,kre as y,pB as z};
