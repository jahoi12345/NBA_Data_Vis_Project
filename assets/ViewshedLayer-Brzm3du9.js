import{a8 as H,_ as r,m as s,a as T,r as D}from"./jsonMap-Bs3hmeCU.js";import{u as j}from"./Viewshed-BubKguHM.js";import{c as G}from"./Analysis-hnMsq69l.js";import{O as q,c as J,e as S}from"./collectionUtils-yEu3-UXw.js";import{a as z}from"./Cyclical-BLSxUpe7.js";import{s as R,r as A}from"./mathUtils-PIGhLnI9.js";import{l as N,w as P}from"./reactiveUtils-SO2Ko3sy.js";import{z as U}from"./Extent-D4kxmHSf.js";import{Y}from"./projectionUtils-DIbtnzb-.js";import{l as k}from"./MultiOriginJSONSupport-Bd1TKmh_.js";import{b as B}from"./Layer-B6AWeI6O.js";import{b as I}from"./OperationalLayer-D4DfJ3fu.js";import"./featureReferenceUtils-kjJSLhsV.js";import"./vec32-BF0cLBAR.js";import"./Polygon-BUi4eoGW.js";import"./Point-B6yFWNoR.js";import"./reader-DcGs6kKN.js";import"./index-CAyy5ces.js";import"./aaBoundingRect-F1Nk1aID.js";import"./sphere-BiyfUvnN.js";import"./mat4-DMghHRAg.js";import"./vec4f64-DPb6J-GU.js";import"./vector-B05yfH0j.js";import"./mat4f64-q_b6UJoq.js";import"./quatf64-CCm9z-pX.js";import"./vec2f64-rIxtbMRN.js";import"./intersectorUtilsConversions-DntjJfod.js";import"./aaBoundingBox-CVMQtR0c.js";import"./DoubleArray-DExKNiTh.js";import"./HUDIntersectorResult-B_jyrAGm.js";import"./vec42-Cr02Pi7P.js";import"./Intersector-CoyLvWqI.js";import"./SimpleObservable-CvFyr0NA.js";import"./Polyline-CiznIgZG.js";import"./date-IqUzANpt.js";import"./layerContainerType-CSXZNpHb.js";import"./ElevationInfo-DevipqE4.js";import"./lengthUtils-BsZbNiqt.js";import"./unitConversionUtils-BhI4jDV1.js";import"./opacityUtils-DuFH0EC9.js";const E=q.ofType(j);let n=class extends G{constructor(e){super(e),this.type="viewshed",this._extent=null}initialize(){this.addHandles(N(()=>this._computeExtent(),e=>{e.pending==null&&(this._extent=e.extent)},P))}get viewsheds(){return this._get("viewsheds")||new E}set viewsheds(e){this._set("viewsheds",J(e,this.viewsheds,E))}get spatialReference(){for(const e of this.viewsheds)if(e.observer!=null)return e.observer.spatialReference;return null}get extent(){return this._extent}get valid(){return this.viewsheds.every(e=>e.valid)}async waitComputeExtent(){const e=this._computeExtent();e.pending!=null&&await e.pending}_computeExtent(){const{spatialReference:e}=this;if(e==null)return{pending:null,extent:null};const a=this.viewsheds.filter(i=>i.observer!=null),u=a.map(i=>i.observer).toArray(),p=Y(u,e);return p.pending!=null?{pending:p.pending,extent:null}:{pending:null,extent:p.geometries.map((i,d)=>{const x=a.at(d);return i!=null&&x!=null?this._computeViewshedExtent(this.viewsheds.at(d),i):null}).filter(i=>i!=null).reduce((i,d)=>K(i,d),null)}}_computeViewshedExtent(e,a){const{farDistance:u,heading:p,tilt:i,horizontalFieldOfView:d,verticalFieldOfView:x}=e,{spatialReference:$}=a,g=d/2,_=x/2,b=u/$.metersPerUnit,C=[z.normalize(p-g),p,z.normalize(p+g)],m=U.fromPoint(a),f=w=>{const h=C.map(l=>z.normalize(l-w));if(h[0]>h[2]||d===360)return b;const c=h.map(l=>Math.abs(l>180?360-l:l)).reduce((l,v)=>l>v?v:l);return c>90?0:b*Math.cos(R(c))};m.xmax+=f(90),m.xmin-=f(-90),m.ymax+=f(0),m.ymin-=f(180);const y=a.z;if(y!=null){let w=y,h=y;const c=i-90,l=A(c+_,-90,90),v=A(c-_,-90,90),O=$?.isGeographic?u:b;w+=O*V(l),h+=O*V(v);const F=L(_)*O,M=V(c)*F*(1-L(g));i<90&&(w-=M),i>90&&(h-=M),m.zmax=Math.max(w,y),m.zmin=Math.min(h,y)}return m}equals(e){return this===e||super.equals(e)&&H(this.viewsheds.toArray(),e.viewsheds.toArray(),(a,u)=>a.equals(u))}clear(){this.viewsheds.removeAll()}};function K(t,e){return t==null?e:e==null?t:t.union(e)}function L(t){return Math.cos(R(t))}function V(t){return Math.sin(R(t))}r([s({type:["viewshed"]})],n.prototype,"type",void 0),r([s({cast:S,type:E,nonNullable:!0})],n.prototype,"viewsheds",null),r([s({readOnly:!0})],n.prototype,"spatialReference",null),r([s()],n.prototype,"_extent",void 0),r([s()],n.prototype,"extent",null),r([s({readOnly:!0})],n.prototype,"valid",null),n=r([T("esri.analysis.ViewshedAnalysis")],n);let o=class extends I(k(B)){constructor(t){super(t),this.type="viewshed",this.operationalLayerType="ViewshedLayer",this.source=new n,this.opacity=1}initialize(){this.addHandles(N(()=>this.source,(t,e)=>{e!=null&&e.parent===this&&(e.parent=null),t!=null&&(t.parent=this)},P))}async load(){return this.addResolvingPromise(this.source.waitComputeExtent()),this}get spatialReference(){return this.source.spatialReference}get fullExtent(){return this.source.extent}releaseAnalysis(t){this.source===t&&(this.source=new n)}get analysis(){return this.source}set analysis(t){this.source=t}get viewsheds(){return this.source.viewsheds}set viewsheds(t){this.source.viewsheds=t}writeViewsheds(t,e,a,u){e.viewsheds=t.filter(p=>p.valid).toJSON(u)}};r([s({json:{read:!1},readOnly:!0})],o.prototype,"type",void 0),r([s({type:["ViewshedLayer"]})],o.prototype,"operationalLayerType",void 0),r([s({type:n,nonNullable:!0})],o.prototype,"source",void 0),r([s({readOnly:!0})],o.prototype,"spatialReference",null),r([s({readOnly:!0})],o.prototype,"fullExtent",null),r([s({readOnly:!0,json:{read:!1,write:!1,origins:{service:{read:!1,write:!1},"portal-item":{read:!1,write:!1},"web-document":{read:!1,write:!1}}}})],o.prototype,"opacity",void 0),r([s({type:["show","hide"]})],o.prototype,"listMode",void 0),r([s({type:q.ofType(j),json:{write:{ignoreOrigin:!0},origins:{"web-scene":{write:{ignoreOrigin:!0}}}}})],o.prototype,"viewsheds",null),r([D("web-scene","viewsheds")],o.prototype,"writeViewsheds",null),o=r([T("esri.layers.ViewshedLayer")],o);const Ce=o;export{Ce as default};
