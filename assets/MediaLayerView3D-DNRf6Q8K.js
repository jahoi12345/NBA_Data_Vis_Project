const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ManipulatedObject3DMediaElement-CovKpTb-.js","assets/jsonMap-Bs3hmeCU.js","assets/reactiveUtils-SO2Ko3sy.js","assets/UpdatingHandles-D2RI_3Hb.js","assets/Point-BN8RINcc.js","assets/reader-DcGs6kKN.js","assets/index-C-2WWcaK.js","assets/index-Cv2ko1Ob.css","assets/Polygon-BdLNJfwi.js","assets/Extent-Bbnm65bN.js","assets/aaBoundingRect-CrU5VtR_.js","assets/mathUtils-PIGhLnI9.js","assets/projectionUtils-zKDw1yLq.js","assets/SimpleObservable-CvFyr0NA.js","assets/collectionUtils-Dk3LoVuX.js","assets/Polyline-BtUG5wiC.js","assets/EditGeometryOperations-B4UKkiuM.js","assets/vec2f64-rIxtbMRN.js","assets/vec32-CNF8e3LG.js","assets/vec42-CkbV-zLi.js","assets/vec4f64-DPb6J-GU.js","assets/plane-CYSvzg5X.js","assets/vector-CGHTqcz0.js","assets/mat4f64-q_b6UJoq.js","assets/quatf64-CCm9z-pX.js","assets/geometry2dUtils-CYnL6wJ1.js","assets/rotate-C0W4p449.js","assets/curveOperationUtils-CTvChjIC.js","assets/projectPointToVector-CELlCh-8.js","assets/VideoElement-o-7NTmBo.js","assets/imageUtils-DFuQNq2S.js","assets/uuid-Oe6SV2kF.js","assets/resourceExtension-B0hY4a0f.js","assets/sanitizerUtils-BT_8V5US.js","assets/Layer-Ciy6IOGe.js","assets/date-IqUzANpt.js","assets/MultiOriginJSONSupport-Bd1TKmh_.js","assets/MediaElementView-D5BX80Yy.js","assets/normalizeUtilsSync-h_rhGmW4.js","assets/jsonUtils-UGNxUp3z.js","assets/normalizeUtilsCommon-rK4fWGKa.js","assets/screenUtils-BitdhK1O.js","assets/ControlPoint-BQpHYE0H.js","assets/videoUtils-Dwx3AEgj.js","assets/LayerView3D-DhpquAs9.js","assets/ShadowCastClear.glsl-Bhq9MYuW.js","assets/Texture-Cw36TGeQ.js","assets/Indices-D0_UQPPr.js","assets/BufferView-BMlFYMIb.js","assets/sphere-9lseHxo-.js","assets/mat4-n_G6OS58.js","assets/frustum-BypfKDJS.js","assets/Emissions.glsl-B8XKMjLy.js","assets/Color-CERqXxxY.js","assets/enums-B4pqBiXb.js","assets/aaBoundingBox-CtkshuSS.js","assets/DoubleArray-DExKNiTh.js","assets/orientedBoundingBox-VXwBwem5.js","assets/quat-CK9e8_eG.js","assets/spatialReferenceEllipsoidUtils-T3ZM6b8E.js","assets/computeTranslationToOriginAndRotation-Cz93wRWF.js","assets/InterleavedLayout-8W9JN4bc.js","assets/types-BKo2foNY.js","assets/VertexElementDescriptor-BlxU8vCE.js","assets/lengthUtils-Ceo6858g.js","assets/Cyclical-BLSxUpe7.js","assets/projectVectorToVector-DkxXb83V.js","assets/HUDIntersectorResult-D3KkIdaq.js","assets/normalizeUtils-BDt2F_N3.js","assets/utils-DBDpKdtI.js","assets/utils-DQFbn7-c.js","assets/typeUtils-Dk-Jta7H.js","assets/modeUtils-DKmpkquP.js","assets/intl-BvIZ3ldN.js","assets/modeUtils-OCMtRbrJ.css","assets/workers-D8pWeOqp.js","assets/Queue-CYlrXMwB.js","assets/PooledRBush-Dco5QkUp.js","assets/quickselect-QQC62dOK.js","assets/GraphicsCollection-CbLe7TzM.js","assets/Graphic-BiQTZi7k.js","assets/getPopupProvider-DjIxdahS.js","assets/createFeatureId-CVwTD0fV.js","assets/typeUtils-W6WEjFtn.js","assets/lineMarkers-CDwLe3J6.js","assets/PolygonSymbol3D-D50k8Fcq.js","assets/ExtrudeSymbol3DLayer-DSc1ou2x.js","assets/opacityUtils-DuFH0EC9.js","assets/Font-Ct7_LYCJ.js","assets/SimpleFillSymbol-CDawtd9z.js","assets/SimpleMarkerSymbol-BGAFRS9_.js","assets/PictureMarkerSymbol-LudhOruE.js","assets/TextSymbol-DH6PXxVy.js","assets/HeightModelInfo-DRFN7tKf.js","assets/RealisticTree.glsl-IWCjmMLr.js","assets/meshVertexSpaceUtils-DM2fDb9e.js","assets/MeshLocalVertexSpace-oQGry7Qx.js","assets/vec3f32-WCVSSNPR.js","assets/memoryEstimations-Bd726a_p.js","assets/Intersector-BDgm95L3.js","assets/scaleUtils-en5WDx65.js","assets/layerUtils-Ca2TiN3a.js","assets/TilemapCache-obN_L5Xm.js","assets/LRUCache-fy84PBMi.js","assets/TileKey-jKcqhCzg.js","assets/tagSymbols-BPcGfZon.js","assets/asyncUtils-w6KfWU41.js","assets/signal-BX9ezF8a.js","assets/Map-BG-ZPeaW.js","assets/Basemap-BBszaJs6.js","assets/loadAll-B7O5Buv4.js","assets/PortalItem-JZSYzcdX.js","assets/writeUtils-DAWG90I-.js","assets/CollectionFlattener-Cag-8feq.js","assets/persistable-CuCo7Cu3.js","assets/MD5-MtSiOt06.js","assets/multiOriginJSONSupportUtils-C0wm8_Yw.js","assets/PolygonCollection-90Z4vnqc.js","assets/mat4f32-Djp3mnm5.js","assets/TablesMixin-BFz-cIJ-.js","assets/timeZoneUtils-BSc7-7qA.js","assets/ReactiveMap-B0by2bYu.js","assets/Query-CikRiKlY.js","assets/Field-Cm_ZejYW.js","assets/fieldType-DVUzXtk_.js","assets/ElevationQuery-pJqr5aW2.js","assets/TileInfo-Y7H9liCK.js","assets/Scheduler-CNrsbccs.js","assets/constants-D67WmGms.js","assets/floatRGBA-CYO4yRwl.js","assets/labelUtils-BtizwBfq.js","assets/ArcadeExpression-Ddk8yIk3.js","assets/TimeOnly-Du0ClqSA.js","assets/enum-BzLwmiID.js","assets/UnknownTimeZone-B697BDFv.js","assets/FieldsIndex-B72TFK42.js","assets/TileKey-C44YQC4_.js","assets/layerViewUtils-BTa15X3o.js","assets/unitConversionUtils-BEb-Sf7Y.js","assets/vec2f32-CaVKkSa6.js","assets/dehydratedFeatures-Brxjc3JN.js","assets/quantizationUtils-BuQfweOC.js","assets/featureConversionUtils-yVOZE0te.js","assets/OptimizedFeature-CwRGZPwv.js","assets/OptimizedFeatureSet-BR8EEvDc.js","assets/Octree-Bb_mCzwl.js","assets/elevationInfoUtils-DOC7auVy.js","assets/intersectorUtilsConversions-U5KUl8sG.js","assets/DefaultLoadingContext-D5ihlAAW.js","assets/wosrLoader-Bo3AtRk9.js","assets/Version-BtYZEj58.js","assets/axisAngleDegrees-BIah1hxG.js","assets/edgePreprocessing-YzR1XaHD.js","assets/config-Dg972SSE.js","assets/GeometryUtils-BoySfe8Y.js","assets/definitions-Dvg4hMIw.js","assets/WorkerHandle-nVMczE_1.js","assets/colorUtils-Chvbp2-y.js","assets/vec3-B_phcnZY.js","assets/vec33-CWJeyzxV.js","assets/capabilities-Bi6C4OG6.js","assets/mat2d-B5KT8MVP.js","assets/mat2df64-DFLy2zOC.js","assets/SnappingManagerPool-BnDJ-2h5.js","assets/allLayerSnapping-D12oZ67L.js","assets/euclideanLengthMeasurementUtils-Dd_tZ3Tl.js","assets/utils-DTE-xBiC.js","assets/geodeticLengthOperator-CGvLaEl3.js","assets/geodeticCurveType-CirnHLSB.js","assets/automaticAreaMeasurementUtils-BXt-1YKV.js","assets/geodesicAreaMeasurementUtils-DN9_D2hv.js","assets/earcut-D9gy186-.js","assets/automaticLengthMeasurementUtils-Dre-iSuB.js","assets/ImageMaterial.glsl-BKsUALFo.js","assets/TriangleMaterial-DyU1F4o5.js","assets/DefaultLayouts-Bl15_2Jf.js","assets/LayerView-mpGtVKhM.js","assets/highlightOptionsUtils-LdnDZQiA.js","assets/editingTools-BuVr_a-G.js","assets/ElevationInfo-BWnVyl7x.js","assets/quantityFormatUtils-DalIiLRy.js","assets/getDefaultUnitForView-DwTC0lpI.js","assets/TextOverlayItem-BD2PDyJ-.js","assets/SnappingVisualizer3D-3XfQy-Gy.js","assets/ExtendedLineVisualElement-jwbByWTi.js","assets/EngineVisualElement-CkOmELQC.js","assets/VisualElement-By4iq8p4.js","assets/LaserlinePath.glsl-Bs_lKAf8.js","assets/PointVisualElement-CEL7QdWI.js","assets/ShadedColorMaterial.glsl-BVRWw9mq.js","assets/line-CK0BnMAu.js","assets/ColorMaterial.glsl-iVY8sJRd.js","assets/SnappingContext-DCZIwxmt.js","assets/PointSnappingHint-DFp1pBau.js","assets/settings-DiY__ZWp.js","assets/lineStippleUtils-CCavR4OV.js","assets/OutlineVisualElement-eIow42DI.js","assets/line-BWLsbDhz.js","assets/triangulationUtils-nC-pDh1J.js","assets/deduplicate-Lzwo1kX7.js","assets/VerticesVisualElement-OZJDLt9Y.js","assets/SelectedVertexTooltipInfo-Cpmdlrjs.js","assets/SketchTooltipInfo-BLL27XaA.js","assets/MeshTransform-CvcT8cWk.js","assets/a11yUtils-B9mR-UhZ.js","assets/angularMeasurementUtils-C4Sm3V2r.js","assets/TooltipInfoWithCoordinates-BTo8UQ9O.js","assets/editPlaneUtils-DkG0bkG4.js","assets/GraphicsLayer-Q6w67hlG.js","assets/BlendLayer-DdoZXYgY.js","assets/layerContainerType-CSXZNpHb.js","assets/jsonUtils-CnXU3mjx.js","assets/ScaleRangeLayer-DQr2T3Hh.js","assets/dehydratedFeatureComparison-OYwn4uut.js","assets/createUtils-NnwyCBTL.js","assets/distanceOperator-BbejHx0E.js","assets/Point2D-CMz7woHH.js","assets/Distance2DCalculator-CXhBP-8I-BMMI87Nn.js","assets/ProjectionTransformation-PJc9H7Gq.js","assets/Envelope2D-mFnl8dXR.js","assets/Transformation2D-CrydmBdC.js","assets/SimpleGeometryCursor-B92kdZ15.js","assets/OperatorDefinitions-DP7_WWTp.js","assets/apiConverter-HTBxo72t.js","assets/jsonConverter-Dk2FSxYW.js","assets/simplifyOperator--XeIF_nM.js","assets/operatorSimplify-5A_MmN4K.js","assets/InteractiveToolBase-DYdTOPhs.js","assets/SketchOptions-Dguq2sp8.js","assets/diffUtils-CvuzActy.js","assets/SnappingDragPipelineStep-COkB-gjg.js","assets/SnappingOperation-ClIdnPwp.js","assets/IViewEvents-BY7m6FHR.js","assets/MoveManipulation-beyqaXdj.js","assets/dragEventPipeline3D-D_wkf_Q_.js","assets/TranslateTooltipInfo-ktO9T3Y-.js","assets/utils-DLXV1Jpi.js","assets/cimSymbolUtils-DOGwV0lV.js","assets/utils-DX2muIr3.js","assets/SlicePlaneMaterial.glsl-D1xrJL8Z.js","assets/sliceToolConfig-BnawSSVt.js","assets/Factory-ZQZ22k6R.js","assets/RotateManipulator-CPb_6EG7.js","assets/ExtentScaleTooltipInfo-ndHz92_7.js","assets/GraphicManipulator-B0mRSd2f.js","assets/defaults-Lh5xiowT.js","assets/defaultsJSON-GKolV7NZ.js"])))=>i.map(i=>d[i]);
import{l as A,ah as L,n as H,ac as z,V as v,u as W,_ as r,m as a,a as E,b9 as F,aC as q,a7 as B,s as K}from"./jsonMap-Bs3hmeCU.js";import{i as Z,p as J}from"./MediaElementView-D5BX80Yy.js";import{h as O,l as G,w as U,a as $}from"./reactiveUtils-SO2Ko3sy.js";import{F as N,a1 as Q,a as X}from"./Polygon-BdLNJfwi.js";import{c as Y}from"./aaBoundingRect-CrU5VtR_.js";import{l as ee}from"./LayerView3D-DhpquAs9.js";import{_ as x}from"./index-C-2WWcaK.js";import{s as te}from"./mathUtils-PIGhLnI9.js";import{F as I}from"./Point-BN8RINcc.js";import{M as ie}from"./mat2d-B5KT8MVP.js";import{e as se}from"./mat2df64-DFLy2zOC.js";import{n as oe}from"./vec2f64-rIxtbMRN.js";import{h as re}from"./UpdatingHandles-D2RI_3Hb.js";import{g as ne,t as ae}from"./EditGeometryOperations-B4UKkiuM.js";import{ak as le,al as h,a8 as D,B as T,h as de}from"./ShadowCastClear.glsl-Bhq9MYuW.js";import{a as he}from"./SnappingManagerPool-BnDJ-2h5.js";import{u as ce}from"./automaticAreaMeasurementUtils-BXt-1YKV.js";import{c as pe}from"./automaticLengthMeasurementUtils-Dre-iSuB.js";import{t as R}from"./orientedBoundingBox-VXwBwem5.js";import{p as me,M as ue,m as _e}from"./Texture-Cw36TGeQ.js";import{g as ge}from"./ImageMaterial.glsl-BKsUALFo.js";import{d as ye}from"./LayerView-mpGtVKhM.js";import{r as fe}from"./highlightOptionsUtils-LdnDZQiA.js";import{t as ve}from"./layerViewUtils-BTa15X3o.js";class we extends ne{constructor(t,i,s){super(t,i),this._updateControlPoints=s,this.editSourcePoints=!1}updateVertices(t,i,s=1){return this._apply(new Ee(this.data,t,i,this.editSourcePoints,this._updateControlPoints),s)}}class Ee extends ae{constructor(t,i,s,o,d){super(t,i,s),this._editSourcePoints=o,this._updateControlPoints=d}_notifyChanges(t){super._notifyChanges(t),this._updateControlPoints(this._editSourcePoints)}canAccumulate(t){return this._editSourcePoints===t._editSourcePoints&&super.canAccumulate(t)}}const C=Symbol(),b=Symbol(),j=1,Te=10;let c=class extends A{get editSourcePoints(){return!!this.options?.reshapeOptions.editSourcePoints!==this._isEditSourcePointsToggled}get updating(){return this._updatingHandles.updating}get _preferredInteractionTool(){return this.options?.tool??"transform"}get _toolType(){switch(this._preferredInteractionTool){case"transform":return"transform-3d";case"reshape":return"reshape-3d"}}get _validatedSelectedElement(){const e=this.selectedElement;if(!e)return null;const{layer:{source:t}}=this;return t?"hasElement"in t?t.hasElement(e)?e:null:t===e?e:null:null}constructor(e){super(e),this.enabled=!1,this._isEditSourcePointsToggled=!1,this._updatingHandles=new re,this._isOpacityToggled=!1,this._factor=j,this._tool=null,this._object=null,this._createToolAbortController=null,this._onPointerMove=L(async t=>{const i=await this._updatingHandles.addPromise(this._findElementAtScreenPoint(t));this.destroyed||(this.removeHandles(b),i&&i!==this.selectedElement&&this.addHandles(this.view.acquireCursor("pointer","high"),b))}),this._tmpMat2=se(),this._tmpVec2=oe()}destroy(){this._createToolAbortController=H(this._createToolAbortController)}initialize(){this.addHandles([z(this._updatingHandles),this._updatingHandles.add(()=>this.enabled,e=>this._enableDisable(e),O),this._updatingHandles.add(()=>this._preferredInteractionTool,e=>this._preferredInteractionToolChanged(e))])}_enableDisable(e){if(!e)return void this.removeHandles(C);this._dynamicImports();const{view:t}=this,i=new le;i.add(h.undo,()=>{this._object?.operations?.undo(),this._object?.emit("modified-externally")}),i.add(h.redo,()=>{this._object?.operations?.redo(),this._object?.emit("modified-externally")}),i.addToggle(h.preserveAspectRatio,s=>{this._tool?.type==="transform-3d"&&(this._tool.preserveAspectRatio=s.type==="key-down")}),i.addToggle(h.editSourcePoints,s=>{this._tool?.type==="reshape-3d"&&(this._isEditSourcePointsToggled=s.type==="key-down")}),i.addToggle(h.rotateIncrements,s=>{this._tool?.type==="transform-3d"&&(this._tool.snapRotation=s.type==="key-down")}),i.add(h.toggleOpacity,()=>{const s=this._object?.element;s&&(s.opacity*=this._isOpacityToggled?2:.5,this._isOpacityToggled=!this._isOpacityToggled)}),i.add(h.moveUp,()=>this._move(0,this._factor)),i.add(h.moveDown,()=>this._move(0,-this._factor)),i.add(h.moveRight,()=>this._move(this._factor,0)),i.add(h.moveLeft,()=>this._move(-this._factor,0)),i.addToggle(h.factorModifier,s=>this._factor=s.type==="key-down"?Te:j),this._isOpacityToggled=!1,this.addHandles([i.register(t,D.TOOL),v(()=>{this._isOpacityToggled&&this.selectedElement&&(this.selectedElement.opacity*=2,this._isOpacityToggled=!1)}),t.on("immediate-click",s=>this._onClick(s),D.TOOL),t.on("pointer-move",s=>this._onPointerMove(s).catch(()=>{}),D.TOOL),this._updatingHandles.add(()=>this._validatedSelectedElement,(s,o)=>{o&&s!==o&&this._isOpacityToggled&&(o.opacity*=2,this._isOpacityToggled=!1),this._selectedElementChanged(s)},O),v(()=>{this.removeHandles(b),this._removeTool()})],C)}async _onClick(e){await this._updatingHandles.addPromise(e.defer(async()=>{const t=await this._findElementAtScreenPoint(e);this.destroyed||(t&&e.stopPropagation(),this.selectedElement=t,this.selectedElement&&this.removeHandles(b))}))}async _selectedElementChanged(e){e?.georeference?this._object?.element!==e&&await this._updatingHandles.addPromise(this._recreateTool()):this._removeTool()}async _recreateTool(){this._createToolAbortController=H(this._createToolAbortController),this._removeTool();const e=this._validatedSelectedElement;if(!e)return;const t=new AbortController;this._createToolAbortController=t;const{ManipulatedObject3DMediaElement:i,ExtentTransformTool:s,ReshapeTool3D:o,automaticAreaMeasurementUtils:d,automaticLengthMeasurementUtils:n}=await this._dynamicImports();if(t.signal.aborted)return;const{view:l,layer:p,_toolType:m}=this;switch(this._object=new i({view:l,layer:p,element:e,tool:this._preferredInteractionTool}),m){case"transform-3d":{this._tool=new s({view:l,object:this._object,automaticLengthMeasurementUtils:n});const u=l.inputManager;u.isModifierKeyDown(h.rotateIncrements.key)&&(this._tool.snapRotation=!0),u.isModifierKeyDown(h.preserveAspectRatio.key)&&(this._tool.preserveAspectRatio=!0)}break;case"reshape-3d":{const u=he(l),{snappingManager:M}=u;this._tool=new o({view:l,object:this._object,enableMidpoints:!1,enableZShape:!1,snappingManager:M,enableMoveObject:!1,autoHideManipulators:!0,enableDeleteVertices:!1,sketchOptions:{tooltips:{enabled:!0,inputEnabled:!0,visibleElements:{area:!1}}},automaticAreaMeasurementUtils:d,automaticLengthMeasurementUtils:n}),this.addHandles([u,G(()=>({editSourcePoints:this.editSourcePoints,operations:this._object?.operations}),y=>{y.operations instanceof we&&(y.operations.editSourcePoints=y.editSourcePoints)},U)],this._tool)}}this.addHandles([v(()=>{this._object=W(this._object),this._tool&&(l.tools.remove(this._tool),this._tool=null)})],this._tool),l.addAndActivateTool(this._tool)}_preferredInteractionToolChanged(e){const{_tool:t}=this;if(!t)return;if(this._toolType!==t.type)return void this._updatingHandles.addPromise(this._recreateTool());const{_object:i}=this;i&&(i.tool=e)}async _dynamicImports(){const[{ManipulatedObject3DMediaElement:e},{ExtentTransformTool:t,ReshapeTool3D:i},s,o]=await Promise.all([x(()=>import("./ManipulatedObject3DMediaElement-CovKpTb-.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177])),x(()=>import("./editingTools-BuVr_a-G.js"),__vite__mapDeps([178,1,157,53,11,19,8,9,4,5,6,7,10,20,2,18,14,13,146,138,64,35,179,41,165,106,12,15,66,28,34,122,39,71,123,124,45,46,23,47,48,17,49,50,22,24,51,21,52,54,55,56,57,58,59,60,61,62,63,65,67,68,40,69,70,43,72,73,31,33,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,3,107,108,109,110,111,112,113,114,115,116,32,117,118,119,120,121,125,126,127,128,129,130,131,132,133,134,135,136,137,139,140,141,142,143,144,145,147,148,149,150,151,152,153,154,155,156,158,159,160,30,166,25,167,168,180,181,182,183,184,185,186,187,188,189,190,191,174,192,193,194,195,196,197,198,171,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,161,162,227,16,26,27,228,229,230,231,232,233,234,235,236,237,238,239,240,175,241,242,173,243,244,245,246])),ce(),pe()]);return{ManipulatedObject3DMediaElement:e,ExtentTransformTool:t,ReshapeTool3D:i,automaticAreaMeasurementUtils:s,automaticLengthMeasurementUtils:o}}async _findElementAtScreenPoint(e){const t=(await this.view.hitTest(e,{include:[this.layer]})).results[0];return t?.type==="media"?t.element:null}_removeTool(){this._tool&&this.removeHandles(this._tool)}_move(e,t){const{view:i,_object:s}=this,o=s?.operations;if(!o)return;const d=i.overlayPixelSizeInMapUnits(i.pointsOfInterest.focus.location)*I(i.spatialReference)/I(o.data.spatialReference),{_tmpMat2:n,_tmpVec2:l}=this,p=ie(n,te(360-this.view.camera.heading)),m=N(l,d*e,d*t);Q(m,m,p),o.move(m[0],m[1],0),s.emit("modified-externally")}};r([a({constructOnly:!0})],c.prototype,"view",void 0),r([a({constructOnly:!0})],c.prototype,"layer",void 0),r([a()],c.prototype,"selectedElement",void 0),r([a()],c.prototype,"enabled",void 0),r([a()],c.prototype,"options",void 0),r([a()],c.prototype,"editSourcePoints",null),r([a()],c.prototype,"_isEditSourcePointsToggled",void 0),r([a()],c.prototype,"updating",null),r([a()],c.prototype,"_preferredInteractionTool",null),r([a()],c.prototype,"_validatedSelectedElement",null),c=r([E("esri.views.3d.layers.support.MediaLayerInteraction")],c);let w=class extends A{constructor(e){super(e),this.editSourcePoints=!1}};r([a()],w.prototype,"editSourcePoints",void 0),w=r([E("esri.views.3d.layers.support.MediaLayerInteractionOptions.ReshapeOptions")],w);let g=class extends A{constructor(t){super(t),this.tool="transform",this.reshapeOptions=new w}};r([a()],g.prototype,"tool",void 0),r([a({type:w})],g.prototype,"reshapeOptions",void 0),g=r([E("esri.views.3d.layers.support.MediaLayerInteractionOptions")],g);const be=e=>{const t=e;let i=class extends t{constructor(...s){super(...s),this.layer=null,this.interactive=!1,this.interactionOptions=new g,this.selectedElement=null}highlight(s,o){throw new Error("missing implementation")}};return r([a()],i.prototype,"layer",void 0),r([a()],i.prototype,"interactive",void 0),r([a({type:g})],i.prototype,"interactionOptions",void 0),r([a()],i.prototype,"selectedElement",void 0),i=r([E("esri.views.layers.MediaLayerView")],i),i};let _=class extends ee(be(ye)){get interactive(){return this._interaction.enabled}set interactive(e){this._interaction&&(this._interaction.enabled=e)}get selectedElement(){return this._interaction.selectedElement}set selectedElement(e){this._interaction&&(this._interaction.selectedElement=e)}get visibleAtCurrentScale(){return ve(this.layer.effectiveScaleRange,this.view.scale)}get usedMemory(){return Array.from(this._renderElements.values()).reduce((e,t)=>e+(t.getRenderData()?.texture.usedMemory??0),0)}constructor(e){super(e),this.type="media-3d",this.drapeSourceType=1,this.updatePolicy=1,this.ignoresMemoryFactor=!0,this.unloadedMemory=0,this._uidToElement=new Map,this._highlightedElements=new Map,this._elementsInHighlightedId=new Map,this._renderElements=new Map,this._lastDrapingExtent=null,this._update=L(async(s,o,d)=>{const n=await this._collectMediaElements(s,o,d);this._synchronizeRenderElements(n)},0);const{view:t,layer:i}=e;this._interaction=new c({view:t,layer:i}),this.addHandles(G(()=>this.interactionOptions,s=>this._interaction.options=s,U))}initialize(){const{view:e,layer:t}=this;this._renderer=e.overlayManager.registerGeometryDrapeSource(this);const i=()=>this._updateWithLastDrapingExtent();this.addHandles([v(()=>e.overlayManager.unregisterDrapeSource(this)),$(()=>t.effectiveSource,"change",i),$(()=>t.effectiveSource,"refresh",i)]),this._updatingHandles.add(()=>this.suspended,i)}destroy(){this._synchronizeRenderElements(new Set)}setDrapingExtent(e,t){this._lastDrapingExtent={overlays:e,spatialReference:t},this._updateWithLastDrapingExtent()}getHit(e){const t=this._uidToElement.get(e);return t?{type:"media",element:t,layer:this.layer}:null}highlight(e,t){const i=fe(t),s=new me(i),o=F(e)?Array.from(e):[e];this._elementsInHighlightedId.set(s,o);for(const d of o){const n=this._highlightedElements.get(d);n?n.add(s):this._highlightedElements.set(d,new Set([s]));const l=this._renderElements.get(d)?.getRenderData();l&&(l.renderGeometry.geometry.addHighlight(s),this._renderer.modifyGeometries([l.renderGeometry],8))}return v(()=>{const d=this._elementsInHighlightedId.get(s);if(d){for(const n of d){const l=this._highlightedElements.get(n);if(!l)continue;l.delete(s);const p=this._renderElements.get(n)?.getRenderData();p&&(p.renderGeometry.geometry.removeHighlight(s),this._renderer.modifyGeometries([p.renderGeometry],8)),l.size===0&&this._highlightedElements.delete(n)}this._elementsInHighlightedId.delete(s)}})}isUpdating(){return super.isUpdating()||this._interaction.updating}_updateWithLastDrapingExtent(){if(this._lastDrapingExtent==null||this.suspended)return void(this._renderer&&this._synchronizeRenderElements(new Set));const{overlays:e,spatialReference:t}=this._lastDrapingExtent;this._updatingHandles.addPromise(this._update(e,t).catch(()=>{}))}async _collectMediaElements(e,t,i){const s=this.layer.effectiveSource;return s==null?new Set:new Set((await Promise.all(e.map(o=>s.queryElements(Y(o.extent,t),{signal:i})))).flat())}_synchronizeRenderElements(e){this._synchronizeRenderElementsRemove(e),this._synchronizeRenderElementsAdd(e)}_synchronizeRenderElementsRemove(e){this._renderElements.forEach((t,i)=>{e.has(i)||(this._removeElement(i,t),this.emit("element-render-changed",{element:i}))})}_synchronizeRenderElementsAdd(e){for(const t of e)this._renderElements.has(t)||this._createRenderElement(t)}_removeElement(e,t){this._destroyRenderData(e,t),this._renderElements.delete(e),this._uidToElement.delete(e.uid),t.handle.remove()}_createRenderElement(e){const t=new Z({spatialReference:this.view.spatialReference,element:e}),i=new Me(q([this._updatingHandles.add(()=>e.opacity,s=>i.getRenderData()?.material.setParameters({opacity:s})),this._updatingHandles.add(()=>t.coords,()=>{i.data?this._updateGeometry(t,i):this._initializeRenderData(t,i)}),this._updatingHandles.add(()=>e.content,()=>this._initializeRenderData(t,i)),z(t)]));this._renderElements.set(e,i),this._uidToElement.set(e.uid,e),this._updatingHandles.addPromise(e.load().catch(()=>{})),this._initializeRenderData(t,i)}_initializeRenderData(e,t){const{coords:i,element:s}=e,{contentWidth:o,contentHeight:d}=s;if(i==null||s.content==null)return void this._destroyRenderData(s,t);if(t.data)return;const n=this._createTexture(s.content),l=n.load(this.view.stage.renderView.renderingContext),p=()=>{if(!n.loaded)return;this.view.stage.addTexture(n);const m=new ge({draped:!0,texture:n,opacity:s.opacity,perspectiveInterpolation:!0}),u=this._getPositionAttributeArray(i),M=[0,0,1,0,1,1,0,1],y=this._getPerspectiveDivideAttributeArray(u,o,d),P=[0,1,2,0,2,3],k=new _e(m,[["position",new R(u,P,3,!0)],["uv0",new R(M,P,2,!0)],["perspectiveDivide",new R(y,P,1,!0)]]),S=new de(k,{layerViewUid:this.uid,graphicUid:s.uid});this._highlightedElements.get(s)?.forEach(V=>S.geometry.addHighlight(V)),this._renderer.addGeometries([S],0),t.data=new Pe(S,n,m),this.emit("element-render-changed",{element:s})};B(l)?(t.data=n,this._updatingHandles.addPromise(l),l.then(p).catch(()=>n.dispose())):p()}_updateGeometry(e,t){const{coords:i,element:s}=e;if(i==null||s.content==null)return void this._destroyRenderData(s,t);const o=t.getRenderData();if(!o)return;const d=this._getPositionAttributeArray(i);o.renderGeometry.geometry.setAttributeData("position",d);const n=this._getPerspectiveDivideAttributeArray(d,s.contentWidth,s.contentHeight);o.renderGeometry.geometry.setAttributeData("perspectiveDivide",n),o.renderGeometry.geometry.invalidateBoundingInfo(),this._renderer.modifyGeometries([o.renderGeometry],2),this.emit("element-render-changed",{element:s})}_getPositionAttributeArray(e){const[t,i,s,o]=e.rings[0];return[t[0],t[1],T,o[0],o[1],T,s[0],s[1],T,i[0],i[1],T]}_getPerspectiveDivideAttributeArray(e,t,i){J(f,[0,0,t,0,t,i,0,i],[e[0],e[1],e[3],e[4],e[6],e[7],e[9],e[10]]);const s=f[6]/f[8]*t,o=f[7]/f[8]*i;return[1,1+s,1+s+o,1+o]}_destroyRenderData(e,t){const i=t.data;if(i==null)return;if(t.data=null,"dispose"in i)return void i.dispose();const s=i.texture;s.unload(),this.view.stage.removeTexture(s),this._renderer.removeGeometries([i.renderGeometry],2),this.emit("element-render-changed",{element:e})}_createTexture(e){const t=e instanceof HTMLImageElement?e.naturalWidth:e.width,i=e instanceof HTMLImageElement?e.naturalHeight:e.height;if("getFrame"in e)throw new K("media-layer-view-3d","animation is not supported");return new ue(e,{wrap:{s:33071,t:33071},preMultiplyAlpha:!0,width:t,height:i,mipmap:!0,updateCallback:()=>this.view.overlayManager.requestRender()})}get test(){}};r([a({readOnly:!0})],_.prototype,"type",void 0),r([a()],_.prototype,"layer",void 0),r([a()],_.prototype,"interactive",null),r([a()],_.prototype,"selectedElement",null),r([a({readOnly:!0})],_.prototype,"visibleAtCurrentScale",null),_=r([E("esri.views.3d.layers.MediaLayerView3D")],_);const f=X();class Me{constructor(t){this.handle=t}getRenderData(){return this.data&&"type"in this.data&&this.data.type==="RenderData"?this.data:null}}class Pe{constructor(t,i,s){this.renderGeometry=t,this.texture=i,this.material=s,this.type="RenderData"}}const Se=_,Ye=Object.freeze(Object.defineProperty({__proto__:null,default:Se},Symbol.toStringTag,{value:"Module"}));export{Ye as M,we as i};
