const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/Popup-BcZl2Ty0.js","assets/jsonMap-Bs3hmeCU.js","assets/reactiveUtils-SO2Ko3sy.js","assets/getPopupProvider-mckaq9Ri.js","assets/collectionUtils-CB98pReO.js","assets/index-CB_zX-aI.js","assets/index-DJhoxO8W.css","assets/Point-62ir3Nzl.js","assets/reader-DcGs6kKN.js","assets/Extent-Cs-ESnE1.js","assets/SimpleObservable-CvFyr0NA.js","assets/lengthUtils-Cm-zragw.js","assets/date-IqUzANpt.js","assets/Color-CERqXxxY.js","assets/mathUtils-PIGhLnI9.js","assets/Layer-BLV7fz0K.js","assets/intl-BIQN36K8.js","assets/throttle-D_a5zHdu.js","assets/signal-BX9ezF8a.js","assets/Polygon-BbQMC1ht.js","assets/aaBoundingRect-DfeeUq5j.js","assets/modeUtils-BF30GgRz.js","assets/uuid-Oe6SV2kF.js","assets/sanitizerUtils-BT_8V5US.js","assets/modeUtils-OCMtRbrJ.css","assets/substitute-Cb1-v8SP.js","assets/Graphic-CkB18CDi.js","assets/jsonUtils-alsySR4T.js","assets/Polyline-CUSonZ4c.js","assets/typeUtils-BR_JAZOz.js","assets/createFeatureId-CVwTD0fV.js","assets/typeUtils-D0MaDvT3.js","assets/lineMarkers-CDwLe3J6.js","assets/PolygonSymbol3D-Dla3O-pf.js","assets/ExtrudeSymbol3DLayer-DSc1ou2x.js","assets/screenUtils-BitdhK1O.js","assets/opacityUtils-DuFH0EC9.js","assets/aaBoundingBox-DO0Hqciy.js","assets/DoubleArray-DExKNiTh.js","assets/mat4f64-q_b6UJoq.js","assets/Font-BYMGzku7.js","assets/SimpleFillSymbol-CDawtd9z.js","assets/SimpleMarkerSymbol-BGAFRS9_.js","assets/PictureMarkerSymbol-CjQJkY_m.js","assets/TextSymbol-Ck-WHI2u.js","assets/AttachmentInfo-f2OvCjJR.js","assets/featureLayerUtils-r2Op4W1w.js","assets/asyncUtils-w6KfWU41.js","assets/Field-Cm_ZejYW.js","assets/fieldType-DVUzXtk_.js","assets/featureQueryAll-Cw2UHvuc.js","assets/Query-98igen-k.js","assets/layerUtils-4EQ207Ij.js","assets/SimpleRenderer-5ThgQgxc.js","assets/commonProperties-DBhvddXj.js","assets/colorRamps-DswZzxkO.js","assets/ColorStop-De5gQTjr.js","assets/visualVariableUtils-DKoaWDyb.js","assets/jsonUtils-zHoDJTQx.js","assets/defaults3D-MaZ_y6xl.js","assets/defaults-DFod6HKh.js","assets/defaultsJSON-GKolV7NZ.js","assets/UniqueValueRenderer-BpF5Qj_l.js","assets/diffUtils-BrvFna5l.js","assets/RendererLegendOptions-BMWz4oAf.js","assets/styleUtils-ByZgnz1l.js","assets/NormalizationBinParametersMixin-BK9wNkI3.js","assets/featureUtils-CMCAXVyw.js","assets/utils-CPKbo3Q6.js","assets/mat4f32-Djp3mnm5.js","assets/mat4-Bjnccznk.js","assets/timeZoneUtils-BSc7-7qA.js","assets/a11yUtils-B9mR-UhZ.js","assets/utils-95OCmOO6.js","assets/cimSymbolUtils-DOGwV0lV.js","assets/utils-DX2muIr3.js","assets/LRUCache-fy84PBMi.js","assets/typeUtils-DN-3AzC7.js","assets/ClassBreaksRenderer-C75KYGj1.js","assets/DictionaryScriptEvaluator-c6Io6Ycc.js","assets/Version-BtYZEj58.js","assets/FieldsIndex-DoTtx8Ak.js","assets/UnknownTimeZone-B697BDFv.js","assets/ArcadeExpression-BKKJxDUn.js","assets/TimeOnly-DbBUn0Ig.js","assets/enum-BzLwmiID.js","assets/heatmapUtils-vMzV0liR.js","assets/vec42-fTNpW1Xv.js","assets/vec4f64-DPb6J-GU.js","assets/executeQueryJSON-BHqk-EcW.js","assets/utils-uBZTDKaj.js","assets/query-B4e6FWQz.js","assets/normalizeUtils-BTK6arYa.js","assets/Cyclical-BLSxUpe7.js","assets/normalizeUtilsCommon-BRJdiLvx.js","assets/utils-tSEVTzcz.js","assets/pbfQueryUtils-8DoYo8im.js","assets/pbf-2SIhMekG.js","assets/memoryEstimations-Bd726a_p.js","assets/OptimizedFeature-CwRGZPwv.js","assets/OptimizedFeatureSet-BR8EEvDc.js","assets/queryZScale-Ce2YyrBG.js","assets/projectionUtils-ClsoIho7.js","assets/FeatureSet-CIJQiuNV.js","assets/shared-CUljbPJt.js","assets/isImageryGraphicOrigin-Ccuhb4eK.js","assets/isImageryTileGraphicOrigin-ZR-gBf9D.js","assets/FeatureLayer-DZdbWewS.js","assets/MultiOriginJSONSupport-Bd1TKmh_.js","assets/layerContainerType-CSXZNpHb.js","assets/FormTemplate-DilvQ64k.js","assets/GraphicOrigin-uE6TDXc9.js","assets/isFeatureGraphicOrigin-YA2hudPe.js","assets/workers-VgzaPqUK.js","assets/Queue-CYlrXMwB.js","assets/editsZScale-CM9fN8nT.js","assets/APIKeyMixin--YGbad8e.js","assets/ArcGISService-CGB_UW-P.js","assets/BlendLayer-CEHruVkx.js","assets/jsonUtils-Bref6UUL.js","assets/CustomParametersMixin-Dshqz1Zp.js","assets/DisplayFilteredLayer-D1-cJpph.js","assets/scaleUtils-m8EJvm5m.js","assets/displayFilterUtils-BZaoiQbg.js","assets/EditBusLayer-EUT9qPID.js","assets/FeatureEffectLayer-D6-JF81o.js","assets/FeatureEffect-C_eW4sk8.js","assets/FeatureFilter-SiAuz7rY.js","assets/FeatureLayerBase-DeuoM54i.js","assets/HeightModelInfo-CNRqlD7K.js","assets/OperationalLayer-DydUunj4.js","assets/ElevationInfo-DqQyVbKu.js","assets/unitConversionUtils-BSQ4LGUO.js","assets/LayerFloorInfo-CP8QzUOB.js","assets/multiLayerServiceUtils-CGi2gXP5.js","assets/Relationship-Cc_bkgMk.js","assets/serviceCapabilitiesUtils-BWaSbTTJ.js","assets/infoFor3D-DhzudQro.js","assets/portalItemUtils-BnUKAdwm.js","assets/FeatureReductionLayer-B9IButuJ.js","assets/FeatureReductionSelection-Du7o8OIG.js","assets/labelingInfo-CzkGBFOy.js","assets/labelUtils-BtizwBfq.js","assets/jsonUtils-DV232abi.js","assets/MD5-MtSiOt06.js","assets/OrderedLayer-DQAUgUTV.js","assets/PortalLayer-DipxjGHJ.js","assets/PortalItem-QIiqvhel.js","assets/RefreshableLayer-jgS-4ToC.js","assets/ScaleRangeLayer-DQr2T3Hh.js","assets/TemporalLayer-PPlZ7dA6.js","assets/TimeInfo-DkMGCZug.js","assets/TrackableLayer-Bfi9HJMk.js","assets/FeatureTemplate-YHws4rVv.js","assets/FeatureType-BiPdEyj6.js","assets/fieldProperties-B2MoGA0X.js","assets/TitleCreator-8I7gM9La.js","assets/versionUtils-CusXj0yS.js","assets/styleUtils-CZJC3pZm.js","assets/popupUtils-AW47OFao.js","assets/streamLayerUtils-DFlbJ4P1.js","assets/ReactiveMap-B0by2bYu.js","assets/NetworkElement-BXc67_5E.js","assets/symbolUtils-l2AgdSy4.js","assets/mat2df32-Dpt2CT5P.js","assets/mat2d-CHHYfmUW.js","assets/layerViewUtils-BTa15X3o.js","assets/geometryServiceUtils-DWghLvIc.js","assets/project-ouXI81dD.js","assets/TileLayerView3D-Bzse8fnp.js","assets/LayerView3D-CCv_nmv5.js","assets/TiledLayerView3D-B9vBKj7k.js","assets/fetchTile-nVZ4FnOJ.js","assets/SublayerPopupHighlightHelper3D-Cbbrj2ec.js","assets/ImageHighlightHelper3D-ClXNLYzO.js","assets/GraphicsCollection-mGxi3VN1.js","assets/floorFilterUtils-DKzVzLpH.js","assets/sublayerUtils-BEQnBRaB.js","assets/popupUtils-CEImAaCE.js","assets/LayerView-B4B44Ajx.js","assets/UpdatingHandles-D2RI_3Hb.js","assets/RefreshableLayerView-BZ0W4dR0.js","assets/Texture-CAvBvljT.js","assets/vec32-zHQcyKRA.js","assets/Indices-D0_UQPPr.js","assets/BufferView-CdBDKeBv.js","assets/vec2f64-rIxtbMRN.js","assets/sphere-DGD4QNOm.js","assets/vector-knXISDaK.js","assets/quatf64-CCm9z-pX.js","assets/frustum-Cq95H2HO.js","assets/plane-CAH7O3r1.js","assets/Emissions.glsl-B8XKMjLy.js","assets/enums-B4pqBiXb.js","assets/orientedBoundingBox-CbUQAgG7.js","assets/quat-CCdR5JrD.js","assets/spatialReferenceEllipsoidUtils-BGTSZp-L.js","assets/computeTranslationToOriginAndRotation-CTVG2hGD.js","assets/InterleavedLayout-KZk0acs8.js","assets/types-BKo2foNY.js","assets/VertexElementDescriptor-BlxU8vCE.js","assets/projectPointToVector-B1tbWJiK.js","assets/projectVectorToVector-CDqzCeaL.js","assets/HUDIntersectorResult-Ds4yeNc-.js","assets/videoUtils-Dwx3AEgj.js","assets/PooledRBush-Dco5QkUp.js","assets/quickselect-QQC62dOK.js","assets/RealisticTree.glsl-DAhEIR1w.js","assets/meshVertexSpaceUtils-BZiL5Bbc.js","assets/MeshLocalVertexSpace-De2t7DNQ.js","assets/vec3f32-WCVSSNPR.js","assets/Intersector-BFu7YAUe.js","assets/TilemapCache-DrtAz5a3.js","assets/TileKey-zev9cGPe.js","assets/tagSymbols-BPcGfZon.js","assets/Map-DoBsBAGU.js","assets/Basemap-BI8rdNrf.js","assets/loadAll-CleWBL8j.js","assets/writeUtils-D0J7VXri.js","assets/CollectionFlattener-C1ewYzfL.js","assets/persistable-AW3PLevT.js","assets/multiOriginJSONSupportUtils-C0wm8_Yw.js","assets/resourceExtension-3aprB2zB.js","assets/PolygonCollection-BQYUC051.js","assets/TablesMixin-MGFFfhKn.js","assets/ElevationQuery-C16QuML_.js","assets/TileInfo-fM6eYiPH.js","assets/Scheduler-CNrsbccs.js","assets/constants-D67WmGms.js","assets/floatRGBA-D95YiFWR.js","assets/TileKey-C44YQC4_.js","assets/vec2f32-CaVKkSa6.js","assets/dehydratedFeatures-BBoTEZJ8.js","assets/quantizationUtils-BSWXSK29.js","assets/featureConversionUtils-DlTGrdYn.js","assets/Octree-vaE3elxD.js","assets/elevationInfoUtils-OU8rgnDX.js","assets/intersectorUtilsConversions-Cv_V2i_M.js","assets/DefaultLoadingContext-BnNmzeR1.js","assets/wosrLoader-B8RYB0d4.js","assets/axisAngleDegrees-D1LL0HZb.js","assets/edgePreprocessing-CBVaMT5L.js","assets/config-Dg972SSE.js","assets/GeometryUtils-BUMmi0hw.js","assets/definitions-Dvg4hMIw.js","assets/WorkerHandle-IsvMxqHu.js","assets/colorUtils-CfxFVJbg.js","assets/vec3-B_phcnZY.js","assets/vec33-CWJeyzxV.js","assets/capabilities-Bi6C4OG6.js","assets/imageUtils-DRSdxeif.js","assets/ElevationLayerView3D-BlJyxDV4.js","assets/LercDecoder-Pfp1fJPH.js","assets/BaseDynamicLayerView3D-DEYmHM3G.js","assets/DynamicLayerView3D-DJnBxKcW.js","assets/SubView3D-BgWeOqxP.js","assets/ImageMaterial.glsl-C4KBwqzq.js","assets/TriangleMaterial-CuAtcOpx.js","assets/DefaultLayouts-Dd1LUG-r.js","assets/BuildingSceneLayerView3D-D7REwVUo.js","assets/BuildingComponentSublayer-Dl4JgTF9.js","assets/capabilities-Cs4k8cuT.js","assets/I3SIndexInfo-Dy2cjpKU.js","assets/I3SLayerDefinitions-BquY6sVj.js","assets/I3SUtil-DcF4YcZ1.js","assets/featurePopupQueryUtils-b8X4Q-4q.js","assets/I3SBinaryReader-ZmgM2p_h.js","assets/BuildingGroupSublayer-Ck-mM2bH.js","assets/WhereClause-Dez6WaCd.js","assets/I3SMeshView3D-DZSnOfcd.js","assets/Transform-CCt9OVQD.js","assets/projectBoundingSphere-s0pRerwh.js","assets/I3SOverrides-lJgdiEmk.js","assets/resourceUtils-DWVfTVer.js","assets/EllipsoidMode-Diy_TLdg.js","assets/SceneModification-8XJBM1CN.js","assets/ExtentSet-CTbPIMna.js","assets/optimizedFeatureQueryEngineAdapter-Bma9_B5X.js","assets/I3SMeshWorkerHandle-Dfa1NACn.js","assets/SceneLayerWorker-D8vqGlpf.js","assets/attributeUtils-Dc8--CBJ.js","assets/highlightUtils-BcRio8cf.js","assets/highlightOptionsUtils-jFZ1fJC9.js","assets/I3SQueryFeatureAdapter-CDdDLjei.js","assets/TemporalSceneLayerView-DP6dpSah.js","assets/QueryEngine-CQEi_XpM.js","assets/WhereClauseCache-Nlnf6Y48.js","assets/FixedIntervalBinParameters-V_WYeh_a.js","assets/QueryEngineCapabilities-DJC_YILC.js","assets/utils-QFWO9f3s.js","assets/utils-BEeBypEk.js","assets/ClassBreaksDefinition-BGOzyovZ.js","assets/SnappingCandidate-DGkpYqI6.js","assets/timeSupport-DhNsaFLS.js","assets/utils-DTE-xBiC.js","assets/I3SQueryFeatureStore-6vxkkYk_.js","assets/CatalogLayerView3D-ZXo-q0--.js","assets/CatalogDynamicGroupLayerView3D-D6bv-610.js","assets/CatalogFootprintLayerView3D-CnSTKEEo.js","assets/FeatureLayerViewBase3D-CS_vBvGl.js","assets/HeatmapDensity.glsl-ChFYAaNU.js","assets/AttributeBinsQuery-CnA8HGJ0.js","assets/FeatureTileDescriptor-n8K3eVrw.js","assets/dehydratedFeatureComparison-DMKONu0S.js","assets/queryForSymbologySnapping-947yNp_6.js","assets/Graphics3DFeatureProcessor-DH4SF_bl.js","assets/hash-CcEbRgUF.js","assets/renderingInfoUtils-BKfQQLqV.js","assets/Graphics3DObjectStates-rpufR3Zm.js","assets/AttributeBinsFeatureSet-BCP1r9yv.js","assets/FeatureStore-C3iyg9e9.js","assets/BoundsStore-DaboXCXV.js","assets/EventedSet-DfgtwAGn.js","assets/FeatureIdInfo-iL5WjyEH.js","assets/constants-SxxbBSOD.js","assets/CSVLayerView3D-BKeDVwhx.js","assets/DimensionLayerView3D-9d0okYxd.js","assets/LayerViewAnalysisViewManager-6ffDeA9n.js","assets/FeatureLayerView3D-C5u_dk9H.js","assets/GaussianSplatLayerView3D-hvWCXDi1.js","assets/tiles3DUtils-D7SG71qr.js","assets/GeoJSONLayerView3D-BV-bwFBB.js","assets/GraphicsLayerView3D-Bof5vOX7.js","assets/GraphicsProcessor-XaOXOweH.js","assets/GroupLayerView3D-L82ORY4l.js","assets/ImageryLayerView3D-DEyYJpE5.js","assets/dataUtils-27saOfMQ.js","assets/FlowSubView3D-BNBCQXs4.js","assets/loadUtils-CUhSQ7p8.js","assets/line-DzJxYxSt.js","assets/rasterFieldUtils-0bNK-dHZ.js","assets/rasterProjectionHelper-LFVfFknq.js","assets/IntegratedMeshLayerView3D-RFKfjCo7.js","assets/IntegratedMesh3DTilesLayerView3D-B-KZEu_V.js","assets/LineOfSightLayerView3D-UkfuaF7l.js","assets/MapImageLayerView3D-DPKayeyA.js","assets/ExportImageParameters-BsPcoTz4.js","assets/MediaLayerView3D-BG_piPY2.js","assets/MediaElementView-BAxbf2oG.js","assets/normalizeUtilsSync-OK6qKDm5.js","assets/mat2df64-DFLy2zOC.js","assets/EditGeometryOperations-C-OVMfDU.js","assets/geometry2dUtils-D-hxoYKh.js","assets/rotate-DPvd871g.js","assets/curveOperationUtils-Cq-Vrv9J.js","assets/SnappingManagerPool-Bdr_Pe2m.js","assets/allLayerSnapping-B-Zf-2kR.js","assets/euclideanLengthMeasurementUtils-Cd4JOoc8.js","assets/geodeticLengthOperator-CC2ukcsv.js","assets/geodeticCurveType-CirnHLSB.js","assets/automaticAreaMeasurementUtils-DTAbpcBX.js","assets/geodesicAreaMeasurementUtils-D05-2vvY.js","assets/earcut-D9gy186-.js","assets/automaticLengthMeasurementUtils-CwXO_zBR.js","assets/OGCFeatureLayerView3D-B4UVS6ST.js","assets/PointCloudLayerView3D-CXBwc9mi.js","assets/PointCloudWorkerUtil-Bud39q8Z.js","assets/PointCloudUniqueValueRenderer-d15JVyxf.js","assets/PopupSceneLayerView-0lANJ1rg.js","assets/ViewshedLayerView3D-BRlFgxxF.js","assets/VoxelLayerView3D-dwHmXaoj.js","assets/VoxelGraphic-Bhvkh7mw.js","assets/RouteLayerView3D-CERbBUpB.js","assets/Stop-ReywEbYl.js","assets/networkEnums-DcxQ-KKD.js","assets/SceneLayerView3D-cWN0jOEX.js","assets/SceneLayerView-Bvvnofy0.js","assets/SceneLayerGraphicsView3D-rV3qst8J.js","assets/StreamLayerView3D-CaVJJs6J.js","assets/StreamFeatureManager-DS8maxEM.js","assets/createConnection-uBdDcyag.js","assets/ImageryTileLayerView3D-CoCtGZsw.js","assets/datasetUtils-DdDUWBI2.js","assets/VectorTileLayerView3D-_xj1gB0E.js","assets/Rect-BAnET0xx.js","assets/rasterizingUtils-DSdqxGQ7.js","assets/StyleRepository-D57R-evj.js","assets/WFSLayerView3D-BBVV4n6J.js","assets/WMSLayerView3D-VF5HR2te.js","assets/ExportWMSImageParameters-DXoETD5V.js","assets/WMTSLayerView3D-DxWJ8fb3.js","assets/AreaMeasurementAnalysisView3D-CADHHAAL.js","assets/getDefaultUnitForView-BfT_njB8.js","assets/AnalysisView3D-zhHEgrUR.js","assets/measurementUtils-Hsu5Hb5H.js","assets/ShadedColorMaterial.glsl-3AYkzYTx.js","assets/VisualElement-By4iq8p4.js","assets/ColorMaterial.glsl-DITwsyR3.js","assets/quantityFormatUtils-C43QixFB.js","assets/Segment-BoBVgZCP.js","assets/TextOverlayItem-BLTSHrw0.js","assets/lineStippleUtils-CCavR4OV.js","assets/SnappingVisualizer3D-BTablpoL.js","assets/ExtendedLineVisualElement-BbXxBw-x.js","assets/EngineVisualElement-DBP6v2o3.js","assets/LaserlinePath.glsl-B_28jNcs.js","assets/PointVisualElement-BTnHoOQz.js","assets/SnappingContext-CTLlOfQA.js","assets/PointSnappingHint-C4faYzR-.js","assets/dragEventPipeline3D-8oHY0ebf.js","assets/InteractiveToolBase-CFS-dgS6.js","assets/ToolIntersector-CJNxpodo.js","assets/analysisViewUtils-p9xJIaI1.js","assets/SnappingDragPipelineStep-BhLMtp0q.js","assets/SnappingOperation-ClIdnPwp.js","assets/DimensionAnalysisView3D-nWWzqK4B.js","assets/LengthDimension-C2pBb4Cn.js","assets/Factory-CKBQfDTy.js","assets/VerticesVisualElement-B9V5nSa4.js","assets/LineMarker.glsl-iFX59k9O.js","assets/DirectLineMeasurementAnalysisView3D-lrBBA8NB.js","assets/ElevationProfileAnalysisView3D-H5PntyO2.js","assets/settings-CBe1rIVY.js","assets/OutlineVisualElement-DGuo8XYr.js","assets/line-Dcl4F6AZ.js","assets/triangulationUtils-DA80_6V0.js","assets/deduplicate-Lzwo1kX7.js","assets/createUtils-BfFtfNYM.js","assets/distanceOperator-jqSOkiaB.js","assets/Point2D-CMz7woHH.js","assets/Distance2DCalculator-CXhBP-8I-BMMI87Nn.js","assets/ProjectionTransformation-PJc9H7Gq.js","assets/Envelope2D-mFnl8dXR.js","assets/Transformation2D-CrydmBdC.js","assets/SimpleGeometryCursor-B92kdZ15.js","assets/OperatorDefinitions-DP7_WWTp.js","assets/apiConverter-BP3G-060.js","assets/jsonConverter-BXIkXJ1n.js","assets/simplifyOperator-GU91fZE2.js","assets/operatorSimplify-5A_MmN4K.js","assets/GraphicsLayer-BzsoYYl-.js","assets/SketchViewModel-MZH8bHBQ.js","assets/SketchOptions-Dguq2sp8.js","assets/LineOfSightAnalysisView3D-D0vzpo48.js","assets/featureReferenceUtils-BzOguQtG.js","assets/LineOfSightAnalysisTarget-Dh6bDHDf.js","assets/IViewEvents-CanZpugO.js","assets/SliceAnalysisView3D-GtwtywNM.js","assets/SlicePlaneMaterial.glsl-CTSeyvjO.js","assets/sliceToolConfig-BnawSSVt.js","assets/RotateManipulator-C5ZLgSrf.js","assets/ViewshedAnalysisView3D-CNKPdnW3.js","assets/Viewshed-Chyge678.js","assets/MoveManipulation-DgIdg4m-.js","assets/VolumeMeasurementAnalysisView3D-YVX7ZBaV.js","assets/Graphics3DExtrudeSymbolLayer-po_h6zGj.js","assets/SketchTooltipInfo-D8rbREIL.js","assets/MeshTransform-BDItFzzp.js","assets/angularMeasurementUtils-BUR3PkJM.js","assets/TooltipInfoWithCoordinates-DafSPtc3.js","assets/VoxelWasmPerSceneView-CxbjRwlS.js","assets/Graphics3DSymbolLayerFactory-BDRDEKPc.js","assets/CIMSymbolHelper-nRs4wiJg.js","assets/BidiEngine-BvER9tXK.js","assets/labelPoint-DSz--xtI.js","assets/MeshComponent-DXijALrB.js","assets/meshProperties-DWLWd_LJ.js","assets/vertexSpaceConversion-BtifLz3Q.js","assets/vec4-B7mYuNMQ.js","assets/projectMeshVertexPositions-Ck7AyMXi.js","assets/objectResourceUtils-CnQBYOEr.js","assets/devEnvironmentUtils-8WtPGj6h.js","assets/indexUtils-DpmEYOW0.js","assets/webStyleSymbolUtils-BJsM9P2X.js","assets/LodRenderer-Dhf84OKt.js","assets/loader-CjRmx4ez.js","assets/TerrainTileTree3DDebugger-BhGK6rP1.js","assets/TileTreeDebugger-DpfhDSzw.js","assets/edgeProcessing-DVxeDOky.js","assets/bufferLayouts-B264SBQA.js","assets/EdgeView-XH0bkele.js","assets/EdgeWorkerHandle-DsEjLOni.js","assets/workerHelper-Dy2lpOXE.js","assets/Lyr3DWasmPerSceneView-CBvvOrtr.js","assets/Lyr3DModule-v3c4TvZs.js","assets/index-SZ3g5lwf.js","assets/index-AZAxQLim.js","assets/guid-LcV_DAvu.js","assets/useT9n-XKURtw_n.js","assets/index-BKY8qfD5.js","assets/index-BsfTHZ_y.js","assets/dom-BgMmHXUg.js","assets/observers-Dd89DmPc.js","assets/ref-VZpf2tPS.js","assets/static-CeizO1tM.js","assets/form-CYQ5XO6d.js","assets/interactive-yMBIfQvu.js","assets/label-DYFm0N1y.js","assets/useSetFocus-sP_WSGbP.js","assets/FeatureTileTree3DDebugger-BLdqLPWf.js","assets/GraphicsView3D-DiSFd0nr.js","assets/FocusAreasView-Jv5gIisy.js","assets/operatorDensify-BAougbyn.js","assets/FeatureTileTree3D-CBoi7U_6.js"])))=>i.map(i=>d[i]);
import{_ as k}from"./index-CB_zX-aI.js";import{v as oa,_ as u,m as p,a as R,X as Xo,B as Ax,l as te,i as j,bC as tm,aH as Kl,aZ as IM,V as xn,o as bi,G as Ze,c6 as J3,c7 as LM,c8 as Ix,c9 as eI,s as me,ca as tI,ax as iI,d as He,a5 as sa,a1 as Mg,e as Aa,as as v0,cb as sI,L as gw,aC as rI,an as nI,bc as Ip,bn as aI,n as Os,ad as Hl,g as zr,w as Oo,W as FM,aP as im,a6 as Bi,aT as pn,aU as b_,u as Q,aI as VM,a7 as Lp,bb as _e,aA as ra,R as Jl,bp as _w,r as ay,y as $g,ac as w_,bz as oI,ar as $e,b7 as Zi,b6 as kM,D as zM,z as lI,cc as cI,Q as zt,ap as hu,cd as hI,ce as uI,F as Do,a4 as dI,U as Lr,b9 as pI,f as mI,aw as fI,cf as gI,ag as Rg,t as Nt,bm as _I,bs as sm,cg as b0,bj as Hd,b1 as yw,ch as Lx,ci as ui,a8 as yI,c1 as vI,A as bI,bB as wI,b0 as rm,cj as xI,bq as CI,ck as TI,cl as SI,cm as PI,cn as Fx,a9 as MI,co as $I,cp as RI,cq as OI,C as DI}from"./jsonMap-Bs3hmeCU.js";import{c4 as Qs,c5 as uu,c6 as x_,c7 as EI,c8 as Wn,T as Xt,V as lt,aW as qi,b6 as AI,aq as Br,a1 as ct,a2 as ht,b1 as ri,a3 as qe,a8 as nt,c9 as vw,bf as ls,af as V,ca as bw,ba as du,cb as II,A as bt,cc as Nr,cd as ln,r as ft,be as Tn,ao as ur,aQ as pu,b2 as Ho,b3 as ne,R as BM,x as Kt,ce as LI,cf as NM,cg as FI,ch as Vx,ci as ww,cj as Eo,g as vt,u as Ur,w as Ao,ck as UM,cl as VI,cm as Gh,cn as mu,c as kI,aP as zI,a as yi,bc as It,bp as BI,P as NI,bN as oy,co as UI,cp as HI,p as qI,aX as Qa,aZ as mr,am as GI,aG as C_,aF as ap,bm as jI,au as qs,at as xw,ae as T_,s as HM,l as $s,ah as WI,ai as qM,aE as QI,bt as ZI,bv as XI,m as GM,cq as ly,cr as kx,B as ss,cs as Og,M as YI,ax as Io,a$ as oc,ap as jM,ct as WM,cu as S_,aK as za,bk as KI,bo as JI,az as Cw,an as QM,b0 as cr,aw as eL,aA as Rs,aH as Tw,aY as ZM,_ as tL,Y as XM,W as YM,Z as KM,$ as JM,a0 as Sw,aC as e$,a5 as zx,a6 as t$,a7 as w0,as as xh,aa as iL,ab as i$,ad as s$,a9 as qd,aI as sL,aJ as Bx,aL as rL,aM as nL,aN as Nx,ay as aL,aO as Ux,cv as cy,aS as jh,cw as oL,cx as lL,cy as r$,cz as Fp,cA as cL,cB as n$,cC as hL,i as Pw,cD as a$,c3 as lc,c0 as P_,bn as Hx,cE as uL,cF as Vp,cG as dL,cH as o$,ar as Mw,cI as $w,b7 as pL,X as l$,aB as mL,bF as c$,cJ as fL,bU as gL,bW as Dg,bT as _L,bX as yL,bZ as vL,b_ as x0,cK as bL,cL as h$,cM as wL,bQ as xL,cN as CL,cO as TL,cP as SL,cQ as C0,cR as u$,c2 as PL,n as d$,cS as ML,j as $L,U as RL,cT as xf,cU as p$,av as m$,cV as OL,cW as DL,cX as EL,bV as AL,cY as IL,cZ as LL,c_ as FL,b$ as VL,c$ as kL,ac as zL,f as BL,L as qx,aU as Rw,d0 as NL,d1 as f$,d2 as T0,t as ec,aV as UL,d3 as HL,d4 as qL,d5 as GL,bh as jL,S as WL,d6 as QL,d7 as ZL,d8 as S0,d9 as XL,da as YL,db as Cf,dc as KL,dd as JL,de as eF}from"./Texture-CAvBvljT.js";import{s as Ba,R as tc,p as tF,f as Dt,b as wt,a5 as Zt,$ as iF,bB as Gx,ay as P0,F as Wh,a6 as Ei,aA as Ow,aB as Dw,aD as g$,c as sF,bC as kp,af as fr,bD as _$,bz as y$,bE as v$,bF as b$,bG as rF,bH as nF,Q as w$,H as hy,bI as x$,a0 as aF,az as C$,aS as T$,bJ as S$,b7 as oF,b8 as lF,bK as cF,an as jx,ar as hF,aj as uF}from"./Point-62ir3Nzl.js";import{f as Wx}from"./jsonUtils-alsySR4T.js";import{l as dF}from"./typeUtils-BR_JAZOz.js";import{n as x,O as Pt,c as P$,l as pF,m as Qx,t as Sn,f as M_,o as mF,r as Qe,a as fF,s as gF,N as _F,b as yF,i as ea,_ as vF,k as bF,q as wF,j as xF,v as CF}from"./collectionUtils-CB98pReO.js";import{j as Zx,U as Ew,V as Xx,B as zp,y as Ni,z as Qh,K as TF,J as SF,W as PF,x as Aw,G as MF,X as $F}from"./modeUtils-BF30GgRz.js";import{s as RF}from"./SimpleObservable-CvFyr0NA.js";import{l as $,h as Re,w as Ve,j as op,c as fu,a as Ds,n as $_,U as Ae,f as Zs,d as M$,i as cc,r as OF,b as DF,e as EF}from"./reactiveUtils-SO2Ko3sy.js";import{i as dr,f as ii,p as Zh,g as mn,u as Eg,y as Ia,x as $$}from"./screenUtils-BitdhK1O.js";import{a as AF,a3 as IF}from"./lengthUtils-Cm-zragw.js";import{m as LF}from"./workers-VgzaPqUK.js";import{E as FF}from"./PooledRBush-Dco5QkUp.js";import{n as VF,i as R$,l as M0}from"./GraphicsCollection-mGxi3VN1.js";import{z as is,a as O$,t as kF}from"./Extent-Cs-ESnE1.js";import{m as Bp}from"./HeightModelInfo-CNRqlD7K.js";import{b as na,W as Np,J as D$,L as zF,G as BF,H as Lo,f as Jc,F as E$,m as NF,Q as UF,C as Yx}from"./projectionUtils-ClsoIho7.js";import{p as HF,f as qF,u as GF}from"./spatialReferenceEllipsoidUtils-BGTSZp-L.js";import{a as Up,i as Mt,c as A$,N as jF,d as I$,K as Fo,G as Ag,l as hr,y as Xn,M as zh,s as $0,f as WF,Q as QF,g as L$,o as F$,O as ql,B as R0,z as ZF,E as XF,V as YF,W as Kx,e as KF,b as Ig,q as Jx}from"./aaBoundingRect-DfeeUq5j.js";import{i as Na,c as Lg}from"./projectPointToVector-B1tbWJiK.js";import{a8 as V$,a9 as Hp,aa as k$,ab as O0,P as eC,i as Iw,ac as z$,z as R_,G as Lw,ad as JF,Q as e5,W as t5,n as i5,E as uy,w as B$,ae as s5,af as r5,ag as n5,ah as a5,ai as tC,aj as o5,c as l5,a0 as c5,a4 as h5,ak as u5,al as d5,am as Fg,F as p5,an as m5,B as f5,v as g5}from"./RealisticTree.glsl-DAhEIR1w.js";import{o as _5,u as y5}from"./scaleUtils-m8EJvm5m.js";import{m as eh,d as iC,l as v5,c as b5,S as Xh,j as Bh,A as N$,J as w5,v as Yh,T as Tf,U as dy,C as sC,k as rC}from"./layerUtils-4EQ207Ij.js";import{j as x5}from"./TilemapCache-DrtAz5a3.js";import{e as C5}from"./tagSymbols-BPcGfZon.js";import{h as hc}from"./UpdatingHandles-D2RI_3Hb.js";import{d as Za,_ as Vg,a as Fw}from"./asyncUtils-w6KfWU41.js";import{s as D0}from"./Queue-CYlrXMwB.js";import{r as rs}from"./signal-BX9ezF8a.js";import{L as T5}from"./Map-DoBsBAGU.js";import{l as U$}from"./CollectionFlattener-C1ewYzfL.js";import{e as S5}from"./date-IqUzANpt.js";import{b as P5,m as M5}from"./Layer-BLV7fz0K.js";import{p as $5}from"./timeZoneUtils-BSc7-7qA.js";import{s as E0}from"./ReactiveMap-B0by2bYu.js";import{b as nC}from"./Query-98igen-k.js";import{u as vi,r as gu}from"./Color-CERqXxxY.js";import{M as ic,r as U,s as rt,l as lp,m as py,A as R5,S as O5,q as D5,o as Me,b as Ua,n as E5,u as sc,L as Kh,f as A5}from"./mathUtils-PIGhLnI9.js";import{b as nm}from"./TablesMixin-MGFFfhKn.js";import{W as Vw,p as Ht,r as fe,s as q,M as I5,o as be,R as zi,g as ee,A as pe,P as We,I as kt,E as ot,u as ce,J as Jh,c as he,K as kw,j as Gs,N as fn,_ as ti,v as $o,y as La,H as qo,Y as on,Q as L5,$ as aC}from"./vec32-zHQcyKRA.js";import{A as F5,C as V5,U as H$}from"./normalizeUtils-BTK6arYa.js";import{i as k5,G as z5,t as B5}from"./ElevationQuery-C16QuML_.js";import{z as am,l as om}from"./TileInfo-fM6eYiPH.js";import{i as Sf,v as O_,k as cn,X as or,q as N5,e as q$,K as zw,j as Ha,a as G$,G as oC,H as U5,m as cp,p as lm,w as cm}from"./plane-CAH7O3r1.js";import{a as Pn,F as Xi,ar as j$,aq as pr,E as Bw,ak as hn,M as qp,e as my,T as H5,P as W$,aj as hp,m as q5,aP as G5,aC as j5,l as $l,u as Yo,U as lC,b as Rl,j as Qi,X as W5,Y as cC,K as Q$,H as Z$,aS as Nw,aT as up,aU as Uw,W as Hw,al as X$,$ as qw,V as Q5,aV as Z5}from"./Polygon-BbQMC1ht.js";import{Y as X5,p as Vo,o as dp,l as hC,m as Y5,x as A0,B as K5,c as as,b as gn,i as rc,q as Y$,s as K$,n as Fr,H as J5,h as eu,X as J$,Q as eV,e as tV,C as iV}from"./mat4-Bjnccznk.js";import{e as Ie,r as _n,n as eR}from"./mat4f64-q_b6UJoq.js";import{n as ke,r as _u,t as sV,l as pp,u as rV}from"./vec2f64-rIxtbMRN.js";import{r as Dr,n as nV}from"./vec3f32-WCVSSNPR.js";import{O as gi,D as Ot,N as si,u as aV,G as tu,n as Ui,T as Gl,o as tR,_ as Ct,R as Cn,E as Es,C as Ws,A as I0,U as iR,B as th,I as fy}from"./enums-B4pqBiXb.js";import{f as di,o as Ai,F as yn,w as oV,G as mp,I as lV}from"./Scheduler-CNrsbccs.js";import{A as sR,e as rR,c as cV}from"./Indices-D0_UQPPr.js";import{t as Vr,Q as Xa}from"./InterleavedLayout-KZk0acs8.js";import{y as hV,e as uV,i as uC}from"./memoryEstimations-Bd726a_p.js";import{r as dV,n as Ya,t as pV,a as mV}from"./VertexElementDescriptor-BlxU8vCE.js";import{o as dC}from"./reader-DcGs6kKN.js";import{a as fV}from"./ExtrudeSymbol3DLayer-DSc1ou2x.js";import{k as iu,W as D_,q as gV,r as E_,d as A_,f as Gw,b as Go,P as Xs,I as Hi,z as fp,D as gp,i as _V,N as jw,e as yV,B as vV,G as bV,V as nR,O as wV,h as xV,L as CV}from"./sphere-DGD4QNOm.js";import{a as hm,t as _p,o as pC,b as TV}from"./constants-D67WmGms.js";import{s as ko,a as Ww}from"./Cyclical-BLSxUpe7.js";import{O as SV}from"./quat-CCdR5JrD.js";import{e as PV}from"./quatf64-CCm9z-pX.js";import{r as MV,b as aR,c as yt,a as $V,u as RV}from"./vector-knXISDaK.js";import{s as os,z as kg,m as Qw,a as jl,E as Pf,o as OV,H as oR,_ as DV}from"./vec42-fTNpW1Xv.js";import{n as Lt,r as Si,s as lR,a as hi,u as EV,e as AV,t as Mf}from"./vec4f64-DPb6J-GU.js";import{_ as Zw}from"./Graphic-CkB18CDi.js";import{m as cR}from"./Polyline-CUSonZ4c.js";import{f as I_}from"./computeTranslationToOriginAndRotation-CTVG2hGD.js";import{n as zo,t as IV}from"./projectVectorToVector-CDqzCeaL.js";import{b as Xw,C as hR,w as Yw,q as Hr,l as zg,M as uR,u as Ka,g as LV,E as dR,y as FV,Z as VV,d as kV,G as zV,V as BV,T as NV,k as pR,Q as UV,J as HV,a as mC}from"./aaBoundingBox-DO0Hqciy.js";import{q as qV,M as GV,b as gy,B as jV,v as mR,w as Kw,o as WV,x as QV,h as ZV}from"./frustum-Cq95H2HO.js";import{c as L_}from"./intl-BIQN36K8.js";import{i as XV,c as YV,b as KV,o as JV,n as e4,r as t4}from"./floatRGBA-D95YiFWR.js";import{l as i4,o as fR,j as s4}from"./typeUtils-D0MaDvT3.js";import{h as r4,e as n4,b as a4}from"./PolygonSymbol3D-Dla3O-pf.js";import{s as o4,f as l4,a as $f,t as c4,c as h4,e as fC,h as u4,i as d4}from"./layerViewUtils-BTa15X3o.js";import{n as gR,e as p4}from"./unitConversionUtils-BSQ4LGUO.js";import{s as Wt,c as m4,t as _R,u as f4,e as Cc,n as um,r as _y,o as g4,X as gC,g as Bg}from"./BufferView-CdBDKeBv.js";import{t as Rf,s as yR,K as _4}from"./orientedBoundingBox-CbUQAgG7.js";import{r as Tc}from"./vec2f32-CaVKkSa6.js";import{i as la,t as y,f as ge,j as Be,e as js,n as X,o as ns,l as Jw,p as y4,s as v4,w as _C,v as b4,z as uc,h as vR,d as w4,r as bR,k as x4,y as C4,b as yy}from"./Emissions.glsl-B8XKMjLy.js";import{z as T4}from"./dehydratedFeatures-BBoTEZJ8.js";import{u as S4}from"./featureConversionUtils-DlTGrdYn.js";import{S as P4}from"./Octree-vaE3elxD.js";import{z as M4}from"./elevationInfoUtils-OU8rgnDX.js";import{p as wR,f as xR}from"./HUDIntersectorResult-Ds4yeNc-.js";import{d as CR,p as TR,i as $4}from"./intersectorUtilsConversions-Cv_V2i_M.js";import{h as R4,a as O4,s as D4}from"./LRUCache-fy84PBMi.js";import{l as E4}from"./DefaultLoadingContext-BnNmzeR1.js";import{h as A4,t as qa}from"./wosrLoader-B8RYB0d4.js";import{v as yC,w as vC,j as I4}from"./axisAngleDegrees-D1LL0HZb.js";import{u as L4,e as yp,x as F4}from"./edgePreprocessing-CBVaMT5L.js";import{e as L0}from"./DoubleArray-DExKNiTh.js";import{e as e1}from"./TileKey-C44YQC4_.js";import{t as V4,e as F0}from"./config-Dg972SSE.js";import{w as k4}from"./GeometryUtils-BUMmi0hw.js";import{R as z4,Q as B4}from"./definitions-Dvg4hMIw.js";import{o as N4}from"./WorkerHandle-IsvMxqHu.js";import{H as t1}from"./colorUtils-CfxFVJbg.js";import{f as U4}from"./vec3-B_phcnZY.js";import{t as H4}from"./vec33-CWJeyzxV.js";import{n as q4,t as G4}from"./capabilities-Bi6C4OG6.js";import{s as Of}from"./imageUtils-DRSdxeif.js";var V0;let uo=V0=class extends oa{constructor(s){super(s),this.rotation=0,this.scale=0,this.targetGeometry=null,this.camera=null}castRotation(s){return(s%=360)<0&&(s+=360),s}clone(){return new V0({rotation:this.rotation,scale:this.scale,targetGeometry:this.targetGeometry!=null?this.targetGeometry.clone():null,camera:this.camera!=null?this.camera.clone():null})}};u([p({type:Number,json:{write:!0,origins:{"web-map":{default:0,write:!0},"web-scene":{write:{overridePolicy:vy}}}}})],uo.prototype,"rotation",void 0),u([Ba("rotation")],uo.prototype,"castRotation",null),u([p({type:Number,json:{write:!0,origins:{"web-map":{default:0,write:!0},"web-scene":{write:{overridePolicy:vy}}}}})],uo.prototype,"scale",void 0),u([p({types:dF,json:{read:Wx,write:!0,origins:{"web-scene":{read:Wx,write:{overridePolicy:vy}}}}})],uo.prototype,"targetGeometry",void 0),u([p({type:Qs,json:{write:!0,origins:{"web-scene":{write:{isRequired:!0}}}}})],uo.prototype,"camera",void 0),uo=V0=u([R("esri.Viewpoint")],uo);const Bo=uo;function vy(){return{enabled:!this.camera}}let j4=class{constructor(e){this._observable=new RF,this._set=new Set(e)}get size(){return Xo(this._observable),this._set.size}add(e){const t=this._set.size;return this._set.add(e),this._set.size!==t&&this._observable.notify(),this}clear(){this._set.size>0&&(this._set.clear(),this._observable.notify())}delete(e){const t=this._set.delete(e);return t&&this._observable.notify(),t}entries(){return Xo(this._observable),this._set.entries()}forEach(e,t){Xo(this._observable),this._set.forEach((i,r)=>e.call(t,i,r,this),t)}has(e){return Xo(this._observable),this._set.has(e)}keys(){return Xo(this._observable),this._set.keys()}values(){return Xo(this._observable),this._set.values()}[Symbol.iterator](){return Xo(this._observable),this._set[Symbol.iterator]()}[Symbol.dispose](){this._observable.destroy()}get[Symbol.toStringTag](){return this._set[Symbol.toStringTag]}};function SR(s,e){const t=Ax(s),i=Ax(e),r=t.store,n=i.store,a=i.metadata;for(const o in a){const l=a[o],c=r.originOf(o),h=n.originOf(o);if(!l.readOnly&&h!==0){if(c!==0){const d=r.get(o),m=n.get(o);d&&m&&m instanceof te&&d instanceof te&&d instanceof m.constructor&&SR(d,m);continue}s.set(o,n.get(o))}}}function i1(s,e,t,i){return s!=null&&(tc(e,i)?(Up(t,s),!0):(Fs[0]=s[0],Fs[1]=s[1],Fs[2]=0,!!na(Fs,e,0,Fs,i,0)&&(t[0]=Fs[0],t[1]=Fs[1],Fs[0]=s[2],Fs[1]=s[3],Fs[2]=0,!!na(Fs,e,0,Fs,i,0)&&(t[2]=Fs[0],t[3]=Fs[1],!0))))}const Fs=x();let su=class extends VF{constructor(e){super(e),this.addHandles(this.on("before-add",t=>{t.item!=null&&t.item.parent===this.owner&&(j.getLogger(this).warn("Analysis inside the collection must be unique. Not adding this element again."),t.preventDefault())}))}_own(e){e.parent=this.owner}_release(e){e.parent=null}};su=u([R("esri.support.AnalysesCollection")],su);const Df={widthBreakpoint:{getValue(s){const e=s.viewSize[0],t=s.breakpoints,i=this.values;return e<=t.xsmall?i.xsmall:e<=t.small?i.small:e<=t.medium?i.medium:e<=t.large?i.large:i.xlarge},values:{xsmall:"xsmall",small:"small",medium:"medium",large:"large",xlarge:"xlarge"},valueToClassName:{xsmall:"esri-view-width-xsmall esri-view-width-less-than-small esri-view-width-less-than-medium esri-view-width-less-than-large esri-view-width-less-than-xlarge",small:"esri-view-width-small esri-view-width-greater-than-xsmall esri-view-width-less-than-medium esri-view-width-less-than-large esri-view-width-less-than-xlarge",medium:"esri-view-width-medium esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-less-than-large esri-view-width-less-than-xlarge",large:"esri-view-width-large esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-greater-than-medium esri-view-width-less-than-xlarge",xlarge:"esri-view-width-xlarge esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-greater-than-medium esri-view-width-greater-than-large"}},heightBreakpoint:{getValue(s){const e=s.viewSize[1],t=s.breakpoints,i=this.values;return e<=t.xsmall?i.xsmall:e<=t.small?i.small:e<=t.medium?i.medium:e<=t.large?i.large:i.xlarge},values:{xsmall:"xsmall",small:"small",medium:"medium",large:"large",xlarge:"xlarge"},valueToClassName:{xsmall:"esri-view-height-xsmall esri-view-height-less-than-small esri-view-height-less-than-medium esri-view-height-less-than-large esri-view-height-less-than-xlarge",small:"esri-view-height-small esri-view-height-greater-than-xsmall esri-view-height-less-than-medium esri-view-height-less-than-large esri-view-height-less-than-xlarge",medium:"esri-view-height-medium esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-less-than-large esri-view-height-less-than-xlarge",large:"esri-view-height-large esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-greater-than-medium esri-view-height-less-than-xlarge",xlarge:"esri-view-height-xlarge esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-greater-than-medium esri-view-height-greater-than-large"}},orientation:{getValue(s){const e=s.viewSize,t=e[0],i=e[1],r=this.values;return i>=t?r.portrait:r.landscape},values:{portrait:"portrait",landscape:"landscape"},valueToClassName:{portrait:"esri-view-orientation-portrait",landscape:"esri-view-orientation-landscape"}}},by={xsmall:544,small:768,medium:992,large:1200};function W4(s){const e=s;return e&&e.xsmall<e.small&&e.small<e.medium&&e.medium<e.large}function wy(s,e){return e?Df[s].valueToClassName[e].split(" "):[]}const Q4=s=>{const e=s;let t=class extends e{constructor(...i){super(...i),this.orientation=null,this.widthBreakpoint=null,this.heightBreakpoint=null,this.breakpoints=by}initialize(){this.addHandles($(()=>[this.breakpoints,this.size],()=>this._updateClassNames(),Re))}destroy(){this.destroyed||this._removeActiveClassNames()}set breakpoints(i){if(i!==this._get("breakpoints")){if(!W4(i)){const r=JSON.stringify(by,null,2);console.warn("provided breakpoints are not valid, using defaults:"+r),i=by}this._set("breakpoints",{...i})}}_updateClassNames(){if(!this.container)return;const i=tm.acquire(),r=tm.acquire();let n,a=!1;for(n in Df){const o=this[n],l=Df[n].getValue({viewSize:this.size,breakpoints:this.breakpoints});o!==l&&(a=!0,this[n]=l,wy(n,o).forEach(c=>r.push(c)),wy(n,l).forEach(c=>i.push(c)))}a&&(this._applyClassNameChanges(i,r),tm.release(i),tm.release(r))}_applyClassNameChanges(i,r){const n=this.container;n&&(r.forEach(a=>n.classList.remove(a)),i.forEach(a=>n.classList.add(a)))}_removeActiveClassNames(){const i=this.container;if(!i)return;let r;for(r in Df)wy(r,this[r]).forEach(n=>i.classList.remove(n))}};return u([p()],t.prototype,"breakpoints",null),u([p()],t.prototype,"orientation",void 0),u([p()],t.prototype,"widthBreakpoint",void 0),u([p()],t.prototype,"heightBreakpoint",void 0),t=u([R("esri.views.BreakpointsOwner")],t),t};let po=class extends te{constructor(){super(...arguments),this.items=new Pt,this._watchUpdatingTracking=new hc,this._callbacks=new Map,this._projector=Zx(),this._hiddenProjector=Zx()}get needsRender(){return this.items.length>0}get updating(){return this._watchUpdatingTracking?.updating??!1}initialize(){const e=document.createElement("div");e.className="esri-overlay-surface",this._set("surface",e),this._hiddenSurface=document.createElement("div"),this._hiddenSurface.setAttribute("style","visibility: hidden;"),e.appendChild(this._hiddenSurface),this._watchUpdatingTracking.addOnCollectionChange(()=>this.items,t=>{for(const i of t.added){const r=()=>i.render();this._callbacks.set(i,r),this._projector.append(this.surface,r)}for(const i of t.removed){const r=this._projector.detach(this._callbacks.get(i));this.surface.removeChild(r.domNode),this._callbacks.delete(i)}})}addItem(e){this.items.add(e)}removeItem(e){this.items.remove(e)}destroy(){this.items.removeAll(),this._callbacks.forEach(e=>this._projector.detach(e)),this._callbacks=null,this._projector=null,this._watchUpdatingTracking.destroy()}render(){this._projector.renderNow()}computeBoundingRect(e){const t=this._hiddenSurface,i=this._hiddenProjector;let r;const n=()=>(r=e.render(),r);i.append(t,n),i.renderNow();const a={left:0,top:0,right:0,bottom:0};if(r?.domNode){const o=r.domNode.getBoundingClientRect();a.left=o.left,a.top=o.top,a.right=o.right,a.bottom=o.bottom}for(i.detach(n);t.firstChild;)t.removeChild(t.firstChild);return a}overlaps(e,t){const i=this.computeBoundingRect(e),r=this.computeBoundingRect(t);return Math.max(i.left,r.left)<=Math.min(i.right,r.right)&&Math.max(i.top,r.top)<=Math.min(i.bottom,r.bottom)}get hasVisibleItems(){return this.items.some(e=>e.visible)}async prepare(){await document.fonts.load(this._fontString()).catch(()=>{})}renderCanvas(e,t){const i=!!t?.disableDecorations;if(!this.items.some(n=>n.visible&&!(i&&n.isDecoration)))return;const r=e.getContext("2d");r.save(),r.font=this._fontString(),this.items.forEach(n=>{i&&n.isDecoration||(r.save(),n.renderCanvas(r),r.restore())}),r.restore()}_fontString(){return`10px ${getComputedStyle(this.surface).fontFamily}`}};u([p({readOnly:!0})],po.prototype,"surface",void 0),u([p({readOnly:!0})],po.prototype,"items",void 0),u([p({readOnly:!0})],po.prototype,"needsRender",null),u([p({readOnly:!0})],po.prototype,"_watchUpdatingTracking",void 0),u([p({readOnly:!0})],po.prototype,"updating",null),po=u([R("esri.views.overlay.ViewOverlay")],po);const bC=po,xy=[0,0];function Z4(s){const e=(s.ownerDocument||window.document).defaultView,t=s.getBoundingClientRect();return xy[0]=t.left+(e?.pageXOffset??0),xy[1]=t.top+(e?.pageYOffset??0),xy}function wC(s){s&&(s.textContent="",s.parentNode&&s.parentNode.removeChild(s))}function X4(s){const e=document.createElement("div");return s.appendChild(e),e}const Sc=16,$u=750,Y4=512,K4=2,J4=s=>{const e=s;let t=class extends e{constructor(...i){super(...i),this._freqInfo={freq:Sc,time:$u},this._overlayRenderTaskHandle=null,this.aria={},this.height=0,this.messagesCommon=null,this.overlay=null,this.position=null,this.resizing=!1,this.root=null,this.surface=null,this.suspended=!0,this.userContent=null,this.width=0,this.widthBreakpoint=null,this.addHandles([$(()=>this.cursor,r=>{const{surface:n}=this;n&&n.setAttribute("data-cursor",r)}),$(()=>this.navigating,r=>{const{surface:n}=this;n&&n.setAttribute("data-navigating",r.toString())}),$(()=>[this.aria,this.surface],()=>this._updateAria(),{initial:!0})])}initialize(){const i=this;this.addHandles([$(()=>this.ui,(r,n)=>this._handleUIChange(r,n),Re),i.on("focus",()=>this.notifyChange("focused")),i.on("blur",()=>this.notifyChange("focused"))])}destroy(){this.destroyed||(this.ui?.destroy(),this.container=null)}get container(){return this._get("container")??null}set container(i){const r=this._get("container"),n=Ew(i);if(n||typeof i!="string"||j.getLogger(this).error("#container",`element with id '${i}' not found`),r===n)return;if(this._stopMeasuring(),r&&(r.classList.remove("esri-view"),this._overlayRenderTaskHandle&&(this._overlayRenderTaskHandle.remove(),this._overlayRenderTaskHandle=null),this.overlay&&(this.overlay.destroy(),this._set("overlay",null)),this.root&&(wC(this.root),this._set("root",null)),this.userContent&&(Xx(this.userContent,r),wC(this.userContent),this._set("userContent",null))),!n)return this._set("width",0),this._set("height",0),this._set("position",null),this._set("suspended",!0),this._set("surface",null),void this._set("container",null);n.classList.add("esri-view");const a=document.createElement("div");a.className="esri-view-user-storage",Xx(n,a),n.appendChild(a),this._set("userContent",a);const o=document.createElement("div");o.className="esri-view-root",n.insertBefore(o,n.firstChild),this._set("root",o);const l=document.createElement("div");l.className="esri-view-surface",l.setAttribute("role","application"),l.tabIndex=0,o.appendChild(l),this._set("surface",l);const c=new bC;o.appendChild(c.surface),this._set("overlay",c),this.addHandles($(()=>c.needsRender,h=>{h&&!this._overlayRenderTaskHandle?this._overlayRenderTaskHandle=Kl({render:()=>this.overlay?.render()}):this._overlayRenderTaskHandle=bi(this._overlayRenderTaskHandle)})),this.forceDOMReadyCycle(),this._set("container",n),this._startMeasuring()}get focused(){const i=document.activeElement===this.surface;return document.hasFocus()&&i}get size(){return[this.width,this.height]}set ui(i){const r=this._get("ui");r!==i&&r?.destroy(),this._set("ui",i)}blur(){this.surface?.blur()}focus(){this.surface?.focus()}pageToContainer(i,r,n){const a=this.position;return i-=a?a[0]:0,r-=a?a[1]:0,n?(n[0]=i,n[1]=r):n=[i,r],n}containerToPage(i,r,n){const a=this.position;return i+=a?a[0]:0,r+=a?a[1]:0,n?(n[0]=i,n[1]=r):n=[i,r],n}_updateAria(){const{surface:i,aria:r}=this;i&&(i.ariaLabelledByElements=r?.labelledByElements??null,i.ariaDescribedByElements=r?.describedByElements??null,i.ariaLabel=r?.label??null,i.ariaDescription=r?.description??null)}_handleUIChange(i,r){this.removeHandles("ui"),r&&r!==i&&r.destroy(),i&&(i.view=this,this.addHandles($(()=>this.root,n=>{i.container=n?X4(n):null},Re),"ui")),this._set("ui",i)}_stopMeasuring(){this.removeHandles("measuring"),this._get("resizing")&&this._set("resizing",!1)}_startMeasuring(){const i=this._freqInfo;i.freq=Sc,i.time=$u;const r=Kl({prepare:o=>{const l=this._measure(),c=this._freqInfo;if(c.time+=o.deltaTime,l&&(c.freq=Sc,this._get("resizing")||this._set("resizing",!0)),c.time<c.freq)return;c.time=0;const h=this._position();c.freq=h||l?Sc:Math.min($u,c.freq*K4),!l&&c.freq>=Y4&&(r.pause(),this._get("resizing")&&this._set("resizing",!1))}}),n=new ResizeObserver(o=>{i.freq=Sc,i.time=$u,r.resume()});this.container!=null&&n.observe(this.container);const a=xn(()=>n.disconnect());this.addHandles([IM(window,"resize",()=>{i.freq=Sc,i.time=$u,r.resume()}),a,r],"measuring"),this._measure(),this._position()}_measure(){const i=this.container,r=i?i.clientWidth:0,n=i?i.clientHeight:0;if(r===0||n===0)return this.suspended||this._set("suspended",!0),!1;const a=this.width,o=this.height;return r===a&&n===o?(this.suspended&&this._set("suspended",!1),!1):(this._set("width",r),this._set("height",n),this.suspended&&this._set("suspended",!1),this.emit("resize",{oldWidth:a,oldHeight:o,width:r,height:n}),!0)}_position(){const i=this.container,r=this.position,n=i&&Z4(i);return!!n&&(!r||n[0]!==r[0]||n[1]!==r[1])&&(this._set("position",[n[0],n[1]]),!0)}forceDOMReadyCycle(){}};return u([p()],t.prototype,"aria",void 0),u([p()],t.prototype,"container",null),u([p({readOnly:!0})],t.prototype,"focused",null),u([p({readOnly:!0})],t.prototype,"height",void 0),u([p()],t.prototype,"messagesCommon",void 0),u([p({type:bC})],t.prototype,"overlay",void 0),u([p({readOnly:!0})],t.prototype,"position",void 0),u([p({readOnly:!0})],t.prototype,"resizing",void 0),u([p({readOnly:!0})],t.prototype,"root",void 0),u([p({value:null,readOnly:!0})],t.prototype,"size",null),u([p({readOnly:!0})],t.prototype,"surface",void 0),u([p({readOnly:!0})],t.prototype,"suspended",void 0),u([p({nonNullable:!0})],t.prototype,"ui",null),u([p({readOnly:!0})],t.prototype,"userContent",void 0),u([p({readOnly:!0})],t.prototype,"width",void 0),u([p()],t.prototype,"widthBreakpoint",void 0),t=u([R("esri.views.DOMContainer")],t),t},dm="popup",xC="manual";function ta(s){return s!=null&&"open"in s&&"declaredClass"in s}function Ga(s){return!!s&&s.tagName.toLowerCase()==="arcgis-popup"&&"open"in s}function ek(s,e,t){const[i,r,n]=e;if(t){const[a,o,l]=t;a&&ta(o)&&(o.view=null,a.remove(o,dm),o!==r&&r&&o.destroy()),a&&l&&Ga(l)&&(l.view=null,a.remove(l,dm),l!==n&&n&&l.remove())}i&&ta(r)&&(r.view=s,i.add(r,{key:dm,position:xC,internal:!0})),i&&n&&Ga(n)&&(n.view=s,i.add(n,{key:dm,position:xC,internal:!0}))}async function tk(s,e){const{popup:t,popupElement:i}=s;ta(t)?await pm(t,null,e):i&&Ga(i)?await pm(null,i,e):e?.defer(async()=>{await s.setupPopup();const{popup:r,popupElement:n}=s;ta(r)&&!s.destroyed&&s.ready&&s.popupEnabled?await pm(r,null,e):n&&Ga(n)&&await pm(null,n,e)})}function ik(s,e){const{popup:t,popupElement:i}=s;if(ta(t))return t.open(e);i&&Ga(i)&&i.open(e)}function sk(s,e){ta(s)&&s.close(),e&&Ga(e)&&(e.visible=!1)}async function pm(s,e,t){if(ta(s)){const i=await s.viewModel.handleViewClick(t);return void(i?.promises?.length?s.open(i):s.visible&&s.close())}if(e&&Ga(e)){const i=await e.handleViewClick(t);i?.promises?.length?e.open(i):e.visible&&(e.visible=!1)}}const PR=Ze("mac")?"Meta":"Control",rk=new Set(["Alt","Control","Meta","Shift","Ctrl","Primary"]),nk=s=>rk.has(s);let ak=class{constructor(e,t=[]){this.eventType=e,this.keyModifiers=t}matches(e){if(e.type!==this.eventType)return!1;if(this.keyModifiers.length===0)return!0;const t=e.modifiers;for(const i of this.keyModifiers)if(!t.has(i))return!1;return!0}},Gi=class{constructor(e){this._manager=null,this._incoming={},this._outgoing={},this._incomingEventMatches=null,this._incomingEventTypes=null,this._outgoingEventTypes=null,this._hasSideEffects=e}get incomingEventMatches(){if(!this._incomingEventMatches){this._incomingEventMatches=[];for(const e in this._incoming){const t=this._incoming[e];for(const i of t)this._incomingEventMatches.push(i.match)}}return this._incomingEventMatches}get incomingEventTypes(){return this._incomingEventTypes||(this._incomingEventTypes=this.incomingEventMatches.map(e=>e.eventType)),this._incomingEventTypes}get outgoingEventTypes(){return this._outgoingEventTypes||(this._outgoingEventTypes=Object.keys(this._outgoing)),this._outgoingEventTypes}get hasSideEffects(){return this._hasSideEffects}get hasPendingInputs(){return!1}onInstall(e){this._manager||(e.setEventCallback(t=>this._handleEvent(t)),e.setUninstallCallback(()=>this._onUninstall()),this._manager=e)}onUninstall(){}registerIncoming(e,t,i){let r;typeof t=="function"?(i=t,r=[]):r=t||[];const n=typeof e=="string"?new ak(e,r):e,a=()=>{this._incomingEventTypes=null,this._incomingEventMatches=null},o=h=>{const d=this._incoming[h.match.eventType];if(d){const m=d.indexOf(h);d.splice(m,1),a(),this._manager&&this._manager.updateDependencies()}},l=new ok(n,i,{onPause:o,onRemove:o,onResume:h=>{const d=this._incoming[h.match.eventType];d&&!d.includes(h)&&(d.push(h),a(),this._manager&&this._manager.updateDependencies())}});let c=this._incoming[n.eventType];return c||(c=[],this._incoming[n.eventType]=c),c.push(l),a(),this._manager&&this._manager.updateDependencies(),l}registerOutgoing(e){if(this._outgoing[e])throw new Error("There is already a callback registered for this outgoing InputEvent: "+e);const t=new lk(e,{onEmit:(i,r,n,a)=>{this._manager?.emit(i.eventType,r,n,a)},onRemove:i=>{delete this._outgoing[i.eventType],this._manager?.updateDependencies()}});return this._outgoing[e]=t,this._outgoingEventTypes=null,this._manager&&this._manager.updateDependencies(),t}startCapturingPointer(e){this._manager?.setPointerCapture(e,!0)}stopCapturingPointer(e){this._manager?.setPointerCapture(e,!1)}refreshHasPendingInputs(){this._manager?.refreshHasPendingInputs()}_onUninstall(){this._manager&&(this.onUninstall(),this._manager=null)}_handleEvent(e){const t=this._incoming[e.type];if(t){for(const i of t)if(i.match.matches(e)&&(i.callback?.(e),e.shouldStopPropagation()))break}}},ok=class{constructor(e,t,i){this.match=e,this._callback=t,this._handler=i}pause(){this._handler.onPause(this)}resume(){this._handler.onResume(this)}remove(){this._handler.onRemove(this)}get callback(){return this._callback}},lk=class{constructor(e,t){this.eventType=e,this._removed=!1,this._handler=t}emit(e,t,i){this._removed||this._handler.onEmit(this,e,t,i)}remove(){this._removed=!0,this._handler.onRemove(this)}},ck=class extends Gi{constructor(e){super(!0),this._onChange=e,this._value="mouse",this._x=null,this._y=null,this._id=null,this.registerIncoming("pointer-move",t=>this._update(t.data))}_update(e){const t=e.native.pointerType==="touch"?"touch":"mouse",{x:i,y:r,native:{pointerId:n}}=e;t===this._value&&this._x===i&&this._y===r&&this._id===n||(this._value=t,this._x=i,this._y=r,this._id=n,this._onChange(n,t,i,r))}},hk=class extends Gi{get multiTouchActive(){return this._multiTouchActive.value}constructor(){super(!0),this._activeTouchPointerIds=new Set,this._multiTouchActive=rs(!1),this._onPointerAdd=({data:e})=>{e.pointerType==="touch"&&(this._activeTouchPointerIds.add(e.native.pointerId),this._update())},this._onPointerRemove=({data:e})=>{e.pointerType==="touch"&&(this._activeTouchPointerIds.delete(e.native.pointerId),this._update())},this.registerIncoming("pointer-down",this._onPointerAdd),this.registerIncoming("pointer-up",this._onPointerRemove),this.registerIncoming("pointer-capture-lost",this._onPointerRemove),this.registerIncoming("pointer-cancel",this._onPointerRemove)}_update(){this._multiTouchActive.value=this._activeTouchPointerIds.size>1}},ja=class{constructor(e,t){this._owner=t,this._properties={},this._afterDispatchHandle=null;for(const i in e){const r=e[i],n=new J3(r,void 0,void 0,2,2);this._properties[i]={pool:n,acquired:[]}}this._afterDispatchHandle=LM(()=>this._release())}destroy(){this._afterDispatchHandle&&(this._afterDispatchHandle.remove(),this._afterDispatchHandle=null);for(const e in this._properties){const t=this._properties[e];for(const i of t.acquired)Ix(i)||t.pool.release(i);t.pool.destroy(),t.pool=null,t.acquired=null}this._properties=null,this._owner=null}get(e){const t=this._owner._get(e),i=this._properties[e];let r=i.pool.acquire();for(i.acquired.push(r);r===t;)r=i.pool.acquire(),i.acquired.push(r);return eI(),r}_release(){for(const e in this._properties){const t=this._properties[e];let i=0;for(const r of t.acquired)Ix(r)?t.acquired[i++]=r:t.pool.release(r);t.acquired.length=i}}},uk=class{constructor(){this.id=0,this.type="mouse",this.location=dr()}},tn=class extends te{constructor(e){super(e),this._pointerCaptures=new Map,this._nameToGroup={},this._handlers=[],this._handlersPriority=[],this._currentPropagation=null,this._updateDependenciesAfterPropagation=!1,this._sourceEvents=new Set,this._keyModifiers=new Set,this._activeKeyModifiers=new Set,this._stoppedPropagationEventIds=new Set,this.primaryKey=PR,this._propertiesPool=new ja({latestPointerInfo:()=>new uk},this),this._latestPointerInfo=void 0,this._paused=!1,this._testTimestamp=void 0}initialize(){this.eventSource.onEventReceived=this._onEventReceived.bind(this),this._installRecognizers()}destroy(){const e=Object.keys(this._nameToGroup);for(const t of e)this.uninstallHandlers(t);this.eventSource.destroy(),this._currentPropagation=null,this._propertiesPool.destroy()}get hasPendingInputs(){return this._handlers.some(e=>e.handler.hasPendingInputs)}get multiTouchActive(){return this._multiTouchHandler.multiTouchActive}get latestPointerInfo(){return this._latestPointerInfo}get updating(){return this.hasPendingInputs||this._paused}installHandlers(e,t,i=Fa.INTERNAL){if(this._nameToGroup[e]||t.length===0)return;const r={name:e,handlers:t.map(n=>({handler:n,active:!0,removed:!1,priorityIndex:0,groupPriority:i,eventCallback:null,uninstallCallback:null}))};this._nameToGroup[e]=r;for(let n=r.handlers.length-1;n>=0;n--){const a=r.handlers[n];this._handlers.push(a),a.handler.onInstall({updateDependencies:()=>{this.updateDependencies()},emit:(o,l,c,h,d)=>{this._emitInputEvent(a.priorityIndex+1,o,l,c,d,h)},setPointerCapture:(o,l)=>{this._setPointerCapture(r,a,o,l)},setEventCallback:o=>{a.eventCallback=o},setUninstallCallback:o=>{a.uninstallCallback=o},refreshHasPendingInputs:()=>{this.notifyChange("hasPendingInputs")}})}this.updateDependencies()}uninstallHandlers(e){const t=this._nameToGroup[e];t?(t.handlers.forEach(i=>{i.removed=!0,i.uninstallCallback?.()}),delete this._nameToGroup[e],this._currentPropagation?this._currentPropagation.needsHandlerGarbageCollect=!0:this._garbageCollectRemovedHandlers()):j.getLogger(this).error("There is no InputHandler group registered under the name `"+e+"`")}hasHandlers(e){return this._nameToGroup[e]!==void 0}isModifierKeyDown(e){return this._activeKeyModifiers.has(e)}updateDependencies(){if(this._currentPropagation)return void(this._updateDependenciesAfterPropagation=!0);this._updateDependenciesAfterPropagation=!1;const e=new Set,t=new Set;this._handlersPriority=[];for(let i=this._handlers.length-1;i>=0;i--){const r=this._handlers[i];r.priorityIndex=i,this._handlersPriority.push(r)}this._handlersPriority=this._sortHandlersPriority(this._handlersPriority);for(let i=this._handlersPriority.length-1;i>=0;i--){const r=this._handlersPriority[i];r.priorityIndex=i;let n=r.handler.hasSideEffects;if(!n){for(const a of r.handler.outgoingEventTypes)if(e.has(a)){n=!0;break}}if(n)for(const a of r.handler.incomingEventMatches){e.add(a.eventType);for(const o of a.keyModifiers)nk(o)||t.add(o)}r.active=n}this._sourceEvents=e,this._keyModifiers=t,this._pointerCaptures.size>0&&this._sourceEvents.add("pointer-capture-lost"),this._keyModifiers.size>0&&(this._sourceEvents.add("key-down"),this._sourceEvents.add("key-up")),this.eventSource&&(this.eventSource.activeEvents=this._sourceEvents)}_setLatestPointer(e,t,i,r){const n=this._latestPointerInfo;if(n==null||n.id!==e||n.type!==t||n.location.x!==i||n.location.y!==r){const a=this._propertiesPool.get("latestPointerInfo");a.id=e,a.type=t,a.location.x=i,a.location.y=r,this._latestPointerInfo=a}}_onEventReceived(e,t){if(e==="pointer-capture-lost"){const n=t;this._pointerCaptures.delete(n.native.pointerId)}this._updateKeyModifiers(e,t);const i=this._testTimestamp??t.native?.timestamp,r=t.native?.cancelable;this._emitInputEventFromSource(e,t,i,r)}_updateKeyModifiers(e,t){if(!t)return;let i=!1;const r=()=>{i||(this._activeKeyModifiers=new Set(this._activeKeyModifiers),i=!0)},n=(o,l)=>{l&&!this._activeKeyModifiers.has(o)?(r(),this._activeKeyModifiers.add(o)):!l&&this._activeKeyModifiers.has(o)&&(r(),this._activeKeyModifiers.delete(o))};if(e==="key-down"||e==="key-up"){const o=t.key;this._keyModifiers.has(o)&&n(o,e==="key-down")}const a=t.native;n("Alt",!!a?.altKey),n("Control",!!a?.ctrlKey),n("Ctrl",!!a?.ctrlKey),n("Shift",!!a?.shiftKey),n("Meta",!!a?.metaKey),n("Primary",this._activeKeyModifiers.has(this.primaryKey))}_installRecognizers(){this._latestPointerHandler=new ck((e,t,i,r)=>this._setLatestPointer(e,t,i,r)),this._multiTouchHandler=new hk,this.installHandlers("input-manager-logic",[this._latestPointerHandler,this._multiTouchHandler],Fa.ALWAYS),this.recognizers.length>0&&this.installHandlers("default",this.recognizers,Fa.INTERNAL)}_setPointerCapture(e,t,i,r){const n=e.name+"-"+t.priorityIndex,a=this._pointerCaptures.get(i.pointerId)||new Set;this._pointerCaptures.set(i.pointerId,a),r?(a.add(n),a.size===1&&this.eventSource&&this.eventSource.setPointerCapture(i,!0)):a.has(n)&&(a.delete(n),a.size===0&&(this._pointerCaptures.delete(i.pointerId),this.eventSource&&this.eventSource.setPointerCapture(i,!1)))}_garbageCollectRemovedHandlers(){this._handlers=this._handlers.filter(e=>!e.removed),this.updateDependencies()}_emitInputEventFromSource(e,t,i,r){this._emitInputEvent(0,e,t,i,r)}_emitInputEvent(e,t,i,r,n,a){const o=r??this._currentPropagation?.timestamp??performance.now(),l=n??!1,c={event:new dk(t,i,o,a||this._activeKeyModifiers,l),priorityIndex:e};this._currentPropagation?this._currentPropagation.events.push(c):this._doNewPropagation(c)}_doNewPropagation(e){this._currentPropagation={events:new D0,currentHandler:null,needsHandlerGarbageCollect:!1,timestamp:e.event.timestamp},this._currentPropagation.events.push(e),this._continuePropagation()}_continuePropagation(){this._paused=!1;const e=this._currentPropagation;if(e){for(;e.events.length>0;){const{event:t,priorityIndex:i}=e.events.pop(),r=t.data?.eventId;if(!(r!=null&&this._stoppedPropagationEventIds.has(r)))for(e.currentHandler=this._handlersPriority[i];e.currentHandler;){if(e.currentHandler.removed)e.needsHandlerGarbageCollect=!0;else{if(e.currentHandler.active&&!t.shouldStopPropagation()&&e.currentHandler.eventCallback?.(t),t.shouldStopPropagation()){r!=null&&this._stoppedPropagationEventIds.add(r);break}if(t.shouldPausePropagation(()=>this._continuePropagation()))return void this._pausePropagation({event:t,priorityIndex:e.currentHandler.priorityIndex+1})}e.currentHandler=this._handlersPriority[e.currentHandler.priorityIndex+1]}}e.needsHandlerGarbageCollect&&this._garbageCollectRemovedHandlers(),this.hasPendingInputs||this._stoppedPropagationEventIds.clear(),this._currentPropagation=null,this._updateDependenciesAfterPropagation&&this.updateDependencies()}}_pausePropagation(e){const t=new D0;t.push(e);const i=this._currentPropagation;if(i){for(;i.events.length;)t.push(i.events.pop());i.events=t,i.currentHandler=null,this._paused=!0}}_compareHandlerPriority(e,t){if(e.handler.hasSideEffects!==t.handler.hasSideEffects)return e.handler.hasSideEffects?1:-1;if(e.groupPriority!==t.groupPriority)return e.groupPriority>t.groupPriority?-1:1;for(const i of e.handler.incomingEventMatches)for(const r of t.handler.incomingEventMatches){if(i.eventType!==r.eventType)continue;const n=i.keyModifiers.filter(a=>r.keyModifiers.includes(a));if(n.length===i.keyModifiers.length!=(n.length===r.keyModifiers.length))return i.keyModifiers.length>r.keyModifiers.length?-1:1}return e.priorityIndex>t.priorityIndex?-1:1}_sortHandlersPriority(e){const t=[];for(const i of e){let r=0;for(;r<t.length&&this._compareHandlerPriority(i,t[r])>=0;)r++;t.splice(r,0,i)}return t}get test(){}};u([p({readOnly:!0})],tn.prototype,"hasPendingInputs",null),u([p({constructOnly:!0})],tn.prototype,"eventSource",void 0),u([p({constructOnly:!0})],tn.prototype,"recognizers",void 0),u([p()],tn.prototype,"multiTouchActive",null),u([p()],tn.prototype,"_latestPointerInfo",void 0),u([p()],tn.prototype,"latestPointerInfo",null),u([p()],tn.prototype,"_paused",void 0),u([p({readOnly:!0})],tn.prototype,"updating",null),tn=u([R("esri.views.input.InputManager")],tn);let dk=class{constructor(e,t,i,r,n){this.type=e,this.data=t,this.timestamp=i,this.modifiers=r,this.cancelable=n,this._propagationState=0,this._resumeCallback=null}stopPropagation(){this._propagationState|=1}shouldStopPropagation(){return!!(1&this._propagationState)}defer(e){this._propagationState|=2;const t=(i,r)=>{this._propagationState&=-3;const n=this._resumeCallback;if(this._resumeCallback=null,n&&n(),r)throw i;return i};return(typeof e=="function"?e():e).then(i=>t(i,!1),i=>t(i,!0))}shouldPausePropagation(e){return!!(2&this._propagationState)&&(this._resumeCallback=e,!0)}preventDefault(){this.data.native.preventDefault()}};const Fa={ALWAYS:1,DEFAULT:0,TOOL:-1,WIDGET:-2,INTERNAL:-3},pk=s=>{const e=s;let t=class extends e{constructor(){super(...arguments),this._popupSetupTask=null,this.popup={},this.popupEnabled=!0}initialize(){this.addHandles([$(()=>[this.ui,this.popup,this.popupElement],([i,r,n],a)=>{const[o,l,c]=a??[];ek(this,[i,r,n],[o,l,c])},Ve),this.on("click",i=>{this.popup&&this.popupEnabled&&(i.pointerType!=="mouse"||i.button===0)&&tk(this,i)},Fa.WIDGET)]),op(()=>this.ready&&this.popupEnabled&&!this.updating).then(()=>k(()=>import("./Popup-BcZl2Ty0.js").then(i=>i.P),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166])))}destroy(){this.destroyed||this.closePopup()}async openPopup(i){if(ta(this.popup))return this.popup.open(i);if(this.popupElement&&Ga(this.popupElement))this.popupElement.open(i).catch(()=>{});else try{if(await this.setupPopup(),!this.popup)return void j.getLogger(this).error(new me("view:null-popup","Popup is null and can't be opened"));ik(this,i)}catch{}}closePopup(){this._popupSetupTask?.abort(),sk(this.popup,this.popupElement)}async fetchPopupFeatures(i,r){return await this.when(),this._popupHitsToFeatures(await this._getPopupHits(i,r),r)}async setupPopup(){if(this._popupSetupTask?.abort(),this.popup&&!ta(this.popup))return this._popupSetupTask=Za(async i=>{if(!this.popupEnabled||!Ga(this.popupElement))if(this.dependencies.popup&&typeof this.dependencies.popup=="function")await this.dependencies.popup(),He(i),customElements.get("arcgis-popup")||j.getLogger(this).error(new me("view:undefined-popup-element","`arcgis-popup` custom element is undefined and can't be opened")),this.popupElement=document.createElement("arcgis-popup");else{const{default:r}=await k(()=>import("./Popup-BcZl2Ty0.js").then(a=>a.P),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166]));if(He(i),!this.popup||ta(this.popup))return;const n=this.popup;if("open"in n||"close"in n){const{open:a,close:o,...l}=n;this.popup=new r({...l})}else this.popup=new r(n)}}),this._popupSetupTask.promise}async _popupHitsToFeatures({location:i,hits:r},n){const a=[],o=[];let l=!1;const c=tI(n,Ze("popup-view-fetch-timeout")??fk),h=f=>{const g=new mk(f);return o.push(g),a.push(g.promise),g},d=f=>{const g=o.at(-1);return g&&g.layerView===f&&!l?g:h(f)};for(const f of r)"graphic"in f?(d(f.layerView).graphics.push(f.graphic),l=!1):(a.push(f.layerView.fetchPopupFeaturesAtLocation(f.mapPoint,c)),l=!0);o.forEach(f=>f.resolve(c));const m=iI(a).then(f=>f.filter(g=>!!g).flat());return{pendingFeatures:a,allGraphicsPromise:m,location:i}}async _getPopupHits(i,r){const{hits:n,location:a}=await this.popupHitTest(i);He(r);const o=[];for(const l of n)if("graphic"in l){if(this._isValidPopupGraphic(l.graphic,r)){const c=this._isValidPopupGraphicsLayerView(l.layerView)?l.layerView:void 0;o.push({graphic:l.graphic,layerView:c})}}else this._isValidPopupLocationLayerView(l.layerView)&&o.push({mapPoint:l.mapPoint,layerView:l.layerView});return{hits:o,location:a}}_isValidPopupGraphic(i,r){return i&&!!i.getEffectivePopupTemplate(r?.defaultPopupTemplateEnabled)}_isValidPopupGraphicsLayerView(i){return!i||(!("layer"in i)||!i.suspended)&&"fetchPopupFeaturesFromGraphics"in i}_isValidPopupLocationLayerView(i){return(!("layer"in i)||!i.suspended)&&"fetchPopupFeaturesAtLocation"in i}};return u([p()],t.prototype,"popup",void 0),u([p()],t.prototype,"popupElement",void 0),u([p()],t.prototype,"popupEnabled",void 0),t=u([R("esri.views.PopupView")],t),t};let mk=class{constructor(e){this.layerView=e,this._resolver=sa(),this.graphics=[]}get promise(){return this._resolver.promise}resolve(e){const{layerView:t,graphics:i,_resolver:r}=this;if(!t)return r.resolve(i),r.promise;let n;return t.fetchPopupFeaturesFromGraphics(i,e).catch(a=>(n=a,null)).then(a=>{a?r.resolve(a):r.reject(n)}),r.promise}};const fk=5e3;let ya=class extends te{constructor(e){super(e),this.view=null,this.baseLayerViews=new Pt,this.groundLayerViews=new Pt,this.referenceLayerViews=new Pt,this._loadingHandle=$(()=>this.view?.map?.basemap,t=>{t&&t.load().catch(()=>{})},Re)}destroy(){this._set("view",null),this._loadingHandle=bi(this._loadingHandle),this.baseLayerViews.destroyAll(),this.groundLayerViews.destroyAll(),this.referenceLayerViews.destroyAll()}get suspended(){return this.view?.suspended??!0}get updating(){return this.view?.suspended?!1:!!this.view?.map?.basemap?.loaded&&(this.baseLayerViews.some(t=>t.updating)||this.groundLayerViews.some(t=>t.updating)||this.referenceLayerViews.some(t=>t.updating))}};u([p({constructOnly:!0})],ya.prototype,"view",void 0),u([p({readOnly:!0})],ya.prototype,"baseLayerViews",void 0),u([p({readOnly:!0})],ya.prototype,"groundLayerViews",void 0),u([p({readOnly:!0})],ya.prototype,"referenceLayerViews",void 0),u([p({readOnly:!0})],ya.prototype,"suspended",null),u([p({type:Boolean,readOnly:!0})],ya.prototype,"updating",null),ya=u([R("esri.views.BasemapView")],ya);const gk=ya;let sr=class extends te{constructor(e){super(e),this.factor=1.5,this.offset=dr(0,0),this.position=null,this.size=120,this.maskUrl=null,this.maskEnabled=!0,this.overlayUrl=null,this.overlayEnabled=!0,this.visible=!0}get version(){return this.commitProperty("factor"),this.commitProperty("offset"),this.commitProperty("position"),this.commitProperty("visible"),this.commitProperty("size"),this.commitProperty("maskUrl"),this.commitProperty("maskEnabled"),this.commitProperty("overlayUrl"),this.commitProperty("overlayEnabled"),(this._get("version")||0)+1}};u([p({type:Number})],sr.prototype,"factor",void 0),u([p({nonNullable:!0})],sr.prototype,"offset",void 0),u([p()],sr.prototype,"position",void 0),u([p({type:Number,range:{min:0}})],sr.prototype,"size",void 0),u([p()],sr.prototype,"maskUrl",void 0),u([p()],sr.prototype,"maskEnabled",void 0),u([p()],sr.prototype,"overlayUrl",void 0),u([p()],sr.prototype,"overlayEnabled",void 0),u([p({readOnly:!0})],sr.prototype,"version",null),u([p({type:Boolean})],sr.prototype,"visible",void 0),sr=u([R("esri.views.Magnifier")],sr);const MR=sr;function to(s){return!(s==null||typeof s!="object"||!("createQuery"in s)||!s.createQuery)}let yr=class extends fu{constructor(e){super(e),this._selectionMap=new E0,this._sources=new Pt,this._trashCan=[],this._layerEditHandles=new Pt,this._vizTaskId=0,this.view=null,this.showHighlight=!0,this.highlightName="default"}initialize(){this.addHandles([$(()=>[this.view,this.showHighlight],()=>this._refreshVisualization()),$(()=>this.view,e=>{e?.when().then(()=>this.syncSources())},Re),Ds(()=>this.sources,"change",e=>{const t=this._selectionMap,i=[];for(const r of e.removed){const n=t.get(r);n&&(t.delete(r),n.highlightHandle?.remove(),i.push({layer:r,selection:[],added:[],removed:[...n.selection]}))}this._refreshListeners(),i.length&&this._onSelectionChange(i)},{onListenerAdd:()=>this._refreshListeners()})])}destroy(){this.clear(),this._layerEditHandles.drain(bi)}get selections(){return Array.from(this._selectionMap.entries()).map(e=>{const[t,i]=e;return{layer:t,selection:[...i.selection]}})}get count(){let e=0;for(const t of this._selectionMap.values())e+=t.selection.length;return e}get hasSelection(){return this.count>0}get sources(){return this._sources}set sources(e){P$(e,this._sources)}syncSources(){const e=new Set,t=this.view?.map;if(!t)return;const i=r=>{v5(r)?(r.layers?.forEach(i),r.tables?.forEach(i)):b5(r)?(r.sublayers?.forEach(i),r.subtables?.forEach(i)):iC(r)?r.sublayers?.forEach(i):to(r)&&e.add(r)};t.allLayers.forEach(i),t.allTables.forEach(i),this.sources=[...e]}async getSelectedFeatures(e,t={},i="layerView"){const{view:r,selections:n}=this;if(!r&&i==="layerView")return j.getLogger(this).warn("Cannot query layer views without a view."),[];const a=(e?.length?n.filter(o=>e.includes(o.layer)):n).map(async o=>{const{layer:l,selection:c}=o;if(!c.length)return;const h=eh(l)?l.parent:l;if(h!=null){if(r&&i==="layerView"&&!CC(h)&&TC(h)){const d=await r.whenLayerView(h).catch(()=>null);if(d)return SC(d,c,t)}return SC(h,c,t)}}).filter(Mg);return(await Promise.all(a)).filter(Mg)}updateSelection(e){const t=new Map;for(const[n,a]of this._selectionMap)t.set(n,[...a.selection]);let i=!1;const r=e.current.concat(e.added);for(const n of r){const a=n.sourceLayer,o=n.getObjectId();if(this.sources.includes(a)&&(to(a)||eh(a))&&o!==null){const l=Aa(t,a,()=>[]);l.includes(o)||(l.push(o),i=!0)}}for(const n of e.removed){const a=n.sourceLayer,o=n.getObjectId();if(this.sources.includes(a)&&(to(a)||eh(a))&&o!==null){const l=t.get(a),c=l?.indexOf(o);c!==void 0&&c>=0&&(l?.splice(c,1),i=!0)}}if(i){const{_selectionMap:n,_trashCan:a}=this,o=[];for(const[l,c]of t){const h=n.get(l);h!==void 0&&a.push(h),n.set(l,{selection:c}),o.push({layer:l,selection:c,...v0(h!==void 0?h.selection:[],c)})}this._onSelectionChange(o)}}setSelection(e,t){this._setSelection(e,t)}getSelection(e){return this._selectionMap.get(e)?.selection}appendToSelection(e,t){const i=this._selectionMap.get(e),r=i!==void 0?[...i.selection]:[];for(const n of t)r.includes(n)||r.push(n);this._setSelection(e,r)}removeFromSelection(e,t){const i=this._selectionMap.get(e);if(!i)return;const r=[];for(const n of i.selection)t.includes(n)||r.push(n);this._setSelection(e,r)}toggleInSelection(e,t){const i=this._selectionMap.get(e);if(!i||i.selection.length===0)return void this._setSelection(e,t);const r=new Set(i.selection),n=new Set(t),a=sI(r,n);this._setSelection(e,Array.from(a))}clear(){const e=this._selectionMap.values();this._trashCan.push(...e);const t=[];for(const[i,r]of this._selectionMap.entries())t.push({layer:i,added:[],removed:[...r.selection],selection:[]});this._selectionMap.clear(),this._onSelectionChange(t)}_onSelectionChange(e){this._refreshVisualization(),this.emit("selection-change",{view:this.view,changes:e})}_refreshVisualization(){for(this._vizTaskId++;this._trashCan.length>0;)this._trashCan.pop()?.highlightHandle?.remove();if(this.view==null)return;const{sources:e,view:t,_selectionMap:i,showHighlight:r}=this,n=this._vizTaskId;for(const a of e){const o=i.get(a),l=eh(a)?a.parent:a;if(l!=null&&TC(l)){if(CC(l))continue;t.whenLayerView(l).then(c=>{o?.highlightHandle?.remove(),o!=null&&r&&n===this._vizTaskId&&"highlight"in c&&typeof c.highlight=="function"&&o.selection.length>0&&(o.highlightHandle=c.highlight(o.selection,this.highlightName))}).catch(()=>{o?.highlightHandle?.remove()})}}}_refreshListeners(){this._layerEditHandles.drain(bi);const e=new Set(this.sources.map(t=>eh(t)?t.parent:t));for(const t of e)to(t)&&"on"in t&&t.on&&this._layerEditHandles.push(t.on("edits",i=>this._onLayerEdit(i,t)))}_onLayerEdit(e,t){if(iC(t))this._onParentLayerEdit(e,t);else if(e.deletedFeatures.length&&this._selectionMap.has(t)){const i=[];e.deletedFeatures.forEach(({error:r,objectId:n})=>{n!=null&&r==null&&i.push(n)}),this.removeFromSelection(t,i)}}_onParentLayerEdit(e,t){const{deletedFeatures:i,edits:r,updatedFeatures:n}=e;if(r?.updateFeatures?.forEach(a=>{const o=a.getObjectId()??a.attributes[t.objectIdField];if(o==null||n.find(h=>h.objectId===o)?.error)return;const l=t.findSublayerForFeature(a);if(!to(l))return;const c=t.sublayers.find(h=>!(!to(h)||!this.getSelection(h)?.includes(o)));to(c)&&c!==l&&(this.removeFromSelection(c,[o]),this.appendToSelection(l,[o]))}),i.length){const a=[];i.forEach(({error:o,objectId:l})=>{l!=null&&o==null&&a.push(l)}),t.sublayers.forEach(o=>{to(o)&&this._selectionMap.has(o)&&this.removeFromSelection(o,a)})}}_setSelection(e,t){if(!this.sources.includes(e))throw new Error(`Cannot set selection on layer ${e.title} because it is not in 'sources'`);const i=this._selectionMap.get(e);if(i===void 0||!yk(i,{selection:t})){i!==void 0&&this._trashCan.push(i),this._selectionMap.set(e,{selection:[...t]});const r={layer:e,selection:[...t],...v0(i!==void 0?i.selection:[],t)};this._onSelectionChange([r])}}};u([p()],yr.prototype,"_selectionMap",void 0),u([p()],yr.prototype,"_sources",void 0),u([p({readOnly:!0,nonNullable:!0})],yr.prototype,"selections",null),u([p({readOnly:!0,nonNullable:!0})],yr.prototype,"count",null),u([p()],yr.prototype,"view",void 0),u([p({readOnly:!0,nonNullable:!0})],yr.prototype,"hasSelection",null),u([p()],yr.prototype,"showHighlight",void 0),u([p()],yr.prototype,"sources",null),u([p()],yr.prototype,"highlightName",void 0),yr=u([R("esri.views.SelectionManager")],yr);const CC=s=>eh(s)?s.parent?.isTable===!0:s.isTable,_k=s=>s.layer!==void 0,TC=s=>s?.when!==void 0,yk=(s,e)=>{if(s==null&&e==null)return!0;if(s!=null&&e==null||s==null&&e!=null)return!1;if(s!=null&&e!=null&&s.selection!=null&&e.selection!=null){const t=[...s.selection],i=[...e.selection];if(t.length!==i.length)return!1;t.sort(),i.sort();for(let r=0;r<t.length;r++)if(t[r]!==i[r])return!1}return!0},SC=async(s,e,t={})=>{let i;if(_k(s)){const r=s;i=r===void 0?null:await r.queryFeatures(new nC({...t,objectIds:e})).then(n=>({data:n,layer:s.layer}))}else{const r=s;i=r===void 0?null:await r.queryFeatures(new nC({...t,objectIds:e})).then(n=>({data:n,layer:r}))}return i},vk=yr;let rd=class extends pF(te){constructor(e){super(e),this.accentColor=new vi([255,127,0]),this.textColor=new vi([255,255,255])}};u([p({type:vi,nonNullable:!0})],rd.prototype,"accentColor",void 0),u([p({type:vi,nonNullable:!0})],rd.prototype,"textColor",void 0),rd=u([R("esri.views.Theme")],rd);const k0=rd,$R=["click","double-click","immediate-click","immediate-double-click","hold","drag","key-down","key-up","pointer-down","pointer-move","pointer-up","pointer-drag","mouse-wheel","pointer-enter","pointer-leave","gamepad","focus","blur"],RR={};function OR(s){return!!RR[s]}function bk(s){for(const e of s)if(!OR(e))return!1;return!0}$R.forEach(s=>{RR[s]=!0});let wk=class{constructor(e){this._handlers=new Map,this._counter=0,this._handlerCounts=new Map,this.view=e,this.inputManager=null}connect(e){e&&this.disconnect(),this.inputManager=e,this._handlers.forEach(({handler:t,priority:i},r)=>this.inputManager?.installHandlers(r,[t],i))}disconnect(){this.inputManager&&this._handlers.forEach((e,t)=>this.inputManager?.uninstallHandlers(t)),this.inputManager=null}destroy(){this.disconnect(),this._handlers.clear(),this.view=null}on(e,t,i,r){const n=Array.isArray(e)?e:e.split(",");if(!bk(n))return n.some(OR)&&console.error("Error: registering input events and other events on the view at the same time is not supported."),null;let a,o;Array.isArray(t)?o=t:(a=t,o=[]),typeof i=="function"?a=i:r=i,r=r??Fa.DEFAULT;const l=this._createUniqueGroupName(),c=new xk(this.view,n,o,a);this._handlers.set(l,{handler:c,priority:r});for(const h of n){const d=this._handlerCounts.get(h)||0;this._handlerCounts.set(h,d+1)}return this.inputManager&&this.inputManager.installHandlers(l,[c],r),xn(()=>this._removeHandler(l,n))}hasHandler(e){return!!this._handlerCounts.get(e)}_removeHandler(e,t){if(this._handlers.has(e)){this._handlers.delete(e);for(const i of t){const r=this._handlerCounts.get(i);r===void 0||(r===1?this._handlerCounts.delete(i):this._handlerCounts.set(i,r-1))}}this.inputManager&&this.inputManager.uninstallHandlers(e)}_createUniqueGroupName(){return this._counter+=1,`viewEvents_${this._counter}`}},xk=class extends Gi{constructor(e,t,i,r){super(!0),this._latestDragStart=void 0,this.view=e;for(const n of t)switch(n){case"click":this.registerIncoming("click",i,a=>r(Sk(e,a)));break;case"double-click":this.registerIncoming("double-click",i,a=>r(Pk(e,a)));break;case"immediate-click":this.registerIncoming("immediate-click",i,a=>r(Mk(e,a)));break;case"immediate-double-click":this.registerIncoming("immediate-double-click",i,a=>r($k(e,a)));break;case"hold":this.registerIncoming("hold",i,a=>r(Rk(e,a)));break;case"drag":this.registerIncoming("drag",i,a=>{const o=this._wrapDrag(a);o&&r(o)});break;case"key-down":this.registerIncoming("key-down",i,a=>r(Ok(a)));break;case"key-up":this.registerIncoming("key-up",i,a=>r(Dk(a)));break;case"pointer-down":this.registerIncoming("pointer-down",i,a=>r(Ru(a,"pointer-down")));break;case"pointer-move":this.registerIncoming("pointer-move",i,a=>r(Ru(a,"pointer-move")));break;case"pointer-up":this.registerIncoming("pointer-up",i,a=>r(Ru(a,"pointer-up")));break;case"pointer-drag":this.registerIncoming("pointer-drag",i,a=>r(Ek(a)));break;case"mouse-wheel":this.registerIncoming("mouse-wheel",i,a=>r(Ak(a)));break;case"pointer-enter":this.registerIncoming("pointer-enter",i,a=>r(Ru(a,"pointer-enter")));break;case"pointer-leave":this.registerIncoming("pointer-leave",i,a=>r(Ru(a,"pointer-leave")));break;case"gamepad":this.registerIncoming("gamepad",i,a=>{r(Ik(a))});break;case"focus":this.registerIncoming("focus",i,a=>{r(Ck(a))});break;case"blur":this.registerIncoming("blur",i,a=>{r(Tk(a))})}}_wrapDrag(e){const t=e.data,{x:i,y:r}=t.center,{action:n,pointerType:a,button:o}=t;if(n==="start"&&(this._latestDragStart=t),!this._latestDragStart)return;const l=t.pointer.native,c=t.buttons,{cancelable:h,timestamp:d}=e,m={x:this._latestDragStart.center.x,y:this._latestDragStart.center.y};return n==="end"&&(this._latestDragStart=void 0),{type:"drag",action:n,x:i,y:r,origin:m,pointerType:a,button:o,buttons:c,radius:t.radius,angle:ic(t.angle),native:l,timestamp:d,cancelable:h,stopPropagation:()=>e.stopPropagation(),defer:f=>e.defer(f),preventDefault:()=>e.preventDefault()}}};function Ck(s){return{type:"focus",timestamp:s.timestamp,native:s.data.native,cancelable:s.cancelable,stopPropagation:()=>s.stopPropagation(),defer:e=>s.defer(e),preventDefault:()=>s.preventDefault()}}function Tk(s){return{type:"blur",timestamp:s.timestamp,native:s.data.native,cancelable:s.cancelable,stopPropagation:()=>s.stopPropagation(),defer:e=>s.defer(e),preventDefault:()=>s.preventDefault()}}function Sk(s,e){const{pointerType:t,button:i,buttons:r,x:n,y:a,native:o,eventId:l}=e.data,{cancelable:c,timestamp:h}=e;return{type:"click",pointerType:t,button:i,buttons:r,x:n,y:a,native:o,timestamp:h,screenPoint:dr(n,a),mapPoint:Gp(s,n,a),eventId:l,cancelable:c,stopPropagation:()=>e.stopPropagation(),defer:d=>e.defer(d),preventDefault:()=>e.preventDefault()}}function Pk(s,e){const{pointerType:t,button:i,buttons:r,x:n,y:a,native:o,eventId:l}=e.data,{cancelable:c,timestamp:h}=e;return{type:"double-click",pointerType:t,button:i,buttons:r,x:n,y:a,native:o,timestamp:h,mapPoint:Gp(s,n,a),eventId:l,cancelable:c,stopPropagation:()=>e.stopPropagation(),defer:d=>e.defer(d),preventDefault:()=>e.preventDefault()}}function Mk(s,e){const{pointerType:t,button:i,buttons:r,x:n,y:a,native:o,eventId:l}=e.data,c=o.pointerId,{cancelable:h,timestamp:d}=e;return{type:"immediate-click",pointerId:c,pointerType:t,button:i,buttons:r,x:n,y:a,native:o,timestamp:d,mapPoint:Gp(s,n,a),eventId:l,cancelable:h,stopPropagation:()=>e.stopPropagation(),defer:m=>e.defer(m),preventDefault:()=>e.preventDefault()}}function $k(s,e){const{pointerType:t,button:i,buttons:r,x:n,y:a,native:o,eventId:l}=e.data,c=o.pointerId,{cancelable:h,timestamp:d}=e;return{type:"immediate-double-click",pointerId:c,pointerType:t,button:i,buttons:r,x:n,y:a,native:o,timestamp:d,mapPoint:Gp(s,n,a),eventId:l,cancelable:h,stopPropagation:()=>e.stopPropagation(),defer:m=>e.defer(m),preventDefault:()=>e.preventDefault()}}function Rk(s,e){const{pointerType:t,button:i,buttons:r,x:n,y:a,native:o}=e.data,{cancelable:l,timestamp:c}=e;return{type:"hold",pointerType:t,button:i,buttons:r,x:n,y:a,native:o,timestamp:c,mapPoint:Gp(s,n,a),cancelable:l,stopPropagation:()=>e.stopPropagation(),defer:h=>e.defer(h),preventDefault:()=>e.preventDefault()}}function Gp(s,e,t){return s.toMap(dr(e,t),{exclude:[]})}function Ok(s){const{key:e,repeat:t,native:i}=s.data,{cancelable:r,timestamp:n}=s;return{type:"key-down",key:e,repeat:t,native:i,timestamp:n,cancelable:r,stopPropagation:()=>s.stopPropagation(),defer:a=>s.defer(a),preventDefault:()=>s.preventDefault()}}function Dk(s){const{key:e,native:t}=s.data,{cancelable:i,timestamp:r}=s;return{type:"key-up",key:e,native:t,timestamp:r,cancelable:i,stopPropagation:()=>s.stopPropagation(),defer:n=>s.defer(n),preventDefault:()=>s.preventDefault()}}function Ru(s,e){const{x:t,y:i,button:r,buttons:n,native:a,eventId:o}=s.data,l=a.pointerId,c=a.pointerType,{cancelable:h,timestamp:d}=s;return{type:e,x:t,y:i,pointerId:l,pointerType:c,button:r,buttons:n,native:a,timestamp:d,eventId:o,cancelable:h,stopPropagation:()=>s.stopPropagation(),defer:m=>s.defer(m),preventDefault:()=>s.preventDefault()}}function Ek(s){const{x:e,y:t,buttons:i,native:r,eventId:n}=s.data.currentEvent,{button:a}=s.data.startEvent,o=s.data.startEvent.native.pointerId,l=s.data.startEvent.native.pointerType,c=s.data.action,h={x:s.data.startEvent.x,y:s.data.startEvent.y},{cancelable:d,timestamp:m}=s;return{type:"pointer-drag",x:e,y:t,pointerId:o,pointerType:l,button:a,buttons:i,action:c,origin:h,native:r,timestamp:m,eventId:n,cancelable:d,stopPropagation:()=>s.stopPropagation(),defer:f=>s.defer(f),preventDefault:()=>s.preventDefault()}}function Ak(s){const{cancelable:e,data:t,timestamp:i}=s,{x:r,y:n,deltaY:a,native:o}=t;return{type:"mouse-wheel",x:r,y:n,deltaY:a,native:o,timestamp:i,cancelable:e,stopPropagation:()=>s.stopPropagation(),defer:l=>s.defer(l),preventDefault:()=>s.preventDefault()}}function Ik(s){const{action:e,state:t,device:i}=s.data,{cancelable:r,timestamp:n}=s,{buttons:a,axes:o}=t;return{type:"gamepad",device:i,timestamp:n,action:e,buttons:a,axes:o,cancelable:r,stopPropagation:()=>s.stopPropagation(),defer:l=>s.defer(l),preventDefault:()=>s.preventDefault()}}const DR="z",ER="r",AR={cancel:"Escape",complete:"Enter"},Hie={...AR,redo:ER,undo:DR,center:"Alt",constraint:"Shift",delete:["Backspace","Delete"],vertexAdd:"f",pan:" "},qie={toggle:"Control"},Gie={enterInputMode:"Tab",commit:"Enter",discard:"Escape",next:"Tab"},jie={moveUp:{key:"ArrowUp",modifier:"Shift",repeats:!0},moveDown:{key:"ArrowDown",modifier:"Shift",repeats:!0},moveLeft:{key:"ArrowLeft",modifier:"Shift",repeats:!0},moveRight:{key:"ArrowRight",modifier:"Shift",repeats:!0},scaleUp:{key:"+",modifier:"Shift"},scaleDown:{key:"-",modifier:"Shift"},factorModifier:{key:PR,continuePropagation:!0},toggleOpacity:"t",preserveAspectRatio:{key:"Shift",continuePropagation:!0},rotateIncrements:{key:"Shift",continuePropagation:!0},editSourcePoints:{key:"Alt",continuePropagation:!0},undo:DR,redo:ER};let Wie=class{constructor(){this._bindings=new Map}add(e,t){return this.addToggle(e,i=>{i.type==="key-down"&&t(i)})}addToggle(e,t){const i=Lk.fromDefinition(e,t),r=Aa(this._bindings,i.key,()=>[]);return r.push(i),xn(()=>gw(r,i))}register(e,t=Fa.WIDGET){return rI([e.on("key-down",i=>this.dispatch(e.inputManager,i),t),e.on("key-up",i=>this.dispatch(e.inputManager,i),t)])}dispatch(e,t){const i=t.key,r=this._bindings.get(i);if(r)for(const n of r)n.process(e,t)}},Lk=class z0{constructor(e,t,i,r,n){this.key=e,this.modifiers=t,this.repeats=i,this.continuePropagation=r,this.callback=n}process(e,t){if(!(t.key!==this.key||"repeat"in t&&t.repeat&&!this.repeats)){for(const i of this.modifiers)if(!e.isModifierKeyDown(i))return;this.continuePropagation||t.stopPropagation(),this.callback(t)}}static fromDefinition(e,t){if(typeof e=="string")return new z0(e,[],!1,!1,t);const{key:i,modifier:r,repeats:n,continuePropagation:a}=e;return new z0(i,r?Array.isArray(r)?r:[r]:[],!!n,!!a,t)}};function Fk(s){return[s.on("before-add",e=>{const t=e.item;if(t==null||s.includes(t))return j.getLogger("esri.views.interactive.interactiveToolUtils").warn("Tool is either already in the list of tools or tool is `null`. Not adding tool."),void e.preventDefault();t.onAdd()}),s.on("after-remove",e=>{const t=e.item;t.active&&(t.view.activeTool=null),t.destroy()})]}function B0(s){return s.visible&&s.getEditableFlag!=null&&s.getEditableFlag(0)&&s.getEditableFlag(1)}function Vk(s){return s.type==="key-down"&&s.key===AR.cancel}function kn(s){return dr(s.x,s.y)}function Zie(s){return ii(s.x,s.y)}function IR(s,e){const t=(s instanceof HTMLElement?s:s.surface)?.getBoundingClientRect();return t?dr(e.clientX-t.left,e.clientY-t.top):dr(0,0)}function PC(s,e){return e instanceof Event?IR(s,e):kn(e)}function MC(s){if(s instanceof Event)return!0;if(typeof s=="object"&&"type"in s)switch(s.type){case"click":case"double-click":case"pointer-down":case"pointer-drag":case"pointer-enter":case"pointer-leave":case"pointer-up":case"pointer-move":case"immediate-click":case"immediate-double-click":case"hold":case"drag":case"mouse-wheel":return!0;default:return!1}return!1}let Ef=class extends te{constructor(){super(...arguments),this._pointerLocations=new Map,this._hoveredManipulators=new E0,this._grabbedManipulators=new E0,this._draggedManipulators=new Map,this._stopDrag=!1,this._externallyDragging=!1,this._revertToNullActiveTool=!1}get cursor(){return this._cursorFromMap(this._grabbedManipulators,"grabbing")??this._cursorFromMap(this._hoveredManipulators,"pointer")}get hasFocusedManipulators(){return this._grabbedManipulators.size>0||this._draggedManipulators.size>0}handleInputEvent(e,t){const i=()=>e.stopPropagation();switch(e.type){case"pointer-move":$C(e.pointerType)&&this._pointerLocations.set(e.pointerId,{x:e.x,y:e.y,pointerType:e.pointerType});break;case"drag":this._grabbedManipulators.size>0?this._stopDrag=!0:e.action==="start"?this._externallyDragging=!0:e.action==="end"&&(this._externallyDragging=!1),this._stopDrag&&(i(),e.action==="end"&&(this._stopDrag=!1));break;case"pointer-down":{if(!RC(e))break;const r=kn(e),n=Pc(r,e.pointerType,t.tools);if(n==null)break;const a=n.manipulator,o=n.tool;a==null||o==null||!a.interactive||a.grabbable&&a.grabbableForEvent(e)||!a.grabbing||a.dragging||this._releaseManipulatorBeforeDragging(a,e,t),a!=null&&o!=null&&a.interactive&&a.grabbable&&a.grabbableForEvent(e)&&!a.grabbing&&(this._grabbedManipulators.set(e.pointerId,{manipulator:a,tool:o,start:r,pointerType:e.pointerType}),this._grabbedManipulators.size===1&&t.activeTool==null&&(this._revertToNullActiveTool=!0,t.setActiveTool(n.tool)),a.grabbing=!0,a.events.emit("grab-changed",{action:"start",pointerType:e.pointerType,screenPoint:r}),i());break}case"pointer-up":this._draggedManipulators.has(e.pointerId)||this._handlePointerEnd(e,t);break;case"pointer-drag":{if(!RC(e))break;const r=this._grabbedManipulators.get(e.pointerId),n=r?.manipulator,a=r?.tool;if(n==null||a==null)break;const o=kn(e);o.x=U(o.x,0,t.view.width),o.y=U(o.y,0,t.view.height);const l=r.start,c=this._draggedManipulators.get(e.pointerId);switch(e.action){case"start":case"update":e.action!=="update"&&this._grabbedManipulators.size!==1||(n.dragging=!0,c?n.events.emit("drag",{action:"update",start:l,screenPoint:o}):n.events.emit("drag",{action:"start",start:l,screenPoint:o,pointerType:e.pointerType}),this._draggedManipulators.set(e.pointerId,{tool:a,manipulator:n,start:l}));break;case"end":n.dragging=!1,c&&n.events.emit("drag",{action:"end",start:l,screenPoint:o}),this._draggedManipulators.delete(e.pointerId),this._handlePointerEnd(e,t)}i();break}case"immediate-click":{const r=kn(e),n=Pc(r,e.pointerType,t.tools);if(!kk(e)){for(const c of t.tools)if((n==null||n.tool!==c||c.automaticManipulatorSelection)&&c.manipulators){let h=!1;c.manipulators.forEach(({manipulator:d})=>{d.selected&&(d.selected=!1,h=!0)}),h&&c.onManipulatorSelectionChanged&&c.onManipulatorSelectionChanged()}}if(n==null)break;const{manipulator:a,tool:o}=n;if(!a.interactive)break;a.selectable&&o.automaticManipulatorSelection&&(a.selected=!a.selected,o.onManipulatorSelectionChanged&&o.onManipulatorSelectionChanged());const l=e.native.shiftKey;a.events.emit("immediate-click",{screenPoint:r,button:e.button,pointerType:e.pointerType,shiftKey:l,stopPropagation:i}),Cy(a,i);break}case"click":{const r=kn(e),n=Pc(r,e.pointerType,t.tools),a=n?.manipulator;if(a==null||!a.interactive)break;const o=e.native.shiftKey;a.events.emit(e.type,{screenPoint:r,button:e.button,pointerType:e.pointerType,shiftKey:o}),i();break}case"double-click":{const r=kn(e),n=Pc(r,e.pointerType,t.tools),a=n!=null?n.manipulator:null;if(a==null||!a.interactive)break;const o=e.native.shiftKey;a.events.emit("double-click",{screenPoint:r,button:e.button,pointerType:e.pointerType,shiftKey:o,stopPropagation:i}),Cy(a,i);break}case"immediate-double-click":{const r=kn(e),n=Pc(r,e.pointerType,t.tools),a=n!=null?n.manipulator:null;if(a==null||!a.interactive)break;const o=e.native.shiftKey;a.events.emit("immediate-double-click",{screenPoint:r,button:e.button,pointerType:e.pointerType,shiftKey:o,stopPropagation:i}),e.pointerType==="mouse"&&Cy(a,i);break}}this._onFocusChange(t.tools)}_releaseManipulatorBeforeDragging(e,t,i){e.grabbing=!1,e.events.emit("grab-changed",{action:"end",pointerType:t.pointerType,screenPoint:kn(t)}),this._grabbedManipulators.forEach(({manipulator:r},n)=>{r===e&&this._grabbedManipulators.delete(n)}),this._afterManipulatorRelease(i.setActiveTool)}_handlePointerEnd(e,t){const i=this._grabbedManipulators.get(e.pointerId)?.manipulator;i!=null&&i.grabbing&&(i.grabbing=!1,i.events.emit("grab-changed",{action:"end",pointerType:e.pointerType,screenPoint:kn(e)}),this._grabbedManipulators.delete(e.pointerId),this._afterManipulatorRelease(t.setActiveTool))}_onFocusChange(e){this._updateFocusedManipulatorTools(e)}_updateFocusedManipulatorTools(e){const t=new Set,i=new Set;this._grabbedManipulators.forEach(({tool:r})=>t.add(r)),this._hoveredManipulators.forEach(({tool:r})=>i.add(r));for(const r of e){r.hasGrabbedManipulators=t.has(r),r.hasHoveredManipulators=i.has(r);const n=this._grabbedManipulators.values(),a=nI(n,({tool:o})=>o===r);r.firstGrabbedManipulator=a!=null?a.manipulator:null}}clearPointers(e,{tools:t,setActiveTool:i},r=!0,n){const a=(o,l)=>o===e&&(n==null||n===l);this._grabbedManipulators.forEach(({tool:o,manipulator:l,pointerType:c},h)=>{a(o,l)&&(this._grabbedManipulators.delete(h),l.grabbing=!1,l.events.emit("grab-changed",{action:"end",screenPoint:null,pointerType:c}))}),this._draggedManipulators.forEach(({tool:o,manipulator:l},c)=>{a(o,l)&&(this._draggedManipulators.delete(c),l.dragging=!1,l.events.emit("drag",{action:"cancel"}))}),r&&this._hoveredManipulators.forEach(({tool:o,manipulator:l},c)=>{a(o,l)&&(this._hoveredManipulators.delete(c),l.hovering=!1)}),this._afterManipulatorRelease(i),this._onFocusChange(t)}updateHoveredStateFromKnownPointers(e){this._pointerLocations.forEach((t,i)=>{this._updateHoveredStateForPointerAtScreenPosition(dr(t.x,t.y),i,t.pointerType,e)})}handleHoverEvent(e,t){const i=e.type;i!=="pointer-up"&&i!=="immediate-click"&&i!=="pointer-move"||!$C(e.pointerType)||(i!=="pointer-up"&&this._externallyDragging?this._clearHoveredManipulatorStates(e.pointerId):this._updateHoveredStateForPointerAtScreenPosition(kn(e),e.pointerId,e.pointerType,t))}_updateHoveredStateForPointerAtScreenPosition(e,t,i,r){let n=Pc(e,i,r);const a=this._hoveredManipulators.get(t)?.manipulator;n==null||n.manipulator.interactive||(n=null),n!=null&&a===n.manipulator||(a!=null&&(a.hovering=!1),n!=null?(n.manipulator.hovering=!0,this._hoveredManipulators.set(t,n)):this._hoveredManipulators.delete(t),this._onFocusChange(r))}_afterManipulatorRelease(e){this._grabbedManipulators.size===0&&this._revertToNullActiveTool&&(e(null),this._revertToNullActiveTool=!1)}_clearHoveredManipulatorStates(e){this._hoveredManipulators.forEach(({manipulator:t},i)=>{e===i&&(this._hoveredManipulators.delete(e),t.hovering=!1)})}_cursorFromMap(e,t){if(!e?.size)return null;for(const{manipulator:i}of e.values())if(i?.interactive){if(i.grabbing&&i.grabCursor)return i.grabCursor;if(i.cursor)return i.cursor}return t}};function Pc(s,e,t){for(const i of t){if(i.manipulators==null||!B0(i))continue;const r=i.manipulators.intersect(s,e);if(r!=null)return{tool:i,manipulator:r}}return null}function $C(s){return s==="mouse"}function RC(s){return s.pointerType!=="mouse"||s.button===0}function kk(s){return!!s.native.shiftKey}function Cy(s,e){s?.consumesClicks&&e()}u([p()],Ef.prototype,"cursor",null),Ef=u([R("esri.views.interactive.ToolViewManagerManipulatorState")],Ef);const OC="attached",Ty="tools",zk=1e3;let zn=class extends te{constructor(e){super(e),this._updatingHandles=new hc,this._clock=Ip,this._manipulatorState=new Ef,this.tools=new Pt,this._interacting=!1,this._interactingTimeout=zk,this._interactingTimeoutHandle=null}initialize(){this.addHandles([this.view.on($R,e=>{this._handleInputEvent(e)},Fa.TOOL),...Fk(this.tools),this.tools.on("before-add",({item:e})=>{this._updateToolEditableFlag(e)}),this.tools.on("before-remove",({item:e})=>{this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs)}),this.tools.on("change",()=>{this._refreshToolWatchers()})])}destroy(){this.activeTool=null,this.tools.drain(e=>e.destroy()),this._clearInteractingTimeout(),this._interacting=!1,this._updatingHandles.destroy(),this._manipulatorState.destroy()}get _manipulatorStateEventArgs(){return{tools:this.tools,activeTool:this.activeTool,setActiveTool:e=>{this.activeTool=e},view:this.view}}set activeTool(e){if(e!=null&&!this.view.ready)return void j.getLogger(this).error("Cannot set active tool while view is not ready.");if(e===this.activeTool)return;const t=this.activeTool;this._set("activeTool",e),t?.deactivate(),e?.activate(),this._removeIncompleteTools(e);for(const i of this.tools){this._updateToolEditableFlag(i);const r=B0(i);this.activeTool!=null&&r||this._manipulatorState.clearPointers(i,this._manipulatorStateEventArgs,!r)}}get cursor(){const e=this._manipulatorState.cursor;if(e!=null)return e;for(const t of this.tools)if(t.visible&&t.cursor!=null)return t.cursor;return null}get updating(){return this._updatingHandles.updating||this.tools.some(e=>e.updating)}get interacting(){return this._interacting}_clearInteractingTimeout(){this._interactingTimeoutHandle=bi(this._interactingTimeoutHandle)}_startInteractingTimeout(){this._clearInteractingTimeout(),this._interactingTimeoutHandle=this._clock.setTimeout(()=>this._interacting=!1,this._interactingTimeout)}attach(){this.view.type==="3d"?this.addHandles([$(()=>{const{state:e}=this.view;return"camera"in e&&e.camera},()=>this._forEachManipulator(e=>e.onViewChange())),this.view.elevationProvider.on("elevation-change",e=>this._forEachManipulator(t=>t.onElevationChange(e)))],OC):this.addHandles($(()=>this.view.extent,()=>this._forEachManipulator(e=>e.onViewChange())))}detach(){this.activeTool=null,this.tools.removeAll(),this.removeHandles(OC),this._clearInteractingTimeout(),this._interacting=!1}_forEachManipulator(e){for(const t of this.tools)t.manipulators&&t.manipulators.forEach(({manipulator:i})=>e(i,t))}_handleInputEvent(e){let t=!1;const i={...e,stopPropagation:()=>{t=!0,e.stopPropagation()}};if(this.activeTool!=null)this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(i);else for(const r of this.tools)!t&&r.visible&&r.handleInputEvent(i);!t&&Vk(e)&&this.activeTool&&(e.stopPropagation(),e.preventDefault(),this.activeTool.cancel(),this.activeTool=null),this._manipulatorState.handleInputEvent(i,this._manipulatorStateEventArgs),t||this.activeTool==null||this.activeTool.handleInputEventAfter(i),this._manipulatorState.handleHoverEvent(i,this.tools),e.type==="pointer-move"&&(this._manipulatorState.hasFocusedManipulators||this.activeTool)&&(this._interacting=!0,this._startInteractingTimeout())}_refreshToolWatchers(){this.removeHandles(Ty);for(const e of this.tools){if(e instanceof te){const t=$(()=>[e.cursor,e.visible,e.editable],()=>{B0(e)||this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs)});this.addHandles(t,Ty)}e.manipulators&&this.addHandles([e.manipulators.on("after-remove",t=>{this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs,!0,t.item.manipulator)}),e.manipulators.on("change",()=>{this._manipulatorState.updateHoveredStateFromKnownPointers(this.tools)})],Ty)}this._manipulatorState.updateHoveredStateFromKnownPointers(this.tools)}_updateToolEditableFlag(e){e.setEditableFlag?.(1,this.activeTool==null||e===this.activeTool)}_removeIncompleteTools(e){this.tools.filter(t=>(e==null||t!==e)&&!t.created&&t.removeIncompleteOnCancel).forEach(t=>{this.tools.remove(t)})}get test(){}};u([p({constructOnly:!0,nonNullable:!0})],zn.prototype,"view",void 0),u([p({value:null})],zn.prototype,"activeTool",null),u([p({readOnly:!0,type:Pt})],zn.prototype,"tools",void 0),u([p()],zn.prototype,"cursor",null),u([p({readOnly:!0})],zn.prototype,"updating",null),u([p()],zn.prototype,"_interacting",void 0),u([p({readOnly:!0})],zn.prototype,"interacting",null),zn=u([R("esri.views.ToolViewManager")],zn);const Bk=new vi("cyan"),Nk=1,Uk=.25,LR=new vi("black"),FR=.4,VR=.2,Hk=.25,aa="default",qk="temporary",Gk=new vi("yellow"),jk=8;var N0;let rr=N0=class extends te{constructor(s){super(s),this.name=aa,this.color=Bk.clone(),this.haloColor=null,this.haloOpacity=Nk,this.fillOpacity=Uk,this.shadowColor=LR.clone(),this.shadowOpacity=FR,this.shadowDifference=VR,this.haloWidth=2.1,this.haloBlur=.8/this.haloWidth}equals(s){return this.color.equals(s.color)&&(this.haloColor||this.color).equals(s.haloColor||s.color)&&this.haloOpacity===s.haloOpacity&&this.fillOpacity===s.fillOpacity&&this.haloWidth===s.haloWidth&&this.haloBlur===s.haloBlur&&this.shadowColor.equals(s.shadowColor)&&this.shadowOpacity===s.shadowOpacity&&this.shadowDifference===s.shadowDifference}clone(){return new N0({...this,color:this.color.clone(),haloColor:this.haloColor?.clone(),shadowColor:this.shadowColor?.clone()})}assignFrom(s){this.color=s.color.clone(),this.haloColor=s.haloColor?.clone(),this.haloOpacity=s.haloOpacity,this.fillOpacity=s.fillOpacity,this.shadowColor=s.shadowColor.clone(),this.shadowDifference=s.shadowDifference,this.shadowOpacity=s.shadowOpacity,this.haloBlur=s.haloBlur,this.haloWidth=s.haloWidth}};u([p({type:String,constructOnly:!0,nonNullable:!0})],rr.prototype,"name",void 0),u([p({type:vi,nonNullable:!0})],rr.prototype,"color",void 0),u([p({type:vi})],rr.prototype,"haloColor",void 0),u([p({nonNullable:!0})],rr.prototype,"haloOpacity",void 0),u([p({nonNullable:!0})],rr.prototype,"fillOpacity",void 0),u([p({type:vi,nonNullable:!0})],rr.prototype,"shadowColor",void 0),u([p({nonNullable:!0})],rr.prototype,"shadowOpacity",void 0),u([p({nonNullable:!0})],rr.prototype,"shadowDifference",void 0),u([p({nonNullable:!0})],rr.prototype,"haloWidth",void 0),u([p({nonNullable:!0})],rr.prototype,"haloBlur",void 0),rr=N0=u([R("esri.views.support.HighlightOptions")],rr);const Wl=rr;function Wk(){return new(Pt.ofType(Wl))([new Wl({name:aa}),new Wl({name:qk,color:Gk})])}let ih=class extends te{constructor(e){super(),this.nativeIndex=null,this._detectedDeviceType="unknown",e.mapping==="standard"?this._detectedDeviceType="standard":Qk.test(e.id)?this._detectedDeviceType="spacemouse":this._detectedDeviceType="unknown",this.nativeIndex=e.index}get native(){const e=navigator.getGamepads?navigator.getGamepads():[];return this.nativeIndex!=null&&this.nativeIndex<e.length?e[this.nativeIndex]:null}get deviceType(){return this._detectedDeviceType}get axisThreshold(){return Zk[this.deviceType]}};u([p({nonNullable:!0,readOnly:!0})],ih.prototype,"nativeIndex",void 0),u([p({type:String,readOnly:!0})],ih.prototype,"deviceType",null),u([p({type:Number,readOnly:!0})],ih.prototype,"axisThreshold",null),ih=u([R("esri.views.input.gamepad.GamepadInputDevice")],ih);const s1=ih,Qk=new RegExp("^(3dconnexion|space(mouse|navigator|pilot|explorer))","i"),Zk={standard:.15,spacemouse:.025,unknown:0};let nd=class extends te{constructor(e){super(e),this.devices=new Pt,this.enabledFocusMode="document"}};u([p({type:Pt.ofType(s1),readOnly:!0})],nd.prototype,"devices",void 0),u([p({type:["document","view","none"]})],nd.prototype,"enabledFocusMode",void 0),nd=u([R("esri.views.input.gamepad.GamepadSettings")],nd);const Xk=nd;let Af=class extends te{constructor(){super(...arguments),this.gamepad=new Xk}};u([p({readOnly:!0})],Af.prototype,"gamepad",void 0),Af=u([R("esri.views.input.Input")],Af);const Yk=Af,Sy=()=>p({type:["pan","rotate","zoom","none"],nonNullable:!0});let ml=class extends te{constructor(e){super(e),this.dragPrimary="pan",this.dragSecondary="rotate",this.dragTertiary="zoom",this.mouseWheel="zoom"}};u([Sy()],ml.prototype,"dragPrimary",void 0),u([Sy()],ml.prototype,"dragSecondary",void 0),u([Sy()],ml.prototype,"dragTertiary",void 0),u([p({type:["zoom","none"],nonNullable:!0})],ml.prototype,"mouseWheel",void 0),ml=u([R("esri.views.navigation.NavigationActionMap")],ml);const kR=ml;let mo=class extends te{constructor(e){super(e),this.enabled=!0,this.device=null,this.mode="pan",this.tiltDirection="forward-down",this.velocityFactor=1}};u([p({type:Boolean,nonNullable:!0})],mo.prototype,"enabled",void 0),u([p({type:s1})],mo.prototype,"device",void 0),u([p({type:["pan","zoom"],nonNullable:!0})],mo.prototype,"mode",void 0),u([p({type:["forward-down","forward-up"],nonNullable:!0})],mo.prototype,"tiltDirection",void 0),u([p({type:Number,nonNullable:!0})],mo.prototype,"velocityFactor",void 0),mo=u([R("esri.views.navigation.gamepad.GamepadSettings")],mo);const zR=mo;let fo=class extends te{constructor(e){super(e),this.actionMap=new kR,this.browserTouchPanEnabled=!0,this.gamepad=new zR,this.momentumEnabled=!0}get mouseWheelZoomEnabled(){return this.actionMap.mouseWheel==="zoom"}set mouseWheelZoomEnabled(e){aI(j.getLogger(this),"mouseWheelZoomEnabled",{replacement:"actionMap.mouseWheel",version:"4.32",warnOnce:!0}),this.actionMap.mouseWheel=e?"zoom":"none"}};u([p({type:kR,nonNullable:!0})],fo.prototype,"actionMap",void 0),u([p({type:Boolean})],fo.prototype,"browserTouchPanEnabled",void 0),u([p({type:zR,nonNullable:!0})],fo.prototype,"gamepad",void 0),u([p({type:Boolean})],fo.prototype,"momentumEnabled",void 0),u([p({type:Boolean})],fo.prototype,"mouseWheelZoomEnabled",null),fo=u([R("esri.views.navigation.Navigation")],fo);const BR=fo;function rse(s,e,t){const i=NR(s),r=e,n=Kk(i,r,t);if(i){const a=Bp.deriveUnitFromSR(i,s.spatialReference).heightUnit;if(!t&&a!==i.heightUnit){const o=new me("layerview:unmatched-height-unit",`The vertical units of the layer must match the horizontal units (${a})`,{horizontalUnit:a});return new me("layerview:unsupported-height-model-info","The vertical coordinate system of the layer is not supported",{heightModelInfo:i,error:o})}}if(!Jk(s)||n===4)return new me("layerview:unsupported-height-model-info","The vertical coordinate system of the layer is not supported",{heightModelInfo:i});switch(n){case 1:{const a=i?.heightUnit||"unknown",o=r?.heightUnit||"unknown",l=new me("layerview:incompatible-height-unit",`The vertical units of the layer (${a}) must match the vertical units of the scene (${o})`,{layerUnit:a,sceneUnit:o});return new me("layerview:incompatible-height-model-info","The vertical coordinate system of the layer is incompatible with the scene",{layerHeightModelInfo:i,sceneHeightModelInfo:r,error:l})}case 2:{const a=i?.heightModel||"unknown",o=r?.heightModel||"unknown",l=new me("layerview:incompatible-height-model",`The height model of the layer (${a}) must match the height model of the scene (${o})`,{layerHeightModel:a,sceneHeightModel:o});return new me("layerview:incompatible-height-model-info","The vertical coordinate system of the layer is incompatible with the scene",{layerHeightModelInfo:i,sceneHeightModelInfo:r,error:l})}case 3:{const a=i?.vertCRS||"unknown",o=r?.vertCRS||"unknown",l=new me("layerview:incompatible-vertical-datum",`The vertical datum of the layer (${a}) must match the vertical datum of the scene (${o})`,{layerDatum:a,sceneDatum:o});return new me("layerview:incompatible-height-model-info","The vertical coordinate system of the layer is incompatible with the scene",{layerHeightModelInfo:i,sceneHeightModelInfo:r,error:l})}}return null}function Kk(s,e,t){if(!DC(s)||!DC(e))return 4;if(s==null||e==null)return 0;if(!t&&s.heightUnit!==e.heightUnit)return 1;if(s.heightModel!==e.heightModel)return 2;switch(s.heightModel){case"gravity-related-height":return 0;case"ellipsoidal":return s.vertCRS===e.vertCRS?0:3;default:return 4}}function DC(s){return s==null||s.heightModel!=null&&s.heightUnit!=null}function Jk(s){return"heightModelInfo"in s&&s.heightModelInfo!=null||s.spatialReference!=null||!qR(s)}function NR(s){if(s.type==="integrated-mesh-3dtiles"||s.type==="gaussian-splat")return null;const e=s.url?tF(s.url):void 0;return!(s.spatialReference?.vcsWkid==null&&e!=null&&e.serverType==="ImageServer")&&UR(s)&&s.heightModelInfo?s.heightModelInfo:qR(s)?Bp.deriveUnitFromSR(tz,s.spatialReference):null}function UR(s){return"heightModelInfo"in s}function HR(s){if(s.type==="unknown"||!("capabilities"in s))return!1;switch(s.type){case"catalog":case"catalog-footprint":case"csv":case"feature":case"geojson":case"subtype-group":case"ogc-feature":case"oriented-imagery":case"wfs":case"knowledge-graph-sublayer":return!0;default:return!1}}function qR(s){return HR(s)?!!(s.capabilities&&s.capabilities.data&&s.capabilities.data.supportsZ):GR(s)}function ez(s){return s.layers!=null||GR(s)||HR(s)||UR(s)}function GR(s){switch(s.type){case"building-scene":case"elevation":case"integrated-mesh":case"integrated-mesh-3dtiles":case"point-cloud":case"scene":case"voxel":return!0;case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"catalog":case"catalog-footprint":case"catalog-dynamic-group":case"csv":case"dimension":case"gaussian-splat":case"geojson":case"feature":case"subtype-group":case"geo-rss":case"graphics":case"group":case"imagery":case"imagery-tile":case"kml":case"knowledge-graph":case"link-chart":case"knowledge-graph-sublayer":case"line-of-sight":case"map-image":case"map-notes":case"media":case"ogc-feature":case"open-street-map":case"oriented-imagery":case"parquet":case"route":case"stream":case"tile":case"unknown":case"unsupported":case"vector-tile":case"video":case"viewshed":case"wcs":case"web-tile":case"wfs":case"wms":case"wmts":case null:return!1}return!1}const tz=new Bp({heightModel:"gravity-related-height"});let U0,Py=null;async function iz(s){Py||(Py=k(()=>import("./geometryServiceUtils-DWghLvIc.js"),__vite__mapDeps([167,1,4,5,6,7,8,2,9,10,168,27,28,19,20,14,90,95])).then(e=>U0=e)),await Py,He(s)}async function jR(s,e,t,i){if(!s)return null;const r=s.spatialReference;return BF()||D$(r,e)?Np(s,e):U0?U0.projectGeometry(s,e,t,i):(await Promise.race([iz(i),zF(i)]),jR(s,e,t,i))}async function nse(s,e){try{return s?.spatialReference?await Lo(s,e):null}catch{return null}}let At=class extends te{constructor(e){super(e),this.required={extent:!1,heightModelInfo:!1,tileInfo:!1},this.defaultSpatialReference=null,this.userSpatialReference=null,this.sourcePreloadCount=10,this.priorityCollection=null,this.requiresExtentInSpatialReference=!0,this.suspended=!1,this._projectExtentTask={task:null,input:null,output:null,spatialReference:null}}destroy(){this._projectExtentTask.task&&(this._projectExtentTask.task=Os(this._projectExtentTask.task)),this._set("map",null)}get ready(){return!this._spatialReferenceTask.updating&&!this._tileInfoTask.updating&&!this._extentTask.updating}get heightModelInfoReady(){return!this._heightModelInfoTask.updating}get spatialReference(){return this.userSpatialReference??this._spatialReferenceTask.spatialReference}get extent(){return this._extentTask.extent}get heightModelInfo(){return this._heightModelInfoTask.heightModelInfo}get vcsWkid(){return this._heightModelInfoTask.vcsWkid}get latestVcsWkid(){return this._heightModelInfoTask.latestVcsWkid}get viewingMode(){return this.userSpatialReference==null||this.userSpatialReference.equals(this._spatialReferenceTask.spatialReference)?this._spatialReferenceTask.viewingMode:null}get tileInfo(){return this._tileInfoTask.tileInfo}get mapCollections(){const e=this.map?.(),t=[];return this.priorityCollection!=null&&t.push(this.priorityCollection),t.push({parent:e?.basemap,layers:e?.basemap?.baseLayers},{parent:e?.basemap,layers:e?.basemap?.groundLayers},{layers:e?.layers},{parent:e?.ground,layers:e?.ground?.layers},{parent:e?.basemap,layers:e?.basemap?.referenceLayers}),t}get _spatialReferenceTask(){if(this.suspended)return this._get("_spatialReferenceTask")??{updating:!1};let e;if(this._collectLayers(this.mapCollections,i=>{const r=this._getSupportedSpatialReferences(i);if(r.length>0){const n=this._narrowDownSpatialReferenceCandidates(e,r);n!=null&&(e=n)}return e?.length===1})&&e?.length!==1)return{updating:!0};const t=this._pickSpatialReferenceCandidate(e);return{spatialReference:t?.spatialReference??null,viewingMode:t?.viewingMode??null,updating:!1}}get _tileInfoTask(){if(!this.required.tileInfo)return this._get("_tileInfoTask")??{updating:!1};const e=this.map?.(),t=this.spatialReference;if(!t)return{updating:this._spatialReferenceTask.updating};let i;const r=this._collectLayers([{parent:e?.basemap,layers:e?.basemap?.baseLayers},{parent:e?.basemap,layers:e?.basemap?.groundLayers},{layers:e?.layers}],n=>!(!("tileInfo"in n)||!n.tileInfo?.spatialReference.equals(t))&&(i=n,!0),n=>"tileInfo"in n);return i?{tileInfo:i.tileInfo,updating:!1}:{updating:r}}get _heightModelInfoTask(){if(!this.required.heightModelInfo||this.suspended&&this._get("_heightModelInfoTask")?.heightModelInfo)return this._get("_heightModelInfoTask")??{updating:!1};let e={};const t=this._collectLayers(this.mapCollections,i=>{const r=NR(i);return!!r&&(e={heightModelInfo:r,vcsWkid:i.spatialReference?.vcsWkid,latestVcsWkid:i.spatialReference?.latestVcsWkid},!0)},i=>ez(i));return{...e,updating:t}}get _extentCandidatesTask(){if(this.suspended||!this.required.extent)return this._get("_extentCandidatesTask")??{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const e=[],t=this._collectLayers(this.mapCollections,i=>{const r="fullExtents"in i&&i.fullExtents||(i.fullExtent!=null?[i.fullExtent]:[]),n=this.requiresExtentInSpatialReference?null:r[0],a=r.find(o=>o.spatialReference.equals(this.spatialReference))??n;if(a)return e.push({extent:a,layer:i}),!0;if(this._getSupportedSpatialReferences(i).length>0)for(const o of r)e.push({extent:o,layer:i});return!1});return{candidates:e,updating:t}}get _extentTask(){const{candidates:e,updating:t}=this._extentCandidatesTask;if(t)return{updating:t};if(e==null||e.length===0)return{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const i=this._pickExtentCandidate(e),r=this.spatialReference;return i.extent.equals(this._projectExtentTask.input)&&r.equals(this._projectExtentTask.spatialReference)?{extent:this._projectExtentTask.output,updating:this._projectExtentTask.task!=null&&!this._projectExtentTask.task.finished}:(this._projectExtentTask.task!=null&&(this._projectExtentTask.task=Os(this._projectExtentTask.task)),this._projectExtentTask={input:i.extent.clone(),output:null,spatialReference:r.clone(),task:Za(async n=>{try{const a=await jR(i.extent,r,"portalItem"in i.layer?i.layer.portalItem:void 0,n);this._projectExtentTask={...this._projectExtentTask,task:null,output:a}}catch{if(Hl(n))return;this._projectExtentTask={...this._projectExtentTask,task:null}}})},{updating:!0})}_narrowDownSpatialReferenceCandidates(e,t){if(e==null)return t;const i=new Array;for(const r of e)for(const n of t){if(!r.spatialReference.equals(n.spatialReference))continue;const a=rz(r.viewingMode,n.viewingMode);if(a!==!1){i.push({spatialReference:r.spatialReference,viewingMode:a});break}}return i.length>0?i:null}_pickSpatialReferenceCandidate(e){const t=this.defaultSpatialReference;return e==null||e.length<1?t?{spatialReference:t,viewingMode:null}:null:(t!=null&&e.length>1&&e.some(({spatialReference:i})=>i.equals(t))&&(e=e.filter(({spatialReference:i})=>i.equals(t))),e.length>1&&e.some(({viewingMode:i})=>i!==2)&&(e=e.filter(({viewingMode:i})=>i!==2)),e[0])}_getSupportedSpatialReferences(e){const t="supportedSpatialReferences"in e&&e.supportedSpatialReferences||(e.spatialReference?[e.spatialReference]:[]);if(t.length===0)return[];const i=[];for(const r of t){const n=this.getSpatialReferenceSupport(r,e);if(n!=null){const a=n.constraints??[{spatialReference:r,viewingMode:null}];for(const{spatialReference:o,viewingMode:l}of a)this.requiresExtentInSpatialReference&&this.userSpatialReference!=null&&!o.equals(this.userSpatialReference)||i.push({spatialReference:o,viewingMode:l})}}return i}_pickExtentCandidate(e){const t=this.spatialReference;return e.find(({extent:i})=>t.equals(i.spatialReference))||e[0]}_collectLayers(e,t,i=()=>!0){switch(this._loadMaybe(this.map?.())){case"loading":return!0;case"failed":return!1}const r=new sz(i,t);for(const n of e)if(this._collectCollection(n,r),r.done||r.preloading===this.sourcePreloadCount)break;return r.updating}_collectCollection(e,t){if(e.layers){switch(this._loadMaybe(e.parent)){case"loading":return t.updating=!0,void++t.preloading;case"failed":return}for(const i of e.layers)if((i.type!=="graphics"||!i.internal)&&t.layerFilter(i)){switch(this._loadMaybe(i)){case"failed":continue;case"loading":t.updating=!0,++t.preloading;break;case"loaded":if(t.updating||(t.done=t.pushLayer(i)),t.done||t.preloading===this.sourcePreloadCount)break;"layers"in i&&this._collectCollection({layers:i.layers},t)}if(t.done||t.preloading===this.sourcePreloadCount)break}}}_loadMaybe(e){return e&&"loadStatus"in e&&e.loadStatus!=null?e.loadStatus==="not-loaded"?(e.load().catch(t=>{zr(t)}),"loading"):e.loadStatus:"loaded"}};u([p()],At.prototype,"required",void 0),u([p({constructOnly:!0})],At.prototype,"map",void 0),u([p({constructOnly:!0})],At.prototype,"getSpatialReferenceSupport",void 0),u([p()],At.prototype,"defaultSpatialReference",void 0),u([p()],At.prototype,"userSpatialReference",void 0),u([p()],At.prototype,"sourcePreloadCount",void 0),u([p()],At.prototype,"priorityCollection",void 0),u([p()],At.prototype,"requiresExtentInSpatialReference",void 0),u([p()],At.prototype,"suspended",void 0),u([p({readOnly:!0})],At.prototype,"ready",null),u([p({readOnly:!0})],At.prototype,"heightModelInfoReady",null),u([p({readOnly:!0})],At.prototype,"spatialReference",null),u([p({readOnly:!0})],At.prototype,"extent",null),u([p({readOnly:!0})],At.prototype,"heightModelInfo",null),u([p({readOnly:!0})],At.prototype,"vcsWkid",null),u([p({readOnly:!0})],At.prototype,"latestVcsWkid",null),u([p({readOnly:!0})],At.prototype,"viewingMode",null),u([p({readOnly:!0})],At.prototype,"tileInfo",null),u([p({readOnly:!0})],At.prototype,"mapCollections",null),u([p({readOnly:!0})],At.prototype,"_spatialReferenceTask",null),u([p({readOnly:!0})],At.prototype,"_tileInfoTask",null),u([p({readOnly:!0})],At.prototype,"_heightModelInfoTask",null),u([p({readOnly:!0})],At.prototype,"_extentCandidatesTask",null),u([p()],At.prototype,"_extentTask",null),u([p()],At.prototype,"_projectExtentTask",void 0),At=u([R("esri.views.support.DefaultsFromMap")],At);let sz=class{constructor(e,t){this.layerFilter=e,this.pushLayer=t,this.preloading=-1,this.updating=!1,this.done=!1}};function rz(s,e){return s!=null?e!=null?s===e&&s:s:e}function nz(s){return"tryRecycleWith"in s}let az=class{constructor(e,t,i){this.layer=e,this.view=t,this.layerViewImporter=i,this._controller=new AbortController,this._started=!1,this.done=!1,this._deferred=sa(),this.promise=this._deferred.promise,Oo(this._controller.signal,()=>{this._recycleController?.abort();const r=new me("cancelled:layerview-create","layerview creation cancelled",{layer:e});this._deferred?.reject(r)})}tryRecycle(e){if(!this.done||!this.layerView||!nz(this.layerView))return null;this._recycleController?.abort(),this._recycleController=new AbortController;const t=this.layer.type,i=this._recycleController.signal;for(let r=0;r<e.length;r++){const n=e[r];if(n.type!==t)continue;const a=this.layerView.tryRecycleWith(n,{signal:i});if(a){e.splice(r,1),this.layer=n;const o=this.layerView,l=o.view;return this.promise=a.then(()=>(He(i),n.emit("layerview-destroy",{view:l,layerView:o}),l.emit("layerview-destroy",{view:l,layerView:o}),n.emit("layerview-create",{view:l,layerView:o}),l.emit("layerview-create",{view:l,layerView:o}),o)),this.promise}}return null}destroy(){this._controller.abort();const{layerView:e}=this;if(e){const{layer:t,view:i}=this;t.emit("layerview-destroy",{view:i,layerView:e}),i.emit("layerview-destroy",{layer:t,layerView:e})}this.done=!0,this.layer=null,this.layerView=null,this.view=null,this.layerViewImporter=null,this._map=null,this.promise=null,this._deferred=null}async start(){const{view:e}=this;if(this._started||!e.map)return;this._started=!0;const{_controller:{signal:t},layer:i}=this;this._map=e.map;try{let r,n;if(await i.load({signal:t}),i.prefetchResources&&await i.prefetchResources({signal:t}),oz(i))r=await i.createLayerView(e,{signal:t});else{if(!this.layerViewImporter.hasLayerViewModule(i))throw new me("layer:view-not-supported","No layerview implementation was found");const l=await this.layerViewImporter.importLayerView(i);He(t),r="default"in l?new l.default({layer:i,view:e}):new l({layer:i,view:e})}const a=()=>{n=bi(n),r.destroyed||r.destroy(),this.done=!0};n=Oo(t,a),He(t);try{await r.when()}catch(l){throw a(),l}if(!this._map?.allLayers?.includes(i))return a(),void this._deferred?.reject(new me("view:no-layerview-for-layer","The layer has been removed from the map",{layer:i}));this.layerView=r,i.emit("layerview-create",{view:e,layerView:r}),e.emit("layerview-create",{layer:i,layerView:r}),this.done=!0,this._deferred?.resolve(r)}catch(r){i.emit("layerview-create-error",{view:e,error:r}),e.emit("layerview-create-error",{layer:i,error:r}),this.done=!0,this._deferred?.reject(new me("layerview:create-error","layerview creation failed",{layer:i,error:r}))}}};function oz(s){return s.createLayerView!==P5.prototype.createLayerView}function lz(s){return s!=null&&typeof s=="object"&&"layerViews"in s}let Bs=class extends te{constructor(e){super(e),this._layerLayerViewInfoMap=new Map,this._recyclingInfoMap=new Map,this._watchUpdatingTracking=new hc,this.supportsGround=!0,this._preloadLayerViewModules=()=>{const t=this.view.map?.allLayers;if(t)for(const i of t)this.layerViewFilter?.(i)!==!1&&this.layerViewImporter.hasLayerViewModule(i)&&this.layerViewImporter.importLayerView(i)},this._reschedule=()=>this.destroyed?Promise.reject():(this._workPromise==null&&(this._workPromise=sa(),this._workPromise.promise.catch(()=>{})),this.removeHandles("reschedule"),this.addHandles(FM(this._doWork),"reschedule"),this._workPromise.promise),this._doWork=()=>{if(this.destroyed)return;const{map:t}=this.view;if(!t)return void this.clear();if(this._map!==t&&(this.clear(),this._map=t),this._workPromise==null)return void this.notifyChange("updating");this.removeHandles("reschedule"),this.removeHandles("collection-change");const i=new Set,r=[],n=this.view.ready,a=h=>{if(h!=null){for(const d of h)if(d){if(this.layerViewFilter?.(d)===!1)continue;i.add(d);const m=this._layerLayerViewInfoMap.get(d);m&&n?m.start():m||this._recyclingInfoMap.has(d)||r.push(d),"layers"in d&&d.layers&&a(d.layers)}}};for(const h of this._rootCollectionNames)a(im(this,h));const o=new Array,l=h=>{const d=h.tryRecycle(r);d?(this._recyclingInfoMap.set(h.layer,h),this.notifyChange("updating"),d.then(()=>{this._recyclingInfoMap.delete(h.layer),this._layerLayerViewInfoMap.set(h.layer,h),this._reschedule(),this.notifyChange("updating")}).catch(m=>{zr(m)||(this._recyclingInfoMap.delete(h.layer),h.destroy(),this._reschedule(),this.notifyChange("updating"))})):o.push(h)};for(const h of this._layerLayerViewInfoMap.values())i.has(h.layer)||(this._layerLayerViewInfoMap.delete(h.layer),l(h));for(const h of this._recyclingInfoMap.values())i.has(h.layer)||(this._recyclingInfoMap.delete(h.layer),l(h));for(const h of r)this._createLayerView(h);this._refreshCollections(),o.forEach(h=>h.destroy());const c=[t?.ground?.layers,t?.basemap?.baseLayers,t?.basemap?.groundLayers,t?.basemap?.referenceLayers,t?.layers].filter(h=>!!h);i.forEach(h=>"layers"in h&&c.push(h.layers)),this.addHandles(c.map(h=>this._watchUpdatingTracking.addOnCollectionChange(()=>h,this._reschedule)),"collection-change"),this._workPromise.resolve(),this._workPromise=null},this._layersToLayerViews=new Map(e.layerviewMapping)}initialize(){this.addHandles([Ds(()=>this.view?.map?.allLayers,"change",this._preloadLayerViewModules,{onListenerAdd:this._preloadLayerViewModules}),$(()=>{const e=this.view,t=e?.map;return[t?.basemap,t?.ground,t?.layers,e?.ready]},()=>this._reschedule(),Ve)]),this._preloadLayerViewModules(),this._reschedule()}clearHandles(){this._watchUpdatingTracking.removeAll()}destroy(){this.clear(),nm(this._recyclingInfoMap),nm(this._layerLayerViewInfoMap),this._watchUpdatingTracking.destroy(),this._map=null,this._workPromise!=null&&(this._workPromise.reject(Bi()),this._workPromise=null)}get _rootCollectionNames(){return Array.from(this._layersToLayerViews.keys())}get updating(){return this._workPromise!=null||this._watchUpdatingTracking.updating||pn(this._layerLayerViewInfoMap,e=>!e.done)||this._recyclingInfoMap.size>0}get updatingRemaining(){let e=0;for(const t of this._layerLayerViewInfoMap.values())t.done||++e;return e}clear(){this.destroyed||(this._clearCollections(),nm(this._layerLayerViewInfoMap),nm(this._recyclingInfoMap))}async whenLayerView(e){await this._reschedule();const t=this._layerLayerViewInfoMap.get(e)?.promise;if(!t){const i=this._recyclingInfoMap.get(e)?.promise;if(!i)throw new me("view:no-layerview-for-layer","No layerview has been found for the layer",{layer:e});return i}return t}isCreatingLayerViewsForLayer(e,t){this.commitProperty("updatingRemaining");const i=this._layerLayerViewInfoMap.get(e);if(!i?.done)return!0;const r=i.layerView;return!(!r||!t||r.parent===t)||!!(i.done&&r&&"layers"in e&&e.layers?.length)&&e.layers.some(n=>this.isCreatingLayerViewsForLayer(n,r))}_refreshCollections(){for(const[e,t]of this._layersToLayerViews)this._populateLayerViewsOwners(im(this,e),im(this,t),this.view);this.notifyChange("updating"),this.notifyChange("updatingRemaining")}_clearCollections(){for(const e of this._layersToLayerViews.values())im(this,e)?.removeAll()}_populateLayerViewsOwners(e,t,i){if(!e||!t)return void t?.removeAll();let r=0;for(const n of e){const a=this._layerLayerViewInfoMap.get(n);if(!a?.layerView)continue;const{layerView:o}=a;o.layer=n,o.parent=i,t.at(r)!==o&&t.splice(r,0,o),"layers"in n&&lz(o)&&this._populateLayerViewsOwners(n.layers,o.layerViews,o),++r}r<t.length&&t.splice(r)}_createLayerView(e){e.load().catch(()=>{}),this.layerViewImporter.hasLayerViewModule(e)&&this.layerViewImporter.importLayerView(e);const t=new az(e,this.view,this.layerViewImporter);t.promise?.then(()=>this._refreshCollections(),i=>{i&&(zr(i)||i.name==="cancelled:layerview-create")||j.getLogger(this).error(`Failed to create layerview for layer title:'${e.title??"no title"}', id:'${e.id??"no id"}' of type '${e.type}'.`,{layer:e,error:i}),this.destroyed||this._refreshCollections()}),this._layerLayerViewInfoMap.set(e,t),this.view.ready&&t.start(),this.notifyChange("updating"),this.notifyChange("updatingRemaining")}};u([p()],Bs.prototype,"_workPromise",void 0),u([p({readOnly:!0})],Bs.prototype,"_watchUpdatingTracking",void 0),u([p({readOnly:!0})],Bs.prototype,"_layersToLayerViews",void 0),u([p({constructOnly:!0})],Bs.prototype,"layerviewMapping",void 0),u([p({readOnly:!0})],Bs.prototype,"_rootCollectionNames",null),u([p({constructOnly:!0})],Bs.prototype,"layerViewFilter",void 0),u([p()],Bs.prototype,"layerViewImporter",void 0),u([p()],Bs.prototype,"supportsGround",void 0),u([p({readOnly:!0})],Bs.prototype,"updating",null),u([p({readOnly:!0})],Bs.prototype,"updatingRemaining",null),u([p({constructOnly:!0})],Bs.prototype,"view",void 0),Bs=u([R("esri.views.support.LayerViewManager")],Bs);const cz=Bs;let sh=class extends te{constructor(e){super(e),this.featureTitleFields=!1,this.utilityNetworkFields=!1,this.globalIdField=!1}};u([p()],sh.prototype,"featureTitleFields",void 0),u([p()],sh.prototype,"utilityNetworkFields",void 0),u([p()],sh.prototype,"globalIdField",void 0),sh=u([R("esri.views.support.RequiredFieldsOptions")],sh);const hz=sh;var rh;let le=class extends $_(M$){static{rh=this}constructor(e){super(e),this._userSpatialReference=null,this.handles=new b_,this.updatingHandles=new hc,this.allLayerViews=new U$({getCollections:()=>this.layerviewCollections,getChildrenFunction:uz}),this.analyses=new su,this.basemapView=null,this.dependencies={popup:void 0},this.displayFilterEnabled=!0,this.fatalError=null,this.graphics=new R$,this.typeSpecificPreconditionsReady=!0,this.layerViews=new Pt,this.magnifier=new MR,this.padding={left:0,top:0,right:0,bottom:0},this.ready=!1,this._readyStateWaitingTask=null,this.type=null,this.scale=null,this.updating=!1,this.initialExtentRequired=!0,this._lowPriorityCursorHandles=new Pt,this._highPriorityCursorHandles=new Pt,this.input=new Yk,this.navigation=new BR,this.layerViewManager=null,this.analysisViewManager=null,this.isHeightModelInfoRequired=!1,this.width=null,this.height=null,this.resizing=!1,this.suspended=!1,this.viewEvents=new wk(this),this.persistableViewModels=new Pt,this.requiredFieldsOptions=new hz,this._isValid=!1,this._readyCycleForced=!1,this._lockedSpatialReference=null,this._userTimeZone=null,this._lockedTimeZone=null,this._userTimeExtent=null,this._lockedTimeExtent=null,this.theme=null,this.handles.add($(()=>this.preconditionsReady,t=>{const i=this.ready;if(t?(this._lockedSpatialReference=this.spatialReference,this._lockedTimeZone=this.timeZone,this._lockedTimeExtent=this.timeExtent,rh.views.add(this)):(this._lockedSpatialReference=null,rh.views.remove(this)),this.notifyChange("spatialReference"),!t&&i)this.toolViewManager?.detach(),this.analysisViewManager?.detach(),this.layerViewManager?.clear(),this._teardown();else if(t&&!i){try{this._startup()}catch(r){return void queueMicrotask(()=>{this.fatalError=new me("view:startup-error","View._startup failed",r)})}this.analysisViewManager?.attach(),this.toolViewManager.attach()}},Ae))}initialize(){this.addResolvingPromise(Promise.all([this.loadAsyncDependencies(),this._validateWithErrorDisplay()]).then(()=>(this._isValid=!0,op(()=>this.ready)))),this.basemapView=new gk({view:this}),this.layerViewManager=new cz({view:this,layerViewFilter:e=>this.layerViewFilter?.(e)??!0,layerViewImporter:{importLayerView:e=>this.importLayerView(e),hasLayerViewModule:e=>this.hasLayerViewModule(e)},layerviewMapping:this._layerToLayerviewMapping}),this.toolViewManager=new zn({view:this}),this.selectionManager=new vk({view:this}),this.addHandles([Zs(()=>this.readyState==="map-content-error"&&!this.spatialReference,()=>{j.getLogger(this).warn("#spatialReference","no spatial reference could be derived from the currently added map layers")}),$(()=>this.initialExtentRequired,e=>this.defaultsFromMap.required={...this.defaultsFromMap.required,extent:e},Ve),$(()=>this.ready,e=>{this.defaultsFromMap&&(this.defaultsFromMap.suspended=e,this.defaultsFromMap.userSpatialReference=e?this.spatialReference:this._userSpatialReference)},Ae),$(()=>this._userSpatialReference,e=>{this.defaultsFromMap&&(this.defaultsFromMap.userSpatialReference=e)},Ve)])}get _layerToLayerviewMapping(){return rh._layerToLayerview}static{this._layerToLayerview=[["view.map.basemap.baseLayers","view.basemapView.baseLayerViews"],["view.map.basemap.groundLayers","view.basemapView.groundLayerViews"],["view.map.basemap.referenceLayers","view.basemapView.referenceLayerViews"],["view.map.layers","view.layerViews"]]}destroy(){this.destroyed||(rh.views.remove(this),this.viewEvents.destroy(),this.allLayerViews.destroy(),this.navigation&&(this.navigation.destroy(),this._set("navigation",null)),this.graphics=Q(this.graphics),this.analyses=Q(this.analyses),this.defaultsFromMap.destroy(),this._set("defaultsFromMap",null),this.analysisViewManager=Q(this.analysisViewManager),this.toolViewManager=Q(this.toolViewManager),this.layerViewManager=Q(this.layerViewManager),this.selectionManager=Q(this.selectionManager),this.basemapView=Q(this.basemapView),this.layerViews?.forEach(e=>e.destroy()),this.layerViews.length=0,this.invalidate(),this.handles.destroy(),this.map=Q(this.map),this.updatingHandles.destroy())}_startup(){this._set("ready",!0)}_teardown(){this._set("ready",!1)}whenReady(){return Promise.resolve(this)}toMap(){return j.getLogger(this).error("#toMap()","Not implemented on this instance of View"),null}get activeTool(){return this.toolViewManager?.activeTool}set activeTool(e){this.toolViewManager&&(this.toolViewManager.activeTool=e)}get layerviewCollections(){return[this.basemapView?.baseLayerViews,this.basemapView?.groundLayerViews,this.layerViews,this.basemapView?.referenceLayerViews]}get animation(){return this._get("animation")}set animation(e){this._set("animation",e)}get center(){return null}get defaultsFromMapSettings(){return{}}get defaultsFromMap(){return new At({required:{tileInfo:!1,heightModelInfo:!1,extent:!1},map:()=>this.map,getSpatialReferenceSupport:(e,t)=>this.getSpatialReferenceSupport(e,t),...this.defaultsFromMapSettings})}get extent(){return this._get("extent")}set extent(e){this._set("extent",e)}get heightModelInfo(){return this.getDefaultHeightModelInfo()}get highlights(){return this._get("highlights")??Wk()}set highlights(e){this._set("highlights",P$(e,this._get("highlights"),Pt.ofType(Wl)))}get interacting(){return this.navigating}get navigating(){return!1}get preconditionsReady(){return!this.destroying&&!this.destroyed&&!(this.fatalError||!this._isValid||this._readyCycleForced||!this.map||Qx(this.map)&&!this.map.loaded||this.width===0||this.height===0||!this.spatialReference||!this._validateSpatialReference(this.spatialReference)||!this._lockedSpatialReference&&!this.defaultsFromMap?.ready||!this.typeSpecificPreconditionsReady)}get resolution(){return 0}set map(e){e!==this._get("map")&&(e?.destroyed&&(j.getLogger(this).warn("#map","The provided map is already destroyed",{map:e}),e=null),Qx(e)&&e.load().catch(()=>{}),this.constructed&&!this.destroyed&&(this.forceReadyCycle(),this._lockedSpatialReference=null),this._set("map",e))}get readyState(){if(this.destroyed)return this._get("readyState");if(!this.map)return"missing-map";if("container"in this&&!this.container)return"missing-container";if(this.fatalError)return"rendering-error";if((this.defaultsFromMap?.ready??!1)&&!this.spatialReference){const e=!("loaded"in this.map)||this.map.loaded,t=this.map.ground.loaded,i=this.map.basemap?.loaded??!0;return e&&i&&t&&!this.map?.allLayers.length?"empty-map":(this._readyStateWaitingTask||(this._readyStateWaitingTask=Za(r=>VM(Ze("view-readyState-waiting-delay"),null,r)),this.addHandles(this._readyStateWaitingTask),this.addHandles(this._readyStateWaitingTask,"ready-state-task")),this._readyStateWaitingTask?.finished?"map-content-error":"loading")}return this._readyStateWaitingTask=Os(this._readyStateWaitingTask),this.removeHandles("ready-state-task"),this.ready?"ready":"loading"}get spatialReference(){const e=this._userSpatialReference||this._lockedSpatialReference||this.getDefaultSpatialReference()||null;if(e&&this.defaultsFromMap?.required?.heightModelInfo){const t=e.clone();return t.vcsWkid=this.defaultsFromMap.vcsWkid,t.latestVcsWkid=this.defaultsFromMap.latestVcsWkid,t}return e}set spatialReference(e){const t=!tc(e,this._get("spatialReference"));this._set("_userSpatialReference",e),t&&(this._set("spatialReference",e),this._spatialReferenceChanged(e))}_spatialReferenceChanged(e){}get stationary(){return!this.animation&&!this.navigating&&!this.resizing}get timeExtent(){return this._userTimeExtent??this._lockedTimeExtent??this.getDefaultTimeExtent()??null}set timeExtent(e){this._userTimeExtent=e}get timeZone(){return this._userTimeZone??this._lockedTimeZone??this.getDefaultTimeZone()??S5}set timeZone(e){this._userTimeZone=e,$5(e)||j.getLogger(this).warn("#timeZone",`the parsed value '${e}' may not be a valid IANA time zone`)}get tools(){return this.toolViewManager?.tools}get initialExtent(){return this.defaultsFromMap?.extent}get cursor(){return this.toolViewManager?.cursor??this._highPriorityCursorHandles.at(-1)?.cursor??this._lowPriorityCursorHandles.at(-1)?.cursor??"default"}acquireCursor(e,t="low"){const i=t==="high"?this._highPriorityCursorHandles:this._lowPriorityCursorHandles,r={cursor:e},n=xn(()=>i.remove(r));return i.add(r),this.addHandles(n),n}get size(){return[this.width,this.height]}get effectiveTheme(){return this.theme??new k0}whenLayerView(e){return this.layerViewManager?.whenLayerView(e)??Promise.reject()}getDefaultSpatialReference(){return this.defaultsFromMap?.spatialReference}getDefaultHeightModelInfo(){return(this.map&&"heightModelInfo"in this.map?this.map.heightModelInfo:void 0)??this.defaultsFromMap?.heightModelInfo??null}getDefaultTimeZone(){return null}getDefaultTimeExtent(){return null}getSurface(){return null}importLayerView(e){throw new me("view:importLayerView-missing","importLayerView() not implemented")}hasLayerViewModule(e){return!1}async validate(){}async loadAsyncDependencies(){}invalidate(){this._isValid=!1}getSpatialReferenceSupport(){return{constraints:null}}_validateSpatialReference(e){return this.getSpatialReferenceSupport(e)!=null}when(e,t){return this.isResolved()&&!this.ready&&j.getLogger(this).warn("#when()","Calling view.when() while the view is no longer ready but was already resolved once will resolve immediately. Use reactiveUtils.whenOnce(() => view.ready).then(...) instead."),super.when(e,t)}forceReadyCycle(){this.ready&&(Zs(()=>this.destroyed||this.preconditionsReady===!1,()=>this._readyCycleForced=!1,{once:!0}),this._readyCycleForced=!0)}on(e,t){return super.on(e,t)}addAndActivateTool(e){this.toolViewManager.tools.add(e),this.activeTool=e}tryFatalErrorRecovery(){this.fatalError=null}static{this.views=new Pt}async _validateWithErrorDisplay(){try{await this.validate()}catch(e){const t=document.createElement("div");t.setAttribute("style","display: flex; flex-direction: column; gap: 8px; padding: 20px; height: 100%; justify-content: center; color: black; background: white; font-family: sans-serif;");const i=document.createElement("div");i.innerHTML="Unable to display map. WebGL2 support is required.",i.setAttribute("style","font-size: 24px; font-weight: bold;");const r=document.createElement("div");r.innerHTML="Ensure that your browser and hardware meet the minimum requirements.",r.setAttribute("style","font-size: 18px;");const n=document.createElement("a");n.innerHTML="https://esriurl.com/webgl-faq",n.target="_blank",n.setAttribute("style","font-size: 18px;"),n.href="https://esriurl.com/webgl-faq",t.appendChild(i),t.appendChild(r),t.appendChild(n);const a=this.getSurface();throw a&&a.appendChild(t),e}}};u([p()],le.prototype,"_userSpatialReference",void 0),u([p()],le.prototype,"activeTool",null),u([p({readOnly:!0})],le.prototype,"allLayerViews",void 0),u([p({readOnly:!0})],le.prototype,"layerviewCollections",null),u([p(M0(su,"analyses"))],le.prototype,"analyses",void 0),u([p()],le.prototype,"animation",null),u([p()],le.prototype,"basemapView",void 0),u([p()],le.prototype,"center",null),u([p()],le.prototype,"defaultsFromMapSettings",null),u([p()],le.prototype,"defaultsFromMap",null),u([p()],le.prototype,"dependencies",void 0),u([p()],le.prototype,"displayFilterEnabled",void 0),u([p({type:is})],le.prototype,"extent",null),u([p()],le.prototype,"fatalError",void 0),u([p(M0(R$,"graphics"))],le.prototype,"graphics",void 0),u([p({readOnly:!0,type:Bp})],le.prototype,"heightModelInfo",null),u([p({type:Pt.ofType(Wl)})],le.prototype,"highlights",null),u([p({readOnly:!0})],le.prototype,"interacting",null),u([p({constructOnly:!0})],le.prototype,"layerViewFilter",void 0),u([p({readOnly:!0})],le.prototype,"navigating",null),u([p({readOnly:!0,dependsOn:["fatalError","_isValid","_readyCycleForced","map","map.loaded?","width","height","spatialReference","_lockedSpatialReference","defaultsFromMap.ready","typeSpecificPreconditionsReady"]})],le.prototype,"preconditionsReady",null),u([p({readOnly:!0})],le.prototype,"typeSpecificPreconditionsReady",void 0),u([p({type:Pt,readOnly:!0})],le.prototype,"layerViews",void 0),u([p()],le.prototype,"resolution",null),u([p({type:MR})],le.prototype,"magnifier",void 0),u([p({value:null,type:T5})],le.prototype,"map",null),u([p()],le.prototype,"padding",void 0),u([p({readOnly:!0})],le.prototype,"ready",void 0),u([p()],le.prototype,"_readyStateWaitingTask",void 0),u([p({readOnly:!0})],le.prototype,"readyState",null),u([p({type:Dt})],le.prototype,"spatialReference",null),u([p()],le.prototype,"stationary",null),u([p({type:M5})],le.prototype,"timeExtent",null),u([p({type:String,nonNullable:!0})],le.prototype,"timeZone",null),u([p()],le.prototype,"tools",null),u([p()],le.prototype,"toolViewManager",void 0),u([p({readOnly:!0})],le.prototype,"type",void 0),u([p({type:Number})],le.prototype,"scale",void 0),u([p({readOnly:!0})],le.prototype,"updating",void 0),u([p({readOnly:!0})],le.prototype,"initialExtentRequired",void 0),u([p({readOnly:!0})],le.prototype,"initialExtent",null),u([p()],le.prototype,"cursor",null),u([p({readOnly:!0})],le.prototype,"input",void 0),u([p({type:BR,nonNullable:!0})],le.prototype,"navigation",void 0),u([p()],le.prototype,"layerViewManager",void 0),u([p()],le.prototype,"analysisViewManager",void 0),u([p()],le.prototype,"selectionManager",void 0),u([p()],le.prototype,"width",void 0),u([p()],le.prototype,"height",void 0),u([p({readOnly:!0})],le.prototype,"resizing",void 0),u([p({value:null,readOnly:!0})],le.prototype,"size",null),u([p({readOnly:!0})],le.prototype,"suspended",void 0),u([p({readOnly:!0})],le.prototype,"viewEvents",void 0),u([p({readOnly:!0})],le.prototype,"persistableViewModels",void 0),u([p()],le.prototype,"_isValid",void 0),u([p()],le.prototype,"_readyCycleForced",void 0),u([p()],le.prototype,"_lockedSpatialReference",void 0),u([p()],le.prototype,"_userTimeZone",void 0),u([p()],le.prototype,"_lockedTimeZone",void 0),u([p()],le.prototype,"_userTimeExtent",void 0),u([p()],le.prototype,"_lockedTimeExtent",void 0),u([p({type:k0})],le.prototype,"theme",void 0),u([p({readOnly:!0,type:k0})],le.prototype,"effectiveTheme",null),le=rh=u([R("esri.views.View")],le);const My=globalThis.$arcgis;My&&!My.views&&Object.defineProperty(My,"views",{configurable:!1,enumerable:!0,writable:!1,value:le.views});const EC=le;function uz(s){return s.layerViews}let nh=class extends M${constructor(e){super(e),this.state="running",this.target=null,this._resolver=null}initialize(){this._resolver=sa(),this.addResolvingPromise(this._resolver.promise)}get done(){return this.state==="finished"||this.state==="stopped"}stop(){this.state!=="stopped"&&this.state!=="finished"&&(this._set("state","stopped"),this._resolver?.reject(new me("view:animation-stopped","ViewAnimation stopped")))}finish(){this.state!=="stopped"&&this.state!=="finished"&&(this._set("state","finished"),this._resolver?.resolve())}update(e,t){t||(t=Lp(e)?"waiting-for-target":"running"),this._set("target",e),this._set("state",t)}static{this.state={RUNNING:"running",STOPPED:"stopped",FINISHED:"finished",WAITING_FOR_TARGET:"waiting-for-target"}}};u([p({readOnly:!0})],nh.prototype,"done",null),u([p({readOnly:!0,type:String})],nh.prototype,"state",void 0),u([p()],nh.prototype,"target",void 0),nh=u([R("esri.views.ViewAnimation")],nh);const ru=nh;function H0(s){return s==="global"?1:2}function $y(s){return s===1?"global":"local"}let dz=class{constructor(e,t=null,i=0){this.array=e,this.spatialReference=t,this.offset=i}};function WR(s){return"array"in s}function Yn(s,e,t="ground"){if(V$(e))return s.getElevation(e.x,e.y,e.z||0,e.spatialReference,t);if(WR(e)){let i=e.offset;return s.getElevation(e.array[i++],e.array[i++],e.array[i]||0,e.spatialReference??s.spatialReference,t)}return s.getElevation(e[0],e[1],e[2]||0,s.spatialReference,t)}function q0(s,e){return s!=null&&(e==null||(e===2?!s.isGeographic||s.isWGS84||s.wkid===4490:s.isWebMercator||s.isWGS84||s.wkid===4490||s.wkid===104971||s.wkid===104905||s.wkid===104903))}const r1=()=>j.getLogger("esri.views.3d.support.cameraUtils"),QR=96*39.37,G0=1,pz=8,mz=5,ZR=1,Gd=x();function dc(s){return s.spatialReference??Dt.WGS84}function fz(s,e,t,i,r){return uu(s).headingTiltToDirectionUp(e,t,i,r)}function vp(s,e){const{camera:t}=s.state,{unitInMeters:i}=s.renderCoordsHelper;return e/=i,t.width/2/t.pixelRatio/(QR/e)/Math.tan(t.fovX/2)}function nc(s,e){const{camera:t}=s.state,{unitInMeters:i}=s.renderCoordsHelper,r=e*Math.tan(t.fovX/2),n=t.width/2/t.pixelRatio;return QR/(n/r)*i}function XR(s,e,t,i){const r=i.levelAtScale(e),n=YR(x_(s,t.eye,t.viewForward,t.up).tilt),a=Math.max(r-n,0);return i.scaleAtLevel(a)}function AC(s,e,t){const i=t.levelAtScale(s),r=YR(e);return t.scaleAtLevel(i+r)}function YR(s){return 2*((s>90?180-s:s)/90)**2}function gz(s,e,t=0){const i=s.basemapTerrain?.tilingScheme;if(!i)return 0;const r=Zt(s.spatialReference).radius,n=s.state.viewingMode===2?e.eye[2]:fe(e.eye)-r;return XR(s,nc(s,Math.abs(n-t)),e,i)}function _z(s,e,t=0){const i=Wn(s,e);return i?gz(s,i,t):0}const yz=1,vz=100;function bz(s,e,t,i){if(e===0)return 0;const r=s.state.contentCamera,n=Ht(r.eye,t),a=s.basemapTerrain?.tilingScheme;if(!a)return r1().error("#scaleToTargetDistance()","Cannot compute distance from scale without a tiling scheme"),n;let o=n;const l=x_(s,r.eye,r.viewForward,r.up),c=l.tilt>90;if(s.state.isLocal){const g=(vp(s,AC(e,l.tilt,a))-Math.abs(r.eye[2]-i[2]))/Math.cos(rt(l.tilt));return o=c?o-g:o+g,o}let h=1/0,d=0,m=bp(s,l.heading,l.tilt,t,n,1);if(!m)return o;const f=fe(i);for(;h>yz&&d<vz;){const g=fe(m.eye),_=c?180-m.tilt:m.tilt,v=rt(_),b=Math.sin(v)*g,T=Math.cos(v)*g,w=vp(s,AC(e,m.tilt,a)),S=c?f-w:f+w,C=lp(b/S),P=Math.cos(C)*S-T,M=Ht(m.eye,t);o=c?M-P:M+P,m=bp(s,l.heading,l.tilt,t,o,1);const O=a1(s,m,ic(r.fov));if(!m||!O)return o;const D=_z(s,O,f-Zt(s.spatialReference).radius);h=Math.abs(e-D),++d}return o}async function wz(s,e,t,i,r,n){return F_(s,e,vp(s,t),i,r,n)}function xz(s,e,t,i,r,n){return a1(s,bp(s,i.heading,i.tilt,e,t,r),i.fov,n)}async function F_(s,e,t,i,r,n){const a=await JR(s,i.heading,i.tilt,e,t,r,n);return He(n),uO(s,a,i.fov,n)}function KR(s,e){return!!(s.basemapTerrain&&s.renderCoordsHelper.fromRenderCoords(e,Gd,s.spatialReference)&&s.elevationProvider&&(Yn(s.elevationProvider,Gd)??0)>Gd[2]-ZR)}async function Cz(s,e,t){if(KR(s,e))return!0;const{elevationProvider:i,spatialReference:r,renderCoordsHelper:n}=s;if(i==null||!n.fromRenderCoords(e,Gd,r))return!1;const[a,o,l]=Gd,c=await i.queryElevation(a,o,l,r,"ground",t)??0;return He(t),c>l-ZR}async function Tz(s,e,t){const i=x();if(e==null)return q(i,s.state.camera.center);if(e instanceof wt){const{renderSpatialReference:r,basemapTerrain:n,elevationProvider:a}=s,o=e.spatialReference;if(await Lg(e,i,r,0,{signal:t}),He(t),e.z==null&&n!=null&&a!=null){const l=await a.queryElevation(e.x,e.y,e.z??0,o,"ground",t);He(t),l!=null&&s.renderCoordsHelper.setAltitude(i,l)}return i}return q(i,e)}function Sz(s,e){const t=x();if(e==null)return q(t,s.state.camera.center);if(e instanceof wt){if(!Na(e,t,s.renderSpatialReference))return null;const{basemapTerrain:i,elevationProvider:r}=s;if(e.z==null&&i!=null&&r!=null){const n=Yn(r,e);n!=null&&s.renderCoordsHelper.setAltitude(t,n)}return t}return q(t,e)}function bp(s,e,t,i,r,n){return eO(s,e,t,i instanceof wt?i:null,Sz(s,i),r,n)}async function JR(s,e,t,i,r,n,a){const o=i instanceof wt?i:null,l=await Tz(s,i,a);return He(a),tO(s,e,t,o,l,r,n,a)}function eO(s,e,t,i,r,n,a){if(r==null||!i&&(i=new wt({spatialReference:dc(s)}),!Hp(r,s.renderSpatialReference,i)))return null;const o=iO(s,e,t,r,n,a);if(sO(s,t,a)&&KR(s,o.eye)){const{tilt:l,mode:c}=rO(s,t,r,n);return eO(s,e,l,i,r,n,c)}return nO(o,r)}async function tO(s,e,t,i,r,n,a,o){i||(i=new wt({spatialReference:dc(s)}),await k$(r,s.renderSpatialReference,i,{signal:o})||(i=null)),He(o);const l=iO(s,e,t,r,n,a);if(sO(s,t,a)&&await Cz(s,l.eye,o)){He(o);const{tilt:c,mode:h}=rO(s,t,r,n);return tO(s,e,c,i,r,n,h,o)}return nO(l,r)}function iO(s,e,t,i,r,n){const a=$z(s,e,t,i,r=Math.max(r,s.state.constraints.minimumPoiDistance),n);return(0,uu(s).eyeForCenterWithHeadingTilt)(i,r,a.heading,a.tilt)}function sO(s,e,t){const i=s.map.ground.navigationConstraint;return t===1&&s.state.isGlobal&&e>0&&(i==null||i.type==="stay-above")}function rO(s,e,t,i){const r=hO(s,t,i,Oz(s,i,e,t));return{tilt:r,mode:e-r<1?0:1}}function nO(s,e){return{...s,center:Sn(e)}}function aO(s,e){const{state:t,spatialReference:i}=s,r=e.spatialReference;return t.isGlobal&&q0(r,1)||t.isLocal&&i.equals(r)}function oO(s,e){let t,i,r;if(s.state.isGlobal){const h=new wt(e.xmin,e.ymin,e.spatialReference),d=new wt(e.xmax,e.ymax,e.spatialReference),m=e.spatialReference.isGeographic?F5:V5;t=new wt({x:m.center(h.x,d.x),y:(d.y+h.y)/2,z:e.zmax!=null&&e.zmin!=null?(e.zmax+e.zmin)/2:void 0,spatialReference:e.spatialReference});const f=Zt(e.spatialReference),g=EI(t,h,d);i=g.lon,r=g.lat,m.diff(h.x,d.x)>m.range/2&&(i+=f.halfCircumference),i=Math.min(i,f.halfCircumference),r=Math.min(r,f.halfCircumference)}else{const h=s.renderSpatialReference??e.spatialReference;h.equals(e.spatialReference)||(e=Np(e,h)),i=e.xmax-e.xmin,r=e.ymax-e.ymin;const d=e.zmax!=null&&e.zmin!=null?(e.zmax+e.zmin)/2:void 0;t=new wt({x:e.xmin+.5*i,y:e.ymin+.5*r,z:d,spatialReference:h})}const n=e.zmax!=null&&e.zmin!=null?e.zmax-e.zmin:0,a=s.state.camera,o=1/Math.tan(a.fovX/2),l=1/Math.tan(a.fovY/2),c=1/Math.tan(a.fov/2);return{center:t,distance:Math.max(.5*i*o,.5*r*l,.5*n*c)/G0}}async function lO(s,e,t,i,r,n){const a=aO(s,e)?e:await Lo(e,s.spatialReference,{signal:n});He(n);const{center:o,distance:l}=oO(s,a),c=await JR(s,t,i,o,l,r,n);return He(n),uO(s,c,s.camera.fov,n)}function If(s,e,t,i,r,n){let a;try{a=aO(s,e)?e:Np(e,s.spatialReference)}catch{return null}const{center:o,distance:l}=oO(s,a),c=bp(s,t,i,o,l,r);return c==null?null:a1(s,c,s.camera.fov,n)}function cO(s,e,t){const i=s.renderSpatialReference,r=new wt({spatialReference:dc(s)});if(!Hp(t,i,r))return null;const n=Math.tan(e.fovX/2),a=Math.tan(e.fovY/2),o=Vw(e.eye,t),l=2*o*n*G0,c=2*o*a*G0;return uu(s).toExtent(s,r,l,c)}function Pz(s,e){return uu(s).toArea(s,e)}function Mz(s,e,t){const i=s.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(t/i)/Math.LN2>pz)return!0;const r=e,n=s.pointsOfInterest.centerOnSurfaceFrequent.renderLocation;return Ht(r,n)/(Math.tan(.5*s.state.camera.fov)*i)>mz}function $z(s,e,t,i,r,n){let a=0;return n===1&&Mz(s,i,r)?(e=0,a=Rz(s,r,t,i)):a=n1(s,i,r,t),a=s.state.constraints.clampTilt(r,a),{heading:e,tilt:t=hO(s,i,r,a)}}const Ng=.7;function Rz(s,e,t,i){const r=n1(s,i,e,t);if(!s.state.constraints.tilt)return r;const n=s.state.constraints.tilt(e);n.max=Math.min(n.max,.5*Math.PI);const a=n.min*(1-Ng)+n.max*Ng;return Math.min(r,a)}function Oz(s,e,t,i){let r=n1(s,i,e,t);if(!s.state.constraints.tilt)return r;const n=s.state.constraints.tilt(e);return r=Math.min(r,.5*Math.PI),n.min*(1-Ng)+r*Ng}function hO(s,e,t,i){return uu(s).lookAtTiltToEyeTilt(i,e,t)}function n1(s,e,t,i){return uu(s).eyeTiltToLookAtTilt(i,e,t)}function a1(s,e,t,i){if(e==null)return null;const r=s.renderSpatialReference,n=new wt({spatialReference:dc(s)});return Hp(e.eye,r,n)?(i??=new Qs,i.position=n,i.heading=e.heading,i.tilt=e.tilt,i.fov=t,i):null}async function uO(s,e,t,i){const r=s.renderSpatialReference,n=new wt({spatialReference:dc(s)});return await k$(e.eye,r,n,{signal:i}),He(i),new Qs(n,e.heading,e.tilt,t)}function Dz(s,e){const t=s.basemapTerrain?.tilingScheme;if(t)return t.levelAtScale(e);r1().error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function dO(s,e){const t=s.basemapTerrain?.tilingScheme;if(t)return t.scaleAtLevel(e);r1().error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}const Ez=12;let un=class ys{constructor(e){const t=ys.checkUnsupported(e);if(t!=null)throw t;const i=e;this.spatialReference=i.spatialReference,this._isWebMercator=this.spatialReference.isWebMercator,this._isGCS=iF(this.spatialReference),this.origin=[i.origin.x,i.origin.y],this.pixelSize=i.size[0],this.dpi=i.dpi;const r=i.lods.reduce((c,h)=>(h.level<c.minLod.level&&(c.minLod=h),c.max=Math.max(c.max,h.level),c),{minLod:i.lods[0],max:-1/0}),n=r.minLod,a=2**n.level;let o=n.resolution*a,l=n.scale*a;this.levels=new Array(r.max+1);for(let c=0;c<this.levels.length;c++)this.levels[c]={resolution:o,scale:l,tileSize:[o*i.size[0],o*i.size[1]]},o/=2,l/=2}clone(){return new ys(this.toTileInfo())}toTileInfo(){return new am({dpi:this.dpi,origin:new wt({x:this.origin[0],y:this.origin[1],spatialReference:this.spatialReference}),size:[this.pixelSize,this.pixelSize],spatialReference:this.spatialReference,lods:this.levels.map((e,t)=>new om({level:t,scale:e.scale,resolution:e.resolution}))})}getExtent(e,t,i,r){const n=this.levels[e],a=n.tileSize[0],o=n.tileSize[1];r[0]=this.origin[0]+i*a,r[2]=this.origin[0]+(i+1)*a,r[3]=this.origin[1]-t*o,r[1]=this.origin[1]-(t+1)*o}convertExtentToRadians(e,t){this._isWebMercator?(t[0]=Gx(e[0]),t[1]=P0(e[1]),t[2]=Gx(e[2]),t[3]=P0(e[3])):this._isGCS&&(t[0]=rt(e[0]),t[1]=rt(e[1]),t[2]=rt(e[2]),t[3]=rt(e[3]))}getExtentGeometry(e,t,i,r=new is){return this.getExtent(e,t,i,Rn),r.spatialReference=this.spatialReference,r.xmin=Rn[0],r.ymin=Rn[1],r.xmax=Rn[2],r.ymax=Rn[3],r.zmin=void 0,r.zmax=void 0,r}ensureMaxLod(e){if(e==null)return!1;let t=!1;for(;this.levels.length<=e;){const{resolution:i,scale:r}=this.levels[this.levels.length-1],n=i/2*this.pixelSize;this.levels.push({resolution:i/2,scale:r/2,tileSize:[n,n]}),t=!0}return t}capMaxLod(e){this.levels.length>e+1&&(this.levels.length=e+1)}getMaxLod(){return this.levels.length-1}scaleAtLevel(e){return this.levels[0].scale/2**e}levelAtScale(e){const t=this.levels[0].scale;return e>=t?0:Math.log(t/e)*Math.LOG2E}resolutionAtLevel(e){return this.levels[0].resolution/2**e}compatibleWith(e,t=1/0){if(ys.checkUnsupported(e))return!1;const i=new ys(e);if(!i.spatialReference.equals(this.spatialReference)||i.pixelSize!==this.pixelSize)return!1;const r=Math.min(this.levels.length-1,i.levels.length-1,t),n=this.levels[r].resolution;let a=.5*n;return!py(i.origin[0],this.origin[0],a)||!py(i.origin[1],this.origin[1],a)?!1:(a=.5*n/2**r/this.pixelSize*Ez,py(n,i.levels[r].resolution,a))}rootTilesInExtent(e,t=null,i=1/0){const r=new Array,n=this.levels[0].tileSize;if(e==null||n[0]===0||n[1]===0)return r;ys.computeRowColExtent(e,n,this.origin,Rn);let a=Rn[1],o=Rn[3],l=Rn[0],c=Rn[2];const h=c-l,d=o-a;if(h*d>i){const m=Math.floor(Math.sqrt(i));d>m&&(a=a+Math.floor(.5*d)-Math.floor(.5*m),o=a+m),h>m&&(l=l+Math.floor(.5*h)-Math.floor(.5*m),c=l+m)}for(let m=a;m<o;m++)for(let f=l;f<c;f++)r.push([0,m,f]);return t!=null&&(t[0]=this.origin[0]+l*n[0],t[1]=this.origin[1]-o*n[1],t[2]=this.origin[0]+c*n[0],t[3]=this.origin[1]-a*n[1]),r}static computeRowColExtent(e,t,i,r){const n=.001*(e[2]-e[0]+(e[3]-e[1]));r[0]=Math.max(0,Math.floor((e[0]+n-i[0])/t[0])),r[2]=Math.max(0,Math.ceil((e[2]-n-i[0])/t[0])),r[1]=Math.max(0,Math.floor((i[1]-e[3]+n)/t[1])),r[3]=Math.max(0,Math.ceil((i[1]-e[1]-n)/t[1]))}static isPowerOfTwo(e){const t=e.lods,i=t[0].resolution*2**t[0].level;return!t.some(r=>!R5(r.resolution,i/2**r.level))}static hasGapInLevels(e){const t=e.lods.map(i=>i.level);t.sort((i,r)=>i-r);for(let i=1;i<t.length;i++)if(t[i]!==t[0]+i)return!0;return!1}static tileSizeSupported(e){const t=e.size[1];return t===e.size[0]&&!(t&t-1)&&t>=128&&t<=512}static hasOriginPerLODs(e){const t=e.origin;return e.lods.some(i=>i.origin!=null&&(i.origin[0]!==t.x||i.origin[1]!==t.y))}static getMissingTileInfoError(){return new me("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}static checkUnsupported(e){return e==null?o1():e.lods.length<1?new me("tilingscheme:generic","Tiling scheme must have at least one level"):ys.isPowerOfTwo(e)?ys.hasGapInLevels(e)?new me("tilingscheme:gaps","Tiling scheme levels must not have gaps between min and max level"):ys.tileSizeSupported(e)?ys.hasOriginPerLODs(e)?new me("tilingscheme:multiple-origin","Tiling scheme levels must not have their own origin"):null:new me("tilingscheme:tile-size","Tiles must be square and size must be one of [128, 256, 512]"):new me("tilingscheme:power-of-two","Tiling scheme must be power of two")}static fromExtent(e,t){const i=e[2]-e[0],r=e[3]-e[1],n=Wh(t),a=1.2*Math.max(i,r),o=256,l=a/o,c=l*n*(96/.0254),h=new ys(new am({size:[o,o],origin:new wt({x:e[0]-.5*(a-i),y:e[3]+.5*(a-r)}),lods:[new om({level:0,resolution:l,scale:c})],spatialReference:t}));return h.ensureMaxLod(20),h}static makeWebMercatorAuxiliarySphere(e){const t=new ys(ys.WebMercatorAuxiliarySphereTileInfo);return t.ensureMaxLod(e),t}static makeGCSWithTileSize(e,t=256,i=16){const r=256/t,n=new ys(new am({size:[t,t],origin:new wt({x:-180,y:90,spatialReference:e}),spatialReference:e,lods:[new om({level:0,resolution:.703125*r,scale:295497598570834e-6*r})]}));return n.ensureMaxLod(i),n}static{this.WebMercatorAuxiliarySphereTileInfo=new am({size:[256,256],origin:new wt({x:-20037508342787e-6,y:20037508342787e-6,spatialReference:Dt.WebMercator}),spatialReference:Dt.WebMercator,lods:[new om({level:0,resolution:156543.03392800014,scale:591657527591555e-6})]})}static{this.WebMercatorAuxiliarySphere=ys.makeWebMercatorAuxiliarySphere(19)}get test(){}};function o1(){return new me("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}const Rn=Mt(),Ch=64,ad=512,Az=2.5,l1=O5(D5/10),pO=2,mO=Mt();un.WebMercatorAuxiliarySphere.getExtent(0,0,0,mO);const Iz=Mt([-180,-90,180,90]),Lz="Cannot extend surface to encompass all layers because it would result in too many root tiles.",Fz="Surface extent is too large for tile resolution at level 0.",li=4;let Th=class extends k5{constructor(e){super(e),this.noDataValue=l1}};u([p({constructOnly:!0})],Th.prototype,"view",void 0),u([p({readOnly:!0})],Th.prototype,"noDataValue",void 0),Th=u([R("esri.views.support.GroundViewElevationSampler")],Th);let ah=class extends Th{initialize(){this.view.basemapTerrain.on("elevation-change",()=>this.emit("changed",{}))}get demResolution(){return this.view.basemapTerrain.demResolution}get extent(){const e=this.view.basemapTerrain;if(e?.extent==null||e.spatialReference==null)return null;const t=A$(e.extent,e.spatialReference);return t.zmin=e.visibleElevationBounds.min,t.zmax=e.visibleElevationBounds.max,t}get spatialReference(){return this.view.basemapTerrain?.spatialReference??Dt.WGS84}elevationAt(e,t){if(this.extent==null||!O$(this.extent,e,t)){const i=this.extent!=null?`${this.extent.xmin}, ${this.extent.ymin}, ${this.extent.xmax}, ${this.extent.ymax}`:null;return j.getLogger(this).warn("#elevationAt()",`Point used to sample elevation (${e}, ${t}) is outside of the sampler extent (${i})`),this.noDataValue}return this.view.elevationProvider?.getElevation(e,t,0,this.spatialReference,"ground")??this.noDataValue}};u([p({readOnly:!0})],ah.prototype,"demResolution",null),u([p({readOnly:!0})],ah.prototype,"extent",null),u([p()],ah.prototype,"spatialReference",null),ah=u([R("esri.views.support.GroundElevationSampler")],ah);let oh=class extends Th{get demResolution(){return this.view.basemapTerrain.demResolution}get extent(){return this.view.map.allLayers.reduce((e,t)=>t.type!=="integrated-mesh"&&t.type!=="integrated-mesh-3dtiles"||!t.fullExtent?e:e?e.union(t.fullExtent):t.fullExtent.clone(),null)}get spatialReference(){return this.view.spatialReference}elevationAt(e,t){return this.extent!=null&&O$(this.extent,e,t)?this.view.elevationProvider.getElevation(e,t,0,this.spatialReference,"im")??this.noDataValue:this.noDataValue}};u([p({readOnly:!0})],oh.prototype,"demResolution",null),u([p({readOnly:!0})],oh.prototype,"extent",null),u([p()],oh.prototype,"spatialReference",null),oh=u([R("esri.views.support.IntegratedMeshElevationSampler")],oh);let Bn=class extends te{constructor(e){super(e),this.view=null,this.layerViews=new Pt}initialize(){this.addHandles(Zs(()=>this.view?.map?.ground,async e=>e.load())),this.view.type==="3d"&&this.addHandles([$(()=>this.view.map?.basemap,()=>this._groundLayersChanged(),{initial:!0}),$(()=>this.view.map?.basemap?.groundLayers,e=>{this._groundLayersChanged(),e?.on("after-changes",()=>this._groundLayersChanged())},{initial:!0}),$(()=>this.view.basemapView?.groundLayerViews,e=>{this._groundLayersChanged(),e?.on("after-changes",()=>this._groundLayersChanged())},{initial:!0}),Zs(()=>this.view.type==="3d"&&(this.view?.basemapTerrain??!1),async()=>{this._groundLayersChanged()})])}_groundLayersChanged(){const{view:e}=this;if(e!=null&&e.type==="3d"){const t=e.basemapTerrain;if(t){const i=e.map?.basemap?.groundLayers.some(r=>!!e.basemapView?.groundLayerViews.find(n=>n.layer===r)&&"replacesTerrain"in r&&r.replacesTerrain);t.enable(!i)}}}get ground(){return this.view?.map?.ground}destroy(){this._set("view",null),this.layerViews.destroyAll()}get elevationSampler(){return this.view.type==="3d"?new ah({view:this.view}):null}get integratedMeshElevationSampler(){return this.view?new oh({view:this.view}):null}get extent(){const{view:e}=this;return e?.ready?cO(e,e.state.camera,e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation):null}get updating(){return!this.suspended&&this.layerViews.some(({updating:e})=>e)}get suspended(){return this.view?.suspended??!0}};u([p({readOnly:!0})],Bn.prototype,"elevationSampler",null),u([p({readOnly:!0})],Bn.prototype,"integratedMeshElevationSampler",null),u([p({readOnly:!0})],Bn.prototype,"extent",null),u([p({type:Boolean,readOnly:!0})],Bn.prototype,"updating",null),u([p({constructOnly:!0})],Bn.prototype,"view",void 0),u([p({type:Pt,readOnly:!0})],Bn.prototype,"layerViews",void 0),u([p({readOnly:!0})],Bn.prototype,"suspended",null),Bn=u([R("esri.views.GroundView")],Bn);const Vz=Bn;let nr=class extends $_(Vz){constructor(e){super(e)}initialize(){super.initialize(),this.addHandles(Zs(()=>this._terrainSurface,e=>e.on("elevation-change",t=>this._elevationChange(t)))),this.addHandles(Zs(()=>this._integratedMeshGroundLayerView,e=>{this.removeHandles(IC),e&&this.addHandles(e.elevationProvider.on("elevation-change",t=>this._elevationChange(t)),IC)}))}_elevationChange(e){this.emit("elevation-change",e)}get _integratedMeshGroundLayerView(){const e=this.ground?.integratedMeshGround;if(e)return this.view.basemapView?.groundLayerViews.find(t=>t.layer===e)}get _terrainSurface(){return this.view.basemapTerrain}get _usingTerrain(){return this._terrainSurface?.enabled??!1}get _usingIntegratedMesh(){return this._integratedMeshGroundLayerView?.visible??!1}get spatialReference(){return this._terrainSurface?.spatialReference}intersect(e,t,i,r){this._source?.intersect(e,t,i,r)}get updating(){return!this.suspended&&((this._source?.updating??!1)||this.layerViews.some(({updating:e})=>e))}get elevationQueryCache(){return this._usingTerrain?this._terrainSurface?.elevationQueryCache:null}get extentAABR(){return this._terrainSurface?.extent}get suspended(){return this._source?.suspended??!1}get ready(){return this._source?.ready??!0}updateOverlayParameters(){this._terrainSurface?.updateOverlayParameters()}get _source(){return this._usingTerrain?this._terrainSurface:this._usingIntegratedMesh?this._integratedMeshGroundLayerView:null}requestRender(e){this.view.stage.renderView?.requestRender(e)}};u([p({readOnly:!0})],nr.prototype,"_integratedMeshGroundLayerView",null),u([p({readOnly:!0})],nr.prototype,"_terrainSurface",null),u([p({readOnly:!0})],nr.prototype,"_usingTerrain",null),u([p({readOnly:!0})],nr.prototype,"_usingIntegratedMesh",null),u([p({readOnly:!0})],nr.prototype,"spatialReference",null),u([p({type:Boolean,readOnly:!0})],nr.prototype,"updating",null),u([p({readOnly:!0})],nr.prototype,"elevationQueryCache",null),u([p({readOnly:!0})],nr.prototype,"extentAABR",null),u([p({readOnly:!0})],nr.prototype,"suspended",null),u([p({readOnly:!0})],nr.prototype,"ready",null),nr=u([R("esri.views.3d.GroundView3D")],nr);const IC=Symbol("integratedMeshHandleKey"),Ou=()=>k(()=>import("./TileLayerView3D-Bzse8fnp.js"),__vite__mapDeps([169,1,102,5,6,10,4,7,8,2,9,28,19,20,14,170,171,166,13,35,88,172,148,109,173,174,175,26,3,11,12,15,27,29,30,31,32,33,34,36,37,38,39,40,41,42,43,44,122,176,92,93,94,90,95,177,178,179,180,181,182,183,184,185,87,186,187,70,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,21,16,22,23,24,113,114,205,206,129,207,208,209,210,98,211,52,212,76,213,214,47,18,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,132,231,232,233,234,99,100,235,236,237,238,239,80,240,241,242,243,244,245,246,247,248,249,250])),LC=()=>k(()=>import("./ElevationLayerView3D-BlJyxDV4.js"),__vite__mapDeps([251,5,6,1,252,245,113,114,10,7,8,16,12,2,9,20,14,170,171,166,13,35,88,179,15,4,180,182,39,183,19,184,185,87,186,187,70,188,189,190,191,192,193,37,38,194,195,196,197,102,28,198,199,200,11,93,201,202,203,92,94,27,90,95,204,29,21,22,23,24,205,206,175,26,3,30,31,32,33,34,36,40,41,42,43,44,129,207,208,209,210,98,211,122,52,212,76,213,214,47,18,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,132,231,232,233,234,99,100,235,236,237,238,239,80,240,241,242,243,244,246,247,248,249,250])),FC={"base-dynamic":()=>k(()=>import("./BaseDynamicLayerView3D-DEYmHM3G.js"),__vite__mapDeps([253,1,254,47,2,9,7,8,5,6,20,14,255,180,38,39,182,183,4,10,19,184,185,87,186,88,187,70,188,189,190,191,192,13,193,37,194,195,196,197,102,28,198,199,200,35,11,12,93,201,202,203,92,94,27,90,95,204,207,208,209,26,3,15,29,30,31,32,33,34,36,40,41,42,43,44,210,98,211,256,257,258,170,179,166,181,21,16,22,23,24,113,114,205,206,175,129,122,52,212,76,213,214,18,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,132,231,232,233,234,99,100,235,236,237,238,239,80,240,241,242,243,244,245,246,247,248,249,250])),"base-elevation":LC,"base-tile":Ou,"bing-maps":Ou,"building-scene":()=>k(()=>import("./BuildingSceneLayerView3D-D7REwVUo.js"),__vite__mapDeps([259,1,4,5,6,7,8,2,9,10,260,26,3,11,12,13,14,15,27,28,19,20,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,111,107,108,109,110,48,49,112,113,114,16,115,101,102,103,116,117,118,119,69,70,120,121,122,22,123,124,125,126,127,51,128,129,130,131,132,71,46,47,50,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,133,134,135,136,137,138,139,140,141,142,143,77,78,76,79,80,81,82,83,84,85,75,86,87,88,144,145,146,147,148,149,150,151,152,153,154,155,156,23,157,158,159,261,262,263,264,183,202,201,187,188,189,186,265,266,197,166,194,195,196,191,192,178,267,217,268,269,180,270,271,182,184,185,190,193,198,199,200,93,203,92,94,90,95,204,272,208,209,273,227,18,246,274,98,275,220,221,222,276,232,233,207,210,211,99,277,205,206,236,278,245,279,247,237,280,281,282,283,284,285,234,100,286,287,288,289,68,290,291,292,293,294,295,170,179,21,24,175,212,213,214,215,216,218,219,223,224,161,225,226,228,229,230,231,235,238,239,240,241,242,243,244,248,249,250])),catalog:()=>k(()=>import("./CatalogLayerView3D-ZXo-q0--.js"),__vite__mapDeps([296,1,4,5,6,7,8,2,9,10,170,179,15,12,180,166,13,14,35,88,182,39,183,19,20,184,185,87,186,187,70,188,189,190,191,192,193,37,38,194,195,196,197,102,28,198,199,200,11,93,201,202,203,92,94,27,90,95,204,29,21,16,22,23,24,113,114,205,206,175,26,3,30,31,32,33,34,36,40,41,42,43,44,129,207,208,209,210,98,211,122,52,212,76,213,214,47,18,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,132,231,232,233,234,99,100,235,236,237,238,239,80,240,241,242,243,244,245,246,247,248,249,250])),"catalog-dynamic-group":()=>k(()=>import("./CatalogDynamicGroupLayerView3D-D6bv-610.js"),__vite__mapDeps([297,1,4,5,6,7,8,2,9,10,170,11,12,179,15,180,166,13,14,35,88,182,39,183,19,20,184,185,87,186,187,70,188,189,190,191,192,193,37,38,194,195,196,197,102,28,198,199,200,93,201,202,203,92,94,27,90,95,204,29,21,16,22,23,24,113,114,205,206,175,26,3,30,31,32,33,34,36,40,41,42,43,44,129,207,208,209,210,98,211,122,52,212,76,213,214,47,18,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,132,231,232,233,234,99,100,235,236,237,238,239,80,240,241,242,243,244,245,246,247,248,249,250])),"catalog-footprint":()=>k(()=>import("./CatalogFootprintLayerView3D-CnSTKEEo.js"),__vite__mapDeps([298,1,299,5,6,2,232,98,7,8,37,9,20,14,38,39,233,28,19,29,48,13,49,11,12,300,26,3,4,10,15,27,30,31,32,33,34,35,36,40,41,42,43,44,207,70,186,183,88,185,87,182,184,187,188,189,190,191,192,193,194,195,196,197,102,198,199,200,93,201,202,203,92,94,90,95,204,208,209,210,211,293,294,80,301,287,66,51,71,280,281,282,166,180,47,46,22,50,52,53,54,55,56,57,58,59,60,61,62,63,64,65,302,161,18,303,227,73,69,74,75,76,304,236,132,305,306,307,276,114,16,99,277,205,206,178,308,127,176,285,234,100,286,268,84,85,82,288,289,86,68,290,291,292,81,309,103,122,310,311,170,91,96,97,101,245,113,312,313,314,123,126,119,265,179,181,21,23,24,175,129,212,213,214,215,216,217,147,218,219,220,144,221,222,223,224,225,226,228,229,142,83,230,231,235,237,238,239,240,241,242,243,244,246,247,248,249,250])),csv:()=>k(()=>import("./CSVLayerView3D-BKeDVwhx.js"),__vite__mapDeps([315,1,299,5,6,2,232,98,7,8,37,9,20,14,38,39,233,28,19,29,48,13,49,11,12,300,26,3,4,10,15,27,30,31,32,33,34,35,36,40,41,42,43,44,207,70,186,183,88,185,87,182,184,187,188,189,190,191,192,193,194,195,196,197,102,198,199,200,93,201,202,203,92,94,90,95,204,208,209,210,211,293,294,80,301,287,66,51,71,280,281,282,166,180,47,46,22,50,52,53,54,55,56,57,58,59,60,61,62,63,64,65,302,161,18,303,227,73,69,74,75,76,304,236,132,305,306,307,276,114,16,99,277,205,206,178,308,127,176,285,234,100,286,268,84,85,82,288,289,86,68,290,291,292,81,309,103,122,310,311,170,91,96,97,101,245,113,312,313,314,123,126,119,265,179,181,21,23,24,175,129,212,213,214,215,216,217,147,218,219,220,144,221,222,223,224,225,226,228,229,142,83,230,231,235,237,238,239,240,241,242,243,244,246,247,248,249,250])),dimension:()=>k(()=>import("./DimensionLayerView3D-9d0okYxd.js"),__vite__mapDeps([316,5,6,1,170,2,317,47,4,7,8,9,10,179,15,12,180,166,13,14,35,88,182,39,183,19,20,184,185,87,186,187,70,188,189,190,191,192,193,37,38,194,195,196,197,102,28,198,199,200,11,93,201,202,203,92,94,27,90,95,204,29,21,16,22,23,24,113,114,205,206,175,26,3,30,31,32,33,34,36,40,41,42,43,44,129,207,208,209,210,98,211,122,52,212,76,213,214,18,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,132,231,232,233,234,99,100,235,236,237,238,239,80,240,241,242,243,244,245,246,247,248,249,250])),elevation:LC,feature:()=>k(()=>import("./FeatureLayerView3D-C5u_dk9H.js"),__vite__mapDeps([318,1,102,5,6,10,4,7,8,2,9,28,19,20,14,112,52,15,12,299,232,98,37,38,39,233,29,48,13,49,11,300,26,3,27,30,31,32,33,34,35,36,40,41,42,43,44,207,70,186,183,88,185,87,182,184,187,188,189,190,191,192,193,194,195,196,197,198,199,200,93,201,202,203,92,94,90,95,204,208,209,210,211,293,294,80,301,287,66,51,71,280,281,282,166,180,47,46,22,50,53,54,55,56,57,58,59,60,61,62,63,64,65,302,161,18,303,227,73,69,74,75,76,304,236,132,305,306,307,276,114,16,99,277,205,206,178,308,127,176,285,234,100,286,268,84,85,82,288,289,86,68,290,291,292,81,309,103,122,310,311,170,91,96,97,101,245,113,312,313,314,123,126,119,265,179,181,21,23,24,175,129,212,213,214,215,216,217,147,218,219,220,144,221,222,223,224,225,226,228,229,142,83,230,231,235,237,238,239,240,241,242,243,244,246,247,248,249,250])),"gaussian-splat":()=>k(()=>import("./GaussianSplatLayerView3D-hvWCXDi1.js"),__vite__mapDeps([319,1,2,7,8,5,6,189,320,14,183,4,9,10,19,20,129,102,28,236,132,11,12,170,194,39,195,87,88,196,197,70,191,188,186,98,187,182,184,185,190,192,13,193,37,38,198,199,200,35,93,201,202,203,92,94,27,90,95,204,237,211,18,245,113,114,16,179,15,180,166,29,21,22,23,24,205,206,175,26,3,30,31,32,33,34,36,40,41,42,43,44,207,208,209,210,122,52,212,76,213,214,47,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,231,232,233,234,99,100,235,238,239,80,240,241,242,243,244,246,247,248,249,250])),geojson:()=>k(()=>import("./GeoJSONLayerView3D-BV-bwFBB.js"),__vite__mapDeps([321,1,299,5,6,2,232,98,7,8,37,9,20,14,38,39,233,28,19,29,48,13,49,11,12,300,26,3,4,10,15,27,30,31,32,33,34,35,36,40,41,42,43,44,207,70,186,183,88,185,87,182,184,187,188,189,190,191,192,193,194,195,196,197,102,198,199,200,93,201,202,203,92,94,90,95,204,208,209,210,211,293,294,80,301,287,66,51,71,280,281,282,166,180,47,46,22,50,52,53,54,55,56,57,58,59,60,61,62,63,64,65,302,161,18,303,227,73,69,74,75,76,304,236,132,305,306,307,276,114,16,99,277,205,206,178,308,127,176,285,234,100,286,268,84,85,82,288,289,86,68,290,291,292,81,309,103,122,310,311,170,91,96,97,101,245,113,312,313,314,123,126,119,265,179,181,21,23,24,175,129,212,213,214,215,216,217,147,218,219,220,144,221,222,223,224,225,226,228,229,142,83,230,231,235,237,238,239,240,241,242,243,244,246,247,248,249,250])),graphics:()=>k(()=>import("./GraphicsLayerView3D-Bof5vOX7.js"),__vite__mapDeps([322,1,2,170,304,4,5,6,7,8,9,10,201,102,28,19,20,14,202,236,132,11,12,323,26,3,13,15,27,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,63,180,207,70,186,183,88,185,87,182,184,187,188,189,190,191,192,193,194,195,196,197,198,199,200,93,203,92,94,90,95,204,208,209,210,98,211,307,57,276,76,114,232,233,48,49,62,54,55,56,58,52,59,60,61,64,65,69,16,99,277,47,205,206,178,227,18,166,308,281,179,282,21,22,23,24,113,175,129,122,212,213,214,215,216,217,147,218,219,220,144,221,222,223,224,71,161,51,225,226,228,229,142,83,84,85,82,81,230,231,234,100,235,237,238,239,80,240,241,242,243,244,245,246,247,248,249,250])),group:()=>k(()=>import("./GroupLayerView3D-L82ORY4l.js"),__vite__mapDeps([324,1,4,5,6,7,8,2,9,10,179,15,12,180,166,13,14,35,88])),imagery:()=>k(()=>import("./ImageryLayerView3D-DEyYJpE5.js"),__vite__mapDeps([325,1,2,254,47,9,7,8,5,6,20,14,255,180,38,39,182,183,4,10,19,184,185,87,186,88,187,70,188,189,190,191,192,13,193,37,194,195,196,197,102,28,198,199,200,35,11,12,93,201,202,203,92,94,27,90,95,204,207,208,209,26,3,15,29,30,31,32,33,34,36,40,41,42,43,44,210,98,211,256,257,258,170,179,166,181,174,175,326,327,131,132,328,302,245,113,114,16,329,236,227,18,81,82,71,330,48,49,293,294,80,331,51,178,21,22,23,24,205,206,129,122,52,212,76,213,214,215,216,217,147,218,219,220,144,221,222,223,69,224,161,225,226,228,229,142,83,84,85,230,231,232,233,234,99,100,235,237,238,239,240,241,242,243,244,246,247,248,249,250])),"integrated-mesh":()=>k(()=>import("./IntegratedMeshLayerView3D-RFKfjCo7.js"),__vite__mapDeps([332,1,2,269,5,6,13,14,26,3,4,7,8,9,10,11,12,15,27,28,19,20,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,70,189,183,87,88,180,196,270,102,271,187,188,186,182,184,185,190,191,192,193,194,195,197,198,199,200,93,201,202,203,92,94,90,95,204,272,76,22,208,209,273,227,18,264,265,51,48,49,266,166,47,246,274,98,16,50,275,220,144,221,222,57,276,114,63,232,233,207,210,211,62,54,55,56,58,52,59,60,61,64,65,69,99,277,205,206,178,236,132,278,245,113,279,247,237,280,281,282,170,179,21,23,24,175,129,122,212,213,214,215,216,217,147,218,219,223,224,71,161,225,226,228,229,142,83,84,85,82,81,230,231,234,100,235,238,239,80,240,241,242,243,244,248,249,250])),"integrated-mesh-3dtiles":()=>k(()=>import("./IntegratedMesh3DTilesLayerView3D-B-KZEu_V.js"),__vite__mapDeps([333,1,2,19,9,7,8,5,6,20,14,39,189,183,4,10,88,197,70,102,28,270,271,187,188,186,182,184,185,87,190,191,192,13,193,37,38,194,195,196,198,199,200,35,11,12,93,201,202,203,92,94,27,90,95,204,275,220,144,221,22,222,236,132,278,245,113,114,16,170,237,211,274,241,179,15,180,166,29,21,23,24,205,206,175,26,3,30,31,32,33,34,36,40,41,42,43,44,129,207,208,209,210,98,122,52,212,76,213,214,47,18,215,216,217,147,218,219,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,231,232,233,234,99,100,235,238,239,80,240,242,243,244,246,247,248,249,250])),"line-of-sight":()=>k(()=>import("./LineOfSightLayerView3D-UkfuaF7l.js"),__vite__mapDeps([334,5,6,1,170,2,317,47,179,15,7,8,4,9,10,12,180,166,13,14,35,88,182,39,183,19,20,184,185,87,186,187,70,188,189,190,191,192,193,37,38,194,195,196,197,102,28,198,199,200,11,93,201,202,203,92,94,27,90,95,204,29,21,16,22,23,24,113,114,205,206,175,26,3,30,31,32,33,34,36,40,41,42,43,44,129,207,208,209,210,98,211,122,52,212,76,213,214,18,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,132,231,232,233,234,99,100,235,236,237,238,239,80,240,241,242,243,244,245,246,247,248,249,250])),"map-image":()=>k(()=>import("./MapImageLayerView3D-DPKayeyA.js"),__vite__mapDeps([335,1,254,47,2,9,7,8,5,6,20,14,255,180,38,39,182,183,4,10,19,184,185,87,186,88,187,70,188,189,190,191,192,13,193,37,194,195,196,197,102,28,198,199,200,35,11,12,93,201,202,203,92,94,27,90,95,204,207,208,209,26,3,15,29,30,31,32,33,34,36,40,41,42,43,44,210,98,211,256,257,258,170,179,166,181,173,174,175,122,176,177,178,336,293,294,80,21,16,22,23,24,113,114,205,206,129,52,212,76,213,214,18,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,132,231,232,233,234,99,100,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250])),media:()=>k(()=>import("./MediaLayerView3D-BG_piPY2.js").then(s=>s.M),__vite__mapDeps([337,1,338,19,9,7,8,5,6,20,14,183,4,2,10,102,28,339,27,94,170,165,340,186,180,341,87,88,191,188,39,189,342,343,344,345,346,347,47,236,132,11,12,202,201,13,15,51,29,48,49,294,80,187,70,35,348,349,196,350,351,352,182,184,185,190,192,193,37,38,194,195,197,198,199,200,93,203,92,90,95,204,353,256,257,258,179,166,282])),"ogc-feature":()=>k(()=>import("./OGCFeatureLayerView3D-B4UVS6ST.js"),__vite__mapDeps([354,1,299,5,6,2,232,98,7,8,37,9,20,14,38,39,233,28,19,29,48,13,49,11,12,300,26,3,4,10,15,27,30,31,32,33,34,35,36,40,41,42,43,44,207,70,186,183,88,185,87,182,184,187,188,189,190,191,192,193,194,195,196,197,102,198,199,200,93,201,202,203,92,94,90,95,204,208,209,210,211,293,294,80,301,287,66,51,71,280,281,282,166,180,47,46,22,50,52,53,54,55,56,57,58,59,60,61,62,63,64,65,302,161,18,303,227,73,69,74,75,76,304,236,132,305,306,307,276,114,16,99,277,205,206,178,308,127,176,285,234,100,286,268,84,85,82,288,289,86,68,290,291,292,81,309,103,122,310,311,170,91,96,97,101,245,113,312,313,314,123,126,119,265,179,181,21,23,24,175,129,212,213,214,215,216,217,147,218,219,220,144,221,222,223,224,225,226,228,229,142,83,230,231,235,237,238,239,240,241,242,243,244,246,247,248,249,250])),"open-street-map":Ou,"oriented-imagery":()=>k(()=>import("./FeatureLayerView3D-C5u_dk9H.js"),__vite__mapDeps([318,1,102,5,6,10,4,7,8,2,9,28,19,20,14,112,52,15,12,299,232,98,37,38,39,233,29,48,13,49,11,300,26,3,27,30,31,32,33,34,35,36,40,41,42,43,44,207,70,186,183,88,185,87,182,184,187,188,189,190,191,192,193,194,195,196,197,198,199,200,93,201,202,203,92,94,90,95,204,208,209,210,211,293,294,80,301,287,66,51,71,280,281,282,166,180,47,46,22,50,53,54,55,56,57,58,59,60,61,62,63,64,65,302,161,18,303,227,73,69,74,75,76,304,236,132,305,306,307,276,114,16,99,277,205,206,178,308,127,176,285,234,100,286,268,84,85,82,288,289,86,68,290,291,292,81,309,103,122,310,311,170,91,96,97,101,245,113,312,313,314,123,126,119,265,179,181,21,23,24,175,129,212,213,214,215,216,217,147,218,219,220,144,221,222,223,224,225,226,228,229,142,83,230,231,235,237,238,239,240,241,242,243,244,246,247,248,249,250])),"point-cloud":()=>k(()=>import("./PointCloudLayerView3D-CXBwc9mi.js"),__vite__mapDeps([355,1,26,3,4,5,6,7,8,2,9,10,11,12,13,14,15,27,28,19,20,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,47,98,183,210,271,102,187,70,88,188,189,186,202,201,191,87,99,285,92,93,94,90,95,234,100,286,76,268,84,85,82,49,287,66,288,233,289,86,68,69,16,71,290,291,292,81,227,18,48,103,51,236,132,170,245,113,114,295,264,265,266,197,166,194,195,196,192,237,203,211,182,184,185,190,193,198,199,200,204,356,357,64,56,281,358,178,179,180,282,21,22,23,24,205,206,175,129,207,208,209,122,52,212,213,214,215,216,217,147,218,219,220,144,221,222,223,224,161,225,226,228,229,142,83,230,231,232,235,238,239,80,240,241,242,243,244,246,247,248,249,250])),viewshed:()=>k(()=>import("./ViewshedLayerView3D-BRlFgxxF.js"),__vite__mapDeps([359,5,6,1,170,2,317,47,179,15,7,8,4,9,10,12,180,166,13,14,35,88,182,39,183,19,20,184,185,87,186,187,70,188,189,190,191,192,193,37,38,194,195,196,197,102,28,198,199,200,11,93,201,202,203,92,94,27,90,95,204,29,21,16,22,23,24,113,114,205,206,175,26,3,30,31,32,33,34,36,40,41,42,43,44,129,207,208,209,210,98,211,122,52,212,76,213,214,18,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,132,231,232,233,234,99,100,235,236,237,238,239,80,240,241,242,243,244,245,246,247,248,249,250])),voxel:()=>k(()=>import("./VoxelLayerView3D-dwHmXaoj.js"),__vite__mapDeps([360,1,2,183,4,5,6,7,8,9,10,19,20,14,202,28,102,201,37,38,39,170,361,26,3,11,12,13,15,27,29,30,31,32,33,34,35,36,40,41,42,43,44,358,178,179,180,166,88,182,184,185,87,186,187,70,188,189,190,191,192,193,194,195,196,197,198,199,200,93,203,92,94,90,95,204,21,16,22,23,24,113,114,205,206,175,129,207,208,209,210,98,211,122,52,212,76,213,214,47,18,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,132,231,232,233,234,99,100,235,236,237,238,239,80,240,241,242,243,244,245,246,247,248,249,250])),route:()=>k(()=>import("./RouteLayerView3D-CERbBUpB.js"),__vite__mapDeps([362,1,4,5,6,7,8,2,9,10,219,363,26,3,11,12,13,14,15,27,28,19,20,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,364,170,323,63,180,207,70,186,183,88,185,87,182,184,187,188,189,190,191,192,193,194,195,196,197,102,198,199,200,93,201,202,203,92,94,90,95,204,208,209,210,98,211,307,57,276,76,114,232,233,48,49,62,54,55,56,58,52,59,60,61,64,65,69,16,99,277,47,205,206,178,227,18,166,308,281,312,179,282,21,22,23,24,113,175,129,122,212,213,214,215,216,217,147,218,220,144,221,222,223,224,71,161,51,225,226,228,229,142,83,84,85,82,81,230,132,231,234,100,235,236,237,238,239,80,240,241,242,243,244,245,246,247,248,249,250])),scene:s=>s.profile==null||s.profile==="mesh-pyramids"?k(()=>import("./SceneLayerView3D-cWN0jOEX.js"),__vite__mapDeps([365,1,26,3,4,5,6,7,8,2,9,10,11,12,13,14,15,27,28,19,20,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,268,84,85,82,127,51,48,49,176,269,70,189,183,87,88,180,196,270,102,271,187,188,186,182,184,185,190,191,192,193,194,195,197,198,199,200,93,201,202,203,92,94,90,95,204,272,76,22,208,209,273,227,18,264,265,266,166,47,246,274,98,16,50,275,220,144,221,222,57,276,114,63,232,233,207,210,211,62,54,55,56,58,52,59,60,61,64,65,69,99,277,205,206,178,236,132,278,245,113,279,247,237,280,281,282,170,366,284,285,234,100,286,287,66,288,289,86,68,71,290,291,292,81,293,294,80,179,283,103,295,358,21,23,24,175,129,122,212,213,214,215,216,217,147,218,219,223,224,161,225,226,228,229,142,83,230,231,235,238,239,240,241,242,243,244,248,249,250])):k(()=>import("./SceneLayerGraphicsView3D-rV3qst8J.js"),__vite__mapDeps([367,5,6,1,98,2,183,4,7,8,9,10,19,20,14,102,28,202,201,38,39,232,37,233,29,48,13,49,207,70,186,88,185,87,182,184,187,188,189,190,191,192,193,194,195,196,197,198,199,200,35,11,12,93,203,92,94,27,90,95,204,208,209,26,3,15,30,31,32,33,34,36,40,41,42,43,44,210,211,272,180,76,22,271,273,227,18,264,265,51,266,166,47,246,274,16,50,127,276,114,63,62,54,55,56,57,58,52,59,60,61,64,65,69,99,277,205,206,178,245,113,170,305,306,307,308,176,285,234,100,286,268,84,85,82,287,66,288,289,86,68,71,290,291,292,81,309,103,281,366,284,293,294,80,179,280,358,282,21,23,24,175,129,122,212,213,214,215,216,217,147,218,219,220,144,221,222,223,224,161,225,226,228,229,142,83,230,132,231,235,236,237,238,239,240,241,242,243,244,247,248,249,250])),stream:()=>k(()=>import("./StreamLayerView3D-CaVJJs6J.js"),__vite__mapDeps([368,1,2,51,7,8,5,6,13,14,27,9,28,19,20,29,48,49,4,10,15,12,11,300,26,3,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,207,70,186,183,88,185,87,182,184,187,188,189,190,191,192,193,194,195,196,197,102,198,199,200,93,201,202,203,92,94,90,95,204,208,209,210,98,211,293,294,80,301,287,66,71,280,281,282,166,180,47,46,22,50,52,53,54,55,56,57,58,59,60,61,62,63,64,65,302,161,18,232,233,303,227,73,69,74,75,76,304,236,132,305,306,307,276,114,16,99,277,205,206,178,308,127,176,285,234,100,286,268,84,85,82,288,289,86,68,290,291,292,81,309,103,122,310,311,170,369,160,370,91,96,97,101,312,179,21,23,24,113,175,129,212,213,214,215,216,217,147,218,219,220,144,221,222,223,224,225,226,228,229,142,83,230,231,235,237,238,239,240,241,242,243,244,245,246,247,248,249,250])),tile:Ou,"imagery-tile":()=>k(()=>import("./ImageryTileLayerView3D-CoCtGZsw.js"),__vite__mapDeps([371,1,2,331,5,6,7,8,9,19,20,14,102,10,4,28,170,171,166,13,35,88,17,18,326,327,131,11,12,132,328,302,93,255,180,245,113,114,16,182,39,183,184,185,87,186,187,70,188,189,190,191,192,193,37,38,194,195,196,197,198,199,200,201,202,203,92,94,27,90,95,204,329,236,98,227,26,3,15,29,30,31,32,33,34,36,40,41,42,43,44,330,48,49,293,294,80,372,178,179,181,249,21,22,23,24,205,206,175,129,207,208,209,210,211,122,52,212,76,213,214,47,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,225,226,228,229,142,83,84,85,82,81,230,231,232,233,234,99,100,235,237,238,239,240,241,242,243,244,246,247,248,250])),"vector-tile":()=>k(()=>import("./VectorTileLayerView3D-_xj1gB0E.js"),__vite__mapDeps([373,1,2,76,20,14,9,7,8,5,6,228,113,114,10,16,12,374,182,39,183,4,19,184,185,87,186,88,187,70,188,189,190,191,192,13,193,37,38,194,195,196,197,102,28,198,199,200,35,11,93,201,202,203,92,94,27,90,95,204,97,98,375,229,142,83,84,85,82,81,71,230,161,18,226,213,244,231,242,376,243,246,170,171,166,179,15,180,29,21,22,23,24,205,206,175,26,3,30,31,32,33,34,36,40,41,42,43,44,129,207,208,209,210,211,122,52,212,214,47,215,216,217,147,218,219,220,144,221,222,223,69,224,51,48,49,225,227,132,232,233,234,99,100,235,236,237,238,239,80,240,241,245,247,248,249,250])),wcs:()=>k(()=>import("./ImageryTileLayerView3D-CoCtGZsw.js"),__vite__mapDeps([371,1,2,331,5,6,7,8,9,19,20,14,102,10,4,28,170,171,166,13,35,88,17,18,326,327,131,11,12,132,328,302,93,255,180,245,113,114,16,182,39,183,184,185,87,186,187,70,188,189,190,191,192,193,37,38,194,195,196,197,198,199,200,201,202,203,92,94,27,90,95,204,329,236,98,227,26,3,15,29,30,31,32,33,34,36,40,41,42,43,44,330,48,49,293,294,80,372,178,179,181,249,21,22,23,24,205,206,175,129,207,208,209,210,211,122,52,212,76,213,214,47,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,225,226,228,229,142,83,84,85,82,81,230,231,232,233,234,99,100,235,237,238,239,240,241,242,243,244,246,247,248,250])),"web-tile":Ou,wfs:()=>k(()=>import("./WFSLayerView3D-BBVV4n6J.js"),__vite__mapDeps([377,1,299,5,6,2,232,98,7,8,37,9,20,14,38,39,233,28,19,29,48,13,49,11,12,300,26,3,4,10,15,27,30,31,32,33,34,35,36,40,41,42,43,44,207,70,186,183,88,185,87,182,184,187,188,189,190,191,192,193,194,195,196,197,102,198,199,200,93,201,202,203,92,94,90,95,204,208,209,210,211,293,294,80,301,287,66,51,71,280,281,282,166,180,47,46,22,50,52,53,54,55,56,57,58,59,60,61,62,63,64,65,302,161,18,303,227,73,69,74,75,76,304,236,132,305,306,307,276,114,16,99,277,205,206,178,308,127,176,285,234,100,286,268,84,85,82,288,289,86,68,290,291,292,81,309,103,122,310,311,170,91,96,97,101,245,113,312,313,314,123,126,119,265,179,181,21,23,24,175,129,212,213,214,215,216,217,147,218,219,220,144,221,222,223,224,225,226,228,229,142,83,230,231,235,237,238,239,240,241,242,243,244,246,247,248,249,250])),wms:()=>k(()=>import("./WMSLayerView3D-VF5HR2te.js"),__vite__mapDeps([378,1,9,7,8,5,6,254,47,2,20,14,255,180,38,39,182,183,4,10,19,184,185,87,186,88,187,70,188,189,190,191,192,13,193,37,194,195,196,197,102,28,198,199,200,35,11,12,93,201,202,203,92,94,27,90,95,204,207,208,209,26,3,15,29,30,31,32,33,34,36,40,41,42,43,44,210,98,211,256,257,258,170,179,166,181,379,293,294,80,21,16,22,23,24,113,114,205,206,175,129,122,52,212,76,213,214,18,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,132,231,232,233,234,99,100,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250])),wmts:()=>k(()=>import("./WMTSLayerView3D-DxWJ8fb3.js"),__vite__mapDeps([380,1,4,5,6,7,8,2,9,10,52,15,12,170,171,166,13,14,35,88,172,148,109,179,180,181,182,39,183,19,20,184,185,87,186,187,70,188,189,190,191,192,193,37,38,194,195,196,197,102,28,198,199,200,11,93,201,202,203,92,94,27,90,95,204,29,21,16,22,23,24,113,114,205,206,175,26,3,30,31,32,33,34,36,40,41,42,43,44,129,207,208,209,210,98,211,122,212,76,213,214,47,18,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,132,231,232,233,234,99,100,235,236,237,238,239,80,240,241,242,243,244,245,246,247,248,249,250])),"geo-rss":null,kml:null,"knowledge-graph-sublayer":null,"knowledge-graph":null,"link-chart":null,"map-notes":null,parquet:null,"subtype-group":null,unknown:null,unsupported:null,video:null};function kz(s){const e=s.declaredClass?s.declaredClass.slice(s.declaredClass.lastIndexOf(".")+1):"Unknown",t=e.replaceAll(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new me(`${t}:view-not-supported`,`${e} is not supported in 3D`)}const VC={hasLayerViewModule:s=>FC[s.type]!=null,importLayerView:s=>{const e=FC[s.type];if(e==null)throw kz(s);return e(s)}},zz={"area-measurement":()=>k(()=>import("./AreaMeasurementAnalysisView3D-CADHHAAL.js"),__vite__mapDeps([381,1,382,7,8,5,6,4,2,9,10,383,14,19,20,186,183,88,102,28,196,202,201,184,187,70,188,39,189,182,185,87,190,191,192,13,193,37,38,194,195,197,198,199,200,35,11,12,93,203,92,94,27,90,95,204,384,351,352,347,47,236,132,15,51,29,48,49,294,80,342,348,349,385,386,329,207,208,209,26,3,30,31,32,33,34,36,40,41,42,43,44,210,98,211,246,387,257,341,343,344,16,388,389,21,22,23,24,390,258,391,180,392,393,394,395,396,397,398,399,400,401,402,403,303,227,18,345,346,404,113,114,205,206,175,129,122,52,212,76,213,214,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,225,226,228,229,142,83,84,85,82,81,230,166,231,232,233,234,99,100,235,237,238,239,240,241,242,243,244,245,247,248,249,250])),dimension:()=>k(()=>import("./DimensionAnalysisView3D-nWWzqK4B.js"),__vite__mapDeps([405,1,383,2,7,8,5,6,382,4,9,10,14,70,19,20,39,183,188,189,186,88,202,28,102,201,207,185,87,182,184,187,190,191,192,13,193,37,38,194,195,196,197,198,199,200,35,11,12,93,203,92,94,27,90,95,204,208,209,26,3,15,29,30,31,32,33,34,36,40,41,42,43,44,210,98,211,389,347,47,236,132,51,48,49,294,80,342,348,349,386,21,16,22,23,24,390,406,246,385,329,387,257,399,400,341,343,344,180,407,392,393,394,395,396,397,398,408,256,258,391,403,303,227,18,345,346,404,402,401,388,409,353,113,114,205,206,175,129,122,52,212,76,213,214,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,225,226,228,229,142,83,84,85,82,81,230,166,231,232,233,234,99,100,235,237,238,239,240,241,242,243,244,245,247,248,249,250])),"direct-line-measurement":()=>k(()=>import("./DirectLineMeasurementAnalysisView3D-lrBBA8NB.js"),__vite__mapDeps([410,1,382,7,8,5,6,4,2,9,10,383,385,102,28,19,20,14,70,39,183,88,386,329,186,38,182,184,185,87,187,188,189,190,191,192,13,193,37,194,195,196,197,198,199,200,35,11,12,93,201,202,203,92,94,27,90,95,204,207,208,209,26,3,15,29,30,31,32,33,34,36,40,41,42,43,44,210,98,211,236,132,246,387,257,347,47,51,48,49,294,80,342,348,349,16,388,389,21,22,23,24,390,392,393,394,395,396,397,398,391,180,384,399,400,341,343,344,402,403,303,227,18,345,346,113,114,205,206,175,129,122,52,212,76,213,214,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,225,226,228,229,142,83,84,85,82,81,230,166,231,232,233,234,99,100,235,237,238,239,240,241,242,243,244,245,247,248,249,250])),"elevation-profile":()=>k(()=>import("./ElevationProfileAnalysisView3D-H5PntyO2.js"),__vite__mapDeps([411,1,383,2,7,8,5,6,183,4,9,10,19,20,14,187,70,88,188,39,189,186,225,47,102,28,213,182,184,185,87,190,191,192,13,193,37,38,194,195,196,197,198,199,200,35,11,12,93,201,202,203,92,94,27,90,95,204,237,211,236,132,347,15,51,29,48,49,294,80,342,348,349,229,16,142,83,84,85,82,81,71,230,114,161,18,227,412,246,391,413,131,394,386,395,329,414,415,352,416,17,417,418,419,420,421,422,423,424,425,426,427,428,429,165,340,76,382,215,216,217,147,52,218,219,36,22,220,144,221,222,223,69,224,26,3,30,31,32,33,34,40,41,42,43,44,180,430,175,118,109,119,149,431,432,350,351,353,21,23,24,113,205,206,129,207,208,209,210,98,122,212,214,226,228,166,231,232,233,234,99,100,235,238,239,240,241,242,243,244,245,247,248,249,250])),"line-of-sight":()=>k(()=>import("./LineOfSightAnalysisView3D-D0vzpo48.js"),__vite__mapDeps([433,1,4,5,6,7,8,2,9,10,383,434,183,19,20,14,187,70,88,188,39,189,186,237,37,38,203,87,211,47,180,102,28,236,132,11,12,35,182,184,185,190,191,192,13,193,194,195,196,197,198,199,200,93,201,202,92,94,27,90,95,204,385,386,329,207,208,209,26,3,15,29,30,31,32,33,34,36,40,41,42,43,44,210,98,246,387,257,227,18,435,220,144,221,22,222,131,436,395,402,400,341,342,343,344,396,21,16,23,24,113,114,205,206,175,129,122,52,212,76,213,214,215,216,217,147,218,219,223,69,224,71,161,51,48,49,225,226,228,229,142,83,84,85,82,81,230,166,231,232,233,234,99,100,235,238,239,80,240,241,242,243,244,245,247,248,249,250])),slice:()=>k(()=>import("./SliceAnalysisView3D-GtwtywNM.js"),__vite__mapDeps([437,1,383,2,438,13,14,246,87,19,9,7,8,5,6,20,88,70,4,10,39,195,189,183,188,186,439,93,35,102,28,207,185,182,184,187,190,191,192,193,37,38,194,196,197,198,199,200,11,12,201,202,203,92,94,27,90,95,204,208,209,26,3,15,29,30,31,32,33,34,36,40,41,42,43,44,210,98,211,385,386,329,236,132,387,257,258,260,111,107,108,109,110,48,49,112,113,114,16,115,101,103,116,117,118,119,69,120,121,122,22,123,124,125,126,127,51,128,129,130,131,71,46,47,50,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,133,134,135,136,137,138,139,140,141,142,143,77,78,76,79,80,81,82,83,84,85,75,86,144,145,146,147,148,149,150,151,152,153,154,155,156,23,157,158,159,261,262,263,264,265,266,166,178,407,440,256,399,400,341,342,343,344,402,401,391,21,24,205,206,175,212,213,214,180,18,215,216,217,218,219,220,221,222,223,224,161,225,226,227,228,229,230,231,232,233,234,99,100,235,237,238,239,240,241,242,243,244,245,247,248,249,250])),viewshed:()=>k(()=>import("./ViewshedAnalysisView3D-CNKPdnW3.js"),__vite__mapDeps([441,1,434,183,4,5,6,7,8,2,9,10,19,20,14,187,70,88,188,39,189,186,237,37,38,203,87,211,102,28,383,385,386,329,182,184,185,190,191,192,13,193,194,195,196,197,198,199,200,35,11,12,93,201,202,92,94,27,90,95,204,207,208,209,26,3,15,29,30,31,32,33,34,36,40,41,42,43,44,210,98,236,132,246,387,257,399,400,341,342,343,344,442,47,443,412,391,439,393,394,395,402,401,396,21,16,22,23,24,113,114,205,206,175,129,122,52,212,76,213,214,180,18,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,166,231,232,233,234,99,100,235,238,239,80,240,241,242,243,244,245,247,248,249,250])),"volume-measurement":()=>k(()=>import("./VolumeMeasurementAnalysisView3D-YVX7ZBaV.js"),__vite__mapDeps([444,1,7,8,5,6,4,2,9,10,382,383,13,14,35,352,39,183,19,20,180,102,28,197,70,38,247,131,11,12,132,385,88,386,329,186,182,184,185,87,187,188,189,190,191,192,193,37,194,195,196,198,199,200,93,201,202,203,92,94,27,90,95,204,207,208,209,26,3,15,29,30,31,32,33,34,36,40,41,42,43,44,210,98,211,236,246,387,257,445,292,307,57,415,416,166,241,347,47,51,48,49,294,80,342,348,349,16,388,389,21,22,23,24,390,413,394,395,414,391,25,430,175,118,109,119,69,149,438,439,258,399,400,341,343,344,432,446,447,240,72,448,449,431,18,52,215,216,217,147,218,219,220,144,221,222,223,224,350,351,353,346,113,114,205,206,129,122,212,76,213,214,71,161,225,226,227,228,229,142,83,84,85,82,81,230,231,232,233,234,99,100,235,237,238,239,242,243,244,245,248,249,250]))};function Bz(s){const e=zz[s.type];if(!e)throw new me("analysis-view-module-import-utils:analysis-not-supported",`Analysis "${s.type}" is not supported`);return e()}let va=class extends te{constructor(e){super(e),this.collision=new od,this.distance=1/0,this.minimumPoiDistance=4,this.tilt=null}get altitude(){return this.mode===2?null:this._get("altitude")||null}set altitude(e){this.mode!==2?this._set("altitude",e):j.getLogger(this).warn("Altitude constraint is ignored in local scenes")}get mode(){return this.state.viewingMode}clampAltitude(e){return this.altitude?U(e,this.altitude.min,this.altitude.max):e}clampTilt(e,t){if(!this.tilt)return t;const i=this.tilt(e);return U(t,i.min,i.max)}clampDistance(e){return Math.min(e,this.distance)}createDefaultTilt(){return this.mode===2?this._createDefaultTiltLocal():this._createDefaultTiltGlobal()}createConstantMaxTilt(e){return(t,i=Ry)=>(i.min=ki.min,i.max=e,i)}_createDefaultTiltLocal(){const e=this.collision.enabled?Sf([[4e3,ki.max],[1e4,rt(88)],[6e6,rt(88)]]):()=>ki.max;return(t,i=Ry)=>(i.min=ki.min,i.max=e(t),i)}_createDefaultTiltGlobal(){const e=this.collision.enabled?Sf([[4e3,ki.max],[5e4,rt(88)],[6e6,rt(88)],[2e7,ki.min]]):Sf([[3e5,ki.max],[3e6,rt(88)],[6e6,rt(88)],[2e7,ki.min]]);return(t,i=Ry)=>(i.min=ki.min,i.max=e(t),i)}};function Nz(s){return{min:-2e5,max:4*s.radius}}u([p()],va.prototype,"altitude",null),u([p({readOnly:!0})],va.prototype,"collision",void 0),u([p()],va.prototype,"distance",void 0),u([p({readOnly:!0})],va.prototype,"minimumPoiDistance",void 0),u([p()],va.prototype,"tilt",void 0),u([p({constructOnly:!0})],va.prototype,"state",void 0),va=u([R("esri.views.3d.state.Constraints")],va);const kC=Nz(Ei),ki={min:rt(.5),max:rt(179.5)},Ry={min:0,max:0};let od=class extends te{constructor(){super(...arguments),this.enabled=!0,this.elevationMargin=5}};u([p({type:Boolean})],od.prototype,"enabled",void 0),u([p({type:Number})],od.prototype,"elevationMargin",void 0),od=u([R("esri.views.3d.state.Constraints.CollisionConstraint")],od);let Sh=class extends M_{constructor(){super(...arguments),this.min=kC.min,this.max=kC.max}};u([p({type:Number})],Sh.prototype,"min",void 0),u([p({type:Number})],Sh.prototype,"max",void 0),Sh=u([R("esri.views.3d.constraints.AltitudeConstraint")],Sh);let Oa=class extends M_{constructor(){super(...arguments),this.mode="auto"}get near(){return this._get("near")}set near(e){this._set("near",e),e>=this._get("far")&&(this.far=e+1e-9),this.mode="manual"}castNear(e){return Math.max(1e-8,e)}get far(){return this._get("far")}set far(e){this._set("far",e),e<=this._get("near")&&(this.near=e-1e-9),this.mode="manual"}castFar(e){return Math.max(1e-8,e)}autoUpdate(e,t){this.mode==="auto"&&(this._get("near")!==e&&this._set("near",e),this._get("far")!==t&&this._set("far",t))}};u([p({type:Number,value:1e-8})],Oa.prototype,"near",null),u([Ba("near")],Oa.prototype,"castNear",null),u([p({type:Number,value:1e-8})],Oa.prototype,"far",null),u([Ba("far")],Oa.prototype,"castFar",null),u([p({type:["auto","manual"]})],Oa.prototype,"mode",void 0),Oa=u([R("esri.views.3d.constraints.ClipDistanceConstraint")],Oa);const j0={min:ic(ki.min),max:ic(ki.max)};let Ol=class extends M_{constructor(e){super(e),this.mode="auto"}get max(){return this._get("max")}set max(e){this._set("max",e),this.mode="manual"}castMax(e){return U(e,j0.min,j0.max)}autoUpdate(e){this.mode==="auto"&&this._get("max")!==e&&this._set("max",e)}};u([p({type:["auto","manual"]})],Ol.prototype,"mode",void 0),u([p({type:Number,value:j0.max})],Ol.prototype,"max",null),u([Ba("max")],Ol.prototype,"castMax",null),Ol=u([R("esri.views.3d.constraints.TiltConstraint")],Ol);let Dl=class extends M_{constructor(e){super(e),this.tilt=new Ol,this.altitude=new Sh,this.clipDistance=new Oa}};u([p({type:Ol,nonNullable:!0})],Dl.prototype,"tilt",void 0),u([p({type:Sh,nonNullable:!0})],Dl.prototype,"altitude",void 0),u([p({type:Oa,nonNullable:!0})],Dl.prototype,"clipDistance",void 0),Dl=u([R("esri.views.3d.constraints.Constraints")],Dl);function zC(s){return tc(s,HF)||Ow(s)?{wkid:104971}:tc(s,qF)||Dw(s)?{wkid:104903}:Dt.WGS84}let Du=class{constructor(e,t,i,r,n,a,o,l,c=.5){this.coverage=e,this.density=t,this.absorption=i,this.cloudSize=r,this.detailSize=n,this.smoothness=a,this.cloudHeight=o,this.raymarchingSteps=l,this.median=c}};const Vi={sunny:new Du([0,.6],[.03,.03],[0,0],[.9,.9],[.8,.8],[.7,.7],[.05,.05],0),cloudy:new Du([.3,.65],[.2,.4],[0,0],[.85,.85],[.75,.75],[.3,.4],[1,1],2,.6),rainy:new Du([.6,.8],[.5,.8],[.1,.5],[.9,.9],[.75,.75],[.5,.5],[1,1],2,.4),snowy:new Du([.25,.75],[.3,.3],[0,0],[.95,.95],[.7,.7],[.69,.75],[.3,1],1,.65),foggy:new Du([.8,.8],[.5,.5],[0,0],[.95,.95],[.9,.9],[.55,.55],[.3,.3],0)};Vi.default=Vi.sunny;const Or=Ze("esri-mobile")?64:128,Uz=Or/128,an=Math.ceil(Math.sqrt(Or)),Va=(Or+2)*an,Hz=1e5,mm=128,qz=Va/1560;let nu=class extends la{constructor(e,t){super(e,"bool",1,(i,r,n)=>i.setUniform1b(e,t(r,n)))}};function jp(s){s.code.add(y`vec2 sphereIntersect(vec3 start, vec3 dir, float distance) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float d = (b * b) - 4.0 * a * distance;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`)}let c1=class extends Xt{constructor(){super(...arguments),this.cloudRadius=0,this.cloudSize=0,this.detailSize=0,this.absorption=0,this.density=0,this.smoothness=0,this.cloudHeight=0,this.coverage=0,this.lastSlice=!1,this.viewMatrix=Pn()}};const Nh=Ze("esri-mobile")?1024:2048;function fO(s){const e=new lt;e.include(qi,!1);const t=e.fragment;return t.include(jp),t.uniforms.add(new ge("cloudRadius",i=>i.cloudRadius),new ge("power",i=>Me(35,120,i.absorption)),new ge("sigmaE",i=>1+i.absorption),new ge("density",i=>Me(0,.3,i.density)),new ge("cloudSize",i=>Me(0,.02,Math.max(.01,1-i.cloudSize))),new ge("detailSize",i=>Me(0,.2,Math.max(.01,1-i.detailSize))),new ge("smoothness",i=>Me(0,.5,1-i.smoothness)),new ge("cloudHeight",i=>Me(0,1500,i.cloudHeight)),new ge("coverage",i=>i.coverage),new AI("view",i=>i.viewMatrix),new Be("cloudShapeTexture",i=>i.noiseTexture!=null?i.noiseTexture.textureAtlas:null),new Br("cloudVariables",i=>Xi(Gz,i.coverage,i.absorption)),new nu("lastSlice",i=>i.lastSlice)),t.constants.add("halfCubeMapSize","float",.5*Nh),t.code.add(y`
    const int STEPS = ${s.steps===0?y`16`:s.steps===1?y`100`:y`200`};
    const int STEPS_LIGHT = 6;
    const float stepL = 300.0 / float(STEPS_LIGHT);
    const float cloudStart = 1500.0;

    vec3 rayDirection(vec2 fragCoord) {
      vec2 xy = fragCoord;
      xy.x -= halfCubeMapSize;
      xy.y = lastSlice ? fragCoord.y - halfCubeMapSize : fragCoord.y;

      return normalize(vec3(-xy, -halfCubeMapSize));
    }

    float remap(float x, float low1, float high1, float low2, float high2) {
      return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
    }

    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }`),t.code.add(y`
    float getCloudShape(vec3 pos, float pOffset) {
      const float textureWidth = ${y.float(Va)};
      const float dataWidth = ${y.float(Va)};
      const float tileRows = ${y.float(an)};
      const vec3 atlasDimensions = vec3(${y.float(Or)}, ${y.float(Or)}, tileRows * tileRows);

      //Change from Y being height to Z being height
      vec3 p = float(${y.float(Uz)}) * pos.xzy;

      //Pixel coordinates of point in the 3D data
      vec3 coord = vec3(mod(p - pOffset * atlasDimensions, atlasDimensions));
      float f = fract(coord.z);
      float level = floor(coord.z);
      float tileY = floor(level / tileRows);
      float tileX = level - tileY * tileRows;

      //The data coordinates are offset by the x and y tile, the two boundary cells between each tile pair and the initial boundary cell on the first row/column
      vec2 offset = atlasDimensions.x * vec2(tileX, tileY) + 2.0 * vec2(tileX, tileY) + 1.0;
      vec2 pixel = coord.xy + offset;
      vec2 data = texture(cloudShapeTexture, mod(pixel, dataWidth) / textureWidth).xy;

      return 1.0 - mix(data.x, data.y, f);
    }

    float getCloudMap(vec2 p){
      // Shift the texture center to origin to avoid seam artifacts
      vec2 uv = (${y.float(qz)} * p) / ${y.float(Va)} + 0.5;

      return texture(cloudShapeTexture, uv).a;
    }
    `),t.code.add(y`float clouds(vec3 p) {
float cloud = saturate(0.5 * mix(0.0, 1.0, min(2.0 * coverage, 1.0)));
if (cloud <= 0.0) {
return 0.0;
}
float cloudMap = getCloudMap(cloudSize * p.xy);
cloud = mix(cloud, min(2.0 * (coverage), 1.0) * cloudMap, min(2.0 * (1.0 - coverage), 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float shape = getCloudShape(8.0 * cloudSize * p, 0.0);
cloud = saturate(remap(cloud, smoothness * shape, 1.0, 0.0, 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float heightFraction = saturate((length(p) - cloudRadius - cloudStart) / cloudHeight);
cloud *= saturate(remap(heightFraction, 0.0, 0.25, 0.0, 1.0)) * smoothstep(1.0, 0.25, heightFraction);
if (cloud <= 0.0) {
return 0.0;
}
return density * saturate(remap(cloud, 0.35 * smoothness * getCloudShape(detailSize * p, 0.0), 1.0, 0.0, 1.0));
}`),t.code.add(y`float HenyeyGreenstein(float g, float costh) {
return (1.0 / (4.0 * 3.1415))  * ((1.0 - g * g) / pow(1.0 + g * g - 2.0 * g * costh, 1.5));
}
float multipleOctaves(float extinction, float mu, float stepL) {
float attenuation = 1.0;
float contribution = 1.0;
float phaseAttenuation = 1.0;
float luminance = 0.0;
for (int i = 0; i < 4; i++) {
float phase = mix(HenyeyGreenstein(0.0, mu), HenyeyGreenstein(0.3 * phaseAttenuation, mu), 0.7);
luminance += contribution * phase * exp(-stepL * extinction * sigmaE * attenuation);
attenuation *= 0.2;
contribution *= 0.6;
phaseAttenuation *= 0.5;
}
return luminance;
}`),t.code.add(y`float lightRay(vec3 org, vec3 p, float phaseFunction, float mu, vec3 sunDirection) {
float lightRayDensity = clouds(p);
lightRayDensity += clouds(p + sunDirection * 1.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 2.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 3.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 4.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 5.0 * stepL);
float beersLaw = multipleOctaves(lightRayDensity, mu, stepL);
return mix(beersLaw * 2.0 * (1.0 - (exp(-stepL * lightRayDensity * 2.0 * sigmaE ))), beersLaw, 0.5 + 0.5 * mu);
}`),t.code.add(y`float mainRay(vec3 org, vec3 dir, vec3 sunDirection, float distToStart, float totalDistance, out float totalTransmittance) {
if (dir.z < 0.0) {
return 0.0;
}
totalTransmittance = 1.0;
float stepS = totalDistance / float(STEPS);
float cameraHeight = length(org);
float mu = 0.5 + 0.5 * dot(sunDirection, dir);
float phaseFunction = mix(HenyeyGreenstein(-0.3, mu), HenyeyGreenstein(0.3, mu), 0.7);
vec3 p = org + distToStart  * dir;
float dist = distToStart;
float shading = 0.0;
for (int i = 0; i < STEPS; i++) {
float sampleDensity = clouds(p);
float sampleSigmaE = sampleDensity * sigmaE;
if (sampleDensity > 0.0 ) {
float ambient = mix((1.2), (1.6), saturate((length(p) - cloudRadius - cloudStart) / cloudHeight));
float luminance = sampleDensity * (ambient + power * phaseFunction * lightRay(org, p, phaseFunction, mu, sunDirection));
float transmittance = exp(-sampleSigmaE * stepS);
shading += totalTransmittance * (luminance - luminance * transmittance) / sampleSigmaE;
totalTransmittance *= transmittance;
if (totalTransmittance <= 0.001) {
totalTransmittance = 0.0;
break;
}
}
dist += stepS;
p = org + dir * dist;
}
return shading;
}`),t.main.add(y`if (coverage ==  0.0) {
fragColor = vec4(0.0, 1.0, 0.0, 1.0);
return;
}
vec3 rayDir = rayDirection(gl_FragCoord.xy);
rayDir = normalize(view * rayDir);
vec3 viewPos = vec3(0, 0, cloudRadius + 1.0);
float hazeFactor = smoothstep(-0.01, mix(0.0, 0.075, cloudVariables.x), abs(dot(rayDir, vec3(0, 0, 1))));
float totalTransmittance = 1.0;
float shading = 0.0;
float cloudDistance = cloudRadius + cloudStart;
float rayStartDistance = dot(viewPos, viewPos) - (cloudDistance * cloudDistance);
vec2 rayStartIntersect = sphereIntersect(viewPos, rayDir, rayStartDistance);
float rayEndDistance = dot(viewPos, viewPos) - ((cloudDistance + cloudHeight) * (cloudDistance + cloudHeight));
vec2 rayEndIntersect = sphereIntersect(viewPos, rayDir, rayEndDistance);
float distToStart = rayStartIntersect.y;
float totalDistance = rayEndIntersect.y - distToStart;
vec3 sunDirection = normalize(vec3(0, 0, 1));
shading = 0.5 * mainRay(viewPos, rayDir, sunDirection, distToStart, totalDistance, totalTransmittance);
shading = mix(clamp(1.0 - cloudVariables.y, 0.6, 1.0), shading, hazeFactor);
totalTransmittance = mix(0.0, totalTransmittance, hazeFactor);
fragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);`),e}const Gz=ke(),jz=Object.freeze(Object.defineProperty({__proto__:null,CloudsPassParameters:c1,build:fO,cubeMapSize:Nh},Symbol.toStringTag,{value:"Module"}));let Oy=class extends ct{constructor(e,t){super(e,t,new ht(jz,()=>k(()=>Promise.resolve().then(()=>GJ),void 0)),ri)}initializePipeline(e){return qe({blending:vw(32769,32770,32774,e.writeTextureChannels===0?[1,1,0,0]:[0,0,1,1]),depthTest:{func:515},colorWrite:nt})}},W0=class extends ls{constructor(){super(...arguments),this.steps=0,this.writeTextureChannels=0}};u([V({count:3})],W0.prototype,"steps",void 0),u([V({count:2})],W0.prototype,"writeTextureChannels",void 0);let h1=class extends Xt{constructor(){super(...arguments),this.weatherTile=_u(0,0)}};function gO(s){const e=new lt;return e.include(qi,!1),e.fragment.code.add(y`float remap(float x, float low1, float high1, float low2, float high2) {
return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
}`),s.mode===0&&(e.fragment.code.add(y`float saturate(float x) {
return clamp(x, 0.0, 1.0);
}`),e.fragment.code.add(y`vec3 modulo(vec3 m, float n) {
return mod(mod(m, n) + n, n);
}
vec3 hash(vec3 p3, float frequency) {
p3 = modulo(p3, frequency);
p3 = fract(p3 * vec3(0.1031, 0.1030, 0.0973));
p3 += dot(p3, p3.yxz + 33.33);
return -1.0 + 2.0 * fract((p3.xxy + p3.yxx) * p3.zyx);
}`),e.fragment.code.add(y`vec3 fade(vec3 t) {
return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
}`),e.fragment.code.add(y`
    float gradientNoise(vec3 p, float frequency) {
      vec3 i = floor(p);
      vec3 f = fract(p);
      vec3 u = fade(f);
      return mix( mix( mix( dot( hash( i + vec3(0.0,0.0,0.0), frequency), f - vec3(0.0,0.0,0.0) ),
                            dot( hash( i + vec3(1.0,0.0,0.0), frequency), f - vec3(1.0,0.0,0.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,0.0), frequency), f - vec3(0.0,1.0,0.0) ),
                            dot( hash( i + vec3(1.0,1.0,0.0), frequency), f - vec3(1.0,1.0,0.0) ), u.x), u.y),
                  mix( mix( dot( hash( i + vec3(0.0,0.0,1.0), frequency), f - vec3(0.0,0.0,1.0) ),
                            dot( hash( i + vec3(1.0,0.0,1.0), frequency), f - vec3(1.0,0.0,1.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,1.0), frequency), f - vec3(0.0,1.0,1.0) ),
                            dot( hash( i + vec3(1.0,1.0,1.0), frequency), f - vec3(1.0,1.0,1.0) ), u.x), u.y), u.z );
    }

    float getPerlinNoise(vec3 pos, float frequency) {
      float octaveFrequency = 2.0;
      float sum = 0.0;
      float weightSum = 0.0;
      float weight = 1.0;

      for (int oct = 0; oct < 3; oct++) {
        vec3 p = pos * frequency;
        float val = 0.5 + 0.5 * gradientNoise(p, frequency);
        sum += val * weight;
        weightSum += weight;
        weight *= 0.5;
        frequency *= octaveFrequency;
      }

      float noise = (sum / weightSum);
      noise = saturate(noise);
      return noise;
    }

    float worley(vec3 pos, float numCells) {
      vec3 p = pos * numCells;
      float d = 1.0e10;

      for (int x = -1; x <= 1; x++) {
        for (int y = -1; y <= 1; y++) {
          for (int z = -1; z <= 1; z++) {
            vec3 tp = floor(p) + vec3(x, y, z);
            tp = p - tp - (hash(tp, numCells) * 0.5 + 0.5);
            d = min(d, dot(tp, tp));
          }
        }
      }

      return 1.0 - clamp(d, 0.0, 1.0);
    }

    vec3 get3Dfrom2D(vec2 uv) {
      vec2 tile = floor(uv);
      float z = floor(${y.float(an)} * tile.y + tile.x);
      return vec3(fract(uv), z);
    }

    float getTextureForPointPerlinWorley(vec3 p) {
      float perlinNoise = getPerlinNoise(p, ${y.float(8)});

      float worley0 = worley(p, ${y.float(2)} * 2.0);
      float worley1 = worley(p, ${y.float(2)} * 8.0);
      float worley2 = worley(p, ${y.float(2)} * 14.0);

      float worleyFBM = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      return remap(perlinNoise, 0.0, 1.0, worleyFBM, 1.0);
    }

    float getTextureForPointWorley(vec3 p) {
      float worley0 = worley(p, ${y.float(2)});
      float worley1 = worley(p, ${y.float(2)} * 2.0);
      float worley2 = worley(p, ${y.float(2)} * 4.0);
      float worley3 = worley(p, ${y.float(2)} * 8.0);

      float FBM0 = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      float FBM1 = worley1 * 0.625 + worley2 * 0.25 + worley3 * 0.125;
      float FBM2 = worley2 * 0.75 + worley3 * 0.25;

      return FBM0 * 0.625 + FBM1 * 0.25 + FBM2 * 0.125;
    }
  `)),e.fragment.uniforms.add(new Br("weatherTile",t=>t.weatherTile)).code.add(y`
    vec2 modulo(vec2 m, float n){
      return mod(mod(m, n) + n, n);
    }

    vec2 hash(vec2 p){
      // Get position of p in weather tile
      p = modulo(p, ${y.float(mm)});

      // Get global coordinates of p
      p += weatherTile * ${y.float(mm)};

      // Limit position to avoid numerical instability
      p = modulo(p, ${y.float(Hz)});

      vec3 p3 = fract(vec3(p.xyx) * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yzx + 33.33);
      return 2.0 * fract((p3.xx + p3.yz) * p3.zy) - 1.0;
    }

    vec2 fade(vec2 t){
      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
    }

    float gradientNoise(vec2 p){
      vec2 i = floor( p );
      vec2 f = fract( p );

      vec2 u = fade(f);

      // Bilinear interpolation of gradients at cell vertices around point
      return  mix(
                mix(dot( hash( i + vec2(0.0,0.0) ), f - vec2(0.0,0.0) ),
                    dot( hash( i + vec2(1.0,0.0) ), f - vec2(1.0,0.0) ), u.x),
                mix(dot( hash( i + vec2(0.0,1.0) ), f - vec2(0.0,1.0) ),
                    dot( hash( i + vec2(1.0,1.0) ), f - vec2(1.0,1.0) ), u.x),
                u.y);
    }

    float worley(vec2 p){
      float d = 1.0e10;
      for (int x = -1; x <= 1; x++){
        for (int y = -1; y <= 1; y++){
                vec2 tp = floor(p) + vec2(x, y);
                tp = p - tp - (0.5 + 0.5 * hash(tp));
                d = min(d, dot(tp, tp));
            }
        }
      return 1.0 - clamp(d, 0.0, 1.0);
    }
  `),s.mode===0?e.fragment.main.add(y`
      float padWidth = 1.0;
      float paddedSize = ${y.float(Or)} + 2.0 * padWidth;
      float tileCount = ${y.float(an)} * ${y.float(an)};
      vec2 tile = floor((gl_FragCoord.xy - 0.5) / paddedSize);

      bool padCell = false;
      if (mod(gl_FragCoord.x, paddedSize) == 0.5 || mod(gl_FragCoord.x, paddedSize) == paddedSize - 0.5) {
        padCell = true;
      }

      if (mod(gl_FragCoord.y, paddedSize) == 0.5 || mod(gl_FragCoord.y, paddedSize) == paddedSize - 0.5) {
        padCell = true;
      }

      bool startPadX = false;
      bool startPadY = false;
      bool endPadX = false;
      bool endPadY = false;

      if (gl_FragCoord.x == tile.x * paddedSize + 0.5) {
        startPadX = true;
      }

      if (gl_FragCoord.y == tile.y * paddedSize + 0.5) {
        startPadY = true;
      }

      if (gl_FragCoord.x == (tile.x + 1.0) * paddedSize - 0.5) {
        endPadX = true;
      }

      if (gl_FragCoord.y == (tile.y + 1.0) * paddedSize - 0.5) {
        endPadY = true;
      }

      vec2 padding = vec2(2.0 * padWidth) * tile;
      vec2 uv;

      if (padCell) {
        vec2 pixel = gl_FragCoord.xy - padWidth - padding;

        if (startPadX) {
          pixel.x += ${y.float(Or)};
        }

        if (startPadY) {
          pixel.y += ${y.float(Or)};
        }

        if (endPadX) {
          pixel.x -= ${y.float(Or)};
        }

        if (endPadY) {
          pixel.y -= ${y.float(Or)};
        }

        uv = vec2(pixel.xy / ${y.float(Or)});
      } else {
        vec2 pixel = gl_FragCoord.xy - padWidth - padding;
        uv = vec2(pixel.xy / ${y.float(Or)});
      }

      vec3 p_ = get3Dfrom2D(uv);
      vec3 p = p_;
      p.z /= (${y.float(an)} * ${y.float(an)});

      float worleyPerlinNoise = getTextureForPointPerlinWorley(p);
      float worleyNoise = getTextureForPointWorley(p);

      fragColor.r = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));

      p_ = mod(p_ + 1.0, ${y.float(an)} * ${y.float(an)});
      p = p_;
      p.z /= (${y.float(an)} * ${y.float(an)});

      worleyPerlinNoise = getTextureForPointPerlinWorley(p);
      worleyNoise = getTextureForPointWorley(p);

      fragColor.g = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));

      vec2 mapUV = ${y.float(mm)} * (gl_FragCoord.xy / ${y.float(Va)});
      float map = abs(gradientNoise(mapUV));
      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);
      fragColor.ba = vec2(0.0, map);
      `):e.fragment.main.add(y`
      vec2 mapUV = ${y.float(mm)} * (gl_FragCoord.xy / ${y.float(Va)});
      float map = abs(gradientNoise(mapUV));
      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);
      fragColor = vec4(map);
    `),e}const Wz=Object.freeze(Object.defineProperty({__proto__:null,NoiseTextureAtlasPassParameters:h1,build:gO},Symbol.toStringTag,{value:"Module"}));let Lf=class extends ls{constructor(){super(...arguments),this.mode=0}};u([V({count:2})],Lf.prototype,"mode",void 0);let Dy=class extends ct{constructor(e,t){super(e,t,new ht(Wz,()=>k(()=>Promise.resolve().then(()=>jJ),void 0)),ri)}initializePipeline(e){return qe({blending:e.mode===0?bw:du(0,1,1,0),depthTest:{func:519},colorWrite:nt})}},Qz=class{constructor(e,t=0,i=t,r=!1,n=1){this.internalFormat=e,this.width=t,this.height=i,this.multisampled=r,this.samples=n}};function Zz(s){return s.width<=0||s.height<=0||s.internalFormat==null?0:s.width*s.height*II(s.internalFormat)}const Xz=!!Ze("esri-tests-disable-gpu-memory-measurements");let _O=class{constructor(e,t){this._context=e,this._descriptor=t,this.type=2,this._context.instanceCounter.increment(gi.Renderbuffer,this);const i=this._context.gl;this.glName=i.createRenderbuffer(),this._context.bindRenderbuffer(this);const{width:r,height:n,internalFormat:a,multisampled:o}=t;o?i.renderbufferStorageMultisample(i.RENDERBUFFER,this.samples,a,r,n):i.renderbufferStorage(i.RENDERBUFFER,a,r,n),this._context.bindRenderbuffer(null)}get descriptor(){return this._descriptor}get samples(){const e=this._descriptor.samples,t=this._context.parameters.maxSamples;return e?Math.min(e,t):t}get usedMemory(){return Xz?0:Zz(this._descriptor)}resize(e,t){const i=this._descriptor;if(i.width===e&&i.height===t)return;i.width=e,i.height=t;const r=this._context.gl;this._context.bindRenderbuffer(this),i.multisampled?r.renderbufferStorageMultisample(r.RENDERBUFFER,this.samples,i.internalFormat,i.width,i.height):r.renderbufferStorage(r.RENDERBUFFER,i.internalFormat,i.width,i.height),this._context.bindRenderbuffer(null)}dispose(){this._context&&(this._context.gl.deleteRenderbuffer(this.glName),this._context.instanceCounter.decrement(gi.Renderbuffer,this),this._context=null)}};const Yz=()=>j.getLogger("esri.views.webgl.FramebufferObject");let jo=class ld{constructor(e,t,i){if(this._context=e,this._glName=null,this._colorAttachments=new Map,this._depthStencilBuffer=null,this._depthStencilTexture=null,this._initialized=!1,e.instanceCounter.increment(gi.FramebufferObject,this),t!=null){const r=eB(e,t);r!=null&&(this._colorAttachments.set(Ot,r),bo(r)?this._validateTextureDescriptor(r.descriptor):this._validateRenderbufferDescriptor(r.descriptor)),this._validateColorAttachmentPoint(Ot)}if(i!=null)if(Kz(i))this._depthStencilTexture=bo(i)?i:new bt(e,i),this._validateTextureDescriptor(this._depthStencilTexture.descriptor);else{const r=Q0(i)?i:new _O(e,i);this._depthStencilBuffer=r,this._validateRenderbufferDescriptor(r.descriptor)}}dispose(){const{_colorAttachments:e,_glName:t}=this;if(e.size===0&&!this._depthStencilBuffer&&!this._depthStencilTexture&&!t)return;const{_context:i}=this,r=i.getBoundFramebufferObject();e.forEach((n,a)=>this.detachColorTexture(a)?.dispose()),this.detachDepthStencilBuffer()?.dispose(),this.detachDepthStencilTexture()?.dispose(),i.gl.deleteFramebuffer(t),this._glName=null,i.bindFramebuffer(r===this?null:r),i.instanceCounter.decrement(gi.FramebufferObject,this)}get glName(){return this._glName}get colorTexture(){const e=this._colorAttachments.get(Ot);return bo(e)?e:null}get depthStencil(){return this._depthStencilTexture||this._depthStencilBuffer}get depthStencilTexture(){return this._depthStencilTexture}get width(){return(this._colorAttachments.get(Ot)??this._depthStencilTexture??this._depthStencilBuffer)?.descriptor?.width??0}get height(){return(this._colorAttachments.get(Ot)??this._depthStencilTexture??this._depthStencilBuffer)?.descriptor?.height??0}get usedMemory(){return[...this._colorAttachments].reduce((e,[t,i])=>e+i.usedMemory,this.depthStencil?.usedMemory??0)}static{this._MAX_COLOR_ATTACHMENTS=-1}getColorTexture(e){const t=this._colorAttachments.get(e);return t&&bo(t)?t:null}get colorAttachments(){return[...this._colorAttachments.keys()]}attachColorTexture(e,t=Ot){if(!e)return;this._validateColorAttachmentPoint(t);const{descriptor:i}=e;this._validateTextureDescriptor(i),this.detachColorTexture(t)?.dispose(),this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(e.glName,t)),this._colorAttachments.set(t,e)}detachColorTexture(e=Ot){const t=this._colorAttachments.get(e);if(!t)return;const i=bo(t);return this._initialized&&this._context.temporaryBindFramebufferObject(this,()=>{if(i)this._framebufferTexture2D(null,e);else{const r=this._context.gl;r.framebufferRenderbuffer(r.FRAMEBUFFER,e,r.RENDERBUFFER,null)}}),this._colorAttachments.delete(e),i?t:void 0}setColorTextureTarget(e,t=Ot,i=0){const r=this._colorAttachments.get(t);r&&(e===35866?this._framebufferTextureLayer(r.glName,t,36160,0,i):this._framebufferTexture2D(r.glName,t,e,36160,0))}attachDepthStencil(e){if(e)switch(e.type){case 1:return this._attachDepthStencilTexture(e);case 2:return this._attachDepthStencilBuffer(e)}}_attachDepthStencilTexture(e){if(e==null)return;const{descriptor:t}=e,{pixelFormat:i,dataType:r}=t;i===34041||i===6402?i!==34041||r===si.UNSIGNED_INT_24_8?i!==6402||r===si.UNSIGNED_INT||r===si.UNSIGNED_SHORT?(this._validateTextureDescriptor(t),this._disposeDepthStencilAttachments(),this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(e.glName,fm(i))),this._depthStencilTexture?.dispose(),this._depthStencilTexture=e):console.error("Depth texture must have data type of UNSIGNED_INT or UNSIGNED_SHORT!"):console.error("Depth/Stencil texture must have data type of UNSIGNED_INT_24_8!"):console.error("Depth/Stencil texture must have a pixel type of DEPTH_STENCIL!")}detachDepthStencilTexture(){const e=this._depthStencilTexture;return e&&this._initialized&&this._context.temporaryBindFramebufferObject(this,()=>{this._framebufferTexture2D(null,fm(e.descriptor.pixelFormat))}),this._depthStencilTexture=null,e}_attachDepthStencilBuffer(e){if(e==null)return;const t=e.descriptor;if(this._validateRenderbufferDescriptor(t),this._disposeDepthStencilAttachments(),this._initialized){this._context.bindFramebuffer(this);const{gl:i}=this._context,r=this._getGLAttachmentPoint(t);i.framebufferRenderbuffer(36160,r,i.RENDERBUFFER,e.glName)}this._depthStencilBuffer=e}detachDepthStencilBuffer(){const e=this._depthStencilBuffer;if(e&&this._initialized){const{_context:t}=this,i=t.getBoundFramebufferObject();t.bindFramebuffer(this);const{gl:r}=t,n=this._getGLAttachmentPoint(e.descriptor);r.framebufferRenderbuffer(36160,n,r.RENDERBUFFER,null),t.bindFramebuffer(i)}return this._depthStencilBuffer=null,e}invalidateAttachments(e){const{_context:t}=this;t.temporaryBindFramebufferObject(this,()=>t.gl.invalidateFramebuffer(36160,e),!0)}copyToTexture(e,t,i,r,n,a,o){(e<0||t<0||n<0||a<0)&&console.error("Offsets cannot be negative!"),(i<=0||r<=0)&&console.error("Copy width and height must be greater than zero!");const l=o.descriptor;o.descriptor.target!==3553&&console.error("Texture target must be TEXTURE_2D!"),(l?.width==null||l?.height==null||e+i>this.width||t+r>this.height||n+i>l.width||a+r>l.height)&&console.error("Bad dimensions, the current input values will attempt to read or copy out of bounds!");const c=this._context,h=c.bindTexture(o,bt.TEXTURE_UNIT_FOR_UPDATES);c.setActiveTexture(bt.TEXTURE_UNIT_FOR_UPDATES),c.bindFramebuffer(this),c.gl.copyTexSubImage2D(3553,0,n,a,e,t,i,r),c.bindTexture(h,bt.TEXTURE_UNIT_FOR_UPDATES)}readPixels(e,t,i,r,n,a,o){(i<=0||r<=0)&&console.error("Copy width and height must be greater than zero!"),o||console.error("Target memory is not initialized!"),this._context.bindFramebuffer(this),this._context.gl.readPixels(e,t,i,r,n,a,o)}async readPixelsAsync(e,t,i,r,n,a,o){const{gl:l}=this._context,c=Nr.createPixelPack(this._context,35041,o.byteLength);this._context.bindBuffer(c);const h=this._context.getBoundFramebufferObject();this._context.bindFramebuffer(this),l.readPixels(e,t,i,r,n,a,0),this._context.unbindBuffer(35051),this._context.bindFramebuffer(h),await c.getSubDataAsync(o),c.dispose()}resize(e,t){if(this.width===e&&this.height===t)return;const i={width:e,height:t};if(Vl(i,this._context.parameters.maxTextureSize),this._colorAttachments.forEach(r=>r.resize(i.width,i.height)),this._depthStencilTexture?.resize(i.width,i.height),this._initialized&&(Vl(i,this._context.parameters.maxRenderbufferSize),this._depthStencilBuffer?.resize(i.width,i.height),ln())){const{gl:r}=this._context;r.checkFramebufferStatus(36160)!==r.FRAMEBUFFER_COMPLETE&&console.error("Framebuffer is incomplete!")}}initializeAndBind(e=36160){const{gl:t}=this._context;if(this._initialized)return void t.bindFramebuffer(e,this.glName);this._glName&&t.deleteFramebuffer(this._glName);const i=t.createFramebuffer();if(t.bindFramebuffer(e,i),this._colorAttachments.forEach((r,n)=>{if(bo(r)){const a=BC(r);a===35866?this._framebufferTextureLayer(r.glName,n,e,0,0):this._framebufferTexture2D(r.glName,n,a,e)}else if(Q0(r)){const a=this._context.gl;a.framebufferRenderbuffer(e,n,a.RENDERBUFFER,r.glName)}}),this._depthStencilBuffer){const r=this._getGLAttachmentPoint(this._depthStencilBuffer.descriptor);t.framebufferRenderbuffer(e,r,t.RENDERBUFFER,this._depthStencilBuffer.glName)}else if(this._depthStencilTexture){const r=fm(this._depthStencilTexture.descriptor.pixelFormat);this._framebufferTexture2D(this._depthStencilTexture.glName,r,BC(this._depthStencilTexture),e)}ln()&&t.checkFramebufferStatus(e)!==t.FRAMEBUFFER_COMPLETE&&console.error("Framebuffer is incomplete!"),this._glName=i,this._initialized=!0}_framebufferTexture2D(e,t=Ot,i=3553,r=36160,n=0){this._context.gl.framebufferTexture2D(r,t,i,e,n)}_framebufferTextureLayer(e,t=Ot,i=36160,r=0,n=0){this._context.gl.framebufferTextureLayer(i,t,e,r,n)}_disposeDepthStencilAttachments(){const e=this._context.gl;if(this._depthStencilBuffer){if(this._initialized){this._context.bindFramebuffer(this);const t=this._getGLAttachmentPoint(this._depthStencilBuffer.descriptor);e.framebufferRenderbuffer(36160,t,e.RENDERBUFFER,null)}this._depthStencilBuffer=_e(this._depthStencilBuffer)}this._depthStencilTexture&&(this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(null,fm(this._depthStencilTexture.descriptor.pixelFormat))),this._depthStencilTexture=_e(this._depthStencilTexture))}_validateTextureDescriptor(e){e.target!==3553&&e.target!==34067&&e.target!==35866&&console.error("Texture type must be TEXTURE_2D, TEXTURE_2D_ARRAY or TEXTURE_CUBE_MAP!"),Vl(e,this._context.parameters.maxTextureSize),this._validateBufferDimensions(e)}_validateRenderbufferDescriptor(e){Vl(e,this._context.parameters.maxRenderbufferSize),this._validateBufferDimensions(e)}_validateBufferDimensions(e){e.width<=0&&(e.width=this.width),e.height<=0&&(e.height=this.height),this.width>0&&this.height>0&&(this.width===e.width&&this.height===e.height||console.error("Attachment size must match framebuffer size!"))}_getGLAttachmentPoint(e){switch(e.internalFormat){case Gl.DEPTH_COMPONENT16:case Gl.DEPTH_COMPONENT24:case Gl.DEPTH_COMPONENT32F:return tR;case tu.DEPTH24_STENCIL8:case tu.DEPTH32F_STENCIL8:return Ui;case 36168:return aV;default:return Ot}}_validateColorAttachmentPoint(e){if(ld._MAX_COLOR_ATTACHMENTS===-1){const{gl:i}=this._context;ld._MAX_COLOR_ATTACHMENTS=i.getParameter(i.MAX_COLOR_ATTACHMENTS)}const t=e-Ot;t+1>ld._MAX_COLOR_ATTACHMENTS&&j.getLogger("esri.views.webgl.FrameBufferObject").error("esri.FrameBufferObject",`illegal attachment point for color attachment: ${t+1}. Implementation supports up to ${ld._MAX_COLOR_ATTACHMENTS} color attachments`)}};function bo(s){return V_(s)===1}function Q0(s){return V_(s)===2}function Kz(s){return bo(s)||yO(s)}function yO(s){return V_(s)===0}function Jz(s){return V_(s)===3||s!=null&&"samples"in s}function V_(s){return s!=null&&"type"in s?s.type:null}function eB(s,e){return bo(e)||Q0(e)?e:yO(e)?new bt(s,e):Jz(e)?new _O(s,e):null}function Vl(s,e){const t=Math.max(s.width,s.height);if(t>e){Yz().warnOnce(`Resizing FBO attachment size ${s.width}x${s.height} to device limit ${e}`);const i=e/t;return s.width=Math.round(s.width*i),s.height=Math.round(s.height*i),!1}return!0}function BC(s){return s.descriptor.target===34067?34069:s.descriptor.target===35866?35866:3553}function fm(s){return s===6402?tR:Ui}let Ff=class extends te{constructor(e){super(e),this._needsRender=!0,this._passParameters=new h1,this._configuration=new Lf,this._fbo=new jo(e.context.renderContext.rctx,new ft(Va)),e.context.techniques.precompile(Dy,new Lf);const t=new Lf;t.mode=1,e.context.techniques.precompile(Dy,t)}get textureAtlas(){if(this._texture&&!this._needsRender)return this._texture;this._configuration.mode=this._texture?1:0;const e=this.context.techniques.get(Dy,this._configuration);return e.compiled&&(this._texture=this._render(e)),this._texture}updateWeatherMap(e){j$(this._passParameters.weatherTile,e)||(pr(this._passParameters.weatherTile,e),this._needsRender=!0)}destroy(){this._fbo=_e(this._fbo)}_render(e){if(!this._fbo)return null;const t=this.context.renderContext.rctx,i=t.getViewport();return t.setViewport(0,0,Va,Va),t.bindFramebuffer(this._fbo),t.bindTechnique(e,this.context.renderContext.bind,this._passParameters),t.screen.draw(),t.setViewport(i.x,i.y,i.width,i.height),this._needsRender=!1,this._fbo.colorTexture}};u([p({constructOnly:!0})],Ff.prototype,"context",void 0),Ff=u([R("esri.views.3d.environment.NoiseTextureAtlas")],Ff);let vs=class extends te{constructor(e){super(e),this._state=rs(0),this._passParameters=new c1,this._weatherTileCount=128,this._sliceIndex=0,this._tileIndex=0,this._tilesPerSlice=1,this.coverage=Me(Vi.default.coverage[0],Vi.default.coverage[1],.5),this.density=Me(Vi.default.density[0],Vi.default.density[1],.5),this.absorption=Me(Vi.default.absorption[0],Vi.default.absorption[1],.5),this.cloudSize=Me(Vi.default.cloudSize[0],Vi.default.cloudSize[1],.5),this.detailSize=Me(Vi.default.detailSize[0],Vi.default.detailSize[1],.5),this.smoothness=Me(Vi.default.smoothness[0],Vi.default.smoothness[1],.5),this.cloudHeight=Me(Vi.default.cloudHeight[0],Vi.default.cloudHeight[1],.5),this.raymarchingSteps=Vi.default.raymarchingSteps,this._viewMatrix=Ie(),this._dirty=!0,this.readyToRun=!0,this._configuration=new W0}initialize(){const e=Zt(this.view.spatialReference);this._passParameters.cloudRadius=.5*e.radius;const t=()=>this.setDirty();this.addHandles([this.view.resourceController.scheduler.registerTask(di.CLOUDS_GENERATOR,this),$(()=>this.coverage,t,Re),$(()=>this.density,t,Re),$(()=>this.absorption,t,Re),$(()=>this.cloudSize,t,Re),$(()=>this.detailSize,t,Re),$(()=>this.smoothness,t,Re),$(()=>this.cloudHeight,t,Re),$(()=>this.raymarchingSteps,t,Re)]);const i=sV(this._computeWeatherTile());let r=0;this.addHandles($(()=>{const n=this._computeWeatherTile();return j$(i,n)||(++r,pr(i,n)),r},t))}destroy(){this.destroyCubeMap(),this._passParameters.noiseTexture=Q(this._passParameters.noiseTexture)}_precompile(){this._configuration.steps=this.raymarchingSteps,this._configuration.writeTextureChannels=0,this.context.techniques.precompile(Oy,this._configuration),this._configuration.writeTextureChannels=1,this.context.techniques.precompile(Oy,this._configuration)}_acquireTechnique(){switch(this.raymarchingSteps){case 0:this._tilesPerSlice=1;break;case 1:this._tilesPerSlice=4;break;case 3:case 2:this._tilesPerSlice=8;break;default:ra(this.raymarchingSteps)}return this._configuration.writeTextureChannels=1-this.parameters.readChannels,this._configuration.steps=this.raymarchingSteps,this.context.techniques.get(Oy,this._configuration)}_computeWeatherTile(){const{camera:e,environment:t}=this.view,{latitude:i,longitude:r}=e.position;if(i==null||r==null)return pp;Xi(Qr,(i+90)/180,(r+180)/360);const n=Math.floor(this._weatherTileCount*Math.abs(2*Qr[0]-1));Qr[0]=Math.floor(2*this._weatherTileCount*Qr[0]),Qr[1]=Math.floor(4*(this._weatherTileCount-n)*Qr[1]);let a=0,o=0;if(t?.lighting?.type!=="virtual"&&t?.lighting?.date!=null){const l=new Date(t.lighting.date);l.setUTCHours(t.lighting.date.getUTCHours()+(t.lighting.displayUTCOffset??0)),a=31*l.getUTCMonth()+l.getUTCDate(),o=l.getUTCFullYear()}return Qr[0]=(Qr[0]+a)%(2*this._weatherTileCount),Qr[1]=(Qr[1]+o%100)%(4*this._weatherTileCount),Qr}get state(){return this._state.value}set state(e){this._state.value=e}get usedMemory(){return(this._fbo?.usedMemory??0)+(this._passParameters.noiseTexture?.textureAtlas?.usedMemory??0)}_ensureNoiseTexture(){return this._passParameters.noiseTexture??=new Ff({context:this.context}),this._passParameters.noiseTexture}_ensureFrameBufferCube(e){const t=this.context.renderContext.rctx;if(this._fbo==null){const i=new ft(e,e/2);i.target=35866,i.depth=6,i.wrapMode=33071,this._fbo=new jo(t,i),this.parameters.data=this,this.parameters.absorption=this.absorption,this.parameters.coverage=this.coverage}return t.unbindTexture(this._fbo.colorTexture),this._fbo}get cubeMap(){return this._fbo}get parameters(){return this.context.renderContext.bind.clouds}destroyCubeMap(){this._fbo=_e(this._fbo),this.parameters.data=null}applyPreset(e,t){const i=e.median,r=n=>{const a=Me(n[0],n[1],i);return t<.5?Me(n[0],a,2*t):Me(a,n[1],2*(t-.5))};this.coverage=r(e.coverage),this.density=r(e.density),this.absorption=r(e.absorption),this.cloudSize=r(e.cloudSize),this.detailSize=r(e.detailSize),this.smoothness=r(e.smoothness),this.cloudHeight=r(e.cloudHeight),this.raymarchingSteps=e.raymarchingSteps,this._precompile()}setDirty(){this._dirty=this.readyToRun=!0}runTask(e){if(this.state===3)return Ai;this._dirty&&(this._sliceIndex=this._tileIndex=0,this.state=1,this._passParameters.absorption=this.absorption,this._passParameters.density=this.density,this._passParameters.cloudSize=this.cloudSize,this._passParameters.detailSize=this.detailSize,this._passParameters.smoothness=this.smoothness,this._passParameters.cloudHeight=this.cloudHeight,this._passParameters.coverage=this.coverage,this._ensureNoiseTexture().updateWeatherMap(this._computeWeatherTile()),this._dirty=!1);const t=this._acquireTechnique();if(!this._ensureNoiseTexture().textureAtlas||!t.compiled)return Ai;const i=tB[this._sliceIndex],r=iB[this._sliceIndex];X5(this._viewMatrix,sB,i,r),Bw(this._passParameters.viewMatrix,this._viewMatrix);const n=this.context.renderContext.rctx,a=n.getViewport(),o=Nh/this._tilesPerSlice,l=this._tileIndex*o;n.setViewport(0,l,Nh,o);const c=this._ensureFrameBufferCube(Nh);return n.bindFramebuffer(c),this._passParameters.lastSlice=this._sliceIndex===5,n.bindTechnique(t,this.context.renderContext.bind,this._passParameters),c.setColorTextureTarget(35866,Ot,this._sliceIndex),n.screen.draw(),n.gl.flush(),n.setViewport(a.x,a.y,a.width,a.height),this.requestRender(),++this._tileIndex,this._sliceIndex===5&&this._tileIndex===this._tilesPerSlice?(this._sliceIndex=this._tileIndex=0,this.state=2,this.readyToRun=!1):this._tileIndex===this._tilesPerSlice&&(++this._sliceIndex,this._tileIndex=0),e.madeProgress(),Ai}};u([p({constructOnly:!0})],vs.prototype,"context",void 0),u([p({constructOnly:!0})],vs.prototype,"view",void 0),u([p({constructOnly:!0})],vs.prototype,"requestRender",void 0),u([p()],vs.prototype,"coverage",void 0),u([p()],vs.prototype,"density",void 0),u([p()],vs.prototype,"absorption",void 0),u([p()],vs.prototype,"cloudSize",void 0),u([p()],vs.prototype,"detailSize",void 0),u([p()],vs.prototype,"smoothness",void 0),u([p()],vs.prototype,"cloudHeight",void 0),u([p()],vs.prototype,"raymarchingSteps",void 0),u([p()],vs.prototype,"readyToRun",void 0),vs=u([R("esri.views.3d.environment.CloudsRenderer")],vs);const tB=[Dr(1,0,0),Dr(-1,0,0),Dr(0,1,0),Dr(0,-1,0),Dr(0,0,1),Dr(0,0,1)],iB=[Dr(0,0,-1),Dr(0,0,-1),Dr(0,0,-1),Dr(0,0,-1),Dr(0,1,0),Dr(0,1,0)],sB=mF(),Qr=rV();function vO(s){const e=new lt;return e.attributes.add("position","vec3"),e.attributes.add("instanceFeatureAttribute","float"),e.vertex.uniforms.add(new Tn("cameraPosition",t=>t.camera.eye),new js("offset",(t,i)=>rB(t,i)),new ge("width",t=>t.width),new ge("time",t=>t.time),new ur("proj",t=>t.camera.projectionMatrix),new ur("view",t=>t.camera.viewMatrix)),e.varyings.add("vUv","vec2"),e.vertex.code.add(y`vec3 hash31(float p){
vec3 p3 = fract(vec3(p) * vec3(0.1031, 0.1030, 0.0973));
p3 += dot(p3, p3.yzx + 33.33);
return fract((p3.xxy + p3.yzz) * p3.zyx);
}
float hash11(float p){
p = fract(p * 0.1031);
p *= p + 33.33;
p *= p + p;
return fract(p);
}
vec3 rotateVectorByQuaternion(vec3 v, vec4 q){
return 2.0 * cross(q.xyz, v * q.w + cross(q.xyz, v)) + v;
}`),e.vertex.main.add(y`
      vUv = position.xz;
      vec3 rand = hash31(instanceFeatureAttribute);

      // Set random position for all particles
      // The hash function space is not high resolution so offset particles by an additional random value
      // This creates grids of 1000 particles which are shifted by random hundredths of the tile width
      // overlaying multiple identical but offset grids
      vec3 randomPosition = 2.0 * (rand + (0.01 + 0.01 * rand) * floor(0.001 * instanceFeatureAttribute)) - 1.0;

      // Random orientation of rain drops
      float angle = 3.1415 * hash11(instanceFeatureAttribute);

      vec3 up = vec3(0, 0, 1);

      // Gravity and wind direction
      vec3 direction = normalize(cameraPosition);

      vec3 tangent = normalize(cross(direction, up));

      // Gravity
      vec3 animatedPos = randomPosition + direction * -time;

      // Rain particles fall straight down and are randomly oriented
      // Snow particles have random sinusoid trajectories and are rotated to face the camera
      ${s.type===0?y`
            // Random rotation for particle
            vec3 rotationAxis = up;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));
            vec3 transformedPos = rotateVectorByQuaternion(vec3(0.2, 0.2, 4.0) * (position - vec3(0.5, 0.0, 0.5)), quat);

            // Rotate particle to planetary position
            rotationAxis = tangent;
            angle = 0.5 * -acos(dot(direction, up));
            quat = vec4(rotationAxis * sin(angle), cos(angle));
            transformedPos = rotateVectorByQuaternion(transformedPos, quat);

            vec4 pos = mat4(mat3(view)) * vec4(transformedPos + (mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * pos;
      `:y`
            vec3 rotationAxis = direction;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));

            tangent = rotateVectorByQuaternion(tangent, quat);
            // Random sinusoid from friction
            animatedPos += tangent * 0.25 * sin(dot(animatedPos, direction));
            vec4 pos = mat4(mat3(view)) * vec4((mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * (0.5 * vec4(position.xzy, 0.0) + pos);
      `}
  `),e.fragment.uniforms.add(new ge("opacity",t=>t.opacity),new Tn("particleColor",t=>nB(t,s))),e.fragment.main.add(y`
    float d = length(vUv - vec2(0.5));

    ${s.type===0?y`d = 0.35 * smoothstep(0.5, 0.0, d);`:y`d = smoothstep(0.5, 0.1, d);`}
    fragColor = opacity * vec4(particleColor * d, d);
  `),e}function rB(s,e){const t=e.camera.eye,i=.5*s.width,r=1/s.width,n=I5(Z0,be(Z0,(t[0]+i)*r,(t[1]+i)*r,(t[2]+i)*r));return zi(n,t,ee(n,n,s.width))}function nB(s,e){const t=e.type===0?oB:aB,i=ee(Z0,t,lB),r=s.camera.eye;pe(NC,r);const n=Math.max(0,We(NC,s.lighting.mainLight.direction));return kt(i,i,t,n)}const Z0=x(),NC=x(),aB=Qe(1,1,1),oB=Qe(.85,.85,.85),lB=.7,cB=Object.freeze(Object.defineProperty({__proto__:null,build:vO},Symbol.toStringTag,{value:"Module"}));let hB=class extends Xt{constructor(){super(...arguments),this.time=0,this.radius=1,this.width=500,this.opacity=0}},UC=class extends ct{constructor(e,t){super(e,t,new ht(cB,()=>k(()=>Promise.resolve().then(()=>WJ),void 0)),new Map([["position",0],["instanceFeatureAttribute",1]]))}initializePipeline(){return qe({blending:pu,depthTest:{func:515},colorWrite:nt})}},bO=class extends ls{constructor(){super(...arguments),this.type=0}};u([V({count:2})],bO.prototype,"type",void 0);let Kn=class extends Ho{constructor(){super(...arguments),this.produces="disabled",this.consumes={required:[ne.OPAQUE_ENVIRONMENT]}}_enable(){this.produces=ne.OPAQUE_ENVIRONMENT,this.requestRender(1)}_disable(){this.produces="disabled",this.requestRender(1)}};u([p()],Kn.prototype,"produces",void 0),u([p()],Kn.prototype,"consumes",void 0),Kn=u([R("esri.views.3d.webgl-engine.effects.OpaqueEnvironment")],Kn);let Ql=class extends Kn{constructor(){super(...arguments),this.consumes={required:[ne.TRANSPARENT_ENVIRONMENT]}}_enable(){this.produces=ne.TRANSPARENT_ENVIRONMENT,this.requestRender(1)}};u([p()],Ql.prototype,"consumes",void 0),Ql=u([R("esri.views.3d.webgl-engine.effects.TransparentEnvironment")],Ql);const Ey=()=>j.getLogger("esri.views.webgl.VertexArrayObject");let Wa=class wO{constructor(e,t,i,r){this._context=e,this._indexBuffer=i,this._buffers=t instanceof Map?t:new Map([["geometry",t]]),this._baseInstances=r==null?new Map:typeof r=="number"?new Map([["geometry",r]]):r,this.locations=Jl(dV(this._buffers))}get glName(){return this._glName}get context(){return this._context}get buffers(){return Jl(this._buffers)}buffer(e="geometry"){return this.buffers.get(e)}get indexBuffer(){return this._indexBuffer}getByteLength(e){return this.buffer(e)?.sizeBytes??0}vertexCount(e){const t=this.buffer(e);return t?t.sizeBytes/t.layout[0].stride:0}get usedMemory(){return Array.from(this._buffers.values()).reduce((e,t)=>e+t.usedMemory,this._indexBuffer?.usedMemory??0+(this._buffers.size+(this._indexBuffer?1:0))*hV)}dispose(){this._context?(this._buffers.forEach(e=>e.dispose()),this._buffers.clear(),this._indexBuffer=_e(this._indexBuffer),this.disposeVAOOnly()):(this._glName||this._buffers.size>0)&&Ey().warn("Leaked WebGL VAO")}disposeVAOOnly(){this._context?(this._context.getBoundVAO()===this&&this._context.bindVAO(null),this._glName&&(this._context.gl.deleteVertexArray(this._glName),this._glName=null,this._context.instanceCounter.decrement(gi.VertexArrayObject,this)),this._context=null):this._glName&&Ey().warn("Leaked WebGL VAO")}bind(e=this.locations){const t=this._context.gl;this._glName?t.bindVertexArray(this._glName):(this._context.instanceCounter.increment(gi.VertexArrayObject,this),this._glName=t.createVertexArray(),t.bindVertexArray(this._glName),this._bindLayout(e))}_bindLayout(e){const{_buffers:t,_indexBuffer:i}=this;if(t||Ey().error("Vertex buffer dictionary is empty!"),t.forEach((r,n)=>BM(this._context,e,r,this._baseInstances.get(n)??0)),i!=null){const r=this._context.gl;this._context.gl.bindBuffer(r.ELEMENT_ARRAY_BUFFER,i.glName)}}unbind(){this._context.gl.bindVertexArray(null)}shallowCloneWithBaseInstances(e){return new wO(this._context,this._buffers,this._indexBuffer,e)}},Mn=class extends Wa{},Vf=class extends Ql{constructor(e){super(e),this._hasSnowCover=!1,this._rainSpeed=.1,this._snowSpeed=.01,this._numParticles=0,this._passParameters=new hB,this._configuration=new bO;const{view:t,type:i}=e;this._configuration.type=i==="rainy"?0:1,t.stage.renderView.techniques.precompile(UC,this._configuration),this._passParameters.time=0,this._passParameters.radius=Zt(t.spatialReference).radius,this.addHandles([$(()=>t.environment.weather,r=>{r.type===i&&this.addHandles([$(()=>r.precipitation,n=>this._adjustParticles(n),Ve),$(()=>r.type==="snowy"&&r.snowCover==="enabled",n=>this._hasSnowCover=n,Ve)])},Ve)]),this.addHandles($(()=>t.stage?.renderer.renderContext.bind.clouds.fadeFactor??1,r=>{this._passParameters.opacity=r,r===1&&(this.removeHandles("opacity"),this.addHandles($(()=>t.stage?.renderer.renderContext.bind.clouds.opacity??1,n=>this._passParameters.opacity=n,Ve),"opacity"))},Ae),"opacity")}initialize(){this.addHandles([$(()=>this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),Ve)])}_adjustParticles(e){const i=e<.5?Me(0,.35,2*e):Me(.35,1,2*(e-.5));this._numParticles=HC*i}destroy(){this._numParticles=0,this._vao=_e(this._vao),this._instanceIdBuffer=_e(this._instanceIdBuffer)}fadeOut(e){this.removeAllHandles(),this.addHandles($(()=>this.renderContext?.bind.clouds.fadeFactor??1,t=>{this._passParameters.opacity=1-t,t===1&&(this.removeAllHandles(),e())}),"opacity")}get snowCover(){return this._hasSnowCover?this._passParameters.opacity:null}updateAnimation(e){const t=(this.type==="rainy"?this._rainSpeed:this._snowSpeed)*_w(e.time)%1e5;return this._passParameters.time!==t&&(this._passParameters.time=t,!0)}render(e){const t=this.renderingContext,i=Math.round(this._numParticles*this._passParameters.opacity),r=e.find(({name:o})=>o===ne.TRANSPARENT_ENVIRONMENT);if(i<1)return r;const n=this.techniques.get(UC,this._configuration);if(!n.compiled)return this.requestRender(1),r;const a=t.bindTechnique(n,this.bindParameters,this._passParameters);return this._vao??=uB(t),t.bindVAO(this._vao),this._bindInstanceIdBuffer(a.locations),a.assertCompatibleVertexAttributeLocations(this._vao,Ya(qC)),t.drawArraysInstanced(Ct.TRIANGLES,0,3,i),t.unbindBuffer(34962),r}_bindInstanceIdBuffer(e){const t=this.renderingContext;if(this._instanceIdBuffer)return void t.bindBuffer(this._instanceIdBuffer);const i=sR(HC);this._instanceIdBuffer=new Kt(t,qC,new Float32Array(i)),BM(t,e,this._instanceIdBuffer,0)}};function uB(s){const e=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new Mn(s,new Kt(s,Vr(dB),e))}u([p({constructOnly:!0})],Vf.prototype,"type",void 0),Vf=u([R("esri.views.3d.environment.Precipitation")],Vf);const HC=25e4,dB=Xa().vec3f("position").freeze(),qC=Vr(Xa().f32("instanceFeatureAttribute"),1);var X0;let cd=X0=class extends oa{constructor(s){super(s),this.type="cloudy",this.cloudCover=.5}clone(){return new X0({cloudCover:this.cloudCover})}};u([gu({cloudy:"cloudy"}),p({json:{write:{isRequired:!0}}})],cd.prototype,"type",void 0),u([p({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],cd.prototype,"cloudCover",void 0),cd=X0=u([R("esri.views.3d.environment.CloudyWeather")],cd);const pB=cd;var Y0;let hd=Y0=class extends oa{constructor(s){super(s),this.type="foggy",this.fogStrength=.5}clone(){return new Y0({fogStrength:this.fogStrength})}};u([gu({foggy:"foggy"}),p({json:{write:{isRequired:!0}}})],hd.prototype,"type",void 0),u([p({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],hd.prototype,"fogStrength",void 0),hd=Y0=u([R("esri.views.3d.environment.FoggyWeather")],hd);const mB=hd;var K0;let lh=K0=class extends oa{constructor(s){super(s),this.type="rainy",this.cloudCover=.5,this.precipitation=.5}clone(){return new K0({cloudCover:this.cloudCover,precipitation:this.precipitation})}};u([gu({rainy:"rainy"}),p({json:{write:{isRequired:!0}}})],lh.prototype,"type",void 0),u([p({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],lh.prototype,"cloudCover",void 0),u([p({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],lh.prototype,"precipitation",void 0),lh=K0=u([R("esri.views.3d.environment.RainyWeather")],lh);const fB=lh;var J0;let fl=J0=class extends oa{constructor(s){super(s),this.type="snowy",this.cloudCover=.5,this.precipitation=.5,this.snowCover="disabled"}clone(){return new J0({cloudCover:this.cloudCover,precipitation:this.precipitation,snowCover:this.snowCover})}};u([gu({snowy:"snowy"}),p({json:{write:{isRequired:!0}}})],fl.prototype,"type",void 0),u([p({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],fl.prototype,"cloudCover",void 0),u([p({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],fl.prototype,"precipitation",void 0),u([p({type:["enabled","disabled"],nonNullable:!0,json:{write:!0}})],fl.prototype,"snowCover",void 0),fl=J0=u([R("esri.views.3d.environment.SnowyWeather")],fl);const gB=fl;var eb;let ud=eb=class extends oa{constructor(s){super(s),this.type="sunny",this.cloudCover=.5}clone(){return new eb({cloudCover:this.cloudCover})}};u([gu({sunny:"sunny"}),p({json:{write:{isRequired:!0}}})],ud.prototype,"type",void 0),u([p({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],ud.prototype,"cloudCover",void 0),ud=eb=u([R("esri.views.3d.environment.SunnyWeather")],ud);const tb=ud,xO={key:"type",base:tb,typeMap:{sunny:tb,cloudy:pB,rainy:fB,snowy:gB,foggy:mB}},_B=Object.keys(xO.typeMap);function yB(s,e){return!!_B.includes(s)||(e.error(`"${s}" is not a valid weather type`),!1)}const kl=1e4,vB=1e5,CO={required:[]},bB={required:[2]};let TO=class extends te{precompile(e){return!!this.acquireTechniques(e)}consumes(){return CO}get usedMemory(){return 0}get renderOccludedFlags(){return 1}get isDecoration(){return!1}get readyToRun(){return!1}get numGeometries(){return 0}get hasOccludees(){return!1}get hasEmitters(){return!1}forEachGeometry(e){}},Wp=class extends TO{},jse=class extends TO{},gl=class extends Wp{constructor(e){super(e),this.produces=new Map([]),this._clouds=rs(null),this._incarnation=0,this._precipitation=null}initialize(){this.view.stage?.addRenderPlugin(this)}destroy(){this.removeHandles(),this.uninitializeRenderContext(),this.view?.stage?.removeRenderPlugin(this),this._set("view",null)}get updating(){return!!this._clouds.value?.readyToRun}get weatherAvailable(){return fe(this.view.state.camera.eye)-Zt(this.view.spatialReference).radius<=kl}get usedMemory(){return this._clouds.value?.usedMemory??0}_fadeOutPrecipitation(){this._precipitation&&(this._precipitationOutgoing?.destroy(),this._precipitationOutgoing=this._precipitation,this._precipitationOutgoing.fadeOut(()=>this._precipitationOutgoing=Q(this._precipitationOutgoing)),this._precipitation=null,++this._incarnation)}get _snowCover(){return this._precipitationOutgoing?.snowCover??this._precipitation?.snowCover??0}get weather(){return this.view?.environmentManager?.weatherEnabled?this.view.environment.weather:null}initializeRenderContext(e){this._context=e;const t=this.view,i=()=>this._requestRender();this.addHandles([$(()=>this._precipitation,i,Ae),$(()=>this._clouds.value?.state,i,Ae),$(()=>t.state.mode,i,Ae),$(()=>this._updateClouds(),i,Ae),$(()=>this._updatePrecipitation(),i,Ae),$(()=>this.weather,r=>this._initWeather(r))])}uninitializeRenderContext(){this._context=null,this._clouds.value=Q(this._clouds.value),this._precipitation=Q(this._precipitation),this._precipitationOutgoing=Q(this._precipitationOutgoing)}prepareRender(e){const{bind:t,time:i}=e;if(this.view.state.viewingMode===1){if(t.clouds.data){t.clouds.fade(t.camera,i,this.view.qualitySettings.fadeDuration);const r=this._clouds.value;r&&r.state===0&&r.coverage===0&&!r.readyToRun&&r.destroyCubeMap()}t.snowCover=this._snowCover}}acquireTechniques(){return[]}render(){}_requestRender(){this._context?.requestRender()}_initWeather(e){const t=this._context;if(!e||!t)return void(this._clouds.value=Q(this._clouds.value));if(this._clouds.value)return;const i=this.view;this._clouds.value=new vs({context:t,view:i,requestRender:()=>this._requestRender()})}_updateClouds(){const e=this.view.environment.weather;return e==null||this._clouds.value==null||this._clouds.value.applyPreset(Vi[e.type],wB(e)),++this._incarnation}_updatePrecipitation(){const e=this.view.environment.weather;if(e.type===this._precipitation?.type)return this._incarnation;this._fadeOutPrecipitation();const t=e.type==="rainy"||e.type==="snowy",i=this._context;return t&&i&&(this._precipitation=new Vf({view:this.view,type:e.type}),++this._incarnation),this._incarnation}hasHighlight(){return!1}get test(){}};function wB(s){switch(s.type){case"rainy":case"snowy":case"cloudy":case"sunny":return s.cloudCover;case"foggy":return s.fogStrength}}u([p({constructOnly:!0})],gl.prototype,"view",void 0),u([p({type:Boolean,readOnly:!0})],gl.prototype,"updating",null),u([p()],gl.prototype,"weatherAvailable",null),u([p()],gl.prototype,"_context",void 0),gl=u([R("esri.views.3d.environment.EnvironmentRenderer")],gl);var k_=Math.PI,Qt=Math.sin,Di=Math.cos,u1=Math.tan,SO=Math.asin,d1=Math.atan2,PO=Math.acos,fi=k_/180,MO=864e5,$O=2440588,RO=2451545,xB={dec:0,ra:0};function CB(s){return s.valueOf()/MO-.5+$O}function gm(s){return new Date((s+.5-$O)*MO)}function kf(s){return CB(s)-RO}var Ug=23.4397*fi;function OO(s,e){return d1(Qt(s)*Di(Ug)-u1(e)*Qt(Ug),Di(s))}function p1(s,e){return SO(Qt(e)*Di(Ug)+Di(e)*Qt(Ug)*Qt(s))}function DO(s,e,t){return d1(Qt(s),Di(s)*Qt(e)-u1(t)*Di(e))}function EO(s,e,t){return SO(Qt(e)*Qt(t)+Di(e)*Di(t)*Di(s))}function AO(s,e){return fi*(280.16+360.9856235*s)-e}function IO(s){return fi*(357.5291+.98560028*s)}function LO(s){return fi*(1.9148*Qt(s)+.02*Qt(2*s)+3e-4*Qt(3*s))}function FO(s,e){return s+e+102.9372*fi+k_}function VO(s,e){var t=IO(s),i=FO(t,LO(t));return e||(e={dec:0,ra:0}),e.dec=p1(i,0),e.ra=OO(i,0),e}var Ps={PolarException:{NORMAL:0,MIDNIGHT_SUN:1,POLAR_NIGHT:2},getPosition:function(s,e,t,i){var r=fi*-t,n=fi*e,a=kf(s),o=VO(a,xB),l=AO(a,r)-o.ra;return i||(i={azimuth:0,altitude:0}),i.azimuth=DO(l,n,o.dec),i.altitude=EO(l,n,o.dec),i}},zf=[[-.83,"sunrise","sunset"]];Ps.addTime=function(s,e,t){zf.push([s,e,t])};var kO=9e-4;function TB(s,e){return Math.round(s-kO-e/(2*k_))}function GC(s,e,t){return kO+(s+e)/(2*k_)+t}function jC(s,e,t){return RO+s+.0053*Qt(e)-.0069*Qt(2*t)}function SB(s,e,t){return PO((Qt(s)-Qt(e)*Qt(t))/(Di(e)*Di(t)))}function WC(s){var e=fi*(134.963+13.064993*s),t=fi*(93.272+13.22935*s),i=fi*(218.316+13.176396*s)+6.289*fi*Qt(e),r=5.128*fi*Qt(t),n=385001-20905*Di(e);return{ra:OO(i,r),dec:p1(i,r),dist:n}}Ps.getTimes=function(s,e,t){var i=fi*-t,r=fi*e,n=TB(kf(s),i),a=GC(0,i,n),o=IO(a),l=LO(o),c=FO(o,l),h=p1(c,0),d=jC(a,o,c);function m(S){return jC(GC(SB(S,r,h),i,n),o,c)}function f(S){var C=(Qt(S)-Qt(r)*Qt(h))/(Di(r)*Di(h));return C<-1?Ps.PolarException.MIDNIGHT_SUN:C>1?Ps.PolarException.POLAR_NIGHT:Ps.PolarException.NORMAL}var g,_,v,b,T,w={solarNoon:gm(d),nadir:gm(d-.5),polarException:Ps.PolarException.NORMAL};for(g=0,_=zf.length;g<_;g+=1)T=d-((b=m((v=zf[g])[0]*fi))-d),w[v[1]]=gm(T),w[v[2]]=gm(b);return w.polarException=f(zf[0][0]*fi),w},Ps.getMoonPosition=function(s,e,t){var i=fi*-t,r=fi*e,n=kf(s),a=WC(n),o=AO(n,i)-a.ra,l=EO(o,r,a.dec);return l+=.017*fi/u1(l+10.26*fi/(l+5.1*fi)),{azimuth:DO(o,r,a.dec),altitude:l,distance:a.dist}},Ps.getMoonFraction=function(s){var e=kf(s),t=VO(e),i=WC(e),r=149598e3,n=PO(Qt(t.dec)*Qt(i.dec)+Di(t.dec)*Di(i.dec)*Di(t.ra-i.ra)),a=d1(r*Qt(n),i.dist-r*Di(n));return(1+Di(a))/2};const ts={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,directAtNoon:.65,directAtTwilight:.7},global:{altitude:8e5,ambient:.015,direct:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};let _m=class{constructor(e,t){this.direct=e,this.ambient=t}};function PB(s,e,t,i,r,n){be(n.ambient.color,1,1,1),n.ambient.intensity=ts.global.ambient,be(n.direct.color,1,1,1),n.direct.intensity=ts.global.direct;const a=e[2],o=U((Math.abs(a)-ts.local.altitude)/(ts.global.altitude-ts.local.altitude),0,1);let l;if(n.globalFactor=o,s!=null&&(l=Ps.getTimes(s,e[1],e[0])),o<1){let c;if(s!=null)c=AB(s,l,i);else{const h=BO(i);c={direct:{intensity:ts.local.directAtNoon*h.direct,color:Qe(1,1,1)},ambient:{intensity:ts.local.ambientAtNoon*h.ambient,color:Qe(1,1,1)},timeOfDay:"early afternoon"}}kt(n.ambient.color,c.ambient.color,n.ambient.color,o),n.ambient.intensity=Me(c.ambient.intensity,n.ambient.intensity,o),kt(n.direct.color,c.direct.color,n.direct.color,o),n.direct.intensity=Me(c.direct.intensity,n.direct.intensity,o),n.specularStrength=i==="rainy"||i==="snowy"||i==="foggy"?0:1,n.environmentStrength=i==="rainy"?.7:i==="snowy"||i==="foggy"?.75:1}n.noonFactor=s!=null?EB(s,l):1,s!=null?MB(s,e,t,n.direct.directionToLightSource):zO(r,t,n.direct.directionToLightSource)}function zO(s,e,t){e===1?pe(Fy,s.eye):be(Fy,0,0,1),ee(Vy,s.viewForward,-1);const i=O_(Vy,Fy),r=Math.max(i-2*ky,0),n=.85*r/(r+1),a=Math.max(ky,i-ky-n);Vo(nT,-a,s.viewRight),ot(t,Vy,nT),ce(t,t,ee(IB,s.viewRight,LB)),pe(t,t)}function MB(s,e,t,i){const r=DB,n=dp(OB);if(t===1)Ps.getPosition(s,0,0,r),be(i,0,0,-1),hC(n,n,-r.azimuth),Y5(n,n,-r.altitude),ot(i,i,n);else{const a=ts.planarDirection,o=a.globalAngles,l=e[2];let c=(Math.abs(l)-a.localAltitude)/(a.globalAltitude-a.localAltitude);c=U(c,0,1),c<1?(Ps.getPosition(s,e[1],e[0],r),r.azimuth=(1-c)*r.azimuth+c*o.azimuth,r.altitude=(1-c)*r.altitude+c*o.altitude):(r.azimuth=o.azimuth,r.altitude=o.altitude),be(i,0,-1,0),A0(n,n,-r.azimuth),hC(n,n,-r.altitude),ot(i,i,n)}}function $B(s,e){if(e===1)return!0;const t=ts.planarDirection;return Math.abs(s)<t.localAltitude}const RB=Qe(.5773502691896258,-.5773502691896258,.5773502691896258);let QC=class{constructor(){this.ambient={color:Qe(1,1,1),intensity:.55},this.direct={color:Qe(1,1,1),intensity:.55,directionToLightSource:Sn(RB)},this.noonFactor=.5,this.globalFactor=0,this.specularStrength=1,this.environmentStrength=1}};const OB=Ie(),DB={azimuth:0,altitude:0};function EB(s,e){const t=s.valueOf();let i,r;e.polarException===Ps.PolarException.MIDNIGHT_SUN?(i=t-60*(s.getHours()+48)*60*1e3-60*s.getMinutes()*1e3,r=i+432e6):e.polarException===Ps.PolarException.POLAR_NIGHT?(i=t-2,r=t-1):(i=e.sunrise.valueOf(),r=e.sunset.valueOf());const n=i+(r-i)/2;return 1-U(Math.abs(t-n)/432e5,0,1)}function BO(s){switch(s){case"disabled":case"sunny":case"cloudy":return new _m(1,1);case"rainy":return new _m(.4,1.2);case"snowy":return new _m(.5,1.3);case"foggy":return new _m(.2,1.6)}}function ZC(s,e){const t=(s[0]+s[1]+s[2])/3;s[0]+=(t-s[0])*e,s[1]+=(t-s[1])*e,s[2]+=(t-s[2])*e}const Ay=Qe(.01,.01,.01),ib=Qe(1,.6,.5),sb=Qe(1,.98,.98),XC=Qe(1,1,1),Iy=Qe(.8,.8,1),rb=Qe(.8,.8,1),nb=Qe(.98,.98,1),YC=Qe(1,1,1),Ly=_u(.01,ts.local.ambientAtNight),ab=_u(ts.local.directAtTwilight,ts.local.ambientAtTwilight),ob=_u(.9*ts.local.directAtNoon,ts.local.ambientAtNoon),KC=_u(ts.local.directAtNoon,ts.local.ambientAtNoon),JC=ob,eT=sb,tT=nb,iT=ab,sT=ib,rT=rb;function AB(s,e,t){const i=s.valueOf();let r,n;e.polarException===Ps.PolarException.MIDNIGHT_SUN?(r=i-60*(s.getHours()+48)*60*1e3-60*s.getMinutes()*1e3,n=r+432e6):e.polarException===Ps.PolarException.POLAR_NIGHT?(r=i-2,n=i-1):(r=e.sunrise.valueOf(),n=e.sunset.valueOf());const a=n-r,o=r+a/2,l=a/4,c=o-l,h=o+l,d=.06*a,m=r-d/2,f=r+d/2,g=n-d/2,_=n+d/2,v=ke(),b=x(),T=x();let w="";if(i<m||i>_)pr(v,Ly),q(b,Ay),q(T,Iy),w="night";else if(i<f){const P=(i-m)/(f-m);hn(v,Ly,ab,P),kt(b,Ay,ib,P),kt(T,Iy,rb,P),w="sun rising"}else if(i<c){const P=(i-f)/(c-f);hn(v,ab,ob,P),kt(b,ib,sb,P),kt(T,rb,nb,P),w="early morning"}else if(i<o){const P=(i-c)/(o-c);hn(v,ob,KC,P),kt(b,sb,XC,P),kt(T,nb,YC,P),w="late morning"}else if(i<h){const P=(i-o)/(h-o);hn(v,KC,JC,P),kt(b,XC,eT,P),kt(T,YC,tT,P),w="early afternoon"}else if(i<g){const P=(i-h)/(g-h);hn(v,JC,iT,P),kt(b,eT,sT,P),kt(T,tT,rT,P),w="late afternoon"}else if(i<_){const P=(i-g)/(_-g);hn(v,iT,Ly,P),kt(b,sT,Ay,P),kt(T,rT,Iy,P),w="sun setting"}let S=0;switch(t){case"rainy":case"foggy":S=.8;break;case"snowy":S=.5}S>0&&(ZC(b,S),ZC(T,S));const C=BO(t);return{direct:{intensity:v[0]*C.direct,color:b},ambient:{intensity:v[1]*C.ambient,color:T},timeOfDay:w}}const nT=Ie(),Fy=x(),Vy=x(),IB=x(),ky=.25,LB=.2;let sn=class extends fu{constructor(e){super(e),this._tmpLightParameters=new QC,this._defaultLightParameters=new QC,this._tmpDate=new Date,this._tmpTz={hours:0,minutes:0,seconds:0},this._viewHandlesKey="viewHandles",this._trackingEnabled=!1,this._mainLight=new LI,this._ambientLight=new NM,this._moonLight=new FI,this._disableWeather=!1,this._renderer=null,this._resetReferencePosition()}destroy(){this.disconnectView()}get _view(){return this._renderer?.view}get updating(){return!!this._renderer?.updating||!this._canProjectCameraPosition}get weatherEnabled(){return this._view?.environment.atmosphereEnabled&&!this._disableWeather&&this._view?.state?.viewingMode===1&&g$(this._view.spatialReference)}get _weatherAvailable(){return this.weatherEnabled&&this._renderer?.weatherAvailable}get referencePositionGeographic(){return this._referencePositionGeographic}get _canProjectCameraPosition(){const e=this._view?.stateManager?.camera?.position?.spatialReference??Dt.WGS84,t=zC(e);return Jc(e,t)}connectView(e){if(this._renderer)return;this._renderer=new gl({view:e});const t=()=>this._updateRenderParameters(),i=()=>this._cameraHandler();this.addHandles([$(()=>e.environment.lighting,r=>this._updateLightingHandler(r),Ae),$(()=>e.environment.lighting.type!=="virtual"?e.environment.lighting.date:null,r=>this._lightingDateHandler(r),Ae),$(()=>e.environment.lighting.directShadowsEnabled,t,Ae),$(()=>e.qualitySettings.ambientOcclusion,t,Ae),$(()=>e.qualitySettings.reflections,t,Ae),$(()=>e.spatialReference,()=>this._resetReferencePosition(!0),Ae),$(()=>[e.environment.weather.type,this.weatherEnabled],()=>this._updateLighting(null,1),Ae),$(()=>e.environment.weather.type==="snowy"&&e.environment.weather.snowCover,t,Ae),$(()=>e.environment,r=>r.setComputeWeatherAvailable(()=>this._weatherAvailable),Ve),$(()=>e.viewingMode,()=>this._resetReferencePosition(!0),Ve),$(()=>e.environment.lighting.type!=="virtual"&&e.environment.lighting.cameraTrackingEnabled,r=>this._updateCameraTracking(r),Ve),$(()=>e.state.camera,i,Ve),Zs(()=>this._canProjectCameraPosition,i,Ae)],this._viewHandlesKey),this._updateRenderParameters(),this._updateLighting(),this._cameraHandler(),this.notifyChange("updating")}disconnectView(){this.removeHandles(this._viewHandlesKey),this._resetReferencePosition(),this._renderer=Q(this._renderer)}_updateLightingHandler(e){this._updateCameraTracking(e.type!=="virtual"&&e.cameraTrackingEnabled),this._lightingDateHandler(e.type!=="virtual"?e.date:null),this._updateRenderParameters()}_updateCameraTracking(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{const t=this._view.environment.lighting;t?.type!=="virtual"&&(t.positionTimezoneInfo.autoUpdated=!1)}}_lightingDateHandler(e){const t=this._view.environment.lighting;if(t?.type!=="virtual"){if(e){if(!t.positionTimezoneInfo.autoUpdated&&(this._preupdateTracking(e),this._referencePositionGeographic!=null)){const i=Vx(this._referencePositionGeographic,this._tmpTz);i!=null&&(t.autoUpdate(null,i),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}this._updateLighting(e)}}else this._updateLighting()}_preupdateTracking(e){!this._trackingEnabled&&this._view.environment.lighting.type!=="virtual"&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)}_cameraHandler(e=null){const t=this._view;if(!t.ready)return;const i=t.stateManager.camera;if(!i)return;const{position:r}=i,n=r.spatialReference??Dt.WGS84,a=zC(n);if(!Na(r,ym,a))return this._referencePositionGeographic==null?void 0:(this._referencePositionGeographic=null,void this._updateLighting());this._referencePositionGeographic?Jh(this._referencePositionGeographic,ym)||(q(this._referencePositionGeographic,ym),this.notifyChange("referencePositionGeographic")):this._referencePositionGeographic=Sn(ym),this._autoUpdateTimezone(this._referencePositionGeographic,e)||this._updateLighting(e)}_updateLighting(e,t=0){const i=this._view,{lighting:r}=i.environment,n=r.type==="virtual",a=this._referencePositionGeographic,o=a!=null?this._tmpLightParameters:this._defaultLightParameters;if(a){e??=n?null:r.date;const f=this._weatherAvailable?i.environment.weather.type:"disabled";PB(e,a,i.state.viewingMode,f,i.state.camera,o)}else n&&zO(i.state.camera,i.state.viewingMode,o.direct.directionToLightSource);const l=this._mainLight,c=o.direct;ee(l.intensity,c.color,c.intensity*Math.PI),q(l.direction,c.directionToLightSource),l.specularStrength=o.specularStrength,l.environmentStrength=o.environmentStrength;const h=this._ambientLight;ee(h.intensity,o.ambient.color,o.ambient.intensity);const d=this._moonLight;kt(d.intensity,FB,VB,o.globalFactor);const m=(1-.5*o.globalFactor)*(1-.4*o.noonFactor*(1-o.globalFactor));ee(d.intensity,d.intensity,m),q(d.direction,c.directionToLightSource),this._view.stage?.renderer.updateLighting([l,h,d],o.noonFactor,o.globalFactor,this._weatherAvailable?t:0),this._updateRenderParameters()}_autoUpdateTimezone(e,t=null){if(this._view.environment.lighting.type==="virtual"||!this._view.environment.lighting.cameraTrackingEnabled||e==null)return!1;const i=this._tmpDate;i.setTime((t||this._view.environment.lighting.date).getTime());const r=Vx(e,this._tmpTz);if(r==null)return!1;let n=this._view.environment.lighting.positionTimezoneInfo;if(n.autoUpdated){if(n.hours===r.hours&&n.minutes===r.minutes&&n.seconds===r.seconds)return!1}else n=r;const a=i.getUTCHours()-(r.hours-n.hours),o=i.getUTCMinutes()-(r.minutes-n.minutes),l=i.getUTCSeconds()-(r.seconds-n.seconds);return i.setUTCHours(a),i.setUTCMinutes(o),i.setUTCSeconds(l),!t&&this._view.environment.lighting.autoUpdate(i,r)}_updateRenderParameters(){const e=this._view.stage;if(!e)return;const t=this._referencePositionGeographic==null||$B(this._referencePositionGeographic[2],this._view.state.viewingMode);e.renderer.setParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&t,environment:this._view.environment,weatherVisible:this._weatherAvailable,qualitySettings:this._view.qualitySettings})}_resetReferencePosition(e=!1){this._referencePositionGeographic=null,e&&this._cameraHandler()}get test(){}};u([p({type:Boolean,readOnly:!0})],sn.prototype,"updating",null),u([p()],sn.prototype,"_disableWeather",void 0),u([p()],sn.prototype,"weatherEnabled",null),u([p()],sn.prototype,"_weatherAvailable",null),u([p()],sn.prototype,"referencePositionGeographic",null),u([p()],sn.prototype,"_referencePositionGeographic",void 0),u([p()],sn.prototype,"_renderer",void 0),u([p()],sn.prototype,"_canProjectCameraPosition",null),sn=u([R("esri.views.3d.environment.EnvironmentManager")],sn);const FB=Qe(.22,.22,.33),VB=Qe(.22,.22,.22),ym=x();var lb;let vr=class extends oa{static{lb=this}constructor(e){super(e),this.type="sun",this.date=null,this.directShadowsEnabled=!1,this.displayUTCOffset=null}readDate(e,t){return t.datetime!=null&&new Date(t.datetime)||null}writeDate(e,t,i){t[i]=e.getTime()}readDirectShadowsEnabled(e,t){return!!t.directShadows}writedirectShadowsEnabled(e,t,i){e&&(t[i]=e)}writeDisplayUTCOffset(e,t){e!=null&&(t.displayUTCOffset=e)}clone(){return new lb(this.cloneConstructProperties())}cloneConstructProperties(){const e={directShadowsEnabled:this.directShadowsEnabled,displayUTCOffset:this.displayUTCOffset!=null?this.displayUTCOffset:null};return this.date!=null&&(e.date=new Date(this.date)),e}};u([p({readOnly:!0,type:["sun"],json:{write:!0}})],vr.prototype,"type",void 0),u([p({type:Date,json:{type:Number,write:{target:"datetime"}}})],vr.prototype,"date",void 0),u([dC("date",["datetime"])],vr.prototype,"readDate",null),u([ay("date")],vr.prototype,"writeDate",null),u([p({type:Boolean,json:{default:!1,write:{target:"directShadows"}}})],vr.prototype,"directShadowsEnabled",void 0),u([dC("directShadowsEnabled",["directShadows"])],vr.prototype,"readDirectShadowsEnabled",null),u([ay("directShadowsEnabled")],vr.prototype,"writedirectShadowsEnabled",null),u([p({type:Number,json:{write:!0}})],vr.prototype,"displayUTCOffset",void 0),u([ay("displayUTCOffset")],vr.prototype,"writeDisplayUTCOffset",null),vr=lb=u([R("esri.webscene.SunLighting")],vr);const wp=vr;var ch;let hh=ch=class extends $_(wp){static calculateTimezoneOffset({hours:s,minutes:e,seconds:t}){return Math.round(s+e/60+t/3600)}constructor(s){super(s),this.cameraTrackingEnabled=!0,this.positionTimezoneInfo={hours:0,minutes:0,seconds:0,autoUpdated:!0};const e=new Date().getFullYear(),t=new Date("March 15, "+e+" 12:00:00 UTC");this._set("defaultDate",t),this._set("date",t)}get defaultDate(){return new Date(this._get("defaultDate"))}static fromWebsceneLighting(s){return new ch(s.cloneConstructProperties())}set defaultDate(s){const e=this._get("date")===this._get("defaultDate");s=new Date(s),this._set("defaultDate",s),e&&this._set("date",s)}set date(s){s!=null&&(this.positionTimezoneInfo.autoUpdated=!1,this._set("date",new Date(s)))}autoUpdate(s,e){const t=ch.calculateTimezoneOffset(this.positionTimezoneInfo);this.positionTimezoneInfo.hours=e.hours,this.positionTimezoneInfo.minutes=e.minutes,this.positionTimezoneInfo.seconds=e.seconds;let i=null;s!=null&&(this.positionTimezoneInfo.autoUpdated=!0,isNaN(s.getTime())?(i=this.defaultDate.getTime(),this._set("date",this.defaultDate)):(i=this.date&&this.date.getTime(),this._set("date",new Date(s))));const r=ch.calculateTimezoneOffset(this.positionTimezoneInfo);if(t!==r&&(vm.target=this,vm.timezoneOffset=r,this.emit("timezone-will-change",vm),vm.target=null),s!=null)return isNaN(s.getTime())||i!==s.getTime()}clone(){const s=this._get("date")===this._get("defaultDate"),e=new ch({...this.cloneConstructProperties(),defaultDate:this.defaultDate,cameraTrackingEnabled:this.cameraTrackingEnabled});return s&&e._set("date",e._get("defaultDate")),e.positionTimezoneInfo.autoUpdated=this.positionTimezoneInfo.autoUpdated,e.positionTimezoneInfo.hours=this.positionTimezoneInfo.hours,e.positionTimezoneInfo.minutes=this.positionTimezoneInfo.minutes,e.positionTimezoneInfo.seconds=this.positionTimezoneInfo.seconds,e}cloneWithWebsceneLighting(s){const e=this.clone();return s.date!=null&&(e.date=s.date),e.directShadowsEnabled=s.directShadowsEnabled,e.displayUTCOffset=s.displayUTCOffset,e}cloneNonPersistentConstructProperties(){return{cameraTrackingEnabled:this.cameraTrackingEnabled}}};u([p({type:Boolean})],hh.prototype,"cameraTrackingEnabled",void 0),u([p({type:Date})],hh.prototype,"defaultDate",null),u([p({type:Date})],hh.prototype,"date",null),hh=ch=u([R("esri.views.3d.environment.SunLighting")],hh);const vm={target:null,timezoneOffset:0},_l=hh;var cb;let dd=class extends oa{static{cb=this}constructor(e){super(e),this.type="virtual",this.directShadowsEnabled=!1}clone(){return new cb(this.cloneConstructProperties())}cloneConstructProperties(){return{directShadowsEnabled:this.directShadowsEnabled}}};u([p({readOnly:!0,type:["virtual"],json:{write:{isRequired:!0}}})],dd.prototype,"type",void 0),u([p({type:Boolean,json:{default:!1,name:"directShadows",write:!0}})],dd.prototype,"directShadowsEnabled",void 0),dd=cb=u([R("esri.webscene.VirtualLighting")],dd);const z_=dd;var Bf;let Nf=Bf=class extends $_(z_){constructor(s){super(s),this.cameraTrackingEnabled=!0}clone(){return new Bf({...this.cloneConstructProperties(),cameraTrackingEnabled:this.cameraTrackingEnabled})}static fromWebsceneLighting(s){return new Bf(s.cloneConstructProperties())}cloneWithWebsceneLighting(s){const e=this.clone();return e.directShadowsEnabled=s.directShadowsEnabled,e}cloneNonPersistentConstructProperties(){return{cameraTrackingEnabled:this.cameraTrackingEnabled}}};u([p({type:Boolean})],Nf.prototype,"cameraTrackingEnabled",void 0),Nf=Bf=u([R("esri.views.3d.environment.VirtualLighting")],Nf);const pd=Nf,kB={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:_l,virtual:pd}},zB={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:wp,virtual:z_}};let Uf=class extends oa{constructor(e){super(e)}clone(){throw new Error("Subclasses of Background should implement their own clone method.")}};u([p({readOnly:!0,json:{read:!1}})],Uf.prototype,"type",void 0),Uf=u([R("esri.webscene.background.Background")],Uf);const NO=Uf;var hb;let md=hb=class extends NO{constructor(s){super(s),this.type="color",this.color=new vi([0,0,0,1])}clone(){return new hb(this.cloneProperties())}cloneProperties(){return{color:this.color.clone()}}};u([gu({color:"color"},{readOnly:!0}),p({json:{write:{isRequired:!0}}})],md.prototype,"type",void 0),u([p(fV({nonNullable:!0,colorRequiredOnWrite:!0}))],md.prototype,"color",void 0),md=hb=u([R("esri.webscene.background.ColorBackground")],md);const UO=md,aT={base:NO,key:"type",typeMap:{color:UO}};function BB(s){return(e,t,i)=>{if(!e)return e;for(const r in s.typeMap)if(e.type===r){const n=new s.typeMap[r];return n.read(e,i),n}}}const NB={types:aT,json:{read:BB(aT),write:{overridePolicy:(s,e,t)=>({enabled:!t?.isPresentation})}}};var ub;const oT=(s,e,t)=>({enabled:!t?.isPresentation});let go=class extends oa{static{ub=this}constructor(e){super(e),this.lighting=new wp,this.background=null,this.atmosphereEnabled=!0,this.starsEnabled=!0}set weather(e){yB(e?.type,j.getLogger(this))&&this._set("weather",e)}clone(){return new ub(this.cloneConstructProperties())}cloneConstructProperties(){return{lighting:this.lighting&&this.lighting.type==="virtual"?z_.prototype.clone.call(this.lighting):wp.prototype.clone.call(this.lighting),background:$g(this.background),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,weather:this.weather.clone()}}};u([p({types:zB,nonNullable:!0,json:{write:!0}})],go.prototype,"lighting",void 0),u([p(NB)],go.prototype,"background",void 0),u([p({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:oT}}})],go.prototype,"atmosphereEnabled",void 0),u([p({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:oT}}})],go.prototype,"starsEnabled",void 0),u([p({types:xO,nonNullable:!0,json:{write:!0},value:new tb})],go.prototype,"weather",null),go=ub=u([R("esri.webscene.Environment")],go);const HO=go;var fd;let yl=class extends HO{static{fd=this}constructor(e){super(e),this.lighting=this.castLighting(),this._computeWeatherAvailable=void 0,this.cachedCameraTrackingEnabled=null}static fromWebsceneEnvironment(e){const t=e.cloneConstructProperties();return new fd({...t,lighting:t.lighting?t.lighting.type==="virtual"?pd.fromWebsceneLighting(t.lighting):_l.fromWebsceneLighting(t.lighting):void 0})}get weatherAvailable(){return this._computeWeatherAvailable?.()??!1}setComputeWeatherAvailable(e){this._computeWeatherAvailable=e}castLighting(e){return this._convertLightingWithDestroy(e)}applyLighting(e){this.lighting=this._convertLightingWithDestroy(e)}_convertLightingWithDestroy(e){const t=this._convertLighting(e);return t!==e&&this.addHandles(w_(t)),t}_convertLighting(e){return e?e instanceof _l||e instanceof pd?e:e instanceof wp?this.lighting&&this.lighting.type!=="virtual"?this.lighting.cloneWithWebsceneLighting(e):new _l({...e.cloneConstructProperties(),...this.lighting?.cloneNonPersistentConstructProperties()}):e instanceof z_?this.lighting&&this.lighting.type==="virtual"?this.lighting.cloneWithWebsceneLighting(e):new pd({...e.cloneConstructProperties(),...this.lighting?.cloneNonPersistentConstructProperties()}):oI(kB,e):new _l}clone(){return new fd({lighting:this.lighting.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:$g(this.background)})}cloneWithWebsceneEnvironment(e){return new fd({weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:$g(this.background),...e.cloneConstructProperties(),lighting:this._getLighting(e)})}_getLighting(e){switch(e.lighting.type){case"sun":return this.lighting&&this.lighting.type==="sun"?this.lighting.cloneWithWebsceneLighting(e.lighting):_l.fromWebsceneLighting(e.lighting);case"virtual":return this.lighting&&this.lighting.type==="virtual"?this.lighting.cloneWithWebsceneLighting(e.lighting):pd.fromWebsceneLighting(e.lighting);default:return ra(e.lighting),_l.fromWebsceneLighting(e.lighting)}}};u([p({nonNullable:!0})],yl.prototype,"lighting",void 0),u([p()],yl.prototype,"_computeWeatherAvailable",void 0),u([p({readOnly:!0})],yl.prototype,"weatherAvailable",null),u([Ba("lighting")],yl.prototype,"castLighting",null),yl=fd=u([R("esri.views.3d.environment.SceneViewEnvironment")],yl);const uh=yl;let gr=class{constructor(e=15,t=0,i=0,r=null,n=null,a=0){this.selection=e,this.interactionType=t,this.interactionFactor=i,this.interactionStartCamera=r,this.interactionDirection=n,this.tiltMode=a}};function xp(s,e){return(s&e)!==0}function Hg(s,e,t,i,r,n){s!==0&&(t?(n.min=Math.min(n.min,e),n.max=Math.max(n.max,e)):i!=null?(n.min-=Math.max(0,(e-n.min)*(1-i)),n.max+=Math.max(0,(e-n.max)*(1-i))):r&&(n.min-=Math.max(0,e-n.min-r),n.max+=Math.max(0,e-n.max-r)))}const pc=new gr(0);function qO(s,e,t,i){return e=e||s.viewForward,q(i,e),ee(i,i,Math.sign(We(e,t))),i}function rre(s,e,t,i){return jB(s,e,t,qB(i,e,t,!0))}function UB(s,e,t,i){const r=We(t,he(s,i,e));return ce(s,e,ee(s,t,r))}const HB={dir:x(),len:0,clip:ke()};function qB(s,e,t,i){const r=HB;return s?(t&&i&&(r.len=Ht(e,t)),q(r.dir,s)):(r.len=Ht(e,t),he(r.dir,t,e),ee(r.dir,r.dir,1/r.len)),r}function GB(s,e,t){const i=We(cn(s),t.dir),r=-or(s,e);if(r<0&&i>=0)return!1;if(i>-1e-6&&i<1e-6)return r>0;if((r<0||i<0)&&!(r<0&&i<0))return!0;const n=r/i;return i>0?n<t.clip[1]&&(t.clip[1]=n):n>t.clip[0]&&(t.clip[0]=n),t.clip[0]<=t.clip[1]}function jB(s,e,t,i){i.clip[0]=0,i.clip[1]=t?i.len:Number.MAX_VALUE;for(let r=0;r<s.length;r++)if(!GB(s[r],e,i))return!1;return!0}function WB(s,e,t=pc){const i=m1(s,e,t);if(i===0)return!1;const r=s.renderCoordsHelper,n=r.getAltitude(e.eye)+i,a=qO(e,t.interactionDirection,XB(s,e,Math.sign(i),eN),JB),o=q(tN,e.viewForward),l=r.intersectInfiniteManifold(iu(e.eye,a),n,zy);return e.eye=l??r.setAltitude(zy,n,e.eye),e.center=UB(zy,e.eye,o,e.center),!0}function m1(s,e,t=pc){if(!QB(s,t)||!s.state.constraints.altitude)return 0;const i=YB(s.state.constraints.altitude,KB);ZB(s,t,i);const r=s.renderCoordsHelper.getAltitude(e.eye),n=U(r,i.min,i.max)-r;return Math.abs(n)<=1e-6?0:n}function QB(s,e){const t=s.state.constraints.altitude;return!(!s.state.isGlobal||!t)&&(e.interactionType!==2||!xp(e.selection,1))}function ZB(s,e,t){const i=e.interactionType;if(i===0)return;const{min:r,max:n}=t,{interactionStartCamera:a,interactionFactor:o}=e;if(!a)return;const l=i===2||i===1,c=m1(s,a),h=c===0?0:s.renderCoordsHelper.getAltitude(a.eye);t.min=r,t.max=n,Hg(c,h,l,o,.05*h,t)}function XB(s,e,t,i){return s.renderCoordsHelper.worldUpAtPosition(e.eye,i),ee(i,i,t),i}function YB(s,e){return e.min=s.min,e.max=s.max,e}const KB={min:0,max:0},JB=x(),eN=x(),tN=x(),zy=x();function f1(s,e,t=pc){if(!s.state.isLocal)return 0;const i=s.state.constraints.distance;if(!s.pointsOfInterest.surfaceOrigin.renderLocation||i===1/0)return 0;bm.min=0,bm.max=i,sN(s,t,bm);const r=g1(s,e),n=bm.max-r;return n>=-1e-6?0:n}function iN(s,e,t=pc){const i=f1(s,e,t);if(i===0)return!1;const r=s.pointsOfInterest.surfaceOrigin;if(!r.renderLocation)return!1;const n=g1(s,e)+i,a=q(nN,e.eye),o=qO(e,t.interactionDirection,rN(e,r.renderLocation,lN),oN);if(!D_(gV(r.renderLocation,n),iu(e.eye,o),wm))return!1;e.eye=wm;const l=he(aN,e.eye,a);e.center=ce(wm,e.center,l);const c=s.renderCoordsHelper.getAltitude(e.center),h=s.renderCoordsHelper.intersectInfiniteManifold(e.ray,c,wm);return h!=null&&(e.center=h),!0}function sN(s,e,t){const i=e.interactionType;if(i===0)return;const{min:r,max:n}=t,{interactionStartCamera:a,interactionFactor:o}=e;if(!a)return;const l=i===1||i===4,c=f1(s,a),h=c===0?0:g1(s,a);t.min=r,t.max=n,Hg(c,h,l,o,.05*h,t)}function g1(s,e){const t=s.pointsOfInterest.surfaceOrigin;return t.renderLocation?Ht(e.eye,t.renderLocation):0}function rN(s,e,t){return kw(t,s.eye,e)}const bm={min:0,max:0},nN=x(),aN=x(),oN=x(),lN=x(),wm=x();function yu(s,e,t=0){const i=s.state.constraints.collision;if(!i.enabled)return!1;const r=ww(s,e.eye),n=s.renderCoordsHelper.getAltitude(e.eye),a=r+i.elevationMargin;if(n>=a)return!1;const o=fe(e.eye);if(he(xm,e.center,e.eye),e.eye=s.renderCoordsHelper.setAltitude(cN,a,e.eye),t===1)e.center=ce(xm,e.eye,xm);else if(t===2){const l=(o-n+a)/o;e.center=ee(xm,e.center,l)}return!0}const xm=x(),cN=x();function GO(s,e,t,i=!0){Eu.eyeCenterDistance=0,Eu.requiresTwoSteps=!1;const r=_1(s,e,t,pc,Eu);if(r===0)return!1;switch(Vo(Cm,-r,e.viewRight),t.tiltMode){case 1:ot(io,e.viewForward,Cm),ee(io,io,Eu.eyeCenterDistance),e.center=ce(Co,e.eye,io);break;case 0:he(io,e.center,e.eye),ot(io,io,Cm),e.eye=he(Co,e.center,io);break;default:ra(t.tiltMode)}return e.up=ot(Co,e.up,Cm),!Eu.requiresTwoSteps||!i||GO(s,e,t,!1)}function _1(s,e,t,i=pc,r){if(!s.state.constraints.tilt)return 0;const n=Math.min(e.relativeElevation*Hf,e.distance),a=s.state.constraints.tilt(n,vN);return yN(s,t,a),i.interactionType===2&&xp(i.selection,2)&&jO(s,i.interactionStartCamera,a),t.tiltMode===1||i.tiltMode===1?uN(s,e,a,r):hN(s,e,a)}function hN(s,e,t){const i=Eo(s.renderCoordsHelper,e.center,e.eye),r=i-U(i,t.min,t.max);return Cp(r)?r:0}function uN(s,e,t,i){switch(i&&(i.requiresTwoSteps=!1),s.viewingMode){case"global":return pN(s,e,t,i);case"local":return dN(s,e,t,i)}}function dN(s,e,t,i){const r=Eo(s.renderCoordsHelper,e.center,e.eye),n=U(r,t.min,t.max),a=r-n;if(!Cp(a))return 0;if(i){const o=Math.abs(s.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude),l=s.renderCoordsHelper.getAltitude(e.eye)-o,c=Math.max(Math.cos(n),1e-4);Math.abs(c)>1e-4?i.eyeCenterDistance=l/c:i.eyeCenterDistance=e.distance}return a}function pN(s,e,t,i){const r=mN(s,e,bN),n=U(r.tiltAtCenter,t.min,t.max);if(!Cp(r.tiltAtCenter-n))return 0;let a,o;return r.centerIsOnSurface?(a=fN(r),o=gN(r,a)):(a=r.constraints.clampTilt(r.distance,r.tiltAtCenter),i&&a<Math.PI/2&&(i.requiresTwoSteps=!0,a=Math.PI/2-1e-5),o=_N(r,a)),i&&(i.eyeCenterDistance=db(r,a)),o}function mN(s,e,t){const i=s.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,r=i+Zt(s.spatialReference).radius,n=s.renderCoordsHelper.intersectManifold(e.ray,i,Co);return t.distance=Math.min(e.relativeElevation*Hf,e.distance),t.centerIsOnSurface=!1,n!=null?(t.distance=Math.min(e.relativeElevation*Hf,Ht(e.eye,n)),t.tiltAtCenter=Eo(s.renderCoordsHelper,n,e.eye),t.centerIsOnSurface=!0):s.state.isLocal?t.tiltAtCenter=Eo(s.renderCoordsHelper,e.center,e.eye):(E_(A_(Gw,r),e.ray,Co),t.distance=Math.min(e.relativeElevation*Hf,Ht(e.eye,Co)),t.tiltAtCenter=Ua(-We(e.viewForward,pe(Co,Co)))),t.radius=r,t.eyeRadius=fe(e.eye),t.constraints=s.state.constraints,t}function Cp(s){return Math.abs(s)>1e-9}function fN(s){const{constraints:e,distance:t,tiltAtCenter:i}=s;let r=i,n=e.clampTilt(t,i);const a=db(s,n);if(e.clampTilt(a,i)===n)return n;let o=0;for(;o<10&&Cp(n-r);){const l=(r+n)/2,c=db(s,l);Cp(e.clampTilt(c,l)-l)?r=l:n=l,o++}return n}function db(s,e){if(!s.centerIsOnSurface)return s.distance;const t=Math.PI-U(e,0,Math.PI),i=lp(s.radius/s.eyeRadius*Math.sin(t)),r=Math.PI-t-i,n=Math.sin(r)/Math.sin(t);if(s.eyeRadius<s.radius&&n>1){const a=Math.PI-i,o=Math.PI-t-a;return Math.sin(o)/Math.sin(t)*s.eyeRadius}return n*s.eyeRadius}function gN(s,e){const t=lp(s.radius/s.eyeRadius*Math.sin(s.tiltAtCenter)),i=lp(s.radius/s.eyeRadius*Math.sin(e));return s.eyeRadius>s.radius?t-i:i-t}function _N(s,e){return s.tiltAtCenter-Math.PI/2-(e-Math.PI/2)}function yN(s,e,t){if(e.interactionType===0)return;const{interactionStartCamera:i,interactionFactor:r}=e;if(!i)return;const{min:n,max:a}=t,o=_1(s,i,pc,e),l=o===0?0:Eo(s.renderCoordsHelper,i.center,i.eye);t.min=n,t.max=a,e.interactionType===2?(xp(e.selection,2)&&jO(s,i,t),Hg(o,l,!0,r,lT,t)):Hg(o,l,!1,r,lT,t)}function jO(s,e,t){const i=s.state.constraints;if(s.state.isLocal||!i.altitude||!e)return;const r=Gs(e.center),n=Math.sqrt(r),a=e.distance,o=Zt(s.spatialReference).radius,l=i.altitude.min+o,c=i.altitude.max+o,h=(l*l-a*a-r)/(-2*n*a),d=(c*c-a*a-r)/(-2*n*a);t.min=Math.max(t.min,Math.min(Math.PI-Ua(d),t.max)),t.max=Math.min(t.max,Math.PI-Ua(h))}const io=x(),Cm=Ie(),Co=x(),lT=rt(5),Hf=30,vN={min:0,max:0},bN={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,distance:0,tiltAtCenter:0},Eu={eyeCenterDistance:0,requiresTwoSteps:!1},wN=s=>s,Tp=s=>s*s,qg=s=>1-Tp(1-s),cT=s=>s<.5?Tp(2*s)/2:(qg(2*(s-.5))+1)/2,Gg=s=>s*s*s,pb=s=>1-Gg(1-s),mb=s=>s<.5?Gg(2*s)/2:(pb(2*(s-.5))+1)/2,jg=s=>s*s*s*s,fb=s=>1-jg(1-s),hT=s=>s<.5?jg(2*s)/2:(fb(2*(s-.5))+1)/2,Wg=s=>s*s*s*s*s,gb=s=>1-Wg(1-s),uT=s=>s<.5?Wg(2*s)/2:(gb(2*(s-.5))+1)/2,Qg=s=>1-Math.cos(s*Math.PI/2),_b=s=>1-Qg(1-s),dT=s=>s<.5?Qg(2*s)/2:(_b(2*(s-.5))+1)/2,Zg=s=>2**(10*(s-1)),au=s=>1-Zg(1-s),pT=s=>s<.5?Zg(2*s)/2:(au(2*(s-.5))+1)/2,Xg=s=>-(Math.sqrt(1-s*s)-1),yb=s=>1-Xg(1-s),mT=s=>s<.5?Xg(2*s)/2:(yb(2*(s-.5))+1)/2;function qr(s){const e=2*(s-Math.sqrt((s-1)*s)),t=e/2/s;return i=>i<t?s*i*i:e*i-e+1}function Gr(s,e){return(t,i)=>t<e?e*s(t/e,i):1-s((1-t)/(1-e),i)*(1-e)}const fT=Gr(qr(1),1),gT=Gr(qr(1),0),Yg=Gr(qr(1),.5),_T=Gr(qr(2),1),yT=Gr(qr(2),0),vT=Gr(qr(2),.5),bT=Gr(qr(3),1),wT=Gr(qr(3),0),xT=Gr(qr(3),.5),CT=Gr(qr(4),1),TT=Gr(qr(4),0),ST=Gr(qr(4),.5),xN={linear:wN,"in-quad":Tp,"out-quad":qg,"in-out-quad":cT,"in-coast-quad":fT,"out-coast-quad":gT,"in-out-coast-quad":Yg,"in-cubic":Gg,"out-cubic":pb,"in-out-cubic":mb,"in-coast-cubic":_T,"out-coast-cubic":yT,"in-out-coast-cubic":vT,"in-quart":jg,"out-quart":fb,"in-out-quart":hT,"in-coast-quart":bT,"out-coast-quart":wT,"in-out-coast-quart":xT,"in-quint":Wg,"out-quint":gb,"in-out-quint":uT,"in-coast-quint":CT,"out-coast-quint":TT,"in-out-coast-quint":ST,"in-sine":Qg,"out-sine":_b,"in-out-sine":dT,"in-expo":Zg,"out-expo":au,"in-out-expo":pT,"in-circ":Xg,"out-circ":yb,"in-out-circ":mT,"quad-in":Tp,"quad-out":qg,"quad-in-out":cT,"quad-in-coast":fT,"quad-out-coast":gT,"quad-in-out-coast":Yg,"cubic-in":Gg,"cubic-out":pb,"cubic-in-out":mb,"cubic-in-coast":_T,"cubic-out-coast":yT,"cubic-in-out-coast":vT,"quart-in":jg,"quart-out":fb,"quart-in-out":hT,"quart-in-coast":bT,"quart-out-coast":wT,"quart-in-out-coast":xT,"quint-in":Wg,"quint-out":gb,"quint-in-out":uT,"quint-in-coast":CT,"quint-out-coast":TT,"quint-in-out-coast":ST,"sine-in":Qg,"sine-out":_b,"sine-in-out":dT,"expo-in":Zg,"expo-out":au,"expo-in-out":pT,"circ-in":Xg,"circ-out":yb,"circ-in-out":mT,ease:s=>hm.ease(s),"ease-in":s=>hm.easeIn(s),"ease-out":s=>hm.easeOut(s),"ease-in-out":s=>hm.easeInOut(s)};function Vt(s,e,t=PN,i=e){i!==e&&i.copyFrom(e),i.computeUp(s.state.viewingMode);let r=!1;for(let o=0;o<MN;o++){let l=0;for(const c of SN)if(xp(t.selection,c.type)){const h=Math.abs(c.error(s,i,t));c.apply(s,i,t)&&(r=!0,l+=h)}if(l===0)break}const n=xp(t.selection,8),a=CN(t.interactionType,s);return n&&yu(s,i,a)&&(r=!0),r&&i.computeUp(s.state.viewingMode),r}function CN(s,e){switch(s){case 4:return 1;case 5:return e.state.isGlobal?2:1;default:return 0}}function Er(s){const e=Math.min(1,s/150);return mb(e)}function TN(s,e,t){return _1(s,e,t)*e.distance}const SN=[{type:1,error:TN,apply:GO},{type:2,error:m1,apply:WB},{type:4,error:f1,apply:iN}],PN=new gr,MN=5;let PT=class{get pitch(){return this._pitch}get yaw(){return this._yaw}get distance(){return this._distance}get fov(){return this._fov}get size(){return this._size}constructor(e){this.viewingMode=e,this.center=x(),this._pitch=0,this._yaw=0,this._distance=0,this.direction=Sn(MT),this._fov=55,this._size=1}pixelsPerPanAtZoom(e){return this._size/2/(this._zoomToPanScale*e)}zoomAtPixelsPerPan(e){return this._size/2/(this._zoomToPanScale*e)}pixelsPerRotate(){const e=Math.max(Math.cos(Math.abs(this._pitch)),.5);return this._size/2/e}compareTo(e,t){if(this.viewingMode===1){const n=(fe(this.center)+fe(e.center))/2;t.pan=O_(this.center,e.center)*n}else t.pan=Ht(this.center,e.center);let i=Math.abs(e._yaw-this._yaw);i>=Math.PI&&(i=2*Math.PI-i);const r=Math.abs(e._pitch-this._pitch);t.rotate=Math.max(i,r),t.fov=e.fov-this.fov,t.sourceZoom=this._distance,t.targetZoom=e._distance}interpolate(e,t,i){this.viewingMode===1?N5(e.center,t.center,i.pan,this.center):kt(this.center,e.center,t.center,i.pan),this._distance=isFinite(t.distance)?Me(e.distance,t.distance+i.zoomOffset,i.zoom):e.distance,this._pitch=Me(e.pitch,t.pitch,i.rotate);let r=e._yaw;const n=t._yaw;Math.abs(n-r)>=Math.PI&&(r+=2*(r<n?1:-1)*Math.PI),this._yaw=Me(r,n,i.rotate),this._fov=Me(e.fov,t.fov,i.fov)}copyFrom(e){q(this.center,e.center),this._pitch=e.pitch,this._yaw=e.yaw,this._distance=e.distance,q(this.direction,e.direction),this._size=e.size,this._fov=e.fov,this._zoomToPanScale=Math.atan(.5*this._fov),this.viewingMode=e.viewingMode}copyFromRenderCamera(e){const t=this._lookAtOrientation(e.center,$T);q(this.center,e.center),he(Li,e.center,e.eye),fn(Li,Li,t),fn(ro,e.up,t),this._distance=fe(Li),this._distance!==0&&(Li[0]/=this._distance,Li[1]/=this._distance,Li[2]/=this._distance),this._pitch=$N(Li),this._yaw=RN(Li,ro),this._size=Math.sqrt(e.width*e.width+e.height*e.height),this._fov=e.fov,this._zoomToPanScale=Math.atan(.5*this._fov)}copyToRenderCamera(e){const t=this._lookAtOrientation(this.center,$T);qp(t,t),this._axisAngleVec3(qf,this._pitch-Math.PI/2,MT,Li),this._axisAngleVec3(zl,this._yaw,Li,Li),this._axisAngleVec3(qf,this._pitch-Math.PI/2,zl,ro),this._axisAngleVec3(zl,this._yaw,ro,ro),ee(Li,Li,this._distance),fn(Li,Li,t),fn(ro,ro,t),e.center=this.center,e.eye=he(Li,this.center,Li),e.up=ro,e.fov=this._fov}_axisAngleVec3(e,t,i,r){const n=Math.cos(t),a=Math.sin(t);return ee(Js,i,n),ti(Us,e,i),ee(Us,Us,a),ee(so,e,(1-n)*We(e,i)),ce(r,ce(r,Js,Us),so)}_lookAtOrientation(e,t=Pn()){return this._upAtLookAt(e,so),ti(Js,this.direction,so),pe(Js,Js),Js[0]===0&&Js[1]===0&&Js[2]===0&&q(Js,qf),ti(Us,so,Js),pe(Us,Us),t[0]=Js[0],t[1]=Us[0],t[2]=so[0],t[3]=Js[1],t[4]=Us[1],t[5]=so[1],t[6]=Js[2],t[7]=Us[2],t[8]=so[2],t}_upAtLookAt(e,t){return this.viewingMode===2?q(t,zl):pe(t,e)}};function $N(s){return Math.PI-O_(zl,s)}function RN(s,e){const t=ON;return Math.abs(e[2])<.5?(q(t,e),s[2]>0&&ee(t,t,-1)):q(t,s),ti(Us,t,zl),pe(Us,Us),O_(qf,Us,zl)}const Js=x(),Us=x(),so=x(),Li=x(),ro=x(),ON=x(),zl=_F,MT=fF,qf=gF,$T=Pn();let DN=class{constructor(){this.pan=0,this.rotate=0,this.fov=0,this.sourceZoom=0,this.targetZoom=0}};const Kg={desiredScreenFlow:2,minDuration:$e(500),maxDuration:$e(8e3)};let EN=class WO{constructor(e){this._createCamera=e,this.compared=new DN,this.segmentStart=0,this.segmentEnd=1,this.settings={desiredScreenFlow:Kg.desiredScreenFlow},this.source=e(),this.target=e()}clone(){const e=new WO(this._createCamera);return e.copyFrom(this),e}copyFrom(e){this.update(e.source,e.target,e.settings)}update(e,t,i){this.source!==e&&this.source.copyFrom(e),this.target!==t&&this.target.copyFrom(t),this.source.compareTo(this.target,this.compared),this.settings.desiredScreenFlow=i.desiredScreenFlow??Kg.desiredScreenFlow,this.desiredPixelFlow=this.settings.desiredScreenFlow*this.target.size,this.halfWindowSize=this.target.size/2}halfWindowPanAtZoom(e){const t=this.target.pixelsPerPanAtZoom(e);return this.halfWindowSize/t}get hasZoom(){return Math.abs(this.compared.sourceZoom-this.compared.targetZoom)>1e-5}get hasPan(){return this.compared.pan>my()}get hasFov(){return Math.abs(this.compared.fov)>my()}get hasRotate(){return this.compared.rotate>my()}},AN=class{constructor(){this.pan=0,this.rotate=0,this.zoom=0,this.fov=0,this.zoomOffset=0}},IN=class{constructor(){this.segments=new Array}get time(){return this.segments.reduce((e,t)=>Zi(e+t.time),Zi(0))}interpolateComponentsAt(e,t){e=Math.min(Math.max(e,0),1),e*=this.time;let i=0,r=0;const n=this.definition,a=this.segments.reduce((o,l)=>o||l.definition.hasZoom,!1);for(let o=0;o<this.segments.length;o++){const l=this.segments[o],c=l.definition;if(e<=l.time||o===this.segments.length-1){if(this.segmentInterpolateComponentsAt(l,l.time===0?0:e/l.time,t),n.hasPan&&!isNaN(t.pan)&&isFinite(n.compared.pan)?t.pan=(i+c.compared.pan*t.pan)/n.compared.pan:t.pan=1,n.hasRotate&&!isNaN(t.rotate)&&isFinite(n.compared.rotate)?t.rotate=(r+c.compared.rotate*t.rotate)/n.compared.rotate:t.rotate=1,a&&!isNaN(t.zoom)&&isFinite(c.compared.targetZoom)){const{sourceZoom:h,targetZoom:d}=c.compared,m=t.zoom*(d-h)+h,f=this.segments[0].definition.compared.sourceZoom,g=this.segments[this.segments.length-1].definition.compared.targetZoom,_=Math.abs(d-f)>Math.abs(h-f)?d:h;t.zoomOffset=_-g,t.zoom=(m-f)/(_-f)}else t.zoom=1;return t}e-=l.time,i+=c.compared.pan,r+=c.compared.rotate}}segmentInterpolateComponentsAt(e,t,i){e.interpolateComponentsAt(t,i)}},By=class{get time(){return this._time}constructor(e){e&&this.update(e)}update(e){e&&(this.definition?this.definition.copyFrom(e):this.definition=e.clone()),this._updatePrecomputedVariables(),this._updatePixelFlow()}_updatePrecomputedVariables(){const e=this.definition,t=e.compared,i=t.sourceZoom,r=t.targetZoom;this._zoomSign=i>r?1:-1,this._panPixelsAtSource=t.pan*e.source.pixelsPerPanAtZoom(i);const n=(e.source.pixelsPerRotate()+e.target.pixelsPerRotate())/2;this._rotatePixels=t.rotate*n}_updatePixelFlow(){const e=this.definition.compared.sourceZoom,t=this.definition.compared.targetZoom,{hasZoom:i,hasPan:r,hasRotate:n}=this.definition;let a=0,o=0;i&&(r&&(a=(t/e-1)/(-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2*this._panPixelsAtSource)),n&&(o=this._zoomSign*(Math.log(e/t)/Math.LN2)*this.definition.halfWindowSize/this._rotatePixels)),this._zoomPixelFlow=0,this._panPixelFlow=0,this._rotatePixelFlow=0;const l=this.definition.desiredPixelFlow;if(i&&r&&n){const c=a+o+a*o;this._zoomPixelFlow=a*o/c*l,this._panPixelFlow=o/c*l,this._rotatePixelFlow=a/c*l}else if(i&&r){const c=1+a;this._zoomPixelFlow=a/c*l,this._panPixelFlow=1/c*l}else if(i&&n){const c=1+o;this._zoomPixelFlow=o/c*l,this._rotatePixelFlow=1/c*l}else if(r&&n){const c=this._panPixelsAtSource/this._rotatePixels,h=1+c;this._panPixelFlow=c/h*l,this._rotatePixelFlow=1/h*l}else r?this._panPixelFlow=l:i?this._zoomPixelFlow=l:n&&(this._rotatePixelFlow=l);if(this._time=Zi(Math.max(this.rotateTime,this.zoomTime,this.panTime)),this.fovTime>this._time){const c=this.fovTime/this._time;this._time=this.fovTime,this._zoomPixelFlow/=c,this._panPixelFlow/=c,this._rotatePixelFlow/=c}}get rotateTime(){return this.definition.hasRotate?Zi(this._rotatePixels/this._rotatePixelFlow):Zi(0)}get zoomTime(){return this.definition.hasZoom?Zi(this._zoomSign*(Math.log(this.definition.compared.sourceZoom/this.definition.compared.targetZoom)/Math.LN2)*this.definition.halfWindowSize/this._zoomPixelFlow):Zi(0)}get fovTime(){return this.definition.hasFov?Zi(Math.abs(this.definition.compared.fov)/LN):Zi(0)}get panTime(){if(!this.definition.hasPan)return Zi(0);if(this.definition.hasZoom){const e=-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2,t=e*this._panPixelsAtSource;return Zi(Math.log(t*(this._zoomPixelFlow/this._panPixelFlow)+1)/(e*this._zoomPixelFlow))}return Zi(this._panPixelsAtSource/this._panPixelFlow)}_interpolateComponentsZoom(e){if(e===0||e===1)return e;if(this.definition.hasZoom){const t=this.definition.compared.sourceZoom,i=this.definition.compared.targetZoom;return(t*(t/i)**-e-t)/(i-t)}return e}_interpolateComponentsFov(e){if(e===0)return this.definition.segmentStart;if(e===1)return this.definition.segmentEnd;if(this.definition.hasFov){const{segmentStart:t,segmentEnd:i}=this.definition;return t+e*(i-t)}return this.definition.segmentStart}_interpolateComponentsPan(e){if(e===0||e===1)return e;if(this.definition.hasPan&&this.definition.hasZoom){const t=-1/(this._zoomSign*this.definition.halfWindowSize)*this._zoomPixelFlow;return 1/this._panPixelsAtSource*(this._panPixelFlow*(2**(t*e*this._time)-1))/(t*Math.LN2)}return e}_interpolateComponentsRotate(e){return e}interpolateComponentsAt(e,t){e=Math.min(Math.max(e,0),1),t.zoom=this._interpolateComponentsZoom(e),t.pan=this._interpolateComponentsPan(e),t.rotate=this._interpolateComponentsRotate(e),t.zoomOffset=0,t.fov=this._interpolateComponentsFov(e)}};const LN=rt(45);function FN(s,e,t){const i=e-s.compared.sourceZoom,r=s.halfWindowPanAtZoom(i);return-s.halfWindowSize*(t.ascensionFactor*Math.LN2*s.compared.pan+r)*Math.log(s.compared.sourceZoom/e)/(s.desiredPixelFlow*Math.LN2*r)}function VN(s,e,t){const i=1/e,r=Math.log(s.compared.sourceZoom*i),n=1/s.desiredPixelFlow,a=1/Math.LN2,o=e-s.compared.sourceZoom,l=1/o,c=(t.ascensionFactor*Math.LN2*s.compared.pan+s.halfWindowPanAtZoom(o))/s.halfWindowPanAtZoom(1);return s.halfWindowSize*i*n*a*l*c-s.halfWindowSize*r*n*a*l+s.halfWindowSize*r*n*a*c/(o*o)}function kN(s,e,t){const i=e-s.compared.sourceZoom,r=1/i,n=1/e,a=Math.log(s.compared.sourceZoom*n),o=(t.ascensionFactor*Math.LN2*s.compared.pan+s.halfWindowPanAtZoom(i))/s.halfWindowPanAtZoom(1);return s.halfWindowSize*r*(-2*r*n*o+2*r*a+2*n-2*a*o/(i*i)-o/(e*e))/(s.desiredPixelFlow*Math.LN2)}function zN(s,e){return-s.halfWindowSize*Math.log(s.compared.sourceZoom/e)/(s.desiredPixelFlow*Math.LN2)}function BN(s,e){return s.halfWindowSize/(e*s.desiredPixelFlow*Math.LN2)}function NN(s,e){return-s.halfWindowSize/(e*e*s.desiredPixelFlow*Math.LN2)}function UN(s,e,t){return-s.compared.pan*s.halfWindowSize*(t.ascensionFactor+t.descensionFactor-1)/(s.desiredPixelFlow*s.halfWindowPanAtZoom(e))}function HN(s,e,t){return s.compared.pan*s.halfWindowSize*(t.ascensionFactor+t.descensionFactor-1)/(s.desiredPixelFlow*s.halfWindowPanAtZoom(e*e))}function qN(s,e,t){return-2*s.compared.pan*s.halfWindowSize*(t.ascensionFactor+t.descensionFactor-1)/(s.desiredPixelFlow*s.halfWindowPanAtZoom(e*e*e))}function GN(s,e,t){return s.halfWindowSize*(-s.halfWindowPanAtZoom(e)-t.descensionFactor*Math.LN2*s.compared.pan+s.halfWindowPanAtZoom(s.compared.targetZoom))*Math.log(e/s.compared.targetZoom)/(s.desiredPixelFlow*Math.LN2*s.halfWindowPanAtZoom(-e+s.compared.targetZoom))}function jN(s,e,t){const i=Math.log(e/s.compared.targetZoom),r=1/s.desiredPixelFlow,n=1/Math.LN2,a=-e+s.compared.targetZoom,o=1/a,l=(-s.halfWindowPanAtZoom(e)-t.descensionFactor*Math.LN2*s.compared.pan+s.halfWindowPanAtZoom(s.compared.targetZoom))/s.halfWindowPanAtZoom(1);return-s.halfWindowSize*i*r*n*o+s.halfWindowSize*i*r*n*l/(a*a)+s.halfWindowSize*r*n*o*l/e}function WN(s,e,t){const i=e-s.compared.targetZoom,r=1/i,n=1/e,a=Math.log(e/s.compared.targetZoom),o=(s.halfWindowPanAtZoom(e)+t.descensionFactor*Math.LN2*s.compared.pan-s.halfWindowPanAtZoom(s.compared.targetZoom))/s.halfWindowPanAtZoom(1);return s.halfWindowSize*r*(-2*r*n*o-2*r*a+2*n+2*a*o/(i*i)-o/(e*e))/(s.desiredPixelFlow*Math.LN2)}function QN(s,e){return s.halfWindowSize*Math.log(e/s.compared.targetZoom)/(s.desiredPixelFlow*Math.LN2)}function ZN(s,e){return s.halfWindowSize/(e*s.desiredPixelFlow*Math.LN2)}function XN(s,e){return-s.halfWindowSize/(e*e*s.desiredPixelFlow*Math.LN2)}function YN(s){const e=s.compared.sourceZoom-s.compared.targetZoom;if(e===0)return s.compared.pan*s.halfWindowSize/(s.desiredPixelFlow*s.halfWindowPanAtZoom(s.compared.sourceZoom));const t=Math.LN2*s.compared.pan,i=e,r=s.halfWindowPanAtZoom(i),n=s.halfWindowSize*Math.log(s.compared.sourceZoom/s.compared.targetZoom)/(s.desiredPixelFlow*Math.LN2*r);return s.compared.sourceZoom<=s.compared.targetZoom?n*(t-r):n*(t+r)}function KN(s,e){let t=JN(s,e);const i={ascensionFactor:e.ascensionFactor!=null?e.ascensionFactor:.5,descensionFactor:e.descensionFactor!=null?e.descensionFactor:.5},r=i.ascensionFactor===0,n=i.descensionFactor===0,a=r?zN:FN,o=r?BN:VN,l=r?NN:kN,c=n?QN:GN,h=n?ZN:jN,d=n?XN:WN,m=C=>a(s,C,i)+UN(s,C,i)+c(s,C,i),f=C=>o(s,C,i)+HN(s,C,i)+h(s,C,i),g=C=>l(s,C,i)+qN(s,C,i)+d(s,C,i);let _=m(t);const v=YN(s);let b;const T=e.maximumIterations||20,w=e.maximumDistance!=null?e.maximumDistance:1/0;for(b=0;b<T;b++){const C=e.desiredSlope??1e-6;let P=f(t);Math.abs(P)>C&&(P+=C);const M=P/g(t);if(isNaN(M)||t>=w&&M<0){if(!isFinite(w))return null;t=w,_=m(t);break}if(t-=M,t<=s.compared.sourceZoom||t<=s.compared.targetZoom)return null;const O=m(t);if(Math.abs(O-_)/_<=.005)break;_=O}return isNaN(_)||_>v*(1-.3)||t<=s.compared.sourceZoom||t<=s.compared.targetZoom?null:t}function JN(s,e){const t=Math.max(s.compared.sourceZoom,s.compared.targetZoom),i=s.source.zoomAtPixelsPerPan(s.desiredPixelFlow/s.compared.pan)/2;return i<t?e.maximumDistance!=null?t+(e.maximumDistance-t)/2:1.5*t:e.maximumDistance?Math.min(e.maximumDistance,i):i}let eU=class extends IN{constructor(e,t){super(),this._preallocSegments=[new By,new By,new By],this._ascensionSegment=null,this._descensionSegment=null,this.update(e,t)}update(e,t){if(!e)return;this.definition?this.definition.copyFrom(e):this.definition=e.clone();const i=t?.apex?KN(e,t.apex):null;this.segments.length=0,this._ascensionSegment=null,this._descensionSegment=null,i?this._updateWithApex(i,t?.apex):this._updateWithoutApex()}segmentInterpolateComponentsAt(e,t,i){e.interpolateComponentsAt(t,i),e===this._ascensionSegment?i.zoom=qg(i.zoom):e===this._descensionSegment&&(i.zoom=Tp(i.zoom))}_updateWithApex(e,t){const[i,r,n]=this._preallocSegments,a=t?.ascensionFactor??.5,o=Math.min(1-a,t?.ascensionFactor!=null&&t.descensionFactor!=null?t.descensionFactor:.5),l=1-a-o;i.definition?i.definition.copyFrom(this.definition):i.definition=this.definition.clone(),i.definition.compared.targetZoom=e,i.definition.compared.pan=this.definition.compared.pan*a,i.definition.compared.rotate=this.definition.compared.rotate*a,i.definition.segmentEnd=a,i.update(),this._ascensionSegment=i,this.segments.push(i),l>0&&(r.definition?r.definition.copyFrom(this.definition):r.definition=this.definition.clone(),r.definition.copyFrom(this.definition),r.definition.compared.sourceZoom=e,r.definition.compared.targetZoom=e,r.definition.compared.pan=this.definition.compared.pan*l,r.definition.compared.rotate=this.definition.compared.rotate*l,r.definition.segmentStart=i.definition.segmentEnd,r.definition.segmentEnd=i.definition.segmentEnd+l,r.update(),this.segments.push(r)),n.definition?n.definition.copyFrom(this.definition):n.definition=this.definition.clone(),n.definition.compared.sourceZoom=e,n.definition.compared.pan=this.definition.compared.pan*o,n.definition.compared.rotate=this.definition.compared.rotate*o,n.definition.segmentStart=a+l,n.update(),this._descensionSegment=n,this.segments.push(n)}_updateWithoutApex(){const[e]=this._preallocSegments;e.update(this.definition),this.segments.push(e)}};const tU=new AN;let iU=class{get time(){return this._time}get isLinear(){return this.path.segments.length===1}constructor(e){this._time=$e(0),this._easing=Yg,this.definition=new EN(e),this.path=new eU}update(e,t,i){this.definition.update(e,t,i),this.path.update(this.definition,i),this._time=this._applyTimeSettings(kM(isFinite(this.path.time)?this.path.time:Zi(0)),i),this._easing=i.easing??(this._time>=1e3?Yg:au)}cameraAt(e,t){e=Math.min(Math.max(0,e),1),e=this._normalizedEasing(e);const i=this.path.interpolateComponentsAt(e,tU);t.interpolate(this.definition.source,this.definition.target,i)}_normalizedEasing(e){const t=this._easing(0,this._time),i=this._easing(1,this._time);return(this._easing(e,this._time)-t)/(i-t)}_applyTimeSettings(e,t){const i=t.speedFactor!=null?t.speedFactor:1,r=t.minDuration??Kg.minDuration/i,n=t.maxDuration??Kg.maxDuration/i;return e=t.duration!=null?$e(t.duration):$e(Math.min(Math.max(e/i,r),n))}},sU=class{get finished(){return this.currentTime>=this._animation.time}get time(){return this._animation.time}constructor(e){this.currentTime=$e(0),this._animation=new iU(()=>new PT(e)),this._current=new PT(e)}update(e,t,i){const{source:r,target:n}=this._animation.definition,a=he(rU,t.center,e.center),o=fe(a);o>=1e-5?(a[0]/=o,a[1]/=o,a[2]/=o):(a[0]=0,a[1]=1,a[0]=0),q(r.direction,a),q(n.direction,a),r.copyFromRenderCamera(e),n.copyFromRenderCamera(t),this._current.copyFrom(r),this._animation.update(r,n,i),this.currentTime=$e(0),e.almostEquals(t)&&(this.currentTime=this._animation.time)}cameraAt(e,t){this._animation.cameraAt(e,this._current),this._current.copyToRenderCamera(t)}step(e,t){this.finished||(this.currentTime=$e(this.currentTime+kM(e)),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,t)}};const rU=x();let Ea=class extends te{constructor(e){super(e),this.state=0}get running(){return this.state===2}get isInteractive(){return!1}get canStop(){return!1}stopController(){return!!this.destroyed||!!this.canStop&&(this.state=3,!0)}finishController(){this.state=4}};u([p({constructOnly:!0})],Ea.prototype,"view",void 0),u([p({readOnly:!0})],Ea.prototype,"running",null),u([p()],Ea.prototype,"state",void 0),u([p({readOnly:!0})],Ea.prototype,"isInteractive",null),Ea=u([R("esri.views.3d.state.controllers.CameraController")],Ea);let Sp=class extends Ea{constructor(){super(...arguments),this._asyncResult=null}get canStop(){return!0}set asyncResult(e){this._asyncResult&&(this._asyncResult.reject(Bi()),this._asyncResult=null),this.state===4||this.state===3?(zM(e),this.state===4?e.resolve():e.reject(Bi())):this._asyncResult=e}get asyncResult(){return this._asyncResult}onControllerStart(){this.state=2,this.viewAnimation!=null&&this.viewAnimation.when(()=>this.updateStateFromViewAnimation(),()=>this.updateStateFromViewAnimation())}updateStateFromViewAnimation(){!this.viewAnimation||this.state!==0&&this.state!==2||(this.viewAnimation.state===ru.state.FINISHED?this.finish():this.viewAnimation.state===ru.state.STOPPED&&(this.state=3))}onControllerEnd(e){this.viewAnimation==null||this.viewAnimation.done||(this.state===4?this.viewAnimation.finish():this.state===3&&this.viewAnimation.stop()),this._asyncResult&&(this.state===4?this._asyncResult.resolve():this._asyncResult.reject(Bi()))}finish(){this.finishController()}};Sp=u([R("esri.views.3d.state.controllers.AnimationController")],Sp);let Bl=class extends Sp{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.type="point-to-point",this.mode="interaction"}initialize(){this.animation=new sU(this.view.state.viewingMode),this.viewAnimation=this.mode==="interaction"?null:new ru}get isInteractive(){return this.mode==="interaction"}begin(e,t){this.stepController=(n,a)=>{this.animation.step(n,a),this.animation.finished&&this.finishController()};const i=this.animationSettings(t);gd.copyFrom(this.view.state.camera);const r=new Ur(this.view.state.viewingMode);this._intersectionHelper.intersectRay(gd.ray,r,RT)&&(gd.center=RT),this.animation.update(gd,e,i),this.animation.finished&&this.finish()}finish(){this.animation.currentTime=this.animation.time,super.finish()}onControllerEnd(e){this.stepController&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,e),this.animation.currentTime=this.animation.time),super.onControllerEnd(e),this.stepController=void 0}animationSettings(e={}){return{apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0},...e,easing:typeof e.easing=="string"?xN[e.easing]:e.easing}}};u([p({constructOnly:!0})],Bl.prototype,"mode",void 0),u([p({readOnly:!0})],Bl.prototype,"isInteractive",null),Bl=u([R("esri.views.3d.state.controllers.PointToPointAnimationController")],Bl);let gd=new vt;const RT=x();function nU(){gd=new vt}function OT(s){return s!=null&&"type"in s&&s.type==="point-to-point"}function B_(s=oU){return[s[0],s[1],s[2],s[3]]}function Pp(s,e){return aU(s[0],s[1],s[2],e,MV.get())}function aU(s,e,t,i,r=B_()){return r[0]=s,r[1]=e,r[2]=t,r[3]=i,r}function y1(s,e,t){return ti(t,s,e),pe(t,t),t[3]=aR(s,e),t}const oU=[0,0,1,0];function gre(s,e,t=Go()){return v1(s,mn(e),t),pe(t.direction,t.direction),t}function v1(s,e,t){return lU(s,s.screenToRender(e,Zh(yt.get())),t)}function lU(s,e,t){if(e==null)return null;const i=Zh(pr(yt.get(),e));if(i[2]=0,!s.unprojectFromRenderScreen(i,t.origin))return null;const r=Zh(pr(yt.get(),e));r[2]=1;const n=s.unprojectFromRenderScreen(r,yt.get());return n==null?null:(he(t.direction,n,t.origin),t)}function vu(s,e,t){return b1(s,s.screenToRender(e,Zh(yt.get())),t)}function b1(s,e,t){q(t.origin,s.eye);const i=be(yt.get(),e[0],e[1],1),r=s.unprojectFromRenderScreen(i,yt.get());return r==null?null:(he(t.direction,r,t.origin),t)}function w1(s,e,t,i){const r=vu(e,t,cU);return D_(s,r,i)}const cU=Go(),QO=30,Jg=[1,3e8],ZO=8,e_=[200,1508e5],XO=5,YO=50,hU=5,uU=10,Qp=80,Ny=90,No=1e-6,mc={exclude:new Set([Ao])};function Zl(s,e,t){return t[0]=e[0]/(s.fullWidth/s.pixelRatio),t[1]=e[1]/(s.fullHeight/s.pixelRatio),t}function vb(s){for(;s>Math.PI;)s-=2*Math.PI;for(;s<-Math.PI;)s+=2*Math.PI;return s}function Uo(s,e,t){const i=Vo($V.get(),t[3],t);i==null||K5(i,_n)||(he(at,s.eye,e),ot(at,at,i),s.eye=ce(at,at,e),he(at,s.center,e),ot(at,at,i),s.center=ce(at,at,e),s.up=ot(at,s.up,i))}function dU(s,e,t,i){return zw(s,v1(e,t,T1),i)}function bb(s,e,t,i){return zw(s,vu(e,t,T1),i)}function x1(s,e,t,i){const r=yt.get();let n=1-t;he(r,e,s.eye);const a=fe(r);let o=a*(1-n);n>=0&&o<i&&(o=i,n=-(o-a)/a),Math.abs(a-o)<No||(ee(r,r,n),s.eye=ce(at,s.eye,r),s.center=kt(at,s.center,e,n))}function KO(s,e,t){e.getScreenCenter(DT),w1(s,e,DT,at)&&(e.center=at);const i=e.distance,r=i*t;if(Math.abs(i-r)<No)return;const n=ee(yt.get(),e.viewForward,r);e.eye=he(at,e.center,n)}const DT=ii();function Uy(s,e){be(e,0,0,0);for(const t of s)ce(e,e,t);ee(e,e,1/s.length)}function Gf(s,e,t,i){return Math.sin(s/fe(e))*(t+i.radius)}function ET(s,e,t,i){return Gf(Math.PI/2,e,t,i)+(s-Math.PI/2)}const AT={Elevation:3e4,Angle:rt(16)},JO=rt(80);function eD(s,e,t,i,r,n){const a=x(),o=Xs();let l=!0,c=!0;return s.intersectScreen(t,a,n)?o[3]=fe(a):(c=!1,e.aboveGround&&r!==0?o[3]=Math.max(fe(e.center),.9*i):o[3]=fe(e.eye)-e.relativeElevation,r===1?Mp(o,e,t,a):l=w1(o,e,t,a)),{sphere:o,scenePickPoint:l?a:null,hasGeometryIntersection:c}}function Zp(s,e,t,i){const r=s.relativeElevation;if(r>AT.Elevation&&i==="global")return 1;vu(s,e,qy);const n=Math.sign(r),a=t.worldUpAtPosition(s.eye,at);return-n*We(a,qy.direction)<Math.sin(AT.Angle)*fe(qy.direction)?0:1}function tD(s,e,t){he(Hy,t,e),s.eye=he(at,s.eye,Hy),s.center=he(at,s.center,Hy)}const Hy=x();function Mp(s,e,t,i){const r=vu(e,t,T1);return r!=null&&(E_(s,r,Tm),D_(s,r,i)?!($o(Tm,r.origin)<$o(i,r.origin))||(q(i,Tm),!1):(he(Mc,e.eye,e.center),pe(Mc,Mc),q$(Mc,-We(pe(Mc,Mc),Tm),IT),zw(IT,r,i),!1))}const Tm=x(),Mc=x(),IT=Ha();function iD(s,e,t,i,r,n){let a=0;if(ti(s_,s,e),he($m,s,e),fe(s)<=r||!i.aboveGround){ti(t,$m,i.eye);const o=We(s,e)/(fe(s)*fe(e));if(o<.9999)a=Ua(o);else{const c=fe(ti(x(),s,e))/(fe(s)*fe(e));a=lp(c)}const l=Math.cos(U(ko.normalize(rt(n)),0,JO));a=-a-Math.max(0,fe(e)-r)/(l*r)}else he(LT,i.eye,i.center),ti(t,$m,LT),a=-fe($m)/r;return pe(t,t),ee(t,t,fe(s_)),a}const LT=x();function FT(s,e,t,i){let r,n;const a=Math.cos(U(ko.normalize(rt(i)),0,JO));return r=e>t?-(e-t)/(a*t):e<-t?Math.PI-(e+t)/(a*t):Ua(e/t),n=s>t?-(s-t)/(a*t):s<-t?Math.PI-(s+t)/(a*t):Ua(s/t),(n-r)*t}function pU(s,e,t,i,r,n,a,o,l,c){const h=FT(s[2],e[2],n[3],o),d=l?FT(s[0],e[0],n[3],180):e[0]-s[0],m=Math.sin(a)*d-Math.cos(a)*h,f=Math.cos(a)*d+Math.sin(a)*h;pe(at,r);const g=l?m/Math.sqrt(Math.abs(n[3]**2-We(t,at)**2)):m/n[3],_=f/Math.sqrt(Math.abs(n[3]**2-We(t,i)**2));Xi(c,g,_)}function sD(s,e,t,i,r,n,a,o,l,c){ti(s_,s,e),O0(n.up,n.eye,Sm,Pm,Mm),O0([0,0,1],n.eye,ka,Ro,oD),q(t,Ro),q(i,ka),pe(t,t),ee(t,t,fe(s_)),eC(s,pe(Pm,Pm),pe(Mm,Mm),pe(Sm,Sm),VT),eC(e,Pm,Mm,Sm,kT),pU(VT,kT,s,ka,Ro,a,o,l,c,r)}function mU(s,e,t,i,r,n,a){Vo(t_,r,i),Vo(i_,a,n),as(Ph,t_,i_),he(e,s,t),ot(e,e,Ph),ce(e,e,t)}function rD(s,e,t,i,r,n){Vo(t_,i,t),Vo(i_,n,r),as(Ph,t_,i_),he(at,s.eye,e),ot(at,at,Ph),s.eye=ce(at,at,e),he(at,s.center,e),ot(at,at,Ph),s.center=ce(at,at,e),he(at,s.up,e),ot(at,at,Ph),s.up=ce(at,at,e)}const Ko={Pole:.95,Angle:rt(18),Tilt:45,TiltHysteresisMargin:1e-7};let $c=!1;function C1(s,e,t,i,r,n){const a=Math.abs(i)>Math.PI-Ko.Angle||Math.abs(i)<Ko.Angle,o=(Math.abs(s[2])<t*Ko.Pole||Math.abs(e)>t)&&n;return a&&o?!$c&&r<Ko.Tilt-Ko.TiltHysteresisMargin?$c=!0:$c&&r>Ko.Tilt+Ko.TiltHysteresisMargin&&($c=!1):$c=!1,$c}function nD(s,e,t,i,r,n){if(n)y1(t,i,zT),Uo(e,Hi(s),zT);else{const a=iD(t,i,BT,e,s[3],r);Uo(e,Hi(s),Pp(BT,a))}}function aD(s,e,t,i,r,n,a){const o=a?20:1,l=1e-12;let c,h;q(Jo,i),_d.copyFrom(e);for(let d=0;d<o&&$o(t,Jo)>l&&(c=$o(t,Jo),sD(t,Jo,Ro,ka,Au,_d,s,r,n,a),rD(_d,Hi(s),ka,Au[1],Ro,Au[0]),mU(Jo,Jo,Hi(s),ka,Au[1],Ro,Au[0]),h=$o(t,Jo),h<c||d===0);d++)e.copyFrom(_d)}function fU(s,e,t,i,r,n,a){C1(t,We(e.up,t),s[3],-ko.normalize(rt(r)),n,e.aboveGround)?aD(s,e,t,i,-ko.normalize(rt(r)),n,a):nD(s,e,t,i,n,a)}function gU(s,e,t,i,r,n){const{eye:a}=s;O0([0,0,1],a,ka,Ro,oD);const o=e.translation[0]*t.pan,l=r.mode==="zoom"?0:e.translation[1]*t.pan,c=Math.max(Math.sqrt(Math.abs(1-We(s.center,ka)**2/fe(s.center)**2)),.5),h=(Math.sin(n)*l+Math.cos(n)*o)/c,d=-Math.cos(n)*l+Math.sin(n)*o;switch(gn(i.pan.matrix,i.pan.matrix,h,ka),i.pan.enabled=!0,r.mode){case"pan":gn(i.pan.matrix,i.pan.matrix,d,Ro),i.pan.enabled=!0;break;case"zoom":i.zoom=-e.translation[1]*t.zoom}}function _U(s,e,t,i,r){const{eye:n,viewRight:a}=s,o=ti(yt.get(),a,n),l=e.translation[0]*t.pan;switch(l!==0&&(gn(i.pan.matrix,i.pan.matrix,-l,o),i.pan.enabled=!0),r.mode){case"pan":{const c=e.translation[1]*t.pan;c!==0&&(gn(i.pan.matrix,i.pan.matrix,c,a),i.pan.enabled=!0);break}case"zoom":i.zoom=-e.translation[1]*t.zoom}}function yU(s,e,t,i,r,n,a,o,l){C1(s.center,We(s.up,s.center),fe(s.center),-ko.normalize(rt(n)),a,e.aboveGround)?gU(e,t,i,o,l,-ko.normalize(rt(r))):_U(e,t,i,o,l)}function bu(s,e,t=1/0){const i=Math.abs(We(s,e));return Math.min(t,1/i)}const ka=x(),Ro=x(),oD=x(),Sm=x(),Pm=x(),Mm=x(),VT=x(),kT=x(),Au=ke(),zT=B_(),t_=Ie(),i_=Ie(),Ph=Ie(),Jo=x(),at=x(),$m=x();let _d=new vt;const s_=x(),BT=x();function vU(){_d=new vt}const T1={origin:x(),direction:x()},qy={origin:x(),direction:x()},NT=.6,Gy=4,bU=60;let r_=class extends Bl{constructor(){super(...arguments),this._zoomLocation=x(),this._tmpCamera=new vt,this._tmpViewDir=x(),this._tmpRayDir=Go(),this._targetOnSphere=x(),this._tmpCenter=x(),this._beginCamera=new vt,this._constraintOptions=new gr(7,1,null,this._beginCamera),this._sphere=Xs()}initialize(){this._intersector=new Ur(this.view.state.viewingMode)}step(e,t){if(!this.running)return;const i=this.view.state;this.animation.finished?this._beginCamera.copyFrom(i.camera):this.animation.cameraAt(1,this._beginCamera);let r=!1,n=!1;this._intersectionHelper.intersectScreen(t,this._zoomLocation,this.view.map.ground.opacity===0?mc:{})&&(r=e>0,n=!0),this._tmpCamera.copyFrom(i.camera),r?this._intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter):this._intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:q(this._zoomLocation,this._tmpCamera.center),this._updateCamera(this._tmpCamera,e,t,n),this.begin(this._tmpCamera)}animationSettings(){return{duration:$e(600),easing:au}}_updateCamera(e,t,i,r){const n=Zp(e,i,this.view.renderCoordsHelper,this.view.viewingMode),a=Math.abs(this.view.camera.position.z),o=this._zoomLocation;pe(Om,e.eye),ee(Om,Om,-1),vu(e,i,this._tmpRayDir),pe(this._tmpRayDir.direction,this._tmpRayDir.direction);const l=U(bu(Om,this._tmpRayDir.direction,ZO)*a,e_[0],e_[1]);if(n===1){let c=NT**t;this._sphere[3]=fe(o),he(this._tmpViewDir,e.center,e.eye);const h=Math.min(fe(this._tmpViewDir),l);let d=h*c;if(c<=1&&d<Gy&&(d=Gy,c=d/h),Math.abs(h-d)<No)return;const m=fe(e.center);if(this._sphere[3]!==m){const f=this._sphere[3]+c*(m-this._sphere[3]);e.center=ee(Rm,e.center,f/m)}ee(this._tmpViewDir,this._tmpViewDir,-c),e.eye=ce(Rm,e.center,this._tmpViewDir),Vt(this.view,e,this._constraintOptions),$o(o,e.center)>1e-12&&w1(this._sphere,e,i,this._targetOnSphere)&&fU(this._sphere,e,o,this._targetOnSphere,this.view.camera.heading,this.view.camera.tilt,!0)}else{let c=NT**Math.abs(t);const h=t>0?1:-1;he(this._tmpViewDir,o,e.eye);const d=fe(this._tmpViewDir),m=this.view.stage.renderView.getMinimalDepthForArea(null,i[0],i[1],this.view.state.camera,bU);let f=m??l;r&&t>0&&(f=Math.min(f,d)),ee(this._tmpRayDir.direction,this._tmpRayDir.direction,f),ce(o,this._tmpRayDir.origin,this._tmpRayDir.direction);let g=f*c;const _=Math.max(Gy,1.01*e.nearFar[0]);if(t>0&&g<_&&(g=_,c=g/f),Math.abs(f-g)<No)return;ee(this._tmpRayDir.direction,this._tmpRayDir.direction,h*(1-c)),e.eye=ce(Rm,e.eye,this._tmpRayDir.direction),e.center=ce(Rm,e.center,this._tmpRayDir.direction),pe(this._tmpRayDir.direction,this._tmpRayDir.direction),this._constraintOptions.interactionDirection=this._tmpRayDir.direction,Vt(this.view,e,this._constraintOptions),this._constraintOptions.interactionDirection=null}yu(this.view,e)}};r_=u([R("esri.views.3d.state.controllers.ZoomStepControllerGlobal")],r_);const Rm=x(),Om=x();let jf,Wf=null;const Uh=new Map;async function yre(s){Wf==null&&(jf==null&&(jf=k(()=>import("./VoxelWasmPerSceneView-CxbjRwlS.js"),__vite__mapDeps([450,1,7,8,5,6,2,15,4,9,10,12,183,19,20,14,207,70,39,186,88,185,87,182,184,187,188,189,190,191,192,13,193,37,38,194,195,196,197,102,28,198,199,200,35,11,93,201,202,203,92,94,27,90,95,204,208,209,26,3,29,30,31,32,33,34,36,40,41,42,43,44,210,98,211,361,237,21,16,22,23,24,113,114,205,206,175,129,122,52,212,76,213,214,180,47,18,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,166,132,231,232,233,234,99,100,235,236,238,239,80,240,241,242,243,244,245,246,247,248,249,250]))),Wf=await jf);const e=s.view;let t=Uh.get(e);return t||(t=new Wf.default({view:e}),Uh.set(e,t)),t.addVoxelLayer(s)}function $p(s){return Uh.get(s)}function vre(s){const e=s.view,t=Uh.get(e);t&&t.removeVoxelLayer(s)<1&&(Uh.delete(e),Uh.size===0&&(jf=null,Wf=null))}const wU=.6,xU=4,CU=60;let n_=class extends Bl{constructor(){super(...arguments),this._zoomLocation=x(),this._tmpCamera=new vt,this._tmpRayDir=x(),this._tmpCenter=x(),this._beginCamera=new vt,this._constraintOptions=new gr(15,1,null,this._beginCamera)}step(e,t){if(!this.running)return;const i=this.view.state;this.animation.finished?this._beginCamera.copyFrom(i.camera):this.animation.cameraAt(1,this._beginCamera),this._tmpCamera.copyFrom(i.camera);const r=new Ur(this.view.state.viewingMode);let n=!1;e>0?(n=this._intersectionHelper.intersectScreenFreePointFallback(t,this._zoomLocation,this.view.basemapTerrain.invisible?mc:{}),this._intersectionHelper.intersectRay(this._tmpCamera.ray,r,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter)):this._intersectionHelper.intersectRay(this._tmpCamera.ray,r,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:q(this._zoomLocation,this._tmpCamera.center);const a=wU**e;let o=this.view.stage.renderView.getMinimalDepthForArea($p(this.view),t[0],t[1],this.view.state.camera,CU);he(Dm,this._tmpCamera.eye,this._zoomLocation),pe(Dm,Dm);const l=Math.abs(this.view.camera.position.z),c=U(bu(TU,Dm,ZO)*l,e_[0],e_[1]);o=o??c;const h=x();he(h,this._zoomLocation,this._tmpCamera.eye),(o<fe(h)||!n)&&(pe(h,h),ce(this._zoomLocation,this._tmpCamera.eye,ee(h,h,o))),this._updateCamera(this._tmpCamera,a,this._zoomLocation),this.begin(this._tmpCamera)}animationSettings(){return{duration:$e(600),easing:au}}_updateCamera(e,t,i){he(this._tmpRayDir,i,e.eye);const r=fe(this._tmpRayDir);let n=r*t;const a=t<=1,o=Math.max(xU,1.01*e.nearFar[0]);n!==0&&(a&&n<o&&(n=o,t=n/r),Math.abs(r-n)<No||(ee(this._tmpRayDir,this._tmpRayDir,t),e.eye=he(UT,i,this._tmpRayDir),e.center=kt(UT,e.center,i,1-t),Vt(this.view,e,this._constraintOptions)))}};n_=u([R("esri.views.3d.state.controllers.ZoomStepControllerLocal")],n_);const UT=x(),TU=Qe(0,0,1),Dm=x();function SU(s,e){switch(e){case"primary":return s.pointerType==="touch"||s.button===0;case"secondary":return s.pointerType!=="touch"&&s.button===2;case"tertiary":return s.pointerType!=="touch"&&s.button===1}}function S1(s,e){const{button:t,pointerType:i}=s;return i!=="touch"&&e.some(r=>r==="primary"&&t===0||r==="secondary"&&t===2||r==="tertiary"&&t===1)}function jy(s,{dragPrimary:e,dragSecondary:t,dragTertiary:i}){return[{key:"primary",value:e},{key:"secondary",value:t},{key:"tertiary",value:i}].filter(r=>r.value===s).map(r=>r.key)}let PU=class extends Gi{constructor(e,t){super(!0),this._view=e,this.registerIncoming("double-click",t,i=>this._handleDoubleClick(i))}_handleDoubleClick(e){const t=e.data;if(SU(t,"primary")){const i=this._view.state.isGlobal?new r_({view:this._view,mode:"animation"}):new n_({view:this._view,mode:"animation"});this._view.state.switchCameraController(i),i.step(Math.log(.5)/Math.log(.6),ii(t.x,t.y)),e.stopPropagation()}}},Qf=class extends te{constructor(e){super(e)}initialize(){this.addHandles(this.view.elevationProvider.on("elevation-change",e=>this._handleElevationChangeEvent(e)))}_handleElevationChangeEvent(e){if(this.view.state.cameraController||e.context!=="ground")return;const t=this.view.state.camera;e.spatialReference!=null&&UM(this.view,t,e.extent,e.spatialReference)&&this._applyToCurrentCamera()}_applyToCurrentCamera(){this.view.state.updateCamera(e=>yu(this.view,e,1))}};u([p({constructOnly:!0})],Qf.prototype,"view",void 0),Qf=u([R("esri.views.3d.state.SurfaceCollisionConstraint")],Qf);let yd=class extends te{constructor(e){super(e),this.nearFarHeuristic=VI(e.view.state.viewingMode,e.view.basemapTerrain,e.view.renderCoordsHelper.spatialReference)}initialize(){const e=()=>this._updateNearFar();this.addHandles([$(()=>[this.view.constraints.clipDistance.near,this.view.constraints.clipDistance.far],()=>this._clipDistanceNearFarChanged()),this.view.state.events.on("before-camera-change",({camera:t,sceneDepthRange:i})=>this._updateCameraNearFar(t,i)),$(()=>this.view.constraints.clipDistance.mode,e),$(()=>this.view.stage.renderer.sceneDepthRange.value,e,Ae),$(()=>this.view.renderDataExtent,e,Ae),$(()=>this.view.basemapTerrain.visibleElevationBounds,e,Ae),$(()=>[this.view.constraints.altitude.min,this.view.constraints.altitude.max],()=>this._updateAltitude(),Ae),$(()=>this.view.constraints.tilt.max,()=>this._updateTiltMax(),Ae),$(()=>this.view.constraints.tilt.mode,()=>this._updateTilt(),Ae),$(()=>this.view.state?.camera,()=>this._updateTiltAutoMax(),Ae),$(()=>[this.view.map?.ground?.navigationConstraint?.type,this.view.state.constraints.collision.enabled],()=>this._updateCollision(),Ae)]),this.view.state.isLocal&&this.addHandles($(()=>this.view.renderDataExtent,t=>this._updateLocalSurfaceDistance(t),Re)),this._updateNearFar(),this.view.state.viewingMode!==2&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new Qf({view:this.view}))}destroy(){this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}_clipDistanceNearFarChanged(){const e=this.view.constraints.clipDistance;e.mode!=="auto"&&this.view.state.updateCamera(t=>HT(t,e))}_updateNearFar(){this.view.state.updateCamera(e=>this._updateCameraNearFar(e))}_updateCameraNearFar(e,t){const i=this.view.constraints.clipDistance;i.mode==="manual"?HT(e,i):this._updateCameraNearFarAuto(e,i,t)}_updateCameraNearFarAuto(e,t,i=this.view.stage.renderer.sceneDepthRange.value){const r=ww(this.view,e.eye),n=this.nearFarHeuristic.compute(e,this.view.renderDataExtent,i,r);e.near=n.near,e.far=n.far,t&&t.autoUpdate(e.near,e.far)}_updateCollision(){const e=this.view.map?.ground?.navigationConstraint?.type,t=!e||e==="stay-above",i=this.view.state.constraints.collision;t!==i.enabled&&(i.enabled=t,t&&this._reapplyConstraints(8),this.view.constraints.tilt.mode==="auto"&&this._updateTiltAuto())}_updateAltitude(){const e=this.view.constraints.altitude;this.view.state.viewingMode===1?this.view.state.constraints.altitude={min:e.min,max:e.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()}_updateTiltMax(){const e=this.view.constraints.tilt;e.mode!=="auto"&&(this._updateTiltManual(e),this._reapplyConstraints())}_updateTilt(){const e=this.view.constraints.tilt;e.mode==="manual"?this._updateTiltManual(e):this._updateTiltAuto(),this._reapplyConstraints()}_updateTiltManual(e){const t=this.view.state.constraints;t.tilt=t.createConstantMaxTilt(rt(e.max))}_updateTiltAuto(){const e=this.view.state.constraints;e.tilt=e.createDefaultTilt(),this._updateTiltAutoMax()}_updateTiltAutoMax(){const e=this.view.constraints.tilt;if(e.mode!=="auto")return;const t=this.view.state.constraints;if(t.tilt){const i=t.tilt(this.view.state.camera.distance).max;e.autoUpdate(ic(i))}}_updateLocalSurfaceDistance(e){if(e==null)return;let t=Math.max(e.width,e.height);if(t<=0)return;e.zmax!=null&&e.zmin!=null&&(t=Math.max(t,e.zmax-e.zmin));const i=this.view.state,r=3*t/Math.atan(i.camera.fov/2);r!==i.constraints.distance&&(i.constraints.distance=r)}_reapplyConstraints(e=15){this.view.state.updateCamera(t=>Vt(this.view,t,new gr(e,0,null)))}};function HT(s,e){e&&(s.near=e.near,s.far=e.far)}u([p({constructOnly:!0})],yd.prototype,"view",void 0),u([p({readOnly:!0})],yd.prototype,"surfaceCollisionConstraint",void 0),yd=u([R("esri.views.3d.state.ConstraintsManager")],yd);let jd=class extends Ea{constructor(e){super(e)}set desiredCamera(e){this._set("desiredCamera",e.clone())}get canStop(){return!0}get constraintEnabled(){return this.view.state.constraints.collision.enabled}onControllerStart(){this.state=2,this.addHandles(this.view.elevationProvider.on("elevation-change",e=>this._elevationChangeEvent(e))),this._applyCorrection()}onControllerEnd(){this.removeAllHandles()}_elevationChangeEvent(e){e.spatialReference!=null&&!UM(this.view,this.desiredCamera,e.extent,e.spatialReference)||e.context!=="ground"||this._applyCorrection()}_applyCorrection(){this.view.state.updateCamera(e=>{e.copyViewFrom(this.desiredCamera),yu(this.view,e,1)||this.constraintEnabled||(this.state=3)})}};u([p({constructOnly:!0})],jd.prototype,"desiredCamera",null),jd=u([R("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],jd);const MU=.66;function lD(s){return 360-Ww.normalize(s)}function N_(s){return Ww.normalize(360-s)}function $U(s,e,t){const i=e.camera;if(i!=null)return OU(i,dc(s));const{targetGeometry:r}=e;if(r==null)return null;const{camera:n,mode:a}=cD(s,e.rotation,t);if(r.type==="point")return EU(s,e,r,n,a);const o=r.extent;return o==null?null:If(s,o,n.heading,n.tilt,a)}async function RU(s,e,t,i){const r=e.camera;if(r!=null)return DU(r,dc(s),i);const{targetGeometry:n}=e;if(n==null)throw new Error("Viewpoint has no targetGeometry!");const{camera:a,mode:o}=cD(s,e.rotation,t);if(n.type==="point")return AU(s,e,n,a,o,i);const l=n.extent;if(l==null)throw new Error("Target geometry has no extent!");return lO(s,l,a.heading,a.tilt,o,i)}function OU(s,e){const t=s.position;let i;try{i=E$(t,e)}catch{return null}if(!i)return null;const r=s.clone();return r.position=i.clone(),r}async function DU(s,e,t){const i=s.position,r=await Lo(i,e,{signal:t});He(t);const n=s.clone();return n.position=r.clone(),n}function cD(s,e,t){const i=Gh(s,s.state.camera);let r=1;return e!=null&&(i.heading=lD(e),r=0),t!=null&&(i.tilt=t),{camera:i,mode:r}}function EU(s,e,t,i,r){const n=s.spatialReference;let a;try{a=E$(t.clone(),n)}catch{return null}if(!a)return null;const o=e.scale!=null?vp(s,e.scale):s.state.camera.distance;return xz(s,a,o,i,r)}async function AU(s,e,t,i,r,n){const a=s.spatialReference,o=await Lo(t.clone(),a,{signal:n});He(n);const l=e.scale!=null?vp(s,e.scale):s.state.camera.distance;return F_(s,o,l,i,r,n)}function IU(s,e,t=null){return t==null&&(t=new Bo),M1(s,null,e.clone(),t)}async function LU(s,e,t){const i=GU(s,e);if(!i)throw new me("viewpointutils-create:no-target","Missing target for creating viewpoint");const r=new Qs({fov:s.camera.fov}),n=new Bo({camera:r});if(i.target instanceof Bo)return el(await kU(s,i.target,i,t,n));if(i.target instanceof Qs)return el(await uD(s,i.target,t,n));const a=i.scale!=null||i.zoom!=null;if(i.target instanceof is){const c=i.target.xmin===i.target.xmax||i.target.ymin===i.target.ymax;return el(a||c?await wb(s,i,i.target.center,r,t,n):await UU(s,i,i.target,r,t,n))}const o=new WU,l=a?FU(s,i):void 0;if(await hD(s,i.target,l,o,t),isFinite(o.boundingBox[0])){let c;if(Xw(o.boundingBox,Ut),lr.x=Ut[0],lr.y=Ut[1],lr.z=Ut[2],lr.spatialReference=s.spatialReference,isFinite(lr.z)&&o.hasZ?c=hR(o.boundingBox):(lr.z=void 0,c=jF(Yw(o.boundingBox,QU))),a||c)return el(await wb(s,i,lr,r,t,n));const h=jU(s,o.screenSpaceObjects);return el(await qU(s,i,lr,o.boundingBox,h,r,t,n))}return i.position?el(await BU(s,i,r,n,t)):el(await NU(s,i,r,t,n))}function P1(s,e){return e.scale==null&&e.zoom!=null?dO(s,e.zoom):e.scale}function FU(s,e){const t=P1(s,e);return t?_5(t):void 0}function U_(s,e){let t=!1;return e.heading!=null?(s.heading=e.heading,t=!0):e.rotation!=null&&(s.heading=lD(e.rotation),t=!0),e.tilt!=null&&(s.tilt=e.tilt,t=!0),e.fov!=null&&(s.fov=e.fov),t}function M1(s,e,t,i){const r=s.spatialReference||Dt.WGS84;if(e??=Wn(s,t),e==null)return i;const n=new wt({spatialReference:r});return Hp(e.center,s.renderSpatialReference,n)&&(i.targetGeometry=n,i.scale=nc(s,e.distance),i.rotation=N_(t.heading),i.camera=t),i}async function a_(s,e,t,i){const r=()=>new me("viewpointutils:invalid-geometry","The target is missing a valid geometry");if(!e)throw r();e.type==="mesh"&&(e=e.extent);const n=s.basemapTerrain.spatialReference;if(!e.hasZ&&s.basemapTerrain){let d;switch(e.type){case"point":d=e;break;case"multipoint":case"polyline":d=e.extent?.center;break;case"extent":d=e.center;break;case"polygon":{const m=H5(e);d=m?wt.fromJSON(m):null;break}}d!=null&&n&&s.elevationProvider?(d=await Lo(d,n,{signal:i}),Ut[2]=Yn(s.elevationProvider,d)??0):Ut[2]=0}const a=ZU[e.type],o=new Array;if(a(e,e.hasZ?d=>{o.push([d[0],d[1],d[2]])}:d=>{o.push([d[0],d[1]])},Ut),o.length===0)throw r();const l=e.spatialReference,c=s.spatialReference,h=await Lo(new cR({spatialReference:l,hasZ:e.hasZ,hasM:!1,points:o}),c,{signal:i});if(e.hasZ&&(t.hasZ=!0),e.hasZ)for(const[d,m,f]of h.points)Ut[0]=d,Ut[1]=m,Ut[2]=f,zg(t.boundingBox,Ut);else for(const[d,m]of h.points)Ut[0]=d,Ut[1]=m,zg(t.boundingBox,Ut)}async function VU(s,e,t,i,r){const n=await Vg(s.whenViewForGraphic(e));if(n.ok===!1||n.value==null||!("whenGraphicBounds"in n.value))return void await a_(s,e.geometry,i,r);const a=n.value,o=await Vg(a.whenGraphicBounds(e,{minDemResolution:t}));if(o.ok===!1||!o.value)return void await a_(s,e.geometry,i,r);const{screenSpaceObjects:l,boundingBox:c}=o.value;uR(i.boundingBox,c),l&&l.forEach(h=>{i.screenSpaceObjects.push(h)}),isFinite(c[2])&&(i.hasZ=!0)}async function hD(s,e,t,i,r){if(Array.isArray(e)&&e.length===2){const n=e[0],a=e[1];if(typeof n=="number"&&typeof a=="number")return lr.x=n,lr.y=a,lr.z=void 0,lr.spatialReference=s.spatialReference?.isGeographic?s.spatialReference:Dt.WGS84,void await a_(s,lr,i,r)}e&&"map"in e&&typeof e.map=="function"?await Promise.allSettled(e.map(n=>hD(s,n,t,i,r))):e instanceof sF?await a_(s,e,i,r):e instanceof Zw&&await VU(s,e,t,i,r)}async function kU(s,e,t,i,r){if(e.camera)return uD(s,e.camera,i,r);r.scale=e.scale,r.rotation=e.rotation,r.targetGeometry=e.targetGeometry!=null?e.targetGeometry.clone():null,r.camera=null,t.heading!=null?r.rotation=N_(t.heading):t.rotation!=null&&(r.rotation=t.rotation);const n=P1(s,t);return n!=null&&(r.scale=n),r.camera=await RU(s,r,t.tilt,i),r}async function uD(s,e,t,i){const r=s.spatialReference,n=await Lo(e.position,r,{signal:t}),a=e.clone();return a.position=n,M1(s,null,a,i)}async function zU(s,e,t,i,r,n,a){const o=s.renderSpatialReference;return await Lg(e,Wy,o,0,{signal:a}),await Lg(t,Am,o,0,{signal:a}),n.targetGeometry=new wt(e),r.position=new wt(t),he(o_,Wy,Am),x_(s,Am,o_,i.up,r),n.scale=nc(s,Ht(Am,Wy)),n.rotation=N_(r.heading),n.camera=r,n}async function wb(s,e,t,i,r,n){n.targetGeometry=t.clone();const a=mu(s);if(e.position)return zU(s,n.targetGeometry,e.position,a,i,n,r);if(e.zoomFactor){const l=a.distance/e.zoomFactor,c=ee(Ut,a.viewForward,-l);a.eye=ce(Ut,a.center,c),n.scale=nc(s,l)}Gh(s,a,i);const o=U_(i,e)?0:1;if(!e.zoomFactor){const l=P1(s,e);if(l==null){await Lg(n.targetGeometry,Ut,s.renderSpatialReference,0,{signal:r});const c=qV(a.frustum,Ut)?Ht(a.eye,Ut):a.distance;n.camera=await F_(s,n.targetGeometry,c,i,o),n.scale=nc(s,c)}else n.scale=l,n.camera=await wz(s,n.targetGeometry,n.scale,i,o,r)}return n}async function BU(s,e,t,i,r){const n=mu(s);q(o_,n.viewForward),x_(s,n.eye,o_,n.up,Qy);const a=s.spatialReference,{position:o}=e;if(o){const l=await Lo(o,a,{signal:r});t.position=l}else t.position=new wt;return t.heading=e.heading!=null?e.heading:Qy.heading,t.tilt=e.tilt!=null?e.tilt:Qy.tilt,M1(s,null,t,i)}async function NU(s,e,t,i,r){if(e.heading!=null||e.rotation!=null||e.scale!=null||e.tilt!=null||e.zoom!=null||e.zoomFactor!=null){const n=mu(s),{spatialReference:a,renderSpatialReference:o}=s,l=new wt({spatialReference:a});return Hp(n.center,o,l)?wb(s,e,l,t,i,r):r}return r.scale=s.scale,r.camera=s.camera.clone(),U_(r.camera,e),r}async function UU(s,e,t,i,r,n){n.targetGeometry=t.clone();const a=mu(s);Gh(s,a,i);const o=U_(i,e)?0:1;return n.camera=await lO(s,t,i.heading,i.tilt,o,r),n}function HU(s,e,t,i,r){let n=0;t.z!=null?n=t.z:s.basemapTerrain&&s.elevationProvider&&(n=Yn(s.elevationProvider,t)),be(Ut,t.x,t.y,n),I_(s.spatialReference,Ut,qT,s.renderSpatialReference),Bw(Em,qT),qp(Em,Em),Hr(Iu);const a=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];for(let g=0;g<a.length;g++){const _=a[g];let v=i[_[2]];isFinite(v)||(v=n),be(Ut,i[_[0]],i[_[1]],v),zo(Ut,s.spatialReference,Ut,s.renderSpatialReference),zg(Iu,fn(Ut,Ut,Em))}const o=LV(Iu),l=dR(Iu),c=FV(Iu),h=1/Math.tan(e.fovX/2),d=1/Math.tan(e.fovY/2),m=.5*Math.sqrt(o*o+c*c)*Math.max(d,h)+.5*l,f=.5*l*d+.5*Math.max(o,c);return Math.max(m,f)/r}async function qU(s,e,t,i,r,n,a,o){o.targetGeometry=t.clone();const l=mu(s),c=HU(s,l,t,i,r);Gh(s,l,n);const h=U_(n,e)?0:1;return o.camera=await F_(s,o.targetGeometry,c,n,h,a),o.scale=nc(s,c),o}function GU(s,e){if(!e||!s.spatialReference)return null;const t={target:void 0};return"declaredClass"in e||Array.isArray(e)?t.target=e:(Object.assign(t,e),!t.target&&"center"in e&&e.center&&(t.target=e.center)),t}function el(s){return s?.camera!=null&&(s.rotation=N_(s.camera.heading)),s}function jU(s,e){const t=MU;if(!e.length)return t;let i=Number.NEGATIVE_INFINITY;for(let r=0;r<e.length;r++){const n=e[r].screenSpaceBoundingRect;i=Math.max(i,Math.abs(n[0]),Math.abs(n[1]),Math.abs(n[2]),Math.abs(n[3]))}return t-i/Math.min(s.width,s.height)*2}let WU=class{constructor(){this.hasZ=!1,this.boundingBox=Hr(),this.screenSpaceObjects=new Array}};const Ut=x(),qT=Ie(),Em=Pn(),Iu=Ka(),QU=Mt(),o_=x(),Am=x(),Wy=x(),Qy={heading:0,tilt:0},lr=new wt,ZU={point(s,e,t){t[0]=s.x,t[1]=s.y,s.z!=null&&(t[2]=s.z),e(t)},polygon(s,e,t){const i=s.hasZ;for(let r=0;r<s.rings.length;r++){const n=s.rings[r];for(let a=0;a<n.length;a++)t[0]=n[a][0],t[1]=n[a][1],i&&(t[2]=n[a][2]),e(t)}},polyline(s,e,t){const i=s.hasZ;for(let r=0;r<s.paths.length;r++){const n=s.paths[r];for(let a=0;a<n.length;a++)t[0]=n[a][0],t[1]=n[a][1],i&&(t[2]=n[a][2]),e(t)}},multipoint(s,e,t){const i=s.points,r=s.hasZ;for(let n=0;n<i.length;n++)t[0]=i[n][0],t[1]=i[n][1],r&&(t[2]=i[n][2]),e(t)},extent(s,e,t){s.zmin!=null&&s.zmax!=null?(e(be(t,s.xmin,s.ymin,s.zmin)),e(be(t,s.xmax,s.ymin,s.zmin)),e(be(t,s.xmin,s.ymax,s.zmin)),e(be(t,s.xmax,s.ymax,s.zmin)),e(be(t,s.xmin,s.ymin,s.zmax)),e(be(t,s.xmax,s.ymin,s.zmax)),e(be(t,s.xmin,s.ymax,s.zmax)),e(be(t,s.xmax,s.ymax,s.zmax))):(e(be(t,s.xmin,s.ymin,t[2])),e(be(t,s.xmax,s.ymin,t[2])),e(be(t,s.xmin,s.ymax,t[2])),e(be(t,s.xmax,s.ymax,t[2])))}};let XU=class{constructor(e,t,i){this._target=e,this._options=t,this.view=i,this.state="pending",this._animationController=null,this.promise=new Promise((r,n)=>{this._resolveCallback=r,this._rejectCallback=n;const a=new AbortController;this._options.signal!=null&&Oo(this._options.signal,()=>this.abort()),this._abortController=a,this._waitForReady()})}_resolve(e){if(this.state!=="finished")return this.state="finished",this._resolveCallback(e)}_reject(e){if(this.state!=="finished")return this.state="finished",this._rejectCallback(e)}abort(e=!1){this._abortController.abort(),this.state==="wait-for-animation-finish"&&!e&&this._animationController!=null&&this.view.state.cameraController===this._animationController&&this._animationController.running&&this._animationController.stopController(),this._reject(Bi())}async _waitForReady(){if(this.state="wait-for-ready",!this.view.ready)try{await op(()=>this.view.ready,this._abortController.signal)}catch(e){return this._reject(e)}this._createViewPoint()}async _createViewPoint(){if(this.state!=="finished"){this.state="wait-for-viewpoint",this._animationController=this._options.animate?this._getAnimationController():null;try{const e=await LU(this.view,this._target,this._abortController.signal);if(this.state==="finished")return;const t=e?this._getCameraFromViewpoint(e):null;if(t==null)return;if(this._options.animate){if(this._animationController==null)return;this._startAnimation(t,this._animationController)}else this.view.stateManager.setStateCamera(t.camera,{applyConstraints:!t.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this._resolve()}catch(e){this._reject(e)}}}_getCameraFromViewpoint(e){const t=!!(this._target instanceof Bo&&this._target.camera||this._target instanceof Qs),i=e.camera;if(i==null)return null;if(!this.view.stateManager.isCompatible(i)){const n=i.position,a=n&&n.spatialReference,o=a?a.wkid:"none",l=this.view.spatialReference?.wkid;return this._reject(new me("GotoAnimation:incompatible-spatialreference",`Resulting camera has an incompatible spatial reference (camera: ${o}, view: ${l})`,{camera:i})),null}const r=Wn(this.view,i);return r==null?(this._reject(new me("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:e,camera:r,isFullySpecified:t}}_startAnimation(e,t){this.state="wait-for-animation-finish";const i=t.viewAnimation;if(i==null)return void this._reject(new me("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));if(i.update(e.viewpoint,"running"),!t.running||t.viewAnimation==null||t.viewAnimation.target!==e.viewpoint||this.view.state.cameraController!==t)return this.abort();let r;e.isFullySpecified?(r=new jd({view:this.view,desiredCamera:e.camera}),yu(this.view,e.camera,1)):Vt(this.view,e.camera),t.begin(e.camera,this._options);const n=()=>{const o=this.view.state.cameraController;r&&(o&&o.running?OT(o)&&o.viewAnimation!=null&&o.viewAnimation.target===e.viewpoint&&(this.view.state.cameraController=r):t.viewAnimation!=null&&t.viewAnimation.target===e.viewpoint&&t.state===4&&(this.view.state.cameraController=r))},a=o=>{if(this.view.state!=null)switch(t.state){case 4:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this._resolve()}break;case 0:case 1:case 2:case 3:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this._reject(o)}}};i.when(n,o=>a(o)),t.asyncResult={resolve:()=>a(),reject:o=>a(o)}}_getAnimationController(){let e=null,t=null;const i=this.view.state.cameraController;return OT(i)&&(i.updateStateFromViewAnimation(),i.running&&(e=i,t=e.viewAnimation)),e==null&&(e=new Bl({view:this.view,mode:"animation"}),t=e.viewAnimation,this.view.state.switchCameraController(e),e.state===1)?(t?.stop(),this._reject(new me("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null):e}},Gt=class extends te{constructor(e){super(e),this.ready=!1,this._windowDevicePixelRatio=1,this._devicePixelRatioOverride=null,this._idleTimeout=GT,this.test={viewStateManager:this,contentCameraResetState:new Map,setDevicePixelRatio:t=>this._devicePixelRatioOverride=t,getDevicePixelRatioOverride:()=>this._devicePixelRatioOverride,renderState:null,get maximumPixelRatio(){return this.viewStateManager.view.qualitySettings.maximumPixelRatio},get updatingIgnoreRenderState(){return this.renderState!=null},get idleTimeoutEnabled(){return this.viewStateManager._idleTimeout>0},set idleTimeoutEnabled(t){this.viewStateManager._idleTimeout=t?GT:0}},this._propertiesPool=new ja({frustum:()=>new kI(null)},this),this._cameraSetByUser=!1,this._gotoOperation=null,this._cameraChangeTime=0,this._tmpCanvasSize=new YU}initialize(){this._cameraChangeTime=performance.now(),this.addHandles([Ds(()=>this.view.state.events,"before-camera-change",({camera:e})=>e&&this._updateElevation(e)),$(()=>this.view.state?.camera,(e,t)=>this._cameraChangedHandler(e,t),Ae)]),Zs(()=>this.view.state?.camera,e=>this._updateElevation(e),{once:!0,sync:!0}),this.addHandles([Kl({prepare:()=>this._prepareFrame()}),$(()=>this.view.state.cameraController,()=>{this._cameraSetByUser=!0,this.removeHandles(Lm)}),Ds(()=>this.view.state.events,"camera-projection-changed",()=>this.notifyChange("scale"))])}destroy(){this.exit(),this._propertiesPool=Q(this._propertiesPool)}get camera(){const e=this._get("camera");if(!this.ready)return e;const t=Gh(this.view,this.view.state.camera,Zf);return t&&e&&t.equals(e)?e:t.clone()}set camera(e){if(this._updatePropertyBeforeReady("camera",e))return;this.view.elevationProvider.enableCache(!0);const t=Wn(this.view,e);t?this.setStateCamera(t,{applyConstraints:!1})||j.getLogger(this).warnOnce("#camera=","There is a currently active camera controller that has priority."):j.getLogger(this).error("#camera=","Invalid camera",e),this.view.elevationProvider.enableCache(!1)}get contentCamera(){const e=this._get("contentCamera");if(!this.ready)return e;const t=Gh(this.view,this.view.state.contentCamera,Zf);return t&&e&&t.equals(e)?e:t.clone()}set contentCamera(e){if(this._updatePropertyBeforeReady("contentCamera",e))return;const t=Wn(this.view,e);this.view.state.contentCamera=t??null}installContentCameraReset(e){if(this.removeHandles(Zy),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;const t=this.zoom,i=this.view.state.camera.distance**2,r=yF(this.view.state.camera.center),n=e.sticky?this.contentCamera.clone():null;return this.addHandles([$(()=>this.contentCamera,()=>{e.sticky||(this.removeHandles(Zy),this.test.contentCameraResetState.clear())}),$(()=>this.zoom,a=>{a!==void 0&&t!==void 0&&(this.test.contentCameraResetState.set("view.zoom",Math.abs(a-t)/2),Math.abs(a-t)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=n))}),$(()=>this.view.state.camera,a=>{const o=$o(r,a.center);this.test.contentCameraResetState.set("camera.center",o/i),o>i?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=n)})],Zy),!0}get center(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")}set center(e){this._updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this._centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():j.getLogger(this).error("#center=","Invalid center",e):j.getLogger(this).error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e):j.getLogger(this).error("#center=","Center may not be null or undefined"))}get visibleArea(){if(!this.ready){const e=this._get("extent");return e?W$.fromExtent(e):null}return Pz(this.view,this.view.pointsOfInterest.focus.renderLocation)}get extent(){if(!this.ready)return this._get("extent");const e=this.view,t=cO(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return t??this._get("extent")}set extent(e){this._updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this._extentToCamera(e),{applyConstraints:!0})||j.getLogger(this).error("#extent=","Invalid extent",e):j.getLogger(this).error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e):j.getLogger(this).error("#extent=","Extent may not be null or undefined"))}get frustum(){const e=this._propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}get constraintsManager(){return this._constraintsManager}get _initialViewpoint(){const e=this.view.map;return e&&"initialViewProperties"in e?e.initialViewProperties?.viewpoint:void 0}get hasInitialView(){return!!this._initialViewpoint}get scale(){if(!this.ready)return this._get("scale");const e=this.view.basemapTerrain.tilingScheme,t=this.view.pointsOfInterest.cameraOnSurface.scale;return e&&t?XR(this.view,t,this.view.state.contentCamera,e):this._get("scale")}set scale(e){this._updatePropertyBeforeReady("scale",e)||this.setStateCamera(this._scaleToCamera(e),{applyConstraints:!0})||j.getLogger(this).error("#scale=","Invalid scale",e)}get padding(){if(!this.ready)return this._get("padding");const e=this.view.state.camera,t=e.padding,i=e.pixelRatio,r=this._get("padding"),n=Math.round(t[0]/i),a=Math.round(t[1]/i),o=Math.round(t[2]/i),l=Math.round(t[3]/i);return r!=null&&r.top===n&&r.right===a&&r.bottom===o&&r.left===l?r:{top:n,right:a,bottom:o,left:l}}set padding(e){this._updatePropertyBeforeReady("padding",e)||(this._paddingToArray(e,this.view.state.camera.pixelRatio,Im),this.view.state.updateCamera(t=>t.padding=Im))}_paddingToArray(e,t,i){e?os(i,e.top||0,e.right||0,e.bottom||0,e.left||0):os(i,0,0,0,0);for(let r=0;r<4;r++)i[r]=Math.round(i[r]*t)}get screenCenter(){const e=this.padding;return dr((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}get viewpoint(){return this.ready?IU(this.view,this.camera):this._get("viewpoint")}set viewpoint(e){if(!this._updatePropertyBeforeReady("viewpoint",e))if(e){if(!this.isCompatible(e)){const t=e.camera!=null?e.camera.position:e.targetGeometry,i=t!=null&&t.spatialReference;return void j.getLogger(this).error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(i?i.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e)}this.setStateCamera(this._viewpointToCamera(e),{applyConstraints:!e.camera})||j.getLogger(this).error("#viewpoint=","Invalid viewpoint",e)}else j.getLogger(this).error("#viewpoint=","Viewpoint may not be null or undefined")}get zoom(){return this.ready?Dz(this.view,this.scale):this._get("zoom")}set zoom(e){this._updatePropertyBeforeReady("zoom",e)||e===void 0||this.setStateCamera(this._zoomToCamera(e),{applyConstraints:!0})||j.getLogger(this).error("#zoom=","Invalid zoom",e)}_computeCanvasSize(){if(this._devicePixelRatioOverride)return this.view.state.contentPixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*this._devicePixelRatioOverride),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*this._devicePixelRatioOverride),this._tmpCanvasSize.pixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize;const e=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio),t=(this._usePhysicalPixelRendering?this._windowDevicePixelRatio:e)*this.view.resolutionScale;this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*t),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*t);const i=this.view.stage.renderView.renderingContext?.parameters.maxTextureSize;return i&&Vl(this._tmpCanvasSize,i),this._tmpCanvasSize.pixelRatio=this._tmpCanvasSize.width>0?this._tmpCanvasSize.width/this.view.surface.clientWidth*.5+this._tmpCanvasSize.height/this.view.surface.clientHeight*.5:t,this.view.state&&(this.view.state.contentPixelRatio=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)),this._tmpCanvasSize}get _rasterPixelRatio(){return this._devicePixelRatioOverride!=null?this._devicePixelRatioOverride:this._usePhysicalPixelRenderingAny?this._windowDevicePixelRatio:Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)}get _usePhysicalPixelRendering(){return this.view?.stage?.renderer.isFeatureEnabled(8)??!1}get _usePhysicalPixelRenderingAny(){const e=this.view?.stage?.renderer;return e&&(e.isFeatureEnabled(8,2)||e.isFeatureEnabled(8,1)||e.isFeatureEnabled(8,0))}preinit(e){return!(this._isOverridden("center")&&!Jc(this.center.spatialReference,e))&&!(this._isOverridden("camera")&&!Jc(this.camera.position.spatialReference,e))&&!(this._isOverridden("extent")&&!Jc(this.extent.spatialReference,e))&&!!(!this._isOverridden("viewpoint")||Jc(this.viewpoint.targetGeometry?.spatialReference,e)&&Jc(this.viewpoint.camera?.position?.spatialReference,e))}init(){this._constraintsManager=new yd({view:this.view}),this._prepareFrame();const e=this._getInitialProperties();this._cameraSetByUser=!1,this._set("ready",!0);for(const t of e)this.set(t.name,t.value);if(!this._cameraSetByUser){const t=this._initialViewpoint||this.view.initialExtent;t&&this.isCompatible(t)?this._setInitialView(t):this.view.state.viewingMode===2&&this.addHandles(Zs(()=>this.view.basemapTerrain.ready,()=>{this.removeHandles(Lm),this._setInitialView(this.view.dataExtent)},{once:!0,initial:!0}),Lm)}}exit(){this._cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this._cameraSetByUser=!1,this.removeHandles(Lm),this._constraintsManager=Q(this._constraintsManager))}async goTo(e,t){return t={animate:!0,...t},this._gotoOperation!=null&&this._gotoOperation.abort(t.animate),this._gotoOperation=new XU(e,t,this.view),this.view.resourceController.scheduler.stopFrame(),this._gotoOperation.promise}debugSetCameraOnContent(){this.setStateCamera(mu(this.view),{applyConstraints:!1})}step(e){const t=this.view.state?.cameraController;t?.stepController&&this.view.state.updateCamera(i=>t.stepController(e,i))}_cancelGoToOperation(){this._gotoOperation!=null&&(this._gotoOperation.abort(),this._gotoOperation=null)}_getInitialProperties(){const e=new Set,t=[];for(const{propertyName:i,overrides:r}of JU){const n=e.has(i),a=this._isOverridden(i);!n&&a&&t.push({name:i,value:this._get(i)}),this._clearOverride(i),(n||a)&&r.forEach(o=>e.add(o))}return t}_setInitialView(e){if(e==null||this._cameraSetByUser)return;if(e instanceof Qs)return void this.setStateCamera(Wn(this.view,e),{applyConstraints:!1});if(e instanceof Bo){if(e.targetGeometry instanceof is){const n=If(this.view,e.targetGeometry,0,.5,0);return void(n!=null&&this.setStateCamera(Wn(this.view,n),{applyConstraints:!0}))}const i={applyConstraints:!e.camera},r=this._viewpointToCamera(e);return void this.setStateCamera(r,i)}const t=If(this.view,e,0,.5,0);t!=null&&this.setStateCamera(Wn(this.view,t),{applyConstraints:!0})}_updatePropertyBeforeReady(e,t){return!this.ready&&(this._override(e,t),t&&KU.has(e)&&this._override("hasInitialView",!0),!0)}isCompatible(e){return e!=null&&(e instanceof Bo?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof Qs?this.isCompatible(e.position):e.spatialReference&&!NF(e.spatialReference,this.view.spatialReference))}_getPreservingHeadingTilt(e=eH){return this._cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e}_centerPointAtDistanceToCamera(e,t,i=ba){const{heading:r,tilt:n}=this._getPreservingHeadingTilt(),a=bp(this.view,r,n,e,t,1);return a==null?null:(i.copyFrom(this.view.state.camera),i.eye=a.eye,i.center=a.center,i.up=a.up,i)}_centerToCamera(e){let t;if(e.hasZ)t=this.view.state.camera.distance;else{const{centerOnContent:i}=this.view.pointsOfInterest;i.runTask(),t=i.distance}return this._centerPointAtDistanceToCamera(e,t)}_extentToCamera(e){const{heading:t,tilt:i}=this._getPreservingHeadingTilt(),r=If(this.view,e,t,i,1,Zf);return r?Wn(this.view,r):null}_scaleToCamera(e){if(e==null)return null;const t=this.view,i=t.pointsOfInterest.centerOnContent;i.runTask();const r=i.renderLocation,n=t.pointsOfInterest.cameraOnSurface.renderLocation,a=bz(t,e,r,n);return this._centerPointAtDistanceToCamera(r,a)}_zoomToCamera(e){return this._scaleToCamera(dO(this.view,e))}_viewpointToCamera(e){return Wn(this.view,$U(this.view,e))}setStateCamera(e,t){return!(e==null||!this.view.state.stopActiveCameraController())&&(this._cameraSetByUser=!0,t.doNotCancelGoToOperation||this._cancelGoToOperation(),this.view.state.updateCamera(i=>{t.positionAndOrientationOnly?(i.eye=e.eye,i.center=e.center,i.up=e.up,i.fov=e.fov):i.copyFrom(e),t.applyConstraints&&Vt(this.view,i)}),t.applyConstraints||(this.view.state.cameraController=new jd({view:this.view,desiredCamera:e})),!0)}_prepareFrame(){const{surface:e,canvas:t,stage:i}=this.view;if(!e||!t||!i||i.destroyed||i.destroying)return;this._windowDevicePixelRatio=window.devicePixelRatio;const r=this._computeCanvasSize();if(r.width!==0&&r.height!==0&&(t.width===r.width&&t.height===r.height||(t.width=r.width,t.height=r.height),this.view.state)){const n=this.view.state.camera;n.fullWidth===r.width&&n.fullHeight===r.height&&n.pixelRatio===r.pixelRatio||(ba.copyFrom(n),ba.pixelRatio!==r.pixelRatio&&(this._paddingToArray(this.padding,r.pixelRatio,Im),ba.padding=Im),ba.fullWidth=r.width,ba.fullHeight=r.height,ba.pixelRatio=r.pixelRatio,this.view.state.camera=ba),this._updateState()}}_updateElevation(e){const t=this.view.renderCoordsHelper?.getAltitude(e.eye)??0,i=this.view.basemapTerrain?.spatialReference,r=i?ww(this.view,e.eye):0;e.relativeElevation=t-r}_updateState(){this.test.renderState!=null?this.view.state.mode=this.test.renderState:this.view.animation?this.view.state.mode=0:this.view.interacting?this.view.state.mode=1:(this.view.state.mode===0&&(this._cameraChangeTime=0),performance.now()-this._cameraChangeTime<this._idleTimeout?this.view.state.mode=1:this.view.state.mode=2),this.view.state.rasterPixelRatio=this._rasterPixelRatio}_cameraChangedHandler(e,t){e&&t&&e.almostEquals(t)||(this._cameraChangeTime=performance.now(),this._updateState())}};u([p({type:Qs,dependsOn:["view.state.camera","ready"]})],Gt.prototype,"camera",null),u([p({type:Qs,dependsOn:["view.state.contentCamera","ready"]})],Gt.prototype,"contentCamera",null),u([p({type:wt})],Gt.prototype,"center",null),u([p()],Gt.prototype,"visibleArea",null),u([p({type:is})],Gt.prototype,"extent",null),u([p({readOnly:!0})],Gt.prototype,"frustum",null),u([p()],Gt.prototype,"_constraintsManager",void 0),u([p({readOnly:!0})],Gt.prototype,"constraintsManager",null),u([p()],Gt.prototype,"_initialViewpoint",null),u([p({readOnly:!0})],Gt.prototype,"hasInitialView",null),u([p({readOnly:!0,type:Boolean})],Gt.prototype,"ready",void 0),u([p({type:Number})],Gt.prototype,"scale",null),u([p()],Gt.prototype,"padding",null),u([p({readOnly:!0})],Gt.prototype,"screenCenter",null),u([p({constructOnly:!0})],Gt.prototype,"view",void 0),u([p({type:Bo})],Gt.prototype,"viewpoint",null),u([p({type:Number})],Gt.prototype,"zoom",null),u([p({readOnly:!0})],Gt.prototype,"_rasterPixelRatio",null),u([p({readOnly:!0})],Gt.prototype,"_usePhysicalPixelRendering",null),u([p({readOnly:!0})],Gt.prototype,"_usePhysicalPixelRenderingAny",null),u([p()],Gt.prototype,"_windowDevicePixelRatio",void 0),u([p()],Gt.prototype,"_devicePixelRatioOverride",void 0),Gt=u([R("esri.views.3d.state.ViewStateManager")],Gt);let YU=class{constructor(){this.width=0,this.height=0,this.pixelRatio=1}};const KU=new Set(["camera","viewpoint","extent","scale","center","zoom"]),JU=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],eH={heading:0,tilt:0};let Zf=new Qs,ba=new vt;const Im=Lt(),Lm="pending-initial-view",Zy="content-camera-reset",GT=300,tH=100;function iH(){Zf=new Qs,ba=new vt}let vn=class extends Ea{constructor(){super(...arguments),this.startCamera=new vt,this.currentCamera=new vt,this._isInteractive=!1,this._interactingTimeoutHandle=void 0}get isInteractive(){return this._isInteractive}stepController(e,t){t.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(t)}onControllerStart(e){this.state=2,this.startCamera.copyFrom(e),this.currentCamera.copyFrom(e)}onControllerEnd(e){e.copyViewFrom(this.currentCamera)}commitCamera(){this._isInteractive=!0,this._interactingTimeoutHandle?.remove(),this._interactingTimeoutHandle=Ip.setTimeout(()=>{this._isInteractive=!1,this._interactingTimeoutHandle=void 0},tH),this.view.state.updateCamera(e=>this.stepController(Zi(0),e))}};u([p({readOnly:!0})],vn.prototype,"isInteractive",null),u([p()],vn.prototype,"_isInteractive",void 0),vn=u([R("esri.views.3d.state.controllers.InteractiveController")],vn);let Wd=class extends vn{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.pivot=0,this._rotScale=0,this._lastPoint=ke(),this._tmpWorldUp=x(),this._tmpViewDir=x(),this._tmpRotCurPoint=ke(),this._tmpTransf=Ie(),this._tmpAxis=x(),this._tmpPivotPoint=x(),this._pivotPos=x(),this._constraintOptions=new gr(15,2,0,this.startCamera)}initialize(){this._rotScale=this.pivot===0?3:1.5}begin(e){if(this.running){switch(this.pivot){case 1:q(this._pivotPos,this.startCamera.eye),this._constraintOptions.interactionType=3,this._constraintOptions.tiltMode=1,this._constraintOptions.selection=0;break;case 0:{const t=this._intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this._pivotPos,this.view.basemapTerrain.invisible?mc:{});t||q(this._pivotPos,this.startCamera.center),this._constrainPivotPoint(e,t),this.startCamera.center=this._pivotPos,this._constraintOptions.interactionType=2,this._constraintOptions.tiltMode=0,this._constraintOptions.selection=11;break}}Zl(this.startCamera,e,this._lastPoint)}}_constrainPivotPoint(e,t){const i=this.startCamera,r=x();he(r,this._pivotPos,i.eye);const n=fe(r),a=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(i.eye,jT);let o=Math.max(bu(jT,i.viewForward,hU)*a,uU);t&&(o=Math.min(n,o));const l=ii(i.width/i.pixelRatio*.5,i.height/i.pixelRatio*.5),c=Zp(this.startCamera,l,this.view.renderCoordsHelper,this.view.viewingMode);let h=this.view.stage.renderView.getMinimalDepthForArea($p(this.view),i.fullWidth/i.pixelRatio*.5,i.fullHeight/i.pixelRatio*.5,i,2.5*Ny,Ny),d=this.view.stage.renderView.getMinimalDepthForArea($p(this.view),e[0],e[1],i,Ny);h==null&&d==null||(h=h??d??0,d=d==null||c===1?h:d,o=h>d?d:h,o=t?Math.min(o,n):o),pe(r,r),q(this._pivotPos,ce(this._tmpPivotPoint,i.eye,ee(this._tmpPivotPoint,r,o)))}update(e){if(this.running){switch(this.pivot){case 1:this.currentCamera.center=this._applyRotation(this.currentCamera,e,this.currentCamera.center,this._pivotPos);break;case 0:this.currentCamera.center=this._pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,e,this.currentCamera.eye,this._pivotPos)}Vt(this.view,this.currentCamera,this._constraintOptions),this.commitCamera()}}end(){this.running&&this.finishController()}_applyRotation(e,t,i,r){this.view.renderCoordsHelper.worldUpAtPosition(r,this._tmpWorldUp),Zl(e,t,this._tmpRotCurPoint);let n=(this._lastPoint[1]-this._tmpRotCurPoint[1])*this._rotScale,a=(this._tmpRotCurPoint[0]-this._lastPoint[0])*this._rotScale;he(this._tmpViewDir,i,r);const o=fe(this._tmpViewDir),l=Ua(We(this._tmpViewDir,this._tmpWorldUp)/o);if(this.pivot===1){n*=-.5;const c=.5*Math.PI-l,h=.5*Math.PI*.99;n=c-Math.max(-h,Math.min(h,c+n))}return n=U(n+l,ki.min,ki.max)-l,ti(this._tmpAxis,e.up,this._tmpViewDir),this.pivot===0&&(a=-a),Vo(this._tmpTransf,a,this._tmpWorldUp),gn(this._tmpTransf,this._tmpTransf,n,this._tmpAxis),ot(this._tmpViewDir,this._tmpViewDir,this._tmpTransf),e.up=ot(Xy,e.up,this._tmpTransf),ce(Xy,r,this._tmpViewDir),pr(this._lastPoint,this._tmpRotCurPoint),Xy}};u([p()],Wd.prototype,"pivot",void 0),Wd=u([R("esri.views.3d.state.controllers.RotateController")],Wd);const Xy=x(),jT=x();let Yy=class extends Gi{constructor(e,t,i,r){super(!0),this._view=e,this.pointerActions=t,this._pivot=i,this.registerIncoming("drag",r,n=>this._handleDrag(n))}_handleDrag(e){const t=e.data;if(t.pointers.size>1||!S1(e.data,this.pointerActions))return;const i=ii(t.center.x,t.center.y);switch(t.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._cameraController=new Wd({view:this._view,pivot:this._pivot}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break;case"update":this._cameraController&&this._cameraController.update(i);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}};function sH(s){return s&&"nodeType"in s}function rH(s){return s&&typeof s.render=="function"}const WT={component:"esri-component"};let vl=class extends te{constructor(){super(...arguments),this.widget=null}destroy(){this.node=null,this.widget?.destroy()}get id(){return this._get("id")??this.widget?.id??this.node?.id}set id(e){this._set("id",e)}set node(e){const t=this._get("node");e!==t&&(e&&e.classList.add(WT.component),t&&t.classList.remove(WT.component),this._set("node",e))}castNode(e){return this.widget?.destroy(),e?typeof e=="string"||sH(e)?(this._set("widget",null),Ew(e)):(rH(e)&&!e.domNode&&(e.domNode=document.createElement("div")),this._set("widget",e),e.domNode):(this._set("widget",null),null)}};u([p()],vl.prototype,"id",null),u([p()],vl.prototype,"node",null),u([Ba("node")],vl.prototype,"castNode",null),u([p({readOnly:!0})],vl.prototype,"widget",void 0),vl=u([R("esri.views.ui.Component")],vl);const Qd=vl;function nH(s,e){return{type:kp(e),value:s,unit:e}}function Are(s){return{value:s}}function aH(s,e){return{type:kp(e),value:s,unit:e}}function oH(s,e){return{type:kp(e),value:s,unit:e}}function Ire(s,e){return{type:kp(e),value:s,unit:e}}function H_(s,e,t="arithmetic"){return{type:kp(e),value:s,unit:e,rotationType:t}}function Lre(s,e){const t=lH(s,e);return s.type==="angle"?H_(t,e,s.rotationType):nH(t,e)}function lH(s,e){return fr(s.value,s.unit,e)}function Fre(s,e){return s==null?e:e==null||s.value>fr(e.value,e.unit,s.unit)?s:e}function Vre(s,e){return s==null?null:{...s,value:s.value*e}}function cH(s,e,t){if(e===t)return s;switch(t){case"arithmetic":case"geographic":return 90-s}}const kre=aH(0,"meters"),zre=oH(0,"square-meters");H_(0,"radians");const Bre=H_(0,"degrees"),Nre=H_(0,"degrees","geographic");function dD(s,e,t){return s.units[e][t]}function fc(s,e,t,i=2,r="abbr"){return`${L_(e,{minimumFractionDigits:i,maximumFractionDigits:i,signDisplay:e>0?"never":"exceptZero"})} ${dD(s,t,r)}`}function q_(s,e,t,i=2,r="abbr"){return`${L_(e,{minimumFractionDigits:i,maximumFractionDigits:i,signDisplay:"exceptZero"})} ${dD(s,t,r)}`}function Ure(s,e,t,i=2,r="abbr"){const n=b$(e,t);return fc(s,fr(e,t,n),n,i,r)}function Hre(s,e,t,i=2,r="abbr"){const n=b$(e,t);return q_(s,fr(e,t,n),n,i,r)}function qre(s,e,t,i=2,r="abbr"){const n=v$(e,t);return fc(s,fr(e,t,n),n,i,r)}function Gre(s,e,t,i=2,r="abbr"){const n=v$(e,t);return q_(s,fr(e,t,n),n,i,r)}function jre(s,e,t,i=2,r="abbr"){const n=y$(e,t);return fc(s,fr(e,t,n),n,i,r)}function Wre(s,e,t,i=2,r="abbr"){const n=y$(e,t);return q_(s,fr(e,t,n),n,i,r)}function Qre(s,e,t,i=2,r="abbr"){const n=_$(e,t);return fc(s,fr(e,t,n),n,i,r)}function Zre(s,e,t,i=2,r="abbr"){const n=_$(e,t);return q_(s,fr(e,t,n),n,i,r)}function Xre(s,e,t,i=2,r="abbr"){const n=rF(e,t);return fc(s,fr(e,t,n),n,i,r)}function Yre(s,e,t,i=2,r="abbr"){const n=nF(e,t);return fc(s,fr(e,t,n),n,i,r)}const hH=(s,e)=>({style:"unit",unitDisplay:"narrow",unit:"degree",maximumFractionDigits:e,minimumFractionDigits:e,signDisplay:s>0?"never":"exceptZero"});function uH(s,e,t,i,r,n=Ww,a=!0){let o=n.normalize(cH(fr(s,e,"degrees"),t,i),0,a);const l=hH(o,r??2);return o=dH(o,l),L_(o,l)}const QT=new Map;function dH(s,e){const t=JSON.stringify(e);let i=QT.get(t);return i||(i=new Intl.NumberFormat("en-US",e),QT.set(t,i)),/^[-+]?360\.?0*?$/.test(i.format(s))?0:s}const ZT=["B","kB","MB","GB","TB"];function Kre(s,e){let t=(e=Math.round(e))===0?0:Math.floor(Math.log(e)/Math.log(1024));t=U(t,0,ZT.length-1);const i=L_(e/1024**t,{maximumFractionDigits:2});return lI(s.units.bytes[ZT[t]],{fileSize:i})}const Fm="esri-fov-overlay",Vm={base:Fm,outer:`${Fm}-outer`,reset:`${Fm}-reset`,text:`${Fm}-text`};let wa=class extends zp{constructor(e){super(e),this.onReset=()=>{},this._messagesCommon=null,this._messagesUnits=null,this.fov=null}render(){return Ni("div",{class:Vm.outer},Ni("div",{class:Vm.base},Ni("p",{class:Vm.text},this._overlay),Ni("p",{class:Vm.reset,onclick:this.onReset,title:this._messagesCommon.reset},this._reset)))}get _overlay(){const{fov:e,_messagesUnits:t}=this;if(!t||e==null)return"";const i=uH(ic(e),"degrees","arithmetic","arithmetic",0),r=pH/(2*Math.tan(e/2));return`${i} | ${fc(t,r,"millimeters",0,"abbr")} |`}get _reset(){return this._messagesUnits&&this.fov!=null?"":""}};u([p()],wa.prototype,"onReset",void 0),u([p(),Qh("esri/t9n/common")],wa.prototype,"_messagesCommon",void 0),u([p(),Qh("esri/core/t9n/Units")],wa.prototype,"_messagesUnits",void 0),u([p()],wa.prototype,"fov",void 0),u([p()],wa.prototype,"_overlay",null),u([p()],wa.prototype,"_reset",null),wa=u([R("esri.widgets.FovOverlay")],wa);const pH=Math.sqrt(1872);let Hh=class extends vn{constructor(e){super(e),this.onStop=null,this._timeOutId=void 0,this._onReset=()=>{this._startSize=this._lastDrag=null,this._setFov(mH),this.updateTimeout()},this._center=x(),this._viewForward=x(),this._constraints=new gr(15,1)}begin(e){_H(e)?this._showOverlay().fov=e.fov:(this._lastDrag=e[1],this._startSize=null,this._ensureStartSize(this.view.state.camera))}updateTimeout(){clearTimeout(this._timeOutId),this._timeOutId=setTimeout(this.onStop,1500)}update(e){if(this._lastDrag==null)return this._lastDrag=e[1],this._startSize=null,void this._ensureStartSize(this.view.state.camera);const t=-(this._lastDrag-e[1])/2;this._lastDrag=e[1],this.step(t)}step(e){if(!this.running)return void(this._startSize=this._lastDrag=null);const t=this.view.state,i=this.currentCamera.copyFrom(t.camera),r=ic(i.fov)+e,n=rt(U(r,fH,gH));n!==i.fov?this._setFov(n):this._showOverlay().fov=i.fov}finish(){this.running&&(this._startSize=this._lastDrag=null,this.finishController())}destroy(){this.hideOverlay()}onControllerEnd(e){super.onControllerEnd(e),this._startSize=this._lastDrag=null,this.hideOverlay()}_showOverlay(){return this._overlay||(this._overlay=new Qd({id:"esri.FovOverlay",node:new wa({onReset:this._onReset})}),this.view.ui.add(this._overlay)),this._overlay.widget}hideOverlay(){this._overlay&&(this.view.ui.remove(this._overlay),this._overlay=Q(this._overlay))}_setFov(e){const t=this.view.state,i=this.currentCamera.copyFrom(t.camera),r=this._ensureStartSize(i)/Math.tan(e/2),n=ce(Ky,this._center,ee(Ky,this._viewForward,-r));i.eye=n,i.fov=e,this._constraints.interactionStartCamera=t.camera,this._constraints.interactionFactor=Er(this.currentCamera.height-t.camera.height),Vt(this.view,this.currentCamera,this._constraints),this.begin(i),this.commitCamera()}_ensureStartSize(e){if(this._startSize==null){q(this._viewForward,e.viewForward);const t=this.view.stage.renderView.getMinimalDepthForArea(null,e.fullWidth/e.pixelRatio*.5,e.fullHeight/e.pixelRatio*.5,e,Qp),i=Ht(e.eye,this.view.pointsOfInterest.centerOnContent.renderLocation),r=t??i;ce(this._center,e.eye,ee(Ky,this._viewForward,r)),this._startSize=r*Math.tan(e.fov/2)}return this._startSize}};u([p()],Hh.prototype,"onStop",void 0),Hh=u([R("esri.views.3d.state.controllers.FovController")],Hh);const mH=rt(new Qs().fov),fH=10,gH=150,Ky=x();function _H(s){return!Array.isArray(s)}const XT=12;let xb=class extends vn{constructor(){super(...arguments),this._pickPoint=x(),this._tmpP0=ke(),this._panAxisAngle=B_(),this._tmpRayDir=x(),this._tmpRayDirPick=x(),this._targetOnSphere=x(),this._navigationMode=1,this._tmpRay={origin:x(),direction:x()},this.dragBeginPoint=ii(),this._normalizedAnchorPoint=ke(),this._constraintOptions=new gr(7,1,0,this.startCamera),this._sphere=Xs(),this._hasPickPoint=!1}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.running)return;pr(this.dragBeginPoint,e),Zl(this.startCamera,e,this._normalizedAnchorPoint);const t=Zt(this.view.spatialReference),i=eD(this._intersectionHelper,this.startCamera,e,t.radius,0,this.view.basemapTerrain.invisible?mc:{});if(this._navigationMode=Zp(this.startCamera,e,this.view.renderCoordsHelper,this.view.viewingMode),this._navigationMode===1)this._hasPickPoint=!!i.scenePickPoint,this._pickPoint=i.scenePickPoint??this._pickPoint,this._sphere=i.sphere;else{let r;vu(this.startCamera,e,this._tmpRay),pe(this._tmpRay.direction,this._tmpRay.direction),i.scenePickPoint!=null&&(he(this._tmpRayDirPick,this.startCamera.eye,i.scenePickPoint),r=fe(this._tmpRayDirPick));const n=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(this.startCamera.eye,YT);const a=U(bu(YT,this._tmpRay.direction,QO)*n,Jg[0],Jg[1]),o=this.view.stage.renderView.getMinimalDepthForArea(null,e[0],e[1],this.view.state.camera,Qp);let l=o??a;r!=null&&(l=Math.min(l,r)),this._hasPickPoint=!0,ee(this._tmpRay.direction,this._tmpRay.direction,l),ce(this._pickPoint,this._tmpRay.origin,this._tmpRay.direction)}}update(e){if(this.running){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,this._navigationMode===1){he(this._tmpRayDir,this.currentCamera.center,this.currentCamera.eye);const t=fe(this._tmpRayDir);Zl(this.currentCamera,e,this._tmpP0);const i=(this._normalizedAnchorPoint[1]-this._tmpP0[1])*XT;let r=t*2**i;const n=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<n&&(r=n),Math.abs(t-r)<No)return;if(this._hasPickPoint&&r<t){const a=1-(1-r/t)*(1-this._sphere[3]/fe(this.currentCamera.center));this.currentCamera.center=ee(km,this.currentCamera.center,a)}ee(this._tmpRayDir,this._tmpRayDir,-r/t),this.currentCamera.eye=ce(km,this.currentCamera.center,this._tmpRayDir),this._constraintOptions.interactionFactor=Er(hp(this.dragBeginPoint,e)),Vt(this.view,this.currentCamera,this._constraintOptions),this._hasPickPoint&&(Mp(this._sphere,this.currentCamera,this.dragBeginPoint,this._targetOnSphere),y1(this._pickPoint,this._targetOnSphere,this._panAxisAngle),Uo(this.currentCamera,Hi(this._sphere),this._panAxisAngle))}else{const t=fe(this._tmpRay.direction);Zl(this.currentCamera,e,this._tmpP0);const i=(this._normalizedAnchorPoint[1]-this._tmpP0[1])*XT;let r=t*2**i;const n=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<n&&(r=n),Math.abs(t-r)<No)return;ee(this._tmpRayDir,this._tmpRay.direction,1-r/t),this.currentCamera.eye=ce(km,this.currentCamera.eye,this._tmpRayDir),this.currentCamera.center=ce(km,this.currentCamera.center,this._tmpRayDir),pe(this._tmpRayDir,this._tmpRayDir),this._constraintOptions.interactionDirection=this._tmpRayDir,Vt(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}yu(this.view,this.currentCamera),this.commitCamera()}}finish(){this.running&&this.finishController()}};xb=u([R("esri.views.3d.state.controllers.ZoomControllerGlobal")],xb);const km=x(),YT=x();let Cb=class extends vn{constructor(){super(...arguments),this._tmpP=x(),this._tmpDir=x(),this._tmpN=x(),this._tmpP0=ke(),this._tmpPoi=x(),this._tmpRayDir=x(),this.dragBeginPoint=ii(),this._normalizedAnchorPoint=ke(),this._constraintOptions=new gr(15,1,0,this.startCamera,x()),this._plane=Ha()}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.running)return;pr(this.dragBeginPoint,e),Zl(this.startCamera,e,this._normalizedAnchorPoint);const t=this._intersectionHelper.intersectScreenFreePointFallback(e,this._tmpP,this.view.basemapTerrain.invisible?mc:{});he(this._tmpDir,this._tmpP,this.startCamera.eye);const i=fe(this._tmpDir);pe(this._tmpDir,this._tmpDir);const r=Math.abs(this.view.camera.position.z),n=U(bu(yH,this._tmpDir,QO)*r,Jg[0],Jg[1]),a=this.view.stage.renderView.getMinimalDepthForArea($p(this.view),e[0],e[1],this.view.state.camera,Qp);let o=a??n;t&&(o=Math.min(o,i)),ee(this._tmpDir,this._tmpDir,o),ce(this._tmpP,this.startCamera.eye,this._tmpDir),he(this._tmpN,this.startCamera.eye,this.startCamera.center),pe(this._tmpN,this._tmpN),this._tmpN[1]<0&&La(this._tmpN,this._tmpN),G$(this._tmpP,this._tmpN,this._plane)}update(e){if(!this.running)return;dU(this._plane,this.currentCamera,this.dragBeginPoint,this._tmpPoi)||q(this._tmpPoi,this.currentCamera.center),Zl(this.currentCamera,e,this._tmpP0);let t=4*(this._tmpP0[1]-this._normalizedAnchorPoint[1]);pr(this._normalizedAnchorPoint,this._tmpP0),he(this._tmpRayDir,this._tmpPoi,this.currentCamera.eye);const i=fe(this._tmpRayDir);let r=i*(1-t);this._constraintOptions.interactionDirection&&(q(this._constraintOptions.interactionDirection,this._tmpRayDir),ee(this._constraintOptions.interactionDirection,this._constraintOptions.interactionDirection,Math.sign(t)/i));const n=this.view.state.constraints.minimumPoiDistance;t>=0&&r<n&&(r=n,t=-(r-i)/i),Math.abs(i-r)<No||(ee(this._tmpRayDir,this._tmpRayDir,t),this.currentCamera.eye=ce(tl,this.currentCamera.eye,this._tmpRayDir),kt(tl,this.currentCamera.center,this._tmpPoi,t),this._tmpPoi[2]>this.startCamera.center[2]?tl[2]=Math.max(this.startCamera.center[2],tl[2]):tl[2]=Math.min(this.startCamera.center[2],tl[2]),this.currentCamera.center=tl,this._constraintOptions.interactionFactor=Er(hp(this.dragBeginPoint,e)),Vt(this.view,this.currentCamera,this._constraintOptions),this.commitCamera())}finish(){this.running&&this.finishController()}};Cb=u([R("esri.views.3d.state.controllers.ZoomControllerLocal")],Cb);const tl=x(),yH=Qe(0,0,1);let vH=class extends Gi{constructor(e,t,i){super(!0),this._view=e,this.pointerActions=t,this._fovModifier=i,this.registerIncoming("drag",[i],r=>this._handleZoom(r)),this.registerIncoming("drag",r=>this._handleZoom(r))}_handleZoom(e){const t=e.data;if(t.pointers.size>1||!S1(e.data,this.pointerActions))return;const i=ii(t.center.x,t.center.y);switch(t.action){case"start":{this._cameraController?.finish();const r=this._view,n=e.modifiers.has(this._fovModifier);this._cameraController=n?new Hh({view:r,onStop:()=>this._stopController()}):r.state.isGlobal?new xb({view:r}):new Cb({view:r}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break}case"update":this._cameraController?.update(i);break;case"end":this._cameraController instanceof Hh?this._cameraController.updateTimeout():this._stopController()}e.stopPropagation()}_stopController(){this._cameraController?.finish(),this._cameraController=null}};function Zr(s){let e=s*s;return s<0&&(e*=-1),e}function KT(s,e,t){const i=t,r=s.state,n=s.device,a=e.tiltDirection==="forward-down"?1:-1,o=1;return n.deviceType==="standard"?(i.translation[0]=Zr(r.axes[0]),i.translation[1]=Zr(r.axes[1]),i.translation[2]=Zr(r.buttons[7])-Zr(r.buttons[6]),i.heading=Zr(r.axes[2]),i.tilt=Zr(r.axes[3])):n.deviceType==="spacemouse"&&(i.translation[0]=1.2*Zr(r.axes[0]),i.translation[1]=1.2*Zr(r.axes[1]),i.translation[2]=2*-Zr(r.axes[2]),i.heading=1.2*Zr(r.axes[5]),i.tilt=1.2*Zr(r.axes[3])),i.tilt*=a,ee(i.translation,i.translation,o),i}function JT(s,e){const t=e;return t.translation[0]=s[1]-s[0],t.translation[1]=s[3]-s[2],t.translation[2]=s[4]-s[5],t.heading=s[7]-s[6],t.tilt=s[8]-s[9],t.zoom=s[10]-s[11],t}function Jy(s){return s.translation[0]===0&&s.translation[1]===0&&s.translation[2]===0&&s.heading===0&&s.tilt===0&&s.zoom===0}let Nl=class extends vn{constructor(e){super(e),this._filteredSurfaceElevation=0,this._transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this._keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],this._tmpCamera=new vt,this._headingStart=0,this._constraintOptions=new gr(15,0,0,new vt,null,1)}handleEventGamepad(e){const t=KT(e,this.view.navigation.gamepad,this._transformation);(e.action==="end"||Jy(t))&&this.finishController()}activateDirection(e){this._keysButtonState[e]=1,JT(this._keysButtonState,this._transformation)}directionActive(e){return this._keysButtonState[e]===1}countActiveDirections(){return this._keysButtonState.reduce((e,t)=>t>0?e+1:e,0)}deactivateDirection(e){this._keysButtonState[e]=0;const t=JT(this._keysButtonState,this._transformation);Jy(t)&&this.finishController()}onControllerStart(e){this._filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this._headingStart=this.view.camera.heading,super.onControllerStart(e)}_updateFilteredSurfaceElevation(e){const t=this.view.pointsOfInterest.cameraOnSurface.location.z,i=1;this._filteredSurfaceElevation+=i*(t-this._filteredSurfaceElevation)*e}stepController(e,t){this._updateStartHeading(),this._updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(t),this._updateCameraCenter(),this._constraintOptions.interactionStartCamera?.copyFrom(this.currentCamera),this._calculateControlTransformation(e,this.currentCamera,il),this._applyDisabledMovementTypes(il),this._applyPan(il.pan),this._applyRotate(il.rotate),this._applyZoom(il.zoom),this._applyAscend(il.ascend),this._constraintOptions.interactionType=0,this._constraintOptions.selection=8,Vt(this.view,this.currentCamera,this._constraintOptions),super.stepController(e,t)}_updateStartHeading(){this._transformation.heading!==0&&(this._headingStart=this.view.camera.heading)}_applyRotate(e){if(!e.enabled)return;const t=this.currentCamera;he(us,t.center,t.eye),ot(us,us,e.matrix),t.center=ce(us,us,t.eye),t.up=ot(us,t.up,e.matrix),this._constraintOptions.interactionType=3,this._constraintOptions.selection=7,Vt(this.view,t,this._constraintOptions)}_applyPan(e,t=this.currentCamera){e.enabled&&(t.eye=ot(us,t.eye,e.matrix),t.center=ot(us,t.center,e.matrix),this.view.state.isGlobal&&(t.up=ot(us,t.up,e.matrix)),this._constraintOptions.interactionType=4,this._constraintOptions.selection=15,Vt(this.view,t,this._constraintOptions))}_applyZoom(e){if(!e)return;const t=this.currentCamera.viewForward;this.currentCamera.eye=ce(us,this.currentCamera.eye,ee(yt.get(),t,e)),q(Lu,t),La(Lu,Lu),this._constraintOptions.interactionDirection=Lu,this._constraintOptions.interactionType=1,this._constraintOptions.selection=7,Vt(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_applyAscend(e){if(!e)return;const t=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,yt.get());if(this._constraintOptions.interactionDirection=q(Lu,t),this.view.state.isGlobal){const i=fe(this.currentCamera.eye),r=(i+e)/i;this.currentCamera.eye=ee(us,this.currentCamera.eye,r),this.currentCamera.center=ee(us,this.currentCamera.center,r)}else{const i=ee(yt.get(),t,e);this.currentCamera.eye=ce(us,this.currentCamera.eye,i),this.currentCamera.center=ce(us,this.currentCamera.center,i)}this._updateCameraCenter(),this._constraintOptions.interactionType=5,this._constraintOptions.selection=8,Vt(this.view,this.currentCamera,this._constraintOptions)&&this._updateCameraCenter(),this._constraintOptions.selection=7,Vt(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_calculateControlTransformation(e,t,i){PH(i);const r=this._computeVelocities(e);this.view.state.isLocal?this._calculateControlTransformationLocal(r,t,i):this._calculateControlTransformationGlobal(r,t,i)}_updateCameraCenter(){const e=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,t=this.view.renderCoordsHelper,i=this.currentCamera.ray;this.currentCamera.center=t.intersectManifoldClosestSilhouette(i,e,us)}_calculateControlTransformationLocal(e,t,i){const{viewRight:r,viewForward:n}=t,a=this._transformation,o=this.view.navigation.gamepad,l=be(yt.get(),n[0],n[1],0);pe(l,l);const c=a.translation[0]*e.pan;if(c!==0){const _=ee(yt.get(),r,c);rc(i.pan.matrix,i.pan.matrix,_),i.pan.enabled=!0}switch(o.mode){case"pan":{const _=-a.translation[1]*e.pan;if(_!==0){const v=ee(yt.get(),l,_);rc(i.pan.matrix,i.pan.matrix,v),i.pan.enabled=!0}i.zoom=a.zoom*e.zoom;break}case"zoom":i.zoom=(-a.translation[1]+a.zoom)*e.zoom;break;default:ra(o.mode)}const h=a.translation[2]*e.ascend;i.ascend=h;const d=-a.heading*e.rotate;d!==0&&(gn(i.rotate.matrix,i.rotate.matrix,d,this.view.renderCoordsHelper.worldUpAtPosition(t.eye,yt.get())),i.rotate.enabled=!0);const m=a.tilt*e.rotate,f=Eo(this.view.renderCoordsHelper,t.center,t.eye),g=U(f+m,ki.min,ki.max)-f;g&&(gn(i.rotate.matrix,i.rotate.matrix,g,r),i.rotate.enabled=!0)}_calculateControlTransformationGlobal(e,t,i){const{eye:r,viewRight:n}=t,a=this._transformation,o=this.view.navigation.gamepad,l=ti(yt.get(),n,r);pe(l,l),La(l,l),yU(this.startCamera,t,a,e,this.view.camera.heading,this._headingStart,this.view.camera.tilt,i,o),this._tmpCamera.copyFrom(this.currentCamera),this._applyPan(il.pan,this._tmpCamera);const c=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,h=a.translation[2]*e.ascend;i.ascend=h;const d=-a.heading*e.rotate;d!==0&&(gn(i.rotate.matrix,i.rotate.matrix,d,this._tmpCamera.eye),i.rotate.enabled=!0);const m=a.tilt*e.rotate,f=this._clampTiltDeltaGlobalToValidRange(m,t.ray,c);f!==0&&(gn(i.rotate.matrix,i.rotate.matrix,f,this._tmpCamera.viewRight),i.rotate.enabled=!0),i.zoom+=a.zoom*e.zoom}_clampTiltDeltaGlobalToValidRange(e,t,i){const r=Zt(this.view.spatialReference),n=Gf(ki.min,t.origin,i,r);let a=0,o=0;const l=yt.get();if(this.view.renderCoordsHelper.intersectManifold(t,i,l)){const c=Eo(this.view.renderCoordsHelper,l,t.origin);a=Gf(c,t.origin,i,r),o=Gf(ki.max,t.origin,i,r)}else{E_(A_(Gw,i+r.radius),t,l);const c=Math.PI+aR(t.direction,l);a=ET(c,t.origin,i,r),o=ET(ki.max,t.origin,i,r)}return U(a+e,n,o)-a}_getPointAbsoluteSurfaceElevation(e,t,i){const{renderCoordsHelper:r}=this.view,n=r.getAltitude(e),a=t+Math.abs(n-t);return r.setAltitude(i,a,e),a}_clampedDistanceToSurface(e,t){const{renderCoordsHelper:i}=this.view,{camera:r}=this.view.state,{direction:n}=fz(this.view,t,0,pD,SH),a=i.intersectManifoldClosestSilhouette(iu(t,n),e,yt.get()),o=Ht(t,a),l=i.intersectManifoldClosestSilhouette(iu(t,kw(yt.get(),t,r.center)),e,yt.get()),c=Ht(t,l);return Math.min(o,c)}_computeHeadingRotateRadius(e){const{renderCoordsHelper:t,state:i}=this.view,{camera:r,isGlobal:n}=i,a=t.intersectManifoldClosestSilhouette(r.ray,this._filteredSurfaceElevation,yt.get());if(n){const o=he(yt.get(),e,a),l=fe(o);ee(o,o,1/l);const c=pe(yt.get(),e),h=Ua(We(c,o));return l*Math.sin(Math.min(wH,h))}{const o=q(yt.get(),e);return t.setAltitude(o,this._filteredSurfaceElevation),Ht(a,o)}}_minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:xH}_computeVelocities(e){const t=this._filteredSurfaceElevation,i=t+Zt(this.view.spatialReference).radius,{camera:r,isGlobal:n}=this.view.state,a=yt.get(),o=this._getPointAbsoluteSurfaceElevation(r.eye,t,a),l=this._clampedDistanceToSurface(t,a),c=r.width/2,h=eS*r.width,d=eS*r.width,m=l*Math.tan(.5*r.fovX)/c,f=m/i,g=m/this._computeHeadingRotateRadius(a),_=o-t;return{pan:(n?f:m)*h*e,ascend:Math.max(this._minimumAscendVelocity()*e,2**(h*e/c)*_-_),zoom:2**(h*e/c)*l-l,rotate:U(g*d,CH,TH)*e}}_applyDisabledMovementTypes(e){this.disableMovements==null||this.disableMovements.mode!==void 0&&this.view.state.viewingMode!==this.disableMovements.mode||(e.zoom=this.disableMovements.zoom?0:e.zoom,e.ascend=this.disableMovements.ascend?0:e.ascend,e.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&dp(e.pan.matrix),e.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&dp(e.rotate.matrix))}static activatesFor(e,t){const i=KT(t,e.navigation.gamepad,bH);return!(t.action==="end"||Jy(i))}};u([p({constructOnly:!0})],Nl.prototype,"gamepadDevice",void 0),u([p({constructOnly:!0})],Nl.prototype,"disableMovements",void 0),Nl=u([R("esri.views.3d.state.controllers.GamepadKeyboardController")],Nl);const bH={translation:[0,0,0],heading:0,tilt:0,zoom:0},pD=80,wH=rt(pD),eS=.75,xH=5,CH=rt(30),TH=rt(80),il={zoom:0,ascend:0,pan:{enabled:!1,matrix:Ie()},rotate:{enabled:!1,matrix:Ie()}},us=x(),Lu=x(),SH=zI();function PH(s){s.zoom=0,s.ascend=0,s.pan.enabled=!1,dp(s.pan.matrix),s.rotate.enabled=!1,dp(s.rotate.matrix)}let MH=class extends Gi{constructor(e){super(!0),this._view=e,this._watchHandles=new b_,this._handle=this.registerIncoming("gamepad",t=>this._handleEventGamepad(t)),this._handle.pause()}onInstall(e){super.onInstall(e),this._watchHandles.add([$(()=>this._view.navigation.gamepad.enabled,t=>{t?this._handle.resume():(this._handle.pause(),this._cameraControllerGamepad&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null))},Re),$(()=>this._view.navigation.gamepad.device,t=>{this._cameraControllerGamepad&&t&&this._cameraControllerGamepad.gamepadDevice!==t&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null)})])}onUninstall(){this._watchHandles.removeAll(),super.onUninstall()}_handleEventGamepad(e){const t=this._view.navigation.gamepad.device;if(t&&e.data.device!==t)return;const i=this._cameraControllerGamepad?.running;if(i||Nl.activatesFor(this._view,e.data)){if(!i){const r=new Nl({view:this._view,gamepadDevice:e.data.device});this._view.state.switchCameraController(r),r.state!==1&&(this._cameraControllerGamepad=r)}this._cameraControllerGamepad&&this._cameraControllerGamepad.running&&this._cameraControllerGamepad.gamepadDevice===e.data.device&&this._cameraControllerGamepad.handleEventGamepad(e.data)}}};function $H(s){const e=()=>s(document.visibilityState==="visible");return document.addEventListener("visibilitychange",e),xn(()=>document.removeEventListener("visibilitychange",e))}let RH=class extends Gi{constructor(e,t){super(!0),this._view=e,this._keyToDirection=new Map,this._keyToAction=new Map,this._disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:2},this._stickyKeyTimeoutHandle=void 0,this._stickyKeyDuration=200,this._addKeysMapping(t),this.registerIncoming("key-down",null,i=>this._handleKeyDown(i)),this.registerIncoming("key-up",null,i=>this._handleKeyUp(i)),this.registerIncoming("blur",null,()=>this._handleStop()),this._visibilityHandle=$H(i=>i?null:this._handleStop())}onUninstall(){this._visibilityHandle?.remove(),this._handleStop()}setStickyKeyDuration(e){this._stickyKeyDuration=e}_addKeysMapping(e){this._addKeyMapping(e.pan.left,0),this._addKeyMapping(e.pan.right,1),this._addKeyMapping(e.pan.forward,2),this._addKeyMapping(e.pan.backward,3),this._addKeyMapping(e.pan.up,4),this._addKeyMapping(e.pan.down,5),this._addKeyMapping(e.lookAround.headingLeft,6),this._addKeyMapping(e.lookAround.headingRight,7),this._addKeyMapping(e.lookAround.tiltUp,8),this._addKeyMapping(e.lookAround.tiltDown,9),this._addKeyMapping(e.zoom.zoomIn,10),this._addKeyMapping(e.zoom.zoomOut,11),this._addKeyAction(e.reset.heading,()=>this._resetHeading()),this._addKeyAction(e.reset.tilt,()=>this._resetTilt())}_addKeyMapping(e,t){for(const i of this._eachKey(e))this._keyToDirection.set(i,t)}*_eachKey(e){typeof e=="string"?yield e:yield*e}_addKeyAction(e,t){for(const i of this._eachKey(e))this._keyToAction.set(i,t)}_handleKeyDown(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this._keyToAction.get(e.data.key);if(t!=null)return e.stopPropagation(),void t();const i=this._keyToDirection.get(e.data.key);if(i!=null&&(this._cameraControllerKeyboard&&this._cameraControllerKeyboard.running||(this._cameraControllerKeyboard=new Nl({view:this._view,disableMovements:this._disableMovements}),this._view.state.switchCameraController(this._cameraControllerKeyboard)),this._cameraControllerKeyboard.running)){if(e.stopPropagation(),this._cameraControllerKeyboard.directionActive(i)||(this._cameraControllerKeyboard.activateDirection(i),this._cameraControllerKeyboard.countActiveDirections()>1||!this._isPanning(i)))return;this._stickyKeyDuration>0&&(this._stickyKeyTimeoutHandle=setTimeout(()=>{this._stickyKeyTimeoutHandle=void 0,this._stickyDirection!=null&&this._stickyDirection!==void 0&&(this._cameraControllerKeyboard?.deactivateDirection(this._stickyDirection),this._stickyDirection=void 0)},this._stickyKeyDuration))}}_handleStop(){this._cameraControllerKeyboard?.running&&(this._cameraControllerKeyboard.finishController(),this._cameraControllerKeyboard=null)}_handleKeyUp(e){if(e.data.native.ctrlKey||e.data.native.metaKey||!this._cameraControllerKeyboard?.running)return;const t=this._keyToDirection.get(e.data.key);if(t==null)return;e.stopPropagation();const i=this._stickyKeyTimeoutHandle===void 0;this._stickyKeyTimeoutHandle===void 0||this._cameraControllerKeyboard?.countActiveDirections()!==1?(this._cameraControllerKeyboard?.deactivateDirection(t),i&&(this._stickyDirection=void 0)):this._stickyDirection=t}_isPanning(e){return e<=3}_resetHeading(){this._view.goTo({heading:0}).catch(()=>{})}_resetTilt(){this._view.goTo({tilt:0}).catch(()=>{})}},OH=class extends Gi{constructor(e,t){super(!0),this._view=e,this.registerIncoming("mouse-wheel",[t],i=>this._handleFov(i)),this.registerIncoming("mouse-wheel",i=>this._handleZoom(i))}_handleZoom(e){if(!this._mouseWheelZoomEnabled)return;const t=e.data;this._zoomController?.running||(this._stopFovController(),this._zoomController=this._view.state.isGlobal?new r_({view:this._view,mode:"interaction"}):new n_({view:this._view,mode:"interaction"}),this._view.state.switchCameraController(this._zoomController)),this._zoomController.step(-t.deltaY/60,ii(t.x,t.y)),e.preventDefault(),e.stopPropagation()}_handleFov(e){this._mouseWheelZoomEnabled&&(this._fovController?.running||(this._zoomController?.finish(),this._fovController?.hideOverlay(),this._fovController=new Hh({view:this._view,onStop:()=>this._stopFovController()}),this._view.state.switchCameraController(this._fovController),this._fovController.state!==1)?(this._fovController.updateTimeout(),this._fovController.step(e.data.deltaY/20),e.preventDefault(),e.stopPropagation()):this._stopFovController())}get _mouseWheelZoomEnabled(){return this._view.navigation.actionMap.mouseWheel==="zoom"}_stopFovController(){this._fovController?.finish(),this._fovController=null}},l_=class{constructor(e){this._gain=e}reset(e){this._value=e}set gain(e){this._gain=e}get value(){return this._value===void 0?0:this._value}update(e){this._value===void 0?this._value=e:this._value=this._gain*e+(1-this._gain)*this._value}},ac=class extends Sp{constructor(){super(...arguments),this._beginCamera=new vt,this._elapsedTime=Zi(0),this.constraintOptions=new gr(15,4,0,this._beginCamera)}initialize(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new ru}onControllerStart(e){this._beginCamera.copyFrom(e),super.onControllerStart(e)}stepController(e,t){t.copyViewFrom(this._beginCamera),this._elapsedTime=Zi(this._elapsedTime+e),this.momentumStep(this._elapsedTime,t),Vt(this.view,t,this.constraintOptions),this.momentum.isFinished(this._elapsedTime)&&this.finishController()}};ac=u([R("esri.views.3d.state.controllers.momentum.MomentumController")],ac);let Zd=class extends ac{constructor(e){super(e),this.interactionType=4,this._tmpPan=x()}momentumStep(e,t){const i=this.momentum.value(e);ee(this._tmpPan,this.momentum.direction,i),t.eye=he(tS,t.eye,this._tmpPan),t.center=he(tS,t.center,this._tmpPan),this.constraintOptions.interactionDirection=this._tmpPan}};u([p({constructOnly:!0})],Zd.prototype,"momentum",void 0),Zd=u([R("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],Zd);const tS=x(),DH=x(),zm=x();let Xf=class extends ac{constructor(e){super(e),this.interactionType=4}momentumStep(e,t){const i=this.momentum.value1(e),r=this.momentum.value2(e);q(zm,t.eye),pe(zm,zm),ti(this.momentum.axis2,zm,this.momentum.axis1),rD(t,DH,this.momentum.axis1,i,this.momentum.axis2,r)}};u([p({constructOnly:!0})],Xf.prototype,"momentum",void 0),Xf=u([R("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],Xf);let El=class extends ac{constructor(e){super(e),this.interactionType=2}momentumStep(e,t){const i=this.momentum.value(e);Uo(t,this.center,Pp(this.axis,i))}set center(e){this._set("center",Sn(e))}set axis(e){this._set("axis",Sn(e))}};u([p({constructOnly:!0})],El.prototype,"center",null),u([p({constructOnly:!0})],El.prototype,"axis",null),u([p({constructOnly:!0})],El.prototype,"momentum",void 0),El=u([R("esri.views.3d.state.controllers.momentum.RotationMomentumController")],El);let Mh=class extends ac{constructor(e){super(e),this.interactionType=1,this.constraintOptions.interactionDirection=x()}momentumStep(e,t){const{interactionDirection:i}=this.constraintOptions;if(!i)return;q(i,t.eye);const r=this.momentum.valueDelta(0,e);x1(t,this.zoomCenter,r,this.view.state.constraints.minimumPoiDistance),kw(i,t.eye,i)}set zoomCenter(e){this._set("zoomCenter",Sn(e))}};u([p({constructOnly:!0})],Mh.prototype,"momentum",void 0),u([p({constructOnly:!0})],Mh.prototype,"zoomCenter",null),Mh=u([R("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],Mh);let bl=class extends ac{constructor(e){super(e),this.radius=0,this.interactionType=1,this._tmpSceneCenter=x(),this._tmpZoomAxisAngle=B_(),this._sphere=Xs()}initialize(){this._sphere[3]=this.radius}momentumStep(e,t){const i=this.momentum.valueDelta(0,e);KO(this._sphere,t,i),this.constraintOptions.interactionType=1,Vt(this.view,t,this.constraintOptions),Mp(this._sphere,t,this.screenCenter,this._tmpSceneCenter),y1(this.sceneCenter,this._tmpSceneCenter,this._tmpZoomAxisAngle),Uo(t,Hi(this._sphere),this._tmpZoomAxisAngle),this.constraintOptions.interactionType=4}set screenCenter(e){this._set("screenCenter",ii(e[0],e[1]))}set sceneCenter(e){this._set("sceneCenter",Sn(e))}};u([p({constructOnly:!0})],bl.prototype,"momentum",void 0),u([p({constructOnly:!0})],bl.prototype,"radius",void 0),u([p({constructOnly:!0})],bl.prototype,"screenCenter",null),u([p({constructOnly:!0})],bl.prototype,"sceneCenter",null),bl=u([R("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],bl);let dn=class{constructor(e){this._gain=e,this.lastValue=void 0,this.filteredDelta=void 0}update(e){if(this.hasLastValue()){const t=this.computeDelta(e);this._updateDelta(t)}this.lastValue=e}reset(){this.lastValue=void 0,this.filteredDelta=void 0}hasLastValue(){return this.lastValue!==void 0}hasFilteredDelta(){return this.filteredDelta!==void 0}computeDelta(e){return this.lastValue===void 0?NaN:e-this.lastValue}_updateDelta(e){this.filteredDelta!==void 0?this.filteredDelta=(1-this._gain)*this.filteredDelta+this._gain*e:this.filteredDelta=e}},G_=class{constructor(e,t,i){this._initialVelocity=e,this._stopVelocity=t,this._friction=i,this._duration=Zi(Math.abs(Math.log(Math.abs(this._initialVelocity)/this._stopVelocity)/Math.log(1-this._friction)))}get duration(){return this._duration}isFinished(e){return e>this.duration}get friction(){return this._friction}value(e){return this.valueFromInitialVelocity(this._initialVelocity,e)}valueDelta(e,t){const i=this.value(e);return this.value(e+t)-i}valueFromInitialVelocity(e,t){t=Math.min(t,this.duration);const i=1-this.friction;return e*(i**t-1)/Math.log(i)}},EH=class extends G_{constructor(e,t,i,r,n){super(e,t,i),this._sceneVelocity=r,this.direction=n}value(e){return super.valueFromInitialVelocity(this._sceneVelocity,e)}},mD=class{constructor(e=300,t=12,i=.84){this._minimumInitialVelocity=e,this._stopVelocity=t,this._friction=i,this.enabled=!0,this._time=new dn(.6),this._screen=[new dn(.4),new dn(.4)],this._scene=[new dn(.6),new dn(.6),new dn(.6)],this._tmpDirection=x()}add(e,t,i){if(this.enabled){if(this._time.hasLastValue()&&this._time.computeDelta(i)<.015)return;this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._scene[0].update(t[0]),this._scene[1].update(t[1]),this._scene[2].update(t[2]),this._time.update(i)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._scene[0].reset(),this._scene[1].reset(),this._scene[2].reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta()||!this._time.hasFilteredDelta())return null;const e=this._screen[0].filteredDelta,t=this._screen[1].filteredDelta,i=e==null||t==null?0:Math.sqrt(e*e+t*t),r=this._time.filteredDelta,n=r==null||i==null?0:i/r;return Math.abs(n)<this._minimumInitialVelocity?null:this.createMomentum(n,this._stopVelocity,this._friction)}createMomentum(e,t,i){be(this._tmpDirection,this._scene[0].filteredDelta??0,this._scene[1].filteredDelta??0,this._scene[2].filteredDelta??0);const r=fe(this._tmpDirection);r>0&&ee(this._tmpDirection,this._tmpDirection,1/r);const n=this._time.filteredDelta;return new EH(e,t,i,n==null?0:r/n,this._tmpDirection)}},iS=class{constructor(e){this._gain=e}update(e){this.filteredValue!==void 0?this.filteredValue=(1-this._gain)*this.filteredValue+this._gain*e:this.filteredValue=e}reset(){this.filteredValue=void 0}get hasFilteredValue(){return this.filteredValue!==void 0}};const sS=1e-5;let AH=class extends G_{constructor(e,t,i,r,n,a=0,o){super(e,t,i),this._angularVelocity1=r,this.axis1=n,this.angularVelocity2=a,this.axis2=o}value1(e){return super.valueFromInitialVelocity(this._angularVelocity1,e)}value2(e){return super.valueFromInitialVelocity(this.angularVelocity2,e)}},IH=class{constructor(e=300,t=12,i=.84){this._minimumInitialVelocity=e,this._stopVelocity=t,this._friction=i,this.enabled=!0,this._tmpAxis1=x(),this._tmpAxis2=x(),this._tmpAngles=ke(),this._time=new dn(.3),this._screen=[new dn(.4),new dn(.4)],this._angle1=new iS(.6),this._angle2=new iS(.6),this._axis1=x(),this._axis2=x(),this._lastScene=x()}addMomentumDirectRotation(e,t,i,r,n,a){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(i)<.01)return;let o=iD(this._lastScene,t,this._tmpAxis2,r,n,a);this._angle2.update(0),Gs(this._tmpAxis2)<sS?o=0:pe(this._axis1,this._tmpAxis2),this._angle1.update(o),q(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(i)}}addMomentumPreserveHeading(e,t,i,r,n,a,o){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(i)<.01)return;sD(this._lastScene,t,this._tmpAxis2,this._tmpAxis1,this._tmpAngles,r,n,a,o,!1),Gs(this._tmpAxis2)<sS?(this._angle1.update(0),this._angle2.update(0)):(this._angle1.update(this._tmpAngles[1]),this._angle2.update(this._tmpAngles[0]),pe(this._axis1,this._tmpAxis1),pe(this._axis2,this._tmpAxis2)),q(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(i)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._angle1.reset(),this._angle2.reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta())return null;const e=this._screen[0].filteredDelta,t=this._screen[1].filteredDelta,i=e==null||t==null?null:Math.sqrt(e*e+t*t),r=this._time.filteredDelta,n=i==null||r==null?0:i/r;return Math.abs(n)<this._minimumInitialVelocity?null:this.createMomentum(n,this._stopVelocity,this._friction)}createMomentum(e,t,i){const r=this._time.filteredDelta,n=this._angle1.filteredValue,a=this._angle2.filteredValue,o=r==null||a==null?0:a/r;return new AH(e,t,i,r==null||n==null?0:n/r,this._axis1,o,this._axis2)}},fD=class{constructor(e=2.5,t=.01,i=.95,r=12){this._minimumInitialVelocity=e,this._stopVelocity=t,this._friction=i,this._maxVelocity=r,this.enabled=!0,this.value=new dn(.8),this.time=new dn(.3)}add(e,t){if(this.enabled&&t!=null){if(this.time.hasLastValue()){if(this.time.computeDelta(t)<.01)return;if(this.value.hasFilteredDelta()){const i=this.value.computeDelta(e);this.value.filteredDelta*i<0&&this.value.reset()}}this.time.update(t),this.value.update(e)}}reset(){this.value.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.value.hasFilteredDelta()||!this.time.hasFilteredDelta())return null;let e=this.value.filteredDelta/this.time.filteredDelta;return e=U(e,-this._maxVelocity,this._maxVelocity),Math.abs(e)<this._minimumInitialVelocity?null:this.createMomentum(e,this._stopVelocity,this._friction)}createMomentum(e,t,i){return new G_(e,t,i)}},gD=class extends fD{constructor(e=3,t=.01,i=.95,r=12){super(e,t,i,r)}add(e,t){const i=this.value.lastValue;if(i!=null){let r=e-i;for(;r>Math.PI;)r-=2*Math.PI;for(;r<-Math.PI;)r+=2*Math.PI;e=i+r}super.add(e,t)}},LH=class extends G_{constructor(e,t,i){super(e,t,i)}value(e){const t=super.value(e);return Math.exp(t)}valueDelta(e,t){const i=super.value(e),r=super.value(e+t)-i;return Math.exp(r)}},_D=class extends fD{constructor(e=2.5,t=.01,i=.95,r=12){super(e,t,i,r)}add(e,t){super.add(Math.log(e),t)}createMomentum(e,t,i){return new LH(e,t,i)}},Tb=class extends vn{constructor(){super(...arguments),this._smoothRotation=new l_(.05),this._rotationAxis=x(),this._beginAngle=0,this._beginHeading=0,this._panningPlane=Ha(),this._beginRadius=0,this._smoothScaling=new l_(.05),this._zoomCenterScreen=ii(),this._zoomMomentumEstimator=new _D,this._rotationMomentumEstimator=new gD,this._panSphericalMomentumEstimator=new IH,this._panPlanarMomentumEstimator=new mD,this._adjustedSphere=Xs(),this._tmp3d=x(),this._tmpScreenPointArray=ii(),this._beginScreenPoint=ii(),this._beginScenePoint=x(),this._screenPickPoint=ii(),this._scenePickPoint=x(),this._navigationMode=1,this._sphere=Xs(),this._pointerCount=0,this._tmpInteractionDirection=x(),this._beginCamera=new vt,this._constraintOptions=new gr(15,0,0,this._beginCamera)}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.running)return;this._zoomMomentumEstimator.enabled=this._rotationMomentumEstimator.enabled=this._panPlanarMomentumEstimator.enabled=this._panSphericalMomentumEstimator.enabled=this.view.navigation.momentumEnabled,this._beginHeading=-ko.normalize(rt(this.view.camera.heading)),this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._smoothRotation.reset(),mn(e.center,this._screenPickPoint),pr(this._beginScreenPoint,this._screenPickPoint);const t=eD(this._intersectionHelper,this.startCamera,this._screenPickPoint,Zt(this.view.spatialReference).radius,1,this.view.basemapTerrain.invisible?mc:{});t.scenePickPoint!=null&&(this._scenePickPoint=t.scenePickPoint,this._sphere=t.sphere,q(this._beginScenePoint,this._scenePickPoint),this._navigationMode=Zp(this.startCamera,this._screenPickPoint,this.view.renderCoordsHelper,this.view.viewingMode),this._navigationMode===0&&this._preparePlanarPanMode(e,t.hasGeometryIntersection),this._beginCamera.copyFrom(this.startCamera))}update(e){if(!this.running)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1;this._navigationMode===1?(t&&this._zoomSpherical(e),this._panningSpherical(e),t&&this._rotateSpherical(e)):(t&&this._zoomPlanar(e),this._panningPlanar(e),t&&this._rotatePlanar(e)),this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return this._navigationMode===1?new bl({view:this.view,momentum:t,screenCenter:this._zoomCenterScreen,sceneCenter:this._beginScenePoint,radius:this._sphere[3]}):new Mh({view:this.view,momentum:t,zoomCenter:this._beginScenePoint});const i=this._rotationMomentumEstimator.evaluateMomentum();if(i)return new El({view:this.view,momentum:i,center:fp(this._sphere,x()),axis:this._rotationAxis});if(this._navigationMode===1){const r=this._panSphericalMomentumEstimator.evaluateMomentum();if(r)return new Xf({view:this.view,momentum:r})}else{const r=this._panPlanarMomentumEstimator.evaluateMomentum();if(r)return new Zd({view:this.view,momentum:r})}return null}_preparePlanarPanMode(e,t){const i=La(this._tmp3d,this.startCamera.viewForward);G$(this._scenePickPoint,i,this._panningPlane);const r=ii(this._screenPickPoint[0],0),n=x(),a=fe(this.startCamera.eye);this._adjustedSphere[3]=a<this._sphere[3]?a-100:this._sphere[3],Mp(this._adjustedSphere,this.startCamera,r,n);const o=x(),l=x(),c=x();he(o,this._scenePickPoint,this.currentCamera.eye);const h=fe(o);pe(o,o);const d=XO*Math.max(Math.abs(this.view.camera.position.z),YO),m=this.view.stage.renderView.getMinimalDepthForArea(null,this._screenPickPoint[0],this._screenPickPoint[1],this.view.state.camera,Qp);let f=m??d;t&&(f=Math.min(f,h)),q(c,ce(l,this.currentCamera.eye,ee(l,o,f))),this._panningPlane[3]=-We(cn(this._panningPlane),c),this.startCamera.center=ce(l,this.startCamera.eye,ee(l,this.startCamera.viewForward,f));const g=mn(e.center,this._tmpScreenPointArray);bb(this._panningPlane,this.startCamera,g,this._beginScenePoint)}_zoomSpherical(e){const t=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=i,this._smoothScaling.update(t),KO(this._sphere,this.currentCamera,this._smoothScaling.value),mn(e.center,this._zoomCenterScreen),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),this._constraintOptions.interactionType=1,this._constraintOptions.interactionFactor=Er(e.radius-this._beginRadius),Vt(this.view,this.currentCamera,this._constraintOptions)}_panningSpherical(e){const t=mn(e.center,this._tmpScreenPointArray);Mp(this._sphere,this.currentCamera,t,this._tmp3d),C1(this._beginScenePoint,We(this.currentCamera.up,this._beginScenePoint),this._sphere[3],this._beginHeading,this.view.camera.tilt,this.startCamera.aboveGround)?(aD(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this._beginHeading,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumPreserveHeading(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere,this._beginHeading,this.view.camera.tilt)):(nD(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumDirectRotation(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere[3],this.view.camera.tilt)),this._constraintOptions.interactionType=4,this._constraintOptions.interactionFactor=Er(hp(this._screenPickPoint,t)),Vt(this.view,this.currentCamera,this._constraintOptions)}_rotateSpherical(e){pe(this._rotationAxis,this._scenePickPoint),this.currentCamera.aboveGround||La(this._rotationAxis,this._rotationAxis);const t=this._smoothRotation.value,i=t+vb(e.angle-t),r=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=r,this._smoothRotation.update(i);const n=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(n,.001*e.timestamp),Uo(this.currentCamera,Hi(this._sphere),Pp(this._rotationAxis,n)),this._constraintOptions.interactionType=2,this._constraintOptions.interactionFactor=Er(e.radius*i),Vt(this.view,this.currentCamera,this._constraintOptions)}_panningPlanar(e){const t=mn(e.center,this._tmpScreenPointArray);bb(this._panningPlane,this.currentCamera,t,this._tmp3d)&&(tD(this.currentCamera,this._beginScenePoint,this._tmp3d),this._panPlanarMomentumEstimator.add(t,this._tmp3d,.001*e.timestamp),this._constraintOptions.interactionType=4,this._constraintOptions.interactionFactor=Er(hp(this._beginScreenPoint,t)),this._constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this._tmpInteractionDirection),Vt(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null)}_zoomPlanar(e){const t=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=i,this._smoothScaling.update(t),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),x1(this.currentCamera,this._beginScenePoint,this._smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this._constraintOptions.interactionType=1,this._constraintOptions.interactionFactor=Er(e.radius-this._beginRadius),Vt(this.view,this.currentCamera,this._constraintOptions)}_rotatePlanar(e){q(this._rotationAxis,this._beginScenePoint),this.currentCamera.aboveGround||La(this._rotationAxis,this._rotationAxis);const t=this._smoothRotation.value;let i=e.angle-t;i=vb(i);const r=t+i,n=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=n,this._smoothRotation.update(r);const a=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(a,.001*e.timestamp),Uo(this.currentCamera,Hi(this._sphere),Pp(this._rotationAxis,a)),this._constraintOptions.interactionType=2,this._constraintOptions.interactionFactor=Er(e.radius*a),Vt(this.view,this.currentCamera,this._constraintOptions)}};Tb=u([R("esri.views.3d.state.controllers.PinchAndPanControllerGlobal")],Tb);const rS=Qe(0,0,1);let Sb=class extends vn{constructor(){super(...arguments),this._rotationValueSmooth=new l_(.05),this._scalingValueSmooth=new l_(.05),this._planeHorizontal=Ha(),this._planeVertical=Ha(),this._rotationMomentumEstimator=new gD,this._panMomentumEstimator=new mD(300,12,.9),this._zoomMomentumEstimator=new _D,this._beginRadius=0,this._beginCenter=x(),this._beginAngle=0,this._tmpPoints=[],this._navigationMode=1,this._beginCenterScreen=ii(),this._tmpCentroid3d=x(),this._tmpCentroid2d=ii(),this._tmp2d=ii(),this._pointerCount=0,this._beginCamera=new vt,this._constraintOptions=new gr(15,0,0,this._beginCamera)}begin(e){if(!this.running)return;const t=this.view.navigation.momentumEnabled;this._zoomMomentumEstimator.enabled=t,this._rotationMomentumEstimator.enabled=t,this._panMomentumEstimator.enabled=t,this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._rotationValueSmooth.reset(),this._scalingValueSmooth.reset(),mn(e.center,this._beginCenterScreen),q$(rS,0,this._planeHorizontal);const i=x(),r=this._intersectionHelper.intersectScreenFreePointFallback(this._beginCenterScreen,i,this.view.basemapTerrain.invisible?mc:{}),n=x();La(n,this.startCamera.viewForward);const a=x();q(a,rS);const o=We(n,a);this._navigationMode=Zp(this.startCamera,this._beginCenterScreen,this.view.renderCoordsHelper,this.view.viewingMode);const l=bu(a,this.startCamera.viewForward,XO)*Math.max(Math.abs(this.view.camera.position.z),YO);oC(this._planeHorizontal,this._planeHorizontal,i),this.startCamera.aboveGround||U5(this._planeHorizontal,this._planeHorizontal);const c=x(),h=x(),d=x();he(c,i,this.currentCamera.eye);const m=fe(c);if(pe(c,c),this._navigationMode===0){ee(a,a,o),he(cn(this._planeVertical),n,a),pe(cn(this._planeVertical),cn(this._planeVertical)),oC(this._planeVertical,this._planeVertical,i);const f=this.view.stage.renderView.getMinimalDepthForArea($p(this.view),this._beginCenterScreen[0],this._beginCenterScreen[1],this.view.state.camera,Qp);let g=f??l;r&&(g=Math.min(g,m)),q(d,ce(h,this.currentCamera.eye,ee(h,c,g))),this._planeVertical[3]=-We(cn(this._planeVertical),d),this._computePlanePoints(e.pointers,this._planeVertical,this.startCamera,this._tmpPoints),Uy(this._tmpPoints,this._beginCenter)}else{const f=r?m:l;q(d,ce(h,this.currentCamera.eye,ee(h,c,f))),this._planeHorizontal[3]=-We(cn(this._planeHorizontal),d),this._computePlanePoints(e.pointers,this._planeHorizontal,this.startCamera,this._tmpPoints),Uy(this._tmpPoints,this._beginCenter)}this._beginCamera.copyFrom(this.startCamera)}update(e){if(!this.running)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1,i=this._navigationMode===1?this._planeHorizontal:this._planeVertical,r=this._beginCenter;if(t){const n=this._beginRadius/e.radius,a=.001875*Math.min(Math.max(e.radius,40),120);this._scalingValueSmooth.gain=a,this._scalingValueSmooth.update(n),x1(this.currentCamera,r,this._scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this._zoomMomentumEstimator.add(this._scalingValueSmooth.value,.001*e.timestamp),this._constraintOptions.interactionType=1,this._constraintOptions.interactionFactor=Er(Math.abs(e.radius-this._beginRadius)),Vt(this.view,this.currentCamera,this._constraintOptions)}if(this._computePlanePoints(e.pointers,i,this.currentCamera,this._tmpPoints),Uy(this._tmpPoints,this._tmpCentroid3d),mn(e.center,this._tmpCentroid2d),tD(this.currentCamera,r,this._tmpCentroid3d),this._panMomentumEstimator.add(this._tmpCentroid2d,this._tmpCentroid3d,.001*e.timestamp),this._constraintOptions.interactionType=4,this._constraintOptions.interactionFactor=Er(hp(this._beginCenterScreen,this._tmpCentroid2d)),Vt(this.view,this.currentCamera,this._constraintOptions),t){const n=r,a=this._rotationValueSmooth.value,o=a+vb(e.angle-a),l=.00125*Math.min(Math.max(e.radius,40),120);this._rotationValueSmooth.gain=l,this._rotationValueSmooth.update(o);const c=this._rotationValueSmooth.value-this._beginAngle;this._rotationMomentumEstimator.add(c,.001*e.timestamp);const h=cn(this._planeHorizontal);Uo(this.currentCamera,n,Pp(h,c)),this._constraintOptions.interactionType=2,this._constraintOptions.interactionFactor=Er(Math.abs(e.radius*c)),Vt(this.view,this.currentCamera,this._constraintOptions)}this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return new Mh({view:this.view,momentum:t,zoomCenter:this._beginCenter});const i=this._rotationMomentumEstimator.evaluateMomentum();if(i)return new El({view:this.view,momentum:i,center:this._beginCenter,axis:cn(this._planeHorizontal)});const r=this._panMomentumEstimator.evaluateMomentum();return r?new Zd({view:this.view,momentum:r}):null}_computePlanePoints(e,t,i,r){r.length=e.size;const n=this._tmp2d;let a=0;return e.forEach(o=>{n[0]=o.x,n[1]=o.y,r[a]===void 0&&(r[a]=x()),bb(t,i,n,r[a]),a+=1}),r}get _intersectionHelper(){return this.view.sceneIntersectionHelper}};Sb=u([R("esri.views.3d.state.controllers.PinchAndPanControllerLocal")],Sb);let nS=class extends Gi{constructor(e,t,i){super(!0),this._view=e,this.pointerActions=t,this._lastEndTimestamp=0,this._lastTimestamp=0,this.registerIncoming("drag",i,r=>this._handleDrag(r))}_handleDrag(e){if(e.data.pointerType==="mouse"&&!S1(e.data,this.pointerActions))return;const t=e.timestamp-this._lastEndTimestamp,i=40,r=this._momentum&&this._momentum.running&&t<i;switch(e.data.action){case"start":case"update":if(r)break;this._controller&&this._controller.running?e.data.timestamp-this._lastTimestamp>2&&(this._controller.update(e.data),this._lastTimestamp=e.timestamp):this._startController(e);break;case"end":case"removed":this._endController(e,!0);break;case"added":this._endController(e,!1),this._startController(e)}e.stopPropagation()}_endController(e,t){if(this._controller?.running){this._lastEndTimestamp=e.timestamp;const i=this._controller.end(e.data);t&&i&&(this._momentum=i,this._view.state.switchCameraController(this._momentum))}this._controller=null}_startController(e){this._controller=this._createController(),this._view.state.switchCameraController(this._controller),this._controller.begin(e.data),this._lastTimestamp=e.timestamp}_createController(){return this._view.state.isGlobal?new Tb({view:this._view}):new Sb({view:this._view})}},FH=class extends Gi{constructor(e,t){super(!0),this.view=e,this.registerIncoming("pointer-down",t,()=>this.view.state.stopActiveCameraController())}},VH=class extends Gi{constructor(e,t=!1){super(!0),this._view=e,this._invert=t,this.registerIncoming("vertical-two-finger-drag",i=>this._handleTwoFinger(i))}_handleTwoFinger(e){const t=this._invert?-1:1,i=ii(0,e.data.delta*t);switch(e.data.action){case"begin":this._cameraController?.end(),this._cameraController=new Wd({view:this._view,pivot:0}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break;case"update":this._cameraController?.update(i);break;case"end":this._cameraController?.end(),this._cameraController=null}}};function aS(s){const e=s.native;return e?{buttons:e.buttons.map(t=>t.pressed?t.value||1:0),axes:e.axes.map(t=>BH(t,s.axisThreshold))}:{buttons:[],axes:[]}}function kH(s,e){if(s.axes.length!==e.axes.length||s.buttons.length!==e.buttons.length)return!1;for(let t=0;t<s.axes.length;t++)if(s.axes[t]!==e.axes[t])return!1;for(let t=0;t<s.buttons.length;t++)if(s.buttons[t]!==e.buttons[t])return!1;return!0}function zH(s){for(let e=0;e<s.axes.length;e++)if(s.axes[e]!==0)return!1;for(let e=0;e<s.buttons.length;e++)if(s.buttons[e]!==0)return!1;return!0}function BH(s,e){const t=Math.abs(s);return t<e?0:Math.sign(s)*(t-e)/(1-e)}let NH=class{constructor(e,t){this._element=e,this._input=t,this._hasEventListeners=!1,this._onConnectGamepad=n=>{this._connectGamepad(n.gamepad)},this._onDisconnectGamepad=n=>{const a=n.gamepad,o=a.index,l=this._inputDevices[o];l&&(this._emitGamepadEvent(a,aS(l),!1),this._inputDevices.splice(o,1),this._latestUpdate.splice(o,1),this._input.gamepad.devices.remove(l),this.ensurePollingState())},this._frameTask=null,this._latestUpdate=new Array,this._inputDevices=new Array,this._callback=null;const i="getGamepads"in window.navigator,r=window.isSecureContext;this.supported=i&&r,this.supported&&(oS(n=>this._connectGamepad(n)),window.addEventListener("gamepadconnected",this._onConnectGamepad),window.addEventListener("gamepaddisconnected",this._onDisconnectGamepad),this.ensurePollingState())}destroy(){this.hasEventListeners=!1,this.supported&&(window.removeEventListener("gamepadconnected",this._onConnectGamepad),window.removeEventListener("gamepaddisconnected",this._onDisconnectGamepad))}set hasEventListeners(e){this._hasEventListeners!==e&&(this._hasEventListeners=e,this.ensurePollingState())}get _eventsEnabled(){return this.supported&&this._inputDevices.length>0&&this._hasEventListeners}set onEvent(e){this._callback=e}_connectGamepad(e){const t=new s1(e);t.deviceType!=="unknown"&&(this._inputDevices[e.index]=t,this._input.gamepad.devices.add(t)),this.ensurePollingState()}ensurePollingState(){this._eventsEnabled?this._startPolling():this._stopPolling()}_startPolling(){this._frameTask==null&&(this._frameTask=Kl({update:()=>this._readGamepadState()}))}_stopPolling(){this._frameTask!=null&&(this._frameTask.remove(),this._frameTask=null,this._latestUpdate=new Array)}_readGamepadState(){const e=document.hasFocus(),t=this._element.contains(document.activeElement),i=this._input.gamepad.enabledFocusMode==="document"&&!e||this._input.gamepad.enabledFocusMode==="view"&&!t;oS(r=>{const n=this._inputDevices[r.index];if(!n)return;const a=this._latestUpdate[r.index],o=aS(n),l=i||zH(o);a&&(a.timestamp===r.timestamp||!a.active&&l||kH(a.state,o))||this._emitGamepadEvent(r,o,!l)})}_emitGamepadEvent(e,t,i){const r=this._latestUpdate[e.index],n=r&&r.active;if(!n&&!i)return;const a=!n&&i?"start":n&&i?"update":"end";this._latestUpdate[e.index]={timestamp:e.timestamp,state:t,active:i},this._callback&&this._callback({device:this._inputDevices[e.index],state:t,action:a})}};function UH(s){if(!s||!s.connected)return!1;for(let e=0;e<s.axes.length;e++)if(isNaN(s.axes[e]))return!1;return!0}function oS(s){for(const e of navigator.getGamepads())UH(e)&&s(e)}const lS=Ze("edge"),HH=Ze("chrome"),qH=Ze("ff"),GH=Ze("safari"),cS="esri-view-surface",Rc={touchNone:`${cS}--touch-none`,touchPan:`${cS}--touch-pan`};let jH=class yD{static{this.test={disableSubpixelCoordinates:!1}}constructor(e,t){this._active={},this._callback=()=>{},this._activePointerCaptures=new Set,this._keyDownState=new Set,this._eventId=1,this._browserTouchPanningEnabled=!1,this._element=e,e.getAttribute("tabindex")||e.setAttribute("tabindex","0"),this._eventHandlers={"key-down":this._handleKey,"key-up":this._handleKey,"pointer-down":this._handlePointer,"pointer-move":this._handlePointerPreventDefault,"pointer-up":this._handlePointerPreventDefault,"pointer-enter":this._handlePointer,"pointer-leave":this._handlePointer,"pointer-cancel":this._handlePointer,"mouse-wheel":this._handleMouseWheel,"pointer-capture-lost":this._handlePointerCaptureLost},this._updateTouchAction(),this._element.addEventListener("keydown",this._preventAltKeyDefault),this._gamepadSource=new NH(e,t),this._gamepadSource.onEvent=i=>this._callback("gamepad",i)}destroy(){this._callback=()=>{},this.activeEvents=null,this._activePointerCaptures.forEach(e=>this._releasePointerCaptureSafe(e)),this._activePointerCaptures.clear(),this._gamepadSource=Q(this._gamepadSource),this._removeTouchAction(),this._element.removeEventListener("keydown",this._preventAltKeyDefault)}get browserTouchPanningEnabled(){return this._browserTouchPanningEnabled}set browserTouchPanningEnabled(e){this._browserTouchPanningEnabled=e,this._updateTouchAction(),this._updateTouchEventHandling()}set onEventReceived(e){this._callback=e}set activeEvents(e){for(const t in this._active)if(!e||!e.has(t)){const i=this._active[t];this._element.removeEventListener(ev[t],i),delete this._active[t]}e&&e.forEach(t=>{if(!this._active[t]&&ev[t]){const i=(this._eventHandlers[t]||this._handleDefault).bind(this,t);this._element.addEventListener(ev[t],i),this._active[t]=i}}),this._gamepadSource&&(this._gamepadSource.hasEventListeners=e?.has("gamepad")??!1)}setPointerCapture(e,t){t?this._setPointerCaptureSafe(e.pointerId):(this._releasePointerCaptureSafe(e.pointerId),this._activePointerCaptures.delete(e.pointerId))}_updateTouchAction(){this._element.classList.remove(this._browserTouchPanningEnabled?Rc.touchNone:Rc.touchPan),this._element.classList.add(this._browserTouchPanningEnabled?Rc.touchPan:Rc.touchNone)}_updateTouchEventHandling(){this._browserTouchPanningEnabled?this._element.addEventListener("touchmove",this._preventMultiTouchPanning):this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_removeTouchAction(){this._element.classList.remove(Rc.touchNone),this._element.classList.remove(Rc.touchPan),this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_setPointerCaptureSafe(e){try{this._element.setPointerCapture(e),this._activePointerCaptures.add(e)}catch{}}_releasePointerCaptureSafe(e){try{if(this._element.hasPointerCapture&&!this._element.hasPointerCapture(e))return;this._element.releasePointerCapture(e)}catch{}}_updateNormalizedPointerLikeEvent(e,t){const i=IR(this._element,e);return yD.test.disableSubpixelCoordinates&&(i.x=Math.round(i.x),i.y=Math.round(i.y)),t.x=i.x,t.y=i.y,t}_handleKey(e,t){const{key:i}=t;i&&e==="key-up"&&this._keyDownState.delete(i);const r={native:t,key:i,repeat:!!i&&this._keyDownState.has(i)};i&&e==="key-down"&&this._keyDownState.add(r.key),this._callback(e,r)}_handlePointer(e,t){const i=this._updateNormalizedPointerLikeEvent(t,{native:t,x:0,y:0,pointerType:t.pointerType,button:t.button,buttons:t.buttons,eventId:this._eventId++});this._callback(e,i)}_handlePointerPreventDefault(e,t){const i=this._updateNormalizedPointerLikeEvent(t,{native:t,x:0,y:0,pointerType:t.pointerType,button:t.button,buttons:t.buttons,eventId:this._eventId++});t.preventDefault(),this._callback(e,i)}_getDeltaFromTrackpadOrMouseWheel(e){return e.shiftKey&&Ze("mac")&&e.deltaY===0?e.deltaX:e.deltaY}_handleMouseWheel(e,t){let i=this._getDeltaFromTrackpadOrMouseWheel(t);switch(t.deltaMode){case 0:lS&&(i=i/document.documentElement.clientHeight*600);break;case 1:i*=30;break;case 2:i*=900}lS?i*=.7:HH||GH?i*=.6:qH&&(i*=1.375);const r=100,n=Math.abs(i);n>r&&(i=i/n*200/(1+Math.exp(-.02*(n-r))));const a=this._updateNormalizedPointerLikeEvent(t,{native:t,x:0,y:0,deltaY:i});this._callback(e,a)}_handlePointerCaptureLost(e,t){this._activePointerCaptures.delete(t.pointerId),this._handleDefault(e,t)}_handleDefault(e,t){const i={native:t};t.preventDefault(),this._callback(e,i)}_preventAltKeyDefault(e){e.key==="Alt"&&e.preventDefault()}_preventMultiTouchPanning(e){e.touches.length>1&&e.preventDefault()}};const ev={"key-down":"keydown","key-up":"keyup","pointer-down":"pointerdown","pointer-up":"pointerup","pointer-move":"pointermove","mouse-wheel":"wheel","pointer-capture-got":"gotpointercapture","pointer-capture-lost":"lostpointercapture","context-menu":"contextmenu","pointer-enter":"pointerenter","pointer-leave":"pointerleave","pointer-cancel":"pointercancel",focus:"focus",blur:"blur"};let WH=class extends Gi{constructor(){super(!0),this.registerIncoming("context-menu",e=>e.data.native.preventDefault())}};const vD=()=>({maximumClickDelay:300}),QH=(s={})=>({...vD(),movementUntilMouseDrag:1.5,movementUntilPenDrag:6,movementUntilTouchDrag:6,holdDelay:500,...s}),bD=(s={})=>({...vD(),maximumDoubleClickDistance:10,maximumDoubleTouchDistance:35,maximumDoubleClickDelay:250,maximumDoubleTouchDelay:350,...s});function Pb(s,e){return Math.abs(e.x-s.x)+Math.abs(e.y-s.y)}function ZH(s,e){const t=e.x-s.x,i=e.y-s.y;return Math.sqrt(t*t+i*i)}function XH(s,e){if(e?(e.radius=0,e.center.x=0,e.center.y=0):e={radius:0,center:dr()},s.length===0)return e;if(s.length===1)return e.center.x=s[0].x,e.center.y=s[0].y,e;if(s.length===2){const[w,S]=s,[C,P]=[S.x-w.x,S.y-w.y];return e.radius=Math.sqrt(C*C+P*P)/2,e.center.x=(w.x+S.x)/2,e.center.y=(w.y+S.y)/2,e}let t=0,i=0;for(let w=0;w<s.length;w++)t+=s[w].x,i+=s[w].y;t/=s.length,i/=s.length;const r=s.map(w=>w.x-t),n=s.map(w=>w.y-i);let a=0,o=0,l=0,c=0,h=0,d=0,m=0;for(let w=0;w<r.length;w++){const S=r[w],C=n[w],P=S*S,M=C*C;a+=P,o+=M,l+=S*C,c+=P*S,h+=M*C,d+=S*M,m+=C*P}const f=.5*(c+d),g=.5*(h+m),_=a*o-l*l,v=(f*o-g*l)/_,b=(a*g-l*f)/_,T=dr(v+t,b+i);return{radius:Math.sqrt(v*v+b*b+(a+o)/s.length),center:T}}function Xd(s){const{native:e}=s,{pointerId:t,button:i,pointerType:r}=e;return r==="mouse"?`${t}:${i}`:`${r}`}let YH=class extends Gi{constructor(e){super(!1),this._navigationTouch=e,this._startStateModifiers=new Set,this._activePointerMap=new Map,this._isDragging=!1,this._isCurrentDragSuppressed=!1,this._drag=this.registerOutgoing("drag"),this.registerIncoming("pointer-drag",this._handlePointerDrag.bind(this)),this.registerIncoming("pointer-up",this._handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-capture-lost",this._handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-cancel",this._handlePointerUpAndPointerLost.bind(this))}_createPayload(e,t,i,r){return{action:e,pointerType:this._pointerType,button:this._mouseButton,buttons:t.buttons,timestamp:r,pointers:KH(this._activePointerMap),pointer:t,angle:i.angle,radius:i.radius,center:i.center}}_addPointer(e){const t=e.native.pointerId,i=Bm(this._activePointerMap).angle,r={event:e,initialAngle:0,lastAngle:0};this._activePointerMap.set(t,r);const n=Yf(r,wD(this._activePointerMap));r.initialAngle=n,r.lastAngle=n,this._updatePointerAngles(i)}_updatePointer(e){if(e&&e.x==null&&e.y==null)return;const t=e.native.pointerId,i=this._activePointerMap.get(t);i?i.event=e:this._addPointer(e)}_removePointer(e){const t=Bm(this._activePointerMap).angle;this._activePointerMap.delete(e),this._updatePointerAngles(t)}_updatePointerAngles(e){const t=Bm(this._activePointerMap);this._activePointerMap.forEach(i=>{i.initialAngle=Yf(i,t)-e,i.lastAngle=Yf(i,t)-e})}_emitEvent(e,t,i){const r=Bm(this._activePointerMap);this._drag.emit(this._createPayload(e,t,r,i),void 0,this._startStateModifiers)}_handlePointerUpAndPointerLost(e){const t=e.data.native.pointerId,i=$e(e.timestamp);this._activePointerMap.get(t)&&(this._activePointerMap.size===1?(this._updatePointer(e.data),!this._isCurrentDragSuppressed&&this._emitEvent("end",e.data,i),this._isDragging=!1,this._isCurrentDragSuppressed=!1,this._removePointer(t)):(this._removePointer(t),this._emitEvent("removed",e.data,$e(e.timestamp))))}_handlePointerDrag(e){const t=e.data,i=t.currentEvent,r=$e(e.timestamp);switch(t.action){case"start":case"update":this._isDragging?this._activePointerMap.has(i.native.pointerId)?(this._updatePointer(i),!this._isCurrentDragSuppressed&&this._emitEvent("update",i,r)):(this._addPointer(i),this._emitEvent("added",i,r),this._isCurrentDragSuppressed=this._isSuppressed):(this._updatePointer(i),this._pointerType=e.data.startEvent.pointerType,this._mouseButton=e.data.startEvent.button,this._startStateModifiers=e.modifiers,this._isDragging=!0,this._isCurrentDragSuppressed=this._isSuppressed,!this._isCurrentDragSuppressed&&this._emitEvent("start",i,r))}}get _isSuppressed(){return!!this._navigationTouch&&!this._navigationTouch.browserTouchPanEnabled&&this._pointerType==="touch"&&this._activePointerMap.size===1}};function wD(s){const e=[];return s.forEach(t=>{e.push(dr(t.event.x,t.event.y))}),XH(e)}function Bm(s){const e=wD(s);let t=0;return s.forEach(i=>{let r=Yf(i,e),n=r-i.lastAngle;for(;n>Math.PI;)n-=2*Math.PI;for(;n<-Math.PI;)n+=2*Math.PI;r=i.lastAngle+n,i.lastAngle=r;const a=r-i.initialAngle;t+=a}),t/=s.size||1,{angle:t,radius:e.radius,center:e.center}}function KH(s){const e=new Map;return s.forEach((t,i)=>e.set(i,t.event)),e}function Yf(s,e){const t=s.event,i=t.x-e.center.x,r=t.y-e.center.y;return Math.atan2(r,i)}let JH=class extends Gi{constructor(e={},t=Ip){super(!1),this._clock=t,this._pointerState=new Map,this._parameters=bD(e),this._immediateDoubleClick=this.registerOutgoing("immediate-double-click"),this.registerIncoming("pointer-down",this._handlePointerDown.bind(this)),this.registerIncoming("pointer-up",this._handlePointerUp.bind(this))}onUninstall(){this._pointerState.forEach(e=>{e.immediateDoubleClick&&e.immediateDoubleClick.timeoutHandle.remove()}),super.onUninstall()}_handlePointerDown(e){const t=e.data,i=Xd(t);if(!this._pointerState.has(i)){const r={downButton:t.native.button,x:t.x,y:t.y,immediateDoubleClick:null};this._pointerState.set(i,r),this.startCapturingPointer(t.native)}}_handlePointerUp(e){const t=e.data,i=Xd(t),r=this._pointerState.get(i);if(r&&r.downButton===t.native.button){const n=r.immediateDoubleClick,a=e.data.native.pointerType==="touch"?this._parameters.maximumDoubleTouchDistance:this._parameters.maximumDoubleClickDistance;n?(n.timeoutHandle.remove(),Pb(n,e.data)>a?this._startImmediateDoubleClick(e,r):(this._immediateDoubleClick.emit(e.data,void 0,n.modifiers),this._removeState(t))):Pb(r,e.data)>a?this._removeState(t):this._startImmediateDoubleClick(e,r)}}_startImmediateDoubleClick(e,t){const i=e.data.native.pointerType==="touch"?this._parameters.maximumDoubleTouchDelay:this._parameters.maximumDoubleClickDelay;t.immediateDoubleClick={x:e.data.x,y:e.data.y,modifiers:e.modifiers,timeoutHandle:this._clock.setTimeout(()=>this._removeState(e.data),i)}}_removeState(e){const t=Xd(e);this._pointerState.delete(t),this.stopCapturingPointer(e.native),this.refreshHasPendingInputs()}},eq=class extends Gi{constructor(e={},t=Ip){super(!1),this._clock=t,this._pointerState=new Map,this._parameters=QH(e),this._pointerDrag=this.registerOutgoing("pointer-drag"),this._immediateClick=this.registerOutgoing("immediate-click"),this._pointerHold=this.registerOutgoing("hold"),this.registerIncoming("pointer-down",i=>this._handlePointerDown(i)),this.registerIncoming("pointer-up",i=>this._handlePointerLoss(i,"pointer-up")),this.registerIncoming("pointer-capture-lost",i=>this._handlePointerLoss(i,"pointer-capture-lost")),this.registerIncoming("pointer-cancel",i=>this._handlePointerLoss(i,"pointer-cancel")),this._moveHandle=this.registerIncoming("pointer-move",i=>this._handlePointerMove(i)),this._moveHandle.pause()}onUninstall(){this._pointerState.forEach(e=>{e.holdTimeout=bi(e.holdTimeout)}),super.onUninstall()}_handlePointerDown(e){const t=e.data,i=t.native.pointerId;let r=null;this._pointerState.size===0&&(r=this._clock.setTimeout(()=>{const a=this._pointerState.get(i);if(a){if(!a.isDragging){const o=a.previousEvent;this._pointerHold.emit(o,void 0,e.modifiers),a.holdEmitted=!0}a.holdTimeout=null}},this._parameters.holdDelay));const n={startEvent:t,previousEvent:t,startTimestamp:e.timestamp,isDragging:!1,downButton:t.native.button,holdTimeout:r,modifiers:new Set};this._pointerState.set(i,n),this.startCapturingPointer(t.native),this._moveHandle.resume(),this._pointerState.size>1&&this._startDragging(e)}_handlePointerMove(e){const t=e.data,i=t.native.pointerId,r=this._pointerState.get(i);r&&(r.isDragging?this._pointerDrag.emit(Nm("update",r,t),void 0,r.modifiers):ZH(t,r.startEvent)>this._getDragThreshold(t.native.pointerType)&&this._startDragging(e),r.previousEvent=t)}_getDragThreshold(e){switch(e){case"touch":return this._parameters.movementUntilTouchDrag;case"pen":return this._parameters.movementUntilPenDrag;default:return this._parameters.movementUntilMouseDrag}}_startDragging(e){const t=e.data,i=t.native.pointerId;this._pointerState.forEach(r=>{r.holdTimeout!=null&&(r.holdTimeout.remove(),r.holdTimeout=null),r.isDragging||(r.modifiers=e.modifiers,r.isDragging=!0,i===r.startEvent.native.pointerId?this._pointerDrag.emit(Nm("start",r,t)):this._pointerDrag.emit(Nm("start",r,r.previousEvent),e.timestamp))})}_handlePointerLoss(e,t){const i=e.data,r=i.native.pointerId,n=this._pointerState.get(r);n&&(n.holdTimeout!=null&&(n.holdTimeout.remove(),n.holdTimeout=null),n.isDragging?this._pointerDrag.emit(Nm("end",n,t==="pointer-up"?i:n.previousEvent),void 0,n.modifiers):t==="pointer-up"&&n.downButton===i.native.button&&e.timestamp-n.startTimestamp<=this._parameters.maximumClickDelay&&!n.holdEmitted&&this._immediateClick.emit(i),this._pointerState.delete(r),this.stopCapturingPointer(i.native),this._pointerState.size===0&&this._moveHandle.pause())}};function Nm(s,e,t){return{action:s,startEvent:e.startEvent,previousEvent:e.previousEvent,currentEvent:t}}let tq=class extends Gi{constructor(e={},t=Ip){super(!1),this._clock=t,this._pointerState=new Map,this._parameters=bD(e),this._click=this.registerOutgoing("click"),this._doubleClick=this.registerOutgoing("double-click"),this.registerIncoming("immediate-click",i=>this._handleImmediateClick(i)),this.registerIncoming("pointer-down",i=>this._handlePointerDown(i))}onUninstall(){this._pointerState.forEach(e=>e.doubleClickTimer=bi(e.doubleClickTimer))}get hasPendingInputs(){for(const e of this._pointerState.values())if(e.doubleClickTimer!=null)return!0;return!1}_clearDoubleClickTimer(e,t){const i=this._pointerState.get(e);i&&(i.doubleClickTimer=bi(i.doubleClickTimer),t&&this._click.emit(i.event.data,void 0,i.event.modifiers),this._pointerState.delete(e),this.refreshHasPendingInputs())}_doubleClickTimeoutExceeded(e){const t=this._pointerState.get(e);t.pointerDownCount===1&&this._click.emit(t.event.data,void 0,t.event.modifiers),t.doubleClickTimer=null,this._pointerState.delete(e),this.refreshHasPendingInputs()}_handleImmediateClick(e){const t=e.data,{pointerType:i}=t.native,r=iq(t);if(!this._pointerState.has(r))return void this._startClick(e);const n=this._pointerState.get(r),{data:a,modifiers:o}=n.event,l=i==="touch"?this._parameters.maximumDoubleTouchDistance:this._parameters.maximumDoubleClickDistance;Pb(a,t)>l?(this._clearDoubleClickTimer(r,!0),this._startClick(e)):(this._clearDoubleClickTimer(r,!1),n.pointerDownCount===2&&this._doubleClick.emit(a,void 0,o))}_handlePointerDown(e){const t=Xd(e.data),i=this._pointerState.get(t);i&&(i.pointerDownCount+=1)}_startClick(e){const{data:t}=e,{native:{pointerType:i}}=t,r=Xd(t),n=i==="touch"?this._parameters.maximumDoubleTouchDelay:this._parameters.maximumDoubleClickDelay,a=this._clock.setTimeout(()=>this._doubleClickTimeoutExceeded(r),n);this._pointerState.set(r,{event:e,doubleClickTimer:a,pointerDownCount:1}),this.refreshHasPendingInputs()}};function iq(s){const{pointerId:e,pointerType:t,button:i}=s.native;return t==="mouse"?`${e}:${i}`:`${t}`}let sq=class{constructor(e){this._callbacks=e,this._currentCount=0,this._callbacks.condition||(this._callbacks.condition=()=>!0)}handle(e){const t=e.data,i=t.pointers.size;switch(t.action){case"start":this._currentCount=i,this._emitStart(e);break;case"added":this._emitEnd(this._previousEvent),this._currentCount=i,this._emitStart(e);break;case"update":this._emitUpdate(e);break;case"removed":this._startEvent&&this._emitEnd(this._previousEvent),this._currentCount=i,this._emitStart(e);break;case"end":this._emitEnd(e),this._currentCount=0}this._previousEvent=e}_emitStart(e){this._startEvent=e,this._callbacks.condition?.(this._currentCount,e)&&this._callbacks.start(this._currentCount,e,this._startEvent)}_emitUpdate(e){this._callbacks.condition?.(this._currentCount,e)&&this._callbacks.update(this._currentCount,e,this._startEvent)}_emitEnd(e){this._callbacks.condition?.(this._currentCount,e)&&this._callbacks.end(this._currentCount,e,this._startEvent),this._startEvent=null}},rq=class extends Gi{constructor(e=20,t=40){super(!1),this._threshold=e,this._maxDelta=t,this._state="ready",this._emittedArtificalEnd2=!1,this._vertical=this.registerOutgoing("vertical-two-finger-drag"),this._artificalDrag=this.registerOutgoing("drag"),this._dragEventSeparator=new sq({start:(i,r)=>this._observeStart(i,r),update:(i,r,n)=>this._observeUpdate(i,r,n),end:(i,r)=>this._observeEnd(r)}),this.registerIncoming("drag",i=>this._dragEventSeparator.handle(i))}get failed(){return this._state==="failed"}_observeStart(e,t){e===1&&this._emittedArtificalEnd2&&(this._emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),t.stopPropagation()),this._state=e===2?"ready":"failed"}_observeUpdate(e,t,i){if(this._state!=="failed"&&e===2)return this._state==="active"?(this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void t.stopPropagation()):void(this._checkMovementWithinLimits(t.data,i.data)?this._checkVerticalThresholdReached(t.data,i.data)&&(this._state="active",this._emittedArtificalEnd2=!0,this._thresholdReachedCenter=t.data.center,this._artificalDrag.emit({action:"end",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),t.stopPropagation()):this._state="failed")}_observeEnd(e){this._state==="active"&&(this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this._state="ready",e.stopPropagation())}_checkMovementWithinLimits(e,t){let i=-1/0,r=1/0,n=-1/0,a=1/0;for(const{x:_,y:v}of t.pointers.values())i=Math.max(i,_),r=Math.min(r,_),n=Math.max(n,v),a=Math.min(a,v);let o=-1/0,l=1/0,c=-1/0,h=1/0;for(const{x:_,y:v}of e.pointers.values())o=Math.max(o,_),l=Math.min(l,_),c=Math.max(c,v),h=Math.min(h,v);const d=i-r,m=n-a,f=o-l,g=c-h;return Math.abs(e.center.x-t.center.x)<this._threshold&&Math.abs(f-d)<=this._maxDelta&&Math.abs(g-m)<=this._maxDelta}_checkVerticalThresholdReached(e,t){let i=Math.abs(e.center.y-t.center.y);return e.pointers.forEach((r,n)=>{const a=t.pointers.get(n);i=Math.min(i,Math.abs(r.y-a.y))}),i>=this._threshold}},xa=class extends te{constructor(){super(...arguments),this.mode="default",this._updateMode=({mode:e,dragPrimary:t,dragSecondary:i,dragTertiary:r})=>{e==="pro"&&(i="zoom",r=t==="pan"?"rotate":"pan");const n={dragPrimary:t,dragSecondary:i,dragTertiary:r};this._modeDragPan&&(this._modeDragPan.pointerActions=jy("pan",n)),this._modeDragRotate&&(this._modeDragRotate.pointerActions=jy("rotate",n)),this._modeDragZoom&&(this._modeDragZoom.pointerActions=jy("zoom",n))}}destroy(){this.disconnect()}get primaryDragAction(){return this.view.navigation.actionMap.dragPrimary}set primaryDragAction(e){const{actionMap:t}=this.view.navigation;t.dragPrimary=e,t.dragSecondary=e==="pan"?"rotate":"pan"}get updating(){return!!this._inputManager?.updating}get latestPointerInfo(){return this._inputManager?.latestPointerInfo}get multiTouchActive(){return this._inputManager?.multiTouchActive??!1}disconnect(){this.removeAllHandles(),this.view.viewEvents.disconnect(),this._modeDragPan=null,this._modeDragRotate=null,this._modeDragZoom=null,this._modeKeyboardNavigation=null,this._inputManager=Q(this._inputManager),this._source=Q(this._source)}connect(){const e=this.view;this._source=new jH(this.view.surface,e.input);const t=[new JH,new eq,new tq,new YH(this.view.navigation),new rq],i=new tn({eventSource:this._source,recognizers:t});this._inputManager=i,i.installHandlers("prevent-context-menu",[new WH],Fa.INTERNAL);const r={fov:"Shift",pan:{left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:["u","U"],down:["j","J"]},lookAround:{headingLeft:["a","A"],headingRight:["d","D"],tiltUp:["w","W"],tiltDown:["s","S"],modifier:"b"},zoom:{zoomIn:["+","="],zoomOut:["-","_"]},reset:{heading:["n","N"],tilt:["p","P"]}};this._modeDragPan=new nS(e,["primary"]),this._modeDragRotate=new Yy(e,["secondary"],0),this._modeDragZoom=new vH(e,["tertiary"],r.fov),this._modeKeyboardNavigation=new RH(e,r),i.installHandlers("navigation",[new FH(e),new PU(e),new MH(e),new OH(e,r.fov),new Yy(e,["primary"],1,[r.lookAround.modifier]),new Yy(e,["secondary"],0,[r.lookAround.modifier]),new nS(e,["tertiary"],[r.lookAround.modifier]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,this._modeKeyboardNavigation,new VH(e)],Fa.INTERNAL),this.view.viewEvents.connect(i),this.addHandles([$(()=>this.view.navigation?.browserTouchPanEnabled,n=>{this._source.browserTouchPanningEnabled=!n},Re),$(()=>{const{actionMap:n}=this.view.navigation,{dragPrimary:a,dragSecondary:o,dragTertiary:l}=n;return{mode:this.mode,dragPrimary:a,dragSecondary:o,dragTertiary:l}},this._updateMode,Ve)])}isModifierKeyDown(e){return this._inputManager?.isModifierKeyDown(e)??!1}get test(){}};u([p()],xa.prototype,"view",void 0),u([p({type:["default","pro"]})],xa.prototype,"mode",void 0),u([p({readOnly:!0})],xa.prototype,"updating",null),u([p()],xa.prototype,"latestPointerInfo",null),u([p()],xa.prototype,"multiTouchActive",null),u([p()],xa.prototype,"_inputManager",void 0),xa=u([R("esri.views.3d.input.SceneInputManager")],xa);const nq=xa;let Ti,ou,Mb=!1,$b=!1,Rb=!1,Ob=!1,Yd=null;function aq(s){const e=$b?s():null;if(!e?.bins)return;xD();const t=ou;let i=0;for(let r=0;r<e.numX;r++)for(let n=0;n<e.numY;n++){const a=e.bins[r][e.numY-1-n];i+=a.length;const o=r*e.sizeX,l=(r+1)*e.sizeX,c=n*e.sizeY,h=(n+1)*e.sizeY;t.fillText(a.length.toFixed(),o+5,c+15),CD(o,l,c,h,"blue")}t.fillText("total totalShownLabels: "+i,70,40),t.fillText("total visible labels: "+e.numVisible,70,50),t.fillText("total numTests: "+e.numTests,70,30)}function oq(s){Rb=yi.DECONFLICTOR_SHOW_VISIBLE,Ob=yi.DECONFLICTOR_SHOW_INVISIBLE,Mb=Rb||Ob,$b=yi.DECONFLICTOR_SHOW_GRID,Yd=null,Mb||$b?(ou&&Ti&&ou.clearRect(0,0,Ti.width,Ti.height),Yd=()=>lq(s)):Ti&&(Ti.parentElement.removeChild(Ti),Ti=null)}function xD(){Yd&&(Yd(),Yd=null)}function lq(s){Ti==null&&(Ti=document.createElement("canvas"),Ti.setAttribute("id","debugCanvas2d"),s.surface.parentElement.style.position="relative",s.surface.parentElement.appendChild(Ti),Ti.style.position="absolute",Ti.style.width="100%",Ti.style.height="100%",Ti.style.display="block",Ti.style.pointerEvents="none",ou=Ti.getContext("2d"),ou.font="12px Arial");const{width:e,height:t}=s.state.camera;Ti.width=e,Ti.height=t}function CD(s,e,t,i,r){xD();const n=Ti.height,a=ou;a.beginPath(),a.lineWidth=1,a.strokeStyle=r,a.moveTo(s,n-t),a.lineTo(e,n-t),a.stroke(),a.lineTo(e,n-i),a.stroke(),a.lineTo(s,n-i),a.stroke(),a.lineTo(s,n-t),a.stroke(),a.closePath()}function TD(s,e,t=!1){Mb&&(e&&Rb||!e&&Ob)&&CD(s[0],s[2],s[1],s[3],t?e?"pink":"grey":e?"green":"red")}let cq=class{constructor(e,t,i){this._setVisibility=e,this._canConflict=t,this._compare=i,this.done=!1,this._items=new Array,this._accBinsNumX=15,this._accBinsNumY=20,this._accBinsSizeX=0,this._accBinsSizeY=0,this._accBins=null}destroy(){this._generator=null,this._accBins=null,this._items.length=0}reset(e,t){this._initBins(e,t),this._items.length=0,this.done=!1,this._generator=null}add(e){this._items.push(e)}run(e){this._generator??=this._run(e),this.done=!!this._generator.next(e).done}*_run(e){yield*this._sort(e),yield*this._deconflict(e),aq(()=>({bins:this._accBins,numX:this._accBinsNumX,numY:this._accBinsNumY,sizeX:this._accBinsSizeX,sizeY:this._accBinsSizeY,numTests:0,numVisible:this._items.length}))}*_sort(e){for(const t of cI(this._items,0,this._items.length,this._compare))e.madeProgress(),e.done&&(e=yield)}_isConflicted(e){let t=!0;return this._forEachBin(e.aabr,i=>(t=!1,i.some(r=>this._canConflict(r,e)&&I$(r.aabr,e.aabr))))||t}*_deconflict(e){for(const t of this._items){e.done&&(e=yield);const i=!this._isConflicted(t);this._setVisibility(t,i),TD(t.aabr,i),i&&this._addToBins(t),e.madeProgress()}}_initBins(e,t){if(this._accBins==null){this._accBins=[];for(let i=0;i<this._accBinsNumX;i++){this._accBins.push([]);const r=this._accBins[this._accBins.length-1];for(let n=0;n<this._accBinsNumY;n++)r.push(new zt)}}else for(let i=0;i<this._accBinsNumX;i++)for(let r=0;r<this._accBinsNumY;r++)this._accBins[i][r].clear();this._accBinsSizeX=e/this._accBinsNumX,this._accBinsSizeY=t/this._accBinsNumY}_addToBins(e){this._forEachBin(e.aabr,t=>t.push(e))}_forEachBin(e,t){if(!this._accBins)return!1;const i=Math.max(Math.floor(e[0]/this._accBinsSizeX),0),r=Math.max(Math.floor(e[1]/this._accBinsSizeY),0),n=Math.min(Math.floor(e[2]/this._accBinsSizeX),this._accBinsNumX-1),a=Math.min(Math.floor(e[3]/this._accBinsSizeY),this._accBinsNumY-1);for(let o=i;o<=n;o++)for(let l=r;l<=a;l++)if(t(this._accBins[o][l]))return!0;return!1}},hq=class{constructor(e){this._gl=e,this._sync=e.fenceSync(e.SYNC_GPU_COMMANDS_COMPLETE,0)}poll(){const e=this._gl,t=e.clientWaitSync(this._sync,e.SYNC_FLUSH_COMMANDS_BIT,0);if(t===e.WAIT_FAILED)throw new Error("clientWaitSync failed");return t!==e.TIMEOUT_EXPIRED}destroy(){this._gl.deleteSync(this._sync),this._sync=null}},wl=class extends Ho{constructor(e){super(e),this.category=It.COMPOSITE,this.readyToRun=!1,this.done=!0,this._origin=x(),this._textureWidth=256,this._uploadBuffer=new Float32Array(3*this._textureWidth),this._counter=0,this._width=0,this._height=0,this._pixelBufferSize=0,this._pipeline=qe({colorWrite:nt}),this._format=0}initialize(){const e=this.view.resourceController.scheduler.registerTask(di.GRAPHICS_CORE,this);this.addHandles(e),this.produces="disabled",this.consumes.required=[this.category],this.formatOverride&&(this._format=this.formatOverride)}destroy(){this._program=_e(this._program);const e=this.gl;this._sync=Q(this._sync),this._pixelBuffer&&(e.deleteBuffer(this._pixelBuffer),this._pixelBuffer=null,this._pixelBufferSize=0),this._texture=_e(this._texture)}precompile(){this._ensureProgram(this.renderingContext)}render(e){const t=e.find(({name:h})=>h===this.category);if(this._sync)return t;this.produces="disabled";const i=this.renderingContext,r=this.gl,n=t.getTexture(r.DEPTH_STENCIL_ATTACHMENT);if(!n)return t;const a=this.view.stage.renderer.fboCache.acquire(this._width,this._height,"hud visibility",9);i.bindFramebuffer(a.fbo),i.setPipelineState(this._pipeline);const o=this._ensureProgram(i);i.useProgram(o);const l=0;i.bindTexture(n,l),o.setUniform1i("depthTex",l);const c=1;return i.bindTexture(this._texture,c),o.setUniform1i("positionTex",c),as(tv,this.camera.viewMatrix,Y$(tv,this._origin)),o.setUniformMatrix4fv("view",tv),o.setUniformMatrix4fv("proj",this.camera.projectionMatrix),o.setUniform1i("count",this._counter),i.screen.draw(),this._pixelBuffer||(this._pixelBuffer=r.createBuffer()),this._format===0&&(this._format=r.getParameter(r.IMPLEMENTATION_COLOR_READ_FORMAT)===6403&&r.getParameter(r.IMPLEMENTATION_COLOR_READ_TYPE)===Cn.FLOAT?6403:6408),this._pixelBufferSize=this._width*this._height*(this._format===6403?4:16),r.bindBuffer(r.PIXEL_PACK_BUFFER,this._pixelBuffer),r.bufferData(r.PIXEL_PACK_BUFFER,this._pixelBufferSize,r.STREAM_READ),r.readPixels(0,0,this._width,this._height,this._format,Cn.FLOAT,0),this._sync=new hq(r),a.release(),setTimeout(()=>this.readyToRun=!0,0),t}runTask(){if(!this._sync)return void(this.readyToRun=!1);try{if(!this._sync.poll())return Ai}catch{return this.readyToRun=!1,void(this._sync=Q(this._sync))}this.readyToRun=!1,this._sync=Q(this._sync);const e=this.gl;e.bindBuffer(e.PIXEL_PACK_BUFFER,this._pixelBuffer),this._cpuBuffer=new Float32Array(this._width*this._height*(this._format===6403?1:4)),e.getBufferSubData(e.PIXEL_PACK_BUFFER,0,this._cpuBuffer),e.bindBuffer(e.PIXEL_PACK_BUFFER,null),this.done=!0}init(e,t){const i=this._textureWidth;if(this._width=i,this._height=Math.ceil(e/i),this._counter=0,this._texture?.dispose(),this._height===0)return;const r=new ft(this._width,this._height);r.pixelFormat=6407,r.dataType=si.FLOAT,r.samplingMode=9728,this._texture=new bt(this.renderingContext,r),this.done=!1,be(this._origin,Math.fround(t[0]),Math.fround(t[1]),Math.fround(t[2]))}addPosition(e){const t=this._width;if(this._counter>=t*this._height)return-1;const i=this._counter%t;return zi(Um,e,this._origin),this._uploadBuffer[3*i+0]=Um[0],this._uploadBuffer[3*i+1]=Um[1],this._uploadBuffer[3*i+2]=Um[2],i===t-1&&this._flush(),this._counter++}start(){if(this._width===0||this._height===0)return;const e=this._width;this._counter%e>0&&this._flush(),this.produces=this.category,this.requestRender(1)}getOcclusion(e){return this._cpuBuffer?.[this._format===6403?e:4*e]??-1}get usedMemory(){return(this._texture?.usedMemory??0)+this._pixelBufferSize+4*(this._uploadBuffer?.length??0)+4*(this._cpuBuffer?.length??0)}_flush(){const e=this._width,t=Math.floor(this._counter/e);this._texture?.updateData(0,0,t,e,1,this._uploadBuffer)}_ensureProgram(e){return this._program??=e.programCache.acquire(uq,dq,ri),this._program}};u([p()],wl.prototype,"category",void 0),u([p()],wl.prototype,"formatOverride",void 0),u([p()],wl.prototype,"readyToRun",void 0),u([p()],wl.prototype,"done",void 0),wl=u([R("esri.views.3d.webgl-engine.lib.GPUPointOcclusionQuery")],wl);const uq=`#version 300 es
precision highp float;
in vec2 position;

void main() {
    gl_Position = vec4(position, 0.0, 1.0);
}`,dq=`#version 300 es
precision highp float;
out highp vec4 fragColor;

uniform highp mat4 proj;
uniform highp mat4 view;

uniform highp int count;

uniform highp sampler2D depthTex;
uniform highp sampler2D positionTex;

float linearizeDepth(float depth) {
  float depthNdc = depth * 2.0 - 1.0;
  float c1 = proj[3][2];
  float c2 = proj[2][2];
  return -c1 / (depthNdc + c2 + 1e-7);
}

void main() {
  int u = int(floor(gl_FragCoord.x));
  int v = int(floor(gl_FragCoord.y));
  if (u + v * textureSize(positionTex, 0).x >= count) {
    fragColor = vec4(-1);
    return;
  }
  vec4 posWorld = vec4(texelFetch(positionTex, ivec2(u, v), 0).rgb, 1.0);

  vec4 posView = view * posWorld;
  vec4 projected = proj * posView;

  vec3 clipPos = projected.xyz / projected.w;

  if (clipPos.x < -1.0 || clipPos.x > 1.0 || clipPos.y < -1.0 || clipPos.y > 1.0) {
    fragColor = vec4(-1);
    return;
  }

  vec3 uvDepth = 0.5 * clipPos + vec3(0.5);

  float depth = texture(depthTex, uvDepth.xy).r;

  if (uvDepth.z <= depth) {
    fragColor = vec4(0);
    return;
  }

  fragColor = vec4(linearizeDepth(depth) - linearizeDepth(uvDepth.z));
}
`,Um=x(),tv=Ie(),ha=x(),iv=x(),Oc=Lt(),Fu=Lt(),sv=x(),pq=Ie(),mq=Xs(),rv=Go(),fq=x(),gq=Mt();class _q{constructor(e){this.id=e,this.aabr=Mt(),this.altitude=0,this.distance=0,this.distanceToOccluder=0,this.culled=!1,this.visible=!1,this.priority=0}}function yq(s,e){const t=s.distanceToOccluder!==0&&s.distance>s.distanceToOccluder,i=e.distanceToOccluder!==0&&e.distance>e.distanceToOccluder;return t!==i?+t-+i:s.priority!==e.priority?e.priority-s.priority:s.distance!==e.distance?s.distance-e.distance:s.visible!==e.visible?+e.visible-+s.visible:s.id-e.id}class vq{constructor(e,t){this.graphics3DGraphic=e,this.slicePlaneEnabled=t,this._info=null,this._labelInfo=null}ensureInfo(e){let t=this.getInfo(e);return t||(t=new _q(this.graphics3DGraphic.graphic.uid),this._setInfo(e,t)),t}getInfo(e){return e===16?this._labelInfo:this._info}removeInfo(e){this._setInfo(e,null)}_setInfo(e,t){e===16?this._labelInfo=t:this._info=t}}class bq{constructor(){this.camera=new vt,this.slicePlane=R_(),this.slicePlaneEnabled=!1}copyFrom(e){this.camera.equals(e.camera)||this.camera.copyFrom(e.camera),Lw(e.slicePlane,this.slicePlane),this.slicePlaneEnabled=e.slicePlaneEnabled}}let wo=class extends te{get dirty(){return this._dirty}get state(){return this._state}constructor(s){super(s),this._dirty=!1,this._viewState=new bq,this._state=0,this._checkOcclusion=new Map,this._active=new Map,this._checkOcclusionIterator=null,this._activeIterator=null,this._occlusionQueryUids=new Array,this._updatingHandles=new hc,this._deconflictor=new cq((e,t)=>{e.visible=t,this._setGraphicVisibility(this._active.get(e.id),t)},(e,t)=>e.id!==t.id,yq),this._baseOccludedVisibility=10,this._altitudeFactor=2,this._minAltitudeDifference=100}initialize(){this._updatingHandles.add(()=>(this.view?.map?.ground?.opacity??0)>0,()=>this.setDirty()),this._updatingHandles.add(()=>this.view.ready,()=>{this._occlusionQuery=null,this.setDirty()})}destroy(){this._occlusionQuery=null,this._updatingHandles.destroy(),this._deconflictor.destroy(),this._checkOcclusion.clear(),this._active.clear()}setDirty(){!this._dirty&&(this._active.size>0||this._checkOcclusion.size>0)&&(this._dirty=!0,this.notifyChange("_readyToRun"))}setPriority(s,e){const t=this._active.get(s.graphic.uid)?.getInfo(this.visibilityGroup);t&&(t.priority=e)}get _readyToRun(){return this._state!==0||this._dirty}get updating(){return this._readyToRun||this._updatingHandles.updating}get updatingProgress(){if(!this.updating)return 1;const s=this._state/5;return this._dirty?.5*s:s}get readyToRun(){return this.view.ready&&this.view.state!=null&&this._readyToRun}get usedMemory(){return this._occlusionQuery?.usedMemory??0+4*(this._occlusionQueryUids?.length??0)}runTask(s){switch(this._state){case 0:this._startUpdate(),s.madeProgress();case 1:if(this._state=1,!this._processCheckOcclusion(s))return;case 2:if(this._state=2,this._occlusionQuery&&!this._occlusionQuery.done)return Ai;this._readOcclusionQueryResult(),s.madeProgress();case 3:if(this._state=3,!this._collectActiveGraphics(s))return;case 4:if(this._state=4,this._deconflictor.run(s),!this._deconflictor.done)return;default:this._state=0,this.notifyChange("_readyToRun")}}setGraphicsActive(s,e){e?s.forEach(t=>this.addToActiveGraphics(t)):s.forEach(t=>this.removeFromActiveGraphics(t))}layerSupportsDeconfliction(s){if(s==null||s.type!=="object3d")return!1;const e=s.stageObject;return(e?.geometries.length??0)!==1?!1:e?.geometries[0]?.material instanceof Iw}_startUpdate(){oq(this.view),this._dirty=!1,this._viewState.copyFrom(this.viewState);const{fullWidth:s,fullHeight:e}=this._viewState.camera;this._deconflictor.reset(s,e),this._resetIterators(),this._occlusionQueryUids.length=0,this._checkOcclusion.size||(this._occlusionQuery=Q(this._occlusionQuery))}addToActiveGraphics(s){s.ensureInfo(this.visibilityGroup),this._active.set(s.graphics3DGraphic.graphic.uid,s),this.setDirty()}removeFromActiveGraphics(s){wq(s,this.visibilityGroup),s.removeInfo(this.visibilityGroup),this._active.delete(s.graphics3DGraphic.graphic.uid),this.setDirty()}addToCheckOcclusion(s){this._checkOcclusion.set(s.graphics3DGraphic.graphic.uid,s),this.setDirty()}removeFromCheckOcclusion(s){this._checkOcclusion.delete(s.graphics3DGraphic.graphic.uid)}_processCheckOcclusion(s){if(this._checkOcclusion.size===0)return!0;const e=this._ensureCheckOcclusionIterator(),t=this._viewState.camera,i=K$(pq,t.viewInverseTransposeMatrix),r=this.view.map.ground.opacity>0,n=this.view.viewingMode==="global"&&r&&t.relativeElevation>0?mq:null;let a=0;n!=null&&(gp(n,ea,t.viewMatrix),n[3]=Zt(this.view.spatialReference).radius,a=_V(n,ea));const o=Mt();for(;;){if(s.done)return!1;s.madeProgress();const l=e.next();if(l.done===!0)break;const c=l.value,h=c.graphics3DGraphic;if(h.destroyed||!h.isVisible(1,8))continue;const d=Sq(h,this.visibilityGroup);let m=null,f=!0;for(const g of d){if(!this.layerSupportsDeconfliction(g))continue;m=Pq,this._projectHudLayer(g,t,m),Fo(o);const _=g.stageObject.geometries[0].material;if(this._expandBoundingRect(o,t,g,_,m),m.isOutsideScreen){f=!1;break}if(this._isCulledBySlice(c,m.positionView)){f=!1;break}if(n!=null&&Tq(m,n,a)){f=!1;break}ot(iv,m.positionView,i),m.altitude=this.view.renderCoordsHelper.getAltitude(iv);const v=c.ensureInfo(this.visibilityGroup);if(v.altitude=m.altitude,v.distance=m.distance,v.distanceToOccluder=m.distanceToOccluder,v.culled=!1,Up(v.aabr,o),_.parameters.occlusionTest)break;this._ensureOcclusionQuery().addPosition(iv)===this._occlusionQueryUids.length&&this._occlusionQueryUids.push(h.graphic.uid);break}if(this._active.has(h.graphic.uid)&&(!f||!m)){const g=c.ensureInfo(this.visibilityGroup);g.visible=!m,g.culled=!0}}return this._checkOcclusionIterator=null,this._occlusionQueryUids.length||(this._occlusionQuery=Q(this._occlusionQuery)),this._occlusionQuery?.start(),!0}_readOcclusionQueryResult(){if(!this._occlusionQuery||!this._occlusionQueryUids.length)return;const s=this._viewState.camera,e=this.view.renderCoordsHelper.getAltitude(s.eye);for(let t=0;t<this._occlusionQueryUids.length;t++){const i=this._occlusionQueryUids[t],r=this._checkOcclusion.get(i);if(!r)continue;const n=this._occlusionQuery.getOcclusion(t)??-1,a=r.getInfo(this.visibilityGroup);a&&(a.distanceToOccluder=n>0?a.distance-n:0);const o=n<=0||this._occludedVisibility(a?.distanceToOccluder??0,a?.distance??n,a?.altitude??0,e);this._active.has(i)?a&&(a.culled=!o,a.visible=o):this._setGraphicVisibility(r,o)}this._occlusionQueryUids.length=0}_collectActiveGraphics(s){const e=this._ensureActiveGraphicsIterator(),t=this.visibilityGroup===16;for(;!s.done;){s.madeProgress();const i=e.next();if(i.done===!0)return this._activeIterator=null,!0;const r=i.value,n=r.getInfo(this.visibilityGroup);n&&(!(!t||r.graphics3DGraphic.isVisible())||n.culled?(TD(n.aabr,!1,!0),this._setGraphicVisibility(r,n.visible)):this._deconflictor.add(n))}return!1}_occludedVisibility(s,e,t,i){const r=Math.max(this._minAltitudeDifference,Math.abs(t-i))-this._minAltitudeDifference;return s===0||e-s<=this._baseOccludedVisibility+this._altitudeFactor*r}_resetIterators(){this._checkOcclusionIterator=null,this._activeIterator=null}_ensureCheckOcclusionIterator(){return this._checkOcclusionIterator??=this._checkOcclusion.values(),this._checkOcclusionIterator}_ensureActiveGraphicsIterator(){return this._activeIterator??=this._active.values(),this._activeIterator}_ensureOcclusionQuery(){return this._occlusionQuery??=new wl({view:this.view}),this._occlusionQueryUids.length||this._occlusionQuery.init(this._checkOcclusion.size,this._viewState.camera.eye),this._occlusionQuery}_projectHudLayer(s,e,t){const i=s.stageObject,r=i.geometries[0],n=r.material;ot(ha,Hi(i.boundingVolumeWorldSpace.bounds),e.viewMatrix);const a=r.attributes,o=a.get("normal").data,l=a.get("centerOffsetAndDistance").data;n.applyShaderOffsetsView(ha,o,i.transformation,l,e,t.screenSizePerspectiveEvaluators,ha),os(Oc,ha[0],ha[1],ha[2],1),kg(Fu,Oc,e.projectionMatrix),ee(t.positionNDC,Fu,1/Fu[3]),n.applyShaderOffsetsNDC(t.positionNDC,l,e,t.positionNDC,sv),t.distanceWithoutPolygonOffset=e.depthNDCToWorld(sv[2]),t.distance=sv[2]===t.positionNDC[2]?t.distanceWithoutPolygonOffset:e.depthNDCToWorld(t.positionNDC[2]),os(Fu,t.positionNDC[0],t.positionNDC[1],t.positionNDC[2],1),kg(Oc,Fu,e.inverseProjectionMatrix),Qw(Oc,Oc,1/Oc[3]),be(t.positionView,ha[0],ha[1],ha[2])}_isCulledBySlice(s,e){return s.slicePlaneEnabled&&this._viewState.slicePlaneEnabled&&z$(this._viewState.slicePlane,e)}_expandBoundingRect(s,e,t,i,{positionNDC:r,screenSizePerspectiveEvaluators:n}){const a=t.getScreenSize(xq);n.evaluator.applyVec2(a,a),a[0]*=e.pixelRatio,a[1]*=e.pixelRatio;const o=Ag(i.calculateRelativeScreenBounds(a,n.alignmentEvaluator.apply(e.pixelRatio),gq),Me(0,e.fullWidth,.5+.5*r[0]),Me(0,e.fullHeight,.5+.5*r[1])),l=this.marginFactor;if(l!==0){const c=l*Math.min(hr(o),Xn(o));o[0]-=c,o[1]-=c,o[2]+=c,o[3]+=c}zh(s,o,s)}_setGraphicVisibility(s,e){const t=s?.graphics3DGraphic;t&&!t.destroyed&&(t.setVisibilityFlag(this.visibilityGroup,8,e),this.visibilityGroup===16&&this.view.labeler.setLabelGraphicVisibility(t,e))}};function wq(s,e){const t=s.graphics3DGraphic;t.destroyed||t.setVisibilityFlag(e,8,!0)}u([p({constructOnly:!0})],wo.prototype,"view",void 0),u([p({type:Boolean,readOnly:!0})],wo.prototype,"_readyToRun",null),u([p({type:Boolean,readOnly:!0})],wo.prototype,"updating",null),u([p({readOnly:!0})],wo.prototype,"_updatingHandles",void 0),wo=u([R("esri.views.3d.layers.graphics.Deconflictor")],wo);const xq=ke();class Cq{constructor(){this.positionView=x(),this.positionNDC=x(),this.altitude=0,this.distance=0,this.distanceToOccluder=0,this.distanceWithoutPolygonOffset=0,this.screenSizePerspectiveEvaluators=new BI}get isOutsideScreen(){const e=this.positionNDC;return e[0]<-1||e[1]<-1||e[2]<-1||e[0]>=1||e[1]>=1||e[2]>=1}}function Tq(s,e,t){return q(rv.direction,s.positionView),be(rv.origin,0,0,0),!!D_(e,rv,fq)&&s.distanceWithoutPolygonOffset>t}function Sq(s,e){return e===16?s.labelLayers:s.layers}const Pq=new Cq,Mq=2e3;let Kf=class extends wo{constructor(e){super(e),this.visibilityGroup=16,this.marginFactor=.05,this._lastDeconfliction=0}get viewState(){return this.parent.viewState}runTask(e){if(this.parent.readyToRun)return Ai;const t=performance.now();if(this.view.state.mode!==2&&t-this._lastDeconfliction<Mq)return Ai;const i=super.runTask(e);return this.state===0&&(this._lastDeconfliction=t),i}};u([p({constructOnly:!0})],Kf.prototype,"parent",void 0),Kf=u([R("esri.views.3d.layers.graphics.LabelDeconflictor")],Kf);let Db=class extends wo{constructor(){super(...arguments),this._contexts=new Map,this.visibilityGroup=1,this._marginFactor=-.1,this.test={overrideMarginFactor:e=>{this._marginFactor=e,this.setDirty()}}}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this._updatingHandles.add(()=>this.view?.state?.camera,()=>{this._updateViewState(),this.setDirty()}),this._updatingHandles.add(()=>this.view?.slice?.plane,()=>{this._updateSlicePlane(),this._slicePlaneChanged(),this.setDirty()},Re),this.addHandles($(()=>this.view.basemapTerrain?.updating||this.view.graphicsView?.updating||this.view.allLayerViews.some(e=>e.updating),(e,t)=>{!e&&t&&this.setDirty()},Ae)),this._frameTask=this.view.resourceController.scheduler.registerTask(di.GRAPHICS_DECONFLICTOR,this),this._labels=new Kf({view:this.view,parent:this})}destroy(){this._labels=Q(this._labels),this._frameTask=bi(this._frameTask)}get marginFactor(){return this._marginFactor}get usedMemory(){return super.usedMemory+this._labels.usedMemory}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty())}runTask(e){const t=super.runTask(e);return this.readyToRun||this._labels.setDirty(),t}_updateViewState(){this.view?.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this._updateSlicePlane())}_updateSlicePlane(){const e=this.view?.slice?.plane;e!=null&&JF(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=e!=null}_slicePlaneChanged(){for(const e of this._contexts.keys())if(e.symbolCreationContext.slicePlaneEnabled)return void this.setDirty()}addGraphicsOwner(e){const t=this._getGraphicsContext(e);return{addGraphic:i=>this._addGraphic(e,t,i),removeGraphic:i=>this._removeGraphic(t,i),labelingInfoChange:()=>this._labelsEnabledChanged(e,t),featureReductionChange:()=>this._enabledChanged(e,t),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(e,t),screenSizePerspectiveEnabledChanged:()=>this._screenSizePerspectiveEnabledChange(),clear:()=>t.forEach(i=>this._removeGraphic(t,i.graphics3DGraphic)),remove:()=>this._removeGraphicsOwner(e),setDirty:()=>this.setDirty()}}_removeGraphicsOwner(e){const t=this._contexts.get(e);t&&(t.forEach(i=>this._removeGraphic(t,i.graphics3DGraphic)),this._contexts.delete(e),this.setDirty())}_addGraphic(e,t,i){const r=i.graphic.uid,n=new vq(i,e.symbolCreationContext.slicePlaneEnabled);t.set(r,n),this.addToCheckOcclusion(n),nv(e)&&this.addToActiveGraphics(n),e.labelsEnabled&&(this._labels.addToCheckOcclusion(n),this._labels.addToActiveGraphics(n));const a=!this._graphicSupportsDeconfliction(i)||!nv(e);i.setVisibilityFlag(1,8,a)}_removeGraphic(e,t){const i=t.graphic.uid,r=e.get(i);r&&(this.removeFromActiveGraphics(r),this.removeFromCheckOcclusion(r),this._labels.removeFromActiveGraphics(r),this._labels.removeFromCheckOcclusion(r),e.delete(i),this.setDirty())}_enabledChanged(e,t){nv(e)?t.forEach(i=>this.addToActiveGraphics(i)):(t.forEach(i=>this.removeFromActiveGraphics(i)),$q(e))}_labelsEnabledChanged(e,t){e.labelsEnabled?(t.forEach(i=>this._labels.addToCheckOcclusion(i)),t.forEach(i=>this._labels.addToActiveGraphics(i))):(t.forEach(i=>this._labels.removeFromCheckOcclusion(i)),t.forEach(i=>this._labels.removeFromActiveGraphics(i)))}_slicePlaneEnabledChanged(e,t){const i=e.symbolCreationContext.slicePlaneEnabled;t.forEach(r=>r.slicePlaneEnabled=i),this.setDirty()}_screenSizePerspectiveEnabledChange(){this.setDirty()}_graphicSupportsDeconfliction(e){if(e.isDraped)return!1;const t=e.layers;if(!t?.length)return!1;for(const i of t)if(this.layerSupportsDeconfliction(i))return!0;return!1}_getGraphicsContext(e){const t=this._contexts.get(e);if(t)return t;const i=new Map;return this._contexts.set(e,i),this.setDirty(),i}};function nv(s){const e=s.layer;return!(!e?.featureReduction||e.featureReduction.type!=="selection")}function $q(s){const e=s.graphics3DGraphics;e&&e.forEach(t=>t.setVisibilityFlag(1,8,!0))}Db=u([R("esri.views.3d.layers.graphics.GraphicsDeconflictor")],Db);let Rq=class{constructor(e,t){this.renderer=e,this.symbol=t,this.color=null,this.size=null,this.opacity=null,this.outlineSize=null,this.heading=null,this.tilt=null,this.roll=null}};function jne(s,e,t,i,r,n,a,o,l,c,h){const d=Fq[h.mode];let m,f,g=0;if(na(s,e,t,i,l.spatialReference,r,o))return d?.requiresAlignment(h)?(g=d.applyElevationAlignmentBuffer(i,r,n,a,o,l,c,h),m=n,f=a):(m=i,f=r),na(m,l.spatialReference,f,n,c.spatialReference,a,o)?g:void 0}function $1(s,e,t,i,r){const n=(V$(s)?s.z:WR(s)?s.array[s.offset+2]:s[2])||0;switch(t.mode){case"on-the-ground":{const a=Yn(e,s,"ground")??0;return r.verticalDistanceToGround=0,r.sampledElevation=a,void(r.z=a)}case"relative-to-ground":{const a=Yn(e,s,"ground")??0,o=t.geometryZWithOffset(n,i);return r.verticalDistanceToGround=o,r.sampledElevation=a,void(r.z=o+a)}case"relative-to-scene":{const a=Yn(e,s,"scene")??0,o=t.geometryZWithOffset(n,i);return r.verticalDistanceToGround=o,r.sampledElevation=a,void(r.z=o+a)}case"absolute-height":{const a=t.geometryZWithOffset(n,i),o=Yn(e,s,"ground")??0;return r.verticalDistanceToGround=a-o,r.sampledElevation=o,void(r.z=a)}default:return void(r.z=0)}}function Wne(s,e,t,i){return $1(s,e,t,i,$h),$h.z}function Oq(s,e,t){return e==="on-the-ground"&&t==="on-the-ground"?s.staysOnTheGround:e===t||e!=="on-the-ground"&&t!=="on-the-ground"?e==null||t==null?s.definedChanged:1:s.onTheGroundChanged}function hS(s){return s==="relative-to-ground"||s==="relative-to-scene"}function Qne(s){return s!=="absolute-height"}function SD(s,e,t,i,r){$1(e,t,r,i,$h),PD(s,$h.verticalDistanceToGround);const n=$h.sampledElevation,a=Fr(Vq,s.transformation);return Hm[0]=e.x,Hm[1]=e.y,Hm[2]=$h.z,I_(e.spatialReference,Hm,a,i.spatialReference)?s.transformation=a:console.warn("Could not locate symbol object properly, it might be misplaced"),n}function PD(s,e){for(let t=0;t<s.geometries.length;++t){const i=s.geometries[t].getMutableAttribute("centerOffsetAndDistance");i&&i.data[3]!==e&&(i.data[3]=e,s.geometryVertexAttributeUpdated(s.geometries[t],"centerOffsetAndDistance"))}}function Dq(s,e,t,i,r,n){let a=0;const o=n.spatialReference;e*=3,i*=3;for(let l=0;l<r;++l){const c=s[e],h=s[e+1],d=s[e+2],m=n.getElevation(c,h,d,o,"ground")??0;a+=m,t[i]=c,t[i+1]=h,t[i+2]=m,e+=3,i+=3}return a/r}function Eq(s,e,t,i,r,n,a,o){let l=0;const c=o.calculateOffsetRenderUnits(a),h=o.featureExpressionInfoContext,d=n.spatialReference;e*=3,i*=3;for(let m=0;m<r;++m){const f=s[e],g=s[e+1],_=s[e+2],v=n.getElevation(f,g,_,d,"ground")??0;l+=v,t[i]=f,t[i+1]=g,t[i+2]=h==null?_+v+c:v+c,e+=3,i+=3}return l/r}function Aq(s,e,t,i,r,n,a,o){let l=0;const c=o.calculateOffsetRenderUnits(a),h=o.featureExpressionInfoContext,d=n.spatialReference;e*=3,i*=3;for(let m=0;m<r;++m){const f=s[e],g=s[e+1],_=s[e+2],v=n.getElevation(f,g,_,d,"scene")??0;l+=v,t[i]=f,t[i+1]=g,t[i+2]=h==null?_+v+c:v+c,e+=3,i+=3}return l/r}function Iq(s){const e=s.meterUnitOffset,t=s.featureExpressionInfoContext;return e!==0||t!=null}function Lq(s,e,t,i,r,n,a,o){const l=o.calculateOffsetRenderUnits(a),c=o.featureExpressionInfoContext;e*=3,i*=3;for(let h=0;h<r;++h){const d=s[e],m=s[e+1],f=s[e+2];t[i]=d,t[i+1]=m,t[i+2]=c==null?f+l:l,e+=3,i+=3}return 0}let MD=class{constructor(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}};const Fq={"absolute-height":{applyElevationAlignmentBuffer:Lq,requiresAlignment:Iq},"on-the-ground":{applyElevationAlignmentBuffer:Dq,requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:Eq,requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:Aq,requiresAlignment:()=>!0}},Vq=Ie(),$h=new MD,Hm=x();function $D(s){return s.mapPositions!=null}function Xne(s,e,t,i,r){const n=s.stageObject,a=n.geometries;let o=0;for(const l of a){if(!$D(l))continue;const{update:c,averageGeometrySampledElevation:h}=OD(l,e,t,i,r);o+=h,c&&n.geometryVertexAttributeUpdated(l,"position")}return o/a.length}function kq(s,e,t,i,r,n){const a=s.stageObject,o=e.centerInElevationSR;let l=0;i(o,Hs),a.usesVerticalDistanceToGround?(PD(a,Hs.verticalDistanceToGround),l=Hs.sampledElevation):e.mode!=="absolute-height"&&(l=Hs.sampledElevation);const c=Fr(zq,n??a.transformation),h=be(RD,c[12],c[13],c[14]);yi.TESTS_DISABLE_OPTIMIZATIONS?(Ms[0]=o[0],Ms[1]=o[1],Ms[2]=Hs.z,I_(t,Ms,c,r.spatialReference)&&(n?Fr(n,c):a.transformation=c)):r.setAltitudeOfTransformation(Hs.z,c);const d=R1/r.unitInMeters;return(Math.abs(c[12]-h[0])>=d||Math.abs(c[13]-h[1])>=d||Math.abs(c[14]-h[2])>=d)&&(n?Fr(n,c):a.transformation=c),l}const zq=Ie();function Yne(s,e,t,i,r){const n=s.graphics3DSymbolLayer.lodRenderer;if(n==null)return 0;const a=e.centerInElevationSR;i(a,Hs);const o=e.mode!=="absolute-height"?Hs.sampledElevation:0,l=n.instanceData,c=s.instanceIndex,h=Bq;l.getGlobalTransform(c,h);const d=be(RD,h[12],h[13],h[14]);yi.TESTS_DISABLE_OPTIMIZATIONS?(Ms[0]=a[0],Ms[1]=a[1],Ms[2]=Hs.z,I_(t,Ms,h,r.spatialReference)&&l.setGlobalTransform(c,h)):r.setAltitudeOfTransformation(Hs.z,h);const m=R1/r.unitInMeters;return(yi.TESTS_DISABLE_OPTIMIZATIONS||Math.abs(h[12]-d[0])>=m||Math.abs(h[13]-d[1])>=m||Math.abs(h[14]-d[2])>=m)&&l.setGlobalTransform(c,h),o}function Kne(s,e,t,i,r){const n=s.stageObject,a=n.geometries;if(a.length===0)return 0;let o=0,l=null,c=0,h=!1;for(const d of a){if(!$D(d))continue;const m=d.attributes.get("position");if(m!==l){const{update:f,averageGeometrySampledElevation:g}=OD(d,e,t,i,r);c=g,l=m,h=f}h&&n.geometryVertexAttributeUpdated(d,"position"),o+=c}return o/a.length}const R1=.01,Ms=x(),_r=x(),Dc=x(),Bq=Ie(),RD=x(),Hs=new MD;function OD(s,e,t,i,r){let n=!1;const a=s.transformation,o=e.requiresSampledElevationInfo;_r[0]=a[12],_r[1]=a[13],_r[2]=a[14],s.invalidateBoundingInfo();const l=s.getMutableAttribute("position"),c=l.data,h=l.size,d=c.length/h,m=new dz(s.mapPositions,t);let f=0,g=0;for(let _=0;_<d;_++){if(Dc[0]=c[f],Dc[1]=c[f+1],Dc[2]=c[f+2],i(m,Hs),o&&(g+=Hs.sampledElevation),yi.TESTS_DISABLE_OPTIMIZATIONS)c[f]=m.array[m.offset],c[f+1]=m.array[m.offset+1],c[f+2]=Hs.z,na(c,t,f,c,r.spatialReference,f,1),c[f]-=_r[0],c[f+1]-=_r[1],c[f+2]-=_r[2],n=!0;else{Ms[0]=c[f]+_r[0],Ms[1]=c[f+1]+_r[1],Ms[2]=c[f+2]+_r[2],r.setAltitude(Ms,Hs.z),c[f]=Ms[0]-_r[0],c[f+1]=Ms[1]-_r[1],c[f+2]=Ms[2]-_r[2];const v=R1/r.unitInMeters;(Math.abs(Dc[0]-c[f])>=v||Math.abs(Dc[1]-c[f+1])>=v||Math.abs(Dc[2]-c[f+2])>=v)&&(n=!0)}f+=h,m.offset+=3}return g/=d,{update:n,averageGeometrySampledElevation:g}}let Nq=class{constructor(e,t,i){this.graphic=e,this.renderingInfo=t,this.layer=i}},eae=class{constructor(e,t,i){this.baseMaterial=e,this.edgeMaterial=t,this.hasSlicePlane=i}},DD=class{get isElevationSource(){return!!this.stageObject.lastValidElevationBB}constructor(e,t,i,r,n,a=null){this.graphics3DSymbolLayer=e,this.stageObject=t,this._sharedResource=i,this.elevationAligner=r,this.elevationContext=n,this._edgeState=a,this.type="object3d",this._stageLayer=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.useObjectOriginAsAttachmentOrigin=!1}initialize(e){this._stageLayer=e}destroy(){if(!this._stageLayer)return;const e=this._stageLayer.stage;this._addedToStage&&(this._stageLayer.remove(this.stageObject),this._addedToStage=!1),e.renderer.edgeView?.removeObject(this.stageObject),this.stageObject.dispose(),this._sharedResource?.release(),this._visible=!1,this._stageLayer=null}get usedMemory(){return this.graphics3DSymbolLayer.usedMemory}layerOpacityChanged(e,t){const{stageObject:i,_edgeState:r,_stageLayer:n}=this;if(r==null)return;const a=uS(r.baseMaterial);r.edgeMaterial.objectTransparency!==a&&(r.edgeMaterial.objectTransparency=a,this.resetEdgeObject(t)),n.stage.renderer.withEdgeView(o=>o.updateAllComponentOpacities(i,[e]))}updateHighlights(e){}slicePlaneEnabledChanged(e,t){const{stageObject:i,_edgeState:r,_stageLayer:n}=this;r!=null&&n.stage.renderer.withEdgeView(a=>{a.updateAllComponentMaterials(i,r.edgeMaterial,e,!t),r.hasSlicePlane=e})}setVisibility(e){const{_edgeState:t,stageObject:i,_stageLayer:r}=this;r!=null&&this.visible!==e&&(this._visible=e,i.visible=e,e&&!this._addedToStage&&(r.add(i),this._addedToStage=!0),t!=null&&r.stage.renderer.withEdgeView(n=>{n.hasObject(i)?n.updateObjectVisibility(i,e):e&&this._addOrUpdateEdgeObject(t,n,!1)}))}get visible(){return this._visible}alignWithElevation(e,t,i){if(this.elevationAligner==null)return;const r=(n,a)=>$1(n,e,this.elevationContext,t,a);this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,e.spatialReference,r,t),this.resetEdgeObject(i)}alignWithAbsoluteElevation(e,t,i){const r=(n,a)=>{a.sampledElevation=e,a.verticalDistanceToGround=0,a.z=e};this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,this.graphics3DSymbolLayer.view.spatialReference,r,t),this.resetEdgeObject(i)}getCenterObjectSpace(e=x()){return q(e,Hi(this.stageObject.boundingVolumeObjectSpace.bounds))}getBoundingBoxObjectSpace(e=Ka()){const t=this.stageObject.boundingVolumeObjectSpace;return VV(e,t.min),kV(e,t.max),e}computeAttachmentOrigin(e){const t=this.stageObject.effectiveTransformation;if(this.useObjectOriginAsAttachmentOrigin)e.render.origin[0]+=t[12],e.render.origin[1]+=t[13],e.render.origin[2]+=t[14],e.render.num++;else for(const i of this.stageObject.geometries)i.computeAttachmentOrigin(ua)&&(ot(ua,ua,t),ce(e.render.origin,e.render.origin,ua),e.render.num++)}async getProjectedBoundingBox(e,t,i,r,n){const a=this.getBoundingBoxObjectSpace(n),o=Uq,l=hR(a)?1:o.length;for(let h=0;h<l;h++){const d=o[h];no[0]=a[d[0]],no[1]=a[d[1]],no[2]=a[d[2]],ot(no,no,this.stageObject.transformation),sl[3*h]=no[0],sl[3*h+1]=no[1],sl[3*h+2]=no[2]}if(!e(sl,0,l))return null;Hr(a);let c=null;this.calculateRelativeScreenBounds&&(c=this.calculateRelativeScreenBounds());for(let h=0;h<3*l;h+=3){for(let d=0;d<3;d++)a[d]=Math.min(a[d],sl[h+d]),a[d+3]=Math.max(a[d+3],sl[h+d]);c&&i.push({location:sl.slice(h,h+3),screenSpaceBoundingRect:c})}if(t?.service&&this.elevationContext.mode!=="absolute-height"){Xw(a,ua);const h=this.elevationContext.mode==="relative-to-scene"?"scene":"ground";let d=0;if(t.useViewElevation)d=t.service.getElevation(ua[0],ua[1],h)??0;else try{const m=e5(a,t.service.spatialReference,t);d=await t.service.queryElevation(ua[0],ua[1],r,m,h)??0}catch{}zV(a,0,0,-this.alignedSampledElevation+d)}return a}addObjectState(e){e.stateType===0&&e.addObject(this.stageObject,this.stageObject.highlight(e.highlightName)),e.stateType===1&&e.addObject(this.stageObject,this.stageObject.maskOccludee())}removeObjectState(e){e.removeByObject(this.stageObject)}resetEdgeObject(e){const{_edgeState:t,stageObject:i,_stageLayer:r,_visible:n}=this;t!=null&&r.stage.renderer.withEdgeView(a=>{n?this._addOrUpdateEdgeObject(t,a,e):a.removeObject(i)})}_addOrUpdateEdgeObject(e,t,i){const r=uS(e.baseMaterial);e.edgeMaterial.objectTransparency=r,t.addOrUpdateObject3D(this.stageObject,e.edgeMaterial,e.hasSlicePlane,!i).then(()=>this._stageLayer?.sync())}};function uS(s){return s.transparent?0:1}const sl=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],no=x(),ua=x(),Uq=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];let Hq=class{constructor(e,t=null){this.labelText=t,this.elevationOffset=e??0}};const qq=3,Gq=3,jq=10;let Mr=class{constructor(e){this.estimated=!1,this.verticesPerFeature=e.verticesPerFeature??0,this.verticesPerCoordinate=e.verticesPerCoordinate??0,this.drawCallsPerFeature=e.drawCallsPerFeature??0,this.memory=e.memory??new ED}},O1=class extends Mr{constructor(e){super(e),this.estimated=!0}},Wq=class extends Mr{constructor(e,t){super(t),this.numComplexities=e}},Qq=class extends O1{constructor(e,t){super(t),this.numComplexities=e}},ED=class{constructor(){this.bytesPerFeature=0,this.bytesPerFeatureLabel=0,this.resourceBytes=0,this.draped={bytesPerFeature:0,bytesPerFeatureLabel:0}}};const AD=new O1({});function cae(s){return s.type==="web-style"?AD:D1(s.symbolLayers.toArray().map(e=>ID(s,e)))}function D1(s){let e=0,t=0,i=0,r=!1,n=0;const a=new ED;for(const o of s)o!=null&&(e+=o.verticesPerFeature,t+=o.verticesPerCoordinate,i+=o.drawCallsPerFeature,a.bytesPerFeature+=o.memory.bytesPerFeature,a.bytesPerFeatureLabel+=o.memory.bytesPerFeatureLabel,a.resourceBytes+=o.memory.resourceBytes,a.draped.bytesPerFeature+=o.memory.bytesPerFeature,a.draped.bytesPerFeatureLabel+=o.memory.bytesPerFeatureLabel,r=r||o.estimated,++n);return r?new Qq(n,{verticesPerFeature:e,verticesPerCoordinate:t,drawCallsPerFeature:i,memory:a}):new Wq(n,{verticesPerFeature:e,verticesPerCoordinate:t,drawCallsPerFeature:i,memory:a})}function hae(s){const e=D1(s);return e.numComplexities>0&&(e.verticesPerFeature/=e.numComplexities,e.verticesPerCoordinate/=e.numComplexities,e.drawCallsPerFeature/=e.numComplexities,e.memory.bytesPerFeature/=e.numComplexities,e.memory.bytesPerFeatureLabel/=e.numComplexities,e.memory.resourceBytes/=e.numComplexities,e.memory.draped.bytesPerFeature/=e.numComplexities,e.memory.draped.bytesPerFeatureLabel/=e.numComplexities),e}const av={};function ID(s,e){const t=Zq(s,e),i=o4(e)?2:0;switch(e.type){case"extrude":return new Mr({verticesPerFeature:-12,verticesPerCoordinate:12,drawCallsPerFeature:i,memory:t});case"fill":if(s.type==="mesh-3d")return new Mr({drawCallsPerFeature:i,memory:t});if(e.outline!=null&&e.outline.size>0)return new Mr({verticesPerFeature:-12,verticesPerCoordinate:9,memory:t});case"water":return new Mr({verticesPerFeature:-6,verticesPerCoordinate:3,memory:t});case"line":return new Mr({verticesPerFeature:-6,verticesPerCoordinate:6,memory:t});case"object":return e.resource?.href?new O1({verticesPerFeature:100,memory:t}):{...Xq(e.resource?.primitive??r4),memory:t};case"path":{let r=0,n=0;switch(e.profile){case"circle":r=jq;break;case"quad":r=4;break;default:return void ra(e.profile)}switch(e.join){case"round":n=qq;break;case"miter":case"bevel":n=1;break;default:return}const a=2*r,o=r*n*2,l=o+a;let c=-2*o-a;switch(e.cap){case"none":break;case"butt":case"square":c+=2*(r-1);break;case"round":c+=2*(r*(Gq-1)*2+r);break;default:return}return new Mr({verticesPerFeature:c,verticesPerCoordinate:l,memory:t})}case"text":{const r=s.type==="label-3d"?0:2;return new Mr({verticesPerFeature:6,memory:t,drawCallsPerFeature:r})}case"icon":return new Mr({verticesPerFeature:6,memory:t});default:return}}function Zq(s,e){const t=s.type==="point-3d";switch(e.type){case"extrude":return e.edges&&e.edges.size>0?Wi.EXTRUDE_EDGES:Wi.EXTRUDE;case"fill":return e.outline!=null&&e.outline.size>0?Wi.FILL_OUTLINE:Wi.FILL;case"water":return Wi.FILL;case"line":return e.join==="round"?Wi.LINE_ROUND:Wi.LINE_MITER;case"path":switch(e.join){case"round":switch(e.profile){case"circle":return Wi.PATH_ROUND_CIRCLE;case"quad":return Wi.PATH_ROUND_QUAD;default:return void ra(e.profile)}case"miter":case"bevel":switch(e.profile){case"circle":return Wi.PATH_MITER_CIRCLE;case"quad":return Wi.PATH_MITER_QUAD;default:return void ra(e.profile)}default:return}case"object":return t?Wi.OBJECT_POINT:Wi.OBJECT_POLYGON;case"icon":case"text":return t?Wi.ICON_POINT:Wi.ICON_POLYGON;default:return}}function Xq(s){const e=av[s];if(e)return e;const t=Yq(t5(s,new NI({},{spherical:!0})).levels);return av[s]=new Mr({verticesPerFeature:t}),av[s]}function Yq(s){return s.reduce((e,t,i)=>e+t.numVertices*(1/10**i),0)/s.reduce((e,t,i)=>e+1/10**i,0)}const Wi={ICON_POINT:{bytesPerFeature:2658,bytesPerFeatureLabel:3484,resourceBytes:0,draped:{bytesPerFeature:1845,bytesPerFeatureLabel:3498}},ICON_POLYGON:{bytesPerFeature:3086,bytesPerFeatureLabel:2996,resourceBytes:0,draped:{bytesPerFeature:2694,bytesPerFeatureLabel:3014}},OBJECT_POINT:{bytesPerFeature:497,bytesPerFeatureLabel:2933,resourceBytes:0,draped:{bytesPerFeature:497,bytesPerFeatureLabel:2933}},OBJECT_POLYGON:{bytesPerFeature:867,bytesPerFeatureLabel:2491,resourceBytes:0,draped:{bytesPerFeature:867,bytesPerFeatureLabel:2491}},LINE_MITER:{bytesPerFeature:2337,bytesPerFeatureLabel:2658,resourceBytes:0,draped:{bytesPerFeature:1864,bytesPerFeatureLabel:2656}},LINE_ROUND:{bytesPerFeature:2341,bytesPerFeatureLabel:2672,resourceBytes:0,draped:{bytesPerFeature:1873,bytesPerFeatureLabel:2643}},PATH_MITER_CIRCLE:{bytesPerFeature:22374,bytesPerFeatureLabel:2558,resourceBytes:0,draped:{bytesPerFeature:22374,bytesPerFeatureLabel:2558}},PATH_ROUND_CIRCLE:{bytesPerFeature:24004,bytesPerFeatureLabel:2598,resourceBytes:0,draped:{bytesPerFeature:24004,bytesPerFeatureLabel:2598}},PATH_MITER_QUAD:{bytesPerFeature:24040,bytesPerFeatureLabel:2940,resourceBytes:0,draped:{bytesPerFeature:24040,bytesPerFeatureLabel:2940}},PATH_ROUND_QUAD:{bytesPerFeature:23088,bytesPerFeatureLabel:2886,resourceBytes:0,draped:{bytesPerFeature:23088,bytesPerFeatureLabel:2886}},FILL:{bytesPerFeature:3059,bytesPerFeatureLabel:2838,resourceBytes:0,draped:{bytesPerFeature:2352,bytesPerFeatureLabel:2808}},FILL_OUTLINE:{bytesPerFeature:3093,bytesPerFeatureLabel:2632,resourceBytes:0,draped:{bytesPerFeature:2480,bytesPerFeatureLabel:2601}},EXTRUDE:{bytesPerFeature:5075,bytesPerFeatureLabel:2559,resourceBytes:0,draped:{bytesPerFeature:5075,bytesPerFeatureLabel:2559}},EXTRUDE_EDGES:{bytesPerFeature:2843,bytesPerFeatureLabel:2139,resourceBytes:0,draped:{bytesPerFeature:2843,bytesPerFeatureLabel:2139}}};if(Ze("esri-tests-disable-symbol-memory-estimators"))for(const s in Wi){const e=Wi[s];e.bytesPerFeature=0,e.bytesPerFeatureLabel=0,e.draped.bytesPerFeature=0,e.draped.bytesPerFeatureLabel=0}const Kq=()=>j.getLogger("esri.views.3d.layers.graphics.featureExpressionInfoUtils");function Jq(s){return{cachedResult:s.cachedResult,arcade:s.arcade?{func:s.arcade.func,context:s.arcade.modules.arcadeUtils.createExecContext(null,{sr:s.arcade.context.spatialReference}),modules:s.arcade.modules}:null}}function uae(s){const e=s?.expression;if(typeof e=="string"){const t=FD(e);if(t!=null)return{cachedResult:t}}return null}async function dae(s,e,t,i){const r=s?.expression;if(typeof r!="string")return null;const n=FD(r);if(n!=null)return{cachedResult:n};const a=await AF();He(t);const o=a.arcadeUtils,l=o.createSyntaxTree(r);return o.dependsOnView(l)?(i?.error("Expressions containing '$view' are not supported on ElevationInfo"),{cachedResult:0}):{arcade:{func:o.createFunction(l),context:o.createExecContext(null,{sr:e}),modules:a}}}function e6(s,e,t){return s.arcadeUtils.createFeature(e.attributes,e.geometry,t)}function t6(s,e){if(s!=null&&!LD(s)){if(!e||!s.arcade)return void Kq().errorOncePerTick("Arcade support required but not provided");const t=e;t._geometry&&(t._geometry=i5(t._geometry)),s.arcade.modules.arcadeUtils.updateExecContext(s.arcade.context,e)}}function i6(s){if(s!=null){if(LD(s))return s.cachedResult;const e=s.arcade;let t=e?.modules.arcadeUtils.executeFunction(e.func,e.context);return typeof t!="number"&&(s.cachedResult=0,t=0),t}return 0}function pae(s,e=!1){let t=s?.featureExpressionInfo;const i=t?.expression;return e||i==="0"||(t=null),t??null}const s6={cachedResult:0};function LD(s){return s.cachedResult!=null}function FD(s){return s==="0"?0:null}let dS=class VD{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit="meters",this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.mode=null,this.centerInElevationSR=null}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(e){this._unit=e,this._metersPerElevationInfoUnit=gR(e)}get requiresSampledElevationInfo(){return this.mode!=="absolute-height"}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit="meters"}set offsetMeters(e){this._meterUnitOffset=e,this._renderUnitOffset=0}set offsetElevationInfoUnits(e){this._meterUnitOffset=e*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}addOffsetRenderUnits(e){this._renderUnitOffset+=e}geometryZWithOffset(e,t){const i=this.calculateOffsetRenderUnits(t);return this.featureExpressionInfoContext!=null?i:e+i}calculateOffsetRenderUnits(e){let t=this._meterUnitOffset;const i=this.featureExpressionInfoContext;return i!=null&&(t+=i6(i)*this._metersPerElevationInfoUnit),t/e.unitInMeters+this._renderUnitOffset}setFromElevationInfo(e){this.mode=e.mode,this.unit=p4(e.unit)?e.unit:"meters",this.offsetElevationInfoUnits=e.offset??0}setFeatureExpressionInfoContext(e){this._featureExpressionInfoContext=e}updateFeatureExpressionInfoContextForGraphic(e,t,i){e.arcade?(this._featureExpressionInfoContext=Jq(e),this.updateFeatureExpressionFeature(t,i)):this._featureExpressionInfoContext=e}updateFeatureExpressionFeature(e,t){const i=this.featureExpressionInfoContext;i?.arcade&&(i.cachedResult=void 0,t6(this._featureExpressionInfoContext,e.geometry?e6(i.arcade.modules,e,t):null))}static fromElevationInfo(e){const t=new VD;return e!=null&&t.setFromElevationInfo(e),t}},E1=class{constructor(e){this.schedule=e,this._abortController=null,this._loadStatus=0,this._loadError=null,this._loader=null,this.logger=null}destroy(){this.abortLoad()}get loadStatus(){return this._loadStatus}load(e,t){return this._loadStatus===1?(e&&e(),this._loader??Promise.resolve()):this._loadStatus===2?(t&&t(this._loadError),this._loader??Promise.resolve()):(this._loader==null&&(this._abortController=new AbortController,this._loader=this.doLoad(this._abortController.signal).then(()=>{this._abortController=null,this._loadStatus=1},i=>{throw this._loadError=i,this._abortController=null,this._loadStatus=2,!zr(i)&&this.logger&&i.message&&this.logger.warn(i.message),i})),this._loader.then(e,t).catch(()=>{}),this._loader)}abortLoad(){this._abortController!=null?this._abortController=Os(this._abortController):this._loadStatus===0&&(this._loadStatus=2),this._loader=null}};const rl=()=>j.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer");let r6=class extends E1{constructor(e,t,i,r,n=!0){super(i.schedule),this.symbol=e,this.symbolLayer=t,this._context=i,this._drivenOpacityFallbackAlwaysOpaque=n,this.ignoreDrivers=!1,this._drivenProperties={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1,rotation:!1},this._materials=[],this.logger=rl(),this._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0},this.skipHighSymbolLodsChanged=!0,this._renderPriority=r.renderPriority,this._renderPriorityStep=r.renderPriorityStep,this._elevationContext=new dS,this.updateComplexity(),this.ignoreDrivers=r.ignoreDrivers,this.ignoreDrivers||(this._drivenProperties=pS(this._context.renderer,n)),this._updateElevationContext()}destroy(){this.complexity=null,this._materials.length=0,super.destroy()}get view(){return this._context.stage.view}getCachedSize(){return null}get extentPadding(){return 0}get materials(){return this._materials}get estimatedMemory(){const{complexity:e}=this;return e==null?0:(this.draped?e.memory.draped:e.memory).bytesPerFeature}get usedMemory(){return this.estimatedMemory}_drivenPropertiesChanged(e){if(this.ignoreDrivers)return!1;const t=this._drivenProperties,i=pS(e,this._drivenOpacityFallbackAlwaysOpaque);return i.color!==t.color||i.opacity!==t.opacity||i.opacityAlwaysOpaque!==t.opacityAlwaysOpaque||i.size!==t.size||i.rotation!==t.rotation}get needsDrivenTransparentPass(){return this._hasDrivenColorOrOpacity&&!this._drivenProperties.opacityAlwaysOpaque}get _hasDrivenColorOrOpacity(){return this._drivenProperties.color||this._drivenProperties.opacity}_logGeometryCreationWarnings(e,t,i,r){const n=e.projectionSuccess,a="polygons"in e?e.polygons:null,o=`${r} geometry failed to be created`;n?!this._logGeometryValidationWarnings(t,i,r)&&a&&a.length===0&&i==="rings"&&t.length>0&&t[0].length>2&&rl().warnOncePerTick(`${o} (filled rings should use clockwise winding - try reversing the order of vertices)`):rl().warnOncePerTick(`${o} (failed to project geometry to view spatial reference)`)}get needsUpdateFocus(){return!1}_logGeometryValidationWarnings(e,t,i){const r=`${i} geometry failed to be created`;return!e.length||e.length===1&&!e[0].length?(rl().warnOncePerTick(`${r} (no ${t} were defined)`),!0):(!Array.isArray(e)||!Array.isArray(e[0]))&&(rl().warnOncePerTick(`${r} (${t} should be defined as a 2D array)`),!0)}_validateGeometry(e,t=null,i=null){if(t!=null&&!t.includes(e.type))return this.logger.warn("unsupported geometry type for "+i+` symbol: ${e.type}`),!1;switch(e.type){case"point":{const r=e;if(!isFinite(r.x)||!isFinite(r.y))return rl().warn("point coordinate is not a valid number, graphic skipped"),!1;break}case"polygon":q5(e)}return!0}_defaultElevationInfoNoZ(){return n6}_defaultElevationInfoZ(){return a6}_updateElevationContext(){this._elevationInfoOverride!=null?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.setFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.setFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset()}getDefaultElevationInfo(e){return e.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()}getGeometryElevationMode(e,t=this.getDefaultElevationInfo(e)){return this._elevationContext.mode||t.mode}setElevationInfoOverride(e){this._elevationInfoOverride=e,this._updateElevationContext()}createElevationContextForGraphic(e){const t=new dS;return this.updateElevationContextForGraphic(t,e),t}updateElevationContextForGraphic(e,t){const i=t.geometry,r=this.getDefaultElevationInfo(i);e.unit=this._elevationContext.unit!=null?this._elevationContext.unit:r.unit,e.mode=this.getGeometryElevationMode(i,r),e.offsetMeters=this._elevationContext.meterUnitOffset??r.offset??0;const n=!this._elevationOptions.supportsOnTheGround&&e.mode==="on-the-ground";n&&(e.mode="relative-to-ground",e.offsetMeters=0);const a=n?s6:this._elevationContext.featureExpressionInfoContext;a?e.updateFeatureExpressionInfoContextForGraphic(a,t,this._context.layer):e.setFeatureExpressionInfoContext(null)}prepareSymbolLayerPatch(e){}onRemoveGraphic(e){}_getLayerOpacity(){return this._context.graphicsCoreOwner&&"fullOpacity"in this._context.graphicsCoreOwner?this._context.graphicsCoreOwner.fullOpacity??0:this._context.layer.opacity??1}_getCombinedOpacity(e,t=mS){const i=this.draped?1:this._getLayerOpacity();return this._drivenProperties.color?i:e?i*(this._drivenProperties.opacity?1:e.a):t.hasIntrinsicColor?i:0}_getCombinedOpacityAndColor(e,t=mS){const i=this._getCombinedOpacity(e,t);if(this._drivenProperties.color)return uy(null,i);const r=e!=null?vi.toUnitRGB(e):vF;return uy(r,i)}_getDrivenUInt8Color({color:e,opacity:t},i,r){const{color:n,opacity:a}=this._drivenProperties,o=vi.toUnitRGBA(i)??(r?lR:hi),l=n?e??o:null,c=e||i||r,h=n?null:o[3];return uy(l,a&&c?t??h:null,255)}_getDrivenUInt8ColorWithNaNSupport({color:e,opacity:t},i,r){const n=i?EV(vi.toUnitRGBA(i)):Si(NaN,NaN,NaN,r?NaN:0);return this._drivenProperties.color&&e!=null&&jl(n,e),this._drivenProperties.opacity&&t!=null&&(n[3]=t),Qw(n,n,255),l4(n,n)}isFastUpdatesEnabled(){return this._fastUpdates!=null}updateComplexity(){this.complexity=this.computeComplexity()}computeComplexity(){return ID(this.symbol,this.symbolLayer)}globalPropertyChanged(e,t,i){switch(e){case"opacity":return this.layerOpacityChanged(t,i),!0;case"screenSizePerspectiveEnabled":return this.layerScreenSizePerspectiveChanged(t,i),!0;case"elevationInfo":{const r=this._elevationContext.mode;return this._updateElevationContext(),this.layerElevationInfoChanged(t,i,r)!==2}case"slicePlaneEnabled":return this.slicePlaneEnabledChanged(t,i);case"physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case"pixelRatio":return this.pixelRatioChanged;case"skipHighSymbolLods":return this.skipHighSymbolLodsChanged;default:return!1}}get pixelRatioChanged(){return!0}updateGraphics3DGraphicElevationInfo(e,t,i){let r=1;return e?.forEach(n=>{const a=t(n);if(a!=null){const o=n.graphic;this.updateElevationContextForGraphic(a.elevationContext,o),a.needsElevationUpdates=i(a.elevationContext.mode)}else r=2}),r}applyRendererDiff(e,t){return 0}getFastUpdateAttrValues(e){if(!this._fastUpdates)return null;const t=this._fastUpdates.visualVariables,i=t.size?oy(t.size.field,e):0,r=t.color?oy(t.color.field,e):0,n=t.opacity?oy(t.opacity.field,e):0;return Si(i,r,n,0)}get draped(){return this._draped}ensureDrapedStatus(e){return this._draped==null?(this._draped=e,!0):(e!==this.draped&&rl().warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary."),!1)}test(){const e=()=>({size:this._fastUpdates?.visualVariables.size?.field??null,color:this._fastUpdates?.visualVariables.color?.field??null,opacity:this._fastUpdates?.visualVariables.opacity?.field??null,rotation:this._fastUpdates?.visualVariables.rotation?.field??null});return{drivenProperties:this._drivenProperties,getVisVarFields:e}}};function pS(s,e){const t={color:!1,opacity:!1,opacityAlwaysOpaque:e,size:!1,rotation:!1};return s&&"visualVariables"in s&&s.visualVariables&&s.visualVariables.forEach(i=>{switch(i.type){case"color":if(t.color=!0,i.stops)for(let r=0;r<i.stops.length;r++){const n=i.stops[r].color;n&&n.a<1&&(t.opacityAlwaysOpaque=!1)}break;case"opacity":t.opacity=!0,t.opacityAlwaysOpaque=!1;break;case"size":t.size=!0;break;case"rotation":t.rotation=!0}}),t}const n6={mode:"on-the-ground",offset:0,unit:"meters"},a6={mode:"absolute-height",offset:0,unit:"meters"},mS={hasIntrinsicColor:!1},gae=Si(NaN,NaN,NaN,NaN);function kD(s){return s==="position"}function o6(s,e){return s==null&&(s=[]),s.push(e),s}function l6(s,e){if(s==null)return null;const t=s.filter(i=>i!==e);return t.length===0?null:t}function _ae(s,e,t,i,r){qm[0]=s.get(e,0),qm[1]=s.get(e,1),qm[2]=s.get(e,2),UI(qm,nl,3),t.set(r,0,nl[0]),i.set(r,0,nl[1]),t.set(r,1,nl[2]),i.set(r,1,nl[3]),t.set(r,2,nl[4]),i.set(r,2,nl[5])}const qm=x(),nl=new Float32Array(6);let zD=class{constructor(e={}){this.id=hu(),this._highlightIds=new Set,this._shaderTransformation=null,this._visible=!0,this.castShadow=e.castShadow??!0,this.usesVerticalDistanceToGround=e.usesVerticalDistanceToGround??!1,this.graphicUid=e.graphicUid,this.layerViewUid=e.layerViewUid,e.isElevationSource&&(this.lastValidElevationBB=new BD),this._geometries=e.geometries?Array.from(e.geometries):new Array}dispose(){this._geometries.length=0}get layer(){return this._layer}set layer(e){Wt(this._layer==null||e==null,"Object3D can only be added to a single Layer"),this._layer=e}addGeometry(e){e.visible=this._visible,this._geometries.push(e);for(const t of this._highlightIds)e.addHighlight(t);this._emit("geometryAdded",{object:this,geometry:e}),this._highlightIds.size&&this._emit("highlightChanged",this),this._invalidateBoundingVolume()}removeGeometry(e){const t=this._geometries.splice(e,1)[0];if(t){for(const i of this._highlightIds)t.removeHighlight(i);this._emit("geometryRemoved",{object:this,geometry:t}),this._highlightIds.size&&this._emit("highlightChanged",this),this._invalidateBoundingVolume()}}removeAllGeometries(){for(;this._geometries.length>0;)this.removeGeometry(0)}geometryVertexAttributeUpdated(e,t,i=!1){this._emit("attributesChanged",{object:this,geometry:e,attribute:t,sync:i}),kD(t)&&this._invalidateBoundingVolume()}get visible(){return this._visible}set visible(e){if(this._visible!==e){this._visible=e;for(const t of this._geometries)t.visible=this._visible;this._emit("visibilityChanged",this)}}maskOccludee(){const e=new HI;for(const t of this._geometries)t.occludees=o6(t.occludees,e);return this._emit("occlusionChanged",this),e}removeOcclude(e){for(const t of this._geometries)t.occludees=l6(t.occludees,e);this._emit("occlusionChanged",this)}highlight(e){const t=new qI(e);for(const i of this._geometries)i.addHighlight(t);return this._emit("highlightChanged",this),this._highlightIds.add(t),t}removeHighlight(e){this._highlightIds.delete(e);for(const t of this._geometries)t.removeHighlight(e);this._emit("highlightChanged",this)}removeStateID(e){e.channel===0?this.removeHighlight(e):this.removeOcclude(e)}getCombinedStaticTransformation(e,t){return as(t,this.transformation,e.transformation)}getCombinedShaderTransformation(e,t=Ie()){return as(t,this.effectiveTransformation,e.transformation)}get boundingVolumeWorldSpace(){return this._bvWorldSpace||(this._bvWorldSpace=this._bvWorldSpace||new fS,this._validateBoundingVolume(this._bvWorldSpace,0)),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._bvObjectSpace||(this._bvObjectSpace=this._bvObjectSpace||new fS,this._validateBoundingVolume(this._bvObjectSpace,1)),this._bvObjectSpace}_validateBoundingVolume(e,t){const i=t===1;for(const r of this._geometries){const n=r.boundingInfo;n&&c6(n,e,i?r.transformation:this.getCombinedShaderTransformation(r))}jw(e.bounds,kt(ov,e.min,e.max,.5));for(const r of this._geometries){const n=r.boundingInfo;if(n==null)continue;const a=i?r.transformation:this.getCombinedShaderTransformation(r),o=cp(a);ot(ov,n.center,a);const l=Ht(ov,Hi(e.bounds)),c=n.radius*o;e.bounds[3]=Math.max(e.bounds[3],l+c)}}_invalidateBoundingVolume(){const e=this._bvWorldSpace?.bounds;this._bvObjectSpace=this._bvWorldSpace=void 0,this.layer&&e&&this.layer.notifyObjectBBChanged(this,e)}_emit(e,t){this.layer?.events.emit(e,t)}get geometries(){return this._geometries}get transformation(){return this._transformation??_n}set transformation(e){this._transformation=Fr(this._transformation??Ie(),e),this._invalidateBoundingVolume(),this._emit("transformationChanged",this)}get shaderTransformation(){return this._shaderTransformation}set shaderTransformation(e){this._shaderTransformation=e?Fr(this._shaderTransformation??Ie(),e):null,this._invalidateBoundingVolume(),this._emit("shaderTransformationChanged",this)}get effectiveTransformation(){return this.shaderTransformation??this.transformation}get test(){}},BD=class{constructor(){this._data=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE]}get min(){return Qe(this._data[0],this._data[1],this._data[2])}get max(){return Qe(this._data[3],this._data[4],this._data[5])}minWith(e){const{_data:t}=this;t[0]=Math.min(t[0],e[0]),t[1]=Math.min(t[1],e[1]),t[2]=Math.min(t[2],e[2])}maxWith(e){const{_data:t}=this;t[3]=Math.max(t[3],e[0]),t[4]=Math.max(t[4],e[1]),t[5]=Math.max(t[5],e[2])}assignMinMax(e,t){for(let i=0;i<3;++i)this._data[0+i]=e[i],this._data[3+i]=t[i]}isEmpty(){return this._data[3]<this._data[0]&&this._data[4]<this._data[1]&&this._data[5]<this._data[2]}},fS=class extends BD{constructor(){super(...arguments),this.bounds=Xs()}};function c6(s,e,t){const i=s.bbMin,r=s.bbMax;if(J5(t)){const n=be(h6,t[12],t[13],t[14]);return ce(er,i,n),ce(Xr,r,n),e.minWith(er),void e.maxWith(Xr)}if(ot(er,i,t),qo(i,r))return e.minWith(er),void e.maxWith(er);ot(Xr,r,t),e.minWith(er),e.minWith(Xr),e.maxWith(er),e.maxWith(Xr);for(let n=0;n<3;++n)q(er,i),q(Xr,r),er[n]=r[n],Xr[n]=i[n],ot(er,er,t),ot(Xr,Xr,t),e.minWith(er),e.minWith(Xr),e.maxWith(er),e.maxWith(Xr)}const h6=x(),er=x(),Xr=x(),ov=x();function u6(s,e,t,i,r){if(ND(s,e))return null;t.localOrigin=m6(s,e);const n=new zD({geometries:[t],castShadow:!1,layerViewUid:s.layerViewUid,graphicUid:r,usesVerticalDistanceToGround:!0});return{object:n,sampledElevation:SD(n,e,s.elevationProvider,s.renderCoordsHelper,i)}}function wae(s,e,t,i){return ND(e,t)?null:SD(s,t,e.elevationProvider,e.renderCoordsHelper,i)}function ND(s,e){const t=s.clippingExtent;return!!t&&(Na(e,So,s.elevationProvider.spatialReference),!BV(t,So))}function d6(s,e,t){const i=s.elevationContext,r=t.spatialReference;Na(e,So,r),i.centerInElevationSR=Qe(So[0],So[1],e.hasZ?So[2]:0)}function p6(s){switch(s.type){case"point":return s;case"polygon":case"extent":return B$(s);case"polyline":{const e=s.paths[0];if(!e||e.length===0)return null;const t=G5(e,j5(e)/2);return IV(t[0],t[1],t[2],s.spatialReference)}case"mesh":return s.extent.center}return null}function m6(s,e){return Na(e,So,s.renderCoordsHelper.spatialReference),s.localOriginFactory.getOrigin(So)}const So=x();function f6(s){s.include(Qa),s.uniforms.add(new mr("geometryDepthTexture",e=>e.geometryDepth?.attachment)),s.code.add(y`bool geometryDepthTest(vec2 pos, float elementDepth) {
float geometryDepth = linearDepthFromTexture(geometryDepthTexture, pos);
return (elementDepth < (geometryDepth - 1.0));
}`)}function UD(s){const e=new lt,{vertex:t,fragment:i}=e,{terrainDepthTest:r}=s;return t.include(s5),e.include(r5,s),e.vertex.include(GI,s),e.attributes.add("uv0","vec2"),t.uniforms.add(new C_("viewport",n=>n.camera.fullViewport),new ge("lineSize",(n,a)=>n.size>0?Math.max(1,n.size)*a.camera.pixelRatio:0),new ap("pixelToNDC",n=>Xi(gS,2/n.camera.fullViewport[2],2/n.camera.fullViewport[3])),new ge("borderSize",(n,a)=>n.borderColor?a.camera.pixelRatio:0),new Br("screenOffset",(n,a)=>Xi(gS,n.horizontalScreenOffset*a.camera.pixelRatio,0))),e.varyings.add("coverageSampling","vec4"),e.varyings.add("lineSizes","vec2"),r&&e.varyings.add("depth","float"),s.occlusionTestEnabled&&e.include(n5),s.hasScreenSizePerspective&&jI(t),t.main.add(y`
    ProjectHUDAux projectAux;
    vec4 endPoint = projectPositionHUD(projectAux);

    vec3 vpos = projectAux.posModel;
    if (rejectBySlice(vpos)) {
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
      return;
    }
    ${X(s.occlusionTestEnabled,y`if (!testHUDVisibility(endPoint)) {
             gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
             return;
           }`)}

    ${s.hasScreenSizePerspective?y`vec3 perspectiveFactor = screenSizePerspectiveScaleFactor(projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
               vec2 screenOffsetScaled = applyScreenSizePerspectiveScaleFactorVec2(screenOffset, perspectiveFactor);`:"vec2 screenOffsetScaled = screenOffset;"}
    // Add view dependent polygon offset to get exact same original starting point. This is mostly used to get the
    // correct depth value
    vec3 posView = (view * vec4(position, 1.0)).xyz;
    ${X(r,"depth = posView.z;")}

    applyHUDViewDependentPolygonOffset(centerOffsetAndDistance.w, projectAux.absCosAngle, posView);
    vec4 startPoint = proj * vec4(posView, 1.0);

    // Apply screen offset to both start and end point
    vec2 screenOffsetNorm = screenOffsetScaled * 2.0 / viewport.zw;
    startPoint.xy += screenOffsetNorm * startPoint.w;
    endPoint.xy += screenOffsetNorm * endPoint.w;

    // Align start and end to pixel origin
    vec4 startAligned = alignToPixelOrigin(startPoint, viewport.zw);
    vec4 endAligned = alignToPixelOrigin(endPoint, viewport.zw);
    ${X(s.hudDepth,s.hudDepthAlignStart?"endAligned = vec4(endAligned.xy / endAligned.w * startAligned.w, startAligned.zw);":"startAligned = vec4(startAligned.xy / startAligned.w * endAligned.w, endAligned.zw);")}
    vec4 projectedPosition = mix(startAligned, endAligned, uv0.y);

    // The direction of the line in screen space
    vec2 screenSpaceDirection = normalize(endAligned.xy / endAligned.w - startAligned.xy / startAligned.w);
    vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x);
    ${s.hasScreenSizePerspective?y`float lineSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(lineSize, perspectiveFactor);
               float borderSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(borderSize, perspectiveFactor);`:y`float lineSizeScaled = lineSize;
               float borderSizeScaled = borderSize;`}
    float halfPixelSize = lineSizeScaled * 0.5;

    // Compute full ndc offset, adding 1px padding for doing anti-aliasing and the border size
    float padding = 1.0 + borderSizeScaled;
    vec2 ndcOffset = (-halfPixelSize - padding + uv0.x * (lineSizeScaled + padding + padding)) * pixelToNDC;

    // Offset x/y from the center of the line in screen space
    projectedPosition.xy += perpendicularScreenSpaceDirection * ndcOffset * projectedPosition.w;

    // Compute a coverage varying which we can use in the fragment shader to determine
    // how much a pixel is actually covered by the line (i.e. to anti alias the line).
    // This works by computing two coordinates that can be linearly interpolated and then
    // subtracted to find out how far away from the line edge we are.
    float edgeDirection = (uv0.x * 2.0 - 1.0);

    float halfBorderSize = 0.5 * borderSizeScaled;
    float halfPixelSizeAndBorder = halfPixelSize + halfBorderSize;
    float outerEdgeCoverageSampler = edgeDirection * (halfPixelSizeAndBorder + halfBorderSize + 1.0);

    float isOneSided = float(lineSizeScaled < 2.0 && borderSize < 2.0);

    coverageSampling = vec4(
      // Edge coordinate
      outerEdgeCoverageSampler,

      // Border edge coordinate
      outerEdgeCoverageSampler - halfPixelSizeAndBorder * isOneSided,

      // Line offset
      halfPixelSize - 0.5,

      // Border offset
      halfBorderSize - 0.5 + halfPixelSizeAndBorder * (1.0 - isOneSided)
    );

    lineSizes = vec2(lineSizeScaled, borderSizeScaled);
    gl_Position = projectedPosition;`),i.uniforms.add(new qs("uColor",n=>n.color??hi),new qs("borderColor",n=>n.borderColor??hi)),r&&(i.include(f6,s),i.uniforms.add(new ap("inverseViewport",n=>n.inverseViewport))),i.main.add(y`
    ${X(r,"if( geometryDepthTest(gl_FragCoord.xy * inverseViewport, depth) ){ discard; }")}

    vec2 coverage = min(1.0 - clamp(abs(coverageSampling.xy) - coverageSampling.zw, 0.0, 1.0), lineSizes);

    float borderAlpha = uColor.a * borderColor.a * coverage.y;
    float colorAlpha = uColor.a * coverage.x;

    float finalAlpha = mix(borderAlpha, 1.0, colorAlpha);
    ${X(!s.hudDepth,y`vec3 finalRgb = mix(borderColor.rgb * borderAlpha, uColor.rgb, colorAlpha);
           fragColor = vec4(finalRgb, finalAlpha);`)}`),e}const gS=ke(),g6=Object.freeze(Object.defineProperty({__proto__:null,build:UD},Symbol.toStringTag,{value:"Module"}));let _6=class extends ct{constructor(e,t){super(e,t,new ht(g6,()=>k(()=>Promise.resolve().then(()=>QJ),void 0)),HD.locations)}initializePipeline(e){const{hudDepth:t,terrainDepthTest:i}=e,r={func:i?519:513};return qe(t?{depthTest:r,depthWrite:xw}:{blending:du(1,770,771,771),depthTest:r,colorWrite:nt})}};const HD=Xa().vec3f("position").vec3f("normal").vec2f16("uv0").vec4f("centerOffsetAndDistance");let _o=class extends T_{constructor(e){super(),this.spherical=e,this.screenCenterOffsetUnitsEnabled=!1,this.occlusionTestEnabled=!0,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.hudDepth=!1,this.hudDepthAlignStart=!1,this.terrainDepthTest=!1,this.draped=!1}};u([V()],_o.prototype,"screenCenterOffsetUnitsEnabled",void 0),u([V()],_o.prototype,"occlusionTestEnabled",void 0),u([V()],_o.prototype,"hasVerticalOffset",void 0),u([V()],_o.prototype,"hasScreenSizePerspective",void 0),u([V()],_o.prototype,"hudDepth",void 0),u([V()],_o.prototype,"hudDepthAlignStart",void 0),u([V()],_o.prototype,"terrainDepthTest",void 0);let lv=class extends HM{constructor(e,t){super(e,qD),this.intersectDraped=void 0,this.produces=new Map([[15,i=>ns(i)],[16,i=>ns(i)]]),this._configuration=new _o(t),this._uniqueMaterialIdentifier=Eb(this.parameters)}passParameters(){return this.parameters}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.hasVerticalOffset=this.parameters.verticalOffset!=null,this._configuration.hasScreenSizePerspective=this.parameters.screenSizePerspective!=null,this._configuration.hudDepth=t.slot===16,this._configuration.hudDepthAlignStart=!!this.parameters.hudDepthAlignStart,this._configuration.screenCenterOffsetUnitsEnabled=this.parameters.centerOffsetUnits==="screen",this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.terrainDepthTest=t.terrainDepthTest,this._configuration}get visible(){return this.parameters.color[3]>=$s||(this.parameters.borderColor?.[3]??0)>=$s}intersect(){}createGLMaterial(e){return new y6(e)}createBufferWriter(){return new v6}validateParameters(e){this._uniqueMaterialIdentifier=Eb(e)}get uniqueMaterialIdentifier(){return this._uniqueMaterialIdentifier}};function Eb({renderOccluded:s,isDecoration:e,horizontalScreenOffset:t,color:i,size:r,occlusionTest:n,shaderPolygonOffset:a,hudDepthAlignStart:o,centerOffsetUnits:l,hasSlicePlane:c,screenSizePerspective:h,verticalOffset:d,borderColor:m}){return hI`${s}:${e}:${t}:[${i}]:${r}:${n}:${a}:${o}:${l}:${c}:${h!=null}:{${d?.screenLength}:${d?.minWorldLength}:${d?.maxWorldLength}}:[${m}]`}let y6=class extends qM{beginSlot(e){return this.getTechnique(_6,e)}},qD=class extends WI{constructor(){super(...arguments),this.horizontalScreenOffset=0,this.color=Si(0,0,0,1),this.size=1,this.occlusionTest=!1,this.shaderPolygonOffset=1e-5,this.hudDepthAlignStart=!1,this.centerOffsetUnits="world",this.hasSlicePlane=!1}};const _S=[Tc(0,0),Tc(1,0),Tc(0,1),Tc(1,0),Tc(1,1),Tc(0,1)];let v6=class{constructor(){this.layout=HD}elementCount(e){return 6*e.get("position").indices.length}write(e,t,i,r,n,a){QI(i.get("position"),e,n.position,a,6),ZI(i.get("normal"),t,n.normal,a,6),XI(i.get("centerOffsetAndDistance"),n.centerOffsetAndDistance,a,6);for(let o=0;o<_S.length;++o)n.uv0.setVec(a+o,_S[o]);return null}},b6=class GD extends r6{static{this.elevationModeChangeTypes={definedChanged:1,staysOnTheGround:1,onTheGroundChanged:2}}constructor(e,t){super(e,null,t,C6),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){this._materials[0]=new lv(this._materialParameters,this._context.spherical)}_perInstanceMaterialParameters(e){const t=this._materialParameters;return t.horizontalScreenOffset=e.horizontalScreenOffset??0,t.centerOffsetUnits=e.centerOffsetUnits||"world",t}get _materialParameters(){const e=new qD,t=this.symbol,i=t.callout;if(i.color){const a=vi.toUnitRGBA(i.color);a[3]*=this._getLayerOpacity(),e.color=a}else e.color=hi;if(e.size=Eg(i.size||0),t.verticalOffset){const{screenLength:a,minWorldLength:o,maxWorldLength:l}=t.verticalOffset;e.verticalOffset={screenLength:Eg(a),minWorldLength:o||0,maxWorldLength:l??1/0}}e.borderColor=i.border?.color!=null?vi.toUnitRGBA(i.border.color):null;const r=t.symbolLayers.at(0).type==="object",n=t.type==="label-3d";return e.occlusionTest=!r&&!Ze("enable-feature:non-occluded-hud"),r&&(e.shaderPolygonOffset=0),e.hudDepthAlignStart=n,e.hasSlicePlane=this._context.slicePlaneEnabled,e.screenSizePerspective=this._context.screenSizePerspectiveEnabled?this.view.screenSizePerspective.parameters:null,e}_defaultElevationInfoNoZ(){return x6}createGraphics3DGraphic(e,t){const i=e.renderingInfo,r=e.graphic,n=this.createElevationContextForGraphic(r,i.elevationOffset||0),a=i.symbol,o=this._elevationContext.mode==="on-the-ground"&&(a.type==="cim"||!a.symbolLayers.some(c=>c.type==="object"||c.type==="text"));if(a.type!=="label-3d"&&o||a.type==="point-3d"&&a.symbolLayers.every(c=>c.type==="text"&&!i4(c)))return null;const l=B$(r.geometry);return l==null?null:this._createAs3DShape(l,n,i,r.uid,t)}layerOpacityChanged(){this._materials[0]?.setParameters(this._materialParameters)}layerScreenSizePerspectiveChanged(){const e=this._context.screenSizePerspectiveEnabled?this.view.screenSizePerspective.parameters:null;this._materials[0]?.setParameters({screenSizePerspective:e})}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,n=Oq(GD.elevationModeChangeTypes,i,r);return n!==1||e?.forEach(a=>{const o=t(a);o!=null&&this.graphics3DGraphicLayerElevationInfoChanged(a.graphic,o)}),n}slicePlaneEnabledChanged(){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}createElevationContextForGraphic(e,t=0){const i=super.createElevationContextForGraphic(e);return i.addOffsetRenderUnits(t),i}updateElevationContextForGraphic(e,t,i=0){super.updateElevationContextForGraphic(e,t),e.addOffsetRenderUnits(i)}graphics3DGraphicLayerElevationInfoChanged(e,t){const{elevationContext:i,metadata:r}=t;this.updateElevationContextForGraphic(i,e,r?.elevationOffset??0),t.needsElevationUpdates=hS(i.mode)}computeComplexity(){return new Mr({verticesPerFeature:6})}_getOrCreateMaterial(e,t){const i=this._perInstanceMaterialParameters(e),r=Eb(i);if(r===this._materials[0]?.uniqueMaterialIdentifier)return this._materials[0];if(t){let n=t.get(r);return n==null&&(n=new lv(i,this._context.spherical),t.set(r,n)),n}return new lv(i,this._context.spherical)}_createAs3DShape(e,t,i,r,n){const a=this._context.layerViewUid,o=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:r,layerViewUid:a}),l=this._getOrCreateMaterial(i,n),c=new GM(l,w6(i),null,1,o),h=u6(this._context,e,c,t,r);if(h==null)return null;const d=new DD(this,h.object,null,kq,t);return d.metadata=new Hq(i.elevationOffset),d.alignedSampledElevation=h.sampledElevation,d.needsElevationUpdates=hS(t.mode),d6(d,e,this._context.elevationProvider),d}};function w6(s){const{translation:e,centerOffset:t}=s,i=new Rf(e?[e[0],e[1],e[2]]:[0,0,0],cv,3,!0),r=new Rf(t?[t[0],t[1],t[2],t[3]]:[0,0,0,1],cv,4,!0);return[["position",i],["normal",new Rf([0,0,1],cv,3,!0)],["centerOffsetAndDistance",r]]}const cv=[0],x6={mode:"relative-to-ground",offset:0},C6={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1};let T6=class extends Rq{constructor(e,t,i=x(),r=Lt(),n=0,a="world",o=0){super(e,t),this.translation=i,this.centerOffset=r,this.horizontalScreenOffset=n,this.centerOffsetUnits=a,this.elevationOffset=o}},S6=class extends Nq{};const yS=()=>j.getLogger("esri.views.3d.layers.graphics.Graphics3DCalloutSymbolLayerFactory");function P6(s,e){if(!fR(s))return yS().error("Graphics3DCalloutSymbolLayerFactory#make",`symbol of type '${s.type}' does not support callouts`),null;if(!s.callout)return null;const t=M6[s.callout.type];return t?new t(s,e):(yS().error("Graphics3DCalloutSymbolLayerFactory#make",`unknown or unsupported callout type ${s.callout.type}`),null)}const M6={line:b6},vS=new Do(()=>Ka(),s=>pR(s,UV),null,10,5),$6=Mt();let R6=class{get labelLayers(){return this._labelLayers||uI}get extent(){return this._extent}get isElevationSource(){return this.layers.some(e=>e?.isElevationSource)}constructor(e,t,i){this.graphic=e,this.graphics3DSymbol=t,this.layers=i,this._visibleFlags=255,++t.referenced}initialize(e){this._layer=e,this._forEachSymbolLayerGraphic(t=>{t.initialize(e),t.setVisibility(this.isVisible())})}destroy(){this._forEachSymbolLayerGraphic(e=>e.destroy()),this._calloutLayer=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}get destroyed(){return this.layers==null}clearLabelGraphics(){this._forEachLabelGraphic(e=>e.destroy()),this._labelLayers=null}addLabelGraphic(e,t){this._labelLayers||(this._labelLayers=new Array),this._labelLayers.push(e),e.initialize(t),e.setVisibility(this.isVisible(16))}setCalloutGraphic(e){this._calloutLayer=e,this._layer&&(e.initialize(this._layer),e.setVisibility(this.isVisible()))}get calloutLayer(){return this._calloutLayer}get isDraped(){let e=!1;return this._forEachSymbolLayerGraphic(t=>{t.type==="draped"&&(e=!0)}),e}isVisible(e=1,t){const i=t?this._visibleFlags|t|16*t:this._visibleFlags;return e===1?!(15&~i):!(255&~i)}setVisibilityFlag(e,t,i){const r=this.isVisible(e);i?this._visibleFlags|=e*t:this._visibleFlags&=~(e*t);const n=this.isVisible(e);if(r===n)return!1;if(e===16)this._forEachLabelGraphic(a=>a.setVisibility(n));else{this._forEachSymbolLayerGraphic(o=>o.setVisibility(n));const a=this.isVisible(16);this._forEachLabelGraphic(o=>o.setVisibility(a))}return!0}getVisibilityFlag(e,t){return(this._visibleFlags&e*t)!==0}computeExtent(e){if(!this._extent){const t=this.graphic.geometry;if(t==null)return!1;this._extent=Mt(),T4(t,this._extent);const i=t.spatialReference;if(!tc(i,e)&&!i1(this._extent,i,this._extent,e))return this._extent=null,!1}return!0}getAsOptimizedGeometry(e,t){return this._optimizedGeometry||(this._optimizedGeometry=this._convertGraphicToOptimizedGeometry(this.graphic,e,t)),this._optimizedGeometry}_convertGraphicToOptimizedGeometry(e,t,i){let r=e.geometry;return r.type!=="mesh"&&r.type!=="extent"||(r=W$.fromExtent(r.type==="mesh"?r.extent:r)),S4(r,t,i)}get usedMemory(){let e=uV(this.graphic.attributes);return this._forEachSymbolLayerGraphic(t=>e+=t.usedMemory),e}computeAttachmentOrigin(){const e={render:{origin:x(),num:0},draped:{origin:ke(),num:0}};for(const t of this.layers)t?.computeAttachmentOrigin(e);return e.render.num>1&&ee(e.render.origin,e.render.origin,1/e.render.num),e.draped.num>1&&$l(e.draped.origin,e.draped.origin,1/e.draped.num),e}async getProjectedBoundingBox(e,t,i,r,n){return n||(n={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),n.boundingBox?Hr(n.boundingBox):n.boundingBox=Hr(),n.requiresDrapedElevation=!1,await Fw(this.layers,async a=>{if(a==null)return;const o=a.type==="draped"?t:e,l=vS.acquire(),c=await a.getProjectedBoundingBox(o,i,n.screenSpaceObjects,r,l);isFinite(c[2])&&isFinite(c[5])||(n.requiresDrapedElevation=!0),c&&uR(n.boundingBox,l),vS.release(l)}),NV(n.boundingBox)||$0(Yw(n.boundingBox,$6))?n:null}needsElevationUpdates(){for(const e of this.layers)if(e!=null&&(e.type==="object3d"||e.type==="lod-instance")&&e.needsElevationUpdates)return!0;return this._labelLayers?.some(e=>e?.needsElevationUpdates??!1)??!1}alignWithElevation(e,t,i){this._forEachRenderedGraphic(r=>{r.type!=="object3d"&&r.type!=="lod-instance"||r.alignWithElevation(e,t,i)})}alignWithAbsoluteElevation(e,t,i){this._forEachRenderedGraphic(r=>{r.type==="object3d"&&r.alignWithAbsoluteElevation(e,t,i)})}addObjectStateSet(e){this._forEachSymbolLayerGraphic(t=>t.addObjectState(e))}removeObjectState(e){this._forEachSymbolLayerGraphic(t=>t.removeObjectState(e))}updateHighlights(e){this._forEachSymbolLayerGraphic(t=>t.updateHighlights(e))}_forEachGraphicList(e,t){e?.forEach(i=>i&&t(i))}_forEachSymbolLayerGraphic(e){this._forEachGraphicList(this.layers,e),this._calloutLayer&&e(this._calloutLayer)}_forEachLabelGraphic(e){this._forEachGraphicList(this.labelLayers,e)}_forEachRenderedGraphic(e){this._forEachSymbolLayerGraphic(e),this._forEachLabelGraphic(e)}get test(){}},Dae=class{constructor(e,t,i,r){this.scheduler=e,this.schedule=t,this.layerViewUid=i,this.compressionTracker=r,this.sharedResources=null,this.streamDataRequester=null,this.elevationProvider=null,this.renderer=null,this.stage=null,this.clippingExtent=null,this.renderCoordsHelper=null,this.overlaySR=null,this.layer=null,this.drapeSourceRenderer=null,this.graphicsCoreOwner=null,this.localOriginFactory=null,this.featureExpressionInfoContext=null,this.screenSizePerspectiveEnabled=!0,this.slicePlaneEnabled=!1,this.physicalBasedRenderingEnabled=!1,this.skipHighSymbolLods=!1,this.isAsync=!1}get spherical(){return this.stage.view.state.viewingMode===1}},O6=class{constructor(){this.renderPriority=0,this.renderPriorityStep=1,this.ignoreDrivers=!1}};const D6=2216,E6=4096;function jD(s){return D6+E6*s.symbolLayers.length+s.complexity.memory.resourceBytes}let A6=class extends E1{set symbol(e){this._symbol=e,e.symbolLayers.forEach((t,i)=>{const r=this.symbolLayers[i];r!=null&&(r.symbol=e,r.symbolLayer=t)})}get symbol(){return this._symbol}constructor(e,t,i){super(t.schedule),this._symbol=e,this._context=t,this._backgroundLayers=i,this._destroyed=!1,this.symbolLayers=new Array,this.referenced=0,this._extentPadding=0}async doLoad(e){let t=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(t=this._backgroundLayers.concat(t));const i=t.length;for(;this.symbolLayers.length<t.length;)this.symbolLayers.push(null);this.symbolLayers.length=t.length;const r=[];if(!hv){const{make:n}=await k(()=>import("./Graphics3DSymbolLayerFactory-BDRDEKPc.js"),__vite__mapDeps([451,1,445,7,8,5,6,352,19,9,20,14,70,4,2,10,39,183,197,102,28,37,38,184,247,13,292,307,57,26,3,11,12,15,27,29,30,31,32,33,34,35,36,40,41,42,43,44,207,186,88,185,87,182,187,188,189,190,191,192,193,194,195,196,198,199,200,93,201,202,203,92,94,90,95,204,208,209,210,98,211,415,416,166,241,47,81,82,71,83,84,85,452,453,454,99,243,75,229,16,142,230,114,161,18,375,165,164,231,60,61,244,74,73,69,76,329,414,409,391,455,250,456,457,458,459,273,460,461,462,238,239,80,258,65,463,58,52,59,464,235,227,387,257,21,22,23,24,113,205,206,175,129,122,212,213,214,180,215,216,217,147,218,219,220,144,221,222,223,224,51,48,49,225,226,228,132,232,233,234,100,236,237,240,242,245,246,248,249]));hv=n}for(let n=0;n<i;n++){const a=t.at(n);if(a.enabled===!1)continue;Gm.renderPriority=1-(1+n)/i,Gm.renderPriorityStep=1/i,Gm.ignoreDrivers=a.ignoreDrivers;const o=hv(this.symbol,a,this._context,Gm),l=dI(e,()=>{this.symbolLayers[n]=null,o.destroy()});l&&r.push(l),this.symbolLayers[n]=o}if(await Fw(this.symbolLayers,async(n,a)=>{if(n!=null)try{await n.load(),this._extentPadding+=Math.max(this._extentPadding,n.extentPadding)}catch{this.symbolLayers[a]=null}}),r.forEach(n=>n.remove()),He(e),this.symbolLayers.length&&!this.symbolLayers.some(n=>!!n))throw new Error}getSymbolLayerSize(e){const t=this.symbolLayers[e];return t!=null?t.getCachedSize():null}get extentPadding(){return this._extentPadding}get symbologySnappingSupported(){return this.symbolLayers.some(e=>e?.queryForSnapping)}get needsUpdateFocus(){return this.symbolLayers.some(e=>e?.needsUpdateFocus===!0)}createGraphics3DGraphic(e,t){const{graphic:i}=e,r=this.symbolLayers.map(n=>n?.createGraphics3DGraphic(e)??null);return new R6(i,t||this,r)}get complexity(){return D1(this.symbolLayers.map(e=>e?.complexity))}globalPropertyChanged(e,t){const i=this.symbolLayers.length;for(let r=0;r<i;r++){const n=this.symbolLayers[r],a=o=>{const l=o.layers[r];return l instanceof DD?l:null};if(n!=null&&!n.globalPropertyChanged(e,t,a))return!1}return!0}applyRendererDiff(e,t){return this.loadStatus!==1?0:this.symbolLayers.reduce((i,r)=>i!==0&&r!=null?Math.min(i,r.applyRendererDiff(e,t)):i,2)}prepareSymbolPatch(e){if(this.loadStatus===2||e.diff.type!=="partial")return;const t=e.diff.diff;if(!t.symbolLayers||t.symbolLayers.type!=="partial")return;const i=t.symbolLayers.diff;this.symbolLayers.forEach((r,n)=>{if(r==null)return;const a=i[n];if(a){const o={diff:a,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};r.prepareSymbolLayerPatch(o),e.symbolStatePatches.push(...o.symbolLayerStatePatches),o.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push((l,c)=>{const h=l.layers[n];h!=null&&o.graphics3DGraphicPatches.forEach(d=>d(h,c))})}})}updateGeometry(e){return this._updateGeometryOrTransform(e,(t,i)=>!!t.updateGeometry&&t.updateGeometry(e.graphic,i))}updateTransform(e,t,i,r){return this._updateGeometryOrTransform(e,(n,a)=>!!n.updateTransform&&n.updateTransform(a,t,i,r))}_updateGeometryOrTransform(e,t){for(let i=0;i<this.symbolLayers.length;i++){const r=this.symbolLayers[i];if(r==null)continue;const n=e.layers[i];if(!n||!t(r,n))return!1}return!0}onRemoveGraphic(e){for(let t=0;t<this.symbolLayers.length;t++){const i=this.symbolLayers[t];if(i==null)continue;const r=e.layers[t];r!=null&&i.onRemoveGraphic(r)}}getFastUpdateStatus(){let e=!1,t=!1;for(const i of this.symbolLayers)if(i!=null){if(i.loadStatus===0)return 3;i.isFastUpdatesEnabled()?t=!0:e=!0}return t?e?2:1:e?0:4}async queryForSnapping(e,t,i,r){const n=this.symbolLayers.filter(Mg).filter(o=>o.queryForSnapping!=null).map(o=>o.queryForSnapping(e,t,i,r)),a=await Promise.all(n);return He(r),a.flat()}destroy(){if(!this.destroyed){super.destroy();for(const e of this.symbolLayers)e?.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}get usedMemory(){return jD(this)}},hv=null;const Gm=new O6;let I6=class extends E1{constructor(e,t,i){super(t),this.symbol=e,this._convert=i,this.symbologySnappingSupported=!1,this.graphics3DSymbol=null,this.referenced=0}getSymbolLayerSize(e){return this.graphics3DSymbol!=null?this.graphics3DSymbol.getSymbolLayerSize(e):null}get symbolLayers(){return this.graphics3DSymbol!=null?this.graphics3DSymbol.symbolLayers:[]}get extentPadding(){return this.graphics3DSymbol!=null?this.graphics3DSymbol.extentPadding:0}async doLoad(e){const t=await this.symbol.fetchSymbol({signal:e});t.id=this.symbol.id,this.graphics3DSymbol=this._convert(t),this.graphics3DSymbol!=null&&await this.graphics3DSymbol.load()}createGraphics3DGraphic(e){return this.graphics3DSymbol!=null?this.graphics3DSymbol.createGraphics3DGraphic(e,this):null}get complexity(){return this.graphics3DSymbol!=null?this.graphics3DSymbol.complexity:AD}globalPropertyChanged(e,t){return this.graphics3DSymbol!=null&&this.graphics3DSymbol.globalPropertyChanged(e,t)}applyRendererDiff(e,t){return this.graphics3DSymbol!=null?this.graphics3DSymbol.applyRendererDiff(e,t):0}prepareSymbolPatch(e){this.graphics3DSymbol!=null&&this.graphics3DSymbol.prepareSymbolPatch(e)}updateGeometry(e){return this.graphics3DSymbol!=null&&this.graphics3DSymbol.updateGeometry(e)}updateTransform(e,t,i,r){return this.graphics3DSymbol?.updateTransform(e,t,i,r)??!1}onRemoveGraphic(){}get needsUpdateFocus(){return!1}getFastUpdateStatus(){return this.graphics3DSymbol?.getFastUpdateStatus()??3}destroy(){this.graphics3DSymbol!=null&&this.graphics3DSymbol.destroy(),this.graphics3DSymbol=void 0,super.destroy()}get destroyed(){return this.graphics3DSymbol===void 0}get usedMemory(){return jD(this)}};function Ab(s){return s instanceof I6?s.graphics3DSymbol:s instanceof A6?s:null}const Fae=1.2,Vae=hi,L6=4;let F6=class{constructor(e,t="center",i=!1,r=ke(),n=Si(0,0,0,-1),a="world",o=x(),l=0){this.verticalOffset=e,this.anchor=t,this.hasLabelVerticalOffset=i,this.screenOffset=r,this.centerOffset=n,this.centerOffsetUnits=a,this.translation=o,this.elevationOffset=l}},V6=class{constructor(e,t="center",i="center",r=null,n=ke(),a=!0){this.placement=e,this.horizontalPlacement=t,this.verticalPlacement=i,this.text=r,this.displaySize=n,this.isFocused=a}};const Vu=()=>j.getLogger("esri.views.3d.layers.graphics.labelPlacement");let bS=class{constructor(e,t,i,r=null){this._graphic=e,this._symbol=t,this._class=i,this._disablePlacement=r}get placement(){const e=this._verticalOffsetPlacement;if(e==null)return null;const t=this._getPlacementInfo(e);if(t==null)return null;const i=t.anchor,r=!!e.hasLabelVerticalOffset,n=e.verticalOffset,a=new F6(n,i,r);return this._calculatePlacementOffsets(a,t)}get _verticalOffsetPlacement(){const e=this._class.labelPlacement,{_symbol:t,_graphic:i}=this,r=Ab(i.graphics3DSymbol),n=r?.symbol.type==="point-3d"?r.symbol:null,a=Ar[e]||this._defaultPlacementInfo;return n?.supportsCallout()&&n.hasVisibleVerticalOffset()&&!i.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:n.verticalOffset.clone(),anchor:null,normalizedOffset:null}:!t?.hasVisibleVerticalOffset()||n!=null&&n.supportsCallout()&&n.verticalOffset&&!i.isDraped?{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}:a&&k6(a.placement)?{placement:"above-center",verticalOffset:t.verticalOffset.clone(),anchor:"bottom",normalizedOffset:[0,a.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(Vu().errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+e+" placement)"),null)}_getPlacementInfo(e){if(e.anchor)return e;const t=this._class.labelPlacement,i=Ar[t],r=i||this._defaultPlacementInfo;return t&&!i&&Vu().warnOnce(`the requested label placement '${t}' is currently unsupported in SceneView.`),this._validatePlacementInfo(r)}_calculatePlacementOffsets(e,t){const i=this._graphic.graphic.geometry;if(i==null)return null;switch(i.type){case"point":this._setPointSpecificPlacement(e,t);break;case"mesh":this._setMeshSpecificPlacement(e,t);break;case"polygon":this._setPolygonSpecificPlacement(e,t)}const r=L6-a5;return e.screenOffset[0]+=r*t.normalizedOffset[0],e.screenOffset[1]+=r*t.normalizedOffset[1],e}get _defaultPlacementInfo(){const e=this._graphic.graphic.geometry;if(e==null)return null;switch(e.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:ea,anchor:"center"};case"polygon":return this._firstSymbolLayer?.type==="extrude"?Ar["above-center"]:{placement:"center-center",normalizedOffset:ea,anchor:"center"};case"point":case"mesh":return Ar["above-center"];default:return}}_validatePlacementInfo(e){const t=this._graphic.graphic.geometry;if(t==null)return null;if(this._disablePlacement!=null){const r=this._class.labelPlacement;return r?(Vu().warnOncePerTick(wS(r,this._disablePlacement.logEntityDescription)),this._defaultPlacementInfo):e}const i=t.type;switch(i){case"polyline":case"polygon":case"extent":case"multipoint":{const r=this._class.labelPlacement;if(r)return Ar[r]&&Vu().warnOnce(wS(r,`'${i}' geometries`)),this._defaultPlacementInfo;break}case"point":case"mesh":return e}return e}_setPointSpecificPlacement(e,t){const i=this._firstSymbolLayer;if(i==null)return;const r=this._graphic.layers[0];switch(r!=null?r.getCenterObjectSpace(e.translation):be(e.translation,0,0,0),i.type){case"icon":case"text":this._setHUDSpecificPlacement(e,t,r);break;case"object":uv(e,t,r)}}_setMeshSpecificPlacement(e,t){const i=this._firstSymbolLayer;i!=null&&i.type==="fill"&&uv(e,t,this._graphic.layers[0])}_setPolygonSpecificPlacement(e,t){const i=this._firstSymbolLayer;if(i!=null&&i.type==="extrude"){const r=this._graphic.layers[0];r!=null?(r.getBoundingBoxObjectSpace(Kd),Xw(Kd,e.translation),e.translation[2]=dR(Kd)/2):be(e.translation,0,0,0),uv(e,t,r)}}_setHUDSpecificPlacement(e,t,i){const{_graphic:r}=this,n=i!=null?i.getScreenSize():null;if(r.isDraped||n==null)e.hasLabelVerticalOffset||e.anchor==="center"||(Ar[this._class.labelPlacement]&&Vu().warnOncePerTick(`the requested placement '${t.placement}' is currently unsupported for draped graphics`),e.anchor="center");else{const a=this._normalizedSymbolAnchorPos;e.screenOffset[0]=n[0]/2*(t.normalizedOffset[0]-a[0]);const o=n[1]/2*(t.normalizedOffset[1]-a[1]);e.hasLabelVerticalOffset?(e.centerOffset[1]=o,e.centerOffsetUnits="screen"):e.screenOffset[1]=o}}get _firstSymbolLayer(){const e=this._graphic.graphics3DSymbol,t=Ab(e);return t!=null?t.symbol.symbolLayers.at(0):null}get _normalizedSymbolAnchorPos(){const e=this._graphic.layers[0],t=e?.stageObject.geometries[0].material??null;if(t&&t instanceof Iw){const i=t.parameters.anchorPosition;ku[0]=2*(i[0]-.5),ku[1]=2*(i[1]-.5)}else ku[0]=0,ku[1]=0;return ku}};function wS(s,e){return`the requested label placement '${s}' is currently unsupported for ${e} in SceneView.`}function uv(s,e,t){const i=t!=null?t.getBoundingBoxObjectSpace(Kd):Kd,r=Qe(i[3]-i[0],i[4]-i[1],i[5]-i[2]),n=Math.sqrt(r[0]*r[0]+r[1]*r[1]);s.centerOffset[0]=n/2*e.normalizedOffset[0];const a=s.translation[2],o=r[2]/2*e.normalizedOffset[1];s.translation[2]=0,s.elevationOffset=a+o;const l=fe(r);s.centerOffset[2]=l/2*e.normalizedOffset[2]}function k6(s){return s==="above-center"}const Ar={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},xS={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const s in xS){const e=xS[s],t=Ar[s];e.forEach(i=>{Ar[i]=t})}Object.freeze&&(Object.freeze(Ar),Object.keys(Ar).forEach(s=>{Object.freeze(Ar[s]),Object.freeze(Ar[s]?.normalizedOffset)}));const ku=[0,0],Kd=Ka();let z6=class WD{constructor(e){this.definition=e,this.key=JSON.stringify(e),this.haloSize=Math.round(e.halo.size),this.textStyle=CS(e.color),this.haloStyle=B6(e.halo.color),this.backgroundStyle=e.background.color[3]!==0?CS(e.background.color):null}fontString(e){const t=this.definition.font;return`${t.style} ${t.weight} ${e}px ${t.family}, sans-serif, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol, Noto Color Emoji`}setFontProperties(e,t){e.font=this.fontString(t),e.textAlign="left",e.textBaseline="alphabetic"}static async fromSymbol(e,t){const i=e?.material?.color,r=vi.toUnitRGBA(i)??hi,n=e.size!=null?Eg(e.size):12,a=e.lineHeight,o=e.background!=null?vi.toUnitRGBA(e.background.color):hi,l={family:e.font?.family??"sans-serif",decoration:e.font?.decoration??"none",weight:e.font?.weight??"normal",style:e.font?.style??"normal"},c=e.halo,h=c?.color!=null&&c.size>0?{size:Eg(c.size),color:vi.toUnitRGBA(c.color)}:{size:0,color:hi},d=new WD({color:r,size:n,background:{color:o,padding:e.background!=null?[.65*n,.5*n]:[0,0],borderRadius:e.background!=null?n*(6/16):0},lineSpacingFactor:a,font:l,halo:h,pixelRatio:t});if(e.font){let m=!1;const f=d.fontString(n);try{m=(await document.fonts.load(f)).some(g=>!XV(g))}catch{j.getLogger("esri.views.3d.webgl-engine.lib.TextRenderParameters").warnOnce(`Failed to preload font '${f}'. Some text symbology may be rendered using the default browser font.`)}if(!m&&!N6.has(e.font.family))try{await YV(e.font)}catch{}}return d}};function B6(s){return`rgb(${s.slice(0,3).map(e=>Math.floor(255*e)).toString()})`}function CS(s){return`rgba(${s.slice(0,3).map(e=>Math.floor(255*e)).toString()},${s[3]})`}const N6=new Set(["Arial","Times New Roman","Courier New","serif","sans-serif","monospace","cursive","fantasy","system-ui","ui-serif","ui-sans-serif","ui-monospace","ui-rounded","math","emoji","fangsong"]),ao=4096;let Rh=class extends te{constructor(e){super(e),this.id=hu(),this.events=new cc,this._glTexture=null,this._atlas=new H6(256,256),this._needsRepack=!1,this._canRepack=!0,this._elementsToRender=new Map,this._elements=new Map,this._uvCallbacks=new Map,this.updating=!1}initialize(){this._canvas=document.createElement("canvas"),this._canvas.setAttribute("id","textAtlasCanvas"),this._canvas.setAttribute("style","display:none"),this._ctx=this._canvas.getContext("2d"),this._stage=this.view.stage,this._stage.addTexture(this),this._updateCanvasElementSize(this._atlas),this._reset()}unload(){this._glTexture=_e(this._glTexture),this._frameWorker=bi(this._frameWorker),this.updating=!1,this.events.emit("unloaded")}get loaded(){return this._glTexture!=null}get glTexture(){return this._glTexture}static get maxSize(){return Jd=0,[ao-oo-Jd,ao-oo-Jd-TS]}load(e){if(this._glTexture)return this._glTexture;const t=new ft;return t.wrapMode=33071,t.samplingMode=9987,t.hasMipmap=!0,t.preMultiplyAlpha=!0,t.maxAnisotropy=e.parameters.maxMaxAnisotropy,this._glTexture=new bt(e,t,this._canvas),this._frameWorker=this.view.resourceController.scheduler.registerTask(di.TEXT_TEXTURE_ATLAS,this),this.setDirty(),this._glTexture}dispose(){this._elements.clear(),this._elementsToRender.clear(),this._frameWorker=bi(this._frameWorker),this._glTexture&&(this._stage.removeTexture(this),this._glTexture=_e(this._glTexture)),this._canvas.width=0,this._canvas.height=0,this._canvas=null,this._ctx=null}_updateCanvasElementSize(e){this._canvas.width=e.width,this._canvas.height=e.height}_resizeAtlas(e,t){const{width:i,height:r}=this._atlas;i===e&&r===t||(this._atlas.width=e,this._atlas.height=t,this._glTexture?.resize(e,t),this._glTexture?.updateData(0,0,0,i,r,this._canvas),this._updateCanvasElementSize(this._atlas),this._elements.forEach(n=>this._uvCallbacks.get(n.textRenderer.key)?.forEach(a=>a(n.uv))),this._reset())}_reset(){this._elementsToRender.clear(),this._atlas.reset(),this._needsRepack=!0,this.setDirty()}_addAtlasElement(e,t,i,r){const n=this._atlas;if(n.width<i||n.height<r)return!1;let a=n.cursors.get(r);if(!a){if(n.height<n.nextY+r)return!1;a=[new SS(n.nextY)],n.cursors.set(r,a),n.nextY+=r}let o=a.find(l=>n.width>=l.x+i);if(o==null){if(n.height<n.nextY+r)return!1;o=new SS(n.nextY),n.nextY+=r,a.push(o)}return e.setNewPosition(o),this._elements.set(t,e),this._elementsToRender.set(t,e),o.x+=i,!0}_ensureCallbacks(e){const t=this._uvCallbacks.get(e);if(t)return t;const i=new Set;return this._uvCallbacks.set(e,i),i}_addCallback(e,t){this._ensureCallbacks(e).add(t)}_removeCallback(e,t){const i=this._uvCallbacks.get(e);return!(!i?.delete(t)||i.size!==0)&&(this._uvCallbacks.delete(e),!0)}_processAddition(e){const t=e.textRenderer.key;if(this._needsRepack)return void this._elements.set(t,e);const i=this._atlas,r=e.textRenderer.renderedWidth,n=e.textRenderer.renderedHeight,a=r+oo,o=n+oo+TS;if(!this._addAtlasElement(e,t,a,o)){if(this._canRepack)this._reset();else if(i.width<a){const l=ly(Math.max(a,1.5*i.width),ao);this._resizeAtlas(l,i.height)}else{const l=i.nextY+o,c=ly(Math.max(l,1.5*i.height),ao);if(c>i.height)this._resizeAtlas(i.width,c);else if(i.width<ao){const h=ly(1.5*i.width,ao);this._resizeAtlas(h,i.height)}}this._elements.set(t,e)}}_renderElement(e){const t=e.commitNewPosition(),i=e.textRenderer;this._ctx.clearRect(t[0]-oo,t[1]-oo,i.renderedWidth+2*oo,i.renderedHeight+2*oo),i.render(this._ctx,t[0],t[1]),this._uvCallbacks.get(i.key)?.forEach(r=>r(e.uv))}get readyToRun(){return this.updating}runTask(e){if(this._glTexture==null)return Ai;for(;this._needsRepack&&(this._canRepack||this._atlas.height<ao&&this._atlas.height<ao);){this._canRepack=this._needsRepack=!1;const t=this._elements;this._elements=new Map,t.forEach(i=>this._processAddition(i)),e.madeProgress()}if(this._elementsToRender.size>0){for(const[t,i]of this._elementsToRender){if(e.done)break;this._renderElement(i),this._elementsToRender.delete(t),e.madeProgress()}this._glTexture.setData(this._canvas)}this.updating=this._elementsToRender.size>0}addText(e,t){const i=e.key;this._addCallback(i,t);let r=this._elements.get(i);return r?Pf(r.uv,hi)||t(r.uv):(r=new U6(e),this._processAddition(r),this.setDirty()),{remove:()=>this._removeText(e,t)}}_removeText(e,t){const i=e.key;this._elements.get(i)&&this._removeCallback(i,t)&&(this._elements.delete(i),this._elementsToRender.delete(i),this._canRepack=!0)}setDirty(){this._glTexture&&(this.updating=!0)}get test(){}get usedMemory(){return(this._glTexture?.usedMemory??0)+(this._canvas?.width??0)*(this._canvas?.height??0)*4}};u([p({constructOnly:!0})],Rh.prototype,"view",void 0),u([p({type:Boolean})],Rh.prototype,"updating",void 0),Rh=u([R("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],Rh);const oo=2,TS=2;let U6=class{constructor(e){this.textRenderer=e,this._uv=Lt(),this._newPosition=[0,0]}get uv(){if(this._xOffset==null||this._yOffset==null)return hi;const{renderedWidth:e,renderedHeight:t}=this.textRenderer;return os(this._uv,this._xOffset,this._yOffset+t,this._xOffset+e,this._yOffset)}setNewPosition(e){this._newPosition[0]=e.x,this._newPosition[1]=e.y}commitNewPosition(){return this._xOffset=this._newPosition[0],this._yOffset=this._newPosition[1],this._newPosition}get xOffset(){return this._xOffset}get yOffset(){return this._yOffset}},H6=class{constructor(e,t){this.width=e,this.height=t,this.cursors=new Map,this.nextY=0}reset(){this.cursors.clear(),this.nextY=Jd}},SS=class{constructor(e){this.y=e,this.x=Jd}},Jd=0;const q6=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","transformationChanged","shaderTransformationChanged","visibilityChanged","occlusionChanged","highlightChanged","geometryAdded","geometryRemoved","attributesChanged"];let QD=class{constructor(e,t,i=""){this.stage=e,this.apiLayerViewUid=i,this.id=hu(),this.events=new cc,this.visible=!0,this.sliceable=!1,this._objectsAdded=new Array,this._handles=new b_,this._objects=new Map,this._pickable=!0,this.visible=t?.visible??!0,this._pickable=t?.pickable??!0,this.updatePolicy=t?.updatePolicy??0,e.addLayer(this);for(const r of q6)this._handles.add(this.events.on(r,n=>e.handleEvent(r,n)))}destroy(){this._handles.size&&(this._handles.destroy(),this.stage.removeLayer(this),this.invalidateSpatialQueryAccelerator())}get objects(){return this._objects}getObject(e){return Jl(this._objects.get(e))}set pickable(e){this._pickable=e}get pickable(){return this._pickable&&this.visible}add(e){this._objects.set(e.id,e),e.layer=this,this.events.emit("layerObjectAdded",e),this._octree!=null&&this._objectsAdded.push(e)}remove(e){this._objects.delete(e.id)&&(this.events.emit("layerObjectRemoved",e),e.layer=null,this._octree!=null&&(Lr(this._objectsAdded,e)||this._octree.remove([e])))}addMany(e){for(const t of e)this._objects.set(t.id,t),t.layer=this;this.events.emit("layerObjectsAdded",e),this._octree!=null&&this._objectsAdded.push(...e)}removeMany(e){const t=new Array;for(const i of e)this._objects.delete(i.id)&&t.push(i);if(t.length!==0&&(this.events.emit("layerObjectsRemoved",t),t.forEach(i=>i.layer=null),this._octree!=null)){for(let i=0;i<t.length;)Lr(this._objectsAdded,t[i])?(t[i]=t[t.length-1],t.length-=1):++i;this._octree.remove(t)}}commit(){this.stage.commitLayer(this)}sync(){this.updatePolicy!==1&&this.stage.syncLayer(this.id)}notifyObjectBBChanged(e,t){this._octree==null||this._objectsAdded.includes(e)||this._octree.update(e,t)}getSpatialQueryAccelerator(){return this._octree==null&&this._objects.size>50?(this._octree=new P4(e=>e.boundingVolumeWorldSpace.bounds),this._octree.add(this._objects.values())):this._octree!=null&&this._objectsAdded.length>0&&(this._octree.add(this._objectsAdded),this._objectsAdded.length=0),this._octree}invalidateSpatialQueryAccelerator(){this._octree=Q(this._octree),this._objectsAdded.length=0}get test(){}},PS=class{constructor(e,t){this.labelingContext=e,this.graphics3DGraphic=t,this.hasGraphics3DResources=!1,this.visible=!1,this.textureAtlasHandles=[],this.textInitialized=!1,this.textRenderers=new Array,this.textLabelPlacements=new Array}},G6=class{constructor(e,t,i,r,n){this.labelClass=e,this.graphics3DSymbol=t,this.graphics3DCalloutSymbolLayer=i,this.textRenderParameters=r,this.labelFunction=n,this.calloutSymbolLayerIndex=0,this.graphics=new Map,this.scaleVisibility=null}},j6=class{constructor(e,t,i,r,n,a,o,l){this.layer=t,this.graphics3DCore=i,this.scaleVisibility=r,this.emptySymbolLabelSupported=n,this.elevationInfoOverride=a,this.disablePlacement=o,this.active=l,this.labelClassAbortController=new AbortController,this._labelClassContexts=new Array,this.graphics=new Map,this.labelsToInitialize=new Map,this.stageLayer=new QD(e,{pickable:!0},i.owner.layerViewUid)}destroy(){this.stageLayer.destroy()}get labelClassContexts(){return this._labelClassContexts}setLabelClassContext(e,t){this._labelClassContexts[e]=t}resetLabelClassContext(){this._labelClassContexts.length=0}},xl=class extends te{constructor(e){super(e),this._hudMaterials=new Map,this._calloutMaterials=new Map,this._dirty=!1,this._focusAreasLabelsQueue=new D0,this._labels=new Map,this._labelingContexts=new Array}setup(){this.dispose(),this.addHandles([$(()=>this.view.state?.camera,()=>this.setDirty()),$(()=>this.view.state?.rasterPixelRatio,()=>this._resetAllLabels()),$(()=>this.view.focusAreasView?.polygons,()=>this._updateFocus()),this.view.resourceController.scheduler.registerTask(di.LABELER,this)]),$f()&&this.addHandles($(()=>this.view.scale,()=>this._updateScaleVisibility())),this._textTextureAtlas=new Rh({view:this.view})}dispose(){this.removeAllHandles(),this._textTextureAtlas=_e(this._textTextureAtlas),this._hudMaterials.clear(),this._calloutMaterials.clear(),this._labelingContexts.length=0,this._labels.clear()}destroy(){this.dispose(),Yr.graphic=null,Yr.renderingInfo=null,Yr.layer=null}_updateFocus(){this._focusAreasLabelsQueue.clear(),this._labelingContexts.forEach(e=>{e.graphics.forEach(t=>{this._focusAreasLabelsQueue.push({graphic3DGraphic:t,labelingContext:e})})})}_activateLabelingContext(e){e.graphics.forEach((t,i)=>{const r=new PS(e,t);this._labels.set(i,r),e.labelsToInitialize.set(i,r),t.setVisibilityFlag(16,1,!0)}),e.active=!0}_deactivateLabelingContext(e){e.graphics.forEach((t,i)=>{t.setVisibilityFlag(16,1,!1),this.setLabelGraphicVisibility(t,!1),t.clearLabelGraphics(),this._labels.delete(i)}),e.active=!1}_addLabelTextureToAtlas(e){if(this._textTextureAtlas)for(const t of e.graphics3DGraphic.labelLayers){if(!t.labelClass)continue;const i=e.textRenderers[t.labelClassContextIndex];i&&(e.textureAtlasHandles.push(this._textTextureAtlas.addText(i,r=>Q6(t.stageObject,r))),W6(t.stageObject,i))}}_removeLabelTextureFromAtlas(e){e.textureAtlasHandles.forEach(t=>t.remove()),e.textureAtlasHandles.length=0}get readyToRun(){return this.view.ready&&(this._dirty||this.deconflictor.readyToRun||this._focusAreasLabelsQueue.length>0)}runTask(e){return this._updateLabels(e),this._applyFocusAreasUpdates(e),!this._dirty&&this.deconflictor.readyToRun&&this.deconflictor.runTask(e),Ai}_updateLabels(e){if(this._dirty){this._dirty=!1;for(const t of this._labelingContexts)if(t.active){if(jm(t))this._dirty=!0;else if(dv(t.labelClassContexts)){if(t.labelClassContexts===null){this._deactivateLabelingContext(t);continue}this._createLabelClassContext(t),this._dirty=!0}else for(const[i,r]of t.labelsToInitialize)if(this._ensureGraphics3DResources(r)&&(this._labels.set(i,r),this.deconflictor.setDirty(),e.madeProgress()),(r.visible&&r.textInitialized||!r.visible&&r.hasGraphics3DResources)&&(t.labelsToInitialize.delete(i),e.madeProgress()),e.done){this._dirty=!0;break}}this._dirty||this.notifyChange("updating")}}_applyFocusAreasUpdates(e){for(;this._focusAreasLabelsQueue.length>0&&!e.done;){e.madeProgress();const{graphic3DGraphic:t,labelingContext:i}=this._focusAreasLabelsQueue.pop();if(t.labelLayers.length===0||!i.active)continue;const r=p6(t.graphic.geometry);if(r==null)continue;const n=this.view.focusAreasView?.containsGeometry(r)??!0;t.labelLayers.forEach(a=>{a.stageObject.geometries.some(o=>o.material.parameters.isFocused!==n)&&(this._removeGraphic(i,t),this._addGraphic(i,t),this.setDirty())})}this._focusAreasLabelsQueue.length===0&&(this.notifyChange("readyToRun"),this.notifyChange("updating"))}async _createLabelClassContextAsync(e){const t=e.labelClassAbortController?.signal;e.layer.when&&await e.layer.when(),He(t),e.scaleVisibility?.updateScaleRangeActive();const i=e.graphics3DCore,r=i.layer,n=r.labelingInfo?.filter(a=>!!a.symbol);!n||n.length===0||(await Fw(n,async(a,o)=>{const l=a.symbol,c=Ab(i.getOrCreateGraphics3DSymbol(l));if(c==null)return void j.getLogger(this).error("Failed to create Graphics3DSymbol for label");await c.load(),He(t);let h=null;fR(l)&&l.hasVisibleCallout()&&(h=P6(l,i.symbolCreationContext),await h.load(),He(t));const d=await Vg(KV(a,e.layer.fieldsIndex,this.view.spatialReference));if(He(t),d.ok===!0){const m=await this._createTextRenderParameters(c.symbol);He(t);const f=new G6(a,c,h,m,d.value);this._updateLabelClassContextVisibility(f),e.setLabelClassContext(o,f)}else j.getLogger(this).error(`Label expression failed to evaluate: ${d.error}`)}),He(t))}async _createLabelClassContext(e){return e.labelClassPromise==null&&(e.labelClassPromise=this._createLabelClassContextAsync(e).catch(t=>{if(zr(t))throw t;e.resetLabelClassContext()}).then(()=>{e.labelClassAbortController=null,this.notifyChange("updating")}).catch(()=>{}),this.notifyChange("updating")),e.labelClassPromise}async _createTextRenderParameters(e){const t=e.symbolLayers.at(0);return t?.type!=="text"?null:z6.fromSymbol(t,this.view.state.rasterPixelRatio)}_destroyLabelClassContext(e){for(const i of e.labelClassContexts)i&&--i.graphics3DSymbol.referenced;const t=e.labelClassAbortController;e.labelClassAbortController=new AbortController,Os(t),e.resetLabelClassContext(),e.labelClassPromise=null,this.notifyChange("updating")}_createTextSymbolGraphic(e,t,i,r,n,a){if(!this._textTextureAtlas)return null;const o=new V6(i,tC(i.anchor),o5(i.anchor),e.text,_u(e.displayWidth,e.displayHeight));return Yr.graphic=t,Yr.layer=r,Yr.renderingInfo=null,n.createLabel(Yr,o,this._hudMaterials,this._textTextureAtlas,()=>a.placement?.elevationOffset??null)}_createLineCalloutGraphic(e,t,i,r,n){Yr.graphic=e,Yr.layer=n;const a=r.screenOffset[0];return Yr.renderingInfo=new T6(null,t,r.translation,r.centerOffset,a,r.centerOffsetUnits,r.elevationOffset),i.createGraphics3DGraphic(Yr,this._calloutMaterials)}_ensureGraphics3DResources(e){if(e.hasGraphics3DResources)return!1;const t=e.graphics3DGraphic;if(t.destroyed)return!1;this._ensureTextTextureResources(e);const i=e.labelingContext,r=i.labelClassContexts;if(dv(r)||!i.emptySymbolLabelSupported&&t.layers.length===0)return!1;let n=!1;const a=t.graphic,o=i.layer,l=Wm(i.layer);for(let c=0;c<r.length;c++){const h=e.textRenderers[c],d=e.textLabelPlacements[c],m=r[c];if(h==null||d==null||m==null)continue;const f=m.graphics3DSymbol,g=Z6(f),_=f.symbolLayers[0];if(!_)continue;_.setElevationInfoOverride(i.elevationInfoOverride);const v=new bS(t,g,m.labelClass),b=this._createTextSymbolGraphic(h,a,d,o,_,v);if(b==null)return!1;b.labelClass=m.labelClass,b.labelClassContextIndex=c,t.addLabelGraphic(b,i.stageLayer),this.deconflictor.setPriority(t,m.textRenderParameters?.definition.size??0),t.setVisibilityFlag(16,1,l),t.setVisibilityFlag(16,2,m.scaleVisibility??!0),t.setVisibilityFlag(16,8,!1),$f()&&m.graphics.set(a.uid,t),n=!0;const T=m.graphics3DCalloutSymbolLayer;if(T&&d.hasLabelVerticalOffset){T.setElevationInfoOverride(i.elevationInfoOverride);const w=this._createLineCalloutGraphic(a,g,T,d,o);w!=null&&(m.calloutSymbolLayerIndex=t.labelLayers.length,t.addLabelGraphic(w,i.stageLayer))}break}return n&&i.scaleVisibility?.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(e){const t=e.labelingContext.labelClassContexts;for(const i of e.graphics3DGraphic.labelLayers){if(i.labelClass==null)continue;t[i.labelClassContextIndex].graphics3DSymbol.symbolLayers[0]?.onRemoveGraphic(i)}e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}_ensureTextTextureResources(e){if(e.textInitialized)return;const t=e.labelingContext,i=t.labelClassContexts;if(dv(i))return;const r=e.graphics3DGraphic.graphic;for(let n=0;n<i.length;n++){const a=i[n];if(e.textRenderers[n]=null,e.textLabelPlacements[n]=null,a?.textRenderParameters==null)continue;const o=a.labelFunction;let l;if(o.type==="arcade")try{const b=o.needsHydrationToEvaluate()?l5(r,t.layer,null):r;l=o.evaluate(b)}catch{l=null}else l=o.evaluate(r);if(l==null||l===""||/^\s+$/.test(l))continue;const c=a.graphics3DSymbol;if(!c.symbolLayers[0])continue;const h=e.graphics3DGraphic,d=c.symbol?.type==="label-3d"?c.symbol:null,m=a.labelClass,f=t.disablePlacement,g=new bS(h,d,m,f).placement;if(g==null)continue;const _=tC(g.anchor),v=h5(_);e.textRenderers[n]=new c5(l,v,a.textRenderParameters,Rh.maxSize),e.textLabelPlacements[n]=g}e.textInitialized=!0}_destroyTextTextureResources(e){e.textInitialized=!1,e.textRenderers.length=0,e.textLabelPlacements.length=0}_addGraphic(e,t){const i=t.graphic.uid;if(e.graphics.set(i,t),e.active){const r=new PS(e,t);this._labels.set(i,r),e.labelsToInitialize.set(i,r)}this.setDirty(),this.deconflictor.setDirty()}_updateGraphicGeometry(e,t){const i=t.graphic.uid,r=this._labels.get(i);if(!r)return!0;for(const n of r.graphics3DGraphic.labelLayers)if(n.labelClass!=null&&!e.labelClassContexts[n.labelClassContextIndex].graphics3DSymbol.symbolLayers[0].updateGeometry(t.graphic,n))return!1;return this.setDirty(),this.deconflictor.setDirty(),!0}_removeGraphic(e,t){const i=t.graphic.uid,r=this._labels.get(i);e.graphics.delete(i),e.labelClassContexts.forEach(n=>n?.graphics.delete(i)),r&&(this._destroyGraphic(r,i),e.labelsToInitialize.delete(i),this.setDirty(),this.deconflictor.setDirty())}_destroyGraphic(e,t){this._labels.delete(t),e.textureAtlasHandles.length&&this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)}async _labelingInfoChange(e,t){if(!t)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const i of t){const r=e.graphics.get(i);r&&(this._removeGraphic(e,r),this._addGraphic(e,r))}}_globalPropertyChanged(e,t){for(const i of t.labelClassContexts){if(!i)continue;const r=new Map;t.graphics.forEach(a=>r.set(a.graphic.uid,a));const n=a=>a.labelLayers[0];if(i.graphics3DSymbol.symbolLayers[0].globalPropertyChanged(e,r,n),i.graphics3DCalloutSymbolLayer){const a=o=>o.labelLayers[i.calloutSymbolLayerIndex];i.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,r,a)}}}_visibilityInfoChange(e){const t=Wm(e.layer);t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty()}_resetAllLabels(){for(const e of this._labelingContexts)this._resetLabels(e)}_resetLabels(e){e.graphics.forEach((t,i)=>{const r=this._labels.get(i);r&&(this._destroyGraphic(r,i),r.visible=!1,e.labelsToInitialize.set(i,r))}),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}_findLabelingContext(e){for(const t of this._labelingContexts)if(t.graphics3DCore===e)return t;return null}addGraphicsOwner(e,t,i){const r=i?.emptySymbolLabelSupported||!1,n=i?.elevationInfoOverride||null,a=i?.disablePlacement||null;if(this._findLabelingContext(e))return;const o=e.layer,l=new j6(this.view.stage,o,e,t,r,n,a,Wm(o));return this._labelingContexts.push(l),this.setDirty(),{addGraphic:c=>this._addGraphic(l,c),removeGraphic:c=>this._removeGraphic(l,c),updateGraphicGeometry:c=>this._updateGraphicGeometry(l,c),layerLabelsEnabled:()=>Wm(l.layer),labelingInfoChange:c=>this._labelingInfoChange(l,c),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",l),screenSizePerspectiveEnabledChanged:()=>this._globalPropertyChanged("screenSizePerspectiveEnabled",l),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",l),visibilityInfoChange:()=>this._visibilityInfoChange(l),reset:()=>this._resetLabels(l),remove:()=>this._removeGraphicsOwner(e),setDirty:()=>this.setDirty()}}_removeGraphicsOwner(e){const t=this._findLabelingContext(e);if(!t)return;const i=this._labelingContexts.indexOf(t);this._labelingContexts.splice(i,1),t.graphics.forEach(r=>this._removeGraphic(t,r)),t.destroy(),this.setDirty()}_updateScaleVisibility(){for(const e of this._labelingContexts)if(e.active&&!jm(e))for(const t of e.labelClassContexts)this._updateLabelClassContextVisibility(t)}_updateLabelClassContextVisibility(e){if(!e||!$f())return;const{labelClass:t,graphics:i}=e,r={minScale:t.minScale,maxScale:t.maxScale},n=c4(r,this.view.scale),a=e.scaleVisibility==null||e.scaleVisibility!==n;e.scaleVisibility=n,a&&i.size&&(i.forEach(o=>o.setVisibilityFlag(16,2,n)),this.deconflictor.setDirty(),this.setDirty())}setLabelGraphicVisibility(e,t){const i=e.graphic.uid,r=this._labels.get(i);r&&r.visible!==t&&(t&&!r.textureAtlasHandles.length?(this._addLabelTextureToAtlas(r),r.textInitialized||r.labelingContext.labelsToInitialize.set(i,r)):!t&&r.textureAtlasHandles.length&&this._removeLabelTextureFromAtlas(r),r.visible=t,this.setDirty())}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._dirty||this._textTextureAtlas?.updating||this.deconflictor.updating||this._labelingContexts.some(e=>jm(e))||this._focusAreasLabelsQueue.length>0}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce((t,i)=>t+(jm(i)?0:1),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}get usedMemory(){return this._textTextureAtlas?.usedMemory??0}get test(){}};function W6(s,e){s.geometries[0].setAttributeData("size",[e.displayWidth,e.displayHeight]),s.geometryVertexAttributeUpdated(s.geometries[0],"size")}function Q6(s,e){s.geometries[0].setAttributeData("uvi",e),s.geometryVertexAttributeUpdated(s.geometries[0],"uvi",!0)}function jm(s){return!!s.labelClassPromise&&!!s.labelClassAbortController}function dv(s){return(s?.length??0)===0}function Z6(s){return s.symbol?.type==="label-3d"?s.symbol:null}function Wm(s){return!!s.labelsVisible&&!!s.labelingInfo?.some(e=>!!e.symbol)}u([p({constructOnly:!0})],xl.prototype,"view",void 0),u([p({constructOnly:!0})],xl.prototype,"deconflictor",void 0),u([p()],xl.prototype,"_textTextureAtlas",void 0),u([p({type:Boolean,readOnly:!0})],xl.prototype,"updating",null),xl=u([R("esri.views.3d.layers.graphics.Labeler")],xl);const Yr=new S6(null,null,null);let X6=class{constructor(e){this._layerView=e,this._lodGlobalDirty=!1}destroy(){this._index=null,this._lodGlobalHandling=null,this._removeNodes=null}startNodeLoading(e,t,i){this._maxLodLevel=i.maxLodLevel,this._index=t,this._removeNodes=e}shouldLoadNode(e){if(e==null)return!1;const t=this._index.nodeTraversalState(e);return!!this._isChosenMaxLOD(t)||!!t.isChosen&&this._childrenRequireLoading(e)}setLodGlobalDirty(){this._lodGlobalDirty=!0}get requiresLODGlobalHandling(){return this._index!=null&&this._lodGlobalDirty===!0}lodGlobalHandling(e){if(!this.requiresLODGlobalHandling)return!1;this._lodGlobalDirty=!1;const t=this._layerView.view.resourceController.memoryController.usedMemory,i=Math.max(0,Math.floor(10*(t-1)));On.clear(),this._lodGlobalHandling(this._index.rootNode,i,!1,!!this._layerView.nodeCrossfadingEnabled);const r=On.length;this._removeNodes(On,e);const n=On.length<r;return On.length!==0&&(this._lodGlobalDirty=!0),On.clear(),n}_lodGlobalHandling(e,t,i,r){if(e==null)return!1;const n=e.index,a=this._index,o=this._layerView,l=a.nodeTraversalState(e),c=this._isChosenMaxLOD(l),h=e.resources.isEmpty;if(c&&h)return e.childrenLoaded>0&&this._removeChildrenRecursive(e),!0;const d=o.isNodeLoaded(n);if(r&&d&&c){const b=!i&&this.hasNoVisibleChildren(e);o.fadeNode(n,0,!b)}const m=d&&(!o.isNodeFullyFadedIn||o.isNodeFullyFadedIn(n));if(d&&(o.updateNodeState(n,c?1:0),c))return m&&this._removeChildrenRecursive(e),m;const f=e.childCount>0;let g=f;if(f)for(let b=0;b<e.childCount;b++){const T=a.getChildIndex(n,b),w=a.getNode(T);w!=null?!a.isGeometryVisible(T)||this._lodGlobalHandling(w,t,i||m,r)||(g=!1):a.isNodeVisible(T)&&(g=!1)}const _=d&&!c&&(g||On.length<t);_&&On.push(n),!r||_||!d||i||g||o.fadeNode(n,0,!1);const v=e.resources.isEmpty;return g||m&&!_||v}_removeChildrenRecursive(e){this._index.traverseDescendants(e,t=>((this._layerView.isNodeLoaded(t.index)||this._layerView.isNodeReloading(t.index))&&On.push(t.index),t.childrenLoaded>0))}hasNoVisibleChildren(e){let t=!0;return this._index.traverseDescendants(e,i=>!(!t||!this._index.isNodeVisible(i.index))&&(this._layerView.isNodeLoaded(i.index)?(t=!1,!1):i.childrenLoaded>0)),t}_childrenRequireLoading(e){let t=!1,i=!0;return this._index.traverseDescendants(e,r=>{if(!i||!this._index.isNodeVisible(r.index))return!1;const n=this._index.nodeTraversalState(r);return this._isChosenMaxLOD(n)&&this._index.isGeometryVisible(r.index)&&(t=!0),this._layerView.isNodeLoaded(r.index)?(i=!1,!1):r.childrenLoaded>0}),i&&t}_isChosenMaxLOD(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)}static cleanupI3SLodHandling(){On.prune()}};const On=new zt({deallocator:null});let ZD=class{constructor(e="scene"){this.context=e,this.extent=Fo(),this.spatialReference=null}};const Y6=1,MS=Symbol("layerHandles");let Ec=class extends fu{get spatialReference(){return this.view.spatialReference}constructor(e){super(e),this._elevationOffset=0}initialize(){this._renderCoordsHelper=this.view.renderCoordsHelper,this._intersectLayers=[this.stageLayer],this._intersector=new Ur(this.view.state.viewingMode),this._intersector.options.store=0;const e=this._computeLayerExtent(this.spatialReference,this.stageLayer);this._zmin=e[2],this._zmax=e[5];const t=this.stageLayer.events;this.addHandles([t.on(["layerObjectAdded","layerObjectRemoved","transformationChanged","shaderTransformationChanged"],i=>this._objectChanged(i)),t.on(["geometryAdded","geometryRemoved"],({object:i})=>this._objectChanged(i)),t.on("attributesChanged",({attribute:i,object:r})=>kD(i)&&this._objectChanged(r))],MS)}destroy(){this.removeHandles(MS)}elevationInfoChanged(){const e=this.layer!=null?this.layer.elevationInfo:null;if(e!=null&&e.mode!=="on-the-ground"){const t=w$(this.layer.spatialReference),i=gR(e.unit??"meters");this._elevationOffset=(e.offset??0)*i/t}else this._elevationOffset=0}getElevation(e,t,i,r){if(ds[0]=e,ds[1]=t,ds[2]=i,!this._renderCoordsHelper.toRenderCoords(ds,r,ds))return j.getLogger(this).error("could not project point for elevation alignment"),null;const n=this._elevationOffset,a=this._zmin+n,o=this._zmax+n;this._renderCoordsHelper.setAltitude($S,o,ds),this._renderCoordsHelper.setAltitude(RS,a,ds);const l=c=>!!c.lastValidElevationBB;return this._intersector.reset($S,RS,null),this._intersector.intersect(this._intersectLayers,null,Y6,null,l),this._intersector.results.min.getIntersectionPoint(ds)?this._renderCoordsHelper.getAltitude(ds):null}_objectChanged(e){const t=this.spatialReference;if(!e.lastValidElevationBB||!t)return;Hr(da);const i=e.lastValidElevationBB;i.isEmpty()||this._expandExtent(t,i.min,i.max,da);const{min:r,max:n}=e.boundingVolumeWorldSpace;this._expandExtent(t,r,n,da),Yw(da,vd.extent),this._zmin=Math.min(this._zmin,da[2]),this._zmax=Math.max(this._zmax,da[5]),vd.spatialReference=t,this.emit("elevation-change",vd),vd.spatialReference=null,i.assignMinMax(r,n)}_computeLayerExtent(e,t){return Hr(da),e!=null&&t.objects.forEach(i=>this._expandExtent(e,i.boundingVolumeWorldSpace.min,i.boundingVolumeWorldSpace.max,da)),da}_expandExtent(e,t,i,r){for(let n=0;n<8;++n)ds[0]=1&n?t[0]:i[0],ds[1]=2&n?t[1]:i[1],ds[2]=4&n?t[2]:i[2],this._renderCoordsHelper.fromRenderCoords(ds,ds,e),zg(r,ds);return r}};u([p({constructOnly:!0})],Ec.prototype,"layer",void 0),u([p({constructOnly:!0})],Ec.prototype,"stageLayer",void 0),u([p({constructOnly:!0})],Ec.prototype,"view",void 0),u([p()],Ec.prototype,"spatialReference",null),Ec=u([R("esri.views.3d.layers.support.StageLayerElevationProvider")],Ec);const da=Hr(),vd=new ZD;function K6(){vd.spatialReference=null}const ds=x(),$S=x(),RS=x();let bd=class extends te{get parameters(){return this._parameters}get labelParameters(){return this._labelParameters}get _calculations(){return this.view.state.isGlobal?new eG(this.view.renderCoordsHelper?.referenceEllipsoid.radius??0):new J6}constructor(e){super(e),this._parameters=new kx,this._labelParameters=new kx}initialize(){this.addHandles([$(()=>({distance:this.view.pointsOfInterest?.centerOnSurfaceInfrequent?.distance??0,fovY:this.view.state.camera.fovY}),e=>this._update(e),Ve)])}_update(e){const t=this._updateParameters(this._parameters,Jf,e),i=this._updateParameters(this._labelParameters,iG,e);return t||i}_updateParameters(e,t,i){if(e&&e.camera.fovY===i.fovY&&e.camera.distance===i.distance)return!1;const{scaleStart:r,scaleFallOffRange:n}=t,{fovY:a,distance:o}=i;this._calculations.calculateCurvatureDependentParameters(pv,t,i);const l=this._calculations.surfaceCoverageCompensation(i,pv),{tiltAngle:c,scaleFallOffFactor:h}=pv,d=Math.sin(c)*o,m=.5*Math.PI-c-a*(.5-r*l),f=d/Math.cos(m),g=m+a*n*l,_=(f-h*(d/Math.cos(g)))/(1-h);return e.camera.fovY=i.fovY,e.camera.distance=i.distance,e.offset=_,e.divisor=f-_,e.minPixelSize=t.minPixelSize,!0}};u([p({constructOnly:!0})],bd.prototype,"view",void 0),u([p()],bd.prototype,"_calculations",null),bd=u([R("esri.views.3d.state.ScreenSizePerspective")],bd);let J6=class{surfaceCoverageCompensation(e,t){return u5(t.tiltAngle,e.fovY)}calculateCurvatureDependentParameters(e,t){e.tiltAngle=t.curvatureDependent.min.tiltAngle,e.scaleFallOffFactor=t.curvatureDependent.min.scaleFallOffFactor}},eG=class{constructor(e){this._ellipsoidRadius=e}surfaceCoverageCompensation(e,t){return A_(OS,this._ellipsoidRadius),yV(OS,t.tiltAngle,e.distance,e.fovY)}calculateCurvatureDependentParameters(e,t,i){const r=t.curvatureDependent,n=1+i.distance/this._ellipsoidRadius,a=Math.sqrt(n*n-1),[o,l]=[r.min.curvature,r.max.curvature],c=U((a-o)/(l-o),0,1),[h,d]=[r.min,r.max];e.tiltAngle=Me(h.tiltAngle,d.tiltAngle,c),e.scaleFallOffFactor=Me(h.scaleFallOffFactor,d.scaleFallOffFactor,c)}},tG=class{constructor(){this.tiltAngle=0,this.scaleFallOffFactor=0}};const Jf={curvatureDependent:{min:{curvature:rt(10),tiltAngle:rt(12),scaleFallOffFactor:.5},max:{curvature:rt(70),tiltAngle:rt(40),scaleFallOffFactor:.8}},scaleStart:.3,scaleFallOffRange:.65,minPixelSize:0},iG={...Jf,curvatureDependent:{min:{...Jf.curvatureDependent.min,scaleFallOffFactor:.7},max:{...Jf.curvatureDependent.max,scaleFallOffFactor:.95}},minPixelSize:14},pv=new tG,OS=Xs();let Rt=class extends te{constructor(e){super(e),this._propertiesPool=new ja({camera:()=>new vt},this),this._lastSeenCameraProjectionValues=new vt,this.mode=0,this._cssCamera=new vt,this._camera=new vt,this.rasterPixelRatio=1,this.contentPixelRatio=1,this.constraints=new va({state:this}),this.events=new cc,this.fading=!1,this._cameraChanged=!1,this._updateQueue=new Array,this._processingUpdates=!1}reset(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new ja({camera:()=>new vt},this)}destroy(){this.cameraController=Q(this.cameraController),this._propertiesPool=Q(this._propertiesPool)}createInitialCamera(){if(this.viewingMode===1){const e=Zt(this.spatialReference).radius;this.camera=new vt({eye:Qe(4*e,0,0),center:Qe(e,0,0),up:Qe(0,0,1)})}else this.camera=new vt({eye:Qe(0,0,100),center:Qe(0,0,0),up:Qe(0,1,0)})}get animation(){return this.cameraController instanceof Sp&&this.cameraController.viewAnimation!=null?this.cameraController.viewAnimation:null}get cssCamera(){const e=this._cssCamera.copyFrom(this.camera),{height:t,width:i,pixelRatio:r}=this.camera;return e.pixelRatio=1,e.height=Math.round(t/r),e.width=Math.round(i/r),e}get camera(){return this._camera}set camera(e){e!==tr&&tr.copyFrom(e),tr.computeUp(this.viewingMode),this.events.emit("before-camera-change",{camera:tr});const t=this._camera;if(sG(this._lastSeenCameraProjectionValues,tr)&&(this._lastSeenCameraProjectionValues.copyFrom(tr),this.events.emit("camera-projection-changed",this._lastSeenCameraProjectionValues)),!t.equals(tr)&&(this._camera=this._propertiesPool.get("camera").copyFrom(tr),this._cameraChanged=!t.almostEquals(tr),this._cameraChanged)){const i=LM(()=>{this._cameraChanged=!1,i.remove()})}}get pixelRatio(){return this.camera.pixelRatio}get alignPixelEnabled(){return this.pixelRatio===this.rasterPixelRatio&&this.mode===2}get updating(){return this.mode!==2}get contentCamera(){return this._contentCamera??this.camera}set contentCamera(e){if(e==null)return void(this._contentCamera=null);const t=e.clone();this.events.emit("before-camera-change",{camera:t,sceneDepthRange:ss.Infinite}),this._contentCamera=t}get fixedContentCamera(){return this._contentCamera!=null}get isGlobal(){return this.viewingMode===1}get isLocal(){return this.viewingMode===2}get viewingMode(){return H0(this.view.viewingMode)}get spatialReference(){return this.view.spatialReference}get highlights(){const e=this.view.highlights.items.slice(0,jk);for(let t=0;t<e.length;){const i=e[t],r=e.findIndex(n=>n.name===i.name);r>=0&&t>r?e.splice(t,1):++t}return e}get highlightOrderMap(){const e=new Map;return this.highlights.forEach((t,i)=>e.set(t.name,i)),e}get navigating(){return!!this.cameraController?.isInteractive}get stationary(){return!this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(e){this.stopActiveCameraController()?(this.removeHandles(ES),this.cameraController?.destroy(),e&&(this.addHandles(Zs(()=>e.state===4||e.state===3,()=>{this.updateCamera(t=>e.onControllerEnd(t)),this.cameraController===e&&(this._set("cameraController",null),e.destroy())},{sync:!0,once:!0}),ES),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=1)}switchCameraController(e){this.cameraController=e}stopActiveCameraController(){return!this.cameraController||this.cameraController.stopController()}updateCamera(e){this._updateQueue.push(e),this._processUpdateQueue()}_processUpdateQueue(){if(this._updateQueue.length===0||this._processingUpdates)return;this._processingUpdates=!0;const e=this._updateQueue.shift();tr.copyFrom(this.camera),e(tr),this.camera=tr,this._processingUpdates=!1,this._processUpdateQueue()}static cleanupViewstate(){tr=new vt}};u([p({constructOnly:!0})],Rt.prototype,"view",void 0),u([p()],Rt.prototype,"mode",void 0),u([p({readOnly:!0,type:ru})],Rt.prototype,"animation",null),u([p({type:vt})],Rt.prototype,"cssCamera",null),u([p()],Rt.prototype,"_cssCamera",void 0),u([p({type:vt})],Rt.prototype,"camera",null),u([p()],Rt.prototype,"_camera",void 0),u([p({readOnly:!0})],Rt.prototype,"pixelRatio",null),u([p()],Rt.prototype,"rasterPixelRatio",void 0),u([p()],Rt.prototype,"contentPixelRatio",void 0),u([p({readOnly:!0})],Rt.prototype,"alignPixelEnabled",null),u([p({readOnly:!0})],Rt.prototype,"updating",null),u([p({})],Rt.prototype,"_contentCamera",void 0),u([p({type:vt})],Rt.prototype,"contentCamera",null),u([p({readOnly:!0})],Rt.prototype,"fixedContentCamera",null),u([p({readOnly:!0})],Rt.prototype,"events",void 0),u([p({readOnly:!0})],Rt.prototype,"isGlobal",null),u([p({readOnly:!0})],Rt.prototype,"isLocal",null),u([p({readOnly:!0})],Rt.prototype,"viewingMode",null),u([p({readOnly:!0})],Rt.prototype,"highlights",null),u([p({readOnly:!0})],Rt.prototype,"highlightOrderMap",null),u([p({readOnly:!0})],Rt.prototype,"navigating",null),u([p()],Rt.prototype,"fading",void 0),u([p({readOnly:!0})],Rt.prototype,"stationary",null),u([p()],Rt.prototype,"_cameraChanged",void 0),u([p()],Rt.prototype,"cameraController",null),Rt=u([R("esri.views.3d.state.ViewState")],Rt);const DS=Rt;function sG(s,e){return s.fov!==e.fov||s.fullViewport[0]!==e.fullViewport[0]||s.fullViewport[1]!==e.fullViewport[1]||s.fullViewport[2]!==e.fullViewport[2]||s.fullViewport[3]!==e.fullViewport[3]||s.padding[0]!==e.padding[0]||s.padding[1]!==e.padding[1]||s.padding[2]!==e.padding[2]||s.padding[3]!==e.padding[3]}let tr=new vt;const ES="ViewStateHandles",rG="OBJECTID";async function nG(s,e,t,i){const r=t?KD(s,t):i,n=ii(e.x,e.y);r.requiresGroundFeedback=!0,r.enableDraped=!0;const a=new Ur(s.state.viewingMode);a.options.selectionMode=!0,a.options.store=2,s.sceneIntersectionHelper.intersectIntersectorScreen(n,a,r);const o=await oG(s,a.results.all,r.graphics),l=a.results.ground,c=TR(l,s),h=c!=null&&"type"in c&&Xh(c)?c:null,d={screenPoint:e,results:o,ground:{mapPoint:Oh(s,l),distance:wR(l)?l.distanceInRenderSpace:0,layer:h}};return yi.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(d.intersector=a),d}function aG(s,e,t,i){const r=t?KD(s,t):i,n=!(!r.graphics?.include&&!r.graphics?.exclude),a=!(!r.mediaElements?.include&&!r.mediaElements?.exclude),o=mn(e);r.enableDraped=r.include&&!r.include.has(Ao)||r.exclude?.has(Ao);const l=s.sceneIntersectionHelper,c=new Ur(s.state.viewingMode);if(c.options.selectionMode=!0,c.options.store=n||a?2:0,c.options.excludeLabels=t?.excludeLabels??!1,l.intersectIntersectorScreen(o,c,r),n||a){for(const h of c.results.all){const d=CR(h,s);if(d==null||n&&(d.type!=="graphic"||XD(r.graphics,d.graphic))||a&&(d.type!=="media"||YD(r.mediaElements,d.element)))return Oh(s,h)}return null}return Oh(s,c.results.min)}async function oG(s,e,t){const i=new Array;let r,n=null;const a={defer(o){r=o()}};for(let o=0;o<e.length;o++){const l=e[o],c=TR(l,s);if(c!=null&&(c===s.map.ground||"type"in c&&Xh(c)))break;const h=CR(l,s,a)??await r;if(r=null,h==null)continue;if(h.type==="graphic"){if(n==null&&o!==e.length-1&&(n=new Set),n!=null){const f=A1(h.graphic);if(n.has(f))continue;n.add(f)}if(!XD(t,h.graphic))continue}const d=Oh(s,l),m=l.distanceInRenderSpace;if(h.type==="media"){const f=h.element.toSource(d);i.push({...h,mapPoint:d,distance:m,sourcePoint:f})}else i.push({...h,mapPoint:d,distance:m})}return i}function Oh(s,e,t){return e.getIntersectionPoint(Dh)?(t=Ib(s,Dh,t),e.intersector===7&&s.basemapTerrain&&(t.z=Yn(s.basemapTerrain,t)??0),t):null}function A1(s){const e=s.getObjectId()??s.attributes?.[rG];return s.origin&&e!=null?`o-${s.origin.id}-${e}`:`u-${s.uid}`}function XD(s,e){return YD(s,A1(e))}function YD(s,e){return s==null||(s.include==null||s.include.has(e))&&(s.exclude==null||!s.exclude.has(e))}function Ib(s,e,t){let i=s.spatialReference||Dt.WGS84;return zo(e,s.renderSpatialReference,Dh,i)?e=Dh:(i=Dt.WGS84,zo(e,s.renderSpatialReference,Dh,i)&&(e=Dh)),t?(t.x=e[0],t.y=e[1],t.z=e[2],t.spatialReference=i):t=new wt(e,i),t}function KD(s,e){const t=Lb(s,e.include,0),i=Lb(s,e.exclude,1);return{include:t.layerViewUids,exclude:i.layerViewUids,graphics:{include:t.graphicUids,exclude:i.graphicUids},mediaElements:{include:t.mediaElements,exclude:i.mediaElements}}}function Lb(s,e,t,i=new lG){if(!e)return i;if(e instanceof Zw)hG(i,A1(e)),t===0&&(s.graphicsView!=null&&e.layer===s?eg(i,s.graphicsView.uid):e.layer&&mv(i,s,e.layer.uid));else if("layer"in e&&"element"in e)uG(i,e.element),t===0&&mv(i,s,e.layer.uid);else if(pI(e))for(const r of e)r===s.graphics&&s.graphicsView!=null?eg(i,s.graphicsView.uid):r===s.map.ground?eg(i,Ao):Lb(s,r,t,i);else"layer"in e&&cG(i,s,e),"uid"in e&&mv(i,s,e.uid);return i}let lG=class{constructor(){this.layerViewUids=null,this.graphicUids=null,this.mediaElements=null}};function mv(s,e,t){const i=e.allLayerViews.find(r=>r.layer.uid===t);i&&eg(s,i.uid)}function eg(s,e){s.layerViewUids??=new Map,s.layerViewUids.set(e,!0)}function cG(s,e,t){const i=e.allLayerViews.find(n=>n.layer.uid===t.layer.uid);if(!i)return;s.layerViewUids??=new Map;const r=s.layerViewUids.get(i.uid);r!==!0&&(r?r.add(t.id):s.layerViewUids.set(i.uid,new Set([t.id])))}function hG(s,e){s.graphicUids??=new Set,s.graphicUids.add(e)}function uG(s,e){s.mediaElements??=new Set,s.mediaElements.add(e)}const Dh=x();function AS(s){return(e,t,i)=>!z$(s,kt(dG,e,t,i))}const dG=x();let pG=class{constructor(e,t,i){this.viewingMode=e,this._forEachLayer=t,this._view=i,this._externalIntersectionHandlers=new zt,this._tolerance=Og,this._tmpRay=Go(),this._tmpRegion=Mt(),this._validateHUDIntersector=new Ur(this.viewingMode),this._validateHUDIntersector.options.hud=!1}destroy(){this._externalIntersectionHandlers.prune()}intersectScreen(e,t,i){return this.intersectRay(this._getPickRay(e,this._tmpRay),IS(this.viewingMode),t,i)}intersectScreenFreePointFallback(e,t,i){return this.intersectRayFreePointFallback(this._getPickRay(e,this._tmpRay),t,i)}intersectRayFreePointFallback(e,t,i){return this.intersectRay(e,IS(this.viewingMode),t,i)||this._intersectRayFreePointLocal(e,t)}intersectRay(e,t,i,r){return t.options.selectionMode=!1,t.options.store=0,this.computeIntersection(e,t,!1,r),!!t.results.min&&t.results.min.getIntersectionPoint(i)}getCenterRayWithSubpixelOffset(e,t,i=.5,r=.5){return e.getRenderCenter(Zm,i,r),Zm[0]+=.0466,Zm[1]-=.0123,b1(e,Zm,t)}intersectIntersectorScreen(e,t,i){this.computeIntersection(this._getPickRay(e,this._tmpRay),t,!1,i)}intersectToolIntersectorScreen(e,t,i){const r=this._getPickRay(e,this._tmpRay);this.intersectToolIntersectorRay(r,t,i)}intersectToolIntersectorRay(e,t,i){t.options.selectionMode=!0,this.computeIntersection(e,t,!1,i);const r=t.results.min;this._view.basemapTerrain&&this._view.basemapTerrain.opaque||wR(r)&&r.intersector!==7||(t.options.selectionMode=!1,this.computeIntersection(e,t,!1,i))}setTolerance(e=Og){this._tolerance=e}addIntersectionHandler(e){this._externalIntersectionHandlers.push(e),this._externalIntersectionHandlers.sort((t,i)=>t.type===7?1:i.type===7?-1:0)}removeIntersectionHandler(e){this._externalIntersectionHandlers.removeUnordered(e)!=null&&this._externalIntersectionHandlers.sort((t,i)=>t.type===7?1:i.type===7?-1:0)}_getPickRay(e,t){const i=this._view.state.camera;return v1(i,e,t)}_intersectRayFreePointLocal(e,t){return this.viewingMode!==2||e==null||ce(t,e.origin,pe(yt.get(),e.direction)),!1}intersectElevationFromScreen(e,t,i=0,r=null){return this._intersectElevation(this._getPickRay(e,this._tmpRay),t,i,r)}_intersectElevation(e,t,i=0,r=null){if(e==null)return null;const n=this._view,{renderCoordsHelper:a}=n,o=w$(n.spatialReference),l=t!=null?t.mode:"absolute-height",c=M4(t)/o,h=(l!=="on-the-ground"?c+i:0)*o/a.unitInMeters,{camera:d}=n.state;if(l==="absolute-height"){const S=a?.getAltitude(d.eye),C=We(pe(zu,e.direction),a.worldUpAtPosition(d.eye,gG));if(S<h&&C<0||S>=h&&C>0)return null;if(a.intersectInfiniteManifold(e,h,zu)){const P=Ib(n,zu);return P.z??=0,P.z-=c,P}return null}const m=d.projectToRenderScreen(e.origin,Zh(yt.get())),f=new LS(null,this._forEachLayer),g=n.slice.plane,_=g!=null?AS(g):null,v=new Ur(this.viewingMode);v.options.store=0,v.options.verticalOffset=h,v.options.normalRequired=!1;const b=e.origin,T=ce(yt.get(),b,e.direction);v.reset(b,T,d),v.point=m;let w=null;if(r&&"type"in r&&r.type==="graphics"){const S=n.allLayerViews.find(C=>C.layer===r)?.uid;w=S?C=>C.layerViewUid===S:null}else r&&(w=S=>S.graphicUid!==r.uid);switch(l){case"relative-to-scene":{const S=C=>(!w||w(C))&&!!C.lastValidElevationBB;v.intersect(f.layers,m,this._tolerance,null,S),this._externalIntersectionHandlers.forAll(C=>{if(C.type===2||C.type===7||C.type===8){const P=C.slicePlaneEnabled?_:null;C.intersect(v,P,v.rayBegin,v.rayEnd,m,!1)}});break}case"on-the-ground":case"relative-to-ground":this._externalIntersectionHandlers.forAll(S=>{if(S.isGround){const C=S.slicePlaneEnabled?_:null;S.intersect(v,C,v.rayBegin,v.rayEnd,m,!1)}})}if(v.results.min.getIntersectionPoint(zu)){const S=Ib(n,zu);return S.z=i,S}return null}computeIntersection(e,t,i,r){if(e==null)return;const n=this._view.state.camera,a=n.projectToRenderScreen(e.origin,Zh(yt.get())),o=new LS(r,this._forEachLayer);t.options.selectOpaqueTerrainOnly=!r||!("include"in r||"exclude"in r);const l=e.origin,c=ce(yt.get(),e.origin,e.direction);t.reset(l,c,n),t.intersect(o.layers,a,this._tolerance);const h=this._view.slice.plane,d=h!=null?AS(h):null;t.intersect(o.sliceableLayers,a,this._tolerance,d);const m=r&&(r.requiresGroundFeedback||r.enableDraped);this._externalIntersectionHandlers.forAll(v=>{const b=v.layerViewUid,T=v.sublayerId,w=Array.isArray(b),S=w?b:[b];w&&(t.options.filteredLayerViewUids=[]);let C=!1;for(const P of S)o.filterLayerViewUid(P,T)?C=!0:w&&t.options.filteredLayerViewUids.push(P);if(t.options.isFiltered=!C,v.isGround&&m||!t.options.isFiltered){const P=v.slicePlaneEnabled?d:null;v.intersect(t,P,l,c,a,i)}});const f=yt.get(),g=this._view,_=g.basemapTerrain;if(r&&r.enableDraped&&_.spatialReference!=null&&t.results.ground.getIntersectionPoint(f)){const v=g.overlayManager.renderer,b=g.renderCoordsHelper.spatialReference,T=yt.get();g.renderCoordsHelper.fromRenderCoords(f,T,_.spatialReference),T[2]=g.elevationProvider?.getElevation(f[0],f[1],f[2],b,"ground")??0,v.intersect(t,T,t.results.ground,w=>o.filterRenderGeometry(w))}t.sortResults(),this._processHUDResults(t)}_processHUDResults(e){const t=e.results.hud;Up(this._tmpRegion,QF);const i=this._view.state.camera,r=[],n=this._tmpRegion,a=b=>{const T=new fG(b),w=T.result.target.object.geometries.every(S=>S.material instanceof Iw&&S.material.parameters.occlusionTest);r.push({item:T,occlusionTest:w}),w&&(i.projectToRenderScreen(b.target.center,T.screenPoint),T.screenPoint[0]=Math.floor(T.screenPoint[0]),T.screenPoint[1]=Math.floor(T.screenPoint[1]),WF(n,T.screenPoint))};e.sortResults(t.all),t.min.distance!=null&&a(t.min);for(const b of t.all)t.min.target.object!==b.target.object&&t.max.target.object!==b.target.object&&a(b);if(t.max.distance!=null&&t.max.target.object!==t.min.target.object&&a(t.max),!r.length)return;n[0]===n[2]&&(n[2]+=1),n[1]===n[3]&&(n[3]+=1);const o=i.fullWidth,l=i.fullHeight,c=Math.max(0,n[0]-wd),h=Math.max(0,n[1]-wd),d=Math.min(hr(n)+2*wd,o-c),m=Math.min(Xn(n)+2*wd,l-h),f=d>0&&m>0?new Uint8Array(d*m*4):null;f&&this._view.stage.renderer.readHUDVisibility(c,h,d,m,f);let g=!0;const _=e.results.max.distance==null;let v=0;for(const{item:b,occlusionTest:T}of r){let w=!T;if(T&&f)for(const S of mG){const C=4*(Math.min(b.screenPoint[0]+S[0],o)-n[0]+(Math.min(b.screenPoint[1]+S[1],l)-n[1])*d);if(C>=0&&C<f.length&&f[C]){w=!0;break}}w&&(g&&(e.results.min.copy(b.result),g=!1),_&&e.results.max.copy(b.result),e.options.store===2&&e.results.all.splice(v++,0,b.result))}}};const wd=1,mG=(()=>{const s=[],e=wd;for(let t=-e;t<=e;t++)for(let i=-e;i<=e;i++)s.push([i+e,t+e]);return s})();let fG=class{constructor(e){this.result=e,this.screenPoint=Ia()}},Qm;function IS(s){return Qm&&Qm.viewingMode===s||(Qm=new Ur(s)),Qm}let LS=class{constructor(e,t){this.layers=new Array,this.sliceableLayers=new Array,this.include=e?.include,this.exclude=e?.exclude,t(i=>{i.pickable&&this.filterLayerViewUid(i.apiLayerViewUid)&&(i.sliceable?this.sliceableLayers:this.layers).push(i)})}filterLayerViewUid(e,t){const{include:i,exclude:r}=this;if(e==null)return i==null&&r==null;const n=i instanceof Map?i.get(e)??!1:i?.has(e),a=r instanceof Map?r.get(e)??!1:r?.has(e);return(n==null||(typeof n=="boolean"?n:t!=null&&n.has(t)))&&(a==null||!(typeof a=="boolean"?a:t!=null&&a.has(t)))}filterRenderGeometry(e){return this.filterLayerViewUid(e.layerViewUid)}};function FS(s){return typeof s=="object"&&"intersect"in s}const zu=x(),gG=x(),Zm=Ia();let loe=class{constructor(e,t){this.spatialReference=e,this._view=t}getElevation(e,t,i){return this._view.elevationProvider.getElevation(e,t,0,this.spatialReference,i)}async queryElevation(e,t,i,r,n){return this._view.elevationProvider.queryElevation(e,t,0,this.spatialReference,n,i,r)}},_G=class{constructor(e,t,i,r){this.spatialReference=t,this._getElevationQueryProvider=i,this._queries=new Array,this._queryOptions={...r,ignoreInvisibleLayers:!0},this._frameTask=e.registerTask(di.ELEVATION_QUERY,this)}destroy({completeTasks:e}={completeTasks:!1}){if(this._frameTask.remove(),this.readyToRun)if(e)this.runTask(yn);else for(const t of this._queries)t.result.reject(Bi())}queryElevation(e,t,i,r=0){const n=sa(),a={x:e,y:t,minDemResolution:r,result:n,signal:i};return this._queries.push(a),Oo(i,()=>{gw(this._queries,a),n.reject(Bi())}),n.promise}get readyToRun(){return this._queries.length>0}runTask(e){const t=this._queries;this._queries=[];const i=this._getElevationQueryProvider();if(!i)return t.forEach(h=>h.result.reject()),void e.madeProgress();const r=t.map(h=>[h.x,h.y]),n=t.reduce((h,d)=>Math.min(h,d.minDemResolution),1/0),a=new cR({points:r,spatialReference:this.spatialReference}),o=t.length>1&&t.some(h=>!!h.signal)?new AbortController:null,l=o!=null?o.signal:t[0].signal;if(o!=null){let h=0;t.forEach(d=>Oo(d.signal,()=>{h++,d.result.reject(Bi()),h===t.length&&o.abort()}))}const c={...this._queryOptions,minDemResolution:n,signal:l};i.queryElevation(a,c).then(h=>{t.forEach((d,m)=>{d.signal!=null&&d.signal.aborted?d.result.reject(Bi()):d.result.resolve(h.geometry.points[m][2])})}).catch(h=>{t.forEach(d=>d.result.reject(h))}),e.madeProgress()}get test(){}},c_=class{constructor(e=1/0,t=-1/0){this.elevationRangeMin=e,this.elevationRangeMax=t}get elevationRangeValid(){return!Number.isNaN(this.elevationRangeMin)}invalidateElevationRange(){this.elevationRangeMin=NaN}expandElevationRangeValues(e,t){this.elevationRangeMin=Math.min(this.elevationRangeMin,e),this.elevationRangeMax=Math.max(this.elevationRangeMax,t)}expandElevationRange(e){this.elevationRangeMin=Math.min(this.elevationRangeMin,e.elevationRangeMin),this.elevationRangeMax=Math.max(this.elevationRangeMax,e.elevationRangeMax)}setElevationRange(e){this.elevationRangeMin=e.elevationRangeMin,this.elevationRangeMax=e.elevationRangeMax}},xd=class extends fu{get spatialReference(){return this.view.basemapTerrain?.spatialReference??this.view.spatialReference}constructor(e){super(e),this._providers=[new Array,new Array,new Array],this._lastResult=null,this._cacheEnabled=!1}reset(){this._cachedQuery?.destroy({completeTasks:!0}),this._cachedQuery=this._lastResult=null}enableCache(e){e||(this._lastResult=null),this._cacheEnabled=e}getElevation(e,t,i,r,n){const a=this._cacheEnabled&&this._lastResult;if(a&&e===a.x&&t===a.y&&i===a.z&&tc(r,a.spatialReference)&&n===a.queryContext)return a.result;let o=this._updateElevation(null,1,e,t,i,r,n);return n!=="im"&&o==null&&(o=this._updateElevation(null,0,e,t,i,r,n)),n==="scene"&&(o=this._updateElevation(o,2,e,t,i,r,n)),this._cacheEnabled&&(this._lastResult=new yG(e,t,i,r,n,o)),o}getSphereElevationBounds(e,t,i){let r=null;const n=a=>{for(const o of this._providers[a])if(o.getSphereElevationBounds){const l=o.getSphereElevationBounds(e,t,i);l!=null&&(r??=new c_,r.expandElevationRangeValues(l.elevationRangeMin,l.elevationRangeMax))}};return i!=="im"&&n(0),n(1),i==="scene"&&n(2),r}getRootElevationBounds(){return this._providers.reduce((e,t)=>t.reduce((i,r)=>{const n=r.getRootElevationBounds?.();return n!=null&&(i??=new c_,i.expandElevationRangeValues(n.elevationRangeMin,n.elevationRangeMax)),i},e),null)}async queryElevation(e,t,i,r,n,a=null,o=0){const l=this._getElevationQuery(r);try{const c=await l.queryElevation(e,t,a,o);return n==="scene"?this._updateElevation(c,2,e,t,i,r,n):c}catch(c){return mI(c),this.getElevation(e,t,i,r,n)}}register(e,t){this.addHandles(t.on("elevation-change",i=>this.emit("elevation-change",i)),t),this._providers[e].push(t),this.reset()}unregister(e){this.removeHandles(e);for(const t of this._providers){const i=t.indexOf(e);i>-1&&t.splice(i,1)}this.reset()}_getElevationQuery(e=this.view.spatialReference){const t=this._cachedQuery;if(t!=null&&tc(e,t.spatialReference))return t;t?.destroy({completeTasks:!0});const{wkid:i,wkt:r,wkt2:n,latestWkid:a}=e,o=new _G(this.view.resourceController.scheduler,new Dt({wkid:i,wkt:r,wkt2:n,latestWkid:a}),()=>this.view.map?.ground,{maximumAutoTileRequests:4});return this._cachedQuery=o,o}_updateElevation(e,t,i,r,n,a,o){return this._providers[t].reduce((l,c)=>{const h=c.getElevation(i,r,n,a,o);return h==null?l:Math.max(h,l??h)},e)}};u([p({constructOnly:!0})],xd.prototype,"view",void 0),u([p()],xd.prototype,"spatialReference",null),xd=u([R("esri.views.3d.support.CombinedElevationProvider")],xd);let yG=class{constructor(e,t,i,r,n,a){this.x=e,this.y=t,this.z=i,this.spatialReference=r,this.queryContext=n,this.result=a}},tg=class{static isValidProfile(e){return e in fv}static getDefaultProfile(){return Ze("esri-iPhone")?"low":"medium"}static apply(e,t){const i=fv[e];t.graphics3D.maxTotalNumberOfFeatures=i.graphics3D.maxTotalNumberOfFeatures,t.graphics3D.maxNumberOfDrawCalls=i.graphics3D.maxNumberOfDrawCalls,t.graphics3D.maxTotalNumberOfVertices=i.graphics3D.maxTotalNumberOfVertices,t.graphics3D.polygonLodFactor=i.graphics3D.polygonLodFactor,t.graphics3D.polylineLodFactor=i.graphics3D.polylineLodFactor,t.graphics3D.snapshotAvailable=i.graphics3D.snapshotAvailable,t.graphics3D.skipHighSymbolLods=i.graphics3D.skipHighSymbolLods;const r=t.sceneService.object,n=i.sceneService.object;r.lodFactor=n.lodFactor,t.sceneService.point.lodFactor=i.sceneService.point.lodFactor,t.sceneService.integratedMesh.lodFactor=i.sceneService.integratedMesh.lodFactor,t.sceneService.pointCloud.lodFactor=i.sceneService.pointCloud.lodFactor,t.tiledSurface.lodBias=i.tiledSurface.lodBias,t.tiledSurface.angledSplitBias=i.tiledSurface.angledSplitBias,t.tiledSurface.vtlContentZoom=i.tiledSurface.vtlContentZoom,t.tiledSurface.elevationLevelDelta=i.tiledSurface.elevationLevelDelta,t.tiledSurface.reduceTileLevelDifferences=i.tiledSurface.reduceTileLevelDifferences,t.gaussianSplat.minimumSplatPixelRadius=i.gaussianSplat.minimumSplatPixelRadius,t.gaussianSplat.minimumOpacity=i.gaussianSplat.minimumOpacity,t.gaussianSplat.maxAllowedVisibleGaussians=i.gaussianSplat.maxAllowedVisibleGaussians,t.heatmap.pixelRatio=i.heatmap.pixelRatio,t.heatmap.maxTotalNumberOfFeatures=i.heatmap.maxTotalNumberOfFeatures,t.flow3D.maxTotalNumberOfStreamlines=i.flow3D.maxTotalNumberOfStreamlines,t.flow3D.maxTracingResolution=i.flow3D.maxTracingResolution,t.fadeDuration=i.fadeDuration,t.antialiasingEnabled=i.antialiasingEnabled,t.physicallyBasedRenderingEnabled=i.physicalBasedRenderingEnabled,t.highQualityTransparency=i.highQualityTransparency,t.highResolutionAtmosphere=i.highResolutionAtmosphere,t.reflections=i.reflections,t.ambientOcclusion=i.ambientOcclusion,t.maxTexturePixels=i.maxTexturePixels,t.memoryLimit=i.memoryLimit,t.additionalCacheMemory=i.additionalCacheMemory,t.frameRate=i.frameRate,t.maximumPixelRatio=i.maximumPixelRatio}static{this.test={reset(){const e=JD();for(const t of Object.keys(e))fv[t]=e[t]}}}};const Bu={IPhone12Pro:120,GalaxyS20:200,FullHD:240,SurfacePro7:300,FullHDRetina:430},fv=JD();function JD(){const s=!!Ze("esri-mobile"),e=!!Ze("ios"),t=$e(400);return{low:{flow3D:{maxTotalNumberOfStreamlines:25e3,maxTracingResolution:1024},graphics3D:{maxTotalNumberOfFeatures:25e3,maxNumberOfDrawCalls:8e3,maxTotalNumberOfVertices:255e4,polygonLodFactor:.5,polylineLodFactor:1,snapshotAvailable:!1,skipHighSymbolLods:!0},heatmap:{pixelRatio:.125,maxTotalNumberOfFeatures:5e4},sceneService:{object:{lodFactor:.2},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5}},gaussianSplat:{minimumSplatPixelRadius:2,minimumOpacity:.1,maxAllowedVisibleGaussians:4e6},tiledSurface:{lodBias:-1,angledSplitBias:.5,vtlContentZoom:.75,elevationLevelDelta:3,reduceTileLevelDifferences:!0},fadeDuration:$e(0),antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,maxTexturePixels:s?1048576:4194304,memoryLimit:200+Bu.IPhone12Pro,additionalCacheMemory:0,frameRate:0,maximumPixelRatio:1},medium:{flow3D:{maxTotalNumberOfStreamlines:1e5,maxTracingResolution:2048},graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:625e4,polygonLodFactor:s?.8:1,polylineLodFactor:s?1.2:1.5,snapshotAvailable:!e,skipHighSymbolLods:!1},heatmap:{pixelRatio:.25,maxTotalNumberOfFeatures:13e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1}},gaussianSplat:{minimumSplatPixelRadius:1,minimumOpacity:.05,maxAllowedVisibleGaussians:8e6},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,elevationLevelDelta:3,reduceTileLevelDifferences:!Ze("disable-feature:reduce-map-tile-levels")},fadeDuration:t,antialiasingEnabled:!1,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,maxTexturePixels:s?4194304:4096**2,memoryLimit:s?600+Bu.GalaxyS20:750+Bu.FullHD,additionalCacheMemory:s?-100:150,frameRate:0,maximumPixelRatio:1},high:{flow3D:{maxTotalNumberOfStreamlines:1e5,maxTracingResolution:2048},graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:125e5,polygonLodFactor:s?1.2:2,polylineLodFactor:s?1.2:2,snapshotAvailable:!e,skipHighSymbolLods:!1},heatmap:{pixelRatio:.5,maxTotalNumberOfFeatures:23e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1}},gaussianSplat:{minimumSplatPixelRadius:.5,minimumOpacity:.005,maxAllowedVisibleGaussians:16e6},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,elevationLevelDelta:2,reduceTileLevelDifferences:!Ze("disable-feature:reduce-map-tile-levels")},fadeDuration:t,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!0,reflections:!0,ambientOcclusion:!0,maxTexturePixels:s?4096**2:1/0,memoryLimit:s?900+Bu.SurfacePro7:1500+Bu.FullHDRetina,additionalCacheMemory:s?-150:0,frameRate:0,maximumPixelRatio:s?1:1/0}}}async function vG(s,e){if(s.type==="2d")return s.hitTest(e);const t=await s.hitTest(e);if(t.results.length===0)return t;const i=t.results[0],r=(i.distance??0)*(1+bG),n=t.results.findIndex(a=>(a.distance??0)>r);return n!==-1&&(t.results=t.results.slice(0,n)),i&&t.ground.distance>r&&(t.ground.mapPoint=null),t}const bG=.05;function wG(s){return s?.type==="graphic"}function foe(s){return s.find(wG)??null}async function xG(s,e){const{results:t,ground:i}=await vG(s,e),r=(!i.layer||!Xh(i.layer))&&i.mapPoint,n=[],a=SG(s),o=r?CG(s,a):TG;let l=0,c=0;const h=()=>{const m=o.layerViews[c++];if(!r||!m||!("fetchPopupFeaturesAtLocation"in m))return;const f=i.mapPoint,g=m.layer;if(Bh(g)&&"effectiveScaleRange"in g){const{minScale:_,maxScale:v}=g.effectiveScaleRange;if(h4(_,v)){if(N$(g)&&!fC(s.scale,_,v))return;const b=s.basemapTerrain.getScale(f);if(!fC(b,_,v))return}}n.push({mapPoint:f,layerView:m})};let d=null;for(;l<t.length||c<o.layerViews.length;){const m=t[l];if(m&&m.type!=="graphic")++l;else if(m?.layer?.type!=="scene"||m?.layer?.parent!==s?.map?.basemap)if(m){const f=m.layer?.uid,g=o.layerUids.has(f)&&m.distance===i.distance,_=a.get(m.layer?.uid);if(d??=m.mapPoint,c<o.layerViews.length&&(g||(m.distance??0)>i.distance)&&o.layerViews[c]!==_){h();continue}n.push({graphic:m.graphic,layerView:_}),++l}else h();else++l}return d??=i.mapPoint,{hits:n,location:d}}function CG(s,e){const t=new Set,i=new Set;for(let n=s.basemapTerrain.numLayers(1)-1;n>=0;n--){const a=s.basemapTerrain.layerViewByIndex(n,1);t.add(a.layer.uid),i.add(a)}const r=s.overlayManager.renderer.layers;for(const{uid:n}of r){const a=e.get(n);a&&(t.add(n),i.add(a))}return{layerUids:t,layerViews:Array.from(i).reverse()}}const TG={layerUids:new Set,layerViews:[]};function SG(s){const e=new Map;for(const t of s.allLayerViews){const i=t.layer.uid;e.set(i,t)}return e}let Tr=class extends te{constructor(){super(...arguments),this.minTotalNumberOfFeatures=2e3,this.maxTotalNumberOfFeatures=5e4,this.maxNumberOfDrawCalls=17e3,this.maxTotalNumberOfVertices=17e5,this.snapshotAvailable=!0,this.polygonLodFactor=1,this.polylineLodFactor=1,this.skipHighSymbolLods=!1}};u([p()],Tr.prototype,"minTotalNumberOfFeatures",void 0),u([p()],Tr.prototype,"maxTotalNumberOfFeatures",void 0),u([p()],Tr.prototype,"maxNumberOfDrawCalls",void 0),u([p()],Tr.prototype,"maxTotalNumberOfVertices",void 0),u([p()],Tr.prototype,"snapshotAvailable",void 0),u([p()],Tr.prototype,"polygonLodFactor",void 0),u([p()],Tr.prototype,"polylineLodFactor",void 0),u([p()],Tr.prototype,"skipHighSymbolLods",void 0),Tr=u([R("esri.views.3d.support.QualitySettings.Graphics3DSettings")],Tr);let Al=class{constructor(){this.minimumSplatPixelRadius=1,this.minimumOpacity=.05,this.maxAllowedVisibleGaussians=8e6}};u([p()],Al.prototype,"minimumSplatPixelRadius",void 0),u([p()],Al.prototype,"minimumOpacity",void 0),u([p()],Al.prototype,"maxAllowedVisibleGaussians",void 0),Al=u([R("esri.views.3d.support.QualitySettings.GaussianSplatSettings")],Al);let bn=class extends te{constructor(){super(...arguments),this.lodFactor=1}};u([p()],bn.prototype,"lodFactor",void 0),bn=u([R("esri.views.3d.support.QualitySettings.LoDFactorSettings")],bn);let xo=class extends te{constructor(){super(...arguments),this.object=new bn,this.point=new bn,this.integratedMesh=new bn,this.pointCloud=new bn}};u([p({type:bn})],xo.prototype,"object",void 0),u([p({type:bn})],xo.prototype,"point",void 0),u([p({type:bn})],xo.prototype,"integratedMesh",void 0),u([p({type:bn})],xo.prototype,"pointCloud",void 0),xo=u([R("esri.views.3d.support.QualitySettings.SceneServiceSettings")],xo);let Da=class extends te{constructor(){super(...arguments),this.lodBias=0,this.angledSplitBias=1,this.vtlContentZoom=1,this.elevationLevelDelta=3,this.reduceTileLevelDifferences=!0}};u([p()],Da.prototype,"lodBias",void 0),u([p()],Da.prototype,"angledSplitBias",void 0),u([p()],Da.prototype,"vtlContentZoom",void 0),u([p()],Da.prototype,"elevationLevelDelta",void 0),u([p()],Da.prototype,"reduceTileLevelDifferences",void 0),Da=u([R("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],Da);let Eh=class extends te{constructor(){super(...arguments),this.pixelRatio=1,this.maxTotalNumberOfFeatures=5e4}};u([p()],Eh.prototype,"pixelRatio",void 0),u([p()],Eh.prototype,"maxTotalNumberOfFeatures",void 0),Eh=u([R("esri.views.3d.support.QualitySettings.HeatmapSettings")],Eh);let Ah=class extends te{constructor(){super(...arguments),this.maxTotalNumberOfStreamlines=1e5,this.maxTracingResolution=2048}};u([p()],Ah.prototype,"maxTotalNumberOfStreamlines",void 0),u([p()],Ah.prototype,"maxTracingResolution",void 0),Ah=u([R("esri.views.3d.support.QualitySettings.Flow3DSettings")],Ah);let ai=class extends te{constructor(){super(...arguments),this.graphics3D=new Tr,this.sceneService=new xo,this.tiledSurface=new Da,this.gaussianSplat=new Al,this.heatmap=new Eh,this.flow3D=new Ah,this.fadeDuration=$e(400),this.antialiasingEnabled=!0,this.physicallyBasedRenderingEnabled=!1,this.highQualityTransparency=!0,this.highResolutionAtmosphere=!1,this.reflections=!1,this.ambientOcclusion=!1,this.glow=!1,this.maxTexturePixels=1/0,this.memoryLimit=750,this.additionalCacheMemory=0,this.frameRate=void 0,this.maximumPixelRatio=1/0}};u([p({type:Tr})],ai.prototype,"graphics3D",void 0),u([p({type:xo})],ai.prototype,"sceneService",void 0),u([p({type:Da})],ai.prototype,"tiledSurface",void 0),u([p({type:Al})],ai.prototype,"gaussianSplat",void 0),u([p({type:Eh})],ai.prototype,"heatmap",void 0),u([p({type:Ah})],ai.prototype,"flow3D",void 0),u([p()],ai.prototype,"fadeDuration",void 0),u([p()],ai.prototype,"antialiasingEnabled",void 0),u([p()],ai.prototype,"physicallyBasedRenderingEnabled",void 0),u([p()],ai.prototype,"highQualityTransparency",void 0),u([p()],ai.prototype,"highResolutionAtmosphere",void 0),u([p()],ai.prototype,"reflections",void 0),u([p()],ai.prototype,"ambientOcclusion",void 0),u([p()],ai.prototype,"glow",void 0),u([p()],ai.prototype,"maxTexturePixels",void 0),u([p()],ai.prototype,"memoryLimit",void 0),u([p()],ai.prototype,"additionalCacheMemory",void 0),u([p()],ai.prototype,"frameRate",void 0),u([p()],ai.prototype,"maximumPixelRatio",void 0),ai=u([R("esri.views.3d.support.QualitySettings")],ai);const VS=ai,PG=(()=>{const s=new Array;return s[0]=10,s[1]=10,s[2]=10,s[3]=10,s[4]=5,s})(),MG=30;function $G(s){return"usedMemory"in s&&"unloadedMemory"in s&&"ignoresMemoryFactor"in s}function RG(s){return new Ji({view:s})}const kS=.1,Xm=1,gv=1,OG=.75,DG=.6,zS=1.3,Ym=!!Ze("esri-tests-disable-memory-pools");let Ji=class extends te{constructor(e){super(e),this._quality=1,this._usedMemory=0,this._updating=!1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._predictedMemory=0,this._cacheStorage=new R4,this._warnMemoryUsage=null,this._numQualityChanges=0,this._maxMemory=Ym?4096:750,this._additionalCacheMemory=Ym?-4096:0,this.addHandles(Kl({prepare:()=>this._updateMemory()}))}destroy(){this._cacheStorage.destroy()}get maxMemory(){return this._maxMemory}set maxMemory(e){e==null||e<=0||Ym||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(Xm),this._maxMemory=e)}get additionalCacheMemory(){return this._additionalCacheMemory}set additionalCacheMemory(e){e==null||Ym||(this._additionalCacheMemory=e)}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._usedMemory}get usedCacheMemory(){return this._cacheStorage.size}newCache(e,t,i){return new O4(e,this._cacheStorage,t,i)}resetStableQuality(){this._stableQuality=0}disableMemCache(){this.additionalCacheMemory=-4096}update(){if(this._predictedMemory<=0&&!this._updating)return;let e=this._layersUpdating();if(this._predictedMemory<DG&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(Xm);else if(e){if(this._predictedMemory>1.1*gv||this._usedMemory>gv){if(this._stableQuality>0)this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality);else if(this._quality>kS&&this._downscaleMemoryUsed<this._usedMemory){if(this._compactAndUpdate())return;this._updateQuality(this._quality/zS),this._downscaleMemoryUsed=this._usedMemory,this._canFastRecover=!1}}}else if(this._downscaleMemoryUsed=0,this._usedMemory>gv){if(this._compactAndUpdate())return;this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/zS),this._downscaleMemoryUsed=this._predictedMemory}else this._stableQuality!==this._quality&&(this._usedMemory<OG&&this._quality<Xm?(this._stableQuality=this._quality,e=this._updateQuality(this._quality+.05)):this._quality<1&&(this._canFastRecover=!0));this._updating=e}_compactAndUpdate(){const e=oV($e(100)),t=this.view.stage.compact(e);return this.view.overlayManager.renderer.compact(e)||t}_updateQuality(e){return(e=Math.min(Math.max(e,kS),Xm))!==this._quality&&(this._quality=e,++this._numQualityChanges,!0)}_layersUpdating(){return this.view.allLayerViews.some(e=>!!e.updating)}_updateMemory(){if(!this.view?.updating||this.view.destroyed||this.view.destroying)return;this.view.stage?.renderer?.tick();const e=this.view.stage?.renderer?.usedMemory;let t=(this.view.basemapTerrain?.usedMemory??0)+(e?e.fbos+e.edges+e.plugins:0)+this.view.deconflictor?.usedMemory+this.view.labeler?.usedMemory,i=0;this.view.allLayerViews&&this.view.allLayerViews.forEach(o=>{if($G(o)){const l=o.ignoresMemoryFactor?this._quality:1;t+=o.usedMemory*l,i+=o.unloadedMemory*l}});const r=this._warnMemoryUsage==null||Math.round(10*t)!==Math.round(10*this._warnMemoryUsage),n=1048576*this.maxMemory;if(t>n&&r){this._warnMemoryUsage=t;const o=c=>(c/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",l=Math.round(100*this._quality);j.getLogger(this).warn(`Memory Limit exceeded! Limit: ${o(n)} Current: ${o(t)} Projected: ${o(t+i)} Quality: ${l}%`)}this._usedMemory=t/n,this._predictedMemory=(t+i)/n;const a=n-t;this._cacheStorage.maxSize=Math.max(0,a+1048576*this.additionalCacheMemory)}get test(){}};u([p({constructOnly:!0})],Ji.prototype,"view",void 0),u([p()],Ji.prototype,"maxMemory",null),u([p()],Ji.prototype,"additionalCacheMemory",null),u([p({readOnly:!0})],Ji.prototype,"memoryFactor",null),u([p({readOnly:!0})],Ji.prototype,"updating",null),u([p({readOnly:!0})],Ji.prototype,"usedMemory",null),u([p({readOnly:!0})],Ji.prototype,"usedCacheMemory",null),u([p()],Ji.prototype,"_quality",void 0),u([p()],Ji.prototype,"_usedMemory",void 0),u([p()],Ji.prototype,"_updating",void 0),u([p()],Ji.prototype,"_stableQuality",void 0),u([p()],Ji.prototype,"_maxMemory",void 0),u([p()],Ji.prototype,"_additionalCacheMemory",void 0),Ji=u([R("esri.views.3d.support.MemoryController")],Ji);let EG=class{constructor(e){this.client=e,this._cancelled=!1,this.size=0,this.duration=0}},AG=class{constructor(e){this.typeWorkerQuota=e,this.tasks=new Array,this.numWorkers=0,this.statistics=new IG}},IG=class{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0}},LG=class{constructor(e,t,i,r){this._workerFunc=e,this._callbackFunc=t,this._maxTotalNumWorkers=i,this._totalNumWorkers=0,this._clients=r.map(n=>new AG(n))}destroy(){this._clients.length=0}hasQuota(e){const t=this._clients[e];return!!t&&(this._totalNumWorkers<this._maxTotalNumWorkers||t.numWorkers+t.tasks.length<t.typeWorkerQuota)}push(e){const t=this._clients[e.client];t&&(this._totalNumWorkers<this._maxTotalNumWorkers?(t.numWorkers++,this._totalNumWorkers++,this._workerFunc(e,(i,r)=>this._taskCallback(i,r))):t.tasks.push(e))}cancel(e){this._taskFinished(e),e._cancelled=!0}_taskFinished(e){const t=this._clients[e.client];this._totalNumWorkers--,t&&(t.numWorkers--,t.statistics.requests++,t.statistics.size+=e.size||0,t.statistics.duration+=e.duration||0,t.statistics.speed=t.statistics.duration>0?t.statistics.size/t.statistics.duration:0,Wt(t.numWorkers>=0)),this._next()}_next(){for(const e of this._clients)if(e&&e.numWorkers<e.typeWorkerQuota&&this._processQueue(e))return;for(const e of this._clients)if(e&&this._processQueue(e))return}_processQueue(e){for(;e.tasks.length>0;)if(this._workerFunc(e.tasks.shift(),(t,i)=>this._taskCallback(t,i)))return e.numWorkers++,this._totalNumWorkers++,!0;return!1}_taskCallback(e,t){e._cancelled||(this._callbackFunc(e,t),this._taskFinished(e))}getStatsForType(e){const t=this._clients[e];return t?{quota:t.typeWorkerQuota,workers:t.numWorkers,queueSize:t.tasks.length,requestStats:t.statistics}:null}get test(){}},FG=class{constructor(e,t){this.element=e,this.type="image+type",this.isOpaque=t==="image/jpeg"}};function dh(s){return s!=null&&"type"in s&&s.type==="vector-tile"}function eE(s){return s!=null&&"type"in s&&s.type==="raster-tile"}function tE(s){return s!=null&&"type"in s&&s.type==="tile-texture"}function j_(s){return s!=null&&"type"in s&&s.type==="image+type"}let ig=class extends te{constructor(){super(...arguments),this._tasks=new Map,this._onLoadQueue=new Array,this._doneQueue=new Array,this.updating=!1}setup(e,t,i){this._loadQueue=new LG((r,n)=>this._startLoading(r,n),(r,n)=>this._doneLoadingCB(r,n),e,t),i&&(this._frameTask=i.registerTask(di.STREAM_DATA_LOADER,this))}destroy(){this._frameTask=bi(this._frameTask),this._tasks.forEach(e=>Os(e.abortController)),this._loadQueue=Q(this._loadQueue),this._onLoadQueue.length=0,this._onLoadQueue=null,this._doneQueue.length=0,this._doneQueue=null,this._tasks.forEach(e=>e.destroy()),this._tasks.clear(),this._tasks=null}hasDownloadSlots(e){return this._loadQueue.hasQuota(e)}request(e,t,i,r={}){const n=sa();return n.__signal=r!=null?r.signal:null,this._createOrUpdateTask(e,t,i,r,n),n.promise}_createTask(e,t,i,r,n,a){const o=new zG(e,t,i,r,n);return this._updateTask(o,a),this._tasks.set(n,o),this._tasks.size===1&&this._set("updating",!0),this._loadQueue.push(o),o}_cancelRequest(e,t){const i=this._tasks.get(e);i&&(Lr(i.resolvers,t),t.reject(Bi()),i.resolvers.length===0&&(i.status===2&&this._loadQueue.cancel(i),i.status=4,this._removeTask(i)))}_updateTask(e,t){e.resolvers.push(t)}_createOrUpdateTask(e,t,i,r,n){const a=BG(r?.uid||e,t,i);let o=this._tasks.get(a);o?this._updateTask(o,n):(o=this._createTask(e,r,t,i,a,n),o.abortHandle=Oo(r,()=>this._cancelRequest(a,n)))}_doneLoadingCB(e,t){this._loadQueue&&(Wt(e.status===2),e.status=3,this._frameTask?this._doneQueue.push({task:e,err:t}):this._doneLoading(e,t))}get readyToRun(){return this._doneQueue.length>0||this._onLoadQueue.length>0}runTask(e){for(;!e.done&&this._onLoadQueue.length>0;){const t=this._onLoadQueue.shift();He(t.task.abortController),t.task.abortController=null,t.callback(t.task),e.madeProgress()}for(;!e.done&&this._doneQueue.length>0;){const t=this._doneQueue.shift();t.task.status!==3&&(t.err=t.err||Bi()),this._doneLoading(t.task,t.err),e.madeProgress()}}_doneLoading(e,t){if(t&&!zr(t)&&e.numRetries>0)return--e.numRetries,void this._loadQueue.push(e);let i=j_(e.result)||e.result instanceof HTMLImageElement?0:e.resolvers.length;for(const r of e.resolvers)if(t)zr(t)?r.reject(t):r.reject(new me("stream-data-loader:request-error",`Failed to request resource at '${e.url}'. ${t}`,{url:e.url,error:t}));else{--i;const n=i>0?$g(e.result):e.result;r.resolve(n)}this._removeTask(e)}_removeTask(e){this._tasks.delete(e.key),e.destroy(),this._tasks.size===0&&this._set("updating",!1)}_startLoading(e,t){if(e.status===4)return!1;let i,r;switch(e.startTime=performance.now(),e.status=2,e.docType){case 1:r="array-buffer",i=0;break;case 2:r="image";break;case 3:r="array-buffer";break;default:r="json"}e.abortController=new AbortController;const n=e.abortController.signal;e.request=hy(e.url,{...e.options,responseType:r,timeout:i,signal:n});const a=l=>{e.duration=performance.now()-e.startTime,e.size=l instanceof ArrayBuffer?l.byteLength:e.size||0,e.result=l,this._frameTask?this._onLoadQueue.push({callback:t,task:e}):(e.abortController=null,t(e))},o=l=>{e.status===2&&t(e,l)};return e.docType!==3?(e.request.then(l=>a(l.data),o),!0):(e.request.then(l=>{const c=l.data,h=kG(c);if(r="image",e.size=c.byteLength,h==="unknown")return e.request=hy(e.url,{responseType:r,timeout:i,signal:n}),void e.request.then(f=>a(f.data),o);const d=new Blob([c],{type:h}),m=window.URL.createObjectURL(d);e.request=hy(m,{responseType:r,timeout:i,signal:n}),e.request.then(f=>a(new FG(f.data,h)),o).finally(()=>window.URL.revokeObjectURL(m))},o),!0)}get test(){}};u([p({readOnly:!0})],ig.prototype,"updating",void 0),ig=u([R("esri.views.3d.support.StreamDataLoader")],ig);const VG={numRetries:0};function kG(s){if(s.byteLength<2)return"unknown";const e=new Uint8Array(s,0,s.byteLength);return e[0]===137&&e[1]===80?"image/png":e[0]===71&&e[1]===73?"image/gif":e[0]===66&&e[1]===77?"image/bmp":e[0]===255&&e[1]===216?"image/jpeg":"unknown"}let zG=class extends EG{constructor(e,t,i,r,n){super(r),this.url=e,this.options=t,this.docType=i,this.key=n,this.abortHandle=null,this.result=null,this.status=1,this.request=null,this.abortController=null,this.resolvers=new Array,this.startTime=0,this.numRetries=VG.numRetries}destroy(){this.result=null,this.request=null,this.abortController?.abort(),this.abortController=null,this.resolvers.length=0,this.options=null,this.abortHandle=bi(this.abortHandle)}};function BG(s,e,t){return`${s}:${e}:${t}`}let NG=class{constructor(e,t){this._loader=e,this._clientType=t}request(e,t,i={}){return this._loader.request(e,t,this._clientType,i)}get busy(){return!this._loader.hasDownloadSlots(this._clientType)}},sg=class extends te{constructor(){super(...arguments),this.updating=!1}};function UG(s){return new Nn({view:s})}u([p({readOnly:!0})],sg.prototype,"updating",void 0),sg=u([R("esri.views.3d.support.ResourceController.ResourceControllerMain")],sg);let Nn=class extends sg{constructor(){super(...arguments),this._immediateTask=mp,this._normalTask=mp,this._updatingObjects=rs([]),this._frameTask=null}get immediate(){return this._immediateTask}get normal(){return this._normalTask}initialize(){this._scheduler=lV(),this._memoryController=RG(this.view),this._streamDataLoader=new ig,this._streamDataLoader.setup(MG,PG,this._scheduler),this.addHandles([$(()=>this.view.stationary,()=>this._stationaryChangedHandler())]),this._frameTask=Kl({update:e=>this._frame(e)}),this._immediateTask=this._scheduler.registerTask(di.RESOURCE_CONTROLLER_IMMEDIATE),this._normalTask=this._scheduler.registerTask(di.RESOURCE_CONTROLLER)}destroy(){this._immediateTask.remove(),this._normalTask.remove(),this._frameTask=bi(this._frameTask),this._streamDataLoader=Q(this._streamDataLoader),this._memoryController=Q(this._memoryController),this._scheduler=Q(this._scheduler),this.view=null}get updating(){return!!(this._memoryController?.updating||this._streamDataLoader?.updating||this._immediateTask?.updating)||this._updatingObjects?.value.some(e=>e.updating)}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}createStreamDataRequester(e){return new NG(this._streamDataLoader,e)}addUpdatingObject(e){const t=this._updatingObjects;return t.value=[...t.value,e],xn(()=>{t.value=t.value.filter(i=>i!==e)})}_frame(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step(_w(e.deltaTime)),!this._scheduler)||(this._memoryController.update(),this.view.state&&(this._scheduler.state=this.view.state.fading?1:this.view.state.mode,this.view.state.fading=!1),this._scheduler.frame(e))}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}get test(){}};u([p()],Nn.prototype,"view",void 0),u([p()],Nn.prototype,"_scheduler",void 0),u([p()],Nn.prototype,"_memoryController",void 0),u([p()],Nn.prototype,"_streamDataLoader",void 0),u([p()],Nn.prototype,"_immediateTask",void 0),u([p()],Nn.prototype,"_normalTask",void 0),u([p({readOnly:!0})],Nn.prototype,"updating",null),Nn=u([R("esri.views.3d.support.ResourceController")],Nn);let Loe=class{constructor(e,t=0,i=0,r=0,n=0,a=null){this.usedMemory=e,this.displayedFeatures=t,this.totalFeatures=i,this.maximumFeatures=r,this.nodes=n,this.core=a}};function HG(s){return"performanceInfo"in s}let qG=class{constructor(e){this.layer=null,this.memory=0,this.displayedNumberOfFeatures=0,this.maximumNumberOfFeatures=null,this.totalNumberOfFeatures=null,this.layer=e.layer;const t=e.performanceInfo;this.memory=t.usedMemory,this.displayedNumberOfFeatures=t.displayedFeatures,this.maximumNumberOfFeatures=t.maximumFeatures,this.totalNumberOfFeatures=t.totalFeatures}},GG=class{constructor(e){if(this.totalMemory=0,this.usedMemory=0,this.quality=1,this.load=0,this.terrainMemory=0,this.edgesMemory=0,this.layerPerformanceInfos=new Array,this.cachedMemory=0,this.fboMemory=0,e.resourceController!=null){const t=e.resourceController.memoryController;this.totalMemory=1048576*(t.maxMemory??0),this.usedMemory=Math.round(t.usedMemory*this.totalMemory),this.quality=e.quality,this.load=e.resourceController.scheduler.load,this.cachedMemory=t.usedCacheMemory}this.terrainMemory=e.basemapTerrain?.usedMemory??0,this.edgesMemory=e.stage?.renderer.usedMemory.edges??0,this.fboMemory=e.stage?.renderer.usedMemory.fbos??0,e.allLayerViews?.items.forEach(t=>{HG(t)&&this.layerPerformanceInfos.push(new qG(t))}),this.layerPerformanceInfos.sort((t,i)=>i.memory-t.memory)}},jG=class{constructor(e){this._gltfLoading=new Map,this._wosrLoading=new Map,this._gltfCache=e("gltf-resources",()=>{}),this._wosrCache=e("wosr-resources",()=>{})}destroy(){this._gltfLoading.forEach(e=>e.abortController.abort()),this._wosrLoading.forEach(e=>e.abortController.abort()),this._gltfCache.destroy(),this._wosrCache.destroy()}loadGLTF(e,t,i){const r=i?`gltfPBR:${e}`:`gltf:${e}`,n=this._gltfCache.get(r);return n?Promise.resolve(n):BS(this._gltfLoading,this._gltfCache,r,async a=>{const{loadGLTF:o}=await k(()=>import("./loader-CjRmx4ez.js"),__vite__mapDeps([465,1,39,7,8,5,6,80,70,4,2,9,10,19,20,14,195,189,183,87,185,186,88,273,193]));return o(new E4(a.streamDataRequester),e,a,i)},t)}loadWOSR(e,t){const i=`wosr:${e}:${t.disableTextures}`,r=this._wosrCache.get(i);return r?Promise.resolve(r):BS(this._wosrLoading,this._wosrCache,i,n=>A4(e,n),t)}};async function BS(s,e,t,i,r){He(r);const n=Oo(r,()=>WG(s,t));let a=s.get(t);if(a)a.refCount++;else{const o=new AbortController;a={refCount:1,abortController:o,promise:i({...r,signal:o.signal})},s.set(t,a)}try{const o=await a.promise;return e.put(t,o),s.delete(t),He(r),o}finally{bi(n)}}function WG(s,e){const t=s.get(e);t!=null&&--t.refCount>0||(s.delete(e),t?.abortController.abort())}let Ih=class extends te{constructor(e,t){super({}),this._stage=e,this._textureRequests=new Map,this._frameTask=t?.registerTask(di.TEXTURE_UNLOAD)??mp}normalizeCtorArgs(){return{}}destroy(){super.destroy(),this._frameTask?.remove(),this._textureRequests?.forEach(e=>this._releaseTextureRequest(e)),this._textureRequests?.clear()}get updating(){return this._frameTask.updating}fromData(e,t){const i=this.makeUid(e);let r=this._textureRequests.get(i);if(!r){const n=new sE;n.texture=t(),this._stage&&(n.texture.load(this._stage.renderView.renderingContext),this._stage.addTexture(n.texture)),this._textureRequests.set(i,n),r=n}return r.referenceCount++,new iE(i,r.texture,()=>this._release(i))}_release(e){const t=this._textureRequests.get(e);t?(t.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+e),t.referenceCount--,t.referenceCount<1&&this._frameTask.schedule(()=>this._releaseNow(e))):console.warn(`TextureCollection: texture doesn't exist: '${e}'`)}get test(){}_releaseNow(e){if(!this._textureRequests)return;const t=this._textureRequests.get(e);!t||t.referenceCount>0||(t.texture?.unload(),this._releaseTextureRequest(t),this._textureRequests.delete(e))}_releaseTextureRequest(e){e.texture?this._stage?.removeTexture(e.texture):e.abortController&&(e.abortController.abort(),e.abortController=null)}makeUid(e,t=null){return t!=null?`${e}.${t}px`:e}};u([p()],Ih.prototype,"_frameTask",void 0),u([p()],Ih.prototype,"updating",null),Ih=u([R("esri.views.3d.support.TextureCollection")],Ih);let iE=class{constructor(e,t,i){this.uid=e,this.texture=t,this.release=i}},sE=class{constructor(){this.referenceCount=0}},QG=class extends Ih{constructor(e,t,i){super(t,i),this._streamDataRequester=e}async fromUrl(e,t,i){He(i);const r=i?.signal,n=this.makeUid(e,t);let a=this._textureRequests.get(n);if(!a){const o=new AbortController,l=this._streamDataRequester.request(e,2,{uid:n,signal:o.signal});a=new sE,a.abortController=o;const c=a;this._textureRequests.set(n,a),a.textureAsync=l.then(async h=>{const d=this._createTexture(e,h,t);return c.texture=d,c.abortController=null,await d.load(this._stage.renderView.renderingContext),this._stage.addTexture(d),new iE(n,d,()=>this._release(n))},h=>{throw c.abortController=null,h})}a.referenceCount++;try{return await fI(a.textureAsync,r)}catch(o){throw this._release(n),o}}_createTexture(e,t,i){const r={width:t.width,height:t.height,wrap:{s:33071,t:33071},preMultiplyAlpha:!0,reloadable:!0};if(x$(e)){if(i||t.width===0&&t.height===0){const n=t.width?t.height/t.width:1;i=i||64,n>1?(t.width=Math.round(i/n),t.height=i):(t.width=i,t.height=Math.round(i*n))}this._stage.renderView?.renderingContext.driverTest.svgPremultipliesAlpha.result&&(r.preMultiplyAlpha=!1)}return new YI(t,r)}},ZG=class{constructor(e){this.streamDataRequester=null,this.cimSymbolRasterizer=null,this.streamDataRequester=e.resourceController.createStreamDataRequester(4),this.objectResourceCache=new jG((t,i)=>e.resourceController.memoryController.newCache(t,i)),this.textures=new QG(this.streamDataRequester,e.view.stage,e.resourceController.scheduler)}destroy(){this.textures.destroy(),this.streamDataRequester=null}},Cd=class extends te{constructor(e){super(e),this._propertiesPool=new ja({plane:()=>R_()},this),this.isDecoration=!0,this.addHandles(w_(this._propertiesPool))}set plane(e){if(!e)return void this._set("plane",e);const t=this._propertiesPool.get("plane");Lw(e,t),this._set("plane",t)}};u([p()],Cd.prototype,"plane",null),u([p()],Cd.prototype,"isDecoration",void 0),Cd=u([R("esri.views.3d.support.ViewSlice")],Cd);let XG=class{constructor(e){this.destination=e}hide(){this.graphic!=null&&(this.destination.remove(this.graphic),this.graphic=null)}},ph=class extends XG{constructor(e,t,i=""){super(e),this._symbol=new s4({symbolLayers:new Pt([new n4({material:{color:t},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new a4({text:i,halo:{color:"white",size:1/.75},material:{color:t},size:12})])})}show(e,t){if(!t)return;this.hide();const i=new wt({x:e[0],y:e[1],z:e[2],spatialReference:t});this.graphic=new Zw({geometry:i,symbol:this._symbol}),this.destination.add(this.graphic)}},To=class extends te{constructor(e){super(e)}};u([p({constructOnly:!0})],To.prototype,"renderCoordsHelper",void 0),u([p({constructOnly:!0})],To.prototype,"surface",void 0),u([p({constructOnly:!0})],To.prototype,"state",void 0),To=u([R("esri.views.3d.support.pointsOfInterest.PointOfInterest")],To);let br=class extends To{constructor(e){super(e),this._dirty=!1,this._propertiesPool=new ja({location:()=>new wt,renderLocation:()=>x()},this),this._estimatedSurfaceAltitude=0,this._elevationQueryController=null,this.renderLocation=x(),this._tmpPoint=new wt}initialize(){if(this.scheduler&&this.addHandles(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){const e=()=>this._setDirty();this.addHandles(Ds(()=>this.map?.ground?.layers,"change",e,{onListenerAdd:e,onListenerRemove:e}))}this._updateRenderLocation()}destroy(){this._cancelPendingRequest(),this._propertiesPool=Q(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}get scale(){const e=this._camera,t=Ht(e.eye,this.renderLocation),i={renderCoordsHelper:this.renderCoordsHelper,state:{camera:e}};return nc(i,t)}get updating(){return this._dirty||this._elevationQueryController!=null}updateRenderLocation(){this._setDirty(),this._updateRenderLocation()}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}_cancelPendingRequest(){const e=this._elevationQueryController;e&&(this._elevationQueryController=null,e.abort(),this.notifyChange("updating"))}get readyToRun(){return!this._elevationQueryController&&this._dirty}runTask(){if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!this.map?.ground)return this._updateSurfaceAltitude(0),Ai;const e=this.state.spatialReference;this._tmpPoint.spatialReference=e,this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this._tmpPoint);const t=(this._tmpPoint.z??0)>YG&&this.renderCoordsHelper.viewingMode===1&&(e.isWGS84||e.isWebMercator);let i=new AbortController;return this.map.ground.queryElevation(this._tmpPoint,{signal:i.signal,cache:this.cache,minDemResolution:t?KG:0}).then(r=>this._updateSurfaceAltitude(r.geometry.z??0)).catch(r=>{if(r.name===z5)if(this.integratedMeshElevationSampler){this._tmpPoint.spatialReference=this.integratedMeshElevationSampler.spatialReference,this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this._tmpPoint);const n=this.integratedMeshElevationSampler.elevationAt(this._tmpPoint.x,this._tmpPoint.y)??0;this._updateSurfaceAltitude(n===this.integratedMeshElevationSampler.noDataValue?0:n)}else this._updateSurfaceAltitude(0)}).catch(()=>{}).then(()=>{this._elevationQueryController===i&&(this._elevationQueryController=null,this.notifyChange("updating")),i=null}),this._elevationQueryController=i,Ai}_updateSurfaceAltitude(e){this._estimatedSurfaceAltitude!==e&&(this._estimatedSurfaceAltitude=e,this._updateRenderLocation())}_updateRenderLocation(){this.renderCoordsHelper.setAltitude(_v,this._estimatedSurfaceAltitude,this._camera.eye),qo(this._get("renderLocation"),_v)||(this._set("renderLocation",q(this._propertiesPool.get("renderLocation"),_v)),this.notifyChange("renderLocation"))}};u([p({constructOnly:!0})],br.prototype,"scheduler",void 0),u([p({constructOnly:!0})],br.prototype,"cache",void 0),u([p({constructOnly:!0})],br.prototype,"map",void 0),u([p({constructOnly:!0})],br.prototype,"task",void 0),u([p({constructOnly:!0})],br.prototype,"integratedMeshElevationSampler",void 0),u([p()],br.prototype,"location",null),u([p()],br.prototype,"renderLocation",void 0),u([p()],br.prototype,"scale",null),u([p()],br.prototype,"updating",null),br=u([R("esri.views.3d.support.pointsOfInterest.CameraOnSurface")],br);const _v=x(),YG=1e5,KG=1e6;let Pr=class extends To{constructor(e){super(e),this._propertiesPool=new ja({location:()=>new wt,renderLocation:()=>x()},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.distance=0,this.renderLocation=x(),this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()}destroy(){this._frameWorker=bi(this._frameWorker),this._propertiesPool=Q(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool?.get("location");return e?(e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e):new wt}updateRenderLocation(){this.updating=!0,this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}get readyToRun(){return this.updating}runTask(){return this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1,Ai}_updateRenderLocation(){const e=ej;let t=this._calculateSurfaceIntersection(this._currentSurfaceAltitude,e);const i=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!t&&i&&(t=this._calculateSurfaceIntersection(this._latestSurfaceAltitude,e),t&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const r=tj;t&&this._latestSurfaceAltitudeChangesDistanceSignificantly(e,r)&&(q(e,r),this._currentSurfaceAltitude=this._latestSurfaceAltitude),t?this.distance=Ht(this._camera.eye,e):(ee(e,this._camera.viewForward,this._get("distance")),ce(e,e,this._camera.eye)),qo(this._get("renderLocation"),e)||this._set("renderLocation",q(this._propertiesPool.get("renderLocation"),e))}_calculateSurfaceIntersection(e,t){const i=this._camera;if(!this.renderCoordsHelper.intersectInfiniteManifold(i.ray,e,t))return!1;if(this.state.isGlobal){const r=Zt(this.renderCoordsHelper.spatialReference).radius,n=r+e,a=Gs(i.eye),o=a<n*n,l=Ht(i.eye,t);if(o&&l>r/4){const c=n-Math.sqrt(a);return ee(t,i.viewForward,c),ce(t,t,i.eye),!0}}else{const r=this.surface?.ready?this.surface.extentAABR:null;r!=null&&i1(r,this.surface?.spatialReference,Nu,this.renderCoordsHelper.spatialReference)&&(t[0]=U(t[0],Nu[0],Nu[2]),t[1]=U(t[1],Nu[1],Nu[3]))}return!0}_latestSurfaceAltitudeChangesDistanceSignificantly(e,t){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||e==null)return!1;if(this._calculateSurfaceIntersection(this._latestSurfaceAltitude,t)){if(yi.TESTS_DISABLE_OPTIMIZATIONS)return!0;const i=this._camera.eye,r=Ht(i,e),n=Ht(i,t);if(Math.abs(n-r)/r>JG)return!0}return!1}};u([p({constructOnly:!0})],Pr.prototype,"scheduler",void 0),u([p({constructOnly:!0})],Pr.prototype,"task",void 0),u([p()],Pr.prototype,"distance",void 0),u([p({constructOnly:!0})],Pr.prototype,"estimateSurfaceAltitudeAtCenter",void 0),u([p({readOnly:!0})],Pr.prototype,"location",null),u([p({readOnly:!0})],Pr.prototype,"renderLocation",void 0),u([p()],Pr.prototype,"updating",void 0),Pr=u([R("esri.views.3d.support.pointsOfInterest.CenterOnSurface")],Pr);const JG=.05,ej=x(),tj=x(),Nu=Mt();function rE(s,e,t){const i=t?.createCollection?.()??new Pt,r=t?.recycleItems?new ij:null,n=(l,c=0)=>{if(!l?.length)return;const h=i.splice(c,l.length);r?r.processRemoved(l):h.forEach(h_)},a=(l,c=0)=>{if(!l?.length)return;const h=[];for(const d of l){const m=r?.use(d);if(m)h.push(m);else{const f=e(d);r?.register(d,f),h.push(f)}}i.addMany(h,c)},o=Ds(s,"after-splice",({added:l,start:c,removed:h})=>{n(h,c),a(l,c)},{sync:!0,onListenerRemove:l=>n(l.items),onListenerAdd:l=>a(l.items)});return i.addHandles(o),i}let ij=class{constructor(){this._originalToMapped=new Map,this._removedItemCandidates=new Set,this._garbageCollectionQueued=!1}processRemoved(e){if(!e?.length)return;const{_removedItemCandidates:t}=this;for(const i of e)this._getItem(i)?.markRemoved()&&(t.add(i),this._queueGarbageCollection())}use(e){const t=this._getItem(e);return t&&(t.removed=!1),t?.item}register(e,t){this._originalToMapped.set(e,new sj(t))}_getItem(e){return this._originalToMapped.get(e)}_queueGarbageCollection(){this._garbageCollectionQueued||(this._garbageCollectionQueued=!0,queueMicrotask(()=>this._garbageCollectCandidates()))}_garbageCollectCandidates(){this._garbageCollectionQueued=!1;const{_removedItemCandidates:e}=this,t=Array.from(e);e.clear(),t.forEach(i=>this._garbageCollectIfRemoved(i))}_garbageCollectIfRemoved(e){const{_originalToMapped:t}=this,i=this._getItem(e);i?.removed&&(h_(i.item),t.delete(e))}},sj=class{constructor(e){this.item=e,this.removed=!1}markRemoved(){return this.removed=!0,!0}};function h_(s){typeof s=="object"&&s&&("destroy"in s&&typeof s.destroy=="function"?s.destroy():gI(s))}function Joe(s,e,t){const i=new Pt,r=rE(s,l=>Za(async c=>{const h=await e(l,c);if(Hl(c))throw h_(h),Bi();return h}),t),n=()=>null,a=async l=>{const c=await l.promise,h=r.indexOf(l);h<0||i.splice(h,1,c)};i.addMany(r.items.map(n));for(const l of r)Rg(a(l));const o=r.on("after-splice",({added:l,start:c,deleteCount:h})=>{const d=i.splice(c,h);for(const m of d)h_(m);if(l?.length){i.addMany(l.map(n),c);for(const m of l)Rg(a(m))}});return i.addHandles([w_(r),o]),i}let rj=class{constructor(e,t){this._handles=new b_,this.events=new cc,this._handles.add([w_(rE(()=>e,i=>i.on("visible-geometry-changed",r=>this.events.emit("request-update",r)))),Ds(t,"visible-geometry-changed",()=>this.events.emit("request-update"))])}destroy(){this._handles.destroy()}},rn=class extends To{constructor(e){super(e),this._propertiesPool=new ja({location:()=>new wt,renderLocation:()=>x()},this),this._dirty=!0,this.renderLocation=this._propertiesPool.get("renderLocation")}initialize(){this.addHandles([$(()=>this.centerOnSurface.renderLocation,()=>this.updateRenderLocation(),{equals:qo}),$(()=>this.state.contentCamera,()=>this.updateRenderLocation())]),this.scheduler&&this.addHandles(this.scheduler.registerTask(di.POINT_OF_INTEREST_FREQUENT,this))}destroy(){this._propertiesPool=Q(this._propertiesPool)}get updating(){return this._dirty||this.centerOnSurface.updating}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}get worldUnitsPerContentPixel(){const{camera:e,contentPixelRatio:t}=this.state;return e.computeRenderPixelSizeAt(this.renderLocation)*(e.pixelRatio/t)}get readyToRun(){return this._dirty}runTask(){const e=this._get("renderLocation"),t=this.centerOnSurface.renderLocation,i=this.renderCoordsHelper,r=this.state.contentCamera;this._dirty=!1,i.worldUpAtPosition(t,NS);const n=Math.max(0,(Math.acos(We(NS,r.viewForward))-.5*Math.PI)*(r.aboveGround?1:-1));if(Number.isNaN(n)){if(!e||!Jh(e,t)){const c=this._propertiesPool.get("renderLocation");q(c,t),this._set("renderLocation",c)}return Ai}const a=1-U(n/(.5*Math.PI),0,1),o=a*a*a;this._calculateScreenHorizontalEdgeOnSurface(US);const l=this._propertiesPool.get("renderLocation");return kt(l,t,US,o),e&&Jh(e,l)||this._set("renderLocation",l),Ai}_calculateScreenHorizontalEdgeOnSurface(e){const t=this.state.contentCamera,i=t.getRenderCenter(Ia());if(i[1]=t.aboveGround?t.padding[2]:t.fullHeight-t.padding[0],this.estimateSurfaceIntersectionAtRenderPoint(i,e))return e;const r=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(t.unprojectFromRenderScreen(i,Uu)){he(Uu,Uu,t.eye);const n=pe(Uu,Uu);if(this.renderCoordsHelper.intersectInfiniteManifold(iu(t.eye,n),r,e))return e}return this.renderCoordsHelper.setAltitude(e,r,t.eye)}updateRenderLocation(){this._dirty=!0}};u([p()],rn.prototype,"_dirty",void 0),u([p({constructOnly:!0})],rn.prototype,"scheduler",void 0),u([p({constructOnly:!0})],rn.prototype,"centerOnSurface",void 0),u([p({constructOnly:!0})],rn.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),u([p()],rn.prototype,"updating",null),u([p()],rn.prototype,"location",null),u([p()],rn.prototype,"renderLocation",void 0),u([p()],rn.prototype,"worldUnitsPerContentPixel",null),rn=u([R("esri.views.3d.support.pointsOfInterest.Focus")],rn);const NS=x(),Uu=x(),US=x();let Ca=class extends te{constructor(e){super(e),this.location=null,this._updateController=null}initialize(){this.view.state.isLocal&&(this.addHandles([$(()=>[this._terrain?.spatialReference,this._terrain?.extent],()=>this._update()),Ds(()=>this._ground?.layers,"change",()=>this._update())]),this._update())}destroy(){this._updateController=Os(this._updateController)}get renderLocation(){if(!this.location)return null;const e=x();return this.view.renderCoordsHelper.toRenderCoords(this.location,e),e}get _ground(){return this.view.map?.ground}get _terrain(){return this.view.basemapTerrain}_update(){if(this._updateController=Os(this._updateController),this._terrain?.extent==null||this._terrain?.spatialReference==null)return void this._set("location",null);const e=L$(this._terrain.extent),t=new wt({x:e[0],y:e[1],z:0,spatialReference:this._terrain.spatialReference});this._ground&&this._ground.layers.length>0?(this._set("location",null),this._updateController=new AbortController,this._ground.queryElevation(t,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then(i=>{this._updateController=null,this._set("location",i.geometry)}).catch(i=>{})):this._set("location",t)}};u([p({constructOnly:!0})],Ca.prototype,"view",void 0),u([p({constructOnly:!0})],Ca.prototype,"cache",void 0),u([p({readOnly:!0})],Ca.prototype,"location",void 0),u([p({readOnly:!0})],Ca.prototype,"renderLocation",null),u([p()],Ca.prototype,"_ground",null),u([p()],Ca.prototype,"_terrain",null),Ca=u([R("esri.views.3d.support.pointsOfInterest.StableSurfaceCenter")],Ca);let Ta=class extends te{constructor(e){super(e),this._tileGeometryUpdateExtent=Fo(),this._tileGeometryUpdateSpatialReference=null,this.events=new cc,this.updating=!1}initialize(){this.addHandles([this.surface.on("elevation-change",e=>this._tileGeometryChanged(e)),this.scheduler.registerTask(di.SURFACE_GEOMETRY_UPDATES,this)])}get readyToRun(){return this.updating}runTask(){return this.updating?(this._tileGeometryUpdateSpatialReference&&this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",nj),Fo(this._tileGeometryUpdateExtent),this._set("updating",!1),Ai):Ai}_tileGeometryChanged(e){this._tileGeometryUpdateSpatialReference=e.spatialReference,zh(this._tileGeometryUpdateExtent,e.extent,this._tileGeometryUpdateExtent),this._set("updating",!0)}_furthestCenterOnSurface(){let e=this.centerOnSurfaces[0];for(let t=1;t<this.centerOnSurfaces.length;t++){const i=this.centerOnSurfaces[t];i.distance>e.distance&&(e=i)}return e}_centerIntersectsExtent(e,t){const i=this.state.contentCamera.eye,r=aj,n=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(i,al,t),this.renderCoordsHelper.fromRenderCoords(n.renderLocation,ol,t),al[0]<ol[0]?(r[0]=al[0],r[2]=ol[0]):(r[0]=ol[0],r[2]=al[0]),al[1]<ol[1]?(r[1]=al[1],r[3]=ol[1]):(r[1]=ol[1],r[3]=al[1]),I$(r,e)}};u([p({constructOnly:!0})],Ta.prototype,"state",void 0),u([p({constructOnly:!0})],Ta.prototype,"centerOnSurfaces",void 0),u([p({constructOnly:!0})],Ta.prototype,"renderCoordsHelper",void 0),u([p({constructOnly:!0})],Ta.prototype,"scheduler",void 0),u([p({constructOnly:!0})],Ta.prototype,"surface",void 0),u([p({readOnly:!0})],Ta.prototype,"updating",void 0),Ta=u([R("esri.views.3d.support.pointsOfInterest.SurfaceGeometryUpdates")],Ta);const nj={},al=x(),ol=x(),aj=Fo();let Cs=class extends te{constructor(e){super(e),this.renderPointOfView=x(),this._pois=new Array,this._updatingHandles=new hc,this._debugCenters=null,this._tmpRay=Go(),this._centerRayDirty=!0,this._surfaceAltitudeAtCenter=0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenter=0,this._contentAltitudeAtCenterDirty=!0,this._propertiesPool=new ja({renderPointOfView:()=>x()},this),this._contentIntersector=new Ur(e.view.state.viewingMode),this._surfaceIntersector=new Ur(e.view.state.viewingMode),this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=0}initialize(){const{state:e,groundView:t,renderCoordsHelper:i,map:r}=this.view,n=()=>this._estimateSurfaceAltitudeAtCenter(),a=this.view.resourceController.scheduler,o=t?.elevationQueryCache,l={state:e,scheduler:a,surface:t,renderCoordsHelper:i};this._set("centerOnSurfaceInfrequent",new Pr({...l,task:di.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:n})),this._set("centerOnSurfaceFrequent",new Pr({...l,task:di.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:n})),this._set("centerOnContent",new Pr({...l,task:di.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()}));const c=t.integratedMeshElevationSampler;this._set("cameraOnSurface",new br({...l,cache:o,integratedMeshElevationSampler:c,task:di.POINT_OF_INTEREST_INFREQUENT,map:r})),this._set("surfaceGeometryUpdates",new Ta({...l,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]})),this._set("contentGeometryUpdates",new rj(this.view.allLayerViews,()=>this.view.graphicsView)),this._set("surfaceOrigin",new Ca({cache:o,view:this.view})),this._set("focus",new rn({state:e,scheduler:a,surface:t,renderCoordsHelper:i,centerOnSurface:this.centerOnSurfaceFrequent,estimateSurfaceIntersectionAtRenderPoint:(h,d)=>this._estimateSurfaceIntersectionAtRenderPoint(h,this.view.state.contentCamera,d)})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.cameraOnSurface,this.focus),this.addHandles([$(()=>e.contentCamera,h=>this._cameraChanged(h),Ae),this._updatingHandles.add(()=>t.extentAABR,()=>this._updateCenterPointsOfInterest()),this._updatingHandles.add(()=>this.view.map?.ground?.navigationConstraint?.type,h=>{this._surfaceIntersector.options.backfacesTerrain=h==="none"},Re),Zs(()=>!t.updating,()=>this._updateCenterPointsOfInterest(),Ae),Ds(()=>this.surfaceGeometryUpdates.events,"request-update",()=>this._updateCenterPointsOfInterest()),Ds(()=>this.contentGeometryUpdates.events,"request-update",()=>this._updateCenterOnContent()),this._updatingHandles.add(()=>yi.SHOW_POI,h=>this._setDebug(h),Re)]),this._cameraChanged(this.view.state.contentCamera);for(const h of this._pois)h.runTask()}destroy(){this._setDebug(!1),this._propertiesPool.destroy();for(const e of this._pois)e.destroy();this._pois.length=0,this.surfaceOrigin.destroy(),this._updatingHandles.destroy(),this._set("centerOnSurfaceInfrequent",null),this._set("centerOnSurfaceFrequent",null),this._set("centerOnContent",null),this._set("cameraOnSurface",null),this._set("surfaceGeometryUpdates",null),this._set("contentGeometryUpdates",null),this._set("surfaceOrigin",null),this._set("focus",null)}get updating(){return!(!this.surfaceGeometryUpdates?.updating&&!this._pois.some(e=>e.updating))||this._updatingHandles.updating}get _centerRay(){return this._centerRayDirty&&(this._centerRayCached=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.contentCamera,this._tmpRay),this._centerRayDirty=!1),this._centerRayCached}_estimateContentAltitudeAtCenter(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const e=this._centerRay;return e==null||(this.view.sceneIntersectionHelper.intersectRay(e,this._contentIntersector,Ac,lj)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(Ac):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}_estimateSurfaceAltitudeAtCenter(){const{view:e}=this,{groundView:t}=e;if(!t)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const i=this._centerRay;if(i==null)return this._surfaceAltitudeAtCenter;const r=i.origin,n=ce(Ac,i.origin,i.direction);return this._surfaceIntersector.resetWithRay(i,e.state.contentCamera),t.intersect(this._surfaceIntersector,null,r,n),this._surfaceIntersector.results.min.getIntersectionPoint(Ac)&&(this._surfaceAltitudeAtCenter=e.renderCoordsHelper.getAltitude(Ac)),this._surfaceAltitudeAtCenter}_estimateSurfaceIntersectionAtRenderPoint(e,t,i){const r=b1(t,e,oj);if(r==null)return null;const n=r.origin,a=ce(Ac,r.origin,r.direction);return this._surfaceIntersector.resetWithRay(r,t),this.view.groundView.intersect(this._surfaceIntersector,null,n,a),this._surfaceIntersector.results.min.getIntersectionPoint(i)?i:null}_cameraChanged(e){this._updateCenterPointsOfInterest();const t=e.eye;qo(this.renderPointOfView,t)||this._set("renderPointOfView",q(this._propertiesPool.get("renderPointOfView"),t))}_updateCenterPointsOfInterest(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;for(const e of this._pois)e.updateRenderLocation()}_updateCenterOnContent(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()}_setDebug(e){if(!e)return this._debugCenters?.forEach(t=>t.hide()),void this.removeHandles("debug");if(!this._debugCenters){this._debugCenters=new Map;const t=this.view.graphics;this._debugCenters.set(this.centerOnContent,new ph(t,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new ph(t,"red","CenterOnSurface")),this._debugCenters.set(this.centerOnSurfaceInfrequent,new ph(t,"red","CenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new ph(t,"blue","CameraOnSurface")),this._debugCenters.set(this.focus,new ph(t,"green","Focus"))}for(const t of this._pois)this.addHandles(this._updatingHandles.add(()=>t.renderLocation,i=>this._debugCenters?.get(t)?.show(i,t.renderCoordsHelper.spatialReference),Re),"debug")}get test(){}};u([p()],Cs.prototype,"centerOnContent",void 0),u([p()],Cs.prototype,"centerOnSurfaceFrequent",void 0),u([p()],Cs.prototype,"centerOnSurfaceInfrequent",void 0),u([p()],Cs.prototype,"cameraOnSurface",void 0),u([p()],Cs.prototype,"focus",void 0),u([p()],Cs.prototype,"renderPointOfView",void 0),u([p()],Cs.prototype,"surfaceOrigin",void 0),u([p()],Cs.prototype,"contentGeometryUpdates",void 0),u([p()],Cs.prototype,"surfaceGeometryUpdates",void 0),u([p({constructOnly:!0})],Cs.prototype,"view",void 0),u([p()],Cs.prototype,"updating",null),Cs=u([R("esri.views.3d.support.pointsOfInterest.PointsOfInterest")],Cs);const Ac=x(),oj=Go(),lj={exclude:new Set([Ao])},cj=()=>j.getLogger("esri/core/MemCachePool");let Xp=class{constructor(e,t){this._cache=e(t,(i,r,n)=>{switch(r){case 0:return i.forEach(a=>a.dispose()),0;case 1:{const a=i.shift();return a?(n-=Math.round(a.usedMemory),a.dispose()):n>0&&(cj().warn("Encountered empty MemCachePool with non-zero memory."),n=0),n}}})}hitrate(){return this._cache.hitRate}destroy(){this._cache.destroy()}clear(){this._cache.clear()}getSize(e){return this._cache.getSize(e)}pop(e){const t=this._cache.peek(e);if(!t)return;const i=t.pop();return t.length>0?i&&(t.usedMemory=this._cache.getSize(e)-Math.round(i.usedMemory),this._cache.updateSize(e)):this._cache.pop(e),i}put(e,t,i=D4){const r=this._cache.peek(e);if(!r){const n=new hj(t);return void this._cache.put(e,n,i)}r.push(t),r.usedMemory=this._cache.getSize(e)+Math.round(t.usedMemory),this._cache.updateSize(e)}},hj=class extends Array{constructor(e){super(),this.item=e,this.usedMemory=e.usedMemory,this.push(e)}},uj=class{constructor(e){this._store=e}destroy(){this._store.destroy()}get(e){return this._store.get(e)}put(e,t){this._store.put(e,t)}};function lle(s,e,t){if(s==null||t==null)return!1;let i=!0;return ci[0]=s.xmin!=null?s.xmin:0,ci[1]=s.ymin!=null?s.ymin:0,ci[2]=s.zmin!=null?s.zmin:0,i=i&&na(ci,s.spatialReference,0,e,t,0),ci[0]=s.xmax!=null?s.xmax:0,ci[1]=s.ymax!=null?s.ymax:0,ci[2]=s.zmax!=null?s.zmax:0,i=i&&na(ci,s.spatialReference,0,e,t,3),s.xmin==null&&(e[0]=-1/0),s.ymin==null&&(e[1]=-1/0),s.zmin==null&&(e[2]=-1/0),s.xmax==null&&(e[3]=1/0),s.ymax==null&&(e[4]=1/0),s.zmax==null&&(e[5]=1/0),i}function dj(s,e,t){if(s==null||t==null)return!1;let i=!0;return ci[0]=s.xmin!=null?s.xmin:0,ci[1]=s.ymin!=null?s.ymin:0,ci[2]=s.zmin!=null?s.zmin:0,i=i&&na(ci,s.spatialReference,0,ci,t,0),e[0]=ci[0],e[1]=ci[1],ci[0]=s.xmax!=null?s.xmax:0,ci[1]=s.ymax!=null?s.ymax:0,ci[2]=s.zmax!=null?s.zmax:0,i=i&&na(ci,s.spatialReference,0,ci,t,0),e[2]=ci[0],e[3]=ci[1],s.xmin==null&&(e[0]=-1/0),s.ymin==null&&(e[1]=-1/0),s.xmax==null&&(e[2]=1/0),s.ymax==null&&(e[3]=1/0),i}const ci=x(),cle={value:.5,readOnly:!0},pj={readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}};let Lh=class{constructor(e=0,t=0){this.min=e,this.max=t,this.level=0,this.hasNoDataValues=!1}copyFrom(e){this.min=e.min,this.max=e.max,this.level=e.level,this.hasNoDataValues=e.hasNoDataValues}},mj=class{constructor(e,t,i){this.type="elevation",this.level=e[0],this.i=e[1],this.j=e[2],this.extent=t,this.samplerData=new B5(i,t)}computeMinMaxValue(e,t,i,r){r.min=1/0,r.max=-1/0,r.hasNoDataValues=!1;const n=e-this.level;if(n<=0)return r;const a=2**n;if(!(Math.floor(t/a)===this.i&&Math.floor(i/a)===this.j))return r;let o=1/0,l=-1/0;const c=this.samplerData.data.width,h=this.samplerData.data.values,d=.5*l1;let m=(c-1)/a,f=(i-this.j*a)*m,g=(t-this.i*a)*m;if(m<1){const _=Math.floor(f),v=Math.floor(g),b=_+v*c,T=h[b],w=h[b+1],S=h[b+c],C=h[b+c+1];if(T+w+S+C<d){const P=f-_,M=g-v,O=lm(T,w,S,C,P,M),D=lm(T,w,S,C,P+m,M),A=lm(T,w,S,C,P,M+m),F=lm(T,w,S,C,P+m,M+m);return r.min=Math.min(O,D,A,F),r.max=Math.max(O,D,A,F),r}f=_,g=v,m=1}else f=Math.floor(f),g=Math.floor(g),m=Math.ceil(m);for(let _=f;_<=f+m;_++)for(let v=g;v<=g+m;v++){const b=h[_+v*c];b<d?(o=Math.min(o,b),l=Math.max(l,b)):r.hasNoDataValues=!0}return r.min=o,r.max=l,r}};const fj=.5*l1;function Ft(s,e,t){if(t==null)return null;for(const i of t){if(!i)continue;const r=i.safeWidth;let n=U(i.dy*(i.y1-e),0,r),a=U(i.dx*(s-i.x0),0,r);const o=Math.floor(n),l=Math.floor(a),c=i.data.width,h=o*c+l,d=i.data.values,m=d[h],f=d[h+1],g=h+c,_=d[g],v=d[g+1];if(m+_+f+v<fj){n-=o,a-=l;const b=m+(f-m)*a;return b+(_+(v-_)*a-b)*n}}return null}function nE(s){return I1(s)||Ow(s)||Dw(s)}function I1(s){return aF(s)||C$(s)}function gj(s,e,t,i){if(s==null)return o1();const r=s.spatialReference;if(r.isGeographic&&!I1(r))return new me("tilingscheme:local-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in local scenes");const n=un.checkUnsupported(s);return n??(t==null?new me("tilingscheme:extent-not-exist","The layer does not provide a layer extent."):_j(s,t)||(e==null||r.equals(e)||e.isWGS84&&r.isWebMercator?null:new me("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the local scene")))}function _j(s,e){const t=s.lods,i=t[0].resolution*2**t[0].level,r=[i*s.size[0],i*s.size[1]],n=[s.origin.x,s.origin.y],a=F$(e),o=Mt();un.computeRowColExtent(a,r,n,o);const l=(o[2]-o[0])*(o[3]-o[1]);if(l>Ch){const c=t[0].scale*2**t[0].level;let h=Math.max((a[3]-a[1])/s.size[1],(a[2]-a[0])/s.size[0])*c/i;const d=Math.floor(Math.log(h)/Math.log(10));return h=Math.ceil(h/10**d)*10**d,new me("tilingscheme:too-many-root-tiles","Scale of level 0 of the tiling scheme (1:"+Math.floor(c).toLocaleString()+") is too large for the layer's extent. Suggested scale: 1:"+h.toLocaleString()+".",{level0Scale:c,suggestedLevel0Scale:h,requiredNumRootTiles:l,allowedNumRootTiles:Ch})}return null}const yj=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:gj},Symbol.toStringTag,{value:"Module"}));function vj(s,e,t,i){if(s==null)return o1();const r=s?.lods.length-1,n=s.spatialReference;if(n.isWebMercator){if(!un.makeWebMercatorAuxiliarySphere(r).compatibleWith(s,i))return new me("tilingscheme:incompatible-global-web-mercator","The tiling scheme is not compatible with the ArcGIS Online Web Mercator tiling scheme")}else{if(!nE(n))return new me("tilingscheme:global-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in global scenes");if(!un.makeGCSWithTileSize(s.spatialReference,s.size[0],r).compatibleWith(s,i))return s.spatialReference.isWGS84?new me("tilingscheme:incompatible-global-wgs84","The tiling scheme is not compatible with the ArcGIS Online WGS84 tiling scheme"):new me("tilingscheme:incompatible-global","The tiling scheme is not compatible with the ArcGIS Online tiling scheme")}return e==null||s.spatialReference.equals(e)?null:new me("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the global scene")}const bj=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:vj},Symbol.toStringTag,{value:"Module"})),wj={1:bj,2:yj};function xi(s,e){s||console.warn("Terrain: "+e)}let _i=!1,u_=!1;function xj(s){u_=s,_i=_i||s}function Cj(s){_i=s}function B(s,e){if(_i&&!s){const t=new Error().stack?.slice(5);throw console.warn("Terrain internal: "+(e??"")+" at "+t),new Error("Assertion failed"+(e?": "+e:""))}}function d_(s){return s?.type==="imagery-tile"||s?.type==="wcs"}function W_(s){return s?.type==="imagery-tile-3d"}function aE(s){return s?.type==="tile-3d"}function lu(s){return s?.type==="vector-tile-3d"}function oE(s){return s?.type==="wmts-3d"}function Fb(s){return s?.type==="elevation-3d"}function Hu(s){return s?.type==="group"}function Rp(s){return s&&(aE(s)||oE(s)||W_(s)||lu(s))}function Vb(s){return s&&(aE(s)||W_(s)||lu(s)||oE(s))}function kb(s){return Vb(s)||Fb(s)}function Tj(s){return eE(s?.sourceLayerInfo?.data)}function Sj(s){return lE(s?.sourceLayerInfo)||!!s?.isVTLBackground}function Pj(s){return tE(s?.sourceLayerInfo?.data)}function Mj(s){const e=s?.sourceLayerInfo?.data;return j_(e)||e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof ImageData}function lE(s){return dh(s?.data)}function qh(s){return s!=null&&"release"in s&&s.release(),null}function dle(s){return s.fetchTile&&s.hasOverriddenFetchTile!==!1}function L1(s,e,t,i,r){return wj[i].checkIfTileInfoSupportedForViewSR(s,t,e,r)}function Q_(s,e,t){let i=null,r=null;if(s?.type==="wmts"){const a=$j(s,e,t);i=a.tileInfo,r=a.fullExtent}else{r=d_(s)?s.getCompatibleFullExtent(e):s.fullExtent;const a=t===2;d_(s)?i=s.getCompatibleTileInfo(e,r,a):s?.type==="vector-tile"?i=a&&!Rj(e)||Oj.force512VTL?s.tileInfo:s.tileInfo.getCompatibleForVTL(256):i=s.tileInfo}const n="tilemapCache"in s?s.tilemapCache?.effectiveMaxLOD:void 0;return i!=null&&r!=null&&L1(i,r,e,t,n)==null?{tileInfo:i,fullExtent:r}:null}function $j(s,e,t){const i=w5(s);if(i!=null){if(!Pt.isCollection(i))return{tileInfo:i.tileInfo,fullExtent:i.fullExtent};{const r=i.find(n=>L1(n.tileInfo,n.fullExtent,e,t)==null);if(r)return{tileInfo:r.tileInfo,fullExtent:r.fullExtent}}}return{tileInfo:null,fullExtent:null}}function Rj(s){return s.isWGS84||s.isWebMercator||C$(s)||!g$(s)}const Oj={force512VTL:!1};function HS(s){return"["+s[0]+","+s[1]+","+s[2]+"]"}function pa(s){return"("+s[0]+","+s[1]+","+s[2]+")"}function Ir(s,e,t=Aj){return Math.abs(s-e)<t}function p_(s){return s===1?5:s===7?3:s===5?1:7}function F1(s){return s===0?4:s===2?6:s===4?0:2}function Dj(s){return s===7||s===5}function Ej(s){return s===7||s===1}function qS(s){return s===7||s===6||s===5}function GS(s){return s===1||s===2||s===3}function jS(s){return s===3||s===4||s===5}function WS(s){return s===1||s===0||s===7}const wn=[0,2,4,6],m_=[1,3,5,7],Aj=1e-5;let Sr=class extends te{constructor(e){super(e)}initialize(){this.addHandles([this.layerViews.on("change",()=>this.notifyChange("stencilEnabledExtents"))])}destroy(){}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents()}_computeStencilEnabledExtents(){const e=[];return this.layerViews.forEach(t=>{const i=t.layer;if(Xh(i)&&this.viewSpatialReference!=null){const r=cE(i.fullExtent,this.viewSpatialReference);r!=null&&e.push(F$(r))}}),e}};function Ij(s,e){return s===1?new zb(e):new Bb(e)}u([p({readOnly:!0})],Sr.prototype,"layerViewsExtent",null),u([p({readOnly:!0})],Sr.prototype,"tiledLayersExtent",null),u([p({readOnly:!0})],Sr.prototype,"stencilEnabledExtents",null),u([p()],Sr.prototype,"viewSpatialReference",void 0),u([p()],Sr.prototype,"tilingScheme",void 0),u([p()],Sr.prototype,"defaultTiledLayersExtent",void 0),u([p({constructOnly:!0})],Sr.prototype,"layers",void 0),u([p({constructOnly:!0})],Sr.prototype,"layerViews",void 0),Sr=u([R("esri.views.3d.terrain.ExtentHelper")],Sr);let zb=class extends Sr{_computeLayerViewsExtent(){return this._globalExtent}_computeTiledLayersExtent(){return this._globalExtent}get _globalExtent(){return this.viewSpatialReference.isWebMercator?mO:Iz}};zb=u([R("esri.views.3d.terrain.ExtentHelper.ExtentHelperGlobal")],zb);let Bb=class extends Sr{_computeLayerViewsExtent(){const e=Fo(),t=this.viewSpatialReference;this.layerViews.forEach(n=>{const a=n.layer;if(n.isResolved()&&(a.type!=="graphics"||!a.internal)){const o=cE("fullExtentInLocalViewSpatialReference"in n&&n.fullExtentInLocalViewSpatialReference||n.layer.fullExtent,t);zh(e,o,e)}});const i=$0(e)?e:null,r=this._get("layerViewsExtent");return ql(i,r)?r:i}_computeTiledLayersExtent(){const e=this.tilingScheme;if(!e)return null;const t=this.viewSpatialReference,i=Fo();this.layers.forEach(a=>{if(a.loaded&&Bh(a)){const o=Q_(a,t,2);if(o==null)return;const{tileInfo:l,fullExtent:c}=o,h="tilemapCache"in a?a.tilemapCache?.effectiveMaxLOD:void 0;l!=null&&c!=null&&(d_(a)||e.compatibleWith(l,h)&&c.spatialReference.equals(e.spatialReference))&&zh(i,c,i)}}),zh(i,this.defaultTiledLayersExtent,i);const r=$0(i)?i:null,n=this._get("tiledLayersExtent");return ql(r,n)?n:r}};function cE(s,e){return s==null||s.spatialReference.equals(e)?s:UF(s,s.spatialReference,e)}Bb=u([R("esri.views.3d.terrain.ExtentHelper.ExtentHelperLocal")],Bb);const mh=[0,1];let Lj=class{constructor(e,t){this.vec3=e,this.id=t}};function f_(s,e,t,i){return new Lj(Qe(s,e,t),i)}let QS=class{constructor(){this._extent=Mt(),this.resolution=0,this.renderLocalOrigin=f_(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new Fj}get extent(){return this._extent}setExtent(e){jl(this._extent,e)}setupGeometryViews(e){if(this._setupGeometryView(),!e)return;const t=.001*e.range;if(this._extent[0]-t<=e.min){const i=this.canvasGeometries.extents[this.canvasGeometries.numViews++];Ag(this._extent,e.range,0,i)}if(this._extent[2]+t>=e.max){const i=this.canvasGeometries.extents[this.canvasGeometries.numViews++];Ag(this._extent,-e.range,0,i)}}_setupGeometryView(){this.canvasGeometries.numViews=1,Up(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const t=this.canvasGeometries.extents[e];if(t[0]!==t[2]&&t[1]!==t[3])return!0}return!1}},Fj=class{constructor(){this.extents=[Mt(),Mt(),Mt()],this.numViews=0}},Vj=class{constructor(e,t,i){this._fbos=e,this._format=t,this._name=i}get valid(){return this._handle?.getTexture()!=null}dispose(){this._handle=Nt(this._handle)}get texture(){return this._handle?.getTexture()}ensureFramebuffer(e,t){this._handle&&this._handle.fbo?.width===e&&this._handle.fbo?.height===t||(this._handle?.release(),this._handle=this._fbos.acquire(e,t,this._name,this._format))}bind(e){e.bindFramebuffer(this._handle?.fbo)}generateMipMap(){this._handle?.getTexture()?.descriptor?.hasMipmap&&this._handle?.getTexture()?.generateMipmap()}},Ic=class{constructor(e,t,i,r,n=1,a=6){this.output=i,this.content=r,this.redrawOnRequest=n,this.fbo=new Vj(e,a,t)}handleRenderRequest(e){return e===1||e===this.redrawOnRequest}get valid(){return this.fbo.valid}},kj=class{constructor(e){this.targets=[new Ic(e,"overlay color",0,0),new Ic(e,"overlay IM color",0,1),new Ic(e,"overlay highlight",9,2,1,3),new Ic(e,"overlay water",3,3,0),new Ic(e,"overlay occluded",0,4)],Io()&&this.targets.push(new Ic(e,"overlay olid",10,5,1,5))}getTexture(e){return this.targets[e]?.fbo.texture}dispose(e){if(e!==0)for(const t of this.targets)t.fbo.dispose();else this.targets[3].fbo.dispose()}computeValidity(){return this.targets.reduce((e,t,i)=>t.valid?e|=1<<i:e,0)}},V1=class extends Xt{constructor(){super(...arguments),this.color=Qe(1,1,1)}};function hE(){const s=new lt;return s.include(qi),s.fragment.uniforms.add(new Be("tex",e=>e.texture),new js("uColor",e=>e.color)),s.fragment.main.add(y`vec4 texColor = texture(tex, uv);
fragColor = texColor * vec4(uColor, 1.0);`),s}const zj=Object.freeze(Object.defineProperty({__proto__:null,TextureOnlyPassParameters:V1,build:hE},Symbol.toStringTag,{value:"Module"}));let ZS=class extends la{constructor(e,t){super(e,"ivec2",1,(i,r,n)=>i.setUniform2iv(e,t(r,n)))}},wu=class extends la{constructor(e,t){super(e,"usampler2D",1,(i,r,n)=>i.bindTexture(e,t(r,n)))}},k1=class extends Xt{};function uE(){const s=new lt,{outputs:e,fragment:t}=s;return s.include(qi),t.uniforms.add(new wu("highlightTexture",i=>i.highlightTexture)),t.constants.add("outlineWidth","int",Math.ceil(Op)),t.constants.add("cellSize","int",Po),e.add("fragGrid","uvec2"),t.main.add(y`ivec2 inputTextureSize = textureSize(highlightTexture, 0);
ivec2 cellBottomLeftCornerInput = ivec2(ivec2(floor(gl_FragCoord.xy) * vec2(cellSize)));
ivec2 coordMid =  cellBottomLeftCornerInput + ivec2(cellSize >> 1);
uvec2 centreTexel = texelFetch(highlightTexture, coordMid, 0).rg & uvec2(0x55u);
float marginSquare = float(outlineWidth*outlineWidth);
uvec2 outputValue = centreTexel & uvec2(0x55u);
for(int y = -outlineWidth; y <= cellSize + outlineWidth; y+=2) {
int dy = y < 0 ? -y : y > cellSize ? y-cellSize : 0;
int xMargin = dy > 0 ? int(ceil(sqrt(marginSquare - float(dy*dy)))) : outlineWidth;
for(int x = -xMargin; x <= cellSize + xMargin; x+=2) {
ivec2 coord = cellBottomLeftCornerInput + ivec2(x, y);
uvec2[4] texels = uvec2[4] (
texelFetch(highlightTexture,coord+ivec2(0,0),0).rg & uvec2(0x55u),
texelFetch(highlightTexture,coord+ivec2(1,0),0).rg & uvec2(0x55u),
texelFetch(highlightTexture,coord+ivec2(0,1),0).rg & uvec2(0x55u),
texelFetch(highlightTexture,coord+ivec2(1,1),0).rg & uvec2(0x55u)
);
if (texels[0] == texels[1] && texels[1] == texels[2] && texels[2] == texels[3] && texels[3] ==  centreTexel) {
continue;
}
for (int i=0; i<4; ++i){
outputValue |= ((texels[i] ^ centreTexel) << 1);
outputValue |= texels[i];
}
}
}
fragGrid = outputValue;`),s}const Po=32,Op=9,z1=.4,Bj=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:k1,blurSize:z1,build:uE,gridCellPixelSize:Po,outlineSize:Op},Symbol.toStringTag,{value:"Module"}));function B1(s){const{vertex:e}=s;e.uniforms.add(new wu("coverageTexture",t=>t.coverageTexture),new ZS("highlightRenderCellCount",t=>Xi(XS,t.horizontalCellCount,t.verticalCellCount)),new ZS("highlightTextureResolution",({highlightTexture:t})=>Xi(XS,t.descriptor.width,t.descriptor.height)),new oc("highlightLevel",t=>t.highlightLevel)).constants.add("cellSize","int",Po),s.varyings.add("sUV","vec2"),s.varyings.add("vOutlinePossible","float"),e.code.add(y`const ivec2 cellVertices[4] = ivec2[4](ivec2(0,0), ivec2(1,0), ivec2(0,1), ivec2(1,1));`),e.main.add(y`int cellIndex = gl_InstanceID;
int cellX = cellIndex % highlightRenderCellCount[0];
int cellY = (cellIndex - cellX) / highlightRenderCellCount[0];
ivec2 cellPos = ivec2(cellX, cellY);
uvec2 covTexel = texelFetch(coverageTexture, cellPos, 0).rg;
int channelIndex = (highlightLevel >> 2) & 3;
uint channelValue = covTexel[channelIndex];
int highlightIndex = (highlightLevel & 3) << 1;
bool covered = ((channelValue >> highlightIndex) & 1u) == 1u;
if (!covered) {
gl_Position = vec4(0.0);
return;
}
vOutlinePossible = (((channelValue >> highlightIndex) & 2u) == 2u) ? 1.0 : 0.0;
ivec2 iPosInCell = cellVertices[gl_VertexID];
vec2 sPos = vec2(cellPos * cellSize + iPosInCell * (cellSize));
vec2 vPos = sPos / vec2(highlightTextureResolution);
sUV = vPos;
gl_Position = vec4(2.0 * vPos - vec2(1.0), 0.0, 1.0);`)}const XS=ke();function dE(){const s=new lt;s.include(B1);const{fragment:e}=s;return e.uniforms.add(new Be("blurInput",t=>t.highlightBlurTexture),new jM("blurSize",t=>t.blurSize),new wu("highlightTexture",t=>t.highlightTexture),new Be("highlightOptionsTexture",t=>t.highlightOptionsTexture),new oc("highlightLevel",t=>t.highlightLevel),new ge("occludedIntensityFactor",t=>t.occludedFactor)),e.constants.add("inner","float",1-(Op-z1)/Op),s.include(WM),e.main.add(y`vec2 highlightTextureSize = vec2(textureSize(highlightTexture,0));
vec2 uv = sUV;
vec2 center = texture(blurInput, uv).rg;
vec2 blurredHighlightValue = (vOutlinePossible == 0.0)
? center
: center * 0.204164
+ texture(blurInput, uv + blurSize * 1.407333).rg * 0.304005
+ texture(blurInput, uv - blurSize * 1.407333).rg * 0.304005
+ texture(blurInput, uv + blurSize * 3.294215).rg * 0.093913
+ texture(blurInput, uv - blurSize * 3.294215).rg * 0.093913;
float highlightIntensity = blurredHighlightValue.r;
float occlusionWeight = blurredHighlightValue.g;
if (highlightIntensity <= 0.01) {
discard;
}
vec4 fillColor    = texelFetch(highlightOptionsTexture, ivec2(highlightLevel, 0), 0);
vec4 outlineColor = texelFetch(highlightOptionsTexture, ivec2(highlightLevel, 1), 0);
uvec2 centerTexel = texelFetch(highlightTexture, ivec2(uv * highlightTextureSize), 0).rg;
uint centerBits = readLevelBits(centerTexel, highlightLevel);
bool centerFilled = (centerBits & 1u) == 1u;
bool centerOccluded = (centerBits & 3u) == 3u;
bool occluded = centerOccluded || (0.5 * highlightIntensity < occlusionWeight);
float occlusionFactor = occluded ? occludedIntensityFactor : 1.0;
float outlineFactor = centerFilled ? 1.0 : smoothstep(0.0, inner, highlightIntensity);
float fillFactor = centerFilled ? 1.0 : 0.0;
vec4 baseColor = mix(outlineColor, fillColor, fillFactor);
float intensity = baseColor.a * occlusionFactor * outlineFactor;
fragColor = vec4(baseColor.rgb, intensity);`),s}const Nj=Object.freeze(Object.defineProperty({__proto__:null,build:dE},Symbol.toStringTag,{value:"Module"}));let YS=class extends ct{constructor(e,t){super(e,t,new ht(Nj,()=>k(()=>Promise.resolve().then(()=>ZJ),void 0)),Ya(S_))}initializePipeline(){return qe({blending:za,colorWrite:nt})}},N1=class extends Xt{constructor(){super(...arguments),this.blurSize=ke()}};function pE(){const s=new lt;return s.include(B1),s.outputs.add("fragHighlight","vec2",0),s.fragment.uniforms.add(new jM("blurSize",e=>e.blurSize),new Jw("blurInput",e=>e.blurInput)).main.add(y`vec2 highlightTextureSize = vec2(textureSize(blurInput,0));
vec2 center = texture(blurInput, sUV).rg;
if (vOutlinePossible == 0.0) {
fragHighlight = center;
} else {
vec2 sum = center * 0.204164;
sum += texture(blurInput, sUV + blurSize * 1.407333).rg * 0.304005;
sum += texture(blurInput, sUV - blurSize * 1.407333).rg * 0.304005;
sum += texture(blurInput, sUV + blurSize * 3.294215).rg * 0.093913;
sum += texture(blurInput, sUV - blurSize * 3.294215).rg * 0.093913;
fragHighlight = sum;
}`),s}const Uj=Object.freeze(Object.defineProperty({__proto__:null,HighlightBlurDrawParameters:N1,build:pE},Symbol.toStringTag,{value:"Module"}));let KS=class extends ct{constructor(e,t){super(e,t,new ht(Uj,()=>k(()=>Promise.resolve().then(()=>XJ),void 0)),Ya(S_))}initializePipeline(){return qe({colorWrite:nt})}},yv=class extends ct{constructor(e,t){super(e,t,new ht(Bj,()=>k(()=>Promise.resolve().then(()=>YJ),void 0)),ri)}initializePipeline(){return qe({colorWrite:nt})}},Hj=class extends Xt{constructor(){super(...arguments),this.occludedFactor=Hk,this.verticalCellCount=0,this.horizontalCellCount=0,this.highlightLevel=0,this.pixelRatio=1}};function mE(){const s=new lt;s.include(B1),s.include(WM);const{fragment:e}=s;return s.outputs.add("fragSingleHighlight","vec2",0),e.uniforms.add(new wu("highlightTexture",t=>t.highlightTexture),new oc("highlightLevel",t=>t.highlightLevel)),e.main.add(y`ivec2 iuv = ivec2(gl_FragCoord.xy);
uvec2 inputTexel = texelFetch(highlightTexture, iuv, 0).rg;
uint bits = readLevelBits(inputTexel, highlightLevel);
bool hasHighlight = (bits & 1u) == 1u;
bool hasOccluded  = (bits & 2u) == 2u;
fragSingleHighlight = vec2(hasHighlight ? 1.0 : 0.0, hasOccluded ? 1.0 : 0.0);`),s}const qj=Object.freeze(Object.defineProperty({__proto__:null,build:mE},Symbol.toStringTag,{value:"Module"}));let JS=class extends ct{constructor(e,t){super(e,t,new ht(qj,()=>k(()=>Promise.resolve().then(()=>KJ),void 0)),Ya(S_))}initializePipeline(){return qe({colorWrite:nt})}},Td=class extends Ho{constructor(){super(...arguments),this.produces=ne.HIGHLIGHTS,this.consumes={required:[ne.HIGHLIGHTS,"highlights"]},this._downsampleDrawParameters=new k1,this._passParameters=new Hj,this._highlightBlurDrawParameters=new N1,this._grid=new Gj}initialize(){this.addHandles([$(()=>this._updateOptionsTexture(),()=>{},Re)])}destroy(){this._grid.coverage=Nt(this._grid.coverage),this._grid.vao=_e(this._grid.vao),this._passParameters.highlightOptionsTexture=Nt(this._passParameters.highlightOptionsTexture)}_updateOptionsTexture(){if(this._passParameters.highlightOptionsTexture==null){const e=new ft(16,2);e.internalFormat=6408,e.samplingMode=9728,this._passParameters.highlightOptionsTexture=new bt(this.renderingContext,e,null)}this._passParameters.highlightOptionsTexture.setData(jj(this.view.state.highlights)),this.requestRender(1)}precompile(){this.techniques.precompile(yv),this.techniques.precompile(JS),this.techniques.precompile(KS),this.techniques.precompile(YS)}render(e){const t=e.find(({name:a})=>a===ne.HIGHLIGHTS),{techniques:i,bindParameters:r}=this;if(!r.decorations)return t;if(!i.get(yv).compiled)return this.requestRender(1),t;const n=e.find(({name:a})=>a==="highlights").getTexture();return this._renderHighlightPostprocess(n,t),t}_prepareAndDownSample(e){this._gridUpdateResources(e);const t=this.techniques.get(yv),i=this._gridComputeCoverage(t,e),{horizontalCellCount:r,verticalCellCount:n}=i,a=this._passParameters;return a.horizontalCellCount=r,a.verticalCellCount=n,a.coverageTexture=i.coverage?.getTexture(),i}_renderGrid(e){const t=e.verticalCellCount*e.horizontalCellCount;this.renderingContext.bindVAO(e.vao),this.renderingContext.drawElementsInstanced(Ct.TRIANGLES,6,Cn.UNSIGNED_BYTE,0,t)}_renderHighlightPostprocess(e,t){const{fboCache:i,techniques:r,bindParameters:n,_passParameters:a,renderingContext:o}=this,l=r.get(JS),c=r.get(KS),h=r.get(YS);if(!h.compiled||!c.compiled||!l.compiled)return void this.requestRender(1);a.highlightTexture=e;const d=this._prepareAndDownSample(e),{width:m,height:f}=e.descriptor;a.highlightTexture=e;const{camera:g}=n,{fullWidth:_,fullHeight:v,pixelRatio:b,fullViewport:T}=g,w=Math.ceil(_/b),S=Math.ceil(v/b),{_highlightBlurDrawParameters:C}=this,P=this.view.stage.renderView.renderer,{highlights:M}=n;for(let O=0;O<M.length;++O){const{name:D}=M[O];if(!P.hasHighlight(D))continue;a.highlightLevel=O,o.setClearColor(0,0,0,0);const A=i.acquire(m,f,"single highlight",2);o.bindFramebuffer(A.fbo),o.setViewport(0,0,m,f),o.clear(16384),o.bindTechnique(l,n,a),this._renderGrid(d),C.blurInput=A.getTexture(),Xi(C.blurSize,1/w,0);const F=i.acquire(w,S,"single highlight blur",2);o.unbindTexture(F.fbo?.colorTexture),o.bindFramebuffer(F.fbo),o.setViewport(0,0,w,S),o.clear(16384),o.bindTechnique(c,n,a,C),this._renderGrid(d),A.release(),Xi(C.blurSize,0,1/S),a.highlightBlurTexture=F.getTexture(),o.bindFramebuffer(t.fbo),o.setViewport4fv(T),o.bindTechnique(h,n,a,C),this._renderGrid(d),F.release()}a.coverageTexture=a.highlightTexture=null}_gridUpdateResources(e){const t=this._grid,{width:i,height:r}=e.descriptor;if(t.horizontalCellCount=Math.ceil(i/Po),t.verticalCellCount=Math.ceil(r/Po),t.vao)return;const n=this.renderingContext,a=Nr.createIndex(n,35044,Zj);t.vao=new Mn(n,new Kt(n,S_),a)}_gridComputeCoverage(e,t){const i=this.renderingContext,r=this._grid,n=t.descriptor,a=Math.ceil(n.width/Po),o=Math.ceil(n.height/Po);this._downsampleDrawParameters.input=t;const{highlights:l}=this.bindParameters;r.coverage?.release();const c=this.fboCache.acquire(a,o,"highlight coverage",l.length>U1?3:1);return r.coverage=c,i.bindFramebuffer(c.fbo),i.bindTechnique(e,this.bindParameters,this._passParameters,this._downsampleDrawParameters),i.setViewport(0,0,a,o),i.screen.draw(),r}get test(){}};u([p()],Td.prototype,"produces",void 0),u([p()],Td.prototype,"consumes",void 0),Td=u([R("esri.views.3d.webgl-engine.effects.highlight.Highlight")],Td);let Gj=class{constructor(){this.coverage=null,this.vao=null,this.verticalCellCount=0,this.horizontalCellCount=0,this.viewportWidth=0,this.viewportHeight=0}};function jj(s){const e=new Uint8Array(128);let t=0;for(const i of s){const r=4*t,n=4*t+64;++t;const{color:a}=i,o=i.haloColor??a;e[r+0]=a.r,e[r+1]=a.g,e[r+2]=a.b,e[r+3]=i.fillOpacity*a.a*255,e[n+0]=o.r,e[n+1]=o.g,e[n+2]=o.b,e[n+3]=i.haloOpacity*o.a*255}return e}let Wj=0;function Qj(s){let e=0;for(const i of s){const{name:r}=i;e+=r.length;const{color:n,fillOpacity:a,haloColor:o,haloOpacity:l}=i;e+=n.r+n.g+n.b+n.a+a,e+=o?o.r+o.g+o.b+o.a+l:0}const t=s.at(0);if(t){const{shadowOpacity:i,shadowDifference:r,shadowColor:n}=t;e+=i+r+n.r+n.g+n.b+n.a}return Wj+++(e>=0?0:1)}const Zj=new Uint8Array([0,1,2,2,1,3]);function fE(s,e,t,i,r,n=0){const{highlights:a}=i,o=a.length>1?e.acquire(t.width,t.height,"highlight mix",a.length>U1?3:1):null,{gl:l}=s;if(o){const h=s.getBoundFramebufferObject();s.bindFramebuffer(o.fbo),l.clearBufferuiv(l.COLOR,0,[0,0,0,0]),s.bindFramebuffer(h)}const c=o?.getTexture();i.highlightMixTexture=c,Xi(i.highlightMixOrigin,n,0),a.forEach((h,d)=>{if(d>0){const m=bt.TEXTURE_UNIT_FOR_UPDATES;s.bindTexture(c,m),s.setActiveTexture(m),l.copyTexSubImage2D(3553,0,0,0,n,0,t.width,t.height),s.bindTexture(null,m)}s.clear(256),i.highlightLevel=d,r()}),i.highlightLevel=null,i.highlightMixTexture=null,o?.release()}const U1=4;let Xj=class{constructor(e,t,i,r){this.material=e,this.output=t,this.techniques=i,this.textures=r}},gE=class{constructor(e,t,i,r){this._textures=e,this._techniques=t,this.materialChanged=i,this.requestRender=r,this._id2glMaterialRef=new qa}dispose(){this._textures.destroy()}acquire(e,t,i){if(this._ownMaterial(e),!e.produces.get(t)?.(i))return null;let n=this._id2glMaterialRef.get(i,e.id);if(n==null){const a=e.createGLMaterial(new Xj(e,i,this._techniques,this._textures));n=new Yj(a),this._id2glMaterialRef.set(i,e.id,n)}return n.ref(),n.glMaterial}release(e,t){const i=this._id2glMaterialRef.get(t,e.id);i!=null&&(i.unref(),i.referenced||(_e(i.glMaterial),this._id2glMaterialRef.delete(t,e.id)))}_ownMaterial(e){e.repository&&e.repository!==this&&j.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),e.repository=this}},Yj=class{constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,Wt(this._refCnt>=0)}get referenced(){return this._refCnt>0}};const e2=8;function Kj(s,e){const{vertex:t,attributes:i}=s;t.uniforms.add(new ge("intrinsicWidth",a=>a.width));const{hasScreenSizePerspective:r,spherical:n}=e;r?(s.include(KI,e),JI(t),Cw(t,e),t.uniforms.add(new QM("inverseViewMatrix",(a,o)=>eu(t2,rc(t2,o.camera.viewMatrix,a.origin)))),t.code.add(y`
      float applyLineSizeScreenSizePerspective(float size, vec3 pos) {
        vec3 worldPos = (inverseViewMatrix * vec4(pos, 1)).xyz;
        vec3 groundUp = ${n?y`normalize(worldPos + localOrigin)`:y`vec3(0.0, 0.0, 1.0)`};
        float absCosAngle = abs(dot(groundUp, normalize(worldPos - cameraPosition)));

        return screenSizePerspectiveScaleFloat(size, absCosAngle, length(pos), screenSizePerspective);
      }
    `)):t.code.add(y`float applyLineSizeScreenSizePerspective(float size, vec3 pos) {
return size;
}`),e.hasVVSize?(i.add("sizeFeatureAttribute","float"),t.uniforms.add(new js("vvSizeMinSize",a=>a.vvSize.minSize),new js("vvSizeMaxSize",a=>a.vvSize.maxSize),new js("vvSizeOffset",a=>a.vvSize.offset),new js("vvSizeFactor",a=>a.vvSize.factor),new js("vvSizeFallback",a=>a.vvSize.fallback)),t.code.add(y`
    float getSize(${X(r,"vec3 pos")}) {
      float size = isnan(sizeFeatureAttribute)
        ? vvSizeFallback.x
        : intrinsicWidth * clamp(vvSizeOffset + sizeFeatureAttribute * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).x;

      return ${X(r,"applyLineSizeScreenSizePerspective(size, pos)","size")};
    }
    `)):(i.add("size","float"),t.code.add(y`
    float getSize(${X(r,"vec3 pos")}) {
      float fullSize = intrinsicWidth * size;
      return ${X(r,"applyLineSizeScreenSizePerspective(fullSize, pos)","fullSize")};
    }
    `)),e.hasVVOpacity?(i.add("opacityFeatureAttribute","float"),t.constants.add("vvOpacityNumber","int",8),t.uniforms.add(new cr("vvOpacityValues",a=>a.vvOpacity.values,e2),new cr("vvOpacityOpacities",a=>a.vvOpacity.opacityValues,e2),new ge("vvOpacityFallback",a=>a.vvOpacity.fallback,{supportsNaN:!0})),t.code.add(y`
    float interpolateOpacity(float value) {
      if (value <= vvOpacityValues[0]) {
        return vvOpacityOpacities[0];
      }

      for (int i = 1; i < vvOpacityNumber; ++i) {
        if (vvOpacityValues[i] >= value) {
          float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
          return mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f);
        }
      }

      return vvOpacityOpacities[vvOpacityNumber - 1];
    }

    vec4 applyOpacity(vec4 color) {
      if (isnan(opacityFeatureAttribute)) {
        // If there is a color vv then it will already have taken care of applying the fallback
        return ${X(e.hasVVColor,"color","vec4(color.rgb, vvOpacityFallback)")};
      }

      return vec4(color.rgb, interpolateOpacity(opacityFeatureAttribute));
    }
    `)):t.code.add(y`vec4 applyOpacity(vec4 color) {
return color;
}`),e.hasVVColor?(s.include(eL,e),i.add("colorFeatureAttribute","float"),t.code.add(y`vec4 getColor() {
vec4 color = interpolateVVColor(colorFeatureAttribute);
if (isnan(color.r)) {
return vec4(0);
}
return applyOpacity(color);
}`)):(i.add("color","vec4"),t.code.add(y`vec4 getColor() {
return applyOpacity(color);
}`))}const t2=Ie();function Jj(s){s.vertex.code.add("#define noPerspectiveWrite(x, w) (x * w)")}function Nb(s){s.fragment.code.add("#define noPerspectiveRead(x) (x * gl_FragCoord.w)")}let _E=class{constructor(e,t,i){this._createTexture=e,this._parametersKey=t,this._repository=new Map,this._orphanCache=i.newCache(`procedural-texture-repository:${hu()}`,r=>r.dispose())}destroy(){for(const{texture:e}of this._repository.values())e.dispose();this._repository.clear(),this._orphanCache.destroy()}swap(e,t=null){const i=this._acquire(e);return this.release(t),i}release(e){if(e==null)return;const t=this._parametersKey(e),i=this._repository.get(t);if(i&&(i.refCount--,i.refCount===0)){this._repository.delete(t);const{texture:r}=i;this._orphanCache.put(t,r)}}_acquire(e){if(e==null)return null;const t=this._parametersKey(e),i=this._repository.get(t);if(i)return i.refCount++,i.texture;const r=this._orphanCache.pop(t)??this._createTexture(e),n=new e8(r);return this._repository.set(t,n),r}},e8=class{constructor(e){this.texture=e,this.refCount=1}};function t8(s,e){return new _E(t=>{const{data:i,textureSize:r}=i8(t),n=new ft(r,1);return n.dataType=si.FLOAT,n.pixelFormat=6403,n.internalFormat=Es.R16F,n.wrapMode=10497,new bt(s,n,i)},t=>`${t.pattern.join(",")}-r${t.pixelRatio}`,e)}function i8(s){const e=yE(s),t=1/s.pixelRatio,i=vE(s),r=[];let n=1;for(const o of e){for(let l=0;l<o;l++){const c=n*(Math.min(l,o-1-l)+.5)*t;r.push(c)}n=-n}const a=Math.round(e[0]/2);return{data:new Float32Array([...r.slice(a),...r.slice(0,a)]),textureSize:i}}function yE(s){return s.pattern.map(e=>Math.round(e*s.pixelRatio))}function vE(s){if(s==null)return 1;const e=yE(s);return Math.floor(e.reduce((t,i)=>t+i))}function s8(s){return s==null?hi:s.length===4?s:os(r8,s[0],s[1],s[2],1)}const r8=Lt();function n8(s,e){if(!e.stippleEnabled)return void s.fragment.code.add(y`float getStippleAlpha(float lineWidth) { return 1.0; }
void discardByStippleAlpha(float stippleAlpha, float threshold) {}
vec4 blendStipple(vec4 color, float stippleAlpha) { return color; }`);const t=!(e.draped&&e.stipplePreferContinuous),{vertex:i,fragment:r}=s;e.draped||(Cw(i,e),i.uniforms.add(new Rs("worldToScreenPerDistanceRatio",({camera:n})=>1/n.perScreenPixelRatio)).code.add(y`float computeWorldToScreenRatio(vec3 segmentCenter) {
float segmentDistanceToCamera = length(segmentCenter - cameraPosition);
return worldToScreenPerDistanceRatio / segmentDistanceToCamera;
}`)),s.varyings.add("vStippleDistance","float"),s.varyings.add("vStippleDistanceLimits","vec2"),s.varyings.add("vStipplePatternStretch","float"),i.code.add(y`
    float discretizeWorldToScreenRatio(float worldToScreenRatio) {
      float step = ${y.float(a8)};

      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);
      return discreteWorldToScreenRatio;
    }
  `),Tw(i),i.code.add(y`
    vec2 computeStippleDistanceLimits(float startPseudoScreen, float segmentLengthPseudoScreen, float segmentLengthScreen, float patternLength) {

      // First check if the segment is long enough to support fully screen space patterns.
      // Force sparse mode for segments that are very large in screen space even if it is not allowed,
      // to avoid imprecision from calculating with large floats.
      if (segmentLengthPseudoScreen >= ${t?"patternLength":"1e4"}) {
        // Round the screen length to get an integer number of pattern repetitions (minimum 1).
        float repetitions = segmentLengthScreen / (patternLength * pixelRatio);
        float flooredRepetitions = max(1.0, floor(repetitions + 0.5));
        float segmentLengthScreenRounded = flooredRepetitions * patternLength;

        float stretch = repetitions / flooredRepetitions;

        // We need to impose a lower bound on the stretch factor to prevent the dots from merging together when there is only 1 repetition.
        // 0.75 is the lowest possible stretch value for flooredRepetitions > 1, so it makes sense as lower bound.
        vStipplePatternStretch = max(0.75, stretch);

        return vec2(0.0, segmentLengthScreenRounded);
      }
      return vec2(startPseudoScreen, startPseudoScreen + segmentLengthPseudoScreen);
    }
  `),r.uniforms.add(new Be("stipplePatternTexture",n=>n.stippleTexture),new ge("stipplePatternPixelSizeInv",n=>1/bE(n))),e.stippleOffColorEnabled&&r.uniforms.add(new qs("stippleOffColor",n=>s8(n.stippleOffColor))),s.include(Nb),r.code.add(y`float getStippleSDF(out bool isClamped) {
float stippleDistanceClamped = noPerspectiveRead(clamp(vStippleDistance, vStippleDistanceLimits.x, vStippleDistanceLimits.y));
float lineSizeInv = noPerspectiveRead(vLineSizeInv);
vec2 aaCorrectedLimits = vStippleDistanceLimits + vec2(1.0, -1.0) / gl_FragCoord.w;
isClamped = vStippleDistance < aaCorrectedLimits.x || vStippleDistance > aaCorrectedLimits.y;
float u = stippleDistanceClamped * stipplePatternPixelSizeInv * lineSizeInv;
u = fract(u);
float sdf = texture(stipplePatternTexture, vec2(u, 0.5)).r;
return (sdf - 0.5) * vStipplePatternStretch + 0.5;
}
float getStippleSDF() {
bool ignored;
return getStippleSDF(ignored);
}
float getStippleAlpha(float lineWidth) {
bool isClamped;
float stippleSDF = getStippleSDF(isClamped);
float antiAliasedResult = clamp(stippleSDF * lineWidth + 0.5, 0.0, 1.0);
return isClamped ? floor(antiAliasedResult + 0.5) : antiAliasedResult;
}`),r.code.add(y`
    void discardByStippleAlpha(float stippleAlpha, float threshold) {
     ${X(!e.stippleOffColorEnabled,"if (stippleAlpha < threshold) { discard; }")}
    }

    vec4 blendStipple(vec4 color, float stippleAlpha) {
      return ${e.stippleOffColorEnabled?"mix(color, stippleOffColor, stippleAlpha)":"vec4(color.rgb, color.a * stippleAlpha)"};
    }
  `)}function bE(s){const e=s.stipplePattern;return e?vE(s.stipplePattern)/e.pixelRatio:1}const a8=.4,g_=64,wE=g_/2,xE=wE/5,o8=g_/xE,zle=.25;function l8(s,e){const t=d5(s,g_,wE,xE),i=new ft(g_);return i.internalFormat=Es.R16F,i.dataType=si.FLOAT,i.pixelFormat=6403,i.wrapMode=33071,new bt(e,i,t)}function c8(s,e){const t=s.vertex,i=e.hasScreenSizePerspective;Tw(t),t.uniforms.get("markerScale")==null&&t.constants.add("markerScale","float",1),t.constants.add("markerSizePerLineWidth","float",o8).code.add(y`
  float getLineWidth(${X(i,"vec3 pos")}) {
     return max(getSize(${X(i,"pos")}), 1.0) * pixelRatio;
  }

  float getScreenMarkerSize(float lineWidth) {
    return markerScale * markerSizePerLineWidth * lineWidth;
  }
  `),e.space===2&&(t.constants.add("maxSegmentLengthFraction","float",.45),t.uniforms.add(new Rs("perRenderPixelRatio",r=>r.camera.perRenderPixelRatio)),t.code.add(y`
  bool areWorldMarkersHidden(vec3 pos, vec3 other) {
    vec3 midPoint = mix(pos, other, 0.5);
    float distanceToCamera = length(midPoint);
    float screenToWorldRatio = perRenderPixelRatio * distanceToCamera * 0.5;
    float worldMarkerSize = getScreenMarkerSize(getLineWidth(${X(i,"pos")})) * screenToWorldRatio;
    float segmentLen = length(pos - other);
    return worldMarkerSize > maxSegmentLengthFraction * segmentLen;
  }

  float getWorldMarkerSize(vec3 pos) {
    float distanceToCamera = length(pos);
    float screenToWorldRatio = perRenderPixelRatio * distanceToCamera * 0.5;
    return getScreenMarkerSize(getLineWidth(${X(i,"pos")})) * screenToWorldRatio;
  }
  `))}function h8(s,e){if(!e.hasAnimation)return;const{attributes:t,varyings:i,vertex:r,fragment:n}=s;t.add("timeStamps","vec4"),i.add("vTimeStamp","float"),i.add("vFirstTime","float"),i.add("vLastTime","float"),i.add("vTransitionType","float"),r.main.add(y`vTimeStamp = timeStamps.x;
vFirstTime = timeStamps.y;
vLastTime = timeStamps.z;
vTransitionType = timeStamps.w;`);const{animation:a}=e;a===3&&n.constants.add("decayRate","float",2.3),n.code.add(y`
    float getTrailOpacity(float x) {
      ${u8(a)}
    }`),n.uniforms.add(new ge("timeElapsed",o=>o.timeElapsed),new ge("trailLength",o=>o.trailLength),new ge("speed",o=>o.animationSpeed),new qs("timingOptions",o=>os(d8,o.startTime,o.endTime,o.fadeInTime,o.fadeOutTime))),n.code.add(y`float fadeIn(float x) {
return smoothstep(0.0, timingOptions[2], x);
}
float fadeOut(float x) {
return isinf(timingOptions[3]) ? 1.0 : smoothstep(timingOptions[3], 0.0, x);
}`),n.code.add(y`vec4 animate(vec4 color) {
float startTime = timingOptions[0];
float endTime = timingOptions[1];
float totalTime = vLastTime - vFirstTime;
float actualEndTime = int(vTransitionType) == 2 ? min(endTime, startTime + vLastTime / speed) : endTime;
vec4 animatedColor = color;
if (speed == 0.0) {
animatedColor.a *= getTrailOpacity((totalTime - (vTimeStamp - vFirstTime)) / trailLength);
animatedColor.a *= isinf(actualEndTime) ? 1.0 : fadeOut(timeElapsed - actualEndTime);
animatedColor.a *= fadeIn(timeElapsed - startTime);
return animatedColor;
}
float relativeStartTime = mod(startTime, totalTime);
float vHeadRelativeToFirst = mod((timeElapsed - relativeStartTime) * speed - vFirstTime, totalTime);
float vRelativeToHead = vHeadRelativeToFirst + vFirstTime - vTimeStamp;
bool inPreviousCycle = vRelativeToHead < 0.0;
vRelativeToHead += inPreviousCycle ? totalTime : 0.0;
float vAbsoluteTime = timeElapsed - vRelativeToHead / speed;
if (vAbsoluteTime > actualEndTime) {
vRelativeToHead = (timeElapsed - relativeStartTime) * speed - vTimeStamp;
vAbsoluteTime = timeElapsed - vRelativeToHead / speed;
}
animatedColor *= step(startTime, vAbsoluteTime);
animatedColor *= step(vAbsoluteTime, actualEndTime);
animatedColor.a *= isinf(actualEndTime) ? 1.0 : fadeOut(timeElapsed - actualEndTime);
animatedColor.a *= inPreviousCycle ? fadeOut(vHeadRelativeToFirst / speed) : 1.0;
animatedColor.a *= getTrailOpacity(vRelativeToHead / trailLength);
animatedColor.a *= int(vTransitionType) == 0 ? fadeIn(vAbsoluteTime - startTime) : 1.0;
animatedColor.a *= fadeIn(vTimeStamp - vFirstTime);
return animatedColor;
}`)}function u8(s){switch(s){case 2:return"return x >= 0.0 && x <= 1.0 ? 1.0 : 0.0;";case 3:return`float cutOff = exp(-decayRate);
        return (exp(-decayRate * x) - cutOff) / (1.0 - cutOff);`;default:return"return 1.0;"}}const d8=Lt(),Dp=1;function CE(s){const e=new lt,{attributes:t,varyings:i,vertex:r,fragment:n}=e,{applyMarkerOffset:a,draped:o,output:l,capType:c,stippleEnabled:h,falloffEnabled:d,roundJoins:m,wireframe:f,innerColorEnabled:g,hasAnimation:_,hasScreenSizePerspective:v}=s;n.include(ZM),e.include(Kj,s),e.include(n8,s),e.include(tL,s),e.include(XM,s),e.include(h8,s);const b=a&&!o;b&&(r.uniforms.add(new ge("markerScale",M=>M.markerScale)),e.include(c8,{space:2,hasScreenSizePerspective:v})),YM(r,s),r.uniforms.add(new ur("inverseProjectionMatrix",M=>M.camera.inverseProjectionMatrix),new ap("nearFar",M=>M.camera.nearFar),new ge("miterLimit",M=>M.join!=="miter"?0:M.miterLimit),new C_("viewport",M=>M.camera.fullViewport)),r.constants.add("LARGE_HALF_FLOAT","float",65500),t.add("position","vec3"),t.add("previousDelta","vec4"),t.add("nextDelta","vec4"),t.add("lineParameters","vec2"),t.add("u0","float"),i.add("vColor","vec4"),i.add("vpos","vec3",{invariant:!0}),i.add("vLineDistance","float"),i.add("vLineWidth","float");const T=h;T&&i.add("vLineSizeInv","float");const w=c===2,S=h&&w,C=d||S;C&&i.add("vLineDistanceNorm","float"),w&&(i.add("vSegmentSDF","float"),i.add("vReverseSegmentSDF","float")),r.code.add(y`vec2 perpendicular(vec2 v) {
return vec2(v.y, -v.x);
}
float interp(float ncp, vec4 a, vec4 b) {
return (-ncp - a.z) / (b.z - a.z);
}
vec2 rotate(vec2 v, float a) {
float s = sin(a);
float c = cos(a);
mat2 m = mat2(c, -s, s, c);
return m * v;
}`),r.code.add(y`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= viewport.zw / posNdc.w;
return posNdc;
}`),r.code.add(y`void clip(
inout vec4 pos,
inout vec4 prev,
inout vec4 next,
bool isStartVertex
) {
float vnp = nearFar[0] * 0.99;
if (pos.z > -nearFar[0]) {
if (!isStartVertex) {
if (prev.z < -nearFar[0]) {
pos = mix(prev, pos, interp(vnp, prev, pos));
next = pos;
} else {
pos = vec4(0.0, 0.0, 0.0, 1.0);
}
} else {
if (next.z < -nearFar[0]) {
pos = mix(pos, next, interp(vnp, pos, next));
prev = pos;
} else {
pos = vec4(0.0, 0.0, 0.0, 1.0);
}
}
} else {
if (prev.z > -nearFar[0]) {
prev = mix(pos, prev, interp(vnp, pos, prev));
}
if (next.z > -nearFar[0]) {
next = mix(next, pos, interp(vnp, next, pos));
}
}
}`),Tw(r),r.constants.add("aaWidth","float",h?0:1).main.add(y`bool isStartVertex = abs(abs(lineParameters.y) - 3.0) == 1.0;
vec3 prevPosition = position + previousDelta.xyz * previousDelta.w;
vec3 nextPosition = position + nextDelta.xyz * nextDelta.w;
float coverage = 1.0;
if (lineParameters.y == 0.0) {
gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
}
else {
vec4 pos  = view * vec4(position, 1.0);
vec4 prev = view * vec4(prevPosition, 1.0);
vec4 next = view * vec4(nextPosition, 1.0);
bool isJoin = abs(lineParameters.y) < 3.0;`),b&&r.main.add(y`vec4 other = isStartVertex ? next : prev;
bool markersHidden = areWorldMarkersHidden(pos.xyz, other.xyz);
if (!isJoin && !markersHidden) {
pos.xyz += normalize(other.xyz - pos.xyz) * getWorldMarkerSize(pos.xyz) * 0.5;
}`),e.include(Jj),r.main.add(y`
      clip(pos, prev, next, isStartVertex);

      vec3 clippedPos = pos.xyz;
      vec3 clippedCenter = mix(pos.xyz, isStartVertex ? next.xyz : prev.xyz, 0.5);

      forwardViewPosDepth(pos.xyz);

      pos = projectAndScale(pos);
      next = projectAndScale(next);
      prev = projectAndScale(prev);

      vec2 left = (pos.xy - prev.xy);
      vec2 right = (next.xy - pos.xy);

      float leftLen = length(left);
      float rightLen = length(right);

      float lineSize = getSize(${X(v,"clippedPos")});
      ${X(h&&v,"float patternLineSize = getSize(clippedCenter);")}
      ${X(h&&!v,"float patternLineSize = lineSize;")}

      if (lineSize < 1.0) {
        coverage = lineSize; // convert sub-pixel coverage to alpha
        lineSize = 1.0;
      }
      lineSize += aaWidth;

      float lineWidth = lineSize * pixelRatio;
      vLineWidth = noPerspectiveWrite(lineWidth, pos.w);
      ${T?y`vLineSizeInv = noPerspectiveWrite(1.0 / lineSize, pos.w);`:""}
  `),(h||w)&&r.main.add(y`
      float isEndVertex = float(!isStartVertex);
      vec2 segmentOrigin = mix(pos.xy, prev.xy, isEndVertex);
      vec2 segment = mix(right, left, isEndVertex);
      ${w?y`vec2 segmentEnd = mix(next.xy, pos.xy, isEndVertex);`:""}
    `),r.main.add(y`left = (leftLen > 0.001) ? left/leftLen : vec2(0.0, 0.0);
right = (rightLen > 0.001) ? right/rightLen : vec2(0.0, 0.0);
vec2 capDisplacementDir = vec2(0, 0);
vec2 joinDisplacementDir = vec2(0, 0);
float displacementLen = lineWidth;
if (isJoin) {
bool isOutside = (left.x * right.y - left.y * right.x) * lineParameters.y > 0.0;
joinDisplacementDir = normalize(left + right);
joinDisplacementDir = perpendicular(joinDisplacementDir);
if (leftLen > 0.001 && rightLen > 0.001) {
float nDotSeg = dot(joinDisplacementDir, left);
displacementLen /= length(nDotSeg * left - joinDisplacementDir);
if (!isOutside) {
displacementLen = min(displacementLen, min(leftLen, rightLen)/abs(nDotSeg));
}
}
float subdivisionFactor = lineParameters.x;
if (isOutside && (displacementLen > miterLimit * lineWidth)) {`),m?r.main.add(y`
        vec2 startDir = leftLen < 0.001 ? right : left;
        startDir = perpendicular(startDir);

        vec2 endDir = rightLen < 0.001 ? left : right;
        endDir = perpendicular(endDir);

        float factor = ${h?y`min(1.0, subdivisionFactor * ${y.float((Dp+2)/(Dp+1))})`:y`subdivisionFactor`};

        float rotationAngle = acos(clamp(dot(startDir, endDir), -1.0, 1.0));
        joinDisplacementDir = rotate(startDir, -sign(lineParameters.y) * factor * rotationAngle);
      `):r.main.add(y`if (leftLen < 0.001) {
joinDisplacementDir = right;
}
else if (rightLen < 0.001) {
joinDisplacementDir = left;
}
else {
joinDisplacementDir = (isStartVertex || subdivisionFactor > 0.0) ? right : left;
}
joinDisplacementDir = perpendicular(joinDisplacementDir);`);const P=c!==0;return r.main.add(y`
        displacementLen = lineWidth;
      }
    } else {
      // CAP handling ---------------------------------------------------
      joinDisplacementDir = isStartVertex ? right : left;
      joinDisplacementDir = perpendicular(joinDisplacementDir);

      ${P?y`capDisplacementDir = isStartVertex ? -right : left;`:""}
    }
  `),r.main.add(y`
    // Displacement (in pixels) caused by join/or cap
    vec2 dpos = joinDisplacementDir * sign(lineParameters.y) * displacementLen + capDisplacementDir * displacementLen;
    float lineDistNorm = noPerspectiveWrite(sign(lineParameters.y), pos.w);

    vLineDistance = lineWidth * lineDistNorm;
    ${C?y`vLineDistanceNorm = lineDistNorm;`:""}

    pos.xy += dpos;
  `),w&&r.main.add(y`vec2 segmentDir = normalize(segment);
vSegmentSDF = noPerspectiveWrite((isJoin && isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentOrigin, segmentDir)), pos.w);
vReverseSegmentSDF = noPerspectiveWrite((isJoin && !isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentEnd, -segmentDir)), pos.w);`),h&&(o?r.uniforms.add(new Rs("worldToScreenRatio",M=>1/M.screenToPCSRatio)):r.main.add(y`vec3 segmentCenter = mix((nextPosition + position) * 0.5, (position + prevPosition) * 0.5, isEndVertex);
float worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);`),r.main.add(y`float segmentLengthScreenDouble = length(segment);
float segmentLengthScreen = segmentLengthScreenDouble * 0.5;
float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);
float segmentLengthRender = length(mix(nextPosition - position, position - prevPosition, isEndVertex));
vStipplePatternStretch = worldToScreenRatio / discreteWorldToScreenRatio;`),o?r.main.add(y`float segmentLengthPseudoScreen = segmentLengthScreen / pixelRatio * discreteWorldToScreenRatio / worldToScreenRatio;
float startPseudoScreen = u0 * discreteWorldToScreenRatio - mix(0.0, segmentLengthPseudoScreen, isEndVertex);`):r.main.add(y`float startPseudoScreen = mix(u0, u0 - segmentLengthRender, isEndVertex) * discreteWorldToScreenRatio;
float segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;`),r.uniforms.add(new ge("stipplePatternPixelSize",M=>bE(M))),r.main.add(y`float patternLength = patternLineSize * stipplePatternPixelSize;
vStippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, segmentLengthScreen, patternLength);
vStippleDistance = mix(vStippleDistanceLimits.x, vStippleDistanceLimits.y, isEndVertex);
if (segmentLengthScreenDouble >= 0.001) {
vec2 stippleDisplacement = pos.xy - segmentOrigin;
float stippleDisplacementFactor = dot(segment, stippleDisplacement) / (segmentLengthScreenDouble * segmentLengthScreenDouble);
vStippleDistance += (stippleDisplacementFactor - isEndVertex) * (vStippleDistanceLimits.y - vStippleDistanceLimits.x);
}
vStippleDistanceLimits = noPerspectiveWrite(vStippleDistanceLimits, pos.w);
vStippleDistance = noPerspectiveWrite(vStippleDistance, pos.w);
vStippleDistanceLimits = isJoin ?
vStippleDistanceLimits :
isStartVertex ?
vec2(-1e34, vStippleDistanceLimits.y) :
vec2(vStippleDistanceLimits.x, 1e34);`)),r.main.add(y`
      // Convert back into NDC
      pos.xy = (pos.xy / viewport.zw) * pos.w;

      vColor = getColor();
      vColor.a = noPerspectiveWrite(vColor.a * coverage, pos.w);

      ${f&&!o?"pos.z -= 0.001 * pos.w;":""}

      // transform final position to camera space for slicing
      vpos = (inverseProjectionMatrix * pos).xyz;
      gl_Position = pos;
      forwardObjectAndLayerIdColor();
    }`),e.fragment.include(KM,s),e.include(JM,s),n.include(Sw),n.main.add(y`discardBySlice(vpos);
discardByTerrainDepth();`),e.include(Nb),n.main.add(y`
    float lineWidth = noPerspectiveRead(vLineWidth);
    float lineDistance = noPerspectiveRead(vLineDistance);
    ${X(C,y`float lineDistanceNorm = noPerspectiveRead(vLineDistanceNorm);`)}
  `),f?n.main.add(y`vec4 finalColor = vec4(1.0, 0.0, 1.0, 1.0);`):(w&&n.main.add(y`
        float sdf = noPerspectiveRead(min(vSegmentSDF, vReverseSegmentSDF));
        vec2 fragmentPosition = vec2(min(sdf, 0.0), lineDistance);

        float fragmentRadius = length(fragmentPosition);
        float fragmentCapSDF = (fragmentRadius - lineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
        float capCoverage = clamp(0.5 - fragmentCapSDF, 0.0, 1.0);

        if (capCoverage < ${y.float($s)}) {
          discard;
        }
      `),S?n.main.add(y`
      vec2 stipplePosition = vec2(
        min(getStippleSDF() * 2.0 - 1.0, 0.0),
        lineDistanceNorm
      );
      float stippleRadius = length(stipplePosition * lineWidth);
      float stippleCapSDF = (stippleRadius - lineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
      float stippleCoverage = clamp(0.5 - stippleCapSDF, 0.0, 1.0);
      float stippleAlpha = step(${y.float($s)}, stippleCoverage);
      `):n.main.add(y`float stippleAlpha = getStippleAlpha(lineWidth);`),l!==10&&n.main.add(y`discardByStippleAlpha(stippleAlpha, ${y.float($s)});`),e.include(Nb),n.uniforms.add(new qs("intrinsicColor",M=>M.color)).main.add(y`vec4 color = intrinsicColor * vColor;
color.a = noPerspectiveRead(color.a);`),g&&n.uniforms.add(new qs("innerColor",M=>M.innerColor??M.color),new ge("innerWidth",(M,O)=>M.innerWidth*O.camera.pixelRatio)).main.add(y`float distToInner = abs(lineDistance) - innerWidth;
float innerAA = clamp(0.5 - distToInner, 0.0, 1.0);
float innerAlpha = innerColor.a + color.a * (1.0 - innerColor.a);
color = mix(color, vec4(innerColor.rgb, innerAlpha), innerAA);`),n.main.add(y`vec4 finalColor = blendStipple(color, stippleAlpha);`),d&&(n.uniforms.add(new ge("falloff",M=>M.falloff)),n.main.add(y`finalColor.a *= pow(max(0.0, 1.0 - abs(lineDistanceNorm)), falloff);`)),h||n.main.add(y`float featherStartDistance = max(lineWidth - 2.0, 0.0);
float value = abs(lineDistance);
float feather = (value - featherStartDistance) / (lineWidth - featherStartDistance);
finalColor.a *= 1.0 - clamp(feather, 0.0, 1.0);`),_&&n.main.add(y`
        finalColor = animate(finalColor);

        ${X(l!==10,y`
            if (finalColor.a <= ${y.float($s)}) {
              discard;
            }`)}
      `)),n.main.add(y`outputColorHighlightOID(finalColor, vpos, finalColor.rgb);`),e}const p8=Object.freeze(Object.defineProperty({__proto__:null,build:CE,ribbonlineNumRoundJoinSubdivisions:Dp},Symbol.toStringTag,{value:"Module"}));let m8=class extends ct{constructor(e,t){super(e,t,new ht(p8,()=>k(()=>Promise.resolve().then(()=>JJ),void 0)),TE(t).locations),this.primitiveType=t.wireframe?Ct.LINES:Ct.TRIANGLE_STRIP}_makePipelineState(e,t){const{oitPass:i,output:r,hasOccludees:n,hasPolygonOffset:a}=e,o=i===0,l=i===2;return qe({blending:ns(r)?s$(i):null,depthTest:{func:i$(i)},depthWrite:iL(e),drawBuffers:xh(r,qd(i,r)),colorWrite:nt,stencilWrite:n?w0:null,stencilTest:n?t?zx:t$:null,polygonOffset:o||l?a?i2:null:e$})}initializePipeline(e){if(e.occluder){const t=e.hasPolygonOffset?i2:null,{output:i,hasOccludees:r}=e;this._occluderPipelineTransparent=qe({blending:za,polygonOffset:t,depthTest:Bx,depthWrite:null,colorWrite:nt,stencilWrite:null,stencilTest:r?sL:null,drawBuffers:xh(i)}),this._occluderPipelineOpaque=qe({blending:za,polygonOffset:t,depthTest:r?Bx:Nx,depthWrite:null,colorWrite:nt,stencilWrite:r?nL:null,stencilTest:r?rL:null,drawBuffers:xh(i)}),this._occluderPipelineMaskWrite=qe({blending:null,polygonOffset:t,depthTest:Nx,depthWrite:null,colorWrite:null,stencilWrite:r?w0:null,stencilTest:r?zx:null,drawBuffers:xh(i)})}return this._occludeePipeline=this._makePipelineState(e,!0),this._makePipelineState(e,!1)}getPipeline(e,t){if(e)return this._occludeePipeline;switch(t){case 11:return this._occluderPipelineTransparent??super.getPipeline();case 10:return this._occluderPipelineOpaque??super.getPipeline();default:return this._occluderPipelineMaskWrite??super.getPipeline()}}};const i2={factor:0,units:-4};function TE(s){const e=Xa().vec3f("position").vec4f16("previousDelta").vec4f16("nextDelta").f32("u0").vec2f16("lineParameters");return s.hasVVColor?e.f32("colorFeatureAttribute"):e.vec4u8("color",{glNormalized:!0}),s.hasVVSize?e.f32("sizeFeatureAttribute"):e.f32("size"),s.hasVVOpacity&&e.f32("opacityFeatureAttribute"),Io()&&e.vec4u8("olidColor"),s.hasAnimation&&e.vec4f16("timeStamps"),e}let Yt=class extends T_{constructor(e){super(),this.spherical=e,this.capType=0,this.emissionSource=0,this.hasPolygonOffset=!1,this.writeDepth=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stipplePreferContinuous=!0,this.roundJoins=!1,this.applyMarkerOffset=!1,this.hasVVSize=!1,this.hasVVColor=!1,this.hasVVOpacity=!1,this.falloffEnabled=!1,this.innerColorEnabled=!1,this.hasOccludees=!1,this.occluder=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.wireframe=!1,this.discardInvisibleFragments=!1,this.animation=2,this.hasScreenSizePerspective=!1,this.textureCoordinateType=0,this.occlusionPass=!1,this.hasVVInstancing=!1,this.hasSliceTranslatedView=!0,this.overlayEnabled=!1,this.snowCover=!1}get hasAnimation(){return this.animation!==0}};u([V({count:3})],Yt.prototype,"capType",void 0),u([V({count:8})],Yt.prototype,"emissionSource",void 0),u([V()],Yt.prototype,"hasPolygonOffset",void 0),u([V()],Yt.prototype,"writeDepth",void 0),u([V()],Yt.prototype,"draped",void 0),u([V()],Yt.prototype,"stippleEnabled",void 0),u([V()],Yt.prototype,"stippleOffColorEnabled",void 0),u([V()],Yt.prototype,"stipplePreferContinuous",void 0),u([V()],Yt.prototype,"roundJoins",void 0),u([V()],Yt.prototype,"applyMarkerOffset",void 0),u([V()],Yt.prototype,"hasVVSize",void 0),u([V()],Yt.prototype,"hasVVColor",void 0),u([V()],Yt.prototype,"hasVVOpacity",void 0),u([V()],Yt.prototype,"falloffEnabled",void 0),u([V()],Yt.prototype,"innerColorEnabled",void 0),u([V()],Yt.prototype,"hasOccludees",void 0),u([V()],Yt.prototype,"occluder",void 0),u([V()],Yt.prototype,"terrainDepthTest",void 0),u([V()],Yt.prototype,"cullAboveTerrain",void 0),u([V()],Yt.prototype,"wireframe",void 0),u([V()],Yt.prototype,"discardInvisibleFragments",void 0),u([V({count:4})],Yt.prototype,"animation",void 0),u([V()],Yt.prototype,"hasScreenSizePerspective",void 0);let f8=class extends HM{constructor(e,t){super(e,_8),this.produces=new Map([[2,i=>y4(i)||ns(i)&&this.parameters.renderOccluded===8],[3,i=>v4(i)],[10,i=>_C(i)&&this.parameters.renderOccluded===8],[11,i=>_C(i)&&this.parameters.renderOccluded===8],[4,i=>ns(i)&&this.parameters.writeDepth&&this.parameters.renderOccluded!==8],[8,i=>ns(i)&&!this.parameters.writeDepth&&this.parameters.renderOccluded!==8],[18,i=>b4(i)]]),this._configuration=new Yt(t)}getConfiguration(e,t){super.getConfiguration(e,t,this._configuration),this._configuration.oitPass=t.oitPass,this._configuration.draped=t.slot===18;const i=this.parameters.stipplePattern!=null&&e!==9;return this._configuration.stippleEnabled=i,this._configuration.stippleOffColorEnabled=i&&this.parameters.stippleOffColor!=null,this._configuration.stipplePreferContinuous=i&&this.parameters.stipplePreferContinuous,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.roundJoins=this.parameters.join==="round",this._configuration.capType=this.parameters.cap,this._configuration.applyMarkerOffset=this.parameters.markerParameters!=null&&v8(this.parameters.markerParameters),this._configuration.hasPolygonOffset=this.parameters.hasPolygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasVVSize=this.parameters.hasVVSize,this._configuration.hasVVColor=this.parameters.hasVVColor,this._configuration.hasVVOpacity=this.parameters.hasVVOpacity,this._configuration.innerColorEnabled=this.parameters.innerWidth>0&&this.parameters.innerColor!=null,this._configuration.falloffEnabled=this.parameters.falloff>0,this._configuration.hasOccludees=t.hasOccludees,this._configuration.occluder=this.parameters.renderOccluded===8,this._configuration.terrainDepthTest=t.terrainDepthTest&&ns(e),this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration.wireframe=this.parameters.wireframe,this._configuration.animation=this.parameters.animation,this._configuration.emissionSource=this.hasEmissions?1:0,this._configuration.hasScreenSizePerspective=!!this.parameters.screenSizePerspective,this._configuration}get visible(){return this.parameters.color[3]>=$s||this.parameters.stipplePattern!=null&&(this.parameters.stippleOffColor?.[3]??0)>$s}setParameters(e,t){e.animation=this.parameters.animation,super.setParameters(e,t)}intersectDraped({attributes:e,screenToWorldRatio:t},i,r,n,a){if(!i.options.selectionMode)return;const o=e.get("size");let l=this.parameters.width;if(this.parameters.vvSize){const v=e.get("sizeFeatureAttribute").data[0];Number.isNaN(v)?l*=this.parameters.vvSize.fallback[0]:l*=U(this.parameters.vvSize.offset[0]+v*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else o&&(l*=o.data[0]);const c=r[0],h=r[1],d=(l/2+4)*t;let m=Number.MAX_VALUE,f=0;const g=e.get("position").data,_=Ub(this.parameters,e)?g.length-2:g.length-5;for(let v=0;v<_;v+=3){const b=g[v],T=g[v+1],w=(v+3)%g.length,S=c-b,C=h-T,P=g[w]-b,M=g[w+1]-T,O=U((P*S+M*C)/(P*P+M*M),0,1),D=P*O-S,A=M*O-C,F=D*D+A*A;F<m&&(m=F,f=v/3)}m<d*d&&n(a.distance,a.normal,f)}intersect(e,t,i,r,n,a){const{options:o,camera:l,rayBegin:c,rayEnd:h}=i;if(!o.selectionMode||!e.visible||!l)return;if(!m4(t))return void j.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial").error("intersection assumes a translation-only matrix");const d=e.attributes,m=d.get("position").data;let f=this.parameters.width;if(this.parameters.vvSize){const w=d.get("sizeFeatureAttribute").data[0];Number.isNaN(w)||(f*=U(this.parameters.vvSize.offset[0]+w*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0]))}else d.has("size")&&(f*=d.get("size").data[0]);const g=b8;pr(g,i.point);const _=f*l.pixelRatio/2+4*l.pixelRatio;be(qu[0],g[0]-_,g[1]+_,0),be(qu[1],g[0]+_,g[1]+_,0),be(qu[2],g[0]+_,g[1]-_,0),be(qu[3],g[0]-_,g[1]-_,0);for(let w=0;w<4;w++)if(!l.unprojectFromRenderScreen(qu[w],ma[w]))return;cm(l.eye,ma[0],ma[1],bv),cm(l.eye,ma[1],ma[2],wv),cm(l.eye,ma[2],ma[3],xv),cm(l.eye,ma[3],ma[0],Cv);let v=Number.MAX_VALUE,b=0;const T=Ub(this.parameters,d)?m.length-2:m.length-5;for(let w=0;w<T;w+=3){ps[0]=m[w]+t[12],ps[1]=m[w+1]+t[13],ps[2]=m[w+2]+t[14];const S=(w+3)%m.length;if(ms[0]=m[S]+t[12],ms[1]=m[S+1]+t[13],ms[2]=m[S+2]+t[14],or(bv,ps)<0&&or(bv,ms)<0||or(wv,ps)<0&&or(wv,ms)<0||or(xv,ps)<0&&or(xv,ms)<0||or(Cv,ps)<0&&or(Cv,ms)<0)continue;const C=l.projectToRenderScreen(ps,w8),P=l.projectToRenderScreen(ms,x8);if(C==null||P==null)continue;if(C[2]<0&&P[2]>0){he(Dn,ps,ms);const O=l.frustum,D=-or(O[4],ps)/We(Dn,cn(O[4]));if(ee(Dn,Dn,D),ce(ps,ps,Dn),!l.projectToRenderScreen(ps,C))continue}else if(C[2]>0&&P[2]<0){he(Dn,ms,ps);const O=l.frustum,D=-or(O[4],ms)/We(Dn,cn(O[4]));if(ee(Dn,Dn,D),ce(ms,ms,Dn),!l.projectToRenderScreen(ms,P))continue}else if(C[2]<0&&P[2]<0)continue;C[2]=0,P[2]=0;const M=GV(gy(C,P,n2),g);M<v&&(v=M,q(s2,ps),q(r2,ms),b=w/3)}if(v<_*_){let w=Number.MAX_VALUE;if(jV(gy(s2,r2,n2),gy(c,h,C8),ll)){he(ll,ll,c);const S=fe(ll);ee(ll,ll,1/S),w=S/Ht(c,h)}a(w,ll,b)}}get hasEmissions(){return this.parameters.emissiveStrength>0}createBufferWriter(){return new y8(TE(this.parameters),this.parameters)}createGLMaterial(e){return new g8(e)}validateParameters(e){e.join!=="miter"&&(e.miterLimit=0),e.markerParameters!=null&&(e.markerScale=e.markerParameters.width/e.width)}update(e){const{hasAnimation:t}=this.parameters;return!!t&&(this.setParameters({timeElapsed:_w(e.time)},!1),e.dt!==0)}},g8=class extends qM{constructor(){super(...arguments),this._stipplePattern=null}dispose(){super.dispose(),this._stippleTextures?.release(this._stipplePattern),this._stipplePattern=null}beginSlot(e){const t=this._material.parameters.stipplePattern;return this._stipplePattern!==t&&(this._material.setParameters({stippleTexture:this._stippleTextures.swap(t,this._stipplePattern)}),this._stipplePattern=t),this.getTechnique(m8,e)}},_8=class extends aL{constructor(){super(...arguments),this.width=0,this.color=lR,this.join="miter",this.cap=0,this.miterLimit=5,this.writeDepth=!0,this.hasPolygonOffset=!1,this.stippleTexture=null,this.stipplePreferContinuous=!0,this.markerParameters=null,this.markerScale=1,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.isClosed=!1,this.falloff=0,this.innerWidth=0,this.wireframe=!1,this.timeElapsed=0,this.animation=0,this.animationSpeed=1,this.trailLength=1,this.startTime=0,this.endTime=1/0,this.fadeInTime=0,this.fadeOutTime=1/0,this.emissiveStrength=0}get transparent(){return this.color[3]<1||this.hasAnimation||this.stipplePattern!=null&&(this.stippleOffColor?.[3]??0)<1}get hasAnimation(){return this.animation!==0}},y8=class{constructor(e,t){this.layout=e,this._parameters=t;const i=t.stipplePattern?1:0;switch(this._parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=i;break;case"round":this.numJoinSubdivisions=Dp+i}}_isClosed(e){return Ub(this._parameters,e)}allocate(e){return this.layout.createBuffer(e)}elementCount(e){const i=e.get("position").indices.length/2+1,r=this._isClosed(e);let n=r?2:4;return n+=((r?i:i-1)-(r?0:1))*(2*this.numJoinSubdivisions+4),n+=2,this._parameters.wireframe&&(n=2+4*(n-2)),n}write(e,t,i,r,n,a){const o=this.layout,l=i.get("position"),c=l.indices,h=l.data.length/3,d=i.get("distanceToStart")?.data;c&&c.length!==2*(h-1)&&console.warn("RibbonLineMaterial does not support indices");const m=o.fields.has("sizeFeatureAttribute");let f=1,g=null;if(m){const ae=i.get("sizeFeatureAttribute");ae.data.length===1?f=ae.data[0]:g=ae.data}else f=i.get("size")?.data[0]??1;let _=[1,1,1,1],v=0,b=null;const T=o.fields.has("colorFeatureAttribute");if(T){const ae=i.get("colorFeatureAttribute");ae.data.length===1?v=ae.data[0]:b=ae.data}else _=i.get("color")?.data??_;const w=i.get("timeStamps")?.data,S=w&&o.fields.has("timeStamps"),C=o.fields.has("opacityFeatureAttribute");let P=0,M=null;if(C){const ae=i.get("opacityFeatureAttribute");ae.data.length===1?P=ae.data[0]:M=ae.data}const O=new Float32Array(n.buffer),D=_R(n.buffer),A=new Uint8Array(n.buffer),F=o.stride/4;let E=a*F;const z=E;let L=0;const I=d?(ae,we,ze)=>L=d[ze]:(ae,we,ze)=>L+=Ht(ae,we),ie=O.BYTES_PER_ELEMENT/D.BYTES_PER_ELEMENT,N=4/ie,se=Io(),G=(ae,we,ze,Xe,$t,ut,De,dt)=>{O[E++]=we[0],O[E++]=we[1],O[E++]=we[2],Ux(ae,we,D,E*ie),E+=N,Ux(ze,we,D,E*ie),E+=N,O[E++]=dt;let Ee=E*ie;if(D[Ee++]=$t,D[Ee++]=ut,E=Math.ceil(Ee/ie),T)O[E]=b?.[De]??v;else{const Se=Math.min(4*De,_.length-4),Ge=4*E;A[Ge]=255*_[Se],A[Ge+1]=255*_[Se+1],A[Ge+2]=255*_[Se+2],A[Ge+3]=255*_[Se+3]}if(E++,O[E++]=g?.[De]??f,C&&(O[E++]=M?.[De]??P),se){let Se=4*E;r?(A[Se++]=r[0],A[Se++]=r[1],A[Se++]=r[2],A[Se++]=r[3]):(A[Se++]=0,A[Se++]=0,A[Se++]=0,A[Se++]=0),E=Math.ceil(.25*Se)}S&&(Ee=E*ie,D[Ee++]=Xe[0],D[Ee++]=Xe[1],D[Ee++]=Xe[2],D[Ee++]=Xe[3],E=Math.ceil(Ee/ie))};E+=F,be(Bt,l.data[0],l.data[1],l.data[2]),S&&os(fs,w[0],w[1],w[2],w[3]),e&&ot(Bt,Bt,e);const Ce=this._isClosed(i);if(Ce){const ae=l.data.length-3;be(Fi,l.data[ae],l.data[ae+1],l.data[ae+2]),e&&ot(Fi,Fi,e)}else be(pi,l.data[3],l.data[4],l.data[5]),e&&ot(pi,pi,e),G(Bt,Bt,pi,fs,1,-4,0,0),G(Bt,Bt,pi,fs,1,4,0,0),q(Fi,Bt),q(Bt,pi),S&&os(fs,w[4],w[5],w[6],w[7]);const ue=Ce?0:1,Oe=Ce?h:h-1;for(let ae=ue;ae<Oe;ae++){const we=(ae+1)%h*3;be(pi,l.data[we],l.data[we+1],l.data[we+2]),e&&ot(pi,pi,e),I(Fi,Bt,ae),G(Fi,Bt,pi,fs,0,-1,ae,L),G(Fi,Bt,pi,fs,0,1,ae,L);const ze=this.numJoinSubdivisions;for(let Xe=0;Xe<ze;++Xe){const $t=(Xe+1)/(ze+1);G(Fi,Bt,pi,fs,$t,-1,ae,L),G(Fi,Bt,pi,fs,$t,1,ae,L)}if(G(Fi,Bt,pi,fs,1,-2,ae,L),G(Fi,Bt,pi,fs,1,2,ae,L),q(Fi,Bt),q(Bt,pi),S){const Xe=(ae+1)%h*4;os(fs,w[Xe],w[Xe+1],w[Xe+2],w[Xe+3])}}return Ce?(be(pi,l.data[3],l.data[4],l.data[5]),e&&ot(pi,pi,e),L=I(Fi,Bt,Oe),G(Fi,Bt,pi,fs,0,-1,ue,L),G(Fi,Bt,pi,fs,0,1,ue,L)):(L=I(Fi,Bt,Oe),G(Fi,Bt,Bt,fs,0,-5,Oe,L),G(Fi,Bt,Bt,fs,0,5,Oe,L)),vv(O,z+F,O,z,F),E=vv(O,E-F,O,E,F),this._parameters.wireframe&&this._addWireframeVertices(n,z,E,F),null}_addWireframeVertices(e,t,i,r){const n=new Float32Array(e.buffer,i*Float32Array.BYTES_PER_ELEMENT),a=new Float32Array(e.buffer,t*Float32Array.BYTES_PER_ELEMENT,i-t);let o=0;const l=c=>o=vv(a,c,n,o,r);for(let c=0;c<a.length-1;c+=2*r)l(c),l(c+2*r),l(c+1*r),l(c+2*r),l(c+1*r),l(c+3*r)}};function vv(s,e,t,i,r){for(let n=0;n<r;n++)t[i++]=s[e++];return i}function Ub(s,e){return s.isClosed?e.get("position").indices.length>2:!1}function v8(s){return s.anchor===1&&s.hideOnShortSegments&&s.placement==="begin-end"&&s.worldSpace}const ps=x(),ms=x(),Dn=x(),ll=x(),b8=x(),w8=Ia(),x8=Ia(),s2=x(),r2=x(),n2=mR(),C8=mR(),Fi=x(),Bt=x(),pi=x(),fs=Lt(),qu=[Ia(),Ia(),Ia(),Ia()],ma=[x(),x(),x(),x()],bv=Ha(),wv=Ha(),xv=Ha(),Cv=Ha();let SE=class{constructor(e){this._originSR=e,this._rootOriginId="root/"+hu(),this._origins=new Map,this._objects=new Map,this._gridSize=5e5}getOrigin(e){const t=this._origins.get(this._rootOriginId);if(t==null){const h=f_(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,h),h}const i=this._gridSize,r=Math.round(e[0]/i),n=Math.round(e[1]/i),a=Math.round(e[2]/i),o=`${r}/${n}/${a}`;let l=this._origins.get(o);const c=.5*i;if(he(Mi,e,t.vec3),Mi[0]=Math.abs(Mi[0]),Mi[1]=Math.abs(Mi[1]),Mi[2]=Math.abs(Mi[2]),Mi[0]<c&&Mi[1]<c&&Mi[2]<c){if(l){const h=Math.max(...Mi);if(he(Mi,e,l.vec3),Mi[0]=Math.abs(Mi[0]),Mi[1]=Math.abs(Mi[1]),Mi[2]=Math.abs(Mi[2]),Math.max(...Mi)<h)return l}return t}return l||(l=f_(r*i,n*i,a*i,o),this._origins.set(o,l)),l}_drawOriginBox(e,t=Si(1,1,0,1)){const i=window.view,r=i.stage,n=t.toString();if(!this._objects.has(n)){this._material=new f8({width:2,color:t},!1);const f=new QD(r,{pickable:!1}),g=new zD({castShadow:!1});f.add(g),this._objects.set(n,g)}const a=this._objects.get(n),o=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],l=o.length,c=new Array(3*l),h=new Array,d=.5*this._gridSize;for(let f=0;f<l;f++)c[3*f]=e[0]+(1&o[f]?d:-d),c[3*f+1]=e[1]+(2&o[f]?d:-d),c[3*f+2]=e[2]+(4&o[f]?d:-d),f>0&&h.push(f-1,f);na(c,this._originSR,0,c,i.renderSpatialReference,0,l);const m=new GM(this._material,[["position",new Rf(c,h,3,!0)]],null,2);a.addGeometry(m)}get test(){}};const Mi=x();function T8(s){return s!=null&&!s.readyToRun}let S8=class{constructor(){this.startTime=0,this._data=rs(null),this.coverage=0,this.absorption=0,this._readChannels=0,this.parallax=new a2,this.parallaxNew=new a2,this._anchorPoint=x(),this._fadeState=rs(0),this._fadeFactor=rs(1)}get data(){return this._data.value}set data(e){this._data.value=e}get readChannels(){return this._readChannels}get fadeState(){return this._fadeState.value}get fadeFactor(){return this._fadeFactor.value}get opacity(){switch(this.fadeState){case 0:return 0;case 4:return 1-this.fadeFactor;case 1:return this.fadeFactor;case 2:case 3:return 1}}fade(e,t,i){this.isFading&&this.fadeFactor<1&&(this._fadeFactor.value=i?U((t-this.startTime)/(M8*i),0,1):1,this.fadeFactor===1&&this._endFade()),this._evaluateState(e,t),this._updateParallax(e)}_evaluateState(e,t){const i=e.relativeElevation,r=this._updateAnchorPoint(e);(i>1.7*kl||i<-kl||r>l2)&&this.opacity>0?this._startFade(0,t):this.isFading||(i>kl||i<-.35*kl||r>$8*l2?this.opacity>0&&this._startFade(4,t):T8(this.data)&&(this.opacity===0?this._startFade(1,t):this.data.state===2&&(this.fadeState===2?this._startFade(3,t):this._startFade(2,t))))}_updateParallax(e){const t=Gs(e.eye);this.parallax.radiusCurvatureCorrection=.84*Math.sqrt(Math.max(t-Ei.radius*Ei.radius,0))/Math.sqrt(t),yC(o2,this.parallax.anchorPoint,Lc),gn(this.parallax.transform,_n,Lc[3],vC(Lc)),yC(o2,this.parallaxNew.anchorPoint,Lc),gn(this.parallaxNew.transform,_n,Lc[3],vC(Lc))}_updateAnchorPoint(e){return pe(this._anchorPoint,e.eye),ee(this._anchorPoint,this._anchorPoint,Ei.radius),this.fadeState===0&&this.data?.state===2?(q(this.parallax.anchorPoint,this._anchorPoint),0):fe(he(P8,this.parallax.anchorPoint,this._anchorPoint))}requestFade(){this._fadeFactor.value=0}_startFade(e,t){switch(this._fadeState.value=e,this.startTime=t,e){case 3:this.requestFade(),this._switchReadChannels(),q(this.parallaxNew.anchorPoint,this._anchorPoint);break;case 1:this.requestFade(),this._switchReadChannels(),q(this.parallax.anchorPoint,this._anchorPoint),q(this.parallaxNew.anchorPoint,this._anchorPoint);break;case 4:this.requestFade();break;case 2:this._switchReadChannels(),q(this.parallax.anchorPoint,this._anchorPoint),q(this.parallaxNew.anchorPoint,this._anchorPoint),this._endFade();break;case 0:this._endFade()}}_endFade(){switch(this._fadeFactor.value=1,this.data&&this.data.state!==2&&(this.data.state=0),this.fadeState){case 3:q(this.parallax.anchorPoint,this.parallaxNew.anchorPoint),this._fadeState.value=2;break;case 1:this._fadeState.value=2;break;case 4:this._fadeState.value=0;break;case 2:case 0:break;default:ra(this.fadeState)}}_switchReadChannels(){this.data?.state===2&&(this._readChannels=1-this._readChannels,this.data.state=3)}get isFading(){return this.fadeState===4||this.fadeState===1||this.fadeState===3}},a2=class{constructor(){this.anchorPoint=x(),this.radiusCurvatureCorrection=0,this.transform=Ie()}};const o2=Qe(0,0,1),Lc=I4(),P8=x(),M8=1.25,$8=.5,l2=2e5;let R8=class{constructor(e,t){this.width=e,this.height=t}},H1=class{constructor(e){this.shadowMap=e,this.slot=2,this.slicePlane=null,this.hasOccludees=!1,this.enableFillLights=!0,this.oitPass=0,this.alignPixelEnabled=!1,this.decorations=!0,this.overlayStretch=1,this.viewshedEnabled=!1,this.cutFillEnabled=!1,this._camera=new vt,this._inverseViewport=ke(),this._oldLighting=new cy,this._newLighting=new cy,this._fadedLighting=new cy,this._lighting=this._newLighting,this.ssr=new O8,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.highlights=new Array,this.highlightOrderMap=new Map,this.highlightMixOrigin=ke(),this.highlightMixTexture=null,this.hudRenderStyle=0,this.hudOccludedFragmentOpacity=1,this.snowCover=0,this.clouds=new S8,this.shadowHighlightsVisible=!1}destroy(){this._camera=null,this.contentCamera=null,this.depth=null,this.geometryDepth=null,this.mainDepth=null,this.overlay=null,this.ssao=null,this.terrainDepth=null}get camera(){return this._camera}set camera(e){this._camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}fadeLighting(){switch(this.clouds.fadeFactor){case 0:this._lighting=this._oldLighting;break;default:this._fadedLighting.lerpLighting(this._oldLighting,this._newLighting,this.clouds.fadeFactor),this._lighting=this._fadedLighting;break;case 1:this._lighting=this._newLighting,this._oldLighting.copyFrom(this._newLighting)}}updateLighting(e,t,i,r){this._oldLighting.copyFrom(this.lighting),this._newLighting.noonFactor=t,this._newLighting.globalFactor=i,this._newLighting.set(e),this._oldLighting.updateLegacy(),r===1&&this.clouds.requestFade(),this.fadeLighting()}get highlight(){return this.highlightLevel==null?null:this.highlights[this.highlightLevel]}},O8=class{constructor(){this.fadeFactor=1,this.reprojectionMatrix=Ie()}},PE=class{constructor(e,t,i){this.rctx=e,this.techniques=i,this.lastFrameCamera=new vt,this.output=0,this.renderOccludedMask=Ep,this.time=$e(0),this.bind=new H1(t),this.bind.alignPixelEnabled=!0}};const Ep=13;let Sd=class extends vt{constructor(){super(...arguments),this._projectionMatrix=Ie()}get projectionMatrix(){return this._projectionMatrix}};u([p()],Sd.prototype,"_projectionMatrix",void 0),u([p({readOnly:!0})],Sd.prototype,"projectionMatrix",null),Sd=u([R("esri.views.3d.webgl-engine.lib.CascadeCamera")],Sd);let Km=class{constructor(){this.camera=new Sd,this.lightMat=Ie()}},D8=class{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}},q1=class{constructor(e,t){this._fbos=e,this._viewingMode=t,this._snapshots=new Array,this._textureHeight=0,this._numCascades=1,this.settings=new D8,this._projectionView=Ie(),this._projectionViewInverse=Ie(),this._modelViewLight=Ie(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=Lt(),this._cascades=[new Km,new Km,new Km,new Km],this._lastOrigin=null,this._enabled=!1,this._maxTextureWidth=Math.min(Ze("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}get depthTexture(){return this._handle?.getTexture(Ui)}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return os(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}disposeMainBuffer(){this._handle=Nt(this._handle)}disposeOffscreenBuffers(){this.disposeMainBuffer(),this._discardSnapshots()}set maxCascades(e){this.settings.maxNumCascadesHighQuality=U(Math.floor(e),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(e){this._enabled=e,e||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&this.depthTexture!=null}get cascades(){for(let e=0;e<this._numCascades;++e)rg[e]=this._cascades[e];return rg.length=this._numCascades,rg}start(e,t,i,r,n){Wt(this.enabled);const{near:a,far:o}=k8(i);this._computeCascadeDistances(a,o,r),this._textureHeight=this._computeTextureHeight(e,n,r),this._setupMatrices(e,t);const{viewMatrix:l,projectionMatrix:c}=e;for(let h=0;h<this._numCascades;++h)this._constructCascade(h,c,l,t);this._lastOrigin=null,this.clear()}finish(){Wt(this.enabled)}getShadowMapMatrices(e){if(!this._lastOrigin||!qo(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||x(),q(this._lastOrigin,e);for(let t=0;t<this._numCascades;++t){rc(m2,this._cascades[t].lightMat,e);for(let i=0;i<16;++i)f2[16*t+i]=m2[i]}}return f2}moveSnapshot(e){Wt(this.enabled),this._snapshots[e]?.release(),this._snapshots[e]=this._handle,this._handle?.setName(e===0?"shadow map highlight":"shadow map excluding highlight"),this._handle=null}copySnapshot(e){if(!this.enabled||!this._handle?.getTexture(Ui)?.descriptor)return;this._snapshots[e]?.release();const i=e===0?"shadow map highlight":"shadow map excluding highlight",r=this._acquireFBO(i);this._snapshots[e]=r;const n=this._handle?.fbo;if(!n||!r?.fbo)return void console.error("No FBO");const{rctx:a}=this._fbos;a.blitFramebuffer(n,r.fbo,256)}getSnapshot(e){return this.enabled?this._snapshots[e]?.getTexture(Ui):null}clear(){this._ensureFbo(),this.bindFbo(),this._fbos.rctx.clear(256)}_computeTextureHeight({pixelRatio:e,fullWidth:t,fullHeight:i},r,n){const a=Math.min(window.devicePixelRatio,r)/e,o=n?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality;return jh(Math.max(t,i)*a*o,this._maxTextureWidth/this._numCascades)}_ensureFbo(){this._handle?.fbo?.width===this._textureWidth&&this._handle?.fbo.height===this._textureHeight||(this._handle?.release(),this._handle=this._acquireFBO("shadow map"))}_acquireFBO(e){const t=this._fbos.acquire(this._textureWidth,this._textureHeight,e,12);return t.getTexture(Ui)?.setShadowFiltering(!0),t}_discardSnapshot(e){this._snapshots[e]=Nt(this._snapshots[e])}_discardSnapshots(){for(let e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0}bindFbo(){this._fbos.rctx.bindFramebuffer(this._handle?.fbo)}_constructCascade(e,t,i,r){const n=this._cascades[e],a=-this._cascadeDistances[e],o=-this._cascadeDistances[e+1],l=(t[10]*a+t[14])/Math.abs(t[11]*a+t[15]),c=(t[10]*o+t[14])/Math.abs(t[11]*o+t[15]);Wt(l<c);for(let f=0;f<8;++f){os(c2,f%4==0||f%4==3?-1:1,f%4==0||f%4==1?-1:1,f<4?l:c,1);const g=$r[f];kg(g,c2,this._projectionViewInverse),g[0]/=g[3],g[1]/=g[3],g[2]/=g[3]}La(Tv,$r[0]),n.camera.viewMatrix=rc(E8,this._modelViewLight,Tv);for(let f=0;f<8;++f)ot($r[f],$r[f],n.camera.viewMatrix);let h=$r[0][2],d=$r[0][2];for(let f=1;f<8;++f)h=Math.min(h,$r[f][2]),d=Math.max(d,$r[f][2]);h-=200,d+=200,n.camera.near=-d,n.camera.far=-h,V8(i,r,h,d,n.camera),as(n.lightMat,n.camera.projectionMatrix,n.camera.viewMatrix);const m=this._textureHeight;n.camera.viewport=[e*m,0,m,m]}_setupMatrices(e,t){as(this._projectionView,e.projectionMatrix,e.viewMatrix),eu(this._projectionViewInverse,this._projectionView);const i=this._viewingMode===1?e.eye:be(Tv,0,0,1);J$(this._modelViewLight,[0,0,0],[-t[0],-t[1],-t[2]],i)}_computeCascadeDistances(e,t,i){const r=i?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor(f4(t/e,4)),r);const n=(t-e)/this._numCascades,a=(t/e)**(1/this._numCascades);let o=e,l=e;for(let c=0;c<this._numCascades+1;++c)this._cascadeDistances[c]=Me(o,l,this.settings.splitSchemeLambda),o*=a,l+=n}get test(){}};const E8=Ie(),c2=Lt(),$r=[];for(let s=0;s<8;++s)$r.push(Lt());const h2=ke(),u2=ke(),A8=ke(),d2=ke(),p2=ke(),Tv=x(),rg=[];function I8(){rg.length=0}const m2=Ie(),f2=_n.concat(_n,_n,_n),ir=ke(),Fc=ke(),cl=[ke(),ke(),ke(),ke()],mi=ke(),Sv=ke(),lo=ke(),Gu=ke(),Vc=ke(),kc=ke(),Jm=ke();function L8(s,e,t,i,r,n,a,o){Xi(ir,0,0);for(let C=0;C<4;++C)Yo(ir,ir,s[C]);$l(ir,ir,.25),Xi(Fc,0,0);for(let C=4;C<8;++C)Yo(Fc,Fc,s[C]);$l(Fc,Fc,.25),hn(cl[0],s[4],s[5],.5),hn(cl[1],s[5],s[6],.5),hn(cl[2],s[6],s[7],.5),hn(cl[3],s[7],s[4],.5);let l=0,c=lC(cl[0],ir);for(let C=1;C<4;++C){const P=lC(cl[C],ir);P<c&&(c=P,l=C)}Rl(mi,cl[l],s[l+4]);const h=mi[0];let d,m;mi[0]=-mi[1],mi[1]=h,Rl(Sv,Fc,ir),Qi(Sv,mi)<0&&W5(mi,mi),hn(mi,mi,Sv,t),cC(mi,mi),d=m=Qi(Rl(lo,s[0],ir),mi);for(let C=1;C<8;++C){const P=Qi(Rl(lo,s[C],ir),mi);P<d?d=P:P>m&&(m=P)}pr(i,ir),$l(lo,mi,d-e),Yo(i,i,lo);let f=-1,g=1,_=0,v=0;for(let C=0;C<8;++C){Rl(Gu,s[C],i),cC(Gu,Gu);const P=mi[0]*Gu[1]-mi[1]*Gu[0];P>0?P>f&&(f=P,_=C):P<g&&(g=P,v=C)}Cc(f>0,"leftArea"),Cc(g<0,"rightArea"),$l(Vc,mi,d),Yo(Vc,Vc,ir),$l(kc,mi,m),Yo(kc,kc,ir),Jm[0]=-mi[1],Jm[1]=mi[0];const b=um(i,s[v],kc,Yo(lo,kc,Jm),1,r),T=um(i,s[_],kc,lo,1,n),w=um(i,s[_],Vc,Yo(lo,Vc,Jm),1,a),S=um(i,s[v],Vc,lo,1,o);Cc(b,"rayRay"),Cc(T,"rayRay"),Cc(w,"rayRay"),Cc(S,"rayRay")}function Ue(s,e){return 3*e+s}const g2=ke();function Vs(s,e){return Xi(g2,s[e],s[e+3]),g2}const gs=ke(),re=Pn();function F8(s,e,t,i,r){Rl(gs,t,i),$l(gs,gs,.5),re[0]=gs[0],re[1]=gs[1],re[2]=0,re[3]=gs[1],re[4]=-gs[0],re[5]=0,re[6]=gs[0]*gs[0]+gs[1]*gs[1],re[7]=gs[0]*gs[1]-gs[1]*gs[0],re[8]=1,re[Ue(0,2)]=-Qi(Vs(re,0),s),re[Ue(1,2)]=-Qi(Vs(re,1),s);let n=Qi(Vs(re,0),t)+re[Ue(0,2)],a=Qi(Vs(re,1),t)+re[Ue(1,2)],o=Qi(Vs(re,0),i)+re[Ue(0,2)],l=Qi(Vs(re,1),i)+re[Ue(1,2)];n=-(n+o)/(a+l),re[Ue(0,0)]+=re[Ue(1,0)]*n,re[Ue(0,1)]+=re[Ue(1,1)]*n,re[Ue(0,2)]+=re[Ue(1,2)]*n,n=1/(Qi(Vs(re,0),t)+re[Ue(0,2)]),a=1/(Qi(Vs(re,1),t)+re[Ue(1,2)]),re[Ue(0,0)]*=n,re[Ue(0,1)]*=n,re[Ue(0,2)]*=n,re[Ue(1,0)]*=a,re[Ue(1,1)]*=a,re[Ue(1,2)]*=a,re[Ue(2,0)]=re[Ue(1,0)],re[Ue(2,1)]=re[Ue(1,1)],re[Ue(2,2)]=re[Ue(1,2)],re[Ue(1,2)]+=1,n=Qi(Vs(re,1),e)+re[Ue(1,2)],a=Qi(Vs(re,2),e)+re[Ue(2,2)],o=Qi(Vs(re,1),t)+re[Ue(1,2)],l=Qi(Vs(re,2),t)+re[Ue(2,2)],n=-.5*(n/a+o/l),re[Ue(1,0)]+=re[Ue(2,0)]*n,re[Ue(1,1)]+=re[Ue(2,1)]*n,re[Ue(1,2)]+=re[Ue(2,2)]*n,n=Qi(Vs(re,1),e)+re[Ue(1,2)],a=Qi(Vs(re,2),e)+re[Ue(2,2)],o=-a/n,re[Ue(1,0)]*=o,re[Ue(1,1)]*=o,re[Ue(1,2)]*=o,r[0]=re[0],r[1]=re[1],r[2]=0,r[3]=re[2],r[4]=re[3],r[5]=re[4],r[6]=0,r[7]=re[5],r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=re[6],r[13]=re[7],r[14]=0,r[15]=re[8]}function V8(s,e,t,i,r){const n=1/$r[0][3],a=1/$r[4][3];Wt(n<a);let o=n+Math.sqrt(n*a);const l=Math.sin(Ua(s[2]*e[0]+s[6]*e[1]+s[10]*e[2]));o/=l,L8($r,o,l,h2,u2,A8,d2,p2),F8(h2,u2,d2,p2,r.projectionMatrix),r.projectionMatrix[10]=2/(t-i),r.projectionMatrix[14]=-(t+i)/(t-i)}function k8(s){let{near:e,far:t}=s;return e<2&&(e=2),t<2&&(t=2),e>=t&&(e=2,t=4),{near:e,far:t}}let _2=class extends ct{constructor(e,t){super(e,t,new ht(zj,()=>k(()=>Promise.resolve().then(()=>eee),void 0)),ri)}initializePipeline(e){return e.hasAlpha?qe({blending:za,colorWrite:nt}):qe({colorWrite:nt})}},ME=class extends ls{constructor(){super(...arguments),this.hasAlpha=!1}};u([V()],ME.prototype,"hasAlpha",void 0);let G1=class extends Xt{constructor(){super(...arguments),this.overlayIndex=0,this.opacity=1}};function $E(){const s=new lt;return s.include(qi),s.fragment.uniforms.add(new Be("tex",e=>e.texture)),s.fragment.uniforms.add(new oc("overlayIdx",e=>e.overlayIndex)),s.fragment.uniforms.add(new ge("opacity",e=>e.opacity)),s.fragment.main.add(y`vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);
fragColor = texture(tex, overlayUV) * opacity;`),s}const z8=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:G1,build:$E},Symbol.toStringTag,{value:"Module"}));let y2=class extends ct{constructor(e,t){super(e,t,new ht(z8,()=>k(()=>Promise.resolve().then(()=>tee),void 0)),ri)}},Un=class extends Wp{constructor(e){super(e),this._overlays=null,this._renderTargets=null,this._overlayParameters=new G1,this.hasHighlights=!1,this.renderOccludedFlags=1,this._hasWater=!1,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new zt,this._passParameters=new V1,this._screenToWorldRatio=1,this._localOriginFactory=null,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._camera=new vt,this.events=new cc,this.longitudeCyclical=null,this.produces=new Map([[18,t=>t!==9||this.hasHighlights],[19,()=>this._hasWater]]),this._hasTargetWithoutRasterImage=!1,this._hasDrapedFeatureSource=!1,this._hasDrapedRasterSource=!1,this._hasDrapedFlowSource=!1}initialize(){const e=this._view,t=e.stage,i=t.renderer.fboCache,{waterTextures:r,techniques:n}=t.renderView;this._renderContext=new PE(this._rctx,new q1(i,e.state.viewingMode),n),this.addHandles([$(()=>r.updating,()=>this.events.emit("content-changed"),Ve),$(()=>this._spatialReference,l=>this._localOriginFactory=new SE(l),Ve),Ds(()=>e.allLayerViews,"after-changes",()=>this._sortedDrapeSourceRenderersDirty=!0),$(()=>Qj(e.state.highlights),()=>this._sortedDrapeSourceRenderersDirty=!0,Re),$(()=>e.state.highlights,l=>{this._bindParameters.highlights=l,this._bindParameters.highlightOrderMap=e.state.highlightOrderMap},Re),e.resourceController.scheduler.registerTask(di.OVERLAY_RENDERER,this)]);const{_bindParameters:a,_camera:o}=this;o.near=1,o.far=1e4,o.relativeElevation=null,a.slot=18,a.mainDepth=null,a.camera=o,a.oitPass=0,a.updateLighting([new NM(bF())],0,0,0)}destroy(){this._renderers.forEach(e=>e.destroy()),this._renderers.clear(),this._passParameters.texture=_e(this._passParameters.texture),this.disposeOverlays(),this._renderContext=null,this._sortedRenderers.prune()}get _bindParameters(){return this._renderContext.bind}get _rctx(){return this._stage.renderView.renderingContext}get _view(){return this.parent.view}get _stage(){return this.parent.view.stage}get _spatialReference(){return this.parent.spatialReference}get _techniques(){return this._stage.renderView.techniques}get rctx(){return this._rctx}get materials(){return this._pluginContext.materials}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}get pluginContext(){return this._pluginContext}initializeRenderContext(e){const t=new gE(this._view.stage.renderView.textures,this._techniques,()=>{this._onMaterialOrContentChanged(),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")},()=>this.events.emit("content-changed"));this._pluginContext={...e,materials:t},this._techniques.precompile(y2)}uninitializeRenderContext(){}acquireTechniques(){return[]}render(){}get updating(){return this._sortedDrapeSourceRenderersDirty||pn(this._renderers,e=>e.updating||e.canCompact)}get hasOverlays(){return this._overlays!=null&&this._renderTargets!=null}getMaterialRenderer(e){for(const t of this._renderers.values()){const i=t.getMaterialRenderer(e);if(i)return i}return null}get layers(){return this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers(),_I(this._sortedRenderers.map(e=>e.drapeSource.layer).filter(e=>!!e))}registerDrapeSource(e,t){const i=this._renderers.get(e);i?.destroy(),this._renderers.set(e,t),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in e&&this.addHandles($(()=>e.fullOpacity,()=>this.events.emit("content-changed")),e)}removeDrapeSourceRenderer(e){if(e==null)return;const t=this._renderers.get(e);t!=null&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(e),this.removeHandles(e),t.destroy())}computeValidity(){return this._renderTargets?.computeValidity()??0}releaseRenderTargets(e){this._renderTargets?.dispose(e)}get overlays(){return this._overlays??[]}ensureDrapeTargets(e){this._hasTargetWithoutRasterImage=!!this._overlays&&sm(e,t=>t.drapeTargetType===1)}ensureDrapeSources(e){this._overlays?(this._hasDrapedFeatureSource=sm(e,t=>t.drapeSourceType===1),this._hasDrapedRasterSource=sm(e,t=>t.drapeSourceType===0),this._hasDrapedFlowSource=sm(e,t=>t.drapeSourceType===2)):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=this._hasDrapedFlowSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(e,t,i=this._bindParameters.overlayStretch){this._overlays==null&&(this._renderTargets=new kj(this._stage.renderer.fboCache),this._overlays=[new QS,new QS]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t),this._bindParameters.overlayStretch=i}disposeOverlays(){this._overlays=null,this._renderTargets?.dispose(1),this._renderTargets=null,this.events.emit("textures-disposed")}_useOverlayColorInsteadOfColorNoRasterImage(e){return e===1&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource}getTexture(e){const t=this._useOverlayColorInsteadOfColorNoRasterImage(e);return this._renderTargets?.getTexture(t?0:e)}get readyToRun(){return this.updating}runTask(e){this._processDrapeSources(e,()=>!0)}_onMaterialOrContentChanged(){this.renderOccludedFlags=pn(this._renderers,e=>e.hasOccluders)?ep:1}_processDrapeSources(e,t){let i=!1;for(const[r,n]of this._renderers){if(e.done)break;(r.destroyed||t(r))&&n.commitChanges()&&(i=!0,e.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,i=!0,this._updateSortedDrapeSourceRenderers(),e.madeProgress()),this.compact(e),i&&(this._overlays!=null&&this._renderers.size===0&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this._onMaterialOrContentChanged(),this.hasHighlights=pn(this._renderers,r=>r.hasHighlights),this.events.emit("content-changed"))}compact(e){let t=!1;for(const i of this._renderers.values()){if(e.done)break;t=i.compact(e)||t}return t&&this.notifyChange("updating"),t}hasHighlight(e){return pn(this._renderers,t=>t.hasHighlight(e))}processSyncDrapeSources(){this._processDrapeSources(yn,e=>e.updatePolicy===1)}get isEmpty(){return!yi.OVERLAY_DRAW_DEBUG_TEXTURE&&b0(this._renderers,e=>e.isEmpty)}get hasWater(){const e=pn(this._renderers,({hasWater:t})=>t);return e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water")),this._hasWater}renders(e){if(yi.OVERLAY_DRAW_DEBUG_TEXTURE&&e!==4&&e!==2)return!0;if(!this._overlays)return!1;const t=this._overlays[0];for(const n of this._overlays)n.setupGeometryViews(this.longitudeCyclical);if(!t.hasSomeSizedView())return!1;const i=this._renderContext.output;this._renderContext.output=this._renderTargets?.targets.find(n=>n.content===e)?.output??0,++this._techniques.precompiling;const r=this._sortedRenderers.some(({renderer:n})=>n.precompile(this._renderContext));return--this._techniques.precompiling,this._renderContext.output=i,r}get mode(){return this.isEmpty?0:this.hasWater&&this.renders(3)?2:this._renderTargets?.getTexture(0)?1:0}updateAnimation(e){let t=!1;return this._renderers.forEach(i=>t=i.updateAnimation(e)||t),t&&this.parent.requestRender(0),t}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}precompileShaders(e){if(!this._overlays||!this._renderTargets)return!1;const t=this._bindParameters;t.alignPixelEnabled=e.alignPixelEnabled,++this._techniques.precompiling;for(const i of this._renderTargets.targets){if(i.content===1&&!this._needsColorWithoutRasterImage)continue;const{output:r}=i;this._renderContext.output=r,t.slot=r===3?19:18,r===9&&(t.highlightMixTexture=t.highlights.length>1?this._rctx.emptyTexture:null);const n=this._renderContext.renderOccludedMask;i.content===4&&(this._renderContext.renderOccludedMask=ep),this._sortedRenderers.forAll(({drapeSource:a,renderer:o})=>{i.content===1&&a.drapeSourceType===0||i.content===4&&o.hasOnlyOccluders||o.precompile(this._renderContext)}),this._renderContext.renderOccludedMask=n,t.highlightMixTexture=null}return--this._techniques.precompiling,!0}drawOverlays(e,t){if(!this._overlays||!this._renderTargets)return;for(const r of this._overlays)r.setupGeometryViews(this.longitudeCyclical);this._bindParameters.alignPixelEnabled=e.alignPixelEnabled;const i=this.allSourcesOccluders;for(const r of this._renderTargets.targets){if(!(r.content===0&&this._hasDrapedFlowSource)&&!r.handleRenderRequest(t)||r.content===1&&!this._needsColorWithoutRasterImage||r.content===4&&i)continue;const n=this._drawTarget(0,r),a=this._drawTarget(1,r);(n||a)&&r.fbo.generateMipMap()}}_drawTarget(e,t){const i=this._overlays[e],r=i.canvasGeometries;if(r.numViews===0)return!1;const n=this._view.state.contentPixelRatio;this._screenToWorldRatio=n*i.mapUnitsPerPixel/this._bindParameters.overlayStretch;const{output:a}=t;if(this.isEmpty||a===3&&!this.hasWater||!i.hasSomeSizedView())return!1;const{_rctx:o,_camera:l,_renderContext:c,_bindParameters:h}=this;if(l.pixelRatio=i.pixelRatio*n,c.output=a,h.screenToWorldRatio=this._screenToWorldRatio,h.screenToPCSRatio=this._screenToWorldRatio*this.parent.worldToPCSRatio,h.slot=a===3?19:18,t.content===4&&(c.renderOccludedMask=ep),!this.renders(t.content))return c.renderOccludedMask=Ep,!1;const{resolution:d}=i,m=e===0,f=m?0:d;if(o.setViewport(f,0,d,d),this._bindTargetFBO(t),m)if(t.output!==9)o.setClearColor(0,0,0,0),o.clear(16384);else{const{gl:g}=o;g.clearBufferuiv(g.COLOR,0,[0,0,0,0])}if(yi.OVERLAY_DRAW_DEBUG_TEXTURE&&t.content!==4&&t.content!==2){this._techniques.precompile(_2,Hb);const g=this._techniques.get(_2,Hb);for(let _=0;_<r.numViews;_++)this._setViewParameters(r.extents[_],i),this._ensureDebugPatternResources(i.resolution,N8[e]),o.bindTechnique(g,h,this._passParameters),o.screen.draw()}if(t.output===9){const{fboCache:g}=this._stage.renderer,_=this._resolution;this._bindTargetFBO(t),fE(o,g,{width:_,height:_},h,()=>this._renderAllGeometry(e,t),f)}else this._renderAllGeometry(e,t);return o.bindFramebuffer(null),c.renderOccludedMask=Ep,!0}get allSourcesOccluders(){return b0(this._renderers,e=>e.hasOnlyOccluders)}_renderAllGeometry(e,t){const i=this._overlays[e],r=i.canvasGeometries;this._sortedRenderers.forAll(({drapeSource:n,renderer:a})=>{if(t.content===1&&n.drapeSourceType===0)return;const{fullOpacity:o}=n,l=o!=null&&o<1&&t.output===0&&this._bindTemporaryFBO();for(let c=0;c<r.numViews;c++)this._setViewParameters(r.extents[c],i),a.render(this._renderContext);if(l){this._bindTargetFBO(t),this._overlayParameters.texture=l.getTexture(),this._overlayParameters.opacity=o,this._overlayParameters.overlayIndex=e;const c=this._techniques.get(y2);this._rctx.bindTechnique(c,this._bindParameters,this._overlayParameters),this._rctx.screen.draw(),l.release()}})}_bindTargetFBO(e){const t=this._resolution,i=2*t;e.fbo.ensureFramebuffer(i,t),e.fbo.bind(this._rctx)}_bindTemporaryFBO(){const e=this._resolution,t=2*e,i=this._stage.renderer.fboCache,r=i.acquire(t,e,"overlay tmp");return i.rctx.bindFramebuffer(r.fbo),i.rctx.clear(16384),r}get _resolution(){return this._overlays?.[0].resolution??0}notifyContentChanged(){this.events.emit("content-changed")}intersect(e,t,i,r){this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers();let n=0;for(const{renderer:a}of this._sortedRenderers)n=a.intersect?.(e,t,i,r,n)??n}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),this._renderers.size===0)return;const e=this._view.map.allLayers.map(i=>i.uid),t=e.length;this._renderers.forEach((i,r)=>{const n=e.indexOf(r.layer?.uid),a=n>=0,o=r.renderGroup??(a?0:1),l=r.drapeSourcePriorityOffset??0,c=t*o+(a?n:0)+l;this._sortedRenderers.push(new B8(r,i,c))}),this._sortedRenderers.sort((i,r)=>i.index-r.index)}_setViewParameters(e,t){const i=this._camera;i.viewport=[0,0,t.resolution,t.resolution],eV(i.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],i.near,i.far),Y$(i.viewMatrix,[-e[0],-e[1],0])}_ensureDebugPatternResources(e,t){if(be(this._passParameters.color,t[0],t[1],t[2]),this._passParameters.texture)return;const i=new Uint8Array(e*e*4);let r=0;for(let a=0;a<e;a++)for(let o=0;o<e;o++){const l=Math.floor(o/10),c=Math.floor(a/10);l<2||c<2||10*l>e-20||10*c>e-20?(i[r++]=255,i[r++]=255,i[r++]=255,i[r++]=255):(i[r++]=255,i[r++]=255,i[r++]=255,i[r++]=1&l&&1&c?1&o^1&a?0:255:1&l^1&c?0:128)}const n=new ft(e);n.samplingMode=9728,this._passParameters.texture=new bt(this._rctx,n,i)}get test(){}};u([p()],Un.prototype,"hasHighlights",void 0),u([p()],Un.prototype,"renderOccludedFlags",void 0),u([p()],Un.prototype,"_sortedDrapeSourceRenderersDirty",void 0),u([p({constructOnly:!0})],Un.prototype,"parent",void 0),u([p({readOnly:!0})],Un.prototype,"_techniques",null),u([p({type:Boolean,readOnly:!0})],Un.prototype,"updating",null),u([p()],Un.prototype,"isEmpty",null),Un=u([R("esri.views.3d.terrain.OverlayRenderer")],Un);let B8=class{constructor(e,t,i){this.drapeSource=e,this.renderer=t,this.index=i}};const N8=[[1,.5,.5],[.5,.5,1]],cce=-2,ep=4,Hb=new ME;Hb.hasAlpha=!0;let qb=class{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}clear(){this.adds.length=0,this.removes.length=0,this.updates.length=0}prune(){this.clear()}get empty(){return this.adds.length===0&&this.removes.length===0&&this.updates.length===0}},U8=class{},H8=class{constructor(e){this.pending=e,this.adds=new Array,this.removes=new Array,this.updates=new Array}clearAddsAndRemoves(){this.adds.forEach(e=>Lr(this.pending.adds,e)),this.removes.forEach(e=>Lr(this.pending.removes,e)),this.adds.length=0,this.removes.length=0}clearUpdates(){this.updates.forEach(e=>Lr(this.pending.updates,e)),this.updates.length=0}clear(){this.clearUpdates(),this.clearAddsAndRemoves()}};function q8(s){const e=new Map,t=i=>{let r=e.get(i);return r||(r=new H8(s),e.set(i,r)),r};return s.removes.forEach(i=>{Pv(i)&&t(i.material).removes.push(i)}),s.adds.forEach(i=>{Pv(i)&&t(i.material).adds.push(i)}),s.updates.forEach(i=>{Pv(i.renderGeometry)&&t(i.renderGeometry.material).updates.push(i)}),e}function Pv(s){return s.geometry.indexCount>=1}let j1=class{constructor(e=0,t=0){this.from=e,this.to=t}get numElements(){return this.to-this.from}};function v2(s){if(s.length<2)return;const e=new Map;s.forAll(i=>e.set(i.from,i));let t=!0;for(;t;){t=!1;for(let i=0;i<s.length;++i){const r=s.data[i],n=e.get(r.to);n&&(r.to=n.to,e.delete(n.from),s.removeUnordered(n),t=!0)}}}let b2=class extends j1{constructor(e,t,i,r){super(t,i),this.geometry=e,this._highlightName=null,this.updateHighlightOptions(r)}updateHighlightOptions(e){const{geometry:t}=this;if(!t.hasHighlights)return void(this._highlightName=null);let i=-1,r=null;t.foreachHighlightOptions(n=>{const a=e.get(n)??-1;a>i&&(i=a,r=n)}),this._highlightName=r}get highlightName(){return this._highlightName}get isVisible(){return this.geometry.visible}get hasHighlights(){return this.isVisible&&this.geometry.hasHighlights}get hasOccludees(){return this.geometry.occludees!=null}},G8=class{constructor(e){this.baseInstanceData=e,this.dataByOrigin=new Map}get id(){return this.baseInstanceData?.baseInstance.id??Hd}dispose(){for(const e of this.dataByOrigin.values())e.dispose();this.dataByOrigin.clear(),this.baseInstanceData?.dispose()}},j8=class{constructor(e,t,i){this.baseInstance=e,this.baseInstanceBuffer=t,this.baseCommand=i}dispose(){this.baseInstanceBuffer.dispose()}},RE=class{constructor(){this.first=0,this.count=0}},W8=class{constructor(e,t){this.vao=e,this.instanceCount=t}dispose(){this.vao.disposeVAOOnly()}},Q8=class{constructor(){this.commandVAOs=new qa,this.drawCommandsDefault=new Array,this.drawCommandsHighlights=new Map,this.drawCommandsOccludees=new Array,this.drawCommandsShadowHighlightRest=new Array}clear(){this.commandVAOs.clear(),this.drawCommandsDefault.length=0,this.drawCommandsHighlights.clear(),this.drawCommandsOccludees.length=0,this.drawCommandsShadowHighlightRest.length=0}dispose(){for(const e of this.commandVAOs.values())e.dispose();this.clear()}},w2=class{constructor(e){this.targetBuffer=e,this.vaoEndElement=0,this._numElements=0,this._instances=new Map,this.holes=new zt({allocator:t=>t||new j1,deallocator:null}),this.hasHiddenInstances=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.highlightNames=new Set,this.drawCommandsDefault=ef(),this.drawCommandsHighlights=new Map,this.drawCommandsOccludees=ef(),this.drawCommandsShadowHighlightRest=ef(),this._instancedCommandVAOs=null}get numElements(){return this._numElements}get instances(){return this._instances}get writeableInstances(){return this._instances}get hasHighlights(){return this.highlightNames.size>0}get instancedCommandVAOs(){return this._instancedCommandVAOs}resetInstanceSummary(){this.hasHiddenInstances=!1,this.hasOccludees=!1,this.highlightNames.clear()}updateIfDrawCommandsDirty(e){if(this.drawCommandsDirty){this.resetInstanceSummary();for(const t of this.instances.values())this.updateDrawState(t);this.updateDrawCommands(e)}}addInstance(e,t){this.deleteInstance(e),this._instances.set(e,t),this._numElements+=t.numElements}deleteInstance(e){const t=this._instances.get(e);t&&(this._numElements-=t.numElements,this._instances.delete(e))}updateInstances(){let e=0;for(const t of this._instances.values())e+=t.numElements,this.updateDrawState(t);this._numElements=e}updateDrawState(e){if(e.isVisible){const{highlightName:t}=e;t&&this.highlightNames.add(t),e.hasOccludees&&(this.hasOccludees=!0)}else this.hasHiddenInstances=!0}updateDrawCommands(e){this._updateDrawCommands(e),this._updateInstancedCommandVAOs()}_updateDrawCommands(e){if(this.drawCommandsDefault.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsDirty=!1,this._instances.size===0)return;const{sortedInstances:t}=this;if(this._updateHighlightDrawCommands(e,t),!this.needsMultipleCommands){const i=this.drawCommandsDefault.pushNew(),r=this.holes.front();return this.vao&&this.holes.length===1&&r.to===this.vaoEndElement?(i.first=0,void(i.count=r.from)):(i.first=1/0,i.count=0,this._instances.forEach(n=>{i.first=Math.min(i.first,n.from),i.count=Math.max(i.count,n.to)}),void(i.count-=i.first))}for(const i of t)i.isVisible&&Mv(i.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,i)}get sortedInstances(){return Array.from(this._instances.values()).sort((e,t)=>e.from===t.from?e.to-t.to:e.from-t.from)}updateHighlights(e){this.highlightNames.clear();const t=this.sortedInstances;for(const i of t)i.updateHighlightOptions(e),i.isVisible&&i.highlightName&&this.highlightNames.add(i.highlightName);this._updateHighlightDrawCommands(e),this._updateInstancedCommandVAOs()}_updateHighlightDrawCommands(e,t=this.sortedInstances){const{drawCommandsHighlights:i,drawCommandsShadowHighlightRest:r}=this;i.clear(),r.clear();for(const n of t){if(n.updateHighlightOptions(e),!n.isVisible)continue;const{highlightName:a}=n;a&&(this.highlightNames.add(a),Mv(Aa(i,a,ef),n)),a&&a===aa||Mv(r,n)}}_updateInstancedCommandVAOs(){const e=this.vao;if(this.targetBuffer==="geometry"||e==null)return;this._instancedCommandVAOs??=new Q8;const t=this._instancedCommandVAOs,i=t.commandVAOs.copy();t.clear();const r=t.commandVAOs,n=(a,o)=>{for(const l of a){const{first:c,count:h}=l,d=r.get(c,h)??i.pop(c,h)??new W8(e.shallowCloneWithBaseInstances(new Map([["instances",l.first]])),l.count);r.set(c,h,d),o.push(d)}};n(this.drawCommandsDefault,t.drawCommandsDefault);for(const[a,o]of this.drawCommandsHighlights){const l=new Array;n(o,l),t.drawCommandsHighlights.set(a,l)}n(this.drawCommandsOccludees,t.drawCommandsOccludees),n(this.drawCommandsShadowHighlightRest,t.drawCommandsShadowHighlightRest);for(const a of i.values())a.dispose();i.clear()}get needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}};function Z8(s){return s.vao!=null}function x2(s){return s?"instances":"geometry"}function ef(){return new zt({allocator:s=>s||new RE,deallocator:s=>s})}function Mv(s,e){const t=s.back();if(t==null){const i=s.pushNew();return i.first=e.from,void(i.count=e.numElements)}if(X8(t,e)){const i=e.from-t.first+e.numElements;t.count=i}else{const i=s.pushNew();i.first=e.from,i.count=e.numElements}}function X8(s,e){return s.first+s.count>=e.from}let Y8=class{constructor(e,t){this.origin=e,this.isInstanced=t,this.buffers=new Array}dispose(){if(this.isInstanced)for(const e of this.buffers)e.vao.buffer("instances")?.dispose(),e.vao.disposeVAOOnly(),e.instancedCommandVAOs?.dispose();else for(const e of this.buffers)e.vao.dispose();this.buffers.length=0}findBuffer(e){return this.buffers.find(t=>t.instances.has(e))}},C2=class{constructor(e,t){this._rctx=t,this._bufferWriter=e.createBufferWriter(),this._vaoCache=t.getVaoCache(Vr(this._bufferWriter.layout))}maxElements(e){return Math.floor(Rv/this._targetStrideFloats(e))}_targetStrideFloats(e){return this._targetStrideBytes(e)/4}_targetStrideBytes(e){return this._targetLayout(e)?.stride??0}_targetLayout(e){return e==="geometry"?this._bufferWriter.layout:this._bufferWriter.instanceLayout}endElement(e){return Math.floor((e.vao?.getByteLength(e.targetBuffer)??0)/this._targetStrideBytes(e.targetBuffer))}evaluateBufferAllocation(e,t,i,r){const n=this._targetStrideFloats(r.targetBuffer),a=t.reduce((d,{geometry:m})=>d+this.elementCount(m),0),o=i.reduce((d,{geometry:m})=>d+this.elementCount(m),0),l=Math.min((e+a-o)*n,Rv),c=r.vao?.buffer(r.targetBuffer),h=(c?.sizeBytes??0)/4;return l>tp&&l<h/2?0:l>h?1:2}deleteBuffer(e){if(e.targetBuffer==="instances")return e.instancedCommandVAOs?.dispose(),e.vao?.buffer("instances")?.dispose(),e.vao?.disposeVAOOnly(),void(e.vao=null);this._vaoCache.deleteVao(e.vao)}createBaseInstanceData(e){const{_bufferWriter:t}=this;if(e==null||t.writeBaseInstance==null||t.elementCountBaseInstance==null)return null;const i=t.layout,r=t.elementCountBaseInstance(e.attributes),n=r*this._targetStrideFloats("geometry"),a=new Kt(this._rctx,Vr(i));a.setSize(Math.ceil(4*n));const o=hl(n),l=i.createView(o.buffer);t.writeBaseInstance(e.attributes,l),a.setSubData(o,0,0,n);const c=new RE;return c.first=0,c.count=r,new j8(e,a,c)}_allocateInstanceBuffer(e){const t=this._bufferWriter.instanceLayout;Wt(t!=null,"Trying to allocate an instance buffer, but the BufferWriter does not support instancing");const i=e*this._targetStrideFloats("instances"),r=new Kt(this._rctx,Vr(t,1));return r.setSize(Ov(i)),r}_createInstancedVao(e,t){return new Mn(this._rctx,new Map([["geometry",e],["instances",t]]))}reallocateBuffer(e,t,i){if(this.deleteBuffer(t),e!=null){const n=e.baseInstanceBuffer,a=this._allocateInstanceBuffer(i);return this._createInstancedVao(n,a)}const r=i*this._targetStrideFloats("geometry");return this._vaoCache.newVao(Ov(r))}elementCount(e){return this._bufferWriter.elementCount(e.attributes)}canGrow(e,t){const{targetBuffer:i,vao:r}=e;if(r==null)return!0;const n=4*(t*this._targetStrideFloats(i));return r.getByteLength(i)<Ov(Rv-tp)&&n>r.getByteLength(i)}clearHoles(e,{vao:t,targetBuffer:i}){const r=this._targetStrideFloats(i),n=e.reduce((l,c)=>Math.max(l,c.numElements),0)*r,a=hl(n);a.fill(0,0,n);const o=t.buffer(i);for(const l of e)o?.setSubData(a,l.from*r,0,l.numElements*r)}clearHolesMetal(e,t,i,{vao:r,targetBuffer:n}){const a=this._targetStrideFloats(n),o=(i-t)*a,l=hl(o),c=this._targetLayout(n).createView(l.buffer);l.fill(0,0,o);for(const h of e){if(!(h.from>=t&&h.to<=i))continue;const d=h.from-t;this._writeGeometry(h.geometry,c,d)}r.buffer(n)?.setSubData(l,t*a,0,o)}writeRandomInstances(e,t,{vao:i,targetBuffer:r}){const n=this._targetStrideFloats(r),a=hl(e*n),o=this._targetLayout(r).createView(a.buffer);let l=0,c=0,h=0;const d=i.buffer(r);for(const f of t){if(h!==f.from){const g=h-c;g>0&&d?.setSubData(a,c*n,0,g*n),c=f.from,l=0}this._writeGeometry(f.geometry,o,l),l+=f.numElements,h=f.to}const m=h-c;m>0&&d?.setSubData(a,c*n,0,m*n)}writeInstanceRangeMetal(e,t,i,{vao:r,targetBuffer:n}){const a=this._targetStrideFloats(n),o=e-t,l=o*a,c=hl(l),h=this._targetLayout(n).createView(c.buffer);c.fill(0,0,l);for(const d of i){if(!(d.from>=t&&d.to<=e))continue;const m=d.from-t;this._writeGeometry(d.geometry,h,m)}o>0&&r.buffer(n)?.setSubData(c,t*a,0,l)}rebuildInstances(e,t,{vao:i,targetBuffer:r}){const n=this._targetStrideFloats(r),a=hl(e*n),o=this._targetLayout(r).createView(a.buffer);let l=0;for(const c of t){this._writeGeometry(c.geometry,o,l);const h=l;l+=this.elementCount(c.geometry.geometry),c.from=h,c.to=l}return i?.buffer(r)?.setSubData(a,0,0,l*n),l}updateInstance(e,{vao:t,targetBuffer:i}){const{_bufferWriter:r}=this,n=this._targetStrideFloats(i),a=hl(r.elementCount(e.geometry.geometry.attributes)*n),o=this._targetLayout(i).createView(a.buffer);this._writeGeometry(e.geometry,o,0),t.buffer(i)?.setSubData(a,e.from*n,0,e.numElements*n)}updateInstancesMetal(e){for(const[t,i]of e){let r=1/0,n=-1/0;for(const a of i)r=Math.min(r,a.from),n=Math.max(n,a.to);this.writeInstanceRangeMetal(n,r,t.instances.values(),t)}}_writeGeometry(e,t,i){const{_bufferWriter:r}=this;r!=null&&(Fr(zc,e.transformation),zc[12]-=e.localOrigin.vec3[0],zc[13]-=e.localOrigin.vec3[1],zc[14]-=e.localOrigin.vec3[2],eu(tf,zc),K$(tf,tf),r.write(zc,tf,e.geometry.attributes,e.geometry.olidColor,t,i))}static prune(){ng=new Float32Array(tp)}};const zc=Ie(),tf=Ie(),tp=65536,$v=4*tp,T2=1024,OE=16777216,Rv=OE/4;let ng=new Float32Array(tp);function hl(s){return ng.length<s&&(ng=new Float32Array(s)),ng}function Ov(s){const e=4*s;return e<=T2?T2:e<$v?E5(e):Math.max(Math.min(Math.ceil(1.5*e/$v)*$v,OE),e)}let Il=class extends te{constructor(e){super(e),this._vaoWriter=null,this._useMetalWorkaround=!1,this._hasOccludees=!1}destroy(){this.uninitializeRenderContext()}initializeRenderContext(e){this._useMetalWorkaround=e.renderContext.rctx.isAssumedMetalDriver,this._vaoWriter=new C2(this.material,e.renderContext.rctx)}uninitializeRenderContext(){this._useMetalWorkaround=!1,this._vaoWriter=null}get hasOccludees(){return this._hasOccludees}modify(e,t){this._applyUpdates(e,t),this._applyAddsAndRemoves(e),this._updateDrawCommands()}get canCompact(){for(const e of this.dataByBaseInstance.values())for(const t of e.dataByOrigin.values())if(t.buffers.some(i=>i.holes.length>1))return!0;return!1}compact(e){if(!this.canCompact)return!1;let t=!1;for(const i of this.dataByBaseInstance.values())for(const r of i.dataByOrigin.values()){const n=new Array;for(let a=0;a<r.buffers.length&&!e.done;){const o=r.buffers[a];o.holes.length<=1?++a:(o.instances.forEach(({geometry:l})=>n.push(l)),this._vaoWriter?.deleteBuffer(o),Lr(r.buffers,o,void 0,{last:a}),e.madeProgress())}if(n.length>0){const{baseInstanceData:a}=i;r.buffers.forEach(l=>this._applyAdds(a,l,n));const o=x2(a!=null);for(;n.length>0;)r.buffers.push(this._applyAndRebuild(a,new w2(o),n,null));t=!0}}return t}updateHighlights(e){this.highlightOrderMap=e;for(const t of this.dataByBaseInstance.values())for(const i of t.dataByOrigin.values())for(const r of i.buffers)r.updateHighlights(e)}_applyUpdates(e,t){const i=this._vaoWriter;if(i==null)return void e.clearUpdates();let r;const n=this._useMetalWorkaround?(a,o)=>{r??=new Map;let l=r.get(o);l||(l=[],r.set(o,l)),l.push(a)}:(a,o)=>i.updateInstance(a,o);for(const a of e.updates){if(t.done)return;const{renderGeometry:o,updateType:l}=a;Lr(e.pending.updates,a),t.madeProgress();const c=this.dataByBaseInstance.get(o.geometry.baseGeometry?.id??Hd),h=c?.dataByOrigin.get(o.localOrigin.id)?.findBuffer(o.id);if(h==null)return;const d=h.instances.get(o.id);6&l&&n(d,h),25&l&&(h.drawCommandsDirty=!0)}r&&i.updateInstancesMetal(r)}_computeDeltas(e,t){const i=new Map;for(const r of e){const n=r.localOrigin;if(n==null)continue;const a=r.geometry.baseGeometry,o=Aa(i,a??null,P2);let l=o.get(n,null);l==null&&(l=new S2(n.vec3,a),o.set(n,null,l)),l.changes.push(r)}for(const r of t){const n=r.localOrigin;if(n==null)continue;const a=r.geometry.baseGeometry,o=this.dataByBaseInstance.get(a?.id??Hd),l=o?.dataByOrigin.get(n.id)?.findBuffer(r.id);if(l==null)continue;const c=Aa(i,a??null,P2);let h=c.get(n,l);h==null&&(h=new S2(n.vec3,a),c.set(n,l,h)),h.changes.push(r)}return i}_applyAddsAndRemoves(e){const{_vaoWriter:t,dataByBaseInstance:i}=this;if(t==null)return void e.clearAddsAndRemoves();const r=this._computeDeltas(e.adds,e.removes);for(const[n,a]of r){const o=Aa(i,n?.id??Hd,()=>new G8(t.createBaseInstanceData(n))),l=n!=null;for(const[c,h]of a.outerMap()){const d=h.get(null),m=d?.changes??[];a.delete(c,null);const f=Aa(o.dataByOrigin,c.id,()=>new Y8(c.vec3,l));for(const[g,_]of h){if(a.delete(c,g),g==null&&Wt(!1,"No VAO for removed geometries"),g.instances.size===_.changes.length){t.deleteBuffer(g),Lr(f.buffers,g),f.buffers.length===0&&m.length===0&&o.dataByOrigin.delete(c.id);continue}const v=g.numElements;switch(t.evaluateBufferAllocation(v,m,_.changes,g)){case 0:_.changes.forEach(({id:b})=>g.deleteInstance(b)),g.instances.forEach(({geometry:b})=>m.push(b)),t.deleteBuffer(g),Lr(f.buffers,g);break;case 1:this._applyAndRebuild(o.baseInstanceData,g,m,_);break;case 2:this._applyRemoves(g,_)}}if(m.length>0){const{baseInstanceData:g}=o,_=x2(l);for(const v of f.buffers)this._applyAdds(g,v,m);for(;m.length>0;)f.buffers.push(this._applyAndRebuild(g,new w2(_),m,null))}}o.dataByOrigin.size===0&&(o.dispose(),i.delete(o.id))}e.clearAddsAndRemoves()}_updateDrawCommands(){this._hasOccludees=!1;for(const e of this.dataByBaseInstance.values())for(const t of e.dataByOrigin.values())for(const i of t.buffers)i.updateIfDrawCommandsDirty(this.highlightOrderMap),this._hasOccludees||=i.hasOccludees}_applyAndRebuild(e,t,i,r){if(r)for(const h of r.changes)t.deleteInstance(h.id);const n=this._vaoWriter,a=n.maxElements(t.targetBuffer);let o=t.numElements;for(;i.length>0;){const h=i.pop(),d=n.elementCount(h.geometry);if(o+d>a&&o>0){i.push(h);break}o+=d;const m=new b2(h,0,0,this.highlightOrderMap);Wt(t.instances.get(h.id)==null),t.addInstance(h.id,m)}t.resetInstanceSummary(),t.vao=n.reallocateBuffer(e,t,o),t.vaoEndElement=n.endElement(t);const l=n.rebuildInstances(o,t.writeableInstances.values(),t);t.updateInstances(),t.holes.clear();const c=t.holes.pushNew();return c.from=l,c.to=t.vaoEndElement,t.updateDrawCommands(this.highlightOrderMap),t}_applyRemoves(e,t){const{_vaoWriter:i}=this;if(t.changes.length===0||i==null)return;let r=1/0,n=-1/0;for(const a of t.changes){const o=a.id,l=e.instances.get(o);if(!l)continue;e.deleteInstance(o),this._useMetalWorkaround&&(r=Math.min(r,l.from),n=Math.max(n,l.to));const c=fa.back();if(c){if(c.to===l.from){c.to=l.to;continue}if(c.from===l.to){c.from=l.from;continue}}const h=fa.pushNew();h.from=l.from,h.to=l.to}v2(fa),this._useMetalWorkaround?i.clearHolesMetal(e.instances.values(),r,n,e):i.clearHoles(fa,e),e.holes.pushArray(fa.data,fa.length),fa.forAll((a,o)=>fa.data[o]=null),fa.clear(),e.drawCommandsDirty=!0}_applyAdds(e,t,i){if(i.length===0||this._vaoWriter==null)return;if(!Z8(t))return void this._applyAndRebuild(e,t,i,null);const r=this._vaoWriter,n=t.numElements,a=i.reduce((m,{geometry:f})=>m+r.elementCount(f),0),o=Math.min(n+a,r.maxElements(t.targetBuffer));if(r.canGrow(t,o))return void this._applyAndRebuild(e,t,i,null);v2(t.holes);const l=new Array;let c=1/0,h=-1/0;for(const{geometry:m}of i){const f=r.elementCount(m),g=K8(t.holes,f);l.push(g),this._useMetalWorkaround&&g!=null&&(c=Math.min(g,c),h=Math.max(g+f,h))}const d=this._addInstances(i,t,l);if(this._useMetalWorkaround){for(const m of d);r.writeInstanceRangeMetal(h,c,t.instances.values(),t)}else r.writeRandomInstances(o,d,t);yw(i,(m,f)=>l[f]==null)}*_addInstances(e,t,i){const r=e.length,n=this._vaoWriter;for(let a=0;a<r;++a){const o=i[a];if(o==null)continue;const l=e[a],c=n.elementCount(l.geometry),h=new b2(l,o,o+c,this.highlightOrderMap);Wt(t.instances.get(l.id)==null),t.addInstance(l.id,h),t.drawCommandsDirty=!0,yield h}}static prune(){C2.prune()}};u([p({constructOnly:!0})],Il.prototype,"dataByBaseInstance",void 0),u([p({constructOnly:!0})],Il.prototype,"material",void 0),u([p()],Il.prototype,"highlightOrderMap",void 0),Il=u([R("esri.views.3d.webgl-engine.materials.renderers.MergedBuffer")],Il);let S2=class{constructor(e,t){this.origin=e,this.baseInstance=t,this.changes=new Array}};function K8(s,e){const t=s.find(r=>r.numElements>=e);if(t==null)return null;const i=t.from;return t.from+=e,t.from>=t.to&&s.removeUnordered(t),i}const fa=new zt({allocator:s=>s||new j1,deallocator:null});function P2(){return new qa}let J8=class{constructor(e,t){this._material=e,this._repository=t,this._map=new Map}dispose(){this._map.forEach((e,t)=>{e!=null&&this._repository.release(this._material,t)})}load(e,t,i){if(!this._material.produces.get(t)?.(i))return null;this._map.has(i)||this._map.set(i,this._repository.acquire(this._material,t,i));const n=this._map.get(i);if(n){if(n.ensureResources(e)===2)return n;this._repository.requestRender()}return null}},DE=class extends oL{constructor(e=x()){super(),this.origin=e}get slicePlaneLocalOrigin(){return this.origin}},Pd=class extends te{constructor(e){super(e),this._glMaterials=null,this._drawParameters=new DE,this._highlightNames=new Set,this._produces=new Map}initialize(){this._updateProduces()}destroy(){this.uninitializeRenderContext()}get _hasHighlights(){return this._highlightNames.size>0}hasHighlight(e){return this._highlightNames.has(e)}get produces(){return this._produces}_updateProduces(){this.material.produces.forEach((e,t)=>{this._produces.set(t,i=>!(this.dataByBaseInstance.size===0||!(i!==9&&i!==5||this._hasHighlights))&&e(i))})}initializeRenderContext(e){this._glMaterials=new J8(this.material,e.materials)}uninitializeRenderContext(){this._glMaterials=_e(this._glMaterials)}acquireTechniques(e){if(!this.material.shouldRender(e))return null;const{output:t,bind:i}=e;if(!this.material.produces.get(i.slot)?.(t))return null;const{highlight:n,slot:a}=i,o=t===5,l=t===9,c=l||o,h=n?.name;if(c&&(this._highlightNames.size===0||l&&h&&!this._highlightNames.has(h)))return null;const d=g=>l&&!!h&&!g.has(h),m=t===6,f=!(c||m);for(const g of this.dataByBaseInstance.values())for(const _ of g.dataByOrigin.values())for(const v of _.buffers){if(d(v.highlightNames))continue;const b=o?v.drawCommandsHighlights.get(aa):c?h?v.drawCommandsHighlights.get(h):v.drawCommandsHighlights.size>0:((m&&v.needsMultipleCommands?v.drawCommandsShadowHighlightRest:v.drawCommandsDefault)||null)?.length??!1,T=f&&v.drawCommandsOccludees||null;if(b||T?.length){const w=this._glMaterials.load(e.rctx,a,t),S=w?.beginSlot(i);if(S)return S}}return null}render(e,t){const{output:i,bind:r}=e,{slot:n,highlight:a}=r,o=i===9,l=a?.name??"";if(o&&!a)return;const c=i===5,h=o||c,d=i===6,m=!(h||d),f=n===10||n===11?n:null,{rctx:g}=e;g.runAppleAmdDriverHelper();const _=g.bindTechnique(t,r,this.material.parameters);for(const v of this.dataByBaseInstance.values()){const{baseInstanceData:b}=v,T=b!=null,w=T?s7:i7,S=T?t7:e7;for(const C of v.dataByOrigin.values()){this._drawParameters.origin=C.origin;for(const P of C.buffers){if(o&&(!P.hasHighlights||!P.drawCommandsHighlights.has(l))||c&&(!P.hasHighlights||!P.drawCommandsHighlights.has(aa)))continue;const M=S(P),O=r7(M,P.needsMultipleCommands,l,c,h,d),D=n7(M,m);(O?.length||D?.length)&&(_.bindDraw(r,this.material.parameters,this._drawParameters),w(g,P,b,t,O,D,f))}}}}updateHighlights(){const{_highlightNames:e}=this;e.clear();for(const t of this.dataByBaseInstance.values())for(const i of t.dataByOrigin.values())for(const r of i.buffers)for(const n of r.highlightNames)e.add(n);this._updateProduces()}get test(){}};u([p({constructOnly:!0})],Pd.prototype,"material",void 0),u([p({constructOnly:!0})],Pd.prototype,"dataByBaseInstance",void 0),Pd=u([R("esri.views.3d.webgl-engine.materials.renderers.VaoRenderer")],Pd);const e7=s=>s,t7=s=>s.instancedCommandVAOs,i7=(s,{vao:e},t,i,r,n,a)=>{i.ensureAttributeLocations(e),s.bindVAO(e),M2(s,i,r,a,!1),M2(s,i,n,a,!0)},s7=(s,e,{baseCommand:t},i,r,n,a)=>{$2(s,i,t,r,a,!1),$2(s,i,t,n,a,!0)};function M2(s,e,t,i,r){if(t?.length){s.setPipelineState(e.getPipeline(r,i));for(const n of t)s.drawArrays(e.primitiveType,n.first,n.count)}}function $2(s,e,{first:t,count:i},r,n,a){if(r?.length){s.setPipelineState(e.getPipeline(a,n));for(const{vao:o,instanceCount:l}of r)e.ensureAttributeLocations(o),s.bindVAO(o),s.drawArraysInstanced(e.primitiveType,t,i,l)}}function r7(s,e,t,i,r,n){const a=r&&!i?s.drawCommandsHighlights.get(t)??null:null;return i?s.drawCommandsHighlights.get(aa):r?a:n&&e?s.drawCommandsShadowHighlightRest:s.drawCommandsDefault}function n7(s,e){return e&&s.drawCommandsOccludees||null}let Fh=class extends Wp{constructor(e){super(e),this._dataByBaseInstance=new Map,this._buffer=null,this._renderer=null,this.drapedPriority=0}initialize(){this._buffer=new Il({material:this.material,dataByBaseInstance:this._dataByBaseInstance,highlightOrderMap:this.highlightOrderMap}),this._renderer=new Pd({material:this.material,dataByBaseInstance:this._dataByBaseInstance})}destroy(){for(const e of this._dataByBaseInstance.values())e.dispose();this._dataByBaseInstance.clear(),this._buffer.destroy(),this._renderer.destroy()}hasHighlight(e){return this._renderer.hasHighlight(e)}initializeRenderContext(e){this._buffer.initializeRenderContext(e),this._renderer.initializeRenderContext(e)}uninitializeRenderContext(){this._buffer.uninitializeRenderContext(),this._renderer.uninitializeRenderContext()}get produces(){return this._renderer.produces}get hasOccludees(){return this._buffer.hasOccludees}get hasOnlyOccluders(){return!!(-2&this.renderOccludedFlags)}get hasEmitters(){return this.material.hasEmissions}get isDecoration(){return this.material.parameters.isDecoration}get renderOccludedFlags(){return this.material.renderOccludedFlags}get numGeometries(){let e=0;for(const t of this._dataByBaseInstance.values())for(const i of t.dataByOrigin.values())e+=i.buffers.reduce((r,n)=>r+n.instances.size,0);return e}get usedMemory(){let e=0;for(const t of this._dataByBaseInstance.values())for(const i of t.dataByOrigin.values())e+=i.buffers.reduce((r,n)=>r+n.vao.usedMemory,0);return e}forEachGeometry(e){for(const t of this._dataByBaseInstance.values())for(const i of t.dataByOrigin.values())for(const r of i.buffers)for(const{geometry:n}of r.instances.values())e(n)}modify(e,t){this._buffer.modify(e,t),this._renderer.updateHighlights()}get canCompact(){return this._buffer.canCompact}compact(e){return this._buffer.compact(e)}updateHighlights(e){this.highlightOrderMap=e,this._buffer.updateHighlights(e),this._renderer.updateHighlights()}updateAnimation(e){return this.material.update(e)}acquireTechniques(e){return this._renderer.acquireTechniques(e)}render(e,t){return this._renderer.render(e,t)}static prune(){Il.prune()}get test(){}};u([p({constructOnly:!0})],Fh.prototype,"material",void 0),u([p()],Fh.prototype,"highlightOrderMap",void 0),Fh=u([R("esri.views.3d.webgl-engine.materials.renderers.MergedRenderer")],Fh);let ip=class extends te{constructor(e){super(e),this._renderers=new Map}destroy(){this._renderers.forEach(e=>!e.destroyed&&e.destroy()),this._renderers.clear()}initialize(){this.addHandles($(()=>this.stage.view.state.highlights,()=>this.updateHighlights()))}getMaterialRenderer(e){return this._renderers.get(e)}updateHighlights(){this._renderers.forEach(e=>e.updateHighlights(this.stage.view.state.highlightOrderMap))}commit(e,t,i){const{adds:r,removes:n,updates:a}=e;if(r.length===0&&n.length===0&&a.length===0)return!1;q8(e).forEach((l,c)=>{if(t.done)return;let h=this._renderers.get(c);h==null&&l.adds.length>0&&(h=new Fh({material:c,highlightOrderMap:this.stage.view.state.highlightOrderMap}),h.initializeRenderContext(i),this.rendererAdded(h),this._renderers.set(c,h)),h?(h.modify(l,t),h.updateHighlights(this.stage.view.state.highlightOrderMap),h.numGeometries===0&&(this._renderers.delete(h.material),this.rendererRemoved(h),h.destroy())):(l.clear(),t.madeProgress())});let o=0;for(const l of this._renderers.values())l.drapedPriority=o++;return!0}get canCompact(){for(const e of this._renderers.values())if(e.canCompact)return!0;return!1}compact(e){let t=!1;for(const i of this._renderers.values()){if(e.done)return t;t=i.compact(e)||t}return t}get renderers(){return this._renderers}};u([p({constructOnly:!0})],ip.prototype,"stage",void 0),ip=u([R("esri.views.3d.webgl-engine.lib.RendererBase")],ip);let Hn=class extends ip{constructor(e){super(e),this._pending=new a7,this._changes=new qb,this._sortedRenderers=new zt,this._geometries=new Map,this._hasHighlights=!1,this._hasWater=!1}destroy(){this.destroyed||(this._changes.prune(),this._sortedRenderers.prune(),this._geometries.clear(),this._pending.clear())}get updating(){return!this._pending.empty||this._changes.updates.length>0}get rctx(){return this.rendererContext.rctx}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}hasHighlight(e){return pn(this.renderers,t=>t.hasHighlight(e))}get hasWater(){return this._hasWater}get hasOccluders(){return this.renderers&&pn(this.renderers,e=>e.hasOnlyOccluders)}get hasOnlyOccluders(){return b0(this.renderers,e=>e.hasOnlyOccluders)}get isEmpty(){return!this.updating&&this.renderers.size===0&&this._geometries.size===0}get sortedRenderers(){return this._sortedRenderers}commitChanges(){return!!this.updating&&(this._processAddsRemoves(),this.commit(this._changes,yn,this.rendererContext.pluginContext)&&(this._updateSortedMaterialRenderers(),this._hasHighlights=pn(this.renderers,e=>{const t=e.produces.get(18);return!!t&&t(9)}),this._hasWater=pn(this.renderers,e=>{const t=e.produces.get(19);return!!t&&t(3)})),this.notifyChange("updating"),!0)}rendererAdded(){this._sortedRenderers.clear()}rendererRemoved(){this._sortedRenderers.clear()}addGeometries(e,t){if(e.length===0)return;const i=this._validateRenderGeometries(e);for(const n of i)this._geometries.set(n.id,n);const r=this._pending.empty;for(const n of i)this._pending.adds.add(n);switch(r&&this.notifyChange("updating"),t){case 0:this._notifyGraphicVisibilityChanged(e);break;case 1:this._notifyGraphicGeometryChanged(e)}}removeGeometries(e,t){if(this.destroyed)return;const i=this._pending.empty,r=this._pending.adds;for(const n of e)r.has(n)?(this._pending.removed.add(n),r.delete(n)):this._pending.removed.has(n)||this._pending.removes.add(n),this._geometries.delete(n.id);i&&!this._pending.empty&&this.notifyChange("updating"),t===1&&this._notifyGraphicGeometryChanged(e)}modifyGeometries(e,t){const i=this._changes.updates.length===0;for(const r of e){const n=new U8;this._changes.updates.push(n),n.renderGeometry=this._ensureValidRenderGeometry(r),n.updateType=t}switch(i&&this._changes.updates.length>0&&this.notifyChange("updating"),t){case 4:case 2:return this._notifyGraphicGeometryChanged(e);case 1:return this._notifyGraphicVisibilityChanged(e)}}updateAnimation(e){let t=!1;return this._sortedRenderers.forAll(i=>t=!!i.updateAnimation&&i.updateAnimation(e)||t),t}precompile(e){return this._sortedRenderers.reduce((t,i)=>i.precompile(e)||t,!1)}render(e){this._sortedRenderers.forAll(t=>{const i=t.acquireTechniques(e);i&&t.render(e,i)})}intersect(e,t,i,r,n){for(const a of this._geometries.values()){if(!r(a))continue;this._intersectRenderGeometry(a,i,t,0,e,n);const o=this.rendererContext.longitudeCyclical;o&&(a.boundingSphere[0]-a.boundingSphere[3]<o.min&&this._intersectRenderGeometry(a,i,t,o.range,e,n),a.boundingSphere[0]+a.boundingSphere[3]>o.max&&this._intersectRenderGeometry(a,i,t,-o.range,e,n)),n++}return n}_updateSortedMaterialRenderers(){if(!(this._sortedRenderers.length>0)){for(const e of this.renderers.values())this._sortedRenderers.push(e);this._sortedRenderers.sort((e,t)=>t.material?.renderPriority===e.material?.renderPriority?e.drapedPriority-t.drapedPriority:(t.material?.renderPriority||0)-(e.material?.renderPriority||0))}}_processAddsRemoves(){this._changes.adds.length=0,this._changes.removes.length=0,Lx(this._changes.adds,Array.from(this._pending.adds)),Lx(this._changes.removes,Array.from(this._pending.removes)),yw(this._changes.updates,({renderGeometry:e})=>!this._pending.has(e)),this._pending.clear()}_intersectRenderGeometry(e,t,i,r,n,a){if(!e.visible||!e.material.visible||!e.material.intersectDraped)return;let o=0;r+=e.transformation[12],o=e.transformation[13],Dv[0]=i[0]-r,Dv[1]=i[1]-o,e.screenToWorldRatio=this.rendererContext.screenToWorldRatio,e.material.intersectDraped(e,n,Dv,(l,c,h)=>{o7(t,h,a,e.material.renderPriority,n,e.layerViewUid,e.graphicUid)},t)}_notifyGraphicGeometryChanged(e){if(this.drapeSource.notifyGraphicGeometryChanged==null)return;let t;for(const{graphicUid:i}of e)i!=null&&i!==t&&(this.drapeSource.notifyGraphicGeometryChanged(i),t=i)}_notifyGraphicVisibilityChanged(e){if(this.drapeSource.notifyGraphicVisibilityChanged==null)return;let t;for(const{graphicUid:i}of e)i!=null&&i!==t&&(this.drapeSource.notifyGraphicVisibilityChanged(i),t=i)}_validateRenderGeometries(e){for(const t of e)this._ensureValidRenderGeometry(t);return e}_ensureValidRenderGeometry(e){return e.localOrigin==null&&(e.localOrigin=this._localOriginFactory.getOrigin(Hi(e.boundingSphere))),e}get test(){}};u([p({constructOnly:!0})],Hn.prototype,"drapeSource",void 0),u([p({constructOnly:!0})],Hn.prototype,"rendererContext",void 0),u([p()],Hn.prototype,"updating",null),u([p()],Hn.prototype,"rctx",null),u([p()],Hn.prototype,"_localOriginFactory",null),u([p({readOnly:!0})],Hn.prototype,"isEmpty",null),u([p()],Hn.prototype,"_geometries",void 0),Hn=u([R("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],Hn);let a7=class{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return this.adds.size===0&&this.removes.size===0&&this.removed.size===0}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}};function o7(s,e,t,i,r,n,a){const o=new $4(n,a,e),l=c=>{c.set(5,o,s.distance,s.normal,s.transformation,t,i)};if((r.results.min.drapedLayerOrder==null||t>=r.results.min.drapedLayerOrder)&&(r.results.min.distance==null||r.results.ground.distance<=r.results.min.distance)&&l(r.results.min),r.options.store!==0&&(r.results.max.drapedLayerOrder==null||t<r.results.max.drapedLayerOrder)&&(r.results.max.distance==null||r.results.ground.distance>r.results.max.distance)&&l(r.results.max),r.options.store===2){const c=new xR(r.ray);l(c),r.results.all.push(c)}}const Dv=ke();function EE(){const s=globalThis.require?.modules;if(s){const e=Object.keys(s);for(const t of e)t.includes(".glsl")&&delete s[t]}}let R2=class{constructor(e,t){this.screen=e,this.olid=t}};const AE=1.3,l7=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let co,bs=class extends te{constructor(s){super(s),this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Set,this._drapeTargets=new Set,this._placementDirty=!1,this._contentUpdated=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._latestOriginId=0,this.groundView=s.view.groundView}initialize(){const{view:s}=this;this.renderer=new Un({parent:this}),s.stage.renderer.plugins.add(this.renderer);const e=()=>this.requestRender();this._groundIntersector=new Ur(s.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this.addHandles([$(()=>this.renderer.hasHighlights,e),this.renderer.events.on("has-water",()=>s.stage?.renderer.updateHasFlags()),this.renderer.events.on("content-changed",e),$(()=>s.state.camera.pixelRatio,e),$(()=>s.state.alignPixelEnabled,e),this.renderer.events.on("textures-disposed",()=>this.groundView.requestRender(1)),$(()=>[s.pointsOfInterest?.renderPointOfView,s.pointsOfInterest?.centerOnSurfaceFrequent?.location],()=>this.setPlacementDirty()),$(()=>[s.state?.pixelRatio,s.state?.contentPixelRatio],()=>this.setPlacementDirty(),Ae),Zs(()=>this.groundView,t=>t.on("elevation-change",()=>this.setPlacementDirty())),s.on("resize",()=>this.setPlacementDirty()),s.resourceController.scheduler.registerTask(di.OVERLAY,this)]),s.stage.renderer.overlay=this}destroy(){this.view?.stage&&(this.view.stage.renderer.plugins.remove(this.renderer),this.view.stage.renderer.overlay=null,Q(this.renderer)),co&&(co.hide(),co=null),this.renderer=null}get spatialReference(){return this._spatialReference}set spatialReference(s){this._spatialReference=s,this.renderer.longitudeCyclical=null;const e=this.view.renderSpatialReference;s!=null&&e!=null?(this._renderSR=e,this._overlaySREqualsRenderSR=s.equals(this._renderSR),this._isSpherical&&(this.renderer.longitudeCyclical=H$(s))):this.renderer.disposeOverlays()}get readyToRun(){return this._placementDirty&&(this._drapeSources.size>0||this.view.graphics.length>0||yi.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&(this.terrainSurface.ready||!this.terrainSurface.enabled)}get _isSpherical(){return this.view.state.isGlobal}get worldToPCSRatio(){return this._spatialReference!=null&&this._spatialReference.isGeographic&&!this.view.state.isLocal?Zt(this._spatialReference).metersPerDegree:1}get _overlayStretch(){return AE/this.view.resolutionScale}get longitudeCyclical(){return this.renderer.longitudeCyclical}get suspended(){return this.terrainSurface.enabled&&this.terrainSurface.suspended}get updating(){return this.readyToRun||!!this.renderer?.updating||this._contentUpdated}render(){return this._contentUpdated=!1,this.renderer.processSyncDrapeSources(),this.renderer.precompileShaders(this.view.state)?this._drawOverlays():null}get hasOverlays(){return this.renderer.hasOverlays}registerDrapeSource(s,e){this._drapeSources.add(s),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources),this.renderer.registerDrapeSource(s,e),this._updateDrapeSourceExtent(s),this._setContentDirty(),this.notifyChange("readyToRun")}registerGeometryDrapeSource(s){const e=new Hn({stage:this.view.stage,drapeSource:s,rendererContext:this.renderer});return this.registerDrapeSource(s,e),e}_updateDrapeSourceExtent(s){this.renderer.overlays.length===2&&s.setDrapingExtent!=null&&this._spatialReference!=null&&s.setDrapingExtent(this.renderer.overlays,this._spatialReference)}unregisterDrapeSource(s){this._drapeSources.has(s)&&(this._drapeSources.delete(s),this.renderer.removeDrapeSourceRenderer(s),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("readyToRun"))}registerDrapeTarget(s){this._drapeTargets.add(s),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)}unregisterDrapeTarget(s){this._drapeTargets.delete(s),this.renderer.ensureDrapeTargets(this._drapeTargets)}_setContentDirty(){this.setPlacementDirty(),this.requestRender()}setPlacementDirty(){this._placementDirty=!0}runTask(s){return this.updateOverlays(s,this.view.state.contentCamera,1)}updateOverlays(s,e,t){if(!this._spatialReference)return Ai;const i=this._computeOverlayHeight(e);this._computeOverlayExtents(e,i,En),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources,En.stretch);const r=this._updateOverlay(0,En.inner,i,1*En.pixelRatioAdjustment,En.mapUnitsPerPixel),n=hr(En.inner)/hr(En.outer),a=this._updateOverlay(1,En.outer,i,n*En.pixelRatioAdjustment,En.mapUnitsPerPixel);r!==1&&a!==1||(this._drapeSources.forEach(o=>this._updateDrapeSourceExtent(o)),this.groundView.updateOverlayParameters(),this.groundView.requestRender(t)),r===0&&a===0||this.requestRender(),this._placementDirty=!1,s.madeProgress()}_computeOverlayHeight(s){const e=this.view.state.contentPixelRatio*this.view.resolutionScale,t=s.fullWidth/s.pixelRatio*e,i=s.fullHeight/s.pixelRatio*e,r=Math.ceil(1.5*Math.max(t,i)),{maxPreferredTexturePixels:n,maxTextureSize:a}=this.view.stage.renderView.renderingContext.parameters,o=.5*a;return jh(lL({width:r,height:r},{maxPreferredTexturePixels:2*n,maxTextureSize:o})[1],o)}get overlays(){return this.renderer.overlays}_updateOverlay(s,e,t,i,r){if(this.renderer.overlays.length===0)return 0;const n=this.renderer.overlays[s],a=n.mapUnitsPerPixel;if(n.mapUnitsPerPixel=r,n.pixelRatio=i,c7(e,n.extent)&&t===n.resolution)return a===r?0:2;n.setExtent(e),n.resolution=t;const o=L$(n.extent);return n.renderLocalOrigin=f_(o[0],o[1],0,"OV_"+this._latestOriginId++),1}overlayPixelSizeInMapUnits(s,e){if(this.renderer.overlays.length===0)return e();const t=this.renderer.overlays[0],i=this.renderer.overlays[1],r=this._pointIsInExtent(s,t.extent)?t:i;return(r.extent[2]-r.extent[0])/r.resolution}reloadShaders(){EE(),this.requestRender(),this.runTask(yn)}requestRender(s=1){this.renderer.hasOverlays?(s===1?(this._contentUpdated=!0,this._drawTexturesDirty=!0):this._drawTexturesAnimateDirty=!0,this.view.stage.renderView.requestRender(s)):this.setPlacementDirty()}_intersectGroundFromView(s,e,t,i,r){const n=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(s,p7,e,t);if(n==null)return!1;const a=n.origin,o=ce(sf,n.origin,n.direction);this._groundIntersector.reset(a,o,s),this._groundIntersector.intersect([]),this.view.groundView.intersect(this._groundIntersector,null,a,o);const l=this._groundIntersector.results.min;return l.getIntersectionPoint(r)&&l.withinDistance(i)}_findHorizonBasedPointOfInterest(s,e){let t=.5;const i=.55,r=this.view.renderCoordsHelper.getAltitude(s.eye),n=this.view.pointsOfInterest.centerOnSurfaceFrequent,a=1e-5,o=U(n.estimatedSurfaceAltitude,s.aboveGround?-1/0:r+a,s.aboveGround?r-a:1/0),l=s.aboveGround;if(this.view.viewingMode==="global"){const c=sf;E_(A_(Gw,Zt(this.view.spatialReference).radius+o),iu(s.eye,s.viewForward),c),he(c,c,s.eye);const h=ko.normalize(RV(s.viewForward,c,s.viewRight))/s.fovY+.5,d=h<=0||h>=1?.5:i;t=l?d*h:h+d*(1-h)}else{const c=.5*Math.PI-Math.acos(-s.viewForward[2]),h=Math.tan(c),d=Si(0,h,1,0),m=kg(d,d,s.projectionMatrix)[1],f=U(.5+.5*m,0,1);t=f===1||f===0?.5:l?f*i:1-(1-f)*i}return this._intersectGroundFromView(s,.5,t,n.distance,e)}_computeOverlayExtents(s,e,t){const{view:i}=this,r=i.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,n=x();this._findHorizonBasedPointOfInterest(s,n)||q(n,r);const a=this._renderSR;yi.OVERLAY_SHOW_CENTER?(co==null&&(co=new ph(i.graphics,"red")),co.show(n,a)):co?.hide();const o=Math.max(.1,Ht(s.eye,n)),l=Eo(i.renderCoordsHelper,r,s.eye),c=this._spatialReference;this._overlaySREqualsRenderSR||zo(n,a,n,c);const h=this._isSpherical,d=this.groundView.extentAABR,m=!h&&c?.isGeographic,f=m&&c?1/Zt(c).metersPerDegree:1,g=i.state.contentPixelRatio,_=s.perScreenPixelRatio/g*o*f;t.mapUnitsPerPixel=_/this.worldToPCSRatio,t.stretch=this._overlayStretch;let v=e*_/2*t.stretch,b=!1,T=m?90:1/0;h&&d&&c&&(c.isWebMercator?(v/=Math.cos(P0(n[1])),T=d[3]):(b=!0,v/=Zt(c).metersPerDegree,T=90),v>=T&&(v=T,n[1]=0,c.isWebMercator&&(n[0]=0)));let w=1;b&&(w=1/Math.max(.2,Math.cos(Math.abs(rt(n[1])))),v*w>180&&(w=180/v),t.mapUnitsPerPixel*=w);const S=Math.log(2)/12;v=Math.exp(Math.round(Math.log(v)/S)*S);const C=v*w,P=32,M=.5*e/(P*C),O=.5*e/(P*v);n[0]=Math.round(n[0]*M)/M,n[1]=Math.round(n[1]*O)/O;const D=t.inner;D[0]=n[0]-C,D[1]=n[1]-v,D[2]=n[0]+C,D[3]=n[1]+v,h&&this._shiftExtentToFitBounds(D,1/0,T);const A=t.outer;if(6*C>hr(d))Up(A,d);else if(Math.PI/2-Math.abs(l-Math.PI/2)<=.25*Math.PI)A[0]=D[0]-C,A[1]=D[1]-v,A[2]=D[2]+C,A[3]=D[3]+v;else{zo(s.eye,a,sf,c),Rl(ul,n,sf);let E=-Math.atan2(ul[1],ul[0])+.125*Math.PI;E<0&&(E+=2*Math.PI);const z=Math.floor(E/(.25*Math.PI));Qw(ul,l7[z],2*v),ul[0]*=w,ul[2]*=w,OV(A,D,ul)}if(h)A[0]=this.longitudeCyclical.clamp(A[0]),A[2]=this.longitudeCyclical.clamp(A[2]),A[1]=Math.max(A[1],-T),A[3]=Math.min(A[3],T);else{const E=R0(D,d,u7),z=R0(A,d,d7);ZF(E,z)&&(A[2]=A[0],A[3]=A[1])}const F=Math.abs(D[2]-D[0])/e;t.mapUnitsPerPixel=Math.max(t.mapUnitsPerPixel,F),t.pixelRatioAdjustment=t.mapUnitsPerPixel/F}_drawOverlays(s=this.view.state){if(!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return this.renderer;const e=!this._drawTexturesDirty&&this._drawTexturesAnimateDirty?0:1;this._drawTexturesDirty=this._drawTexturesAnimateDirty=!1;const t=this.renderer.computeValidity();return this.renderer.releaseRenderTargets(e),this.renderer.drawOverlays(s,e),t!==this.renderer.computeValidity()&&(this.groundView.updateOverlayParameters(),this.groundView.requestRender(1)),this.groundView.requestRender(e),e===1&&this.terrainSurface.requestUpdate(),this.renderer}_pointIsInExtent(s,e){if(this.longitudeCyclical)return this.longitudeCyclical.contains(e[0],e[2],s.x)&&s.y>=e[1]&&s.y<=e[3];const t=s.x,i=s.y;return t>e[0]&&t<e[2]&&i>e[1]&&i<e[3]}_shiftExtentToFitBounds(s,e,t){let i=0,r=0;s[0]<-e?i=s[0]+e:s[2]>e&&(i=e-s[2]),s[1]<-t?r=s[1]+t:s[3]>t&&(r=t-s[3]),Ag(s,i,r)}get test(){}};function c7(s,e){const i=yi.TESTS_DISABLE_OPTIMIZATIONS?0:1e-5*Math.max(s[2]-s[0],s[3]-s[1],e[2]-e[0],e[3]-e[1]);return Math.abs(e[0]-s[0])<=i&&Math.abs(e[1]-s[1])<=i&&Math.abs(e[2]-s[2])<=i&&Math.abs(e[3]-s[3])<=i}u([p()],bs.prototype,"_spatialReference",void 0),u([p({readOnly:!0})],bs.prototype,"readyToRun",null),u([p()],bs.prototype,"_placementDirty",void 0),u([p()],bs.prototype,"_contentUpdated",void 0),u([p()],bs.prototype,"_isSpherical",null),u([p()],bs.prototype,"worldToPCSRatio",null),u([p()],bs.prototype,"renderer",void 0),u([p({constructOnly:!0})],bs.prototype,"view",void 0),u([p({constructOnly:!0})],bs.prototype,"groundView",void 0),u([p({constructOnly:!0})],bs.prototype,"terrainSurface",void 0),u([p()],bs.prototype,"suspended",null),u([p()],bs.prototype,"updating",null),bs=u([R("esri.views.3d.terrain.OverlayManager")],bs);let h7=class{constructor(){this.inner=Mt(),this.outer=Mt(),this.mapUnitsPerPixel=0,this.pixelRatioAdjustment=1,this.stretch=AE}};const ul=Lt(),sf=x(),En=new h7,u7=Mt(),d7=Mt(),p7=Go();let m7=class{constructor(){this.sinLonLUT=new Array(ad+1),this.cosLonLUT=new Array(ad+1),this.sinLatLUT=new Array(ad+1),this.cosLatLUT=new Array(ad+1)}update(e,t,i){const r=t[0],n=t[2];for(let a=0;a<=e;a++){const o=a/e,l=r*(1-o)+n*o;this.sinLonLUT[a]=Math.sin(l),this.cosLonLUT[a]=Math.cos(l);const c=i(o);this.sinLatLUT[a]=Math.sin(c),this.cosLatLUT[a]=Math.cos(c)}}},f7=class{constructor(){this.numVerticesPerSide=0,this.samplerData=null,this.samplerDataVersion=0,this.clippingArea=null,this.wireframe=!1,this.cornerPeerNeighbors=[null,null,null,null],this.cornerNeighborCornerTiles=[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],this.cornerNeighborCornerTileSamplerVersions=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],this.edgeResolutions=[-1,-1,-1,-1],this.edgePeerNeighbors=[null,null,null,null],this.edgePeerNeighborSamplerVersions=[-1,-1,-1,-1]}},g7=class{constructor(){this.indices=null,this.indexCount=0,this.edgeIndicesStartIndex=0,this.poleIndicesStartIndex=0,this.vertexAttributes=null,this.edgeVerticesStartIndex=0,this.poleVerticesStartIndex=0,this.maxEdgeVertexCount=0,this.boundingBox=Hr(),this.numVerticesPerSide=0,this.minu=0,this.minv=0,this.maxu=1,this.maxv=1,this.outerEdgesOffsetAndLength=[0,0,0,0,0,0,0,0]}release(){this.vertexAttributes=Nt(this.vertexAttributes),this.indices=null}reset(){this.indices=null,this.vertexAttributes=null,Hr(this.boundingBox),this.numVerticesPerSide=0}getEdgeFirstVertexIndex(e){return this.outerEdgesOffsetAndLength[2*e]}getEdgeCount(e){return this.outerEdgesOffsetAndLength[2*e+1]}getEdgeVertexIndex(e,t){return this.getEdgeAttributeIndex(e,t)}getEdgeVertexPosition(e,t,i,r){this._getEdgeVertexRaw(this.getEdgeAttributeIndex(e,r),t),ce(t,t,i)}getEdgeNormal(e,t,i){const{typedBuffer:r,typedBufferStride:n}=this.vertexAttributes.normalCompressed;L4(t,r,this.getEdgeAttributeIndex(e,i),n)}setEdgeNormalFromValues(e,t,i,r,n){this._setNormal(this.getEdgeAttributeIndex(e,t),i,r,n)}setEdgeVertexFromValuesRawPositionUV(e,t,i,r,n,a,o){const l=this.getEdgeAttributeIndex(e,t);this.vertexAttributes.position.setValues(l,i,r,n),this._setUV(l,a,o)}setEdgeVertexFromValuesRawPositionUVNormal(e,t,i,r,n,a,o,l,c,h){const d=this.getEdgeAttributeIndex(e,t);this.vertexAttributes.position.setValues(d,i,r,n),this._setUV(d,a,o),this._setNormal(d,l,c,h)}_getEdgeVertexRaw(e,t){this.vertexAttributes.position.getVec(e,t)}_setNormal(e,t,i,r){const{typedBuffer:n,typedBufferStride:a}=this.vertexAttributes.normalCompressed;yp(n,e,t,i,r,a)}_setUV(e,t,i){this.vertexAttributes.uv0.setValues(e,Math.round(t*ui),Math.round(i*ui))}getEdgeAttributeIndex(e,t){return B(0<=t&&t<this.getEdgeCount(e)),this.getEdgeFirstVertexIndex(e)+t}},_7=class ag{constructor(e){this._getFadeDuration=e,this._fadeStart=0,this._delayedTime=0}clear(){this._current=Q(this._current),this._next=Q(this._next),this._waiting=Q(this._waiting),this._delayed=Q(this._delayed)}get current(){if(this._current==null)return null;if(!this._isFadingEnabled){let t=null;this._delayed?(t=this._delayed,this._delayed=null):this._waiting?(t=this._waiting,this._waiting=null):this._next&&(t=this._next,this._next=null),t&&(this.clear(),this._current=t)}let e=ag.test.fadeMoment;if(this._delayed&&(e=e||performance.now(),e>=this._delayedTime&&(this._push(this._delayed,0),this._delayed=null)),this._next){e=e||performance.now();const t=this._fadeDuration,i=this._current!=null&&this._next.texture===this._current.texture,r=this._next.type!==0,n=e-this._fadeStart>=t;(i||r||n)&&(Q(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(e))}return this._current}get next(){return this._next}get fadeFactor(){if(this._next==null)return 1;const e=ag.test.fadeMoment||performance.now(),t=Math.max(0,e-this._fadeStart),i=this._fadeDuration;return t>i?0:1-t/i}get isFading(){return this._next!=null||this._delayed!=null}push(e,t=0){this._delayed=Q(this._delayed),this._push(e,t)}_push(e,t){if(this._isFadingEnabled||this.clear(),this._current==null)return void(this._current=e);const i=ag.test.fadeMoment||performance.now();return t!==0?(this._delayed=e,void(this._delayedTime=i+t)):this._next==null?(this._next=e,void(this._fadeStart=this._alignFadeStart(i))):void(e!=null&&(Q(this._waiting),this._waiting=e))}get _fadeDuration(){const e=this._getFadeDuration();return this._waiting?.5*e:e}_alignFadeStart(e){const t=this._getFadeDuration();return e+t-e%t}get _isFadingEnabled(){return this._getFadeDuration()>0}static{this.test={fadeMoment:0}}},og=class{constructor(e,t,i,r,n,a){this.texture=e,this.type=t,this.offsetAndScale=i,e.retain(),this.opacities=Qe(r,n,a)}destroy(){this.texture.release()}},y7=class{constructor(){this._scales=Si(-1,-1,-1,-1),this._offsets=Si(-1,-1,-1,-1)}clear(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}setScale(e,t,i){this._scales[2*e]=t,this._scales[2*e+1]=i}setOffset(e,t,i){this._offsets[2*e]=t,this._offsets[2*e+1]=i}get scales(){return this._scales}get offsets(){return this._offsets}},IE=class{constructor(){this._queue=new zt,this.remove=()=>{}}get done(){return this._queue.length===0&&(!this._last||this._last.leaf)}resetOne(e){this._queue.clear(),this._queue.push(e),this._last=void 0}reset(e=null){this._queue.clear(),e!=null&&this._queue.pushArray(e),this._last=void 0}skipSubtree(){this._last=void 0}next(){const e=this._last?.children;return e?.[0]&&this._queue.pushArray(e),this._last=this._queue.pop(),this._last}},v7=class{constructor(){this._q=new zt}get done(){return this._q.length===0}reset(e){if(this._q.clear(),e!=null){this._q.pushArray(e);for(let t=0;t<this._q.length;++t){const i=this._q.data[t];i.leaf||this._q.pushArray(i.children)}}}next(){return this._q.pop()}};function Xl(s,e){if(e==null||e.destroyed)return!1;const t=b7(e);if(t?.fullExtent==null)return!1;const i=t.fullExtent,r=s.extent;if(i.xmin>r[2]||i.ymin>r[3]||i.xmax<r[0]||i.ymax<r[1])return!1;const n=s.surface.tilingScheme.levels[s.level].scale,a=t.minScale;if(a>0&&n>1.00000001*a)return!1;const o=t.maxScale;return!(o>0&&n<.99999999*o)}function b7(s){return W_(s)?{fullExtent:s.fullExtent,minScale:s.layer.minScale,maxScale:s.layer.maxScale}:s.layer}function w7(s){return!W_(s)&&s.layer&&"tilemapCache"in s.layer?s.layer.tilemapCache:null}function Jn(s,e){const t=s.lij,i=e.lij;return t[0]-i[0]||t[1]-i[1]||t[2]-i[2]}function LE(s,e=null){return e==null||e.length===0?s.sort(x7):s.sort((t,i)=>C7(t,i,e))}function x7(s,e){const t=s.screenDepth-e.screenDepth;if(t!==0)return t;const i=s.lij,r=e.lij;return i[0]-r[0]||i[1]-r[1]||i[2]-r[2]}function FE(s,e){const t=s.screenDepth,i=e.screenDepth;return t<i?-1:t>i?1:Jn(s,e)}function C7(s,e,t){return O2(s,t)===O2(e,t)?FE(s,e):s?1:-1}function O2(s,e){for(const t of e)if(s.intersectsExtent(t))return!0;return!1}function T7(s,e){const t=s.distanceToPOI-e.distanceToPOI;if(t!==0)return t;const i=s.lij,r=e.lij;return i[0]-r[0]||i[1]-r[1]||i[2]-r[2]}function S7(s,e){const t=s.length;for(let i=0;i<t;++i)s.at(i).updateDistanceToPOI(e);s.sort(T7)}function P7(s,e,t){let i=1,r=0,n=0;for(;s!==e;)if(i*=.5,r*=.5,n*=.5,1&s.lij[2]&&(r+=.5),1&s.lij[1]||(n+=.5),(s=s.parent)==null)throw new Error("tile was not a descendant of upsampleTile");t.init(e,r,n,i)}function M7(s){for(let e=0;e<s.length;e++){const t=s[e],i=t.parent;if(i)for(let r=0;r<4;r++){const n=i.children[r];if(n&&n!==t)return!0}}return!1}function Nce(s,e){if(!s||!e||s[0]===e[0])return!1;const t=s[0]<e[0],i=t?s:e,r=t?e:s,n=1<<r[0]-i[0];return Math.floor(r[1]/n)===i[1]&&Math.floor(r[2]/n)===i[2]}let $7=class{constructor(){this.geometry=new g7,this.geometryState=null,this._texture=null,this._textureOpacity=1,this._textureRef=new _7(()=>this._tile.surface.fadeDuration),this.overlay=new y7,this._localOrigin=null,this._geometryStateChangedSinceLastUpdate=!0,this._hasGeometry=!1,this._modifiedFlags=0}get tile(){return this._tile}get localOrigin(){return this._localOrigin}init(e,t){this.clear(),this._tile=e,this.geometry.reset(),this.intersectionData=null,this.geometryState=new f7,this._localOrigin=t,this.overlay.clear()}clear(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear(),this._tile=null,this.intersectionData=null,this.geometryState=null}updateGeometryIfNeeded(e){if((!this._vao||this._geometryStateChangedSinceLastUpdate||this.wireframeChanged||this.clippingAreaChanged||this.samplerDataChanged||this.numVerticesPerSideChanged||this.dirtyCorners||this.dirtyEdgeResolutions||this.dirtyEdges)&&(this._updateGeometry(e),this._geometryStateChangedSinceLastUpdate=!1),_i&&this.tile.intersectsClippingArea)for(let t=0;t<4;++t)B(this.geometry.getEdgeCount(t)===this.geometryState.edgeResolutions[t]+1)}_calculateEdgeResolution(e,t){const i=this.tile,r=this.geometryState.numVerticesPerSide-1;if(!i.surface.isGlobal){const l=i.surface.extent;if(l!=null&&(e===0&&i.extent[3]>l[3]||e===1&&i.extent[2]>l[2]||e===2&&i.extent[1]<l[1]||e===3&&i.extent[0]<l[0]))return r}const n=i.level,a=wn[e];if(!t)return B(i.surface?.rootTiles==null||i.surface.updatingRootTiles||!i.shouldHaveNeighbor(a)),r;if(t.loaded){const l=t,c=l.renderData.geometryState,h=n-l.level;if(B(h>=0),h===0){const f=c.numVerticesPerSide-1;return Math.max(f,r)}const d=2**h,m=c.edgeResolutions[(e+2)%4]/d;return Math.max(1,m)}B(!t.leaf);let o=r;return t.forAllSubtreeOnSide(F1(a),l=>l===i||(l.loaded?(o=Math.max(o,2**(l.level-n)),!0):(B(!l.leaf),!1))),o}updateNeighborData(){const e=this.tile;if(!e.intersectsClippingArea)return;const t=e.renderData.geometryState,i=a=>(a.loaded||a.level===e.level)&&a?.intersectsClippingArea,r=t.edgePeerNeighbors,n=t.edgePeerNeighborSamplerVersions;for(let a=0;a<4;++a){const o=e.findNeighborTile(wn[a],i),l=Ll(e,o),c=l?.renderData?.geometryState.samplerDataVersion??-1,h=r[a],d=l!==Ll(e,h),m=n[a]!==c;_i&&o&&(B(e.level>=o.level),B(e.level-o.level<=li)),r[a]=o,(d||m)&&(n[a]=c,this._markEdgeDirty(a));const f=t.edgeResolutions[a],g=this._calculateEdgeResolution(a,o);B(sc(g)),B(g>=1),t.edgeResolutions[a]=g,f!==g&&this._markEdgeResolutionDirty(a)}for(let a=0;a<4;++a){const o=e.findNeighborTile(m_[a],i);t.cornerPeerNeighbors[a]=o;const l=Ll(e,r[a]),c=Ll(e,r[(a+1)%4]),h=Ll(e,o);Kr[a]=h,Kr[(a+1)%4]=c,Kr[(a+2)%4]=e,Kr[(a+3)%4]=l,B(Kr.some(g=>g?.loaded||g===e));const d=Kr.reduce((g,_)=>Math.min(g,_?.level??1/0),1/0);Kr.forEach((g,_)=>{g&&g?.level>d&&(Kr[_]=null)}),B(Kr.some(g=>g?.loaded||g===e));const m=t.cornerNeighborCornerTiles,f=t.cornerNeighborCornerTileSamplerVersions;for(let g=0;g<4;++g){const _=Kr[g],v=_?.renderData.geometryState.samplerDataVersion??-1,b=4*a+g,T=m[b]!==_,w=!T&&f[b]!==v;(T||w)&&(m[b]=_,f[b]=v,this._markCornerDirty(a))}_i&&B(W1.some(g=>m[4*a+g]?.loaded||m[4*a+g]===e))}_i&&B(this.geometryState.edgeResolutions.every(a=>a>0));for(let a=0;a<4;++a)Kr[a]=null}_updateGeometry(e){if(!this.tile.intersectsClippingArea)return;_i&&B(!this.tile.intersectsClippingArea||this.geometryState.edgeResolutions.every(f=>f>0)),this.intersectionData=null;const{tile:t,_vao:i,geometry:r,geometryState:n}=this,a=!i||!1||this.wireframeChanged||this.samplerDataChanged||this.clippingAreaChanged||this.numVerticesPerSideChanged,o=this.dirtyEdgeResolutions!==0,l=n.edgeResolutions.reduce((f,g)=>f+g+1,0),c=a||o&&l>(r?.maxEdgeVertexCount??0),h=!c&&o,d=!h&&(this.dirtyEdges!==0||o),m=!d&&this.dirtyCorners!==0;c?(this.releaseGeometry(),this._createGeometry(e)):h?t.updateEdgeElevationsAndResolutions():d||m?t.updateEdgeElevations():m?t.updateCornerElevations():console.warn("Update for no reason?"),this._modifiedFlags=0}get hasGeometry(){return this._hasGeometry}releaseGeometry(){return this._hasGeometry=!1,this.intersectionData=null,!!this._vao&&(this._vao=_e(this._vao),this.geometry.release(),!0)}ensureTexture(e,t,i,r){const n=t?6408:6407;return this._texture!=null&&(i===0&&this._tile.surface.fadeDuration>0&&this._isTextureVisible(this._texture)||this._texture.descriptor.width!==e||this._texture.descriptor.pixelFormat!==n)&&this.releaseTexture(),this._texture==null&&(this._texture=r(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){this._texture&&(this._texture=Nt(this._texture),this.tile.setMemoryDirty())}reuseTexture(e,t){return!(!e||!this._texture)&&(e.setTextureReference(new og(this._texture,0,t,this._textureOpacity,0,1)),!0)}get numVerticesPerSideChanged(){return(this._modifiedFlags&O7)!==0}get samplerDataChanged(){return(this._modifiedFlags&D7)!==0}get clippingAreaChanged(){return(this._modifiedFlags&E7)!==0}get wireframeChanged(){return(this._modifiedFlags&A7)!==0}get dirtyEdges(){return this._modifiedFlags>>Ev&15}get dirtyCorners(){return this._modifiedFlags>>Av&15}get dirtyEdgeResolutions(){return this._modifiedFlags>>Iv&15}_markCornerDirty(e){const t=1<<e<<Av;this._modifiedFlags|=t}_markEdgeDirty(e){const t=1<<e<<Ev;this._modifiedFlags|=t,this._markCornerDirty((e+0)%4),this._markCornerDirty((e+3)%4)}_markEdgeResolutionDirty(e){const t=1<<e<<Iv;this._modifiedFlags|=t,this._markEdgeDirty(e)}_markAllEdgesAndCornersDirty(){this._modifiedFlags|=15<<Av|15<<Ev|15<<Iv}updateGeometryState(){const e=this._elevationInfo,t=this.tile,i=e.samplerData?t.getElevationVerticesPerSide(e.maxTileLevel):t.minimumVerticesPerSide,r=Math.max(i,5);let n=t.clippingArea;t.intersectsClippingArea&&!t.withinClippingArea||(n=null);const a=this.geometryState;let o=!1;a.numVerticesPerSide!==r&&(this._modifiedFlags|=1,a.numVerticesPerSide=r,a.samplerDataVersion++,o=!0),e.changed&&(this._modifiedFlags|=2,a.samplerData=e.samplerData,a.samplerDataVersion++,o=!0),yI(a.clippingArea,n)||(this._modifiedFlags=4,a.clippingArea=n,o=!0);const l=t.surface.wireframe;return a.wireframe!==l&&(this._modifiedFlags=8,a.wireframe=l,o=!0),this._geometryStateChangedSinceLastUpdate||=o,o&&this._markAllEdgesAndCornersDirty(),this._hasGeometry=!0,this._geometryStateChangedSinceLastUpdate}_createGeometry(e){this.tile.createGeometry();const{vertexAttributes:t,indices:i}=this.geometry,r=e.gl;this._vao=new Mn(e,new Kt(e,Vr(t.layout),t.buffer),Nr.createIndex(e,r.STATIC_DRAW,i)),this._hasGeometry=!0}get vao(){return this._vao}setTextureReference(e,t=0){e?.texture===this._texture?this._textureOpacity=e.opacities[0]:this.releaseTexture(),this._textureRef.push(e,t)}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_isTextureVisible(e){return this._textureRef.current?.texture===e||this._textureRef.next?.texture===e&&this._textureRef.fadeFactor<1}get _elevationInfo(){const e=this.geometryState.samplerData,t=this.tile.layerInfo[0],i=t.length,r=new Array(i);let n=0,a=0,o=!1;for(let h=0;h<i;h++){const d=t[h],m=d.upsampleInfo?.tile;if(m){const f=m.layerInfo[0][h].data,g=f&&f.samplerData;e&&e[n]===g||(o=!0),r[n++]=g,a=Math.max(a,m.lij[0])}else if(d.data){const f=this.tile.surface.layerViewByIndex(h,0);if(Xl(this.tile,f)){const g=d.data;e&&e[n]===g.samplerData||(o=!0),r[n++]=g.samplerData,a=this.tile.level}}}e!=null&&e.length!==n&&(o=!0);const l=n>0,c=l?r:null;return l&&(r.length=n),{changed:o,samplerData:c,maxTileLevel:a}}get estimatedGeometryMemoryUsage(){const e=this.intersectionData?.estimatedMemoryUsage??0;return(this.geometry.indices?.byteLength??0)+(this.geometry.vertexAttributes?.byteLength??0)+e}get texture(){return this._texture}get test(){}checkGeometryWaterproofness(){if(!_i)return;const e=this.tile;if(!e.loaded||!e.intersectsClippingArea||e.level===0)return void B(e?.loaded);const t=e.surface.extent;if(t!=null&&!e.intersectsExtent(t))return;const i=wn.map((o,l)=>t!=null&&(l<2?-1:1)*(e.extent[3-l]-t[3-l])<0),r=e.level;B(this.dirtyCorners===0),B(this.dirtyEdges===0),B(this.dirtyEdgeResolutions===0),B(!this.numVerticesPerSideChanged),B(!this.samplerDataChanged),B(!this.clippingAreaChanged),B(!this.wireframeChanged);const n=m_.map(o=>e.findNeighborCornerTileExact(o,l=>!l.intersectsClippingArea||l.loaded||l.level===e.level)??null).map(o=>o?.intersectsClippingArea?o:null),a=this.geometryState;for(let o=0;o<4;++o){const l=a.cornerPeerNeighbors[o],c=n[o];B(c===l,`Tile[${e.lij}].corner[${o}] out of date: cur=[${l?.lij}] exp=[${c?.lij}]`)}wn.forEach((o,l)=>{if(i[l])return;const c=e.findNeighborTile(o,ue=>(ue.level===r||ue?.loaded)&&ue?.intersectsClippingArea);if(!c){const ue=!e.surface.updatingRootTiles&&e.surface.rootTiles!=null&&e.surface.rootTiles.length>0&&e.shouldHaveNeighbor(o);return void B(!ue)}B(c.loaded||c.level===e.level),B(c===this.geometryState.edgePeerNeighbors[l]);const h=r-c.level;if(!c.loaded)return B(!c.leaf),void B(h===0);const d=c.renderData;B(e.isEdgeNeighbor(c,o)),B(h>=0);const m=2**h;if(h<0)return void B(!1);const f=e.renderData,g=f.geometry,_=f.localOrigin,v=g.getEdgeCount(l),b=g.numVerticesPerSide-1,T=d.geometry;if(!T)return void B(!1);const w=d.localOrigin,S=this.geometryState.edgePeerNeighbors[l];if(S?.loaded){const ue=S.renderData;B(f.geometryState.edgePeerNeighborSamplerVersions[l]===ue.geometryState.samplerDataVersion),B(this.geometryState.edgePeerNeighborSamplerVersions[l]===ue.geometryState.samplerDataVersion)}const C=(l+2)%4,P=T.getEdgeCount(C),M=v-1,O=P-1;B(M*m===O,`Tile[${e.lij}]:e${l},res=${M} edgeRes mismatch with Neighbor[${c.lij}]:e${C},res=${O} (expected:${M*m})`);const D=e.extent,A=o===0||o===4,F=P-1,E=F>>h,z=v-1;if(E<1)return void B(z===1);B(E===z),B(sc(E));const L=T.numVerticesPerSide-1;B(h>0||E===Math.max(L,b));const I=e.getNeighborEdgeStartVertexIndex(l,c);B(0<=I&&I<m);const ie=I*E;B(0<=ie&&ie<=F-E);let N=0,se=ie;g.getEdgeVertexPosition(l,An,_,0),g.getEdgeVertexPosition(l,In,_,v-1);const G=Ht(An,In),Ce=Math.max(R7,1e-4*G);for(let ue=0;ue<=E;++ue){g.getEdgeVertexPosition(l,An,_,N),T.getEdgeVertexPosition(C,In,w,se);const Oe=ue/E,ae=A?D[0]+Oe*(D[2]-D[0]):o===6?D[0]:D[2],we=A?o===4?D[1]:D[3]:D[1]+Oe*(D[3]-D[1]),ze=e.surface.extent;if(ze==null||XF(ze,ae,we)){const Xe=Vw(An,In),$t=on(An)-Ei.radius,ut=on(In)-Ei.radius,De=Xe<Ce;if(!De){console.warn(`Tile edge vertex position mismatch: between [${e.lij}].edge${l}[${N}/${v}] and [${c.lij}].edge${C}[${se}/${P}]`),ze!=null&&console.warn("  surface extent= ",ze," x,y=",ae,",",we);const Se=x();he(Se,f.localOrigin,d.localOrigin),on(Se)>0&&console.warn(`   localOrigins: ${f.localOrigin} vs ${d.localOrigin} d=${on(Se)} [${Se}]`),(()=>{const Ne=Sn(An),W=Sn(In);e.updateEdgeElevations(),c.updateEdgeElevations(),g.getEdgeVertexPosition(l,An,_,N),T.getEdgeVertexPosition(C,In,w,se);const H=x();zi(H,An,Ne),on(H)>0&&console.warn(`  XXX Tile[${e.lij}] edge out of date: ${Ne} vs ${An} d=${on(H)} [${H}]`),zi(H,In,W),on(H)>0&&console.warn(`  XXX Neighbor[${c.lij}] edge out of date: ${W} vs ${In} d=${on(H)} [${H}]`)})();const Ge=g.getEdgeCount(l),K=T.getEdgeCount(P);B(De,`Mismatch in tile [${e.lij}].edge[${l}][${N}/${Ge}] vs neighbor [${c.lij}].edge[${C}][${se}/${K}] ${pa(An)} vs ${pa(In)}  dist=${Xe} h(t|n|d)=${$t}|${ut}|${ut-$t}`)}g.getEdgeNormal(l,Bc,N),T.getEdgeNormal(C,Nc,se),pe(D2,Bc),pe(E2,Nc);const dt=We(D2,E2),Ee=1-dt<.01||!1||e===c;if(!Ee){const Se=x();zi(Se,Bc,Nc);const Ge=()=>`Mismatch in tile edge normal ${HS(e.lij)} (${N}/${v-1}) edge ${l} vs neighbor ${HS(c.lij)}  (${se}/${P-1}) nedge ${C} :${pa(Bc)} vs ${pa(Nc)}  dot = ${dt} : ${pa(Se)}`;console.warn("Mismatch in tile edge normal: ",Ge());{e.updateEdgeElevations(),c.updateEdgeElevations();const K=x(),Ne=x();g.getEdgeNormal(l,K,N),T.getEdgeNormal(C,Ne,se),Jh(Bc,K)||console.warn("Missing update in tile normal: ",pa(Bc)," => ",pa(K)),Jh(Nc,Ne)||console.warn("Missing update in neighbor normal: ",pa(Nc)," => ",pa(Ne))}B(Ee,Ge())}}N+=1,se+=1}})}};const An=x(),In=x(),Bc=x(),Nc=x(),D2=x(),E2=x(),R7=1,Kr=[null,null,null,null];function Ll(s,e){return e?.loaded||e===s?e:null}const O7=1,D7=2,E7=4,A7=8,Ev=4,Av=8,Iv=12,W1=[0,1,2,3];let Q1=class{get updating(){return!!this._tileRequested}init(e,t,i,r){this.tile=e,this._layerIdx=t,this._layerClass=i,this._suspended=r,this._tileLayerInfo=e.getLayerInfo(t,i),this._tileRequested=null;const n=this._findAncestorWithData();this._setUpsampleTile(n)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(e,t){this._setUpsampleTile(e,t),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass,0,t):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return e!=null?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}_findNextDownload(){const e=this._layerIdx,t=this._layerClass,i=this.tile.surface.layerViewByIndex(e,t),{minLevel:r,maxLevel:n}=i.dataLevelRange,a=this._desiredMinLevelDelta,o=this._progressiveLevelModulo+a,l=this._scaleRangeEnabled?Xl:()=>!0;let c=this.tile;const h=c.level;let d;const m=this._tileLayerInfo.upsampleInfo,f=m?.tile?.level??-1,g=m!=null&&f-h>=a,_=w7(i),v=i.type==="vector-tile-3d"?i.schemaHelper:null;for(;c&&l(c,i)&&c.level>=r;){const b=c.level,T=h-b,w=c.layerInfo[t][e];if(w.data&&T>=a){(!g||b>f)&&this._setUpsampleTile(c),w.dataInvalidated&&(d=c);break}const S=v?.getLevelRowColumn(c.lij)??c.lij;if(_?.getAvailability(S[0],S[1],S[2])!=="unavailable"&&b<=n&&!w.data&&!w.dataMissing&&((!d||c.level===r||b%pO===0||h-d.level<a)&&(d=c),T>=o))break;c=c.parent}if(d!=null&&h-d.level<a)if(m)d=null;else{const b=this._findAncestorWithData();b!=null&&(this._setUpsampleTile(b),d=b.layerInfo[t][e].dataInvalidated?b:null)}return d}_findAncestorWithData(){const e=this.tile.elevationLevel,t=this._desiredMinLevelDelta;let i;for(let r=this.tile;r;r=r.parent)if(r.hasLayerData(this._layerIdx,this._layerClass)){if(e-r.level>=t)return r;i=r}return i}_setUpsampleTile(e,t){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass,0,t)}get test(){}},I7=class extends Q1{constructor(){super(...arguments),this.type="none"}get _desiredMinLevelDelta(){throw A2}get _progressiveLevelModulo(){throw A2}dispose(){}};const A2=new Error("Abstract method called on TileAgent"),ks=new I7;let L7=class extends Q1{constructor(){super(...arguments),this.type="elevation",this._scaleRangeEnabled=!1}get _desiredMinLevelDelta(){return this.tile.elevationLevelDelta-(this.tile.elevationLevel-this.tile.level)}get _progressiveLevelModulo(){return 0}};function F7(s){return s.type==="elevation"}let V7=class{constructor(e){this.tile=e}get usedMemory(){return this.tile.mapDataMemory}},k7=class extends Q1{constructor(){super(),this.type="map",this._scaleRangeEnabled=!0}get _desiredMinLevelDelta(){return 0}get _progressiveLevelModulo(){return pO}};function z7(s){return s.type==="map"}let lg=class{constructor(){this.waitingAgents=new zt,this.pendingUpdates=0}static acquire(e){const t=cg.acquire();return t._init(e),t}release(){this.dispose(),sp.delete(this),cg.release(this)}dispose(){this.loadingAgent=_e(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=qh(this._data)}static prune(){cg.prune(0)}_init(e){this.waitingAgents.clear(),this._data=qh(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=e,this.elevationBounds=null}invalidateSourceData(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}abortRequest(){this.requestAbort=Os(this.requestAbort),this.requestPromise=null}_unsetUpsampleInfo(){this.upsampleInfo&&(this.upsampleInfo.tile?.unrefMapData(),this._pool.release(this.upsampleInfo),this.upsampleInfo=null)}setUpsampleInfo(e,t){if(e!==t&&t!=null){if(this.upsampleInfo==null)this.upsampleInfo=this._pool.acquire();else{if(this.upsampleInfo.tile===t)return;this.upsampleInfo.tile?.unrefMapData()}t.refMapData(),P7(e,t,this.upsampleInfo)}else this._unsetUpsampleInfo()}get data(){return this._data}set data(e){qh(this._data),this._data=e}};const cg=new Do(()=>new lg,null,()=>{}),sp=new Map;function B7(){sp.size>0&&(console.log(`${sp.size} live TilePerLayerInfo allocations:`),sp.forEach(s=>console.log(s,`
`)))}function N7(){cg.prune(),sp.clear()}const U7=.1;class Z1{constructor(){this._lij=[0,0,0],this._children=[null,null,null,null],this._pendingUpdates=0,this._dirty=!0,this._previouslyRendered=!1,this.extent=Mt(),this._elevationBoundsMin=NaN,this._elevationBoundsMax=0,this.layerInfo=[[],[]],this.extentInRadians=Mt(),this.centerAtSeaLevel=x(),this._center=[x(),Xs(),x()],this.up=wF(),this._withinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=0,this._rasterTileMemory=0,this._vectorTileMemory=0,this._mapDataRefCount=0,this.screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0,this.onCompressionFinished=()=>{this.setPendingUpdate(16),this.setMemoryDirty()},this.extentMidX=0,this.extentMidY=0,this.distanceToPOI=-1,this._lastPOI=x(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0}get lij(){return this._lij}get spatialReference(){return this._surface.spatialReference??this._surface.tilingScheme.spatialReference}get elevationLevelDelta(){return this._surface.getElevationLevelDelta(this.level)}static prune(){X1.prune(0),Y1.prune(0),lg.prune()}get _cached(){return!this.leaf&&this._mapDataRefCount<=0}get withinClippingArea(){return this._withinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBoundsMin(){return this._elevationBoundsMin}get elevationBoundsMax(){return this._elevationBoundsMax}get level(){return this._lij[0]}get key(){return`${this._lij[0]}/${this._lij[1]}/${this._lij[2]}`}get edgeLen(){return this._edgeLen}get radius(){return this._center[1][3]}get visible(){return this._dirty&&this.computeVisibility(),this._visible}get frustumVisibility(){return this._dirty&&this.computeVisibility(),this._frustumVisibility}computeVisibility(){this._dirty=!1;const e=this.parent,t=e?.frustumVisibility??1;this._frustumVisibility=t===0?0:t===2?2:this._calculateFrustumVisibility(this.surface.frustum);const i=this._frustumVisibility!==2&&this._intersectsClippingArea;i!==this._visible&&(this._visible=i,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setDirty(),this.updateAgentSuspension())}get _loadable(){return this.visible||this._surface.view.state.fixedContentCamera}get rendered(){const e=!!this.renderData;return e!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this._surface.renderer.setDirty()),e}init(e,t,i,r,n){this._lij[0]=e,this._lij[1]=t,this._lij[2]=i,this.ellipsoid=Zt(n.tilingScheme.spatialReference),n.tilingScheme.getExtent(e,t,i,this.extent),n.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this.extentMidX=.5*(this.extent[0]+this.extent[2]),this.extentMidY=.5*(this.extent[1]+this.extent[3]),this._withinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,n.upsampleMapCache.pop(this.key),this._edgeLen=0,this._edgeLen2=0,this._center[1][3]=0,this.elevationLevel=e,r&&!Number.isNaN(r.elevationBoundsMin)?(this._elevationBoundsMin=r.elevationBoundsMin,this._elevationBoundsMax=r.elevationBoundsMax):(this._elevationBoundsMin=0,this._elevationBoundsMax=0),this._pendingUpdates=0,this.renderData=null,this.screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=r,this.clearChildren(),this._surface=n,this.updateVisibility(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0;for(const a of mh){const o=n.numLayers(a),l=this.layerInfo[a];for(const c of l)c.release();l.length=o;for(let c=0;c<o;c++)l[c]=lg.acquire(this._surface.upsampleInfoPool),a===0&&this.findElevationBoundsForLayer(c,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(n.tilingScheme.pixelSize,ad)}dispose(){xi(!this.renderData,"tile.renderData was not unloaded"),this._surface?.upsampleMapCache.pop(this.key),this.layerInfo.forEach(e=>{e.forEach(t=>t.release()),e.length=0}),this._surface=this._parent=null,this.clearChildren(),this.setMemoryDirty()}refMapData(){++this._mapDataRefCount,this._cached||this._surface.upsampleMapCache.pop(this.key)}unrefMapData(){--this._mapDataRefCount,this._cached&&this.cachedMemory>0&&this._surface.upsampleMapCache.put(this.key,new V7(Jl(this)))}setMemoryDirty(){this._usedMemory=0}get usedMemory(){return this._ensureUsedMemory()+(this._cached?0:this.mapDataMemory)}get cachedMemory(){return this._ensureUsedMemory(),this._surface==null?this.usedMemory:this._cached?this.mapDataMemory:0}get mapDataMemory(){return this._rasterTileMemory+this._vectorTileMemory}get _cpuImageMemorySize(){const t=this._surface.tilingScheme.pixelSize;return t*t*4}_ensureUsedMemory(){if(this._usedMemory>0)return this._vectorTileMemory=this.layerInfo[1].reduce((e,{data:t})=>e+(dh(t)?t.usedMemoryPerReference:0),0),this._usedMemory;this._usedMemory=this._baseUsedMemory,this._rasterTileMemory=0,this._vectorTileMemory=0;for(const{data:e}of this.layerInfo[1])dh(e)?this._vectorTileMemory+=e.usedMemoryPerReference:this._rasterTileMemory+=this.getTerrainDataMemory(e);for(const e of this.layerInfo[0])this._usedMemory+=e.data?this._cpuImageMemorySize:0;return this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._rasterTileMemory+=this.renderData.texture?.usedMemory??0),this._cached&&this._surface.upsampleMapCache.updateSize(this.key),this._usedMemory}getUsedMemoryForLayer(e,t){const i=this.layerInfo[e][t];return i?.data?e===1?this._cached?0:this.getTerrainDataMemory(i.data):e===0?this._cpuImageMemorySize:0:0}getTerrainDataMemory(e){return tE(e)?e.texture.usedMemory:eE(e)?e.memoryUsage:dh(e)?e.usedMemoryPerReference:j_(e)||e instanceof HTMLImageElement?this._cpuImageMemorySize:0}updateScreenDepth(e){const t=this._center[1],i=e,r=t[0],n=t[1],a=t[2],o=i[2]*r+i[6]*n+i[10]*a+i[14];this.screenDepth=o<0?0:o/(i[3]*r+i[7]*n+i[11]*a+i[15])}shouldSplit(e,t,i){if(!this.visible||e.frustum&&(!this._intersectsClippingArea||this._calculateFrustumVisibility(e.frustum)===2))return 0;const r=this.level;he(nf,Hi(this._center[1]),t);let n=Gs(nf),a=nf,o=fp(this._center[1],x());he(Lv,this._center[0],t);const l=Gs(Lv);l<n&&(n=l,a=Lv,o=this._center[0]),he(Fv,this._center[2],t);const c=Gs(Fv);if(c<n&&(n=c,a=Fv,o=this._center[2]),this._edgeLen2>n&&r<e.maxLod)return 1;const h=Math.sqrt(n),d=e.fovX*h*2,m=this._edgeLen/d,f=()=>{if(r<e.maxLod)return this.elevationLevel=r,0;const M=r+Math.ceil(-Math.log2(e.relativeWidthLimit/m));return M!==this.elevationLevel?(this.elevationLevel=M,2):0},g=i!=null?i-r:1/0;if(g<=.5)return f();const _=We(this.up,nf),v=this._elevationBoundsMax-this._elevationBoundsMin,b=v/this.edgeLen;if(e.aboveGround&&_>0&&b<.001&&_/h-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-b>0)return 0;const T=i!=null?3-Math.min(g,2):1;if(m*T<e.relativeWidthLimit||r>=e.maxLod)return f();if(r<7)return 1;ee($i,this.up,_),he($i,$i,a);const w=Gs($i);if(w<=this.radius*this.radius)return 1;ee($i,$i,this.radius/Math.sqrt(w)),ce($i,$i,o),he($i,t,$i);const S=Math.min(1,(Math.abs(We($i,this.up))+.5*v+this._curvatureHeight)/fe($i)),C=U7/e.angledSplitBias,P=e.fovY*h*2;return S*(this._edgeLen/P*T)<C*e.relativeHeightLimit?0:1}createChildren(){const e=this._children,t=this.lij[0]+1,i=2*this.lij[1],r=2*this.lij[2];return e[0]=this.surface.createTile(t,i,r,this),e[1]=this.surface.createTile(t,i,r+1,this),e[2]=this.surface.createTile(t,i+1,r,this),e[3]=this.surface.createTile(t,i+1,r+1,this),e}clearChildren(){this._children[0]=this._children[1]=this._children[2]=this._children[3]=null}get loaded(){return this.renderData?.hasGeometry??!1}load(){this.refMapData();for(const e of mh)this._createOrUpdateAgents(0,e);this.surface.renderer.loadTile(this)}unload(){this.renderData&&this.unrefMapData(),this.surface.renderer.unloadTile(this);for(const e of mh){const t=this.layerInfo[e];for(const i of t)i.loadingAgent&&i.loadingAgent!==ks&&(rf(i.loadingAgent),i.loadingAgent=null),i.pendingUpdates=0}this.resetPendingUpdate(8),this.resetPendingUpdate(16),this.resetPendingUpdate(32)}unloadMapData(){const e=this.layerInfo[1];for(const t of e)t.loadingAgent&&t.loadingAgent!==ks&&(rf(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0,t.invalidateSourceData();this.renderData?.releaseTexture(),this.setMemoryDirty()}updateClippingStatus(e){if(ql(e,this._clippingArea))return!1;const t=this._intersectsClippingArea,i=this._withinClippingArea;e!=null?(this._intersectsClippingArea=this.intersectsExtent(e),this._withinClippingArea=this._isWithinExtent(e)):(this._intersectsClippingArea=!0,this._withinClippingArea=!0),this._clippingArea=e,this.updateVisibility();const r=i&&this._withinClippingArea,n=!(i||t||this._withinClippingArea||this._intersectsClippingArea);return!this.renderData||r||n||this.setPendingUpdate(8),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty()}getLayerInfo(e,t){return this.layerInfo[t][e]}hasLayerData(e,t){const i=this.layerInfo[t][e];return!(!i?.data||i.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return!0;for(const e of mh){const t=this.layerInfo[e];for(const i of t)if(i.loadingAgent&&i.loadingAgent!==ks&&i.loadingAgent.updating)return!0}return!1}_isSuspended(e){return!!this.hasPendingUpdate(1)||e!==0&&!this._loadable}get hasPendingUpdates(){return this._pendingUpdates!==0}hasPendingUpdate(e){return(this._pendingUpdates&e)===e}setPendingUpdate(e){const t=this._pendingUpdates;return this._pendingUpdates|=e,e===1||e===4?this._surface.setTileTreeDirty():this._surface.requestUpdate(),t!==this._pendingUpdates}resetPendingUpdate(e){return!!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)}requestLayerData(e,t,i){const r=this.layerInfo[t][e];if(r.waitingAgents.has(i))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),i.tile.lij.toString(),t,e),!0;if(r.waitingAgents.push(i),r.data&&!r.dataInvalidated){console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),i.tile.lij.toString(),t,e);const o=dh(r.data);return i.dataArrived(this,o),!0}if(r.requestPromise)return!0;Os(r.requestAbort),r.requestAbort=new AbortController;const n=this._surface.requestTileData(this,e,t,r.requestAbort);if(!n)return r.requestAbort=null,!1;const a=()=>{r.requestPromise===n&&(r.requestPromise=null,r.requestAbort=null)};return r.requestPromise=n,n.then(a,a),!0}get leaf(){return this._children[0]==null}hasLij(e){return this._lij[0]===e[0]&&this._lij[1]===e[1]&&this._lij[2]===e[2]}findByLij(e){if(this.hasLij(e))return this;const t=this._children;return t[0]?t[0].findByLij(e)||t[1].findByLij(e)||t[2].findByLij(e)||t[3].findByLij(e):null}distanceToSquared(e){return Gs(he($i,Hi(this._center[1]),e))}containsPoint(e){const t=this.extent;return e[0]>=t[0]&&e[1]>=t[1]&&e[0]<=t[2]&&e[1]<=t[3]}containsPointXY(e,t){const i=this.extent;return e>=i[0]&&t>=i[1]&&e<=i[2]&&t<=i[3]}unrequestLayerData(e,t,i){const r=this.layerInfo[t][e],n=r.waitingAgents,a=n.removeUnordered(i)!=null;xi(a,"agent has not requested this piece of map data"),n.length<1&&(r.abortRequest(),this.setMemoryDirty())}dataArrived(e,t,i){const r=dh(i),n=this.layerInfo[t][e];n.data=i,n.dataInvalidated=!1,n.waitingAgents.forAll(a=>a.dataArrived(this,r)),n.waitingAgents.clear(),this.setMemoryDirty()}dataMissing(e,t){const i=this.layerInfo[t][e];i.dataMissing=!0,i.waitingAgents.forAll(r=>r.dataMissing()),i.waitingAgents.clear(),this.setMemoryDirty()}updateRenderData(e,t,i){switch(i&&this.forEachLoadedNeighbor(r=>r.updateRenderData(e,t)),e){case 1:return this._updateTexture(t);case 0:return this._updateGeometry()}}_updateTexture(e){this.renderData&&(this.resetPendingUpdate(e===0?16:32),this.setPendingUpdate(e===0?32:16))}_updateGeometry(){this.setPendingUpdate(8);for(const e of this.layerInfo[0])e.pendingUpdates|=8}invalidateLayerData(e,t){this.layerInfo[t][e].invalidateSourceData(),this.restartAgents(t)}computeElevationBounds(){const e=this._elevationBoundsMin,t=this._elevationBoundsMax;let i=1/0,r=-1/0;const n=this.layerInfo[0];let a=!0;for(const o of n)o.elevationBounds!=null&&(i=Math.min(i,o.elevationBounds.min),r=Math.max(r,o.elevationBounds.max),o.elevationBounds.hasNoDataValues||(a=!1));a&&(i=Math.min(i,0),r=Math.max(r,0)),e===i&&t===r||(this._elevationBoundsMin=i,this._elevationBoundsMax=r,this.updateRadiusAndCenter(),this._surface.setTileTreeDirty())}_updateCenter(){const e=this._elevationBoundsMin,t=this._elevationBoundsMax,i=.5*(e+t),r=this._center;ee($i,this.up,i),jw(r[1],ce(j7,this.centerAtSeaLevel,$i)),ee($i,this.up,e),ce(r[0],this.centerAtSeaLevel,$i),ee($i,this.up,t),ce(r[2],this.centerAtSeaLevel,$i)}findElevationBoundsForLayer(e,t){const i=this.layerInfo[0][e],r=this.elevationLevelDelta,n=Math.max(this.elevationLevel-r,0),a=i.elevationBounds;if(a!=null&&a.level>=t&&a.level<=n)return;const o=this._surface.layerViewByIndex(e,0);if(!Xl(this,o))return;const l=q7;let c=!1;const h=i.data;if(h&&h.level<=n){const d=i.data;l.min=d.samplerData.data.minValue,l.max=d.samplerData.data.maxValue,l.hasNoDataValues=d.samplerData.data.hasNoDataValues,l.level=this.level,c=!0}else{let d,m,f=0;for(let g=this._parent;g&&(!m||f<r)&&(f=this.elevationLevel-g.level,d=m||d,m=g.layerInfo[0][e].data,!(!m&&d&&g.level<=n));g=g.parent);m=m||d,m&&(m.computeMinMaxValue(this._lij[0],this._lij[1],this._lij[2],l),l.min!==1/0&&(l.level=m.level,c=!0))}c&&(i.elevationBounds==null&&(i.elevationBounds=new Lh),i.elevationBounds.copyFrom(l))}modifyLayers(e,t,i){const r=this.layerInfo[i];for(const o of r)o.loadingAgent&&o.loadingAgent!==ks&&(rf(o.loadingAgent),o.loadingAgent=null),o.waitingAgents.clear();for(let o=0;o<r.length;++o)e[o]===void 0&&r[o].release();const n=new Array(...r),a=t.length;r.length=a;for(let o=0;o<a;o++){const l=t[o];r[o]=l>-1?n[l]:lg.acquire(this._surface.upsampleInfoPool)}this.setMemoryDirty()}restartAgents(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e,0))}updateAgents(e){if(this.renderData){const t=this.layerInfo[e];for(const i of t)i.loadingAgent===ks&&(i.loadingAgent=null);this._createOrUpdateAgents(0,e)}}updateAgentSuspension(){for(const e of mh){const t=this._isSuspended(e);for(const i of this.layerInfo[e])i.loadingAgent&&i.loadingAgent!==ks&&(i.loadingAgent.setSuspension(t),i.loadingAgent===ks&&this.updateRenderData(e,0))}}removeLayerAgent(e,t){const i=this.layerInfo[t][e];i.loadingAgent&&i.loadingAgent!==ks&&i.loadingAgent.dispose(),i.loadingAgent=null}agentDone(e,t){const i=this.layerInfo[t][e];i.loadingAgent=ks,i.data||i.upsampleInfo!=null||this._createOrUpdateAgents(e+1,t)}_hasBlendableAncestor(e){return e.blendMode!=="normal"||Yh(e.parent)&&this._hasBlendableAncestor(e.parent)}_hasBlendModes(e,t,i){for(let r=e;r<t;++r){const n=this._surface.layerViewByIndex(r,i);if(Rp(n)&&n?.layer?.blendMode!=="normal"||Yh(n?.layer?.parent)&&this._hasBlendableAncestor(n?.layer?.parent))return!0}return!1}_createOrUpdateAgents(e,t){const i=this.layerInfo[t];if(i.length===0)return;const r=this._isSuspended(t);for(let n=e;n<i.length;++n){const a=i[n],o=this._surface.layerViewByIndex(n,t);let l=!1;if(a.loadingAgent?Xl(this,o)?(a.loadingAgent!==ks&&a.loadingAgent.setSuspension(r),a.loadingAgent!==ks&&(l=a.loadingAgent.update())):a.dispose():Xl(this,o)&&(a.loadingAgent=H7(this,n,t,r),l=a.loadingAgent.startLoading(),l?a.loadingAgent===ks&&this.setPendingUpdate(8):(rf(a.loadingAgent),a.loadingAgent=ks)),a.loadingAgent===ks&&this.updateRenderData(t,0),!o.destroyed&&!this._hasBlendModes(e,i.length,t)&&l&&o.isOpaque)return}}_isWithinExtent(e){const t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]}intersectsExtent(e){const t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]}getElevationVerticesPerSide(e){const t=this.elevationLevel-this.level,i=Math.max(this.level-e,this.elevationLevelDelta-t),r=U(1+(this._maxTesselation>>i),2,this._maxTesselation+1),n=this.minimumVerticesPerSide;return Math.max(r,n)}_findLIJ(e,t){if(!e)return null;const i=this.surface.rootTiles;if(i!=null){for(const r of i)if(G7(r,e)){let n=r,a=e[0]-n.level-1;for(;a>=0&&!n.leaf&&!t(n);){const o=e[1]>>a&1,l=e[2]>>a&1;n=n.children[2*o+l],a--}return t(n)?n:null}}return null}findNeighborTile(e,t){const i=this._lij,r=this._getNeighborLIJ(i,e);return r?hg(i,r)?t(this)?this:null:this._findLIJ(r,t):null}findCorner(e,t){const i=e===1?1:e===7?0:e===5?2:3;let r=this;for(;r.children[0]&&(!t||!t(r));)r=r.children[i];return r}findNeighborCornerTileExact(e,t){return this.findNeighborTile(e,i=>t(i)||i.level===this.level)?.findCorner(p_(e),t)||null}forAllSubtreeOnSide(e,t){const i=e===0?[0,1]:e===1?[1]:e===2?[1,3]:e===3?[3]:e===4?[2,3]:e===5?[2]:e===6?[0,2]:[0],r=n=>{const a=n.children;!t(n)&&a[0]&&i.forEach(o=>r(a[o]))};r(this)}getNeighborEdgeStartVertexIndex(e,t){if(!t)return 0;const i=this.level-t.level;if(B(!_i||i>=0),i===0)return 0;const r=2**i,n=!(1&~e),a=n?0:1,o=t.lij[a+1]*r,l=this._lij[a+1],c=l-o,h=n?r-1-c:c;return _i&&(B(o<=l&&l<o+r),B(0<=h&&h<r)),h}forEachLoadedNeighbor(e){const t=this.level,i=r=>r.level===t||r.loaded;wn.forEach(r=>{const n=this.findNeighborTile(r,i);n!=null&&n!==this&&n.forAllSubtreeOnSide(F1(r),a=>!!a.loaded&&(e(a,r),!0))}),m_.forEach(r=>{const n=this.findNeighborTile(r,i)?.findCorner(p_(r),a=>a.loaded);B(!n||Gb(this,n,r)),n?.loaded&&e(n,r)})}_getNeighborLIJ(e,t){const i=WS(t)?-1:jS(t)?1:0,r=qS(t)?-1:GS(t)?1:0,n=[e[0],e[1]+i,e[2]+r];return n[1]<0?null:this.surface.isGlobal?this._wrapLIJ(n):n[2]<0?null:n}_wrapLIJ(e){return!e||e[1]<0||e[1]>=2**e[0]?null:this.surface.wrapEastWest(e)}isEdgeNeighbor(e,t){if(e==null)return!1;if(this.level===0&&e.level===0&&(this._eastEnd&&e._westEnd&&t===2||this._westEnd&&e._eastEnd&&t===6))return!0;const i=Math.max(1e-6*(this.extent[2]-this.extent[0]),1);switch(t){case 0:return Ir(this.extent[3],e.extent[1],i);case 4:return Ir(this.extent[1],e.extent[3],i);case 2:return Ir(this.extent[2],e.extent[0],i)||Ir(this.extent[2],-e.extent[0],i);case 6:return Ir(this.extent[0],e.extent[2],i)||Ir(this.extent[0],-e.extent[2],i)}}get _eastEnd(){return this._lij[2]===this.surface.lijEastEnd(this.level)-1}get _westEnd(){return this._lij[2]===0}checkGeometryWaterproofness(){u_&&(B(this.loaded),this.renderData?.checkGeometryWaterproofness())}shouldHaveNeighbor(e){const t=this.extent,i=this.surface.rootTilesExtent,r=.25*(t[2]-t[0]);if(WS(e)&&t[3]+r>=i[3]||jS(e)&&t[1]-r<=i[1])return!1;const n=this.surface.isGlobal;return!(!n&&qS(e)&&t[0]-r<=i[0])&&!(!n&&GS(e)&&t[2]+r>=i[2])}updateDistanceToPOI(e){const t=this._lastPOI;if(this.distanceToPOI>=0&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return;q(this._lastPOI,e);const i=this._center[1],r=e[0]-i[0],n=e[1]-i[1],a=e[2]-i[2];this.distanceToPOI=r*r+n*n+a*a}updateOverlayParameters(e){const{renderData:t}=this;if(!t)return;const{overlays:i,longitudeCyclical:r}=e,n=t.overlay;if(i.length===0)this._clearTileOverlayData(0,n),this._clearTileOverlayData(1,n);else{const[a,o]=i,l=this.extent;YF(a.extent,l,r)||Kx(l,a.extent,r)||Kx(l,o.extent,r)?(this._setOverlayData(i,r,l,0,n),this._setOverlayData(i,r,l,1,n)):(this._clearTileOverlayData(0,n),this._clearTileOverlayData(1,n))}}_setOverlayData(e,t,i,r,n){const a=e[r].extent,o=hr(a),l=Xn(a);let c=i[0];if(t){c=t.minimalMonotonic(a[0],c);const h=t.minimalMonotonic(a[0],i[2]);c>h&&(c=h-(i[2]-i[0]))}n.setScale(r,hr(i)/o,Xn(i)/l),n.setOffset(r,(c-a[0])/o,(i[1]-a[1])/l)}_clearTileOverlayData(e,t){t.setScale(e,-1,-1),t.setOffset(e,-1,-1)}}function H7(s,e,t,i){const r=t===0?Y1.acquire():X1.acquire();return r.init(s,e,t,i),r}function rf(s){s.dispose(),F7(s)?Y1.release(s):z7(s)&&X1.release(s)}const X1=new Do(()=>new k7),Y1=new Do(()=>new L7),q7=new Lh;function G7(s,e){const t=s.lij,i=e[0]-t[0];return!(i<0)&&e[1]>>i===t[1]&&e[2]>>i===t[2]}function hg(s,e){return s[0]===e[0]&&s[1]===e[1]&&s[2]===e[2]}function Gb(s,e,t){return s!=null&&e!=null&&e!==s&&(s.level>=e.level?I2(s,e,t):I2(e,s,p_(t)))}function I2(s,e,t){B(s.level>=e.level);const i=Dj(t),r=Ej(t),n=s.extent,a=e.extent,o=[i?n[0]:n[2],r?n[3]:n[1]],l=[i?a[2]:a[0],r?a[1]:a[3]],c=1e-5*(n[2]-n[0]),h=Ir(o[0],l[0],c)||s.surface.isGlobal&&Ir(o[0],-l[0],c),d=Ir(o[1],l[1],c);if(h&&d)return!0;if(s.level===e.level||!h&&!d)return B(!1),!1;const m=h?L2(a[1],a[3],n[1],n[3],c):L2(a[0],a[2],n[0],n[2],c);return B(m),m}function L2(s,e,t,i,r){return s-r<=t&&t<=i&&i<=e+r}const nf=x(),Lv=x(),Fv=x(),$i=x(),j7=x(),W7=65536;function Q7(s,e){const{tile:t,geometry:i,geometryState:r}=s,{extentInRadians:n,surface:a}=t,{isWebMercator:o,renderer:l}=a,{numVerticesPerSide:c,wireframe:h}=r,d=c-1,m=(c-2)**2,f=o&&(e===2||e===3),g=o&&(e===1||e===3),_=((f?1:0)+(g?1:0))*ug*c,v=YE(r),b=m+_+4*v,T=l.tileGeometryCache.acquire(b);i.numVerticesPerSide=c,i.vertexAttributes=T,i.maxEdgeVertexCount=v;const{boundingBox:w}=i;Hr(w);const S=J1(s);Ri.update(d,n,S),X7(s),i.poleVerticesStartIndex=m;const C=Z7(s,f,g);i.edgeVerticesStartIndex=m+_,tx(s),K1(s),HE(i,C,h),s.intersectionData=null}function Z7(s,e,t){const{tile:i,localOrigin:r,geometry:n}=s,{extent:a,ellipsoid:o}=i,{boundingBox:l,numVerticesPerSide:c,vertexAttributes:h,poleVerticesStartIndex:d}=n,m=c-1,f=r[0],g=r[1],_=r[2],v=o.radius,b=a[1],T=a[3],w=[];let S=d;const C=(P,M)=>{const O=M*c;kr(-f,-g,P*v-_,l),w.push(new mW(P===1,O,P===1?0:2,S,ug));const D=zE(P===-1?b:T,v),A=P*Math.PI/2-D,F=.99*(P===1?1:-1),E=v+0,{position:z,uv0:L}=h,{typedBuffer:I,typedBufferStride:ie}=h.normalCompressed;for(let N=1;N<=ug;++N){const se=D+A*(N/ug),G=Math.cos(se),Ce=Math.sin(se);for(let ue=0;ue<=m;ue++){const Oe=ue/m,ae=Ri.sinLonLUT[ue],we=Ri.cosLonLUT[ue]*G,ze=ae*G,Xe=Ce,$t=we*E-f,ut=ze*E-g,De=Xe*E-_;kr($t,ut,De,l),z.setValues(S,$t,ut,De),L.setValues(S,Math.round(Oe*ui),Math.round(F*ui)),yp(I,S,we,ze,Xe,ie),++S}}};return e&&C(-1,0),t&&C(1,m),w}function X7(s){const{tile:e}=s;if(!e.intersectsClippingArea)return;const{geometry:t,geometryState:i,localOrigin:r}=s,{numVerticesPerSide:n,samplerData:a}=i,o=n-2,l=n-1,{vertexAttributes:c,boundingBox:h}=t,{position:d,uv0:m}=c,{typedBuffer:f,typedBufferStride:g}=c.normalCompressed,{extent:_}=e,v=_[0],b=_[2],T=_[1],w=_[3],S=e.ellipsoid.radius,C=r[0],P=r[1],M=r[2],O=d.typedBuffer,D=d.typedBufferStride,A=1/l;let F=0;if(1<=o){const E=A,z=T*(1-E)+w*E,L=Ri.sinLatLUT[1],I=Ri.cosLatLUT[1];for(let ie=1;ie<=o;ie++){const N=ie*A,se=v*(1-N)+b*N,G=Ri.sinLonLUT[ie],Ce=Ri.cosLonLUT[ie],ue=S+Ft(se,z,a),Oe=ue*Ce*I-C,ae=ue*G*I-P,we=ue*L-M;kr(Oe,ae,we,h);const ze=(ie-1)*D;O[ze]=Oe,O[ze+1]=ae,O[ze+2]=we,m.setValues(ie-1,Math.round(N*ui),Math.round(E*ui))}}for(let E=1;E<=o;E++){const z=E*A,L=T*(1-z)+w*z,I=Ri.sinLatLUT[E],ie=Ri.cosLatLUT[E],N=E+1,se=N*A,G=T*(1-se)+w*se,Ce=Ri.sinLatLUT[N],ue=Ri.cosLatLUT[N],Oe=Ri.sinLonLUT[0],ae=Ri.cosLonLUT[0],we=S+Ft(v,L,a);let ze=ae*ie*we-C,Xe=Oe*ie*we-P,$t=I*we-M;const ut=F*D;let De=O[ut],dt=O[ut+1],Ee=O[ut+2];for(let Se=1;Se<=o;Se++){const Ge=Se*A,K=v*(1-Ge)+b*Ge,Ne=Ri.sinLonLUT[Se],W=Ri.cosLonLUT[Se];let H=0,de=0,ye=0;if(Se<o){const _t=(F+1)*D;H=O[_t],de=O[_t+1],ye=O[_t+2]}else{const _t=Ri.sinLonLUT[l],qt=Ri.cosLonLUT[l],Jt=S+Ft(b,L,a);H=qt*ie*Jt-C,de=_t*ie*Jt-P,ye=I*Jt-M}const Te=ze,oe=Xe,Y=$t;ze=De,Xe=dt,$t=Ee,De=H,dt=de,Ee=ye;const J=H-Te,ve=de-oe,Le=ye-Y;let Tt=0,St=0,Ye=0;if(E>1){const _t=(F-o)*D;Tt=O[_t],St=O[_t+1],Ye=O[_t+2]}else{const _t=Ri.sinLatLUT[0],qt=Ri.cosLatLUT[0],Jt=S+Ft(K,T,a);Tt=W*qt*Jt-C,St=Ne*qt*Jt-P,Ye=_t*Jt-M}const pt=S+Ft(K,G,a),gt=W*ue*pt-C,Ke=Ne*ue*pt-P,Je=Ce*pt-M;if(E<o){const _t=F+o,qt=_t*D;O[qt]=gt,O[qt+1]=Ke,O[qt+2]=Je,kr(gt,Ke,Je,h),m.setValues(_t,Math.round(Ge*ui),Math.round(se*ui))}const je=Tt-gt,Pe=St-Ke,Fe=Ye-Je;let et=W*ie,tt=Ne*ie,Et=I;Et*Et<.999&&(et=Le*Pe-ve*Fe,tt=J*Fe-Le*je,Et=ve*je-J*Pe);const mt=1/Math.sqrt(et*et+tt*tt+Et*Et);yp(f,F,et*mt,tt*mt,Et*mt,g),++F}}}function Y7(s){s.tile.intersectsClippingArea&&(K1(s),xu(s),s.intersectionData=null)}function K7(s){s.tile.intersectsClippingArea&&(jE(s),K1(s),xu(s),ZE(s),s.intersectionData=null)}function J7(s){s.tile.intersectsClippingArea&&(kE(s),VE(s,!0),xu(s),s.intersectionData=null)}function K1(s){s.tile.intersectsClippingArea&&(kE(s),VE(s))}function VE(s,e=!1){const{geometry:t,geometryState:i,tile:r,localOrigin:n}=s,{level:a,extent:o,extentInRadians:l,ellipsoid:c}=r,h=c.radius,d=l[0],m=l[2],f=l[1],g=l[3],{samplerData:_}=i,v=o[0],b=o[2],T=o[1],w=o[3],S=J1(s),{boundingBox:C,vertexAttributes:P}=t,M=n[0],O=n[1],D=n[2],{position:A,uv0:F}=P,E=A.typedBuffer,z=A.typedBufferStride;for(let L=0;L<4;++L){const I=L===1||L===3,ie=i.edgeResolutions[L];B(sc(ie));const N=ie+1,se=Ll(r,i.edgePeerNeighbors[L]);if(XE(r,se,L)){WE(s,L,se);continue}const G=se!=null;B(!G||se.level===r.level),B(!G||Jn(r,se)<=0);const Ce=se?.renderData,ue=Ce?.geometryState;if(_i){const J=r.surface;if(!se&&J&&!J.updatingRootTiles){const ve=wn[L],Le=r.findNeighborTile(ve,Tt=>Tt.loaded||Tt.leaf||Tt.level===r.level);Le?Le.intersectsClippingArea&&(B(!Le.loaded),B(!Le.leaf),B(Le.level===a)):B(J?.rootTiles==null||!r.shouldHaveNeighbor(ve))}}const Oe=L===1?o[2]:o[0],ae=se?.extent,we=ae&&I?L===1?ae[0]:ae[2]:Oe,ze=L===0?o[3]:o[1],Xe=L===1?1:0,$t=L===0?1:0,ut=L===1?m:d,De=L===0?g:f,dt=Math.sin(ut),Ee=Math.cos(ut),Se=Math.sin(De),Ge=Math.cos(De),K=ue?.samplerData,Ne=G?(J,ve,Le)=>.5*(Ft(J,ve,_)+Ft(Le,ve,K)):(J,ve,Le)=>Ft(J,ve,_),W=t.outerEdgesOffsetAndLength[2*L+0],H=e&&N>3?N-3:1,de=_!=null&&_.some(J=>J!=null),ye=K!=null&&K.some(J=>J!=null),Te=de||ye,oe=1/ie,Y=W;B(!ae||Ir(ae[2]-ae[0],o[2]-o[0])),(()=>{const J=L===1?-1:L===3?1:0,ve=L===0?-1:L===2?1:0,Le=(o[2]-o[0])*oe,Tt=J*Le,St=ve*Le,Ye=I?J*((m-d)*oe):0,pt=I?0:ve*oe,gt=$t,Ke=I?ut+Ye:ut,Je=I?Math.sin(Ke):dt,je=I?Math.cos(Ke):Ee,Pe=I?ut-Ye:ut,Fe=I?Math.sin(Pe):dt,et=I?Math.cos(Pe):Ee,tt=I?De:S(gt+pt),Et=I?Se:Math.sin(tt),mt=I?Ge:Math.cos(tt),_t=I?De:S(gt-pt),qt=I?Se:Math.sin(_t),Jt=I?Ge:Math.cos(_t);let ji=0,Ys=0,cs=0;{const it=0*oe,ni=I?Oe:v*(1-it)+b*it,ei=I?we:ni,Ii=I?T*(1-it)+w*it:ze,Pi=I?ut:d*(1-it)+m*it,ca=I?dt:Math.sin(Pi),jr=I?Ee:Math.cos(Pi),As=I?S(it):De,Wr=I?Math.sin(As):Se,Is=I?Math.cos(As):Ge,hs=h+Ne(ni,Ii,ei);ji=jr*Is*hs,Ys=ca*Is*hs,cs=Wr*hs}let Ks=0,Yi=0,wi=0;{const it=1*oe,ni=I?Oe:v*(1-it)+b*it,ei=I?we:ni,Ii=I?T*(1-it)+w*it:ze,Pi=I?ut:d*(1-it)+m*it,ca=I?dt:Math.sin(Pi),jr=I?Ee:Math.cos(Pi),As=I?S(it):De,Wr=I?Math.sin(As):Se,Is=I?Math.cos(As):Ge,hs=h+Ne(ni,Ii,ei);Ks=jr*Is*hs,Yi=ca*Is*hs,wi=Wr*hs}for(let it=1;it<N-1;it+=H){let ni=0,ei=0,Ii=0;{const Ls=(it+1)*oe,$n=I?Oe:v*(1-Ls)+b*Ls,Ja=I?we:$n,Ki=I?T*(1-Ls)+w*Ls:ze,eo=I?ut:d*(1-Ls)+m*Ls,bc=I?dt:Math.sin(eo),wc=I?Ee:Math.cos(eo),Qo=I?S(Ls):De,em=I?Math.sin(Qo):Se,Pu=I?Math.cos(Qo):Ge,xc=h+Ne($n,Ki,Ja);ni=wc*Pu*xc,ei=bc*Pu*xc,Ii=em*xc}const Pi=ni,ca=ei,jr=Ii,As=Ks,Wr=Yi,Is=wi;Ks=Pi,Yi=ca,wi=jr;{const Ls=Y+it,$n=Ls*z,Ja=As-M,Ki=Wr-O,eo=Is-D;E[$n]=Ja,E[$n+1]=Ki,E[$n+2]=eo,kr(Ja,Ki,eo,C);const bc=it*oe,wc=I?Xe:bc,Qo=I?bc:$t;F.setValues(Ls,Math.round(wc*ui),Math.round(Qo*ui))}const hs=ji,Y3=Ys,K3=cs;ji=As,Ys=Wr,cs=Is;const Tu=As,Su=Wr,gc=Is,Jp=1/Math.sqrt(Tu*Tu+Su*Su+gc*gc),Tx=gc*Jp;let _c=0,yc=0,vc=0;if(Te&&Tx*Tx<.999){let Ls=0,$n=0,Ja=0;{const Ki=L===0?-1:1;Ls=Ki*(Pi-hs),$n=Ki*(ca-Y3),Ja=Ki*(jr-K3)}{const Ki=it*oe,eo=I?Oe:v*(1-Ki)+b*Ki,bc=I?we:eo,wc=I?T*(1-Ki)+w*Ki:ze,Qo=I?ut:d*(1-Ki)+m*Ki,em=I?dt:Math.sin(Qo),Pu=I?Ee:Math.cos(Qo),xc=I?S(Ki):De,Sx=I?Math.sin(xc):Se,Px=I?Math.cos(xc):Ge;let ty=Tu,iy=Su,sy=gc;if(G){const Zo=h+Ft(bc-Tt,wc-St,K),Mu=I?Px:Jt;ty=(I?et:Pu)*Mu*Zo,iy=(I?Fe:em)*Mu*Zo,sy=(I?Sx:qt)*Zo}{const Zo=h+Ft(eo+Tt,wc+St,_),Mu=I?Px:mt,Mx=(I?je:Pu)*Mu*Zo,$x=(I?Je:em)*Mu*Zo,Rx=(I?Sx:Et)*Zo;G||(ty=2*Tu-Mx,iy=2*Su-$x,sy=2*gc-Rx);const ry=L===3?-1:1,Ox=ry*(ty-Mx),Dx=ry*(iy-$x),Ex=ry*(sy-Rx);_c=Ja*Dx-$n*Ex,yc=Ls*Ex-Ja*Ox,vc=$n*Ox-Ls*Dx;const ny=1/Math.sqrt(_c*_c+yc*yc+vc*vc);_c*=ny,yc*=ny,vc*=ny}}}else _c=Tu*Jp,yc=Su*Jp,vc=gc*Jp;t.setEdgeNormalFromValues(L,it,_c,yc,vc)}})()}}function kE(s){QE(s)}function zE(s,e){return Math.PI/2-2*Math.atan(Math.exp(-s/e))}function eW(s,e,t,i){return zE(s*(1-i)+e*i,t)}function tW(s,e,t){return s*(1-t)+e*t}function J1(s){const{tile:e}=s;if(e.surface.isWebMercator){const i=e.extent,r=e.ellipsoid.radius;return n=>eW(i[1],i[3],r,n)}const t=e.extentInRadians;return i=>tW(t[1],t[3],i)}function iW(s,e){const{tile:t,geometryState:i,geometry:r}=s,{extent:n,surface:a}=t,{wireframe:o}=i,l=n[0],c=n[1],h=n[2]-l,d=n[3]-c,{numVerticesPerSide:m,clippingArea:f}=i,g=f!=null?Math.max(0,(f[0]-l)/h):0,_=f!=null?Math.max(0,(f[1]-c)/d):0,v=f!=null?Math.min(1,(f[2]-l)/h):1,b=f!=null?Math.min(1,(f[3]-c)/d):1,T=(m-2)**2,w=YE(i),S=T+4*w,C=a.renderer.tileGeometryCache.acquire(S),{boundingBox:P}=r;Hr(P),r.numVerticesPerSide=m,r.vertexAttributes=C,r.maxEdgeVertexCount=w,r.minu=g,r.minv=_,r.maxu=v,r.maxv=b,sW(s),r.edgeVerticesStartIndex=T,tx(s),ex(s),HE(r,[],o),s.intersectionData=null}function sW(s){const e=s.tile;if(!e.intersectsClippingArea)return;const{geometry:t,geometryState:i,localOrigin:r}=s,{samplerData:n,clippingArea:a,numVerticesPerSide:o}=i,{surface:l,extent:c,ellipsoid:h}=e,{isWebMercatorOnPlateCarree:d}=l,m=a??ix,f=c[0],g=c[1],_=c[2],v=c[3],b=Math.max(f,m[0]),T=Math.min(_,m[2]),w=Math.max(g,m[1]),S=Math.min(v,m[3]),C=h.radius,P=e.horizontalScale,M=o-1,O=o-2,{minu:D,minv:A,maxu:F,maxv:E,boundingBox:z,vertexAttributes:L}=t,{position:I,uv0:ie}=L,{typedBuffer:N,typedBufferStride:se}=L.normalCompressed,G=r[0],Ce=r[1],ue=r[2],Oe=I.typedBuffer,ae=I.typedBufferStride;let we=0;const ze=U(g,w,S),Xe=d?(Math.PI/2-2*Math.atan(Math.exp(-ze/C)))*C:ze*P,$t=1/M,ut=U(g*(1-$t)+v*$t,w,S);let De=Xe,dt=d?(Math.PI/2-2*Math.atan(Math.exp(-ut/C)))*C:ut*P;for(let Ee=1;Ee<=O;Ee++){const Se=Ee/M,Ge=U(g*(1-Se)+v*Se,w,S),K=U(Se,A,E),Ne=dt,W=(Ee-1)/M,H=U(g*(1-W)+v*W,w,S),de=De,ye=(Ee+1)/M,Te=U(g*(1-ye)+v*ye,w,S),oe=d?(Math.PI/2-2*Math.atan(Math.exp(-Te/C)))*C:Te*P,Y=U(ye,A,E);De=dt,dt=oe;const J=U(f,b,T);let ve=J*P,Le=Ft(J,Ge,n);const Tt=1/M,St=U(Tt,D,F),Ye=U(f*(1-St)+_*St,b,T);let pt=St,gt=Ye,Ke=Ye*P,Je=Ft(Ye,Ge,n);if(Ee===1){const je=Ke-G,Pe=De-Ce,Fe=Je-ue,et=0*ae;Oe[et]=je,Oe[et+1]=Pe,Oe[et+2]=Fe,kr(je,Pe,Fe,z);const tt=U(Tt,D,F);ie.setValues(we,Math.round(tt*ui),Math.round(K*ui))}for(let je=1;je<=O;je++){const Pe=Ke,Fe=Je,et=(je+1)/M,tt=U(et,D,F),Et=U(f*(1-et)+_*et,b,T),mt=gt;gt=Et;{const Yi=we+1,wi=Yi*ae;if(Ee===1||je===O){const it=Et*P,ni=Ft(Et,Ge,n);if(Ee===1&&je<O){const ei=it-G,Ii=Ne-Ce,Pi=ni-ue;Oe[wi]=ei,Oe[wi+1]=Ii,Oe[wi+2]=Pi,kr(ei,Ii,Pi,z),ie.setValues(Yi,Math.round(tt*ui),Math.round(K*ui))}Ke=it,Je=ni}else Ke=Oe[wi]+G,Je=Oe[wi+2]+ue}const _t=Ke,qt=Je,Jt=ve,ji=Le;ve=Pe,Le=Fe;const Ys=(we-O)*ae,cs=Ee===1?Ft(mt,H,n):Oe[Ys+2]+ue,Ks=Ft(mt,Te,n);if(Ee<O){const Yi=we+O,wi=Yi*ae,it=Pe-G,ni=oe-Ce,ei=Ks-ue;Oe[wi]=it,Oe[wi+1]=ni,Oe[wi+2]=ei,kr(it,ni,ei,z);const Ii=pt;pt=tt,ie.setValues(Yi,Math.round(Ii*ui),Math.round(Y*ui))}{const Yi=_t-Jt,wi=de-oe,it=wi*(qt-ji),ni=Yi*(cs-Ks),ei=-wi*Yi,Ii=it*it+ni*ni+ei*ei;if(Ii===0)yp(N,we,0,0,1,se);else{const Pi=1/Math.sqrt(Ii);yp(N,we,it*Pi,ni*Pi,ei*Pi,se)}}++we}}}function rW(s,e){s.tile.intersectsClippingArea&&(NE(s),BE(s,!0),xu(s),s.intersectionData=null)}function nW(s,e){s.tile.intersectsClippingArea&&(jE(s),ex(s),xu(s),ZE(s),s.intersectionData=null)}function aW(s,e){s.tile.intersectsClippingArea&&(ex(s),xu(s),s.intersectionData=null)}function ex(s,e){s.tile.intersectsClippingArea&&(NE(s),BE(s,!1))}function BE(s,e){const{geometry:t,geometryState:i,localOrigin:r}=s,n=s.tile,{surface:a,extent:o}=n,{clippingArea:l,samplerData:c}=i,h=l??ix,d=o[0],m=o[2],f=o[1],g=o[3],_=[g>h[3],m>h[2],f<h[1],d<h[0]],v=n.horizontalScale,b=UE(a.isWebMercatorOnPlateCarree,n.ellipsoid.radius,v),{minu:T,minv:w,maxu:S,maxv:C,boundingBox:P}=t,M=Math.max(d,h[0]),O=Math.min(m,h[2]),D=Math.max(f,h[1]),A=Math.min(g,h[3]),F=r[0],E=r[1],z=r[2];for(let L=0;L<4;++L){const I=L===1||L===3,ie=i.edgeResolutions[L];B(sc(ie));const N=ie+1,se=_[L],G=Ll(n,i.edgePeerNeighbors[L]);if(!se&&XE(n,G,L)){WE(s,L,G);continue}const Ce=G!=null&&!se,ue=G?.renderData,Oe=ue?.geometryState;if(_i&&(B(!Ce||G.level===n.level),B(!Ce||Jn(n,G)<=0),n&&!G&&!a.updatingRootTiles)){const oe=wn[L],Y=n.findNeighborTile(oe,J=>J.loaded||J.leaf||J.level===n.level);a.updatingRootTiles||(Y?Y.intersectsClippingArea&&(B(!Y.loaded),B(!Y.leaf),B(Y.level===n.level)):B(a?.rootTiles==null||!n.shouldHaveNeighbor(oe)))}const ae=U(L===1?m:d,M,O),we=U(L===0?g:f,D,A),ze=Oe?.samplerData,Xe=e&&N>3?N-3:1,$t=U(L===1?1:0,T,S),ut=U(L===0?1:0,w,C),De=Ce?(oe,Y)=>.5*(Ft(oe,Y,ze)+Ft(oe,Y,c)):(oe,Y)=>Ft(oe,Y,c),dt=(m-d)/ie,Ee=I?L===1?dt:-dt:0,Se=I?0:L===0?dt:-dt,Ge=-Ee,K=-Se;let Ne=0,W=0,H=0;{const oe=0/ie,Y=I?ae:U(d*(1-oe)+m*oe,M,O),J=I?U(f*(1-oe)+g*oe,D,A):we,ve=De(Y,J);Ne=Y*v,W=b(J),H=ve}let de=0,ye=0,Te=0;{const oe=1/ie,Y=I?ae:U(d*(1-oe)+m*oe,M,O),J=I?U(f*(1-oe)+g*oe,D,A):we,ve=De(Y,J);de=Y*v,ye=b(J),Te=ve}for(let oe=1;oe<N-1;oe+=Xe){const Y=oe/ie,J=de,ve=ye,Le=Te;{const Fe=I?$t:U(Y,T,S),et=I?U(Y,w,C):ut,tt=J-F,Et=ve-E,mt=Le-z;kr(J,Et,mt,P),t.setEdgeVertexFromValuesRawPositionUV(L,oe,tt,Et,mt,Fe,et)}{const Fe=(oe+1)/ie,et=I?ae:U(d*(1-Fe)+m*Fe,M,O),tt=I?U(f*(1-Fe)+g*Fe,D,A):we,Et=De(et,tt);de=et*v,ye=b(tt),Te=Et}const Tt=de,St=Te,Ye=Ne,pt=W,gt=H;Ne=J,W=ve,H=Le;let Ke=0,Je=0,je=0;if(I){const Fe=ye-ve,et=St-Le,tt=pt-ve,Et=gt-Le,mt=U(f*(1-Y)+g*Y,D,A),_t=ae+Ge,qt=_t*v-J,Jt=Ft(_t,mt,c)-Le,ji=L===3?-1:1;if(Ke=ji*(-tt+Fe)*Jt,Je=ji*qt*(-Et+et),je=-ji*qt*(-tt+Fe),Ce){const Ys=ae+Ee,cs=Ys*v-J;Ke=(-tt+Fe)*(Jt-(Ft(Ys,mt,ze)-Le)),Je=(qt-cs)*(-Et+et),je=-(qt-cs)*(-tt+Fe)}}else{const Fe=Tt-J,et=St-Le,tt=Ye-J,Et=gt-Le,mt=U(d*(1-Y)+m*Y,M,O),_t=we+K,qt=Ft(mt,_t,c)-Le,Jt=b(_t)-ve,ji=L===2?-1:1;if(Ke=ji*Jt*(-Et+et),Je=ji*(-tt+Fe)*qt,je=-ji*Jt*(-tt+Fe),Ce){const Ys=mt,cs=we+Se,Ks=b(cs)-ve;Ke=(-Jt+Ks)*(-Et+et),Je=(-tt+Fe)*(-qt+(Ft(Ys,cs,ze)-Le)),je=-(-Jt+Ks)*(-tt+Fe)}}const Pe=1/Math.sqrt(Ke*Ke+Je*Je+je*je);t.setEdgeNormalFromValues(L,oe,Ke*Pe,Je*Pe,je*Pe)}}}function NE(s,e){QE(s)}function oW(s,e){return(Math.PI/2-2*Math.atan(Math.exp(-s/e)))*e}function lW(s,e){return s*e}function UE(s,e,t){return s?i=>oW(i,e):i=>lW(i,t)}function HE(s,e,t){const{numVerticesPerSide:i,vertexAttributes:r,maxEdgeVertexCount:n}=s,a=i-1,o=r.count,l=2*(i-3)*(i-3),c=4*(a+n-3),h=W1.reduce((_,v)=>_+(a+s.getEdgeCount(v)-3),0),d=e.reduce((_,v)=>_+a*(2*(v.latitudeResolution-1)+1),0),m=3*(t?2:1),f=(l+c+d)*m,g=o>=W7?new Uint32Array(f):new Uint16Array(f);for(let _=0;_<f;++_)g[_]=0;s.indices=g,s.indexCount=(l+h+d)*m,s.poleIndicesStartIndex=l*m,s.edgeIndicesStartIndex=(l+d)*m,t?(uW(s),dW(s,e),GE(s)):(cW(s),hW(s,e),qE(s))}function cW(s){const{numVerticesPerSide:e,indices:t,vertexAttributes:i}=s,{position:r}=i,{typedBuffer:n,typedBufferStride:a}=r,o=e-2,l=e-3,c=0,h=e-3;let d=0;for(let m=0;m<l;++m){const f=m*o;for(let g=c;g<h;++g){const _=f+g,v=_+1,b=v+o,T=b-1;KE(_,v,b,T,a,n)?(t[d]=_,t[d+1]=v,t[d+2]=b,t[d+3]=b,t[d+4]=T,t[d+5]=_):(t[d]=_,t[d+1]=v,t[d+2]=T,t[d+3]=T,t[d+4]=v,t[d+5]=b),d+=6}}}function hW(s,e){const{numVerticesPerSide:t,indices:i,poleIndicesStartIndex:r}=s,n=t-1;let a=r;for(const o of e){const l=o.isNorth?1:2,c=o.isNorth?2:1,h=o.isNorth?3:4,d=o.isNorth?4:3;let m=s.getEdgeVertexIndex(o.connectedOuterEdgeOffset,0),f=1;for(let g=0;g<o.latitudeResolution;++g){const _=g===0?o.rowOffset:m+t;for(let v=0;v<n;v++){const b=_+v;i[a]=m,i[a+l]=m+1,i[a+c]=b,g<o.latitudeResolution-1?(i[a+h]=m+1,i[a+d]=b+1,i[a+5]=b,a+=6):a+=3,m+=f}m=_,f=1}}}function qE(s){const{indices:e,numVerticesPerSide:t,edgeIndicesStartIndex:i}=s,r=t-1,n=r-2;let a=i;for(let o=0;o<4;++o){const l=sx[o];let c=0,h=0;const d=s.getEdgeCount(o),m=l.count;B(m===r-1);const f=o===1||o===2,g=f?1:2,_=f?2:1,v=s.getEdgeFirstVertexIndex(o),b=1,T=l.vertex0Index,w=l.stride;for(;c<d-1||h<m-1;){const S=T+h*w,C=v+c*b,P=c<d-1,M=h<m-1,O=P&&(!M||(P?0+r*(c+.5)/(d-1):0)<=(M?1+n*(h+.5)/(m-1):0));O?++c:++h;const D=O?C+b:S+w;e[a]=S,e[a+g]=C,e[a+_]=D,a+=3}}s.indexCount=a}function uW(s){const{indices:e,numVerticesPerSide:t,vertexAttributes:i}=s,{position:r}=i,{typedBuffer:n,typedBufferStride:a}=r,o=t-2;let l=0;for(let c=0;c<t-3;++c){const h=c*o;for(let d=0;d<t-3;++d){const m=c*o+d,f=m+1,g=f+o,_=g-1,v=h+d,b=v+1,T=b+o;KE(v,b,T,T-1,a,n)?(Vh(e,l,m,f,g),l+=6,Vh(e,l,g,_,m)):(Vh(e,l,m,f,_),l+=6,Vh(e,l,_,g,f)),l+=6}}}function dW(s,e){const{indices:t,numVerticesPerSide:i,poleIndicesStartIndex:r}=s,n=i-1;let a=r;for(const o of e){const l=o.connectedOuterEdgeOffset;let c=s.getEdgeVertexIndex(l,0),h=1;for(let d=0;d<o.latitudeResolution;++d){const m=d===0?o.rowOffset:c+i;for(let f=0;f<n;f++)Vh(t,a,c,c+1,m+f),a+=6,d<o.latitudeResolution-1&&(Vh(t,a,c+1,m+f+1,m+f),a+=6),c+=h;c=m,h=1}}}function GE(s){const{indices:e,numVerticesPerSide:t,edgeIndicesStartIndex:i}=s,r=t-1,n=r-2;let a=i;for(let o=0;o<4;++o){const l=sx[o];let c=0,h=0;const d=s.getEdgeCount(o),m=l.count;B(m===r-1);const f=o===1||o===2,g=f?1:3,_=f?3:1,v=s.getEdgeFirstVertexIndex(o),b=1,T=l.vertex0Index,w=l.stride;for(;c<d-1||h<m-1;){const S=T+h*w,C=v+c*b,P=c<d-1,M=h<m-1,O=P&&(!M||(P?0+r*(c+.5)/(d-1):0)<=(M?1+n*(h+.5)/(m-1):0));O?++c:++h;const D=O?C+b:S+w;e[a]=S,e[a+g]=C,e[a+g+1]=C,e[a+_]=D,e[a+_+1]=D,e[a+5]=S,a+=6}}s.indexCount=a}function tx(s){const{geometry:e,geometryState:t}=s,{edgeResolutions:i}=t,{numVerticesPerSide:r,edgeVerticesStartIndex:n}=e,a=r-2;let o=n;for(let l=0;l<4;++l){{const c=l===0||l===2,h=(l===0?a-1:0)*a+(l===1?a-1:0),d=(c?0:1)*a+(c?1:0),m=sx[l];m.vertex0Index=h,m.stride=d,m.count=a}{const c=i[l]+1;e.outerEdgesOffsetAndLength[2*l+0]=o,e.outerEdgesOffsetAndLength[2*l+1]=c,o+=c}}}function jE(s){tx(s),s.geometryState.wireframe?GE(s.geometry):qE(s.geometry)}function WE(s,e,t){const{geometryState:i,geometry:r,tile:n,localOrigin:a}=s,o=e===1||e===3,l=i.edgeResolutions[e];B(sc(l));const c=l+1,{boundingBox:h,minu:d,minv:m,maxu:f,maxv:g,vertexAttributes:_}=r,v=U(e===1?1:0,d,f),b=U(e===0?1:0,m,g),T=t.renderData,w=T.geometryState,S=T.geometry,C=(e+2)%4,P=S.getEdgeCount(C),M=n.getNeighborEdgeStartVertexIndex(e,t)*l,O=l*2**(n.level-t.level);B(w.edgeResolutions[C]===O),B(P-1===O);const D=T.localOrigin[0]-a[0],A=T.localOrigin[1]-a[1],F=T.localOrigin[2]-a[2],E=r.getEdgeFirstVertexIndex(e),{position:z,uv0:L}=_,I=z.typedBuffer,ie=z.typedBufferStride,N=_.normalCompressed,se=N.typedBuffer,G=N.typedBufferStride,Ce=S.vertexAttributes,ue=S.getEdgeFirstVertexIndex(C),Oe=Ce.position.typedBuffer,ae=Ce.position.typedBufferStride,we=Ce.normalCompressed.typedBuffer,ze=Ce.normalCompressed.typedBufferStride;for(let Xe=1;Xe<c-1;++Xe){const $t=E+Xe,ut=ue+(M+Xe),De=$t*ie,dt=ut*ae,Ee=Oe[dt]+D,Se=Oe[dt+1]+A,Ge=Oe[dt+2]+F;I[De]=Ee,I[De+1]=Se,I[De+2]=Ge,kr(Ee,Se,Ge,h);const K=$t*G,Ne=ut*ze;se[K]=we[Ne],se[K+1]=we[Ne+1];const W=Xe/l,H=o?v:U(W,d,f),de=o?U(W,m,g):b;L.setValues($t,Math.round(H*ui),Math.round(de*ui))}}function QE(s){const{geometry:e,geometryState:t,localOrigin:i}=s,{clippingArea:r,samplerData:n}=t,{minu:a,minv:o,maxu:l,maxv:c,boundingBox:h,vertexAttributes:d}=e,m=s.tile,{surface:f,ellipsoid:g,extent:_,extentInRadians:v,horizontalScale:b}=m,T=f.view?.viewingMode==="local",w=g.radius;let S=0,C=0,P=0;const M=(K,Ne,W)=>{const H=v[Ne===0?1:3],de=v[K===0?0:2],ye=Math.cos(H),Te=Math.sin(H),oe=Math.sin(de),Y=Math.cos(de),J=w+W;S=Y*ye*J,C=oe*ye*J,P=Te*J},O=T?(()=>{const K=r,Ne=K!=null&&(_[3]>K[3]||_[2]>K[2]||_[1]<K[1]||_[0]<K[0]),W=UE(f.isWebMercatorOnPlateCarree,w,b);return(H,de,ye)=>{const Te=H===0?_[0]:_[2],oe=de===0?_[1]:_[3],Y=Ne?U(Te,K[0],K[2]):Te,J=Ne?U(oe,K[1],K[3]):oe,ve=ye;S=Y*b,C=W(J),P=ve}})():M;let D=0,A=0,F=0,E=0,z=0,L=0,I=0,ie=0,N=0;const se=T&&f.isWebMercatorOnPlateCarree,G=(K,Ne,W,H,de)=>{let ye=0,Te=0,oe=0;if(T){const Y=Ne*b,J=se?(Math.PI/2-2*Math.atan(Math.exp(-W/w)))*w:W*b;ye=Y-S,Te=J-C,oe=H-P}else{const Y=J1(K),J=K.tile,ve=J.extent,Le=J.extentInRadians,Tt=(Ne-ve[0])/(ve[2]-ve[0]),St=(W-ve[1])/(ve[3]-ve[1]),Ye=Le[0]*(1-Tt)+Le[2]*Tt,pt=Y(St),gt=Math.cos(pt),Ke=Math.sin(pt),Je=Math.sin(Ye),je=Math.cos(Ye),Pe=w+H;ye=je*gt*Pe-S,Te=Je*gt*Pe-C,oe=Ke*Pe-P}switch(de){case 0:I+=ye,ie+=Te,N+=oe;break;case 1:E-=ye,z-=Te,L-=oe;break;case 2:I-=ye,ie-=Te,N-=oe;break;case 3:E+=ye,z+=Te,L+=oe}},Ce=r??ix,ue=_[0],Oe=_[2],ae=_[1],we=_[3],ze=[we>Ce[3],Oe>Ce[2],ae<Ce[1],ue<Ce[0]],Xe=Math.max(ue,Ce[0]),$t=Math.min(Oe,Ce[2]),ut=Math.max(ae,Ce[1]),De=Math.min(we,Ce[3]),dt=K=>Math.max(Ce[0],Math.min(Ce[2],K)),Ee=K=>Math.max(Ce[1],Math.min(Ce[3],K)),Se=K=>{const Ne=t.cornerNeighborCornerTiles;D=0,A=0,F=1,E=0,z=0,L=0,I=0,ie=0,N=0;let W=1/0;for(let Y=0;Y<4;++Y){const J=Ne[4*K+Y];W=Math.min(W,J?.level??1/0)}for(let Y=0;Y<4;++Y){const J=Ne[4*K+Y];ju[Y]=J?.level===W?J:null}let H=1,de=0;for(let Y=0;Y<4;++Y){const J=ju[Y];J&&(H=Math.max(H,J?.renderData.geometryState.numVerticesPerSide),de=J.extent[2]-J.extent[0])}const ye=de,Te=H;B(Te>1);const oe=ye/Te;for(let Y=0;Y<4;++Y){const J=ju[(Y+3)%4],ve=ju[Y%4];if(!J&&!ve)continue;const Le=Y===0?1:Y===1?2:Y===2?3:0,Tt=Y===0?2:Y===1?3:Y===2?0:1;if(J&&ve){const St=Vv[Y][0]*oe,Ye=Vv[Y][1]*oe,pt=J.extent,gt=dt(pt[Le===0||Le===1?2:0]+St),Ke=Ee(pt[Le===0||Le===3?3:1]+Ye),Je=ve.extent,je=dt(Je[Tt===0||Tt===1?2:0]+St),Pe=Ee(Je[Tt===0||Tt===3?3:1]+Ye),Fe=J.renderData,et=ve.renderData,tt=Ft(gt,Ke,Fe.geometryState.samplerData),Et=Ft(je,Pe,et.geometryState.samplerData);G(Fe,gt,Ke,.5*(tt+Et),Y)}else{const St=J??ve,Ye=J?Le:Tt,pt=St.extent,gt=Vv[Y],Ke=dt(pt[Ye===0||Ye===1?2:0]+gt[0]*oe),Je=Ee(pt[Ye===0||Ye===3?3:1]+gt[1]*oe),je=St.renderData,Pe=Ft(Ke,Je,je.geometryState.samplerData);G(je,Ke,Je,Pe,Y)}}if(!T){const Y=Math.sqrt(S*S+C*C+P*P);D=S/Y,A=C/Y,F=P/Y}if(T||F*F<.999){const Y=Math.sqrt(E*E+z*z+L*L);E/=Y,z/=Y,L/=Y;const J=Math.sqrt(I*I+ie*ie+N*N);I/=J,ie/=J,N/=J,D=L*ie-z*N,A=E*N-L*I,F=z*I-E*ie;const ve=1/Math.sqrt(D*D+A*A+F*F);D*=ve,A*=ve,F*=ve}},Ge=t.cornerNeighborCornerTiles;for(let K=0;K<4;++K){const Ne=K,W=(K+1)%4,H=K===0||K===1?1:0,de=K===0||K===3?1:0,ye=U(H,a,l),Te=U(de,o,c),oe=e.getEdgeFirstVertexIndex(Ne),Y=e.getEdgeCount(Ne),J=K===0||K===3?Y-1:0,ve=e.getEdgeFirstVertexIndex(W),Le=e.getEdgeCount(W),Tt=K===0||K===1?Le-1:0;let St=-1;for(let gt=0;gt<4;++gt){const Ke=Ge[4*K+gt],Je=Ge[4*K+St];Ke&&(St===-1||Jn(Je,Ke)>0)&&(St=gt)}const Ye=St,pt=Ge[4*K+Ye];if(pt!==m){const gt=m.level-pt.level,Ke=2**gt,Je=[pt.lij[0]+gt,pt.lij[1]*Ke,pt.lij[2]*Ke],je=[Je[1]+Ke===m.lij[1],K===0&&(Ye===1||Ye===0&&pt!==Ge[4*K+3])||K===1&&(Ye===0||Ye===1&&pt!==Ge[4*K+2]),Je[1]===m.lij[1]+1,K===2&&(Ye===3||Ye===2&&pt!==Ge[4*K+1])||K===3&&(Ye===2||Ye===3&&pt!==Ge[4*K+0])],Pe=je.reduce((mt,_t)=>mt+(_t?1:0),0);B(Pe===1||Pe===2);let Fe=-1,et=-1;const tt=pt.renderData;if(Pe===1){const mt=je.findIndex(qt=>qt);B(0<=mt&&mt<=3),Fe=(mt+2)%4;const _t=t.edgeResolutions[mt];et=m.getNeighborEdgeStartVertexIndex(mt,pt)*_t+_t*(mt===0&&K===0||mt===1&&K===0||mt===2&&K===1||mt===3&&K===3?1:0)}else{B(je[1]||je[3]),Fe=je[1]?3:1;const mt=tt.geometryState.edgeResolutions[Fe];et=K===0||K===3?0:mt}const Et=tt.geometry;{const mt=oe+J,_t=ve+Tt,qt=Et.getEdgeFirstVertexIndex(Fe)+et,Jt=Et.vertexAttributes,ji=tt.localOrigin,Ys=Jt.position,cs=Ys.typedBuffer,Ks=qt*Ys.typedBufferStride,Yi=cs[Ks]+ji[0]-i[0],wi=cs[Ks+1]+ji[1]-i[1],it=cs[Ks+2]+ji[2]-i[2];kr(Yi,wi,it,h);const ni=d.position,ei=ni.typedBuffer,Ii=mt*ni.typedBufferStride;ei[Ii]=Yi,ei[Ii+1]=wi,ei[Ii+2]=it;const Pi=_t*ni.typedBufferStride;ei[Pi]=Yi,ei[Pi+1]=wi,ei[Pi+2]=it;const ca=d.uv0;ca.setValues(mt,Math.round(ye*ui),Math.round(Te*ui)),ca.setValues(_t,Math.round(ye*ui),Math.round(Te*ui));{const jr=Jt.normalCompressed.typedBuffer,As=qt*Jt.normalCompressed.typedBufferStride,Wr=d.normalCompressed,Is=Wr.typedBuffer;{const hs=mt*Wr.typedBufferStride;Is[hs]=jr[As],Is[hs+1]=jr[As+1]}{const hs=_t*Wr.typedBufferStride;Is[hs]=jr[As],Is[hs+1]=jr[As+1]}}}}else{const gt=ze[Ne],Ke=ze[W];let Je;if(gt||Ke){const et=U(ue*(1-H)+Oe*H,Xe,$t),tt=U(ae*(1-de)+we*de,ut,De);Je=Ft(et,tt,n)}else Je=pW(Ge,K);O(H,de,Je),Se(K);const je=S-i[0],Pe=C-i[1],Fe=P-i[2];kr(je,Pe,Fe,h),e.setEdgeVertexFromValuesRawPositionUVNormal(Ne,J,je,Pe,Fe,ye,Te,D,A,F),e.setEdgeVertexFromValuesRawPositionUVNormal(W,Tt,je,Pe,Fe,ye,Te,D,A,F)}}for(let K=0;K<4;++K)ju[K]=null}function pW(s,e){const t=4*e,i=W1.reduce((o,l)=>Math.min(o,s[t+l]?.level??1/0),1/0);_i&&(B(!s[t+0]||!s[t+2]||Gb(s[t+0],s[t+2],5)),B(!s[t+1]||!s[t+3]||Gb(s[t+1],s[t+3],7)));let r=0,n=0;for(let o=0;o<4;++o){const l=s[t+o];if(l&&l.level===i){const c=o===0||o===1,h=o===0||o===3,d=l.extent,m=d[c?0:2],f=d[h?1:3],g=l.renderData?.geometryState?.samplerData;n+=Ft(m,f,g),r++}}const a=r?n/r:0;return B(a!=null),a}function xu(s){const{vao:e,geometry:t}=s,{vertexAttributes:i,edgeVerticesStartIndex:r}=t,n=i.position.typedBuffer;e.buffer()?.setSubData(n,r,r,n.length)}function ZE(s){const{vao:e,geometry:t}=s,{indices:i,indexCount:r,edgeIndicesStartIndex:n}=t;e.indexBuffer.setSubData(i,n,n,r)}class mW{constructor(e,t,i,r,n){this.isNorth=e,this.connectedRowOffset=t,this.connectedOuterEdgeOffset=i,this.rowOffset=r,this.latitudeResolution=n}}const Vv=[[0,1],[1,0],[0,-1],[-1,0]],Ri=new m7,ix=KF(-1/0,-1/0,1/0,1/0),ju=[null,null,null,null];function XE(s,e,t){if(!e)return!1;const i=Jn(s,e);return i>0||i===0&&t>=2}let af=class{constructor(){this.vertex0Index=0,this.stride=1,this.count=0}getVertexIndex(e){return B(0<=e&&e<this.count),this.vertex0Index+this.stride*e}};const sx=[new af,new af,new af,new af];function kr(s,e,t,i){s<i[0]?i[0]=s:s>i[3]&&(i[3]=s),e<i[1]?i[1]=e:e>i[4]&&(i[4]=e),t<i[2]?i[2]=t:t>i[5]&&(i[5]=t)}function YE(s){const{edgeResolutions:e,numVerticesPerSide:t}=s,i=1+Math.max(...e);return Math.max(t,i)}function KE(s,e,t,i,r,n){const a=s*r,o=n[a],l=n[a+1],c=n[a+2],h=e*r,d=n[h],m=n[h+1],f=n[h+2],g=t*r,_=n[g],v=n[g+1],b=n[g+2],T=i*r,w=n[T],S=n[T+1],C=n[T+2];return(d-w)*(d-w)+(m-S)*(m-S)+(f-C)*(f-C)>(o-_)*(o-_)+(l-v)*(l-v)+(c-b)*(c-b)}function Vh(s,e,t,i,r){s[e]=t,s[e+1]=i,s[e+2]=i,s[e+3]=r,s[e+4]=r,s[e+5]=t}const ug=6;let fW=class extends Z1{constructor(e,t,i,r,n){super(),this._horizontalScaleFactor=1,this._extentInRenderSR=Mt(),this._baseUsedMemory=900,this._subtreeGeometryElevationBoundMin=0,this._subtreeGeometryElevationBoundMax=0,this.init(e,t,i,r,n)}init(e,t,i,r,n){super.init(e,t,i,r,n);const a=n.view.renderSpatialReference,o=n.spatialReference,l=a!=null&&T$(a)&&o!=null&&o.isGeographic?this.ellipsoid.radius*Math.PI/180:1;this._horizontalScaleFactor=l;const{isWebMercatorOnPlateCarree:c}=n,h=this._extentInRenderSR,d=this.extent;if(c){const m=Qe(d[0],d[1],0);zo(m,Dt.WebMercator,m,Dt.PlateCarree);const f=Qe(d[2],d[3],0);zo(f,Dt.WebMercator,f,Dt.PlateCarree),h[0]=m[0],h[1]=m[1],h[2]=f[0],h[3]=f[1]}else for(let m=0;m<4;++m)h[m]=d[m]*l;this.centerAtSeaLevel[0]=.5*(h[0]+h[2]),this.centerAtSeaLevel[1]=.5*(h[1]+h[3]),this.centerAtSeaLevel[2]=0,this._edgeLen=Math.max(h[2]-h[0],h[3]-h[1]),this._edgeLen2=this._edgeLen*this._edgeLen,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateCenter();const e=this._extentInRenderSR,t=.5*(e[2]-e[0]),i=.5*(e[3]-e[1]),r=Math.sqrt(t*t+i*i),n=.5*(this.elevationBoundsMax-this.elevationBoundsMin),a=Math.max(r,n);this._center[1][3]=a}_calculateFrustumVisibility(e){const t=this._aabb(),i=t[0],r=t[1],n=t[2],a=t[3],o=t[4],l=t[5];let c=!0;for(let h=0;h<6;h++){const d=e[h],m=d[0],f=d[1],g=d[2],_=d[3];if(m*(m>0?i:a)+f*(f>0?r:o)+g*(g>0?n:l)+_>=0)return 2;c=c&&m*(m<0?i:a)+f*(f<0?r:o)+g*(g<0?n:l)+_<=0}return c?0:1}_aabb(){const e=this._extentInRenderSR;return HV(e[0],e[1],Math.min(this.elevationBoundsMin,this._subtreeGeometryElevationBoundMin),e[2],e[3],Math.max(this.elevationBoundsMax,this._subtreeGeometryElevationBoundMax))}intersectsRay(e,t,i,r){return of[0]=1/t[0],of[1]=1/t[1],of[2]=1/t[2],r$(this._aabb(),e,of,i,r)}createGeometry(){iW(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds(),this.setMemoryDirty()}_updateSubtreeGeometryElevationsBounds(){const e=this._subtreeGeometryElevationBoundMin,t=this._subtreeGeometryElevationBoundMax,i=this.renderData;let r=e,n=t;if(i){const a=i.geometry.boundingBox;r=a[2],n=a[5]}else if(!this.leaf){r=1/0,n=-1/0;for(const a of this.children){const o=a;r=Math.min(r,o._subtreeGeometryElevationBoundMin),n=Math.max(n,o._subtreeGeometryElevationBoundMax)}}(r!==this._subtreeGeometryElevationBoundMin||n!==this._subtreeGeometryElevationBoundMax)&&(this._subtreeGeometryElevationBoundMin=r,this._subtreeGeometryElevationBoundMax=n,this.parent?._updateSubtreeGeometryElevationsBounds())}get minimumVerticesPerSide(){return this.level<9?3:2}updateCornerElevations(){rW(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}updateEdgeElevations(){aW(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}updateEdgeElevationsAndResolutions(){nW(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}get horizontalScale(){return this._horizontalScaleFactor}};const of=x();let gW=class{constructor(e){this.capacity=e,this._head=0,this._tail=0,this._data=new Array(e)}push(e){const t=this._tail;if(!(t<this.capacity))throw new Error("Queue full");this._data[t]=e,this._tail=t+1}pushAll(e){const t=e.length;if(t===0)return;const i=this._tail;if(!(i+t<=this.capacity))throw new Error("Queue full");for(let r=0;r<t;++r)this._data[i+r]=e[r];this._tail=i+t}pop(){const e=this._head;if(e<this._tail){const t=this._data[e];return this._head=e+1,t}}get empty(){return this._head>=this._tail}get full(){return this._tail>=this._data.length}},_W=class{constructor(){this.extent=Lt(),this.minLevel=0,this.maxLevel=0,this.callback=null}},dg=class extends te{constructor(){super(...arguments),this._queries=new zt({initialSize:10}),this._queriesInvPtr=0,this._queryQueue=new zt({initialSize:30}),this._queryPool=new Do(()=>new _W)}queryVisibleLevelRange(e,t,i,r){const n=this._queryPool.acquire();jl(n.extent,e),n.minLevel=t??-Number.MAX_VALUE,n.maxLevel=i??Number.MAX_VALUE,n.callback=r,this._queryQueue.push(n),this.notifyChange("updating")}get updating(){return this._queryQueue.length!==0}prepare(){for(;this._queries.length<this._queries.data.length&&this._queryQueue.length>0;){const e=this._queryQueue.pop();this._queries.push(e)}this._queriesInvPtr=this._queries.length}process(){for(let e=0;e<this._queries.length;e++){const t=this._queries.data[e];this._queryPool.release(t),t.callback(e>=this._queriesInvPtr),t.callback=null}this._queries.clear(),this.notifyChange("updating")}queriesForTile(e){const t=e.level;let i=0;for(;i<this._queriesInvPtr;){const r=this._queries.data[i],n=r.extent;t>=r.minLevel&&t<=r.maxLevel&&n[0]<=e.extent[2]&&n[2]>=e.extent[0]&&n[1]<=e.extent[3]&&n[3]>=e.extent[1]?(this._queries.swapElements(i,this._queriesInvPtr-1),this._queriesInvPtr--):i++}}};u([p()],dg.prototype,"updating",null),dg=u([R("esri.views.3d.terrain.ScaleRangeQueries")],dg);function yW(s,e,t,i){const r=Math.cos(t);s[0]=Math.cos(e)*r*i,s[1]=Math.sin(e)*r*i,s[2]=Math.sin(t)*i}let vW=class extends Z1{constructor(e,t,i,r,n){super(),this._convexHull=new Array(24),this._boundingSphere=Xs(),this._baseUsedMemory=1816,this.init(e,t,i,r,n)}init(e,t,i,r,n){super.init(e,t,i,r,n);const a=this.ellipsoid.radius,o=this.extentInRadians[0],l=this.extentInRadians[1],c=this.extentInRadians[2],h=this.extentInRadians[3],d=Me(l,h,.5),m=Me(o,c,.5),f=e===0?0:Math.min(Math.abs(l),Math.abs(h));this._edgeLen=(c-o)*Math.cos(f)*a,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=a-Math.sqrt(a*a-this._edgeLen2/4),yW(this.centerAtSeaLevel,m,d,this.ellipsoid.radius),pe(this.up,this.centerAtSeaLevel),this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateBoundingVolumes();const e=this._center;if(this.lij[0]===0)vV(e[1],0,0,0),be(e[0],0,0,0),be(e[2],0,0,0),e[1][3]=this.ellipsoid.radius+this.elevationBoundsMax;else{this._updateCenter();const t=e[1],i=this.convexHull;let r=0;const n=Hi(t);for(let a=0;a<8;++a)r=Math.max(r,bW(n,i,3*a));e[1][3]=Math.sqrt(r)}}_calculateFrustumVisibility(e){if(!Kw(e,this._boundingSphere))return 2;if(this.lij[0]<10)return 1;const t=this.convexHull,i=this.surface.view.state.camera.near;let r=!0;for(let n=0;n<WV;n++){const a=n===4,o=e[n],l=o[0],c=o[1],h=o[2],d=o[3]-(a?i:0);let m=!1;for(let f=0;f<8;++f){const g=3*f;if(l*t[g]+c*t[g+1]+h*t[g+2]+d<0){if(m=!0,!r)break}else r=!1}if(!m)return 2}return r?0:1}computeElevationBounds(){super.computeElevationBounds(),this._updateBoundingVolumes()}createGeometry(){Q7(this.renderData,this._getPatchType()),this._updateBoundingVolumes(),this.setMemoryDirty()}_updateBoundingVolumes(){this._updateConvexHull(),this._updateBoundingSphere(),_i&&this._checkBVs()}_updateBoundingSphere(){const e=this._boundingSphere,t=this.elevationBoundsMin,i=this.elevationBoundsMax,r=this.ellipsoid.radius,n=i;if(this.level===0)bV(e,0,0,0,r+n);else{const a=this.extentInRadians,o=.5*(a[0]+a[2]),l=a[1],c=a[3];dl(k2,o,l,r),dl(z2,o,c,r),ce(Uc,k2,z2),ee(Uc,Uc,(r+.5*(t+i))/on(Uc));const h=this.convexHull;let d=0;const m=(f,g)=>{const _=f[0]-h[3*g],v=f[1]-h[3*g+1],b=f[2]-h[3*g+2];return Math.sqrt(_*_+v*v+b*b)};for(let f=0;f<8;++f){const g=m(Uc,f);d=Math.max(d,g)}nR(e,Uc,d+2)}}_updateConvexHull(){const e=this.extentInRadians,t=this.ellipsoid.radius;if(this.level===0)return;const i=this.elevationBoundsMin,r=this.elevationBoundsMax,n=this._getPatchType(),a=this.surface.isWebMercator,o=a&&n===1,l=a&&n===2,c=l||o,h=Math.PI/2,d=e[0],m=e[2],f=l?-h:e[1],g=o?h:e[3],_=.5*(d+m),v=i,b=t+(c?Math.min(0,v-1):v),T=(N,se,G)=>dl(N,se,G,b),w=x(),S=x(),C=x(),P=x();T(w,d,f),T(S,d,g),T(C,m,g),T(P,m,f);const M=(N,se)=>{for(let G=0;G<3;++G)this._convexHull[3*se+G]=N[G]};M(w,0),M(S,1),M(C,2),M(P,3);const O=r,D=t+(c?Math.max(0,O+1):O),A=x(),F=x(),E=x();dl(F,_,g,b),dl(E,_,f,b),ce(A,F,E),pe(A,A);const z=x(),L=x(),I=(N,se)=>{zi(L,N,se),pe(L,L);const G=-We(N,z)/We(L,z);B(G>=0),ee(L,L,G),ce(N,N,L)};if(2**this.lij[0]>2*this.lij[1]){const N=E,se=x();ti(se,V2,N),pe(se,se),ti(z,N,se),pe(z,z),B(Ir(We(z,N)/on(N),0)),I(w,S),I(P,C),M(w,0),M(P,3)}else if(2**this.lij[0]!==2*this.lij[1]){const N=F,se=x();ti(se,V2,N),pe(se,se),ti(z,se,N),pe(z,z),I(S,w),I(C,P),M(S,1),M(C,2)}const ie=(N,se)=>{const G=D/We(se,A);for(let Ce=0;Ce<3;++Ce)this._convexHull[3*N+Ce]=se[Ce]*G};ie(4,w),ie(5,S),ie(6,C),ie(7,P)}_getPatchType(){const e=this.lij[1],t=e===0,i=e===(1<<this.level)-1;return t?i?3:1:i?2:0}intersectsRay(e,t,i,r){const n=this._boundingSphere,a=n[3]+i,o=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],l=n[0]-e[0],c=n[1]-e[1],h=n[2]-e[2],d=(l*t[0]+c*t[1]+h*t[2])/o,m=t[0]*d-l,f=t[1]*d-c,g=t[2]*d-h;return m*m+f*f+g*g<a*a}get minimumVerticesPerSide(){return this.level<F2.length?F2[this.level]+1:2}updateCornerElevations(){J7(this.renderData),this._updateBoundingVolumes()}updateEdgeElevations(){Y7(this.renderData),this._updateBoundingVolumes()}updateEdgeElevationsAndResolutions(){K7(this.renderData),this._updateBoundingVolumes()}_checkBVs(){if(!_i||this.level<=2)return;const e=this._boundingSphere,t=e[3],i=fp(e,x()),r=x(),n=this.ellipsoid.radius,a=this.elevationBoundsMin,o=this.elevationBoundsMax,l=n+a,c=1,h=0,d=this._center[1];fp(d,x());const m=d[3],f=this.convexHull,g=(W,H)=>{for(let de=0;de<3;++de)W[de]=f[3*H+de]};{const W=x(),H=x(),de=x(),ye=x(),Te=x(),oe=(Y,J,ve,Le)=>{g(H,Y),g(de,J),g(ye,ve),zi(H,H,de),zi(ye,ye,de),ti(W,H,ye),pe(W,W);const Tt=We(W,de);g(Te,Le);const St=We(W,Te),Ye=Math.abs(St-Tt);B(Ir(Ye,0),`Non coplanar ${Y},${J},${ve},${Le} diff = ${Ye}`)};oe(0,1,2,3),oe(4,5,6,7),oe(0,1,4,5),oe(1,2,5,6),oe(2,3,6,7),oe(3,0,7,4)}const _=L0(24),v=(W,H,de)=>{const ye=4*W;for(let Te=0;Te<3;++Te)_[ye+Te]=H[Te];_[ye+3]=de},b=x(),T=x(),w=x(),S=x(),C=(W,H,de,ye)=>{g(b,H),g(T,de),g(w,ye),zi(b,b,T),pe(b,b),zi(w,w,T),pe(w,w),ti(S,b,w),pe(S,S);const Te=We(S,T);v(W,S,Te)};C(0,0,1,2),C(1,1,0,4),C(2,1,5,2),C(3,3,2,6),C(4,4,0,3),C(5,4,6,5);const P=(W,H,de,ye)=>{const Te=4*W;return _[Te]*H+_[Te+1]*de+_[Te+2]*ye-_[Te+3]},M=(W,H,de,ye)=>P(W,H,de,ye)>=-1,O=(W,H)=>M(W,H[0],H[1],H[2]),D=2**this.lij[0]>2*this.lij[1],A=(W,H,de)=>Math.sqrt(JE(W,H,de,i[0],i[1],i[2]))<t,F=W=>A(W[0],W[1],W[2]),E=(W,H)=>A(W[H],W[H+1],W[H+2]),z=this.extentInRadians,L=.5*(z[0]+z[2]),I=z[1],ie=z[3],N=x(),se=x();dl(N,L,ie,l),dl(se,L,I,l);const G=D?"Upper":"Lower";let Ce=!0;for(let W=0;W<6;++W){for(let H=0;H<8;++H){const de=3*H,ye=M(W,f[de],f[de+1],f[de+2]);Ce&&=ye,B(ye,`Tile[${this.lij}] Convex hull point ${H} outside of plane ${W}`)}B(O(W,se),`Tile[${this.lij}] (${G}) bottom mid outside of plane ${W}`),B(O(W,N),`Tile[${this.lij}] (${G}) top mid outside of plane ${W}`)}B(Ce,"Not all convex hull points are inside  convex hull polyhedron"),B(F(se),`Tile[${this.lij}] (${G}) bottom mid outside of bounding sphere`),B(F(N),`Tile[${this.lij}] (${G}) top mid outside of bounding sphere`);for(let W=0;W<8;++W){const H=E(f,3*W);B(H,`Tile[${this.lij}] Convex hull point ${W} outside of bounding sphere`)}for(let W=0;W<6;++W)for(let H=0;H<8;++H){const de=3*H;M(W,f[de],f[de+1],f[de+2])||console.error(`Tile[${this.lij}] Convex hull point ${H} outside of plane ${W}`)}const{extentInRadians:ue}=this,Oe=Math.max(ue[2]-ue[0],ue[3]-ue[1]),ae=Math.round(Oe*n),{renderData:we}=this;if(!we)return;const{geometry:ze,geometryState:Xe,localOrigin:$t}=we,ut=ze.vertexAttributes?.position;if(!ut)return;const De=x(),dt=ze.numVerticesPerSide-2,{indices:Ee,indexCount:Se,edgeVerticesStartIndex:Ge,poleVerticesStartIndex:K}=ze;if(!Ee)return;const Ne=new Set;for(let W=0;W<Se;++W){const H=Ee[W];if(Ne.has(H))continue;Ne.add(H);const de=H<K,ye=H>=Ge;let Te=!1,oe=-1;if(ye){let Pe=Ge;for(let Fe=0;Fe<4;++Fe){const et=Xe.edgeResolutions[Fe];if(H===Pe||H===Pe+et-1){Te=!0;break}if(Pe+=et,H<Pe){oe=Fe;break}}}const Y=ye?Xe.edgePeerNeighbors[oe]:null,J=ye&&Y&&Jn(this,Y)>0;ut.getVec(H,r),ce(De,r,$t);const ve=on(De)-n;let Le=0,Tt=!1;const St=a-ve,Ye=ve-o,pt=St>c,gt=Ye>c,Ke=pt||gt,Je=()=>{const Pe=de?"internal":ye&&!Te?"edge":Te?"corner":"pole";return`Tile[${this.lij}].vertex[${H}]:${Pe}`+(pt?"(below)":gt?"(above)":"")+(J?"(Neighbor)":"")},je=Vw(De,i);if(je>=t+h){const Pe=je-t;Ke||(console.error(`${Je()} is out of the bounding sphere by ${Pe.toFixed(0)} / ${t.toFixed(0)}[tol=${h}] h=${ve.toFixed(0)} / [${a.toFixed(0)}..${o.toFixed(0)}] (${(Pe/t).toFixed(0)})`),Tt=!0)}for(let Pe=0;Pe<6;++Pe)if(!M(Pe,De[0],De[1],De[2])){const Fe=P(Pe,De[0],De[1],De[2]),et=H%dt,tt=(H-et)/dt;Pe===0&&St||Pe===5&&Ye||(console.error(`${Je()} (${et},${tt})|${dt}] is out of the bounding trapezoid plane ${Pe} h=${Math.round(ve)} / [${Math.round(a)}..${Math.round(o)}] dist=${Math.round(Fe)} radii = ${Math.round(t)}/${Math.round(m)}} : maxL = ${ae}`),++Le)}if(Tt||Le>0)break}}get convexHull(){return this._convexHull}};const F2=[128,64,64,32,16,8,8,4];function bW(s,e,t){return JE(s[0],s[1],s[2],e[t],e[t+1],e[t+2])}function JE(s,e,t,i,r,n){const a=i-s,o=r-e,l=n-t;return a*a+o*o+l*l}const dl=(s,e,t,i)=>{const r=Math.cos(e),n=Math.sin(e),a=Math.cos(t),o=Math.sin(t);s[0]=i*a*r,s[1]=i*a*n,s[2]=i*o},V2=[0,0,1],k2=x(),z2=x(),Uc=x();let nn=class extends te{constructor(){super(...arguments),this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0}};u([p()],nn.prototype,"fovX",void 0),u([p()],nn.prototype,"fovY",void 0),u([p()],nn.prototype,"relativeWidthLimit",void 0),u([p()],nn.prototype,"relativeHeightLimit",void 0),u([p()],nn.prototype,"maxLod",void 0),u([p()],nn.prototype,"angledSplitBias",void 0),u([p()],nn.prototype,"aboveGround",void 0),u([p()],nn.prototype,"frustum",void 0),nn=u([R("esri.views.3d.terrain.SplitLimits")],nn);const eA=Xa().vec3f("position").vec2u16("uv0",{glNormalized:!0}).vec2i16("normalCompressed",{glNormalized:!0});let wW=class{constructor(e){this._storage=new Xp((t,i)=>e.newCache(t,i),"TileGeometry")}acquire(e){const i=Math.ceil(e/4)*4,r=this._storage,n=xW(i),a=r.pop(n);if(a)return a;const o=eA.createBuffer(i);return o.release=()=>r.put(n,o),o}clear(){this._storage.clear()}destroy(){this._storage.destroy()}};function xW(s){return s.toString()}function B2(s){return N$(s.layer)}let tA=class extends Xt{constructor(){super(...arguments),this.scale=1,this.offset=pp}};function iA(s){s.attributes.add("position","vec2"),s.attributes.add("uv0","vec2"),s.varyings.add("uv","vec2"),s.varyings.add("vuv","vec2"),s.vertex.uniforms.add(new ge("scale",e=>e.scale),new Br("offset",e=>e.offset)).main.add(y`gl_Position = vec4(position, 0.0, 1.0);
uv = uv0 * scale + offset;
vuv = uv0;`)}function rx(s){s.code.add(y`
    float lineFactorAtPosition(float value) {
      float pos = value * ${y.float(257)};
      if(pos < 0.5 || pos > ${y.float(257-.5)}) {
        return 1.0;
      }

      pos = pos + 0.5;
      float modulo = mod(pos, 16.0);
      return modulo <= 2.0 ?  1.0 - abs(modulo - 1.0) : 0.0;
    }

    float lineFactorAtUV(vec2 uv) {
      return max(lineFactorAtPosition(uv.x), lineFactorAtPosition(uv.y));
    }

    float lineFactor(vec2 uv) {
      vec2 offset = fwidth(uv) * 0.25;
      return (lineFactorAtUV(vec2(uv.x + offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x + offset.x, uv.y - offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y - offset.y))) / 4.0;
    }

    vec3 gridColor(vec2 uv) {
      float line = lineFactor(uv) * 0.1 + 0.9;
      return vec3(1.0, 0.972, 0.918) * line;
    }`)}function CW(s,e){const t=e.blendMode;t!==0&&(t===30&&s.code.add(y`float reflectBlend(in float cb, in float cl) {
return (cl == 1.0) ? cl : min(cb * cb / (1.0 - cl), 1.0);
}`),t!==6&&t!==13||s.code.add(y`float colorDodge(in float cb, in float cl) {
return (cb == 0.0) ? 0.0 : (cl == 1.0) ? 1.0 : min(1.0, cb / (1.0 - cl));
}`),t!==9&&t!==13||s.code.add(y`float colorBurn(in float cb, in float cl) {
return (cb == 1.0) ? 1.0 : (cl == 0.0) ? 0.0 : 1.0 - min(1.0, (1.0 - cb) / cl);
}`),t===10&&s.code.add(y`float overlay(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (1.0 - 2.0 * (1.0 - cl ) * (1.0 - cb)) + step(0.5, cl) * (2.0 * cl * cb);
}`),t===12&&s.code.add(y`float hardLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (2.0 * cl * cb) + step(0.5, cl) * (1.0 - 2.0 * (1.0 - cl) * (1.0 - cb));
}`),t===11&&s.code.add(y`float softLight(in float cb, in float cl) {
if (cl <= 0.5) {
return cb - (1.0 - 2.0 * cl) * cb * (1.0 - cb);
}
if (cb <= 0.25) {
return cb + (2.0 * cl - 1.0) * cb * ((16.0 * cb - 12.0) * cb + 3.0);
}
return cb + (2.0 * cl - 1.0) * (sqrt(cb) - cb);
}`),t===13&&s.code.add(y`float vividLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * colorBurn(cb, 2.0 * cl) + step(0.5, cl) * colorDodge(cb, (2.0 * (cl - 0.5)));
}`),t!==14&&t!==15&&t!==17&&t!==16||(s.code.add(y`float minv3(in vec3 c) {
return min(min(c.r, c.g), c.b);
}
float maxv3(in vec3 c) {
return max(max(c.r, c.g), c.b);
}
float lumv3(in vec3 c) {
return dot(c, vec3(0.3, 0.59, 0.11));
}
vec3 clipColor(vec3 color) {
float lum = lumv3(color);
float mincol = minv3(color);
float maxcol = maxv3(color);
if (mincol < 0.0) {
color = lum + ((color - lum) * lum) / (lum - mincol);
}
if (maxcol > 1.0) {
color = lum + ((color - lum) * (1.0 - lum)) / (maxcol - lum);
}
return color;
}
vec3 setLum(vec3 cbase, vec3 clum) {
return clipColor(cbase + vec3(lumv3(clum) - lumv3(cbase)));
}`),t!==14&&t!==15||s.code.add(y`float satv3(vec3 c) {
return maxv3(c) - minv3(c);
}
vec3 setLumSat(vec3 cbase, vec3 csat, vec3 clum)
{
float minbase = minv3(cbase);
float sbase = satv3(cbase);
float ssat = satv3(csat);
return setLum(sbase > 0.0 ? (cbase - minbase) * ssat / sbase : vec3(0.0), clum);
}`)),s.code.add(y`
    vec4 applyBlendMode(vec3 cl, float ol, vec3 cb, float ob) {
      ${t===8?y`return vec4(cl * ol * cb * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===1?y`return vec4((cb + cl) * 0.5 * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===2?y`return vec4(max(cb, cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===7?y`return vec4(min(cl, cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===3?y`return vec4(cl * ol + cb * ob, ol + ob);`:t===4?y`return clamp(vec4(cl.rgb + cb.rgb, ol + ob), 0.0, 1.0);`:t===28?y`return vec4(clamp(vec3(cb.rgb - cl.rgb), 0.0, 1.0), ob * ol);`:t===5?y`return vec4((cl + cb - cl * cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===26?y`return vec4(abs(cb - cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===29?y`return vec4((1.0 - cb) * ol * ob + cb * ob * (1.0 - ol), ob);`:t===18?y`return vec4(cl * ol * (1.0 - ob) + cb * ob, ol + ob - ol * ob);`:t===19?y`return vec4(cl * ol * (1.0 - ob) + cb * ob * ol, ol);`:t===21?y`return vec4(cb * ob * (1.0 - ol), ob * (1.0 - ol));`:t===22?y`return vec4(cl * ol * ob + cb * ob * (1.0 - ol), ob);`:t===24?y`return vec4(cl * ol * (1.0 - ob), ol * (1.0 - ob));`:t===25?y`return vec4(cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), ol * (1.0 - ob) + ob * (1.0 - ol));`:t===20?y`return vec4(cb * ob * ol, ol * ob);`:t===23?y`return vec4(cl * ol * ob, ol * ob);`:t===14?y`
          vec3 f = setLumSat(cl, cb, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===15?y`
          vec3 f = setLumSat(cb, cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===17?y`
          vec3 f = setLum(cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===16?y`
          vec3 f = setLum(cb, cl);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===27?y`
          vec3 f = cl + cb - 2.0 * cl * cb;
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===30?y`
          vec3 f = vec3(reflectBlend(cb.r, cl.r), reflectBlend(cb.g, cl.g), reflectBlend(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===6?y`
          vec3 f = vec3(colorDodge(cb.r, cl.r), colorDodge(cb.g, cl.g), colorDodge(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===9?y`
          vec3 f = vec3(colorBurn(cb.r, cl.r), colorBurn(cb.g, cl.g), colorBurn(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===10?y`
          vec3 f = vec3(overlay(cb.r, cl.r), overlay(cb.g, cl.g), overlay(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===11?y`
          vec3 f = vec3(softLight(cb.r, cl.r), softLight(cb.g, cl.g), softLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===12?y`
          vec3 f = vec3(hardLight(cb.r, cl.r), hardLight(cb.g, cl.g), hardLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===13?y`
          vec3 f = vec3(vividLight(cb.r, cl.r), vividLight(cb.g, cl.g), vividLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:y``}
    }
  `))}function sA(s,e){const{output:t,blendMode:i,baseOpacityMode:r,premultipliedSource:n}=e,a=s.fragment,o=r===1;o&&a.uniforms.add(new ge("baseOpacity",d=>d.baseOpacity));const l=i!==0,c=!l&&n!==1&&(t===1&&!o||t===4);a.include(CW,e);let h="";switch(t){case 4:case 0:h=y`vec4(0.0)`;break;case 2:a.uniforms.add(new js("backgroundColor",d=>d.backgroundColor)),h=y`vec4(backgroundColor, 1.0)`;break;case 3:a.include(rx),h=y`vec4(gridColor(uv), 1.0)`;break;case 1:a.uniforms.add(new Be("fboColor",d=>d.fboTexture)),h=y`texelFetch(fboColor, ivec2(gl_FragCoord.xy), 0)`}a.code.add(y`
    vec4 getBackground(vec2 uv) {
      return ${X(o,y`baseOpacity *`)} ${h};
    }

    vec4 blendLayers(vec2 bgUV, vec4 colorLayer, float opacity) {
      ${l?y`
          vec3 cl = colorLayer.a == 0.0 ? colorLayer.rgb : colorLayer.rgb / colorLayer.a;
          vec4 bgColor = getBackground(bgUV);
          vec3 cb = bgColor.a == 0.0 ? bgColor.rgb : bgColor.rgb / bgColor.a;
          return applyBlendMode(clamp(cl, vec3(0.0), vec3(1.0)), colorLayer.a * opacity, cb, bgColor.a);`:y`
          float composeAlpha = colorLayer.a * opacity;
          ${c?y`return colorLayer * opacity;`:y`
            vec4 bgColor = getBackground(bgUV);
            return bgColor * (1.0 - composeAlpha) + colorLayer * opacity;`}`}
    }`)}function rA(s){const e=new lt,t=e.fragment;if(e.include(iA),s.background===1){const i=s.output===2;return i?t.uniforms.add(new js("backgroundColor",r=>r.backgroundColor)):t.include(rx),t.main.add(y`fragColor = vec4(${i?y`backgroundColor`:y`gridColor(uv)`}, 1.0);`),e}return e.include(sA,s),t.uniforms.add(new Be("tex",i=>i.texture),new ge("opacity",i=>i.opacity)),t.main.add(y`fragColor = blendLayers(uv, texture(tex, uv), opacity);`),e}const TW=Object.freeze(Object.defineProperty({__proto__:null,build:rA},Symbol.toStringTag,{value:"Module"}));let SW=class extends tA{constructor(){super(...arguments),this.opacity=1,this.baseOpacity=1,this.texture=null,this.fboTexture=null,this.backgroundColor=ea}},N2=class extends ct{constructor(e,t){super(e,t,new ht(TW,()=>k(()=>Promise.resolve().then(()=>iee),void 0)),Ya(Fp))}};function Yl(){const s=new Float32Array(9);return s[0]=1,s[4]=1,s[8]=1,s}function nA(s){const e=new Float32Array(9);return e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3],e[4]=s[4],e[5]=s[5],e[6]=s[6],e[7]=s[7],e[8]=s[8],e}function PW(s,e,t,i,r,n,a,o,l){const c=new Float32Array(9);return c[0]=s,c[1]=e,c[2]=t,c[3]=i,c[4]=r,c[5]=n,c[6]=a,c[7]=o,c[8]=l,c}Object.freeze(Object.defineProperty({__proto__:null,clone:nA,create:Yl,fromValues:PW},Symbol.toStringTag,{value:"Module"}));let MW=class{constructor(e,t){this.sourceTile=t,this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.featureIndex=0,this.uniqueSymbol=null,this._colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=e}colliders(){return this._colliders}},$W=class{constructor(e){this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1,this.lastShow=!1,this.tileSymbols=[e],this.id=e.id}};function RW(s,e,t,i){return aA(s,e,t.level,t.col,i.key.level,i.key.col)}function OW(s,e,t,i){return aA(s,e,t.level,t.row,i.level,i.row)}function aA(s,e,t,i,r,n){const a=t-r;if(a>=0)return(e>>a)+(i-(n<<a))*(s>>a);const o=-a;return e-(n-(i<<o))*(s>>o)<<o}let oA=class{constructor(e,t,i){this._rows=Math.ceil(t/i),this._columns=Math.ceil(e/i),this._cellSize=i,this.cells=new Array(this._rows);for(let r=0;r<this._rows;r++){this.cells[r]=new Array(this._columns);for(let n=0;n<this._columns;n++)this.cells[r][n]=[]}}getCell(e,t){const i=Math.min(Math.max(Math.floor(t/this._cellSize),0),this._rows-1),r=Math.min(Math.max(Math.floor(e/this._cellSize),0),this._columns-1);return this.cells[i]&&this.cells[i][r]||null}getCellSpan(e,t,i,r){return[Math.min(Math.max(Math.floor(e/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(t/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(i/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(r/this._cellSize),0),this.rows-1)]}get cellSize(){return this._cellSize}get columns(){return this._columns}get rows(){return this._rows}};function DW(s,e,t,i,r,n,a){const o=e[i++];for(let l=0;l<o;l++){const c=new MW(n,a);c.xTile=e[i++],c.yTile=e[i++],c.hash=e[i++],c.priority=e[i++],c.featureIndex=e[i++];const h=e[i++],d=c.colliders();for(let g=0;g<h;g++){const _=e[i++],v=e[i++],b=e[i++],T=e[i++],w=!!e[i++],S=e[i++],C=t[i++],P=t[i++],M=e[i++],O=e[i++];d.push({xTile:_,yTile:v,dxPixels:b,dyPixels:T,hard:w,partIndex:S,width:M,height:O,minLod:C,maxLod:P})}const m=s[i++];for(let g=0;g<m;g++)c.textVertexRanges.push([s[i++],s[i++]]);const f=s[i++];for(let g=0;g<f;g++)c.iconVertexRanges.push([s[i++],s[i++]]);r.push(c)}return i}function EW(s,e,t){for(const[i,r]of s.symbols)AW(s,e,t,r,i)}function AW(s,e,t,i,r){const n=s.layerData.get(r);if(n.type===3){for(const a of i){const o=a.uniqueSymbol;let l;if(a.selectedForRendering){const c=o.parts[0];c.startOpacity;const h=c.targetOpacity;s.allSymbolsFadingOut=s.allSymbolsFadingOut&&h===0;const d=h?255:0;l=d<<24|d<<16|d<<8|d}else l=0;for(const[c,h]of a.iconVertexRanges)for(let d=c;d<c+h;d+=4)n.iconOpacity[d/4]=l;if(a.selectedForRendering){const c=o.parts[1];c.startOpacity;const h=c.targetOpacity;s.allSymbolsFadingOut=s.allSymbolsFadingOut&&h===0;const d=h?255:0;l=d<<24|d<<16|d<<8|d}else l=0;for(const[c,h]of a.textVertexRanges)for(let d=c;d<c+h;d+=4)n.textOpacity[d/4]=l}n.lastOpacityUpdate=e,n.opacityChanged=!0}}function IW(s,e,t,i){const r=s.colliders();let n,a,o,l;for(const c of r)if(s.uniqueSymbol?.show&&s.uniqueSymbol.parts[c.partIndex].show&&(n=c.xScreen-i[0]+c.dxScreen,a=c.yScreen-i[1]+c.dyScreen,o=n+c.width,l=a+c.height,k4(t,e.x,e.y,n,a,o,l)))return!0;return!1}let LW=class{constructor(e,t,i,r,n,a){this._symbols=e,this._styleRepository=r,this._zoom=n,this._currentLayerCursor=0,this._currentSymbolCursor=0,this._styleProps=new Map,this._allNeededMatrices=new Map,this._gridIndex=new oA(t,i,V4),this._si=Math.sin(Math.PI*a/180),this._co=Math.cos(Math.PI*a/180),r.cachedStyles&&(this._styleProps=r.cachedStyles);for(const o of e)for(const l of o.symbols)this._allNeededMatrices.has(l.tile)||this._allNeededMatrices.set(l.tile,nA(l.tile.transforms.tileUnitsToPixels))}work(e){const t=performance.now();for(;this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0){const i=this._symbols[this._currentLayerCursor],r=this._getProperties(i.styleLayerUID),n=this._styleRepository.layerContexts?.get(i.styleLayerUID);for(;this._currentSymbolCursor<i.symbols.length;this._currentSymbolCursor++){if(this._currentSymbolCursor%100==99&&performance.now()-t>e)return!1;const a=i.symbols[this._currentSymbolCursor];if(!a.uniqueSymbol?.show)continue;const o=this._computeCoordinates(a,r,n),l=a.uniqueSymbol;if(!l.show)continue;const{iconAllowOverlap:c,textAllowOverlap:h}=r;for(const d of o){if(!d.enabled)continue;const m=l.parts[d.partIndex];m.show&&!(d.partIndex?h:c)&&this._doesCollide(d)&&(d.hard?l.show=!1:m.show=!1)}l.show&&this._insertColliders(l.parts,o,r)}}return!0}_insertColliders(e,t,i){const{iconIgnorePlacement:r,textIgnorePlacement:n}=i;for(const a of t){if(!a.enabled||(a.partIndex?n:r)||!e[a.partIndex].show)continue;const o=a.xScreen+a.dxScreen,l=a.yScreen+a.dyScreen,c=o+a.width,h=l+a.height,[d,m,f,g]=this._gridIndex.getCellSpan(o,l,c,h);for(let _=m;_<=g;_++)for(let v=d;v<=f;v++)this._gridIndex.cells[_][v].push(a)}}_computeCoordinates(e,t,i){const{iconRotationAlignment:r,textRotationAlignment:n,iconTranslate:a,iconTranslateAnchor:o,textTranslate:l,textTranslateAnchor:c}=t,h=this._si,d=this._co,m=this._zoom,f=this._allNeededMatrices.get(e.tile),g=e.uniqueSymbol,_=e.colliders(i);let v=0;for(const b of _){const[T,w]=b.partIndex===0?a:l,S=b.partIndex===0?o:c,C=b.minLod<=m&&m<=b.maxLod;v+=C?0:1,b.enabled=C,b.xScreen=b.xTile*f[0]+b.yTile*f[3]+f[6],b.yScreen=b.xTile*f[1]+b.yTile*f[4]+f[7],S===0?(b.xScreen+=d*T-h*w,b.yScreen+=h*T+d*w):(b.xScreen+=T,b.yScreen+=w),(b.partIndex===0?r:n)===1?(b.dxScreen=b.dxPixels,b.dyScreen=b.dyPixels):(b.dxScreen=d*(b.dxPixels+b.width/2)-h*(b.dyPixels+b.height/2)-b.width/2,b.dyScreen=h*(b.dxPixels+b.width/2)+d*(b.dyPixels+b.height/2)-b.height/2)}return _.length>0&&v===_.length&&g&&(g.show=!1),_}_getProperties(e){const t=this._styleProps.get(e);if(t)return t;const i=this._styleRepository.getLayerStyleProperties?.(e,this._zoom);return this._styleProps.set(e,i),i}_doesCollide(e){const t=e.xScreen+e.dxScreen,i=e.yScreen+e.dyScreen,r=t+e.width,n=i+e.height,[a,o,l,c]=this._gridIndex.getCellSpan(t,i,r,n);for(let h=o;h<=c;h++)for(let d=a;d<=l;d++){const m=this._gridIndex.cells[h][d];for(const f of m){if(f.labelId!=null&&e.labelId!=null&&f.labelId===e.labelId)continue;const g=f.xScreen+f.dxScreen,_=f.yScreen+f.dyScreen,v=g+f.width,b=_+f.height;if(!(r<g||t>v||n<_||i>b))return!0}}return!1}},Z_=class{constructor(e,t){this.layerUIDs=[],this.isDestroyed=!1,this._data=e;let i=1;const r=new Uint32Array(e);this.layerUIDs=[];const n=r[i++];for(let a=0;a<n;a++)this.layerUIDs[a]=r[i++];this.bufferDataOffset=i,t&&(this.layer=t.getStyleLayerByUID(this.layerUIDs[0]))}get isPreparedForRendering(){return this._data==null}get offset(){return this.bufferDataOffset}get data(){return this._data}destroy(){this.isDestroyed||(this.doDestroy(),this._data=null,this.isDestroyed=!0)}prepareForRendering(e){this._data!=null&&(this.doPrepareForRendering(e,this._data,this.bufferDataOffset),this._data=null)}},FW=class extends Z_{constructor(e,t){super(e,t),this.type=2,this.lineIndexStart=0,this.lineIndexCount=0;const i=new Uint32Array(e);let r=this.bufferDataOffset;this.lineIndexStart=i[r++],this.lineIndexCount=i[r++];const n=i[r++];if(n>0){this.patternMap=new Map;for(let a=0;a<n;a++){const o=i[r++],l=i[r++],c=i[r++];this.patternMap.set(o,[l,c])}}this.bufferDataOffset=r}get usedMemory(){return(this.data?.byteLength??0)+(this.vao?.usedMemory??0)}hasData(){return this.lineIndexCount>0}triangleCount(){return this.lineIndexCount/3}doDestroy(){this.vao=_e(this.vao)}doPrepareForRendering(e,t,i){const r=new Uint32Array(t),n=new Int32Array(r.buffer),a=r[i++],o=this.layer.lineMaterial,l=new Kt(e,o.geometryLayout,new Int32Array(n.buffer,4*i,a));i+=a;const c=r[i++],h=Nr.createIndex(e,35044,new Uint32Array(r.buffer,4*i,c));i+=c,this.vao=new Wa(e,l,h)}},VW=class extends Z_{constructor(e,t){super(e,t),this.type=1,this.fillIndexStart=0,this.fillIndexCount=0,this.outlineIndexStart=0,this.outlineIndexCount=0;const i=new Uint32Array(e);let r=this.bufferDataOffset;this.fillIndexStart=i[r++],this.fillIndexCount=i[r++],this.outlineIndexStart=i[r++],this.outlineIndexCount=i[r++];const n=i[r++];if(n>0){this.patternMap=new Map;for(let a=0;a<n;a++){const o=i[r++],l=i[r++],c=i[r++];this.patternMap.set(o,[l,c])}}this.bufferDataOffset=r}get usedMemory(){return(this.data?.byteLength??0)+(this.fillVAO?.usedMemory??0)+(this.outlineVAO?.usedMemory??0)}hasData(){return this.fillIndexCount>0||this.outlineIndexCount>0}triangleCount(){return(this.fillIndexCount+this.outlineIndexCount)/3}doDestroy(){this.fillVAO=_e(this.fillVAO),this.outlineVAO=_e(this.outlineVAO)}doPrepareForRendering(e,t,i){const r=new Uint32Array(t),n=new Int32Array(r.buffer),a=r[i++],o=this.layer,l=o.fillMaterial,c=new Kt(e,l.geometryLayout,new Int32Array(n.buffer,4*i,a));i+=a;const h=r[i++],d=Nr.createIndex(e,35044,new Uint32Array(r.buffer,4*i,h));i+=h;const m=r[i++],f=o.outlineMaterial,g=new Kt(e,f.geometryLayout,new Int32Array(n.buffer,4*i,m));i+=m;const _=r[i++],v=Nr.createIndex(e,35044,new Uint32Array(r.buffer,4*i,_));i+=_,this.fillVAO=new Wa(e,c,d),this.outlineVAO=new Wa(e,g,v)}},kW=class extends Z_{constructor(e,t,i){super(e,t),this.type=3,this.iconPerPageElementsMap=new Map,this.glyphPerPageElementsMap=new Map,this.symbolInstances=[],this.isIconSDF=!1,this.opacityChanged=!1,this.lastOpacityUpdate=0,this.symbols=[];const r=new Uint32Array(e),n=new Int32Array(e),a=new Float32Array(e);let o=this.bufferDataOffset;this.isIconSDF=!!r[o++];const l=r[o++],c=r[o++],h=r[o++],d=new e1(l,c,h,0),m=r[o++];for(let v=0;v<m;v++){const b=r[o++],T=r[o++],w=r[o++];this.iconPerPageElementsMap.set(b,[T,w])}const f=r[o++];for(let v=0;v<f;v++){const b=r[o++],T=r[o++],w=r[o++];this.glyphPerPageElementsMap.set(b,[T,w])}const g=r[o++],_=r[o++];this.iconOpacity=new Int32Array(g),this.textOpacity=new Int32Array(_),o=DW(r,n,a,o,this.symbols,i,d),this.bufferDataOffset=o}get usedMemory(){return(this.data?.byteLength??0)+(this.iconVAO?.usedMemory??0)+(this.textVAO?.usedMemory??0)+uC(this.iconOpacity)+uC(this.textOpacity)}hasData(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0}triangleCount(){let e=0;for(const t of this.iconPerPageElementsMap.values())e+=t[1];for(const t of this.glyphPerPageElementsMap.values())e+=t[1];return e/3}doDestroy(){this.iconVAO=_e(this.iconVAO),this.textVAO=_e(this.textVAO)}updateOpacityInfo(){if(!this.opacityChanged)return;this.opacityChanged=!1;const e=this.iconOpacity,t=this.iconVAO.buffer("opacity");e.length>0&&e.byteLength===t.usedMemory&&t.setSubData(e,0,0,e.length);const i=this.textOpacity,r=this.textVAO.buffer("opacity");i.length>0&&i.byteLength===r.usedMemory&&r.setSubData(i,0,0,i.length)}doPrepareForRendering(e,t,i){const r=new Uint32Array(t),n=new Int32Array(r.buffer),a=r[i++],o=this.layer,l=o.iconMaterial,c=new Kt(e,l.geometryLayout,new Int32Array(n.buffer,4*i,a));i+=a;const h=r[i++],d=Nr.createIndex(e,35044,new Uint32Array(r.buffer,4*i,h));i+=h;const m=r[i++],f=o.textMaterial,g=new Kt(e,f.geometryLayout,new Int32Array(n.buffer,4*i,m));i+=m;const _=r[i++],v=Nr.createIndex(e,35044,new Uint32Array(r.buffer,4*i,_));i+=_;const b=new Kt(e,l.opacityLayout,this.iconOpacity.buffer),T=new Kt(e,f.opacityLayout,this.textOpacity.buffer);this.iconVAO=new Wa(e,new Map([["geometry",c],["opacity",b]]),d),this.textVAO=new Wa(e,new Map([["geometry",g],["opacity",T]]),v)}},zW=class extends Z_{constructor(e,t){super(e,t),this.type=4,this.circleIndexStart=0,this.circleIndexCount=0;const i=new Uint32Array(e);let r=this.bufferDataOffset;this.circleIndexStart=i[r++],this.circleIndexCount=i[r++],this.bufferDataOffset=r}get usedMemory(){return(this.data?.byteLength??0)+(this.vao?.usedMemory??0)}hasData(){return this.circleIndexCount>0}triangleCount(){return this.circleIndexCount/3}doDestroy(){this.vao=_e(this.vao)}doPrepareForRendering(e,t,i){const r=new Uint32Array(t),n=new Int32Array(r.buffer),a=r[i++],o=this.layer.circleMaterial,l=new Kt(e,o.geometryLayout,new Int32Array(n.buffer,4*i,a));i+=a;const c=r[i++],h=Nr.createIndex(e,35044,new Uint32Array(r.buffer,4*i,c));i+=c,this.vao=new Wa(e,l,h)}},qn=class extends te{constructor(e){super(e),this.computedOpacity=1,this.computedVisible=!0,this.opacity=1,this.visible=!0,this._fadeOutResolver=null,this._fadeInResolver=null}get transitioning(){return(this._fadeOutResolver||!this.visible?0:this.opacity)!==this.computedOpacity}endTransition(){this._fadeInResolver?.(),this._fadeOutResolver?.(),this._fadeInResolver=this._fadeOutResolver=null,this.computedOpacity=this.visible?this.opacity:0}fadeIn(){return this._fadeInResolver||(this.opacity=1,this.computedOpacity=0,this._fadeOutResolver?.(),this._fadeOutResolver=null,this._fadeInResolver=sa()),this._fadeInResolver.promise}fadeOut(){return this._fadeOutResolver||(this.opacity=0,this._fadeInResolver?.(),this._fadeInResolver=null,this._fadeOutResolver=sa()),this._fadeOutResolver.promise}transitionStep(e,t){const i=Ze("mapview-transitions-duration"),r=i?1/i:0;if(r===0)this.computedOpacity=this.opacity,this.computedVisible=this.visible;else{const n=this._fadeOutResolver||!this.visible?0:this.opacity,a=this.computedOpacity;if(a===n)this.computedVisible=this.visible;else{const o=e*r;this.computedOpacity=a>n?Math.max(n,a-o):Math.min(n,a+o),this.computedVisible=this.computedOpacity>0}}this.transitioning||(this._fadeInResolver?.(),this._fadeOutResolver?.(),this._fadeOutResolver=this._fadeInResolver=null)}};u([p()],qn.prototype,"computedOpacity",void 0),u([p()],qn.prototype,"computedVisible",void 0),u([p()],qn.prototype,"opacity",void 0),u([p()],qn.prototype,"visible",void 0),u([p()],qn.prototype,"transitioning",null),u([p()],qn.prototype,"_fadeOutResolver",void 0),u([p()],qn.prototype,"_fadeInResolver",void 0),qn=u([R("esri.views.2d.engine.transitions.FadeTransition")],qn);let BW=class extends OF{constructor(){super(...arguments),this._transitionables=null,this._clips=null,this._fadeTransition=null,this._isReady=!1,this._opacity=1,this.parent=null,this._stage=null,this._visible=!0}get computedOpacity(){return this._fadeTransition?.computedOpacity??this.opacity}get clips(){return this._clips}set clips(e){this._clips=e,this.requestRender()}get fadeTransitionEnabled(){return this._fadeTransition!==null}set fadeTransitionEnabled(e){!this._fadeTransition&&e?(this._fadeTransition=new qn({opacity:this.opacity,visible:this.visible}),this.addTransitionable(this._fadeTransition)):this._fadeTransition&&!e&&(this.removeTransitionable(this._fadeTransition),this._fadeTransition=null)}get inFadeTransition(){return this._fadeTransition?.transitioning??!1}get isReady(){return this._isReady}get opacity(){return this._opacity}set opacity(e){this._opacity!==e&&(this._opacity=Math.min(1,Math.max(e,0)),this._fadeTransition&&(this._fadeTransition.opacity=this._opacity),this.requestRender())}get stage(){return this._stage}set stage(e){if(this._stage===e)return;const t=this._stage;this._stage=e,e?this._stage?.untrashDisplayObject(this)||(this.onAttach(),this.emit("attach")):t?.trashDisplayObject(this)}get transforms(){return this._transforms==null&&(this._transforms=this._createTransforms()),this._transforms}get transitioning(){return this.isTransitioning()}get usedMemory(){return 0}get visible(){return this._visible}set visible(e){this._visible!==e&&(this._visible=e,this._fadeTransition&&(this._fadeTransition.visible=this._visible),this.requestRender())}get hasLabels(){return!1}get hasHighlight(){return!1}get hasBlending(){return!1}addTransitionable(e){this._transitionables??=[],this._transitionables.push(e),this.requestRender()}removeTransitionable(e){e.endTransition(),this._transitionables&&gw(this._transitionables,e),this.requestRender()}fadeIn(){this.fadeTransitionEnabled=!0;const e=this._fadeTransition.fadeIn();return this.opacity=1,this.requestRender(),e}fadeOut(){this.fadeTransitionEnabled=!0;const e=this._fadeTransition.fadeOut();return this.opacity=0,this.requestRender(),e}endTransitions(){if(this._transitionables){for(const e of this._transitionables)e.endTransition();this.requestRender()}}beforeRender(e){this.transitionStep(e.deltaTime,e.state.scale),this.setTransform(e.state)}afterRender(e){this.transitioning&&this.requestRender()}remove(){this.parent?.removeChild(this)}setTransform(e){}processRender(e){this.stage&&(this._fadeTransition?.computedVisible??this.visible)&&this.doRender(e)}requestRender(){this.stage&&this.stage.requestRender()}processDetach(){this.endTransitions(),this.onDetach(),this.emit("detach")}isTransitioning(){return this._transitionables?.some(e=>e.transitioning)??!1}transitionStep(e,t){if(this._transitionables)for(const i of this._transitionables)i.transitionStep(e,t)}onAttach(){}onDetach(){}doRender(e){}ready(){this._isReady||(this._isReady=!0,this.emit("isReady"),this.requestRender())}},lA=class extends BW{constructor(e,t,i,r,n,a,o=n,l=a){super(),this.tileDebugInfoTexture=null,this.debugInfo={display:{length:0,minOrderedLength:0,minUnorderedLength:0,triangleCount:0},memory:{bytesUsed:0,bytesReserved:0}},this._destroyed=!1,this.key=new e1(e),this.resolution=t,this.x=i,this.y=r,this.width=n,this.height=a,this.rangeX=o,this.rangeY=l}destroy(){super.destroy(),this.tileDebugInfoTexture&&(this.tileDebugInfoTexture.dispose(),this.tileDebugInfoTexture=null),this._destroyed=!0}get debugSlot(){let e=this;for(;e.parent!==this._stage;){if(!e.parent)return 0;e=e.parent}return this._stage.children.indexOf(e)}setTransform(e){const t=this.resolution/(e.resolution*e.pixelRatio),i=this.transforms.tileMat3,[r,n]=e.toScreenNoRotation([0,0],[this.x,this.y]),a=this.width/this.rangeX*t,o=this.height/this.rangeY*t;Q$(i,a,0,0,0,o,0,r,n,1),Z$(this.transforms.displayViewScreenMat3,e.displayViewMat3,i)}get destroyed(){return this._destroyed}},NW=class cA extends lA{constructor(e,t,i,r,n,a,o,l=null){super(e,t,i,r,n,a,_p,_p),this.styleRepository=o,this._owner=l,this.type="vector-tile",this._referenced=1,this._hasSymbolBuckets=!1,this._usedMemory=256,this.layerData=new Map,this.status="loading",this.allSymbolsFadingOut=!1,this.lastOpacityUpdate=0,this.symbols=new Map,this.isCoverage=!1,this.neededForCoverage=!1,this.decluttered=!1,this.parentTile=null,this.childrenTiles=new Set,this.featureIndex=null,this.triangleCount=0,this._processed=!1,this.id=e.id}get styleLayerUIDs(){return Array.from(this.layerData.keys())}get hasSymbolBuckets(){return this._hasSymbolBuckets}get isFading(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<F0}get isHoldingForFade(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<F0)}get wasRequested(){return this.status==="errored"||this.status==="loaded"||this.status==="reloading"}setData(e){this.changeDataImpl(e),this.requestRender(),this.ready(),this._processed=!0}deleteLayerData(e){let t=!1;for(const i of e){const r=this.layerData.get(i);r&&(this._usedMemory-=r.usedMemory,r.type===3&&this.symbols.delete(i)&&(t=!0),r.destroy(),this.layerData.delete(i))}this._owner?.updateTileSize(this),t&&(this.featureIndex?.clear(),this.emit("symbols-changed")),this.requestRender()}processed(){return this._processed}hasData(){return this.layerData.size>0}hasFeatures(){const e=this.layerData.values();for(const t of e)if(t.hasData())return!0;return!1}dispose(){this.status!=="unloaded"&&(cA._destroyRenderBuckets(this.layerData),this.layerData.clear(),this.featureIndex=null,this._usedMemory=0,this.destroy(),this.status="unloaded")}release(){--this._referenced===0&&(this._owner?.onDisposeTile(this),this.dispose(),this.stage=null)}retain(){++this._referenced}get usedMemory(){return this._usedMemory}get usedMemoryPerReference(){return this._usedMemory/(this._referenced||1)}changeDataImpl(e){this.featureIndex?.clear();let t=!1;if(e){const{bucketsWithData:i,emptyBuckets:r}=e,n=this._createRenderBuckets(i);if(r&&r.byteLength>0){const a=new Uint32Array(r);for(const o of a)this._deleteLayerData(o)}for(const[a,o]of n)this._deleteLayerData(a),o.type===3&&(this.symbols.set(a,o.symbols),t=!0),this._usedMemory+=o.usedMemory,this.layerData.set(a,o);this._owner?.updateTileSize(this)}this._hasSymbolBuckets=!1;for(const i of this.layerData.values())i.type===3&&(this._hasSymbolBuckets=!0);t&&this.emit("symbols-changed")}attachWithContext(e){this.stage={context:e,trashDisplayObject(t){t.processDetach()},untrashDisplayObject:()=>!1}}setTransform(e){super.setTransform(e);const t=this.resolution/(e.resolution*e.pixelRatio),i=this.width/this.rangeX*t,r=this.height/this.rangeY*t,n=[0,0];e.toScreen(n,[this.x,this.y]);const a=this.transforms.tileUnitsToPixels;Nw(a),up(a,a,n),Uw(a,a,Math.PI*e.rotation/180),Hw(a,a,[i,r,1])}_createTransforms(){return{displayViewScreenMat3:Yl(),tileMat3:Yl(),tileUnitsToPixels:Yl()}}static _destroyRenderBuckets(e){if(!e)return;const t=new Set;for(const i of e.values())t.has(i)||(i.destroy(),t.add(i));e.clear()}_createRenderBuckets(e){const t=new Map,i=new Map;for(const r of e){const n=this._deserializeBucket(r,i);for(const a of n.layerUIDs)t.set(a,n)}return t}_deserializeBucket(e,t){let i=t.get(e);if(i)return i;switch(new Uint32Array(e)[0]){case 1:i=new VW(e,this.styleRepository);break;case 2:i=new FW(e,this.styleRepository);break;case 3:i=new kW(e,this.styleRepository,this);break;case 4:i=new zW(e,this.styleRepository)}return t.set(e,i),i}_deleteLayerData(e){if(!this.layerData.has(e))return;const t=this.layerData.get(e);this._usedMemory-=t.usedMemory,t.destroy(),this.layerData.delete(e)}};function lf(s){return(s.uniqueSymbol?.show&&s.uniqueSymbol?.lastShow)??!1}function UW(s,e){if(s.priority-e.priority)return s.priority-e.priority;if(lf(s)&&!lf(e))return-1;if(lf(e)&&!lf(s))return 1;const t=s.tile.key,i=e.tile.key;return t.world-i.world?t.world-i.world:t.level-i.level?t.level-i.level:t.row-i.row?t.row-i.row:t.col-i.col?t.col-i.col:s.xTile-e.xTile?s.xTile-e.xTile:s.yTile-e.yTile}let HW=class{get running(){return this._running}constructor(e,t,i,r,n,a,o,l){this.selectionMode=e,this._visibleTiles=t,this._symbolRepository=i,this._styleRepository=r,this._createCollisionJob=n,this._assignTileSymbolsOpacity=a,this._symbolLayerSorter=o,this._isLayerVisible=l,this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}setScreenSize(e,t){this._screenWidth===e&&this._screenHeight===t||this.restart(),this._screenWidth=e,this._screenHeight=t}restart(){this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}continue(e){if(this._selectionJob||(this._selectionJob=this._createSelectionJob()),!this._selectionJobCompleted){const t=performance.now();if(!this._selectionJob.work(e)||(this._selectionJobCompleted=!0,(e=Math.max(0,e-(performance.now()-t)))===0))return!1}if(this._collisionJob||(this._collisionJob=this._createCollisionJob(this._selectionJob.sortedSymbols,this._screenWidth,this._screenHeight)),!this._collisionJobCompleted){const t=performance.now();if(!this._collisionJob.work(e)||(this._collisionJobCompleted=!0,(e=Math.max(0,e-(performance.now()-t)))===0))return!1}if(this._opacityJob||(this._opacityJob=this._createOpacityJob()),!this._opacityJobCompleted){const t=performance.now();if(!this._opacityJob.work(e)||(this._opacityJobCompleted=!0,(e=Math.max(0,e-(performance.now()-t)))===0))return!1}return this._running=!1,!0}_isFeatureFiltered(e,t,i){const r=t.getFilterFlags(e),n=r&B4,a=i.featureEffect==null||i.featureEffect.excludedLabelsVisible||r&z4;return!(n&&a)}_getFilteredByLayer(){let e;if(this._styleRepository?.layerContexts)for(const t of this._symbolRepository.uniqueSymbols){const i=this._styleRepository.layerContexts?.get(t.styleLayerUID);if(i?.attributeView)for(const r of t.uniqueSymbols){e??=new Map,e.get(t.styleLayerUID)||e.set(t.styleLayerUID,new Set);const n=e.get(t.styleLayerUID),a=i.attributeView,o=i.layerView;this._isFeatureFiltered(r.id,a,o)&&n.add(r.id)}}return e}_resetSelection(){for(let e=0;e<this._symbolRepository.uniqueSymbols.length;e++){const t=this._symbolRepository.uniqueSymbols[e];for(let i=0;i<t.uniqueSymbols.length;i++){const r=t.uniqueSymbols[i];for(const n of r.tileSymbols)n.selectedForRendering=!1}}}_createSelectionJob(){const e=this.selectionMode==="feature-tile"?GW:jW,t=this._symbolRepository.uniqueSymbols;this._resetSelection();const i=[];let r=0,n=0;const a=this._isLayerVisible,o=this._getFilteredByLayer(),l=this._styleRepository?.layerContexts;function c(d){let m;const f=performance.now();for(;n<t.length;n++,r=0){const g=t[n],_=g.styleLayerUID,v=o?.get(_);let b=0;if(l){const w=l.get(_).layerView;b=w.view.allLayerViews.items.indexOf(w)}if(!a(_)){i[n]||(i[n]={styleLayerUID:_,layerOrder:b,symbols:[]});continue}i[n]||={styleLayerUID:_,symbols:[],layerOrder:b};const T=i[n];for(;r<g.uniqueSymbols.length;r++){if(m=g.uniqueSymbols[r],r%100==99&&performance.now()-f>d)return!1;if(m.lastShow=m.show,m.id&&v?.has(m.id)){m.show=!1,m.parts[0].show=!1,m.parts[1].show=!1;continue}const w=e(m);if(w){w.selectedForRendering=!0,T.symbols.push(w),m.show=!0;for(const S of m.parts)S.show=!0}else m.show=!1}}for(const g of i)g.symbols.sort(UW);return i.sort((g,_)=>_.layerOrder-g.layerOrder),!0}const h=this._symbolLayerSorter;return{work:c,get sortedSymbols(){return i.sort(h)}}}_createOpacityJob(){const e=this._assignTileSymbolsOpacity,t=this._visibleTiles;let i=0;function r(n,a){for(const o of n.symbols.values())qW(o,a);e(n,a);for(const o of n.childrenTiles)r(o,a)}return{work(n){const a=performance.now();for(;i<t.length;i++){if(performance.now()-a>n)return!1;const o=t[i];if(o.parentTile!=null)continue;const l=performance.now();o instanceof NW?r(o,l):e(o,l)}return!0}}}};function qW(s,e){for(const t of s){const i=t.uniqueSymbol;for(const r of i.parts){const n=r.targetOpacity>.5?1:-1;r.startOpacity+=n*((e-r.startTime)/F0),r.startOpacity=Math.min(Math.max(r.startOpacity,0),1),r.startTime=e,r.targetOpacity=i.show&&r.show?1:0}}}function GW(s){let e=null,t=null,i=null;for(const r of s.tileSymbols){const n=r.tile;n.isReady&&n.isCoverage?e=r:n.isReady?t=r:n.rendering&&(i=r)}return e??t??i}function jW(s){let e=null,t=!1,i=!1;for(const r of s.tileSymbols)if(!i||!t){const n=r.tile;(!e||n.isCoverage||n.neededForCoverage&&!t)&&(e=r,(n.neededForCoverage||n.isCoverage)&&(i=!0),n.isCoverage&&(t=!0))}return i?e:null}let WW=class jb{static fromSymbols(e,t){let i=e.length;if(i>=QW){let r=t;do r/=2,i/=4;while(i>ZW&&r>XW);const n=new oA(t,t,r);for(const a of e)n.getCell(a.xTile,a.yTile).push(a);return new jb(t,e,n)}return new jb(t,e,null)}constructor(e,t,i){this.tileCoordRange=e,this._symbols=t,this._index=i}addSymbols(e){for(const t of e)this._symbols.push(t);if(this._index)for(const t of e)this._index.getCell(t.xTile,t.yTile).push(t)}removeSymbols(e){const t=new Set(e);if(this._symbols=this._symbols.filter(i=>!t.has(i)),this._index)for(const i of this._index.cells)for(let r=0;r<i.length;r++)i[r]=i[r].filter(n=>!t.has(n))}getSymbols(){return this._symbols}getCandidate(e,t,i,r){if(!this._index){for(const h of this._symbols)if(i===h.hash&&Math.abs(e-h.xTile)<=r&&Math.abs(t-h.yTile)<=r)return h;return null}const n=this._index.getCellSpan(e-r,t-r,e+r,t+r),[a,o,l,c]=n;for(let h=o;h<=c;h++)for(let d=a;d<=l;d++){const m=this._index.cells[h][d];for(const f of m)if(i===f.hash&&Math.abs(e-f.xTile)<=r&&Math.abs(t-f.yTile)<=r)return f}return null}};const QW=32,ZW=8,XW=64,U2=20;let YW=class{constructor(e,t){this.tileCoordRange=e,this._visibleTiles=t,this._indexMapByTile=new Map,this._uniqueSymbolsByStyleLayerId=new Map}get uniqueSymbols(){return this._uniqueSymbolLayerArray==null&&(this._uniqueSymbolLayerArray=this._createUniqueSymbolLayerArray()),this._uniqueSymbolLayerArray}registerVectorTile(e,t){const i=this._ensureIndexMap(e),r=t?.values()??i.keys();for(const n of r){const a=i.get(n);a&&(this._removeSymbols(n,a.getSymbols()),i.delete(n))}this._addSymbols(e.key,i,e.symbols),this._invalidate()}unregisterVectorTile(e){this._removeTile(e),this._invalidate()}registerFeatureTile(e){this._ensureIndexMap(e),this._invalidate()}unregisterFeatureTile(e){this._removeTile(e),this._invalidate()}insertFeatureTileMetrics(e,t){const i=this._indexMapByTile.get(e);if(!i)throw new Error(`tile ${e.id} not registered!`);this._addSymbols(e.key,i,H2(t)),this._invalidate()}removeFeatureTileMetrics(e,t){const i=this._indexMapByTile.get(e);if(!i)return;const r=H2(t);for(const[n,a]of i.entries()){const o=r.get(n);o&&(a.removeSymbols(o),this._removeSymbols(n,o))}this._invalidate()}deleteStyleLayers(e){for(const t of this._indexMapByTile.values())for(const i of e){const r=t.get(i);r&&(this._removeSymbols(i,r.getSymbols()),t.delete(i))}this._invalidate()}querySymbols(e,t,i,r){const n=[];for(const[a,o]of this._uniqueSymbolsByStyleLayerId.entries())for(const l of o){const c=l.tileSymbols.find(h=>h.selectedForRendering);c&&IW(c,e,t*(window.devicePixelRatio||1),i)&&n.push({vtlSymbol:c,styleLayerUID:a,tileKey:c.tile.key})}return n}_ensureIndexMap(e){let t=this._indexMapByTile.get(e);return t||(t=new Map,this._indexMapByTile.set(e,t)),t}_invalidate(){this._uniqueSymbolLayerArray=null}_addSymbols(e,t,i){for(const[r,n]of i){let a=t.get(r);a?a.addSymbols(n):(a=WW.fromSymbols(n,this.tileCoordRange),t.set(r,a))}this._updateUniqueSymbols(e,i)}_removeTile(e){const t=this._indexMapByTile.get(e);if(t){for(const[i,r]of t.entries())this._removeSymbols(i,r.getSymbols());this._indexMapByTile.delete(e),this._invalidate()}}_removeSymbols(e,t){for(const i of t){const r=i.uniqueSymbol;if(r){if(r.tileSymbols=r.tileSymbols.filter(n=>n!==i),r.tileSymbols.length===0){const n=this._uniqueSymbolsByStyleLayerId.get(e);n.delete(r),n.size===0&&this._uniqueSymbolsByStyleLayerId.delete(e)}i.uniqueSymbol=null}}}_updateUniqueSymbols(e,t){if(t.size!==0){for(const i of this._visibleTiles)i.parentTile||i.key.world!==e.world||i.key.level===e.level&&!i.key.equals(e)||this._matchSymbols(i,e,t);for(const[i,r]of t)for(const n of r)if(!n.uniqueSymbol){n.uniqueSymbol=new $W(n);let a=this._uniqueSymbolsByStyleLayerId.get(i);a||(a=new Set,this._uniqueSymbolsByStyleLayerId.set(i,a)),a.add(n.uniqueSymbol)}}}_matchSymbols(e,t,i){if(e.key.level>t.level){const n=e.key.level-t.level;if(e.key.row>>n!==t.row||e.key.col>>n!==t.col)return}if(t.level>e.key.level){const n=t.level-e.key.level;if(t.row>>n!==e.key.row||t.col>>n!==e.key.col)return}const r=new Map;for(const[n,a]of i){const o=[],l=e.key.level<t.level?1:1<<Math.abs(e.key.level-t.level),c=this._indexMapByTile.get(e),h=c?.get(n);if(h)for(const d of a){if(d.uniqueSymbol)continue;const m=RW(this.tileCoordRange,d.xTile,t,e.key),f=OW(this.tileCoordRange,d.yTile,t,e.key),g=-U2,_=this.tileCoordRange+U2;if(!(m>=g&&m<_&&f>=g&&f<_)){o.push(d);continue}const v=h.getCandidate(m,f,d.hash,l),b=v?.uniqueSymbol;b?(d.uniqueSymbol=b,b.tileSymbols.push(d)):o.push(d)}o.length>0&&r.set(n,o)}for(const n of e.childrenTiles||[])this._matchSymbols(n,t,r)}_createUniqueSymbolLayerArray(){const e=this._uniqueSymbolsByStyleLayerId,t=new Array(e.size);let i,r=0;for(const[n,a]of e){const o=new Array(a.size);i=0;for(const l of a)o[i++]=l;t[r]={styleLayerUID:n,uniqueSymbols:o},r++}return t}};function H2(s){const e=new Map;for(const t of s){const i=t.labelClassId;let r=e.get(i);r||(r=[],e.set(i,r)),r.push(t)}return e}function KW(s,e){const t=s.transforms.tileUnitsToPixels,i=X$(e),r=Math.cos(i),n=Math.sin(i),a=Math.ceil(512*(Math.abs(n)+Math.abs(r)));Nw(Ln),up(Ln,Ln,[a/2,a/2]),Uw(Ln,Ln,i),up(Ln,Ln,[-256,-256]),Hw(Ln,Ln,[1/8,1/8,1]),s.transforms.tileUnitsToPixels=Ln;const o=[],l=new YW(_p,o),c=new HW("vector-tile",o,l,null,(h,d,m)=>new LW(h,d,m,s.styleRepository,s.key.level,e),(h,d)=>{EW(h,d,!1)},()=>0,h=>{const d=s.styleRepository.getStyleLayerByUID(h).getLayoutProperty("visibility");return!d||d.getValue()!==1});o.push(s),l.registerVectorTile(s),c.setScreenSize(a,a),c.continue(1/0),l.unregisterVectorTile(s),s.transforms.tileUnitsToPixels=t}const Ln=Yl();let JW=class extends lA{_createTransforms(){return{displayViewScreenMat3:Yl(),tileMat3:Yl()}}},e9=class{constructor(){this._candidateTiles=[]}schedule(e){this._candidateTiles.includes(e)||this._candidateTiles.push(e)}reshuffle(e){const t=[];for(const i of this._candidateTiles)e>0?(i.reshuffle(),e--):t.push(i);this._candidateTiles=t}},t9=class{constructor(){this._renderParams={reshuffleManager:new e9,context:null,drawPhase:1,state:new i9,stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,requestRender:null,allowDelayedRender:!1,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1,highlightGradient:null,stencilSymbols:!0,is3D:!0,backgroundColor:null,animationsEnabled:!0},this._backgroundTile=new JW(new e1(0,0,0,0),0,0,0,pC,pC,_p,_p),this._heading=0,this._declutteredForHeading=new WeakMap}dispose(){this._renderParams=null}renderBackground(e,t,i,r,n,a,o,l,c,h){const d=this._backgroundTile;this._updateRenderParameters(e,t,d,i,n,a,o,l,c,h),this._renderParams.stencilSymbols=!1,i.drawBackground(this._renderParams,d,r)}renderContent(e,t,i,r,n,a,o,l,c,h,d,m){this._declutter(i),r.forAll(({sourceLayerInfo:{data:_}})=>this._declutter(_));const f=r.length>0;f&&this._stencilSymbols(e,t,i,r,n,a,o,l,c,h,d,m);let g=1;i.stencilRef=f?g:0,e.setStencilFunction(514,i.stencilRef,255),this._render(e,t,i,n,a,o,l,c,h,d,m),r.forAll(({sourceLod:_,offset:v,sourceLayerInfo:{data:b}})=>{b.stencilRef=++g,this._renderSymbols(e,_,b,n,a,o,l,v,h,d,m)})}_stencilSymbols(e,t,i,r,n,a,o,l,c,h,d,m){let f=1;i.stencilRef=f,e.setDepthTestEnabled(!1),e.setDepthWriteEnabled(!1),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!1),e.setStencilOp(7680,7680,7681),e.setStencilWriteMask(255),e.setStencilFunction(519,i.stencilRef,255),this._stencilTileSymbols(e,t,i,n,a,o,l,c,h,d,m),r.forAll(({sourceLod:g,offset:_,sourceLayerInfo:{data:v}})=>{v.stencilRef=++f,e.setStencilFunction(519,v.stencilRef,255),this._stencilTileSymbols(e,g,v,n,a,o,l,_,h,d,m)}),e.setStencilWriteMask(0),e.setBlendingEnabled(!0),e.setDepthTestEnabled(!0),e.setColorMask(!0,!0,!0,!0)}_renderSymbols(e,t,i,r,n,a,o,l,c,h,d){e.setStencilFunction(514,i.stencilRef,255),this._render(e,t,i,r,n,a,o,l,c,h,d,3)}_render(e,t,i,r,n,a,o,l,c,h,d,m){this._updateRenderParameters(e,t,i,r,a,o,l,c,h,d),this._renderParams.stencilSymbols=!1,r.drawTile(this._renderParams,i,n,m)}_stencilTileSymbols(e,t,i,r,n,a,o,l,c,h,d){this._updateRenderParameters(e,t,i,r,a,o,l,c,h,d),this._renderParams.stencilSymbols=!0,i.triangleCount=0,r.drawSymbols(this._renderParams,i,n)}_updateRenderParameters(e,t,i,r,n,a,o,l,c,h){"type"in i&&i.type==="vector-tile"&&!i.stage&&i.attachWithContext(e);const d=t[0]-n.getLevelShift(t[0]),m=this._renderParams;m.context=e,m.painter=r,m.glyphMosaic=r.glyphMosaic,m.spriteMosaic=r.spriteMosaic,m.pixelRatio=c*h,m.displayLevel=d,m.requiredLevel=d;const f=n.getScale(t[0]),[g,_]=n.getOffset(t,a*f),v=TV*a*f/l,b=i.transforms.displayViewScreenMat3;b[0]=v,b[4]=-v,b[6]=-1-g-o[0]*a*2,b[7]=1+_+(1-o[1])*a*2-2;const T=m.state,w=l/h;T.size[0]=w,T.size[1]=w,T.pixelRatio=h,T.rotation=(360-this._heading)%360;const S=2/w;Q$(T.displayViewMat3,S,0,0,0,-S,0,-1,1,1);const C=Nw(T.displayMat3),P=X$(this._heading);up(C,C,[w/2,w/2]),Uw(C,C,P),up(C,C,[-w/2,-w/2]),Z$(C,T.displayViewMat3,C)}updateHeading(e){this._heading=e}_declutter(e){this._declutteredForHeading.get(e)!==this._heading&&(KW(e,(360-this._heading)%360),this._declutteredForHeading.set(e,this._heading))}},i9=class{constructor(){this.size=[0,0],this.pixelRatio=1,this.rotation=0,this.displayMat3=Pn(),this.displayViewMat3=Pn(),this.transform=null,this.inverseTransform=null,this.viewMat2d=null,this.viewMat3=null,this.id=0,this.extent=null,this.center=null,this.scale=1,this.resolution=0,this.worldScreenWidth=0,this.spatialReference=null,this.viewpoint=null,this.getScreenTransform=null,this.toMap=null,this.toScreen=null,this.clone=null,this.copy=null,this.toJSON=null}},hA=class extends ls{constructor(){super(...arguments),this.blendMode=0}};u([V({count:31})],hA.prototype,"blendMode",void 0);let rp=class extends hA{constructor(){super(...arguments),this.output=1,this.baseOpacityMode=0,this.premultipliedSource=0}};u([V({count:5})],rp.prototype,"output",void 0),u([V({count:2})],rp.prototype,"baseOpacityMode",void 0),u([V({count:2})],rp.prototype,"premultipliedSource",void 0);let uA=class extends rp{constructor(){super(...arguments),this.background=0}};u([V({count:2})],uA.prototype,"background",void 0);function s9(s){s.fragment.uniforms.add(new Be("u_colormap",e=>e.u_colormap),new ge("u_colormapOffset",e=>e.colormap.u_colormapOffset),new ge("u_colormapMaxIndex",e=>e.colormap.u_colormapMaxIndex),new ge("u_opacity",e=>e.common.u_opacity)),s.fragment.code.add(y`vec4 colormap(vec4 currentPixel, bool isFloat) {
float colorIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;
vec4 result;
if (currentPixel.a == 0.0 || colorIndex > u_colormapMaxIndex) {
result = vec4(0.0, 0.0, 0.0, 0.0);
} else {
vec2 texelCoordinates = vec2((colorIndex + 0.5), 0.5);
result = texelFetch(u_colormap, ivec2(texelCoordinates), 0);
}
return result;
}`)}function r9(s){s.fragment.uniforms.add(new Be("u_transformGrid",e=>e.u_transformGrid),new Br("u_transformSpacing",e=>e.common.u_transformSpacing),new Br("u_targetImageSize",e=>e.common.u_targetImageSize)),s.fragment.code.add(y`vec2 projectPixelLocation(vec2 coords) {
vec2 index_image = floor(coords * u_targetImageSize);
vec2 oneTransformPixel = vec2(4.0, 1.0);
vec2 index_transform = floor(index_image / u_transformSpacing) * oneTransformPixel;
vec2 pos = fract((index_image + 0.5) / u_transformSpacing);
vec2 transform_location = index_transform + 0.5;
vec2 srcLocation;
if (pos.s <= pos.t) {
vec3 ll_abc = texelFetch(u_transformGrid, ivec2(transform_location), 0).rgb;
vec3 ll_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 1.0, transform_location.t), 0).rgb;
srcLocation.s = dot(ll_abc, vec3(pos, 1.0));
srcLocation.t = dot(ll_def, vec3(pos, 1.0));
} else {
vec3 ur_abc = texelFetch(u_transformGrid, ivec2(transform_location.s + 2.0, transform_location.t), 0).rgb;
vec3 ur_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 3.0, transform_location.t), 0).rgb;
srcLocation.s = dot(ur_abc, vec3(pos, 1.0));
srcLocation.t = dot(ur_def, vec3(pos, 1.0));
}
return srcLocation;
}`)}let n9=class extends tA{constructor(e,t,i){super(),this.common=e,this.u_image=t,this.u_transformGrid=i}};function a9(s,e){s.include(r9),s.fragment.uniforms.add(new Be("u_image",i=>i.u_image),new nu("u_flipY",i=>i.common.u_flipY),new nu("u_applyTransform",i=>i.common.u_applyTransform));const{requireBilinearWithNN:t}=e;t&&s.fragment.uniforms.add(new Br("u_srcImageSize",i=>i.common.u_srcImageSize)),s.fragment.code.add(y`vec2 getPixelLocation(vec2 coords) {
vec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;
if (!u_applyTransform) {
return targetLocation;
}
return projectPixelLocation(targetLocation);
}
bool isOutside(vec2 coords){
if (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {
return true;
} else {
return false;
}
}`),t?s.fragment.code.add(y`vec4 sampleBilinear(sampler2D sampler, vec2 coords, vec2 texSize) {
vec2 texelStart = floor(coords * texSize);
vec2 coord0 = texelStart / texSize;
vec2 coord1 = (texelStart +  vec2(1.0, 0.0)) / texSize;
vec2 coord2 = (texelStart +  vec2(0.0, 1.0)) / texSize;
vec2 coord3 = (texelStart +  vec2(1.0, 1.0)) / texSize;
vec4 color0 = texture(sampler, coord0);
vec4 color1 = texture(sampler, coord1);
vec4 color2 = texture(sampler, coord2);
vec4 color3 = texture(sampler, coord3);
vec2 blend = fract(coords * texSize);
vec4 color01 = mix(color0, color1, blend.x);
vec4 color23 = mix(color2, color3, blend.x);
vec4 color = mix(color01, color23, blend.y);
float alpha = floor(color0.a * color1.a * color2.a * color3.a + 0.5);
color = color * alpha + (1.0 - alpha) * texture(sampler, coords);
return color;
}
vec4 getPixel(vec2 pixelLocation) {
return sampleBilinear(u_image, pixelLocation, u_srcImageSize);
}`):s.fragment.code.add(y`vec4 getPixel(vec2 pixelLocation) {
return texture(u_image, pixelLocation);
}`)}let X_=class extends n9{constructor(e,t,i,r,n,a){super(e,r,n),this.colormap=t,this.symbolizer=i,this.u_colormap=a,this.backgroundColor=ea,this.fboTexture=null,this.baseOpacity=1}},dA=class extends X_{},pA=class extends X_{};function mA(s){const e=new lt;return e.include(iA),e.include(a9,s),e.include(s9,s),e.include(sA,s),e.fragment.code.add(y`vec4 applyBackgroundBlend(vec4 layerColor) {
return blendLayers(vuv, layerColor, u_opacity);
}`),s.colorizerType===0?l9(e,s):s.colorizerType===1?o9(e):s.colorizerType===2&&c9(e,s),e}function o9(s){s.fragment.main.add(y`vec2 pixelLocation = getPixelLocation(uv);
if (isOutside(pixelLocation)) {
fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
return;
}
vec4 currentPixel = getPixel(pixelLocation);
fragColor = applyBackgroundBlend(colormap(currentPixel, true));`)}function l9(s,e){s.fragment.uniforms.add(new oc("u_bandCount",i=>i.symbolizer.u_bandCount),new cr("u_minCutOff",i=>i.symbolizer.u_minCutOff,3),new cr("u_maxCutOff",i=>i.symbolizer.u_maxCutOff,3),new cr("u_factor",i=>i.symbolizer.u_factor,3),new ge("u_minOutput",i=>i.symbolizer.u_minOutput),new ge("u_maxOutput",i=>i.symbolizer.u_maxOutput),new nu("u_useGamma",i=>i.symbolizer.u_useGamma),new cr("u_gamma",i=>i.symbolizer.u_gamma,3),new cr("u_gammaCorrection",i=>i.symbolizer.u_gammaCorrection,3),new ge("u_opacity",i=>i.common.u_opacity)),s.fragment.code.add(y`float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {
if (val >= maxCutOff) {
return maxOutput;
} else if (val <= minCutOff) {
return minOutput;
}
float stretchedVal;
if (useGamma) {
float tempf = 1.0;
float outRange = maxOutput - minOutput;
float relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);
if (gamma > 1.0) {
tempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);
}
stretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;
} else {
stretchedVal = minOutput + (val - minCutOff) * factor;
}
return stretchedVal;
}`);const t=e.applyColormap?y`fragColor = applyBackgroundBlend(colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma));`:y`fragColor = applyBackgroundBlend(vec4(grayVal, grayVal, grayVal, currentPixel.a));`;s.fragment.main.add(y`
    vec2 pixelLocation = getPixelLocation(uv);
    if (isOutside(pixelLocation)) {
      fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
      return;
    }

    vec4 currentPixel = getPixel(pixelLocation);
    ${e.stretchType===0?y`fragColor = applyBackgroundBlend(currentPixel);`:y`
    if (currentPixel.a == 0.0) {
      fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
      return;
    }
    if (u_bandCount == 1) {
      float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
      ${t}
    } else {
      float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
      float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);
      float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);
      fragColor = applyBackgroundBlend(vec4(redVal, greenVal, blueVal, currentPixel.a));
    }`}`)}function c9(s,e){const t=s.fragment;t.uniforms.add(new Be("u_image",r=>r.u_image),new oc("u_hillshadeType",r=>r.symbolizer.u_hillshadeType),new cr("u_sinZcosAs",r=>r.symbolizer.u_sinZcosAs,6),new cr("u_sinZsinAs",r=>r.symbolizer.u_sinZsinAs,6),new cr("u_cosZs",r=>r.symbolizer.u_cosZs,6),new cr("u_weights",r=>r.symbolizer.u_weights,6),new Br("u_factor",r=>r.symbolizer.u_factor),new ge("u_minValue",r=>r.symbolizer.u_minValue),new ge("u_maxValue",r=>r.symbolizer.u_maxValue),new Br("u_srcImageSize",r=>r.common.u_srcImageSize)),t.include(Sw),t.code.add(y`vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {
val = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);
vec4 color = colormap(vec4(val, val, val, 1.0), false);
vec3 hsv = rgb2hsv(color.rgb);
hsv.z = hillshade;
return vec4(hsv2rgb(hsv), 1.0) * alpha * color.a;
}`),t.code.add(y`float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){
if (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {
return 0.0;
}  else {
return e;
}
}`);const i=e.applyColormap?y`fragColor = applyBackgroundBlend(overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha));`:y`hillshade *= alpha;
fragColor = applyBackgroundBlend(vec4(hillshade, hillshade, hillshade, alpha));`;t.main.add(y`
      vec2 pixelLocation = getPixelLocation(uv);
      if (isOutside(pixelLocation)) {
        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      vec4 currentPixel = getPixel(pixelLocation);
      if (currentPixel.a == 0.0) {
        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      //mirror edge pixels
      vec2 axy = vec2(-1.0, -1.0);
      vec2 bxy = vec2(0.0, -1.0);
      vec2 cxy = vec2(1.0, -1.0);
      vec2 dxy = vec2(-1.0, 0.0);
      vec2 fxy = vec2(1.0, 0.0);
      vec2 gxy = vec2(-1.0, 1.0);
      vec2 hxy = vec2(0.0, 1.0);
      vec2 ixy = vec2(1.0, 1.0);
      vec2 onePixel = 1.0 / u_srcImageSize;
      if (pixelLocation.s < onePixel.s) {
        axy[0] = 1.0;
        dxy[0] = 1.0;
        gxy[0] = 1.0;
      }
      if (pixelLocation.t < onePixel.t) {
        axy[1] = 1.0;
        bxy[1] = 1.0;
        cxy[1] = 1.0;
      }
      if (pixelLocation.s > 1.0 - onePixel.s) {
        cxy[0] = -1.0;
        fxy[0] = -1.0;
        ixy[0] = -1.0;
      }
      if (pixelLocation.t > 1.0 - onePixel.t) {
        gxy[1] = -1.0;
        hxy[1] = -1.0;
        ixy[1] = -1.0;
      }

      // calculate hillshade
      vec4 va = texture(u_image, pixelLocation + onePixel * axy);
      vec4 vb = texture(u_image, pixelLocation + onePixel * bxy);
      vec4 vc = texture(u_image, pixelLocation + onePixel * cxy);
      vec4 vd = texture(u_image, pixelLocation + onePixel * dxy);
      vec4 ve = texture(u_image, pixelLocation);
      vec4 vf = texture(u_image, pixelLocation + onePixel * fxy);
      vec4 vg = texture(u_image, pixelLocation + onePixel * gxy);
      vec4 vh = texture(u_image, pixelLocation + onePixel * hxy);
      vec4 vi = texture(u_image, pixelLocation + onePixel * ixy);

      // calculate the rate of z change along the x, y, and diagonal direction
      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;
      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;
      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);
      float hillshade = 0.0;

      // traditional single light source
      if (u_hillshadeType == 0){
        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;
        float z = (u_cosZs[0] + cosDelta) / dzd;
        if (z < 0.0)  z = 0.0;
        hillshade = z;
      } else {
        // multi-directional with 6 light sources
        for (int k = 0; k < 6; k++) {
        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;
        float z = (u_cosZs[k] + cosDelta) / dzd;
        if (z < 0.0) z = 0.0;
        hillshade = hillshade + z * u_weights[k];
        if (k == 5) break;
        }
      }

      // set color
      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);
      alpha *= u_opacity;
      ${i}`)}const h9=Object.freeze(Object.defineProperty({__proto__:null,ColorizerHillshadeUniforms:pA,ColorizerStretchUniforms:dA,ColorizerUniforms:X_,build:mA},Symbol.toStringTag,{value:"Module"}));let q2=class extends ct{constructor(e,t){super(e,t,new ht(h9,()=>k(()=>Promise.resolve().then(()=>see),void 0)),Ya(Fp))}},Md=class extends rp{constructor(){super(...arguments),this.colorizerType=0,this.stretchType=0,this.applyColormap=!0,this.requireBilinearWithNN=!1}};u([V({count:3})],Md.prototype,"colorizerType",void 0),u([V({count:2})],Md.prototype,"stretchType",void 0),u([V()],Md.prototype,"applyColormap",void 0),u([V()],Md.prototype,"requireBilinearWithNN",void 0);let G2=class{constructor(e){this._rctx=e,this._fbos=new Map}get(e){return this._getPool(e)}dispose(){this._fbos.forEach(e=>e.dispose()),this._fbos.clear()}_getPool(e){const t=this._fbos.get(e);if(t)return t;const i=new jo(this._rctx,new ft(e),new Qz(tu.DEPTH24_STENCIL8,e));return this._fbos.set(e,i),i}};function Wo(s,e=0,t=-1,i=1){const r=e===1,n=r?_y?new Float32Array([t,t,0,i,t,0,t,i,0,i,i,0]):new Float32Array([t,t,0,0,i,t,1,0,t,i,0,1,i,i,1,1]):new Float32Array([t,t,i,t,t,i,i,i]);if(r&&_y){const a=_R(n.buffer);a[10]=a[17]=a[22]=a[23]=1}return new Mn(s,new Kt(s,r?_y?Fp:cL:n$,n))}const u9=4;function fA(s){const e=new ft(u9);return e.samplingMode=9728,new bt(s,e)}const d9=()=>j.getLogger("esri.views.3d.terrain");let p9=class{constructor(e,t){this._rctx=e,this._techniques=t,this._fbos=[],this._vectorTileHelper=new t9,this._bindParameters=new H1(null),this._blendConfiguration=new uA,this._current=0,this._lastUsedIds=new Array,this._lastCreatedBufferId=0,this._onHoldIds=new Array,this._vao=Wo(this._rctx,1)}dispose(){this._fbos.forEach(_e),this._fbos=null,this._vtFBO=_e(this._vtFBO),this._vao=_e(this._vao),this._vectorTileHelper=_e(this._vectorTileHelper)}updateHeading(e){this._vectorTileHelper?.updateHeading(e)}_acquireBlendTechnique(e,t,i,r=0,n=0){return this._blendConfiguration.output=t,this._blendConfiguration.blendMode=e,this._blendConfiguration.baseOpacityMode=i,this._blendConfiguration.premultipliedSource=r,this._blendConfiguration.background=n,this._techniques.precompile(N2,this._blendConfiguration),this._techniques.get(N2,this._blendConfiguration)}drawBackground(e,t){const i=this._acquireBlendTechnique(0,t?2:3,0,0,1),r=this._rctx.bindTechnique(i,this._bindParameters,e);this._render(r)}_render(e){this._rctx.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),this._rctx.drawArrays(Ct.TRIANGLE_STRIP,0,this._vao.vertexCount("geometry"))}drawGroup(e,t,i,r,n=1){t===1&&(e.fboTexture=this._fbos[this.getLastOnHoldId()].get(i).colorTexture,e.fboTexture==null&&(e.fboTexture=this._rctx.emptyTexture)),e.texture=this.currentFBO(i).colorTexture,this.closeGroup(i);const a=e.baseOpacity<1?1:0,o=this._acquireBlendTechnique(r,t,a,n),l=this._rctx.bindTechnique(o,this._bindParameters,e);this._render(l)}drawImageData(e,t,i,r,n=0){if(e.texture==null)return;const a=e.baseOpacity<1?1:0;e.fboTexture=t===4||r===0&&a===0&&n===0?null:this.switch(i).colorTexture,e.fboTexture==null&&(e.fboTexture=this._rctx.emptyTexture);const o=this._acquireBlendTechnique(r,t,a,n),l=this._rctx.bindTechnique(o,this._bindParameters,e);this._render(l)}drawRasterData(e,t,i,r,n){const a=n.sourceLayerInfo.data;if(!a.source||(n.tile.surface.layerViewByIndex(n.layerIndex,1).ensureSymbolizerParameters(a),!a.bind(this._rctx)))return;const o=e.baseOpacity<1?1:0;e.fboTexture=r===0&&o===0?null:this.switch(i).colorTexture;const l=this._acquireRasterTechnique(a,t,r,o);if(!l)return;a.opacity=e.opacity;const c=a.getUniforms(this._rctx);c.scale=n.scale,c.offset=n.offset,c.backgroundColor=e.backgroundColor,c.fboTexture=e.fboTexture,c.baseOpacity=e.baseOpacity;const h=this._rctx.bindTechnique(l,this._bindParameters,c);this._render(h)}_acquireRasterTechnique(e,t,i,r){if(!this._rctx.capabilities.colorBufferFloat)return null;const n=e.symbolizerParameters,a=["stretch","lut","hillshade"].indexOf(n.type);return this._rasterConfiguration??=new Md,this._rasterConfiguration.output=t,this._rasterConfiguration.blendMode=i,this._rasterConfiguration.baseOpacityMode=r,this._rasterConfiguration.colorizerType=a,this._rasterConfiguration.applyColormap=!!n.colormap,this._rasterConfiguration.requireBilinearWithNN=e.isBilinearWithStretchColorRamp,this._rasterConfiguration.stretchType=e.hasStretchTypeNone()?0:1,this._techniques.precompile(q2,this._rasterConfiguration),this._techniques.get(q2,this._rasterConfiguration)}drawVectorData(e,t,i,r,n,a,o,l){const c=this._rctx,h=n.sourceLayerInfo.data,d=n.tile.surface.layerViewByIndex(n.layerIndex,1),m=e.baseOpacity<1?1:0,f=m===1||e.opacity<1||r!==0||t!==1,g=f?1:0,_=this._acquireBlendTechnique(r,t,m,g);c.setPipelineState(_.getPipeline());let v=null,b=null;f?(b=this.currentFBO(i),this._vtFBO==null&&(this._vtFBO=new G2(this._rctx)),v=this._vtFBO.get(i),c.bindFramebuffer(v),this._clearCurrentFBO()):l&&c.clear(256);try{this._vectorTileHelper.renderBackground(c,n.sourceLod,d.painter,d.layer.styleRepository,d.schemaHelper,Math.round(1/n.scale),n.offset,o,a,d.contentZoom),h&&this._vectorTileHelper.renderContent(c,n.sourceLod,h,n.vtlNeighborInfos,d.painter,d.layer.styleRepository,d.schemaHelper,Math.round(1/n.scale),n.offset,o,a,d.contentZoom)}catch(T){d9().warnOnce("A render call containing vector tiles did not resolve correctly.",T)}return!v||(c.bindFramebuffer(b),e.texture=v.colorTexture,e.offset=pp,e.scale=1,this.drawImageData(e,t,i,r,g),l)}copyFBOToTexture(e){const t=this._rctx,i=t.bindTexture(e.texture,bt.TEXTURE_UNIT_FOR_UPDATES),r=e.descriptor;t.gl.copyTexImage2D(3553,0,r.pixelFormat,0,0,r.width,r.height,0),e.generateMipmap(),t.bindTexture(i,bt.TEXTURE_UNIT_FOR_UPDATES)}_clearCurrentFBO(){this._rctx.setStencilWriteMask(255),this._rctx.setClearColor(0,0,0,0),this._rctx.setClearDepth(1),this._rctx.setClearStencil(0),this._rctx.clear(17664)}_initFBO(e,t,i){this._rctx.bindFramebuffer(e),i&&(this._rctx.setViewport(0,0,t,t),this._clearCurrentFBO())}ensureBuffer(e){this._lastUsedIds.length=0,this._lastUsedIds.push(1),this._lastCreatedBufferId=1,this._onHoldIds.length=0,this.bind(e)}bind(e,t=0,i=!0){if(this._current=t,t>=this._fbos.length)for(let r=this._fbos.length;r<=t;r++)this._fbos.push(new G2(this._rctx));this._initFBO(this._fbos[t].get(e),e,i)}_bindNextFreeBuffer(e){this._lastUsedIds.length>0?this.bind(e,this._lastUsedIds.pop()):(this._lastCreatedBufferId++,this.bind(e,this._lastCreatedBufferId))}openGroup(e){this._onHoldIds.push(this._current),this._bindNextFreeBuffer(e)}switch(e){const t=this.currentFBO(e),i=this._current;return this._bindNextFreeBuffer(e),this._lastUsedIds.push(i),t}getLastOnHoldId(){return this._onHoldIds[this._onHoldIds.length-1]}closeGroup(e){const t=this._current;this._bindNextFreeBuffer(e),this._lastUsedIds.push(t),this._lastUsedIds.push(this._onHoldIds.pop())}unbind(){this._rctx.bindFramebuffer(null)}currentFBO(e){return this._fbos[this._current].get(e)}},m9=class{constructor(){this.sourceLod=[0,0,0],this.offset=[0,0],this.scale=1,this.layerIndex=0,this.isVTLBackground=!1,this.vtlNeighborInfos=new zt({allocator:e=>e||new f9})}},f9=class{constructor(){this.sourceLayerInfo=null,this.sourceLod=[0,0,0],this.offset=[-1,0]}},j2=class{constructor(e,t){this._texture=e,this._cache=t,this.type="tile-texture",this._refCount=1,this._texture.descriptor.context.instanceCounter.increment(gi.TileTexture,this)}retain(){++this._refCount}release(){--this._refCount,this._refCount===0&&(this._cache?(this._texture.abortCompression(),this._cache.put(Wb(this.descriptor),this)):this.dispose())}dispose(){this._texture.descriptor.context.instanceCounter.decrement(gi.TileTexture,this),this._texture.dispose()}get texture(){return this._texture}generateMipmap(){this._texture.generateMipmap()}get descriptor(){return this._texture.descriptor}get usedMemory(){return this._texture.usedMemory}};function Wb(s,e=hL(s.internalFormat)){return`${s.width} ${s.pixelFormat} ${e}`}const Qb={normal:0,average:1,lighten:2,lighter:3,screen:5,plus:4,"color-dodge":6,darken:7,multiply:8,"color-burn":9,overlay:10,"soft-light":11,"hard-light":12,"vivid-light":13,hue:14,saturation:15,luminosity:16,color:17,difference:26,exclusion:27,minus:28,invert:29,reflect:30,"destination-over":18,"destination-atop":19,"destination-in":20,"destination-out":21,"source-atop":22,"source-in":23,"source-out":24,xor:25};function g9(s){return s===18||s===19||s===20||s===21||s===22||s===23||s===24||s===25}function gA(s,e){let t=e.width,i=e.height;return(s instanceof HTMLImageElement||s instanceof HTMLCanvasElement)&&(t=s.width,i=s.height),(s instanceof HTMLImageElement||s instanceof HTMLCanvasElement||s instanceof Uint8Array)&&(e.pixelFormat===6408||e.pixelFormat===6407)&&sc(t)&&sc(i)&&t>=16&&i>=16}let _9=class extends N4{constructor(e){super("TextureCompressionWorker","compress",{compress:t=>[t.data]},e)}async destroyWorkerAndSelf(){await this.broadcast({},"destroy"),this.destroy()}isCompressible(e,t){return gA(e,t)}},y9=class{constructor(e,t,i,r,n,a){this.start=e,this.end=t,this.blendMode=i,this.opacity=r,this.output=n,this.baseOpacity=a}},v9=class{constructor(e,t,i,r,n){this._rctx=e,this.tileSize=t,this._techniques=i,this._cache=r,this._compressionTracker=n,this._passParameters=new SW,this._backgroundColor=null,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._compositor=new p9(this._rctx,this._techniques)}dispose(){this._compositor=_e(this._compositor),this._backgroundTexture=Nt(this._backgroundTexture)}get backgroundIsGrid(){return this._backgroundColor==null}get backgroundColor(){return this._backgroundColor}updateHeading(e){this._compositor?.updateHeading(e)}updateTileTexture(e,t){if(!e.renderData)return;const i=e.surface,r=i.baseOpacity;let n=0,a=0,o=this.tileSize,l=!1,c=!1;const h=i.view.state.contentPixelRatio;let d=!1;__.clear(),Hc.length=0;const m=e.layerInfo[1];let f=0,g=null;for(;f<m.length;f++){const v=i.layerViewByIndex(f,1),b=v.layer,T=!Xl(e,v),w=b.opacity,S=v.fullOpacity;if(c=c||Tf(b),B2(v))continue;if(Rp(v)){let M=v.layer.blendMode!=="normal";if(Yh(b.parent)){const O=b.parent.uid;O!=null&&O!==""&&(M=_A(b.parent)||M)}M&&(d=M,l=!1)}if((T||w===0)&&!d){m[f].pendingUpdates&=-1;continue}++a;const C=lu(v),P=kv(e,f,C);if(P){if(m[f].pendingUpdates&=-1,Yh(b.parent)){const M=b.parent.uid;M!=null&&M!==""&&yA(b.parent,f)}C?o=Math.max(o,this.tileSize*h):r===1&&S===1&&(v.isOpaque||this._dataToTexture(P,dy(b))&&P.sourceLayerInfo.data.descriptor.isOpaque)&&(l=!0),++n,g===null&&(g=f)}}const _=o/this.tileSize;n!==0&&g!==null?n===1&&!d&&this._useLayerTexture(e,g)||this._composeLayers(e,t,f-1,c,o,_,!l||d,__,d):this._useBackgroundTexture(e,a,t!==0)}setBackground(e){this._backgroundColor!==e&&(this._backgroundColor=e,this._backgroundTexture&&this._drawBackgroundTexture(this._backgroundTexture))}_ensureBackgroundTexture(){return this._backgroundTexture==null&&(this._backgroundTexture=this._buildTexture(this.tileSize,!1),this._drawBackgroundTexture(this._backgroundTexture)),this._backgroundTexture}_drawBackgroundTexture(e){this._compositor.bind(this.tileSize),this._passParameters.offset=pp,this._passParameters.scale=1,this._passParameters.opacity=1,this.backgroundColor&&(this._passParameters.backgroundColor=this.backgroundColor),this._compositor.drawBackground(this._passParameters,this.backgroundColor!=null),this._compositor.copyFBOToTexture(e),this._compositor.unbind()}_useBackgroundTexture(e,t,i){const r=e.renderData,n=!i&&r.textureReference!=null&&(e.surface.view.layerViewManager.updating||t>0)?5e3:0,a=this._ensureBackgroundTexture();r.setTextureReference(new og(a,0,W2,e.surface.baseOpacity,0,1),n)}_useLayerTexture(e,t){const i=e.surface.layerViewByIndex(t,1),r=Tf(i.layer),n=r?e.surface.baseOpacity:1,a=r?1:e.surface.baseOpacity,o=i.fullOpacity,l=kv(e,t,!1);return!!this._dataToTexture(l,dy(i.layer))&&(e.renderData.setTextureReference(new og(l.sourceLayerInfo.data,0,Si(l.offset[0],l.offset[1],l.scale,l.scale),n,a,o)),!0)}_composeLayers(e,t,i,r,n,a,o,l,c){this._compositor.ensureBuffer(n);const h=e.surface.baseOpacity;let d=!1,m=9987,f=!1,g=0;for(let T=i;T>=0;T--){const w=e.surface.layerViewByIndex(T,1),S=w.layer,C=lu(w),P=kv(e,T,C),M=S.opacity,O=!Xl(e,w);if(!P||(M===0||O)&&!c||B2(w))continue;const D=!Tf(S)&&!d;D&&(d=!0);let A=!1;l.forEach(z=>{z.start===T&&(z.output=r?1:o&&D?this.backgroundIsGrid?3:2:1,z.baseOpacity=D?h:1,Hc.push(z),this._compositor.openGroup(n),A=!0)});const F=A?4:o&&g===0?this.backgroundIsGrid?3:2:1,E=Qb[Rp(w)?w.layer.blendMode:"normal"];for(this._passParameters.baseOpacity=D&&!A&&h<1?h:1,this._passParameters.opacity=M,Sj(P)?f=this._compositor.drawVectorData(this._passParameters,F,n,E,P,a,this.tileSize,f):Tj(P)?(this._compositor.drawRasterData(this._passParameters,F,n,E,P),b9(P)&&(m=9728)):this._dataToTexture(P,dy(S))&&(this._passParameters.texture=P.sourceLayerInfo.data.texture,this._passParameters.offset=P.offset,this._passParameters.scale=P.scale,this._compositor.drawImageData(this._passParameters,F,n,E));Hc.length>0&&Hc[Hc.length-1].end===T;){const z=Hc.pop();this._passParameters.baseOpacity=z.baseOpacity,this._passParameters.opacity=z.opacity,this._passParameters.offset=pp,this._passParameters.scale=1,this._compositor.drawGroup(this._passParameters,z.output,n,Qb[z.blendMode])}g++}const _=e.renderData,v=c||d&&h<1,b=_.ensureTexture(n,v,t,()=>this._buildTexture(n,v,m));this._compositor.copyFBOToTexture(b),this._compositor.unbind(),_.setTextureReference(new og(b,t,W2,d?1:h,0,1))}_dataToTexture(e,t){if(Mj(e)){const i=e.sourceLayerInfo,r=e.scale===1&&!t;i.data=this._buildTexture(i.data,!0,r,e.tile.onCompressionFinished),e.tile.setMemoryDirty()}return Pj(e)}_buildTexture(e,t,i=9987,r=()=>{}){if(e==null)return null;const n=new ft;n.wrapMode=33071,n.samplingMode=typeof i=="boolean"?9987:i,n.maxAnisotropy=this._maxAnisotropy,n.preMultiplyAlpha=!0,n.flipped=!0,n.hasMipmap=!0,t||(n.pixelFormat=6407);const a=this._rctx,o=typeof i=="boolean"&&i;let l;if(typeof e=="number")n.width=n.height=e,l=this._buildTileTexture(n);else if(j_(e))n.isOpaque=e.isOpaque,n.isOpaque&&(n.pixelFormat=6407),n.width=e.element.width,n.height=e.element.height,l=this._buildTileTexture(n,o,r,e.element);else try{n.width=e.width,n.height=e.height,l=this._buildTileTexture(n,o,r,e)}catch{l=new j2(fA(a)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const c=a.bindTexture(l.texture,bt.TEXTURE_UNIT_FOR_UPDATES);return l.generateMipmap(),a.bindTexture(c,bt.TEXTURE_UNIT_FOR_UPDATES),l}_buildTileTexture(e,t=!1,i=()=>{},r){const n=this._cache.pop(Wb(e,!1))??this._cache.pop(Wb(e,!0));if(t&&=gA(r,e),n)return n.retain(),t?n.texture.enableCompression({compressionTracker:this._compressionTracker,compressionCallback:i}):n.texture.disableCompression(),n.texture.setData(r),n;e.compress=t?{compressionTracker:this._compressionTracker,compressionCallback:i}:void 0;const a=new bt(this._rctx,e,r);return new j2(a,this._cache)}get test(){}};function kv(s,e,t){Ci.layerIndex=e,Ci.vtlNeighborInfos.clear();const i=s.layerInfo[1][e];if(Xi(Ci.offset,0,0),Ci.tile=s,Ci.scale=1,Ci.sourceLod=s.lij,Ci.sourceLayerInfo=i,Ci.isVTLBackground=t,i.data)return t&&s.forEachLoadedNeighbor((a,o)=>{if(a.level!==s.level)return;const l=a.layerInfo[1][e];if(!lE(l)||i.data===l.data)return;const c=Ci.vtlNeighborInfos.pushNew();c.offset=Sa[o],c.sourceLod=a.lij,c.sourceLayerInfo=l}),Ci;const r=i.upsampleInfo,n=r?.tile?.layerInfo[1][e];return n&&r.tile?(Ci.tile=r.tile,pr(Ci.offset,r.offset),Ci.scale=r.scale,Ci.sourceLod=r.tile.lij,Ci.sourceLayerInfo=n,Ci):t?Ci:null}function b9(s){const e=s.sourceLayerInfo.data;return!!e.source&&e.interpolation==="nearest"}function _A(s){let e=s.blendMode!=="normal";return Yh(s.parent)&&(e=_A(s.parent)||e),e}function yA(s,e){Yh(s.parent)&&yA(s.parent,e);const t=s.uid;if(t!=null&&t!==""){const i=__.get(t);i?i.start=e:__.set(t,new y9(e,e,s.blendMode,s.opacity,1,1))}}const __=new Map,Hc=new Array,Ci=new m9,W2=Si(0,0,1,1),Sa=new Array;function w9(){Ci.sourceLayerInfo=null,Ci.tile=null,Ci.vtlNeighborInfos.prune()}Sa[0]=[0,-1],Sa[1]=[-1,-1],Sa[2]=[-1,0],Sa[3]=[-1,1],Sa[4]=[0,1],Sa[5]=[1,1],Sa[6]=[1,0],Sa[7]=[1,-1];const x9=200,zv=40,C9=.8,T9=10,$d=1e-6;function S9(s,e,t){const i=e,r=t;let n=0,a=1/0;for(let o=0;o<3;++o){{const l=s[o];if(i[o]<l){if(r[o]<=$d)return!1;const c=(l-i[o])/r[o];n=Math.max(n,c)}else if(r[o]<=-$d){const c=(l-i[o])/r[o];a=Math.min(a,c)}if(n>a)return!1}{const l=s[o+3];if(i[o]>l){if(r[o]>=-$d)return!1;const c=(l-i[o])/r[o];n=Math.max(n,c)}else if(r[o]>=$d){const c=(l-i[o])/r[o];a=Math.min(a,c)}if(n>a)return!1}}return!0}let Q2=class{constructor(e,t,i,r,n){this.aabb=e,this.axis=t,this.d=i,this.midStartIndex=r,this.rightStartIndex=n}},vA=class Zb{constructor(e,t,i,r){this.globalTriangleVertexIndices=e,this.firstTriangleIndex=t,this.positions=r,this._rayDirection=x(),this._callback=X2,this._intersectionOptions=Z2,this.bspNodeTree=new Array;const n=i-t,a=new(n<O9?Uint8Array:n<D9?Uint16Array:Uint32Array)(n);this.triangleIndexMap=a;for(let o=0;o<n;++o)a[o]=o;{const o=R9(e,t,i,r.data,r.stride),l=U(Math.log2(n/zv),2,T9),c=(h,d,m)=>{const f=M9(a,o,h,d),g=d-h;if(g<=zv){const S=new Q2(f,void 0,0,h,d);return this.bspNodeTree.push(S),S}const{axis:_,midValue:v}=$9(f),b=P9(a,o,h,d,_,v),T=(S,C)=>{if(m>l)return;const P=C-S;return P<zv||P>=C9*g?void 0:c(S,C,m+1)},w=new Q2(f,_,v,b.next,b.mid);return this.bspNodeTree.push(w),w.leftNode=T(h,b.next),w.rightNode=T(b.mid,d),w};c(0,n,0)}}intersectRayTriangleRange(e,t){if(e>=t)return;const i=this.positions;a$(this._rayFrom,this._rayDirection,e,t,this.globalTriangleVertexIndices,i.data,i.stride,this._intersectionOptions.normalRequired,this._callback,this.triangleIndexMap,this.firstTriangleIndex),Zb.numFacesTested+=t-e}intersectRay(e,t,i,r){Zb.numFacesTested=0;const n=e,a=t,o=a[0]-n[0],l=a[1]-n[1],c=a[2]-n[2];if(o*o+l*l+c*c<$d)return;this._rayFrom=n;const h=this._rayDirection;h[0]=o,h[1]=l,h[2]=c;const d=this.triangleIndexMap.length;this._callback=r,this._intersectionOptions=i,this.intersectRayBSP(this.bspNodeTree[0],0,d),this._callback=X2,this._intersectionOptions=Z2}intersectRayBSP(e,t,i){const r=this._rayFrom,n=this._rayDirection;if(!S9(e.aabb,r,n))return;const a=e.axis,o=e.d;if(r[a]<o||n[a]<0){const l=t,c=e.midStartIndex;if(l<c){const h=e.leftNode;h!==void 0?this.intersectRayBSP(h,l,c):this.intersectRayTriangleRange(l,c)}}if(this.intersectRayTriangleRange(e.midStartIndex,e.rightStartIndex),r[a]>o||n[a]>0){const l=e.rightStartIndex,c=i;if(l<c){const h=e.rightNode;h!==void 0?this.intersectRayBSP(h,l,c):this.intersectRayTriangleRange(l,c)}}}static{this.numFacesTested=0}get estimatedMemoryUsage(){return this.triangleIndexMap.byteLength}};const qc=[1/0,1/0,1/0],Gc=[-1/0,-1/0,-1/0];function P9(s,e,t,i,r,n){let a=t,o=i;for(;a<o;){const c=s[a];e[6*c+r+3]<=n?++a:(--o,s[a]=s[o],s[o]=c)}let l=a;for(o=i;l<o;){const c=s[o-1];e[6*c+r]>=n?--o:(s[o-1]=s[l],s[l]=c,++l)}return{next:a,mid:l}}function M9(s,e,t,i){if(i<=t)return mC(NaN,NaN,NaN,NaN,NaN,NaN);{const r=6*s[t];for(let n=0;n<3;++n)qc[n]=e[r+0+n],Gc[n]=e[r+3+n]}for(let r=t+1;r<i;++r){const n=6*s[r];for(let a=0;a<3;++a)qc[a]=Math.min(qc[a],e[n+0+a]),Gc[a]=Math.max(Gc[a],e[n+3+a])}return mC(qc[0],qc[1],qc[2],Gc[0],Gc[1],Gc[2])}function $9(s){const e=s[3]-s[0],t=s[4]-s[1],i=s[5]-s[2],r=e>t?e>i?0:t>i?1:2:t>i?1:i>e?2:0;return{axis:r,midValue:(s[r]+s[r+3])/2}}function R9(s,e,t,i,r){const n=t-e,a=new Float32Array(6*n);for(let o=0;o<n;++o){const l=3*(o+e),c=s[l]*r,h=s[l+1]*r,d=s[l+2]*r;for(let m=0;m<3;++m){const f=i[c+m],g=i[h+m],_=i[d+m];a[6*o+m]=Math.min(f,g,_),a[6*o+3+m]=Math.max(f,g,_)}}return a}const O9=255,D9=65535,Z2=new Pw,X2=()=>{};function Uhe(s){s.code.add(y`float normals2FoamIntensity(vec3 n, float waveStrength){
float normalizationFactor =  max(0.015, waveStrength);
return max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);
}`)}function E9(s){s.code.add(y`vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){
return foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;
}`)}function A9(s,e){if(!e.screenSpaceReflections)return;const t=s.fragment;t.include(Qa),t.uniforms.add(new ap("nearFar",i=>i.camera.nearFar),new mr("depthMap",i=>i.depth?.attachment),new ur("proj",i=>i.camera.projectionMatrix),new Rs("invResolutionHeight",i=>1/i.camera.height),new ur("reprojectionMatrix",i=>i.ssr.reprojectionMatrix)).code.add(y`
  vec2 reprojectionCoordinate(vec3 projectionCoordinate)
  {
    vec4 zw = proj * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);
    vec4 reprojectedCoord = reprojectionMatrix * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);
    reprojectedCoord.xy /= reprojectedCoord.w;
    return reprojectedCoord.xy * 0.5 + 0.5;
  }

  const int maxSteps = ${e.highStepCount?"150":"75"};

  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)
  {
    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);
    projectedCoord.xy /= projectedCoord.w;
    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;
    return projectedCoord;
  }

  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)
  {
    vec3 viewPos = startPosition;
    vec3 viewPosEnd = startPosition;

    // Project the start position to the screen
    vec4 projectedCoordStart = applyProjectionMat(proj, viewPos);
    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space
    float k0 = 1.0/ projectedCoordStart.w;

    // advance the position in the direction of the reflection
    viewPos += dir;

    vec4 projectedCoordVanishingPoint = applyProjectionMat(proj, dir);

    // Project the advanced position to the screen
    vec4 projectedCoordEnd = applyProjectionMat(proj, viewPos);
    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space
    float k1 = 1.0/ projectedCoordEnd.w;

    // calculate the reflection direction in the screen space
    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);
    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);

    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);

    float projectedCoordDirLength = length(projectedCoordDir);
    float maxSt = float(maxSteps);

    // normalize the projection direction depending on maximum steps
    // this determines how blocky the reflection looks
    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);

    // Normalize the homogeneous camera space coordinates
    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);
    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);

    // initialize the variables for ray marching
    vec2 P = projectedCoordStart.xy;
    vec3 Q = Q0;
    float k = k0;
    float rayStartZ = -startPosition.z; // estimated ray start depth value
    float rayEndZ = -startPosition.z;   // estimated ray end depth value
    float prevEstimateZ = -startPosition.z;
    float rayDiffZ = 0.0;
    float dDepth;
    float depth;
    float rayDiffZOld = 0.0;

    // early outs
    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)
      return vec3(P, 0.0);
    float dDepthBefore = 0.0;

    for(int i = 0; i < maxSteps-1; i++)
    {
      depth = -linearDepthFromTexture(depthMap, P); // get linear depth from the depth buffer

      // estimate depth of the marching ray
      rayStartZ = prevEstimateZ;
      dDepth = -rayStartZ - depth;
      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));
      rayDiffZ = rayEndZ- rayStartZ;
      prevEstimateZ = rayEndZ;

      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )
      {
        return vec3(P, 0.);
      }

      // If we detect a hit - return the intersection point, two conditions:
      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth
      //  - if difference between dDepth and rayDiffZOld is not too large
      //  - if difference between dDepth and 0.025/abs(k) is not too large
      //  - if the sampled depth is not behind far plane or in front of near plane

      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)
      {
        float weight = dDepth / (dDepth - dDepthBefore);
        vec2 Pf = mix(P - dP, P, 1.0 - weight);
        if (abs(Pf.y - projectedCoordStart.y) > invResolutionHeight) {
          return vec3(Pf, depth);
        }
        else {
          return vec3(P, depth);
        }
      }

      // continue with ray marching
      P = clamp(P + dP, vec2(0.0), vec2(0.999));
      Q.z += dQ.z;
      k += dk;
      rayDiffZOld = rayDiffZ;
      dDepthBefore = dDepth;
    }
    return vec3(P, 0.0);
  }
  `)}function I9(s){s.fragment.uniforms.add(new Rs("cloudAbsorption",e=>e.clouds.absorption),new Rs("cloudCoverage",e=>e.clouds.coverage)).code.add(y`vec4 lookupCloudsFromTextureArray(sampler2DArray cubeMap, vec3 rayDir) {
int faceIndex;
vec2 uv;
if(rayDir.z <= 0.0) {
float hazeFactor = smoothstep(-0.01, mix(0.0, 0.075, cloudCoverage), abs(dot(rayDir, vec3(0, 0, 1))));
float shading = clamp(1.0 - cloudAbsorption, 0.6, 1.0) * (1.0 - hazeFactor);
float totalTransmittance = hazeFactor;
return vec4(shading, totalTransmittance, shading, totalTransmittance);
}
if (abs(rayDir.x) >= abs(rayDir.y) && abs(rayDir.x) >= abs(rayDir.z)) {
if(rayDir.x > 0.0) {
faceIndex = 0;
uv = rayDir.yz / rayDir.x;
uv = vec2(-uv.x, uv.y);
} else {
faceIndex = 1;
uv = rayDir.yz / rayDir.x;
uv = vec2(-uv.x, -uv.y);
}
} else if (abs(rayDir.y) >= abs(rayDir.x) && abs(rayDir.y) >= abs(rayDir.z)) {
if(rayDir.y > 0.0) {
faceIndex = 2;
uv = rayDir.xz / rayDir.y;
} else {
faceIndex = 3;
uv = rayDir.xz / rayDir.y;
uv = vec2(uv.x, -uv.y);
}
} else {
if(rayDir.y < 0.0) {
faceIndex = 4;
uv = rayDir.xy / rayDir.z;
uv = vec2(uv.x, -uv.y);
} else {
faceIndex = 5;
uv = rayDir.xy / rayDir.z;
uv = vec2(uv.x, -uv.y);
}
}
uv = 0.5 * (uv + 1.0);
if(faceIndex != 5) {
uv.y = uv.y - 0.5;
}
uv.y = uv.y * 2.0;
vec4 s = texture(cubeMap, vec3(uv, float(faceIndex)));
return s;
}`)}let L9=class extends la{constructor(e,t){super(e,"sampler2DArray",0,(i,r)=>i.bindTexture(e,t(r)))}};function bA(s){const e=s.fragment;e.constants.add("radiusCloudsSquared","float",F9).code.add(y`vec3 intersectWithCloudLayer(vec3 dir, vec3 cameraPosition, vec3 spherePos) {
float B = 2.0 * dot(cameraPosition, dir);
float C = dot(cameraPosition, cameraPosition) - radiusCloudsSquared;
float det = B * B - 4.0 * C;
float pointIntDist = max(0.0, 0.5 *(-B + sqrt(det)));
return (cameraPosition + dir * pointIntDist) - spherePos;
}`),e.uniforms.add(new Rs("radiusCurvatureCorrection",({clouds:l})=>l.parallax.radiusCurvatureCorrection)).code.add(y`vec3 correctForPlanetCurvature(vec3 dir) {
dir.z = dir.z * (1.0 - radiusCurvatureCorrection) + radiusCurvatureCorrection;
return dir;
}`),e.code.add(y`vec3 rotateDirectionToAnchorPoint(mat4 rotMat, vec3 inVec) {
return (rotMat * vec4(inVec, 0.0)).xyz;
}`),lc(e),P_(e);const t=Qe(.28,.175,.035);e.constants.add("RIM_COLOR","vec3",t),e.code.add(y`
    vec3 calculateCloudColor(vec3 cameraPosition, vec3 worldSpaceRay, vec4 clouds) {
      float upDotLight = dot(cameraPosition, mainLightDirection);
      float dirDotLight = max(dot(worldSpaceRay, mainLightDirection), 0.0);
      float sunsetTransition = clamp(pow(max(upDotLight, 0.0), ${y.float(.3)}), 0.0, 1.0);

      // Base color of the clouds that depends on lighting of the sun and sky
      vec3 ambientLight = calculateAmbientIrradiance(cameraPosition,  0.0);
      vec3 combinedLight = clamp((mainLightIntensity + ambientLight )/PI, vec3(0.0), vec3(1.0));
      vec3 baseCloudColor = pow(combinedLight * pow(clouds.xyz, vec3(GAMMA)), vec3(INV_GAMMA));

      // Rim light around the edge of the clouds simulating scattering of the direct lun light
      float scatteringMod = max(clouds.a < 0.5 ? clouds.a / 0.5 : - clouds.a / 0.5 + 2.0, 0.0);
      float rimLightIntensity = 0.5 + 0.5 * pow(max(upDotLight, 0.0), 0.35);
      vec3 directSunScattering = RIM_COLOR * rimLightIntensity * (pow(dirDotLight, ${y.float(140)})) * scatteringMod;

      // Brighten the clouds around the sun at the sunsets
      float additionalLight = ${y.float(.2)} * pow(dirDotLight, ${y.float(10)}) * (1. - pow(sunsetTransition, ${y.float(.3)})) ;

      return vec3(baseCloudColor * (1.0 + additionalLight) + directSunScattering);
    }
  `),s.include(I9),e.uniforms.add(new Hx("readChannelsRG",l=>l.clouds.readChannels===0),new L9("cubeMap",l=>l.clouds.data?.cubeMap?.colorTexture)).code.add(y`vec4 sampleCloud(vec3 rayDir, bool readOtherChannel) {
vec4 s = lookupCloudsFromTextureArray(cubeMap, rayDir);
bool readRG = readChannelsRG ^^ readOtherChannel;
s = readRG ? vec4(vec3(s.r), s.g) : vec4(vec3(s.b), s.a);
return length(s) == 0.0 ? vec4(s.rgb, 1.0) : s;
}`),e.uniforms.add(new Tn("anchorPoint",l=>l.clouds.parallax.anchorPoint),new Tn("anchorPointNew",l=>l.clouds.parallaxNew.anchorPoint),new ur("rotationClouds",l=>l.clouds.parallax.transform),new ur("rotationCloudsNew",l=>l.clouds.parallaxNew.transform),new Rs("cloudsOpacity",l=>l.clouds.opacity),new Rs("fadeFactor",l=>l.clouds.fadeFactor),new Hx("crossFade",l=>l.clouds.fadeState===3)).code.add(y`vec4 renderClouds(vec3 worldRay, vec3 cameraPosition) {
vec3 intersectionPoint = intersectWithCloudLayer(worldRay, cameraPosition, anchorPoint);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = sampleCloud(worldRayRotatedCorrected, crossFade);
vec3 cameraPositionN = normalize(cameraPosition);
vec4 cloudColor = vec4(calculateCloudColor(cameraPositionN, worldRay, cloudData), cloudData.a);
if(crossFade) {
intersectionPoint = intersectWithCloudLayer(worldRay, cameraPosition, anchorPointNew);
worldRayRotated = rotateDirectionToAnchorPoint(rotationCloudsNew, normalize(intersectionPoint));
worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
cloudData = sampleCloud(worldRayRotatedCorrected, false);
vec4 cloudColorNew = vec4(calculateCloudColor(cameraPositionN, worldRay, cloudData), cloudData.a);
cloudColor = mix(cloudColor, cloudColorNew, fadeFactor);
}
float totalTransmittance = length(cloudColor.rgb) == 0.0 ?
1.0 :
clamp(cloudColor.a * cloudsOpacity + (1.0 - cloudsOpacity), 0.0 , 1.0);
return vec4(cloudColor.rgb, totalTransmittance);
}`)}const F9=(Ei.radius+vB)**2;function V9(s,e){const t=s.fragment;t.include(uL,e),t.include(uc),t.include(E9),e.cloudReflections&&s.include(bA),s.include(A9,e),t.include(Vp,e),t.constants.add("fresnelSky","vec3",[.02,1,15]),t.constants.add("fresnelMaterial","vec2",[.02,.1]),t.constants.add("roughness","float",.015),t.constants.add("foamIntensityExternal","float",1.7),t.constants.add("ssrIntensity","float",.65),t.constants.add("ssrHeightFadeStart","float",dL),t.constants.add("ssrHeightFadeEnd","float",o$),t.constants.add("waterDiffusion","float",.92),t.constants.add("waterSeaColorMod","float",.8),t.constants.add("correctionViewingPowerFactor","float",.4),t.constants.add("skyZenitColor","vec3",[.52,.68,.9]),t.constants.add("skyColor","vec3",[.67,.79,.9]),t.constants.add("cloudFresnelModifier","vec2",[1.2,.01]),t.code.add(y`PBRShadingWater shadingInfo;
vec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {
float exponent = pow((1.0 - cosTheta), fresnelSky[2]);
return mix(zenit, horizon, exponent);
}`),t.uniforms.add(new Rs("lightingSpecularStrength",i=>i.lighting.mainLight.specularStrength),new Rs("lightingEnvironmentStrength",i=>i.lighting.mainLight.environmentStrength)),t.code.add(y`vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 viewPosition, vec3 position) {
float reflectionHit = 0.0;
float reflectionHitDiffused = 0.0;
vec3 seaWaterColor = linearizeGamma(color);
vec3 h = normalize(l + v);
shadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);
shadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);
shadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);
shadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);
shadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);
float upDotV = max(dot(localUp,v), 0.0);
vec3 skyHorizon = linearizeGamma(skyColor);
vec3 skyZenit = linearizeGamma(skyZenitColor);
vec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );
float upDotL = max(dot(localUp,l),0.0);
float daytimeMod = 0.1 + upDotL * 0.9;
skyColor *= daytimeMod;
float shadowModifier = clamp(shadow, 0.8, 1.0);
vec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);
vec3 reflSky = lightingEnvironmentStrength * fresnelModifier * skyColor * shadowModifier;
vec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;
vec3 specular = vec3(0.0);
if(upDotV > 0.0 && upDotL > 0.0) {
vec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);
vec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;
float NdotL = clamp(dot(n, l), 0.0, 1.0);
specular = lightingSpecularStrength * NdotL * incidentLight * specularSun;
}
vec3 foam = vec3(0.0);
if(upDotV > 0.0) {
foam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);
}
float correctionViewingFactor = pow(max(dot(v, localUp), 0.0), correctionViewingPowerFactor);
vec3 normalCorrectedClouds = mix(localUp, n, correctionViewingFactor);
vec3 reflectedWorld = normalize(reflect(-v, normalCorrectedClouds));`),e.cloudReflections&&t.uniforms.add(new Rs("cloudsOpacity",i=>i.clouds.opacity)).code.add(y`vec4 cloudsColor = renderClouds(reflectedWorld, position);
cloudsColor.a = 1.0 - cloudsColor.a;
cloudsColor = pow(cloudsColor, vec4(GAMMA));
cloudsColor *= clamp(fresnelModifier.y * cloudFresnelModifier[0] - cloudFresnelModifier[1], 0.0, 1.0) * cloudsOpacity;`),e.screenSpaceReflections?t.uniforms.add(new ur("view",i=>i.camera.viewMatrix),new mr("lastFrameColorTexture",i=>i.ssr.lastFrameColor?.getTexture()),new Rs("fadeFactorSSR",i=>i.ssr.fadeFactor)).code.add(y`vec3 viewDir = normalize(viewPosition);
vec4 viewNormalVectorCoordinate = view * vec4(n, 0.0);
vec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);
vec4 viewUp = view * vec4(localUp, 0.0);
vec3 viewNormalCorrectedSSR = mix(viewUp.xyz, viewNormal, correctionViewingFactor);
vec3 reflected = normalize(reflect(viewDir, viewNormalCorrectedSSR));
vec3 hitCoordinate = screenSpaceIntersection(reflected, viewPosition, viewDir, viewUp.xyz);
vec3 reflectedColor = vec3(0.0);
if (hitCoordinate.z > 0.0)
{
vec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);
vec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));
float heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -viewPosition.z);
reflectionHit = clamp(1.0 - (1.3 * dCoords.y), 0.0, 1.0) * heightMod * fadeFactorSSR;
reflectionHitDiffused = waterDiffusion * reflectionHit;
reflectedColor = linearizeGamma(texture(lastFrameColorTexture, reprojectedCoordinate).xyz) *
reflectionHitDiffused * fresnelModifier.y * ssrIntensity;
}
float seaColorMod =  mix(waterSeaColorMod, waterSeaColorMod * 0.5, reflectionHitDiffused);
vec3 waterRenderedColor = tonemapACES((1.0 - reflectionHitDiffused) * reflSky + reflectedColor +
reflSea * seaColorMod + specular + foam);`):t.code.add(y`vec3 waterRenderedColor = tonemapACES(reflSky + reflSea * waterSeaColorMod + specular + foam);`),e.cloudReflections?e.screenSpaceReflections?t.code.add(y`return waterRenderedColor * (1.0 - (1.0 - reflectionHit) * cloudsColor.a) + (1.0 - reflectionHit) * cloudsColor.xyz;
}`):t.code.add(y`return waterRenderedColor * (1.0 - cloudsColor.a) + cloudsColor.xyz;
}`):t.code.add(y`return waterRenderedColor;
}`)}function k9(s,e){const{vertex:t,fragment:i}=s;t.uniforms.add(new Fg("overlayTexOffset",(r,n)=>N9(r,n)),new Fg("overlayTexScale",(r,n)=>U9(r,n))),i.constants.add("overlayOpacity","float",1),i.uniforms.add(new Be("ovColorTex",(r,n)=>z9(r,n))),wA(s,e)}function z9(s,e){return s.identifier===0&&ns(s.output)?s.occludedGround?e.overlay?.allSourcesOccluders?e.overlay?.getTexture(1):e.overlay?.getTexture(4):e.overlay?.getTexture(1):s.identifier===0&&s.output===10?e.overlay?.getTexture(5):s.identifier===2?e.overlay?.getTexture(2):null}function Wu(s,e){const{vertex:t,fragment:i}=s,{output:r}=e;t.uniforms.add(new Y2("overlayTexOffset"),new Y2("overlayTexScale")),i.uniforms.add(new ge("overlayOpacity",n=>n.overlayOpacity)),r!==9&&i.uniforms.add(new Be("ovColorTex",(n,a)=>a.overlay?.getTexture(n.overlayContent))),wA(s,e)}function B9(s,e){switch(s){case 0:case 1:return e.slot!==9||e.overlay?.allSourcesOccluders?0:4;case 2:case 3:return 0;case 9:return 2;case 4:case 6:case 7:case 8:return null;case 10:return 5}return null}function wA(s,e){const t=e.pbrMode===3||e.pbrMode===4||e.pbrMode===6;t&&s.include(V9,e);const{vertex:i,fragment:r,varyings:n}=s;n.add("vtcOverlay","vec4");const{output:a}=e,o=a===9;i.code.add(y`void setOverlayVTC(in vec2 uv) {
vtcOverlay = vec4(uv, uv) * overlayTexScale + overlayTexOffset;
}`),r.code.add(y`bool isValid(vec2 uv, vec2 dxdy) {
return (uv.x >= 0.0 + dxdy.x) && (uv.x <= 1.0 - dxdy.x) && (uv.y >= 0.0 + dxdy.y) && (uv.y <= 1.0 - dxdy.y);
}
vec4 getOverlayColor(sampler2D ov0Tex, vec4 texCoords) {
vec4 color0 = texture(ov0Tex, vec2(texCoords.x * 0.5, texCoords.y));
vec4 color1 = texture(ov0Tex, vec2(texCoords.z * 0.5 + 0.5, texCoords.w));
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`),o?r.uniforms.add(new wu("overlayHighlightTexture",(l,c)=>c.overlay?.getTexture(2))).code.add(y`uvec2 getAllOverlayHighlightValuesEncoded() {
vec4 texCoords = vtcOverlay;
vec2 uvInner = texCoords.xy;
vec2 uvOuter = texCoords.zw;
bool isValidInner = isValid(uvInner, fwidth(uvInner));
bool isValidOuter = isValid(uvOuter, vec2(0.0, 0.0));
vec2 texelCoordInner = uvInner * vec2(0.5, 1.0);
vec2 texelCoordOuter = uvOuter * vec2(0.5, 1.0) + vec2(0.5,0.0);
vec2 texDim =  vec2(textureSize(overlayHighlightTexture, 0));
uvec2 texelValueInner = texelFetch(overlayHighlightTexture, ivec2(texelCoordInner * texDim), 0).rg;
uvec2 texelValueOuter = texelFetch(overlayHighlightTexture, ivec2(texelCoordOuter * texDim), 0).rg;
return
isValidInner ? texelValueInner :
isValidOuter ? texelValueOuter :
uvec2(0);
}`):(r.code.add(y`vec4 getCombinedOverlayColor() {
return overlayOpacity * getOverlayColor(ovColorTex, vtcOverlay);
}`),r.code.add(y`vec4 getOverlayColorTexel() {
vec4 texCoords = vtcOverlay;
vec2 texDim =  vec2(textureSize(ovColorTex, 0));
vec4 color0 = texelFetch(ovColorTex, ivec2(vec2(texCoords.x * 0.5, texCoords.y) * texDim), 0);
vec4 color1 = texelFetch(ovColorTex, ivec2(vec2(texCoords.z * 0.5 + 0.5, texCoords.w) * texDim), 0);
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`)),t&&(lc(r),P_(r),r.code.add(y`vec4 getOverlayWaterColor(vec4 maskInput, vec4 colorInput, vec3 vposEyeDir,
float shadow, vec3 localUp, mat3 tbn, vec3 position, vec3 positionWorld) {
vec3 n = normalize(tbn *  (2.0 * maskInput.rgb - vec3(1.0)));
vec3 v = vposEyeDir;
vec3 final = getSeaColor(n, v, mainLightDirection, colorInput.rgb, mainLightIntensity, localUp, 1.0 - shadow, maskInput.w, position, positionWorld);
return vec4(final, colorInput.w);
}`))}function N9(s,e){const t=e.overlay?.overlays[0]?.extent;Ig(t)&&(Zn[0]=s.toMapSpace[0]/hr(t)-t[0]/hr(t),Zn[1]=s.toMapSpace[1]/Xn(t)-t[1]/Xn(t));const i=e.overlay?.overlays[1]?.extent;return Ig(i)&&(Zn[2]=s.toMapSpace[0]/hr(i)-i[0]/hr(i),Zn[3]=s.toMapSpace[1]/Xn(i)-i[1]/Xn(i)),Zn}function U9(s,e){const t=e.overlay?.overlays[0]?.extent;Ig(t)&&(Zn[0]=s.toMapSpace[2]/hr(t),Zn[1]=s.toMapSpace[3]/Xn(t));const i=e.overlay?.overlays[1]?.extent;return Ig(i)&&(Zn[2]=s.toMapSpace[2]/hr(i),Zn[3]=s.toMapSpace[3]/Xn(i)),Zn}const Zn=Lt();let Y2=class extends la{constructor(e){super(e,"vec4")}};function H9(s,e){s.varyings.add("tbnTangent","vec3"),s.varyings.add("tbnBiTangent","vec3"),e.spherical?s.vertex.code.add(y`void forwardVertexTangent(vec3 n) {
tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));
tbnBiTangent = normalize(cross(n, tbnTangent));
}`):s.vertex.code.add(y`void forwardVertexTangent(vec3 n) {
tbnTangent = vec3(1.0, 0.0, 0.0);
tbnBiTangent = normalize(cross(n, tbnTangent));
}`),s.fragment.code.add(y`mat3 getTBNMatrix(vec3 n) {
return mat3(tbnTangent, tbnBiTangent, n);
}`)}function xA(s,e){e.output===9&&(s.include(Mw,e),s.fragment.code.add(y`
    void calculateOcclusionAndOutputHighlight(uvec2 highlightToAdd) {
      uint levelBits = readLevelBits(highlightToAdd, highlightLevel);
      if ((levelBits & 1u) == 0u) discard;
      outputHighlight(isHighlightOccluded());
    }
  `))}function q9(s,e){e.spherical?s.vertex.code.add(y`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return normalize(pos + origin);
}`):s.vertex.code.add(y`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return vec3(0.0, 0.0, 1.0);
}`),e.spherical?s.vertex.code.add(y`mat3 getTBNMatrix(in vec3 n) {
vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`):s.vertex.code.add(y`mat3 getTBNMatrix(in vec3 n) {
vec3 t = vec3(1.0, 0.0, 0.0);
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`)}let G9=class extends $w{constructor(){super(...arguments),this.overlayOpacity=1}};function j9(s,e){const{vertex:t,fragment:i,varyings:r}=s;r.add("vtc","vec2"),t.uniforms.add(new K2("texOffsetAndScale")),i.uniforms.add(new J2("tex")),i.uniforms.add(new Bv("textureOpacities"));const n=e.textureFadingEnabled&&!e.renderOccluded;n&&(t.uniforms.add(new K2("nextTexOffsetAndScale")),r.add("nvtc","vec2"),i.uniforms.add(new J2("texNext")),i.uniforms.add(new Bv("nextTexOpacities")),i.uniforms.add(new W9("fadeFactor")));const a=e.tileBlendInput===1,o=e.tileBlendInput===2;o&&i.include(rx),a&&i.uniforms.add(new Bv("backgroundColor")),t.code.add(y`
  void forwardTextureCoordinatesWithTransform(in vec2 uv) {
    vtc = texOffsetAndScale.xy + uv * texOffsetAndScale.zw;
    ${X(n,"nvtc = nextTexOffsetAndScale.xy + uv * nextTexOffsetAndScale.zw;")}
  }`),i.code.add(y`
    vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
      ${X(o||a,y`if (opacities.y <= 0.0) {
           return color * opacities.z * opacities.x;
         }
         vec4 bg = vec4(${a?y`backgroundColor`:y`gridColor(uv)`} * opacities.y, opacities.y);
         vec4 layer = color * opacities.z;
         return (bg * (1.0 - layer.a) + layer) * opacities.x;`,"return color;")}
    }`),n?i.code.add(y`vec4 getTileColor() {
vec4 color = getColor(texture(tex, vtc), vtc, textureOpacities);
if (fadeFactor >= 1.0) {
return color;
}
vec4 nextColor = getColor(texture(texNext, nvtc), nvtc, nextTexOpacities);
return mix(nextColor, color, fadeFactor);
}`):i.code.add(y`vec4 getTileColor() {
return getColor(texture(tex, vtc), vtc, textureOpacities);
}`)}let W9=class extends la{constructor(e){super(e,"float")}},Bv=class extends la{constructor(e){super(e,"vec3")}},K2=class extends la{constructor(e){super(e,"vec4")}},J2=class extends la{constructor(e){super(e,"sampler2D")}},nx=class extends G9{};function CA(s){const e=new lt,{attributes:t,vertex:i,fragment:r,varyings:n}=e;t.add("position","vec3"),e.include(pL,s),e.include(vR,s);const a=()=>{e.include(q9,s),i.code.add(y`vec3 getNormal() {
float z = 1.0 - abs(normalCompressed.x) - abs(normalCompressed.y);
vec3 n = vec3(normalCompressed + vec2(normalCompressed.x >= 0.0 ? 1.0 : -1.0,
normalCompressed.y >= 0.0 ? 1.0 : -1.0) * min(z, 0.0), z);
return normalize(n);
}`)};YM(i,s),e.include(l$);const{output:o,pbrMode:l,overlayMode:c,tileBorders:h,spherical:d,transparencyMode:m,overlayEnabled:f}=s,g=m===2||m===3,_=f&&g;switch(o){case 1:case 0:{e.include(j9,s),e.include(Dg,s),f&&(s.pbrMode=l===5?6:3,e.include(Wu,s),s.pbrMode=l);const v=c===2;v&&e.include(H9,s),n.add("vnormal","vec3"),n.add("vpos","vec3",{invariant:!0}),n.add("vup","vec3"),a(),i.main.add(y`
          vpos = position;
          vec3 positionWorld = position + localOrigin;
          gl_Position = transformPosition(proj, view, vpos);
          vnormal = getNormal();
          vup = getLocalUp(position, localOrigin);
          ${X(v,y`forwardVertexTangent(vnormal);`)}

          forwardTextureCoordinatesWithTransform(uv0);
          ${X(f,"setOverlayVTC(uv0);")}
          ${X(h,"forwardTextureCoordinates();")}
          forwardLinearDepthToReadShadowMap();`),e.include(_L,s),r.include(KM,s),e.include(Dg,s),r.include(yL,s),Cw(r,s),vL(r),x0(r),r.uniforms.add(i.uniforms.get("localOrigin"),new Tn("viewDirection",({camera:T})=>pe(eP,be(eP,T.viewMatrix[12],T.viewMatrix[13],T.viewMatrix[14])))),v&&r.uniforms.add(new mr("ovWaterTex",T=>T.overlay?.getTexture(3)),new QM("view",({origin:T},{camera:w})=>rc(Q9,w.viewMatrix,T)));const b=.2;r.code.add(y`float lum(vec3 c) {
return (min(min(c.r, c.g), c.b) + max(max(c.r, c.g), c.b)) * 0.5;
}`),lc(r),P_(r),r.main.add(y`
          vec3 normal = normalize(vnormal);
          float vndl = dot(normal, mainLightDirection);

          float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl*2.5, 0.0, 1.0));
          float shadow = readShadow(additionalAmbientScale, vpos);
          float ssao = evaluateAmbientOcclusionInverse();
          vec4 tileColor = getTileColor();

          ${X(f,y`vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
                   vec4 overlayColor = overlayOpacity * overlayColorOpaque;
                   ${X(g,`if (overlayColor.a < ${y.float($s)}) { discard; }`)}
                   vec4 groundColor = tileColor;
                   tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;`)}

          // If combined alpha is 0 we can discard pixel. The performance impact by having a discard here
          // is neglectable because terrain typically renders first into the framebuffer.
          if(tileColor.a < ${y.float($s)}) {
            discard;
          }

          bool sliced = rejectBySlice(vpos);
          if (sliced) {
            tileColor *= ${y.float(b)};
          }

          vec3 albedo = tileColor.rgb;

          // heuristic shading function used in the old terrain, now used to add ambient lighting

          vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

          ${l===5||l===6?y`fragColor = vec4(evaluatePBRSimplifiedLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight, normalize(vpos - cameraPosition), vup), tileColor.a);`:y`fragColor = vec4(evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);`}
          ${X(v,y`vec4 overlayWaterMask = getOverlayColor(ovWaterTex, vtcOverlay);
                   float waterNormalLength = length(overlayWaterMask);
                   if (waterNormalLength > 0.95) {
                     mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);
                     vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);
                     vec4 viewPosition = view*vec4(vpos, 1.0);
                     vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - cameraPosition), shadow, vnormal, tbnMatrix, viewPosition.xyz,  vpos + localOrigin);
                     vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                     float opacity = sliced ? ${y.float(b)} : 1.0;
                     // un-gamma the ground color to mix in linear space
                     fragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w) * opacity;
                   }`)}
          ${X(s.visualizeNormals,d?y`
                  vec3 localUp = normalize(vpos + localOrigin);
                  vec3 right = normalize(cross(vec3(0.0, 0.0, 1.0), localUp));
                  vec3 forward = normalize(cross(localUp, right));
                  mat3 tbn = mat3(right, forward, localUp);
                  vec3 tNormal = normalize(normal * tbn);
                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);`:y`
                  vec3 tNormal = normalize(normal);
                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);`)}
          ${X(h,y`vec2 dVuv = fwidth(vuv0);
                 vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv0, 1.0 - vuv0));
                 float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);
                 fragColor = mix(fragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);`)}
          fragColor = applySlice(fragColor, vpos);`)}break;case 2:_&&e.include(Wu,s),i.main.add(y`
        ${X(_,"setOverlayVTC(uv0);")}
        gl_Position = transformPosition(proj, view, position);`),r.main.add(`${X(_,`if (getCombinedOverlayColor().a < ${y.float($s)}) discard;`)}`);break;case 4:case 5:case 6:case 7:case 8:e.include(c$,s),fL(e),gL(e),i.main.add(y`gl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);`),r.main.add(y`outputDepth(linearDepth);`);break;case 3:_&&e.include(Wu,s),n.add("vnormal","vec3"),mL(i),a(),i.main.add(y`
        ${X(_,"setOverlayVTC(uv0);")}
        gl_Position = transformPosition(proj, view, position);
        vnormal = normalize((viewNormal * vec4(getNormal(), 1.0)).xyz);`),r.main.add(y`
        ${X(_,`if (getCombinedOverlayColor().a < ${y.float($s)}) discard;`)}
        vec3 normal = normalize(vnormal);
        if (gl_FrontFacing == false) {
          normal = -normal;
        }
        fragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);`);break;case 9:f&&(e.include(Wu,s),e.include(xA,s)),i.main.add(y`
        ${X(f,"setOverlayVTC(uv0);")}
        gl_Position = transformPosition(proj, view, position);`),e.include(Mw,s),r.main.add(y`
        ${X(f,y`
           calculateOcclusionAndOutputHighlight(getAllOverlayHighlightValuesEncoded());`,"calculateOcclusionAndOutputHighlight();")}
      `)}if(o===10)if(f)s.pbrMode=0,e.include(Wu,s),s.pbrMode=l,i.main.add(y`gl_Position = transformPosition(proj, view, position);
setOverlayVTC(uv0);`),r.main.add(y`fragColor = getOverlayColorTexel();`);else{const v=m===0;i.main.add(y`${X(v,"gl_Position = transformPosition(proj, view, position);")}`),r.main.add(y`fragColor = vec4(0.0);`)}return e}const Q9=Ie(),eP=x(),Z9=Object.freeze(Object.defineProperty({__proto__:null,TerrainPassParameters:nx,build:CA},Symbol.toStringTag,{value:"Module"}));let X9=class extends ct{constructor(e,t){super(e,t,new ht(Z9,()=>k(()=>Promise.resolve().then(()=>ree),void 0)),eA.locations),this.type="TerrainTechnique",this.useStencil=!1}initializePipeline(e){return this._stencilPipelineState=this._createPipeline(e,!0),this._createPipeline(e,!1)}_createPipeline(e,t){const{renderOccluded:i,output:r}=e,n=e.backfaceCullingEnabled&&!i;return qe({blending:i?pu:null,culling:n?h$:null,depthTest:i?null:{func:513},depthWrite:i?null:xw,colorWrite:nt,stencilTest:t?bL(1):null,drawBuffers:xh(r)})}getPipeline(){return this.useStencil?this._stencilPipelineState:super.getPipeline()}},Ns=class extends T_{constructor(e){super(),this.spherical=e,this.overlayMode=0,this.tileBlendInput=0,this.transparencyMode=0,this.pbrMode=5,this.receiveShadows=!1,this.backfaceCullingEnabled=!1,this.textureFadingEnabled=!1,this.renderOccluded=!1,this.screenSpaceReflections=!1,this.cloudReflections=!1,this.receiveAmbientOcclusion=!1,this.tileBorders=!1,this.visualizeNormals=!1,this.normalType=1,this.textureCoordinateType=1,this.highStepCount=!1,this.useCustomDTRExponentForWater=!1,this.useFillLights=!1,this.hasColorTexture=!0,this.draped=!1}get overlayEnabled(){return this.overlayMode!==0}};u([V({count:3})],Ns.prototype,"overlayMode",void 0),u([V({count:3})],Ns.prototype,"tileBlendInput",void 0),u([V({count:4})],Ns.prototype,"transparencyMode",void 0),u([V({count:7})],Ns.prototype,"pbrMode",void 0),u([V()],Ns.prototype,"receiveShadows",void 0),u([V()],Ns.prototype,"backfaceCullingEnabled",void 0),u([V()],Ns.prototype,"textureFadingEnabled",void 0),u([V()],Ns.prototype,"renderOccluded",void 0),u([V()],Ns.prototype,"screenSpaceReflections",void 0),u([V()],Ns.prototype,"cloudReflections",void 0),u([V()],Ns.prototype,"receiveAmbientOcclusion",void 0),u([V()],Ns.prototype,"tileBorders",void 0),u([V()],Ns.prototype,"visualizeNormals",void 0);const Nv=7,Y9=10,Uv=Ka();let wr=class extends Wp{get visibleTiles(){return Array.from(this._visiblePatchesByOrigin.values()).flat()}get _isGlobal(){return this._stage.viewingMode===1}get _techniques(){return this._context.techniques}get _rctx(){return this._context.renderContext.rctx}constructor(e,t,i,r,n){super({}),this._overlayRenderer=e,this._stage=t,this._allTiles=i,this._compressionTracker=r,this.type=7,this.isGround=!0,this._passParameters=new nx,this._drawParameters=new DE,this._renderDataPool=new Do(()=>new $7),this._visiblePatchesByOrigin=new Map,this._allPatchesByOrigin=new Map,this._patchesByOriginDirty=!0,this._patchSortingDirty=!0,this._tileIterator=new IE,this._castShadows=!1,this._inViewshed=!1,this._cutFillEnabled=!1,this._tileRenderer=null,this._stencilEnabledLayerExtents=new Array,this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0,this.renderOccludedFlags=1,this.produces=new Map([[1,()=>this._produces()&&this.transparency===0],[6,()=>this._produces()&&(this.transparency===1||this.transparency===2)],[9,()=>this._produces()&&this.renderOccludedFlags===ep]]),this._tileSize=256,this._configuration=new Ns(t.viewingMode===1),this._tileTextureCache=new Xp((a,o)=>n.newCache(a,o),"TileTexture"),this.tileGeometryCache=new wW(n)}normalizeCtorArgs(){return{}}initialize(){this._stage.addRenderPlugin(this),this.addHandles($(()=>this._overlayRenderer.renderOccludedFlags,e=>{this.renderOccludedFlags=e,this.setNeedsRender()},Ae))}destroy(){this._stage.removeRenderPlugin(this),this._tileTextureCache.destroy(),this.tileGeometryCache.destroy(),this._allTiles.prune(),this._tileRenderer=null}_produces(){return this.visible&&!!this._rootTiles&&!this.renderingDisabled}consumes(){return this._overlayRenderer.hasWater?bB:CO}set renderingDisabled(e){this._set("renderingDisabled",!!e),this.setDirty()}set visible(e){this._set("visible",!!e),this.setDirty()}updateHeading(e){this._tileRenderer?.updateHeading(e)}set transparency(e){this._configuration.transparencyMode!==e&&(this._configuration.transparencyMode=e,this.setNeedsRender())}get transparency(){return this._configuration.transparencyMode}get renderPatchBorders(){return this._configuration.tileBorders}set renderPatchBorders(e){this._configuration.tileBorders!==e&&(this._configuration.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get visualizeNormals(){return this._configuration.visualizeNormals}set visualizeNormals(e){this._configuration.visualizeNormals!==e&&(this._configuration.visualizeNormals=e,this.setNeedsRender(),this.notifyChange("visualizeNormals"))}get cullBackFaces(){return this._configuration.backfaceCullingEnabled}set cullBackFaces(e){this._configuration.backfaceCullingEnabled!==e&&(this._configuration.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}get layerViewUid(){return Ao}get slicePlaneEnabled(){return this._configuration.hasSlicePlane}set slicePlaneEnabled(e){this._configuration.hasSlicePlane!==e&&(this._configuration.hasSlicePlane=e,this.setNeedsRender())}set textureFadingEnabled(e){this._configuration.textureFadingEnabled!==e&&(this._configuration.textureFadingEnabled=e,this.setNeedsRender())}set pbrMode(e){this._configuration.pbrMode!==e&&(this._configuration.pbrMode=e,this.setNeedsRender())}setRootTiles(e){this._rootTiles=e,this.setDirty()}setStencilEnabledLayerExtents(e){this._stencilEnabledLayerExtents=e,this._setSortingDirty()}set tileSize(e){this._tileSize=e,this._tileRenderer!=null&&(this._tileRenderer.tileSize=e),this.setDirty()}get tileSize(){return this._tileSize}_ensureRenderData(e){e.renderData||(e.renderData=this._renderDataPool.acquire(),e.renderData.init(e,this._getLocalOriginOfTile(e)))}loadTile(e){this._ensureRenderData(e),this.updateTileGeometryState(e),this.reuseTextureFromParent(e)||this.updateTileTexture(e,32)}reuseTextureFromParent(e){const t=e.parent;if(!t)return!1;const i=Si(1&e.lij[2]?.5:0,1&e.lij[1]?0:.5,.5,.5);return t.renderData?.reuseTexture(e.renderData,i)??!1}updateTileTexture(e,t){this._tileRenderer!=null&&(this._tileRenderer.updateTileTexture(e,t===32?0:2),this.setNeedsRender(),e.resetPendingUpdate(t))}updateTileGeometryState(e){for(const i of e.layerInfo[0])i.pendingUpdates&=-9;e.resetPendingUpdate(8);const t=e.renderData.updateGeometryState();return t&&this.setDirty(),t}updateGeometryIfNeeded(e){e.loaded&&e.renderData.updateGeometryIfNeeded(this._rctx)}unloadTile(e){const t=e.renderData;t&&(t.releaseGeometry(),this._renderDataPool.release(t),t.clear(),e.renderData=null,e.setMemoryDirty(),this.setDirty())}_getLocalOriginOfTile(e){const t=Y9-Nv,i=Math.max(0,Math.floor((e.level-t)/Nv)*Nv);if(this._isGlobal&&i===0)return ea;for(;e.parent&&e.level>i;)e=e.parent;return e.centerAtSeaLevel}getStats(){return{numTilesRendered:this._numTilesRendered,numTilesCulled:this._numTilesCulled,numOriginsRendered:this._numOriginsRendered}}set wireframe(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.setNeedsRender())}setDirty(e=1){this._patchesByOriginDirty=!0,this._context.requestRender(e)}_setSortingDirty(e=1){this._patchSortingDirty=!0,this._context.requestRender(e)}setNeedsRender(e=1){this._context.requestRender(e)}initializeRenderContext(e){this._context=e,this._tileRenderer=new v9(this._rctx,this._tileSize,this._techniques,this._tileTextureCache,this._compressionTracker),this.updateTileBackground()}uninitializeRenderContext(){this._tileRenderer=_e(this._tileRenderer)}intersect(e,t,i,r){if(!this._rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&this.transparency!==0)return;const n=K9,a=J9;he(n,r,i),be(a,1/n[0],1/n[1],1/n[2]);const o=e.results.min,l=e.results.max,c=e.results.ground,h=e.options.store===0,d=!!e.results.ground.target,m=wL(e.verticalOffset),f=e.tolerance;let g,_=h&&o.distance!=null?o.distance:1/0;const v=e.options,b=v.normalRequired||!v.backfacesTerrain,T=new Pw(f,!1,b),w=C=>{const P=C.renderData;if(!P?.vao)return;const M=P.geometry;pR(Uv,M.boundingBox);const O=P.localOrigin;m!=null&&(m.localOrigin=O,m.applyToAabb(Uv));const D=Uv;if(jc[0]=i[0]-O[0],jc[1]=i[1]-O[1],jc[2]=i[2]-O[2],!r$(D,jc,a,f,_))return;const A=(G,Ce,ue)=>{G.set(this.type,C,Ce,ue),_=h&&o.distance!=null?o.distance:1/0},F=(G,Ce,ue)=>{if((!b||ue!=null)&&G>=0&&(v.backfacesTerrain||We(ue,n)<0)&&(v.invisibleTerrain||!v.selectionMode||t==null||t(i,r,G))){if((c.distance==null||G<c.distance)&&A(c,G,ue),v.isFiltered)return;v.store===2&&(g==null?(g=new xR(e.ray),A(g,G,ue),e.results.all.push(g)):G<g.distance&&A(g,G,ue)),(o.distance==null||G<o.distance)&&A(o,G,ue),v.store!==0&&(l.distance==null||G>l.distance)&&A(l,G,ue)}},E=eQ;he(E,r,O);const{indices:z,indexCount:L}=M,I=M.vertexAttributes,ie=I.getField("position",g4),N=new yR(ie.typedBuffer,3,I.stride/4),se=L/3;if(!m&&se>x9){const G=C.renderData;G.intersectionData==null&&(G.intersectionData=new vA(z,0,se,N)),G.intersectionData.intersectRay(jc,E,T,F)}else xL(jc,E,0,se,z,N,m,T,F)},S=this._rootTiles;S!=null&&(()=>{const C=this._tileIterator;C.reset(S);const P=e.options.invisibleTerrain;for(let M=C.next();M;M=C.next())!(M.visible||P&&M.intersectsClippingArea)||m==null&&!M.intersectsRay(i,n,f,_)||d&&this._useStencilForTile(M)?C.skipSubtree():w(M)})()}processScaleRangeQueries(e,t){if(!t.done&&e)for(this._updatePatchGroups();e.updating&&!t.done;){e.prepare();for(const i of this._visiblePatchesByOrigin.values())for(const r of i)r.renderData?.textureReference!=null&&e.queriesForTile(r);e.process(),t.madeProgress()}}acquireTechniques(e){const t=!!Ze("enable-feature:terrain-shadows")&&e.bind.shadowMap.enabled;t!==this._castShadows&&(this._castShadows=t,this._patchesByOriginDirty=!0);const i=e.bind.viewshedEnabled;this._inViewshed!==i&&(this._inViewshed=i,this._patchesByOriginDirty=!0);const r=e.bind.cutFillEnabled;if(this._cutFillEnabled!==r&&(this._cutFillEnabled=r,this._patchesByOriginDirty=!0),e.bind.slot===9){if((e.renderOccludedMask&ep)===0)return null}else{const a=this.transparency===0?1:6;if(e.bind.slot!==a)return null}if(this.transparency===3)return null;const n=this._configuration;switch(n.screenSpaceReflections=n.cloudReflections=n.receiveShadows=n.receiveAmbientOcclusion=n.renderOccluded=n.hasHighlightMixTexture=!1,n.overlayMode=this._overlayRenderer.mode,e.output){case 0:case 1:{n.screenSpaceReflections=e.bind.ssr.lastFrameColor!=null,n.cloudReflections=e.bind.clouds.data!=null;const a=e.bind.slot===9;return n.receiveShadows=e.bind.shadowMap.ready&&!a,n.renderOccluded=a,n.receiveAmbientOcclusion=!a&&e.bind.ssao!=null,this._acquireTechnique(e.output)}case 4:case 6:return this._castShadows?this._acquireTechnique(4):null;case 7:return this._inViewshed?this._acquireTechnique(7):null;case 8:return this._cutFillEnabled?this._acquireTechnique(8):null;case 2:case 3:return this._acquireTechnique(e.output);case 10:return this._acquireTechnique(10);case 9:return n.hasHighlightMixTexture=e.bind.highlightMixTexture!=null,this._overlayRenderer.hasHighlights?this._acquireTechnique(9):null}return null}render(e,t){switch(this._updatePatchGroups(),t.useStencil=!1,this._passParameters.overlayContent=B9(e.output,e.bind),e.output){case 0:case 1:this._renderMaterialPass(e,t);break;case 2:case 3:case 10:this._renderAuxiliaryPass(e,t,this._visiblePatchesByOrigin);break;case 9:{const i=e.bind.highlight?.name;i&&this._overlayRenderer.hasHighlights&&this._overlayRenderer.renders(2)&&this._overlayRenderer.hasHighlight(i)&&this._renderAuxiliaryPass(e,t,this._visiblePatchesByOrigin);break}case 4:case 6:case 7:case 8:this._renderAuxiliaryPass(e,t,this._allPatchesByOrigin)}}updateTileBackground(e){if(this._tileRenderer==null)return;const t=this._tileRenderer;let i;if(e!=null){const r=vi.toUnitRGBA(e);i=Qe(r[0]||0,r[1]||0,r[2]||0)}t.setBackground(i),this._allTiles.forAll(r=>t.updateTileTexture(r,0)),this._configuration.tileBlendInput=t.backgroundIsGrid?2:t.backgroundColor!=null?1:0,this.setNeedsRender()}_updatePatchGroups(){if(this._patchesByOriginDirty&&(this._rebuildPatchGroups(),this._patchesByOriginDirty=!1,this._patchSortingDirty=!0),this._patchSortingDirty){const e=Array.from(this._visiblePatchesByOrigin.values()),t=this._stencilEnabledLayerExtents;for(const i of e)LE(i,t);e.sort((i,r)=>FE(i[0],r[0])),this._visiblePatchesByOrigin=new Map(e.map(i=>[i[0].renderData.localOrigin,i])),this.notifyChange("visibleTiles"),this._patchSortingDirty=!1}}_rebuildPatchGroups(){const e=this._rootTiles;if(e!=null){e[0]?.surface.checkAllTilesWaterproofness(),this._visiblePatchesByOrigin.clear(),this._allPatchesByOrigin.clear();for(const t of e)this._rebuildPatchGroupsForRootTile(t)}}_rebuildPatchGroupsForRootTile(e){const t=this._tileIterator;for(t.resetOne(e);!t.done;){const i=t.next(),r=i.renderData;if(!r){this._numTilesCulled++;continue}const n=r.localOrigin;if(this._castShadows||this._inViewshed||this._cutFillEnabled){let o=this._allPatchesByOrigin.get(n);o||(o=[],this._allPatchesByOrigin.set(n,o)),o.push(i)}if(!i.visible){this._numTilesCulled++,t.skipSubtree();continue}let a=this._visiblePatchesByOrigin.get(n);a||(a=[],this._visiblePatchesByOrigin.set(n,a)),a.push(i),t.skipSubtree()}}_useStencilForTile(e){for(const t of this._stencilEnabledLayerExtents)if(e.intersectsExtent(t))return!0;return!1}_renderAuxiliaryPass(e,t,i){const{rctx:r,bind:n}=e;r.bindTechnique(t,n,this._passParameters);const a=this._stencilEnabledLayerExtents.length>0;i.forEach(o=>{this._drawParameters.origin=o[0].renderData.localOrigin,t.program.bindDraw(n,this._passParameters,this._drawParameters);for(let l=0;l<o.length;l++)this._renderPatch(r,t,o[l],Ct.TRIANGLES,a,this._passParameters.overlayContent===null)}),r.bindVAO(null)}_renderMaterialPass(e,t){const{rctx:i,bind:r}=e;i.bindTechnique(t,r,this._passParameters),this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0;const n=t.program,a=this._stencilEnabledLayerExtents.length>0,o=r.slot===9;o&&(n.bindTexture("tex",i.emptyTexture),n.setUniform3fv("textureOpacities",ea),n.setUniform4fv("texOffsetAndScale",hi));const l=this._tileRenderer?.backgroundColor!=null?this._tileRenderer.backgroundColor:ea;this._configuration.tileBlendInput===1&&n.setUniform3fv("backgroundColor",l);const c=this.wireframe?Ct.LINES:Ct.TRIANGLES;this._configuration.textureFadingEnabled&&n.bindTexture("texNext",i.emptyTexture);const h=this._visiblePatchesByOrigin;for(const d of h.values()){const m=d[0].renderData.localOrigin;this._drawParameters.origin=m,t.program.bindDraw(r,this._passParameters,this._drawParameters),this._numOriginsRendered++;for(const f of d){const g=f.renderData,_=g.textureReference;if(_!=null){if(!o){n.setUniform4fv("texOffsetAndScale",_.offsetAndScale),n.bindTexture("tex",_.texture.texture);const v=g.textureFadeFactor,b=v<1?g.nextTextureReference:null;this._configuration.textureFadingEnabled&&b&&v<1?(n.setUniform1f("fadeFactor",v),n.setUniform4fv("nextTexOffsetAndScale",b.offsetAndScale),n.setUniform3fv("nextTexOpacities",b.opacities),n.bindTexture("texNext",b.texture.texture)):n.setUniform1f("fadeFactor",1),g.textureIsFading&&this.setNeedsRender(2),n.setUniform3fv("textureOpacities",_.opacities)}this._renderPatch(i,t,f,c,a),f.renderOrder=this._numTilesRendered,this._numTilesRendered++}}}i.bindVAO(null)}_renderPatch(e,t,i,r,n,a=!1){const o=i.renderData,l=o.vao,c=l?.indexBuffer;if(!l||c==null)return void(_i&&console.error("Rendered tile with no indices: ",i.lij," : ",o));const h=t.program;a||this._overlayRenderer.isEmpty||this._bindOverlayPatchData(h,o.overlay),n&&(t.useStencil=this._useStencilForTile(i),e.setPipelineState(t.getPipeline()));const d=o.geometry.indexCount;e.bindVAO(l),h.assertCompatibleVertexAttributeLocations(l),e.drawElements(r,d,c.indexType,0)}_bindOverlayPatchData(e,t){e.setUniform4fv("overlayTexOffset",t.offsets),e.setUniform4fv("overlayTexScale",t.scales)}_acquireTechnique(e){return this._configuration.output=e,this._techniques.get(X9,this._configuration)}get test(){}hasHighlight(e){return this._overlayRenderer.hasHighlight(e)}};u([p({readOnly:!0})],wr.prototype,"visibleTiles",null),u([p({readOnly:!0})],wr.prototype,"_isGlobal",null),u([p()],wr.prototype,"renderOccludedFlags",void 0),u([p({value:!1})],wr.prototype,"renderingDisabled",null),u([p({value:!0})],wr.prototype,"visible",null),u([p()],wr.prototype,"renderPatchBorders",null),u([p()],wr.prototype,"visualizeNormals",null),u([p()],wr.prototype,"cullBackFaces",null),u([p()],wr.prototype,"wireframe",null),wr=u([R("esri.views.3d.terrain.TerrainRenderer")],wr);const K9=x(),J9=x(),jc=x(),eQ=x();let tQ=class{constructor(){this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array}},Gn=class extends te{constructor(e){super(e)}initialize(){this.addHandles([this.layers.on("change",()=>this._update()),$(()=>this.extentHelper.layerViewsExtent,()=>this._setAdHocTilingScheme())]),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._waitTask=null,this.layers.destroy()}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this.layers.some(t=>!(!Bh(t)||t.isRejected())&&!(t.isFulfilled()&&!iQ(t,this.viewSpatialReference,this.viewingMode))&&(e=t,!(t?.type==="vector-tile"||d_(t)))),e)if(e.isResolved()){const t=Q_(e,this.viewSpatialReference,this.viewingMode);if(t!=null){const i=new un(t.tileInfo);this._lockTilingScheme(i)}}else this._updateWhen(e)}_updateWhen(e){const t=e.when().catch(()=>{}).then(()=>{t!==this._waitTask||this.destroyed||this._update()});this._waitTask=t}_lockTilingScheme(e){if(this.viewingMode===1){const t=e.levels.length-1,i=e.spatialReference;i.isWebMercator?e=un.makeWebMercatorAuxiliarySphere(t):I1(i)&&(e=un.makeGCSWithTileSize(e.spatialReference,e.pixelSize,t))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this.removeAllHandles(),this.addHandles($(()=>this.extentHelper.tiledLayersExtent,()=>this._updateTiledLayerExtent()))}_updateTiledLayerExtent(){this._set("extent",this.extentHelper.tiledLayersExtent)}_setAdHocTilingScheme(){if(this.viewingMode===1){const e=this.extentHelper.viewSpatialReference;e.isWebMercator?this.tilingScheme=un.WebMercatorAuxiliarySphere:nE(e)&&(this.tilingScheme=un.makeGCSWithTileSize(e,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{const e=this.extentHelper.layerViewsExtent;e==null||ql(e,this.extent)||(this.tilingScheme=un.fromExtent(e,this.extentHelper.viewSpatialReference),this._set("extent",e))}}get test(){}};function iQ(s,e,t){return Q_(s,e,t)!=null}u([p()],Gn.prototype,"tilingScheme",void 0),u([p({readOnly:!0})],Gn.prototype,"extent",void 0),u([p({value:!1})],Gn.prototype,"tilingSchemeLocked",void 0),u([p({constructOnly:!0})],Gn.prototype,"viewSpatialReference",void 0),u([p({constructOnly:!0})],Gn.prototype,"layers",void 0),u([p({constructOnly:!0})],Gn.prototype,"extentHelper",void 0),u([p({constructOnly:!0})],Gn.prototype,"viewingMode",void 0),Gn=u([R("esri.views.3d.terrain.TilingSchemeLogic")],Gn);let sQ=class{constructor(){this._offset=ke(),this.scale=0}get offset(){return this._offset}init(e,t,i,r){this.tile=e,this._offset[0]=t,this._offset[1]=i,this.scale=r}dispose(){this.tile=null,this._offset[0]=0,this._offset[1]=0,this.scale=0}},rQ=class{constructor(){this._pendingCompressionTasks=rs(0)}get compressing(){return!!this._pendingCompressionTasks.value}increment(){this._pendingCompressionTasks.value++}decrement(){this._pendingCompressionTasks.value--}};var pg;let xe=class extends fu{static{pg=this}get allTiles(){return Jl(this._allTiles)}get renderedTiles(){return LE(yw(this._allTiles.toArray(),s=>s.visible&&s.rendered))}get demResolution(){const{_allTiles:s,tilingScheme:e}=this;if(s.length===0)return{min:1,max:1};const t=Wh(e.spatialReference);let i=Number.POSITIVE_INFINITY,r=Number.NEGATIVE_INFINITY;for(const n of s){const a=e.resolutionAtLevel(n.level)*t;i=Math.min(i,a),r=Math.max(r,a)}return{min:i,max:r}}constructor(s){super(s),this.terrainTextureCompressionTracker=new rQ,this._iteratorPool=new Do(()=>new IE,t=>t.remove=()=>this._iteratorPool.release(t)),this._postorderIterator=new v7,this._hasPendingUpdates=!1,this._pendingUpdates=0,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._usedMemory=null,this._performanceInfo=new tQ,this._viewChanged=!1,this.heading=0,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._eyePosRenderSR=x(),this._eyePosSurfaceSR=x(),this._splitLimits=new nn,this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._watchUpdatingTracking=new hc,this._frameTask=mp,this._allTiles=new zt,this._upsampleInfoPool=new Do(()=>new sQ),this._shouldEmitChangeEvent=!1,this._rootTilesExtent=Mt(),this.updatingProgress=.5,this._maxNumUpdating=1,this.maxTextureScale=1.2,this._spatialReference=Dt.WebMercator,this._elevationProjectorCache=new Map,this.visibleElevationBounds=new Lh(1/0,-1/0),this.rootTileElevationBounds=new Lh(1/0,-1/0),this._projectorCache=new Map,this._tilingSchemeSpatialReference=null,this._updatingRootTiles=!1,this._pendingTilesForElevationUpdateEvent=new Set,this._pendingTilesToUpdate=new Set,this.totalGeometryUpdates=0,this.totalTileUpdates=0,this._oneBatchPerFrameTask=!0,this._layerViewsDirty=!1,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._isWebMercator=!1,this._isWebMercatorOnPlateCarree=!1,this.enabled=!0;const{view:e}=s;this.overlayManager=new bs({...s,terrainSurface:this}),this._isGlobal=!e.state?.isLocal,this._isGeographic=this._spatialReference?.isGeographic??!1,this._tileConstructor=this._isGlobal?vW:fW,this._ellipsoid=Zt(e.spatialReference),this._renderer=new wr(this.overlayManager.renderer,e.stage,this._allTiles,this.terrainTextureCompressionTracker,e.resourceController.memoryController),$f()||(this._scaleRangeQueries=new dg)}initialize(){const{view:s}=this,{resourceController:e}=s,{memoryController:t}=e;this._tileCache=new Xp((l,c)=>t.newCache(l,c),"terrain-tile"),this._upsampleMapCache=t.newCache("terrain-upsample",({tile:l})=>l.unloadMapData()),this._elevationQueryCache=new uj(t.newCache("elevation-query"));const i=this.overlayManager;this.addHandles([$(()=>i.renderer.isEmpty,()=>this._evaluateTransparency()),$(()=>this.renderer.visible,l=>this.suspended=!l),$(()=>this.heading,l=>{this._renderer.updateHeading(l),this._updateTileTextures(0)}),$(()=>({heading:s.camera?.heading,state:s.state?.mode}),({heading:l,state:c})=>{if(l==null)return;if(this.isGlobal&&this.isGeographic||this.isWebMercatorOnPlateCarree)return void(this.heading=90*Math.round(l/90)%360);const h=Math.round(l)%360,d=Math.abs(h-this.heading);(c===2||Math.min(d,360-d)>=30)&&(this.heading=h)})],"overlayManager"),this.addHandles([$(()=>this.baseOpacity,()=>{this._handleLayerViewChanges(),this._updateTileTextures(this._evaluateTransparency()?1:2)},Ve),$(()=>this.hasCompositeBlendMode,()=>this._updateTileTextures(this._evaluateTransparency()?1:2),Ve),$(()=>this.backgroundColor,(l,c)=>{l?.equals(c)||(this._handleLayerViewChanges(),this._renderer.updateTileBackground(l))},Ae),$(()=>this.snapLevel,()=>this._viewChanged=!0,Ae),$(()=>this.view.pointsOfInterest,l=>{this._renderer.pointsOfInterest=l,this._watchUpdatingTracking.removeAll(),l&&this._watchUpdatingTracking.add(()=>l.focus?.renderLocation,()=>this._allTilesSorted=!1,{equals:qo})}),$(()=>yi.TERRAIN_TILE_TREE_SHOW_TILES,l=>{l&&!this._treeDebugger?k(async()=>{const{TerrainTileTree3DDebugger:c}=await import("./TerrainTileTree3DDebugger-BhGK6rP1.js");return{TerrainTileTree3DDebugger:c}},__vite__mapDeps([466,1,2,19,9,7,8,5,6,20,14,467,13,26,3,4,10,11,12,15,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44])).then(({TerrainTileTree3DDebugger:c})=>{!this._treeDebugger&&yi.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new c({view:s}))}):l||(this._treeDebugger=Q(this._treeDebugger))},Re)]);const{spatialReference:r}=s;this._extentHelper=Ij(this.viewingMode,{layers:s.map.allLayers,layerViews:s.allLayerViews,viewSpatialReference:r});const n=new U$({getCollections:()=>s.defaultsFromMap?.mapCollections?.map(({layers:l})=>l),getChildrenFunction:l=>l&&"layers"in l?l.layers:null}),a=new Gn({layers:n,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:r});this._set("tilingSchemeLogic",a),this._updateTilingScheme(),this._elevationDataRequester=e.createStreamDataRequester(0),this._mapDataRequester=e.createStreamDataRequester(1);const o=e.scheduler;this._frameTask=o.registerTask(di.TERRAIN_SURFACE,this),this.addHandles([$(()=>this._extentHelper.stencilEnabledExtents,l=>this._renderer.setStencilEnabledLayerExtents(l),Re),$(()=>this.tilingSchemeLogic.tilingScheme,()=>this._updateTilingScheme(),Ae),$(()=>this.extent,()=>this._updateRootTiles(),Re),s.on("resize",()=>this._viewChangeUpdate()),$(()=>{const l=s.state;return[this._lodBias,this.lodSnappingEnabled,s.quality,l.camera,l.contentCamera,l.fixedContentCamera]},()=>this._viewChangeUpdate(),Ve),$(()=>s.qualitySettings?.fadeDuration,l=>this._renderer.textureFadingEnabled=l>0,Re),$(()=>s.qualitySettings?.physicallyBasedRenderingEnabled,l=>this._renderer.pbrMode=l?5:0,Re),$(()=>s.qualitySettings?.tiledSurface.elevationLevelDelta,()=>this._updateAllTileGeometries()),$(()=>this._userClippingExtent,()=>this._updateClippingExtent(),Ae)]),this.addHandles(s.allLayerViews.on("after-changes",()=>this._layerViewsDirty=!0)),this._layerViewsDirty=!0,this._handleLayerViewChanges(),this._renderer.updateTileBackground(this.backgroundColor)}clearHandles(){this._watchUpdatingTracking?.removeAll(),this.removeAllHandles(),this._basemapLayerViewHandles.forEach((s,e)=>this._unregisterTiledLayerView(e)),this._basemapLayerViewHandles.clear()}destroy(){this._frameTask.remove(),this._frameTask=mp,this._watchUpdatingTracking?.destroy(),this._removeAllTiles(),this._set("tilingSchemeLogic",Q(this.tilingSchemeLogic)),this._basemapLayerViewHandles.forEach((s,e)=>this._unregisterTiledLayerView(e)),this._basemapLayerViewHandles.clear(),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",Q(this.overlayManager)),this._tileCache=Q(this._tileCache),this._allTiles.prune(),Z1.prune(),this._treeDebugger=Q(this._treeDebugger),this._renderer.destroyed||this._renderer.destroy(),this._renderer=null,this._iteratorPool=Q(this._iteratorPool),this._upsampleMapCache=Q(this._upsampleMapCache),this._elevationQueryCache=Q(this._elevationQueryCache),this._set("view",null),this._extentHelper=Q(this._extentHelper),this._upsampleInfoPool=Q(this._upsampleInfoPool),B7(),this._layerViews.forEach(s=>s.length=0),this._performanceInfo=null}get renderer(){return this._renderer}get frustum(){return this.view.state.camera.frustum}get snapLevel(){return this.lodSnappingEnabled?this.view.terrainLevel:null}get lodSnappingEnabled(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get hasStencilEnabledExtents(){return this._extentHelper.stencilEnabledExtents.length>0}get _userClippingExtent(){const{spatialReference:s}=this,e=this.view?.clippingArea;if(e==null||s==null)return null;const t=Mt(),i=dj(e,t,s)?t:null,r=this._get("extent");return ql(i,r)?r:i}get rootTilesExtent(){return this._rootTilesExtent}get extent(){const s=R0(this.groundExtent,this._userClippingExtent,Mt()),e=this._get("extent");return ql(s,e)?e:s}get groundExtent(){return this._tilingSchemeExtent!=null?this._tilingSchemeExtent:this._rootTilesExtent}get _tilingSchemeExtent(){return this.tilingSchemeLogic?.extent}get updating(){return this._hasPendingUpdates||(this._maxNumUpdating=1),this.enabled&&!!((this.readyToRun||this._watchUpdatingTracking?.updating||this._asyncWorkItems>0)&&this.ready&&!this.suspended||this.overlayManager?.updating||this.terrainTextureCompressionTracker.compressing)}get readyToRun(){return this.enabled&&(this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||!this._allTilesSorted||this._layerViewsDirty||this._scaleRangeQueries?.updating||this._frameTask.updating)&&this.ready&&!this.suspended}get updatingProgressValue(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}get baseOpacity(){return this.view?.map?.ground?.opacity??1}set baseOpacity(s){this.view.map.ground.opacity=s}get viewingMode(){return this.view.state.viewingMode}get ready(){return!this.enabled||this._rootTiles!=null}get rootTiles(){return this._rootTiles}get spatialReference(){return this.tilingScheme?.spatialReference??null}get backgroundColor(){return this.view?.map?.ground?.surfaceColor}set backgroundColor(s){this.view.map.ground.surfaceColor=s}set slicePlaneEnabled(s){this._renderer.slicePlaneEnabled=s,this._set("slicePlaneEnabled",s),this._evaluateTransparency()}get tilingSchemeLocked(){return this.tilingSchemeLogic?.tilingSchemeLocked??!1}get wireframe(){return this._renderer?.wireframe}set wireframe(s){s!==this._renderer.wireframe&&(this._renderer.wireframe=s,this._updateAllTileGeometries())}get opaque(){return this._renderer.transparency===0}get invisible(){return this._renderer.transparency===3}set suspended(s){this._set("suspended",s),this._viewChangeUpdate()}get fadeDuration(){return this.view.qualitySettings.fadeDuration??0}intersect(s,e,t,i){this._renderer.intersect(s,e,t,i)}getElevationLevelDelta(s){return s<4?3:this.view.qualitySettings.tiledSurface.elevationLevelDelta}get _xNormalizer(){return H$(this._spatialReference)}getElevation(s,e,t,i){const r=this._rootTiles;if(!r?.length||!this.enabled||r[0].layerInfo[0].length===0)return null;let n=this._elevationProjectorCache.get(i);if(n===void 0&&(n=Yx(i,this._spatialReference)??null,this._elevationProjectorCache.set(i,n)),n==null)return j.getLogger(this).error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;const a=be(Qu,s,e,t);return n(a,0,a,0),iP(r,this._xNormalizer?.normalize(a[0])??a[0],a[1])}getElevations(s,e,t){const i=this._rootTiles,r=i?i[0].layerInfo[0].length:0;if(i?.length&&r!==0&&this.enabled)for(let n=0;n<e;++n){const a=3*n;t(n,iP(i,s[a],s[a+1]))}else for(let n=0;n<e;++n)t(n,null)}getLayerIndexByUID(s,e){return this._layerIndexByUid[s].get(e)}getScale(s){if(!this.tilingScheme)return null;if(!Na(s,Qu,this.spatialReference))return j.getLogger(this).error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;const e=this._rootTiles;if(e!=null){for(const t of e)if(t?.containsPoint(Qu)){let i=t;for(;i.children[0]&&!i.rendered;){const r=i.children[0].extent;let n=0;Qu[0]>r[2]&&(n+=1),Qu[1]<r[1]&&(n+=2),i=i.children[n]}return this._getLodBiasCorrectedScale(i.level)}}return 1/0}_ensureProjector(s){const e=this._projectorCache.get(s);if(e)return e;const t=Yx(s,this._tilingSchemeSpatialReference)??null;return this._projectorCache.set(s,t),t}getSphereElevationBounds(s,e){if(!this.enabled||this._rootTiles==null)return null;const t=this._ensureProjector(e);if(t==null)return j.getLogger(this).error("TerrainSurface.getSphereElevationBounds(): could not project given point to tiling scheme coordinate system"),null;wV(s,Wc);const i=fp(Wc,x());t(i,0,i,0),jw(Wc,i);const r=new c_,n=this._rootTiles;if(n!=null){const a=[];for(const l of n)a.push(l);let o=0;for(;o<a.length;){const l=a[o];if(++o,!Jx(l.extent,Wc))continue;const c=l.children;if(c[0]==null||l.rendered)r.expandElevationRangeValues(l.elevationBoundsMin,l.elevationBoundsMax);else for(const h of c)a.push(h)}}return r}getRootElevationBounds(){return this.enabled&&this._rootTiles!=null?new c_(this.rootTileElevationBounds.min,this.rootTileElevationBounds.max):null}getLowerBoundRadius(){const s=(this._ellipsoid.radius+this.visibleElevationBounds.min)*S$;return Math.min(s,this._ellipsoid.radius)}getSphereScale(s,e){if(!this.tilingScheme)return null;if(!Na(s,rP,this.spatialReference))return j.getLogger(this).error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;nR(Wc,rP,e);let t=null;const i=n=>{if(n&&Jx(n.extent,Wc)){const a=n.children;if(a[0]&&!n.rendered)for(const o of a)i(o);else{const o=this._getLodBiasCorrectedScale(n.level);t=t==null?o:Math.min(t,o)}}},r=this._rootTiles;if(r!=null)for(const n of r)i(n);return t}queryVisibleScaleRange(s,e,t,i){if(!this._scaleRangeQueries)return;const r=e?this.tilingScheme.levelAtScale(e):0,n=t?this.tilingScheme.levelAtScale(t):1/0,a=this._lodBias;this._scaleRangeQueries.queryVisibleLevelRange(s,r+a,n+a,i)}_evaluateTransparency(){const s=this.baseOpacity,e=this.overlayManager.renderer.isEmpty,t=this._renderer.transparency,i=this._isFullyTransparent?e?3:2:s>=1&&!this.hasCompositeBlendMode&&!this._renderer.slicePlaneEnabled?0:1;return this._renderer.transparency=i,t!==i}_updateTilingScheme(){const{tilingScheme:s}=this.tilingSchemeLogic;if(s===this.tilingScheme)return;xi(!!s,"tiling scheme cannot be reset to undefined"),this._isGlobal=!this.view?.state?.isLocal,this.tilingScheme&&this._removeAllTiles();const e=s?.spatialReference??Dt.WebMercator;this._spatialReference=e,this._isWebMercator=!!e?.isWebMercator,this._isWebMercatorOnPlateCarree=this._isWebMercator&&T$(this.view?.renderSpatialReference),this._isGeographic=e?.isGeographic??!1,this._set("tilingScheme",s),this._tilingSchemeSpatialReference=this.tilingScheme?.spatialReference,this._projectorCache.clear(),this._updateClippingExtent(),s&&(this._updateTiledLayers(),this._renderer.tileSize=s.pixelSize,this.overlayManager.spatialReference=s.spatialReference,this._updateRootTiles())}static{this._tileMemcacheKey="TerrainTileMemcache"}_acquireTile(s,e,t,i){const r=this._tileCache.pop(pg._tileMemcacheKey);return r?(r.init(s,e,t,i,this),r):new this._tileConstructor(s,e,t,i,this)}get updatingRootTiles(){return this._updatingRootTiles}_updateRootTiles(){const{extent:s,tilingScheme:e}=this;if(!e)return;const t=nQ;let i=e.rootTilesInExtent(s,t,5*Ch);if(this._rootTiles!=null){if(i.length>Ch)return void j.getLogger(this).warn(Lz);const r=this._rootTiles.map(a=>a.lij),n=v0(r,i,hg);if(this._updatingRootTiles=!0,n.removed.length>0||n.added.length>0){const a=this._rootTiles.filter(o=>!(n.removed.findIndex(l=>hg(l,o.lij))>-1)||(this._purgeTile(o),!1));n.added.forEach(o=>a.push(this._newRootTile(o))),this._setRootTiles(a)}}else this._updatingRootTiles=!0,i.length>Ch&&(j.getLogger(this).warn(Fz),i=e.rootTilesInExtent(s,t,Ch)),this._setRootTiles(i.map(r=>this._newRootTile(r)));ql(t,this._rootTilesExtent)||(this._rootTilesExtent=Mt(t)),this.renderer.visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready"),this._updateAllTileGeometries(),this._updatingRootTiles=!1,this.checkAllTilesWaterproofness()}_updateAllTileGeometries(){const s=this._allTiles.filter(e=>e.loaded&&e.intersectsClippingArea);s.sort(Jn),s.forEach(e=>this._renderer.updateTileGeometryState(e)),s.forEach(e=>e.renderData.updateNeighborData()),this._updateTilesGeometries(s),this._pendingTilesToUpdate.clear()}_updateTilesGeometries(s){if(s.length===0)return;s.sort(Jn);const e=this.renderer;s.forEach(t=>e.updateGeometryIfNeeded(t)),s.forEach(t=>this._pendingTilesForElevationUpdateEvent.add(t))}_shouldSplit(s){return s.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.snapLevel)===1}_newRootTile(s){const e=this._acquireTile(0,s[1],s[2],null);return this._shouldSplit(e)&&e.setPendingUpdate(1),this._loadTile(e),this._markTileToUpdate(e),this._updateRootTileElevationBounds(),e}_setRootTiles(s){if(this._rootTiles=s,this._allTiles.clear(),s!=null){const e=this._iteratorPool.acquire();for(e.reset(s);!e.done;)this._allTiles.push(e.next());e.remove()}this._renderer.setRootTiles(this._rootTiles),this._updateTilesVisibility(s),this.notifyChange("demResolution"),this.emit("tiles-changed",{allTiles:this.allTiles})}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}_viewChangeUpdate(){this.view&&!this.suspended&&this.tilingScheme&&this.renderer.visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateTilesVisibility(this._rootTiles)))}_updateClippingStatus(s){s.updateClippingStatus(this.extent)&&s.resetPendingUpdate(8)&&this._updateTileGeometryState(s)}_updateTilesVisibility(s){if(s==null)return;const e=M7(s),t=this.visibleElevationBounds;let i=e?t.min:1/0,r=e?t.max:-1/0;const n=this.extent,a=this.view.state.contentCamera.viewProjectionMatrix;this.setTileTreeDirty();const o=this._iteratorPool.acquire();for(o.reset(s);!o.done;){const l=o.next();l.updateClippingStatus(n)&&l.resetPendingUpdate(8)&&this._updateTileGeometryState(l),l.computeVisibility(),l.updateScreenDepth(a),l.renderData&&(i=Math.min(l.elevationBoundsMin,i),r=Math.max(l.elevationBoundsMax,r))}o.remove(),this._viewChanged=!0,this._allTilesDirty=!0,this._updatePendingTileGeometries(),isFinite(i)&&isFinite(r)&&(t.min!==i||t.max!==r)&&(this.visibleElevationBounds=new Lh(i,r))}_updateRootTileElevationBounds(){let s=1/0,e=-1/0;const t=this._rootTiles;t?.forEach(({elevationBoundsMin:r,elevationBoundsMax:n})=>{s=Math.min(s,r),e=Math.max(e,n)});const i=this.rootTileElevationBounds;i.min===s&&i.max===e||(this.rootTileElevationBounds=new Lh(s,e))}_updateViewDependentParameters(){const{camera:s,contentCamera:e}=this.view.state,t=Math.tan(.5*e.fovX),i=Math.tan(.5*e.fovY),r=this.tilingScheme.pixelSize,n=2**-this._lodBias*s.pixelRatio;this._splitLimits.aboveGround=s.aboveGround,this._splitLimits.fovX=t,this._splitLimits.fovY=i,this._splitLimits.relativeWidthLimit=r/s.width*this.maxTextureScale*n,this._splitLimits.relativeHeightLimit=r/s.height*this.maxTextureScale*n,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?this._splitLimits.frustum=QV(this._splitLimits.frustum??ZV(),e.frustum):this._splitLimits.frustum=null,q(this._eyePosRenderSR,e.eye),zo(s.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}_updateTileGeometryState(s){s.updateVisibility(),this._renderer.updateTileGeometryState(s)&&this._markTileToUpdate(s),this.setMemoryDirty()}_markAllTileNeighborsForUpdate(s){s.forEachLoadedNeighbor(e=>{this._layerViews[1].some(lu)&&e.setPendingUpdate(32),this._pendingTilesToUpdate.add(e)})}_updateTileTexture(s,e){const t=s.resetPendingUpdate(32)?32:!!s.resetPendingUpdate(16)&&16;t&&(this._renderer.updateTileTexture(s,t),this._usedMemory=null,e.madeProgress())}_emitElevationUpdateEventForTiles(){if(!this._shouldEmitChangeEvent)return;const s=Hv.extent;Fo(s),this._pendingTilesForElevationUpdateEvent.forEach(e=>zh(s,e.extent,s)),this._pendingTilesForElevationUpdateEvent.clear(),Hv.spatialReference=this.spatialReference,this.emit("elevation-change",Hv),this._shouldEmitChangeEvent=!1}runTask(s){this._handleLayerViewChanges(s),this._frameTask.processQueue(s),this.renderer.processScaleRangeQueries(this._scaleRangeQueries,s),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateAllTilesStatus(s),this._sortTiles(s);const e=!this.view.state.fixedContentCamera;if(this._mergeAndSplit(s,e),this._updateElevation(s),this._updateTextures(s),e||this._mergeAndSplit(s,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),this._updatePendingTileGeometries(),this._emitElevationUpdateEventForTiles(),s.done&&s.hasProgressed&&this.requestUpdate(),this.notifyChange("updatingProgressValue"),_i&&this._checkTileInvariant(),!s.hasProgressed)return Ai}_checkTileInvariant(){const s=new Map;this._allTiles.forAll(e=>s.set(e,new Set)),this._allTiles.forAll(e=>{if(xi(e.rendered===e.leaf,` rendered ${e.rendered} != ${e.leaf} leaf`),!e.leaf){const t=r=>r.unmergableChildCount===0&&r.maxLevelDeltaNeighborCount===0,i=e.children.reduce((r,n)=>r+(t(n)?0:1),0);if(xi(e.unmergableChildCount===i,` Tile[${e.lij.toString()}] unmergeable child count mismatch: actual ${e.unmergableChildCount} vs ${i}`),e.hasPendingUpdate(4)){xi(!e.hasPendingUpdate(1),"Tile can be both split and merge at the same time");for(const r of e.children)xi(r.leaf||r.hasPendingUpdate(4),"Child of tile to merge must also merge")}}for(let t=0;t<4;++t){if(e.rendered){const a=e.renderData?.geometryState.edgePeerNeighbors[t];if(a!=null){{const o=e.level-a.level<=li;o||(console.log(`tile level delta [${e.lij.toString()}] vs [${a.lij.toString()}] > ${li}  (edge[${t}])`),xi(o,`tile level delta [${e.level}] vs [${a.level}] > ${li}`))}xi(e.level-a.level<=li,`Max tile lod delta exceeded: [${e.lij.toString()}] vs [${a.lij.toString()}]`)}}const i=e.level-li,r=a=>a.leaf||a.level===e.level,n=e.findNeighborTile(wn[t],r);if(n!=null){if(e.leaf&&e.level>=li){let a=n;for(;e.level-a.level<li;)a=a.parent;const o=[i,e.lij[1]>>li,e.lij[2]>>li];if(!hg(o,a.lij)){const l=s.get(a);xi(!l.has(e),"Cannot already have neighbor"),l.add(e)}}xi(n.rendered||n.level===e.level,"Non-same-level-neighbor of rendered must be rendered"),xi(e.level-n.level<=li,`Tile level delta [${e.level}] vs [${n.level}] > ${li}`)}}}),this._allTiles.forAll(e=>{const t=e.maxLevelDeltaNeighborCount,i=s.get(e);xi(t===i.size,`Tile[${e.lij.toString()}] merge-blocker mismatch: actual ${t} vs ${i.size}`)})}_updateAllTilesStatus(s){if(!this._viewChanged||!this._rootTiles||s.done)return;this._viewChanged=!1;const e=new gW(this._allTiles.length);e.pushAll(this._rootTiles);const t=this.snapLevel,i=this._splitLimits,r=this._eyePosRenderSR;this._allTiles.forAll(a=>{a.maxLevelDeltaNeighborCount=0,a.unmergableChildCount=0});const n=this.view.state.contentCamera.viewProjectionMatrix;for(;!e.empty;){const a=e.pop(),o=a.parent,l=o?.hasPendingUpdate(4),c=l?4:a.shouldSplit(i,r,t),h=c===1;a.leaf?qv(a,h):e.pushAll(a.children),l?(a.resetPendingUpdate(1),a.leaf||a.setPendingUpdate(4),this._updateClippingStatus(a),a.updateVisibility(),a.updateScreenDepth(n)):h?(a.resetPendingUpdate(4),a.leaf&&a.setPendingUpdate(1)):(a.resetPendingUpdate(1)&&a.updateAgentSuspension(),c===2&&a.updateAgents(0),a.leaf||(a.setPendingUpdate(4),a.resetPendingUpdate(1)))}this.requestUpdate(),(this._shortBatches||!this._oneBatchPerFrameTask)&&this._updatePendingTileGeometries(),s.madeProgress()}_sortTiles(s){s.done||this._allTilesSorted||!this.view.pointsOfInterest?.focus||(S7(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger?.update(),s.madeProgress())}_markTileToUpdate(s){B(s.loaded),s.intersectsClippingArea&&(this._pendingTilesToUpdate.add(s),this._markAllTileNeighborsForUpdate(s))}_updatePendingTileGeometries(){const s=this._pendingTilesToUpdate,e=Array.from(s.keys()).filter(r=>r.loaded&&r.intersectsClippingArea);if(e.length===0)return void s.clear();const t=(r,n)=>{!n?.loaded||!n.intersectsClippingArea||n.level<r.level||s.has(n)||(s.add(n),e.push(n),n.renderData.updateNeighborData())};e.sort(Jn);const i=e.length;for(let r=0;r<i;++r){const n=e[r];B(n.loaded),B(n.intersectsClippingArea);const a=n.renderData;a.updateNeighborData();const o=a.dirtyEdgeResolutions,l=a.geometryState,c=h=>{const d=m_[h];t(n,l.cornerPeerNeighbors[h]?.findCorner(p_(d),m=>m.loaded))};for(let h=0;h<4;++h)if(o&1<<h){const d=a.geometryState.edgePeerNeighbors[h];d&&d?.level>=n.level&&d.forAllSubtreeOnSide(F1(wn[h]),m=>!(!m.loaded||!m.intersectsClippingArea)&&(B(s.has(m)||Jn(n,m)<0),t(n,m),!0)),c((h+1)%4),c(h)}}s.clear(),this._updateTilesGeometries(e),this._shouldEmitChangeEvent=!0,_i&&u_&&this.checkAllTilesWaterproofness()}_mergeAndSplit(s,e){if(this.suspended||s.done||!this._allTilesDirty)return;this._allTilesDirty=!1,this.requestUpdate();let t=!1;const i=this.view.state.fixedContentCamera;let r=!1;for(;!s.done;){r=!0;let n=!1;const a=!this._allTiles.some(o=>{if(!t&&!i&&!o.visible)return s.done;let l=o;if(o.hasPendingUpdate(4)){if(!e||o.unmergableChildCount>0)return s.done;for(o.resetPendingUpdate(4);l.parent!=null&&l.parent.unmergableChildCount===0&&l.parent.resetPendingUpdate(4);)l=l.parent;this._mergeTile(l),n=!0,s.madeProgress()}else if(o.resetPendingUpdate(1)){let c=!0;const h=o.level;if(h>=li){const d=m=>m.leaf||h-m.level<li;for(let m=0;m<4;++m){const f=o.findNeighborTile(wn[m],d);f!=null&&h-f.level===li&&(c=!1,_i&&(B(f.leaf),B(f.hasPendingUpdate(1))))}}c?(this._splitTile(o),s.madeProgress(),n=!0):o.setPendingUpdate(1)}return s.done});if(n&&(this._allTilesSorted=!1,this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries()),a){if(!t){t=!0;continue}if(!n)break}else this._allTilesDirty=!0}r?s.madeProgress():this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries(),this._sortTiles(s)}_updateElevation(s){s.done||(this._allTiles.some(e=>(e.resetPendingUpdate(8)&&(this._updateTileGeometryState(e),this._shortBatches&&this._updatePendingTileGeometries(),s.madeProgress()),s.done)),!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries())}_updateTextures(s){s.done||this._allTiles.some(e=>(this._updateTileTexture(e,s),s.done))}_updateClippingExtent(){this.spatialReference&&(this.updateOverlayParameters(),this.requestRender(1),this.overlayManager.setPlacementDirty(),this._updateRootTiles())}get _lodBias(){const s=this.view.quality;return this.view.qualitySettings.tiledSurface.lodBias-(1-s)*Az}_getLodBiasCorrectedScale(s){const e=this.tilingScheme.levels,t=U(s-this._lodBias,0,e.length-1),i=t-Math.floor(t);return e[Math.floor(t)].scale*(1-i)+e[Math.ceil(t)].scale*i}_removeAllTiles(){this._rootTiles!=null&&(this._rootTiles.forEach(s=>this._purgeTile(s)),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.notifyChange("demResolution"),this.emit("tiles-changed",{allTiles:this.allTiles}),this.renderer.visible=!1}_purgeSubtree(s){const e=s.children;e[0]&&(this._purgeTile(e[0]),this._purgeTile(e[1]),this._purgeTile(e[2]),this._purgeTile(e[3]),s.clearChildren())}_purgeTile(s){s.leaf?sP(s):this._purgeSubtree(s),this._allTiles.removeUnordered(s),this._unloadTile(s),s.dispose(),this._tileCache.put(pg._tileMemcacheKey,s),this.notifyChange("demResolution"),this.emit("tiles-changed",{allTiles:this.allTiles})}_unloadTile(s){this._pendingTilesToUpdate.delete(s),this._pendingTilesForElevationUpdateEvent.delete(s),s.unload()}_splitTile(s){xi(s.leaf,"Tile that is already split should not be split again!"),xi(s.rendered,"Tile marked to split is not rendered"),sP(s);const e=s.createChildren();this._allTiles.pushArray(e),this.notifyChange("demResolution"),this.emit("tiles-changed",{allTiles:this.allTiles}),s.updateAgentSuspension(),xi(s.rendered,"parent should be rendered"),e.forEach(t=>this._loadTile(t)),e.forEach(t=>this._pendingTilesToUpdate.add(t)),this._unloadTile(s),this._markAllTileNeighborsForUpdate(s),this._emitTileScaleChange(s,s.level+1),this._allTilesDirty=!0,this._shortBatches&&this._updatePendingTileGeometries(),e.forEach(t=>qv(t,t.hasPendingUpdate(1))),++this._performanceInfo.numSplit}_emitTileScaleChange(s,e=s.level){cf.spatialReference=this.spatialReference,cf.extent=s.extent,cf.scale=this._getLodBiasCorrectedScale(e),this.emit("scale-change",cf)}createTile(s,e,t,i){xi(!!i,"createTile sanity check");const r=this._acquireTile(s,e,t,i);return r.updateClippingStatus(this.extent),r.updateScreenDepth(this.view.state.contentCamera.viewProjectionMatrix),this._shouldSplit(r)&&r.setPendingUpdate(1),r}get _shortBatches(){return this.view.state.mode!==2}_mergeTile(s){xi(!s.hasPendingUpdate(1),"_mergeTile sanity check"),xi(!s.leaf,"Cannot merge a leaf"),s.leaf||(this._purgeSubtree(s),xi(!s.renderData,"Merging tile with existing render data?"),this._loadTile(s),this._markTileToUpdate(s),this._emitTileScaleChange(s),this._shortBatches&&this._updatePendingTileGeometries(),qv(s,!1),this._allTilesDirty=!0,++this._performanceInfo.numMerged)}_loadTile(s){s.load(),this.requestUpdate(),this._allTilesDirty=!0,this.overlayManager?.hasOverlays&&s.updateOverlayParameters(this.overlayManager)}_handleLayerViewChanges(s=yn){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let e=!1;const t=new Set;let i=-1;for(let r=this.view.allLayerViews.length-1;r>=0;r--){const n=this.view.allLayerViews.items[r];if(t.add(n.uid),kb(n)||Hu(n))if(this._basemapLayerViewHandles.has(n.uid)&&!Hu(n)){const a=this._layerClassFromLayerView(n),o=this.getLayerIndexByUID(a,n.uid);o!=null&&((o<i||i==null)&&(e=!0),i=o)}else this._registerTiledLayerView(n),n.layer.loaded&&(e=!0)}this._basemapLayerViewHandles.forEach((r,n)=>{t.has(n)||(this._unregisterTiledLayerView(n),e=!0)}),e&&this._updateTiledLayers(),this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._evaluateTransparency(),s.madeProgress()}get _isFullyTransparent(){if(this.view.map?.ground?.opacity>0)return!1;for(const s of this.view.allLayerViews.items)if(Vb(s)&&!Tf(s.layer)&&s.fullOpacity!==0)return!1;return!0}_hasCompositeBlendMode(){for(const s of this.view.allLayerViews.items)if((Rp(s)||Hu(s))&&g9(Qb[s.layer.blendMode]))return!0;return!1}_layerClassFromLayerView(s){return Fb(s)?0:1}_registerTiledLayerView(s){const e=[];if((Rp(s)||Hu(s))&&e.push($(()=>s.layer.blendMode,()=>{this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._updateTileTextures(2)})),!Hu(s)){const t=this._layerClassFromLayerView(s);e.push($(()=>!s.destroyed&&s.suspended,()=>this._updateTiledLayers())),e.push($(()=>!s.destroyed&&s.fullOpacity,()=>this._updateTileTextures(2)));const{layer:i}=s;"effectiveScaleRange"in i&&e.push($(()=>!s.destroyed&&i.effectiveScaleRange,()=>this._restartAllAgents(t))),e.push(s.on("data-changed",()=>{const r=this.getLayerIndexByUID(t,s.uid);r!=null&&this._invalidateLayerData(r,t)}))}this._unregisterTiledLayerView(s.uid),this._basemapLayerViewHandles.set(s.uid,e)}_unregisterTiledLayerView(s){const e=this._basemapLayerViewHandles.get(s);if(e){for(const t of e)t.remove();this._basemapLayerViewHandles.delete(s)}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;const s=this.view.allLayerViews,e=[[],[]];let t=null;s.forEach(i=>{if(!i.layer||i.suspended||!kb(i)||!i.fullExtent)return;const r=this._layerClassFromLayerView(i);if(r===1){const n=i.displayLevelRange.maxLevel;n!==1/0&&(t===null||n>t)&&(t=n)}e[r].push(i)});for(const i of mh){const r=this._layerViews[i],n=e[i];n.reverse();const a=n.length;let o=r.length!==a;const l=new Array(a),c=new Array(r.length);this._layerIndexByUid[i].clear();for(let h=0;h<a;h++){const d=n[h].uid;this._layerIndexByUid[i].set(d,h);const m=r.indexOf(n[h]);l[h]=m,h!==m&&(o=!0),m>-1&&(c[m]=h)}if(o){const h=this._postorderIterator;for(h.reset(this._rootTiles);!h.done;)h.next().modifyLayers(c,l,i);this._layerViews[i]=n,this._restartAllAgents(i),this._updateTilesVisibility(this._rootTiles)}}this.tilingScheme.ensureMaxLod(t)&&(this._viewChangeUpdate(),this.notifyChange("tilingScheme"))}_restartAllAgents(s){const e=this._postorderIterator;for(e.reset(this._rootTiles);!e.done;){const t=e.next();t.restartAgents(s),s===0&&t.computeElevationBounds()}this._updateRootTileElevationBounds()}layerViewByIndex(s,e){return this._layerViews[e][s]}numLayers(s){return this._layerViews[s].length}_updateTileTextures(s){this._allTiles.forAll(e=>{e.updateAgents(1),s===1?this.renderer.updateTileTexture(e,16):e.updateRenderData(1,s)}),this._evaluateTransparency()}_invalidateLayerData(s,e){this._allTiles.forAll(t=>t.removeLayerAgent(s,e)),this._allTiles.forAll(t=>t.invalidateLayerData(s,e))}setTileTreeDirty(){this._allTilesDirty=!0}requestRender(s=1){this.renderer.setNeedsRender(s)}requestUpdate(){++this._pendingUpdates===1&&(this._hasPendingUpdates=!0)}requestTileData(s,e,t,i){const r=this.layerViewByIndex(e,t),n=r.layer;return!n.tilemapCache||lu(r)?this._requestTileData(s,t,r,i):(++this._asyncWorkItems,n.tilemapCache.fetchAvailability(s.level,s.lij[1],s.lij[2],{...i,timeout:6e3}).then(()=>--this._asyncWorkItems).catch(a=>{throw--this._asyncWorkItems,He(i),zr(a)||this._dataMissing(s,t,r),a}).then(()=>this._frameTask.schedule(()=>this._requestTileData(s,t,r,i),i.signal)))}_requestTileData(s,e,t,i){if(this.destroying)return Promise.resolve();const r=e===0;return i.requester??=r?this._elevationDataRequester:this._mapDataRequester,r?Fb(t)?this._requestElevationTileData(s,t,i):Promise.reject():Vb(t)?this._requestMapTileData(s,t,i):Promise.reject()}_requestElevationTileData(s,e,t){++this._asyncWorkItems;const i=n=>{!Hl(t)&&n&&(this.setMemoryDirty(),this.requestUpdate(),this._elevationDataArrived(s,e,n))},r=n=>{zr(n)||(j.getLogger(this).error(`Tile ${s.lij.toString()} layer 0/${e.uid} error ${n}`),this._dataMissing(s,0,e),this.requestUpdate())};return e.fetchElevationTile(s,t).then(n=>this._frameTask.schedule(()=>i(n)),r).finally(()=>--this._asyncWorkItems)}_elevationDataArrived(s,e,t){const i=this._layerIndexByUid[0].get(e.uid);if(i==null)return void j.getLogger(this).warn("TerrainSurface: received data from unknown layer %d %s",0,s.lij.toString());const r=new mj(s.lij,s.extent,t);s.dataArrived(i,0,r),this.emit("tile-data-changed",{tile:s,layerIndex:i,layerClass:0});const n=[s],a=s.level,o=this._iteratorPool.acquire();for(o.reset(n);!o.done;){const l=o.next();l.findElevationBoundsForLayer(i,a),l.computeElevationBounds()}a===0&&this._updateRootTileElevationBounds(),o.remove(),this._updateTilesVisibility(n)}_requestMapTileData(s,e,t){++this._asyncWorkItems;const i=(o,l)=>{qh(l),Hl(t)||(console.error(`Tile ${s.lij.toString()} layer 1/${e.uid} error ${o}`),this._dataMissing(s,1,e),this.requestUpdate())},r=o=>l=>i(l,o),n=o=>this._frameTask.schedule(()=>{this.requestUpdate(),Hl(t)?qh(o):this._mapTileDataArrived(s,e,o)},t.signal,r(o)).catch(r(o)),a=(o,l=null)=>this._frameTask.schedule(()=>i(o,l));return e.fetchTile(s.lij,t).then(n,a).finally(()=>--this._asyncWorkItems)}_mapTileDataArrived(s,e,t){const i=this.getLayerIndexByUID(1,e.uid);if(i==null)return qh(t),void j.getLogger(this).warn("TerrainSurface: received data from unknown layer");s.dataArrived(i,1,t),this.emit("tile-data-changed",{tile:s,layerIndex:i,layerClass:1})}_dataMissing(s,e,t){const i=this.getLayerIndexByUID(e,t.uid);i!=null?(s.dataMissing(i,e),this.emit("tile-data-changed",{tile:s,layerIndex:i,layerClass:e})):j.getLogger(this).warn("TerrainSurface: received data from unknown layer")}get performanceInfo(){const s=this._performanceInfo;return s.numNodes=this._allTiles.length,s.numLeaves=s.numVisible=s.numRendered=s.numLoadedPerLevel.length=s.numRenderedPerLevel.length=0,this._allTiles.forAll(e=>{e.leaf&&s.numLeaves++;const t=e.level;e.renderData&&(s.numLoadedPerLevel[t]=(s.numLoadedPerLevel[t]||0)+1),e.visible&&(s.numVisible++,e.rendered&&(s.numRenderedPerLevel[t]=(s.numRenderedPerLevel[t]||0)+1,s.numRendered++))}),s}setMemoryDirty(){this._usedMemory=null}get usedMemory(){return this.tilingScheme?(this._usedMemory==null&&(this._usedMemory=this._recalculateUsedMemory()),this._usedMemory??0):0}_recalculateUsedMemory(){return this.tilingScheme?Math.round(this._allTiles.reduce((s,e)=>s+e.usedMemory,0)):null}getUsedMemoryForLayerView(s){let e=0;const t=this._layerClassFromLayerView(s),i=this.getLayerIndexByUID(t,s.uid);return i!=null&&this._allTiles.forAll(r=>e+=r.getUsedMemoryForLayer(t,i)),e}get renderPatchBorders(){return this._renderer.renderPatchBorders}set renderPatchBorders(s){this._renderer.renderPatchBorders=s}get visualizeNormals(){return this._renderer.visualizeNormals}set visualizeNormals(s){this._renderer.visualizeNormals=s}get renderingDisabled(){return this._renderer.renderingDisabled}set renderingDisabled(s){this._renderer.renderingDisabled=s}get test(){}checkAllTilesWaterproofness(){if(!u_)return;const s=this._rootTiles;if(s==null)return;const e=n=>n?.renderData?.geometry?.indices?.length>0,t=(n,a)=>{e(n)&&console.error("Tile[",n.lij,"] has geometry although parent[",a.lij,"] has geom")},i=n=>{if(n.intersectsClippingArea)if(n.renderData&&!n.renderData.geometryState&&console.error("Tile[",n.lij,"] has renderData but not geometryState"),n.renderData&&!n.renderData.geometry&&console.error("Tile[",n.lij,"] has renderData but not geometryInfo"),!n.renderData?.geometry||(n.renderData.geometry.indices?.length??0)>0||console.error("Tile[",n.lij,"] has renderData but no indices - geometryInfo: ",n.renderData.geometry),e(n)){n.checkGeometryWaterproofness();for(const a of n.children)t(a,n)}else if(n.leaf)console.error("Tile[",n.lij,"] has no geometry and no children, from root to leaf");else for(const a of n.children)i(a)},r=n=>{const a=n.parent?.visible??!0,o=n.visible;n.computeVisibility();const l=n.visible;if(o!==l&&a&&console.error(" Tile[",n.lij,"] has out of date visibility: ",o," instead of ",l),!n.leaf)for(const c of n.children)r(c)};for(const n of s)i(n),r(n)}get isGlobal(){return this._isGlobal}get isGeographic(){return this._isGeographic}get isWebMercator(){return this._isWebMercator}get isWebMercatorOnPlateCarree(){return this._isWebMercatorOnPlateCarree}isEastEndWrap(s){return this._isGlobal&&s[2]===this.lijEastEnd(s[0])-1}isWestEndWrap(s){return this._isGlobal&&s[2]===0}lijEastEnd(s){return 1<<s+(this._isGeographic?1:0)}wrapEastWest(s){const e=this.lijEastEnd(s[0]),t=s[2];if(0<=t&&t<e)return s;if(!this._isGlobal)return null;const i=(t+(t<0?e:0))%e;return[s[0],s[1],i]}enableInternalChecks(s){Cj(s)}enableWaterproofnessChecks(s){xj(s)}static cleanupTerrainSurface(){aQ.prune()}enable(s){s!==this.enabled&&(s?(this._updateRootTiles(),this.suspended=!1):(this.suspended=!0,this._removeAllTiles(),this._setRootTiles(null)),this._set("enabled",s),this.notifyChange("ready"))}updateOverlayParameters(){const{overlayManager:s}=this;this.allTiles.forAll(e=>e.updateOverlayParameters(s))}};u([p()],xe.prototype,"_renderer",void 0),u([p({constructOnly:!0})],xe.prototype,"_scaleRangeQueries",void 0),u([p({constructOnly:!0})],xe.prototype,"view",void 0),u([p({constructOnly:!0})],xe.prototype,"overlayManager",void 0),u([p({constructOnly:!0})],xe.prototype,"terrainTextureCompressionTracker",void 0),u([p()],xe.prototype,"_hasPendingUpdates",void 0),u([p()],xe.prototype,"_asyncWorkItems",void 0),u([p()],xe.prototype,"_allTilesDirty",void 0),u([p()],xe.prototype,"_allTilesSorted",void 0),u([p()],xe.prototype,"_viewChanged",void 0),u([p({type:Number})],xe.prototype,"heading",void 0),u([p()],xe.prototype,"_splitLimits",void 0),u([p({readOnly:!0})],xe.prototype,"_watchUpdatingTracking",void 0),u([p()],xe.prototype,"_frameTask",void 0),u([p()],xe.prototype,"demResolution",null),u([p({readOnly:!0})],xe.prototype,"snapLevel",null),u([p({readOnly:!0})],xe.prototype,"lodSnappingEnabled",null),u([p()],xe.prototype,"_userClippingExtent",null),u([p()],xe.prototype,"_rootTilesExtent",void 0),u([p({readOnly:!0})],xe.prototype,"extent",null),u([p({readOnly:!0})],xe.prototype,"groundExtent",null),u([p({readOnly:!0})],xe.prototype,"_tilingSchemeExtent",null),u([p({readOnly:!0})],xe.prototype,"updating",null),u([p({readOnly:!0})],xe.prototype,"readyToRun",null),u([p(pj)],xe.prototype,"updatingProgress",void 0),u([p({readOnly:!0})],xe.prototype,"updatingProgressValue",null),u([p()],xe.prototype,"_maxNumUpdating",void 0),u([p()],xe.prototype,"baseOpacity",null),u([p()],xe.prototype,"hasCompositeBlendMode",void 0),u([p({readOnly:!0})],xe.prototype,"viewingMode",null),u([p()],xe.prototype,"maxTextureScale",void 0),u([p({readOnly:!0})],xe.prototype,"ready",null),u([p({readOnly:!0})],xe.prototype,"rootTiles",null),u([p()],xe.prototype,"_rootTiles",void 0),u([p({readOnly:!0})],xe.prototype,"spatialReference",null),u([p({type:vi})],xe.prototype,"backgroundColor",null),u([p({value:!1})],xe.prototype,"slicePlaneEnabled",null),u([p({readOnly:!0})],xe.prototype,"tilingScheme",void 0),u([p({readOnly:!0})],xe.prototype,"tilingSchemeLocked",null),u([p({readOnly:!0})],xe.prototype,"tilingSchemeLogic",void 0),u([p()],xe.prototype,"wireframe",null),u([p({value:!1})],xe.prototype,"suspended",null),u([p()],xe.prototype,"fadeDuration",null),u([p()],xe.prototype,"_xNormalizer",null),u([p()],xe.prototype,"visibleElevationBounds",void 0),u([p()],xe.prototype,"rootTileElevationBounds",void 0),u([p()],xe.prototype,"_layerViewsDirty",void 0),u([p()],xe.prototype,"renderPatchBorders",null),u([p()],xe.prototype,"visualizeNormals",null),u([p()],xe.prototype,"renderingDisabled",null),u([p({readOnly:!0})],xe.prototype,"enabled",void 0),xe=pg=u([R("esri.views.3d.terrain.TerrainSurface")],xe);const tP=xe,Qu=x(),Wc=Xs(),nQ=Mt(),aQ=new zt,Hv=new ZD("ground"),cf={spatialReference:null,extent:null,scale:0};function iP(s,e,t){for(const i of s){if(!i.containsPointXY(e,t))continue;let r=i;for(;r&&!r.renderData;){const a=(e>r.extentMidX?1:0)+(t<r.extentMidY?2:0);r=r.children[a]}const n=r?.renderData?.geometryState.samplerData??null;return Ft(e,t,n)}return null}function qv(s,e){!s.leaf||s.level<li||ax(s,t=>{e&&TA(t);const i=Xb(t);if(t.maxLevelDeltaNeighborCount++,i){let r=t.parent;for(;r;){const n=Xb(r);if(r.unmergableChildCount++,!n)break;r=r.parent}}})}function TA(s){if(s.hasPendingUpdate(1))return;let e=s.parent;for(;e?.resetPendingUpdate(4);)e=e.parent;s.resetPendingUpdate(4),s.leaf&&s.setPendingUpdate(1),s.level<li||ax(s,t=>{TA(t)})}function sP(s){s.level<li||ax(s,e=>{if(e.maxLevelDeltaNeighborCount--,e.maxLevelDeltaNeighborCount===0&&e.unmergableChildCount===0){let t=e.parent;for(;t&&(t.unmergableChildCount--,Xb(t));)t=t.parent}})}function Xb(s){return s.maxLevelDeltaNeighborCount===0&&s.unmergableChildCount===0}function ax(s,e){if(s.level<li)return;const t=s.level-li,i=s.lij[1]>>li,r=s.lij[2]>>li,n=a=>a.leaf||a.level===t;for(let a=0;a<4;++a){const o=s.findNeighborTile(wn[a],n);if(!o||o.level!==t)continue;const l=o.lij;l[1]===i&&l[2]===r||e(o)}}const rP=x();let oQ=class{constructor(e,t,i,r){this.operation=e,this.geometry=t,this.states=i,this.sync=r}},Rd=class extends te{constructor(e){super(e),this._residentGeomRecords=new qa,this._dirtyGeomRecords=new qa,this._dirtyRecordCount=0}get dirty(){return this._dirtyRecordCount>0}commitLayer(e,t){const i=this._dirtyGeomRecords.getInner(e),r=this.model.getLayer(e);if(!i||!r)return;let n=0;i.forEach((a,o)=>{const l=this._ensureGeomRecord(e,o);this._dirtyGeomRecords.delete(e,o),n+=a.size,a.forEach(({geometry:c,operation:h,states:d},m)=>{let f=!1;if(h===1){const g=l.get(m);if(g){if(4&d){const _=r.getObject(o);this.model.updateRenderGeometryTransformation(_,c,g)&&(f=!0)}f||t.updates.push({renderGeometry:g,updateType:d})}else Wt(!1,"ModelDirtySet.commitLayer: invalid update")}if(h===2||f){const g=l.get(m);g?(t.removes.push(g),l.delete(m)):h===2&&Wt(!1,"ModelDirtySet.commitLayer: invalid remove")}if(h===0||f){const g=r.getObject(o);if(g!=null){const _=this.model.getRenderGeometry(g,c);t.adds.push(_),l.set(m,_)}}}),l.size===0&&this._residentGeomRecords.delete(e,o)}),this._dirtyRecordCount-=n}commitSyncUpdates(e,t){const i=this._dirtyGeomRecords.getInner(e),r=this.model.getLayer(e);i&&r&&i.forEach((n,a)=>{const o=this._ensureGeomRecord(e,a);n.forEach(({geometry:l,operation:c,states:h,sync:d},m)=>{let f=!1;if(c===1&&d){const g=o.get(m);if(g){if(4&h){const _=r.getObject(a);this.model.updateRenderGeometryTransformation(_,l,g)&&(f=!0)}f||t.updates.push({renderGeometry:g,updateType:h})}else Wt(!1,"ModelDirtySet.commitSyncUpdates: invalid update")}})})}_objectStateChanged(e,t){for(const i of t.geometries)this._updateOrCreateDirtyRecord(t,i,1,e)}visibilityChanged(e){this._objectStateChanged(1,e)}highlightChanged(e){this._objectStateChanged(8,e)}occlusionChanged(e){this._objectStateChanged(16,e)}attributesChanged({object:e,geometry:t,sync:i}){this._updateOrCreateDirtyRecord(e,t,1,2,i)}layerAdded(e){e.objects.forEach(t=>this.layerObjectAdded(t))}layerRemoved(e){e.objects.forEach(t=>this.layerObjectRemoved(t))}layerObjectAdded(e){for(const t of e.geometries)this._geometryAdded(e,t)}layerObjectRemoved(e){for(const t of e.geometries)this._geometryRemoved(e,t)}layerObjectsAdded(e){for(const t of e)this.layerObjectAdded(t)}layerObjectsRemoved(e){for(const t of e)this.layerObjectRemoved(t)}transformationChanged(e){const t=this._getLayerId(e),i=e.id;this._ensureGeomRecord(t,i).forEach(({geometry:r})=>this._updateOrCreateDirtyRecord(e,r,1,4))}shaderTransformationChanged(e){const t=this._getLayerId(e),i=e.id;this._ensureGeomRecord(t,i).forEach(r=>r.objectShaderTransformationChanged(e.shaderTransformation))}geometryAdded(e){this._geometryAdded(e.object,e.geometry)}_geometryAdded(e,t){this._updateOrCreateDirtyRecord(e,t,0)}geometryRemoved(e){this._geometryRemoved(e.object,e.geometry)}_geometryRemoved(e,t){this._updateOrCreateDirtyRecord(e,t,2)}_updateOrCreateDirtyRecord(e,t,i,r=0,n=!1){const a=this._getLayerId(e),o=e.id,l=t.id,c=this._ensureDirtyRecord(a,o),h=c.get(l);if(h){const d=h.operation;d===2&&i===0&&h.states!==0?h.operation=1:d===2&&i===0||d===0&&i===2?(c.delete(l),this._dirtyRecordCount--):d!==1||i!==2&&i!==1?(Wt((d===2||d===0)&&i===1,"ModelDirtySet.objectGeometryAdded: inconsistent state"),h.states|=r):(h.operation=i,h.states|=r),h.sync=h.sync||n}else c.set(l,new oQ(i,t,r,n)),this._dirtyRecordCount++}_ensureGeomRecord(e,t){let i=this._residentGeomRecords.get(e,t);return i||(i=new Map,this._residentGeomRecords.set(e,t,i)),i}assertLayerClean(e){Wt(this._dirtyGeomRecords.getInner(e)==null,"Dirty geometry records for removed layer")}_ensureDirtyRecord(e,t){const i=this.model.getLayer(e);Wt(i!=null,"Updating geometry record for an unregistered layer");let r=this._dirtyGeomRecords.get(e,t);return r||(r=new Map,this._dirtyGeomRecords.set(e,t,r)),r}_getLayerId(e){return e.layer?.id??Hd}formatDebugInfo(){const e=["ADD","UPD",void 0,"REM"];let t="";return this._dirtyGeomRecords.forAll((i,r,n)=>{t.length>0&&(t+=`
`),t+=r+"."+n;const a=[];i.forEach(o=>{const l=o.operation;a[l]||(a[l]=[]),a[l].push(o.geometry.id)});for(let o=0;o<a.length;o++)if(a[o]){t+=" "+e[o-1]+": ";for(let l=0;l<a[o].length;l++)t+=a[o][l]+", "}}),t}get test(){}};u([p({constructOnly:!0})],Rd.prototype,"model",void 0),u([p()],Rd.prototype,"_dirtyRecordCount",void 0),Rd=u([R("esri.views.3d.webgl-engine.lib.ModelDirtySet")],Rd);const lQ=Rd;let cQ=class{constructor(e,t={}){this.geometry=e,this.screenToWorldRatio=1,this._transformation=Ie(),this._shaderTransformation=null,this._boundingSphere=null,this.id=hu(),this.layerViewUid=t.layerViewUid,this.graphicUid=t.graphicUid,this.castShadow=t.castShadow??!1,t.objectShaderTransformation&&this.objectShaderTransformationChanged(t.objectShaderTransformation)}get transformation(){return this._transformation}set transformation(e){Fr(this._transformation,e),this._boundingSphere=null}get boundingInfo(){return this.geometry.boundingInfo}objectShaderTransformationChanged(e){e==null?this._shaderTransformation=null:(this._shaderTransformation??=Ie(),as(this._shaderTransformation,e,this.geometry.transformation)),this._boundingSphere=null}get boundingSphere(){return this.boundingInfo?(this._boundingSphere==null&&(this._boundingSphere??=Xs(),gp(this._boundingSphere,this.boundingInfo.center,this.shaderTransformation),this._boundingSphere[3]=this.boundingInfo.radius*cp(this.shaderTransformation)),this._boundingSphere):xV}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){return this._shaderTransformation??this.transformation}get attributes(){return this.geometry.attributes}get positionAttribute(){return this.geometry.positionAttribute}foreachHighlightOptions(e){this.geometry.foreachHighlightOptions(e)}get hasHighlights(){return this.geometry.hasHighlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(e){this.geometry.visible=e}},mg=class extends te{constructor(){super(...arguments),this.dirtySet=new lQ({model:this}),this._originFactory=new SE(null),this._textures=new Map,this._layers=new Map}hasTexture(e){return this._textures.has(e.id)}getTexture(e){return e==null?null:this._textures.get(e)}addTexture(e){const t=e.id;Wt(!this._textures.has(t),"Model/Stage already contains texture to be added"),this._textures.set(t,e)}removeTexture(e){return this._textures.delete(e.id)}addTextures(e){for(const t of e)t&&(Wt(!this._textures.has(t.id),"Model/Stage already contains object to be added"),this._textures.set(t.id,t))}removeTextures(e){for(const t of e)t&&(Wt(this._textures.has(t.id),"Model/Stage doesn't contain object to be removed"),this._textures.delete(t.id))}forEachTexture(e){this._textures.forEach(t=>e(t))}hasLayer(e){return this._layers.has(e.id)}getLayer(e){return e==null?null:this._layers.get(e)}addLayer(e){const t=e.id;Wt(!this._layers.has(t),"Model/Stage already contains layer to be added"),this._layers.set(t,e)}removeLayer(e){return this._layers.delete(e.id)}getRenderGeometry(e,t){const i=new cQ(t,{castShadow:e.castShadow,objectShaderTransformation:e.shaderTransformation}),r=t.localOrigin;return i.transformation=e.getCombinedStaticTransformation(t,nP),i.localOrigin=r??this._originFactory.getOrigin(Hi(i.boundingSphere)),i}updateRenderGeometryTransformation(e,t,i){if(e==null)return!1;i.transformation=e.getCombinedStaticTransformation(t,nP);const r=this._originFactory.getOrigin(Hi(i.boundingSphere));return i.localOrigin!==r}get test(){}};u([p({constructOnly:!0})],mg.prototype,"dirtySet",void 0),mg=u([R("esri.views.3d.webgl-engine.parts.Model")],mg);const nP=Ie();let SA=class extends Xt{constructor(){super(...arguments),this.radii=ke(),this.heightParameters=Lt()}};function hQ(s){s.uniforms.add(new Br("radii",e=>e.radii),new qs("heightParameters",e=>e.heightParameters)),s.constants.add("scaleHeight","float",Ei.scaleHeight*Ei.atmosphereHeight),s.code.add(y`float chapmanApproximation(float thickness, float height, float cosZenith) {
float c = sqrt(thickness + height);
float cExpH = c * exp(-height);
if (cosZenith >= 0.0) {
return cExpH / (c * cosZenith + 1.0);
} else {
float x0 = sqrt(1.0 - cosZenith * cosZenith) * (thickness + height);
float c0 = sqrt(x0);
return 2.0 * c0 * exp(thickness - x0) - cExpH / (1.0 - c * cosZenith);
}
}`),s.code.add(y`float getOpticalDepth(vec3 position, vec3 dir, float h) {
return scaleHeight * chapmanApproximation(radii[0] / scaleHeight, h, dot(normalize(position), dir));
}`),s.code.add(y`vec4 planetIntersect(vec3 cameraPos, vec3 rayDir) {
float reducedPlanetRadius = radii[0] - 20000.0;
float rayPlanetDistance = heightParameters[1] - reducedPlanetRadius * reducedPlanetRadius;
vec2 rayPlanetIntersect = sphereIntersect(cameraPos, rayDir, rayPlanetDistance);
vec2 rayAtmosphereIntersect = sphereIntersect(cameraPos, rayDir, heightParameters[2]);
bool hitsAtmosphere = (rayAtmosphereIntersect.x <= rayAtmosphereIntersect.y) && rayAtmosphereIntersect.x > 0.0;
bool insideAtmosphere = heightParameters[0] < radii[1];
if (!(hitsAtmosphere || insideAtmosphere)) {
return vec4(1.0, 0.0, 0.0, 0.0);
}
bool hitsPlanet = (rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.x > 0.0;
float start = insideAtmosphere ? 0.0 : rayAtmosphereIntersect.x;
if (heightParameters[0] < reducedPlanetRadius) {
if (dot(rayDir, normalize(cameraPos)) < -0.025) {
return vec4(1.0, 0.0, 0.0, 0.0);
}
start = rayPlanetIntersect.y;
}
float end = hitsPlanet ? rayPlanetIntersect.x : rayAtmosphereIntersect.y;
return vec4(0.0, hitsPlanet ? 1.0 : 0.0, start, end);
}`)}function PA(s,e){s.include(hQ);const t=6;s.uniforms.add(new Tn("cameraPosition",i=>i.camera.eye)),s.constants.add("betaRayleigh","vec3",CL),s.constants.add("betaCombined","vec3",TL),s.constants.add("betaMie","float",SL),s.code.add(y`
    vec3 raymarchAtmosphere(vec3 cameraPos, vec3 rayDir, vec3 lightDir, float terrainDepth) {
      vec4 ray = planetIntersect(cameraPos, rayDir);
      if(ray.x == 1.0) {
        return vec3(0);
      }
      ${X(e,"if (terrainDepth != -1.0) { ray.w = terrainDepth; }")}

      vec3 samplePoint = cameraPos + rayDir * ray.w;
      float multiplier = ray.y == 1.0 ? -1.0 : 1.0;

      vec3 scattering = vec3(0);
      float scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
      float lastOpticalDepth = getOpticalDepth(samplePoint, rayDir, scaleFract);
      float stepSize = (ray.w - ray.z) / ${y.float(t)};

      for (int i = 0; i < ${y.int(t)}; i++) {
        samplePoint -= stepSize * rayDir;
        scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
        float opticalDepth = multiplier * getOpticalDepth(samplePoint, rayDir * multiplier, scaleFract);

        if (i > 0) {
          scattering *= exp(-(mix(betaCombined, betaRayleigh, 0.5) + betaMie) * max(0.0, (opticalDepth - lastOpticalDepth)));
          ${X(!e,"scattering *= mix(2.5, 1.0, clamp((length(cameraPos) - radii[0]) / 50e3, 0.0, 1.0))")};
        }

        if (dot(normalize(samplePoint), lightDir) > -0.3) {
          float scale = exp(-scaleFract);
          float lightDepth = getOpticalDepth(samplePoint, lightDir, scaleFract);
          scattering += scale * exp(-(betaCombined + betaMie) * lightDepth);
          ${X(!e,"scattering += scale * exp(-(0.25 * betaCombined ) * lightDepth);")}
        }
        lastOpticalDepth = opticalDepth;
      }

      float mu = dot(rayDir, lightDir);
      float mumu = 1.0 + mu * mu;

      float phaseRayleigh = 0.0596831 * mumu;
      ${e?"return 3.0 * scattering * stepSize * phaseRayleigh * betaRayleigh;":y`const float g = 0.8;
             const float gg = g * g;
             float phaseMie = 0.1193662 * ((1.0 - gg) * mumu) / (pow(1.0 + gg - 2.0 * mu * g, 1.5) * (2.0 + gg));
             phaseMie = clamp(phaseMie, 0.0, 128.0);
             return 3.0 * scattering * stepSize * (phaseRayleigh * betaRayleigh + 0.025 * phaseMie * betaMie);`}
    }`)}function Yp(s,e={needUVs:!0,needEyeDirection:!0}){s.attributes.add("position","vec2"),s.varyings.add("worldRay","vec3");const{needUVs:t,needEyeDirection:i}=e;t&&s.varyings.add("uv","vec2"),i&&s.varyings.add("eyeDir","vec3"),s.vertex.uniforms.add(new ur("inverseProjectionMatrix",r=>r.camera.inverseProjectionMatrix),new ur("inverseViewMatrix",r=>tV(uQ,r.camera.viewMatrix))),s.vertex.main.add(y`
    vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1.0, 1.0)).xyz;
    ${X(i,"eyeDir = posViewNear;")}
    worldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;
    ${X(t,"uv = position * 0.5 + vec2(0.5);")}
    gl_Position = vec4(position, 1, 1);
  `)}const uQ=Ie();function MA(s){const e=new lt;e.include(Yp);const{reduced:t}=s,{fragment:i}=e;return lc(i),i.include(uc),i.include(jp),i.include(Vp),i.include(PA,!1),i.uniforms.add(new js("backgroundColor",r=>r.backgroundColor),new ge("innerFadeDistance",r=>r.innerFadeDistance),new ge("altitudeFade",r=>r.altitudeFade),new mr("depthTexture",r=>r.mainDepth)).code.add(y`vec4 applyUndergroundAtmosphere(vec3 rayDir, vec3 lightDirection, vec4 fragColor) {
float rayPlanetDistance = heightParameters[1] - radii[0] * radii[0];
vec2 rayPlanetIntersect = sphereIntersect(cameraPosition, rayDir, rayPlanetDistance);
if (!((rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.y > 0.0)) {
return fragColor;
}
float lightAngle = dot(lightDirection, normalize(cameraPosition + rayDir * max(0.0, rayPlanetIntersect.x)));
vec4 surfaceColor = vec4(vec3(max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)))), 1.0 - altitudeFade);
float relDist = (rayPlanetIntersect.y - max(0.0, rayPlanetIntersect.x)) / innerFadeDistance;
if (relDist > 1.0) {
return surfaceColor;
}
return mix(fragColor, surfaceColor, smoothstep(0.0, 1.0, relDist * relDist));
}
float getGlow(float dist, float radius, float intensity) {
return pow(radius / max(dist, 1e-6), intensity);
}
vec3 getSun(vec3 cameraPos, vec3 rayDir, vec3 lightDir){
float scaleFract = (length(cameraPos) - radii[0]) / scaleHeight;
float sunOpticalDepth = getOpticalDepth(cameraPos, rayDir, max(scaleFract, 0.0));
vec3 sunTransmittance = exp(-(mix(betaCombined, betaRayleigh, 0.5)) * max(0.0, sunOpticalDepth));
float mu = clamp(dot(rayDir, lightDir), 0.0, 1.0);
float sunDisc = 256.0 * smoothstep(0.0, 128.0, clamp(getGlow(1.0 - mu, 3e-5, 3.0), 0.0, 128.0));
return normalize(sunTransmittance) * sunDisc;
}`).main.add(y`
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;
      ${X(!t,y`float depthSample = texture(depthTexture, uv).r;
             if (depthSample != 1.0) {
                fragColor = vec4(0);
                return;
             }`)}

      vec3 col = linearizeGamma(backgroundColor);
      col += raymarchAtmosphere(cameraPosition, rayDir, mainLightDirection, terrainDepth);
      col += getSun(cameraPosition, rayDir, mainLightDirection);
      float alpha = smoothstep(0.0, mix(0.15, 0.01, heightParameters[3]), length(col));

      col = tonemapACES(col);
      fragColor = delinearizeGamma(vec4(col, alpha));
      fragColor = applyUndergroundAtmosphere(rayDir, mainLightDirection, fragColor);
  `),e}const dQ=Object.freeze(Object.defineProperty({__proto__:null,build:MA},Symbol.toStringTag,{value:"Module"}));let pQ=class extends SA{constructor(){super(...arguments),this.innerFadeDistance=0,this.altitudeFade=0,this.backgroundColor=x()}},Gv=class extends ct{constructor(e,t){super(e,t,new ht(dQ,()=>k(()=>Promise.resolve().then(()=>nee),void 0)),Ya(Fp))}initializePipeline(e){return qe({blending:e.reduced?bw:vw(770,771),depthTest:{func:e.reduced?519:515},colorWrite:nt})}},$A=class extends ls{constructor(){super(...arguments),this.reduced=!1}};u([V()],$A.prototype,"reduced",void 0);let ox=class extends Xt{};function RA(){const s=new lt;return s.include(qi),s.fragment.uniforms.add(new Be("colorTexture",e=>e.color),new mr("depthTexture",e=>e.mainDepth)),s.fragment.main.add(y`float depthSample = texture(depthTexture, uv).r;
if (depthSample != 1.0 ) {
fragColor = vec4(0);
return;
}
fragColor = texture(colorTexture, uv);`),s}const mQ=Object.freeze(Object.defineProperty({__proto__:null,AtmosphereCompositingPassParameters:ox,build:RA},Symbol.toStringTag,{value:"Module"}));let aP=class extends ct{constructor(e,t){super(e,t,new ht(mQ,()=>k(()=>Promise.resolve().then(()=>aee),void 0)),ri)}initializePipeline(){return qe({blending:vw(770,771),depthTest:{func:519},colorWrite:nt})}},Yb=class extends Kn{constructor(){super(...arguments),this.requireGeometryDepth=!0,this._compositingPassParameters=new ox,this._vao=null,this._passParameters=new pQ,this._configuration=new $A}initialize(){this.techniques.precompile(Gv,this._configuration),this.techniques.precompile(aP),this._configuration.reduced=!0,this.techniques.precompile(Gv,this._configuration),this._configuration.reduced=!1,this.addHandles([$(()=>this.view.environment.background,e=>{const t=e instanceof UO?t1(e.color):hi;be(this._passParameters.backgroundColor,t[0]*t[3],t[1]*t[3],t[2]*t[3])},Ve),$(()=>this.view.stage?.renderer?.fullResolutionAtmosphere,e=>this._configuration.reduced=!e,Ve),$(()=>this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),Ve)])}destroy(){this._vao=_e(this._vao)}render(e){const t=e.find(({name:v})=>v===ne.OPAQUE_ENVIRONMENT);if(!this.bindParameters.mainDepth)return t;const i=this.renderingContext;this._vao??=Wo(i,1);const r=t.getAttachment(Ui);this._update();const n=this.techniques.get(Gv,this._configuration);if(!n.compiled)return this.requestRender(1),t;if(!this._configuration.reduced)return t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(n,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(Ct.TRIANGLE_STRIP,0,4),t.attachDepth(r),t;const a=this.techniques.get(aP);if(!a.compiled)return this.requestRender(1),t;const o=i.getViewport(),l=this.bindParameters.camera,c=fe(l.eye)-Ei.radius;let h;const d=Ei.atmosphereHeight;if(c<d){const v=Math.min(1,Math.max(0,c/d));h=Me(.2,.3,v)}else{const v=Math.min(1,Math.max(0,(c-d)/(15*d)));h=Me(.3,.6,v)}const m=this.renderingContext.parameters.maxTextureSize,f=jh(Math.round(h*l.fullViewport[2]),m),g=jh(Math.round(h*l.fullViewport[3]),m);i.setViewport(0,0,f,g);const _=this.fboCache.acquire(f,g,"chapman",5);return i.bindFramebuffer(_.fbo),i.clearFramebuffer([0,0,0,1],!0,!0),i.bindTechnique(n,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(Ct.TRIANGLE_STRIP,0,4),i.setViewport(o.x,o.y,o.width,o.height),this._compositingPassParameters.color=_.getTexture(),t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(a,this.bindParameters,this._compositingPassParameters),i.screen.draw(),t.attachDepth(r),_.release(),t}_update(){const e=this.bindParameters.camera,t=Gs(e.eye),i=Math.sqrt(t),r=t-this._passParameters.radii[1]**2,n=U((i-this._passParameters.radii[0])/Ei.atmosphereHeight,0,1);os(this._passParameters.heightParameters,i,t,r,n);const a=this.view.basemapTerrain?.getLowerBoundRadius()??0;Xi(this._passParameters.radii,a,a+Ei.atmosphereHeight),this._passParameters.innerFadeDistance=2*Math.sqrt((2*a-C0)*C0),this._passParameters.altitudeFade=u$(i-a)}};Yb=u([R("esri.views.3d.environment.ChapmanAtmosphere")],Yb);function OA(){const s=new lt,{fragment:e}=s;return s.include(Yp,{needUVs:!1,needEyeDirection:!1}),e.include(Sw),s.include(PL,{pbrMode:0,lightingSphericalHarmonicsOrder:2}),e.include(ZM),e.include(uc),s.include(bA),e.uniforms.add(new Tn("cameraPosition",t=>t.camera.eye),new Rs("cloudsOpacity",t=>t.clouds.opacity)).main.add(y`vec4 cloudsColor = renderClouds(normalize(worldRay), cameraPosition);
fragColor = vec4(cloudsOpacity * cloudsColor.rgb, cloudsColor.a);`),s}const fQ=Object.freeze(Object.defineProperty({__proto__:null,build:OA},Symbol.toStringTag,{value:"Module"}));let oP=class extends ct{constructor(e,t){super(e,t,new ht(fQ,()=>k(()=>Promise.resolve().then(()=>oee),void 0)),ri)}initializePipeline(){return qe({blending:du(1,0,770,1),depthTest:{func:515},colorWrite:nt})}},Kb=class extends Kn{constructor(e){super(e),this._planetRadius=Zt(e.view.spatialReference).radius}initialize(){this.techniques.precompile(oP),this.addHandles([$(()=>this.view.environment.weather!=null&&this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),Re)])}destroy(){this._vao=_e(this._vao)}render(e){const t=e.find(({name:o})=>o===ne.OPAQUE_ENVIRONMENT),i=this.bindParameters.clouds;if(!i.data)return t;const r=this.techniques.get(oP);if(!r.compiled)return this.requestRender(1),t;const n=this.renderingContext;this._vao??=Wo(n);const a=n.bindTechnique(r,this.bindParameters);return n.bindVAO(this._vao),a.assertCompatibleVertexAttributeLocations(this._vao),n.drawArrays(Ct.TRIANGLE_STRIP,0,4),i.isFading&&this.requestRender(2),t}};Kb=u([R("esri.views.3d.environment.CloudsComposition")],Kb);let DA=class extends Xt{constructor(){super(...arguments),this.atmosphereC=1}};function EA(s){s.include(jp),s.uniforms.add(new ge("atmosphereC",e=>e.atmosphereC),new Tn("cameraPosition",e=>e.camera.eye)),s.code.add(y`float getDistanceFalloff(float dist, vec3 rayDir, float weight) {
if(dist == -1.0){
dist = 0.055 * sphereIntersect(cameraPosition, rayDir, atmosphereC).y;
}
return (1.0 - exp(-dist * weight));
}`)}let lx=class extends DA{constructor(){super(...arguments),this.color=x(),this.strength=4e-6,this.amount=0,this.fogColorDistanceWeight=1}};function AA(s){const e=new lt;e.include(Yp,{needUVs:!0,needEyeDirection:!0});const t=e.fragment,{hasEmissive:i}=s;return t.uniforms.add(new mr("depthTexture",r=>r.mainDepth),new ge("fogStrength",r=>r.strength),new ge("fogAmount",r=>r.amount),new js("fogColor",r=>r.color),new ge("fogColorDistanceWeight",r=>r.fogColorDistanceWeight)),i&&t.uniforms.add(new Be("emissionTexture",r=>r.emission)),t.include(EA),t.include(uc),t.include(Vp),t.include(Qa),t.main.add(y`
    vec3 rayDir = normalize(worldRay);
    float terrainDepth = -1.0;

    float depthSample = depthFromTexture(depthTexture, uv);
    if(depthSample < 1.0 && depthSample > 0.0){
      vec3 cameraSpaceRay = normalize(eyeDir);
      cameraSpaceRay /= cameraSpaceRay.z;
      cameraSpaceRay *= linearizeDepth(depthSample);
      terrainDepth = max(0.0, length(cameraSpaceRay));
    }

    float fogAmount = fogAmount * getDistanceFalloff(terrainDepth, rayDir, fogStrength);

    ${X(i,y`vec3 emission = texture(emissionTexture, uv).rgb;
           vec3 emissionDistanceCorrected = mix(emission, vec3(0.0), fogAmount * fogColorDistanceWeight);
           vec3 finalFogColor = fogColor * fogAmount + emissionDistanceCorrected;
           vec4 fog = vec4(finalFogColor, fogAmount);`,y`vec4 fog = vec4(fogColor, 1.0) * fogAmount;`)}
    fragColor = delinearizeGamma(vec4(tonemapACES(fog.rgb), fog.a));`),e}const gQ=Object.freeze(Object.defineProperty({__proto__:null,FogPassParameters:lx,build:AA},Symbol.toStringTag,{value:"Module"}));let jv=class extends ct{constructor(e,t){super(e,t,new ht(gQ,()=>k(()=>Promise.resolve().then(()=>lee),void 0)),ri)}initializePipeline(){return qe({blending:du(770,0,771,1),colorWrite:nt})}},IA=class extends ls{constructor(){super(...arguments),this.hasEmissive=!1}};u([V()],IA.prototype,"hasEmissive",void 0);function LA(s){s.code.add(y`const float MAX_RGBA_FLOAT =
255.0 / 256.0 +
255.0 / 256.0 / 256.0 +
255.0 / 256.0 / 256.0 / 256.0 +
255.0 / 256.0 / 256.0 / 256.0 / 256.0;
const vec4 FIXED_POINT_FACTORS = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);
vec4 float2rgba(const float value) {
float valueInValidDomain = clamp(value, 0.0, MAX_RGBA_FLOAT);
vec4 fixedPointU8 = floor(fract(valueInValidDomain * FIXED_POINT_FACTORS) * 256.0);
const float toU8AsFloat = 1.0 / 255.0;
return fixedPointU8 * toU8AsFloat;
}`),s.code.add(y`const vec4 RGBA_TO_FLOAT_FACTORS = vec4(
255.0 / (256.0),
255.0 / (256.0 * 256.0),
255.0 / (256.0 * 256.0 * 256.0),
255.0 / (256.0 * 256.0 * 256.0 * 256.0)
);
float rgbaTofloat(vec4 rgba) {
return dot(rgba, RGBA_TO_FLOAT_FACTORS);
}`),s.code.add(y`const vec4 uninterpolatedRGBAToFloatFactors = vec4(
1.0 / 256.0,
1.0 / 256.0 / 256.0,
1.0 / 256.0 / 256.0 / 256.0,
1.0 / 256.0 / 256.0 / 256.0 / 256.0
);
float uninterpolatedRGBAToFloat(vec4 rgba) {
return (dot(round(rgba * 255.0), uninterpolatedRGBAToFloatFactors) - 0.5) * 2.0;
}`),s.code.add(y`const vec3 uninterpolatedRGBToFloatFactors = vec3(
1.0 / 256.0,
1.0 / 256.0 / 256.0,
1.0 / 256.0 / 256.0 / 256.0
);
float uninterpolatedRGBToFloat(vec3 rgb) {
return (dot(round(rgb * 255.0), uninterpolatedRGBToFloatFactors) - 0.5) * 2.0;
}`)}let Y_=class extends Xt{constructor(){super(...arguments),this.opacity=1}};function FA(s){const e=new lt,{blitEmissiveMode:t,blitMode:i,hasOpacityFactor:r}=s;e.include(qi),e.fragment.uniforms.add(new Be("tex",o=>o.texture)),r&&e.fragment.uniforms.add(new ge("opacity",o=>o.opacity));const n=i===3;n&&(e.fragment.uniforms.add(new ap("nearFar",o=>o.camera.nearFar)),e.fragment.include(Qa),e.fragment.include(LA));const a=t===1;return a&&(e.outputs.add("fragColor","vec4",0),e.outputs.add("fragEmission","vec4",1)),e.fragment.main.add(y`
    ${n?y`
          float normalizedLinearDepth = (-linearDepthFromTexture(tex, uv) - nearFar[0]) / (nearFar[1] - nearFar[0]);
          fragColor = float2rgba(normalizedLinearDepth);`:y`
          fragColor = texture(tex, uv) ${r?"* opacity":""};`}
    ${X(a,"fragEmission = vec4(0.0, 0.0, 0.0, fragColor.a);")}`),e}const _Q=Object.freeze(Object.defineProperty({__proto__:null,CompositingPassParameters:Y_,build:FA},Symbol.toStringTag,{value:"Module"}));let Qn=class extends ct{constructor(e,t){super(e,t,new ht(_Q,()=>k(()=>Promise.resolve().then(()=>cee),void 0)),ri)}initializePipeline(e){const{blitMode:t,blitEmissiveMode:i}=e,r=i?1:0;switch(t){case 0:case 3:return qe({colorWrite:nt,drawBuffers:qd(0,r)});case 1:return qe({blending:za,colorWrite:nt,drawBuffers:qd(0,r)});default:return qe({blending:pu,colorWrite:nt,drawBuffers:qd(0,r)})}}},np=class extends ls{constructor(){super(...arguments),this.blitMode=0,this.blitEmissiveMode=0,this.hasOpacityFactor=!1}};u([V({count:4})],np.prototype,"blitMode",void 0),u([V({count:4})],np.prototype,"blitEmissiveMode",void 0),u([V()],np.prototype,"hasOpacityFactor",void 0);let cx=class{constructor(e,t=0){this._techniques=e,this._parameters=new Y_,this._configuration=new np,this._configuration.blitMode=t,e.precompile(Qn,this._configuration),this._configuration.hasOpacityFactor=!0,e.precompile(Qn,this._configuration),this._configuration.hasOpacityFactor=!1}blit(e,t,i,r){this.blitTexture(e,t.getTexture(),i,r)}blitTexture(e,t,i,r){e.bindFramebuffer(i.fbo),e.setClearColor(0,0,0,1),e.clear(16384),this._parameters.texture=t;const n=this._techniques.get(Qn,this._configuration);e.bindTechnique(n,r,this._parameters),e.screen.draw()}blend(e,t,i,r,n=1){this._configuration.hasOpacityFactor=n<1;const a=this._techniques.get(Qn,this._configuration);return!!a.compiled&&(e.bindFramebuffer(i.fbo),this._parameters.texture=t.getTexture(),this._parameters.opacity=n,e.bindTechnique(a,r,this._parameters),e.screen.draw(),!0)}};const yQ=.95,vQ=1;let fg=class extends Ql{constructor(e){super(e),this.consumes={required:[ne.TRANSPARENT_ENVIRONMENT]},this._configuration=new IA,this.requireGeometryDepth=!0,this._newParameters=new Wv,this._oldParameters=new Wv,this._fadedParameters=new Wv,this._parameters=this._newParameters,this._passParameters=new lx,this._blit=null;const t=Zt(e.view.spatialReference);this._planetRadius=t.radius,this._atmosphereRadius=t.radius+t.atmosphereHeight;const i=e.view.stage.renderView.techniques;i.precompile(jv,this._configuration),this._configuration.hasEmissive=!this._configuration.hasEmissive,i.precompile(jv,this._configuration),this._configuration.hasEmissive=!this._configuration.hasEmissive}toogle(){this.view.environment.atmosphereEnabled&&this.view.environment.weather?this._enable():this._disable()}initialize(){this.addHandles([$(()=>this.view.environment.atmosphereEnabled,()=>this.toogle(),Ve),$(()=>this.view.environment.weather,()=>this.toogle(),Ve),$(()=>this._updateFogParameters(),()=>{},Ve)]),this.addHandles($(()=>this._fadeFactor,e=>this._fade(e),Ve))}get _fadeFactor(){return this.view.stage?.renderer.renderContext.bind.clouds.fadeFactor??1}_fade(e){const{_newParameters:t,_oldParameters:i}=this;e>=1?(this._parameters=t,this._oldParameters.copyFrom(this._newParameters)):e<=0?this._parameters=i:(this._fadedParameters.lerp(i,t,e),this._parameters=this._fadedParameters)}_updateFogParameters(){const e=this.view.environment.weather,t=e.type==="foggy"||e.type==="snowy"||e.type==="rainy";this._newParameters.strength=e.type==="foggy"?Me(3e-5,.005,e.fogStrength**3):e.type==="snowy"||e.type==="rainy"?Me(4e-6,2e-4,(e.precipitation??0)**3):0,this._newParameters.amount=t?1:0,e.type!=="foggy"&&e.type!=="snowy"||q(this._newParameters.color,wQ),e.type==="rainy"&&q(this._newParameters.color,bQ),this._fadeFactor>=1&&this._oldParameters.copyFrom(this._newParameters),this.requestRender(1)}render(e){const t=e.find(({name:m})=>m===ne.TRANSPARENT_ENVIRONMENT);if(this._parameters.amount===0||(this._update(),this._passParameters.amount<=0))return t;const i=t.getAttachment(Ws);this._configuration.hasEmissive=i!=null;const r=this.techniques.get(jv,this._configuration);if(!r.compiled)return this.requestRender(1),t;const n=t.getAttachment(Ui),a=this.renderingContext,{fullWidth:o,fullHeight:l}=this.bindParameters.camera,c=o,h=l;let d=null;return i&&(d=this.fboCache.acquire(c,h,"glow horizontal",8),this._blit??=new cx(this.techniques),this._blit.blitTexture(a,i?.attachment,d,this.bindParameters)),t.attachDepth(null),a.bindFramebuffer(t.fbo),i&&(this._passParameters.emission=d?.getTexture()),a.bindTechnique(r,this.bindParameters,this._passParameters),a.screen.draw(),t.attachDepth(n),d?.release(),t}_update(){const e=this.bindParameters.camera;pe(lP,e.eye);const t=Math.max(0,We(lP,this.bindParameters.lighting.mainLight.direction)),i=this._parameters.color;ee(cP,i,.1),kt(this._passParameters.color,cP,i,t);const r=fe(e.eye);this._passParameters.atmosphereC=r**2-this._atmosphereRadius**2,this._passParameters.amount=(1-Kh(yQ*kl,vQ*kl,Math.abs(r-this._planetRadius)))*this._parameters.amount,this._passParameters.strength=this._parameters.strength}get test(){return{parameters:this._passParameters}}};u([p()],fg.prototype,"consumes",void 0),fg=u([R("esri.views.3d.environment.Fog")],fg);let Wv=class{constructor(){this.color=x(),this.strength=0,this.amount=0}copyFrom(e){this.amount=e.amount,this.strength=e.strength,q(this.color,e.color)}lerp(e,t,i){this.amount=Me(e.amount,t.amount,i),this.strength=Me(e.strength,t.strength,i),kt(this.color,e.color,t.color,i)}};const lP=x(),cP=x(),bQ=Qe(.5,.5,.5),wQ=Qe(1.5,1.5,1.5);let K_=class extends Xt{constructor(){super(...arguments),this.texV=ke(),this.altitudeFade=0,this.innerScale=0,this.undergroundFadeAlpha=0,this.silhouette=new hx}},hx=class{constructor(){this.center=x(),this.v1=x(),this.v2=x()}};function VA(s){const e=new lt,{vertex:t,fragment:i}=e;if(lc(t),s.geometry===2)e.attributes.add("position","vec2"),e.varyings.add("color","vec4"),t.uniforms.add(new Tn("cameraPosition",r=>r.camera.eye),new ge("undergroundFadeAlpha",r=>r.undergroundFadeAlpha)),t.main.add(y`float ndotl = dot(normalize(cameraPosition), mainLightDirection);
float lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));
color = vec4(vec3(lighting), undergroundFadeAlpha);
gl_Position = vec4(position.xy, 1.0, 1.0);`),i.main.add(y`fragColor = color;`);else{e.include(l$),e.attributes.add("position","vec3"),e.varyings.add("vtc","vec2"),e.varyings.add("falloff","float");const r=s.geometry===1;t.uniforms.add(new ur("proj",o=>o.camera.projectionMatrix),new ur("view",o=>o.camera.viewMatrix)),r||(e.varyings.add("innerFactor","float"),t.uniforms.add(new js("silCircleCenter",o=>o.silhouette.center)),t.uniforms.add(new js("silCircleV1",o=>o.silhouette.v1)),t.uniforms.add(new js("silCircleV2",o=>o.silhouette.v2)),t.uniforms.add(new Br("texV",o=>o.texV)),t.uniforms.add(new ge("innerScale",o=>o.innerScale)));const n=6.2831853,a=1/128;t.main.add(y`
      ${r?y`
      vec3 pos = position;
      float ndotl = mainLightDirection.z;
      vtc = vec2(0.0, position.z + 0.05);`:y`
      innerFactor = clamp(-position.z, 0.0, 1.0);
      float scale = position.y * (1.0 + innerFactor * innerScale);
      float phi = position.x * ${y.float(n*a)} + 1.0;
      vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;
      float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), mainLightDirection);
      vtc.x = position.x  * ${y.float(a)};
      vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;
      `}
      falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));

		  gl_Position = transformPosition(proj, view, pos);
		  gl_Position.z = gl_Position.w; // project atmosphere onto the far plane
	  `),i.uniforms.add(new Be("tex",o=>o.texture)),r||i.uniforms.add(new ge("altitudeFade",o=>o.altitudeFade)),i.main.add(y`
			vec4 atmosphereColor = texture(tex, vtc) * falloff;
      ${r?y`fragColor = atmosphereColor;`:y`
			vec4 innerColor = vec4(atmosphereColor.rgb, 1.0 - altitudeFade);
			fragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));`}`)}return e}const xQ=Object.freeze(Object.defineProperty({__proto__:null,SilhouetteCircle:hx,SimpleAtmospherePassParameters:K_,build:VA},Symbol.toStringTag,{value:"Module"}));let kh=class extends ct{constructor(e,t){super(e,t,new ht(xQ,()=>k(()=>Promise.resolve().then(()=>hee),void 0)),Ap.locations)}initializePipeline(e){const t=e.geometry===1;return qe({blending:za,culling:t?h$:void 0,depthTest:{func:515},colorWrite:nt})}};const Ap=Xa().vec3f("position").freeze();let ux=class extends T_{constructor(){super(...arguments),this.geometry=0}};u([V({count:3})],ux.prototype,"geometry",void 0);const CQ=new Uint8ClampedArray([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,16,0,0,16,16,0,0,16,16,0,0,16,16,0,0,16,15,0,0,17,15,0,0,17,15,0,0,17,15,0,0,17,14,0,0,18,14,0,0,18,14,0,0,18,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,20,13,0,0,20,13,0,0,20,13,0,0,20,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,22,12,0,0,22,12,0,0,22,12,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,27,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,29,18,0,0,29,18,0,0,29,17,0,0,30,17,0,0,30,17,0,0,30,17,0,0,30,16,0,0,31,16,0,0,31,16,0,0,31,16,0,0,32,16,0,0,32,16,0,0,32,15,0,0,33,15,0,0,33,15,0,0,33,15,0,0,34,15,8,0,34,15,8,0,34,15,8,0,34,15,7,0,35,15,7,0,35,15,7,0,35,21,7,0,36,21,7,0,36,21,7,0,36,21,7,0,37,21,7,0,37,21,7,0,37,20,7,0,38,20,7,0,38,20,7,0,38,20,7,0,39,20,7,0,39,20,7,0,39,20,7,0,39,19,6,0,40,19,6,0,40,19,6,0,40,19,6,0,41,19,6,0,41,19,6,0,41,18,6,0,42,18,6,0,42,18,6,0,42,24,6,0,43,24,6,0,43,24,6,0,43,23,6,0,44,23,6,0,44,23,6,0,44,23,6,0,45,23,6,0,45,23,6,0,45,22,6,0,46,22,6,0,46,22,6,0,46,22,5,0,47,22,5,0,47,22,5,0,47,21,5,0,48,21,5,0,48,21,5,0,48,21,5,0,49,21,5,0,49,26,5,0,49,25,5,0,50,25,5,0,50,25,5,0,50,25,5,0,51,25,5,0,51,25,5,0,51,25,5,0,52,25,5,0,52,25,5,0,52,24,5,0,53,24,5,0,53,24,5,0,53,24,9,0,54,28,9,0,54,28,9,0,54,28,9,0,55,28,9,0,55,27,9,0,56,27,9,0,56,27,9,0,56,27,9,4,57,27,9,4,57,27,9,4,57,26,9,4,58,26,9,4,58,26,9,4,58,26,9,4,59,26,9,4,59,26,9,4,59,26,8,4,60,30,8,4,60,30,8,4,60,29,8,4,61,29,8,4,61,29,8,4,62,29,8,4,62,29,8,4,62,28,8,4,63,28,8,4,63,28,8,4,63,28,12,4,64,28,12,4,64,28,12,4,64,27,12,4,65,27,12,8,65,27,12,8,65,31,12,8,66,31,12,8,66,30,11,8,67,30,11,8,67,30,11,8,67,30,11,8,68,30,11,8,68,30,11,8,68,30,15,7,69,30,15,7,69,30,15,7,69,33,15,11,70,33,15,11,70,32,14,11,71,32,14,11,71,32,14,11,71,32,18,14,72,32,18,14,72,32,18,14,72,31,17,14,73,35,17,14,73,34,17,17,74,34,21,17,74,34,21,17,74,34,20,17,75,34,20,20,75,34,20,20,75,34,23,20,76,34,23,20,76,36,23,23,77,36,23,23,77,36,23,23,77,36,23,23,78,36,26,26,78,36,26,26,78,36,26,26,79,36,26,29,79,38,26,29,80,38,29,29,80,38,29,29,80,38,28,31,81,38,28,31,81,38,31,31,81,37,31,34,82,37,31,34,82,37,31,37,83,40,34,37,83,40,34,37,83,39,33,39,84,39,33,39,84,39,36,42,84,39,36,42,85,39,36,42,85,39,36,42,85,39,39,44,86,39,39,44,86,41,38,47,87,41,41,47,87,41,41,50,87,41,41,49,88,41,41,52,88,40,43,52,89,43,43,52,89,43,43,54,89,42,45,54,90,42,45,57,90,42,45,57,90,42,45,59,91,42,48,59,91,44,47,61,92,44,47,61,92,44,50,61,92,44,49,63,93,44,49,63,93,44,52,66,93,43,52,65,94,46,54,68,94,46,54,70,95,46,54,70,95,46,54,70,95,45,56,72,96,45,56,72,96,45,58,74,97,47,58,76,97,47,58,76,97,47,60,78,98,47,60,78,98,47,60,81,98,49,62,80,99,49,62,82,99,48,61,84,100,48,64,84,100,48,64,84,100,50,63,86,101,50,66,86,101,50,66,88,101,50,65,90,102,52,67,89,103,51,69,91,104,51,68,92,105,52,69,93,107,52,71,94,108,54,70,96,109,53,71,96,111,52,73,98,112,54,72,98,114,53,73,100,115,54,72,100,117,54,73,102,118,55,74,104,120,55,76,105,121,56,77,106,123,56,76,107,124,57,79,107,126,58,78,110,128,57,79,111,129,56,80,113,131,58,79,112,132,57,82,114,134,58,81,116,136,60,82,117,137,59,83,117,139,60,83,119,141,59,84,120,142,60,85,122,144,59,86,122,146,60,86,126,148,62,87,127,149,61,88,127,151,62,88,128,153,63,89,130,155,62,90,131,156,63,90,132,158,64,91,134,160,65,91,135,162,64,92,136,163,63,93,138,165,66,95,139,167,65,95,140,169,66,95,142,171,67,96,142,172,66,97,144,174,67,99,145,176,67,97,148,178,67,99,147,180,68,100,149,181,68,100,150,183,69,101,152,185,70,102,153,187,71,103,155,188,70,103,156,190,70,104,157,192,71,105,158,194,71,106,160,195,72,106,161,197,72,108,161,199,73,108,163,200,73,109,164,202,74,109,165,204,74,110,167,206,75,111,168,207,74,112,170,209,75,112,170,210,76,113,171,212,76,114,173,214,77,115,174,215,78,115,175,217,78,116,175,218,78,117,177,220,78,118,178,221,79,118,180,223,80,120,180,224,81,120,181,226,81,120,182,227,82,121,184,229,82,122,185,230,84,123,186,232,83,123,187,233,84,124,189,234,84,125,188,235,85,126,189,237,86,126,190,238,86,127,191,239,87,127,192,240,87,129,193,242,88,129,194,243,89,130,195,244,90,131,196,245,90,132,197,246,91,132,197,247,92,133,198,248,92,134,199,249,93,135,200,250,94,136,201,251,95,137,202,252,96,138,203,253,97,140,204,254,98,141,205,254,99,142,206,255,101,143,207,255,102,144,208,255,103,146,209,255,104,147,209,255,106,148,210,255,107,149,211,255,108,151,212,255,110,152,213,255,111,153,213,255,112,154,214,255,114,156,215,255,115,157,215,255,117,158,216,255,118,160,217,255,120,161,217,255,121,162,218,255,123,164,218,255,124,165,219,255,125,166,219,255,127,167,220,255,129,169,220,255,130,170,221,255,132,171,221,255,133,173,222,255,134,174,222,255,136,175,223,255,139,178,224,255,142,180,224,255,144,182,225,255,147,185,226,255,150,187,226,255,153,189,227,255,155,191,228,255,158,194,228,255,160,196,229,255,163,198,229,255,165,200,230,255,168,202,231,255,170,203,231,255,172,205,232,255,174,207,232,255,176,209,233,255,178,210,234,255,180,212,234,255,182,214,235,255,184,215,236,255,186,217,237,255,188,219,238,255,190,220,238,255,192,221,239,255,193,222,240,255,194,224,240,255,196,225,241,255,197,226,241,255,198,226,242,255,199,227,242,255,200,228,242,255,201,228,243,255,202,229,243,255,203,230,243,255,204,230,244,255,205,231,244,255,207,232,244,255,208,233,245,255,209,233,245,255,211,234,246,255,213,235,246,255,217,238,247,255,222,240,248,255,226,242,249,255,231,245,250,255,236,247,251,255,241,249,252,255,245,251,253,255,249,252,254,255,255,255,255,255]);let Jb=class extends Kn{constructor(){super(...arguments),this._configuration=new ux,this._passParameters=new K_,this._vao=null,this._vaoCount=0}initialize(){this._configuration.geometry=1,this.addHandles([$(()=>this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),Re)])}destroy(){this._passParameters.texture=_e(this._passParameters.texture),this._vao=_e(this._vao)}precompile(){this.techniques.precompile(kh,this._configuration)}render(e){const t=e.find(({name:a})=>a===ne.OPAQUE_ENVIRONMENT),i=this.techniques.get(kh,this._configuration);if(!i.compiled)return this.requestRender(1),t;const r=this.renderingContext;if(this._vao||(this._vao=TQ(r),this._vaoCount=this._vao.vertexCount("geometry")),!this._passParameters.texture){const a=new ft(1,512);a.wrapMode=33071,a.flipped=!0,this._passParameters.texture=new bt(r,a,CQ)}const n=r.bindTechnique(i,this.bindParameters,this._passParameters);return SQ(hP,this.bindParameters.camera.viewMatrix),n.setUniformMatrix4fv("view",hP),r.bindVAO(this._vao),n.assertCompatibleVertexAttributeLocations(this._vao),r.drawArrays(Ct.TRIANGLES,0,this._vaoCount),t}};function TQ(s){const e=p5(1,2,!1),{data:t,indices:i}=e[0][1],r=Ap.createBuffer(i.length),n=r.position;for(let a=0;a<i.length;++a){const o=3*i[a%3==0?a+2:a%3==2?a-2:a];n.set(a,0,t[o]),n.set(a,1,t[o+1]),n.set(a,2,t[o+2])}return new Mn(s,new Kt(s,Vr(Ap),r.buffer))}function SQ(s,e){Fr(s,e),s[12]=0,s[13]=0,s[14]=0,s[15]=1}Jb=u([R("esri.views.3d.environment.LocalAtmosphere")],Jb);const hP=Ie(),PQ=new Uint8ClampedArray([0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,16,0,0,0,16,0,0,0,16,0,0,0,17,0,0,0,17,0,0,0,18,0,0,0,18,0,0,0,19,0,0,0,19,0,0,0,19,0,0,0,20,0,0,0,20,0,0,0,21,0,0,0,21,0,0,0,22,0,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,28,9,0,0,28,9,0,0,29,9,0,0,29,8,0,0,30,8,0,0,30,8,0,0,31,8,0,0,31,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,33,8,0,0,33,8,0,0,34,7,0,0,35,7,0,0,35,7,0,0,36,7,0,0,36,7,7,0,37,7,7,0,37,7,7,0,38,7,7,0,38,13,7,0,39,13,7,0,39,13,6,0,40,13,6,0,40,12,6,0,41,12,6,0,41,12,6,0,41,12,6,0,42,12,6,0,42,12,6,0,43,12,6,0,43,12,6,0,44,12,6,0,44,11,6,0,45,11,6,6,45,11,6,6,46,11,5,5,47,11,5,5,47,11,5,5,48,11,5,5,48,10,5,5,49,10,5,5,49,10,5,5,50,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,52,15,5,5,52,14,5,5,53,14,5,5,54,14,5,5,54,14,5,5,55,14,5,5,55,14,5,5,56,13,4,4,57,13,4,4,57,13,4,4,58,13,4,4,58,13,4,4,59,13,4,4,59,17,4,4,60,17,4,4,60,17,4,4,60,17,4,4,61,17,4,4,61,16,4,4,62,16,4,4,63,16,4,4,63,16,8,4,64,16,8,4,64,16,8,4,65,15,8,4,66,15,8,4,66,15,8,4,67,19,8,4,68,19,8,4,68,18,7,4,69,18,7,4,69,18,7,4,69,18,7,4,70,18,7,4,70,18,7,4,71,18,7,4,71,18,7,4,72,17,7,3,73,17,7,3,73,21,7,3,74,21,7,3,74,20,7,3,75,20,7,3,76,20,7,3,76,20,7,3,77,20,7,3,77,20,7,3,78,20,7,3,78,20,7,7,78,19,6,6,79,19,10,6,80,19,10,6,80,22,9,6,81,22,9,6,81,22,9,6,82,22,9,6,83,22,9,6,83,21,9,6,84,21,9,6,84,21,9,6,85,21,9,6,86,21,9,6,86,23,9,6,87,23,9,6,87,23,9,6,87,23,9,6,88,23,9,6,88,23,9,6,89,23,8,6,90,23,8,6,90,22,8,6,91,22,8,6,91,25,8,6,92,25,8,5,93,25,8,5,93,24,8,5,94,24,8,5,94,24,11,5,95,24,11,5,96,24,11,5,96,26,11,5,97,26,11,5,97,26,11,5,97,26,10,5,98,26,10,5,98,26,10,5,99,25,10,5,100,25,10,5,100,25,10,5,101,25,10,5,101,25,10,5,102,27,10,5,103,27,10,5,103,27,10,5,104,27,10,5,104,27,12,5,105,26,12,5,106,26,12,5,106,29,12,5,106,29,12,5,106,29,12,7,107,28,12,7,108,28,12,7,108,28,12,7,109,28,12,7,109,30,12,7,110,30,11,7,111,30,11,7,111,30,11,7,112,30,11,7,112,29,11,7,113,29,11,7,114,29,11,7,114,31,11,7,115,31,11,7,115,31,11,7,115,31,11,7,116,31,11,7,116,33,13,7,117,33,13,9,117,32,13,9,118,32,13,9,118,32,13,9,119,34,15,8,120,34,15,8,120,34,15,8,121,36,15,8,121,36,15,8,122,36,15,8,122,35,15,8,123,37,14,8,124,37,14,8,124,37,14,8,124,37,14,8,124,39,14,8,125,39,16,8,125,38,16,8,126,38,16,8,127,38,16,8,127,40,16,10,128,40,16,10,128,40,16,10,129,42,18,10,129,41,18,10,130,41,18,10,130,43,18,10,131,43,18,10,131,42,17,10,132,42,17,12,132,42,17,12,133,44,17,12,133,44,17,12,133,46,17,11,134,46,17,11,134,45,19,11,135,45,19,11,135,47,19,11,136,47,19,11,136,47,19,11,137,47,19,11,137,48,20,11,138,48,20,11,138,50,20,13,139,50,20,13,139,49,20,13,140,49,22,13,140,51,22,13,141,51,22,13,141,50,22,13,142,52,22,13,142,52,21,12,143,53,21,12,143,53,21,12,143,53,21,12,143,53,21,14,144,53,23,14,144,55,23,14,145,55,23,14,145,56,23,14,146,56,23,14,146,57,24,14,147,57,24,14,147,59,24,16,148,59,24,16,148,58,24,15,149,58,26,15,149,58,26,15,149,60,26,15,150,60,26,15,150,61,25,15,151,61,25,15,151,62,25,17,152,62,25,17,152,64,25,17,152,64,27,17,152,63,27,17,153,63,27,17,153,65,27,17,153,66,28,17,154,66,28,17,154,67,28,16,155,67,28,16,155,67,30,16,155,69,29,18,156,69,29,18,156,68,29,18,157,70,29,18,157,70,29,18,157,71,31,18,158,71,31,18,158,72,30,19,159,72,30,19,159,74,30,19,159,73,30,19,160,73,32,19,160,74,32,19,161,74,32,21,161,76,32,21,161,78,33,21,161,78,33,21,161,79,35,20,162,78,34,20,163,79,34,22,164,81,36,22,164,82,36,22,165,81,35,22,166,82,37,21,167,84,37,21,167,85,36,21,168,86,38,23,169,88,38,23,169,88,38,23,170,88,39,23,170,89,39,24,171,91,40,24,171,92,40,24,172,93,40,24,173,94,41,25,173,95,41,25,174,96,42,25,175,98,42,25,175,99,43,26,176,99,43,26,177,101,45,26,177,102,44,26,178,103,46,27,179,104,46,27,179,105,46,27,179,106,45,28,180,108,47,28,180,108,46,28,181,109,48,28,182,111,48,29,182,111,49,29,183,114,49,29,184,114,50,30,184,114,50,30,185,116,51,30,185,117,51,30,186,119,52,31,187,119,53,31,187,121,53,31,188,122,54,33,188,123,54,32,189,124,55,32,189,125,55,32,189,126,56,34,190,128,56,34,190,128,57,33,191,130,57,33,191,131,58,35,192,131,58,35,192,133,59,34,193,134,60,35,194,135,60,35,194,136,61,37,195,139,61,37,195,139,62,36,196,141,62,36,196,141,63,38,197,142,63,38,197,143,64,39,198,144,64,39,198,146,66,39,198,146,67,39,198,147,67,38,199,147,68,40,199,149,68,40,200,150,69,40,200,152,70,41,201,154,71,41,201,154,71,42,202,155,72,42,202,156,73,41,203,157,73,43,203,158,74,42,204,160,75,44,204,161,76,44,204,162,77,44,205,164,77,45,205,165,78,45,206,166,79,45,206,168,80,46,207,169,81,46,207,170,83,47,207,171,83,47,207,172,83,47,207,174,85,48,208,175,85,48,208,177,85,48,209,178,87,49,209,180,87,49,210,181,87,49,210,182,89,50,210,182,89,50,211,185,91,50,211,186,91,51,212,186,93,51,212,189,94,52,212,190,95,51,213,192,96,51,213,193,96,53,213,194,97,52,214,195,98,54,214,197,98,55,215,198,100,55,215,199,101,55,215,200,102,55,216,202,103,55,216,203,104,55,216,204,105,57,216,205,106,57,216,207,107,58,216,208,108,58,217,209,109,59,217,210,110,60,217,211,111,60,218,212,112,61,218,213,113,61,218,214,114,62,219,217,115,63,219,217,116,64,219,218,118,64,220,219,119,65,220,220,121,66,220,222,121,67,221,222,122,67,221,222,123,68,221,223,124,69,222,224,125,70,222,225,127,71,222,226,128,72,223,228,129,73,223,228,130,74,223,229,132,75,223,230,135,79,224,231,138,81,224,233,141,84,224,233,144,87,225,235,147,91,225,236,150,94,225,237,154,97,225,238,158,102,225,239,161,107,225,239,165,110,225,240,168,114,226,241,172,118,226,241,176,122,226,241,181,126,226,242,183,130,227,243,186,135,227,243,190,139,227,244,194,143,227,244,197,147,228,244,200,150,228,245,204,154,228,245,207,157,228,245,210,161,229,246,212,164,229,246,215,167,229,246,217,169,229,246,220,172,230,247,221,174,230]),hf=128,uP=-C0,dP=0,Qv=50,MQ=()=>1-511/512,$Q=Sf([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);let ew=class extends Kn{constructor(e){super(e),this._passParameters=new K_,this._configuration=new ux,this._vao=null,this._fadeVao=null,this._texV1=1;const t=e.view,i=Zt(t.spatialReference),{outerAtmosphereRimWidth:r,radius:n}=i;this._planetRadius=n,this._innerRimFactor=1+uP/n,this._middleRimFactor=1+dP/n,this._outerRimFactor=1+r/n,this._texV0=dP/r,this._texVScale=this._texV1-this._texV0;const a=t.stage.renderView.techniques;a.precompile(kh,this._configuration),this._configuration.geometry=2,a.precompile(kh,this._configuration)}initialize(){this.addHandles($(()=>this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),Re))}destroy(){this._passParameters.texture=_e(this._passParameters.texture),this._fadeVao=_e(this._fadeVao),this._vao=_e(this._vao)}render(e){const t=e.find(({name:r})=>r===ne.OPAQUE_ENVIRONMENT);this._update();const i=this.renderingContext;if(!this._passParameters.texture){const r=new ft(1,512);r.wrapMode=33071,r.flipped=!0,this._passParameters.texture=new bt(i,r,PQ)}if(this._passParameters.undergroundFadeAlpha<1){this._vao??=this._createRibbon(i),this._configuration.geometry=0;const r=this.techniques.get(kh,this._configuration);if(!r.compiled)return this.requestRender(1),t;i.bindTechnique(r,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(Ct.TRIANGLES,0,this._vao.vertexCount("geometry"))}if(this._passParameters.undergroundFadeAlpha>0){this._fadeVao??=Wo(i),this._configuration.geometry=2;const r=this.techniques.get(kh,this._configuration);if(!r.compiled)return this.requestRender(1),t;i.bindTechnique(r,this.bindParameters,this._passParameters),i.bindVAO(this._fadeVao),i.drawArrays(Ct.TRIANGLE_STRIP,0,this._fadeVao.vertexCount("geometry"))}return t}_update(){const e=this.bindParameters.camera,t=x(),i=this._planetRadius,r=fe(e.eye),n=r-i;if(n<0){const f=Math.min(-n/5e3,1);this._passParameters.undergroundFadeAlpha=f}else this._passParameters.undergroundFadeAlpha=0;const a=Math.max(Qv,n),o=i+uP;this._passParameters.innerScale=RQ(i+a,i,o)-1,this._passParameters.altitudeFade=u$(n),ee(t,e.eye,(i+Qv)/r),pP(t,e.center,e.up,i,this._passParameters.silhouette);const l=this._computeScreenRimWidth(e,t,e.up,this._passParameters.silhouette),c=MQ(),h=$Q(n);let d=this._texV0+c*this._texVScale,m=this._texV0+l*h*this._texVScale;if(n>Qv){pP(e.eye,e.center,e.up,i,this._passParameters.silhouette);const f=this._computeScreenRimWidth(e,e.eye,e.up,this._passParameters.silhouette),g=U((f-1.5)/(l-1.5),0,1);d=this._texV0+g*c*this._texVScale,m=this._texV0+Me(this._texV1,l*h,g)*this._texVScale}Xi(this._passParameters.texV,d,m)}_createRibbon(e){const t=d$(3+3*hf*3),i=new Uint32Array(3*hf*5);t[0]=0,t[1]=0,t[2]=-1;for(let a=0;a<hf;a++){const o=9*a+3;t[o]=a,t[o+1]=this._innerRimFactor,t[o+2]=-1,t[o+3]=a,t[o+4]=this._middleRimFactor,t[o+5]=0,t[o+6]=a,t[o+7]=this._outerRimFactor,t[o+8]=1;const l=3*a+1,c=a===hf-1?1:l+3,h=15*a;i[h]=l,i[h+1]=l+1,i[h+2]=c+1,i[h+3]=c+1,i[h+4]=c,i[h+5]=l,i[h+6]=l+1,i[h+7]=l+2,i[h+8]=c+2,i[h+9]=c+2,i[h+10]=c+1,i[h+11]=l+1,i[h+12]=l,i[h+13]=c,i[h+14]=0}const r=Ap.createBuffer(i.length),n=r.position;for(let a=0;a<i.length;++a){const o=3*i[a];n.set(a,0,t[o]),n.set(a,1,t[o+1]),n.set(a,2,t[o+2])}return new Mn(e,new Kt(e,Vr(Ap),r.buffer))}_computeScreenRimWidth(e,t,i,r){return ce(Qc,r.center,r.v2),ee(uf,Qc,this._outerRimFactor),J$(Zv,t,Qc,i),gC(Qc,Zv,e.projectionMatrix,e.viewport,Qc),gC(uf,Zv,e.projectionMatrix,e.viewport,uf),Ht(Qc,uf)/e.height}};function pP(s,e,t,i,r){const n=fe(s),a=i*Math.sqrt(n*n-i*i)/n,o=Math.sqrt(i*i-a*a),l=r.v1,c=r.v2;return ee(r.center,s,o/n),ti(l,s,e),Gs(l)<1&&ti(l,s,t),ee(l,l,a/fe(l)),ti(c,l,s),ee(c,c,a/fe(c)),a}ew=u([R("esri.views.3d.environment.MarsAtmosphere")],ew);const Zv=Ie(),Qc=x(),uf=x();function RQ(s,e,t){return s*s/(Math.sqrt(s*s-e*e)*Math.sqrt(s*s-t*t)+e*t)}let OQ=class{constructor(e){this._totalCount=e,this._componentCountCache=-1,this._indexRanges=[0,e]}allVisible(){return this.componentCount===this._totalCount}allInvisible(){return this._indexRanges.length===0}isVisible(e){if(e<0||e>=this._totalCount)return!1;if(this.allVisible())return!0;const t=this._indexRanges;let i=0,r=t.length/2;if(e<t[2*i]||e>t[2*r]+t[2*r+1])return!1;for(;r-i>0;){const n=Math.floor(.5*(i+r)),a=t[2*n];if(e<a){if(r-i===1)return!1;r=n;continue}if(e<a+t[2*n+1])return!0;if(r-i===1)return!1;i=n+1}return!1}get componentCount(){if(this._componentCountCache===-1){const e=this._indexRanges;let t=0;for(let i=0;i<e.length;i+=2)t+=e[i+1];this._componentCountCache=t}return this._componentCountCache}reset(e){e==="all"||e.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=DQ(e),this._componentCountCache=-1}forEachComponent(e){const t=this._indexRanges;for(let i=0;i<t.length;i+=2){const r=t[i],n=r+t[i+1];for(let a=r;a<n;a++)if(!e(a))return!1}return!0}forEachComponentRange(e){const t=this._indexRanges;for(let i=0;i<t.length;i+=2){const r=t[i];if(!e(r,r+t[i+1]))return!1}return!0}computeOffsetRanges(e){const t=new Array(this._indexRanges.length),i=this._indexRanges;for(let r=0;r<i.length;r+=2){const n=i[r],a=n+i[r+1],o=e[n],l=e[a];t[r]=o,t[r+1]=l-o}return t}};function DQ(s){const e=new Array;if(s.length===0)return e;let t=s[0],i=1;for(let r=1;r<s.length;r++){const n=s[r];t+i===n?i+=1:(e.push(t),e.push(i),t=n,i=1)}return e.push(t),e.push(i),e}let EQ=class{constructor(e,t){this.offsets=t,this._highlightsInOrder=[],this.pickability=null,this.componentHighlights=new Map,this.verticalOffsets=null,this._cachedGeometryRanges=null,this._cachedHighlightRangesMap=null,this._cachedShadowmapRanges=null;const i=this.count;this.visibility=new OQ(i),this.materialDataBuffer=e.getBuffer(i),this.materialDataIndices=new Uint16Array(i);for(let r=0;r<i;r++)this.materialDataIndices[r]=this.materialDataBuffer.acquireIndex()}destroy(){for(let e=0;e<this.count;e++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[e])}get count(){return this.offsets.length-1}get geometryRanges(){return this._cachedGeometryRanges==null&&(this._cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this._cachedGeometryRanges}get highlightRangesMap(){return this.componentHighlights.size===0?null:(this._updateCachedHighlightRanges(),this._cachedHighlightRangesMap)}get shadowmapRanges(){return this.componentHighlights.size===0?this.geometryRanges:(this._updateCachedHighlightRanges(),this._cachedShadowmapRanges)}markHighlightsDirty(){this._cachedHighlightRangesMap=null,this._cachedShadowmapRanges=null}markVisibilityDirty(){this._cachedGeometryRanges=null,this.markHighlightsDirty()}updateHighlights(e){this._updateHighlightOrder(e)&&(this.markHighlightsDirty(),this._updateCachedHighlightRanges())}_updateHighlightOrder(e){const{_highlightsInOrder:t}=this;let i=t.length!==e.length;t.length=Math.min(e.length,8);for(let r=0;r<e.length;++r){const n=e.at(r).name;t.length<r?(i=!0,t.push(n)):t[r]!==n&&(t[r]=n,i=!0)}return i}_updateCachedHighlightRanges(){if(this._cachedHighlightRangesMap==null||this._cachedShadowmapRanges==null){const{highlightRangesMap:e,shadowmapRangesMap:t}=AQ(this.componentHighlights,this.visibility,this.offsets,this._highlightsInOrder);this._cachedHighlightRangesMap=e,this._cachedShadowmapRanges=t}}};function AQ(s,e,t,i){const r=new Map,n=[];if(s.size>0){let a=t.length;e.forEachComponent(o=>{let l=!1;for(let c=i.length-1;c>=0;--c){const h=i[c];if((s.get(h)?.[o]??0)>0){const m=Aa(r,h,()=>[]),f=t[o],g=t[o+1];m.push(f),m.push(g-f),l||=h===aa;break}}return l||(a!==o-1&&(n.length>0&&n.push(t[a+1]-n[n.length-1]),n.push(t[o])),a=o),!0}),n.length>0&&n.push(t[a+1]-n[n.length-1])}return{highlightRangesMap:r,shadowmapRangesMap:n}}let IQ=class{constructor(e,t,i,r,n,a){this.transform=e,this.toMapSpace=t,this.obb=i,this.componentData=r,this.renderable=n,this.intersectionGeometry=a,this.visible=!1,this.offsetObb=null,this._aabbInWorldCoordinates=null}destroy(){this.intersectionGeometry=Q(this.intersectionGeometry),this.renderable=Q(this.renderable),this.componentData=Q(this.componentData)}get aabbInWorldCoordinates(){let e=this._aabbInWorldCoordinates;return e||(e=this._computeAabbInWorldCoordinates(),this._aabbInWorldCoordinates=e),e}_computeAabbInWorldCoordinates(){const e=Ka(),{positions:t}=this.intersectionGeometry;if(Math.floor(t.length/3)>0){const{rotationScale:i,position:r}=this.transform;let n=1/0,a=1/0,o=1/0,l=-1/0,c=-1/0,h=-1/0;const d=x();for(let m=0;m<t.length;m+=3)be(d,t[m+0],t[m+1],t[m+2]),fn(d,d,i),ce(d,d,r),n=Math.min(n,d[0]),a=Math.min(a,d[1]),o=Math.min(o,d[2]),l=Math.max(l,d[0]),c=Math.max(c,d[1]),h=Math.max(h,d[2]);e[0]=n,e[1]=a,e[2]=o,e[3]=l,e[4]=c,e[5]=h}return e}};function LQ(s,e,t,i,r,n,a){const o=n-a,l=e-s,c=new Float64Array(4*l);for(let h=0;h<l;++h){const d=3*(h+s),m=r*t[d+0],f=i[m+0],g=i[m+1],_=o/(i[m+2]-a),v=f*_,b=g*_,T=r*t[d+1],w=i[T+0],S=i[T+1],C=o/(i[T+2]-a),P=w*C,M=S*C,O=r*t[d+2],D=i[O+0],A=i[O+1],F=o/(i[O+2]-a),E=D*F,z=A*F,L=4*h;c[L+0]=Math.min(v,P,E),c[L+1]=Math.min(b,M,z),c[L+2]=Math.max(v,P,E),c[L+3]=Math.max(b,M,z)}return c}function FQ(s,e,t,i,r){const n=e-s,a=new Float64Array(4*n);for(let o=0;o<n;++o){const l=3*(o+s),c=r*t[l+0],h=i[c+0],d=i[c+1],m=r*t[l+1],f=i[m+0],g=i[m+1],_=r*t[l+2],v=i[_+0],b=i[_+1],T=4*o;a[T+0]=Math.min(h,f,v),a[T+1]=Math.min(d,g,b),a[T+2]=Math.max(h,f,v),a[T+3]=Math.max(d,g,b)}return a}function VQ(s,e){return new(kQ(s))(e)}function kQ(s){return s<128?Uint8Array:s<32768?Uint16Array:s<1<<31?Uint32Array:Array}function mP(s,e,t,i){const[r,n,a]=i??s,o=a-t,l=e/Math.sqrt(r*r+n*n+o*o);s[0]+=r*l,s[1]+=n*l,s[2]+=o*l}let kA=class{constructor(e,t){this.elementCount=e,this.model=t,this._elementIndexMap=null,this._bspNodes=[],this._generatedBVH=!1,this.localMode=t.localMode,this.planetCenterZ=t.planetCenterZ,this.geometryMinZ=t.geometryMinZ,this.planetCenter=Qe(0,0,this.planetCenterZ),this.maxBspNodeDepth=t.maxBspNodeDepth??8,this.minElementCountForBVH=t.minElementCountForBVH??15,this.minBspNodeElementCount=t.minBspNodeElementCount??5}get elementIndexMap(){return this._ensureBVH(),this._elementIndexMap}get _skipBVH(){return this.elementCount<this.minElementCountForBVH||this.geometryMinZ<.5*this.planetCenterZ}_ensureBVH(){this._generatedBVH||this._skipBVH||this._bspNodes.length===0&&this._generateBsp()}intersectRay(e,t,i){this.elementCount<1||(this._skipBVH?this._intersectRayWithoutBVH(i):this._intersectRayWithBVH(e,t,i))}_intersectRayWithoutBVH(e){this._intersectRange(0,this.elementCount)}_intersectRange(e,t){this.model.intersectRange(e,t)}_intersectRayWithBVH(e,t,i){this._ensureBVH(),i?this._intersectGeometryWithBVHVerticalRay(e):this._intersectGeometryWithBVHGeneralRay(e,t)}_intersectGeometryWithBVHVerticalRay(e){let t=e[0],i=e[1];if(!this.localMode){const{geometryMinZ:a,planetCenterZ:o}=this,l=(a-o)/(e[2]-o);t=e[0]*l,i=e[1]*l}const{_bspNodes:r}=this;let n=0;for(;n>=0;){const a=r[n],{d:o,dim:l,minIndexIndex:c,minMidIndexIndex:h,maxMidIndexIndex:d,maxIndexIndex:m,aabb2D:f}=a;if(t<f[0]||t>f[2]||i<f[1]||i>f[3])break;if(l===-1||a.child0===-1&&a.child1===-1){this._intersectRange(c,m);break}{this._intersectRange(h,d);const g=(l===0?t:i)-o;if(g<0){if(a.child0===-1){this._intersectRange(c,h);break}n=a.child0}else{if(!(g>0))break;if(a.child1===-1){this._intersectRange(d,m);break}n=a.child1}}}}_intersectGeometryWithBVHGeneralRay(e,t){let i=e[0],r=e[1],n=t[0],a=t[1];const{geometryMinZ:o}=this;if(!this.localMode){let g=0,_=1;const v=Math.min(.5*this.planetCenterZ,o),b=e[2],T=t[2];if(b<v&&T<v||(b<v&&(g=(v-b)/(T-b)),T<v&&(_=(v-b)/(T-b)),g>_))return;const w=(1-g)*e[0]+g*t[0],S=(1-g)*e[1]+g*t[1],C=(1-g)*e[2]+g*t[2],P=(1-_)*e[0]+_*t[0],M=(1-_)*e[1]+_*t[1],O=(1-_)*e[2]+_*t[2],{planetCenterZ:D}=this,A=o-D,F=A/(C-D);i=w*F,r=S*F;const E=A/(O-D);n=P*E,a=M*E}const l=n-i,c=a-r,h=this._bspNodes;let d=1;{const{aabb2D:g}=h[0],_=(T,w,S,C)=>{if(Math.abs(w)<1e-5*Math.max(C-S,1))return!1;const P=w>0,M=P?C:S,O=T+d*w;return(P?O<M:O>M)&&(d=Math.max((M-T)/w,d),!0)},v=()=>_(i,l,g[0],g[2]),b=()=>_(r,c,g[1],g[3]);Math.abs(l)>=Math.abs(c)?v()||b():b()||v()}const m=[0,0,d];let f=0;for(;f<m.length;){const g=m[f];let _=m[f+1],v=m[f+2];if(f+=3,_>v)continue;const b=h[g],{minIndexIndex:T,maxIndexIndex:w}=b,{child0:S,child1:C,minMidIndexIndex:P,maxMidIndexIndex:M,aabb2D:O,d:D,dim:A}=b;{const F=i+_*l,E=i+v*l,z=Math.min(F,E),L=Math.max(F,E),I=O[0],ie=O[2];if(L<I||ie<z)continue;if(z<I){const N=(I-i)/l;l>0?_=Math.max(_,N):v=Math.min(v,N)}if(ie<L){const N=(ie-i)/l;l>0?v=Math.min(v,N):_=Math.max(_,N)}}{const F=r+_*c,E=r+v*c,z=Math.min(F,E),L=Math.max(F,E),I=O[1],ie=O[3];if(L<I||ie<z)continue;if(z<I){const N=(I-r)/c;c>0?_=Math.max(_,N):v=Math.min(v,N)}if(ie<L){const N=(ie-r)/c;c>0?v=Math.min(v,N):_=Math.max(_,N)}}if(S===-1&&C===-1)this._intersectRange(T,w);else{const F=A===0?i:r,E=A===0?l:c,z=F+_*E,L=F+v*E,I=Math.min(z,L),ie=Math.max(z,L),N=U((D-F)/E,0,d);T<P&&I<=D&&(S!==-1?(m.push(S),m.push(E>=0?_:Math.max(_,N)),m.push(E>=0?Math.min(v,N):v)):this._intersectRange(T,P)),this._intersectRange(P,M),M<w&&D<=ie&&(C!==-1?(m.push(C),m.push(E>=0?Math.max(_,N):_),m.push(E>=0?v:Math.min(v,N))):this._intersectRange(M,w))}}}_generateBsp(){const{elementCount:e}=this;if(e<1)return;const t=VQ(e,e);this._elementIndexMap=t;for(let f=0;f<e;++f)t[f]=f;const i=this.model.getAabbs2D();let r=0;const n=this._bspNodes;n.length=0;const{localMode:a}=this;let o=!1;if(!a){const{planetCenterZ:f,geometryMinZ:g}=this;o=f>=0||g<.5*f}const l=[],c=(f,g,_,v,b)=>{l.push(f),l.push(g),l.push(_),l.push(v<0?-1:(b?0:1)+2*v)},{maxBspNodeDepth:h,minBspNodeElementCount:d}=this,m=(f,g,_,v,b)=>{const T=n.length;if(T>0&&(o||_>=h||g-f<d))return;const w=Mt();UQ(w,f,g,t,i);const{d:S,dim:C}=a?zQ(w):BQ(w),{rangeMidStart:P,rangeMidEnd:M}=NQ(f,g,C,S,t,i),O=_===h-1,D=!O&&P>=f+d,A=!O&&g>=M+d;if(D||A||T===0){const F=new HQ(f,P,M,g,C,S,w);if(D&&c(f,P,_+1,T,!0),A&&c(M,g,_+1,T,!1),n.push(F),v!==-1){const E=n[v];b?E.child0=T:E.child1=T}}};for(c(0,e,0,-1,!1);r<l.length;){const f=l[r],g=l[r+1],_=l[r+2],v=l[r+3];r+=4;const b=v>>1;m(f,g,_,b,v-(b<<1)==0)}this._generatedBVH=!0}};function zQ(s){const e=s[0],t=s[1],i=s[2],r=s[3];let n,a;return i-e>=r-t?(a=.5*(e+i),n=0):(a=.5*(t+r),n=1),{d:a,dim:n}}function BQ(s){const e=s[0],t=s[1],i=s[2],r=s[3];let n,a;return i-e>=r-t?(n=0,a=.5*(e+i)):(n=1,a=.5*(t+r)),{dim:n,d:a}}function NQ(s,e,t,i,r,n){let a=s;{let h=e;for(;a<h;){const d=r[a];fP(d,t,i,n)<0?++a:(--h,r[a]=r[h],r[h]=d)}}const o=a;let l=a,c=e;for(;l<c;){const h=r[c-1];fP(h,t,i,n)>0?--c:(r[c-1]=r[l],r[l]=h,++l)}return{rangeMidStart:o,rangeMidEnd:c}}function fP(s,e,t,i){const r=4*s,n=i[r+0+e];return i[r+2+e]<t?-1:n>t?1:0}function UQ(s,e,t,i,r){let n=1/0,a=1/0,o=-1/0,l=-1/0;for(let c=e;c<t;++c){const h=4*i[c];n=Math.min(n,r[h+0]),a=Math.min(a,r[h+1]),o=Math.max(o,r[h+2]),l=Math.max(l,r[h+3])}s[0]=n,s[1]=a,s[2]=o,s[3]=l}let HQ=class{constructor(e,t,i,r,n,a,o){this.minIndexIndex=e,this.minMidIndexIndex=t,this.maxMidIndexIndex=i,this.maxIndexIndex=r,this.dim=n,this.d=a,this.aabb2D=o,this.child0=-1,this.child1=-1}},qQ=class{constructor(e,t,i,r,n,a,o,l,c){this.componentIndex=e,this.vertexData=t,this.vertexStride=i,this.indexData=r,this.startTriangleNumber=n,this.endTriangleNumber=a,this.geometryMinZ=o,this.planetCenterZ=l,this.localMode=c,this.maxBspNodeDepth=8,this.minElementCountForBVH=20,this.minBspNodeElementCount=10,this.rayDirection=x(),this.ray0=x(),this.isVerticalRay=!1,this._triangleHitCallback=gP,this.totalElevationOffset=0,this.normalRequired=!1,this._bvh=new kA(a-n,this)}getAabbs2D(){return this.localMode?FQ(this.startTriangleNumber,this.endTriangleNumber,this.indexData,this.vertexData,this.vertexStride):LQ(this.startTriangleNumber,this.endTriangleNumber,this.indexData,this.vertexData,this.vertexStride,this.geometryMinZ,this.planetCenterZ)}get numTriangles(){return this.endTriangleNumber-this.startTriangleNumber}intersectRay(e,t,i,r,n,a){q(this.ray0,e),zi(this.rayDirection,t,e),this.isVerticalRay=i,this.totalElevationOffset=r,this.normalRequired=a,this._triangleHitCallback=n,this._bvh.intersectRay(e,t,i),this._triangleHitCallback=gP}intersectRange(e,t){const i=this._bvh.elementIndexMap;zA(this.ray0,this.rayDirection,e,t,this.indexData,this.vertexData,this.vertexStride,this.totalElevationOffset,this.planetCenterZ,this.normalRequired,this._triangleHitCallback,i,this.startTriangleNumber)}getTriangleElevationOffset(e){return this.totalElevationOffset}};function zA(s,e,t,i,r,n,a,o,l,c,h,d=null,m=0){o!==0?ML(s,e,t,i,r,n,a,o,l,c,h,d,m):a$(s,e,t,i,r,n,a,c,h,d,m)}function gP(){}function GQ(s,e,t){const i=s.count;if(e>=i)return;s.pickability??=new Uint32Array(0);let r=s.pickability;const n=NA(r),a=e/n|0,o=e-n*a,l=(i-1)/n|0,c=r;if(!(e<c.length*n)&&!t){const h=a+1,d=Math.ceil(c.length*vI),m=l+1;let f=Math.max(h,d);f=Math.min(f,m),s.pickability=r=new Uint32Array(f),r.set(c)}a<r.length&&(r[a]=WQ(r[a],o,!t))}function BA(s,e){if(s==null)return!0;const t=NA(s);return!(e<s.length*t)||jQ(s,e,t)}function jQ(s,e,t){const i=e/t|0,r=e-i*t;return!QQ(s[i],r)}function NA(s){return s.BYTES_PER_ELEMENT*8}function WQ(s,e,t){return s&~(1<<e)|(t?1:0)<<e}function QQ(s,e){return!!(s&1<<e)}let ZQ=class{constructor(e,t,i,r,n,a,o,l){this.vertexData=e,this.vertexStride=t,this.indexData=i,this._components=r,this._componentAabbs3D=n,this.geometryMinZ=a,this.planetCenterZ=o,this.localMode=l,this.maxBspNodeDepth=6,this.minElementCountForBVH=10,this.minBspNodeElementCount=3,this._ray0=JQ,this._ray1=eZ,this._invDir=x(),this._componentVerticalOffsets=null,this._verticalOffset=null,this._tolerance=0,this._intersectionOptions=tZ,this._callback=_P,this.rayDirectionC=x(),this._componentIndexMap=null,this._bvh=new kA(r.count,this),this.componentIntersectionData=new Array(r.count)}get numComponents(){return this._components.count}get minZGlobal(){return this.geometryMinZ-this.planetCenterZ}getAabbs2D(){return this.localMode?this.getAabbs2DLocal():this.getAabbs2DGlobal()}getAabbs2DGlobal(){const{numComponents:e,planetCenterZ:t,minZGlobal:i}=this,r=L0(4*e),n=this._componentAabbs3D;for(let a=0;a<e;++a){const o=6*a,l=n[o+0],c=n[o+1],h=n[o+2],d=n[o+3],m=n[o+4],f=i/(h-t),g=i/(n[o+5]-t),_=Math.min(l*f,l*g),v=Math.min(c*f,c*g),b=Math.max(d*f,d*g),T=Math.max(m*f,m*g),w=4*a;r[w+0]=_,r[w+1]=v,r[w+2]=b,r[w+3]=T}return r}getAabbs2DLocal(){const{numComponents:e}=this,t=L0(4*e),i=this._componentAabbs3D;for(let r=0;r<e;++r){const n=6*r,a=i[n+0],o=i[n+1],l=i[n+3],c=i[n+4],h=4*r;t[h+0]=a,t[h+1]=o,t[h+2]=l,t[h+3]=c}return t}intersectRay(e,t,i,r,n,a){const{isVerticalRay:o}=i;this._ray0=e,this._ray1=t,this._componentVerticalOffsets=n??null,this._verticalOffset=a??null,this._tolerance=i.tolerance,this._intersectionOptions=i,this._componentIndexMap=this._bvh.elementIndexMap,$L(e,t,this._invDir),this._callback=r,this._bvh.intersectRay(e,t,o),this._callback=_P}intersectRange(e,t){const i=this._componentIndexMap,{pickability:r,visibility:n}=this._components;for(let a=e;a<t;++a){const o=i?i[a]:a;BA(r,o)&&n.isVisible(o)&&this._intersectComponent(o)}}getComponentTriangleCount(e){const t=this._components.offsets,i=t[e]/3;return t[e+1]/3-i}getComponentAabb3D(e,t){const i=this._componentAabbs3D,r=6*e;return t[0]=i[r],t[1]=i[r+1],t[2]=i[r+2],t[3]=i[r+3],t[4]=i[r+4],t[5]=i[r+5],t}_intersectComponent(e){const t=this.getComponentAabb3D(e,XQ);let i=!1;const{localMode:r,_componentVerticalOffsets:n,_verticalOffset:a,_ray0:o,_ray1:l,_invDir:c,planetCenterZ:h,_tolerance:d,rayDirectionC:m,componentIntersectionData:f}=this,{isVerticalRay:g}=this._intersectionOptions,_=this._components.offsets,v=q(YQ,o),b=q(KQ,l),T=n?.[e]??0,w=T+(a?.offset??0);if(w!==0&&(r?(v[2]=o[2]-w,b[2]=l[2]-w,i=!0):(a!=null&&(a.componentOffset=T),g&&(mP(v,-w,h,o),mP(b,-w,h,l),i=!0))),a==null||i||w===0||a.applyToAabb(t),!RL(t,v,c,d))return;zi(m,b,v);const S=_[e]/3,C=_[e+1]/3,P=C-S,M=(z,L,I)=>{this._callback(z,L,e,I)},{vertexData:O,vertexStride:D,indexData:A,_intersectionOptions:F}=this,{normalRequired:E}=F;if(P>iZ){let z=f[e];z==null&&(z=new qQ(e,O,D,A,S,C,this.geometryMinZ,h,r),f[e]=z),z.intersectRay(v,b,g,i?0:w,M,E)}else zA(v,m,S,C,A,O,D,i?0:w,h,E,M)}};const XQ=Ka(),YQ=x(),KQ=x(),JQ=x(),eZ=x(),_P=()=>{},tZ=new Pw,iZ=40;let sZ=class{constructor(e,t,i,r,n,a){this._componentOffsets=a,this._accelerationData=new vA(i,r,n,new yR(e,3,t))}intersectRay(e,t,i,r){const n=(a,o,l)=>{const c=rZ(this._componentOffsets,o);r(a,o,c,l)};this._accelerationData.intersectRay(e,t,i,n)}};function rZ(s,e){const{length:t}=s;if(t===0||e<s[0])return-1;if(e>s[t-1])return t;let i=0,r=t-1;for(;r-i>1;){const n=Math.round(.5*(i+r));e<=s[n]?r=n:i=n}return i}let nZ=class{constructor(e,t,i,r){this.viewingMode=e,this.positionData=t,this._components=i,this._needsElevationAlignment=r,this.verticalOffset=null,this.componentVerticalOffsets=null,this._planetCenter=x(),this._componentBvh=null,this._aabb=Ka(),this._indices=t.indices?rR(t.indices):sR(t.positions.length/3),this._positions=t.positions}destroy(){this._positions=null,this._indices=null,this._perComponentAabbs=null,this._componentBvh=null}getComponentAabb(e,t){const i=this._ensureComponentAabbs(),r=6*e;return t[0]=i[r],t[1]=i[r+1],t[2]=i[r+2],t[3]=i[r+3],t[4]=i[r+4],t[5]=i[r+5],t}getComponentAabbs(){return this._ensureComponentAabbs()}_ensureComponentAabbs(){return this._perComponentAabbs||(this._perComponentAabbs=this._computePerComponentAabbs()),this._perComponentAabbs}getComponentPositions(e,t){t.indices=this._indices,t.data=this._positions,t.stride=3,t.startIndex=this._components.offsets[e],t.endIndex=this._components.offsets[e+1]}intersect(e,t,i,r,n,a,o){this.verticalOffset=i,this.componentVerticalOffsets=r;const{position:l}=n,c=zi(aZ,e,l),h=zi(oZ,t,l),d=qw(lZ,n.rotationScale);fn(c,c,d),fn(h,h,d);const m=qp(hZ,d);if(this.viewingMode===1){const g=this._planetCenter;La(g,l),fn(g,g,d)}const f=(g,_,v,b)=>{o(v,g,b?fn(cZ,b,m):null,_)};this._intersectComponents(c,h,r,i,f,a)}_computePerComponentAabbs(){const e=this._aabb,t=.5*(e[0]+e[3]),i=.5*(e[1]+e[4]),r=.5*(e[2]+e[5]),n=this._components.count,a=d$(6*n),o=this._indices,l=this._positions,c=this._components.offsets;let h=0,d=1/0,m=1/0,f=1/0,g=-1/0,_=-1/0,v=-1/0;for(let b=0;b<n;b++){const T=c[b],w=c[b+1];let S=1/0,C=1/0,P=1/0,M=-1/0,O=-1/0,D=-1/0;if(T<w)for(let A=T;A<w;A++){const F=3*o[A],E=l[F],z=l[F+1],L=l[F+2];S=Math.min(S,E),C=Math.min(C,z),P=Math.min(P,L),M=Math.max(M,E),O=Math.max(O,z),D=Math.max(D,L)}else S=t,C=i,P=r,M=t,O=i,D=r;a[h++]=S,a[h++]=C,a[h++]=P,a[h++]=M,a[h++]=O,a[h++]=D,d=Math.min(d,S),m=Math.min(m,C),f=Math.min(f,P),g=Math.max(g,M),_=Math.max(_,O),v=Math.max(v,D)}return this._aabb[0]=d,this._aabb[1]=m,this._aabb[2]=f,this._aabb[3]=g,this._aabb[4]=_,this._aabb[5]=v,a}_intersectComponents(e,t,i,r,n,a){let o=this._componentBvh;o==null&&(o=this._needsElevationAlignment?new ZQ(this._positions,yP,this._indices,this._components,this._ensureComponentAabbs(),this.geometryMinZ,this.planetCenterZ,this.localMode):new sZ(this._positions,yP,this._indices,0,this.numTriangles,this._components.offsets),this._componentBvh=o),o.intersectRay(e,t,a,n,i??void 0,r??void 0)}get geometryMinZ(){return this._aabb[2]}get planetCenterZ(){return this._planetCenter[2]}get numTriangles(){return this._indices.length/3}get localMode(){return this.viewingMode===2}get positions(){return this._positions}get indices(){return this._indices}get aabb(){return this._ensureComponentAabbs(),this._aabb}};const aZ=x(),oZ=x(),lZ=Pn(),cZ=x(),hZ=Pn(),yP=3;let uZ=class{constructor(e,t,i){this.material=e,this.geometry=t,this.meta=i}destroy(){this.material.dispose(),this.geometry.dispose()}},dZ=class{constructor(e,t,i,r){this.vao=e,this.primitiveType=t,this.parameters=i,this.indexed=r}dispose(){this.vao.dispose()}};function pZ(s,e){const t=new ss,{eye:i,frustum:r,viewForward:n}=s;e.forAll(a=>{const o=a.offsetObb!=null?a.offsetObb:a.obb,l=We(zi(ar,o.center,i),n),c=o.projectedRadius(n);if(t.within(l-c)&&t.within(l+c))return;const h=yZ(o,r);if(h===-1)return;if(h===0)return ga.far=l+c,ga.near=l-c,void t.union(ga);const d=df.pushNew();d.near=l-c,d.far=l+c,d.mask=h,d.object=a});for(let a=0;a<df.length;a++){const o=df.data[a];if(t.within(o.near)&&t.within(o.far))continue;ga.far=o.far,ga.near=1/0,_Z(o.object.offsetObb!=null?o.object.offsetObb:o.object.obb,i,mZ,c=>{let h=fZ;for(let d=0;d<UA&&c.length>0;d++){if(!(o.mask&1<<d))continue;gZ(r[d],c,h);const m=c;c=h,h=m}for(let d=0;d<c.length;d+=3){be(Ts,c.data[d],c.data[d+1],c.data[d+2]);const m=We(zi(Ts,Ts,i),n);ga.near=Math.min(ga.near,m)}})===0&&(ga.near=0),t.union(ga)}return df.length=0,t}const df=new zt({allocator:s=>s||{near:1/0,far:-1/0,mask:0,object:null},deallocator:s=>(s.object=null,s)}),ga=new ss,Ts=x(),pl=x(),mZ=new zt({deallocator:null}),fZ=new zt({deallocator:null});function gZ(s,e,t){t.length=0;const i=e.length-3;Xv(Ts,e,i);const r=or(s,Ts);r<=0&&(t.push(Ts[0]),t.push(Ts[1]),t.push(Ts[2]));let n=0,a=r;for(;n<i;n+=3){Xv(pl,e,n);const o=or(s,pl);a*o<0&&(kt(Ts,pl,Ts,o/(o-a)),Ss(t,Ts)),o<=0&&Ss(t,pl),a=o,q(Ts,pl)}a*r<0&&(Xv(pl,e,i),kt(Ts,pl,Ts,r/(r-a)),Ss(t,Ts))}function Xv(s,e,t){return be(s,e.data[t],e.data[t+1],e.data[t+2])}function Ss(s,e){s.push(e[0]),s.push(e[1]),s.push(e[2])}function _Z(s,e,t,i){SV(bP,s.quaternion),zi(ar,e,s.center),L5(ar,ar,bP);const r=s.halfSize,n=8*((ar[0]<-r[0]?-1:ar[0]>r[0]?1:0)+3*(ar[1]<-r[1]?-1:ar[1]>r[1]?1:0)+9*(ar[2]<-r[2]?-1:ar[2]>r[2]?1:0)+13),a=vP[n];if(a===0)return a;Q5(pf,s.quaternion),Hw(pf,pf,s.halfSize);const o=(l,c)=>{const h=vP[n+c+1];return be(l,((1&h)<<1)-1,(2&h)-1,((4&h)>>1)-1),fn(l,l,pf),ce(l,s.center,l)};return t.length=0,Ss(t,o(Yv,0)),Ss(t,o(wP,1)),Ss(t,o(ar,2)),Ss(t,o(xP,3)),i(t),a===1||(t.length=0,Ss(t,Yv),Ss(t,xP),Ss(t,o(ar,4)),Ss(t,o(CP,5)),i(t),a===2||(t.length=0,Ss(t,Yv),Ss(t,CP),Ss(t,o(ar,6)),Ss(t,wP),i(t))),a}const vP=(()=>{const s=new Array(216);let e=0;const t=i=>{for(let r=0;r<i.length;r++)s[e+r]=i[r];e+=8};return t([3,0,6,2,3,1,5,4]),t([2,0,2,3,1,5,4,0]),t([3,1,0,2,3,7,5,4]),t([2,0,1,3,2,6,4,0]),t([1,0,1,3,2,0,0,0]),t([2,1,5,7,3,2,0,0]),t([3,2,0,1,3,7,6,4]),t([2,2,0,1,3,7,6,0]),t([3,3,0,1,5,7,6,2]),t([2,0,1,5,4,6,2,0]),t([1,0,1,5,4,0,0,0]),t([2,1,3,7,5,4,0,0]),t([1,0,2,6,4,0,0,0]),t([0,0,0,0,0,0,0,0]),t([1,1,3,7,5,0,0,0]),t([2,2,3,7,6,4,0,0]),t([1,2,3,7,6,0,0,0]),t([2,3,1,5,7,6,2,0]),t([3,4,0,1,5,7,6,2]),t([2,5,7,6,4,0,1,0]),t([3,5,0,1,3,7,6,4]),t([2,4,5,7,6,2,0,0]),t([1,4,5,7,6,0,0,0]),t([2,5,1,3,7,6,4,0]),t([3,6,0,2,3,7,5,4]),t([2,6,2,3,7,5,4,0]),t([3,7,6,2,3,1,5,4]),s})(),UA=4;function yZ(s,e){let t=0;for(let i=0;i<UA;i++){const r=s.intersectPlane(e[i]);if(r>0)return-1;r===0&&(t|=1<<i)}return t}const pf=Pn(),bP=PV(),ar=x(),Yv=x(),wP=x(),xP=x(),CP=x();let vZ=class{constructor(e){this._objects=e}destroy(){this._objects=null}submit(e,t){this._objects.preSubmit(t),this._objects.visibleObjects.forAll(i=>i.renderable.material.submit(e,t,i))}queryDepthRange(e){return this._objects.visibleObjects.length?pZ(e,this._objects.visibleObjects):null}get hasEmissions(){return this._objects.visibleObjects.some(e=>e.renderable.material.hasEmissions)}hasHighlight(e){return this._objects.hasHighlight(e)}},Gue=class{constructor(e,t,i,r){this.vertices=e,this.positionData=t,this.indices=i,this.componentOffsets=r}},Wue=class extends Xt{constructor(e,t,i,r,n){super(),this.hasVertexColors=e,this.textureCoordinateType=t,this.hasNormals=i,this.shadeNormals=r,this.applySSAO=n}};function HA(s){const e=Xa().vec3f("position");return s.hasNormals&&e.vec2i16("normalCompressed",{glNormalized:!0}),s.textureCoordinateType===1?e.vec2f("uv0"):s.textureCoordinateType===2&&(e.vec2f("uv0"),e.vec4u16("uvRegion",{glNormalized:!0})),s.hasVertexColors&&e.vec4u8("color",{glNormalized:!0}),e.freeze()}let bZ=class{constructor(){this.externalColor=Lt(),this.externalColorMixMode=1,this.castShadows=!0,this.pickable=!0,this.elevationOffset=0,this.emissiveStrength=w4,this.emissiveSource=0}};function wZ(s){s.vertex.code.add(y`
    vec4 decodeSymbolColor(vec4 symbolColor, out int colorMixMode) {
      float symbolAlpha = 0.0;

      const float maxTint = 85.0;
      const float maxReplace = 170.0;
      const float scaleAlpha = 3.0;

      if (symbolColor.a > maxReplace) {
        colorMixMode = ${y.int(1)};
        symbolAlpha = scaleAlpha * (symbolColor.a - maxReplace);
      } else if (symbolColor.a > maxTint) {
        colorMixMode = ${y.int(3)};
        symbolAlpha = scaleAlpha * (symbolColor.a - maxTint);
      } else if (symbolColor.a > 0.0) {
        colorMixMode = ${y.int(4)};
        symbolAlpha = scaleAlpha * symbolColor.a;
      } else {
        colorMixMode = ${y.int(1)};
        symbolAlpha = 0.0;
      }

      return vec4(symbolColor.r, symbolColor.g, symbolColor.b, symbolAlpha);
    }
  `)}let xZ=class extends la{constructor(e,t){super(e,"int",2,(i,r,n)=>i.setUniform1i(e,t(r,n)))}};const qA=429496.7296;function CZ(s,e){JV(s/qA*.5+.5,e)}const GA=1e6;function TZ(s,e){e4(s/GA*.5+.5,e)}function jA(){return 3+(Io()?1:0)}function SZ(s,e){switch(e.componentData){case 1:return PZ(s,e);case 0:return MZ(s,e);case 2:return;default:ra(e.componentData)}}function PZ(s,e){const{vertex:t,fragment:i}=s;t.include(LA),t.uniforms.add(new Jw("componentColorTex",o=>o.componentParameters.texture.texture)),s.attributes.add("componentIndex","float"),s.varyings.add("vExternalColorMixMode","mediump float"),s.varyings.add("vExternalColor","vec4");const{output:r}=e,n=r===10;n&&s.varyings.add("vObjectAndLayerIdColor","vec4");const a=r===1;a&&(s.varyings.add("emissiveStrength","float"),s.varyings.add("emissiveSource","int")),s.include(wZ),t.constants.add("stride","float",jA()),t.code.add(y`vec2 getComponentTextureCoordinates(float componentIndex, float typeOffset) {
float index = componentIndex * stride + typeOffset;
float texSize = float(textureSize(componentColorTex, 0).x);
float coordX = mod(index, texSize);
float coordY = floor(index / texSize);
return vec2(coordX, coordY) + 0.5;
}`),t.code.add(y`
  vec4 _readComponentColor() {
    vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 0.0);
    return texelFetch(componentColorTex, ivec2(textureCoordinates), 0);
   }

  float readElevationOffset() {
    vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 1.0);
    vec4 encodedElevation = texelFetch(componentColorTex, ivec2(textureCoordinates), 0);
    return uninterpolatedRGBAToFloat(encodedElevation) * ${y.float(qA)};
  }

  void forwardEmissiveStrength() {
    ${X(a,y`vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 2.0);
           vec4 encodedEmissive = texelFetch(componentColorTex, ivec2(textureCoordinates), 0);
           emissiveStrength = uninterpolatedRGBToFloat(encodedEmissive.rgb) * ${y.float(GA)};
           emissiveSource = encodedEmissive.a == 0.0 ? 0 : 1;`)}
  }

  void forwardObjectAndLayerIdColor() {
    ${X(n,y`vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 3.0);
           vObjectAndLayerIdColor = texelFetch(componentColorTex, ivec2(textureCoordinates), 0);`)}
  }

  vec4 forwardExternalColor(out bool castShadows) {
    vec4 componentColor = _readComponentColor() * 255.0;

    float shadowFlag = mod(componentColor.b * 255.0, 2.0);
    componentColor.b -= shadowFlag;
    castShadows = shadowFlag >= 1.0;

    int decodedColorMixMode;
    vExternalColor = decodeSymbolColor(componentColor, decodedColorMixMode) * 0.003921568627451; // = 1/255;
    vExternalColorMixMode = float(decodedColorMixMode) + 0.5; // add 0.5 to avoid interpolation artifacts

    return vExternalColor;
  }
`),i.code.add(y`
  void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {
    externalColor = vExternalColor;
    externalColorMixMode = int(vExternalColorMixMode);
  }

  void outputObjectAndLayerIdColor() {
     ${n?y`fragColor = vObjectAndLayerIdColor;`:""}
  }
`)}function MZ(s,e){const{vertex:t,fragment:i}=s;s.varyings.add("vExternalColor","vec4"),i.uniforms.add(new bR("emissiveStrength",n=>n.componentParameters.emissiveStrength)),t.uniforms.add(new Fg("externalColor",n=>n.componentParameters.externalColor)).code.add(y`float readElevationOffset() {
return 0.0;
}
void forwardObjectAndLayerIdColor() {}
void forwardEmissiveStrength() {}
vec4 forwardExternalColor(out bool castShadows) {
vExternalColor = externalColor;
castShadows = true;
return externalColor;
}`);const r=e.output===10;i.uniforms.add(new xZ("externalColorMixMode",n=>n.componentParameters.externalColorMixMode)).code.add(y`
    void readExternalColor(out vec4 color, out int colorMixMode) {
      color = vExternalColor;
      colorMixMode = externalColorMixMode;
    }

    void outputObjectAndLayerIdColor() {
      ${X(r,"fragColor = vec4(0, 0, 0, 0);")}
    }
  `)}function TP(s,e){const t=s.fragment;switch(e.doubleSidedMode){case 0:t.code.add(y`vec3 _adjustDoublesided(vec3 normal) {
return normal;
}`);break;case 1:s.include(xf,e),t.code.add(y`vec3 _adjustDoublesided(vec3 normal) {
return dot(normal, vPositionWorldCameraRelative) > 0.0 ? -normal : normal;
}`);break;case 2:t.code.add(y`vec3 _adjustDoublesided(vec3 normal) {
return gl_FrontFacing ? normal : -normal;
}`);break;default:ra(e.doubleSidedMode);case 3:}switch(e.normalType){case 0:case 1:s.include(p$,e),t.main.add(y`vec3 fragmentFaceNormal = _adjustDoublesided(normalize(vNormalWorld));
vec3 fragmentFaceNormalView = gl_FrontFacing ? normalize(vNormalView) : -normalize(vNormalView);`);break;case 2:s.include(xf,e),t.main.add(y`vec3 fragmentFaceNormal = normalize(cross(dFdx(vPositionWorldCameraRelative), dFdy(vPositionWorldCameraRelative)));
vec3 fragmentFaceNormalView = normalize(cross(dFdx(vPosition_view), dFdy(vPosition_view)));`)}e.shadeNormals?t.main.add(y`vec3 fragmentShadingNormal = fragmentFaceNormal;`):e.spherical?(s.include(xf,e),t.main.add(y`vec3 fragmentShadingNormal = normalize(positionWorld());`)):t.main.add(y`vec3 fragmentShadingNormal = vec3(0.0, 0.0, 1.0);`)}function $Z(s,e){s.include(m$,e),s.fragment.include(OL);const t=s.fragment;t.uniforms.add(new Fg("baseColor",i=>i.baseColor)),t.uniforms.add(new bR("objectOpacity",i=>i.objectOpacity)),e.hasVertexColors?t.code.add(y`vec3 _baseColor() {
return baseColor.rgb * vColor.rgb;
}
float _baseOpacity() {
return baseColor.a * vColor.a;
}`):t.code.add(y`vec3 _baseColor() {
return baseColor.rgb;
}
float _baseOpacity() {
return baseColor.a;
}`),t.code.add(y`vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {
vec3 baseColor = _baseColor();
float baseOpacity = _baseOpacity();
vec3 color = mixExternalColor(
baseColor,
textureColor.rgb,
externalColor.rgb,
externalColorMixMode
);
float opacity = objectOpacity * mixExternalOpacity(
baseOpacity,
textureColor.a,
externalColor.a,
externalColorMixMode
);
return vec4(color, opacity);
}`)}function RZ(s,e){const t=e.hasColorTexture&&(ns(e.output)||e.alphaDiscardMode!==1);t&&(s.include(x4,e),s.fragment.uniforms.add(new Jw("baseColorTexture",i=>i.texture))),s.fragment.code.add(y`
    vec4 readBaseColorTexture() {
      return ${t?"textureLookup(baseColorTexture, vuv0)":"vec4(1.0)"};
    }
  `)}function OZ(s,e){s.fragment.uniforms.add(new C_("heightParameters",t=>{const i=t.camera,r=Gs(i.eye),n=Math.sqrt(r),a=e.radius,o=r-a*a;let l=Kh(4e6,5e6,n-a);return l=Math.min(l,.98),Si(l,o,0,0)}),new Tn("cameraPosition",t=>t.camera.eye)),s.fragment.include(jp),s.fragment.code.add(y`float sphereFade() {return heightParameters[0];}
float sphereDepthInterpolate(vec3 worldRay, vec3 viewRay, float currentLinearDepth) {
vec2 rayPlanetIntersect = sphereIntersect(cameraPosition, worldRay, heightParameters[1]);
bool hitsPlanet = (rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.x > 0.0;
if (hitsPlanet) {
float sphereDepth = rayPlanetIntersect.x;
viewRay *= viewRay.z*sphereDepth;
float linearDepth = length(viewRay);
float sphereFade = heightParameters[0];
return (-linearDepth)*sphereFade + currentLinearDepth*(1.0-sphereFade);
}
return currentLinearDepth;
}`)}function WA(s){const e=new lt,{vertex:t,fragment:i}=e;e.include(xf,s),e.include(p$,s),e.include(m$,s),e.include(vR,s),e.include(SZ,s),e.include(DL,s),i.include(EL,s),e.include(RZ,s),e.include(XM,s);const{output:r,pbrMode:n,hasNormalTexture:a,snowCover:o,receiveShadows:l,shadeNormals:c,spherical:h,ellipsoidMode:d,overlayEnabled:m,componentData:f,vertexDiscardMode:g,renderOccluded:_}=s,v=n===1||n===2;v&&(e.include(AL,s),a&&e.include(IL,s));const b=r===4||r===5||r===6,T=b&&f===1,w=d===1,S=d===1?Ei.radius:w?oF.radius:lF.radius;m&&(e.include(Dg,s),e.include(k9,s),t.code.add(`
      ${X(h,`const float invRadius = ${y.float(1/S)};`)}
      vec2 projectOverlay(vec3 pos) { return pos.xy ${X(h,"/ (1.0 + invRadius * pos.z);")}; }`));const C=m&&ns(r)&&n===4;C&&(e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),e.varyings.add("groundNormal","vec3"));const P=g===0,M=g===2,O=1-1/255;if(e.include(LL,s),e.include(FL,s),t.main.add(y`
    bool castShadows;
    vec4 externalColor = forwardExternalColor(castShadows);
    ${X(T,"if(!castShadows) { gl_Position = vec4(vec3(1e38), 1.0); return; }")}

    ${X(!P,`{ if (externalColor.a ${M?">":"<="} ${y.float(O)}) { gl_Position = vec4(vec3(1e38), 1.0); return; } }`)}

    ${X(r===10,"externalColor.a = 1.0;")}

    forwardPosition(readElevationOffset());
    forwardViewPosDepth(vPosition_view);
    forwardNormal();
    forwardTextureCoordinates();
    forwardVertexColor();
    forwardLinearDepthToReadShadowMap();
    forwardLinearDepthToWriteShadowMap();
    forwardEmissiveStrength();
    forwardObjectAndLayerIdColor();
    ${X(C,h?y`
            groundNormal = normalize(positionWorld());
            tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));
            tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`:y`
            groundNormal = vec3(0.0, 0.0, 1.0);
            tbnTangent = vec3(1.0, 0.0, 0.0);
            tbnBiTangent = vec3(0.0, 1.0, 0.0);`)}
    ${X(m,"setOverlayVTC(projectOverlay(position));")}

    if (externalColor.a < ${y.float($s)}) {
      // Discard this vertex
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
      return;
    }
  `),ns(r))return e.include($Z,s),e.include(TP,s),e.include(Dg,s),e.include(JM,s),i.include(VL,s),i.code.add(y`
      float evaluateShadow() {
        return ${l?"readShadowMap(vPositionWorldCameraRelative, linearDepth)":"0.0"};
      }`),i.main.add(y`
      discardBySlice(vPositionWorldCameraRelative);
      discardByTerrainDepth();

      vec4 textureColor = readBaseColorTexture();
      discardOrAdjustAlpha(textureColor);

      /* When rendering the occluded overlay, we still need to read the base color texture
       * because we need to use the same discard logic. However after that to render only the
       * draped overlay, we simply set the base texture color to zero. */
      ${X(_,y`textureColor = vec4(0);`)}

      ${X(m,y`vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);`)}

      /* Early discard to only emit when we have overlay */
      ${X(m&&_,y`if (overlayColor.a < ${y.float($s)}) { discard; }`)}

      vec4 externalColor;
      int externalColorMixMode;
      readExternalColor(externalColor, externalColorMixMode);

      vec4 materialColor = computeMaterialColor(textureColor, externalColor, externalColorMixMode);
    `),v?(P_(i),h&&x0(i),i.main.add(y`
        applyPBRFactors();
        ${X(n===1,y`if (externalColorMixMode == 3) {
              mrr = vec3(0.0, 0.6, 0.2);
            }`)}
        float additionalIrradiance = 0.02 * mainLightIntensity[2];
        ${X(a,"mat3 tangentSpace = computeTangentSpace(fragmentFaceNormal, vPositionWorldCameraRelative, vuv0);")}
        vec3 shadingNormal = ${a?"computeTextureNormal(tangentSpace, vuv0)":"fragmentShadingNormal"};
        vec3 groundNormal = ${h?y`normalize(positionWorld())`:y`vec3(0.0, 0.0, 1.0)`};

        vec3 viewDir = normalize(vPositionWorldCameraRelative);
        float ssao = 1.0 - occlusion * evaluateAmbientOcclusionInverse();
        ${X(o,y`float snow = getSnow(fragmentFaceNormal, normalize(positionWorld()));
                 materialColor.rgb = mix(materialColor.rgb, vec3(1.1), snow);
                 ssao = mix(ssao, 0.5 * ssao, snow);
                 shadingNormal = mix(shadingNormal, fragmentFaceNormal, snow);`)}
        ${X(m,"materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;")}

        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());
        ${X(h,"float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());")}
        ${h?y`float shadow = max(lightingGlobalFactor * (1.0 - additionalAmbientScale), evaluateShadow());`:"float shadow = evaluateShadow();"}
        vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, shadow, ssao, additionalLight, viewDir, groundNormal, mrr, additionalIrradiance), materialColor.a);
        `)):(lc(i),h&&x0(i),C&&i.uniforms.add(new mr("ovNormalTex",z=>z.overlay?.getTexture(3))),i.main.add(y`
        ${X(h,"float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());")}
        float shadow = ${l?h?"max(lightingGlobalFactor * (1.0 - additionalAmbientScale), evaluateShadow())":"evaluateShadow()":h?"lightingGlobalFactor * (1.0 - additionalAmbientScale)":"0.0"};

        ${X(l&&!c,y`
            float dotFL = dot(fragmentFaceNormal, mainLightDirection);
            if( dotFL <= 0.0) shadow = 1.0;
        `)}
        ${X(o,y`float snow = getSnow(fragmentFaceNormal, normalize(positionWorld()));
               materialColor.rgb = mix(materialColor.rgb, vec3(1), snow);`)}

        // At global scale we create some additional ambient light based on the main light to simulate global illumination
        float ssao = evaluateAmbientOcclusion();
        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());

        ${X(m,"materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;")}

        vec4 shadedColor = vec4(evaluateSceneLighting(fragmentShadingNormal, materialColor.rgb, shadow, ssao, additionalLight), materialColor.a);
        ${X(C,y`vec4 overlayWaterMask = getOverlayColor(ovNormalTex, vtcOverlay);
                 float waterNormalLength = length(overlayWaterMask);
                 if (waterNormalLength > 0.95) {
                   mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);
                   vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, overlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, vPosition_view, positionWorld());
                   vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                   // un-gamma the ground color to mix in linear space
                   shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);
                 }`)}
      `)),i.main.add(`outputColorHighlightOID(shadedColor, vPositionWorldCameraRelative, materialColor.rgb ${X(o,", snow")});`),s.sphereDepthInterpolate&&(e.include(OZ,{radius:S*S$}),e.fragment.include(Qa),i.main.add(y`if (sphereFade()>0.0) {
vec3 worldRay = normalize(vPositionWorldCameraRelative);
vec3 viewRay = normalize(vPosition_view);
gl_FragDepth = delinearizeDepth(sphereDepthInterpolate(worldRay, viewRay, linearizeDepth(gl_FragCoord.z)));
} else {
gl_FragDepth = gl_FragCoord.z;
}`)),e;const D=r===3,A=r===10,F=r===9,E=b||r===7||r===8;return E&&e.include(c$,s),D&&e.include(TP,s),m&&e.include(xA,s),e.include(Mw,s),i.main.add(y`
    discardBySlice(vPositionWorldCameraRelative);

    vec4 textureColor = readBaseColorTexture();
    discardOrAdjustAlpha(textureColor);

    ${X(E,"outputDepth(linearDepth);")}
    ${X(D,y`fragColor = vec4(vec3(0.5) + 0.5 * fragmentFaceNormalView, 1.0);`)}
    ${X(A,m?"fragColor = getOverlayColorTexel();":"outputObjectAndLayerIdColor();")}
    ${X(F,X(m,y`calculateOcclusionAndOutputHighlight(getAllOverlayHighlightValuesEncoded());`,y`calculateOcclusionAndOutputHighlight();`))}`),e}const DZ=Object.freeze(Object.defineProperty({__proto__:null,build:WA},Symbol.toStringTag,{value:"Module"}));let EZ=class extends ct{constructor(e,t){super(e,t,new ht(DZ,()=>k(()=>Promise.resolve().then(()=>uee),void 0)),pV([Vr(HA(t)),QA]))}initializePipeline(e){const{integratedMeshMode:t,output:i,blendingEnabled:r,cullFace:n,hasOccludees:a,hasPolygonOffset:o,oitPass:l,renderOccluded:c}=e,h=t!==0,d=l===0,m=l===2;return qe({blending:c?pu:ns(i)&&r?s$(l):null,culling:zL(n),depthTest:c?null:{func:i$(l)},depthWrite:c||!d&&!m?null:xw,drawBuffers:xh(i,qd(l,i)),colorWrite:nt,stencilWrite:!c&&h||a?w0:null,stencilTest:h?kL(1):a?t$:null,polygonOffset:d||m?o?{factor:2,units:2}:null:e$})}};const QA=Vr(Xa().u16("componentIndex"));let st=class extends ls{constructor(e){super(),this.spherical=e,this.output=0,this.textureCoordinateType=0,this.componentData=0,this.cullFace=2,this.vertexDiscardMode=0,this.doubleSidedMode=2,this.alphaDiscardMode=1,this.integratedMeshMode=0,this.oitPass=0,this.ellipsoidMode=1,this.pbrMode=0,this.normalType=0,this.emissionSource=0,this.hasVertexColors=!1,this.hasNormals=!1,this.shadeNormals=!0,this.hasSlicePlane=!1,this.hasColorTexture=!1,this.hasHighlightMixTexture=!1,this.receiveAmbientOcclusion=!0,this.receiveShadows=!0,this.blendingEnabled=!0,this.screenSpaceReflections=!1,this.hasPolygonOffset=!1,this.hasMetallicRoughnessTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.hasNormalTextureTransform=!1,this.cloudReflections=!0,this.snowCover=!1,this.olidColor=!1,this.renderOccluded=!1,this.sphereDepthInterpolate=!1,this.discardInvisibleFragments=!1,this.occlusionPass=!1,this.bindType=2,this.useCustomDTRExponentForWater=!1,this.hasVertexTangents=!1,this.highStepCount=!1,this.instanced=!1,this.instancedDoublePrecision=!1,this.hasModelTransformation=!1,this.useFillLights=!0,this.draped=!1}get overlayEnabled(){return(this.integratedMeshMode===2||this.integratedMeshMode===3)&&C4(this.output)}};u([V({count:11})],st.prototype,"output",void 0),u([V({count:3})],st.prototype,"textureCoordinateType",void 0),u([V({count:2})],st.prototype,"componentData",void 0),u([V({count:3})],st.prototype,"cullFace",void 0),u([V({count:3})],st.prototype,"vertexDiscardMode",void 0),u([V({count:3})],st.prototype,"doubleSidedMode",void 0),u([V({count:4})],st.prototype,"alphaDiscardMode",void 0),u([V({count:4})],st.prototype,"integratedMeshMode",void 0),u([V({count:3})],st.prototype,"oitPass",void 0),u([V({count:4})],st.prototype,"ellipsoidMode",void 0),u([V({count:7})],st.prototype,"pbrMode",void 0),u([V({count:3})],st.prototype,"normalType",void 0),u([V({count:8})],st.prototype,"emissionSource",void 0),u([V()],st.prototype,"hasVertexColors",void 0),u([V()],st.prototype,"hasNormals",void 0),u([V()],st.prototype,"shadeNormals",void 0),u([V()],st.prototype,"hasSlicePlane",void 0),u([V()],st.prototype,"hasColorTexture",void 0),u([V()],st.prototype,"hasHighlightMixTexture",void 0),u([V()],st.prototype,"receiveAmbientOcclusion",void 0),u([V()],st.prototype,"receiveShadows",void 0),u([V()],st.prototype,"blendingEnabled",void 0),u([V()],st.prototype,"screenSpaceReflections",void 0),u([V()],st.prototype,"hasPolygonOffset",void 0),u([V()],st.prototype,"hasMetallicRoughnessTexture",void 0),u([V()],st.prototype,"hasOcclusionTexture",void 0),u([V()],st.prototype,"hasNormalTexture",void 0),u([V()],st.prototype,"hasOccludees",void 0),u([V()],st.prototype,"terrainDepthTest",void 0),u([V()],st.prototype,"cullAboveTerrain",void 0),u([V()],st.prototype,"hasNormalTextureTransform",void 0),u([V()],st.prototype,"cloudReflections",void 0),u([V()],st.prototype,"snowCover",void 0),u([V()],st.prototype,"olidColor",void 0),u([V()],st.prototype,"renderOccluded",void 0),u([V()],st.prototype,"sphereDepthInterpolate",void 0);let AZ=class extends Xt{constructor(){super(...arguments),this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){if(this._dirty=!1,this._parameterBlocks!=null)for(const e of this._parameterBlocks)this[e]._setClean()}get dirty(){return this._dirty||this._checkParameterBlocksDirty()}_checkParameterBlocksDirty(){if(this._parameterBlocks==null)return!1;for(const e of this._parameterBlocks)if(this[e].dirty)return!0;return!1}},dx=class{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){this._dirty=!1}get dirty(){return this._dirty}};function xt(s={}){return(e,t)=>{const i=e._parameterCount??0;if(e._parameterCount=i+1,s.vectorOps){const r=s.vectorOps;Object.defineProperty(e,t,{get(){return this[i]},set(n){const a=this[i];if(a==null)this[i]=Array.from(n);else{if(r.equals(a,n))return;r.copy(a,n)}this._setDirty()}})}else Object.defineProperty(e,t,{get(){return this[i]},set(r){this[i]!==r&&(s.dispose&&this[i]&&this[i].dispose(),this[i]=r,this._setDirty())}})}}function SP(){return(s,e)=>{const t=s._parameterCount??0;s._parameterCount=t+1,s._parameterBlocks=s._parameterBlocks||[],s._parameterBlocks.push(t),Object.defineProperty(s,e,{get(){return this[t]},set(i){this[t]!==i&&(this[t]=i,this._setDirty())}})}}let ZA=class{constructor(e){this._low=x(),this._high=x(),e&&this.set(e)}get low(){return this._low}get high(){return this._high}set(e){q(this._low,q(PP,e));const t=zi(PP,e,this._low);q(this._high,t)}get(e){return ce(e,this._low,this._high)}getLowScaled(e){return ee(e,this._low,1)}};const PP=nV();let oi=class extends AZ{constructor(e,t){super(),this.toMapSpace=t,this.baseColor=AV(1,1,1,1),this.usePBR=!1,this.hasParametersFromSource=!1,this.sphereDepthInterpolate=!1,this.mrrFactors=BL,this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.normalTexture=null,this.occlusionTexture=null,this.emissionTexture=null,this.emissiveBaseColor=xF(0,0,0),this.emissiveStrength=0,this.commonMaterialParameters=new gg,this.componentParameters=new Fl,this.objectOpacity=1,this.textureAlphaCutoff=$s,this.alphaDiscardMode=1,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=1,this.hasOccludees=!1;const i=new ZA(e.position),r=Z5(e.rotationScale);qw(r,r),qp(r,r),this.transformNormalGlobalFromModel=r,this.transformWorldFromModelTL=i.low,this.transformWorldFromModelTH=i.high,this.transformWorldFromModelRS=e.rotationScale}dispose(){this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}get _hasEmissiveBase(){return this.emissionTexture!=null||!qo(this.emissiveBaseColor,ea)}get _hasEmissiveStrength(){return this.componentParameters.emissiveOverride!==2}get hasEmissions(){return this._hasEmissiveStrength&&(this._hasEmissiveBase||this.componentParameters.emissiveSourceOverride!==2)}get texture(){return this.baseColorTexture?.glTexture}get textureMetallicRoughness(){return this.metallicRoughnessTexture?.glTexture}get textureEmissive(){return this.emissionTexture?.glTexture}get textureOcclusion(){return this.occlusionTexture?.glTexture}get textureNormal(){return this.normalTexture?.glTexture}acquireTechnique(e,t,i,r){const n=new st(e.context.spherical);n.renderOccluded=i.slot===9,n.hasVertexColors=r.hasVertexColors,n.hasNormals=r.hasNormals,n.textureCoordinateType=r.textureCoordinateType,n.hasMetallicRoughnessTexture=this.metallicRoughnessTexture!=null,n.hasOcclusionTexture=this.occlusionTexture!=null,n.hasNormalTexture=this.normalTexture!=null,n.sphereDepthInterpolate=this.sphereDepthInterpolate&&e.viewingMode===1,n.oitPass=t.identifier===0&&i.oitPass!=null?i.oitPass:0,n.terrainDepthTest=t.identifier===0&&i.terrainDepthTest,n.cullAboveTerrain=t.identifier===0&&i.cullAboveTerrain,n.ellipsoidMode=this.ellipsoidMode,n.componentData=this.componentParameters.type,n.cullFace=this.commonMaterialParameters.cullFace,n.doubleSidedMode=this.commonMaterialParameters.doubleSided?1:0,n.hasColorTexture=this.baseColorTexture!=null;const a=this._computeWhichMaterialPass();n.blendingEnabled=a===1||a===2,n.alphaDiscardMode=this.alphaDiscardMode,n.integratedMeshMode=this.isIntegratedMesh?FZ(i)?LZ(i)?3:2:1:0,n.hasPolygonOffset=this.polygonOffsetEnabled,n.pbrMode=n.integratedMeshMode===3?4:this.usePBR?this.hasParametersFromSource?r.shadeNormals&&this.isIntegratedMesh?0:2:1:0;const o=this.componentParameters.emissiveSourceOverride===1,l=this.componentParameters.emissiveSourceOverride===2,c=this.emissionTexture!=null;if(n.emissionSource=this.hasEmissions?this._hasEmissiveBase&&n.pbrMode===1?l?c?4:2:o?c?5:7:6:o?7:6:0,n.shadeNormals=r.shadeNormals,n.normalType=n.hasNormals?1:2,n.hasSlicePlane=i.slicePlane!=null&&this.commonMaterialParameters.hasSlicePlane,n.receiveAmbientOcclusion=n.hasOccludees=n.receiveShadows=n.screenSpaceReflections=n.cloudReflections=n.hasHighlightMixTexture=!1,t.identifier===1)n.output=4,n.vertexDiscardMode=0;else if(t.identifier===3)n.output=7,n.vertexDiscardMode=0;else if(t.identifier===2)n.output=9,n.vertexDiscardMode=0,n.hasHighlightMixTexture=i.highlightMixTexture!=null;else{switch(n.vertexDiscardMode=a===2?t.transparent?2:1:0,n.output=t.output,t.output){case 0:case 1:n.receiveAmbientOcclusion=r.applySSAO&&i.ssao?.getTexture()!=null,n.hasOccludees=i.hasOccludees,n.receiveShadows=i.shadowMap.ready,n.screenSpaceReflections=i.ssr.lastFrameColor!=null,n.cloudReflections=i.clouds.data?.cubeMap?.colorTexture!=null;break;case 10:n.olidColor=!0}n.snowCover=i.snowCover>0}const h=e.get(EZ,n);return this._setClean(),h}submit(e,t,i){if(this.objectOpacity<=0)return;const{componentData:r,renderable:n}=i,{geometry:a}=n,o=n.meta.cameraDepthSquared;r.updateHighlights(t.highlights);const{geometryRanges:l,highlightRangesMap:c,shadowmapRanges:h}=r;switch(this._computeWhichMaterialPass()){case 0:e.opaque.submitDraw(this,a,l,o);break;case 1:e.transparent.submitDraw(this,a,l,o);break;case 2:e.opaque.submitDraw(this,a,l,o),e.transparent.submitDraw(this,a,l,o);break;case 3:e.integratedMesh.submitDraw(this,a,l,o),VZ(t)&&e.occludedGround.submitDraw(this,a,l,o),IZ(t)&&e.highlightIntegratedMesh.submitDraw(this,a,l,o);break;case 4:e.transparentIntegratedMesh.submitDraw(this,a,l,o)}if(this.componentParameters.castShadows!==2){if(c!=null)for(const d of c)d[0]===aa&&e.highlightShadowMap.submitDraw(this,a,d[1],o,d[0]);h!=null&&e.defaultShadowMap.submitDraw(this,a,h,o),e.shadowMap.submitDraw(this,a,l,o)}if(c!=null)for(const d of c)e.highlight.submitDraw(this,a,d[1],o,d[0]);t.viewshedEnabled&&e.viewshedShadowMap.submitDraw(this,a,l,o)}_computeWhichMaterialPass(){if(this.isIntegratedMesh&&this.objectOpacity>=1)return 3;if(this.isIntegratedMesh&&this.objectOpacity<1)return 4;if(this.objectOpacity<1)return 1;if(this.componentParameters.opaqueOverride===0)return 0;if(this.baseColor[3]<1||this.alphaDiscardMode===0||this.alphaDiscardMode===3)return 1;switch(this.componentParameters.transparent){case 2:return 0;case 0:return 1;case 1:return 2}}};u([xt({vectorOps:oR})],oi.prototype,"baseColor",void 0),u([xt()],oi.prototype,"usePBR",void 0),u([xt()],oi.prototype,"hasParametersFromSource",void 0),u([xt()],oi.prototype,"sphereDepthInterpolate",void 0),u([xt({vectorOps:aC})],oi.prototype,"mrrFactors",void 0),u([xt({dispose:!0})],oi.prototype,"baseColorTexture",void 0),u([xt({dispose:!0})],oi.prototype,"metallicRoughnessTexture",void 0),u([xt({dispose:!0})],oi.prototype,"normalTexture",void 0),u([xt({dispose:!0})],oi.prototype,"occlusionTexture",void 0),u([xt({dispose:!0})],oi.prototype,"emissionTexture",void 0),u([xt({vectorOps:aC})],oi.prototype,"emissiveBaseColor",void 0),u([xt()],oi.prototype,"emissiveStrength",void 0),u([SP()],oi.prototype,"commonMaterialParameters",void 0),u([SP()],oi.prototype,"componentParameters",void 0),u([xt()],oi.prototype,"objectOpacity",void 0),u([xt()],oi.prototype,"textureAlphaCutoff",void 0),u([xt()],oi.prototype,"alphaDiscardMode",void 0),u([xt()],oi.prototype,"isIntegratedMesh",void 0),u([xt()],oi.prototype,"polygonOffsetEnabled",void 0),u([xt()],oi.prototype,"ellipsoidMode",void 0),u([xt()],oi.prototype,"hasOccludees",void 0);let gg=class extends dx{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=2,this.hasSlicePlane=!0}};u([xt()],gg.prototype,"doubleSided",void 0),u([xt()],gg.prototype,"cullFace",void 0),u([xt()],gg.prototype,"hasSlicePlane",void 0);let Fl=class extends dx{constructor(){super(...arguments),this.externalColor=Si(1,1,1,1),this.externalColorMixMode=1,this.emissiveStrength=0,this.emissiveSource=0,this.castShadows=0}get transparent(){return this.externalColor[3]<1?0:2}get opaqueOverride(){return this.externalColorMixMode===3&&this.externalColor[3]===1?0:2}get emissiveOverride(){return this.emissiveStrength>0?0:2}get emissiveSourceOverride(){return this.emissiveSource===1?0:2}get visible(){return this.externalColor[3]>0?0:2}get type(){return 0}};u([xt({vectorOps:oR})],Fl.prototype,"externalColor",void 0),u([xt()],Fl.prototype,"externalColorMixMode",void 0),u([xt()],Fl.prototype,"emissiveStrength",void 0),u([xt()],Fl.prototype,"emissiveSource",void 0),u([xt()],Fl.prototype,"castShadows",void 0);let Cl=class extends dx{constructor(){super(...arguments),this.texture=null,this.transparent=2,this.opaqueOverride=2,this.emissiveOverride=2,this.emissiveSourceOverride=2,this.castShadows=2}get type(){return 1}};function IZ(s){return s.overlay?.getTexture(2)!=null}function LZ(s){return s.overlay?.getTexture(3)!=null}function FZ(s){return s.overlay?.getTexture(1)!=null}function VZ(s){return s.overlay?.getTexture(s.overlay?.allSourcesOccluders?1:4)!=null}u([xt()],Cl.prototype,"texture",void 0),u([xt()],Cl.prototype,"transparent",void 0),u([xt()],Cl.prototype,"opaqueOverride",void 0),u([xt()],Cl.prototype,"emissiveOverride",void 0),u([xt()],Cl.prototype,"emissiveSourceOverride",void 0),u([xt()],Cl.prototype,"castShadows",void 0);let kZ=class{constructor(e){this._maxCount=e,this._nextIndex=0,this._recycledIndices=[]}get activeCount(){return this._nextIndex-this._recycledIndices.length}get availableCount(){return this._recycledIndices.length+this._maxCount-this._nextIndex}acquire(){return this._recycledIndices.length>0?this._recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}release(e){this._recycledIndices.push(e)}},zZ=class{constructor(e,t=1){this._rctx=e,this._fieldCount=t,this.textureWidth=4096,this._dirty=!0;const i=new ft(this.textureWidth,1);i.samplingMode=9728,i.wrapMode=33071,this._texture=new bt(this._rctx,i),this._data=new Bg(new ArrayBuffer(4*this.textureWidth))}dispose(){this._texture.dispose(),this._texture=void 0,this._data=void 0}setData(e,t,i,r,n,a){const o=e*this._fieldCount+t;this._dirty=!0,this._data.set(o,0,i),this._data.set(o,1,r),this._data.set(o,2,n),this._data.set(o,3,a)}setDataElement(e,t,i,r){const n=e*this._fieldCount+t;this._dirty=!0,this._data.set(n,i,r)}getDataElement(e,t,i){const r=e*this._fieldCount+t;return this._dirty=!0,this._data.get(r,i)}resizeToFit(e){const t=(e+1)*this._fieldCount;if(t>this._data.count){const i=Math.ceil(t/this.textureWidth)*this.textureWidth,r=new Bg(new ArrayBuffer(4*i));r.typedBuffer.set(this._data.typedBuffer),this._data=r}}updateTexture(){if(!this._dirty)return;const e=this._texture.descriptor.width,t=this._texture.descriptor.height;this._data.count>e*t&&this._texture.resize(e,this._data.count/e),this._texture.setData(this._data.typedBuffer),this._dirty=!1}get texture(){return this._texture}};const XA=65536;let BZ=class{constructor(e,t=1){this.textureBuffer=new zZ(e,t),this._indexManager=new kZ(XA)}dispose(){this.textureBuffer.dispose(),this.textureBuffer=void 0}get availableCount(){return this._indexManager.availableCount}get activeCount(){return this._indexManager.activeCount}acquireIndex(){const e=this._indexManager.acquire();return this.textureBuffer.resizeToFit(e),e}releaseIndex(e){this._indexManager.release(e)}},NZ=class{constructor(e,t=1){this._rctx=e,this._fieldCount=t,this._buffers=[]}garbageCollect(){this._buffers=this._buffers.filter(e=>e.activeCount!==0||(e.dispose(),!1))}destroy(){this._buffers.forEach(e=>e.dispose()),this._buffers=[]}getBuffer(e){for(const i of this._buffers)if(i.availableCount>=e)return i;if(e>XA)return null;const t=new BZ(this._rctx,this._fieldCount);return this._buffers.push(t),t}updateTextures(){for(const e of this._buffers)e.textureBuffer.updateTexture()}};const mf=()=>j.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");let UZ=class{constructor(e,t){this._renderManager=e,this._viewingMode=t,this._elevationRangeCacheVerticalOffset=NaN,this._elevationRangeCacheMin=NaN,this._elevationRangeCacheMax=NaN,this._activeHighlightOptions=new Map,this._visible=new zt,this._hidden=new zt,this._renderSubmit=new vZ(this),this._renderManager.register(this._renderSubmit),this._componentBufferManager=new NZ(e.rctx,jA())}destroy(){Wt(this._hidden.length===0&&this._visible.length===0,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy(),this._componentBufferManager=null,this._visible.forAll(e=>e.destroy()),this._visible.prune(),this._hidden.forAll(e=>e.destroy()),this._hidden.prune(),this._renderSubmit.destroy()}createObject(e){const{geometry:t}=e,i=new EQ(this._componentBufferManager,rR(t.componentOffsets)),r=this._createRenderable(e,i),n=new nZ(this._viewingMode,t.positionData,i,e.elevationAlignable),a=new IQ(e.transform,e.toMapSpace,e.obb.clone(),i,r,n);return(a.visible?this._visible:this._hidden).push(a),a}destroyObject(e){const t=e;(t.visible?this._visible:this._hidden).removeUnordered(t),t.destroy(),this._notifyDirty()}setObjectVisibility(e,t){const i=e;t!==i.visible&&(t?(this._hidden.removeUnordered(i),this._visible.push(i)):(this._visible.removeUnordered(i),this._hidden.push(i)),i.visible=t,this._notifyDirty())}preSubmit(e){const t=e.camera.eye;this.visibleObjects.forAll(i=>i.renderable.meta.cameraDepthSquared=$o(t,i.obb.center))}getMaterial(e){return e.renderable.material}updateMaterial(e,t){const i=e.renderable.material;t(i),i.dirty&&this._notifyDirty()}setAllComponentVisibilities(e,t){const i=e;i.componentData.visibility.reset(t),i.componentData.markVisibilityDirty(),this._notifyDirty()}forEachVisibleComponent(e,t){return e.componentData.visibility.forEachComponent(t)}getComponentCount(e){const t=e,i=t.componentData.visibility.componentCount;return{visible:i,invisible:t.componentData.count-i}}setComponentData(e,t){const i=e,{renderable:r,componentData:n}=i,a=r.material,o=n.materialDataBuffer,l=n.materialDataIndices,c=new bZ,h=o.textureBuffer,d=new Uint8Array(4),m=new Uint32Array(d.buffer);let f=0,g=0,_=0,v=0,b=0,T=n.verticalOffsets,w=1/0,S=-1/0,C=!1,P=!1,M=!1,O=0;for(let D=0;D<n.count;D++){t(D,c),f+=+(c.externalColor[3]<1),g+=+(c.externalColorMixMode===3&&c.externalColor[3]===1),v+=+(c.emissiveStrength>0),b+=+(c.emissiveSource===1),P||=c.emissiveStrength!==1,_+=+c.castShadows,u4(c.externalColor,c.externalColorMixMode,d),d[2]=254&d[2]|+c.castShadows,h.setData(l[D],0,d[0],d[1],d[2],d[3]),C||=D>0&&O!==m[0],O=m[0],M||=c.elevationOffset!==0,M&&T==null&&(T=new Array(D).fill(0)),T!=null&&(T[D]=c.elevationOffset),w=Math.min(w,c.elevationOffset),S=Math.max(S,c.elevationOffset),CZ(c.elevationOffset,d),h.setData(l[D],1,d[0],d[1],d[2],d[3]),TZ(c.emissiveStrength,d),h.setData(l[D],2,d[0],d[1],d[2],c.emissiveSource===0?0:255);const A=c.olidColor;A!=null&&h.setData(l[D],3,A[0],A[1],A[2],A[3]),c.pickable!==BA(n.pickability,D)&&GQ(n,D,c.pickable)}n.verticalOffsets=M?T:null,i.offsetObb=M?_4(i.obb,w,S,this._viewingMode,i.offsetObb??i.obb.clone()):null,C||M||Io()||(P||b>0)&&v>0?(a.componentParameters=new Cl,a.componentParameters.castShadows=Zu(_,n.count),a.componentParameters.transparent=Zu(f,n.count),a.componentParameters.opaqueOverride=Zu(g,n.count),a.componentParameters.emissiveOverride=Zu(v,n.count),a.componentParameters.emissiveSourceOverride=Zu(b,n.count),a.componentParameters.texture=h,h.updateTexture()):(a.componentParameters=new Fl,a.componentParameters.castShadows=c.castShadows?0:2,a.componentParameters.externalColor=c.externalColor,a.componentParameters.externalColorMixMode=c.externalColorMixMode,a.componentParameters.emissiveStrength=c.emissiveStrength,a.componentParameters.emissiveSource=c.emissiveSource),this._elevationRangeCacheVerticalOffset=NaN,this._notifyDirty()}getComponentAabb(e,t,i,r=!1){e.intersectionGeometry.getComponentAabb(t,i);const n=e,a=n.componentData.verticalOffsets;if(r||a==null)return i;const o=a[t];if(this._viewingMode===2||o===0)return i[2]+=o,i[5]+=o,i;const l=qx(o);return l.localOrigin=n.transform.position,l.applyToAabb(i)}getComponentObb(e){return e.obb}getObjectTransform(e){return e.transform}getComponentPositions(e,t,i){return e.intersectionGeometry.getComponentPositions(t,i)}expandRangeWithComponentObjectElevationRange(e,t,i,r){Number.isNaN(this._elevationRangeCacheVerticalOffset)||this._elevationRangeCacheVerticalOffset!==t||r.expandElevationRangeValues(this._elevationRangeCacheMin,this._elevationRangeCacheMax);const n=e,a=n.componentData,o=a.count,l=a.verticalOffsets,c=n.intersectionGeometry,h=this._viewingMode===2,d=c.getComponentAabbs(),m=HZ;let f=1/0,g=-1/0;for(let _=0;_<o;_++){const v=6*_,b=l?.[_]??0;let T=1/0,w=-1/0;if(h)T=d[v+2]+b+t,w=d[v+5]+b+t;else{if(m[0]=d[v],m[1]=d[v+1],m[2]=d[v+2],m[3]=d[v+3],m[4]=d[v+4],m[5]=d[v+5],b!==0){const M=qx(b);M.localOrigin=n.transform.position,M.applyToAabb(m)}const S=Math.max(Math.abs(m[3]),Math.abs(m[0])),C=Math.max(Math.abs(m[4]),Math.abs(m[1])),P=t+m[5]+i;r.expandElevationRangeValues(t+m[2],Math.sqrt(S*S+C*C+P*P)-i)}r.expandElevationRangeValues(T,w),f=Math.min(f,T),g=Math.max(g,w)}this._elevationRangeCacheVerticalOffset=t,this._elevationRangeCacheMin=f,this._elevationRangeCacheMax=g}intersect(e,t,i,r,n,a){const o=e,{transform:l,componentData:c,intersectionGeometry:h}=o;return r!=null&&(r.localOrigin=l.position),h.intersect(t,i,r,c.verticalOffsets,l,n,a)}addEdges(e,t,i,r,n){const a=e,{indices:o,positions:l}=a.intersectionGeometry,c=a.componentData.offsets;return t.addComponentObject(a,l,o,c,i,r,n)}async extractEdgeInformation(e,t,i){const r=e,n=r.componentData.visibility;if(n.allInvisible()){const{extractComponentsEdgeLocationsLayout:f}=await k(()=>import("./edgeProcessing-DVxeDOky.js"),__vite__mapDeps([468,416,14,184,1,198,185,19,9,7,8,5,6,20,183,4,2,10,87,186,88,199,193,200,469,241]));return{buffer:f.createBuffer(0),origin:[0,0,0]}}const{indices:a,positions:o}=r.intersectionGeometry,l=r.componentData.offsets,{EdgeInputBufferLayout:c}=await k(async()=>{const{EdgeInputBufferLayout:f}=await import("./bufferLayouts-B264SBQA.js");return{EdgeInputBufferLayout:f}},__vite__mapDeps([469,198,185,19,1,9,7,8,5,6,20,14,183,4,2,10,87,186,88,199,193,200])),h=c.createBuffer(o.length/3);H4(h.position.typedBuffer,o,h.position.typedBufferStride,3),U4(h.position,h.position,r.transform.rotationScale),this._setComponentIndices(h.componentIndex,a,l);const d=h.count,m=this._computeVisibilityIndices(a,n,l,d);return{origin:Sn(r.transform.position),buffer:await t.extractComponentsEdgeLocations({indices:m,indicesLength:m.length,skipDeduplicate:!0,data:h,writerSettings:{reducedPrecision:!1,variants:0}},i)}}_setComponentIndices(e,t,i){let r=0;for(let n=0;n<i.length-1;n++){const a=i[n],o=i[n+1];for(let l=a;l<o;l++){const c=t?t[l]:l;e.set(c,r)}r++}}_computeVisibilityIndices(e,t,i,r){if(e&&t.allVisible())return e;let n=0;t.forEachComponentRange((l,c)=>(n+=i[c]-i[l],!0));const a=bI(e)?e?.BYTES_PER_ELEMENT===2||r<=65536?new Uint16Array(n):new Uint32Array(n):new Array(n);let o=0;return t.forEachComponentRange((l,c)=>{const h=i[l],d=i[c];for(let m=h;m<d;m++)a[o++]=e?e[m]:m;return!0}),a}addComponentHighlight(e,t,i){const r=e.componentData,n=Aa(r.componentHighlights,i,()=>new Uint32Array(r.count+1));{const a=this._activeHighlightOptions.get(i)??0;this._activeHighlightOptions.set(i,a+1)}n[t]++===0&&(r.markHighlightsDirty(),this._notifyDirty()),n[r.count]++}removeComponentHighlight(e,t,i){const{componentData:r}=e,n=r.componentHighlights.get(i);if(n===void 0)return void mf().warn("Removing non-existing highlight.");const a=n[t];if(a===0)return void mf().warn("Removing non-existing highlight.");this._removeActiveHighlight(i);const o=n[r.count];if(a>1)return n[t]=a-1,void(n[r.count]=o-1);n[t]=0,o===1?r.componentHighlights.delete(i):n[r.count]=o-1,r.markHighlightsDirty(),this._notifyDirty()}_removeActiveHighlight(e,t=1){const i=this._activeHighlightOptions.get(e);if(i===void 0)mf().warn("Removing non-existing highlight.");else{const r=i-t;r<0&&mf().warn("Removing non-existing highlight."),r<=0?this._activeHighlightOptions.delete(e):this._activeHighlightOptions.set(e,r)}}clearHighlights(e){const{componentData:t}=e,{componentHighlights:i}=t;if(i.size>0){for(const r of i)this._removeActiveHighlight(r[0],r[1][t.count]);i.clear(),t.markHighlightsDirty(),this._notifyDirty()}}hasHighlight(e){return this._activeHighlightOptions.has(e)}getObjectGPUMemoryUsage(e){return e.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._visible}_createRenderable(e,t){const i=this._renderManager.rctx,r=e.geometry,n=r.vertices.layoutParameters,a=Vr(HA(n)),o=new Kt(i,a,r.vertices.data),l=r.indices?Nr.createIndex(i,35044,r.indices):null,c=new Uint16Array(r.vertices.count);for(let _=0;_<t.count;_++){const v=t.offsets[_],b=t.offsets[_+1],T=t.materialDataIndices[_];if(r.indices!=null)for(let w=v;w<b;w++)c[r.indices[w]]=T;else for(let w=v;w<b;w++)c[w]=T}const h=new Kt(i,QA,c.buffer),d=new oi(e.transform,e.toMapSpace),m=new Mn(i,new Map([["geometry",o],["componentIndices",h]]),l),f=new dZ(m,Ct.TRIANGLES,n,l!=null),g={cameraDepthSquared:.5,gpuMemoryEstimate:o.usedMemory+h.usedMemory+(l!=null?l.usedMemory:0)};return new uZ(d,f,g)}_notifyDirty(){this._renderManager.notifyDirty()}};function Zu(s,e){return s===e?0:s===0?2:1}const HZ=Ka();let qZ=class{constructor(e,t,i,r,n){this.rctx=e,this.viewingMode=t,this.stippleTextures=i,this.waterTextures=r,this.markerTextures=n}get spherical(){return this.viewingMode===1}},GZ=class{constructor(e){this._context=e,this._debug=!1,this._precompiling=this._debug?0:1,this._cache=new qa}get context(){return this._context}get precompiling(){return this._precompiling}set precompiling(e){this._precompiling=e,e===0&&this.context.rctx.gl.flush()}get viewingMode(){return this.context.viewingMode}destroy(){this._cache.forAll(e=>e.destroy()),this._cache.clear(),this._context=null}precompile(e,t=MP){++this.precompiling,this.get(e,t),--this.precompiling}get(e,t=MP){const i=t.key.code;let r=this._cache.get(e,i);if(r==null){if(this._precompiling===0){let n=`Uncached shader compile in ${new Error().stack}
  for configuration
${t.decode()}`;const a=this._cache.getInner(e);throw a?.size&&(n+=`

  cached configurations:
`,n+=Array.from(a.values()).map(o=>t.decode(o.key)).sort().join(`

`)),console.log(n),new me("shader:uncached-compile",n)}r=new e(this.context,t),this._cache.set(e,i,r)}return r}async reloadAll(){const e=new Array;this._cache.forEach(t=>e.push(jZ(t))),await Promise.all(e)}};async function jZ(s){let e=!0;s.forEach(async t=>{await t.reload(e),e=!1})}const MP=new ls;let Od=class extends Ho{constructor(e){super(e),this.consumes={required:["olid"]},this.produces="olid"}destroy(){}render(e){const t=e.find(({name:r})=>r==="olid"),i=this.renderingContext;return i.bindFramebuffer(t.fbo),i.clearFramebuffer(hi,!0,!0),this.view.stage.renderer.renderAllGeometry(10),i.clear(1280),this.view.stage.renderer.renderHUD(1),t}};u([p()],Od.prototype,"consumes",void 0),u([p()],Od.prototype,"produces",void 0),Od=u([R("esri.views.3d.webgl-engine.effects.geometry.ObjectAndLayerIDRenderNode")],Od);let Dd=class extends Ho{constructor(e){super(e),this.consumes={required:[ne.OCCLUDED]},this.produces=ne.OCCLUDED,this._blit=new cx(e.view.stage.renderView.techniques,2)}precompile(){const e=this.view.stage.renderer;e.plugins.plugins.forEach(t=>{e.precompileSlots(t,9,11),t.material&&e.precompileOccludedSlots(t,iw)})}render(e){const t=e.find(({name:i})=>i===this.produces);return this._renderOccludedAndTransparentStencil(t),this._renderOccludedComposite(t),t}_renderOccludedAndTransparentStencil(e){const t=this.view.stage.renderer,i=tw;i.clear();for(const r of t.plugins.plugins)8&r.renderOccludedFlags&&i.push(r);i.length!==0&&(t.renderSlots(i,10),this._renderAndComposite(e,e.getAttachment(Ui),.5,()=>t.renderSlots(i,11),!1,!1),i.clear())}_renderOccludedComposite(e){const t=this.view.stage.renderer,i=tw;i.clear();let r=0;for(const o of t.plugins.plugins){const l=o.renderOccludedFlags&QZ;r|=l,l&&i.push(o)}if(!r)return void i.clear();const n=this._getDepthStencilAttachment(e);let a=n.clearStencil;for(const o of iw)r&o&&(this._renderAndComposite(e,n.depth,o===16?1:.5,()=>t.renderOccludedSlots(i,o),!0,a),a=!1);n.release(),i.clear()}_renderAndComposite(e,t,i,r,n,a){const o=this.renderingContext,{width:l,height:c}=e.fbo,h=this.fboCache.acquire(l,c,"tmp color");h.attachDepth(t),o.bindFramebuffer(h.fbo),o.clearFramebuffer(hi,n,a),r(),h.detachDepth(),this._blit.blend(o,h,e,this.bindParameters,i),h.release()}_getDepthStencilAttachment(e){const{width:t,height:i}=e.fbo;if(!this.view.stage.renderer.occludedRequiresIntegratedMeshStencil){const n=this.fboCache.acquireDepth(13,t,i,"retained stencil");return{depth:n,release:()=>n.release(),clearStencil:!0}}const r=this.fboCache.acquire(t,i,"retained stencil",13);return this.renderingContext.blitFramebuffer(e.fbo,r.fbo,1024),{depth:r.getAttachment(Ui),release:()=>r.release(),clearStencil:!1}}};u([p()],Dd.prototype,"consumes",void 0),u([p()],Dd.prototype,"produces",void 0),Dd=u([R("esri.views.3d.webgl-engine.effects.geometry.RenderOccludedRenderNode")],Dd);const tw=new zt;function WZ(){tw.prune()}const iw=[4,2,16],QZ=iw.reduce((s,e)=>s|e,0);function YA(){return new Float32Array(4)}function ZZ(s){const e=new Float32Array(4);return e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3],e}function Cu(s,e,t,i){const r=new Float32Array(4);return r[0]=s,r[1]=e,r[2]=t,r[3]=i,r}function KA(){return YA()}function JA(){return Cu(1,1,1,1)}function e3(){return Cu(1,0,0,0)}function t3(){return Cu(0,1,0,0)}function i3(){return Cu(0,0,1,0)}function s3(){return Cu(0,0,0,1)}const J_=KA(),XZ=JA(),YZ=e3(),KZ=t3(),JZ=i3(),eX=s3();Object.freeze(Object.defineProperty({__proto__:null,ONES:XZ,UNIT_W:eX,UNIT_X:YZ,UNIT_Y:KZ,UNIT_Z:JZ,ZEROS:J_,clone:ZZ,create:YA,fromValues:Cu,ones:JA,unitW:s3,unitX:e3,unitY:t3,unitZ:i3,zeros:KA},Symbol.toStringTag,{value:"Module"}));const _g={sunny:.0022,rainy:.0022,cloudy:.0022,snowy:.0022,foggy:.0022};let $P=class{constructor(e){this.presets=e,this.presets=r3(e)}};const y_={minDisperse:new $P([.8,.12,.06,.02,0,0]),maxDisperse:new $P([0,0,.06,.12,.25,.57])};function r3(s,e=1){const t=s[0]+s[1]+s[2]+s[3]+s[4]+s[5];return t<=e?s:[s[0]/t,s[1]/t,s[2]/t,s[3]/t,s[4]/t,s[5]/t]}let px=class extends Xt{constructor(){super(...arguments),this.blurRadius=_g.sunny}};function n3(s){const e=new lt,t=e.fragment;e.include(qi),t.include(uc),t.uniforms.add(new Be("colorTexture",l=>l.emissionsToDownsample),new ge("blurRadius",l=>l.blurRadius));let i="";const r=15;for(let l=0;l<r;l++)i+=`locations1D[${l}] = ${(l/(r-1)*2-1).toFixed(3).toString()};`;const n=2;let a="";for(let l=0;l<r;l++)a+=`locations1DWeights[${l}] = ${A5(l-Math.floor(r/2),n).toFixed(7).toString()};`;const o=s.glowStage===0;return t.code.add(y`
    float locations1D[${y.int(r)}];
    float locations1DWeights[${y.int(r)}];

    vec3 blurUniformSamples(sampler2D toBlur) {
      vec3 res = vec3(0.0);
      vec2 size = vec2(textureSize(toBlur, 0));
      vec2 aspectCorrection = vec2(1.0, size.x / size.y);
      vec2 uvInPixel = uv * size;

      ${i}
      ${a}
      vec2 pixelCenterShift = 0.5 / size;

      for(int i=0;i < ${y.int(r)}; i++) {
        float uv1D = locations1D[i] + ${o?"pixelCenterShift.x":"pixelCenterShift.y"};
        vec2 uvOffset = ${o?"vec2(uv1D, 0.0)":"vec2(0.0, uv1D)"};

        vec2 uvDistorted = uv + uvOffset * blurRadius * aspectCorrection;
        vec3 sampleColor = texture(toBlur, uvDistorted).rgb;
        res += sampleColor * locations1DWeights[i];
      }
      return res;
    }
  `).main.add(y`fragColor = vec4(blurUniformSamples(colorTexture), 0.0);`),e}const tX=Object.freeze(Object.defineProperty({__proto__:null,GlowBlurPassParameters:px,build:n3},Symbol.toStringTag,{value:"Module"}));let ff=class extends ct{constructor(e,t){super(e,t,new ht(tX,()=>k(()=>Promise.resolve().then(()=>dee),void 0)),ri)}initializePipeline(){return qe({colorWrite:nt})}},sw=class extends ls{constructor(){super(...arguments),this.glowStage=0}};u([V({count:2})],sw.prototype,"glowStage",void 0);let mx=class extends DA{constructor(){super(...arguments),this.lodFactors=[0,0,0,0,0,0],this.glowLod=-1,this.dispersionWeight=1,this.distanceModifier=1e-4}};function a3(s){const e=new lt,t=e.fragment,{blurEnabled:i,tonemappingEnabled:r}=s;return e.include(Yp,{needUVs:!0,needEyeDirection:!0}),t.include(uc),t.include(EA),t.include(Qa),e.outputs.add("fragColor","vec4",0),e.outputs.add("fragEmission","vec3",1),t.include(Vp),t.uniforms.add(new Be("colorTexture",n=>n.color),new Be("emissionTexture",n=>n.emission)),i?(t.uniforms.add(new mr("depthTexture",n=>n.mainDepth),new ge("distanceModifier",n=>n.distanceModifier),new Be("lodTexture0",n=>n.lodTexture0),new Be("lodTexture1",n=>n.lodTexture1),new Be("lodTexture2",n=>n.lodTexture2),new Be("lodTexture3",n=>n.lodTexture3),new Be("lodTexture4",n=>n.lodTexture4),new oc("glowLod",n=>n.glowLod),new cr("minDisperse",()=>y_.minDisperse.presets,6),new cr("maxDisperse",()=>y_.maxDisperse.presets,6),new ge("dispersionWeight",n=>n.dispersionWeight)).main.add(y`
    vec4 color = texture(colorTexture, uv);
    color = vec4(linearizeGamma(color.rgb), color.a);

    vec3 lod0 = texture(emissionTexture, uv).rgb;
    vec3 lod1 = texture(lodTexture0, uv).rgb;
    vec3 lod2 = texture(lodTexture1, uv).rgb;
    vec3 lod3 = texture(lodTexture2, uv).rgb;
    vec3 lod4 = texture(lodTexture3, uv).rgb;
    vec3 lod5 = texture(lodTexture4, uv).rgb;

    float terrainDepth = -1.0;
    float depthSample = depthFromTexture(depthTexture, uv);
    if(depthSample < 1.0 && depthSample > 0.0){
      vec3 cameraSpaceRay = normalize(eyeDir);
      cameraSpaceRay /= cameraSpaceRay.z;
      cameraSpaceRay *= linearizeDepth(depthSample);
      terrainDepth = max(0.0, length(cameraSpaceRay));
    }
    vec3 rayDir = normalize(worldRay);
    float dispersionByDistance = getDistanceFalloff(terrainDepth, rayDir, distanceModifier);
    float dispersionPerPixel = dispersionWeight * dispersionByDistance;

    float lodFactor0 = mix(minDisperse[0], maxDisperse[0], dispersionPerPixel);
    float lodFactor1 = mix(minDisperse[1], maxDisperse[1], dispersionPerPixel);
    float lodFactor2 = mix(minDisperse[2], maxDisperse[2], dispersionPerPixel);
    float lodFactor3 = mix(minDisperse[3], maxDisperse[3], dispersionPerPixel);
    float lodFactor4 = mix(minDisperse[4], maxDisperse[4], dispersionPerPixel);
    float lodFactor5 = mix(minDisperse[5], maxDisperse[5], dispersionPerPixel);

    vec3 emission = lodFactor0 * lod0;
    emission += lodFactor1 * lod1;
    emission += lodFactor2 * lod2;
    emission += lodFactor3 * lod3;
    emission += lodFactor4 * lod4;
    emission += lodFactor5 * lod5;

    // only for glow editor lod debugging
    emission = glowLod == 0 ? lodFactor0 * lod0 : glowLod == 1 ? lodFactor1 * lod1 : glowLod == 2 ? lodFactor2 * lod2 : glowLod == 3 ? lodFactor3 * lod3 : glowLod == 4 ? lodFactor4 * lod4 : glowLod == 5 ? lodFactor5 * lod5 : emission;

    fragEmission = emission;
    // tonemapping is only applied to the emissive part since main color values are not in HDR.
    ${X(r,"emission = tonemapACES(emission);")}

    fragColor = delinearizeGamma(vec4(color.rgb + emission.rgb, color.w));
  `),e):(t.main.add(y`
      vec4 color = texture(colorTexture, uv);
      color = vec4(linearizeGamma(color.rgb), color.a);

      // emission is already in linear color space here.
      vec3 emission = texture(emissionTexture, uv).rgb;

      ${X(r,"emission = tonemapACES(emission);")}
      fragColor = delinearizeGamma(vec4(color.rgb + emission, color.w));
    `),e)}const iX=Object.freeze(Object.defineProperty({__proto__:null,GlowCompositionPassParameters:mx,build:a3},Symbol.toStringTag,{value:"Module"}));let gf=class extends ct{constructor(e,t){super(e,t,new ht(iX,()=>k(()=>Promise.resolve().then(()=>pee),void 0)),ri)}initializePipeline(e){return qe({colorWrite:nt,drawBuffers:{buffers:e.blurEnabled?[Ot,Ws]:[Ot]}})}},rw=class extends ls{constructor(){super(...arguments),this.blurEnabled=!1,this.tonemappingEnabled=!0}};u([V()],rw.prototype,"blurEnabled",void 0),u([V()],rw.prototype,"tonemappingEnabled",void 0);let Ul=class extends Ql{constructor(e){super(e),this.consumes={required:[ne.TRANSPARENT_ENVIRONMENT,"emissive"]},this.produces=ne.TRANSPARENT_ENVIRONMENT,this._blurHorizontalConfiguration=new sw,this._blurVerticalConfiguration=new sw,this._compositionConfiguration=new rw,this._compositionParameters=new mx,this._blurParameters=new px,this._blurScale=3.06,this._glowEnabled=!1,this._glowResults=new Array;const t=Zt(e.view.spatialReference);this._atmosphereRadius=t.radius+t.atmosphereHeight,e.view.stage.renderView.techniques.precompile(gf,this._compositionConfiguration)}initialize(){this.addHandles([$(()=>this._updateFogParameters(),()=>{},Ve),$(()=>this.view.qualitySettings.glow,e=>{this._glowEnabled=e,this.precompile(),this.requestRender(1)},Ve)])}_updateFogParameters(){const e=this.view.environment.weather;if(e.type==="sunny"||e.type==="cloudy")this._blurParameters.blurRadius=_g[e.type],this._compositionParameters.distanceModifier=0;else{const t=e.type==="foggy"?e.fogStrength:e.precipitation;this._blurParameters.blurRadius=Me(_g.cloudy,_g[e.type],t),this._compositionParameters.distanceModifier=e.type==="foggy"?Me(3e-5,.005,e.fogStrength**3):Me(4e-6,2e-4,(e.precipitation??0)**3)}this._computeLodFactors(),this.requestRender(1)}_computeLodFactors(e=y_.minDisperse.presets,t=y_.maxDisperse.presets){e.forEach((i,r)=>{this._compositionParameters.lodFactors[r]=Me(i,t[r],this._compositionParameters.dispersionWeight)})}precompile(){this._glowEnabled&&(this.techniques.precompile(ff,this._blurHorizontalConfiguration),this._blurVerticalConfiguration.glowStage=1,this.techniques.precompile(ff,this._blurVerticalConfiguration)),this._compositionConfiguration.blurEnabled=this._glowEnabled,this.techniques.precompile(gf,this._compositionConfiguration)}render(e){const t=e.find(({name:C})=>C===ne.TRANSPARENT_ENVIRONMENT),i=t.getAttachment(Ws);if(!i?.attachment)return t;const r=t.getAttachment(Ui);if(!this._glowEnabled){const C=this.techniques.get(gf,this._compositionConfiguration);if(!C.compiled)return this.requestRender(1),t;const P=t.getTexture(),M=this.fboCache,{fullWidth:O,fullHeight:D}=this.bindParameters.camera,A=this.renderingContext,F=M.acquire(P.descriptor.width,P.descriptor.height,this.produces);return this._prepareFBO(F,O,D),this._compositionParameters.color=P,this._compositionParameters.emission=i.attachment,A.bindTechnique(C,this.bindParameters,this._compositionParameters),A.screen.draw(),F.attachDepth(r),F.attachColor(i,Ws),F}const n=this.techniques.get(ff,this._blurHorizontalConfiguration),a=this.techniques.get(ff,this._blurVerticalConfiguration),o=this.techniques.get(gf,this._compositionConfiguration);if(!n.compiled||!a.compiled||!o.compiled)return this.requestRender(1),t;const l=t.getTexture(),c=this.fboCache,{fullWidth:h,fullHeight:d}=this.bindParameters.camera,m=this.renderingContext;let f=i.attachment,g=Math.ceil(h/2),_=Math.ceil(d/2);const v=5,b=this._blurParameters.blurRadius;for(let C=0;C<v;C++){const P=c.acquire(g,_,"glow horizontal",8);this._blurParameters.emissionsToDownsample=f,this._prepareFBO(P,g,_),m.bindTechnique(n,this.bindParameters,this._blurParameters),m.screen.draw();const M=c.acquire(g,_,"glow vertical",8);this._blurParameters.emissionsToDownsample=P.getTexture(),this._prepareFBO(M,g,_),m.bindTechnique(a,this.bindParameters,this._blurParameters),m.screen.draw(),P.release(),this._glowResults[C]=M,g=Math.ceil(g/2),_=Math.ceil(_/2),f=this._glowResults[C].getTexture(),this._blurParameters.blurRadius*=this._blurScale}this._blurParameters.blurRadius=b;const T=this.bindParameters.camera,w=fe(T.eye);this._compositionParameters.atmosphereC=w**2-this._atmosphereRadius**2,this._compositionParameters.color=l,this._compositionParameters.emission=i.attachment,this._compositionParameters.lodTexture0=this._glowResults[0].getTexture(),this._compositionParameters.lodTexture1=this._glowResults[1].getTexture(),this._compositionParameters.lodTexture2=this._glowResults[2].getTexture(),this._compositionParameters.lodTexture3=this._glowResults[3].getTexture(),this._compositionParameters.lodTexture4=this._glowResults[4].getTexture();const S=c.acquire(l.descriptor.width,l.descriptor.height,this.produces);return S.acquireColor(Ws,8,"emissive glow"),this._prepareFBO(S,h,d,!0),m.bindTechnique(o,this.bindParameters,this._compositionParameters),m.screen.draw(),this._glowResults.forEach(C=>C.release()),S.attachDepth(r),S}_prepareFBO(e,t,i,r=!1){const n=this.renderingContext;n.bindFramebuffer(e.fbo),n.setViewport(0,0,t,i),n.setClearColor(0,0,0,0),n.clear(16384),r&&n.clearBuffer(1,J_)}get test(){return{compositionParameters:this._compositionParameters,blurParameters:this._blurParameters,setBlurLodCombination:e=>{this._compositionParameters.dispersionWeight=e,this._computeLodFactors()},setLodFactors:e=>{this._computeLodFactors(r3(e))},toggleTonemapping:e=>{this._compositionConfiguration.tonemappingEnabled=e,this.requestRender(1)}}}};u([p()],Ul.prototype,"consumes",void 0),u([p()],Ul.prototype,"produces",void 0),Ul=u([R("esri.views.3d.webgl-engine.effects.glow.GlowRenderNode")],Ul);let fx=class extends Xt{};function o3(){const s=new lt;return s.include(qi),s.fragment.uniforms.add(new Be("colorTexture",e=>e.color),new mr("depthTexture",e=>e.mainDepth)),s.fragment.main.add(y`float depthSample = texture(depthTexture, uv).r;
if (depthSample == 1.0 ) {
fragColor = vec4(0);
return;
}
fragColor = texture(colorTexture, uv);`),s}const sX=Object.freeze(Object.defineProperty({__proto__:null,HazeCompositingPassParameters:fx,build:o3},Symbol.toStringTag,{value:"Module"}));let RP=class extends ct{constructor(e,t){super(e,t,new ht(sX,()=>k(()=>Promise.resolve().then(()=>mee),void 0)),ri)}initializePipeline(){return qe({blending:du(1,0,769,1),depthTest:{func:519},colorWrite:nt})}};function l3(s){const e=new lt,{fragment:t}=e;e.include(Yp),lc(t),t.include(uc),t.include(Qa),t.include(jp),t.include(Vp),t.include(PA,!0),t.uniforms.add(new mr("depthTexture",r=>r.mainDepth),new ge("hazeStrength",r=>r.hazeStrength));const{reduced:i}=s;return i&&t.code.add(y`float getDepth(vec2 uv){
return linearDepthFromTexture(depthTexture, uv);
}
float textureBilinear(vec2 uv) {
vec2 depthTextureSize = vec2(textureSize(depthTexture, 0));
vec2 texelSize = 1.0 / depthTextureSize;
vec2 depthUV = (uv * depthTextureSize) - vec2(0.5);
vec2 f = fract(depthUV);
vec2 snapUV = (floor(depthUV) + vec2(0.5)) / depthTextureSize;
float d0 = getDepth(snapUV);
float d1 = getDepth(snapUV + vec2(texelSize.x, 0.0));
float d2 = getDepth(snapUV + vec2(0.0, texelSize.y));
float d3 = getDepth(snapUV + texelSize);
return mix(mix(d0, d1, f.x), mix(d2, d3, f.x), f.y);
}`),t.main.add(y`
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;

      float depthSample = texture(depthTexture, uv).r;
      if (depthSample != 1.0) {
        vec3 cameraSpaceRay = normalize(eyeDir);
        cameraSpaceRay /= cameraSpaceRay.z;

        cameraSpaceRay *= ${X(i,"-textureBilinear(uv)","-linearDepthFromTexture(depthTexture, uv)")};
        terrainDepth = max(0.0, length(cameraSpaceRay));
      } else {
        discard;
      }

      // Alpha is ignored for haze blending
      vec3 col = vec3(0);
      float fadeOut = smoothstep(-10000.0, -15000.0, heightParameters[0] - radii[0]);
      if(depthSample != 1.0){
        col = (1.0 - fadeOut) * hazeStrength * raymarchAtmosphere(cameraPosition, rayDir, mainLightDirection, terrainDepth);
      }
      float alpha = 1.0;

      col = tonemapACES(col);
      fragColor = delinearizeGamma(vec4(col, alpha));
  `),e}const rX=Object.freeze(Object.defineProperty({__proto__:null,build:l3},Symbol.toStringTag,{value:"Module"}));let nX=class extends SA{constructor(){super(...arguments),this.hazeStrength=1}},Kv=class extends ct{constructor(e,t){super(e,t,new ht(rX,()=>k(()=>Promise.resolve().then(()=>fee),void 0)),Ya(Fp))}initializePipeline(e){return e.reduced?qe({blending:bw,depthTest:{func:519},colorWrite:nt}):qe({blending:du(1,0,769,1),colorWrite:nt})}},yg=class extends ls{constructor(){super(...arguments),this.reduced=!1}};u([V()],yg.prototype,"reduced",void 0);let nw=class extends Ql{constructor(e){super(e),this._compositingPassParameters=new fx,this._passParameters=new nX,this._hazeConfiguration=new yg,this.requireGeometryDepth=!0,this._oldAmount=1,this._newAmount=1,this._amount=this._newAmount;const t=e.view.stage.renderView.techniques;t.precompile(Kv,new yg);const i=new yg;i.reduced=!0,t.precompile(Kv,i),t.precompile(RP)}initialize(){this.addHandles([$(()=>this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),Ve),$(()=>this.view.stage?.renderer.renderContext.bind.clouds.fadeFactor??1,e=>this._fade(e),Ve),$(()=>this.view.environment.weather.type,e=>this._newAmount=e==="rainy"?0:1,Ve),$(()=>this.view.stage.renderer?.fullResolutionAtmosphere,e=>this._hazeConfiguration.reduced=!e,Ve)])}_fade(e){e>=1?(this._amount=this._newAmount,this._oldAmount=this._newAmount):this._amount=e<=0?this._oldAmount:Me(this._oldAmount,this._newAmount,e)}destroy(){this._vao=_e(this._vao)}render(e){const t=e.find(({name:v})=>v===ne.TRANSPARENT_ENVIRONMENT);if(!this.bindParameters.mainDepth)return t;const i=this.renderingContext,r=this.techniques.get(Kv,this._hazeConfiguration);if(!r.compiled)return t;const n=t.getAttachment(Ui);if(this._update(),!this._hazeConfiguration.reduced)return t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(r,this.bindParameters,this._passParameters),this._renderCommon(i),t.attachDepth(n),t;const a=this.techniques.get(RP);if(!a.compiled)return t;const o=i.getViewport(),l=this.camera,c=fe(l.eye)-Ei.radius;let h;const d=Ei.atmosphereHeight;if(c<d){const v=Math.min(1,Math.max(0,c/d));h=Me(.4,.5,v)}else{const v=Math.min(1,Math.max(0,(c-d)/(15*d)));h=Me(.5,1,v)}const m=this.renderingContext.parameters.maxTextureSize,f=jh(Math.round(h*l.fullViewport[2]),m),g=jh(Math.round(h*l.fullViewport[3]),m);i.setViewport(0,0,f,g);const _=this.fboCache.acquire(f,g,"haze",5);return i.bindFramebuffer(_.fbo),i.clearFramebuffer([0,0,0,1],!0,!0),i.bindTechnique(r,this.bindParameters,this._passParameters),this._renderCommon(i),i.setViewport(o.x,o.y,o.width,o.height),this._compositingPassParameters.color=_.getTexture(),t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(a,this.bindParameters,this._compositingPassParameters),i.screen.draw(),t.attachDepth(n),_.release(),t}_renderCommon(e){this._vao??=Wo(e,1),e.bindVAO(this._vao),e.drawArrays(Ct.TRIANGLE_STRIP,0,4)}_update(){const e=this.bindParameters.camera,t=Gs(e.eye),i=Math.sqrt(t),r=t-this._passParameters.radii[1]*this._passParameters.radii[1],n=U((i-this._passParameters.radii[0])/Ei.atmosphereHeight,0,1);os(this._passParameters.heightParameters,i,t,r,n);const a=this.view.basemapTerrain?.getLowerBoundRadius()??0;Xi(this._passParameters.radii,a,a+Ei.atmosphereHeight),this._passParameters.hazeStrength=Me(Me(.6,1,Kh(9500,10500,i-Ei.radius)),1,this._amount)}};nw=u([R("esri.views.3d.webgl-engine.effects.haze.Haze")],nw);function Jv(s){if(!s.highlights)return null;const e=s.highlights.findIndex(t=>t.name==="default");return e===-1?null:s.highlights.items[e]}function aX(s){const e=s.fragment;s.include(Rw),e.include(Qa),e.code.add(y`vec3 normalFromDepth(sampler2D depthMap, vec3 pixelPos, vec2 fragCoord, vec2 uv) {
ivec2 iuv = ivec2(uv * vec2(textureSize(depthMap, 0)));
float leftPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(-1, 0), 0).r);
float rightPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(1, 0), 0).r);
float bottomPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(0, -1), 0).r);
float topPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(0, 1), 0).r);
bool pickLeft = abs(pixelPos.z - leftPixelDepth) < abs(pixelPos.z - rightPixelDepth);
bool pickBottom = abs(pixelPos.z - bottomPixelDepth) < abs(pixelPos.z - topPixelDepth);
vec3 fragCoordHorizontal = pickLeft
? vec3(fragCoord + vec2(-1.0, 0.0), leftPixelDepth)
: vec3(fragCoord + vec2(1.0, 0.0), rightPixelDepth);
vec3 fragCoordVertical = pickBottom
? vec3(fragCoord + vec2(0.0, -1.0), bottomPixelDepth)
: vec3(fragCoord + vec2(0.0, 1.0), topPixelDepth);
vec3 verticalPixelPos = reconstructPosition(fragCoordHorizontal.xy, fragCoordHorizontal.z);
vec3 horizontalPixelPos = reconstructPosition(fragCoordVertical.xy, fragCoordVertical.z);
vec3 normal = normalize(cross(verticalPixelPos - pixelPos, horizontalPixelPos - pixelPos));
return pickLeft == pickBottom ? normal : -normal;
}`)}function c3(s){s.include(NL),oX(s)}function oX(s){s.fragment.include(Qa),s.include(Rw),s.fragment.uniforms.add(new ur("inverseViewMatrix",({camera:e})=>eu(OP,rc(OP,e.viewMatrix,e.center)))).code.add(y`vec3 calculateUVZShadowAndPixelPosFromDepth(
in vec2 _uv,
ivec2 shadowMapSize,
in sampler2D _depthMap,
out vec4 currentPixelPos
) {
float depth = depthFromTexture(_depthMap, _uv);
if (depth >= 1.0 || depth <= 0.0) {
return invalidShadowmapUVZ;
}
float currentPixelDepth = linearizeDepth(depth);
currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;
float linearDepth = -currentPixelDepth;
return calculateUVZShadow(worldSpacePos.xyz, linearDepth, shadowMapSize);
}
vec3 calculateUVZShadowFromDepth(
in vec2 _uv,
ivec2 shadowMapSize,
in sampler2D _depthMap
) {
vec4 currentPixelPos;
return calculateUVZShadowAndPixelPosFromDepth(_uv, shadowMapSize, _depthMap, currentPixelPos);
}`)}const OP=Ie(),lX=.025;function h3(){const s=new lt;s.include(c3),s.include(f$),s.include(qi),s.include(aX);const e=s.fragment;return e.uniforms.add(new T0("shadowMapExcludingHighlight",t=>t.shadowMap.getSnapshot(1)),new T0("shadowMapHighlight",t=>t.shadowMap.getSnapshot(0)),new mr("depthMap",t=>t.depth?.attachment),new wu("highlightTexture",t=>t.highlightTexture),new qs("uColor",t=>t.shadowColor),new ge("opacity",t=>t.shadowOpacity),new ge("occludedOpacity",t=>t.occludedShadowOpacity),new ge("terminationFactor",t=>t.opacityElevation*t.dayNightTerminator),new Tn("lightingMainDirectionView",({lighting:t,camera:i})=>pe(DP,ot(DP,t.mainLight.direction,i.viewInverseTransposeMatrix)))),e.main.add(y`
    ivec2 highlightTextureSize = textureSize(highlightTexture, 0);
    ivec2 highlightIUV = ivec2(uv * vec2(highlightTextureSize));
    uvec2 highlightInfo = texelFetch(highlightTexture, highlightIUV, 0).rg;

    fragColor = vec4(0.0);

    // Calculate bit mask to check if pixel is highlit unoccluded at any level
    uint ored = (highlightInfo.r << 0) | (highlightInfo.g << 8);

    bool visiblyHighlighted = ((ored & ~(ored >> 1)) & (1u+4u+16u+64u)) != 0u;
    if (visiblyHighlighted) {
      return;
    }

    vec4 currentPixelPos;
    vec3 uvzShadow = calculateUVZShadowAndPixelPosFromDepth(uv, textureSize(shadowMapHighlight,0), depthMap, currentPixelPos);
    if (uvzShadow.z < 0.0) {
      return;
    }

    float shadowHighlightFactor = readShadowMapUVZ(uvzShadow, shadowMapHighlight);
    if (shadowHighlightFactor == 0.0) {
      return;
    }

    float shadowExcludingHighlightFactor = readShadowMapUVZ(uvzShadow, shadowMapExcludingHighlight);

    vec3 normal = normalFromDepth(depthMap, currentPixelPos.xyz, gl_FragCoord.xy, uv);
    bool shaded = dot(normal, lightingMainDirectionView) < ${y.float(lX)};

    float occludedFactor = max(shadowExcludingHighlightFactor, shaded ? 1.0 : 0.0);
    float fragOpacity = mix(opacity, occludedOpacity, occludedFactor);
    fragColor = vec4(uColor.rgb, uColor.a * fragOpacity * terminationFactor);
  `),s}const DP=x(),cX=Object.freeze(Object.defineProperty({__proto__:null,build:h3},Symbol.toStringTag,{value:"Module"}));let hX=class extends $w{constructor(){super(...arguments),this.shadowColor=Si(1,0,1,1),this.shadowOpacity=.2,this.occludedShadowOpacity=.1,this.opacityElevation=1,this.dayNightTerminator=1}},EP=class extends ct{constructor(e,t){super(e,t,new ht(cX,()=>k(()=>Promise.resolve().then(()=>gee),void 0)),ri),this.primitiveType=Ct.TRIANGLE_STRIP}initializePipeline(){return qe({blending:za,colorWrite:nt,depthTest:null,depthWrite:null})}};const uX=1/512,dX=4e4,pX=5e4;let fh=class extends Ho{constructor(e){super(e),this.produces=It.COMPOSITE,this.consumes={required:[It.COMPOSITE,"highlights"]},this._passParameters=new hX,this._maxOpacity=1,this._shadowDifference=.2}initialize(){this.addHandles([$(()=>Jv(this.view)?.shadowOpacity,e=>{this._passParameters.shadowOpacity=e??FR,this._updateOccludedShadowOpacity(),this._ensureMaxOpacity()},Ve),$(()=>Jv(this.view)?.shadowDifference,e=>{this._shadowDifference=e??VR,this._updateOccludedShadowOpacity(),this._ensureMaxOpacity()},Ve),$(()=>Jv(this.view)?.shadowColor,e=>{this._passParameters.shadowColor=t1(e??LR),this._ensureMaxOpacity()},Ve)])}_updateOccludedShadowOpacity(){this._passParameters.occludedShadowOpacity=this._passParameters.shadowOpacity*(1-this._shadowDifference)}_ensureMaxOpacity(){const e=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity);this._maxOpacity=e*this._passParameters.shadowColor[3],this.requestRender(1)}precompile(){this.techniques.precompile(EP)}render(e){const t=e.find(({name:a})=>a===It.COMPOSITE),i=this.bindParameters;if(!i.shadowHighlightsVisible||!i.depth||!this._ensureIfVisible(i.camera,i.lighting.mainLight.direction))return t;const r=this.techniques.get(EP);if(!r.compiled)return this.requestRender(1),t;this._passParameters.highlightTexture=e.find(({name:a})=>a==="highlights")?.getTexture(),this._passParameters.origin=i.camera.center;const n=this.renderingContext;return n.bindFramebuffer(t.fbo),n.bindTechnique(r,i,this._passParameters),n.screen.draw(),t}_ensureIfVisible(e,t){this._passParameters.opacityElevation=1-Kh(dX,pX,e.relativeElevation);const i=this.viewingMode===1?pe(AP,e.center):be(AP,0,0,1),r=We(i,t);return this._passParameters.dayNightTerminator=Kh(0,1,U(30*r,0,1)),this._maxOpacity*this._passParameters.opacityElevation*this._passParameters.dayNightTerminator>=uX}};u([p()],fh.prototype,"produces",void 0),u([p()],fh.prototype,"consumes",void 0),u([p({constructOnly:!0})],fh.prototype,"viewingMode",void 0),fh=u([R("esri.views.3d.webgl-engine.effects.highlight.ShadowHighlight")],fh);const AP=x();let gx=class extends Xt{constructor(){super(...arguments),this.mask=null,this.overlay=null,this.input=null,this.size=0}};function u3(){const s=new lt;return s.attributes.add("position","vec2"),s.vertex.uniforms.add(new qs("drawPosition",(e,t)=>mX(e,t))),s.varyings.add("vUV","vec2"),s.vertex.main.add(y`vUV = position;
gl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);`),s.fragment.uniforms.add(new Be("textureInput",e=>e.input)),s.fragment.uniforms.add(new Be("textureMask",e=>e.mask)),s.fragment.uniforms.add(new Be("textureOverlay",e=>e.overlay)),s.fragment.uniforms.add(new nu("maskEnabled",e=>e.magnifier.maskEnabled)),s.fragment.uniforms.add(new nu("overlayEnabled",e=>e.magnifier.overlayEnabled)),s.fragment.code.add(y`const float barrelFactor = 1.1;
vec2 barrel(vec2 uv) {
vec2 uvn = uv * 2.0 - 1.0;
if (uvn.x == 0.0 && uvn.y == 0.0) {
return vec2(0.5, 0.5);
}
float theta = atan(uvn.y, uvn.x);
float r = pow(length(uvn), barrelFactor);
return r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;
}`),s.fragment.main.add(y`float mask = maskEnabled ? texture(textureMask, vUV).a : 1.0;
vec4 inputColor = texture(textureInput, barrel(vUV)) * mask;
vec4 overlayColor = overlayEnabled ? texture(textureOverlay, vUV) : vec4(0);
fragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;`),s}function mX(s,e){const t=e.camera.pixelRatio,i=s.magnifier.offset.x*t,r=s.magnifier.offset.y*t;mn(s.magnifier.position,IP);const n=e.camera.screenToRender(IP,fX),a=Math.ceil(t*s.magnifier.size),{fullWidth:o,fullHeight:l}=e.camera;return os(gX,(n[0]+i)/o*2-1,(n[1]-r)/l*2-1,a/o*2,a/l*2)}const IP=ii(),fX=$$(),gX=Lt(),_X=Object.freeze(Object.defineProperty({__proto__:null,MagnifierPassParameters:gx,build:u3},Symbol.toStringTag,{value:"Module"}));let LP=class extends ct{constructor(e,t){super(e,t,new ht(_X,()=>k(()=>Promise.resolve().then(()=>_ee),void 0)),ri)}initializePipeline(){return qe({blending:pu,depthTest:null,depthWrite:null,colorWrite:nt})}};async function yX(s){const e=k(()=>import("./mask-svg-BZIDpTf0.js"),[]),t=k(()=>import("./overlay-svg-DKwEt0oU.js"),[]),i=ec((await e).default,{signal:s}),r=ec((await t).default,{signal:s}),n={mask:await i,overlay:await r};return He(s),n}let Tl=class extends Ho{constructor(){super(...arguments),this.produces=ne.MAGNIFIER,this.consumes={required:[ne.MAGNIFIER]},this._imageSources=null,this._imageLoadTask=null,this._passParameters=new gx,this._magnifier=null,this._tmpScreenPoint=ii(),this._tmpRenderPoint=$$()}initialize(){this.addHandles([$(()=>this.view.magnifier,e=>this._update(e),Ve)])}_update(e){if(e===this._magnifier)return;this.removeAllHandles(),this._magnifier=e;const t=()=>{const i=this._validMagnifier;i?(this._loadResources(i),this.produces=ne.MAGNIFIER):this.produces="disabled",this.requestRender()};this._magnifier&&this.addHandles($(()=>this._magnifier?.version,t)),t()}get _validMagnifier(){return this._magnifier?.visible&&this._magnifier?.position&&this._magnifier?.size>0?this._magnifier:null}get _factor(){return this._magnifier?.factor||1}destroy(){this._magnifier=null,this._imageLoadTask!=null&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeTextures(),this._vao=_e(this._vao)}_disposeTextures(){this._passParameters.mask=_e(this._passParameters.mask),this._passParameters.overlay=_e(this._passParameters.overlay),this._passParameters.input=_e(this._passParameters.input)}precompile(){this._imageSources&&this.techniques.precompile(LP)}render(e){const t=this._validMagnifier,i=e.find(({name:b})=>b===ne.MAGNIFIER);if(t==null)return i;if(this._imageSources==null)return this.requestRender(1),i;const r=this.renderingContext,n=this.camera.pixelRatio,a=Math.ceil(n*t.size);this._vao??=Wo(r,0,0,1);const o=this.techniques.get(LP);if(this._ensureTextureResources(r,a),!o.compiled||!this._passParameters.input)return this.requestRender(1),i;const l=Math.ceil(1/this._factor*a),c=this._passParameters.input;c.resize(l,l),mn(t.position,this._tmpScreenPoint);const h=this.camera.screenToRender(this._tmpScreenPoint,this._tmpRenderPoint),d=this.camera.fullWidth,m=this.camera.fullHeight,f=.5*l,g=.5*l;h[0]=U(h[0],f,d-f-1),h[1]=U(h[1],g,m-g-1);const _=Math.floor(h[0]-f),v=Math.floor(h[1]-g);return r.bindFramebuffer(i.fbo),o.program.bindTexture("textureInput",c),r.gl.copyTexImage2D(c.descriptor.target,0,c.descriptor.pixelFormat,_,v,l,l,0),this._passParameters.magnifier=t,r.bindTechnique(o,this.bindParameters,this._passParameters),r.bindVAO(this._vao),r.drawArrays(Ct.TRIANGLE_STRIP,0,4),i}_loadResources(e){const{maskUrl:t,overlayUrl:i}=e;this._imageLoadTask?.maskUrl===t&&this._imageLoadTask?.overlayUrl===i||(this._imageLoadTask?.task.abort(),this._imageLoadTask=this._imageSources=null),this._imageSources||this._imageLoadTask||(this._imageLoadTask={maskUrl:t,overlayUrl:i,task:Za(async r=>{const n=t==null||i==null?yX(r):null,a=t!=null?ec(t,{signal:r}):n.then(l=>l.mask),o=i!=null?ec(i,{signal:r}):n.then(l=>l.overlay);this._imageSources={mask:await a,overlay:await o}})})}_ensureTextureResources(e,t){this._imageSources==null||this._passParameters.size===t&&this._passParameters.input&&this._passParameters.mask&&this._passParameters.overlay||(this._disposeTextures(),this._imageSources.overlay.width=this._imageSources.mask.width=t,this._imageSources.overlay.height=this._imageSources.mask.height=t,this._passParameters.overlay=new bt(e,this._createTextureDescriptor(t,6408,this._imageSources.overlay),this._imageSources.overlay),this._passParameters.mask=new bt(e,this._createTextureDescriptor(t,6406,this._imageSources.mask),this._imageSources.mask),this._passParameters.input=new bt(e,this._createTextureDescriptor(t,6408,null)))}_createTextureDescriptor(e,t,i){const r=this.renderingContext,n=new ft(e);return n.pixelFormat=n.internalFormat=t,n.wrapMode=33071,n.flipped=!!i,n.preMultiplyAlpha=!(t!==6408||!i||x$(i.src)&&r.driverTest.svgPremultipliesAlpha.result),n}};u([p()],Tl.prototype,"produces",void 0),u([p()],Tl.prototype,"consumes",void 0),u([p()],Tl.prototype,"_imageSources",void 0),u([p()],Tl.prototype,"_imageLoadTask",void 0),Tl=u([R("esri.views.3d.webgl-engine.effects.magnifier.Magnifier")],Tl);const Xu=8,vX=16;function d3(){const s=new lt;s.include(qi),s.fragment.uniforms.add(new Be("edgesTexture",t=>t.inputTexture),new Be("areaTexture",t=>t.areaTexture),new Be("searchTexture",t=>t.searchTexture)),s.fragment.constants.add("smaaAreaTexPixelSize","vec2",[1/160,1/560]);const e=1/7;return s.fragment.code.add(y`
    vec4 sampleLevelZeroOffset(vec2 coord, vec2 offset, vec2 resolution) {
      return texture(edgesTexture, coord + offset.x * resolution);
    }

    float searchLength(vec2 e, float bias, float scale) {
      e.r = bias + e.r * scale;
      return 255.0 * texture(searchTexture, e).r;
    }

    float searchLeft(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(0.0, 1.0);
      for (int i = 0; i < ${y.int(Xu)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord -= vec2(2.0, 0.0) * resolution;
        if (! (texcoord.x > end && e.g > 0.8281 && e.r == 0.0)) break;
      }
      texcoord.x += 0.25 * resolution.x;
      texcoord.x += resolution.x;
      texcoord.x += 2.0 * resolution.x;
      texcoord.x -= resolution.x * searchLength(e, 0.0, 0.5);
      return texcoord.x;
    }

    float searchRight(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(0.0, 1.0);
      for (int i = 0; i < ${y.int(Xu)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord += vec2(2.0, 0.0) * resolution;
        if (! (texcoord.x < end && e.g > 0.8281 && e.r == 0.0)) break;
      }
      texcoord.x -= 0.25 * resolution.x;
      texcoord.x -= resolution.x;
      texcoord.x -= 2.0 * resolution.x;
      texcoord.x += resolution.x * searchLength(e, 0.5, 0.5);
      return texcoord.x;
    }

    float searchUp(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(1.0, 0.0);
      for (int i = 0; i < ${y.int(Xu)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord += vec2(0.0, 2.0) * resolution;
        if (! (texcoord.y > end && e.r > 0.8281 && e.g == 0.0)) break;
      }
      texcoord.y -= 0.25 * resolution.y;
      texcoord.y -= resolution.y;
      texcoord.y -= 2.0 * resolution.y;
      texcoord.y += resolution.y * searchLength(e.gr, 0.0, 0.5);
      return texcoord.y;
    }

    float searchDown(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(1.0, 0.0);
      for (int i = 0; i < ${y.int(Xu)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord -= vec2(0.0, 2.0) * resolution;
        if (! (texcoord.y < end && e.r > 0.8281 && e.g == 0.0)) break;
      }
      texcoord.y += 0.25 * resolution.y;
      texcoord.y += resolution.y;
      texcoord.y += 2.0 * resolution.y;
      texcoord.y -= resolution.y * searchLength(e.gr, 0.5, 0.5);
      return texcoord.y;
    }

    vec2 getArea(sampler2D areaTex, vec2 dist, float e1, float e2, float offset) {
      vec2 texcoord = float(${y.int(vX)}) * round(4.0 * vec2(e1, e2)) + dist;
      texcoord = smaaAreaTexPixelSize * texcoord + (0.5 * smaaAreaTexPixelSize);
      texcoord.y += ${y.float(e)} * offset;
      return texture(areaTex, texcoord).rg;
    }`),s.fragment.main.add(y`
    vec2 size = vec2(textureSize(edgesTexture, 0));
    vec2 resolution = 1.0 / size;
    vec2 pixelCoord = uv * size;
    vec4 offsets[2];
    offsets[0] = uv.xyxy + resolution.xyxy * vec4(-0.25, 0.125, 1.25, 0.125);
    offsets[1] = uv.xyxy + resolution.xyxy * vec4(-0.125, 0.25, -0.125, -1.25);
    vec4 maxOffset = vec4(offsets[0].xz, offsets[1].yw) + vec4(-2.0, 2.0, -2.0, 2.0) * resolution.xxyy * float(${y.int(Xu)});
    ivec4 subsampleIndices = ivec4(0.0);
    vec4 weights = vec4(0.0);
    vec2 e = texture(edgesTexture, uv).rg;
    if (e.r > 0.0) {
      vec2 d;
      vec2 coords;
      coords.y = searchUp(offsets[1].xy, maxOffset.z, resolution);
      coords.x = offsets[0].x;
      d.x = coords.y;
      float e1 = texture(edgesTexture, coords).g;
      coords.y = searchDown(offsets[1].zw, maxOffset.w, resolution);
      d.y = coords.y;
      d = d * size.y - pixelCoord.y;
      vec2 sqrt_d = sqrt(abs(d));
      coords.y -= 1.0 * resolution.y;
      float e2 = sampleLevelZeroOffset(coords, vec2(0.0, 1.0), resolution).g;
      weights.ba = getArea(areaTexture, sqrt_d, e1, e2, float(subsampleIndices.x));
      // for some reason the following lines are necessary to prevent
      // texture lookup precision issues on some Intel integrated graphics chips
      vec4 dbg = (offsets[0] + offsets[1] + maxOffset + coords.xyyx);
      weights.r += 0.00000001 * dot(vec4(0, 1, 0, 1), dbg);
    }
    if (e.g > 0.0) {
      vec2 d;
      vec2 coords;
      coords.x = searchLeft(offsets[0].xy, maxOffset.x, resolution);
      coords.y = offsets[1].y;
      d.x = coords.x;
      float e1 = texture(edgesTexture, coords).r;
      coords.x = searchRight(offsets[0].zw, maxOffset.y, resolution);
      d.y = coords.x;
      d = d * size.x - pixelCoord.x;
      vec2 sqrt_d = sqrt(abs(d));
      coords.y -= 1.0 * resolution.y;
      float e2 = sampleLevelZeroOffset(coords, vec2(1.0, 0.0), resolution).r;
      weights.rg = getArea(areaTexture, sqrt_d, e1, e2, float(subsampleIndices.y));
    }
    fragColor = weights;
  `),s}const bX=Object.freeze(Object.defineProperty({__proto__:null,build:d3},Symbol.toStringTag,{value:"Module"}));let FP=class extends ct{constructor(e,t){super(e,t,new ht(bX,()=>k(()=>Promise.resolve().then(()=>yee),void 0)),ri)}initializePipeline(){return qe({colorWrite:nt})}};function p3(){const s=new lt;return s.include(qi),s.fragment.uniforms.add(new Be("blendWeightsTexture",e=>e.inputTexture),new Be("colorTexture",e=>e.color)),s.fragment.main.add(y`vec2 resolution = 1.0 / vec2(textureSize(colorTexture, 0));
vec4 offsets = vec4(uv.x + resolution.x, uv.y, uv.x, uv.y - resolution.y);
vec4 a;
a.rb = texture(blendWeightsTexture, uv).rb;
a.g = texture(blendWeightsTexture, offsets.zw).g;
a.a = texture(blendWeightsTexture, offsets.xy).a;
if ( dot(a, vec4(1.0)) < 1e-5 ) {
fragColor = texture( colorTexture, uv, 0.0 );
} else {
vec2 offset;
offset.x = a.a > a.b ? a.a : -a.b;
offset.y = a.g > a.r ? -a.g : a.r;
if ( abs( offset.x ) > abs( offset.y )) {
offset.y = 0.0;
} else {
offset.x = 0.0;
}
vec4 C = texture( colorTexture, uv, 0.0 );
vec4 Cop = texture( colorTexture, uv + sign( offset ) * resolution.xy, 0.0 );
float s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );
fragColor = mix(C, Cop, s);
}`),s}const wX=Object.freeze(Object.defineProperty({__proto__:null,build:p3},Symbol.toStringTag,{value:"Module"}));let VP=class extends ct{constructor(e,t){super(e,t,new ht(wX,()=>k(()=>Promise.resolve().then(()=>vee),void 0)),ri)}initializePipeline(){return qe({colorWrite:nt})}};const xX=.05,CX=2;function m3(){const s=new lt;return s.include(qi),s.outputs.add("fragEdges","vec2"),s.fragment.code.add(y`float absMax3(vec3 v) {
vec3 t = abs(v);
return max(max(t.r, t.g), t.b);
}`),s.fragment.uniforms.add(new Be("colorTexture",e=>e.color)).main.add(y`
    vec2 resolution = 1.0 / vec2(textureSize(colorTexture, 0));
    vec4 offsets[3];
    offsets[0] = vec4(uv.x - resolution.x, uv.y, uv.x, uv.y + resolution.y);
    offsets[1] = vec4(uv.x + resolution.x, uv.y, uv.x, uv.y - resolution.y);
    offsets[2] = vec4(uv.x - 2.0 * resolution.x, uv.y, uv.x, uv.y + 2.0 * resolution.y);

    // Calculate color deltas:
    vec3 C = texture(colorTexture, uv).rgb;
    vec3 Cleft = texture(colorTexture, offsets[0].xy).rgb;
    vec3 Ctop = texture(colorTexture, offsets[0].zw).rgb;
    vec2 delta = vec2(absMax3(C - Cleft), absMax3(C - Ctop));
    vec2 edges = step(vec2(${y.float(xX)}), delta);

    // discard if there is no edge:
    if (dot(edges, vec2(1.0)) == 0.0) {
      fragEdges = vec2(0.0);
    }
    else {
      // Calculate right and bottom deltas:
      vec3 Cright = texture(colorTexture, offsets[1].xy).rgb;
      float horizontal = absMax3(C - Cright);

      vec3 Cbottom  = texture(colorTexture, offsets[1].zw).rgb;
      float vertical = absMax3(C - Cbottom);

      // Calculate the maximum delta in the direct neighborhood:
      float maxDelta = max(max(max(delta.x, delta.y), horizontal), vertical);

      // Calculate left-left and top-top deltas:
      vec3 Cleftleft  = texture(colorTexture, offsets[2].xy).rgb;
      horizontal = absMax3(C - Cleftleft);

      vec3 Ctoptop = texture(colorTexture, offsets[2].zw).rgb;
      vertical = absMax3(C - Ctoptop);

      // Calculate the final maximum delta:
      maxDelta = max(max(maxDelta, horizontal), vertical);

      // Local contrast adaptation in action:
      fragEdges = edges * step(maxDelta, float(${y.float(CX)}) * delta);
    }
  `),s}const TX=Object.freeze(Object.defineProperty({__proto__:null,build:m3},Symbol.toStringTag,{value:"Module"}));let kP=class extends ct{constructor(e,t){super(e,t,new ht(TX,()=>k(()=>Promise.resolve().then(()=>bee),void 0)),ri)}initializePipeline(){return qe({colorWrite:nt})}},SX=class extends Xt{},Sl=class extends Ho{constructor(e){super(e),this.produces="disabled",this.consumes={required:[ne.ANTIALIASING],optional:[It.COMPOSITE]},this._areaTexture=null,this._searchTexture=null,this._smaaParameters=new SX}initialize(){this.addHandles([$(()=>this.isEnabled(),e=>e?this.enable():this.disable(),Ve)])}async enable(){if(this.destroyed||(this.produces=ne.ANTIALIASING,this.requestRender(1),this._abortController||this._areaTexture&&this._searchTexture))return;this._abortController=new AbortController;const e=this._abortController.signal;try{const t=await k(()=>import("./SMAAData-DCEZ61Cs.js"),[]);He(e),await this._loadTextures(t,e),He(e),this.requestRender(1)}catch(t){zr(t)||j.getLogger(this).errorOnce(t)}this._abortController=null}async _loadTextures(e,t){He(t);const[i,r]=await Promise.allSettled([ec(e.areaTexture,{signal:t}),ec(e.searchTexure,{signal:t})]);if(He(t),i.status!=="fulfilled"||r.status!=="fulfilled")return;const n=this.renderingContext;this._areaTexture=zP(n,9729,6407,i.value),this._searchTexture=zP(n,9728,6409,r.value)}disable(){this.produces="disabled",this.requestRender(1)}destroy(){this._abortController=Os(this._abortController),this._searchTexture=_e(this._searchTexture),this._areaTexture=_e(this._areaTexture)}precompile(){this.techniques.precompile(kP),this.techniques.precompile(FP),this.techniques.precompile(VP)}render(e){const t=e.find(({name:f})=>f===ne.ANTIALIASING),i=e.find(({name:f})=>f===It.COMPOSITE);if(!i)return t;if(!this._areaTexture||!this._searchTexture)return this.view.stage.renderer.blitFBO(i,t,!1),this.requestRender(1),t;const r=this.techniques.get(kP),n=this.techniques.get(FP),a=this.techniques.get(VP);if(!r.compiled||!n.compiled||!a.compiled)return this.view.stage.renderer.blitFBO(i,t,!1),this.requestRender(1),t;const o=i.fbo.width,l=i.fbo.height,c=this.renderingContext;c.setViewport(0,0,o,l);const h=this.fboCache.acquire(o,l,"smaa edges",2);c.bindFramebuffer(h.fbo),c.setClearColor(0,0,0,1),c.clear(16384),this._smaaParameters.color=i.getTexture();const d=this.bindParameters;c.bindTechnique(r,d,this._smaaParameters),c.screen.draw();const m=this.fboCache.acquire(o,l,"smaa blend");return c.bindFramebuffer(m.fbo),c.setClearColor(0,0,1,1),c.clear(16384),this._smaaParameters.inputTexture=h.getTexture(),this._smaaParameters.areaTexture=this._areaTexture,this._smaaParameters.searchTexture=this._searchTexture,c.bindTechnique(n,d,this._smaaParameters),c.screen.draw(),h.release(),c.bindFramebuffer(t.fbo),c.setClearColor(0,1,0,1),c.clear(16384),this._smaaParameters.inputTexture=m.getTexture(),c.bindTechnique(a,d,this._smaaParameters),c.screen.draw(),m.release(),t}};function zP(s,e,t,i){const r=new ft(i.width,i.height);return r.pixelFormat=t,r.wrapMode=33071,r.samplingMode=e,new bt(s,r,i)}u([p()],Sl.prototype,"produces",void 0),u([p()],Sl.prototype,"consumes",void 0),u([p({constructOnly:!0})],Sl.prototype,"isEnabled",void 0),u([p()],Sl.prototype,"_abortController",void 0),Sl=u([R("esri.views.3d.webgl-engine.effects.smaa.SMAA")],Sl);function f3(){const s=new lt;return s.attributes.add("position","vec3"),s.attributes.add("color","vec4"),s.attributes.add("size","float"),s.varyings.add("vcolor","vec4"),s.varyings.add("vsize","float"),s.vertex.uniforms.add(new UL("transform",(e,t)=>PX(e,t)),new C_("viewport",e=>e.camera.fullViewport),new Rs("pixelRatio",e=>e.camera.pixelRatio)),s.vertex.main.add(y`gl_Position = transform * vec4(position, 0);
vcolor = color / 1.2;
vsize = size * 5.0 * pixelRatio;
gl_PointSize = vsize;`),s.fragment.main.add(y`float cap = 0.7;
float scale = 1.0 / cap;
float helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);
float alpha = clamp((cap - helper) * scale, 0.0, 1.0);
float intensity = alpha * alpha * alpha;
if (vsize < 3.0) {
intensity *= 0.5;
}
fragColor = vec4(vcolor.xyz, intensity);`),s}function PX(s,e){return Fr(ho,e.camera.projectionMatrix),ho[10]=24e-8-1,ho[11]=-1,ho[14]=(24e-8-2)*e.camera.near,as(ho,ho,e.camera.viewMatrix),as(ho,ho,s.modelMatrix)}const ho=Ie(),MX=Object.freeze(Object.defineProperty({__proto__:null,build:f3},Symbol.toStringTag,{value:"Module"}));let $X=class extends Xt{constructor(){super(...arguments),this.modelMatrix=Ie()}},BP=class extends ct{constructor(e,t){super(e,t,new ht(MX,()=>k(()=>Promise.resolve().then(()=>wee),void 0)),aw.locations)}initializePipeline(){return qe({blending:za,depthTest:{func:515},colorWrite:nt})}};const aw=Xa().vec3f("position").vec4u8("color").f32("size").freeze();let ow=class extends Kn{constructor(){super(...arguments),this._numPoints=0,this._passParameters=new $X}initialize(){this.addHandles([$(()=>this.view.environment.starsEnabled,e=>e?this._enable():this._disable(),Re),$(()=>this.view.environment.lighting.type==="virtual"?null:this.view.environment.lighting.date,e=>this._update(e),Ve)])}_enable(){super._enable(),this._loadDataTask=this._createLoadDataTask()}get loading(){return!!this._loadDataTask&&!this._loadDataTask.finished}destroy(){this._loadDataTask=Os(this._loadDataTask),this._numPoints=0,this._vao=_e(this._vao),this._starData=null}precompile(){this.techniques.precompile(BP)}render(e){const t=e.find(({name:n})=>n===ne.OPAQUE_ENVIRONMENT),i=this.renderingContext;if(this.loading)return this.requestRender(1),t;if(!this._starData)return t;this._vao??=this._ensureResources(this._starData,i);const r=this.techniques.get(BP);return r.compiled?(i.bindTechnique(r,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(Ct.POINTS,0,this._numPoints),t):(this.requestRender(1),t)}_ensureResources(e,t){return this._numPoints=e.byteLength/g3,RX(t,new Float32Array(e,0,2*this._numPoints),new Uint8Array(e,2*this._numPoints*4,this._numPoints),this._numPoints)}_update(e){if(!e)return;const t=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,i=2*OX(e),r=Fr(this._passParameters.modelMatrix,FX);A0(r,r,-i*Math.PI),as(r,LX,r),A0(r,r,-t*Math.PI),this.requestRender(1)}_createLoadDataTask(){if(this._starData)return null;const e=Za(async t=>{const{data:i}=await cF("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:t});DX(i),this._starData=i});return e.promise.catch(t=>{zr(t)||j.getLogger(this).error(t)}).then(()=>{this.destroyed||this.requestRender(1)}),e}};function RX(s,e,t,i){const r=aw.createBuffer(i),n=r.position,a=r.color,o=r.size;for(let l=0;l<i;l++){const c=e[2*l],h=e[2*l+1];n.set(l,0,-Math.cos(c)*Math.sin(h)),n.set(l,1,-Math.sin(c)*Math.sin(h)),n.set(l,2,-Math.cos(h));const d=AX(t[l]),m=EX(IX[d[1]]);a.set(l,0,255*m[0]),a.set(l,1,255*m[1]),a.set(l,2,255*m[2]),a.set(l,3,255),o.set(l,d[0])}return new Mn(s,new Kt(s,Vr(aw),r.buffer))}function OX(s){const e=s,t=new Date(s.getFullYear(),0,1,11,58,56);return(+e-+t)/(+new Date(s.getFullYear()+1,0,1,11,58,55)-+t)}function DX(s){if(!s)throw new me("stars:no-data-received","Failed to create stars because star catalogue is missing");const e=s.byteLength/g3;if(e%1!=0||e>5e4||e<5e3)throw new me("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}function EX(s){return[parseInt(s.slice(0,2),16),parseInt(s.slice(2,4),16),parseInt(s.slice(4,6),16)]}function AX(s){return s>=192?[2.9,s-192]:s>=160?[2.5,s-160]:s>=128?[2,s-128]:s>=96?[1.5,s-96]:s>=64?[1,s-64]:s>=32?[.7,s-32]:[.4,s]}ow=u([R("esri.views.3d.webgl-engine.effects.stars.Stars")],ow);const IX=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],LX=eR(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),FX=eR(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),g3=9;let _x=class extends Xt{};function _3(){const s=new lt;return s.include(qi),s.fragment.uniforms.add(new Be("tex",e=>e.texture)),s.fragment.main.add(y`fragColor = vec4(1.0 - texture(tex, uv).a);`),s}const VX=Object.freeze(Object.defineProperty({__proto__:null,HUDCompositingPassParameters:_x,build:_3},Symbol.toStringTag,{value:"Module"}));let NP=class extends ct{constructor(e,t){super(e,t,new ht(VX,()=>k(()=>Promise.resolve().then(()=>xee),void 0)),ri)}initializePipeline(){return qe({colorWrite:{r:!1,g:!0,b:!1,a:!1}})}},kX=class{constructor(e,t){this._rctx=e,this._techniques=t,this._configuration=new np,this._passParameters=new Y_,this._hudParameters=new _x,this._configuration.blitMode=2,this._techniques.precompile(Qn,this._configuration),this._configuration.blitEmissiveMode=1,this._techniques.precompile(Qn,this._configuration),this._configuration.blitMode=1,this._techniques.precompile(Qn,this._configuration),this._configuration.blitEmissiveMode=0,this._techniques.precompile(Qn,this._configuration),this._configuration.blitMode=3,this._techniques.precompile(Qn,this._configuration),this._techniques.precompile(NP)}compositeHUD(e,t){this._hudParameters.texture=t;const i=this._techniques.get(NP);this._rctx.bindTechnique(i,e,this._hudParameters),this._rctx.screen.draw()}compositePreMultipliedAlpha(e,t,i){this._composite(e,t,2,i)}composite(e,t,i){this._composite(e,t,1,i)}blitDepthToLinearDepth(e,t){this._composite(e,t,3)}_composite(e,t,i,r=0){this._configuration.blitMode=i,this._configuration.blitEmissiveMode=r,this._passParameters.texture=t;const n=this._techniques.get(Qn,this._configuration);this._rctx.bindTechnique(n,e,this._passParameters),this._rctx.screen.draw()}},zX=class{constructor(){this.declaredClass="esri.views.3d.webgl-engine.lib.ObjectAndLayerIdRenderHelper",this.colorZero=new Bg(new ArrayBuffer(4)),this._layerToOidToColor=new qa,this._colorToUID=new Map,this._layerViewUidToGraphicsUidToObjectId=new qa,this._layerViewUidToLayerId=new Map,this._layerViewUidToPopupEnabled=new Map}setUidToObjectAndLayerId(e,t,i,r,n,a=null,o=null,l=null){e&&t&&i&&r&&(this._layerViewUidToLayerId.set(r,i),this._layerViewUidToPopupEnabled.set(r,n),n&&this._layerViewUidToGraphicsUidToObjectId.set(r,t,{objectId:e,attributeNodeId:a,attributeIndex:o,subLayerId:l}))}getObjectAndLayerIdColor(e){const t=this.getObjectAndLayerIdColorArray(e);return Si(t.get(0,1),t.get(0,2),t.get(0,3),255)}getObjectAndLayerIdColorArray(e){if(!e.layerViewUid||!e.graphicUid)return this.colorZero;const t=this._layerViewUidToPopupEnabled.get(e.layerViewUid);if(t===void 0)return this.colorZero;if(t===!1)return this.colorZero;const i=this._layerViewUidToGraphicsUidToObjectId.get(e.layerViewUid,e.graphicUid)?.objectId;if(!i)return this.colorZero;let r=this._layerToOidToColor.get(e.layerViewUid,i);if(!r){if(Ze("enable-feature:objectAndLayerId-screenshot-testing"))r=i;else for(;!r;){const a=Math.floor(16777214*Math.random())+1;this._colorToUID.has(a)||(r=a)}if(r>16777215)throw new Error("Object ID Overflow");this._layerToOidToColor.set(e.layerViewUid,i,r),this._colorToUID.set(r,e)}const n=new ArrayBuffer(4);return new DataView(n).setUint32(0,r,!1),new Bg(n)}getColorToObjectAndLayerIdMapping(){const e=new Map;for(const[t,i]of this._colorToUID.entries()){const r=this._layerViewUidToGraphicsUidToObjectId.get(i.layerViewUid,i.graphicUid),n=this._layerViewUidToLayerId.get(i.layerViewUid);r&&n&&e.set(t,r.attributeNodeId?{type:"object-and-layer-and-i3s-id",olid:r.objectId,lid:n,attrId:r.attributeNodeId,attrIdx:r.attributeIndex,subLayerId:r.subLayerId}:{type:"object-and-layer-id",olid:r.objectId,lid:n})}return e}},y3=class{constructor(e,t){this.key=e,this._free=t,this.incarnation=0,this._refCount=1}retain(e=1){this._refCount+=e}release(){return this._refCount===0?(console.log(`Releasing already released FBO attachment "${this.name}" in ${new Error().stack}`),!0):(--this._refCount,this._refCount===0&&(this._free(),!0))}get test(){}},v3=class extends y3{constructor(e,t,i){super(e,i),this.attachment=t,this.name=""}dispose(){this.attachment.dispose()}get usedMemory(){return this.attachment.usedMemory}},BX=class extends v3{constructor(e,t,i){super(e,t,i),this.attachment=t,this.type=2}},NX=class extends v3{constructor(){super(...arguments),this.type=1}},UX=class extends NX{constructor(e,t,i){super(e,t,i),this.attachment=t}};function HX(s){return s?.attachment.type===1}let b3=class extends y3{constructor(e,t,i,r,n,a){super(e,a),this.fbo=i,this.type=0,this._colors=new Map,this._name=It.COMPOSITE,this.acquireColor=null,this.acquireDepth=null,this._name=t,this.acquireColor=r,this.acquireDepth=n}dispose(){this.fbo?.dispose()}get usedMemory(){return this.fbo?.usedMemory||0}get numberOfColorAttachments(){return this._colors.size}get name(){return this._name}setName(e){this._name=e}getTexture(e=Ot){return e===Ui?this.fbo?.depthStencilTexture:this.fbo?.getColorTexture(e)}get depthTexture(){return this.getTexture(Ui)}getAttachment(e=Ot){return e===Ui?this._depth:this._colors.get(e)}hasAttachment(e){return pn(this._colors,t=>t.name===e)}attachDepth(e){return e?.retain(),this.detachDepth(),e&&this.fbo?.attachDepthStencil(e.attachment),this._depth=e,this}detachDepth(){this.fbo?.detachDepthStencilTexture(),this.fbo?.detachDepthStencilBuffer(),this._depth=Nt(this._depth)}obtainDepthTexture(){const e=this._depth;return HX(e)?(this.fbo?.detachDepthStencilTexture(),this._depth=null,e):null}attachColor(e,t){return e.retain(),this.detachColor(t),this.fbo?.attachColorTexture(e.attachment,t),this._colors.set(t,e),this}detachColor(e){this.fbo?.detachColorTexture(e);const t=this._colors.get(e);this._colors.delete(e),t?.release()}detachAllColors(){this._colors.forEach((e,t)=>this.detachColor(t))}detachAll(){this.detachAllColors(),this.detachDepth()}detachAllColorsBut0(){this._colors.forEach((e,t)=>{t!==Ot&&this.detachColor(t)})}detachAllButColor0(){this.detachAllColorsBut0(),this.detachDepth()}};function qX(s){switch(s){case 0:return"R8UNORM";case 1:return"R8UINT";case 2:return"RG8UNORM";case 3:return"RG8UINT";case 4:return"RGBA4UNORM";case 5:return"RGBA8UNORM";case 6:return"RGBA8UNORM_MIPMAP";case 7:return"R16FLOAT";case 8:return"RGBA16FLOAT";case 9:return"R32FLOAT";case 10:return"RG32FLOAT";case 11:return"RGBA32UINT";case 12:return"COUNT"}}function GX(s){switch(s){case 12:return"DEPTH16";case 13:return"DEPTH24_STENCIL8"}}function e0(s){return lw(s)?GX(s):qX(s)}function lw(s){return s>=12}const vg=new ft;vg.pixelFormat=6403,vg.internalFormat=Es.R8,vg.wrapMode=33071;const Ed=new ft;Ed.pixelFormat=36244,Ed.internalFormat=Es.R8UI,Ed.wrapMode=33071,Ed.samplingMode=9728;const bg=new ft;bg.pixelFormat=33319,bg.internalFormat=Es.RG8,bg.wrapMode=33071;const Ad=new ft;Ad.pixelFormat=33320,Ad.internalFormat=Es.RG8UI,Ad.wrapMode=33071,Ad.samplingMode=9728;const wg=new ft;wg.internalFormat=Es.RGBA4,wg.dataType=si.UNSIGNED_SHORT_4_4_4_4,wg.wrapMode=33071;const w3=new ft;w3.wrapMode=33071;const Id=new ft;Id.wrapMode=33071,Id.samplingMode=9987,Id.hasMipmap=!0,Id.maxAnisotropy=8;const Ld=new ft;Ld.pixelFormat=6403,Ld.dataType=si.HALF_FLOAT,Ld.internalFormat=Es.R16F,Ld.samplingMode=9728;const xg=new ft;xg.dataType=si.HALF_FLOAT,xg.internalFormat=Es.RGBA16F,xg.wrapMode=33071;const Fd=new ft;Fd.pixelFormat=6403,Fd.dataType=si.FLOAT,Fd.internalFormat=Es.R32F,Fd.samplingMode=9728;const Vd=new ft;Vd.pixelFormat=33319,Vd.dataType=si.FLOAT,Vd.internalFormat=Es.RG32F,Vd.samplingMode=9728;const gh=new ft;gh.pixelFormat=36249,gh.dataType=si.UNSIGNED_INT,gh.internalFormat=Es.RGBA32UI,gh.samplingMode=9728,gh.wrapMode=33071;const jX={0:vg,1:Ed,2:bg,3:Ad,4:wg,5:w3,6:Id,7:Ld,8:xg,9:Fd,10:Vd,11:gh,12:null},WX={[Gl.DEPTH_COMPONENT16]:si.UNSIGNED_SHORT,[Gl.DEPTH_COMPONENT24]:si.UNSIGNED_INT,[Gl.DEPTH_COMPONENT32F]:si.FLOAT,[tu.DEPTH24_STENCIL8]:si.UNSIGNED_INT_24_8,[tu.DEPTH32F_STENCIL8]:si.FLOAT_32_UNSIGNED_INT_24_8_REV},QX={13:UP(tu.DEPTH24_STENCIL8),12:UP(Gl.DEPTH_COMPONENT16)};function UP(s){const e=new ft;return e.pixelFormat=HL(s)?6402:34041,e.dataType=WX[s],e.samplingMode=9728,e.wrapMode=33071,e.internalFormat=s,e.hasMipmap=!1,e.isImmutable=!0,e}let t0=class{constructor(e,t){this._last=new zt,this._incarnation=0,this._cache=new Xp(e,t)}destroy(){this._last?.forAll(e=>e.dispose()),this._last?.prune(),this._last=null,this._cache.destroy()}set interactive(e){e&&!this._last?this._last=new zt:e||(this._last?.forAll(t=>t.dispose()),this._last=null)}clean(){this._last?.filterInPlace(e=>!(e.incarnation<this._incarnation)||(this._cache.put(e.key,e),!1))}frame(){++this._incarnation}pop(e){if(this._last){const t=this._last.find(i=>i.key===e);if(t)return this._last.removeUnordered(t),t}return this._cache.pop(e)}put(e){e.incarnation=this._incarnation,this._last?this._last.push(e):this._cache.put(e.key,e)}get usedMemory(){return this._last?.reduce((e,t)=>e+t.usedMemory,0)??0}},ZX=class{constructor(e){this.rctx=e,this._interactive=!1,this._usage=new Map,this._acquired=new Set,this._cache=new t0(e.newCache,"FBOCache"),this._depthCache=new t0(e.newCache,"DepthAttachmentCache"),this._colorCache=new t0(e.newCache,"ColorAttachmentCache")}destroy(){this._cache.destroy(),this._depthCache.destroy(),this._colorCache.destroy()}clean(){this._cache.clean(),this._colorCache.clean(),this._depthCache.clean()}frameStart(){this._cache.frame(),this._colorCache.frame(),this._depthCache.frame(),this.debugCallback?.(),this._usage.clear()}frameEnd(){const{debugCallback:e}=this;e&&this._acquired.forEach(t=>e(t.name,t.fbo,this._usage))}get usedMemory(){return Array.from(this._acquired.values()).reduce((e,t)=>e+t.usedMemory,this._cache.usedMemory+this._colorCache.usedMemory+this._depthCache.usedMemory)}set interactive(e){this._cache.interactive=this._colorCache.interactive=this._depthCache.interactive=e,this._interactive=e}get interactive(){return this._interactive}acquire(e,t,i,r=5){const n=i0(r,e,t);let a=this._cache.pop(n);const{rctx:o}=this;if(a){a.retain(),a.setName(i);const l=a.getAttachment(Ui);l&&(l.name=qP(i));const c=a.getAttachment(Ot);c&&(c.name=HP(i,0));const h=a.fbo;h?o.temporaryBindFramebufferObject(h,()=>{o.setDrawBuffers([Ot]),o.unbindTexture(h.colorTexture)}):j.getLogger("esri.views.3d.webgl-engine.core.FBOCache").errorOnce("Encountered an invalid cached framebuffer")}else{const l=new jo(o),c=(m,f,g)=>{f??=5;const _=this._acquireColor(f,e,t,g??HP(a.name,m-Ot));return this.rctx.unbindTexture(_.attachment),a.attachColor(_,m),_.release(),a},h=m=>{m??=13;const f=this.acquireDepth(m,e,t,qP(a.name));return a.attachDepth(f),f.release(),a},d=()=>{if(!a)return;this.debugCallback?.(a.name,a.fbo),this._acquired.delete(a);const m=lw(r);m&&a.getAttachment(Ui)!=null||!m&&a.getAttachment(Ot)!=null?(m?(a.fbo?.invalidateAttachments([Ui]),a.detachAllColors()):(a.fbo?.invalidateAttachments([Ot]),a.detachAllButColor0()),this._cache.put(a)):a.dispose()};a=new b3(n,i,l,c,h,d),lw(r)?a.acquireDepth(r):a.acquireColor(Ot,r,i)}return this._trackUsage(a,"fbo "+e0(r),e,t),this._trackHandle(a)}acquireDepth(e,t,i,r){const n=i0(e,t,i);let a=this._depthCache.pop(n);if(a)a.retain(),a.attachment.setShadowFiltering(!1);else{const o=new bt(this.rctx,{...QX[e],width:t,height:i});a=new UX(n,o,()=>this._depthCache.put(a))}return a.name=r,this._trackUsage(a,"depth "+e0(e),t,i),a}_acquireColor(e,t,i,r){const n=i0(e,t,i);let a=this._colorCache.pop(n);if(a)a.retain();else{const o=new bt(this.rctx,{...jX[e],width:t,height:i});a=new BX(n,o,()=>this._colorCache.put(a))}return a.name=r,this._trackUsage(a,"color "+e0(e),t,i),a}_trackHandle(e){return this._acquired.add(e),e}_trackUsage(e,t,i,r){this.debugCallback&&(this._usage.has(e)?this._usage.get(e)[2].push(e.name):this._usage.set(e,[t,`${i}x${r}`,[e.name]]))}};function HP(s,e=0){return`${s}.color${e}`}function qP(s){return`${s}.depth`}const cu=new b3("default","default",null,()=>cu,()=>cu,()=>{});function i0(s,e,t){return`${e}x${t}:${s}`}cu.release=()=>!1;let Jr=class{constructor(e,t,i=0){this._rctx=e,this._techniques=t,this._sorting=i,this._draws=new zt({allocator:r=>r??{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._previouslyBoundDraw=new Map}submitDraw(e,t,i,r,n){const a=this._draws.pushNew();a.geometry=t,a.geometryRanges=i,a.material=e,a.depthSquaredHint=r,a.indexType=(t.indexed?t.vao.indexBuffer.indexType:null)??0,a.highlightName=n}acquire(e,t){return this._draws.map(i=>i.material.acquireTechnique(this._techniques,e,t,i.geometry.parameters))}dispatch(e,t,i){const r=this._rctx;this._previouslyBoundDraw.clear();let n=null;const a=this._draws.length,o=t.highlight?.name;for(let l=0;l<a;l++){const c=this._draws.data[l];if(e.identifier===2){const b=c.highlightName;if(b){if(b!==o)continue}else if(!o||!t.overlay?.hasHighlight(o))continue}const h=i[l];h===n&&t.oitPass===0||(r.bindTechnique(h,t,e),n=h);const{geometryRanges:d,indexType:m,geometry:f,material:g}=c;r.bindVAO(f.vao),this._previouslyBoundDraw.get(h)!==g&&(h.program.bindDraw(t,e,g),this._previouslyBoundDraw.set(h,g));const _=d.length,{primitiveType:v}=f;for(let b=0;b<_;b+=2){const T=d[b],w=d[b+1];if(m!==0){const S=Cg.get(m);r.drawElements(v,w,m,T*S)}else r.drawArrays(v,T,w)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){const e=this._sorting===0?1:-1;this._draws.sort((t,i)=>e*(t.depthSquaredHint-i.depthSquaredHint)||t.geometry.vao.usedMemory-i.geometry.vao.usedMemory)}get count(){return this._draws.length}};const Cg=new Map;Cg.set(Cn.UNSIGNED_BYTE,1),Cg.set(Cn.UNSIGNED_SHORT,2),Cg.set(Cn.UNSIGNED_INT,4);let XX=class{constructor(e){const t=e.renderContext.rctx,i=e.techniques;this.opaque=new Jr(t,i),this.transparent=new Jr(t,i,1),this.integratedMesh=new Jr(t,i),this.transparentIntegratedMesh=new Jr(t,i),this.occludedGround=new Jr(t,i),this.shadowMap=new Jr(t,i),this.highlight=new Jr(t,i),this.highlightIntegratedMesh=new Jr(t,i),this.highlightShadowMap=new Jr(t,i),this.viewshedShadowMap=new Jr(t,i),this.defaultShadowMap=new Jr(t,i)}},ey=class extends qL{constructor(){super(...arguments),this.slicePlaneLocalOrigin=x(),this.origin=this.slicePlaneLocalOrigin}},YX=class extends ey{constructor(){super(...arguments),this.identifier=0,this.output=0,this.transparent=!1,this.occludedGround=!1}},KX=class extends ey{constructor(){super(...arguments),this.identifier=1}},JX=class extends ey{constructor(){super(...arguments),this.identifier=2}},eY=class extends ey{constructor(){super(...arguments),this.identifier=3}},cw=class extends Wp{constructor(){super(...arguments),this.produces=new Map([[2,e=>this._produces(e,2)],[4,e=>this._produces(e,4)],[0,e=>this._produces(e,0)],[7,e=>this._produces(e,7)],[9,e=>this._produces(e,9)]]),this._materialPassParameters=new YX,this._shadowPassParameters=new KX,this._highlightPassParameters=new JX,this._viewshedPassParameters=new eY,this._systems=new Set}initializeRenderContext(e){this._context=e,this._passes=new XX(e)}get rctx(){return this._context.renderContext.rctx}uninitializeRenderContext(){}dispose(){this._context=null,this._systems.clear(),this._passes=null}register(e){this._systems.add(e)}_produces(e,t){return!!this._invoke(e,t,i=>i.count>0)}prepareRender(e){const{_systems:t,_passes:i}=this;if(t.size!==0&&i!=null){for(const r of Object.values(i))r.prepareSubmit();t.forEach(r=>r.submit(i,e.bind));for(const r of Object.values(i))r.finishSubmit()}}acquireTechniques(e){if(this._systems.size===0)return null;const t=e.output===4||e.output===5||e.output===6?this._shadowPassParameters:e.output===7?this._viewshedPassParameters:e.output===9?this._highlightPassParameters:this._materialPassParameters,i=e.bind;return this._updateParameters(i.camera,t,i.slot),this._materialPassParameters.output=e.output,this._invoke(e.output,e.bind.slot,(r,n)=>r.acquire(n,e.bind))}render(e,t){this._invoke(e.output,e.bind.slot,(i,r)=>i.dispatch(r,e.bind,t))}_invoke(e,t,i){if(this._passes==null)return null;switch(t){case 2:switch(e){case 0:case 1:case 2:case 3:case 10:return i(this._passes.opaque,this._materialPassParameters);case 9:return i(this._passes.highlight,this._highlightPassParameters);case 4:return i(this._passes.shadowMap,this._shadowPassParameters);case 5:return i(this._passes.highlightShadowMap,this._shadowPassParameters);case 6:return i(this._passes.defaultShadowMap,this._shadowPassParameters);case 7:return i(this._passes.viewshedShadowMap,this._viewshedPassParameters)}break;case 4:switch(e){case 0:case 1:case 2:case 3:case 10:return i(this._passes.transparent,this._materialPassParameters)}break;case 0:switch(e){case 0:case 1:case 2:case 3:case 10:case 8:return i(this._passes.integratedMesh,this._materialPassParameters);case 9:return i(this._passes.highlightIntegratedMesh,this._highlightPassParameters)}break;case 7:switch(e){case 0:case 1:return i(this._passes.transparentIntegratedMesh,this._materialPassParameters)}break;case 9:switch(e){case 0:case 1:case 2:case 3:case 10:return i(this._passes.occludedGround,this._materialPassParameters)}}return null}notifyDirty(){this._context.requestRender()}queryDepthRange(e){const t=new ss;return this._systems.forEach(i=>t.union(i.queryDepthRange(e))),t}get hasEmitters(){let e=!1;return this._systems.forEach(t=>e=t.hasEmissions||e),e}_updateParameters(e,t,i){const r=e.viewInverseTransposeMatrix,n=i===4,a=i===9;be(s0,r[3],r[7],r[11]),r0.set(s0),q(t.transformWorldFromViewTH,r0.high),q(t.transformWorldFromViewTL,r0.low),q(t.slicePlaneLocalOrigin,s0),Bw(t.transformViewFromCameraRelativeRS,e.viewMatrix),Fr(t.transformProjFromView,e.projectionMatrix),t.identifier===0&&(this._materialPassParameters.transparent=n,this._materialPassParameters.occludedGround=a,qp(GP,t.transformViewFromCameraRelativeRS),qw(t.transformNormalViewFromGlobal,GP))}hasHighlight(e){for(const t of this._systems)if(t.hasHighlight(e))return!0;return!1}};cw=u([R("esri.views.3d.webgl-engine.core.renderPasses.RenderPassManager")],cw);const s0=x(),GP=Pn(),r0=new ZA;function tY(s){return s.name}let iY=class{constructor(e){this._context=e,this._nodes=new zt}destroy(){this._nodes.forEach(e=>e.destroy()),this._nodes.prune()}add(e){this._nodes.push(e)}remove(e){this._nodes.remove(e)}produces(e){return this._nodes.some(({produces:t})=>t===e)}require(e,...t){const i=this._nodes,r=n=>i.reduce((a,{consumes:o,produces:l})=>a+(!o.required.includes(e)||n!=null&&l!==n?0:1),0);return t.length===0?r():t.reduce((n,a)=>n+r(a),0)}optional(e,...t){const i=this._nodes,r=n=>i.reduce((a,{consumes:o,produces:l})=>a+(!o.optional?.includes(e)||n!=null&&l!==n?0:1),0);return t.length===0?r():t.reduce((n,a)=>n+r(a),0)}updateAnimation(e){return this._nodes.reduce((t,i)=>i.updateAnimation(e)||t,!1)}precompile(...e){++this._context.techniques.precompiling;for(const t of e)this._nodes.forEach(i=>{i.produces===t&&i.precompile()});--this._context.techniques.precompiling}render(e,t,i=()=>{}){return this._render(e,t,i)??(tY(e)?e:cu)}produce(e,t,i=()=>{}){return this._render(e,t,i)}_render(e,t,i=()=>{}){const r=typeof e=="string"?e:e.name,n=this._nodes.filter(({produces:o})=>o===r);if(n.length===0)return;let a=typeof e=="string"?null:e;return n.some(o=>{const l=a?[a]:[],c=a==null;for(const h of o.consumes.required){if(h===r){if(c)return!1;continue}const d=t.get(h);if(d)l.push(d);else if(h!=="emissive"||!t.get(r)?.hasAttachment(h))return i?.(l),!1}if(o.consumes.optional)for(const h of o.consumes.optional){if(h===r)continue;const d=t.get(h);d&&l.push(d)}try{const h=o.doRender(l);h&&h!==a&&(r!==h.name&&(j.getLogger(o).errorOnce(`RenderNode produced ${h.name}, expected ${r}`),h.setName(r)),a?.release(),a=h,t.set(r,a))}catch(h){j.getLogger(o).errorOnce(h)}return i?.(l),c&&a!=null}),this._context.rctx.enforceState(),a}requireGeometryDepth(){return this._nodes.some(e=>e.produces!=="disabled"&&e.requireGeometryDepth)}get test(){return{nodes:this._nodes}}},sY=class{constructor(e){this.context=e,this._renderPlugins=new Array,this._slots=new Array,this._version=rs(0);for(let t=0;t<21;++t)this._slots[t]=[]}destroy(){this._renderPlugins.forEach(e=>e.destroy()),this._renderPlugins.length=0}get plugins(){return this._renderPlugins}add(e,t){const i=()=>{if(t?.aborted)throw e.uninitializeRenderContext(),Bi();this._renderPlugins.push(e),e.produces.forEach((n,a)=>this._slots[a].push(e)),this.context.requestRender(),this._version.value++},r=e.initializeRenderContext(this.context,t);if(Lp(r))return r.then(i);i()}remove(e){Lr(this._renderPlugins,e),e.uninitializeRenderContext();for(let t=0;t<this._slots.length;++t)this._slots[t]=this._slots[t].filter(i=>i!==e);this.context.requestRender(),this._version.value++}prepareRender(){this._renderPlugins.forEach(e=>{e.prepareRender&&e.prepareRender(this.context.renderContext)})}updateAnimation(e){let t=!1;return this._renderPlugins.forEach(i=>t=i.updateAnimation?.(e)||t),t}precompile(...e){++this.context.techniques.precompiling;const t=this.context.renderContext.bind.slot;for(const i of e)this.context.renderContext.bind.slot=i,this._forEachRender(()=>{});this.context.renderContext.bind.slot=t,--this.context.techniques.precompiling}render(...e){for(const t of e)this.context.renderContext.bind.slot=t,this._forEachRender((i,r)=>i.render(this.context.renderContext,r))}_forEachRender(e){const t=this.context.renderContext.bind.slot,i=this.context.renderContext.output;this._slots[t].forEach(r=>{if(!r.produces.get(t)?.(i)||r.isDecoration&&!this.context.renderContext.bind.decorations)return;const a=r.acquireTechniques(this.context.renderContext);a&&e(r,a)})}queryDepthRange(e){const t=new ss;return this._renderPlugins.forEach(i=>{const r=i.queryDepthRange?.(e);t.union(r)}),t}get updating(){return this._version.value>=0&&this._renderPlugins.some(e=>e.readyToRun)}produces(e,...t){return t.some(i=>this._slots[i].some(r=>{const n=r.produces.get(i);return!!n&&n(e)}))}consumes(e){return this._renderPlugins.some(t=>t.consumes().required.includes(e))}hasHighlight(e){return rY.some(t=>this._slots[t].some(i=>i.hasHighlight(e)))}get hasDecorations(){return this._renderPlugins.some(e=>e.isDecoration)}get hasOccludees(){return this._renderPlugins.some(e=>e.hasOccludees)}get hasEmitters(){return this._renderPlugins.some(e=>e.hasEmitters)}get renderOccludedFlags(){return this._renderPlugins.reduce((e,t)=>e|(t.renderOccludedFlags??0),0)}get usedMemory(){return this._renderPlugins.reduce((e,t)=>t.material?e:e+(t.usedMemory??0),0)}get test(){}};const rY=[2,4,18,13,14];let yx=class extends Xt{};function x3(s){const e=new lt;e.include(qi);const{hasEmitters:t,dimEmissive:i}=s,r=e.fragment;return r.uniforms.add(new Be("colorTexture",n=>n.colorTexture),new Be("alphaTexture",n=>n.alphaTexture)),e.outputs.add("fragColor","vec4",0),t&&e.outputs.add("fragEmission","vec4",1),i?(r.main.add(y`float srcAlpha = texture(alphaTexture, uv).r;
vec4 srcColor = texture(colorTexture, uv);
srcColor.rgb = clamp(srcColor.rgb, vec3(0.0), srcColor.rgb);
vec3 dimming = srcAlpha > 1.0 ? mix(vec3(1.0), srcColor.rgb, 1.0 / srcAlpha) : mix(vec3(1.0), srcColor.rgb, srcAlpha);
fragEmission = vec4(dimming, 0.0);`),e):(r.uniforms.add(new Be("frontFaceTexture",n=>n.frontFaceTexture)),t&&(r.uniforms.add(new Be("emissionTexture",n=>n.emissionTexture)),r.uniforms.add(new Be("emissionFrontFaceTexture",n=>n.emissionFrontFaceTexture))),r.main.add(y`
      float srcAlpha = texture(alphaTexture, uv).r;
      if(srcAlpha == 0.0){
        fragColor = vec4(0.0);
        ${X(t,"fragEmission = vec4(0.0);")}
        return;
      }

      vec4 srcColor = texture(colorTexture, uv);
      vec4 frontFace = texture(frontFaceTexture, uv);
      fragColor = vec4(mix(srcColor.rgb / srcAlpha, frontFace.rgb, frontFace.a), 1.0 - srcColor.a);

      ${X(t,`vec4 emission = texture(emissionTexture, uv);
         vec4 emissionFrontFace = texture(emissionFrontFaceTexture, uv);

         // Modulate transparent emitter by front faces. This case is important for surfaces which contain emitter and 
         // non-emitter at the same time. Non-emitter surface parts need to modulate emissions as well.
         emission.rgb = emission.rgb * (1.0 - frontFace.a);

         fragEmission = vec4(mix(emission.rgb / srcAlpha, emissionFrontFace.rgb, emissionFrontFace.a), 1.0 - srcColor.a);`)}
    `),e)}const nY=Object.freeze(Object.defineProperty({__proto__:null,OITBlendPassParameters:yx,build:x3},Symbol.toStringTag,{value:"Module"}));let Yu=class extends ct{constructor(e,t){super(e,t,new ht(nY,()=>k(()=>Promise.resolve().then(()=>Cee),void 0)),ri)}initializePipeline(e){return qe({blending:e.dimEmissive?GL:za,colorWrite:nt,drawBuffers:e.dimEmissive?{buffers:[I0,Ws]}:e.hasEmitters?{buffers:[Ot,Ws]}:{buffers:[Ot]}})}},hw=class extends ls{constructor(){super(...arguments),this.hasEmitters=!1,this.dimEmissive=!1}};u([V()],hw.prototype,"hasEmitters",void 0),u([V()],hw.prototype,"dimEmissive",void 0);let aY=class{constructor(e){this._techniques=e,this._parameters=new yx,this._configuration=new hw,e.precompile(Yu,this._configuration),this._configuration.hasEmitters=!0,e.precompile(Yu,this._configuration),this._configuration.dimEmissive=!0,e.precompile(Yu,this._configuration),this._configuration.dimEmissive=!1,this._configuration.hasEmitters=!1}blend(e,t,i,r,n,a){if(this._parameters.colorTexture=t.getTexture(),this._parameters.alphaTexture=t.getTexture(n?iR:Ws),this._parameters.frontFaceTexture=i.getTexture(),this._configuration.hasEmitters=n,n&&a){this._configuration.dimEmissive=!0;const l=this._techniques.get(Yu,this._configuration);e.bindTechnique(l,r,this._parameters),e.screen.draw(),this._configuration.dimEmissive=!1}n&&(this._parameters.emissionTexture=t.getTexture(Ws),this._parameters.emissionFrontFaceTexture=i.getTexture(Ws));const o=this._techniques.get(Yu,this._configuration);e.bindTechnique(o,r,this._parameters),e.screen.draw()}},oY=class{constructor(e,t){this._camera=e,this._dt=$e(0),this._time=$e(0),this._lastUpdate=$e(0),this._lastUpdate=t,this._time=t}advance(e,t,i){const r=$e(t-this._lastUpdate);this._dt=$e(r/i),this._time=$e(this._time+r),this._lastUpdate=t,this._camera=e}get camera(){return this._camera}get dt(){return this._dt}get time(){return this._time}},lY=class{constructor(){this._step=QP,this._dilation=1,this._firstIdleTime=$e(0)}frame(e,t){if(t?this._firstIdleTime===0&&(this._firstIdleTime=$e(performance.now())):this._firstIdleTime=$e(0),Ze("disable-feature:high-quality-idle"))this._dilation=1;else{const r=t?performance.now()-this._firstIdleTime:0;if(r>=jP+hY)return this._step=$e(1/0),void(this._dilation=1);this._dilation=r>=jP?uY:1}const i=U(e/cY,QP,pY);this._step===1/0?this._step=$e(i):this._step=$e(this._step*WP+i*(1-WP))}get value(){return this._step}get timeDilation(){return this._dilation}clear(){this._step=this._firstIdleTime=$e(0)}};const cY=.5,jP=$e(12e4),hY=$e(1e4),uY=10,WP=.9,dY=30,QP=$e(1e3/1),pY=$e(1e3/dY),mY=1e4,uw=100,fY=500,gY=500,_Y=.1;function ZP(s,e,t,i){let r=0;if(!e.some(a=>!!a.material&&(r+=a.numGeometries,r>=mY)))return PY.compute(s,e,i);const n=new ss;return t.forEach(a=>n.union(yY(s,a))),n}function yY(s,e){if(!e.visible)return;const t=new ss,i=e.getSpatialQueryAccelerator();return i?vY(t,s,i):bY(t,s,e.objects),t}function vY(s,e,t){const{eye:i,viewForward:r,frustum:n}=e,a=l=>l.visible,o=t.objectCount;if(o<fY)Rr.set(e.near,Math.min(s.near,e.far)),t.forEachInDepthRange(i,r,1,Rr,(l,c)=>{dw(s,e,l),Rr.far=s.near,c.setRange(Rr)},n,a),Rr.set(Math.max(s.far,e.near),e.far),t.forEachInDepthRange(i,r,-1,Rr,(l,c)=>{dw(s,e,l),Rr.near=s.far,c.setRange(Rr)},n,a);else{const l=Math.max(Math.min(o,gY),Math.ceil(o*_Y)),c=t.findClosest(r,1,n,a,l),h=t.findClosest(r,-1,n,a,l);c&&h&&(XP(s,e,c.boundingVolumeWorldSpace.bounds),XP(s,e,h.boundingVolumeWorldSpace.bounds))}}function bY(s,e,t){Zc.clear(),t.forEach(i=>{i.visible&&i.geometries.length!==0&&Zc.add(i)}),Zc.empty||(Zc.sort(e),Rr.set(e.near,Math.min(s.near,e.far)),Zc.forEachInDepthRange(Rr,1,(i,r)=>{r<s.near&&dw(s,e,i)}),Rr.set(Math.max(s.far,e.near),e.far),Zc.forEachInDepthRange(Rr,-1,(i,r,n)=>{s.far=Math.max(s.far,n)}))}function dw(s,e,t){if(!t.visible||!Kw(e.frustum,t.boundingVolumeWorldSpace.bounds))return;const i=t.transformation,r=SY;t.geometries.forEach(n=>{as(r,i,n.transformation);const a=cp(r);C3(s,e,n.boundingInfo,r,a)})}function C3(s,e,t,i,r){if(t==null)return;gp(Oi,t.center,i);const{eye:n,viewForward:a}=e,o=a[0]*(Oi[0]-n[0])+a[1]*(Oi[1]-n[1])+a[2]*(Oi[2]-n[2]);if(Oi[3]=t.radius*r,!(o-Oi[3]>s.near&&o+Oi[3]<s.far)&&Kw(e.frustum,Oi))if(t.radius>uw&&t.getChildren())for(const l of t.getChildren())C3(s,e,l,i,r);else pw.unionDepthRangeWithAABB(s,e.viewProjectionMatrix,i,t.bbMin,t.bbMax)}function XP(s,e,t){const i=e.eye,r=e.viewForward,n=(t[0]-i[0])*r[0]+(t[1]-i[1])*r[1]+(t[2]-i[2])*r[2];s.near=Math.min(s.near,n-t[3]),s.far=Math.max(s.far,n+t[3])}let wY=class{constructor(){this._items=new zt({allocator:e=>e||{object:null,distance:0,near:0,far:0},deallocator:e=>(e.object=null,e.distance=0,e.near=0,e.far=0,e)})}get length(){return this._items.length}get empty(){return this._items.length===0}clear(){this._items.clear()}add(e){this._items.pushNew().object=e}sort(e){const t=e.eye,i=e.viewForward;this._items.forAll(r=>{const n=r.object.boundingVolumeWorldSpace.bounds,a=(n[0]-t[0])*i[0]+(n[1]-t[1])*i[1]+(n[2]-t[2])*i[2];r.distance=a,r.near=a-n[3],r.far=a+n[3]}),this._items.sort((r,n)=>r.distance-n.distance)}forEachInDepthRange(e,t,i){if(t===1)for(let r=0;r<this._items.length;++r){const n=this._items.data[r];n.far<e.near||n.near>e.far||i(n.object,n.near,n.far)}else for(let r=this._items.length-1;r>=0;--r){const n=this._items.data[r];n.far<e.near||n.near>e.far||i(n.object,n.near,n.far)}}};class xY{constructor(){this._geometries=new Array,this._near=[],this._far=[],this._nearCandidates=[],this._farCandidates=[],this._looseRange=new ss(0,0)}compute(e,t,i){this._reset();const{viewMatrix:r}=e;t.forEach(c=>{c.forEachGeometry(h=>{if(!h.visible||i===0&&!h.castShadow)return;const d=h.boundingSphere,m=r[2]*d[0]+r[6]*d[1]+r[10]*d[2]+r[14],f=m-d[3],g=m+d[3];this._geometries.push(h),this._near.push(-g),this._far.push(-f)})});const n=new ss;if(this._geometries.length===0)return n;for(let c=0;c<this._geometries.length;++c)this._near[c]>n.far&&(n.far=this._near[c]),this._near[c]>2&&this._far[c]<n.near&&(n.near=this._far[c]);const a=this._looseRange;a.near=Math.max(.5*n.near,2),a.far=2*n.far;let o=0,l=0;for(let c=0;c<this._geometries.length;++c)this._near[c]<n.near&&(this._near[c]>=a.near?n.near=this._near[c]:this._nearCandidates[o++]=c),this._far[c]>n.far&&(this._far[c]<=a.far?n.far=this._far[c]:this._farCandidates[l++]=c);if(this._nearCandidates.length===0&&this._farCandidates.length===0)return n;this._nearCandidates.sort((c,h)=>this._near[c]<this._near[h]?-1:this._near[c]>this._near[h]?1:0),this._farCandidates.sort((c,h)=>this._far[c]<this._far[h]?1:this._far[c]>this._far[h]?-1:0);for(let c=0;c<this._nearCandidates.length;++c){const h=this._nearCandidates[c];if(this._near[h]<n.near){const d=this._geometries[h],{boundingInfo:m,shaderTransformation:f}=d;this._includeNearBoundingInfoRec(e,m,f,n)}}for(let c=0;c<this._farCandidates.length;++c){const h=this._farCandidates[c];if(this._far[h]>n.far){const d=this._geometries[h],{boundingInfo:m,shaderTransformation:f}=d;this._includeFarBoundingInfoRec(e,m,f,n)}}return this._reset(),n}_reset(){this._geometries.length=0,this._near.length=0,this._far.length=0,this._nearCandidates.length=0,this._farCandidates.length=0}_isOutsideSidePlanes(e,t){const i=Hi(e),r=CV(e);return t[0][0]*i[0]+t[0][1]*i[1]+t[0][2]*i[2]+t[0][3]>r||t[1][0]*i[0]+t[1][1]*i[1]+t[1][2]*i[2]+t[1][3]>r||t[2][0]*i[0]+t[2][1]*i[1]+t[2][2]*i[2]+t[2][3]>r||t[3][0]*i[0]+t[3][1]*i[1]+t[3][2]*i[2]+t[3][3]>r}_includeNearBoundingInfoRec(e,t,i,r){if(t==null)return;const n=t.center;gp(Oi,n,i),Oi[3]=t.radius*cp(i);const{frustum:a}=e;if(this._isOutsideSidePlanes(Oi,a))return;const o=Oi[0],l=Oi[1],c=Oi[2],h=Oi[3],{viewMatrix:d}=e,m=d[2]*o+d[6]*l+d[10]*c+d[14],f=m+h;if(!(-(m-h)<2||-f>=r.near))if(-f>this._looseRange.near)r.near=-f;else{if(h>uw){const g=t.getChildren();if(g!==void 0){for(const _ of g)this._includeNearBoundingInfoRec(e,_,i,r);return}}pw.unionDepthRangeWithAABB(r,e.viewProjectionMatrix,i,t.bbMin,t.bbMax)}}_includeFarBoundingInfoRec(e,t,i,r){if(t==null)return;const n=t.center;gp(Oi,n,i),Oi[3]=t.radius*cp(i);const{frustum:a}=e;if(this._isOutsideSidePlanes(Oi,a))return;const[o,l,c,h]=Oi,{viewMatrix:d}=e,m=d[2]*o+d[6]*l+d[10]*c+d[14]-h;if(!(-m<=r.far))if(-m<this._looseRange.far)r.far=-m;else{if(h>uw){const f=t.getChildren();if(f!==void 0){for(const g of f)this._includeFarBoundingInfoRec(e,g,i,r);return}}pw.unionDepthRangeWithAABB(r,e.viewProjectionMatrix,i,t.bbMin,t.bbMax)}}}let CY=class{constructor(){this._modelViewProj=Ie(),this._clipPosition=[Lt(),Lt(),Lt(),Lt(),Lt(),Lt(),Lt(),Lt()]}unionDepthRangeWithAABB(e,t,i,r,n){const a=this._modelViewProj;as(a,t,i);let o=!1;for(let l=0;l<8;++l){const c=this._clipPosition[l],h=l===0||l===3||l===4||l===7?r[0]:n[0],d=l===0||l===1||l===4||l===5?r[1]:n[1],m=l<4?r[2]:n[2];c[0]=a[0]*h+a[4]*d+a[8]*m+a[12],c[1]=a[1]*h+a[5]*d+a[9]*m+a[13],c[2]=a[2]*h+a[6]*d+a[10]*m+a[14],c[3]=a[3]*h+a[7]*d+a[11]*m+a[15]}for(let l=0;l<12;++l){const c=TY(this._clipPosition[a0[l][0]],this._clipPosition[a0[l][1]],this._clipPosition[a0[l][2]]);let h=!0;for(let d=0;d<c.length;++d)if(c[d][3]>=2){h=!1;break}if(!h){o=!0;for(let d=0;d<c.length;++d){const m=c[d][3];Number.isFinite(m)&&(e.near=Math.min(m,e.near),e.far=Math.max(m,e.far))}}}return o}};function TY(s,e,t){let i=[s,e,t];for(let r=0;r<4;++r){const n=i;i=[];for(let a=0;a<n.length;++a){const o=n[a],l=n[(a+1)%n.length];n0(l,r)?(n0(o,r)||i.push(YP(o,l,r)),i.push(l)):n0(o,r)&&i.push(YP(o,l,r))}}return i}function n0(s,e){return e===0?s[0]>=-s[3]:e===1?s[1]>=-s[3]:e===2?s[0]<=s[3]:e===3?s[1]<=s[3]:void Wt(!1)}function YP(s,e,t){let i=0;return t===0?i=(-s[3]-s[0])/(e[0]-s[0]+e[3]-s[3]):t===1?i=(-s[3]-s[1])/(e[1]-s[1]+e[3]-s[3]):t===2?i=(s[3]-s[0])/(e[0]-s[0]-e[3]+s[3]):t===3&&(i=(s[3]-s[1])/(e[1]-s[1]-e[3]+s[3])),DV(Lt(),s,e,i)}const a0=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],Oi=Xs(),SY=Ie(),Rr=new ss,Zc=new wY,PY=new xY,pw=new CY,MY={idleOpacity:.8,navigatingOpacity:.4,maxDelta:.1,tiltFadeStart:20,tiltFadeEnd:30,altitudeStart:1e4,altitudeEnd:2e4};let $Y=class{constructor(e){this._fbos=e,this._requiresEmission=!1,this._size=new R8(0,0),this._clearColor=Lt()}dispose(){this._color=Nt(this._color),this.releaseDepth()}initialize(e,t,i,r){this._size.width=e,this._size.height=t,Vl(this._size,this._fbos.rctx.parameters.maxTextureSize);const n=this._color;return this._color=null,this.releaseDepth(),this._requiresEmission=r,jl(this._clearColor,i),n}releaseDepth(){this._color?.detachDepth(),this._depth=Nt(this._depth)}update(e){const t=this._ensureColor();t.attachDepth(this.depth),this._color=e(t)}bind(){const{rctx:e}=this._fbos,t=this._color==null;this.color.attachDepth(this.depth),e.bindFramebuffer(this.color.fbo),t&&(e.setClearStencil(0),e.setClearColor(this._clearColor[0],this._clearColor[1],this._clearColor[2],this._clearColor[3]),e.clear(17664),this._requiresEmission&&e.clearBuffer(1,J_))}_acquireColor(){return this._requiresEmission?this._fbos.acquire(this._size.width,this._size.height,"main color").acquireColor(Ws,8,"emissive"):this._fbos.acquire(this._size.width,this._size.height,"main color")}_acquireDepth(){return this._fbos.acquireDepth(13,this._size.width,this._size.height,"main depth")}get size(){return this._size}get color(){return this._ensureColor()}get depth(){return this._depth??=this._acquireDepth(),this._depth}_ensureColor(){return this._color??=this._acquireColor(),this._color}};function KP(s=!Ze("disable-feature:high-quality-idle"),e=null){const t=new qa;return s?(t.set(2,0,e!=="low"),t.set(2,3,e!=="low"),t.set(2,1,!0),t.set(2,4,!0),t.set(2,5,!0),t.set(2,8,!0)):(t.set(0,6,!0),t.set(0,7,!0),t.set(1,6,!0),t.set(1,7,!0)),t.set(2,6,!0),t.set(2,7,!0),t.set(2,2,!0),t}let RY=class{constructor(){this._inputs=new Map}set(e,t){this._inputs.set(e,t)}get(e){return this._inputs.get(e)}has(e){return this._inputs.has(e)}release(e){this._inputs.get(e)?.release()&&this._inputs.delete(e)}};function OY(s){s.code.add(`
  vec4 blendColorsPremultiplied(vec4 source, vec4 dest) {
    float oneMinusSourceAlpha = 1.0 - source.a;
    return source + dest * oneMinusSourceAlpha;
  }
  `)}function Ku(s,e){return s[0]=e[0]*e[3],s[1]=e[1]*e[3],s[2]=e[2]*e[3],s[3]=e[3],s}const Kp=255,DY=1/Kp;function T3(s){const e=new lt,{fragment:t}=e;e.include(qi),e.include(c3),e.include(f$),t.uniforms.add(new T0("shadowMap",r=>r.shadowMap.depthTexture),new mr("depthMap",r=>r.depth?.attachment)),t.constants.add("sampleValue","float",DY);const i=s.index===1?"vec2":"float";return e.outputs.add("sampleCount",i),t.main.add(y`
    sampleCount = ${i}(0.0);

    vec3 uvzShadow = calculateUVZShadowFromDepth(uv, textureSize(shadowMap,0), depthMap);
    if (uvzShadow.z < 0.0) {
      return;
    }

    // The shadow map sampler returns a value between 0 and 1, we take the midpoint as we count discrete samples
    bool shadow = readShadowMapUVZ(uvzShadow, shadowMap) > 0.5;

    if (shadow) {
      sampleCount = ${i}(sampleValue); // Add 1 to the sample count
    }
  `),e}const EY=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastMaxSamples:Kp,build:T3},Symbol.toStringTag,{value:"Module"}));let vx=class extends Xt{constructor(e){super(),this._data=e,this.sampleScale=ke(),this.opacityFromElevation=1,this.gradientColor=Mf(AY),this.thresholdColor=Mf(IY),this.bandedGradientColor=Mf(LY),this.bandSize=.1,this.threshold=.5}get shadowCastMap(){return this._data.shadowCastTexture}};const bx=.7,o0=50/255,AY=Si(0,0,1,bx),IY=Si(1,0,0,bx),LY=Si(o0,o0,o0,bx);function S3(s){const e=new lt,t=e.fragment;e.include(Rw),e.include(qi);const{visualization:i}=s;t.constants.add("inverseSampleValue","float",Kp),t.uniforms.add(new Be("shadowCastMap",h=>h.shadowCastMap),new Br("sampleScale",h=>h.sampleScale),new ge("opacityFromElevation",h=>h.opacityFromElevation));const r=i===2,n=i===3,a=i===1;switch(n&&t.include(OY),i){case 0:t.uniforms.add(new qs("uColor",h=>Ku(Ju,h.gradientColor)));break;case 1:t.uniforms.add(new qs("uColor",h=>Ku(Ju,h.bandedGradientColor)),new ge("bandSize",h=>h.bandSize));break;case 3:t.uniforms.add(new qs("uColor",h=>Ku(Ju,h.thresholdColor)),new qs("gradientColor",h=>Ku(Ju,h.gradientColor)),new ge("threshold",h=>h.threshold));break;case 2:t.uniforms.add(new qs("uColor",h=>Ku(Ju,h.thresholdColor)),new ge("threshold",h=>h.threshold))}const{type:o,selector:l,thresholdStrengthSelector:c}=n?{type:"vec2",selector:"rg",thresholdStrengthSelector:"strength.x"}:{type:"float",selector:"r",thresholdStrengthSelector:"strength"};return t.main.add(y`
    ${o} numSamples = texture(shadowCastMap, uv).${l} * inverseSampleValue;

    fragColor = vec4(0.0);

    // early out if we do not have any samples in one or more channels
    if (dot(numSamples, ${o}(1)) < 1.0) {
      return;
    }

    // sampleScale is the number of total samples taken, so this brings strength to a 0-1 range.
    // note that sampleScale is always a vec2 even if we have only the primary channel.
    ${o} strength = numSamples * sampleScale.${l};

    // in threshold mode, step the strength to 0 if we are at or below the threshold, 1 otherwise.
    ${X(r||n,y`
      ${c} = 1.0 - step(${c}, threshold);
    `)}

    // bail out if we are below the threshold
    ${X(r,y`if (${c} == 0.0) { return; }`)}

    ${X(a,y`strength = ceil(strength / bandSize) * bandSize;`)}

    ${o} attenuation = opacityFromElevation * strength;

    // in ThresholdAndGradient mode we blend the threshold color on top of the gradient color
    fragColor = ${X(n,y`blendColorsPremultiplied(uColor * attenuation.r, gradientColor * attenuation.g)`,y`uColor * attenuation`)};
  `),e}const Ju=Lt(),FY=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastVisualizePassParameters:vx,build:S3},Symbol.toStringTag,{value:"Module"}));let JP=class extends ct{constructor(e,t){super(e,t,new ht(FY,()=>k(()=>Promise.resolve().then(()=>Tee),void 0)),ri),this.primitiveType=Ct.TRIANGLE_STRIP}initializePipeline(){return qe({blending:pu,colorWrite:nt,depthTest:null,depthWrite:null})}},P3=class extends ls{constructor(){super(...arguments),this.visualization=0}};u([V({count:4})],P3.prototype,"visualization",void 0);const VY=4e4,kY=5e4,M3=1/512;let Tg=class extends te{constructor(e,t,i,r){super({}),this._techniques=e,this._rctx=t,this._data=i,this._requestRender=r,this._passParameters=new vx(this._data),this._configuration=new P3,this._enabled=!1,this._vao=Wo(t)}dispose(){this._stop(),this._vao=_e(this._vao)}precompile(){this._showVisualization&&this._techniques.precompile(JP,this._configuration)}render(e){if(!this._showVisualization)return;const[t,i]=this._data.computedSamples;this._passParameters.sampleScale=[t?1/t:0,i?1/i:0];const r=this._techniques.get(JP,this._configuration);this._rctx.bindVAO(this._vao),this._rctx.bindTechnique(r,e,this._passParameters),this._rctx.drawArrays(r.primitiveType,0,this._vao.vertexCount("geometry"))}setOptions(e){e.enabled!==void 0&&this._setEnabled(e.enabled),e.thresholdColor!==void 0&&this._setThresholdColor(e.thresholdColor),e.gradientColor!==void 0&&this._setGradientColor(e.gradientColor),e.bandedGradientColor!==void 0&&this._setBandedGradientColor(e.bandedGradientColor),e.threshold!==void 0&&(this._threshold=e.threshold),e.visualization!==void 0&&(this._visualization=e.visualization),e.bandSize!==void 0&&(this._bandSize=e.bandSize)}get opacityFromElevation(){return this._passParameters.opacityFromElevation}set opacityFromElevation(e){this._passParameters.opacityFromElevation!==e&&(this._passParameters.opacityFromElevation=e,this.notifyChange("opacityFromElevation"))}get _showVisualization(){return this._enabled&&(this._data.computedSamples[0]>0||this._data.computedSamples[1]>0)&&this.opacityFromElevation>M3}get _threshold(){return this._passParameters.threshold}set _threshold(e){this._threshold!==e&&(this._passParameters.threshold=e,this._requestRenderIfEnabled())}get _visualization(){return this._configuration.visualization}set _visualization(e){e!==this._visualization&&(this._configuration.visualization=e,this._requestRenderIfEnabled())}get _bandSize(){return this._passParameters.bandSize}set _bandSize(e){e!==this._bandSize&&(this._passParameters.bandSize=e,this._requestRenderIfEnabled())}_setThresholdColor(e){const t=this._passParameters.thresholdColor;Pf(e,t)||(jl(this._passParameters.thresholdColor,e),this._requestRenderIfEnabled())}_setGradientColor(e){const t=this._passParameters.gradientColor;Pf(e,t)||(jl(this._passParameters.gradientColor,e),this._requestRenderIfEnabled())}_setBandedGradientColor(e){const t=this._passParameters.bandedGradientColor;Pf(e,t)||(jl(this._passParameters.bandedGradientColor,e),this._requestRenderIfEnabled())}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop())}_requestRenderIfEnabled(){this._enabled&&this._requestRender()}_start(){this._enabled=!0,this._requestRender()}_stop(){this._enabled=!1,this._requestRender()}};u([p()],Tg.prototype,"opacityFromElevation",null),Tg=u([R("esri.views.3d.webgl-engine.lib.ShadowCastRenderer")],Tg);let $3=class extends ct{constructor(e,t){super(e,t,new ht(EY,()=>k(()=>Promise.resolve().then(()=>See),void 0)),ri),this.primitiveType=Ct.TRIANGLE_STRIP}initializePipeline(e){const t={r:e.index===0,g:e.index===1,b:!1,a:!1};return qe({blending:jL,colorWrite:t,depthTest:null,depthWrite:null})}},mw=class extends ls{constructor(e){super(),this.index=0,this.index=e}};u([V({count:2})],mw.prototype,"index",void 0);function R3(s){const e=new lt,{fragment:t}=e;e.include(qi);const i=s.index===1?"vec2":"float",r="value";return e.outputs.add(r,i),t.main.add(y`${r} = ${i}(0.0);`),e}const zY=Object.freeze(Object.defineProperty({__proto__:null,build:R3},Symbol.toStringTag,{value:"Module"}));let O3=class extends ct{constructor(e,t){super(e,t,new ht(zY,()=>k(()=>Promise.resolve().then(()=>Pee),void 0)),ri),this.primitiveType=Ct.TRIANGLE_STRIP}initializePipeline(e){const t={r:e.index===0,g:e.index===1,b:!1,a:!1};return qe({blending:null,colorWrite:t,depthTest:null,depthWrite:null})}},ws=class extends te{updateDepthRange(e){this._depthRange.equals(e)||(this._depthRange=e)}constructor(e,t,i,r,n,a){super({}),this.fbos=e,this._techniques=t,this._stage=i,this._prepareForShadowMapPass=r,this._renderToShadowMap=n,this._requestRender=a,this._primarySet=new tM(new mw(0),()=>this._requestRenderIfEnabled()),this._contextSet=new tM(new mw(1),()=>this._requestRenderIfEnabled()),this._passParameters=new $w,this._depthRange=ss.Zero,this._previewing=!1,this._shadowAccumulatorKey=Symbol("shadowAccumulator"),this._rctx=e.rctx,this._bindParameters=new H1(new q1(e,i.viewingMode)),this._bindParameters.shadowMap.enabled=!0,this._vao=Wo(this._rctx),this._accumulationRenderer=new Tg(t,this._rctx,this,a);const o=this._stage.view.resourceController.scheduler;this.addHandles([o.registerTask(di.SHADOW_ACCUMULATOR,this),$(()=>this._previewing,()=>this._requestRenderIfEnabled(),Ae),$(()=>this._numActive===2,()=>this._numActiveChanged(),Ae),$(()=>this._depthRange,()=>this._invalidateAccumulationSets(),Ae)],this._shadowAccumulatorKey);for(const l of this._accumulationSets())l.precompile(t)}*_accumulationSets(){yield this._primarySet,yield this._contextSet}normalizeCtorArgs(){return{}}destroy(){this._disable(),this.removeHandles(this._shadowAccumulatorKey),this._accumulationRenderer=_e(this._accumulationRenderer),this._bindParameters.shadowMap.dispose(),this._fbo=_e(this._fbo),this._vao=_e(this._vao);for(const e of this._accumulationSets())e.destroy();this._contextSet=null,this._primarySet=null,this._bindParameters.destroy()}get computedSamples(){return[this._primarySet.progress,this._contextSet.progress]}get shadowCastTexture(){return this._fbo?.colorTexture}get accumulating(){return this.active&&this._previewing||this._refining}get _refining(){return this.active&&!this._doneAccumulating&&!this._previewing}get active(){return this._fbo!=null&&[...this._accumulationSets()].some(e=>e.active)}get canAccumulate(){return this._bindParameters.depth!=null&&this._depthRange!==ss.Zero&&this._opacityFromElevation>M3}get _doneAccumulating(){return[...this._accumulationSets()].every(e=>e.doneAccumulating)}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(e){this._accumulationRenderer.opacityFromElevation=e}get _numActive(){return[...this._accumulationSets()].reduce((e,t)=>e+(t.active?1:0),0)}get _pixelFormat(){return this._numActive===2?{pixelFormat:33319,internalFormat:Es.RG8}:{pixelFormat:6403,internalFormat:Es.R8}}get readyToRun(){return this._refining&&this.canAccumulate&&[...this._accumulationSets()].some(e=>e.running)}runTask(e){this._clearBuffersOnAccumulationStart(),this._prepareForShadowMapPass(this._bindParameters);let t=!1;for(const i of this._accumulationSets())this._runTaskForSet(i,e)&&(t=!0);t&&this._requestRender()}_runTaskForSet(e,t){let i=!1;for(;!t.done&&!e.doneAccumulating;)this._accumulateShadow(e),t.madeProgress(),i=!0;return i}renderAccumulation(e,t,i,r){return this._updateCamera(t),this._bindParameters.contentCamera=i,this._bindParameters.depth=e,this._passParameters.origin=this._bindParameters.camera.center,this.notifyChange("canAccumulate"),!(!this.accumulating||!this.canAccumulate)&&(this._previewing||r?(this._clearFramebuffer(),this._reset()):this._clearBuffersOnAccumulationStart(),this._accumulateSetsForRenderFrame(r))}_clearBuffersOnAccumulationStart(){if([...this._accumulationSets()].every(e=>e.progress===0))this._clearFramebuffer();else for(const e of this._accumulationSets())e.progress===0&&this._clearFramebufferForSet(this._fbo,e)}_accumulateSetsForRenderFrame(e){let t=!1;for(const i of this._accumulationSets())this._accumulateSetForRenderFrame(i,e)&&(t=!0);return t&&this._requestRender(),t}_accumulateSetForRenderFrame(e,t){let i=t?e.sampleCount:Math.min(BY,e.sampleCount);i-=e.progress;for(let r=0;r<i;++r)this._accumulateShadow(e);return i>0}precompile(){this._accumulationRenderer.precompile()}render(e){this._accumulationRenderer.render(e)}setOptions(e){e.previewing!==void 0&&(this._previewing=e.previewing),e.lightDirections!==void 0&&(this._primarySet.lightDirections=e.lightDirections),e.lightDirectionsContext!==void 0&&(this._contextSet.lightDirections=e.lightDirectionsContext),e.enabled===!0?this._enable():e.enabled===!1&&this._disable(),this._accumulationRenderer.setOptions(e)}readAccumulatedShadow(e,t){const i=this._primarySet.progress;return!this.active||!this._fbo||i<1||e<0||e>=this._fbo.width||t<0||t>=this._fbo.height?0:(this._fbo.readPixels(e,t,1,1,6408,si.UNSIGNED_BYTE,eM),eM[0]/i)}_numActiveChanged(){if(!this._fbo)return;const e=this._numActive===2,t=this._createFBO();t.resize(this._fbo.width,this._fbo.height),e&&(this._clearFramebuffer(t),this._contextSet.reset()),this._fbo.width&&this._fbo.height&&this._rctx.blitFramebuffer(this._fbo,t),this._fbo.dispose(),this._fbo=t,this._requestRender()}_enable(){this._fbo||(this._fbo=this._createFBO(),this._invalidateAccumulationSets())}_createFBO(){const{pixelFormat:e,internalFormat:t}=this._pixelFormat,i=new ft;return i.pixelFormat=e,i.internalFormat=t,i.wrapMode=33071,new jo(this._rctx,i)}_invalidateAccumulationSets(){for(const e of this._accumulationSets())e.reset();this._requestRenderIfEnabled()}_disable(){this._fbo&&(this._fbo=_e(this._fbo),this._requestRender())}_reset(){for(const e of this._accumulationSets())e.reset()}_clearFramebuffer(e=this._fbo){e&&e.width&&e.height&&(this._rctx.bindFramebuffer(e),this._rctx.setClearColor(0,0,0,0),this._rctx.clear(16384))}_clearFramebufferForSet(e,t){if(!e)return;const i=this._techniques.get(O3,t.configuration);this._rctx.bindFramebuffer(e),this._rctx.bindTechnique(i,this._bindParameters,this._passParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(i.primitiveType,0,this._vao.vertexCount("geometry"))}_accumulateShadow(e){this._renderToShadowMap(this._bindParameters,e.lightDirections[e.progress++],this._depthRange);const t=this._techniques.get($3,e.configuration);this._rctx.bindFramebuffer(this._fbo),this._rctx.bindTechnique(t,this._bindParameters,this._passParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(t.primitiveType,0,this._vao.vertexCount("geometry"))}_updateCamera(e){const t=this._fbo;if(t==null)return;const i=this._bindParameters.camera;e.equals(i)||i.copyFrom(e),t.resize(e.fullWidth,e.fullHeight),this._opacityFromElevation=1-Kh(VY,kY,e.relativeElevation)}_requestRenderIfEnabled(){this._fbo&&this._requestRender()}get test(){}};u([p()],ws.prototype,"_fbo",void 0),u([p()],ws.prototype,"_depthRange",void 0),u([p()],ws.prototype,"_previewing",void 0),u([p()],ws.prototype,"_accumulationRenderer",void 0),u([p()],ws.prototype,"_refining",null),u([p()],ws.prototype,"active",null),u([p()],ws.prototype,"canAccumulate",null),u([p()],ws.prototype,"_doneAccumulating",null),u([p()],ws.prototype,"_opacityFromElevation",null),u([p()],ws.prototype,"_numActive",null),u([p()],ws.prototype,"_pixelFormat",null),u([p()],ws.prototype,"readyToRun",null),ws=u([R("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],ws);const BY=6,eM=new Uint8Array(4);let tM=class{constructor(e,t){this.configuration=e,this._notifyChange=t,this._cachedLightDirections=[],this._progress=rs(0),this._sampleCount=rs(0)}get progress(){return this._progress.value}set progress(e){this._progress.value=e}get sampleCount(){return this._sampleCount.value}get doneAccumulating(){return this.progress>=this.sampleCount}get running(){return this.progress>0}get active(){return this.sampleCount>0}get lightDirections(){return this._cachedLightDirections}set lightDirections(e){const t=this._cachedLightDirections,i=Math.min(Kp,e.length);if(!wI(t,0,t.length,e,0,i,Jh)){t.length=i,this._sampleCount.value=i;for(let r=0;r<i;++r)t[r]=q(t[r]??x(),e[r]);this.reset(),this._notifyChange()}}destroy(){this._cachedLightDirections.length=0,this._sampleCount.value=0}reset(){this.progress=0}precompile(e){e.precompile($3,this.configuration),e.precompile(O3,this.configuration)}};const NY=R_();let UY=class{constructor(){this._plane=R_(),this._isDecoration=!0}get plane(){return this._plane}get isDecoration(){return this._isDecoration}update({plane:e,isDecoration:t}){let i=!1;return this._isDecoration!==t&&(this._isDecoration=t,i=!0),e??=NY,m5(e,this._plane)?i:(Lw(e,this._plane),!0)}},iM=class{constructor(e,t,i,r,n,a,o,l,c){this.createQuery=e,this.deleteQuery=t,this.resultAvailable=i,this.getResult=r,this.disjoint=n,this.beginTimeElapsed=a,this.endTimeElapsed=o,this.createTimestamp=l,this.timestampBits=c}},Pa=!1;function HY(s,e){if(e.disjointTimerQuery)return null;let t=s.getExtension("EXT_disjoint_timer_query_webgl2");return t?new iM(()=>s.createQuery(),i=>{s.deleteQuery(i),Pa=!1},i=>s.getQueryParameter(i,s.QUERY_RESULT_AVAILABLE),i=>s.getQueryParameter(i,s.QUERY_RESULT),()=>s.getParameter(t.GPU_DISJOINT_EXT),i=>{Pa||(Pa=!0,s.beginQuery(t.TIME_ELAPSED_EXT,i))},()=>{s.endQuery(t.TIME_ELAPSED_EXT),Pa=!1},i=>t.queryCounterEXT(i,t.TIMESTAMP_EXT),()=>s.getQuery(t.TIMESTAMP_EXT,t.QUERY_COUNTER_BITS_EXT)):(t=s.getExtension("EXT_disjoint_timer_query"),t?new iM(()=>t.createQueryEXT(),i=>{t.deleteQueryEXT(i),Pa=!1},i=>t.getQueryObjectEXT(i,t.QUERY_RESULT_AVAILABLE_EXT),i=>t.getQueryObjectEXT(i,t.QUERY_RESULT_EXT),()=>s.getParameter(t.GPU_DISJOINT_EXT),i=>{Pa||(Pa=!0,t.beginQueryEXT(t.TIME_ELAPSED_EXT,i))},()=>{t.endQueryEXT(t.TIME_ELAPSED_EXT),Pa=!1},i=>t.queryCounterEXT(i,t.TIMESTAMP_EXT),()=>t.getQueryEXT(t.TIMESTAMP_EXT,t.QUERY_COUNTER_BITS_EXT)):null)}function qY(s,e){const t=s.capabilities.disjointTimerQuery;return t==null?null:new GY(t,e)}let GY=class{constructor(e,t){this._timer=e,this._queryPool=new Array,this._queryResults=new Map,this._currentQuery=null,t.forEach(i=>{const r=this._timer.createQuery(),n=this._timer.createQuery();this._queryPool.push(r,n),this._queryResults.set(i,null)})}start(){Pa||(this._currentQuery=this._queryPool.pop(),this._currentQuery!=null&&(this._timer.disjoint(),this._timer.beginTimeElapsed(this._currentQuery)))}stop(e){if(this._timer.disjoint()||this._currentQuery==null||!this._queryResults.has(e))return this.abort(),null;this._timer.endTimeElapsed();const t=this._queryResults.get(e);if(t==null)return this._queryResults.set(e,this._currentQuery),this._currentQuery=null,null;if(!this._timer.resultAvailable(t))return this._queryPool.unshift(this._currentQuery),this._currentQuery=null,null;const i=this._timer.getResult(t)/1e6;return this._queryPool.unshift(t),this._queryResults.set(e,this._currentQuery),this._currentQuery=null,i}abort(){this._currentQuery!=null&&(this._timer.deleteQuery(this._currentQuery),this._queryPool.unshift(this._timer.createQuery()),this._currentQuery=null)}dispose(){this._currentQuery!=null&&this._timer.deleteQuery(this._currentQuery),this._queryPool.forEach(e=>{this._timer.deleteQuery(e)}),this._queryResults.forEach(e=>{e!=null&&this._timer.deleteQuery(e)})}};const jt={OVERLAY:"overlay",PREPARE:"prepare",SHADOW_MAP:"shadow map",DEPTH:"depth",ACCUMULATED_SHADOWS:"accumulated shadows",APPLY_ACCUMULATED_SHADOWS:"apply accumulated shadows",OBJECT_AND_LAYER_ID_COLOR:"object/layer id color",NORMALS:"normals",SSAO:"SSAO",HIGHLIGHTS:"highlights",OPAQUE_EDGES:"opaque edges",VOXEL:"voxel",TRANSPARENT:"transparent",TRANSPARENT_EDGES:"transparent edges",HUD_VISIBILITY:"HUD visibility",TRANSPARENT_TERRAIN:"transparent terrain",TRANSPARENT_MATERIAL_WITHOUT_DEPTH:"transparent material without depth",OPAQUE_ENVIRONMENT:"opaque environment",TRANSPARENT_ENVIRONMENT:"transparent environment",OCCLUDED:"occluded",HUD:"HUD",HUD_OCCLUDED:"HUD occluded",FINISH:"finish",FOCUS_AREA_MASK:"focus area mask"},l0=Object.values(It).concat(Object.values(ne)).concat(Object.values(jt)),sM="Total";let jY=class{constructor(e){this._rctx=e,this._startTimeStampCPU=$e(0),this._lastTimeStampCPU=$e(0),this._totalCPUTime=new rm(sM),this._cpuTimeSamplers=new Map(l0.map(t=>[t,new rm(t)])),this._enableGPUTimer=0,this._totalGPUTime=new rm("GPU"),this._gpuTimeSamplers=new Map(l0.map(t=>[t,new rm(t)])),this._totalTime=$e(0),this._totalFrameCount=0}get totalCPUTimeSampler(){return this._totalCPUTime}get cpuTimeSamplers(){return Array.from(this._cpuTimeSamplers.values())}get totalGPUTimeSampler(){return this._totalGPUTime}get gpuTimeSamplers(){return Array.from(this._gpuTimeSamplers.values())}get gpuSamplingEnabled(){return this._gpuTimerPool!=null}get totalTime(){return this._totalTime}get totalFrameCount(){return this._totalFrameCount}get elapsedTime(){return $e(performance.now()-this._startTimeStampCPU)}enableGPUPerformanceInfo(){if(this._gpuTimerPool==null){const t=[...l0,sM];this._gpuTimerPool=qY(this._rctx,t)}if(this._gpuTimerPool==null)return{hasGPUTimerSupport:!1,remove:()=>{}};++this._enableGPUTimer;let e=!1;return{hasGPUTimerSupport:!0,remove:()=>{e||(e=!0,--this._enableGPUTimer,this._enableGPUTimer===0&&(this._gpuTimerPool=_e(this._gpuTimerPool)))}}}startFrame(){this._startTimeStampCPU=this._lastTimeStampCPU=$e(performance.now()),this._gpuTimerPool&&(this._gpuTimeSamplers.forEach(e=>e.push(0)),this._gpuTimerPool.start())}advance(e){const t=$e(performance.now());if(this._cpuTimeSamplers.get(e).push(t-this._lastTimeStampCPU),this._lastTimeStampCPU=t,this._gpuTimerPool){const i=this._gpuTimerPool.stop(e);this._gpuTimeSamplers.get(e).set(i),this._gpuTimerPool.start()}}finishFrame(){if(this._gpuTimerPool){const t=this._gpuTimerPool.stop(jt.FINISH);this._gpuTimeSamplers.get(jt.FINISH).set(t),this._rctx.gl.flush()}const e=$e(performance.now()-this._startTimeStampCPU);this._totalTime=$e(this._totalTime+e),this._totalCPUTime.push(e),this._gpuTimerPool&&this._totalGPUTime.push(this.gpuTimeSamplers.reduce((t,i)=>t+(i.last||0),0)),++this._totalFrameCount}},_h=class extends ip{constructor(s,e,t,i,r,n){super({stage:s}),this._techniques=t,this._rctx=i,this._compositingHelper=r,this._requestRender=n,this._pluginsHas={hudElements:!1,water:!1},this.renderPassManager=new cw,this._isRendering=!1,this._inGlobeView=!1,this._backgroundColor=Si(0,0,0,1),this._sliceHelper=new UY,this._blit=null,this._oitblend=null,this.sceneDepthRange=rs(ss.Infinite),this._state=rs(2),this._highQualityTransparencyEnabled=!0,this._ssrEnabled=!1,this._hasAnimations=!1,this._animationTimestep=new lY,this._loadEdgeViewTask=null,this._edgeViewCallbacks=[],this._reprojectionMatrixVersion=rs(0),this._lastFrameTime=$e(0),this._renderHiddenTransparentEdges=()=>{},this._pluginInput=new RY,this._releaseNormals=a=>{a.some(({name:o})=>o==="normals")&&this._pluginInput.release("normals")},this._debugNeedsDepth=!1,this._fboCache=new ZX(i),this._renderStateFeatures=rs(KP(!Ze("disable-feature:high-quality-idle"),s.view.qualityProfile)),this._framebuffer=new $Y(this.fboCache),this._performanceInfo=new jY(this._rctx),this._shadowMap=new q1(this.fboCache,s.viewingMode),this._shadowAccumulator=new ws(this.fboCache,t,s,a=>{const o=this.shadowsEnabled;this._shadowMap.enabled=!0,this._ensureBindParametersCamera(a.camera,a.contentCamera),this._plugins.prepareRender(),this._shadowMap.enabled=o},(a,o,l)=>{const c=s.view.qualitySettings.maximumPixelRatio;a.shadowMap.start(a.camera,o,l,!0,c),this._renderShadowCascades(4,a.shadowMap),a.shadowMap.finish(),a.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(a.camera,a.contentCamera)},n),this._renderContext=new PE(this._rctx,this._shadowMap,t),this._nodes=new iY(this._renderContext),this._plugins=new sY({renderContext:this._renderContext,techniques:t,materials:e,requestRender:n,controller:s,fbos:this.fboCache,isFeatureEnabled:a=>this.isFeatureEnabled(a)}),this._plugins.add(this.renderPassManager),this.addHandles([$(()=>s.view.state.camera,()=>n(),Ve),$(()=>yi.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES,a=>{this._renderHiddenTransparentEdges=a?()=>this._renderEdges(0):()=>{},n()},Re),$(()=>s.view.environment.background?.color,a=>{const o=a?t1(a):hi;os(this._backgroundColor,o[0]*o[3],o[1]*o[3],o[2]*o[3],o[3]),n()},Ve),$(()=>s.view.state.camera.relativeElevation,a=>this._inGlobeView=(a??1/0)>=o$,Ve),$(()=>this._bindParameters.clouds.fadeFactor,()=>{this._bindParameters.fadeLighting(),this._requestRender(2)},Ae),$(()=>this._bindParameters.clouds.data?.state,()=>n(),Ae),$(()=>s.view.state.highlights,a=>{this._bindParameters.highlights=a,n()},Re)])}destroy(){this._gpuTimerHandle=bi(this._gpuTimerHandle),this._nodes.destroy(),this._framebuffer.dispose(),this._shadowMap.dispose(),this._shadowAccumulator.destroy(),this._shadowAccumulator=null,this._loadEdgeViewTask=Os(this._loadEdgeViewTask),this._edgeView=Q(this._edgeView),this.renderPassManager.dispose(),this._releaseFBOs(),this._disposeOffscreenBuffers(),this._fboCache.destroy(),this._fboCache=null,this._plugins.destroy(),this._plugins=null,this._pluginInput=null,this._blit=null,this._oitblend=null,this._compositingHelper=null,this._nodes=null,this._framebuffer=null,this._shadowMap=null,this._renderContext=null,this._performanceInfo=null,WL.prune(),Fh.prune(),cV()}get renderContext(){return this._renderContext}get _bindParameters(){return this._renderContext.bind}get _framebufferSize(){return this._framebuffer.size}get performanceInfo(){return this._performanceInfo}updateRenderFeatures(s=null,e=!Ze("disable-feature:high-quality-idle")){this._renderStateFeatures.value=KP(e,s),this._requestRender()}isFeatureEnabled(s,e=this._state.value){return this._renderStateFeatures.value.get(e,s)??!1}setFeatureEnabled(s,e,t){this._renderStateFeatures.mutate(i=>i.set(e,s,t)),this._requestRender()}get _highQualityTransparency(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(1)}get hasReflections(){return this._pluginsHas.water&&(this._ssrEnabled||this.isFeatureEnabled(5))}get _hasHighlights(){return this._plugins.produces(9,2,4,18,13,14)}hasHighlight(s){return this._plugins.hasHighlight(s)}get _hasHUDHighlights(){return this._plugins.produces(9,13,14)}get hasSSAO(){return(this.stage.view.qualitySettings.ambientOcclusion||this.isFeatureEnabled(4))&&!this._inGlobeView}get hasSMAA(){return this.stage.view.qualitySettings.antialiasingEnabled||this.isFeatureEnabled(0)}get hasEmitters(){return this._plugins.hasEmitters&&this.stage.view.qualitySettings.physicallyBasedRenderingEnabled}get fullResolutionAtmosphere(){return this.stage.view.qualitySettings.highResolutionAtmosphere||this.isFeatureEnabled(3)}get fboCache(){return this._fboCache}_releaseFBOs(){this._bindParameters.ssr.lastFrameColor=Nt(this._bindParameters.ssr.lastFrameColor),this._bindParameters.terrainDepth=Nt(this._bindParameters.terrainDepth),this._bindParameters.geometryDepth=Nt(this._bindParameters.geometryDepth)}_disposeOffscreenBuffers(){this._framebuffer.dispose(),this._disposeBindBuffers()}_disposeBindBuffers(){this._shadowMap.disposeOffscreenBuffers(),this._bindParameters.depth=Nt(this._bindParameters.depth),this._bindParameters.hudVisibility=Nt(this._bindParameters.hudVisibility)}get updating(){return this._loadEdgeViewTask&&!this._loadEdgeViewTask.finished||this._edgeView?.updating||this._shadowAccumulator.readyToRun||this._plugins.updating||!this.isCameraFinal}loadEdgeView(){return this._loadEdgeViewTask||(this._loadEdgeViewTask=Za(async s=>{const{EdgeView:e}=await k(()=>import("./EdgeView-XH0bkele.js"),__vite__mapDeps([470,1,14,19,9,7,8,5,6,20,39,183,4,2,10,180,187,70,88,188,189,186,248,194,195,87,196,197,102,28,191,469,198,185,199,193,200,182,184,190,192,13,37,38,35,11,12,93,201,202,203,92,94,27,90,95,204,471,245,113,114,16,472,468,416,241,229,142,83,84,85,82,81,71,230,161,18,29,21,22,23,24,205,206,175,26,3,15,30,31,32,33,34,36,40,41,42,43,44,129,207,208,209,210,98,211,122,52,212,76,213,214,47,215,216,217,147,218,219,220,144,221,222,223,69,224,51,48,49,225,226,227,228,166,132,231,232,233,234,99,100,235,236,237,238,239,80,240,242,243,244,246,247,249,250]));He(s);const t=this._edgeView=new e({rctx:this._rctx,renderSR:this.stage.view.renderSpatialReference,viewingMode:this.stage.view.stage.viewingMode,techniques:this._techniques,setNeedsRender:()=>this._requestRender(),schedule:XY(this.stage.view.resourceController)});return this.addHandles($(()=>t.updating,()=>this._requestRender(),Ae)),this._requestRender(),this._edgeViewCallbacks.forEach(i=>i(t)),this._edgeViewCallbacks.length=0,t})),this._loadEdgeViewTask.promise}withEdgeView(s){this.loadEdgeView(),this._edgeView==null?this._edgeViewCallbacks.push(s):s(this._edgeView)}get edgeView(){return this._edgeView}get isCameraFinal(){return this._reprojectionMatrixVersion.value>=0&&iV(this._bindParameters.ssr.reprojectionMatrix,_n)}set _reprojectionMatrix(s){xI(this._bindParameters.ssr.reprojectionMatrix,s)&&this._reprojectionMatrixVersion.value++}get shadowsEnabled(){return!!this._shadowMap?.enabled}setParameters(s){const{_shadowMap:e,_bindParameters:t}=this;if(s.qualitySettings?.reflections!==void 0&&this._ssrEnabled!==s.qualitySettings.reflections&&(this._ssrEnabled=s.qualitySettings.reflections,this._requestRender()),s.shadowMap!==void 0&&this._shadowMap.enabled!==s.shadowMap&&(this._shadowMap.enabled=s.shadowMap,this._requestRender()),s.shadowMapMaxCascades!==void 0&&e.maxCascades!==s.shadowMapMaxCascades&&(e.maxCascades=s.shadowMapMaxCascades,this._requestRender()),s.environment){s.environment.weather!==void 0&&(this._bindParameters.weather=s.environment.weather);const i=s.environment.lighting.type!=="virtual";t.enableFillLights!==i&&(t.enableFillLights=i,this._requestRender())}s.highQualityTransparency!==void 0&&this._highQualityTransparencyEnabled!==s.highQualityTransparency&&(this._highQualityTransparencyEnabled=s.highQualityTransparency,this._requestRender()),s.shadowCast!==void 0&&this._shadowAccumulator.setOptions(s.shadowCast)}set slice(s){this._sliceHelper.update(s)&&this._requestRender()}get plugins(){return this._plugins}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlend.result}get _oitEnabled(){return this._highQualityTransparency&&this._hasOITSupport}commit(s,e){return this._isRendering&&console.warn("Renderer.modify called while rendering"),!!super.commit(s,e,this._plugins.context)&&(this.updateHasFlags(),!0)}rendererAdded(s){this._plugins.add(s)}rendererRemoved(s){this._plugins.remove(s)}get occludedRequiresStencil(){return this.occludedRequiresOccludeeStencil||this.occludedRequiresIntegratedMeshStencil}get occludedRequiresOccludeeStencil(){return this._bindParameters.hasOccludees&&!!(8&this.plugins.renderOccludedFlags)}get occludedRequiresIntegratedMeshStencil(){return this._plugins.produces(0,0)&&this._plugins.produces(0,9)}updateHasFlags(){const s=this._pluginsHas;s.hudElements=this._plugins.produces(0,...td),s.water=this._plugins.produces(3,19),this._bindParameters.hasOccludees=this._plugins.hasOccludees,this._requestRender()}updateAnimation(s,e){this._animationTimer??=new oY(s.camera,e),this._animationTimer.advance(s.camera,e,this._animationTimeDilation);const t=this._hasAnimations;return this._hasAnimations=this._plugins.updateAnimation(this._animationTimer),this._hasAnimations=this._nodes.updateAnimation(this._animationTimer)||this._hasAnimations,this._hasAnimations!==t&&(this._gpuTimerHandle=t?bi(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo()),this._hasAnimations}get animationTimestep(){return this._animationTimestep.value}get _animationTimeDilation(){return this._animationTimestep.timeDilation}resetAnimation(){this._animationTimestep.clear()}tick(){this.fboCache.clean()}render(s,e,t,i=!1){try{return this._isRendering=!0,this._render(s,e,t,i)}catch(r){console.error(`Exception during rendering: ${r}`)}finally{this._isRendering=!1}return new R2(this._pluginInput.get(It.FINAL),null)}_updateHUDOccludedFragmentOpacity(s,e){const{idleOpacity:t,navigatingOpacity:i,maxDelta:r,tiltFadeStart:n,tiltFadeEnd:a,altitudeStart:o,altitudeEnd:l}=MY,c=this.stage.view,h=c.stateManager.camera,d=c.qualitySettings.fadeDuration,m=s===2?t:i,f=U((h.tilt-n)/(a-n),0,1),g=U(((h.position.z??0)-o)/(l-o),0,1),_=Me(Me(1,m,f),1,g),v=this._bindParameters.hudOccludedFragmentOpacity;if(d<=0||v===_||this._lastFrameTime===0||this._lastFrameTime>e)return this._bindParameters.hudOccludedFragmentOpacity=_,void(this._lastFrameTime=e);const b=e-this._lastFrameTime;this._lastFrameTime=e;const T=Math.max(1-t,Math.abs(t-i)),w=Math.min(T*b/d,r);w>=Math.abs(_-v)?this._bindParameters.hudOccludedFragmentOpacity=_:(this._bindParameters.hudOccludedFragmentOpacity=v+Math.sign(_-v)*w,this._requestRender())}_render(s,e,t,i){const r=t===0;this.performanceInfo.startFrame(),this.fboCache.frameStart(),this.fboCache.interactive=r,this._disposeBindBuffers();const{camera:n,contentCamera:a,mode:o,alignPixelEnabled:l}=s;this._state.value=o;const c=this._nodes.produces("magnifier-color"),h=this._nodes.produces(It.FINAL),d=this.hasEmitters,m=d?1:0;this._renderContext.time=e,this._renderContext.output=m,this._bindParameters.oitPass=0,this._bindParameters.alignPixelEnabled=l,this._bindParameters.decorations=!i,this._bindParameters.mainDepth=null;const f=!i||!this._sliceHelper.isDecoration;this._bindParameters.slicePlane=f?this._sliceHelper.plane:null,this._bindParameters.viewshedEnabled=this._nodes.produces(ne.VIEWSHED),this._bindParameters.cutFillEnabled=this._nodes.produces(ne.CUTFILL_DEPTH),this._renderOverlay(),n.setGLViewport(this._rctx);const g=this._framebuffer,_=g.initialize(n.fullWidth,n.fullHeight,this._backgroundColor,d);this.hasReflections?(_?.setName("last frame color"),this._bindParameters.ssr.lastFrameColor=_):_?.release(),this._ensureBindParametersCamera(n,a),this._updateHUDOccludedFragmentOpacity(o,e),this._plugins.prepareRender(),this._bindParameters.shadowHighlightsVisible=this._needsShadowHighlight&&!i;const v=this._highQualityTransparency&&this._hasTransparentTerrain,b=this._plugins.produces(0,...ed);this._precompilePrepasses(),this.performanceInfo.advance(jt.PREPARE);const T=this._computeShadowDepthRange(n);this._renderShadowMap(n,this._bindParameters.lighting.mainLight.direction,T),this._pluginInput.set("normals",this._renderNormals()),this._renderRemainingGeometryDepth(),this._renderShadowAccumulation(T,n,a,!r),this._ensureBindParametersSSR(e),this._precompileShaders(v,b,m),this._renderContext.output=m,g.bind(),this._bindParameters.mainDepth=g.depth.attachment,this._renderOpaque(v),this._renderTransparent(b,v,m),this._shadowMap.disposeMainBuffer(),this._pluginInput.set(ne.FOCUSAREA,this._renderFocusAreaGeometry()),this._pluginInput.set(ne.CUTFILL_DEPTH,this._renderCutFillDepth()),g.update(A=>this._renderNodes(ne.TRANSPARENT_ENVIRONMENT,A)),g.update(A=>this._renderNodes(ne.VIEWSHED,A)),g.update(A=>this._renderNodes(ne.LASERLINES,A)),g.update(A=>this._renderNodes(ne.FOCUSAREA_COLOR,A)),this._pluginInput.release(ne.FOCUSAREA),this._pluginInput.release(ne.CUTFILL_DEPTH),g.update(A=>this._renderNodes(ne.OCCLUDED,A)),this._pluginInput.set("highlights",this._renderHighlightPrepass()),this._renderHighlightShadowMap(n,this._bindParameters.lighting.mainLight.direction,T);const w=t===2?this._renderObjectAndLayerIdColor():null;g.update(A=>this._renderNodes(It.COMPOSITE,A)),this._shadowMap.disposeOffscreenBuffers();const S=r&&!h&&!(c&&!i),C=this._pluginInput.get(It.COMPOSITE),P=S?cu:this.fboCache.acquire(C.fbo.width,C.fbo.height,ne.ANTIALIASING),M=this._nodes.produces(ne.ANTIALIASING)?this._renderNodes(ne.ANTIALIASING,P):this.blitFBO(C,P,!1);let O;this._pluginInput.set(ne.ANTIALIASING,M),this._hasHUDHighlights?(this._renderHUD(1,M,m),O=this._renderNodes(ne.HIGHLIGHTS,M)):(O=this._renderNodes(ne.HIGHLIGHTS,M),this._renderHUD(1,O,m));const D=this._renderNodes(ne.MAGNIFIER,O);return r&&c&&!i&&!h&&this.blitFBO(D),h?(D.attachDepth(g.depth),this.blitFBO(this._renderNodes(It.FINAL,D)),D.detachDepth()):this._pluginInput.set(It.FINAL,D),this._pluginInput.release("highlights"),this.onPostRender&&this.onPostRender(),this._releaseFBOs(),g.releaseDepth(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this.fboCache.frameEnd(),this.performanceInfo.finishFrame(),r||(this._releaseFBOs(),this._disposeOffscreenBuffers()),new R2(this._pluginInput.get(It.FINAL),w)}_precompileShaders(s,e,t){++this._plugins.context.techniques.precompiling,this._renderContext.output=t,this._precompileOpaqueGeometry(),this._nodes.precompile(ne.OPAQUE_ENVIRONMENT),this._bindParameters.terrainDepthTest=s,this._bindParameters.cullAboveTerrain=s,this._renderContext.output=2,this._plugins.precompile(6),this._plugins.precompile(7),s&&(this._precompileOpaqueGeometry(),this._precompileTransparentGeometry()),this._renderContext.output=t,this._plugins.precompile(6),this._plugins.precompile(7),e&&(this._precompileTransparentGeometry(),this._hasTransparentTerrain&&(this._bindParameters.cullAboveTerrain=!1,this._precompileTransparentGeometry(),this._bindParameters.cullAboveTerrain=s)),this._nodes.precompile(ne.FOCUSAREA),this._needsHUDVisibility&&this._plugins.precompile(12),this._plugins.precompile(15),this._precompileHUD(0),this._bindParameters.terrainDepthTest=!1,this._bindParameters.cullAboveTerrain=!1,this._nodes.precompile(ne.VIEWSHED,ne.CUTFILL_DEPTH,ne.CUTFILL_COLOR,ne.LASERLINES,ne.FOCUSAREA_COLOR,ne.OCCLUDED,ne.ANTIALIASING,ne.HIGHLIGHTS);const i=this._bindParameters;i.highlightMixTexture=i.highlights.length>1?this._rctx.emptyTexture:null,this._precompileHUD(1),this._hasHighlights&&(i.highlights.forEach((r,n)=>{i.highlightLevel=n,this._precompileAllGeometry(9)}),i.highlightLevel=null),i.highlightMixTexture=null,this._nodes.precompile(It.COMPOSITE,ne.MAGNIFIER),this._shadowAccumulator.precompile(),this._plugins.precompile(8),--this._plugins.context.techniques.precompiling}_renderFocusAreaGeometry(){const s=this._nodes.produce(ne.FOCUSAREA,this._pluginInput);return s&&this.performanceInfo.advance(jt.FOCUS_AREA_MASK),s}_renderObjectAndLayerIdColor(){if(!this._nodes.produces("olid"))return null;const s=this._renderContext.output;++this._techniques.precompiling;const e=this._framebufferSize;let t=this.fboCache.acquire(e.width,e.height,"olid");return t.acquireDepth(13),t=this._nodes.render(t,this._pluginInput),--this._techniques.precompiling,this.performanceInfo.advance(jt.OBJECT_AND_LAYER_ID_COLOR),this._renderContext.output=s,t}finish(s){this._hasAnimations||this._animationTimestep.clear();const e=this.performanceInfo.gpuSamplingEnabled,t=s===0;if(t||e){const i=t?this.performanceInfo.elapsedTime:0;let r=0;e?r=this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.finish();const n=Math.max(i,r);this._animationTimestep.frame(n,t)}}readMainDepth(s,e){const{mainDepth:t,camera:i}=this._bindParameters;if(!t)return;const r=this.fboCache.acquire(this._framebufferSize.width,this._framebufferSize.height,"linear depth");this._rctx.bindFramebuffer(r.fbo),i.setGLViewport(this._rctx),this._rctx.setScissorRect(s[0],s[1],s[2],s[3]),this._rctx.setScissorTestEnabled(!0),this._rctx.clearFramebuffer(hi),this._compositingHelper.blitDepthToLinearDepth(this._bindParameters,t),this._rctx.setScissorTestEnabled(!1),this._rctx.setScissorRect(0,0,this._rctx.gl.canvas.width,this._rctx.gl.canvas.width),r.fbo?.readPixels(s[0],s[1],s[2],s[3],6408,si.UNSIGNED_BYTE,e),r.release()}readHUDVisibility(s,e,t,i,r){this._bindParameters.hudVisibility?.fbo?.readPixels(s,e,t,i,6408,si.UNSIGNED_BYTE,r)}readAccumulatedShadow(s){return this._shadowAccumulator.readAccumulatedShadow(s[0],s[1])}_renderEdges(s){const e=this._edgeView;if(!e?.shouldRender())return;const t=this._renderContext.output,i=this._framebufferSize,r=this.fboCache.acquire(i.width,i.height,"edges"),n=()=>e.render(this._bindParameters,s),a=this._bindParameters.geometryDepth;this.renderToTargets(n,r,a??this._framebuffer.depth,hi),this._framebuffer.bind(),this._compositingHelper.composite(this._bindParameters,r.getTexture(),yy(t)?1:0),r.release(),this.performanceInfo.advance(s===1?jt.OPAQUE_EDGES:jt.TRANSPARENT_EDGES)}_renderOverlay(){this._bindParameters.overlay=this.overlay?.render(),this._bindParameters.overlay&&this.performanceInfo.advance(jt.OVERLAY)}_renderShadowMap(s,e,t){if(!this.shadowsEnabled)return;const{contentCamera:i}=this._bindParameters,r=this._shadowMap;r.start(s,e,t,this.isFeatureEnabled(6),this.stage.view.qualitySettings.maximumPixelRatio),this._needsShadowHighlight?(this._renderShadowCascades(6,this._shadowMap),r.copySnapshot(1),this._renderShadowCascades(5,this._shadowMap)):this._renderShadowCascades(4),r.finish(),s.setGLViewport(this._rctx),this._ensureBindParametersCamera(s,i),this.performanceInfo.advance(jt.SHADOW_MAP)}_renderHighlightShadowMap(s,e,t){if(!this.shadowsEnabled||!this._needsShadowHighlight)return;const{contentCamera:i}=this._bindParameters,r=this._shadowMap;r.start(s,e,t,this.isFeatureEnabled(6),this.stage.view.qualitySettings.maximumPixelRatio),this._renderShadowCascades(5,this._shadowMap),r.moveSnapshot(0),r.finish(),s.setGLViewport(this._rctx),this._ensureBindParametersCamera(s,i),this.performanceInfo.advance(jt.SHADOW_MAP)}_renderCutFillDepth(){return this._nodes.produce(ne.CUTFILL_DEPTH,this._pluginInput)}_precompileShadowCascades(s){for(const e of this._shadowMap.cascades)e.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(e.camera,e.camera),this._precompileAllGeometry(s)}_renderShadowCascades(s,e=this._shadowMap){e.bindFbo();for(const t of e.cascades)t.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(t.camera,t.camera),this.renderAllGeometry(s)}get _needsDepth(){return this._plugins.consumes(2)||this._nodes.requireGeometryDepth()||this.hasReflections||this._needsShadowHighlight||this._shadowAccumulator.active||this._debugNeedsDepth}_renderRemainingGeometryDepth(){const s=this._pluginInput.get("normals");s?(this._pluginInput.set(ne.SSAO,this._renderSSAO()),this._needsDepth?(this._rctx.bindFramebuffer(s.fbo),this._rctx.clear(1024),this._renderGeometryWithoutNormals(2),Nt(this._bindParameters.depth),this._bindParameters.depth=s.obtainDepthTexture(),this.performanceInfo.advance(jt.DEPTH)):(s.detachDepth(),this._bindParameters.depth=Nt(this._bindParameters.depth)),this.hasSSAO&&this._pluginInput.release("normals")):this._renderAllGeometryDepth()}_renderAllGeometryDepth(){if(!this._needsDepth)return void(this._bindParameters.depth=Nt(this._bindParameters.depth));const s=this._framebufferSize,e=this.fboCache.acquire(s.width,s.height,"geometry depth",13);this._rctx.bindFramebuffer(e.fbo),this._rctx.clear(1280),this.renderAllGeometry(2),Nt(this._bindParameters.depth),this._bindParameters.depth=e.obtainDepthTexture(),e.release(),this.performanceInfo.advance(jt.DEPTH)}_renderTerrainDepth(s){if(this._bindParameters.terrainDepthTest=s,this._bindParameters.cullAboveTerrain=s,!s)return void(this._bindParameters.terrainDepth=Nt(this._bindParameters.terrainDepth));const e=this._renderContext.output;this._renderContext.output=2;const t=this._framebufferSize,i=this.fboCache.acquire(t.width,t.height,"terrain depth",13);this._rctx.bindFramebuffer(i.fbo),this._rctx.clear(1280),this._renderTransparentTerrain(),Nt(this._bindParameters.terrainDepth),this._bindParameters.terrainDepth=i.obtainDepthTexture(),this._renderContext.output=e,i.release()}_renderGeometryDepth(s){if(!s)return void(this._bindParameters.geometryDepth=Nt(this._bindParameters.geometryDepth));const e=this._renderContext.output,{width:t,height:i}=this._framebufferSize,r=this.fboCache.acquire(t,i,"geometry depth",13);this._rctx.bindFramebuffer(r.fbo),this._rctx.clear(1280),this._renderOpaqueAndTransparentGeometry(2),this._renderContext.output=e,Nt(this._bindParameters.geometryDepth),this._bindParameters.geometryDepth=r.obtainDepthTexture(),r.release()}get _needsShadowDepthRange(){return this._shadowMap.enabled||this._shadowAccumulator.active}_computeShadowDepthRange(s){if(!this._needsShadowDepthRange)return ss.Zero;const e=ZP(s,this._plugins.plugins,this.stage.layers,0);return e.union(this._plugins.queryDepthRange(s)),e.near=Math.max(s.near,e.near),e.far=Math.min(s.far,e.far),e}updateSceneDepthRange(s){if(!this.stage.view.state.isGlobal)return void(this.sceneDepthRange.value=ss.Infinite);if((this.stage.view.renderCoordsHelper?.getAltitude(s.eye)??0)<QL)return void(this.sceneDepthRange.value=ss.Infinite);const e=s.clone();e.near=ZL,e.far=1e10;const t=ZP(e,this._plugins.plugins,this.stage.layers,1);t.union(this._plugins.queryDepthRange(e)),this.sceneDepthRange.value.equals(t)||(this.sceneDepthRange.value=t)}get _normalsRequired(){const s=this._nodes.require("normals",It.FINAL,It.COMPOSITE,It.OPAQUE,It.TRANSPARENT,ne.VIEWSHED,ne.LASERLINES);return(this.hasSSAO?1:0)+s}_precompilePrepasses(){this._normalsRequired&&this._precompileAllGeometry(3),this._needsDepth&&this._precompileAllGeometry(2),this.shadowsEnabled&&(this._needsShadowHighlight?(this._precompileShadowCascades(5),this._precompileShadowCascades(6),this._precompileShadowCascades(5)):this._precompileShadowCascades(4)),this._shadowAccumulator.active&&this._precompileAllGeometry(4)}_renderNormals(){const s=this._normalsRequired;if(s===0)return;const e=this._framebufferSize,t=this.fboCache.acquire(e.width,e.height,"normals",5);t.acquireDepth(13),this._rctx.bindFramebuffer(t.fbo),this._rctx.clearFramebuffer(hi,!0,!0),this._renderGeometryWithNormals(3);const i=this._nodes.optional("normals",It.FINAL,It.COMPOSITE,It.OPAQUE,It.TRANSPARENT,ne.VIEWSHED);return t.retain(s+i-1),this.performanceInfo.advance(jt.NORMALS),t}_renderSSAO(){const s=this._pluginInput.get("normals");if(!this.hasSSAO||!s)return;const e=this._nodes.produce(ne.SSAO,this._pluginInput);return this._bindParameters.ssao=e,e&&this.performanceInfo.advance(jt.SSAO),e}_precompileAllGeometry(s){const e=this._renderContext.output;this._renderContext.output=s,this._precompileOpaqueGeometry(),this._precompileTransparentGeometry(),this._plugins.precompile(6),this._plugins.precompile(7),this._renderContext.output=e}renderAllGeometry(s){this._renderContext.output=s,this._renderOpaqueAndTransparentGeometry(s),this._renderTransparentTerrain()}precompileSlots(s,...e){for(const t of e)this._bindParameters.slot=t,s.precompile(this._renderContext)}precompileOccludedSlots(s,e){for(const t of e)this._renderContext.renderOccludedMask=t,this.precompileSlots(s,...rM);this._renderContext.renderOccludedMask=Ep}renderSlots(s,...e){for(const t of e)this._bindParameters.slot=t,s.forAll(i=>{const r=i.acquireTechniques(this._renderContext);r&&i.render(this._renderContext,r)})}renderOccludedSlots(s,e){this._renderContext.renderOccludedMask=e,this.plugins.renderOccludedFlags>1&&this._plugins.render(9),this.renderSlots(s,...rM),this._renderContext.renderOccludedMask=Ep}renderHUD(s){this._bindParameters.hudRenderStyle=s,this._plugins.render(13)}precompileViewshedShadowMap(){this._precompileAllGeometry(7)}precompileCutFill(){const e=this._renderContext.output;this._renderContext.output=8,this._plugins.precompile(0,1,6),this._renderContext.output=e}renderViewshedShadowMap(s){const{camera:e,contentCamera:t}=this._bindParameters,i=this._renderContext.output;s.setGLViewport(this._rctx),this._ensureBindParametersCamera(s,s),this.renderAllGeometry(7),this._ensureBindParametersCamera(e,t),this._bindParameters.camera.setGLViewport(this._rctx),this._renderContext.output=i}renderCutFillReferenceDepth(s){const{camera:e,contentCamera:t}=this._bindParameters,i=this._renderContext.output;s.setGLViewport(this._rctx),this._ensureBindParametersCamera(s,s),this._renderContext.output=8,this._plugins.render(0,1),this._plugins.render(6),this._ensureBindParametersCamera(e,t),e.setGLViewport(this._rctx),this._renderContext.output=i}_renderOpaqueAndTransparentGeometry(s){this._renderContext.output=s,this._renderOpaqueGeometry(),this._renderTransparentGeometry()}_renderGeometryWithNormals(s){this._renderContext.output=s,this._plugins.render(...WY),this._renderTransparentTerrain()}_renderGeometryWithoutNormals(s){this._renderContext.output=s,this._plugins.render(...QY)}_precompileOpaqueGeometry(){this._plugins.precompile(...c0),this._nodes.precompile("opaque-color")}_renderOpaqueGeometry(){this._plugins.render(...c0)}_renderTransparentGeometry(){this._plugins.render(...ed)}get _hasTransparentTerrain(){return this._plugins.produces(0,6)}get _hasTransparentIntegratedMesh(){return this._plugins.produces(this._renderContext.output,7)}_renderTransparentTerrain(){const s=()=>this._plugins.render(6);if(!ns(this._renderContext.output))return void s();const e=this._framebufferSize,t=this.fboCache.acquire(e.width,e.height,"transparent terrain");return this.renderToTargets(s,t,this._framebuffer.depth,hi),t}_renderTransparentIntegratedMesh(){const s=()=>this._plugins.render(7);if(!ns(this._renderContext.output))return void s();const e=this._framebufferSize,t=this.fboCache.acquire(e.width,e.height,"transparent integrated mesh");return this.renderToTargets(s,t,this._framebuffer.depth,hi),t}get _needsHUDVisibility(){return this._plugins.produces(this._renderContext.output,12)}_renderHUDVisibility(){if(!this._needsHUDVisibility)return void(this._bindParameters.hudVisibility=Nt(this._bindParameters.hudVisibility));const{width:s,height:e}=this._framebufferSize;let t=this._bindParameters.hudVisibility;t?.fbo?.width===s&&t?.fbo?.height===e||(t?.release(),t=this.fboCache.acquire(s,e,"hud visibility",4),this._bindParameters.hudVisibility=t);const i=this._bindParameters.geometryDepth;t.attachDepth(i||this._framebuffer.depth),this._rctx.bindFramebuffer(t.fbo),this._rctx.clearFramebuffer([0,1,0,1]),this._plugins.render(12),t.detachDepth(),this._framebuffer.bind(),this.performanceInfo.advance(jt.HUD_VISIBILITY)}_renderLineCallouts(s){if(this._bindParameters.hudRenderStyle=s,s===0){const e=()=>this._plugins.render(15),t=this._framebufferSize,i=this.fboCache.acquireDepth(12,t.width,t.height,"line callouts");this.renderToTargets(e,this._framebuffer.color,i,void 0,!0,!0),i.release()}else this._plugins.render(15)}_precompileHUD(s){if(this._precompileHUDOutput(s),this._hasHighlights){const e=this._renderContext.output;this._renderContext.output=9,this._precompileHUDOutput(s),this._renderContext.output=e}}_precompileHUDOutput(s){const e=this._bindParameters.hudRenderStyle;this._bindParameters.hudRenderStyle=s,this._oitEnabled&&ns(this._renderContext.output)?(this._bindParameters.oitPass=1,this._plugins.precompile(...td),this._bindParameters.oitPass=2,this._plugins.precompile(...td),this._bindParameters.oitPass=0):this._plugins.precompile(...td),this._bindParameters.hudRenderStyle=e}_renderHUD(s,e,t){if(this._pluginsHas.hudElements){if(this._oitEnabled){const i=this._renderOIT(1,t,s);this._rctx.bindFramebuffer(e.fbo),this._compositingHelper.compositePreMultipliedAlpha(this._bindParameters,i.getTexture(),0),i.release()}else if(this._renderContext.output=t,s===0){const i=()=>this._renderHUDElements(s),r=this._framebufferSize,n=this.fboCache.acquireDepth(12,r.width,r.height,"hud");this.renderToTargets(i,this._framebuffer.color,n,void 0,!0,!0),n.release()}else e.acquireDepth(12),this._rctx.bindFramebuffer(e.fbo),this._renderHUDElements(s),e.detachDepth();this.performanceInfo.advance(s===0?jt.HUD_OCCLUDED:jt.HUD)}}_renderHUDElements(s){this._bindParameters.hudRenderStyle=s,this._plugins.render(...td)}get _needsShadowHighlight(){return this.shadowsEnabled&&this._plugins.produces(5,2)}_renderHighlightPrepass(){if(!this._hasHighlights)return;const{fboCache:s,_rctx:e,_bindParameters:t}=this,i=this._framebufferSize,{highlights:r}=t,n=s.acquire(i.width,i.height,"highlights",r.length>U1?3:1);n.acquireDepth(13);const a=this._plugins.produces(9,0);return a&&this._framebuffer.color.fbo&&n.fbo&&e.blitFramebuffer(this._framebuffer.color.fbo,n.fbo,1024),e.bindFramebuffer(n.fbo),e.gl.clearBufferuiv(6144,0,[0,0,0,0]),a||e.clear(1024),this._renderContext.output=9,e.bindFramebuffer(n.fbo),fE(e,s,i,t,()=>this._renderHighlightGeometries()),n.detachDepth(),this.performanceInfo.advance(jt.HIGHLIGHTS),n}_renderHighlightGeometries(){this._plugins.render(...ZY),this._rctx.clear(256),this._renderHUDElements(2)}_renderShadowAccumulation(s,e,t,i){this._shadowAccumulator.updateDepthRange(s),this._shadowAccumulator.accumulating&&this._bindParameters.depth&&this._shadowAccumulator.renderAccumulation(this._bindParameters.depth,e,t,i)&&this.performanceInfo.advance(jt.ACCUMULATED_SHADOWS)}_precompileTransparentGeometry(){this._oitEnabled&&ns(this._renderContext.output)?(this._bindParameters.oitPass=1,this._plugins.precompile(...ed),this._bindParameters.oitPass=2,this._plugins.precompile(...ed),this._bindParameters.oitPass=0):this._plugins.precompile(...ed)}_renderOIT(s,e,t=2){const i=s===1,r=this._framebufferSize,n=i?this.fboCache.acquire(r.width,r.height,"oit hud composite"):null,a=i?()=>this._renderHUDElements(t):()=>this._renderTransparentGeometry(),o=this._bindParameters,l=this._renderContext.output;this._renderContext.output=e,o.oitPass=1;const c=n?"oit hud color+alpha":"oit color+alpha",h=this.fboCache.acquire(r.width,r.height,c,8),d=e===1;d&&h.acquireColor(Ws,8,"oit emissive"),h.acquireColor(d?iR:Ws,7),n||h.attachDepth(this._framebuffer.depth),this._rctx.bindFramebuffer(h.fbo),this._rctx.clearFramebuffer([0,0,0,1]),d&&this._rctx.clearBuffer(1,J_),a(),h.detachDepth(),o.oitPass=2;const m=this.fboCache.acquire(r.width,r.height,n?"oit hud front":"oit front");return d&&m.acquireColor(Ws,8,"oit emissive front"),n?m.acquireDepth(12):m.attachDepth(this._framebuffer.depth),this._rctx.bindFramebuffer(m.fbo),this._rctx.clearFramebuffer(hi,!!n),a(),m.detachDepth(),o.oitPass=0,n?(this._rctx.bindFramebuffer(n.fbo),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clear(16384)):this._framebuffer.bind(),this._oitblend??=new aY(this._techniques),this._oitblend.blend(this._rctx,h,m,o,d,!i),n?.detachDepth(),m.release(),h.release(),this._renderContext.output=l,n}_renderOpaque(s){const e=this.plugins.produces(0,...c0);if(e){this._plugins.render(0,1);const i=this._framebuffer;i.update(r=>this._renderNodes(ne.CUTFILL_COLOR,r)),i.update(r=>this._renderNodes(ne.OPAQUE_TERRAIN,r)),i.bind(),this._plugins.render(2,3)}const t=this._framebuffer;this._renderTerrainDepth(s),t.update(i=>this._renderNodes(It.OPAQUE,i,e)),this.fboCache.debugCallback?.(It.OPAQUE,t.color.fbo),t.update(i=>this._renderNodes(ne.OPAQUE_ENVIRONMENT,i)),this.fboCache.debugCallback?.(ne.OPAQUE_ENVIRONMENT,t.color.fbo),this._renderEdges(1)}_renderTransparent(s,e,t){const i=this._framebuffer;i.bind(),this._renderPlugins(20,jt.VOXEL),this._renderHiddenTransparentEdges(),s&&(this._oitEnabled?this._renderOIT(0,t):this._renderTransparentGeometry()),i.update(a=>this._renderNodes(It.TRANSPARENT,a,s)),this.fboCache.debugCallback?.(It.TRANSPARENT,i.color.fbo),this._renderGeometryDepth(e),this._renderHUDVisibility(),e||this._plugins.render(15),this._renderEdges(0);const r=this._hasTransparentTerrain?this._renderTransparentTerrain():null;r&&(this.performanceInfo.advance(jt.TRANSPARENT_TERRAIN),this._bindParameters.hudVisibility&&(e?this._renderLineCallouts(0):(this._rctx.bindFramebuffer(this._bindParameters.hudVisibility?.fbo),this._compositingHelper.compositeHUD(this._bindParameters,r.getTexture())),this._renderHUD(0,i.color,t))),this._bindParameters.cullAboveTerrain=!1,r&&(i.bind(),this._compositingHelper.compositePreMultipliedAlpha(this._bindParameters,r.getTexture(),yy(t)?1:0),r.release(),e&&(this._renderEdges(1),s&&(this._oitEnabled?this._renderOIT(0,t):this._renderTransparentGeometry(),this.performanceInfo.advance(jt.TRANSPARENT)),this._renderEdges(0)));const n=this._hasTransparentIntegratedMesh?this._renderTransparentIntegratedMesh():null;n&&(i.bind(),this._compositingHelper.composite(this._bindParameters,n.getTexture(),yy(t)?1:0),n.release()),this._bindParameters.ssao=Nt(this._bindParameters.ssao),e&&this._renderLineCallouts(1),this._bindParameters.terrainDepthTest=!1,this._renderTransparentEnvironment()}_renderTransparentEnvironment(){this._shadowAccumulator.render(this._bindParameters),this.performanceInfo.advance(jt.APPLY_ACCUMULATED_SHADOWS),this._framebuffer.bind(),this._plugins.render(8),this.performanceInfo.advance(jt.TRANSPARENT_MATERIAL_WITHOUT_DEPTH)}_renderPlugins(s,e){this._plugins.produces(this._renderContext.output,s)&&(this._plugins.render(s),this.performanceInfo.advance(e))}_renderNodes(s,e,t=!1){if(e.setName(s),this._pluginInput.set(s,e),!this._nodes.produces(s))return t&&this.performanceInfo.advance(s),e;const i=this._nodes.render(e,this._pluginInput,this._releaseNormals);return this.performanceInfo.advance(s),i}blitFBO(s,e=cu,t=!0){return this._blit??=new cx(this._techniques),this._blit.blit(this._rctx,s,e,this._bindParameters),this._pluginInput.set(s.name,e),t&&s.release(),e}_ensureBindParametersCamera(s,e){this._bindParameters.camera=s,this._bindParameters.contentCamera=e}_ensureBindParametersSSR(s){if(this._bindParameters.ssr.lastFrameColor){this._ssrEnableTime==null&&(this._ssrEnableTime=s),this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=_n:(eu(aM,this._bindParameters.camera.viewMatrix),eu(nM,this._bindParameters.camera.projectionMatrix),as(Xc,aM,nM),as(Xc,this._renderContext.lastFrameCamera.viewMatrix,Xc),as(Xc,this._renderContext.lastFrameCamera.projectionMatrix,Xc),this._reprojectionMatrix=Xc);const e=this.stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=e>0?Math.min(e,s-this._ssrEnableTime)/e:1,this._bindParameters.ssr.fadeFactor<1&&this._requestRender()}else this._reprojectionMatrix=_n,this._ssrEnableTime=null}addRenderNode(s){this._nodes.add(s),this._requestRender()}removeRenderNode(s){this._nodes.remove(s),this._requestRender()}updateLighting(s,e,t,i){this._bindParameters.updateLighting(s,e,t,i),this._requestRender(1)}get usedMemory(){return{fbos:this.fboCache.usedMemory,plugins:this._plugins.usedMemory,edges:this.edgeView?.usedMemory??0}}renderToTargets(s,e,t,i,r=!1,n=!1){e.attachDepth(t),this._rctx.bindFramebuffer(e.fbo),this._rctx.clearFramebuffer(i,r,n),s(),e.detachDepth()}get test(){}};u([p({readOnly:!0})],_h.prototype,"fullResolutionAtmosphere",null),u([p()],_h.prototype,"_edgeView",void 0),u([p()],_h.prototype,"updating",null),_h=u([R("esri.views.3d.webgl-engine.lib.Renderer")],_h);const WY=[0,1,2,4],QY=[3,5],c0=[0,1,2,3],ed=[4,5],rM=[2,4,8],td=[16,13,14],ZY=[4,5,2,3,6,0,1],nM=Ie(),aM=Ie(),Xc=Ie();function XY(s){return e=>s.immediate.schedule(e)}let YY=class{constructor(e){this._rctx=e,this._vao=KY(e)}destroy(){this._vao=_e(this._vao)}draw(){this._vao!=null&&(this._rctx.bindVAO(this._vao),this._rctx.drawArrays(Ct.TRIANGLES,0,3))}get test(){}};function KY(s){const e=new Float32Array([-1,-1,3,-1,-1,3]);return new Mn(s,new Kt(s,n$,e))}let JY=class{constructor(e,t){this._rctx=e,this._layout=t,this._cache=new Xp(e.newCache,"VAOCache")}dispose(){this._cache.destroy()}newVao(e){const t=e.toString();let i=this._cache.pop(t);return i||(i=new Mn(this._rctx,new Kt(this._rctx,this._layout)),i.buffer()?.setSize(e),i)}deleteVao(e){if(e==null)return;const t=e.getByteLength("geometry").toString();this._cache.put(t,e)}},D3=class E3{constructor(e){this._rctx=e,this._indexBuffer=this._createIndexbuffer(),this._program=this._createHelperProgram()}static getShaderSources(){return{vertex:`#version 300 es
    precision highp float;

    void main(void) {
      gl_Position = vec4(0.0, 0.0, float(gl_VertexID)-2.0, 1.0);
    }`,fragment:`#version 300 es
    precision highp float;

    out vec4 fragColor;

    void main(void) {
      fragColor = vec4(0.0, 0.0, 0.0, 1.0);
    }`}}_createHelperProgram(){const e=E3.getShaderSources();return this._rctx.programCache.acquire(e.vertex,e.fragment,new Map([]))}_createIndexbuffer(){return Nr.createIndex(this._rctx,35044,new Uint32Array([0]))}run(){this._program.compiled&&this._indexBuffer&&(this._rctx.bindVAO(null),this._rctx.useProgram(this._program),this._rctx.bindBuffer(this._indexBuffer,34963),this._rctx.drawElements(Ct.POINTS,1,Cn.UNSIGNED_INT,0))}dispose(){this._program.dispose(),this._indexBuffer.dispose()}get test(){}},oM=class{constructor(){this.blend=!1,this.blendColor={r:0,g:0,b:0,a:0},this.blendFunction={srcRGB:1,dstRGB:0,srcAlpha:1,dstAlpha:0},this.blendEquation={mode:32774,modeAlpha:32774},this.colorMask={r:!0,g:!0,b:!0,a:!0},this.faceCulling=!1,this.cullFace=1029,this.frontFace=2305,this.scissorTest=!1,this.scissorRect={x:0,y:0,width:0,height:0},this.depthTest=!1,this.depthFunction=513,this.clearDepth=1,this.depthWrite=!0,this.depthRange={zNear:0,zFar:1},this.viewport=null,this.stencilTest=!1,this.polygonOffsetFill=!1,this.polygonOffset=[0,0],this.stencilFunction={face:1032,func:519,ref:0,mask:1},this.clearStencil=0,this.stencilWriteMask=1,this.stencilOperation={face:1032,fail:7680,zFail:7680,zPass:7680},this.clearColor={r:0,g:0,b:0,a:0},this.program=null,this.vertexBuffer=null,this.indexBuffer=null,this.uniformBuffer=null,this.pixelPackBuffer=null,this.pixelUnpackBuffer=null,this.copyReadBuffer=null,this.copyWriteBuffer=null,this.transformFeedbackBuffer=null,this.uniformBufferBindingPoints=new Array,this.transformBufferBindingPoints=new Array,this.readFramebuffer=null,this.drawFramebuffer=null,this.drawBuffers={defaultFramebuffer:[th],fbos:new WeakMap},this.renderbuffer=null,this.activeTexture=0,this.textureUnitMap=new Array,this.vertexArrayObject=null}},eK=class{constructor(){for(this._current=new Array,this._allocations=null;this._current.length<gi.COUNT;)this._current.push(0)}increment(e,t,i=1){this._current[e]+=i,this._allocations?.add(t)}decrement(e,t,i=1){this._current[e]-=i,this._allocations?.remove(t)}get current(){return this._current}get total(){return this.current.reduce((e,t,i)=>e+(i<gi.UNCOUNTED?t:0),0)}get resourceInformation(){let e="";if(this.total>0){e+=`Live objects:
`;for(let t=0;t<gi.COUNT;++t){const i=this._current[t];i>0&&(e+=`${CI(gi,t)}: ${i}
`)}}return e+=this._allocations?.resetLog(),e}},lM=class{constructor(e,t,i){const r=t.textureFilterAnisotropic;this.versionString=e.getParameter(e.VERSION),this.maxVertexTextureImageUnits=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.maxVertexAttributes=e.getParameter(e.MAX_VERTEX_ATTRIBS);const n=i.maxAnisotropy;this.maxMaxAnisotropy=r?Math.min(e.getParameter(r.MAX_TEXTURE_MAX_ANISOTROPY),n):1,this.maxTextureImageUnits=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this.maxPreferredTexturePixels=i.maxPreferredTexturePixels,this.maxRenderbufferSize=e.getParameter(e.MAX_RENDERBUFFER_SIZE),this.maxViewportDims=e.getParameter(e.MAX_VIEWPORT_DIMS),this.maxUniformBufferBindings=e.getParameter(e.MAX_UNIFORM_BUFFER_BINDINGS),this.maxVertexUniformBlocks=e.getParameter(e.MAX_VERTEX_UNIFORM_BLOCKS),this.maxFragmentUniformBlocks=e.getParameter(e.MAX_FRAGMENT_UNIFORM_BLOCKS),this.maxUniformBlockSize=e.getParameter(e.MAX_UNIFORM_BLOCK_SIZE),this.uniformBufferOffsetAlignment=e.getParameter(e.UNIFORM_BUFFER_OFFSET_ALIGNMENT),this.maxArrayTextureLayers=e.getParameter(e.MAX_ARRAY_TEXTURE_LAYERS),this.maxSamples=e.getParameter(e.MAX_SAMPLES),this.maxDrawBuffers=e.getParameter(e.MAX_DRAW_BUFFERS)}};const tK=["layout","centroid","smooth","case","mat2x2","mat2x3","mat2x4","mat3x2","mat3x3","mat3x4","mat4x2","mat4x3","mat4x4","uint","uvec2","uvec3","uvec4","samplerCubeShadow","sampler2DArray","sampler2DArrayShadow","isampler2D","isampler3D","isamplerCube","isampler2DArray","usampler2D","usampler3D","usamplerCube","usampler2DArray","coherent","restrict","readonly","writeonly","resource","atomic_uint","noperspective","patch","sample","subroutine","common","partition","active","filter","image1D","image2D","image3D","imageCube","iimage1D","iimage2D","iimage3D","iimageCube","uimage1D","uimage2D","uimage3D","uimageCube","image1DArray","image2DArray","iimage1DArray","iimage2DArray","uimage1DArray","uimage2DArray","image1DShadow","image2DShadow","image1DArrayShadow","image2DArrayShadow","imageBuffer","iimageBuffer","uimageBuffer","sampler1DArray","sampler1DArrayShadow","isampler1D","isampler1DArray","usampler1D","usampler1DArray","isampler2DRect","usampler2DRect","samplerBuffer","isamplerBuffer","usamplerBuffer","sampler2DMS","isampler2DMS","usampler2DMS","sampler2DMSArray","isampler2DMSArray","usampler2DMSArray","trunc","round","roundEven","isnan","isinf","floatBitsToInt","floatBitsToUint","intBitsToFloat","uintBitsToFloat","packSnorm2x16","unpackSnorm2x16","packUnorm2x16","unpackUnorm2x16","packHalf2x16","unpackHalf2x16","outerProduct","transpose","determinant","inverse","texture","textureSize","textureProj","textureLod","textureOffset","texelFetch","texelFetchOffset","textureProjOffset","textureLodOffset","textureProjLod","textureProjLodOffset","textureGrad","textureGradOffset","textureProjGrad","textureProjGradOffset"],iK=["precision","highp","mediump","lowp","attribute","const","uniform","varying","break","continue","do","for","while","if","else","in","out","inout","float","int","void","bool","true","false","discard","return","mat2","mat3","mat4","vec2","vec3","vec4","ivec2","ivec3","ivec4","uvec2","uvec3","uvec4","bvec2","bvec3","bvec4","sampler1D","sampler2D","sampler3D","usampler1D","usampler2D","usampler3D","samplerCube","sampler1DShadow","sampler2DShadow","struct","asm","class","union","enum","typedef","template","this","packed","goto","switch","default","inline","noinline","volatile","public","static","extern","external","interface","long","short","double","half","fixed","unsigned","input","output","hvec2","hvec3","hvec4","dvec2","dvec3","dvec4","fvec2","fvec3","fvec4","sampler2DRect","sampler3DRect","sampler2DRectShadow","sizeof","cast","namespace","using"],cM=["<<=",">>=","++","--","<<",">>","<=",">=","==","!=","&&","||","+=","-=","*=","/=","%=","&=","^^","^=","|=","(",")","[","]",".","!","~","*","/","%","+","-","<",">","&","^","|","?",":","=",",",";","{","}"],sK=["abs","acos","all","any","asin","atan","ceil","clamp","cos","cross","dFdx","dFdy","degrees","distance","dot","equal","exp","exp2","faceforward","floor","fract","gl_BackColor","gl_BackLightModelProduct","gl_BackLightProduct","gl_BackMaterial","gl_BackSecondaryColor","gl_ClipPlane","gl_ClipVertex","gl_Color","gl_DepthRange","gl_DepthRangeParameters","gl_EyePlaneQ","gl_EyePlaneR","gl_EyePlaneS","gl_EyePlaneT","gl_Fog","gl_FogCoord","gl_FogFragCoord","gl_FogParameters","gl_FragColor","gl_FragCoord","gl_FragData","gl_FragDepth","gl_FragDepthEXT","gl_FrontColor","gl_FrontFacing","gl_FrontLightModelProduct","gl_FrontLightProduct","gl_FrontMaterial","gl_FrontSecondaryColor","gl_LightModel","gl_LightModelParameters","gl_LightModelProducts","gl_LightProducts","gl_LightSource","gl_LightSourceParameters","gl_MaterialParameters","gl_MaxClipPlanes","gl_MaxCombinedTextureImageUnits","gl_MaxDrawBuffers","gl_MaxFragmentUniformComponents","gl_MaxLights","gl_MaxTextureCoords","gl_MaxTextureImageUnits","gl_MaxTextureUnits","gl_MaxVaryingFloats","gl_MaxVertexAttribs","gl_MaxVertexTextureImageUnits","gl_MaxVertexUniformComponents","gl_ModelViewMatrix","gl_ModelViewMatrixInverse","gl_ModelViewMatrixInverseTranspose","gl_ModelViewMatrixTranspose","gl_ModelViewProjectionMatrix","gl_ModelViewProjectionMatrixInverse","gl_ModelViewProjectionMatrixInverseTranspose","gl_ModelViewProjectionMatrixTranspose","gl_MultiTexCoord0","gl_MultiTexCoord1","gl_MultiTexCoord2","gl_MultiTexCoord3","gl_MultiTexCoord4","gl_MultiTexCoord5","gl_MultiTexCoord6","gl_MultiTexCoord7","gl_Normal","gl_NormalMatrix","gl_NormalScale","gl_ObjectPlaneQ","gl_ObjectPlaneR","gl_ObjectPlaneS","gl_ObjectPlaneT","gl_Point","gl_PointCoord","gl_PointParameters","gl_PointSize","gl_Position","gl_ProjectionMatrix","gl_ProjectionMatrixInverse","gl_ProjectionMatrixInverseTranspose","gl_ProjectionMatrixTranspose","gl_SecondaryColor","gl_TexCoord","gl_TextureEnvColor","gl_TextureMatrix","gl_TextureMatrixInverse","gl_TextureMatrixInverseTranspose","gl_TextureMatrixTranspose","gl_Vertex","greaterThan","greaterThanEqual","inversesqrt","length","lessThan","lessThanEqual","log","log2","matrixCompMult","max","min","mix","mod","normalize","not","notEqual","pow","radians","reflect","refract","sign","sin","smoothstep","sqrt","step","tan","texture2D","texture2DLod","texture2DProj","texture2DProjLod","textureCube","textureCubeLod","texture2DLodEXT","texture2DProjLodEXT","textureCubeLodEXT","texture2DGradEXT","texture2DProjGradEXT","textureCubeGradEXT","textureSize","texelFetch"];var en=999,hM=9999,h0=0,u0=1,uM=2,dM=3,pM=4,_f=5,rK=6,nK=7,aK=8,mM=9,oK=10,fM=11,lK=["block-comment","line-comment","preprocessor","operator","integer","float","ident","builtin","keyword","whitespace","eof","integer"];function cK(){var s,e,t,i=0,r=0,n=en,a=[],o=[],l=1,c=0,h=0,d=!1,m=!1,f="";return function(E){return o=[],E!==null?_(E.replace?E.replace(/\r\n/g,`
`):E):v()};function g(E){E.length&&o.push({type:lK[n],data:E,position:h,line:l,column:c})}function _(E){var z;for(i=0,t=(f+=E).length;s=f[i],i<t;){switch(z=i,n){case h0:i=C();break;case u0:i=S();break;case uM:i=w();break;case dM:i=P();break;case pM:i=D();break;case fM:i=O();break;case _f:i=A();break;case hM:i=F();break;case mM:i=T();break;case en:i=b()}z!==i&&(f[z]===`
`?(c=0,++l):++c)}return r+=i,f=f.slice(i),o}function v(E){return a.length&&g(a.join("")),n=oK,g("(eof)"),o}function b(){return a=a.length?[]:a,e==="/"&&s==="*"?(h=r+i-1,n=h0,e=s,i+1):e==="/"&&s==="/"?(h=r+i-1,n=u0,e=s,i+1):s==="#"?(n=uM,h=r+i,i):/\s/.test(s)?(n=mM,h=r+i,i):(d=/\d/.test(s),m=/[^\w_]/.test(s),h=r+i,n=d?pM:m?dM:hM,i)}function T(){return/[^\s]/g.test(s)?(g(a.join("")),n=en,i):(a.push(s),e=s,i+1)}function w(){return s!=="\r"&&s!==`
`||e==="\\"?(a.push(s),e=s,i+1):(g(a.join("")),n=en,i)}function S(){return w()}function C(){return s==="/"&&e==="*"?(a.push(s),g(a.join("")),n=en,i+1):(a.push(s),e=s,i+1)}function P(){if(e==="."&&/\d/.test(s))return n=_f,i;if(e==="/"&&s==="*")return n=h0,i;if(e==="/"&&s==="/")return n=u0,i;if(s==="."&&a.length){for(;M(a););return n=_f,i}if(s===";"||s===")"||s==="("){if(a.length)for(;M(a););return g(s),n=en,i+1}var E=a.length===2&&s!=="=";if(/[\w_\d\s]/.test(s)||E){for(;M(a););return n=en,i}return a.push(s),e=s,i+1}function M(E){for(var z,L,I=0;;){if(z=cM.indexOf(E.slice(0,E.length+I).join("")),L=cM[z],z===-1){if(I--+E.length>0)continue;L=E.slice(0,1).join("")}return g(L),h+=L.length,(a=a.slice(L.length)).length}}function O(){return/[^a-fA-F0-9]/.test(s)?(g(a.join("")),n=en,i):(a.push(s),e=s,i+1)}function D(){return s==="."||/[eE]/.test(s)?(a.push(s),n=_f,e=s,i+1):s==="x"&&a.length===1&&a[0]==="0"?(n=fM,a.push(s),e=s,i+1):/[^\d]/.test(s)?(g(a.join("")),n=en,i):(a.push(s),e=s,i+1)}function A(){return s==="f"&&(a.push(s),e=s,i+=1),/[eE]/.test(s)||s==="-"&&/[eE]/.test(e)?(a.push(s),e=s,i+1):/[^\d]/.test(s)?(g(a.join("")),n=en,i):(a.push(s),e=s,i+1)}function F(){if(/[^\d\w_]/.test(s)){var E=a.join("");return n=iK.indexOf(E)>-1?aK:sK.indexOf(E)>-1?nK:rK,g(a.join("")),n=en,i}return a.push(s),e=s,i+1}}function hK(s){var e=cK(),t=[];return t=(t=t.concat(e(s))).concat(e(null))}function uK(s){return hK(s)}function dK(s){return s.map(e=>e.type!=="eof"?e.data:"").join("")}const d0=new Set(["GL_OES_standard_derivatives","GL_EXT_frag_depth","GL_EXT_draw_buffers","GL_EXT_shader_texture_lod"]);function pK(s,e="100",t="300 es"){const i=/^\s*#version\s+([0-9]+(\s+[a-zA-Z]+)?)\s*/;for(const r of s)if(r.type==="preprocessor"){const n=i.exec(r.data);if(n){const a=n[1].replaceAll(/\s{2,}/g," ");if(a===t)return a;if(a===e)return r.data="#version "+t,e;throw new Error("unknown glsl version: "+a)}}return s.splice(0,0,{type:"preprocessor",data:"#version "+t},{type:"whitespace",data:`
`}),null}function mK(s,e){for(let t=e-1;t>=0;t--){const i=s[t];if(i.type!=="whitespace"&&i.type!=="block-comment"){if(i.type!=="keyword")break;if(i.data==="attribute"||i.data==="in")return!0}}return!1}function kd(s,e,t,i){i=i||t;for(const r of s)if(r.type==="ident"&&r.data===t)return i in e?e[i]++:e[i]=0,kd(s,e,i+"_"+e[i],i);return t}function A3(s,e,t="afterVersion"){function i(l,c){for(let h=c;h<l.length;h++){const d=l[h];if(d.type==="operator"&&d.data===";")return h}return null}function r(l){let c=-1,h=0,d=-1;for(let m=0;m<l.length;m++){const f=l[m];if(f.type==="preprocessor"&&(/#(if|ifdef|ifndef)\s+.+/.test(f.data)?++h:/#endif\s*.*/.test(f.data)&&--h),t!=="afterVersion"&&t!=="afterPrecision"||f.type==="preprocessor"&&f.data.startsWith("#version")&&(d=Math.max(d,m)),t==="afterPrecision"&&f.type==="keyword"&&f.data==="precision"){const g=i(l,m);if(g===null)throw new Error("precision statement not followed by any semicolons!");d=Math.max(d,g)}c<d&&h===0&&(c=m)}return c+1}const n={data:`
`,type:"whitespace"},a=l=>l<s.length&&/[^\r\n]$/.test(s[l].data);let o=r(s);a(o-1)&&s.splice(o++,0,n);for(const l of e)s.splice(o++,0,l);a(o-1)&&a(o)&&s.splice(o,0,n)}function fK(s,e,t,i="lowp"){A3(s,[{type:"keyword",data:"out"},{type:"whitespace",data:" "},{type:"keyword",data:i},{type:"whitespace",data:" "},{type:"keyword",data:t},{type:"whitespace",data:" "},{type:"ident",data:e},{type:"operator",data:";"}],"afterPrecision")}function gK(s,e,t,i,r="lowp"){A3(s,[{type:"keyword",data:"layout"},{type:"operator",data:"("},{type:"keyword",data:"location"},{type:"whitespace",data:" "},{type:"operator",data:"="},{type:"whitespace",data:" "},{type:"integer",data:i.toString()},{type:"operator",data:")"},{type:"whitespace",data:" "},{type:"keyword",data:"out"},{type:"whitespace",data:" "},{type:"keyword",data:r},{type:"whitespace",data:" "},{type:"keyword",data:t},{type:"whitespace",data:" "},{type:"ident",data:e},{type:"operator",data:";"}],"afterPrecision")}function _K(s,e){let t,i,r=-1;for(let n=e;n<s.length;n++){const a=s[n];if(a.type==="operator"&&(a.data==="["&&(t=n),a.data==="]")){i=n;break}a.type==="integer"&&(r=parseInt(a.data,10))}return t&&i&&s.splice(t,i-t+1),r}function gM(s,e){if(s.startsWith("#version 300"))return s;const t=uK(s);if(pK(t,"100","300 es")==="300 es")return s;let i=null,r=null;const n={},a={};for(let o=0;o<t.length;++o){const l=t[o];switch(l.type){case"keyword":e===35633&&l.data==="attribute"?l.data="in":l.data==="varying"&&(l.data=e===35633?"out":"in");break;case"builtin":if(/^texture(2D|Cube)(Proj)?(Lod|Grad)?(EXT)?$/.test(l.data.trim())&&(l.data=l.data.replaceAll(/(2D|Cube|EXT)/g,"")),e===35632&&l.data==="gl_FragColor"&&(i||(i=kd(t,n,"fragColor"),fK(t,i,"vec4")),l.data=i),e===35632&&l.data==="gl_FragData"){const c=_K(t,o+1),h=kd(t,n,"fragData");gK(t,h,"vec4",c,"mediump"),l.data=h}else e===35632&&l.data==="gl_FragDepthEXT"&&(r||(r=kd(t,n,"gl_FragDepth")),l.data=r);break;case"ident":if(tK.includes(l.data)){if(e===35633&&mK(t,o))throw new Error("attribute in vertex shader uses a name that is a reserved word in glsl 300 es");l.data in a||(a[l.data]=kd(t,n,l.data)),l.data=a[l.data]}}}for(let o=t.length-1;o>=0;--o){const l=t[o];if(l.type==="preprocessor"){const c=l.data.match(/#extension\s+(.*):/);if(c?.[1]&&d0.has(c[1].trim())){const m=t[o+1];t.splice(o,m&&m.type==="whitespace"?2:1)}const h=l.data.match(/#ifdef\s+(.*)/);h?.[1]&&d0.has(h[1].trim())&&(l.data="#if 1");const d=l.data.match(/#ifndef\s+(.*)/);d?.[1]&&d0.has(d[1].trim())&&(l.data="#if 0")}}return yK(s,dK(t))}function yK(s,e){return e}const vK=4294967295,bK=!!Ze("esri-tests-disable-gpu-memory-measurements");let wK=class{constructor(e,t,i,r,n=new Map,a=[]){this._context=e,this._refCount=1,this._compiled=!1,this._linesOfCode=0,this._nameToUniformLocation=new Map,this._nameToUniform1=new Map,this._nameToUniform1v=new Map,this._nameToUniform2=new Map,this._nameToUniform3=new Map,this._nameToUniform4=new Map,this._nameToUniformMatrix3=new Map,this._nameToUniformMatrix4=new Map,e||console.error("RenderingContext isn't initialized!"),t.length===0&&console.error("Shaders source should not be empty!"),t=gM(t,35633),i=gM(i,35632),this._vShader=_M(this._context,35633,t),this._fShader=_M(this._context,35632,i),this._vShader&&this._fShader||console.error("Error loading shaders!"),e.instanceCounter.increment(gi.Shader,this),S0()&&(this.vertexShader=t,this.fragmentShader=i),this.usedMemory=bK?0:t.length+i.length;const o=this._context.gl,l=o.createProgram();o.attachShader(l,this._vShader),o.attachShader(l,this._fShader),r.forEach((c,h)=>o.bindAttribLocation(l,c,h)),this.hasTransformFeedbackVaryings=!!a?.length,this.hasTransformFeedbackVaryings&&o.transformFeedbackVaryings(l,a,o.SEPARATE_ATTRIBS),o.linkProgram(l),S0()&&!o.getProgramParameter(l,o.LINK_STATUS)&&console.error(`Could not link shader
validated: ${o.getProgramParameter(l,o.VALIDATE_STATUS)}, gl error ${o.getError()}, vertex: ${o.getShaderParameter(this._vShader,o.COMPILE_STATUS)}, fragment: ${o.getShaderParameter(this._fShader,o.COMPILE_STATUS)}, info log: ${o.getProgramInfoLog(l)}, vertex source: ${this.vertexShader}, fragment source: ${this.fragmentShader}`);for(const[c,h]of n){const d=o.getUniformBlockIndex(l,c);d<vK&&o.uniformBlockBinding(l,d,h)}this._glName=l,e.instanceCounter.increment(gi.Program,this)}get glName(){return this._glName}get hasGLName(){return this._glName!=null}get compiled(){return!!this._compiled||(this._context.capabilities.parallelShaderCompile&&this.glName!=null?(this._compiled=!!this._context.gl.getProgramParameter(this.glName,37297),this._compiled):(this._compiled=!0,!0))}dispose(){if(--this._refCount>0)return;const e=this._context.gl,t=this._context.instanceCounter;this._nameToUniformLocation.forEach(i=>i&&t.decrement(gi.Uniform,i)),this._nameToUniformLocation.clear(),this._vShader&&(this._linesOfCode>0&&(t.decrement(gi.LinesOfCode,this._vShader,this._linesOfCode),this._linesOfCode=0),e.deleteShader(this._vShader),this._vShader=null,t.decrement(gi.Shader,this)),this._fShader&&(e.deleteShader(this._fShader),this._fShader=null),this._glName&&(e.deleteProgram(this._glName),this._glName=null,t.decrement(gi.Program,this))}ref(){++this._refCount}_getUniformLocation(e){const t=this._nameToUniformLocation.get(e);if(t!==void 0)return t;if(this.glName){const i=this._context.gl.getUniformLocation(this.glName,e);return this._nameToUniformLocation.set(e,i),i&&this._context.instanceCounter.increment(gi.Uniform,i),i}return null}hasUniform(e){return this._getUniformLocation(e)!=null}setUniform1i(e,t,i){id(i,t);const r=this._nameToUniform1.get(e);r!==void 0&&t===r||(this._context.gl.uniform1i(this._getUniformLocation(e),t),this._nameToUniform1.set(e,t))}setUniform1iv(e,t,i){xr(i,t),Fn(this._nameToUniform1v,e,t)&&this._context.gl.uniform1iv(this._getUniformLocation(e),t)}setUniform2iv(e,t,i){xr(i,t),Fn(this._nameToUniform2,e,t)&&this._context.gl.uniform2iv(this._getUniformLocation(e),t)}setUniform3iv(e,t,i){xr(i,t),Fn(this._nameToUniform3,e,t)&&this._context.gl.uniform3iv(this._getUniformLocation(e),t)}setUniform4iv(e,t,i){xr(i,t),Fn(this._nameToUniform4,e,t)&&this._context.gl.uniform4iv(this._getUniformLocation(e),t)}setUniform1f(e,t,i){id(i,t);const r=this._nameToUniform1.get(e);r!==void 0&&t===r||(this._context.gl.uniform1f(this._getUniformLocation(e),t),this._nameToUniform1.set(e,t))}setUniform1fv(e,t,i){xr(i,t),Fn(this._nameToUniform1v,e,t)&&this._context.gl.uniform1fv(this._getUniformLocation(e),t)}setUniform2f(e,t,i,r){id(r,t,i);const n=this._nameToUniform2.get(e);n===void 0?(this._context.gl.uniform2f(this._getUniformLocation(e),t,i),this._nameToUniform2.set(e,[t,i])):t===n[0]&&i===n[1]||(this._context.gl.uniform2f(this._getUniformLocation(e),t,i),n[0]=t,n[1]=i)}setUniform2fv(e,t,i){xr(i,t),Fn(this._nameToUniform2,e,t)&&this._context.gl.uniform2fv(this._getUniformLocation(e),t)}setUniform3f(e,t,i,r,n){id(n,t,i,r);const a=this._nameToUniform3.get(e);a===void 0?(this._context.gl.uniform3f(this._getUniformLocation(e),t,i,r),this._nameToUniform3.set(e,[t,i,r])):t===a[0]&&i===a[1]&&r===a[2]||(this._context.gl.uniform3f(this._getUniformLocation(e),t,i,r),a[0]=t,a[1]=i,a[2]=r)}setUniform3fv(e,t,i){xr(i,t);const r=this._getUniformLocation(e);r!=null&&Fn(this._nameToUniform3,e,t)&&this._context.gl.uniform3fv(r,t)}setUniform4f(e,t,i,r,n,a){id(a,t,i,r,n);const o=this._nameToUniform4.get(e);o===void 0?(this._context.gl.uniform4f(this._getUniformLocation(e),t,i,r,n),this._nameToUniform4.set(e,[t,i,r,n])):o!==void 0&&t===o[0]&&i===o[1]&&r===o[2]&&n===o[3]||(this._context.gl.uniform4f(this._getUniformLocation(e),t,i,r,n),o[0]=t,o[1]=i,o[2]=r,o[3]=n)}setUniform4fv(e,t,i){xr(i,t);const r=this._getUniformLocation(e);r!=null&&Fn(this._nameToUniform4,e,t)&&this._context.gl.uniform4fv(r,t)}setUniformMatrix3fv(e,t,i=!1,r){xr(r,t);const n=this._getUniformLocation(e);n!=null&&Fn(this._nameToUniformMatrix3,e,t)&&this._context.gl.uniformMatrix3fv(n,i,t)}setUniformMatrix4fv(e,t,i=!1,r){xr(r,t);const n=this._getUniformLocation(e);if(n!=null){const a=this._nameToUniformMatrix4,o=a.get(e);let l=!1;if(o){const c=t.length;if(o.length!==c)a.set(e,Array.from(t)),l=!0;else for(let h=0;h<c;++h){const d=t[h];if(o[h]!==d){for(o[h]=d;h<c;++h)o[h]=t[h];l=!0;break}}}else a.set(e,Array.from(t)),l=!0;l&&this._context.gl.uniformMatrix4fv(n,i,t)}}setUniformMatrices4fv(e,t,i=!1,r){xr(r,t);const n=this._getUniformLocation(e);n!=null&&Fn(this._nameToUniformMatrix4,e,t)&&this._context.gl.uniformMatrix4fv(n,i,t)}stop(){}};function _M(s,e,t){const i=s.gl,r=i.createShader(e);return i.shaderSource(r,t),i.compileShader(r),S0()&&!i.getShaderParameter(r,i.COMPILE_STATUS)&&(console.error("Compile error in ".concat(e===35633?"vertex":"fragment"," shader")),console.error(i.getShaderInfoLog(r)),console.error(xK(t))),r}function xK(s){let e=2;return s.replaceAll(`
`,()=>`
`+CK(e++)+":")}function CK(s){return s>=1e3?s.toString():("  "+s).slice(-3)}function Fn(s,e,t){const i=s.get(e);if(!i)return s.set(e,Array.from(t)),!0;const r=t.length;if(i.length!==r)return s.set(e,Array.from(t)),!0;for(let n=0;n<r;++n){const a=t[n];if(i[n]!==a){for(i[n]=a;n<r;++n)i[n]=t[n];return!0}}return!1}const id=ln()?(s,...e)=>xr(s,e):()=>{},xr=ln()?(s,e)=>{if(s?.supportsNaN)return;const t=e.length;for(let i=0;i<t;++i){const r=e[i];Number.isNaN(r)&&console.error(`Got ${r} as uniform value from ${new Error().stack}`)}}:()=>{};let TK=class{constructor(e){this._rctx=e,this._store=new Map}dispose(){this._store.forEach(e=>e.dispose()),this._store.clear()}acquire(e,t,i,r){const n=e+t+JSON.stringify(Array.from(i.entries())),a=this._store.get(n);if(a!=null)return a.ref(),a;const o=new wK(this._rctx,e,t,i,r);return o.ref(),this._store.set(n,o),o}get test(){}},wx=class{constructor(){this._result=!1}dispose(){this._program=_e(this._program)}get result(){return this._program!=null&&(this._result=this._test(this._program),this.dispose()),this._result}},SK=class extends wx{constructor(e){super(),this._rctx=e,this._helperProgram=null,Ze("mac")&&Ze("chrome")&&(this._program=this._prepareProgram(),this._helperProgram=this._prepareHelperProgram())}dispose(){super.dispose(),this._helperProgram?.dispose(),this._helperProgram=null}_test(e){const t=this._rctx,i=t.getBoundFramebufferObject(),{x:r,y:n,width:a,height:o}=t.getViewport();t.resetState();const l=new ft(1);l.wrapMode=33071,l.samplingMode=9728;const c=new jo(t,l),h=Nr.createIndex(this._rctx,35044,new Uint8Array([0]));t.bindFramebuffer(c),t.setViewport(0,0,1,1),t.useProgram(this._helperProgram),t.bindBuffer(h,34963),t.drawElements(Ct.POINTS,1,Cn.UNSIGNED_BYTE,0),t.useProgram(e),t.bindVAO(null),t.drawArrays(Ct.TRIANGLES,0,258);const d=new Uint8Array(4);return c.readPixels(0,0,1,1,6408,si.UNSIGNED_BYTE,d),t.setViewport(r,n,a,o),t.bindFramebuffer(i),c.dispose(),h.dispose(),d[0]===255}_prepareProgram(){const t=`#version 300 es
    precision highp float;

    out float triangleId;

    const vec3 triangleVertices[3] = vec3[3](vec3(-0.5, -0.5, 0.0), vec3(0.5, -0.5, 0.0), vec3(0.0, 0.5, 0.0));

    void main(void) {
      triangleId = floor(float(gl_VertexID)/3.0);

      vec3 position = triangleVertices[gl_VertexID % 3];
      float offset = triangleId / ${y.float(85)};
      position.z = 0.5 - offset;

      gl_Position = vec4(position, 1.0);
    }
    `,i=`#version 300 es
    precision highp float;

    in float triangleId;

    out vec4 fragColor;

    void main(void) {
      fragColor = triangleId == ${y.float(85)} ? vec4(0.0, 1.0, 0.0, 1.0) : vec4(1.0, 0.0, 0.0, 1.0);
    }
    `;return this._rctx.programCache.acquire(t,i,new Map([]))}_prepareHelperProgram(){const e=D3.getShaderSources();return this._rctx.programCache.acquire(e.vertex,e.fragment,new Map([]))}};const xx=[new mV("position",2,Cn.UNSIGNED_SHORT,0,4)],I3=Ya(xx);let PK=class extends wx{constructor(e){if(super(),this._rctx=e,!e.gl||!(e.capabilities.colorBufferFloat?.textureFloat&&e.capabilities.colorBufferFloat?.floatBlend))return;const t=`
    precision highp float;
    attribute vec2 position;

    void main() {
      gl_Position = vec4(position * 2.0 - 1.0, 0.0, 1.0);
    }
    `,i=`
     precision highp float;

     void main() {
      gl_FragColor = vec4(0.5, 0.5, 0.5, 0.5);
     }
    `;this._program=e.programCache.acquire(t,i,I3)}_test(e){const t=this._rctx,i=new ft(1);i.wrapMode=33071,i.dataType=si.FLOAT,i.internalFormat=Es.RGBA32F,i.samplingMode=9728;const r=new jo(t,i),n=new Kt(t,xx,new Uint16Array([0,0,1,0,0,1,1,1])),a=new Wa(t,n);t.gl.getError(),t.useProgram(e);const o=t.getBoundFramebufferObject(),{x:l,y:c,width:h,height:d}=t.getViewport();t.bindFramebuffer(r),t.setViewport(0,0,1,1),t.bindVAO(a),t.drawArrays(Ct.TRIANGLE_STRIP,0,4);const m=qe({blending:XL});t.setPipelineState(m),t.drawArrays(Ct.TRIANGLE_STRIP,0,4);const f=t.gl.getError();return t.setViewport(l,c,h,d),t.bindFramebuffer(o),a.dispose(),r.dispose(),f!==t.gl.INVALID_OPERATION||(console.warn("Device claims support for WebGL extension EXT_float_blend but does not support it. Using fall back."),!1)}},MK=class extends wx{constructor(e){super(),this._rctx=e;const t=`
    precision highp float;

    attribute vec2 position;
    varying vec2 v_uv;

    void main() {
      v_uv = position;
      gl_Position = vec4(position * 2.0 - 1.0, 0.0, 1.0);
    }
    `,i=`
    precision highp float;

    varying vec2 v_uv;

    uniform sampler2D u_texture;

    void main() {
      gl_FragColor = texture2D(u_texture, v_uv);
    }
    `;this._program=e.programCache.acquire(t,i,I3)}dispose(){super.dispose()}_test(e){const t=this._rctx;if(!t.gl)return e.dispose(),!0;const i=new ft(1);i.wrapMode=33071,i.samplingMode=9728;const r=new jo(t,i),n=new Kt(t,xx,new Uint16Array([0,0,1,0,0,1,1,1])),a=new Wa(t,n),o=new ft;o.samplingMode=9729,o.wrapMode=33071;const l=new bt(t,o,zd);t.useProgram(e),t.bindTexture(l,0),e.setUniform1i("u_texture",0);const c=t.getBoundFramebufferObject(),{x:h,y:d,width:m,height:f}=t.getViewport();t.bindFramebuffer(r),t.setViewport(0,0,1,1),t.setClearColor(0,0,0,0),t.setBlendingEnabled(!1),t.clear(16384),t.bindVAO(a),t.drawArrays(Ct.TRIANGLE_STRIP,0,4);const g=new Uint8Array(4);return r.readPixels(0,0,1,1,6408,si.UNSIGNED_BYTE,g),a.dispose(),r.dispose(),l.dispose(),t.setViewport(h,d,m,f),t.bindFramebuffer(c),g[0]!==255}};const zd=new Image;zd.src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='5' height='5' version='1.1' viewBox='0 0 5 5' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='5' height='5' fill='%23f00' fill-opacity='.5'/%3E%3C/svg%3E%0A",zd.width=5,zd.height=5,zd.decode();let $K=class{constructor(e){this.rctx=e,this.floatBufferBlend=new PK(e),this.svgPremultipliesAlpha=new MK(e),this.drawArraysRequiresIndicesTypeReset=new SK(e)}dispose(){this.svgPremultipliesAlpha.dispose(),this.floatBufferBlend.dispose(),this.drawArraysRequiresIndicesTypeReset.dispose()}};function RK(s,e){if(e.compressedTextureETC)return null;const t=s.getExtension("WEBGL_compressed_texture_etc");return t?{COMPRESSED_R11_EAC:t.COMPRESSED_R11_EAC,COMPRESSED_SIGNED_R11_EAC:t.COMPRESSED_SIGNED_R11_EAC,COMPRESSED_RG11_EAC:t.COMPRESSED_RG11_EAC,COMPRESSED_SIGNED_RG11_EAC:t.COMPRESSED_SIGNED_RG11_EAC,COMPRESSED_RGB8_ETC2:t.COMPRESSED_RGB8_ETC2,COMPRESSED_SRGB8_ETC2:t.COMPRESSED_SRGB8_ETC2,COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:t.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:t.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_RGBA8_ETC2_EAC:t.COMPRESSED_RGBA8_ETC2_EAC,COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:t.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC}:null}function OK(s,e){if(e.compressedTextureS3TC)return null;const t=s.getExtension("WEBGL_compressed_texture_s3tc");return t?{COMPRESSED_RGB_S3TC_DXT1:t.COMPRESSED_RGB_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT1:t.COMPRESSED_RGBA_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT3:t.COMPRESSED_RGBA_S3TC_DXT3_EXT,COMPRESSED_RGBA_S3TC_DXT5:t.COMPRESSED_RGBA_S3TC_DXT5_EXT}:null}function DK(s,e){if(e.textureFilterAnisotropic)return null;const t=s.getExtension("EXT_texture_filter_anisotropic")||s.getExtension("MOZ_EXT_texture_filter_anisotropic")||s.getExtension("WEBKIT_EXT_texture_filter_anisotropic");return t?{MAX_TEXTURE_MAX_ANISOTROPY:t.MAX_TEXTURE_MAX_ANISOTROPY_EXT,TEXTURE_MAX_ANISOTROPY:t.TEXTURE_MAX_ANISOTROPY_EXT}:null}function EK(s,e){const t=!e.colorBufferHalfFloat&&s.getExtension("EXT_color_buffer_half_float")||!e.colorBufferFloat&&s.getExtension("EXT_color_buffer_float"),i=!e.colorBufferFloat&&s.getExtension("EXT_color_buffer_float"),r=!e.floatBlend&&!e.colorBufferFloat&&s.getExtension("EXT_float_blend");return t||i||r?{textureFloat:!!i,textureHalfFloat:!!t,floatBlend:!!r,R16F:s.R16F,RG16F:s.RG16F,RGBA16F:s.RGBA16F,R32F:s.R32F,RG32F:s.RG32F,RGBA32F:s.RGBA32F,R11F_G11F_B10F:s.R11F_G11F_B10F,RGB16F:s.RGB16F}:null}function yM(s,e,t,i,r){if(e[t])return!1;for(const n of r)if(s.getExtension(n))return!0;return!1}function AK(s,e){if(e.textureNorm16)return null;const t=s.getExtension("EXT_texture_norm16");return t?{R16:t.R16_EXT,RG16:t.RG16_EXT,RGB16:t.RGB16_EXT,RGBA16:t.RGBA16_EXT,R16_SNORM:t.R16_SNORM_EXT,RG16_SNORM:t.RG16_SNORM_EXT,RGB16_SNORM:t.RGB16_SNORM_EXT,RGBA16_SNORM:t.RGBA16_SNORM_EXT}:null}function IK(s,e){const t=e.loseContext&&s.getExtension("WEBGL_lose_context");return t?{loseRenderingContext:()=>t.loseContext()}:null}let LK=class{constructor(e,t){this._gl=e,this._compressedTextureETC=null,this._compressedTextureS3TC=null,this._textureFilterAnisotropic=null,this._colorBufferFloat=null,this._loseContext=null,this._textureNorm16=null,this._textureFloatLinear=null,this._parallelShaderCompile=null,this._rendererInfo=null,this._disabledExtensions=t.disabledExtensions,this._debugWebGLExtensions=t.debugWebGLExtensions}get compressedTextureETC(){return this._compressedTextureETC??=RK(this._gl,this._disabledExtensions),this._compressedTextureETC}get compressedTextureS3TC(){return this._compressedTextureS3TC??=OK(this._gl,this._disabledExtensions),this._compressedTextureS3TC}get textureFilterAnisotropic(){return this._textureFilterAnisotropic??=DK(this._gl,this._disabledExtensions),this._textureFilterAnisotropic}get disjointTimerQuery(){return this._disjointTimerQuery??=HY(this._gl,this._disabledExtensions),this._disjointTimerQuery}get colorBufferFloat(){return this._colorBufferFloat??=EK(this._gl,this._disabledExtensions),this._colorBufferFloat}get textureNorm16(){return this._textureNorm16??=AK(this._gl,this._disabledExtensions),this._textureNorm16}get textureFloatLinear(){return this._textureFloatLinear??=yM(this._gl,this._disabledExtensions,"textureFloatLinear",!1,["OES_texture_float_linear"]),this._textureFloatLinear}get parallelShaderCompile(){return this._parallelShaderCompile??=yM(this._gl,this._disabledExtensions,"parallelShaderCompile",!1,["KHR_parallel_shader_compile"]),this._parallelShaderCompile}get loseContext(){return this._loseContext??=IK(this._gl,this._debugWebGLExtensions),this._loseContext}get rendererInfo(){return this._rendererInfo??=q4(this._gl),this._rendererInfo}enable(e){return this[e]}},FK=class{constructor(s,e){this.gl=s,this.instanceCounter=new eK,this._programCache=new TK(this),this._transformFeedbackRequestInfo=null,this._state=new oM,this._numOfDrawCalls=0,this._numOfTriangles=0,this._options=e,this.configure(e)}configure(s){this._options=s,this._capabilities=new LK(this.gl,s),this._parameters=new lM(this.gl,this._capabilities,s),bt.TEXTURE_UNIT_FOR_UPDATES=this._parameters.maxTextureImageUnits-1;const e=this.gl.getParameter(this.gl.VIEWPORT);this._state=new oM,this._state.viewport={x:e[0],y:e[1],width:e[2],height:e[3]},this._stateTracker=new YL({setBlending:t=>{if(t){this.setBlendingEnabled(!0),this.setBlendEquationSeparate(t.opRgb,t.opAlpha),this.setBlendFunctionSeparate(t.srcRgb,t.dstRgb,t.srcAlpha,t.dstAlpha);const i=t.color;this.setBlendColor(i.r,i.g,i.b,i.a)}else this.setBlendingEnabled(!1)},setCulling:t=>{t?(this.setFaceCullingEnabled(!0),this.setCullFace(t.face),this.setFrontFace(t.mode)):this.setFaceCullingEnabled(!1)},setPolygonOffset:t=>{t?(this.setPolygonOffsetFillEnabled(!0),this.setPolygonOffset(t.factor,t.units)):this.setPolygonOffsetFillEnabled(!1)},setDepthTest:t=>{t?(this.setDepthTestEnabled(!0),this.setDepthFunction(t.func)):this.setDepthTestEnabled(!1)},setStencilTest:t=>{if(t){this.setStencilTestEnabled(!0);const i=t.function;this.setStencilFunction(i.func,i.ref,i.mask);const r=t.operation;this.setStencilOp(r.fail,r.zFail,r.zPass)}else this.setStencilTestEnabled(!1)},setDepthWrite:t=>{t?(this.setDepthWriteEnabled(!0),this.setDepthRange(t.zNear,t.zFar)):this.setDepthWriteEnabled(!1)},setColorWrite:t=>{t?this.setColorMask(t.r,t.g,t.b,t.a):this.setColorMask(!1,!1,!1,!1)},setStencilWrite:t=>{t?this.setStencilWriteMask(t.mask):this.setStencilWriteMask(0)},setDrawBuffers:t=>{if(t)this.setDrawBuffers(t.buffers);else{const{drawFramebuffer:i}=this._state;i===null?this.setDrawBuffers([th]):i.colorAttachments.length===0?this.setDrawBuffers([I0]):this.setDrawBuffers([Ot])}}}),this.enforceState(),_e(this._driverTest),this._driverTest=new $K(this)}updateOptions(s){this._options={...this._options,...s},this._parameters=new lM(this.gl,this._capabilities,this._options)}dispose(){this._driverTest=_e(this._driverTest),this._programCache=_e(this._programCache),this.bindVAO(null),this.unbindBuffer(34962),this.unbindBuffer(34963),this.unbindBuffer(35345),this._state.uniformBufferBindingPoints.length=0,this.unbindBuffer(35051),this.unbindBuffer(35052),this.unbindBuffer(36662),this.unbindBuffer(36663),this._state.textureUnitMap.length=0,this._state=null,this._capabilities=null,this._stateTracker=null,ln()&&console.log(this.instanceCounter.resourceInformation)}get driverTest(){return this._driverTest}get contextAttributes(){return this.gl.getContextAttributes()}get parameters(){return this._parameters}get programCache(){return this._programCache}setPipelineState(s){this._stateTracker.setPipeline(s)}setBlendingEnabled(s){this._state.blend!==s&&(s===!0?this.gl.enable(this.gl.BLEND):this.gl.disable(this.gl.BLEND),this._state.blend=s,this._stateTracker.invalidateBlending())}externalProgramUpdate(){this._state.program?.stop(),this._state.program=null}externalTextureUnitUpdate(s,e){for(let t=0;t<s.length;++t)this._state.textureUnitMap[s[t]]=null;e>=0&&(this._state.activeTexture=e)}externalVertexArrayObjectUpdate(){this.gl.bindVertexArray(null),this._state.vertexArrayObject=null,this._state.vertexBuffer=null,this._state.indexBuffer=null}externalVertexBufferUpdate(){this._state.vertexBuffer=null}externalIndexBufferUpdate(){this._state.indexBuffer=null}setBlendColor(s,e,t,i){s===this._state.blendColor.r&&e===this._state.blendColor.g&&t===this._state.blendColor.b&&i===this._state.blendColor.a||(this.gl.blendColor(s,e,t,i),this._state.blendColor.r=s,this._state.blendColor.g=e,this._state.blendColor.b=t,this._state.blendColor.a=i,this._stateTracker.invalidateBlending())}setBlendFunction(s,e){s===this._state.blendFunction.srcRGB&&e===this._state.blendFunction.dstRGB||(this.gl.blendFunc(s,e),this._state.blendFunction.srcRGB=s,this._state.blendFunction.srcAlpha=s,this._state.blendFunction.dstRGB=e,this._state.blendFunction.dstAlpha=e,this._stateTracker.invalidateBlending())}setBlendFunctionSeparate(s,e,t,i){this._state.blendFunction.srcRGB===s&&this._state.blendFunction.srcAlpha===t&&this._state.blendFunction.dstRGB===e&&this._state.blendFunction.dstAlpha===i||(this.gl.blendFuncSeparate(s,e,t,i),this._state.blendFunction.srcRGB=s,this._state.blendFunction.srcAlpha=t,this._state.blendFunction.dstRGB=e,this._state.blendFunction.dstAlpha=i,this._stateTracker.invalidateBlending())}setBlendEquation(s){this._state.blendEquation.mode!==s&&(this.gl.blendEquation(s),this._state.blendEquation.mode=s,this._state.blendEquation.modeAlpha=s,this._stateTracker.invalidateBlending())}setBlendEquationSeparate(s,e){this._state.blendEquation.mode===s&&this._state.blendEquation.modeAlpha===e||(this.gl.blendEquationSeparate(s,e),this._state.blendEquation.mode=s,this._state.blendEquation.modeAlpha=e,this._stateTracker.invalidateBlending())}setColorMask(s,e,t,i){this._state.colorMask.r===s&&this._state.colorMask.g===e&&this._state.colorMask.b===t&&this._state.colorMask.a===i||(this.gl.colorMask(s,e,t,i),this._state.colorMask.r=s,this._state.colorMask.g=e,this._state.colorMask.b=t,this._state.colorMask.a=i,this._stateTracker.invalidateColorWrite())}setClearColor(s,e,t,i){this._state.clearColor.r===s&&this._state.clearColor.g===e&&this._state.clearColor.b===t&&this._state.clearColor.a===i||(this.gl.clearColor(s,e,t,i),this._state.clearColor.r=s,this._state.clearColor.g=e,this._state.clearColor.b=t,this._state.clearColor.a=i)}setFaceCullingEnabled(s){this._state.faceCulling!==s&&(s===!0?this.gl.enable(this.gl.CULL_FACE):this.gl.disable(this.gl.CULL_FACE),this._state.faceCulling=s,this._stateTracker.invalidateCulling())}setPolygonOffsetFillEnabled(s){this._state.polygonOffsetFill!==s&&(s===!0?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL),this._state.polygonOffsetFill=s,this._stateTracker.invalidatePolygonOffset())}setPolygonOffset(s,e){this._state.polygonOffset[0]===s&&this._state.polygonOffset[1]===e||(this._state.polygonOffset[0]=s,this._state.polygonOffset[1]=e,this.gl.polygonOffset(s,e),this._stateTracker.invalidatePolygonOffset())}setCullFace(s){this._state.cullFace!==s&&(this.gl.cullFace(s),this._state.cullFace=s,this._stateTracker.invalidateCulling())}setFrontFace(s){this._state.frontFace!==s&&(this.gl.frontFace(s),this._state.frontFace=s,this._stateTracker.invalidateCulling())}setScissorTestEnabled(s){this._state.scissorTest!==s&&(s===!0?this.gl.enable(this.gl.SCISSOR_TEST):this.gl.disable(this.gl.SCISSOR_TEST),this._state.scissorTest=s)}setScissorRect(s,e,t,i){this._state.scissorRect.x===s&&this._state.scissorRect.y===e&&this._state.scissorRect.width===t&&this._state.scissorRect.height===i||(this.gl.scissor(s,e,t,i),this._state.scissorRect.x=s,this._state.scissorRect.y=e,this._state.scissorRect.width=t,this._state.scissorRect.height=i)}setDepthTestEnabled(s){this._state.depthTest!==s&&(s===!0?this.gl.enable(this.gl.DEPTH_TEST):this.gl.disable(this.gl.DEPTH_TEST),this._state.depthTest=s,this._stateTracker.invalidateDepthTest())}setClearDepth(s){this._state.clearDepth!==s&&(this.gl.clearDepth(s),this._state.clearDepth=s)}setDepthFunction(s){this._state.depthFunction!==s&&(this.gl.depthFunc(s),this._state.depthFunction=s,this._stateTracker.invalidateDepthTest())}setDepthWriteEnabled(s){this._state.depthWrite!==s&&(this.gl.depthMask(s),this._state.depthWrite=s,this._stateTracker.invalidateDepthWrite())}setDepthRange(s,e){this._state.depthRange.zNear===s&&this._state.depthRange.zFar===e||(this.gl.depthRange(s,e),this._state.depthRange.zNear=s,this._state.depthRange.zFar=e,this._stateTracker.invalidateDepthWrite())}setStencilTestEnabled(s){this._state.stencilTest!==s&&(s===!0?this.gl.enable(this.gl.STENCIL_TEST):this.gl.disable(this.gl.STENCIL_TEST),this._state.stencilTest=s,this._stateTracker.invalidateStencilTest())}setClearStencil(s){s!==this._state.clearStencil&&(this.gl.clearStencil(s),this._state.clearStencil=s)}setStencilFunction(s,e,t){this._state.stencilFunction.func===s&&this._state.stencilFunction.ref===e&&this._state.stencilFunction.mask===t||(this.gl.stencilFunc(s,e,t),this._state.stencilFunction.face=1032,this._state.stencilFunction.func=s,this._state.stencilFunction.ref=e,this._state.stencilFunction.mask=t,this._stateTracker.invalidateStencilTest())}setStencilFunctionSeparate(s,e,t,i){this._state.stencilFunction.face===s&&this._state.stencilFunction.func===e&&this._state.stencilFunction.ref===t&&this._state.stencilFunction.mask===i||(this.gl.stencilFuncSeparate(s,e,t,i),this._state.stencilFunction.face=s,this._state.stencilFunction.func=e,this._state.stencilFunction.ref=t,this._state.stencilFunction.mask=i,this._stateTracker.invalidateStencilTest())}setStencilWriteMask(s){this._state.stencilWriteMask!==s&&(this.gl.stencilMask(s),this._state.stencilWriteMask=s,this._stateTracker.invalidateStencilWrite())}setStencilOp(s,e,t){this._state.stencilOperation.face===1032&&this._state.stencilOperation.fail===s&&this._state.stencilOperation.zFail===e&&this._state.stencilOperation.zPass===t||(this.gl.stencilOp(s,e,t),this._state.stencilOperation.face=1032,this._state.stencilOperation.fail=s,this._state.stencilOperation.zFail=e,this._state.stencilOperation.zPass=t,this._stateTracker.invalidateStencilTest())}setStencilOpSeparate(s,e,t,i){this._state.stencilOperation.face===s&&this._state.stencilOperation.fail===e&&this._state.stencilOperation.zFail===t&&this._state.stencilOperation.zPass===i||(this.gl.stencilOpSeparate(s,e,t,i),this._state.stencilOperation.face=s,this._state.stencilOperation.fail=e,this._state.stencilOperation.zFail=t,this._state.stencilOperation.zPass=i,this._stateTracker.invalidateStencilTest())}setActiveTexture(s,e=!1){const t=this._state.activeTexture;return s>=0&&(e||s!==this._state.activeTexture)&&(this.gl.activeTexture(fy+s),this._state.activeTexture=s),t}setDrawBuffers(s){const{drawFramebuffer:e}=this._state,t=e===null,i=t?this._state.drawBuffers.defaultFramebuffer:this._state.drawBuffers.fbos.get(e);if(i?.length!==s.length||!i.every((r,n)=>r===s[n]))if(s.length>this.parameters.maxDrawBuffers)console.error("Setting more active draw buffers than GL.MAX_DRAW_BUFFERS allows.");else{if(t){if(s.length>1)return void console.error("The default framebuffer can only have one active draw buffer.");if(s[0]!==th&&s[0]!==I0)return void console.error("The default framebuffer can only use the constants GL.BACK or GL.NONE as draw buffers.")}t||!s.includes(th)?(this.gl.drawBuffers(s),t?this._state.drawBuffers.defaultFramebuffer=s:this._state.drawBuffers.fbos.set(e,s),this._stateTracker.invalidateDrawBuffers()):console.error("A framebuffer object can only use the constants GL.COLOR_ATTACHMENTi or GL.NONE as draw buffers.")}}clear(s,e=255){if(s){if(16384&s){const t=this._state.drawFramebuffer?.colorAttachments;t&&this.setDrawBuffers(t),this.setColorMask(!0,!0,!0,!0)}256&s&&this.setDepthWriteEnabled(!0),1024&s&&this.setStencilWriteMask(e),this.gl.clear(s)}}clearFramebuffer(s,e=!1,t=!1){let i=0;if(s){const n=Math.max(1e-13,s[3]);this.setClearColor(s[0],s[1],s[2],n),i|=16384}e&&(i|=256),t===!1?t=0:(t===!0&&(t=255),i|=1024),i&&this.clear(i,t)}clearBuffer(s,e,t=6144,i=void 0){this.gl.clearBufferfv(t,s,e,i)}clearBufferInteger(s,e,t=6144,i=void 0){this.gl.clearBufferiv(t,s,e,i)}clearBufferUnsignedInteger(s,e,t=6144,i=void 0){this.gl.clearBufferuiv(t,s,e,i)}drawArrays(s,e,t){if(this._transformFeedbackRequestInfo){if(s!==this._transformFeedbackRequestInfo.primitiveType)throw new Error("DrawArrays called during transform feedback, but primitiveType does not match that of the current transform feedback request");if(this._state.program?.hasTransformFeedbackVaryings==null)throw new Error("DrawArrays called during transform feedback, but the shader program was not linked with a transform feedback varying")}if(ln()&&(this._numOfDrawCalls++,this._numOfTriangles+=vM(s,t),Ze("enable-feature:webgl-debug:textureReadWrite"))){const i=this._state.textureUnitMap;for(let r=0;r<i.length;r++){const n=i[r];if(n!=null&&n===this._state.drawFramebuffer?.colorTexture)throw new Error(`Detected readWrite. Texture already bound at index ${r}`)}}this.gl.drawArrays(s,e,t),Cf(this.gl)}drawArraysInstanced(s,e,t,i){this.gl.drawArraysInstanced(s,e,t,i),Cf(this.gl)}drawElements(s,e,t,i){if(this._transformFeedbackRequestInfo)throw new Error("Cannot called drawElements during a transform feedback request");if(ln()&&(this._numOfDrawCalls++,this._numOfTriangles+=vM(s,e)),this.gl.drawElements(s,e,t,i),ln()){const r=KL(this.gl);if(r){const n=this.getBoundVAO(),a=n?.indexBuffer,o=n?.buffers,l={indexBuffer:a,vertexBuffers:o},c={mode:s,count:e,type:t,offset:i},h=a?.size??0,d=i+e,m=h<d?`. Buffer is too small. Attempted to draw index ${d} of ${h}`:"";console.error(`drawElements: ${r}${m}`,{args:c,vao:l})}}}drawElementsInstanced(s,e,t,i,r){this.gl.drawElementsInstanced(s,e,t,i,r),Cf(this.gl)}logInfo(){ln()&&console.log(`DrawCalls: ${this._numOfDrawCalls}, Triangles: ${this._numOfTriangles}`)}resetInfo(){ln()&&(this._numOfDrawCalls=0,this._numOfTriangles=0)}get capabilities(){return this._capabilities}setViewport(s,e,t,i){t=Math.max(Math.round(t),1),i=Math.max(Math.round(i),1);const r=this._state.viewport;r.x===s&&r.y===e&&r.width===t&&r.height===i||(r.x=s,r.y=e,r.width=t,r.height=i,this.gl.viewport(s,e,t,i))}setViewport4fv(s){this.setViewport(s[0],s[1],s[2],s[3])}restoreViewport({x:s,y:e,width:t,height:i}){this.setViewport(s,e,t,i)}getViewport(){const s=this._state.viewport;return{x:s.x,y:s.y,width:s.width,height:s.height}}useProgram(s){this._state.program!==s&&(this._state.program?.stop(),this._state.program=s,this.gl.useProgram(s?.glName??null))}bindTexture(s,e,t=!1){(e>=this.parameters.maxTextureImageUnits||e<0)&&console.error("Input texture unit is out of range of available units!");const i=this._state.textureUnitMap[e];return s?.glName==null?(i!=null&&(this.setActiveTexture(e,t),this.gl.bindTexture(i.descriptor.target,null)),this._state.textureUnitMap[e]=null,i):t||i!==s?(this.setActiveTexture(e,t),this.gl.bindTexture(s.descriptor.target,s.glName),s.applyChanges(),this._state.textureUnitMap[e]=s,i):(s.isDirty&&(this.setActiveTexture(e,t),s.applyChanges()),i)}unbindTexture(s){if(s!=null)for(let e=0;e<this.parameters.maxTextureImageUnits;e++)this._state.textureUnitMap[e]===s&&(this.bindTexture(null,e),this._state.textureUnitMap[e]=null)}bindFramebuffer(s,e=!1){if(e||this._state.readFramebuffer!==s||this._state.drawFramebuffer!==s){if(this._stateTracker.invalidateDrawBuffers(),s==null)return this.gl.bindFramebuffer(36160,null),void(this._state.readFramebuffer=this._state.drawFramebuffer=null);s.initializeAndBind(36160),this._state.readFramebuffer=s,this._state.drawFramebuffer=s}}bindFramebufferSeparate(s,e,t=!1){const i=e===36008,r=i?this._state.readFramebuffer:this._state.drawFramebuffer;(t||r!==s)&&(s==null?this.gl.bindFramebuffer(e,null):s.initializeAndBind(e),i?this._state.readFramebuffer=s??null:(this._stateTracker.invalidateDrawBuffers(),this._state.drawFramebuffer=s??null))}blitFramebuffer(s,e,t=16384,i=9728,r=0,n=0,a=s.width,o=s.height,l=0,c=0,h=e.width,d=e.height){this.bindFramebufferSeparate(s,36008,!0),this.bindFramebufferSeparate(e,36009,!0),this.gl.blitFramebuffer(r,n,a,o,l,c,h,d,t,i)}bindBuffer(s,e){if(s)switch(e??=s.bufferType,e){case 34962:this._state.vertexBuffer=_s(this.gl,s,e,this._state.vertexBuffer);break;case 34963:this._state.indexBuffer=_s(this.gl,s,e,this._state.indexBuffer);break;case 35345:this._state.uniformBuffer=_s(this.gl,s,e,this._state.uniformBuffer);break;case 35051:this._state.pixelPackBuffer=_s(this.gl,s,e,this._state.pixelPackBuffer);break;case 35052:this._state.pixelUnpackBuffer=_s(this.gl,s,e,this._state.pixelUnpackBuffer);break;case 36662:this._state.copyReadBuffer=_s(this.gl,s,e,this._state.copyReadBuffer);break;case 36663:this._state.copyWriteBuffer=_s(this.gl,s,e,this._state.copyWriteBuffer);break;case 35982:this._state.transformFeedbackBuffer=_s(this.gl,s,e,this._state.transformFeedbackBuffer)}}bindRenderbuffer(s){const e=this.gl;s||(e.bindRenderbuffer(e.RENDERBUFFER,null),this._state.renderbuffer=null),this._state.renderbuffer!==s&&(e.bindRenderbuffer(e.RENDERBUFFER,s.glName),this._state.renderbuffer=s)}_getBufferBinding(s,e){if(e>=this.parameters.maxUniformBufferBindings||e<0)return console.error("Uniform buffer binding point is out of range!"),null;const t=s===35345?this._state.uniformBufferBindingPoints:this._state.transformBufferBindingPoints;let i=t[e];return i==null&&(i={buffer:null,offset:0,size:0},t[e]=i),i}bindBufferBase(s,e,t){const i=this._getBufferBinding(s,e);i!=null&&(i.buffer===t&&i.offset===0&&i.size===0||(this.gl.bindBufferBase(s,e,t?t.glName:null),i.buffer=t,i.offset=0,i.size=0))}bindBufferRange(s,e,t,i,r){const n=this._getBufferBinding(s,e);n!=null&&(n.buffer===t&&n.offset===i&&n.size===r||(i%this._parameters.uniformBufferOffsetAlignment===0?(this.gl.bindBufferRange(s,e,t.glName,i,r),n.buffer=t,n.offset=i,n.size=r):console.error("Uniform buffer binding offset is not a multiple of the context offset alignment")))}bindUBO(s,e,t,i){e!=null?(ln()&&(i??e.byteLength)>this._parameters.maxUniformBlockSize&&console.error("Attempting to bind more data than the maximum uniform block size"),e.initialize(),t!==void 0&&i!==void 0?this.bindBufferRange(35345,s,e.buffer,t,i):this.bindBufferBase(35345,s,e.buffer)):this.bindBufferBase(35345,s,null)}unbindUBO(s){for(let e=0,t=this._state.uniformBufferBindingPoints.length;e<t;e++){const i=this._state.uniformBufferBindingPoints[e];i!=null&&i.buffer===s.buffer&&this.bindBufferBase(35345,e,null)}}unbindBuffer(s){switch(s){case 34962:this._state.vertexBuffer=_s(this.gl,null,s,this._state.vertexBuffer);break;case 34963:this._state.indexBuffer=_s(this.gl,null,s,this._state.indexBuffer);break;case 35345:this._state.uniformBuffer=_s(this.gl,null,s,this._state.uniformBuffer);break;case 35051:this._state.pixelPackBuffer=_s(this.gl,null,s,this._state.pixelPackBuffer);break;case 35052:this._state.pixelUnpackBuffer=_s(this.gl,null,s,this._state.pixelUnpackBuffer);break;case 36662:this._state.copyReadBuffer=_s(this.gl,null,s,this._state.copyReadBuffer);break;case 36663:this._state.copyWriteBuffer=_s(this.gl,null,s,this._state.copyWriteBuffer)}}bindVAO(s,e){if(s==null)return this._state.vertexArrayObject?.unbind(),void(this._state.vertexArrayObject=null);this._state.vertexArrayObject!==s&&(s.bind(e),this._state.vertexArrayObject=s)}bindTransformFeedback(s){const{gl:e}=this;e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,s.glName)}beginTransformFeedback(s,e){if(this._transformFeedbackRequestInfo)throw new Error("Already in a transform feedback request");const{gl:t}=this;t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,s.glName),t.beginTransformFeedback(e),this._transformFeedbackRequestInfo={primitiveType:e}}endTransformFeedback(){if(!this._transformFeedbackRequestInfo)throw new Error("Not in a transform feedback request");const{gl:s}=this;s.endTransformFeedback(),s.bindTransformFeedback(s.TRANSFORM_FEEDBACK,null),this._transformFeedbackRequestInfo=null}async clientWaitAsync(s=$e(10)){const{gl:e}=this,t=e.fenceSync(37143,0);if(!t)throw new Error("Client wait failed, could not create sync object");let i;this.instanceCounter.increment(gi.Sync,t),e.flush();do await VM(s),i=e.clientWaitSync(t,0,0);while(i===37147);if(this.instanceCounter.decrement(gi.Sync,t),e.deleteSync(t),i===37149)throw new Error("Client wait failed")}getBoundFramebufferObject(s=36160){return s===36008?this._state.readFramebuffer:this._state.drawFramebuffer}temporaryBindFramebufferObject(s,e,t=!1){const i=this.getBoundFramebufferObject();try{this.bindFramebuffer(s,t),e()}finally{this.bindFramebuffer(i,t)}}getBoundVAO(){return this._state.vertexArrayObject}resetState(){this.useProgram(null),this.bindVAO(null),this.bindFramebuffer(null,!0),this.unbindBuffer(34962),this.unbindBuffer(34963),this.unbindBuffer(35345),this._state.uniformBufferBindingPoints.length=0,this.unbindBuffer(35051),this.unbindBuffer(35052),this.unbindBuffer(36662),this.unbindBuffer(36663);for(let s=0;s<this.parameters.maxTextureImageUnits;++s)this.bindTexture(null,s);this.setBlendingEnabled(!1),this.setBlendFunction(1,0),this.setBlendEquation(32774),this.setBlendColor(0,0,0,0),this.setFaceCullingEnabled(!1),this.setCullFace(1029),this.setFrontFace(2305),this.setPolygonOffsetFillEnabled(!1),this.setPolygonOffset(0,0),this.setScissorTestEnabled(!1),this.setScissorRect(0,0,this.gl.canvas.width,this.gl.canvas.height),this.setDepthTestEnabled(!1),this.setDepthFunction(513),this.setDepthRange(0,1),this.setStencilTestEnabled(!1),this.setStencilFunction(519,0,0),this.setStencilOp(7680,7680,7680),this.setClearColor(0,0,0,0),this.setClearDepth(1),this.setClearStencil(0),this.setColorMask(!0,!0,!0,!0),this.setStencilWriteMask(4294967295),this.setDepthWriteEnabled(!0),this.setDrawBuffers([th]),this.setViewport(0,0,this.gl.canvas.width,this.gl.canvas.height)}enforceState(){const{gl:s}=this;s.bindVertexArray(null);for(let t=0;t<this.parameters.maxVertexAttributes;t++)s.disableVertexAttribArray(t);this._state.vertexBuffer?s.bindBuffer(this._state.vertexBuffer.bufferType,this._state.vertexBuffer.glName):s.bindBuffer(34962,null),this._state.indexBuffer?s.bindBuffer(this._state.indexBuffer.bufferType,this._state.indexBuffer.glName):s.bindBuffer(34963,null),this._state.uniformBuffer?s.bindBuffer(this._state.uniformBuffer.bufferType,this._state.uniformBuffer.glName):s.bindBuffer(35345,null);for(let t=0;t<this._parameters.maxUniformBufferBindings;t++){const i=this._state.uniformBufferBindingPoints[t];if(i!=null){const{buffer:r,offset:n,size:a}=i;r!==null?n===0&&a===0?s.bindBufferBase(35345,t,r.glName):s.bindBufferRange(35345,t,r.glName,n,a):s.bindBufferBase(35345,t,null)}}if(this._state.pixelPackBuffer?s.bindBuffer(this._state.pixelPackBuffer.bufferType,this._state.pixelPackBuffer.glName):s.bindBuffer(35051,null),this._state.pixelUnpackBuffer?s.bindBuffer(this._state.pixelUnpackBuffer.bufferType,this._state.pixelUnpackBuffer.glName):s.bindBuffer(35052,null),this._state.copyReadBuffer?s.bindBuffer(this._state.copyReadBuffer.bufferType,this._state.copyReadBuffer.glName):s.bindBuffer(36662,null),this._state.copyWriteBuffer?s.bindBuffer(this._state.copyWriteBuffer.bufferType,this._state.copyWriteBuffer.glName):s.bindBuffer(36663,null),s.bindFramebuffer(36008,null),s.readBuffer(s.BACK),this._state.readFramebuffer&&(s.bindFramebuffer(36008,this._state.readFramebuffer.glName),s.readBuffer(Ot)),s.bindFramebuffer(36009,this._state.drawFramebuffer?.glName??null),this._state.drawFramebuffer===null){const t=this._state.drawBuffers.defaultFramebuffer;s.drawBuffers(t??[th])}else{const t=this._state.drawBuffers.fbos.get(this._state.drawFramebuffer);s.drawBuffers(t??[Ot])}if(this._state.vertexArrayObject){const t=this._state.vertexArrayObject;this._state.vertexArrayObject&&(this._state.vertexArrayObject.unbind(),this._state.vertexArrayObject=null),this.bindVAO(t)}s.useProgram(this._state.program?.glName??null),s.blendColor(this._state.blendColor.r,this._state.blendColor.g,this._state.blendColor.b,this._state.blendColor.a),s.bindRenderbuffer(s.RENDERBUFFER,this._state.renderbuffer?.glName??null),this._state.blend===!0?s.enable(this.gl.BLEND):s.disable(this.gl.BLEND),s.blendEquationSeparate(this._state.blendEquation.mode,this._state.blendEquation.modeAlpha),s.blendFuncSeparate(this._state.blendFunction.srcRGB,this._state.blendFunction.dstRGB,this._state.blendFunction.srcAlpha,this._state.blendFunction.dstAlpha),s.clearColor(this._state.clearColor.r,this._state.clearColor.g,this._state.clearColor.b,this._state.clearColor.a),s.clearDepth(this._state.clearDepth),s.clearStencil(this._state.clearStencil),s.colorMask(this._state.colorMask.r,this._state.colorMask.g,this._state.colorMask.b,this._state.colorMask.a),s.cullFace(this._state.cullFace),s.depthFunc(this._state.depthFunction),s.depthRange(this._state.depthRange.zNear,this._state.depthRange.zFar),this._state.depthTest===!0?s.enable(s.DEPTH_TEST):s.disable(s.DEPTH_TEST),s.depthMask(this._state.depthWrite),s.frontFace(this._state.frontFace),s.lineWidth(1),this._state.faceCulling===!0?s.enable(s.CULL_FACE):s.disable(s.CULL_FACE),s.polygonOffset(this._state.polygonOffset[0],this._state.polygonOffset[1]),this._state.polygonOffsetFill===!0?s.enable(s.POLYGON_OFFSET_FILL):s.disable(s.POLYGON_OFFSET_FILL),s.scissor(this._state.scissorRect.x,this._state.scissorRect.y,this._state.scissorRect.width,this._state.scissorRect.height),this._state.scissorTest===!0?s.enable(s.SCISSOR_TEST):s.disable(s.SCISSOR_TEST),s.stencilFunc(this._state.stencilFunction.func,this._state.stencilFunction.ref,this._state.stencilFunction.mask),s.stencilOpSeparate(this._state.stencilOperation.face,this._state.stencilOperation.fail,this._state.stencilOperation.zFail,this._state.stencilOperation.zPass),this._state.stencilTest===!0?s.enable(s.STENCIL_TEST):s.disable(s.STENCIL_TEST),s.stencilMask(this._state.stencilWriteMask);for(let t=0;t<this.parameters.maxTextureImageUnits;t++){s.activeTexture(fy+t),s.bindTexture(3553,null),s.bindTexture(34067,null),s.bindTexture(32879,null),s.bindTexture(35866,null);const i=this._state.textureUnitMap[t];i!=null&&s.bindTexture(i.descriptor.target,i.glName)}s.activeTexture(fy+this._state.activeTexture);const e=this._state.viewport;s.viewport(e.x,e.y,e.width,e.height),this.resetInfo()}};function _s(s,e,t,i){return e?i!==e&&s.bindBuffer(t,e.glName):s.bindBuffer(t,null),e}function vM(s,e){switch(s){case Ct.POINTS:return 2*e;case Ct.TRIANGLES:return e/3;case Ct.TRIANGLE_STRIP:case Ct.TRIANGLE_FAN:return e-2;default:return 0}}let VK=class extends FK{constructor(e,t){super(e,t),this.emptyTexture=fA(this),this._vaoCaches=new Map,this._appleAmdDriverHelper=null,this._refCount=1,this._newCache=t.newCache,this._screen=new YY(this)}configure(e){super.configure(e),this._newCache=e.newCache}destroy(){this._vaoCaches.forEach(e=>e.dispose()),this._vaoCaches.clear(),--this._refCount>0||this.dispose()}ref(){++this._refCount}get refCount(){return this._refCount}dispose(){this.emptyTexture.dispose(),this._screen.destroy(),this._screen=null,super.dispose(),this._appleAmdDriverHelper?.dispose(),this._vaoCaches.forEach(e=>e.dispose()),this._vaoCaches.clear()}get newCache(){return this._newCache}get screen(){return this._screen}getVaoCache(e){const t=JSON.stringify(e),i=this._vaoCaches.get(t);if(i)return i;const r=new JY(this,e);return this._vaoCaches.set(t,r),r}bindTechnique(e,t,i,r){return this.useProgram(e.program),this.setPipelineState(e.getPipeline()),e.program.bind(t),i&&(e.program.bindPass(i,t),r&&e.program.bindDraw(t,i,r)),e.program}runAppleAmdDriverHelper(){this.driverTest.drawArraysRequiresIndicesTypeReset.result&&(this._appleAmdDriverHelper??=new D3(this),this._appleAmdDriverHelper.run())}get isAssumedMetalDriver(){if(this._isAssumedMetalDriver==null&&(this._isAssumedMetalDriver=!!Ze("ios")||!!Ze("safari"),!this._isAssumedMetalDriver&&Ze("mac")&&Ze("chrome"))){const e=this.capabilities.rendererInfo?.getUnmaskedRenderer().toLowerCase(),t=e?.includes("apple")&&e?.includes("angle")&&e?.includes("metal");this._isAssumedMetalDriver=t??!0}return this._isAssumedMetalDriver}get test(){}},kK=class{constructor(e={},t={},i=8,r=1/0){this.disabledExtensions=e,this.debugWebGLExtensions=t,this.maxAnisotropy=i,this.maxPreferredTexturePixels=r}},zK=class extends kK{constructor(e){super(e.options.deactivatedWebGLExtensions||{},e.options.debugWebGLExtensions||{},8,e.view.qualitySettings.maxTexturePixels),this.newCache=(t,i)=>e.view.resourceController.memoryController.newCache(t,i)}};function bM(s){return!!s.update}let BK=class{constructor(){this._updating=new Map}destroy(){this._updating.clear()}add(e){this._updating.set(e.id,new NK(e))}remove(e){this._updating.delete(e.id)}run(){let e=!1;return this._updating.forEach(t=>{const i=t.texture.update(t.previousToken);i>=0&&i!==t.previousToken&&(t.previousToken=i,e=!0)}),e}},NK=class{constructor(e){this.texture=e,this.previousToken=-1}},yh=class extends te{constructor(e){super({}),this._stage=e,this._textures=new Map,this._loadingCount=0,this.events=new cc,this.updater=new BK,this._frameTask=e.view.resourceController.scheduler.registerTask(di.TEXTURE_UNLOAD)}normalizeCtorArgs(){return{}}destroy(){this._frameTask.remove(),this.updater.destroy(),this._textures.forEach(e=>e.unload())}get updating(){return this._loadingCount>0||this._frameTask.updating}acquire(e){const t=this._textures.get(e);return t?(t.ref(),t.loadingPromise??t):this._createNewRef(e)}update(){this.updater.run()&&this.events.emit("changed",0)}_createNewRef(e){const t=this._stage.getTexture(e);if(t==null)return null;const i=t.events.on("unloaded",()=>{i.remove(),this._onTextureUnloaded(t)}),r=new UK(t,()=>{this._frameTask.schedule(()=>{r.isUnreferenced&&t.unload()})});return this._textures.set(e,r),r.ref(),t.loaded?(this._updateGLTexture(r,t.glTexture),bM(t)&&this.updater.add(t),r):(this._loadingCount++,r.loadingPromise=this._stage.schedule(()=>{const n=t.load(this._stage.renderView.renderingContext),a=l=>(this._loadingCount--,r.loadingPromise=null,this._updateGLTexture(r,l),bM(t)&&this.updater.add(t),r),o=l=>(t.unload(),this._loadingCount--,r.loadingPromise=null,zr(l)||j.getLogger(this).error(l),null);return Lp(n)?n.then(a,o):a(n)}),r.loadingPromise)}_updateGLTexture(e,t){e.glTexture=t,this.events.emit("changed",1)}_onTextureUnloaded(e){this._textures.delete(e.id),this.updater.remove(e)}};u([p()],yh.prototype,"_loadingCount",void 0),u([p()],yh.prototype,"_frameTask",void 0),u([p()],yh.prototype,"updating",null),yh=u([R("esri.views.3d.webgl-engine.lib.TextureRepository")],yh);let UK=class{constructor(e,t){this._texture=e,this._release=t,this._refCount=0}get id(){return this._texture.id}get isUnreferenced(){return this._refCount===0}ref(){++this._refCount}release(){--this._refCount,this._refCount>0||(this._refCount!==0?(j.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository.RefCountedTextureImpl").error("Cannot dereference texture that has no references!"),this._refCount=0):this._release())}unload(){this._texture.unload()}};function HK(s,e){return new _E(t=>l8(t,s),t=>t,e)}let Bd=class extends te{constructor(){super(...arguments),this._passParameters=new qK,this._resourcesTask=null}get passParameters(){return this._passParameters}destroy(){this._resourcesTask=Os(this._resourcesTask),this._passParameters.waveNormal=_e(this._passParameters.waveNormal),this._passParameters.wavePerturbation=_e(this._passParameters.wavePerturbation)}get updating(){return!!this._resourcesTask&&!this._resourcesTask.finished}ensureResources(e){return this._resourcesTask||(this._resourcesTask=Za(async t=>{await Promise.allSettled([this._loadImageResource(e,jx("esri/images/materials/water/normals.jpg"),i=>this._passParameters.waveNormal=i,t),this._loadImageResource(e,jx("esri/images/materials/water/perturbation.jpg"),i=>this._passParameters.wavePerturbation=i,t)])})),this._resourcesTask.finished?2:1}async _loadImageResource(e,t,i,r){try{const n=await ec(t,{signal:r});He(r);const a=new ft(n.width,n.height);a.pixelFormat=6407,a.samplingMode=9987,a.hasMipmap=!0,a.maxAnisotropy=8,i(new bt(e,a,n))}catch(n){j.getLogger(this).error("Failed to load water material normal texture.",n)}}};u([p()],Bd.prototype,"_resourcesTask",void 0),u([p({type:Boolean,readOnly:!0})],Bd.prototype,"updating",null),Bd=u([R("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],Bd);let qK=class extends Xt{};const wM=2048,GK=1.5,jK=8;function L3(s,e){const{format:t,quality:i,rotation:r,disableDecorations:n}=s||{},a=Cx(s,e.padding),o=tJ(s,{width:e.width-a.left-a.right,height:e.height-a.top-a.bottom}),{width:l,height:c}=eJ(s,o),h=B3(t),d=N3[h];return{format:h,quality:U(i??d,0,100),area:o,width:l,height:c,rotation:r,disableDecorations:!!n,ignoreBackground:!!s?.ignoreBackground,ignorePadding:!!s?.ignorePadding}}function WK(s,e){const t=L3(s,e),i=t.area,r=t.width/i.width,n=Cx(t,e.padding),a=n.left+n.right,o=n.top+n.bottom,l=e.width-a,c=e.height-o,h=Math.floor(l*r+a),d=Math.floor(c*r+o),m=s?.layers??[],f=t.ignoreBackground,g=t.ignorePadding;return{framebufferWidth:h,framebufferHeight:d,region:{x:Math.floor(i.x*r)+n.left,y:Math.floor(i.y*r)+n.top,width:t.width,height:t.height},format:t.format,quality:t.quality,rotation:t.rotation,pixelRatio:r,layers:m,disableDecorations:t.disableDecorations,ignoreBackground:f,ignorePadding:g,olidColor:!1}}function QK(s,e,t){const{ctx:i,canvas:r}=F3(s,t),n=i.getImageData(0,0,s.width,s.height),a=k3(r,e);return V3(r),{dataUrl:a,data:n}}function ZK(s,e){const{ctx:t,canvas:i}=F3(s,e),r=t.getImageData(0,0,s.width,s.height);return V3(i),r}function F3(s,e){const t=XK();e.premultipliedAlpha&&nJ(s),t.width=s.width,t.height=s.height;const i=t.getContext("2d",{willReadFrequently:!0});return i.putImageData(s,0,0),e.flipY&&rJ(i),{ctx:i,canvas:t}}function V3(s){s.width=0,s.height=0}function XK(){return p0==null&&(p0=document.createElement("canvas")),p0}let p0=null;function k3(s,e){const t=aJ[e.format],i=e.quality/100;return s.toDataURL(t,i)}function YK(s,e){const t=B3(s),i=N3[t];return{format:t,quality:U(e??i,0,100)}}function KK(s,e){return e/Math.max(s[0],s[1])}function z3(s,e,t,i=0,r=0,n=s.width-i,a=s.height-r,o=!1){const{data:l}=s,{width:c,height:h,data:d}=e,m=n/c,f=a/h,g=Math.ceil(m/2),_=Math.ceil(f/2),v=s.width;for(let b=0;b<h;b++)for(let T=0;T<c;T++){const w=4*(T+(o?h-b-1:b)*c);let S=0,C=0,P=0,M=0,O=0,D=0;const A=(b+.5)*f;for(let F=Math.floor(b*f);F<(b+1)*f;F++){const E=Math.abs(A-(F+.5))/_,z=(T+.5)*m,L=E*E;for(let I=Math.floor(T*m);I<(T+1)*m;I++){const ie=Math.abs(z-(I+.5))/g,N=Math.sqrt(L+ie*ie);if(N>=1)continue;let se=2*N*N*N-3*N*N+1;const G=4*(i+I+(r+F)*v);D+=se*l[G+3],C+=se,!t&&l[G+3]<255&&(se=se*l[G+3]/255),P+=se*l[G],M+=se*l[G+1],O+=se*l[G+2],S+=se}}d[w]=P/S,d[w+1]=M/S,d[w+2]=O/S,d[w+3]=D/C}return e}function JK(s,e,t){if(!e)return s;const{framebufferWidth:i,framebufferHeight:r,pixelRatio:n,region:a}=s,o=Cx(s,t),l=o.left+o.right,c=o.top+o.bottom,h=i-l,d=r-c,m=Math.min(jK,Math.min((wM-l)/h,(wM-c)/d));return m<GK?s:{...s,framebufferWidth:Math.round(h*m)+l,framebufferHeight:Math.round(d*m)+c,pixelRatio:n*m,resample:{region:{x:Math.round((a.x-o.left)*m)+o.left,y:Math.round((a.y-o.top)*m)+o.top,width:Math.round(a.width*m),height:Math.round(a.height*m)},width:i,height:r}}}function eJ(s,e){if(!s)return e;const t=s.width,i=s.height;if(t!=null&&i!=null)return{width:Math.floor(t),height:Math.floor(i)};if(t==null&&i==null)return e;const r=e.width/e.height;return i==null?{width:Math.floor(t),height:Math.floor(t/r)}:{width:Math.floor(i*r),height:Math.floor(i)}}function tJ(s,e){const t={x:0,y:0,width:e.width,height:e.height};if(s?.area){s.area.x!=null&&(t.x=Math.floor(s.area.x)),s.area.y!=null&&(t.y=Math.floor(s.area.y));const i=s.area.width!=null?Math.floor(s.area.width):null,r=s.area.height!=null?Math.floor(s.area.height):null;if(t.width=e.width-t.x,t.height=e.height-t.y,i!=null&&r!=null)t.width=Math.min(t.width,i),t.height=Math.min(t.height,r);else if(i==null&&r!=null){const n=Math.min(t.width,i);t.height=n/t.width*t.height,t.width=n}else if(i!=null&&r==null){const n=Math.min(t.height,r);t.width=n/t.height*t.width,t.height=n}}return iJ(sJ(t,s),e)}function iJ(s,e){const t=Math.floor(Math.max(s.x,0)),i=Math.floor(Math.max(s.y,0)),r={x:t,y:i,width:Math.floor(Math.min(s.width,e.width-t)),height:Math.floor(Math.min(s.height,e.height-i))},n=r.width/r.height,a=s.width/s.height;if(a===n)return r;if(a>n){const c=Math.floor(r.width/a),h=r.height-c;return{x:r.x,y:Math.floor(r.y+h/2),width:r.width,height:c}}const o=Math.floor(r.height*a),l=r.width-o;return{x:Math.floor(r.x+l/2),y:r.y,width:o,height:r.height}}function sJ(s,e){if(e?.width==null||e.height==null)return s;const t=e.width/e.height,i=s.width/s.height;if(i===t)return s;if(i<t){const n=Math.floor(s.height*t);return s.x-=(n-s.width)/2,s.width=n,s}const r=Math.floor(s.width/t);return s.y-=(r-s.height)/2,s.height=r,s}function Cx(s,e){return!e||s?.ignorePadding?lJ:e}function B3(s){switch(s){case"png":case"jpg":case"jpeg":return s;default:return oJ}}function rJ(s){s.save(),s.globalCompositeOperation="copy",s.scale(1,-1),s.translate(0,-s.canvas.height),s.drawImage(s.canvas,0,0),s.restore()}function nJ(s){const e=s.data,t=e.length;for(let i=0;i<t;i+=4){const r=e[i+3];if(r!==255&&r>0){const n=255/r;e[i]=e[i]*n,e[i+1]=e[i+1]*n,e[i+2]=e[i+2]*n}}}const aJ={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg"},xM=98,oJ="png",N3={png:100,jpg:xM,jpeg:xM},lJ={top:0,right:0,bottom:0,left:0},sd=Object.freeze(Object.defineProperty({__proto__:null,completeUserSettings:L3,createEmptyImageData:Of,encode:QK,encodeData:ZK,getFormatAndQuality:YK,getMaximumResolutionScale:KK,resampleHermite:z3,screenshotSuperSampleSettings:JK,toDataUrl:k3,toRenderSettings:WK},Symbol.toStringTag,{value:"Module"}));let cJ=class{constructor(e,t){this.parameters=e,this.fbos=t}},hJ=class{constructor(e,t,i){this._rctx=e,this._renderFunctions=t,this._forceCameraHook=i,this.supersample=!0,this._screenshotQueue=new Array}destroy(){this._rctx=null}async takeScreenshot(e){await this._renderFunctions.prepareOverlay(),this._renderFunctions.requestRenderScene(0);const t=sa();return this._screenshotQueue.push({settings:e,resolver:t}),t.promise}update(e,t){for(const i of this._screenshotQueue){if(this._rctx==null){i.resolver.reject();continue}const r={...i.settings,pixelRatio:i.settings.pixelRatio*e.parameters.camera.pixelRatio},n=this._renderScreenshot(e,r,t);i.resolver(n)}this._screenshotQueue.length=0}_renderScreenshotOverlay(e,t,i){e.width=t.width,e.height=t.height;const r=e.getContext("2d",{willReadFrequently:!0}),n=i.pixelRatio;return r.save(),r.translate(0,t.height),r.scale(1,-1),i.region&&r.translate(-i.region.x,-i.region.y),r.scale(n,n),t=this._renderFunctions.renderOverlay(e,i.disableDecorations,t),r.restore(),t}_readbackScreenshot(e,t){return e.resample?this._readbackScreenshotResampled({...e,resample:e.resample},t):this._readbackScreenshotImmediate(e,t)}_readbackScreenshotResampled(e,t){const{framebufferWidth:i,framebufferHeight:r,region:n,resample:a}=e,o=this._ensureScreenshotEncodeCanvas();let l=Of(i,r,o);this._rctx.gl.readPixels(0,0,i,r,6408,Cn.UNSIGNED_BYTE,new Uint8Array(l.data.buffer)),t(),l=this._renderScreenshotOverlay(o,l,{...e,region:void 0});const c=Of(n.width,n.height,o);return z3(l,c,!0,a.region.x,r-(a.region.y+a.region.height),a.region.width,a.region.height)}_readbackScreenshotImmediate(e,t){const{framebufferHeight:i,region:r}=e,n=this._ensureScreenshotEncodeCanvas(),a=Of(r.width,r.height,n);return this._rctx.gl.readPixels(r.x,i-(r.y+r.height),r.width,r.height,6408,Cn.UNSIGNED_BYTE,new Uint8Array(a.data.buffer)),t(),this._renderScreenshotOverlay(n,a,e)}_renderScreenshot(e,t,i){const r=e.parameters.camera,{framebufferWidth:n,framebufferHeight:a,ignorePadding:o,pixelRatio:l,disableDecorations:c,olidColor:h}=t,d={width:n,height:a};Vl(d,Math.min(this._rctx.parameters.maxTextureSize,this._rctx.parameters.maxRenderbufferSize));let m=!1;const f=d.width!==r.fullWidth||d.height!==r.fullHeight,g=o&&r.pixelRatio!==l,_=f||c||g||h;let v=null,b=null;if(_){const C=r.clone();if(o){const A=Mf(C.padding);for(let F=0;F<4;F++)A[F]=Math.round(A[F]/C.pixelRatio*l);C.padding=A}C.fullWidth=d.width,C.fullHeight=d.height,C.pixelRatio=l;const P=r.fovX-C.fovX,M=r.fovY-C.fovY;P<0&&P<M?C.fovX=r.fovX:M<0&&M<P&&(C.fovY=r.fovY);const O={camera:C,contentCamera:C,mode:2,alignPixelEnabled:!0,contentPixelRatio:C.pixelRatio};this._forceCameraHook(O),m=!0;const D=this._renderFunctions.renderScene(O,i,h?2:1,c);b=D.screen,v=D.olid}const T=()=>{this._rctx.bindFramebuffer(null),b?.release()};this._rctx.bindFramebuffer(b?.fbo);const w=this._readbackScreenshot(t,T);let S=null;if(h){const C=()=>{this._rctx.bindFramebuffer(null),v?.release()};this._rctx.bindFramebuffer(v?.fbo),S=this._readbackScreenshot(t,C),this._rctx.bindFramebuffer(null)}if(_&&!this._rctx.contextAttributes.alpha)for(let C=3;C<w.data.length;C+=4)w.data[C]=255;if(S&&!this._rctx.contextAttributes.alpha)for(let C=3;C<S.data.length;C+=4)S.data[C]=255;return m&&this._forceCameraHook(e.parameters),[w,S]}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas??=document.createElement("canvas"),this._screenshotEncodeCanvas}},es=class extends te{constructor(s){super(s),this._waterTextures=new Bd,this.olidRenderHelper=Io()?new zX:null,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._needsWaterReflectionUpdate=!1,this._lastAnimationUpdate=0,this.glow=null,this.fog=null,this.test=null;const e=s.stage;try{this._initializeContext(e)}catch(n){return void console.error("Failed to initialize context",n)}const{memoryController:t}=e.view.resourceController;this._stippleTextures=t8(this._rctx,t),this.notifyChange("stippleTextures"),this._markerTextures=HK(this._rctx,t),this.notifyChange("markerTextures"),this._techniques=new GZ(new qZ(this._rctx,e.viewingMode,this.stippleTextures,this.waterTextures,this.markerTextures)),this._textures=new yh(e),this.addHandles(this._textures.events.on("changed",n=>this.requestRender(n)));const i=new gE(this._textures,this._techniques,()=>this.requestRender(),()=>this.requestRender());this._compositingHelper=new kX(this._rctx,this._techniques),this._renderer=new _h(e,i,this._techniques,this._rctx,this._compositingHelper,n=>this.requestRender(n)),this.notifyChange("renderer"),this.addHandles([$(()=>e.view.ready,n=>{n&&this._createRenderNodes()},Re),$(()=>this.waterTextures?.updating,()=>this.requestRender(),Re),$(()=>e.view.qualityProfile,n=>this.renderer?.updateRenderFeatures(n),Ve)]);const r={renderScene:(n,a,o,l)=>this.renderer.render(n,a,o,l),requestRenderScene:n=>this.requestRender(n),prepareOverlay:()=>e.options.screenshot.prepareOverlay(),renderOverlay:(n,a,o)=>e.options.screenshot.renderOverlay(n,a,o)};this._screenshotManager=new hJ(this._rctx,r,n=>e.view.overlayManager.updateOverlays(yn,n.camera,0)),this._registerFrameTask(e)}destroy(){const s=this.stage?.container;s?.contains(this._canvas)&&s.removeChild(this._canvas),this._frameTask=bi(this._frameTask),this._techniques=Q(this._techniques),this._componentObjectCollection=Q(this._componentObjectCollection),this._set("componentObjectCollection",null),this._screenshotManager=Q(this._screenshotManager),Q(this.renderer),this._textures=Q(this._textures),Q(this.waterTextures),Q(this.markerTextures),Q(this.stippleTextures),this._waterTextures=null,this._markerTextures=null,this._stippleTextures=null,this._canvas=null,this._rctx=Q(this._rctx),this._compositingHelper=null,this._renderer=null,this._set("renderer",null),this.test?.destroy()}_createRenderNodes(){const{view:s,viewingMode:e}=this.stage;new ow({view:s}),Dw(s.spatialReference)||(e===2?(new Jb({view:s}),this.glow=new Ul({view:s})):Ow(s.spatialReference)?(new ew({view:s}),this.glow=new Ul({view:s})):(new Yb({view:s}),new Kb({view:s}),this.glow=new Ul({view:s}),new nw({view:s}),this.fog=new fg({view:s}))),new JL({view:s,isEnabled:()=>this.renderer.hasSSAO}),new Sl({view:s,isEnabled:()=>this.renderer.hasSMAA}),new Tl({view:s}),new Td({view:s}),new fh({view:s,viewingMode:e}),new Dd({view:s}),Io()&&new Od({view:s})}requestRender(s=1){switch(s){case 2:this.stage.view.state.fading=!0;case 1:this._needsUpdate=!0;case 0:this._needsRender=!0}}get updating(){return this._needsUpdate||this._needsWaterReflectionUpdate||this.renderer.updating||this._textures.updating||this.waterTextures.updating}get textures(){return this._textures}get techniques(){return this._techniques}get compositingHelper(){return this._compositingHelper}setIdleSuspend(s){this._idleSuspend!==s&&(this._idleSuspend=s,this.requestRender())}get renderingContext(){return this._rctx}get capabilities(){return this._rctx.capabilities}get canvas(){return this._canvas}takeScreenshot(s){return this._screenshotManager.takeScreenshot(Jl(s))}getAlpha(){return!!this._rctx.contextAttributes.alpha}getMinimalDepthForArea(s,e,t,i,r,n=r){const a=i.constrainWindowSize(e,t,r*i.pixelRatio,n*i.pixelRatio),o=this._ensureLinearDepthArrayBuffer(a);this.renderer.readMainDepth(a,o);const l=(h,d,m)=>t4(d,h)*(m[1]-m[0])+m[0];let c=Number.MAX_VALUE;for(let h=0;h<a[2]*a[3];h++){const d=l(4*h,o,i.nearFar);c>d&&d!==i.nearFar[0]&&d!==i.nearFar[1]&&(c=d)}if(s){const h=s.pickDepth(e*i.pixelRatio,t*i.pixelRatio,i);h!=null&&c>h&&h!==i.nearFar[0]&&h!==i.nearFar[1]&&(c=h)}return c===Number.MAX_VALUE?void 0:c}_ensureLinearDepthArrayBuffer(s){const e=4*s[2]*s[3];return(this._tmpDepthBuffer==null||this._tmpDepthBuffer.byteLength<e)&&(this._tmpDepthBuffer=new Uint8Array(e)),this._tmpDepthBuffer}async reloadShaders(){EE(),await this._techniques.reloadAll(),this.renderer.overlay?.reloadShaders(),this.requestRender()}_registerFrameTask(s){const e=s.view.state;let t=!1,i=0,r=!1;const n={preRender:({time:a})=>{t=this.updating,i=this._needsUpdate?1:0,this._needsRender&&this.renderer.updateSceneDepthRange(e.camera),s.commitSyncLayers(),a=this.test?.time??a,($e(a-this._lastAnimationUpdate)>this.renderer.animationTimestep||t||this._needsRender)&&(this.renderer.updateAnimation(e,a)&&this.requestRender(0),this._lastAnimationUpdate=a)},render:({time:a})=>{if((this._needsRender||!this._idleSuspend||!this.renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&e.camera.fullWidth>0&&e.camera.fullHeight>0){const o=this._needsUpdate&&this._idleSuspend&&this.renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,a=this.test?.time??a,this.renderer.render(e,a,0),r=!0,o&&this.renderer.hasReflections&&(this.requestRender(0),this._needsWaterReflectionUpdate=!0)}},update:({time:a})=>{this._textures.update();const o=new cJ(e,this.renderer.fboCache);a=this.test?.time??a,this._screenshotManager.update(o,a)},finish:()=>{r&&(this.renderer.finish(e.mode===2?i:1),r=!1)}};this._frameTask=Kl(n)}_initializeContext(s){const{options:e}=s,t=e.canvas??document.createElement("canvas");t.setAttribute("style","width: 100%; height:100%; display:block;"),this._canvas=t;const i={alpha:e.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:e.stencil??!0,powerPreference:"high-performance",preserveDrawingBuffer:e.preserveDrawingBuffer??!1},r=t.getContext("webgl2",i);if(r==null)return void j.getLogger(this).error("A WebGL2 context could not be created.");Cf(r,!0),this._rctx=uJ(r,s),this._loadShaderOnlyExtensions(),!e.alpha&&this._rctx.contextAttributes.alpha&&j.getLogger(this).error("WebGL context has alpha channel even though no alpha channel was requested");const{container:n}=s;!this._rctx.contextAttributes.alpha&&Ze("safari")>=11&&(n.style.backgroundColor="black"),n.contains(t)||n.appendChild(t)}_loadShaderOnlyExtensions(){this._rctx.capabilities.enable("textureFloatLinear")}get _viewingMode(){return this.stage.viewingMode}get stippleTextures(){return this._stippleTextures}get markerTextures(){return this._markerTextures}get waterTextures(){return this._waterTextures}getObjectAndLayerIdColor(s){return this.olidRenderHelper?.getObjectAndLayerIdColor(s)}get renderer(){return this._renderer}get componentObjectCollection(){return this._componentObjectCollection==null&&(this._componentObjectCollection=new UZ(this.renderer.renderPassManager,this._viewingMode)),this._componentObjectCollection}set componentObjectCollection(s){this._componentObjectCollection=s}updateQualitySettings(s){this.test?.time!=null&&(this.test.savedFadeDuration=s.fadeDuration,s.fadeDuration=$e(0)),this._rctx.updateOptions({maxPreferredTexturePixels:this.stage.view.qualitySettings.maxTexturePixels})}};function uJ(s,e){const t=new zK(e);return new VK(s,t)}u([p({type:Boolean,readOnly:!0})],es.prototype,"updating",null),u([p({constructOnly:!0})],es.prototype,"stage",void 0),u([p({readOnly:!0})],es.prototype,"stippleTextures",null),u([p({readOnly:!0})],es.prototype,"markerTextures",null),u([p({readOnly:!0})],es.prototype,"waterTextures",null),u([p({readOnly:!0})],es.prototype,"olidRenderHelper",void 0),u([p()],es.prototype,"_textures",void 0),u([p({readOnly:!0})],es.prototype,"renderer",null),u([p()],es.prototype,"_screenshotManager",void 0),u([p()],es.prototype,"componentObjectCollection",null),u([p()],es.prototype,"_componentObjectCollection",void 0),u([p()],es.prototype,"_needsUpdate",void 0),u([p()],es.prototype,"_needsWaterReflectionUpdate",void 0),es=u([R("esri.views.3d.webgl-engine.parts.RenderView")],es);let Cr=class extends te{constructor(e){super(e),this._model=new mg,this._canCompact=rs(!1),this._layers=new Array,this._asyncChangeSet=new qb,this._syncChangeSet=new qb,this._layerSyncSet=new Set,this._textures=new Ih(this,e.view.resourceController.scheduler),this._frameTask=e.view.resourceController.scheduler.registerTask(di.STAGE,this),this.addHandles(this._frameTask)}initialize(){this._renderView=new es({stage:this})}destroy(){this.removeAllHandles(),this._textures.destroy(),this._set("textures",null),this._renderView=Q(this._renderView),this._set("renderView",null),this._layers.length=0,this._model=null,this._set("renderer",null),this.options.canvas=null,this._set("options",null)}get viewingMode(){return this.view.state.viewingMode}get updating(){return!this.destroyed&&!this.destroying&&(this.readyToRun||this.renderView.updating||this._frameTask.updating||this.textures.updating)}get renderView(){return this._renderView}get renderer(){return this.renderView?.renderer}get textures(){return this._textures}addTexture(e){this._model.addTexture(e),this.renderView.requestRender()}removeTexture(e){e!=null&&!this.destroyed&&this._model.hasTexture(e)&&(this._model.removeTexture(e),this.renderView.requestRender())}addTextures(e){e!=null&&(this._model.addTextures(e),this.renderView.requestRender())}removeTextures(e){e!=null&&(this._model?.removeTextures(e),this.renderView.requestRender())}forEachTexture(e){this._model.forEachTexture(e)}getTexture(e){return this._model.getTexture(e)}addLayer(e){this._layers.includes(e)||(this._model.addLayer(e),this._layers.push(e),this._model.dirtySet.layerAdded(e),this.renderView.requestRender())}removeLayer(e){e!=null&&!this.destroyed&&this._model.hasLayer(Jl(e))&&(this._model.dirtySet.layerRemoved(e),this.commitLayer(e),Lr(this._layers,e),this._model.dirtySet.assertLayerClean(e.id),this._model.removeLayer(e),this.renderView.requestRender())}getLayer(e){return this._model.getLayer(e)}handleEvent(e,t){this.destroyed||(this._model.dirtySet[e](t),this.renderView.requestRender())}get readyToRun(){return this._model.dirtySet.dirty||!this._asyncChangeSet.empty||this._canCompact.value}runTask(e){if(this._frameTask.processQueue(e),this._commit(e),this.renderer.compact(e),this._canCompact.value=this.renderer.canCompact,!e.hasProgressed)return Ai}compact(e){return this._canCompact.value=!1,this.renderer.compact(e)}_commit(e){const t=this._model.dirtySet;this._asyncChangeSet.empty||e.done||(this.renderer.commit(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()),this._layers.forEach(i=>{if(e.done)return;const r=this._layerSyncSet.has(i.id)||i.updatePolicy===1,n=r?this._syncChangeSet:this._asyncChangeSet;t.commitLayer(i.id,n),this._layerSyncSet.delete(i.id),n.empty||(this.renderer.commit(n,r?yn:e),this.renderView.requestRender(),e.madeProgress())}),this._syncChangeSet.empty||(this.renderer.commit(this._syncChangeSet,yn),this.renderView.requestRender(),e.madeProgress()),this._layers.forEach(i=>{e.done||this._layerSyncSet.has(i.id)||i.updatePolicy!==0||(t.commitLayer(i.id,this._asyncChangeSet),this._asyncChangeSet.empty||(this.renderer.commit(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()))}),this._layerSyncSet.clear(),this.notifyChange("readyToRun")}commitSyncLayers(){const e=this._model.dirtySet;this._layers.forEach(t=>{this._layerSyncSet.has(t.id)||t.updatePolicy===1?(e.commitLayer(t.id,this._syncChangeSet),this._layerSyncSet.delete(t.id)):e.commitSyncUpdates(t.id,this._syncChangeSet)});for(const t of this._layerSyncSet)e.commitLayer(t,this._syncChangeSet);this._layerSyncSet.clear(),this._syncChangeSet.empty||(this.renderer.commit(this._syncChangeSet,yn),this.renderView.requestRender())}commitLayer(e){this._model.dirtySet.commitLayer(e.id,this._syncChangeSet),this._layerSyncSet.delete(e.id),this._syncChangeSet.empty||(this.renderer.commit(this._syncChangeSet,yn),this.renderView.requestRender())}schedule(e,t){return this._frameTask.schedule(e,t)}reschedule(e,t){return this._frameTask.reschedule(e,t)}syncLayer(e){this._layerSyncSet.add(e),this.renderView.requestRender()}get layers(){return this._layers}addRenderPlugin(e,t){const i=this.renderer.plugins.add(e,t),r=()=>{FS(e)&&this.view.sceneIntersectionHelper.addIntersectionHandler(e)};if(Lp(i))return i.then(r);r()}removeRenderPlugin(e){this.destroyed||(FS(e)&&this.view.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderer.plugins.remove(e))}get test(){}};u([p({constructOnly:!0})],Cr.prototype,"view",void 0),u([p({constructOnly:!0})],Cr.prototype,"options",void 0),u([p({readOnly:!0})],Cr.prototype,"viewingMode",null),u([p({constructOnly:!0})],Cr.prototype,"container",void 0),u([p({readOnly:!0})],Cr.prototype,"updating",null),u([p({readOnly:!0})],Cr.prototype,"renderView",null),u([p({readOnly:!0})],Cr.prototype,"renderer",null),u([p({readOnly:!0})],Cr.prototype,"textures",null),u([p({readOnly:!0})],Cr.prototype,"readyToRun",null),Cr=u([R("esri.views.3d.webgl-engine.Stage")],Cr);const CM=Symbol("analyses-owner-handles");let yo=class extends te{constructor(s){super(s),this._allAnalysisViews=new Pt,this._creatingViewCount=0,this._attachedToViewResolver=TM(),this._items=new Map,this._moduleMap=new Map,this._scheduledUpdateHandle=null,this._emitOnView=(e,t)=>this.view.emit(e,t)}destroy(){this._disconnectOwners(),this._attachedToViewResolver.reject(Bi("AnalysisViewManager was destroyed")),this._set("view",null)}attach(){this._connectOwners(),this._attachedToViewResolver.resolve()}detach(){this._disconnectOwners(),this._attachedToViewResolver.reject(Bi()),this._attachedToViewResolver=TM()}get updating(){return!this.view.ready||this._creatingViewCount!==0||this._allAnalysisViews.some(s=>s.updating)}get testInfo(){}async whenAnalysisView(s){await this._attachedToViewResolver.promise;const e=this._items.get(s);if(e==null||e.state.list===1)throw new me("AnalysisViewManager:no-analysis-view-for-analysis","The analysis does not exist in view.analyses",{analysis:s});return e.createAnalysisViewTask.promise}_connectOwners(){this.addHandles(this._connectAnalysesCollection(this.view.analyses),CM)}_disconnectOwners(){this.removeHandles(CM),this._update(),this._creatingViewCount=0}_connectAnalysesCollection(s){for(const i of s)this._addAnalysis(i);const e=s.on("after-add",i=>this._addAnalysis(i.item)),t=s.on("after-remove",i=>this._removeAnalysis(i.item));return xn(()=>{e.remove(),t.remove();for(const i of s)this._removeAnalysis(i)})}_addAnalysis(s){const e=this._items.get(s);if(e==null){const t={state:{view:0,list:0},analysis:s,view:null,createAnalysisViewTask:null};this._items.set(s,t),t.createAnalysisViewTask=Za(i=>this._createAnalysisViewPromise(t,i).then(r=>(this._emitOnView("analysis-view-create",{analysis:s,analysisView:r}),r),r=>{throw this._emitOnView("analysis-view-create-error",{analysis:s,error:r}),r}))}else e.state.list=0}_removeAnalysis(s){const e=this._items.get(s);e!=null?(e.state.list=1,this._scheduleUpdate()):j.getLogger(this).error("Trying to remove analysis which was not added")}_scheduleUpdate(){this._scheduledUpdateHandle==null&&(this._scheduledUpdateHandle=FM(()=>this._update()))}_update(){this._scheduledUpdateHandle=bi(this._scheduledUpdateHandle),this._items.forEach(s=>{if(s.state.list!==1)return;const{analysis:e,view:t}=s;switch(this._items.delete(e),s.state.view){case 0:s.createAnalysisViewTask=Os(s.createAnalysisViewTask);break;case 1:t!=null&&(this._allAnalysisViews.remove(t),s.view=Q(t),s.createAnalysisViewTask=null,this._emitOnView("analysis-view-destroy",{analysis:e,analysisView:t}))}})}async _createAnalysisViewPromise(s,e){const{analysis:t}=s;if(this._creatingViewCount+=1,!this._moduleMap.has(t.type))try{this._moduleMap.set(t.type,await this.importAnalysisViewModule(t))}catch{throw this._creatingViewCount-=1,new me("AnalysisViewManager:no-analysis-view-for-analysis",`Analysis of type "${t.type}" is not supported`)}if(Hl(e))throw this._creatingViewCount-=1,Bi("AnalysisView creation aborted");const i=new(this._moduleMap.get(t.type)).default({analysis:t,view:this.view});let r=!0;Oo(e,()=>{r&&this._destroyAnalysisView(t,i)});try{await i.when()}catch(n){throw r=!1,this._destroyAnalysisView(t,i),n}if(Hl(e))throw Bi();return r=!1,s.view=i,s.state.view=1,this._allAnalysisViews.add(i),this._creatingViewCount-=1,i}_destroyAnalysisView(s,e){e.destroyed||(this._creatingViewCount-=1,e.destroy(),this._emitOnView("analysis-view-destroy",{analysis:s,analysisView:e}))}};u([p()],yo.prototype,"updating",null),u([p({constructOnly:!0})],yo.prototype,"importAnalysisViewModule",void 0),u([p({constructOnly:!0})],yo.prototype,"view",void 0),u([p()],yo.prototype,"_allAnalysisViews",void 0),u([p()],yo.prototype,"_creatingViewCount",void 0),yo=u([R("esri.views.support.AnalysisViewManager")],yo);const dJ=yo;function TM(){const s=sa();return s.promise.catch(()=>{}),s}function m0(s,e){return e?"xoffset"in e&&e.xoffset?Math.max(s,Math.abs(e.xoffset)):"yoffset"in e&&e.yoffset?Math.max(s,Math.abs(e.yoffset||0)):s:s}function pJ(s){let e=0,t=0;for(let i=0;i<s.length;i++){const r=s[i].size;typeof r=="number"&&(e+=r,t++)}return e/t}function SM(s,e){return typeof s=="number"?s:s?.stops?.length?pJ(s.stops):e}function mJ(s,e){if(!e)return s;const t=e.filter(a=>a.type==="size").map(a=>{const{maxSize:o,minSize:l}=a;return(SM(o,s)+SM(l,s))/2});let i=0;const r=t.length;if(r===0)return s;for(let a=0;a<r;a++)i+=t[a];const n=Math.floor(i/r);return Math.max(n,s)}function fJ(s){const e=s?.renderer,t=s?.pointerType,i=t==="touch"?9:6;if(!e)return i;const r="visualVariables"in e?mJ(i,e.visualVariables):i;if(e.type==="simple")return m0(r,e.symbol);if(e.type==="unique-value"){let n=r;return e.uniqueValueInfos?.forEach(a=>{n=m0(n,a.symbol)}),n}if(e.type==="class-breaks"){let n=r;return e.classBreakInfos.forEach(a=>{n=m0(n,a.symbol)}),n}return e.type==="dot-density"||e.type,r}function gJ(s,e,t,i=new is){let r=0;if(t.type==="2d")r=e*(t.resolution??0);else if(t.type==="3d"){const h=t.overlayPixelSizeInMapUnits(s),d=t.basemapSpatialReference;r=d==null||d.equals(t.spatialReference)?e*h:Wh(d)/Wh(t.spatialReference)}const n=s.x-r,a=s.y-r,o=s.x+r,l=s.y+r,{spatialReference:c}=t;return i.xmin=Math.min(n,o),i.ymin=Math.min(a,l),i.xmax=Math.max(n,o),i.ymax=Math.max(a,l),i.spatialReference=c,i}function nme(s,e,t){const i=t.toMap(s);return i==null?!1:gJ(i,fJ(),t,U3).intersects(e)}let U3=new is;function _J(){U3=new is}function yJ(s){return e=>{if(s.destroyed){const i=e(yn);return Lp(i)?i:Promise.resolve(i)}if(s.immediate)return s.immediate.schedule(e);const t="No immediate scheduler";throw console.error(t),new Error(t)}}const v_=new Set,H3=()=>j.getLogger("esri/views/support/TextureCompressionHelper");function vJ(s,e){return bt.compressionWorkerHandle??=new _9(yJ(e)),v_.has(s)?H3().warn("Repeated texture compression worker initialization by the same view."):v_.add(s),bt.compressionWorkerHandle}function bJ(s){const e=bt.compressionWorkerHandle;e&&(v_.delete(s)||H3().warn("Unknown view attempted to destroy the texture compression worker."),v_.size||(e.destroyWorkerAndSelf(),bt.compressionWorkerHandle=null))}function wJ(s){const e=G4();return e.available?s==="3d"&&e.majorPerformanceCaveat?new me("webgl:major-performance-caveat-detected",`Your WebGL implementation (${e.unmaskedRenderer}) doesn't seem to support hardware accelerated rendering. Check your browser settings or if your GPU is in a blocklist.`):e.supportsHighPrecisionFragment?e.supportsVertexShaderSamplers?null:new me("webgl:vertex-shader-samplers-required","WebGL support for vertex shader samplers is required but not supported."):new me("webgl:high-precision-fragment-required","WebGL support for high precision fragment shaders is required but not supported."):new me("webgl:required","WebGL2 is required but not supported.",new Error().stack)}const xJ={left:0,top:0,bottom:0,right:0},q3={bottom:30,top:15,right:15,left:15},_a="esri-ui",zs={ui:_a,corner:`${_a}-corner`,innerContainer:`${_a}-inner-container`,manualContainer:`${_a}-manual-container`,cornerContainer:`${_a}-corner-container`,topLeft:`${_a}-top-left`,topRight:`${_a}-top-right`,bottomLeft:`${_a}-bottom-left`,bottomRight:`${_a}-bottom-right`};function CJ(s){return s&&!s._started&&typeof s.postMixInProperties=="function"&&typeof s.buildRendering=="function"&&typeof s.postCreate=="function"&&typeof s.startup=="function"}function yf(s){return s===0?"0":`${s}px`}function f0(s){const e=typeof s=="object"&&s!==null&&Object.getPrototypeOf(s);return(e===null||e===Object.prototype)&&("component"in s||"index"in s||"position"in s)?s:null}function g0(s,{top:e,bottom:t,left:i,right:r}){s.style.top=e,s.style.bottom=t,s.style.left=i,s.style.right=r}let jn=class extends fu{constructor(s){super(s),this._cornerNameToContainerLookup={},this._positionNameToContainerLookup={},this._components=new Array,this._componentMap=new Map,this._removeWidgetHandleKey=Symbol("componentOnRemoveSymbol"),this._locale=DF(),this.view=null,this._applyViewPadding=()=>{const e=this.container;e&&g0(e,this._toPixelPosition(this._getViewPadding()))},this._applyUIPadding=()=>{const e=this._innerContainer;e&&g0(e,this._toPixelPosition(this.padding))},this._initContainers()}initialize(){this.addHandles([$(()=>[this.view?.padding,this.container],this._applyViewPadding,Re),$(()=>this.padding,this._applyUIPadding,Re),$(()=>[this.container,this._locale],([s,e])=>{s&&s.setAttribute("lang",e)},Re),EF(s=>{this._locale=s})])}destroy(){this.removeAllHandles(),this.container=null;for(const s of this._components)s.destroy();this._components.length=0,this._componentMap.clear(),this.view=null,this._set("view",null)}set container(s){const e=this._get("container");s!==e&&(s&&(s.classList.add(zs.ui),TF(s),this._attachContainers(s)),e&&(e.classList.remove(zs.ui),g0(e,{top:"",bottom:"",left:"",right:""}),e.textContent=""),this._set("container",s))}get height(){const s=this.view?.height??0;if(s===0)return s;const e=this._getViewPadding(),{top:t,bottom:i}=e;return Math.max(s-t-i,0)}get padding(){return this._get("padding")}set padding(s){this._overrideIfSome("padding",s)}castPadding(s){return typeof s=="number"?{bottom:s,top:s,right:s,left:s}:{...q3,...s}}get width(){const s=this.view?.width??0;if(s===0)return s;const e=this._getViewPadding(),{left:t,right:i}=e;return Math.max(s-t-i,0)}add(s,e){let t,i,r;if(Array.isArray(s))return void s.forEach(a=>this.add(a,e));const n=f0(s);n&&({index:t,position:e,component:s,key:i}=n),e&&typeof e=="object"&&({index:t,key:i,position:e,internal:r}=e),!s||e&&!this._isValidPosition(e)||this._add(s,e,t??this._getNumComponentsAtPosition(e),i,r)}remove(s,e){if(!s)return;if(Array.isArray(s))return s.map(i=>this.remove(i,e));const t=this._find(s);if(t){const i=this._componentMap.get(t);if(!i||i.key!==e)return;const r=this._components.indexOf(t);return t.node.parentNode?.removeChild(t.node),this._componentMap.delete(t),t.widget?.removeHandlesReference(this._removeWidgetHandleKey),this._components.forEach(a=>{const o=this._componentMap.get(a);o&&o.position===i.position&&o.index>i.index&&o.index--}),this._components.splice(r,1)[0]}}empty(s,e={removeInternal:!1}){if(Array.isArray(s)){for(const r of s)this.empty(r,e);return}const t=this._positionNameToContainerLookup[s??"manual"],i=Array.prototype.slice.call(t.children).map(r=>this._findByNode(r)).filter(r=>r==null?!1:!(this._componentMap.get(r)?.internal??!1)||e.removeInternal);for(const r of i)this.remove(r)}move(s,e){if(Array.isArray(s)&&s.forEach(n=>this.move(n,e)),!s)return;let t;const i=f0(s)||f0(e);if(i&&(t=i.index,e=i.position,s=i.component||s),e&&!this._isValidPosition(e))return;const r=this.remove(s);r&&this.add(r,{position:e,index:t})}find(s){if(!s)return null;const e=this._findById(s);return e&&(e.widget||e.node)}getComponents(s,e={includeInternal:!1}){return s?Array.isArray(s)?s.flatMap(t=>this._getComponentsAtPosition(t,e)):this._getComponentsAtPosition(s,e):this._components.filter(t=>e.includeInternal||!this._componentMap.get(t)?.internal).map(({widget:t,node:i})=>t??i)}getPosition(s){for(const e in this._positionNameToContainerLookup)if(this._positionNameToContainerLookup[e].contains(s))return e;return null}_add(s,e,t,i,r){s instanceof Qd||(s=new Qd({node:s}));const{widget:n}=s;n!=null&&n instanceof te&&n.addHandles(xn(()=>{queueMicrotask(()=>this.remove(s))}),this._removeWidgetHandleKey);const a=this._positionNameToContainerLookup[e];this._components.some(o=>{const l=this._componentMap.get(o)?.position,c=l?this._positionNameToContainerLookup[l]:null;return a===c&&this._componentMap.get(o)?.index===t})&&this._components.forEach(o=>{const l=this._componentMap.get(o),c=l?.position,h=c?this._positionNameToContainerLookup[c]:null;l&&h===a&&l.index>=t&&l.index++}),this._place({component:s,position:e,index:t}),this._components.push(s),this._componentMap.set(s,{key:i,position:e,internal:r,index:t})}_find(s){return s?s instanceof Qd?this._findByComponent(s):typeof s=="string"?this._findById(s):"domNode"in s?this._findByNode(s.domNode):this._findByNode(s):null}_getViewPadding(){return this.view?.padding??xJ}_attachContainers(s){s.appendChild(this._innerContainer),s.appendChild(this._manualContainer)}_initContainers(){const s=document.createElement("div");s.classList.add(zs.innerContainer,zs.cornerContainer);const e=document.createElement("div");e.classList.add(zs.innerContainer,zs.manualContainer);const t=document.createElement("div");t.classList.add(zs.topLeft,zs.corner),s.appendChild(t);const i=document.createElement("div");i.classList.add(zs.topRight,zs.corner),s.appendChild(i);const r=document.createElement("div");r.classList.add(zs.bottomLeft,zs.corner),s.appendChild(r);const n=document.createElement("div");n.classList.add(zs.bottomRight,zs.corner),s.appendChild(n),this._innerContainer=s,this._manualContainer=e;const a=SF();this._cornerNameToContainerLookup={"top-left":t,"top-right":i,"bottom-left":r,"bottom-right":n,"top-leading":a?i:t,"top-trailing":a?t:i,"bottom-leading":a?n:r,"bottom-trailing":a?r:n},this._positionNameToContainerLookup={manual:e,...this._cornerNameToContainerLookup}}_isValidPosition(s){return!!this._positionNameToContainerLookup[s]}_place(s){const e=s.position??"manual",{component:t,index:i}=s,r=this._positionNameToContainerLookup[e],n=i!=null&&i>-1;if(CJ(t.widget)&&t.widget.startup(),!n)return void r.appendChild(t.node);const a=Array.from(r.children);if(a.length!==0){for(const o of a){const l=this._findByNode(o);if(l&&i<(this._componentMap.get(l)?.index??0))return void o.parentNode?.insertBefore(t.node,o)}r.appendChild(t.node)}else r.appendChild(t.node)}_toPixelPosition(s){return{top:yf(s.top),left:yf(s.left),right:yf(s.right),bottom:yf(s.bottom)}}_findByComponent(s){return this._components.find(e=>e===s)??null}_findById(s){return this._components.find(({id:e})=>e===s)??null}_findByNode(s){return s?this._components.find(({node:e})=>e===s):null}_getComponentsAtPosition(s,e){const t=this._positionNameToContainerLookup[s];return Array.prototype.slice.call(t.children).map(i=>this._findByNode(i)).filter(Mg).filter(i=>e.includeInternal||!this._componentMap.get(i)?.internal).map(({widget:i,node:r})=>i??r)}_getNumComponentsAtPosition(s){return this._positionNameToContainerLookup[s]?.children.length??0}};u([p()],jn.prototype,"_locale",void 0),u([p()],jn.prototype,"container",null),u([p()],jn.prototype,"height",null),u([p({value:q3})],jn.prototype,"padding",null),u([Ba("padding")],jn.prototype,"castPadding",null),u([p()],jn.prototype,"view",void 0),u([p()],jn.prototype,"width",null),jn=u([R("esri.views.ui.UI")],jn);const TJ=jn,ame=-1,SJ=-2;let Nd,Ud=null;const Mo=new Map;async function ome(s){Ud==null&&(Nd==null&&(Nd=k(()=>import("./Lyr3DWasmPerSceneView-CBvvOrtr.js"),__vite__mapDeps([473,1,7,8,5,6,2,245,113,114,10,16,12,474,236,132,11,182,39,183,4,9,19,20,14,184,185,87,186,88,187,70,188,189,190,191,192,13,193,37,38,194,195,196,197,102,28,198,199,200,35,93,201,202,203,92,94,27,90,95,204,29,21,22,23,24,205,206,175,26,3,15,30,31,32,33,34,36,40,41,42,43,44,129,207,208,209,210,98,211,122,52,212,76,213,214,180,47,18,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,166,231,232,233,234,99,100,235,237,238,239,80,240,241,242,243,244,246,247,248,249,250]))),Ud=await Nd);const e=s.view;let t=Mo.get(e);t||(t=new Ud.default({view:e}),Mo.set(e,t));const i=!!e.stage.renderView.renderingContext.capabilities.compressedTextureS3TC,r=!!e.stage.renderView.renderingContext.capabilities.compressedTextureETC;await t.initializeWasm(i,r);const n=t.addLayerView(s);if(n.wasmLayerId<0)throw t.getValidLayerViewCount()<1&&(Mo.delete(e),Mo.size===0&&(Nd=null,Ud=null)),n.wasmLayerId===SJ?new me("tiles3d:addLayer-failure","The 3d tiles layer web assembly module failed to download.",{}):new me("tiles3d:addLayer-failure",n.check?.errorDescription??"The 3d tiles layer description was invalid.",{});return n.wasmLayerId}function PJ(s){return Mo.get(s)}function lme(s){const e=s.view,t=Mo.get(e);t&&t.removeLayerView(s)<1&&(Mo.delete(e),Mo.size===0&&(Nd=null,Ud=null))}function PM(s,e){return s&&"copyright"in s&&(!e||typeof s.originOf=="function"&&s.originOf("copyright")==="user")}function MJ(s,e){return s.length!==e.length||s.some((t,i)=>t.text!==e[i].text)}function vf(s,e,t){!t||!e||s.find(i=>i.layerView===e&&i.text===t)||s.push({text:t,layerView:e})}function $J(s){return s.type==="bing-maps"}const Vn=[];let vh=class extends te{constructor(s){super(s),this._clear=()=>{this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.removeHandles("suspension"),this.notifyChange("state")},this._pendingAttributions=new Set,this._fetchedAttributionData=new Map,this.items=new Pt,this.view=null,this._allLayerViewsChange=e=>{this.removeHandles("suspension"),this.removeHandles("visible-geometry-changed");const t=this.view?.allLayerViews;t&&(this.addHandles(t.map(i=>$(()=>[i.suspended,i.layer?.attributionVisible],()=>this._updateAttributionItems())).toArray(),"suspension"),t.forEach(i=>{i.declaredClass==="esri.views.3d.layers.IntegratedMesh3DTilesLayerView3D"&&this.addHandles(i.on("visible-geometry-changed",()=>this._updateAttributionItems()),"visible-geometry-changed")})),e?.removed&&e.removed.forEach(i=>{this._pendingAttributions.delete(i),this._fetchedAttributionData.delete(i)}),this._updateAttributionItems()},this.addHandles([Ds(()=>this.view?.allLayerViews,"change",e=>this._allLayerViewsChange(e),{onListenerAdd:()=>this._allLayerViewsChange(),onListenerRemove:this._clear}),Zs(()=>this.view?.stationary===!0,()=>this._updateAttributionItems())])}destroy(){this.view=null,this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.items.removeAll()}get state(){return this.view?.ready?this._pendingAttributions.size>0?"loading":"ready":"disabled"}_updateAttributionItems(){const s=this.view,e=s?.allLayerViews;Vn.length=0;let t=!1,i=null;if(!s||!e)return void this._clear();e.forEach(n=>{if(n.suspended||!n.layer?.attributionVisible)return;const a=n.layer;if(PM(a,"user"))return void vf(Vn,n,a.copyright);if(a.type==="integrated-mesh-3dtiles"&&a.hasGoogleUrl&&(t=!0,i=n),a.hasAttributionData){if(this._fetchedAttributionData.has(n)){const l=this._fetchedAttributionData.get(n);return void(l?vf(Vn,n,this._getDynamicAttribution(l,s,a)):PM(a)&&vf(Vn,n,a.copyright))}return void this._fetchAttributionData(n)}const o="portalItem"in a?a.portalItem?.accessInformation:void 0;vf(Vn,n,o||a.copyright)});const r=e.find(n=>n.layer?.type==="integrated-mesh-3dtiles");if(this.view&&r){const n=PJ(this.view);if(n){const a=n.getAttributionText();for(let o=a.length-1;o>-1;--o)Vn.unshift({text:a[o],layerView:r})}}t&&i&&Vn.unshift({text:"Google Maps",layerView:i}),MJ(this.items,Vn)&&(this.items.removeAll(),this.items.addMany(Vn)),Vn.length=0,this.notifyChange("state")}async _fetchAttributionData(s){if(this._pendingAttributions.has(s))return;this._pendingAttributions.add(s);const e=await Vg(s.layer.fetchAttributionData());if(this._pendingAttributions.has(s)){const t=e.ok?this._createContributionIndex(e.value,$J(s.layer)):null;this._pendingAttributions.delete(s),this._fetchedAttributionData.set(s,t)}this._updateAttributionItems()}_createContributionIndex(s,e){const t=s.contributors,i={};if(!t)return i;for(let r=0;r<t.length;r++){const n=t[r],a=n.coverageAreas;if(!a)return;for(const o of a){const l=o.bbox,c=o.zoomMin-(e&&o.zoomMin?1:0),h=o.zoomMax-(e&&o.zoomMax?1:0),d=new is({xmin:l[1],ymin:l[0],xmax:l[3],ymax:l[2],spatialReference:Dt.WGS84}),m={extent:hF(d),attribution:n.attribution||"",score:o.score!=null?o.score:100,id:r};for(let f=c;f<=h;f++)i[f]??=[],i[f].push(m)}}return i.maxKey=Math.max.apply(null,Object.keys(i)),i}_getDynamicAttribution(s,e,t){const{extent:i,scale:r}=e;let n=t.tileInfo?.scaleToZoom(r)??0;if(n=Math.min(s.maxKey??0,Math.round(n)),!i||n==null||n<=-1)return"";const a=s[n],o=uF(i.center.clone().normalize(),Dt.WebMercator),l=new Set;return a?a.filter(c=>{const h=c.id,d=!l.has(h)&&o&&c.extent&&kF(c.extent,o);return d&&l.add(h),d}).sort((c,h)=>h.score-c.score||c.objectId-h.objectId).map(c=>c.attribution).join(", "):""}};u([p({readOnly:!0,type:Pt})],vh.prototype,"items",void 0),u([p({readOnly:!0})],vh.prototype,"state",null),u([p()],vh.prototype,"view",void 0),vh=u([R("esri.widgets.Attribution.AttributionViewModel")],vh);const G3=vh,ia={button:"esri-button",buttonDisabled:"esri-button--disabled",buttonHalf:"esri-button--half",buttonSecondary:"esri-button--secondary",buttonSmall:"esri-button--small",buttonTertiary:"esri-button--tertiary",buttonThird:"esri-button--third",empty:"esri-widget__content--empty",heading:"esri-widget__heading",interactive:"esri-interactive",panel:"esri-widget--panel",table:"esri-widget__table",widget:"esri-widget",widgetButton:"esri-widget--button"};function RJ(){return function(s,e){if(!s[e])throw new TypeError(`Cannot auto bind undefined function '${String(e)}'`);return{value:DJ(s[e])}}}function OJ(s){const e=s?.type;return s instanceof KeyboardEvent||e==="keyup"||e==="keydown"||e==="keypress"}function DJ(s){return function(e,...t){OJ(e)?PF(e.key)&&(e.preventDefault(),e.stopPropagation(),e.target.click()):s.call(this,e,...t)}}const Yc="esri-attribution",Kc={base:Yc,poweredBy:`${Yc}__powered-by`,sources:`${Yc}__sources`,open:`${Yc}--open`,sourcesOpen:`${Yc}__sources--open`,link:`${Yc}__link`};let xs=class extends zp{constructor(e,t){super(e,t),this._isOpen=!1,this._attributionTextOverflowed=!1,this._prevSourceNodeHeight=0,this._sourcesNode=null,this._overflowRequestAnimationFrame=null,this._resizeObserver=new ResizeObserver(i=>{i.forEach(({target:r})=>{this._scheduleOverflowCheck(r)})}),this._mutationObserver=new MutationObserver(i=>{let r=!1;for(const n of i)if(n.type==="childList"||n.type==="characterData"||n.type==="attributes"){r=!0;break}r&&this._sourcesNode&&this._scheduleOverflowCheck(this._sourcesNode)}),this.itemDelimiter=" | ",this.messages=null,this.viewModel=new G3}initialize(){this.addHandles(Ds(()=>this.viewModel?.items,"change",()=>this.scheduleRender()))}destroy(){this._resizeObserver?.disconnect(),this._mutationObserver?.disconnect(),this._overflowRequestAnimationFrame!=null&&(cancelAnimationFrame(this._overflowRequestAnimationFrame),this._overflowRequestAnimationFrame=null)}get _isInteractive(){return this._isOpen||this._attributionTextOverflowed}_scheduleOverflowCheck(e){this._overflowRequestAnimationFrame==null&&(this._overflowRequestAnimationFrame=requestAnimationFrame(()=>{this._overflowRequestAnimationFrame=null,this._checkSourceTextOverflow(e)}))}get attributionText(){return this.viewModel.items.reduce((e,t)=>(e.includes(t.text)||e.push(t.text),e),[]).join(this.itemDelimiter)}get icon(){return"description"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}render(){const e={[Kc.open]:this._isOpen};return Ni("div",{bind:this,class:this.classes(Kc.base,ia.widget,e),dir:"ltr",onclick:this._toggleState,onkeydown:this._toggleState},this._renderSourcesNode(),this._renderPoweredBy())}_renderPoweredBy(){return Ni("div",{class:Kc.poweredBy},"Powered by"," ",Ni("a",{class:Kc.link,href:"https://www.esri.com/",rel:"noreferrer",target:"_blank"},"Esri"))}_renderSourcesNode(){const e=this._isOpen,t=this._isInteractive,i=t?0:void 0,{attributionText:r}=this,n={[Kc.sourcesOpen]:e,[ia.interactive]:t};return Ni("div",{afterCreate:this._afterSourcesNodeCreate,bind:this,class:this.classes(Kc.sources,n),innerHTML:r,tabIndex:i})}_afterSourcesNodeCreate(e){this._prevSourceNodeHeight=e.clientWidth,this._sourcesNode=e,this._resizeObserver.observe(e),this._mutationObserver.observe(e,{subtree:!0,childList:!0,characterData:!0,attributes:!0}),this._scheduleOverflowCheck(e)}_checkSourceTextOverflow(e){let t=!1;const{clientHeight:i,clientWidth:r,scrollWidth:n}=e,a=n>r,o=this._attributionTextOverflowed!==a;if(this._attributionTextOverflowed=a,o&&(t=!0),this._isOpen){const l=i<this._prevSourceNodeHeight;this._prevSourceNodeHeight=i,l&&(this._isOpen=!1,t=!0)}t&&this.scheduleRender()}_toggleState(){this._isInteractive&&(this._isOpen=!this._isOpen)}};u([p()],xs.prototype,"_isOpen",void 0),u([p()],xs.prototype,"_isInteractive",null),u([p()],xs.prototype,"_attributionTextOverflowed",void 0),u([p()],xs.prototype,"_prevSourceNodeHeight",void 0),u([p({readOnly:!0,dependsOn:["viewModel.items.length","itemDelimiter"]})],xs.prototype,"attributionText",null),u([p()],xs.prototype,"icon",null),u([p()],xs.prototype,"itemDelimiter",void 0),u([p()],xs.prototype,"label",null),u([p(),Qh("esri/widgets/Attribution/t9n/Attribution")],xs.prototype,"messages",void 0),u([p()],xs.prototype,"view",null),u([p({type:G3})],xs.prototype,"viewModel",void 0),u([RJ()],xs.prototype,"_toggleState",null),xs=u([R("esri.widgets.Attribution")],xs);const EJ=xs;function AJ(){const s=Ze("mapview-essential-goto-duration");return s==null?s:$e(s)}function IJ(s){return s?.spatialReference?.isWebMercator||s?.spatialReference?.isGeographic||!1}function LJ(s,e,t){return s.goTo(e,t)}const FJ=s=>{const e=s;let t=class extends e{constructor(...i){super(...i),this.goToOverride=null,this.view=null}callGoTo(i){const{view:r}=this;return zM(r),this.goToOverride?this.goToOverride(r,i):LJ(r,i.target,i.options)}};return u([p()],t.prototype,"goToOverride",void 0),u([p()],t.prototype,"view",void 0),t=u([R("esri.widgets.support.GoTo")],t),t};let Pl=class extends FJ(te){constructor(e){super(e),this.orientation={x:0,y:0,z:0},this.view=null,this._updateForCamera=this._updateForCamera.bind(this),this._updateForRotation=this._updateForRotation.bind(this),this._updateRotationWatcher=this._updateRotationWatcher.bind(this)}initialize(){this._watchForView(Re)}destroy(){this.view=null}get canShowNorth(){return IJ(this.view)}get state(){return!this.view?.ready||this.view.type==="2d"&&!this.view.constraints.rotationEnabled?"disabled":this.canShowNorth?"compass":"rotation"}reset(){this.view?.ready&&(this.view?.type==="2d"?this.callGoTo({target:{rotation:0},options:{animationMode:"always",duration:AJ()}}):this.callGoTo({target:{heading:0}}))}_updateForRotation(e){e!=null&&this._set("orientation",{z:e})}_updateForCamera(e){if(!e)return;const t=-e.heading;this._set("orientation",{x:0,y:0,z:t})}_updateRotationWatcher(e){this.removeAllHandles(),this._watchForView(),e&&this.addHandles(e.type==="2d"?$(()=>e?.rotation,this._updateForRotation,Re):$(()=>e?.camera,this._updateForCamera,Re))}_watchForView(e){this.addHandles($(()=>this.view,this._updateRotationWatcher,e))}};u([p({readOnly:!0})],Pl.prototype,"canShowNorth",null),u([p({readOnly:!0})],Pl.prototype,"orientation",void 0),u([p({readOnly:!0})],Pl.prototype,"state",null),u([p()],Pl.prototype,"view",void 0),Pl=u([R("esri.widgets.Compass.CompassViewModel")],Pl);const j3=Pl,MM="esri-compass",$M={base:MM,iconContainer:`${MM}__icon-container`};let Ma=class extends zp{constructor(e,t){super(e,t),this.messages=null,this.viewModel=new j3,this._reset=()=>{this.viewModel.reset()},this._toRotationTransform=i=>({transform:`rotateZ(${i.z}deg)`})}loadDependencies(){return Aw({button:()=>k(()=>import("./index-SZ3g5lwf.js"),__vite__mapDeps([475,476,21,1,16,12,2,7,8,5,6,22,23,24,477,478,479,480,481,482,483,484,485,486,487,488])),icon:()=>k(()=>import("./index-BsfTHZ_y.js").then(e=>e.i),__vite__mapDeps([480,21,1,16,12,2,7,8,5,6,22,23,24,481,482]))})}get goToOverride(){return this.viewModel.goToOverride}set goToOverride(e){this.viewModel.goToOverride=e}get icon(){return this.viewModel.state==="rotation"?"arrow-up":"compass-needle"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}reset(){return this.viewModel.reset()}render(){const{orientation:e,state:t}=this.viewModel,{messages:i}=this;return Ni("div",{class:this.classes($M.base,ia.widget)},Ni("calcite-button",{class:ia.widgetButton,disabled:t==="disabled",kind:"neutral",label:i.reset,onclick:this._reset,round:!0,scale:"s",title:i.reset},Ni("div",{"aria-hidden":"true",class:$M.iconContainer,title:i.reset},Ni("calcite-icon",{icon:this.icon,styles:this._toRotationTransform(e)}))))}};u([p()],Ma.prototype,"goToOverride",null),u([p()],Ma.prototype,"icon",null),u([p()],Ma.prototype,"label",null),u([p(),Qh("esri/widgets/Compass/t9n/Compass")],Ma.prototype,"messages",void 0),u([p()],Ma.prototype,"view",null),u([p({type:j3})],Ma.prototype,"viewModel",void 0),Ma=u([R("esri.widgets.Compass")],Ma);const VJ=Ma,RM="esri-navigation-toggle",OM={base:RM,isLayoutHorizontal:`${RM}--horizontal`};let bh=class extends te{constructor(s){super(s),this._navigationMode="pan",this.view=null,s?.isDefaultViewModel||TI(j.getLogger(this),"Navigation Toggle","arcgis-navigation-toggle",{version:"4.33"})}normalizeCtorArgs(s={}){const{isDefaultViewModel:e,...t}=s;return t}initialize(){this.addHandles(Zs(()=>this.view?.navigation?.actionMap,()=>this._updateNavigationActionMap()))}destroy(){this.view=null}get state(){return this.view?.ready&&this.view?.type==="3d"?"ready":"disabled"}get navigationMode(){return this._navigationMode}set navigationMode(s){this._navigationMode=s,this._updateNavigationActionMap()}toggle(){this.state!=="disabled"&&(this.navigationMode=this.navigationMode!=="pan"?"pan":"rotate")}_updateNavigationActionMap(){const s=this.view?.navigation?.actionMap;if(!s)return;const e=this._navigationMode==="pan";s.dragPrimary=e?"pan":"rotate",s.dragSecondary=e?"rotate":"pan"}};u([p({readOnly:!0})],bh.prototype,"state",null),u([p()],bh.prototype,"_navigationMode",void 0),u([p()],bh.prototype,"view",void 0),bh=u([R("esri.widgets.NavigationToggle.NavigationToggleViewModel")],bh);const W3=bh;let $a=class extends zp{constructor(e,t){super(e,t),this.messages=null,this.viewModel=new W3({isDefaultViewModel:!0}),this.toggle=()=>this.viewModel.toggle(),this._panButton=null,this._rotateButton=null,this._toggle=()=>{const i=this.viewModel?.navigationMode==="pan"?this._rotateButton:this._panButton;MF(i),this.toggle()},e?.isDefaultUI||SI(j.getLogger(this),"Navigation Toggle","arcgis-navigation-toggle",{version:"4.32"})}normalizeCtorArgs(e={}){const{isDefaultUI:t,...i}=e;return i}loadDependencies(){return Aw({button:()=>k(()=>import("./index-SZ3g5lwf.js"),__vite__mapDeps([475,476,21,1,16,12,2,7,8,5,6,22,23,24,477,478,479,480,481,482,483,484,485,486,487,488]))})}get icon(){return"move"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}set layout(e){e!=="horizontal"&&(e="vertical"),this._set("layout",e)}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}render(){const e=this.viewModel?.state==="disabled",t=this.viewModel?.navigationMode==="pan",i=this.messages.toggle;return Ni("div",{class:this.classes(OM.base,ia.widget,{[OM.isLayoutHorizontal]:this.layout==="horizontal"})},Ni("calcite-button",{afterCreate:r=>{this._panButton=r},appearance:t?"outline-fill":"solid",class:ia.widgetButton,disabled:e,iconStart:"move",kind:"neutral",label:i,onclick:this._toggle,tabIndex:t?void 0:-1,title:i}),Ni("calcite-button",{afterCreate:r=>{this._rotateButton=r},appearance:t?"solid":"outline-fill",class:ia.widgetButton,disabled:e,iconStart:"rotate",kind:"neutral",label:i,onclick:this._toggle,tabIndex:t?-1:void 0,title:i}))}};u([p()],$a.prototype,"icon",null),u([p()],$a.prototype,"label",null),u([p({value:"vertical"})],$a.prototype,"layout",null),u([p(),Qh("esri/widgets/NavigationToggle/t9n/NavigationToggle")],$a.prototype,"messages",void 0),u([p()],$a.prototype,"view",null),u([p({type:W3})],$a.prototype,"viewModel",void 0),$a=u([R("esri.widgets.NavigationToggle")],$a);const kJ=$a;let Ml=class extends te{get canZoomIn(){if(!this.view?.ready)return!1;const t=this.view?.constraints?.effectiveMaxScale;return t===0||this._scale>t}get canZoomOut(){const{view:e}=this;if(!e?.ready)return!1;const i=e.constraints?.effectiveMinScale;return i===0||this._scale<i}get _scale(){const e=this.view?.animation?.target;return(e&&"then"in e?void 0:e?.scale)??this.view?.scale??0}};u([p({readOnly:!0})],Ml.prototype,"canZoomIn",null),u([p({readOnly:!0})],Ml.prototype,"canZoomOut",null),u([p()],Ml.prototype,"view",void 0),u([p()],Ml.prototype,"_scale",null),Ml=u([R("esri.widgets.Zoom.ZoomConditions2D")],Ml);const zJ=Ml;let wh=class extends te{get canZoomIn(){return!!this.view.ready}get canZoomOut(){return!!this.view.ready}};u([p({readOnly:!0})],wh.prototype,"canZoomIn",null),u([p({readOnly:!0})],wh.prototype,"canZoomOut",null),u([p()],wh.prototype,"view",void 0),wh=u([R("esri.widgets.Zoom.ZoomConditions3D")],wh);const BJ=wh;let vo=class extends te{constructor(e){super(e)}destroy(){this.view=null}get canZoomIn(){return this._zoomConditions!=null&&this._zoomConditions.canZoomIn}get canZoomOut(){return this._zoomConditions!=null&&this._zoomConditions?.canZoomOut}get state(){return this.view?.ready?"ready":"disabled"}set view(e){e?e.type==="2d"?this._zoomConditions=new zJ({view:e}):e.type==="3d"&&(this._zoomConditions=new BJ({view:e})):this._zoomConditions=null,this._set("view",e)}zoomIn(){const e=this.view;this.canZoomIn&&e&&(e.type==="2d"?e.mapViewNavigation.zoomIn():Rg(e.goTo({zoomFactor:2})))}zoomOut(){const e=this.view;this.canZoomOut&&e&&(e.type==="2d"?e.mapViewNavigation.zoomOut():Rg(e.goTo({zoomFactor:.5})))}};u([p()],vo.prototype,"_zoomConditions",void 0),u([p()],vo.prototype,"canZoomIn",null),u([p()],vo.prototype,"canZoomOut",null),u([p({readOnly:!0})],vo.prototype,"state",null),u([p()],vo.prototype,"view",null),vo=u([R("esri.widgets.Zoom.ZoomViewModel")],vo);const Q3=vo,DM={base:"esri-zoom",horizontalLayout:"esri-zoom--horizontal"};let Ra=class extends zp{constructor(e,t){super(e,t),this.messages=null,this.viewModel=new Q3,this.zoomIn=()=>this.viewModel.zoomIn(),this.zoomOut=()=>this.viewModel.zoomOut()}loadDependencies(){return Aw({button:()=>k(()=>import("./index-SZ3g5lwf.js"),__vite__mapDeps([475,476,21,1,16,12,2,7,8,5,6,22,23,24,477,478,479,480,481,482,483,484,485,486,487,488]))})}get icon(){return"magnifying-glass-plus"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}set layout(e){e!=="horizontal"&&(e="vertical"),this._set("layout",e)}set view(e){this.viewModel.view=e}get view(){return this.viewModel.view}render(){const e={[DM.horizontalLayout]:this.layout==="horizontal"},{canZoomIn:t,canZoomOut:i}=this.viewModel,{zoomIn:r,zoomOut:n}=this.messages;return Ni("div",{class:this.classes(DM.base,ia.widget,e)},Ni("calcite-button",{class:ia.widgetButton,disabled:!t,iconStart:"plus",kind:"neutral",label:r,onclick:this.zoomIn,title:r}),Ni("calcite-button",{class:ia.widgetButton,disabled:!i,iconStart:"minus",kind:"neutral",label:n,onclick:this.zoomOut,title:n}))}};u([p()],Ra.prototype,"icon",null),u([p()],Ra.prototype,"label",null),u([p({value:"vertical"})],Ra.prototype,"layout",null),u([p(),Qh("esri/widgets/Zoom/t9n/Zoom")],Ra.prototype,"messages",void 0),u([p()],Ra.prototype,"view",null),u([p({type:Q3})],Ra.prototype,"viewModel",void 0),Ra=u([R("esri.widgets.Zoom")],Ra);const NJ=Ra;function UJ(s){return s?.view!==void 0}let Sg=class extends TJ{constructor(s){super(s),this._defaultPositionLookup={attribution:"manual",compass:"top-left","navigation-toggle":"top-left",zoom:"top-left"},this.components=[],this._updateViewAwareWidgets=e=>{this.components.forEach(t=>{const i=this._find(t),r=i?.widget;UJ(r)&&(r.view=e)})},this._componentsWatcher=(e,t)=>{this._removeComponents(t),this._addComponents(e),this._adjustPadding(e)}}initialize(){this.addHandles([$(()=>this.components,this._componentsWatcher,Re),$(()=>this.view,this._updateViewAwareWidgets,Re)])}_add(s,e,t,i,r){let n=s;if(typeof s=="string"&&this._defaultPositionLookup[s]){if(this._find(s))return;n=this._createComponent(s)}super._add(n,e,t,i,r)}_removeComponents(s){s.forEach(e=>{const t=this._find(e);t&&(this.remove(t),t.destroy())})}_adjustPadding(s){if(!s.includes("attribution")&&!this._isOverridden("padding")){const{top:e}=this.padding;this.padding=e}}_addComponents(s){this.constructed&&s.forEach(e=>this.add(this._createComponent(e),this._defaultPositionLookup[e]))}_createComponent(s){const e=this._createWidget(s);return new Qd({id:s,node:e})}_createWidget(s){const e=this.view;switch(s){case"attribution":return new EJ({view:e});case"compass":return new VJ({view:e});case"navigation-toggle":return new kJ({view:e,isDefaultUI:!0});case"zoom":return new NJ({view:e})}}};u([p()],Sg.prototype,"components",void 0),Sg=u([R("esri.views.ui.DefaultUI")],Sg);const Z3=Sg;let Pg=class extends Z3{constructor(s){super(s),this.components=["attribution","zoom","navigation-toggle","compass"]}};u([p()],Pg.prototype,"components",void 0),Pg=u([R("esri.views.ui.3d.DefaultUI3D")],Pg);const X3=Pg;var fw;const EM=Symbol(),_0=Symbol();let Z=class extends Q4(pk(J4(EC))){static{fw=this}constructor(s){super(s),this._userClippingArea=null,this._clippingArea=null,this._initialDefaultSpatialReference=null,this._overrideDefaultEnvironmentOnly=!0,this._resolveWhenReady=[],this._resourceController=UG(this),this.deconflictor=new Db({view:this}),this.labeler=new xl({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.analyses=new su,this.animationsEnabled=!0,this.basemapTerrain=null,this.elevationProvider=new xd({view:this}),this._canvas=null,this.constraints=new Dl,this._environment=new uh,this.environmentManager=new sn,this.floors=new Pt,this.fullOpacity=1,this.graphicsView=null,this.analysisViewManager=new dJ({importAnalysisViewModule:t=>Bz(t),view:this}),this.groundView=null,this.map=null,this._featureTileTreeClients=new j4,this._featureTiles=null,this._featureTreeDebugger=null,this.state=new DS({view:this}),this.slice=new Cd,this.spatialReference=null,this.preserveDrawingBufferEnabled=!1,this.supersampleScreenshotsEnabled=!0,this.type="3d",this.ui=new X3,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this._importControllers=new Map,LF();const e=(t=null)=>{t!=null&&t.type===4||(this._updatingChanged(),this.map?.allLayers.forEach(async i=>{try{await i.when()}catch{}this._updatingChanged()}))};this.addHandles([Ds(()=>this.map?.allLayers,"after-changes",t=>e(t),{onListenerAdd:()=>e(),onListenerRemove:()=>e(),sync:!0}),this.allLayerViews.on("after-changes",t=>this._updateUpdatingMonitors(t)),$(()=>this.scene,t=>t?.load().catch(()=>{}))]),this.inputManager=new nq({view:this}),this.stateManager=new Gt({view:this}),this.screenSizePerspective=new bd({view:this})}initialize(){if(Ze("enable-feature:esri-compress-textures")&&Ze("wasm-simd")){const s=vJ(this,this.resourceController);this.addResolvingPromise(s.promise)}this.groundView=new nr({view:this}),this._updateUpdatingMonitors(),this.updatingHandles.add(()=>this.qualitySettings.memoryLimit,s=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=s)},Re),this.updatingHandles.add(()=>this.qualitySettings.additionalCacheMemory,s=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=s)},Re),this.updatingHandles.add(()=>this.qualitySettings.frameRate??0,s=>PI(s>0?1e3/Math.ceil(s):0),Re),this.addHandles([$(()=>this.spatialReference,()=>this.notifyChange("clippingArea"),Ae),$(()=>({plane:this.slice.plane,isDecoration:this.slice.isDecoration}),()=>this._updateSlice(),Ae)])}destroy(){this.destroyed||(bJ(this),this.updatingHandles.removeAll(),this.basemapTerrain?.clearHandles(),this.elevationProvider.destroy(),this.ui.removeAllHandles(),this.layerViewManager.clearHandles(),this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._set("analysisViewManager",Q(this.analysisViewManager)),this._exitSurface(),this._disposeGraphicsView(),this._disposeFocusAreasView(),this.sharedSymbolResources=Q(this.sharedSymbolResources),this._set("labeler",Q(this.labeler)),this._set("deconflictor",Q(this.deconflictor)),this._resourceController=Q(this._resourceController),this._set("stateManager",Q(this.stateManager)),this._set("inputManager",Q(this.inputManager)),this.state.destroy(),this.highlights.destroy(),this.removeHandles("updatingMonitors"),this._set("environmentManager",Q(this.environmentManager)),this._set("environment",Q(this.environment)),this.groundView=Q(this.groundView),this.slice.destroy(),this._updatingObjectsWithProgress.length=0,this._updatingObjects.length=0,this.ui?.destroy(),this._set("ui",null),this._set("renderCanvas",null),this._set("canvas",null),this._canvas=null,this.screenSizePerspective.destroy())}get stage(){return this._stage}get renderSpatialReference(){return this.renderCoordsHelper?.spatialReference}get basemapSpatialReference(){return this.basemapTerrain?.spatialReference}get animation(){return this.state?.animation}get overlayManager(){return this.basemapTerrain?.overlayManager}get camera(){return this.stateManager?.camera}set camera(s){this.stateManager&&(this.stateManager.camera=s)}get contentCamera(){return this.stateManager?.contentCamera}set contentCamera(s){this.stateManager&&(this.stateManager.contentCamera=s)}installContentCameraReset(s={sticky:!1}){return this.stateManager.installContentCameraReset(s)}get canvas(){return this._canvas}get center(){return this.stateManager?.center}set center(s){this.stateManager&&(this.stateManager.center=s)}get clippingArea(){if(this.viewingMode==="global")return null;const s=this.map;let e=this._userClippingArea||Fx(s,"clippingArea");return!this._userClippingArea&&!Fx(s,"clippingEnabled")||e==null?(this._clippingArea=null,null):e instanceof is?this.spatialReference&&(e=bf(e,this.spatialReference),e==null)?(j.getLogger(this).error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(e=e.clone(),e.intersection(this._groundAndLayersExtent)==null&&(e.xmin=e.xmax,e.ymin=e.ymax),e.zmin=void 0,e.zmax=void 0,e.equals(this._clippingArea)||(this._clippingArea=e),this._clippingArea):(j.getLogger(this).error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)}set clippingArea(s){this.ready&&this.viewingMode==="global"&&s!=null?j.getLogger(this).error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=s}get renderDataExtent(){if(this.state.viewingMode===1)return null;const s=this.renderSpatialReference,e=this.dataExtent;return e==null||s==null||e.spatialReference.equals(s)?e:bf(e,s)}get tileInfo(){return this.basemapTerrain?.tilingScheme?.toTileInfo()}get dataExtent(){let s=this._groundAndLayersExtent;const e=this.spatialReference||Dt.WGS84,t=bf(this.clippingArea,e);t!=null&&(s=s!=null?s.intersection(t):t);const i=this._get("dataExtent");return s!=null&&s.equals(i)?i:s}get _groundAndLayersExtent(){const s=this.spatialReference||Dt.WGS84;let e;const t=a=>{const o=bf(a,s);o!=null&&(e!=null?e.union(o):e=o.clone())},{basemapTerrain:i}=this;if(i?.spatialReference){const a=i.groundExtent;t(new is({xmin:a[0],ymin:a[1],zmin:0,xmax:a[2],ymax:a[3],zmax:0,spatialReference:i.spatialReference}))}const r=a=>{a.fullExtent==null||a.type==="graphics"&&a.internal||t(a.fullExtent)};if(this.map?.allLayers.forEach(a=>r(a)),e==null)return null;e.hasZ?(e.zmin=Math.min(0,e.zmin??0),e.zmax=Math.max(0,e.zmax??0)):(e.zmin=0,e.zmax=0);const n=this._get("_groundAndLayersExtent");return e.equals(n)?n:e}get environment(){return this._environment}set environment(s){if(this._environment===s)return;const{_environment:e}=this;this._environment=null,e?.destroy(),this._environment=s,this.notifyChange("environment")}castEnvironment(s){return s?s instanceof uh?s:s instanceof HO?this.environment?.cloneWithWebsceneEnvironment(s)??uh.fromWebsceneEnvironment(s):MI(uh,s):new uh}get extent(){return this.stateManager?.extent}set extent(s){this.stateManager&&(this.stateManager.extent=s)}get screenCenter(){return this.stateManager?.screenCenter}get frustum(){return this.stateManager?.frustum}get layerviewCollections(){return[this.basemapView?.baseLayerViews,this.basemapView?.groundLayerViews,this.groundView?.layerViews,this.layerViews,this.basemapView?.referenceLayerViews]}get _layerToLayerviewMapping(){return fw._layerToLayerview}static{this._layerToLayerview=EC._layerToLayerview.concat([["view.map.ground.layers","view.groundView.layerViews"]])}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get defaultsFromMapSettings(){return{required:{tileInfo:!1,heightModelInfo:!0,extent:!1}}}get interacting(){return this.navigating||(this.toolViewManager?.interacting??!1)}get stationary(){return!this.animation&&!this.resizing&&(this.state?.stationary??!0)}get navigating(){return this.state?.navigating??!1}get scene(){return this.map&&C5 in this.map?this.map:null}get padding(){return this.stateManager?.padding}set padding(s){this.stateManager&&(this.stateManager.padding=s)}get featureTiles(){return this._featureTiles}set qualityProfile(s){tg.isValidProfile(s)&&(tg.apply(s,this.qualitySettings),this.stage?.renderView.updateQualitySettings(this.qualitySettings),this._set("qualityProfile",s))}get qualityProfile(){return this._get("qualityProfile")||tg.getDefaultProfile()}_updateSlice(){this.stage!=null&&(this.stage.renderer.slice=this.slice)}get typeSpecificPreconditionsReady(){return!!this.viewingMode&&!!this.stateManager?.preinit(this.spatialReference)}get resolution(){return this.spatialReference!=null?y5(this.scale,this.spatialReference):0}get scale(){return this.stateManager?.scale}set scale(s){this.stateManager&&(this.stateManager.scale=s)}get terrainLevel(){const s=this.basemapTerrain?.tilingScheme,{scale:e}=this;if(!s||!e)return null;const t=s.levelAtScale(e)+this.qualitySettings.tiledSurface.lodBias,i=s.getMaxLod();return t<=0?null:Math.max(0,Math.min(t,i||1/0))}get heightModelInfo(){const s=this.getDefaultHeightModelInfo();return s!=null?Bp.deriveUnitFromSR(s,this.spatialReference):null}get alphaCompositingEnabled(){return this._get("alphaCompositingEnabled")}set alphaCompositingEnabled(s){this._stage&&j.getLogger(this).warn("alphaCompositingEnabled cannot be changed after the view has become ready"),this._set("alphaCompositingEnabled",s)}get updating(){if(this.destroying||this.destroyed)return!1;let s=0,e=this.layerViewManager.updating,t=e?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach(r=>{if(r.isFulfilled()){if(r.updating){if(e=!0,r.suspended||kb(r))return;++t,s+=r.updatingProgress}}else++t});for(const r of this._updatingObjects)r!=null&&r.updating&&(t+=.1,s+=.5*.1);for(const r of this._updatingObjectsWithProgress)r!=null&&r.updating&&(++t,s+=r.updatingProgress);const i=!this.stateManager.test.updatingIgnoreRenderState&&this.state.updating;if(e=!!(e||t>0||this.updatingHandles.updating||!this.ready||!this.stationary||i||this._importControllers.size>0||this.inputManager?.updating||this.map?.allLayers?.some(r=>!r.isFulfilled())),e?(this._numUpdating=Math.max(t,this._numUpdating),s+=this._numUpdating-t):this._numUpdating=0,this._numUpdating>0?s/=this._numUpdating:s=e?0:1,this._get("updatingProgress")!==s){const r=performance.now();if(s<1){const n=Math.min((r-this._lastUpdateTime)/2e3,1);s=this.updatingProgress*(1-n)+s*n}this._set("updatingProgress",s),this._lastUpdateTime=e&&s<1?r:0}return e}get _updatingObjects(){return[this.graphicsView,this.basemapView,this._resourceController,this.stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this._featureTreeDebugger,this.toolViewManager,this.analysisViewManager]}get _updatingObjectsWithProgress(){return[this.deconflictor,this.labeler,this.basemapTerrain]}get viewingMode(){const s=this._predeterminedViewingMode;if(s!=null)return $y(s);const e=this.spatialReference;return e?this.defaultsFromMap?.viewingMode!=null&&e.equals(this.defaultsFromMap.spatialReference)?$y(this.defaultsFromMap.viewingMode):q0(e,1)?"global":"local":"global"}set viewingMode(s){this.ready?j.getLogger(this).error("#viewingMode","viewingMode cannot be set once view is ready"):this._overrideIfSome("viewingMode",s)}get viewpoint(){return this.stateManager?.viewpoint}set viewpoint(s){this.stateManager&&(this.stateManager.viewpoint=s)}get visibleArea(){return this.stateManager?.visibleArea}get zoom(){return this.stateManager.zoom}set zoom(s){this.stateManager&&(this.stateManager.zoom=s)}get highlightOptions(){return this.highlights.find(({name:s})=>s===aa)??new Wl}set highlightOptions(s){for(let e=0;e<this.highlights.length;++e)if(this.highlights.at(e).name===aa)return void this.highlights.items[e].assignFrom(s)}get resourceController(){return this._resourceController}get quality(){return this._resourceController?.memoryController?.memoryFactor??1}get resolutionScale(){return Math.sqrt(Math.min(1,this.quality/.75))}get performanceInfo(){return new GG(this)}on(s,e,t,i){return this.viewEvents.on(s,e,t,i)||super.on(s,e)}hasEventListener(s){return super.hasEventListener(s)||this.viewEvents.hasHandler(s)}toMap(s,e){if(!this.ready)return j.getLogger(this).error("#toMap()","Scene view cannot be used before it is ready"),null;const t=MC(s)?PC(this,s):s;return aG(this,t,e,this._defaultToMapOptions)}toScreen(s){if(!this.ready)return j.getLogger(this).error("#toScreen()","Scene view cannot be used before it is ready"),null;const e=(s.z==null?Yn(this.elevationProvider,s):null)??0;return Na(s,wf,this.renderSpatialReference,e),this.state.camera.projectToScreen(wf,y0),dr(y0[0],y0[1])}pixelSizeAt(s,e){if(!this.ready)return j.getLogger(this).error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null;if(!s)return 0;const t=this.renderSpatialReference;Na(s,wf,t);const i=this.state.camera.computeScreenPixelSizeAt(wf);return e&&t!==e?i*Wh(t)/Wh(e):i}overlayPixelSizeInMapUnits(s){return this.overlayManager?.overlayPixelSizeInMapUnits(s,()=>this.pixelSizeAt(s))??1}hitTest(s,e){if(!this.ready)return j.getLogger(this).error("#hitTest()","Scene view cannot be used before it is ready"),null;const t=MC(s)?PC(this,s):s;return nG(this,t,e,this._defaultHitTestOptions)}async popupHitTest(s){return xG(this,s)}goTo(s,e){return this.updatingHandles.addPromise(this.stateManager.goTo(s,e))}async whenAnalysisView(s){if(s.parent==null)throw new me("view:no-analysisview-for-analysis","The analysis does not exist in view.analyses",{analysis:s});switch(s.parent.type){case"line-of-sight":case"dimension":case"viewshed":return(await this.whenLayerView(s.parent)).whenAnalysisView();default:return this.analysisViewManager.whenAnalysisView(s)}}whenLayerView(s){return super.whenLayerView(s)}async takeScreenshot(s){const e=await this._completeSettings(s);await this.whenReady();const t=(await this.stage.renderView.takeScreenshot(e))[0];return(await k(async()=>{const{encode:i}=await Promise.resolve().then(()=>sd);return{encode:i}},void 0)).encode(t,e,this._pixelFormat())}async _takeScreenshot(s){const e=await this._completeSettings(s);await this.whenReady();const t=(await this.stage.renderView.takeScreenshot(e))[0];return(await k(async()=>{const{encodeData:i}=await Promise.resolve().then(()=>sd);return{encodeData:i}},void 0)).encodeData(t,this._pixelFormat())}async _takeScreenshotWithObjectAndLayerId(s){const e=await this._completeSettings(s);e.olidColor=!0,await this.whenReady();const t=await this.stage.renderView.takeScreenshot(e),{encodeData:i}=await k(async()=>{const{encodeData:r}=await Promise.resolve().then(()=>sd);return{encodeData:r}},void 0);return[i(t[0],this._pixelFormat()),i(t[1],this._pixelFormat())]}async _completeSettings(s){const{toRenderSettings:e,screenshotSuperSampleSettings:t}=await k(()=>Promise.resolve().then(()=>sd),void 0),i=e(s,this);return i.pixelRatio/=this.state.pixelRatio,t(i,this.supersampleScreenshotsEnabled,this.padding)}_pixelFormat(){return{flipY:!0,premultipliedAlpha:this.stage?.renderView.getAlpha()??!1}}get test(){}async takeScreenshotWithObjectAndLayerId(s){if(!Io())throw new me("360vr:objectAndLayerId-rendering-disabled","has enable-feature:objectAndLayerId-rendering must be true");const{encode:e}=await k(()=>Promise.resolve().then(()=>sd),void 0),t=await this._completeSettings(s);t.olidColor=!0,await this.whenReady();const i=await this.stage.renderView.takeScreenshot(t),r=e(i[0],t,this._pixelFormat()),n=await this._completeSettings(s);return n.format="png",[r,e(i[1],n,this._pixelFormat())]}getColorToObjectAndLayerIdMapping(){const s=this.stage.renderView.olidRenderHelper;if(s)return s.getColorToObjectAndLayerIdMapping();throw new me("360vr:objectAndLayerId-rendering-disabled","has enable-feature:objectAndLayerId-rendering must be true")}addUpdatingPromise(s){return this.updatingHandles.addPromise(s)}importLayerView(s){return VC.importLayerView(s)}hasLayerViewModule(s){return VC.hasLayerViewModule(s)}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){return this.scene?.initialViewProperties?.spatialReference||this.defaultsFromMap?.spatialReference||this.defaultsFromMap?.ready&&this._initialDefaultSpatialReference||null}getSurface(){return this.surface}async validate(){let s=wJ(this.type);const e=Ze("safari");if(e&&e<9&&(s=new me("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:e})),s!=null)throw j.getLogger(this).warn("#validate()",s.message),s}get _predeterminedViewingMode(){const s=this._isOverridden("viewingMode")?this._get("viewingMode"):this.scene?.initialViewProperties?.viewingMode;return s!=null?H0(s):null}getSpatialReferenceSupport(s,e){const t=this._predeterminedViewingMode;if(t!=null)return this._validateSpatialReferenceForViewingMode(s,e,t)?{constraints:this._makeSpatialReferenceConstraints(s,e,t)}:null;const i=this._validateSpatialReferenceForViewingMode(s,e,2),r=this._validateSpatialReferenceForViewingMode(s,e,1);return i||r?i&&r?{constraints:this._makeSpatialReferenceConstraints(s,e,null)}:i?{constraints:this._makeSpatialReferenceConstraints(s,e,2)}:{constraints:this._makeSpatialReferenceConstraints(s,e,1)}:null}_validateSpatialReferenceForViewingMode(s,e,t){return!!q0(s,t)&&(e==null||!!sC(e)||(!Bh(e)||Q_(e,s,t)!=null)&&(!rC(e)||t!==1))}_makeSpatialReferenceConstraints(s,e,t){if(e==null)return[{spatialReference:s,viewingMode:t}];const{isWebMercator:i,isWGS84:r}=s;return sC(e)&&(i||r)?!r||t===2||L1(e.tileInfo,e.fullExtent,s,1)===null?[{spatialReference:s,viewingMode:t},{spatialReference:Dt.WebMercator,viewingMode:t}]:[{spatialReference:i?Dt.WGS84:Dt.WebMercator,viewingMode:t}]:Bh(e)||rC(e)||!i&&!r?Bh(e)&&i&&t!==1?[{spatialReference:s,viewingMode:t},{spatialReference:Dt.WGS84,viewingMode:2}]:[{spatialReference:s,viewingMode:t}]:[{spatialReference:s,viewingMode:t},{spatialReference:i?Dt.WGS84:Dt.WebMercator,viewingMode:t}]}_validateSpatialReference(s){const e=this.getSpatialReferenceSupport(s)!=null,t=this._predeterminedViewingMode;return e||(t!=null?j.getLogger(this).warnOnce(`Spatial reference defined on view not supported in ${$y(t)} viewing mode.`):s.isGeographic&&j.getLogger(this).warnOnce("Spatial reference is geographic but not supported.")),e}whenReady(){return new Promise(s=>{this.ready?s(this):this._resolveWhenReady.push(s)})}trackGraphicState(s){if(!s.graphic)return j.getLogger(this).error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;const e=this.getViewForGraphic(s.graphic);let t=null,i=!1;const r=n=>{!i&&n!=null&&"processor"in n&&n.processor?.type==="graphics-3d"&&n.processor.graphicsCore&&(t=n.processor.graphicsCore.trackGraphicState(s))};return e!=null?r(e):this.whenViewForGraphic(s.graphic,{waitForLayer:!0}).then(n=>r(n),()=>{}).catch(()=>{}),xn(()=>{i=!0,t!=null&&(t.remove(),t=null)})}maskOccludee(s){if(!s)return j.getLogger(this).error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;const e=this.getViewForGraphic(s);let t=null,i=!1;const r=n=>{!i&&n!=null&&d4(n)&&(t=n.maskOccludee(s))};return e!=null?r(e):this.whenViewForGraphic(s,{waitForLayer:!0}).then(n=>r(n),()=>{}).catch(()=>{}),xn(()=>{i=!0,t!=null&&(t.remove(),t=null)})}getViewForGraphic(s){return s.layer===this?this.graphicsView:s.layer?this.allLayerViews.filter(e=>e.type!=="media-3d").find(e=>e.layer===s.layer):null}graphicChanged(s){this.graphicsView!=null&&this.graphicsView.graphicChanged(s)}async whenViewForGraphic(s,e){return s.layer===this?(await op(()=>this.graphicsView),this.graphicsView):s.layer&&this.map?e&&e.waitForLayer&&!this.map.allLayers.includes(s.layer)?new Promise((t,i)=>{const r=this.map.allLayers.on("change",n=>{n.added.includes(s.layer)&&(r.remove(),this.whenLayerView(s.layer).then(t,i))})}):this.whenLayerView(s.layer):null}enableFeatureTiles(){const s=Symbol();return this._featureTileTreeClients.add(s),xn(()=>this._featureTileTreeClients.delete(s))}async _importModule(s,e){const t=new AbortController;this._importControllers.set(s,t),this._updatingChanged();try{const i=await HJ[s]();if(e&&($I(this),He(t.signal),await e(t.signal)),this.destroyed)throw Bi();return He(t.signal),i}catch{return null}finally{this._importControllers.delete(s),this._updatingChanged()}}_abortImport(s){this._importControllers.get(s)?.abort(),this._importControllers.delete(s),this._updatingChanged()}_initBasemapTerrain(){this._set("basemapTerrain",new tP({view:this})),this.elevationProvider.register(0,this.basemapTerrain)}_exitBasemapTerrain(){const{basemapTerrain:s,elevationProvider:e}=this;s&&(this._set("basemapTerrain",null),e.unregister(s),s.destroy())}_initGlobe(){this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new Cs({view:this})),this.addHandles([this.updatingHandles.add(()=>yi.FEATURE_TILE_TREE_SHOW_TILES,s=>{s&&!this._featureTreeDebugger?this.updatingHandles.addPromise(k(()=>import("./FeatureTileTree3DDebugger-BLdqLPWf.js"),__vite__mapDeps([489,1,2,180,19,9,7,8,5,6,20,14,467,13,26,3,4,10,11,12,15,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44]))).then(({FeatureTileTree3DDebugger:e})=>{!this._featureTreeDebugger&&yi.FEATURE_TILE_TREE_SHOW_TILES&&(this._featureTreeDebugger=new e({view:this}))}):s||(this._featureTreeDebugger=Q(this._featureTreeDebugger))},Ve),this.updatingHandles.add(()=>({basemapExtent:this.basemapTerrain?.extent,basemapSpatialReference:this.basemapTerrain?.spatialReference,clippingArea:this.clippingArea,featureTiles:this._featureTiles}),({basemapExtent:s,basemapSpatialReference:e,clippingArea:t,featureTiles:i})=>{if(!i)return;const r=!!s;if(t||r)if(r&&e){const n=s&&e?Np(A$(s,e),this.spatialReference):null;i.filterExtent=t?t.intersection(n):n}else i.filterExtent=t;else i.filterExtent=null},Ve),this.updatingHandles.add(()=>this._featureTileTreeClients.size>0,s=>{s?this.updatingHandles.addPromise(this._ensureFeatureTileTree()):this._featureTiles=Q(this._featureTiles)},Ae)],EM),this.stateManager.init()}async _ensureFeatureTileTree(){if(this._featureTiles||this._importControllers.has("FeatureTileTree3D"))return;const s=(await this.updatingHandles.addPromise(this._importModule("FeatureTileTree3D")))?.FeatureTileTree3D;s&&(this._featureTiles=new s({renderCoordsHelper:this.renderCoordsHelper,pointsOfInterest:this.pointsOfInterest,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}),this._updatingChanged())}_exitTerrain(){this.stateManager.exit(),this.removeHandles(_0),this.removeHandles(EM),this._featureTiles=Q(this.featureTiles),this._set("pointsOfInterest",Q(this.pointsOfInterest)),this._exitBasemapTerrain(),this.state.reset(),this._exitCoordinateSystem()}_initCoordinateSystem(){if(this.spatialReference){const s=this.spatialReference,e=this.state.isGlobal,t=f5(e,s);t!==this.renderSpatialReference&&(this._set("renderCoordsHelper",g5.create(this.state.viewingMode,t)),e||this.addHandles($(()=>this.basemapTerrain?.extent,i=>{const r=this.renderCoordsHelper.spatialReference;i==null||i[0]===0&&i[1]===0&&i[2]===0&&i[3]===0||!i1(i,this.basemapTerrain.spatialReference,AM,r)||(this.renderCoordsHelper.extent=AM)},Ae),_0),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(Og/this.renderCoordsHelper.unitInMeters))}else this._set("renderCoordsHelper",null)}_exitCoordinateSystem(){this.removeHandles(_0),this._set("renderCoordsHelper",null)}_updatingChanged(){this.notifyChange("updating")}_updateUpdatingMonitors(s=null){s!=null&&s.type===4||(this.removeHandles("updatingMonitors"),this.allLayerViews.forEach(e=>{e.destroyed||(this.addHandles($(()=>[e.updating,e.updatingProgress],()=>this._updatingChanged(),Ae),"updatingMonitors"),e.when(()=>this._updatingChanged(),()=>this._updatingChanged()))}),this._updatingChanged())}async _prepareScreenshotOverlay(){this.overlay&&await this.overlay.prepare()}_renderScreenshotOverlay(s,e,t){if(!this.overlay||!this.overlay.hasVisibleItems)return t;const i=s.getContext("2d",{willReadFrequently:!0});return i.putImageData(t,0,0),this.overlay.renderCanvas(s,{disableDecorations:e}),i.getImageData(0,0,t.width,t.height)}_initStage(){const s={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,preserveDrawingBuffer:this.preserveDrawingBufferEnabled,canvas:this.renderCanvas,screenshot:{prepareOverlay:()=>this._prepareScreenshotOverlay(),renderOverlay:(i,r,n)=>this._renderScreenshotOverlay(i,r,n)}},e=new pG(this.state.viewingMode,i=>this.stage.layers.forEach(i),this);this._set("sceneIntersectionHelper",e);const t=Ew(this.surface);this._stage=new Cr({view:this,options:s,container:t}),this.notifyChange("stage"),this._updateSlice(),this.addHandles([this.updatingHandles.add(()=>this.qualitySettings.highQualityTransparency,i=>this.stage.renderer.setParameters({highQualityTransparency:i}),Re),this.on("pointer-move",()=>this.stage?.renderer.resetAnimation()),IM(this.stage.renderView.canvas,"webglcontextlost",i=>{this.fatalError=new me("webgl-context-lost",i.statusMessage)})],"stage"),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(Og/this.renderCoordsHelper.unitInMeters),this._set("canvas",this.stage.renderView.canvas)}_exitStage(){this.sceneIntersectionHelper?.destroy(),this._set("sceneIntersectionHelper",null),this._stage=Q(this.stage),this._set("stage",null),this.removeHandles("stage"),this._set("canvas",null)}_initSurface(){this._exitSurface(),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new ZG({view:this,resourceController:this._resourceController})}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitTerrain(),this._exitStage())}async _ensureGraphicsView(){if(this.graphicsView||this._importControllers.has("GraphicsView3D")||this.graphics.length===0)return;this.removeHandles("GraphicsView3D");const s=(await this.updatingHandles.addPromise(this._importModule("GraphicsView3D",e=>op(()=>this.basemapTerrain?.ready,e))))?.default;s&&this._set("graphicsView",new s({view:this,getGraphics:()=>this.graphics})),this._updatingChanged()}_disposeGraphicsView(){this._abortImport("GraphicsView3D"),this.removeHandles("GraphicsView3D"),this.graphicsView&&(this.removeHandles(this.graphicsView.processor.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}_disposeFocusAreasView(){this._abortImport("FocusAreasView"),this.removeHandles("FocusAreasView"),this.focusAreasView=Q(this.focusAreasView)}async _ensureFocusAreasView(s){if(this.focusAreasView||this._importControllers.has("FocusAreasView")||s===0)return;this.removeHandles("FocusAreasView");const e=(await this.updatingHandles.addPromise(this._importModule("FocusAreasView")))?.FocusAreasView;e&&(this.focusAreasView=new e({view:this})),this._updatingChanged()}_startup(){H0(this.viewingMode)===1&&(this._clippingArea=null),this._initSurface(),this._set("ready",!0),this.addHandles(Ds(()=>this.graphics,"after-changes",()=>this._ensureGraphicsView()),"GraphicsView3D"),this._ensureGraphicsView(),this.addHandles($(()=>this.map?.focusAreas?.areas.length??0,i=>this._ensureFocusAreasView(i),{initial:!0}),"FocusAreasView");const s=this.scene?.initialViewProperties??null,e=s?.environment;e&&(this._overrideDefaultEnvironmentOnly?SR(this.environment,e):this.environment=this.environment.cloneWithWebsceneEnvironment(e)),this.timeExtent=s?.timeExtent,s?.analyses.applyTo(this),this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect();const t=this._resolveWhenReady;this._resolveWhenReady=[],t.forEach(i=>i(this))}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this._overrideDefaultEnvironmentOnly=!1,this.labeler.dispose(),this._disposeGraphicsView(),this._disposeFocusAreasView(),this._exitSurface(),this._set("ready",!1)}get _defaultToMapOptions(){const s={include:new Set};if(!this.map)return s;this.map.ground&&s.include.add(Ao);for(const e of this.allLayerViews)Xh(e.layer)&&s.include.add(e.uid);return s}get _defaultHitTestOptions(){const s={exclude:new Set};if(!this.map)return s;this.map.ground&&this.map.ground.opacity<1&&s.exclude.add(Ao);for(const e of this.allLayerViews)Xh(e.layer)&&e.layer.opacity<1&&s.exclude.add(e.uid);return s}static{this.type="3d"}static clearStatics(){$F(),RI(),IF(),F4(),iH(),eF(),K6(),GF(),_J(),CF(),w9(),I8(),nU(),vU(),FF(),OI(),WZ(),N7(),X6.cleanupI3SLodHandling(),x5.cleanupTilemapCache(),DS.cleanupViewstate(),tP.cleanupTerrainSurface()}};function bf(s,e){return s!=null&&D$(s.spatialReference,e)?Np(s,e):null}u([p()],Z.prototype,"_userClippingArea",void 0),u([p()],Z.prototype,"_resourceController",void 0),u([p()],Z.prototype,"stage",null),u([p({readOnly:!0})],Z.prototype,"deconflictor",void 0),u([p({readOnly:!0})],Z.prototype,"labeler",void 0),u([p(M0(su,"analyses"))],Z.prototype,"analyses",void 0),u([p({type:ru,readOnly:!0})],Z.prototype,"animation",null),u([p()],Z.prototype,"animationsEnabled",void 0),u([p({readOnly:!0})],Z.prototype,"basemapTerrain",void 0),u([p({readOnly:!0})],Z.prototype,"overlayManager",null),u([p({readOnly:!0})],Z.prototype,"elevationProvider",void 0),u([p()],Z.prototype,"camera",null),u([p({type:Qs})],Z.prototype,"contentCamera",null),u([p({readOnly:!0})],Z.prototype,"canvas",null),u([p({type:wt})],Z.prototype,"center",null),u([p({type:is})],Z.prototype,"clippingArea",null),u([p({type:Dl,nonNullable:!0})],Z.prototype,"constraints",void 0),u([p({type:is,readOnly:!0})],Z.prototype,"renderDataExtent",null),u([p({readOnly:!0})],Z.prototype,"tileInfo",null),u([p({type:is,readOnly:!0})],Z.prototype,"dataExtent",null),u([p({type:is,readOnly:!0})],Z.prototype,"_groundAndLayersExtent",null),u([p({type:uh})],Z.prototype,"environment",null),u([Ba("environment")],Z.prototype,"castEnvironment",null),u([p({readOnly:!0})],Z.prototype,"environmentManager",void 0),u([p({type:is})],Z.prototype,"extent",null),u([p({type:Pt})],Z.prototype,"floors",void 0),u([p()],Z.prototype,"screenCenter",null),u([p()],Z.prototype,"frustum",null),u([p({type:Number,readOnly:!0})],Z.prototype,"fullOpacity",void 0),u([p({readOnly:!0})],Z.prototype,"graphicsView",void 0),u([p()],Z.prototype,"analysisViewManager",void 0),u([p()],Z.prototype,"groundView",void 0),u([p({readOnly:!0})],Z.prototype,"layerviewCollections",null),u([p({type:Boolean})],Z.prototype,"initialExtentRequired",null),u([p()],Z.prototype,"defaultsFromMapSettings",null),u([p()],Z.prototype,"interacting",null),u([p()],Z.prototype,"stationary",null),u([p()],Z.prototype,"navigating",null),u([p()],Z.prototype,"map",void 0),u([p()],Z.prototype,"padding",null),u([p({type:Cs,readOnly:!0})],Z.prototype,"pointsOfInterest",void 0),u([p()],Z.prototype,"_featureTiles",void 0),u([p()],Z.prototype,"featureTiles",null),u([p()],Z.prototype,"_featureTreeDebugger",void 0),u([p({constructOnly:!0})],Z.prototype,"deactivatedWebGLExtensions",void 0),u([p({constructOnly:!0})],Z.prototype,"debugWebGLExtensions",void 0),u([p({constructOnly:!0})],Z.prototype,"renderCanvas",void 0),u([p({constructOnly:!0})],Z.prototype,"state",void 0),u([p()],Z.prototype,"screenSizePerspective",void 0),u([p({readOnly:!0})],Z.prototype,"inputManager",void 0),u([p({readOnly:!0})],Z.prototype,"stateManager",void 0),u([p({type:["low","medium","high"]})],Z.prototype,"qualityProfile",null),u([p({type:VS,get(){let s=this._get("qualitySettings");return s||(s=new VS,tg.apply(this.qualityProfile,s)),s}})],Z.prototype,"qualitySettings",void 0),u([p()],Z.prototype,"slice",void 0),u([p({readOnly:!0})],Z.prototype,"typeSpecificPreconditionsReady",null),u([p({readOnly:!0})],Z.prototype,"renderCoordsHelper",void 0),u([p({readOnly:!0})],Z.prototype,"sceneIntersectionHelper",void 0),u([p({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],Z.prototype,"resolution",null),u([p({type:Number})],Z.prototype,"scale",null),u([p({readOnly:!0,type:Number})],Z.prototype,"terrainLevel",null),u([p()],Z.prototype,"heightModelInfo",null),u([p()],Z.prototype,"spatialReference",void 0),u([p({type:Boolean,value:!1})],Z.prototype,"alphaCompositingEnabled",null),u([p({constructOnly:!0})],Z.prototype,"preserveDrawingBufferEnabled",void 0),u([p({type:Boolean})],Z.prototype,"supersampleScreenshotsEnabled",void 0),u([p({readOnly:!0})],Z.prototype,"type",void 0),u([p(),Ba(s=>s instanceof Z3?s:DI(X3,s))],Z.prototype,"ui",void 0),u([p({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.updating","toolViewManager.updating","analysisViewManager.updating","state.updating","textures.updating"]})],Z.prototype,"updating",null),u([p()],Z.prototype,"_updatingObjects",null),u([p()],Z.prototype,"_updatingObjectsWithProgress",null),u([p({type:Number,readOnly:!0,dependsOn:["updating"]})],Z.prototype,"updatingProgress",void 0),u([p({type:["global","local"]})],Z.prototype,"viewingMode",null),u([p({type:Bo})],Z.prototype,"viewpoint",null),u([p({readOnly:!0})],Z.prototype,"visibleArea",null),u([p({type:Number})],Z.prototype,"zoom",null),u([p({type:Wl})],Z.prototype,"highlightOptions",null),u([p({readOnly:!0})],Z.prototype,"quality",null),u([p({readOnly:!0})],Z.prototype,"resolutionScale",null),u([p()],Z.prototype,"focusAreasView",void 0),u([p()],Z.prototype,"_defaultToMapOptions",null),u([p()],Z.prototype,"_defaultHitTestOptions",null),Z=fw=u([R("esri.views.SceneView")],Z);const wf=x(),y0=ii(),AM=Mt(),HJ={GraphicsView3D:()=>k(()=>import("./GraphicsView3D-DiSFd0nr.js"),__vite__mapDeps([490,1,2,15,5,6,7,8,4,9,10,12,323,26,3,11,13,14,27,28,19,20,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,63,180,207,70,186,183,88,185,87,182,184,187,188,189,190,191,192,193,194,195,196,197,102,198,199,200,93,201,202,203,92,94,90,95,204,208,209,210,98,211,307,57,276,76,114,232,233,48,49,62,54,55,56,58,52,59,60,61,64,65,69,16,99,277,47,205,206,178,227,18,166,308,281,282,21,22,23,24,113,175,129,122,212,213,214,215,216,217,147,218,219,220,144,221,222,223,224,71,161,51,225,226,228,229,142,83,84,85,82,81,230,132,231,234,100,235,236,237,238,239,80,240,241,242,243,244,245,246,247,248,249,250])),FocusAreasView:()=>k(()=>import("./FocusAreasView-Jv5gIisy.js"),__vite__mapDeps([491,1,4,5,6,7,8,2,9,10,352,39,102,28,19,20,14,492,424,421,419,422,423,425,429,426,427,197,70,38,184,247,13,445,183,37,292,307,57,26,3,11,12,15,27,29,30,31,32,33,34,35,36,40,41,42,43,44,207,186,88,185,87,182,187,188,189,190,191,192,193,194,195,196,198,199,200,93,201,202,203,92,94,90,95,204,208,209,210,98,211,415,416,166,241,413,236,132,131,394,386,395,329,414,18,21,16,22,23,24,113,114,205,206,175,129,122,52,212,76,213,214,180,47,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,227,228,229,142,83,84,85,82,81,230,231,232,233,234,99,100,235,237,238,239,80,240,242,243,244,245,246,248,249,250])),FeatureTileTree3D:()=>k(()=>import("./FeatureTileTree3D-CBoi7U_6.js"),__vite__mapDeps([493,1,4,5,6,7,8,2,9,10,18,20,14,302,183,19,190,187,70,88,188,39,189,186,87,191,196,102,28,182,184,185,192,13,193,37,38,194,195,197,198,199,200,35,11,12,93,201,202,203,92,94,27,90,95,204,227,29,21,16,22,23,24,113,114,205,206,175,26,3,15,30,31,32,33,34,36,40,41,42,43,44,129,207,208,209,210,98,211,122,52,212,76,213,214,180,47,215,216,217,147,218,219,220,144,221,222,223,69,224,71,161,51,48,49,225,226,228,229,142,83,84,85,82,81,230,166,132,231,232,233,234,99,100,235,236,237,238,239,80,240,241,242,243,244,245,246,247,248,249,250]))},qJ=Z,gme=Object.freeze(Object.defineProperty({__proto__:null,default:qJ},Symbol.toStringTag,{value:"Module"})),GJ=Object.freeze(Object.defineProperty({__proto__:null,CloudsPassParameters:c1,build:fO,cubeMapSize:Nh},Symbol.toStringTag,{value:"Module"})),jJ=Object.freeze(Object.defineProperty({__proto__:null,NoiseTextureAtlasPassParameters:h1,build:gO},Symbol.toStringTag,{value:"Module"})),WJ=Object.freeze(Object.defineProperty({__proto__:null,build:vO},Symbol.toStringTag,{value:"Module"})),QJ=Object.freeze(Object.defineProperty({__proto__:null,build:UD},Symbol.toStringTag,{value:"Module"})),ZJ=Object.freeze(Object.defineProperty({__proto__:null,build:dE},Symbol.toStringTag,{value:"Module"})),XJ=Object.freeze(Object.defineProperty({__proto__:null,HighlightBlurDrawParameters:N1,build:pE},Symbol.toStringTag,{value:"Module"})),YJ=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:k1,blurSize:z1,build:uE,gridCellPixelSize:Po,outlineSize:Op},Symbol.toStringTag,{value:"Module"})),KJ=Object.freeze(Object.defineProperty({__proto__:null,build:mE},Symbol.toStringTag,{value:"Module"})),JJ=Object.freeze(Object.defineProperty({__proto__:null,build:CE,ribbonlineNumRoundJoinSubdivisions:Dp},Symbol.toStringTag,{value:"Module"})),eee=Object.freeze(Object.defineProperty({__proto__:null,TextureOnlyPassParameters:V1,build:hE},Symbol.toStringTag,{value:"Module"})),tee=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:G1,build:$E},Symbol.toStringTag,{value:"Module"})),iee=Object.freeze(Object.defineProperty({__proto__:null,build:rA},Symbol.toStringTag,{value:"Module"})),see=Object.freeze(Object.defineProperty({__proto__:null,ColorizerHillshadeUniforms:pA,ColorizerStretchUniforms:dA,ColorizerUniforms:X_,build:mA},Symbol.toStringTag,{value:"Module"})),ree=Object.freeze(Object.defineProperty({__proto__:null,TerrainPassParameters:nx,build:CA},Symbol.toStringTag,{value:"Module"})),nee=Object.freeze(Object.defineProperty({__proto__:null,build:MA},Symbol.toStringTag,{value:"Module"})),aee=Object.freeze(Object.defineProperty({__proto__:null,AtmosphereCompositingPassParameters:ox,build:RA},Symbol.toStringTag,{value:"Module"})),oee=Object.freeze(Object.defineProperty({__proto__:null,build:OA},Symbol.toStringTag,{value:"Module"})),lee=Object.freeze(Object.defineProperty({__proto__:null,FogPassParameters:lx,build:AA},Symbol.toStringTag,{value:"Module"})),cee=Object.freeze(Object.defineProperty({__proto__:null,CompositingPassParameters:Y_,build:FA},Symbol.toStringTag,{value:"Module"})),hee=Object.freeze(Object.defineProperty({__proto__:null,SilhouetteCircle:hx,SimpleAtmospherePassParameters:K_,build:VA},Symbol.toStringTag,{value:"Module"})),uee=Object.freeze(Object.defineProperty({__proto__:null,build:WA},Symbol.toStringTag,{value:"Module"})),dee=Object.freeze(Object.defineProperty({__proto__:null,GlowBlurPassParameters:px,build:n3},Symbol.toStringTag,{value:"Module"})),pee=Object.freeze(Object.defineProperty({__proto__:null,GlowCompositionPassParameters:mx,build:a3},Symbol.toStringTag,{value:"Module"})),mee=Object.freeze(Object.defineProperty({__proto__:null,HazeCompositingPassParameters:fx,build:o3},Symbol.toStringTag,{value:"Module"})),fee=Object.freeze(Object.defineProperty({__proto__:null,build:l3},Symbol.toStringTag,{value:"Module"})),gee=Object.freeze(Object.defineProperty({__proto__:null,build:h3},Symbol.toStringTag,{value:"Module"})),_ee=Object.freeze(Object.defineProperty({__proto__:null,MagnifierPassParameters:gx,build:u3},Symbol.toStringTag,{value:"Module"})),yee=Object.freeze(Object.defineProperty({__proto__:null,build:d3},Symbol.toStringTag,{value:"Module"})),vee=Object.freeze(Object.defineProperty({__proto__:null,build:p3},Symbol.toStringTag,{value:"Module"})),bee=Object.freeze(Object.defineProperty({__proto__:null,build:m3},Symbol.toStringTag,{value:"Module"})),wee=Object.freeze(Object.defineProperty({__proto__:null,build:f3},Symbol.toStringTag,{value:"Module"})),xee=Object.freeze(Object.defineProperty({__proto__:null,HUDCompositingPassParameters:_x,build:_3},Symbol.toStringTag,{value:"Module"})),Cee=Object.freeze(Object.defineProperty({__proto__:null,OITBlendPassParameters:yx,build:x3},Symbol.toStringTag,{value:"Module"})),Tee=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastVisualizePassParameters:vx,build:S3},Symbol.toStringTag,{value:"Module"})),See=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastMaxSamples:Kp,build:T3},Symbol.toStringTag,{value:"Module"})),Pee=Object.freeze(Object.defineProperty({__proto__:null,build:R3},Symbol.toStringTag,{value:"Module"}));export{Qre as $,Xre as A,cce as B,Yre as C,L1 as D,v1 as E,Hre as F,Wne as G,cH as H,H_ as I,f8 as J,kre as K,l1 as L,Wre as M,pae as N,dae as O,$1 as P,MD as Q,oH as R,Wp as S,SJ as T,dle as U,yJ as V,ame as W,nme as X,Joe as Y,r6 as Z,Qne as _,jne as a,ZZ as a$,zD as a0,eae as a1,DD as a2,$D as a3,dz as a4,QD as a5,rG as a6,Fre as a7,Fa as a8,kn as a9,fJ as aA,aH as aB,Are as aC,zre as aD,Bre as aE,lH as aF,Wi as aG,Nce as aH,foe as aI,PR as aJ,A6 as aK,P6 as aL,T6 as aM,hae as aN,cae as aO,ja as aP,Dae as aQ,loe as aR,SE as aS,kD as aT,Ec as aU,p6 as aV,Nq as aW,I6 as aX,o8 as aY,Zie as aZ,Cu as a_,dj as aa,ZD as ab,c_ as ac,rQ as ad,ome as ae,lme as af,PJ as ag,Wue as ah,HA as ai,Gue as aj,Wie as ak,jie as al,eE as am,X_ as an,gJ as ao,gre as ap,J8 as aq,Mn as ar,jse as as,_ae as at,ia as au,DE as av,fS as aw,Hie as ax,rre as ay,i1 as az,rse as b,Yne as b$,uae as b0,X6 as b1,H0 as b2,MG as b3,kS as b4,Wm as b5,Nre as b6,NW as b7,PW as b8,Yl as b9,LA as bA,qA as bB,ZA as bC,NZ as bD,CZ as bE,OY as bF,cx as bG,un as bH,Hn as bI,jo as bJ,Wo as bK,wu as bL,Kk as bM,Ire as bN,Vae as bO,wae as bP,m6 as bQ,d6 as bR,Oq as bS,hS as bT,u6 as bU,kq as bV,gae as bW,Kne as bX,Zq as bY,Mr as bZ,Yq as b_,Wa as ba,Rj as bb,Oj as bc,KD as bd,XD as be,uj as bf,Vk as bg,qie as bh,Gie as bi,dD as bj,Vre as bk,Kre as bl,FJ as bm,bM as bn,lle as bo,Ib as bp,Yn as bq,Kj as br,c8 as bs,Jj as bt,g_ as bu,Nb as bv,wE as bw,zle as bx,fz as by,lU as bz,aa as c,jq as c0,q9 as c1,qq as c2,Gq as c3,Xne as c4,Rh as c5,z6 as c6,F6 as c7,V6 as c8,Hq as c9,Uhe as ca,V9 as cb,gme as cc,Loe as d,cle as e,rE as f,ez as g,cQ as h,yre as i,$p as j,vre as k,Rq as l,j4 as m,fc as n,dS as o,nse as p,jre as q,Fae as r,Lre as s,pj as t,q_ as u,Gre as v,Zre as w,Ure as x,qre as y,uH as z};
