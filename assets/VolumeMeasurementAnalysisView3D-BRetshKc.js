import{l as J,_ as n,m as u,a as M,s as zt,G as Ut,bb as I,i as qt,u as F,a8 as Ht,ag as De,V as Se,ad as It}from"./jsonMap-Bs3hmeCU.js";import{bA as mt,ax as fe,af as ye,b as Ee}from"./Point-BN8RINcc.js";import{n as f,i as gt,r as _t,b as je,t as ke}from"./collectionUtils-Dk3LoVuX.js";import{e as Bt}from"./getDefaultUnitForView-DwTC0lpI.js";import{e as Nt}from"./AnalysisView3D-zhHEgrUR.js";import{u as b}from"./Color-CERqXxxY.js";import{h as S,l as w,f as Wt,w as N,U as ft,e as Xt}from"./reactiveUtils-SO2Ko3sy.js";import{f as Qt}from"./screenUtils-BitdhK1O.js";import{e as yt}from"./earcut-D9gy186-.js";import{e as A}from"./mat4f64-q_b6UJoq.js";import{o as me,X as Ae,s as Kt,A as W,c as K,_ as ze,P as Ue,I as Zt}from"./vec32-CNF8e3LG.js";import{h as vt}from"./UpdatingHandles-D2RI_3Hb.js";import{X as Jt}from"./projectionUtils-zKDw1yLq.js";import{f as wt}from"./computeTranslationToOriginAndRotation-Cz93wRWF.js";import{bN as ae,s as Yt,ar as bt,o as ve,az as ei,bq as ti,aF as ii}from"./ShadowCastClear.glsl-Bhq9MYuW.js";import{i as Ct,o as Vt,y as we,l as be,M as xt,K as Pe,d as ri}from"./aaBoundingRect-CrU5VtR_.js";import{e as Ce}from"./DoubleArray-DExKNiTh.js";import{r as Pt}from"./vec3-B_phcnZY.js";import{c as Ve}from"./ElevationInfo-BWnVyl7x.js";import{a as oi,p as le,w as si}from"./ShadedColorMaterial.glsl-BVRWw9mq.js";import{P as ni}from"./RealisticTree.glsl-IWCjmMLr.js";import{r as xe,X as ai}from"./Graphics3DExtrudeSymbolLayer-CaXhay6G.js";import{i as qe,s as li}from"./mathUtils-PIGhLnI9.js";import{i as Ft,Q as ui,x as ci}from"./mat4-n_G6OS58.js";import{bf as hi,af as pi,T as Y,V as ee,aW as Fe,aX as di,a1 as te,a2 as ie,b1 as $e,a3 as re,a8 as oe,X as mi,bF as gi,aV as He,aq as _i,bG as fi,at as yi,b2 as $t,bc as Tt,b3 as ge,g as vi,x as Rt,au as wi,ao as bi,an as Ci,bb as Vi,bH as Ie,C as xi,bI as Be,bJ as ue,bd as Pi}from"./Texture-Cw36TGeQ.js";import{Q as Gt,t as Mt}from"./InterleavedLayout-8W9JN4bc.js";import{_ as se}from"./index-C-2WWcaK.js";import{_ as H,R as Fi,n as _e}from"./enums-B4pqBiXb.js";import{a5 as Ne,ad as We}from"./euclideanLengthMeasurementUtils-Dd_tZ3Tl.js";import{f as Xe}from"./intl-BvIZ3ldN.js";import{s as $i}from"./Cyclical-BLSxUpe7.js";import{d as Ti}from"./quantityFormatUtils-DalIiLRy.js";import{f as Qe}from"./Indices-D0_UQPPr.js";import{u as Ri,c as ce,a as Gi}from"./vector-CGHTqcz0.js";import{f as Ke,m as Mi}from"./Segment-agewC3Lx.js";import{R as Ze}from"./OutlineVisualElement-eIow42DI.js";import{n as Oi}from"./VertexElementDescriptor-BlxU8vCE.js";import{h as Li}from"./lineStippleUtils-CCavR4OV.js";import{s as Je}from"./substitute-4zVNxrc6.js";import{_ as Di}from"./Graphic-BiQTZi7k.js";import Si from"./GraphicsLayer-Q6w67hlG.js";import{m as Ei}from"./SimpleFillSymbol-CDawtd9z.js";import{_ as ji,S as ki}from"./SlicePlaneMaterial.glsl-D1xrJL8Z.js";import{T as Ai}from"./dragEventPipeline3D-D_wkf_Q_.js";import{r as zi,p as Ui,j as qi}from"./InteractiveToolBase-DYdTOPhs.js";import{l as Ot,a as Ye}from"./SketchOptions-Dguq2sp8.js";import{r as Hi,R as Ii,H as Bi}from"./SketchTooltipInfo-BLL27XaA.js";import{h as Ni}from"./TooltipInfoWithCoordinates-BTo8UQ9O.js";import{s as Wi,d as Xi}from"./SketchViewModel-D3if6G7x.js";import{a as Qi}from"./allLayerSnapping-D12oZ67L.js";import{j as B,t as z,f as Ki}from"./Emissions.glsl-B8XKMjLy.js";import"./Polygon-BdLNJfwi.js";import{n as Zi}from"./vec2f64-rIxtbMRN.js";import{n as Ji}from"./vec4f64-DPb6J-GU.js";import"./reader-DcGs6kKN.js";import"./Extent-Bbnm65bN.js";import"./SimpleObservable-CvFyr0NA.js";import"./Polyline-BtUG5wiC.js";import"./jsonUtils-UGNxUp3z.js";import"./typeUtils-Dk-Jta7H.js";import"./modeUtils-DKmpkquP.js";import"./uuid-Oe6SV2kF.js";import"./sanitizerUtils-BT_8V5US.js";import"./lengthUtils-Ceo6858g.js";import"./date-IqUzANpt.js";import"./workers-D8pWeOqp.js";import"./Queue-CYlrXMwB.js";import"./PooledRBush-Dco5QkUp.js";import"./quickselect-QQC62dOK.js";import"./GraphicsCollection-CbLe7TzM.js";import"./HeightModelInfo-DRFN7tKf.js";import"./spatialReferenceEllipsoidUtils-T3ZM6b8E.js";import"./projectPointToVector-CELlCh-8.js";import"./scaleUtils-en5WDx65.js";import"./layerUtils-Ca2TiN3a.js";import"./Layer-Ciy6IOGe.js";import"./TilemapCache-obN_L5Xm.js";import"./LRUCache-fy84PBMi.js";import"./TileKey-jKcqhCzg.js";import"./memoryEstimations-Bd726a_p.js";import"./tagSymbols-BPcGfZon.js";import"./asyncUtils-w6KfWU41.js";import"./signal-BX9ezF8a.js";import"./Map-BG-ZPeaW.js";import"./Basemap-BBszaJs6.js";import"./loadAll-B7O5Buv4.js";import"./PortalItem-JZSYzcdX.js";import"./writeUtils-DAWG90I-.js";import"./CollectionFlattener-Cag-8feq.js";import"./opacityUtils-DuFH0EC9.js";import"./persistable-CuCo7Cu3.js";import"./MD5-MtSiOt06.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw.js";import"./resourceExtension-B0hY4a0f.js";import"./PolygonCollection-90Z4vnqc.js";import"./mat4f32-Djp3mnm5.js";import"./TablesMixin-BFz-cIJ-.js";import"./timeZoneUtils-BSc7-7qA.js";import"./ReactiveMap-B0by2bYu.js";import"./Query-CikRiKlY.js";import"./Field-Cm_ZejYW.js";import"./fieldType-DVUzXtk_.js";import"./normalizeUtils-BDt2F_N3.js";import"./normalizeUtilsCommon-rK4fWGKa.js";import"./utils-DBDpKdtI.js";import"./utils-DQFbn7-c.js";import"./ElevationQuery-pJqr5aW2.js";import"./TileInfo-Y7H9liCK.js";import"./plane-CYSvzg5X.js";import"./vec42-CkbV-zLi.js";import"./vec3f32-WCVSSNPR.js";import"./Scheduler-CNrsbccs.js";import"./ExtrudeSymbol3DLayer-DSc1ou2x.js";import"./sphere-9lseHxo-.js";import"./constants-D67WmGms.js";import"./quat-CK9e8_eG.js";import"./quatf64-CCm9z-pX.js";import"./projectVectorToVector-DkxXb83V.js";import"./aaBoundingBox-CtkshuSS.js";import"./frustum-BypfKDJS.js";import"./floatRGBA-CYO4yRwl.js";import"./labelUtils-BtizwBfq.js";import"./ArcadeExpression-Ddk8yIk3.js";import"./TimeOnly-Du0ClqSA.js";import"./enum-BzLwmiID.js";import"./UnknownTimeZone-B697BDFv.js";import"./FieldsIndex-B72TFK42.js";import"./TileKey-C44YQC4_.js";import"./typeUtils-W6WEjFtn.js";import"./lineMarkers-CDwLe3J6.js";import"./PolygonSymbol3D-D50k8Fcq.js";import"./Font-Ct7_LYCJ.js";import"./PictureMarkerSymbol-LudhOruE.js";import"./SimpleMarkerSymbol-BGAFRS9_.js";import"./TextSymbol-DH6PXxVy.js";import"./layerViewUtils-BTa15X3o.js";import"./unitConversionUtils-BEb-Sf7Y.js";import"./BufferView-BMlFYMIb.js";import"./orientedBoundingBox-VXwBwem5.js";import"./vec2f32-CaVKkSa6.js";import"./dehydratedFeatures-Brxjc3JN.js";import"./quantizationUtils-BuQfweOC.js";import"./featureConversionUtils-yVOZE0te.js";import"./OptimizedFeature-CwRGZPwv.js";import"./OptimizedFeatureSet-BR8EEvDc.js";import"./createFeatureId-CVwTD0fV.js";import"./Octree-Bb_mCzwl.js";import"./elevationInfoUtils-DOC7auVy.js";import"./HUDIntersectorResult-D3KkIdaq.js";import"./intersectorUtilsConversions-U5KUl8sG.js";import"./Intersector-BDgm95L3.js";import"./DefaultLoadingContext-D5ihlAAW.js";import"./wosrLoader-Bo3AtRk9.js";import"./Version-BtYZEj58.js";import"./axisAngleDegrees-BIah1hxG.js";import"./edgePreprocessing-YzR1XaHD.js";import"./config-Dg972SSE.js";import"./GeometryUtils-BoySfe8Y.js";import"./definitions-Dvg4hMIw.js";import"./WorkerHandle-nVMczE_1.js";import"./colorUtils-Chvbp2-y.js";import"./vec33-CWJeyzxV.js";import"./capabilities-Bi6C4OG6.js";import"./imageUtils-DFuQNq2S.js";import"./VisualElement-By4iq8p4.js";import"./line-CK0BnMAu.js";import"./ColorMaterial.glsl-iVY8sJRd.js";import"./TriangleMaterial-DyU1F4o5.js";import"./meshVertexSpaceUtils-DM2fDb9e.js";import"./MeshLocalVertexSpace-oQGry7Qx.js";import"./SnappingCandidate-DGkpYqI6.js";import"./renderingInfoUtils-BXcQx9dw.js";import"./visualVariableUtils-CQqBkcYu.js";import"./triangulationUtils-nC-pDh1J.js";import"./deduplicate-Lzwo1kX7.js";import"./videoUtils-Dwx3AEgj.js";import"./types-BKo2foNY.js";import"./utils-DTE-xBiC.js";import"./geometry2dUtils-CYnL6wJ1.js";import"./geodeticLengthOperator-CGvLaEl3.js";import"./geodeticCurveType-CirnHLSB.js";import"./TextOverlayItem-BD2PDyJ-.js";import"./EngineVisualElement-CkOmELQC.js";import"./LaserlinePath.glsl-Bs_lKAf8.js";import"./line-BWLsbDhz.js";import"./getPopupProvider-DjIxdahS.js";import"./BlendLayer-DdoZXYgY.js";import"./layerContainerType-CSXZNpHb.js";import"./jsonUtils-CnXU3mjx.js";import"./ScaleRangeLayer-DQr2T3Hh.js";import"./sliceToolConfig-BnawSSVt.js";import"./DefaultLayouts-Bl15_2Jf.js";import"./EditGeometryOperations-B4UKkiuM.js";import"./rotate-C0W4p449.js";import"./curveOperationUtils-CTvChjIC.js";import"./MeshTransform-CvcT8cWk.js";import"./a11yUtils-B9mR-UhZ.js";import"./angularMeasurementUtils-C4Sm3V2r.js";import"./automaticAreaMeasurementUtils-BXt-1YKV.js";import"./geodesicAreaMeasurementUtils-DN9_D2hv.js";import"./automaticLengthMeasurementUtils-Dre-iSuB.js";const et=new b("black");let Yi=class{constructor(){this.geometryOutlineWidth=1.5,this.geometryOutlineColor=new b("rgb(128,128,128)"),this.cutColor=new b("rgba(153, 198, 111, 0.75)"),this.fillColor=new b("rgba(200, 200, 230, 0.75)"),this.cutColorMuted=new b("rgba(176, 176, 176, 0.75)"),this.fillColorMuted=new b("rgba(194, 194, 194, 0.75)"),this.cutProjectionLineColor=b.blendColors(this.cutColor,et,.4),this.fillProjectionLineColor=b.blendColors(this.fillColor,et,.4),this.projectionLineWidth=2,this.projectionLineStippleSize=4,this.labelDistance=40,this.labelPrecisions={"cubic-millimeters":0,"cubic-centimeters":0,"cubic-decimeters":1,"cubic-meters":2,"cubic-kilometers":6,"cubic-inches":0,"cubic-feet":2,"cubic-yards":2,"cubic-miles":6,liters:2},this.maxVolumeExtentSizeVw=.7,this.minVolumeExtentSizePixels=250,this.minTargetElevation=-11e3,this.maxTargetElevation=9e3,this.targetElevationRange=this.maxTargetElevation-this.minTargetElevation,this.maxPerimeterLocalWebMercator=1e4,this.maxPerimeterGlobal=5e4}};const G=new Yi;let V=class extends J{constructor(e){super(e),this.rawResult=null}get localOriginRenderSpace(){const{extent:e,localOrigin:i,renderCoordsHelper:r}=this,o=f();return r.toRenderCoords(i,e.spatialReference,o),o}get cameraPositionRenderSpace(){const{localOriginRenderSpace:e,renderCoordsHelper:i}=this,r=f(),o=1/i.unitInMeters;return i.setAltitude(r,tr*o,e),r}get boundingRect(){const{extent:e,renderCoordsHelper:i}=this,r=Ct();return i.viewingMode===2?Vt(e,r):(this._expandBoundingRect(e.xmin,e.ymin,r),this._expandBoundingRect(e.xmax,e.ymin,r),this._expandBoundingRect(e.xmin,e.ymax,r),this._expandBoundingRect(e.xmax,e.ymax,r)),r}get cameraDimensions(){const{boundingRect:e}=this;return{width:be(e),height:we(e)}}get cameraNearFar(){const{renderCoordsHelper:{unitInMeters:e}}=this,i=1/e;return{near:ir*i,far:rr*i}}get upVector(){return this.renderCoordsHelper.worldBasisAtPosition(this.cameraPositionRenderSpace,2,f())}get northVector(){return this.renderCoordsHelper.worldBasisAtPosition(this.cameraPositionRenderSpace,1,f())}get eastVector(){return this.renderCoordsHelper.worldBasisAtPosition(this.cameraPositionRenderSpace,0,f())}_expandBoundingRect(e,i,r){const{extent:o,eastVector:l,northVector:a,upVector:c,renderCoordsHelper:h}=this,p=o.center.z??0;me(he,e,i,p),h.toRenderCoords(he,o.spatialReference,he),ni(he,l,a,c,tt),xt(r,tt,r)}};n([u()],V.prototype,"renderCoordsHelper",void 0),n([u()],V.prototype,"extent",void 0),n([u()],V.prototype,"localOrigin",void 0),n([u()],V.prototype,"localOriginRenderSpace",null),n([u()],V.prototype,"cameraPositionRenderSpace",null),n([u()],V.prototype,"boundingRect",null),n([u()],V.prototype,"cameraDimensions",null),n([u()],V.prototype,"upVector",null),n([u()],V.prototype,"northVector",null),n([u()],V.prototype,"eastVector",null),n([u()],V.prototype,"rawResult",void 0),V=n([M("esri.views.3d.analysis.VolumeMeasurement.VolumeMeasurementCutFillComputation")],V);const he=f(),tt=f(),er=100,tr=G.maxTargetElevation,ir=0,rr=G.targetElevationRange+er;let ne=class extends zt{constructor(e,i,r){super(e,i,r),this.name="unknown",this.name=e}};class it extends ne{constructor(){super("perimeter-too-large","The input geometry's perimeter is too large for the current viewing mode and spatial reference.")}}let or=class extends ne{constructor(){super("distance-too-far","The measurement geometry is too far from the camera.")}},sr=class extends ne{constructor(){super("distance-too-close","The measurement geometry is too close to the camera.")}};class nr extends ne{constructor(){super("unsupported-coordinate-system","The coordinate system of the view (viewing mode and spatial reference) is not supported.")}}let ar=class extends ne{constructor(){super("unsupported-layer-transparency","The volume measurement analysis does not support transparent layers.")}};function lr(t,e,i="cubic-meters"){const r=t-e,o=t+e;return{cutVolume:ae(t,i),fillVolume:ae(e,i),netVolume:ae(r,i),totalVolume:ae(o,i)}}function pe(t,e){return t?Yt(t,mt(t.value,t.unit,e)):null}let T=class extends J{constructor(e){super(e)}get cutVolume(){return pe(this.rawResult.cutVolume,this.unit)}get fillVolume(){return pe(this.rawResult.fillVolume,this.unit)}get netVolume(){return pe(this.rawResult.netVolume,this.unit)}get totalVolume(){return pe(this.rawResult.totalVolume,this.unit)}};n([u({constructOnly:!0})],T.prototype,"measureType",void 0),n([u()],T.prototype,"cutVolume",null),n([u()],T.prototype,"fillVolume",null),n([u()],T.prototype,"netVolume",null),n([u()],T.prototype,"totalVolume",null),n([u({constructOnly:!0})],T.prototype,"rawResult",void 0),n([u({constructOnly:!0})],T.prototype,"unit",void 0),T=n([M("esri.views.3d.analysis.VolumeMeasurement.VolumeMeasurementResult")],T);class Lt extends hi{constructor(){super(...arguments),this.output=0}}n([pi({count:11})],Lt.prototype,"output",void 0);let Te=class extends Y{};function Dt(){const t=new ee;return t.include(Fe),t.fragment.include(di),t.fragment.uniforms.add(new B("cutFillReferenceDepthTexture",e=>e.referenceDepthTexture),new B("cutFillTargetDepthTexture",e=>e.targetDepthTexture)),t.fragment.code.add(z`bool outsideFar(float depth) {
return depth >= 1.0;
}`),t.fragment.main.add(z`float referenceDepth = depthFromTexture(cutFillReferenceDepthTexture, uv);
float targetDepth = depthFromTexture(cutFillTargetDepthTexture, uv);
if (outsideFar(targetDepth)) {
discard;
}
float depth = referenceDepth - targetDepth;
float cut = min(0.0, depth);
float fill = max(0.0, depth);
fragColor = vec4(cut, fill, 0.0, 0.0);`),t}const ur=Object.freeze(Object.defineProperty({__proto__:null,CutFillDepthParameters:Te,build:Dt},Symbol.toStringTag,{value:"Module"}));let rt=class extends te{constructor(e,i){super(e,i,new ie(ur,()=>se(()=>Promise.resolve().then(()=>$r),void 0)),$e)}initializePipeline(){return re({colorWrite:oe})}},Re=class extends Y{};function St(){const t=new ee;return t.include(Fe),t.fragment.uniforms.add(new B("cutFillDepthTexture",e=>e.depthTexture)),t.fragment.main.add(z`ivec2 iuv = ivec2(gl_FragCoord.xy) * 2;
vec2 sum = vec2(0.0);
for (int dx = 0; dx < 2; dx++) {
for (int dy = 0; dy < 2; dy++) {
sum += texelFetch(cutFillDepthTexture, iuv + ivec2(dx, dy), 0).rg;
}
}
fragColor = vec4(sum.r, sum.g, 0.0, 0.0);`),t}const cr=Object.freeze(Object.defineProperty({__proto__:null,CutFillReductionParameters:Re,build:St},Symbol.toStringTag,{value:"Module"}));class ot extends te{constructor(e,i){super(e,i,new ie(cr,()=>se(()=>Promise.resolve().then(()=>Tr),void 0)),$e)}initializePipeline(){return re({colorWrite:oe})}}let Ge=class extends Y{constructor(){super(...arguments),this.origin=gt,this.cutFillCamera={projectionMatrix:A(),viewMatrix:A(),nearFar:Zi()}}};function Et(t){const e=new ee,{vertex:i,fragment:r,varyings:o,attributes:l}=e;return e.include(mi),e.include(gi,t),l.add("position","vec3"),o.add("depth","float",{invariant:!0}),i.uniforms.add(new He("proj",a=>a.cutFillCamera.projectionMatrix),new He("view",a=>Ft(hr,a.cutFillCamera.viewMatrix,a.origin)),new _i("nearFar",a=>a.cutFillCamera.nearFar)),i.main.add(z`gl_Position = transformPositionWithDepth(proj, view, position, nearFar, depth);`),r.main.add(z`fragColor = vec4(1.0);
outputDepth(depth);`),e}const hr=A(),pr=Object.freeze(Object.defineProperty({__proto__:null,CutFillTargetDepthParameters:Ge,build:Et},Symbol.toStringTag,{value:"Module"}));let st=class extends te{constructor(e,i){super(e,i,new ie(pr,()=>se(()=>Promise.resolve().then(()=>Rr),void 0)),fi)}initializePipeline(){return re({colorWrite:oe,depthWrite:yi,depthTest:{func:519}})}},E=class extends $t{constructor(e){super(e),this.consumes={required:[Tt.TRANSPARENT]},this.produces=ge.CUTFILL_DEPTH,this._cutFillTargetDepthConfiguration=new Lt,this._cutFillTargetDepthParameters=new Ge,this._cutFillDepthParameters=new Te,this._cutFillReductionParameters=new Re,this.needsRender=!1,this.done=!0,this._localOrigin=f(),this._maxTextureSize=4096,this._width=0,this._height=0,this._reducedWidth=0,this._reducedHeight=0,this._depthFormat=13,this._colorFormat=10,this._targetVao=null}initialize(){this._maxTextureSize=Math.min(Ut("esri-mobile")?1024:this._maxTextureSize,this.fboCache.rctx.parameters.maxTextureSize),this._cutFillTargetDepthConfiguration.output=8}destroy(){this._targetVao=I(this._targetVao)}precompile(){this.techniques.precompile(st,this._cutFillTargetDepthConfiguration),this.techniques.precompile(rt),this.techniques.precompile(ot),this.view.stage.renderer.precompileCutFill()}render(e){const i=e.find(({name:C})=>C===ge.CUTFILL_DEPTH);if(!this._orthographicCamera||!this._targetVao||!this.needsRender)return i;const r=this.techniques.get(st,this._cutFillTargetDepthConfiguration),o=this.techniques.get(rt),l=this.techniques.get(ot);if(!r.compiled||!o.compiled||!l.compiled)return this.requestRender(1),i;this.needsRender=!1;const a=this.renderingContext,c=this.fboCache,h=a.getViewport(),p=c.acquire(this._width,this._height,"cutfill reference depth",this._depthFormat);a.bindFramebuffer(p.fbo),a.setViewport(0,0,this._width,this._height),a.clear(1280),this.view.stage.renderer.renderCutFillReferenceDepth(this._orthographicCamera);const s=c.acquire(this._width,this._height,"cutfill target depth",this._depthFormat);a.bindFramebuffer(s.fbo),a.setViewport(0,0,this._width,this._height),a.setClearDepth(1),a.clear(256),this._cutFillTargetDepthParameters.origin=this._localOrigin,this._cutFillTargetDepthParameters.cutFillCamera=this._orthographicCamera,a.bindTechnique(r,this.bindParameters,this._cutFillTargetDepthParameters),a.bindVAO(this._targetVao),a.drawArrays(H.TRIANGLES,0,this._targetVao.vertexCount("geometry"));let d=c.acquire(this._width,this._height,"cutfill reduction even",this._colorFormat),m=c.acquire(this._width,this._height,"cutfill reduction odd",this._colorFormat);this._cutFillDepthParameters.referenceDepthTexture=p.depthTexture,this._cutFillDepthParameters.targetDepthTexture=s.depthTexture,a.bindFramebuffer(d.fbo),a.bindTechnique(o,this.bindParameters,this._cutFillDepthParameters),a.setClearColor(0,0,0,0),a.clear(16384),a.screen.draw(),p.release(),s.release();let y=this._width,v=this._height;const _=Math.ceil(Math.log2(Math.min(y,v)));for(let C=0;C<_;C++)y=Math.ceil(y/2),v=Math.ceil(v/2),this._cutFillReductionParameters.depthTexture=d.getTexture(),this._prepareFBO(m,y,v),a.bindTechnique(l,this.bindParameters,this._cutFillReductionParameters),a.screen.draw(),[d,m]=[m,d];return this._buffer=new Float32Array(y*v*2),d.fbo?.readPixels(0,0,y,v,33319,Fi.FLOAT,this._buffer),this._reducedWidth=y,this._reducedHeight=v,d.release(),m.release(),a.setViewport(h.x,h.y,h.width,h.height),this.done=!0,i}setup(e,i){const r=this.renderingContext,{cameraDimensions:{width:o,height:l},localOriginRenderSpace:a}=e,c=this._maxTextureSize,h=l/o,p=o>l?c:c/h,s=o>l?c*h:c;this._width=qe(p),this._height=qe(s);const d=[this._width,this._height];this._orthographicCamera=this._createCamera(e,d),this._targetVao=I(this._targetVao),this._targetVao=dr(r,i),this._localOrigin=a,this.done=!1}start(){this._width!==0&&this._height!==0&&(this.needsRender=!0)}getDepth(){let e=0,i=0;for(let r=0;r<this._reducedWidth;r++)for(let o=0;o<this._reducedHeight;o++){const l=r+o*this._reducedHeight;e+=this._buffer?.[2*l]??0,i+=this._buffer?.[2*l+1]??0}return{cut:e,fill:i}}get width(){return this._width}get height(){return this._height}get updating(){return this.needsRender||!this.done}_prepareFBO(e,i,r){const o=this.renderingContext;o.bindFramebuffer(e.fbo),o.setViewport(0,0,i,r),o.setClearColor(0,0,0,0),o.clear(16384)}_createCamera(e,i){const{cameraPositionRenderSpace:r,localOriginRenderSpace:o,northVector:l,cameraDimensions:{width:a,height:c},cameraNearFar:{near:h,far:p}}=e,s=new vi({eye:r,center:o,up:l,near:h,far:p});return s.viewport=[0,0,i[0],i[1]],ui(s.projectionMatrix,-a/2,a/2,-c/2,c/2,h,p),s}};n([u()],E.prototype,"consumes",void 0),n([u()],E.prototype,"produces",void 0),n([u()],E.prototype,"needsRender",void 0),n([u()],E.prototype,"done",void 0),n([u()],E.prototype,"updating",null),E=n([M("esri.views.3d.webgl-engine.lib.CutFillDepth")],E);const nt=Gt().vec3f("position").freeze();function dr(t,e){const{positions:i,indices:r}=e,o=nt.createBuffer(r.length),l=o.position;for(let c=0;c<r.length;++c){const h=3*r[c];l.set(c,0,i[h]),l.set(c,1,i[h+1]),l.set(c,2,i[h+2])}const a=new Rt(t,Mt(nt),o.buffer);return new bt(t,a)}let mr=class{constructor(e,i){this.positions=e,this.indices=i}},g=class extends J{constructor(t){super(t),this._getElevationProvider=()=>this.view.elevationProvider,this._updatingHandles=new vt,this._computationValue=null}initialize(){const t=this.view;this._renderer=new E({view:t}),this._updatingHandles.add(()=>({computation:this._computation,renderGeometry:this._targetGeometryRenderInfo}),({computation:e,renderGeometry:i})=>{e&&i&&(this._renderer.setup(e,i),this._renderer.start())},S),this.addHandles([this._createElevationUpdateHandle(),w(()=>this._targetGeometry,e=>this.analysisViewData.targetGeometry=e,N),w(()=>this._elevationAlignedGeometry,e=>this.analysisViewData.elevationAlignedGeometry=e,N),w(()=>({computation:this._computation,extent:this._projectedGeometry?.extent,localOrigin:this._localOrigin}),({computation:e,extent:i,localOrigin:r})=>{e&&i&&r&&(e.extent=i,e.localOrigin=r)},ft),Wt(()=>this._renderer.done,()=>this._updateResult())])}destroy(){this._updatingHandles.destroy(),this._renderer.destroy()}get _projectedGeometry(){if(!this.analysis.valid)return null;const t=this.analysis.geometry,e=Jt(t,this.view.spatialReference);return e.pending?(this._updatingHandles.addPromise(e.pending),null):(t&&!e.geometry&&oi(this.analysis,t.spatialReference,qt.getLogger(this)),e.geometry)}get _localOrigin(){const t=this._projectedGeometry?.extent;return t?_t(t.center.x,t.center.y,0):null}get _elevationAlignedGeometry(){const t=this._projectedGeometry;if(!t)return null;const e=t.clone();return gr(this._getElevationProvider(),e),e}get _targetGeometry(){const t=this._elevationAlignedGeometry;if(!t)return null;const e=this.analysis.measureType,{effectiveTargetElevation:i}=this.analysisViewData;if(e==="stockpile"||i==null)return t;const r=t.clone();return r.rings[0].forEach(o=>o[2]=i),r}get _targetGeometryRenderInfo(){const t=this._targetGeometry,e=this._projectedGeometry?.extent,i=this._localOrigin;if(!t||!e||!i)return null;const{elevationProvider:r,renderCoordsHelper:o}=this.view,l=xe(t,r,o,ve.fromElevationInfo(new Ve({mode:"absolute-height"}))),{polygons:a}=l,c=a[0],h=yt(c.position,c.holeIndices,3),p=Ce(3*c.count),s=A(),d=A();return wt(e.spatialReference,i,s,o.spatialReference),d[12]=-s[12],d[13]=-s[13],d[14]=-s[14],Pt(p,c.position,d),new mr(p,h)}get updating(){return this._renderer.updating||this._updatingHandles.updating}get result(){const t=this._computation?.rawResult;return t?new T({measureType:this.analysis.measureType,rawResult:t,unit:this.analysisViewData.effectiveDisplayUnits.volume}):null}get error(){return this._unsupportedCoordinateSystemError??this._unsupportedLayerTransparencyError??this._perimeterTooLargeError??this._tooNearFarError}get _tooNearFarError(){const t=this._elevationAlignedGeometry;if(!t)return null;const{view:e}=this,{elevationProvider:i,renderCoordsHelper:r}=e,{camera:o}=e.state,l=xe(t,i,r,ve.fromElevationInfo(new Ve({mode:"absolute-height"}))),{polygons:a}=l,c=a[0].position;Pe(X);for(let m=0;m<c.length;m+=3)o.projectToScreen(me(vr,c[m],c[m+1],c[m+2]),ut),xt(X,ut,X);const h=be(X),p=we(X),{maxVolumeExtentSizeVw:s,minVolumeExtentSizePixels:d}=G;return h>o.width/o.pixelRatio*s||p>o.height/o.pixelRatio*s?new sr:Math.max(h,p)<d?new or:null}get _perimeterTooLargeError(){return this._perimeterTooLargeLocalError??this._perimeterTooLargeGlobalError}get _perimeterTooLargeLocalError(){const{spatialReference:t,state:{isLocal:e}}=this.view;if(!e||!t.isWebMercator)return null;const i=this._perimeter,{maxPerimeterLocalWebMercator:r}=G;return i!=null&&i>r?new it:null}get _perimeterTooLargeGlobalError(){if(!this.view.state.isGlobal)return null;const t=this._perimeter,{maxPerimeterGlobal:e}=G;return t!=null&&t>e?new it:null}get _unsupportedCoordinateSystemError(){return this.view.state.isLocal&&this.view.spatialReference.isGeographic?new nr:null}get _unsupportedLayerTransparencyError(){return(this.view.map?.ground.opacity??1)<1?new ar:null}get _perimeter(){const t=this._targetGeometryRenderInfo?.positions,e=t?fr(yr(t)):null;return e!=null?e/this.view.renderCoordsHelper.unitInMeters:null}get _enabled(){return!this.error}get _computation(){const t=this._projectedGeometry?.extent;if(!t||!this._enabled)return this._computationValue=F(this._computationValue),null;if(this._computationValue)return this._computationValue;const e=this._localOrigin;if(!e)return null;const{renderCoordsHelper:i}=this.view;return this._computationValue=new V({extent:t,localOrigin:e,renderCoordsHelper:i}),this._computationValue}_createElevationUpdateHandle(){const t=e=>{const i=this._projectedGeometry?.extent;e.context==="ground"&&i&&(ei(e.extent,e.spatialReference,at,this.view.spatialReference),Vt(i,lt),ri(at,lt)&&(this._getElevationProvider=()=>this.view.elevationProvider))};return this.view.elevationProvider.on("elevation-change",e=>t(e))}_updateResult(){if(!this._computation)return;const{spatialReference:t,viewingMode:e}=this.view,{extent:i,boundingRect:r,cameraNearFar:{near:o,far:l}}=this._computation,{width:a,height:c}=this._renderer;let h,p;e==="local"&&t.isWebMercator?{width:h,height:p}=_r(i):(h=be(r),p=we(r));const s=h/a*(p/c),d=this._renderer.getDepth(),m=_=>_*(l-o)+o,y=m(d.cut)*s,v=m(d.fill)*s;this._computation.rawResult=lr(Math.abs(y),v)}};function gr(t,e){e.rings[0].forEach(i=>{i[2]=ti(t,i,"ground")??0})}function _r(t){const e=Ne([t.xmin,t.ymin,0],[t.xmax,t.ymin,0],t.spatialReference),i=Ne([t.xmin,t.ymin,0],[t.xmin,t.ymax,0],t.spatialReference);return{width:e?.value??0,height:i?.value??0}}function fr(t){if(!t)return null;let e=null,i=null,r=0;for(const o of t)e||(e=[o[0],o[1],o[2]??0]),i?r+=Ae(i,o):i=[0,0,0],i[0]=o[0],i[1]=o[1],i[2]=o[2];return e&&i&&(r+=Ae(i,e)),Math.sqrt(r)}function*yr(t){const e=f();for(let i=0;i<t.length;i+=3)e[0]=t[i],e[1]=t[i+1],e[2]=t[i+2],yield e}n([u()],g.prototype,"_projectedGeometry",null),n([u()],g.prototype,"_localOrigin",null),n([u()],g.prototype,"_getElevationProvider",void 0),n([u()],g.prototype,"_elevationAlignedGeometry",null),n([u()],g.prototype,"_targetGeometry",null),n([u()],g.prototype,"_targetGeometryRenderInfo",null),n([u({constructOnly:!0})],g.prototype,"analysis",void 0),n([u({constructOnly:!0})],g.prototype,"analysisViewData",void 0),n([u({constructOnly:!0})],g.prototype,"view",void 0),n([u()],g.prototype,"updating",null),n([u()],g.prototype,"result",null),n([u()],g.prototype,"error",null),n([u()],g.prototype,"_tooNearFarError",null),n([u()],g.prototype,"_perimeterTooLargeError",null),n([u()],g.prototype,"_perimeterTooLargeLocalError",null),n([u()],g.prototype,"_perimeterTooLargeGlobalError",null),n([u()],g.prototype,"_unsupportedCoordinateSystemError",null),n([u()],g.prototype,"_unsupportedLayerTransparencyError",null),n([u()],g.prototype,"_perimeter",null),n([u()],g.prototype,"_enabled",null),n([u()],g.prototype,"_renderer",void 0),n([u({readOnly:!0})],g.prototype,"_updatingHandles",void 0),n([u()],g.prototype,"_computation",null),g=n([M("esri.views.3d.analysis.VolumeMeasurement.VolumeMeasurementCutFillController")],g);const at=Pe(),lt=Pe(),vr=f(),X=Ct(),ut=Qt();let Me=class extends Y{constructor(){super(...arguments),this.borderColor=Ji()}};function jt(){const t=new ee;return t.include(Fe),t.outputs.add("fragColor","vec4",0),t.fragment.uniforms.add(new B("colorTexture",e=>e.color),new B("cutFillVolumes",e=>e.cutFillVolumes),new B("cutFillMask",e=>e.cutFillMask),new Ki("pixelRatio",(e,i)=>i.camera.pixelRatio),new wi("borderColor",e=>e.borderColor)).main.add(z`vec4 color = texture(colorTexture, uv, 0.0);
vec4 volumesColor = texture(cutFillVolumes, uv, 0.0);
ivec2 iuv = ivec2(uv * vec2(textureSize(cutFillMask, 0)));
vec2 m0 = texelFetch(cutFillMask, iuv, 0).rg;
vec2 m1 = texelFetch(cutFillMask, iuv + ivec2(-1, 0), 0).rg;
vec2 m2 = texelFetch(cutFillMask, iuv + ivec2(1, 0), 0).rg;
vec2 m3 = texelFetch(cutFillMask, iuv + ivec2(0, -1), 0).rg;
vec2 m4 = texelFetch(cutFillMask, iuv + ivec2(0, 1), 0).rg;
float d = (
step(1.5, abs(m0.r - m1.r) + abs(m0.g - m1.g))
+ step(1.5, abs(m0.r - m2.r) + abs(m0.g - m2.g))
+ step(1.5, abs(m0.r - m3.r) + abs(m0.g - m3.g))
+ step(1.5, abs(m0.r - m4.r) + abs(m0.g - m4.g))
) * 0.25 * pixelRatio;
vec4 base = mix(color, volumesColor, max(m0.r, m0.g) * volumesColor.a);
fragColor = mix(base, borderColor, d);`),t}const wr=Object.freeze(Object.defineProperty({__proto__:null,CutFillCompositionPassParameters:Me,build:jt},Symbol.toStringTag,{value:"Module"}));let ct=class extends te{constructor(e,i){super(e,i,new ie(wr,()=>se(()=>Promise.resolve().then(()=>Gr),void 0)),$e)}initializePipeline(){return re({colorWrite:oe})}};class Oe extends Y{constructor(){super(...arguments),this.origin=gt}}function kt(){const t=new ee;return t.attributes.add("position","vec3"),t.outputs.add("fragColor","vec4",0),t.vertex.uniforms.add(new bi("proj",e=>e.camera.projectionMatrix),new Ci("view",(e,i)=>Ft(br,i.camera.viewMatrix,e.origin))).main.add(z`gl_Position = proj * view * vec4(position, 1.0);
gl_Position.z = min(gl_Position.z, gl_Position.w);`),t.fragment.main.add(z`fragColor = vec4(1, 1, 0, 0);`),t}const br=A(),Cr=Object.freeze(Object.defineProperty({__proto__:null,CutFillMaskDrawParameters:Oe,build:kt},Symbol.toStringTag,{value:"Module"}));class ht extends te{constructor(e,i){super(e,i,new ie(Cr,()=>se(()=>Promise.resolve().then(()=>Mr),void 0)),Oi(Vi))}initializePipeline(){return re({colorWrite:oe,depthTest:{func:515}})}}let j=class extends $t{constructor(t){super(t),this.consumes={required:[Tt.OPAQUE]},this.produces=ge.CUTFILL_COLOR,this._vaoCut=null,this._vaoFill=null,this._countCut=0,this._countFill=0,this._maskParameters=new Oe,this._cutVolumeParameters=new Ie,this._fillVolumeParameters=new Ie,this._compositeParameters=new Me,this._drawParameters=new xi;const e=t.view.state.viewingMode===1;this._cutVolumeTechniqueConfiguration=new Be(e),this._cutVolumeTechniqueConfiguration.customDepthTest=2,this._cutVolumeTechniqueConfiguration.writeDepth=!1,this._cutVolumeTechniqueConfiguration.cullFace=1,this._cutVolumeTechniqueConfiguration.doubleSidedMode=1,this._fillVolumeTechniqueConfiguration=new Be(e),this._fillVolumeTechniqueConfiguration.cullFace=2}initialize(){this.addHandles([w(()=>[this.cutColor,this.fillColor],()=>this._updateColors(),N)])}destroy(){this._vaoCut=I(this._vaoCut),this._vaoFill=I(this._vaoFill)}precompile(){this.techniques.precompile(ue,this._cutVolumeTechniqueConfiguration),this.techniques.precompile(ue,this._fillVolumeTechniqueConfiguration),this.techniques.precompile(ht),this.techniques.precompile(ct)}render(t){const e=this.techniques.get(ue,this._cutVolumeTechniqueConfiguration),i=this.techniques.get(ue,this._fillVolumeTechniqueConfiguration),r=this.techniques.get(ht),o=this.techniques.get(ct),l=t.find(({name:_})=>_===this.produces);if(!this._vaoCut||!this._vaoFill)return l;if(!(e&&i&&r.compiled&&o.compiled))return this.requestRender(1),l;const a=this.bindParameters,c=a.camera,h=c.fullViewport[2],p=c.fullViewport[3],s=this.renderingContext,d=this.fboCache,m=d.acquire(h,p,"cutfill color mask",2);m.attachDepth(l.getAttachment(_e)),s.bindFramebuffer(m.fbo),s.setClearColor(0,0,0,1),s.clear(17408),s.setViewport(0,0,h,p),s.bindTechnique(r,a,Pi,this._maskParameters),s.setFaceCullingEnabled(!1),s.setStencilTestEnabled(!0),s.setStencilOpSeparate(1028,7680,34055,7680),s.setStencilOpSeparate(1029,7680,34056,7680),s.setDepthWriteEnabled(!1),s.bindVAO(this._vaoCut),s.setDepthTestEnabled(!0),s.setStencilWriteMask(255),s.setStencilFunction(519,0,255),s.setColorMask(!1,!1,!1,!1),s.drawArrays(H.TRIANGLES,0,this._countCut),s.setDepthTestEnabled(!1),s.setStencilWriteMask(0),s.setStencilFunction(517,0,255),s.setColorMask(!0,!1,!1,!1),s.drawArrays(H.TRIANGLES,0,this._countCut),s.bindVAO(this._vaoFill),s.setDepthTestEnabled(!0),s.setStencilWriteMask(255),s.setStencilFunction(519,0,255),s.setColorMask(!1,!0,!1,!1),s.drawArrays(H.TRIANGLES,0,this._countFill);const y=d.acquire(h,p,"cutfill color volumes",5);y.attachDepth(l.getAttachment(_e)),s.bindFramebuffer(y.fbo),s.setClearColor(0,0,0,0),s.clear(16384),s.setColorMask(!0,!0,!0,!0),s.bindTechnique(e,this.bindParameters,this._cutVolumeParameters,this._drawParameters),s.setPolygonOffset(1,1),s.setPolygonOffsetFillEnabled(!0),s.bindVAO(this._vaoCut),s.drawArrays(H.TRIANGLES,0,this._countCut),s.bindTechnique(i,this.bindParameters,this._fillVolumeParameters,this._drawParameters),s.setPolygonOffset(0,0),s.setPolygonOffsetFillEnabled(!1),s.bindVAO(this._vaoFill),s.drawArrays(H.TRIANGLES,0,this._countFill);const v=this.fboCache.acquire(h,p,this.produces);return s.bindFramebuffer(v.fbo),this._compositeParameters.color=l.getTexture(),this._compositeParameters.cutFillVolumes=y.getTexture(),this._compositeParameters.cutFillMask=m.getTexture(),b.toUnitRGBA(this.borderColor,this._compositeParameters.borderColor),s.bindTechnique(o,a,this._compositeParameters),s.screen.draw(),m.release(),y.release(),v.attachDepth(l.getAttachment(_e)),v}enable(){this.produces=ge.CUTFILL_COLOR,this.requestRender(1)}disable(){this.produces="disabled",this.requestRender(1)}updateGeometries(t,e,i){this._vaoCut=I(this._vaoCut),this._vaoCut=this._createVao(t),this._countCut=t.indicesBottom.length+t.indicesExtruded.length,this._vaoFill=I(this._vaoFill),this._vaoFill=this._createVao(e),this._countFill=e.indicesBottom.length+e.indicesExtruded.length,this._maskParameters.origin=i,Kt(this._drawParameters.origin,i),this.requestRender(1)}_updateColors(){this._cutVolumeParameters.diffuse=b.toUnitRGB(this.cutColor),this._cutVolumeParameters.opacity=this.cutColor.a,this._fillVolumeParameters.diffuse=b.toUnitRGB(this.fillColor),this._fillVolumeParameters.opacity=this.fillColor.a,this.requestRender(1)}_createVao(t){const e=this.renderingContext,{vertices:i,normals:r,indicesBottom:o,indicesExtruded:l}=t,a=pt.createBuffer(o.length+l.length),{position:c,normal:h}=a;for(let s=0;s<o.length;s++){const d=3*o[s];c.set(s,0,i[d]),c.set(s,1,i[d+1]),c.set(s,2,i[d+2]),h.set(s,0,r[d]),h.set(s,1,r[d+1]),h.set(s,2,r[d+2])}for(let s=0;s<l.length;s++){const d=s+o.length,m=3*l[s];c.set(d,0,i[m]),c.set(d,1,i[m+1]),c.set(d,2,i[m+2]),h.set(d,0,r[m]),h.set(d,1,r[m+1]),h.set(d,2,r[m+2])}const p=new Rt(e,Mt(pt),a.buffer);return new bt(e,p)}};n([u()],j.prototype,"consumes",void 0),n([u()],j.prototype,"produces",void 0),n([u()],j.prototype,"cutColor",void 0),n([u()],j.prototype,"fillColor",void 0),n([u()],j.prototype,"borderColor",void 0),j=n([M("esri.views.3d.webgl-engine.lib.CutFillColor")],j);const pt=Gt().vec3f("position").vec3f("normal").freeze();class Vr{constructor(e,i,r,o){this.vertices=e,this.indicesBottom=i,this.indicesExtruded=r,this.normals=o}}let P=class extends J{get visible(){return this.analysisViewData.visible&&this.analysisViewData.elevationAlignedGeometry!=null&&this.analysisViewData.targetGeometry!=null}get updating(){return this.loadingMessages}get hasUnsupportedError(){const{error:t}=this.analysisViewData;return!!t&&["unsupported-coordinate-system","unsupported-layer-transparency"].includes(t.name)}constructor(t){super(t),this.unitsMessages=null,this.messages=null,this.loadingMessages=!0,this._elevationContext=ve.fromElevationInfo(new Ve({mode:"absolute-height"})),this._extrusionHeight=G.targetElevationRange,this._projectionLines=[]}initialize(){const{view:t}=this,e={view:t,isDecoration:!0},i=G,r={...e,width:i.geometryOutlineWidth};this._elevationAlignedGeometry=new Ze({...r,isDraped:!0,color:b.toUnitRGBA(i.geometryOutlineColor)}),this._targetGeometry=new Ze(r);const o={...e,attached:!0,width:i.projectionLineWidth,renderOccluded:4,polygonOffset:!0},l={...o,stipplePattern:Li(i.projectionLineStippleSize)},a=b.toUnitRGBA(i.cutProjectionLineColor),c=b.toUnitRGBA(i.fillProjectionLineColor);this._cutProjectionLines=new le({...o,color:a}),this._occludedCutProjectionLines=new le({...l,color:a}),this._fillProjectionLines=new le({...o,color:c}),this._occludedFillProjectionLines=new le({...l,color:c});const h={...e,attached:!0};this._cutVolumeLabel=new Ke(h),this._fillVolumeLabel=new Ke(h),this._cutFillRenderNode=new j({view:t,cutColor:i.cutColor,fillColor:i.fillColor,borderColor:i.geometryOutlineColor}),this.addHandles([w(()=>({elevationAlignedGeometry:this.analysisViewData.elevationAlignedGeometry,targetGeometry:this.analysisViewData.targetGeometry}),({elevationAlignedGeometry:p,targetGeometry:s})=>{this._elevationAlignedGeometry.geometry=p,this._targetGeometry.geometry=s},S),w(()=>({interactive:this.analysisViewData.interactive,measureType:this.analysis.measureType,visible:this.visible}),({visible:p,interactive:s,measureType:d})=>{this._elevationAlignedGeometry.visible=p&&!s,this._targetGeometry.visible=p&&d==="cut-fill"},S),w(()=>({elevationAlignedGeometry:this.analysisViewData.elevationAlignedGeometry,targetGeometry:this.analysisViewData.targetGeometry,visible:this.visible}),({elevationAlignedGeometry:p,targetGeometry:s,visible:d})=>this._updateProjectionLines(p,s,d),S),w(()=>({interactive:this.analysisViewData.interactive,accentColor:this.view.effectiveTheme.accentColor,hasResult:!!this.analysisViewData.result}),({interactive:p,accentColor:s,hasResult:d})=>{this._updateColors(p,s,d)},S),w(()=>this.analysisViewData.targetGeometry,()=>this._updateCutFillGeometry(),S),w(()=>this.visible&&!this.hasUnsupportedError,p=>this._updateCutFillVisibility(p),S),w(()=>{const{messages:p,unitsMessages:s,visible:d,analysisViewData:m}=this;return{labelAnchors:m.labelAnchors,effectiveDisplayUnits:m.effectiveDisplayUnits,messages:p,unitsMessages:s,result:m.result,visible:d&&!!m.result}},p=>this._updateLabels(p)),w(()=>this.view.state.camera,p=>this._updateProjectionLineOcclusion(p),S),Xt(()=>this._updateMessageBundle())]),this._updateMessageBundle()}destroy(){this._elevationAlignedGeometry=F(this._elevationAlignedGeometry),this._targetGeometry=F(this._targetGeometry),this._cutProjectionLines=F(this._cutProjectionLines),this._occludedCutProjectionLines=F(this._occludedCutProjectionLines),this._fillProjectionLines=F(this._fillProjectionLines),this._occludedFillProjectionLines=F(this._occludedFillProjectionLines),this._cutVolumeLabel=F(this._cutVolumeLabel),this._fillVolumeLabel=F(this._fillVolumeLabel),this._cutFillRenderNode.destroy()}_updateProjectionLines(t,e,i){if(this._cutProjectionLines.visible=i,this._occludedCutProjectionLines.visible=i,this._fillProjectionLines.visible=i,this._occludedFillProjectionLines.visible=i,!t||!e)return;const{renderCoordsHelper:r}=this.view,o=[],l=t.spatialReference,a=t.rings[0],c=a.length>1&&Ht(a[0],a[a.length-1]),h=a.length-(c?1:0);for(let _=0;_<h;++_){const C=a[_],O=me(f(),C[0],C[1],C[2]);r.toRenderCoords(O,l,O);const L=e.rings[0][_],$=me(f(),L[0],L[1],L[2]);r.toRenderCoords($,l,$);const q=new Mi(O,$);o.push(q)}t.isClockwise(a)||o.reverse();const p=[],s=[],d=[],m=[],y=[],v=this.view.state.camera;for(let _=0;_<o.length;++_){const C=o[_],O=o[_===0?o.length-1:_-1],L=o[_===o.length-1?0:_+1],$=t.rings[0][_],q=e.rings[0][_],U=$[2]>q[2],D=new xr(C,O,L,U);p.push(D),D.updateOccluded(v);const Le=D.isOccluded;U?(Le?d:s).push(C):(Le?y:m).push(C)}this._projectionLines=p,this._cutProjectionLines.setGeometryFromSegments(s),this._occludedCutProjectionLines.setGeometryFromSegments(d),this._fillProjectionLines.setGeometryFromSegments(m),this._occludedFillProjectionLines.setGeometryFromSegments(y)}_updateProjectionLineOcclusion(t){const e=[],i=[],r=[],o=[];let l=!1,a=!1;for(const c of this._projectionLines){c.updateOccluded(t)&&(l||=c.isCut,a||=!c.isCut);const h=c.isOccluded;(c.isCut?h?i:e:h?o:r).push(c.segment)}a&&(this._fillProjectionLines.setGeometryFromSegments(r),this._occludedFillProjectionLines.setGeometryFromSegments(o)),l&&(this._cutProjectionLines.setGeometryFromSegments(e),this._occludedCutProjectionLines.setGeometryFromSegments(i))}_updateColors(t,e,i){const{geometryOutlineColor:r,cutColor:o,fillColor:l,cutColorMuted:a,fillColorMuted:c,cutProjectionLineColor:h,fillProjectionLineColor:p}=G;if(this._cutFillRenderNode.cutColor=i?o:a,this._cutFillRenderNode.fillColor=i?l:c,t){const s=b.toUnitRGBA(e);this._targetGeometry.color=s,this._cutProjectionLines.color=s,this._occludedCutProjectionLines.color=s,this._fillProjectionLines.color=s,this._occludedFillProjectionLines.color=s,this._cutFillRenderNode.borderColor=e}else{this._targetGeometry.color=b.toUnitRGBA(r);const s=b.toUnitRGBA(i?h:a);this._cutProjectionLines.color=s,this._occludedCutProjectionLines.color=s;const d=b.toUnitRGBA(i?p:c);this._fillProjectionLines.color=d,this._occludedFillProjectionLines.color=d,this._cutFillRenderNode.borderColor=r}}_updateLabels(t){const{labelDistance:e}=G,{effectiveDisplayUnits:i,labelAnchors:r,messages:o,unitsMessages:l,result:a,visible:c}=t;if(this._cutVolumeLabel.visible=c,this._fillVolumeLabel.visible=c,this._cutVolumeLabel.geometry=r.cut?{type:"point",point:r.cut,callout:{distance:e,offset:0}}:null,this._fillVolumeLabel.geometry=r.fill?{type:"point",point:r.fill,callout:{distance:-e,offset:0}}:null,a==null||o==null||l==null)return this._cutVolumeLabel.text="-",void(this._fillVolumeLabel.text="-");const h=i.volume,p=Je(o.labels.cut,{volume:dt(l,a.cutVolume,h)}),s=Je(o.labels.fill,{volume:dt(l,a.fillVolume,h)});this._cutVolumeLabel.text=p,this._fillVolumeLabel.text=s}_updateCutFillVisibility(t){t?this._cutFillRenderNode.enable():this._cutFillRenderNode.disable()}_updateCutFillGeometry(){const{renderCoordsHelper:t}=this.view,{targetGeometry:e}=this.analysisViewData;if(!e?.extent)return;const{center:i}=e.extent,r=_t(i.x,i.y,0),o=f();t.toRenderCoords(r,e.spatialReference,o);const l=this._getExtrudedVolumes(e,this._extrusionHeight,r),a=this._getExtrudedVolumes(e,-this._extrusionHeight,r);this._cutFillRenderNode.updateGeometries(l,a,o)}_getExtrudedVolumes(t,e,i){const{renderCoordsHelper:r,spatialReference:o,elevationProvider:l}=this.view,a=f(),c=r.viewingMode===1;c||r.worldUpAtPosition([0,0,0],a);const h=xe(t,l,r,this._elevationContext),{polygons:p,mapPositions:s,position:d}=h,m=p[0],y=m.count,v=yt(m.mapPositions,m.holeIndices,3),_=v.length,C=6*y,O=Qe(C+_),L=Qe(_),$=Ce(3*C),q=Ce(3*C);ai(d,s,v,m,$,null,q,null,O,L,e,a,c);const U=A(),D=A();return wt(o,i,U,r.spatialReference),D[12]=-U[12],D[13]=-U[13],D[14]=-U[14],Pt($,$,D),new Vr($,L,O,q)}async _updateMessageBundle(){this.loadingMessages=!0;try{this.unitsMessages=await Xe("esri/core/t9n/Units"),this.messages=await Xe("esri/views/3d/analysis/VolumeMeasurement/t9n/VolumeMeasurementAnalysis")}finally{this.loadingMessages=!1}}};function dt(t,e,i){if(!e||!t)return null;const r=mt(e.value,e.unit,i),o=G.labelPrecisions[r];return Ti(t,e,r,o)}n([u({constructOnly:!0})],P.prototype,"view",void 0),n([u({constructOnly:!0})],P.prototype,"analysis",void 0),n([u({constructOnly:!0})],P.prototype,"analysisViewData",void 0),n([u()],P.prototype,"unitsMessages",void 0),n([u()],P.prototype,"messages",void 0),n([u()],P.prototype,"loadingMessages",void 0),n([u({readOnly:!0})],P.prototype,"visible",null),n([u()],P.prototype,"updating",null),n([u()],P.prototype,"hasUnsupportedError",null),P=n([M("esri.views.3d.analysis.VolumeMeasurement.VolumeMeasurementCutFillVisualization")],P);class xr{constructor(e,i,r,o){this.segment=e,this.previous=i,this.next=r,this.isCut=o,this._isOccluded=!1,this._n1=f(),this._n2=f();const l=W(Q,K(Q,e.endRenderSpace,e.startRenderSpace));W(this._n1,ze(this._n1,l,W(de,K(de,i.startRenderSpace,e.startRenderSpace)))),W(this._n2,ze(this._n2,l,W(de,K(de,e.startRenderSpace,r.startRenderSpace)))),this._isConvex=$i.normalize(Ri(this._n1,this._n2,l))<0}get isOccluded(){return this._isOccluded}updateOccluded(e){K(Q,this.segment.startRenderSpace,e.eye);const i=Ue(this._n1,Q)<0,r=Ue(this._n2,Q)<0,o=this._isOccluded;return this._isOccluded=this._isConvex?i&&r:i||r,this._isOccluded!==o}}const Q=f(),de=f();function Pr(t){return At(t?.geometry)}function At(t){return t!=null&&t.type==="polygon"}let Z=class extends Ni(Hi){constructor(t){super(t),this.type="elevation",this.allFields.forEach(e=>{e.lockable=!1,e.setActual(null)})}get allFields(){return[this.elevation]}};n([u()],Z.prototype,"type",void 0),n([u()],Z.prototype,"allFields",null),Z=n([M("esri.views.interactive.tooltip.infos.ElevationTooltipInfo")],Z);let k=class extends zi{constructor(t){super(t),this.sketchOptions=new Ot}initialize(){const{view:t}=this;this._shiftManipulator=new ji(t,0),this._shiftManipulator.state|=ki,this.manipulators.add(this._shiftManipulator),this.addHandles([this._createDragPipeline(),w(()=>this.analysisViewData.targetGeometry,()=>this._updateManipulatorPosition(),ft),w(()=>[this.analysisViewData.interactive,this.analysisViewData.targetGeometry,this.analysis.measureType],()=>this._updateManipulatorVisibility(),N)]),this._initializeTooltip(),this.finishToolCreation()}_initializeTooltip(){const{view:t}=this;this.tooltip=Ii(()=>({view:t,options:this.sketchOptions.tooltips})),this._tooltipInfo=new Z({sketchOptions:this.sketchOptions}),this.sketchOptions.tooltips.placement="trailing",this._updateSketchOptions(),this.addHandles([w(()=>this.analysisViewData.effectiveTargetElevation,()=>this._updateTooltip()),w(()=>this._shouldShowTooltip,e=>{e?this._showTooltip():this._hideTooltip()}),this.tooltip.on("commit",()=>{const e=this._tooltipInfo.elevation.actual,i=fe(this.view.spatialReference);if(e==null||i==null)return;const r=ii(e,i);this._updateValue(r,{recordUndo:this.analysis.cutFillOptions.targetElevation})}),w(()=>[this.analysis.displayUnits.elevation,this.analysis.inputUnits.elevation],()=>this._updateSketchOptions(),N)])}destroy(){this._shiftManipulator.destroy(),this.tooltip.destroy()}onInputEvent(t){if(!this.destroyed&&!Bi(t,this.tooltip))return super.onInputEvent(t)}get _shouldShowTooltip(){return this.hasFocusedManipulators||this.tooltip.mode==="input"}_createDragPipeline(){return Ui(this._shiftManipulator,(t,e,i)=>{const r=ke(t.renderLocation),o=this.analysis.inputUnits.elevation??"meters",l=fe(this.view.spatialReference);let a;e.next(Ai(this.view,r,this.view.spatialReference)).next(qi()).next(c=>{if(c.action==="start"){const{targetElevation:h}=this.analysis.cutFillOptions;a=h&&l?ye(h,o,l):void 0}return this._updateValue(a!=null?a+c.translationZ:c.mapEnd.z,c.action==="end"?{recordUndo:a}:void 0),c}),i.next(()=>{this._updateValue(a)})})}_updateManipulatorPosition(){const{targetGeometry:t}=this.analysisViewData,{renderCoordsHelper:e}=this.view;if(!t)return;const i=.5,r=t.rings[0],o=je(r[0]),l=je(r[1]);e.toRenderCoords(o,t.spatialReference,o),e.toRenderCoords(l,t.spatialReference,l);const a=ce.get();K(a,l,o);const c=ce.get();Zt(c,o,l,i);const h=e.worldBasisAtPosition(c,1,ce.get()),p=e.worldBasisAtPosition(c,0,ce.get()),s=si(h,p,c,Gi.get()),d=e.headingAtPosition(c,a),m=t.isClockwise(t.rings[0])?-Math.PI/2:Math.PI/2;ci(s,s,li(d)+m),s[12]=0,s[13]=0,s[14]=0,this._shiftManipulator.renderLocation=ke(c),this._shiftManipulator.modelTransform=s}_updateManipulatorVisibility(){const{interactive:t,targetGeometry:e}=this.analysisViewData,{measureType:i}=this.analysis,r=t&&e!=null&&i==="cut-fill";this._shiftManipulator.available=r}_updateValue(t,e){const i=We(t,this.view.spatialReference);if(i==null)return;const r=this.analysis.inputUnits.elevation??"meters",o=ye(i.value,i.unit,r),l=a=>{this.analysis.cutFillOptions.targetElevation=a};if(l(o),e&&"recordUndo"in e){const a=e.recordUndo;this.emit("record-undo",{apply:()=>l(o),undo:()=>l(a)})}}_getUpdatedTooltipInfo(){const{effectiveTargetElevation:t}=this.analysisViewData;return t?(this._tooltipInfo.elevation.actual=We(t,this.view.spatialReference),this._tooltipInfo):this._tooltipInfo}_updateTooltip(){this._shouldShowTooltip&&(this.tooltip.info=this._getUpdatedTooltipInfo())}_showTooltip(){this._updateTooltip()}_hideTooltip(){this.tooltip?.clear()}_updateSketchOptions(){const{analysis:t}=this,{displayUnits:e,inputUnits:i}=t;this.sketchOptions.values.inputUnits=new Ye({verticalLength:i.elevation}),this.sketchOptions.values.displayUnits=new Ye({verticalLength:e.elevation})}};n([u({constructOnly:!0})],k.prototype,"analysis",void 0),n([u({constructOnly:!0})],k.prototype,"view",void 0),n([u({constructOnly:!0})],k.prototype,"analysisViewData",void 0),n([u({constructOnly:!0,type:Ot})],k.prototype,"sketchOptions",void 0),n([u()],k.prototype,"_shouldShowTooltip",null),k=n([M("esri.views.3d.analysis.VolumeMeasurement.VolumeMeasurementShiftTool")],k);let R=class extends J{constructor(t){super(t),this._updatingHandles=new vt,this._operationManager=new Wi,this._onUndoRedo=()=>{this._updateGeometryFromSketchGraphic()}}initialize(){const{analysis:t,analysisViewData:e,view:i}=this;this._graphicsLayer=new Si({listMode:"hide",internal:!0,elevationInfo:{mode:"on-the-ground"}});const r=Qi(i,{selfEnabled:!0,excludeInternal:!0});this._sketchViewModel=new Xi({layer:this._graphicsLayer,view:i,updateOnGraphicClick:!1,defaultUpdateOptions:{reshapeOptions:{shapeOperation:"none"},enableRotation:!1,enableScaling:!1,enableMoveAllGraphics:!1,enableZ:!1,multipleSelectionEnabled:!1,toggleToolOnClick:!1,tool:"reshape"},polygonSymbol:this._polygonSymbol,snappingOptions:r.options}),this.addHandles([this._sketchViewModel.on(["undo","redo"],this._onUndoRedo),w(()=>({map:i.map,internalGraphicsLayer:this._graphicsLayer,state:this.state}),({map:o,internalGraphicsLayer:l,state:a})=>{switch(Fr(o,l),a){case"idle":case"reshaping-disabled":this._operationManager.stop(),this._graphicsLayer.removeAll(),this._ensureUpdatedSketchGraphic();break;case"reshaping":De(this._startReshape());break;case"awaiting-sketch":this.analysisViewData.interactive=!0}},N),r]),this._shiftTool=new k({analysis:t,view:i,analysisViewData:e}),this.addHandles(this._shiftTool.on("record-undo",o=>{const l=this._sketchViewModel.activeComponent;l?.type==="reshape-3d"&&l.recordUndo(o.apply,o.undo)})),i.tools.add(this._shiftTool),this.addHandles({remove:()=>i.tools.remove(this._shiftTool)})}destroy(){this._operationManager.destroy(),this._sketchViewModel.destroy();const t=this._graphicsLayer;this.view.map.remove(t),t.destroy()}get sketchGraphic(){return this._get("sketchGraphic")}set sketchGraphic(t){t!==this._get("sketchGraphic")&&(this._set("sketchGraphic",t),this._updateGeometryFromSketchGraphic())}get state(){const{geometry:t}=this.analysis,{interactive:e,visible:i}=this.analysisViewData;return i?this._sketchViewModel.createGraphic?this._sketchViewModel.createGraphic===this.sketchGraphic?"sketching":"awaiting-sketch":t?e?"reshaping":"reshaping-disabled":"idle":"idle"}get updating(){return this._sketchViewModel.updating||this._updatingHandles.updating}get _polygonSymbol(){return new Ei({color:[0,0,0,0],outline:{color:[0,0,0,0]}})}place(t){return this._operationManager.start("place",async e=>{const i=this.analysis.clone();this._ensureUpdatedSketchGraphic();const r=this._sketchViewModel.on("create",o=>{switch(o.state){case"start":this._graphicsLayer.removeAll(),this.sketchGraphic=o.graphic;break;case"active":this._updateGeometryFromSketchGraphic();break;case"complete":this._updateGeometryFromSketchGraphic(),e.stop();break;case"cancel":e.stop()}});e.handles.push(r,Se(()=>(r.remove(),this._sketchViewModel.cancel(),this._updateGeometryFromSketchGraphic(),this.analysis.valid?It(t)||i.equals(this.analysis)?e.reject():void e.resolve({}):(this._clearGeometry(),e.reject())))),await this._updatingHandles.addPromise(this._sketchViewModel.create("polygon"))},t)}_startReshape(){return this._operationManager.start("reshape",async t=>{const e=()=>{const r=this._ensureUpdatedSketchGraphic();return r?(this._graphicsLayer.removeAll(),this._graphicsLayer.add(r),this._updatingHandles.addPromise(this._sketchViewModel.update(r,{tool:"reshape"}))):Promise.resolve()};if(!this._ensureUpdatedSketchGraphic())return;const i=this._sketchViewModel.on("update",r=>{this._updateGeometryFromSketchGraphic(),r.state==="complete"&&(this.state==="reshaping"?De(e()):t.resolve())});t.handles.push(i,Se(()=>{i.remove(),this._sketchViewModel.cancel(),t.resolve()})),await e()})}_ensureUpdatedSketchGraphic(){const{geometry:t}=this.analysis;return At(t)?(this.sketchGraphic??=new Di({geometry:t,symbol:this._polygonSymbol}),this.sketchGraphic.geometry=t,this.sketchGraphic):(this.sketchGraphic=null,null)}_clearGeometry(){this.sketchGraphic=null,this.analysis.geometry=null}_updateGeometryFromSketchGraphic(){const t=this.sketchGraphic;this.analysis.geometry=Pr(t)?t.geometry:null}get test(){}};function Fr(t,e){e&&(e.removeFromParent(),t?.add(e))}n([u({constructOnly:!0})],R.prototype,"analysisViewData",void 0),n([u({constructOnly:!0})],R.prototype,"view",void 0),n([u({constructOnly:!0})],R.prototype,"analysis",void 0),n([u()],R.prototype,"sketchGraphic",null),n([u({nonNullable:!0})],R.prototype,"state",null),n([u()],R.prototype,"updating",null),n([u()],R.prototype,"_polygonSymbol",null),R=n([M("esri.views.3d.analysis.VolumeMeasurement.VolumeMeasurementTool")],R);let x=class extends Nt{constructor(t){super(t),this.type="volume-measurement-view-3d",this.analysis=null,this.elevationAlignedGeometry=null,this.targetGeometry=null}initialize(){const{analysis:t,view:e}=this;this._analysisController=new g({view:e,analysis:t,analysisViewData:this}),this._analysisTool=new R({analysis:t,view:e,analysisViewData:this}),this._analysisVisualization=new P({view:e,analysis:t,analysisViewData:this})}destroy(){this._analysisController=F(this._analysisController),this._analysisVisualization=F(this._analysisVisualization),this._analysisTool.destroy()}get error(){return this._analysisController?.error??null}get result(){return this._analysisController?.result}get interactive(){return super.interactive}set interactive(t){super.interactive=t}get visible(){return super.visible}set visible(t){super.visible=t}get effectiveTargetElevation(){const{cutFillOptions:t,inputUnits:e}=this.analysis,{targetElevation:i}=t,r=e?.elevation??"meters",o=fe(this.view.spatialReference);if(i!=null&&o!=null)return ye(i,r,o);const l=this.elevationAlignedGeometry?.extent;return l?.zmin==null||l?.zmax==null?null:(l.zmax+l.zmin)/2}get effectiveDisplayUnits(){const{displayUnits:t}=this.analysis,e=Bt(this.view);return{elevation:t.elevation??e,volume:t.volume??e}}get labelAnchors(){const{elevationAlignedGeometry:t,view:e}=this,{renderCoordsHelper:i}=e;if(!t)return{cut:null,fill:null};let r=t.rings[0][0],o=t.rings[0][0];t.rings[0].forEach(s=>{s[2]>r[2]&&(r=s),s[2]<o[2]&&(o=s)});const{spatialReference:l}=t,a=new Ee({x:r[0],y:r[1],z:r[2],spatialReference:l}),c=new Ee({x:o[0],y:o[1],z:o[2],spatialReference:l}),h=f(),p=f();return i.toRenderCoords(a,h),i.toRenderCoords(c,p),{cut:h,fill:p}}get updating(){return this._analysisController!=null&&this._analysisController.updating||this._analysisTool.updating||this._analysisVisualization.updating}place(t){return this._analysisTool.place(t)}get test(){}};n([u()],x.prototype,"error",null),n([u({readOnly:!0})],x.prototype,"type",void 0),n([u({constructOnly:!0,nonNullable:!0})],x.prototype,"analysis",void 0),n([u({readOnly:!0})],x.prototype,"result",null),n([u()],x.prototype,"elevationAlignedGeometry",void 0),n([u({type:Number})],x.prototype,"effectiveTargetElevation",null),n([u()],x.prototype,"targetGeometry",void 0),n([u()],x.prototype,"effectiveDisplayUnits",null),n([u()],x.prototype,"labelAnchors",null),n([u()],x.prototype,"updating",null),x=n([M("esri.views.3d.analysis.VolumeMeasurementAnalysisView3D")],x);const Sa=x,$r=Object.freeze(Object.defineProperty({__proto__:null,CutFillDepthParameters:Te,build:Dt},Symbol.toStringTag,{value:"Module"})),Tr=Object.freeze(Object.defineProperty({__proto__:null,CutFillReductionParameters:Re,build:St},Symbol.toStringTag,{value:"Module"})),Rr=Object.freeze(Object.defineProperty({__proto__:null,CutFillTargetDepthParameters:Ge,build:Et},Symbol.toStringTag,{value:"Module"})),Gr=Object.freeze(Object.defineProperty({__proto__:null,CutFillCompositionPassParameters:Me,build:jt},Symbol.toStringTag,{value:"Module"})),Mr=Object.freeze(Object.defineProperty({__proto__:null,CutFillMaskDrawParameters:Oe,build:kt},Symbol.toStringTag,{value:"Module"}));export{Sa as default};
