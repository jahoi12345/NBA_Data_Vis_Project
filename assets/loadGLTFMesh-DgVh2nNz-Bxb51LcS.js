import{F as S,v as k}from"./Color-CERqXxxY-BuYn26eI.js";import{H as D}from"./Point-BfTTZoMu-DeJwQYfh.js";import{I as G,y as I}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{B as L,G as $}from"./mathUtils-PIGhLnI9-B1tKUlUb.js";import{D as P,a as C,E as U}from"./Polygon-D6wEPb3W-D2MPjRU4.js";import{M as q}from"./collectionUtils-jDyktm0P-BDP2Oq99.js";import{e as N}from"./vec4f64-DPb6J-GU-C7c2DqbZ.js";import{n as V,l as H,u as K,p as Q}from"./MeshComponent-Ccgxjntc-lZNdhigm.js";import{o as X}from"./MeshVertexAttributes-CsRRGxwu-B0_t4SvE.js";import{b as F}from"./meshVertexSpaceUtils-CtG7DPVT-kybwngCt.js";import{F as j,_ as O,j as J,A as M,m as E,X as W,e as Y,S as Z}from"./BufferView-Cj2sQaht-avJ4OGB_.js";import{O as tt,q as et,k as ot,x as _}from"./vec3-B_phcnZY-DHC7I6xa.js";import{C as rt,D as nt,F as A}from"./vec4-B7mYuNMQ-ChTBJPnP.js";import{c as st}from"./types-BKo2foNY-DE0QfIFp.js";import{loadGLTF as it}from"./loader-CvLhmqYC-CS7K3i0U.js";import{U as lt,B as at,g as ut}from"./indexUtils-DpmEYOW0-Be5tCvPq.js";import{y as ft}from"./vec33-CWJeyzxV-Me4sF5XB.js";import{m as ct}from"./vertexSpaceConversion-DwAXLcxI-BXQ2PRg6.js";import{y as mt}from"./DefaultLoadingContext-DXgBe4GE-Unnb_XgV.js";import{p as pt}from"./resourceUtils-DWVfTVer-NJXuINUS.js";import"./index-B0z_nLWi.js";import"./Extent-CgDMOSRD-Bod5LY6s.js";import"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import"./vec32-CewSdTn3-VRto2OOh.js";import"./MeshLocalVertexSpace-BGd1IdEs-C0HJG4wR.js";import"./vec42-B8VM4vXb-B6OGOEI9.js";import"./vec2f64-rIxtbMRN-Kai9mK1i.js";import"./mat4f64-q_b6UJoq-Dh6sWB_w.js";import"./mat4-C96X-Nn0-BrMLOLCb.js";import"./quat-B7J5v7rV-CZ9akUv-.js";import"./quatf64-CCm9z-pX-CQ7_sSji.js";import"./Indices-D0_UQPPr-t1Qev6md.js";import"./spatialReferenceEllipsoidUtils-D2JabnKt-Ce3ED0lc.js";import"./projectionUtils-BGH_5_I3-DGwchVO8.js";import"./Polyline-CoiTLswR-DTxpB2Yg.js";import"./asyncUtils-w6KfWU41-HenJ0UOu.js";import"./reader-DcGs6kKN-DHJfK-tm.js";import"./aaBoundingRect-CjwcS2F3-ri8bmh30.js";import"./SimpleObservable-CvFyr0NA-DXpoMYph.js";import"./imageUtils-142g71N8-Wj0XNClb.js";import"./meshProperties-DWLWd_LJ-DdGPdsWo.js";import"./Version-BtYZEj58-LyRHDnSJ.js";import"./enums-B4pqBiXb-BO-3hS_8.js";import"./computeTranslationToOriginAndRotation-Bjd4esRf-vJ4LbdOU.js";import"./projectPointToVector-DL7Z4uvb-CPbOlZdQ.js";function dt(t,e,o){const i=t.typedBuffer,l=t.typedBufferStride,n=e.typedBuffer,u=e.typedBufferStride,r=o?o.count:e.count;let a=(o?.dstIndex??0)*l,c=(o?.srcIndex??0)*u;for(let f=0;f<r;++f){for(let s=0;s<9;++s)i[a+s]=n[c+s];a+=l,c+=u}}Object.freeze(Object.defineProperty({__proto__:null,copy:dt},Symbol.toStringTag,{value:"Module"}));function yt(t,e,o){const i=t.typedBuffer,l=t.typedBufferStride,n=e.typedBuffer,u=e.typedBufferStride,r=o?o.count:e.count;let a=(o?.dstIndex??0)*l,c=(o?.srcIndex??0)*u;for(let f=0;f<r;++f){for(let s=0;s<16;++s)i[a+s]=n[c+s];a+=l,c+=u}}Object.freeze(Object.defineProperty({__proto__:null,copy:yt},Symbol.toStringTag,{value:"Module"}));function xt(t,e){z(t.typedBuffer,e,t.typedBufferStride)}function z(t,e,o=4){const i=e.typedBuffer,l=e.typedBufferStride,n=e.count;let u=0,r=0;for(let a=0;a<n;++a)t[u]=i[r],t[u+1]=i[r+1],t[u+2]=i[r+2],t[u+3]=i[r+3],u+=o,r+=l}function h(t,e,o,i,l,n){const u=t.typedBuffer,r=t.typedBufferStride,a=n?.count??t.count;let c=(n?.dstIndex??0)*r;for(let f=0;f<a;++f)u[c]=e,u[c+1]=o,u[c+2]=i,u[c+3]=l,c+=r}Object.freeze(Object.defineProperty({__proto__:null,copy:z,copyView:xt,fill:h},Symbol.toStringTag,{value:"Module"}));function x(t,e){return new t(new ArrayBuffer(e*t.ElementCount*st(t.ElementType)))}async function he(t,e,o){const i=new mt(gt(o)),l=await it(i,e,o,!0),n=l.model,u=n.lods.shift(),r=new Map,a=new Map;n.textures.forEach((y,v)=>r.set(v,bt(y))),n.materials.forEach((y,v)=>a.set(v,vt(y,r)));const c=ht(u);for(const y of c.parts)wt(c,y,a);const{position:f,normal:s,tangent:m,color:p,texCoord0:b}=c.vertexAttributes,T=F(t,o),w=t.spatialReference.isGeographic?F(t):T,B=ct({vertexAttributes:{position:f.typedBuffer,normal:s?.typedBuffer,tangent:m?.typedBuffer},vertexSpace:w,spatialReference:t.spatialReference},T,{allowBufferReuse:!0,sourceUnit:o?.unitConversionDisabled?void 0:"meters"});if(!B)throw new G("load-gltf-mesh:vertex-space-projection",`Failed to load mesh from glTF because we could not convert the vertex space from ${w.type} to ${T.type}`);return{mesh:{transform:null,vertexSpace:T,components:c.components,spatialReference:t.spatialReference,vertexAttributes:new X({...B,color:p?.typedBuffer,uv:b?.typedBuffer})},meta:l.meta}}function gt(t){const e=t?.resolveFile;return e?{busy:!1,request:async(o,i,l)=>{const n=e?.(o)??o;return(await D(n,{responseType:i===2?"image":i===1||i===3?"array-buffer":"json",signal:l?.signal,timeout:0})).data}}:null}function g(t,e){if(t==null)return"-";const o=t.typedBuffer;return`${I(e,o.buffer,()=>e.size)}/${o.byteOffset}/${o.byteLength}`}function Tt(t){return t!=null?t.toString():"-"}function ht(t){let e=0;const o={color:!1,tangent:!1,normal:!1,texCoord0:!1},i=new Map,l=new Map,n=[];for(const u of t.parts){const{position:r,normal:a,color:c,tangent:f,texCoord0:s}=u.attributes,m=`
      ${g(r,i)}/
      ${g(a,i)}/
      ${g(c,i)}/
      ${g(f,i)}/
      ${g(s,i)}/
      ${Tt(u.transform)}
    `;let p=!1;const b=I(l,m,()=>(p=!0,{start:e,length:r.count}));p&&(e+=r.count),a&&(o.normal=!0),c&&(o.color=!0),f&&(o.tangent=!0),s&&(o.texCoord0=!0),n.push({gltf:u,writeVertices:p,region:b})}return{vertexAttributes:{position:x(Z,e),normal:o.normal?x(E,e):null,tangent:o.tangent?x(j,e):null,color:o.color?x(O,e):null,texCoord0:o.texCoord0?x(Y,e):null},parts:n,components:[]}}function bt(t){return new V({data:(pt(t.data),t.data),wrap:$t(t.parameters.wrap)})}function vt(t,e){const o=new S(Ct(t.color,t.opacity)),i=t.emissiveFactor?new S(Ft(t.emissiveFactor)):null,l=n=>n?new K({scale:n.scale?[n.scale[0],n.scale[1]]:[1,1],rotation:L(n.rotation??0),offset:n.offset?[n.offset[0],n.offset[1]]:[0,0]}):null;return new H({color:o,colorTexture:e.get(t.colorTexture),normalTexture:e.get(t.normalTexture),emissiveColor:i,emissiveTexture:e.get(t.emissiveTexture),occlusionTexture:e.get(t.occlusionTexture),alphaMode:St(t.alphaMode),alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,metallic:t.metallicFactor,roughness:t.roughnessFactor,metallicRoughnessTexture:e.get(t.metallicRoughnessTexture),colorTextureTransform:l(t.colorTextureTransform),normalTextureTransform:l(t.normalTextureTransform),occlusionTextureTransform:l(t.occlusionTextureTransform),emissiveTextureTransform:l(t.emissiveTextureTransform),metallicRoughnessTextureTransform:l(t.metallicRoughnessTextureTransform)})}function wt(t,e,o){e.writeVertices&&Bt(t,e);const{indices:i,attributes:l,primitiveType:n,material:u}=e.gltf;let r=lt(i||l.position.count,n);const a=e.region.start;if(a){const c=new Uint32Array(r);for(let f=0;f<r.length;f++)c[f]+=a;r=c}t.components.push(new Q({name:e.gltf.name,faces:r,material:o.get(u),shading:l.normal?"source":"flat",trustSourceNormals:!0}))}function Bt(t,e){const{position:o,normal:i,tangent:l,color:n,texCoord0:u}=t.vertexAttributes,r=e.region.start,{attributes:a,transform:c}=e.gltf,f=a.position.count;if(tt(o.slice(r,f),a.position,c),a.normal!=null&&i!=null){const s=P(C(),c),m=i.slice(r,f);et(m,a.normal,s),$(s)&&ot(m,m)}else i!=null&&ft(i,0,0,1,{dstIndex:r,count:f});if(a.tangent!=null&&l!=null){const s=U(C(),c),m=l.slice(r,f);rt(m,a.tangent,s),$(s)&&nt(m,m)}else l!=null&&h(l,0,0,1,1,{dstIndex:r,count:f});if(a.texCoord0!=null&&u!=null?at(u.slice(r,f),a.texCoord0):u!=null&&ut(u,0,0,{dstIndex:r,count:f}),a.color!=null&&n!=null){const s=a.color,m=n.slice(r,f);if(s.elementCount===4)s instanceof j?A(m,s,1,255):(s instanceof O||s instanceof J)&&A(m,s,1/255,255);else{h(m,255,255,255,255);const p=M.fromTypedArray(m.typedBuffer,m.typedBufferStride);s instanceof E?_(p,s,1,255):(s instanceof M||s instanceof W)&&_(p,s,1/255,255)}}else n!=null&&h(n.slice(r,f),255,255,255,255)}function St(t){switch(t){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function $t(t){return{horizontal:R(t.s),vertical:R(t.t)}}function R(t){switch(t){case 33071:return"clamp";case 33648:return"mirror";case 10497:return"repeat"}}function d(t){return t**(1/k)*255}function Ct(t,e){return N(d(t[0]),d(t[1]),d(t[2]),e)}function Ft(t){return q(d(t[0]),d(t[1]),d(t[2]))}export{he as loadGLTFMesh};
