import{r as G,b as nt,s as J}from"./mathUtils-PIGhLnI9.js";import{N as et,A as O,p as st,o as $,s as K,P as D,c as Q,_ as R,K as at}from"./vec32-DAazN8eR.js";import{n as m}from"./collectionUtils-DO-P7c3V.js";import{H as ot,Q as E}from"./jsonMap-Bs3hmeCU.js";function rt(t){return t<=ot?new Array(t):new Int16Array(t)}function S(t,o,s,r,a,n=2){const e=1/(Math.abs(s)+Math.abs(r)+Math.abs(a)),l=s*e,u=r*e,f=a<=0?(l>=0?1:-1)*(1-Math.abs(u)):l,c=a<=0?(u>=0?1:-1)*(1-Math.abs(l)):u,g=o*n;t[g]=U(f),t[g+1]=U(c)}function Nt(t){const o=t.length/3,s=rt(2*o);let r=0;for(let a=0;a<o;++a)S(s,a,t[r++],t[r++],t[r++]);return s}function xt(t,o){const s=t.length/3,r=new Int16Array(2*s);let a=0;const n=m();for(let e=0;e<s;++e)n[0]=t[a++],n[1]=t[a++],n[2]=t[a++],et(n,n,o),S(r,e,n[0],n[1],n[2]);return r}function yt(t,o,s,r=2){const a=s*r,n=_(o[a]),e=_(o[a+1]),l=1-Math.abs(n)-Math.abs(e);return t[2]=l,l<0?(t[0]=(n>=0?1:-1)*(1-Math.abs(e)),t[1]=(e>=0?1:-1)*(1-Math.abs(n))):(t[0]=n,t[1]=e),O(t,t)}function U(t){return G(Math.round(32767*t),-32767,32767)}function _(t){return G(t/32767,-1,1)}class ct{constructor(){this.position0=m(),this.position1=m(),this.faceNormal0=m(),this.faceNormal1=m(),this.componentIndex=0,this.cosAngle=0}}const I=-1;function vt(t,o,s){const r=t.vertices.position,a=t.vertices.componentIndex,n=h.position0,e=h.position1,l=h.faceNormal0,u=h.faceNormal1,{edges:f,normals:c}=ut(t),g=f.length/4,w=o.allocate(g);let F=0;const W=g,x=s?.allocate(W);let L=0,P=0,j=0;N.length=0;for(let d=0;d<g;++d){const A=4*d;r.getVec(f.data[A],n),r.getVec(f.data[A+1],e);const M=N.pushNew();M.index=4*d,M.length=st(n,e)}N.sort((d,A)=>A.length-d.length);const k=new Array,q=new Array;N.forAll(({length:d,index:A})=>{const M=f.data[A],tt=f.data[A+1],z=f.data[A+2],B=f.data[A+3],H=B===I;if(r.getVec(M,n),r.getVec(tt,e),H){const p=3*z;$(l,c.data[p],c.data[p+1],c.data[p+2]),K(u,l),h.componentIndex=a.get(M),h.cosAngle=D(l,u)}else{let p=3*z;if($(l,c.data[p],c.data[p+1],c.data[p+2]),p=3*B,$(u,c.data[p],c.data[p+1],c.data[p+2]),h.componentIndex=a.get(M),h.cosAngle=D(l,u),it(h,pt))return;h.cosAngle<-.9999&&K(u,l)}P+=d,j++,H||lt(h,mt)?(o.write(w,F++,h),k.push(d)):ht(h,T)&&(x&&s&&s.write(x,L++,h),q.push(d))});const X=new Float32Array(k.reverse()),Y=new Float32Array(q.reverse()),Z=x&&s?{instancesData:x.slice(0,L),lodInfo:{lengths:Y}}:void 0;return{regular:{instancesData:w.slice(0,F),lodInfo:{lengths:X}},silhouette:Z,averageEdgeLength:P/j}}function lt(t,o){return t.cosAngle<o}function it(t,o){return t.cosAngle>o}function ht(t,o){const s=nt(t.cosAngle);return at(C,t.position1,t.position0),s*(D(R(gt,t.faceNormal0,t.faceNormal1),C)>0?-1:1)>o}function ut(t){const o=t.faces.length/3,s=t.faces,r=t.neighbors,a=t.vertices.position;i.length=V.length=0;for(let n=0;n<o;n++){const e=3*n,l=r[e],u=r[e+1],f=r[e+2],c=s[e],g=s[e+1],w=s[e+2];a.getVec(c,b),a.getVec(g,y),a.getVec(w,v),Q(y,y,b),Q(v,v,b),R(b,y,v),O(b,b),V.pushArray(b),(l===I||c<g)&&(i.push(c),i.push(g),i.push(n),i.push(l)),(u===I||g<w)&&(i.push(g),i.push(w),i.push(n),i.push(u)),(f===I||w<c)&&(i.push(w),i.push(c),i.push(n),i.push(f))}return{edges:i,normals:V}}class ft{constructor(){this.index=0,this.length=0}}function It(){N.prune(),i.prune(),V.prune()}const N=new E({allocator:t=>t||new ft,deallocator:null}),i=new E({deallocator:null}),V=new E({deallocator:null}),h=new ct,gt=m(),C=m(),b=m(),y=m(),v=m(),T=J(4),pt=Math.cos(T),dt=J(35),mt=Math.cos(dt);export{Nt as c,vt as d,S as e,xt as f,rt as t,yt as u,It as x};
