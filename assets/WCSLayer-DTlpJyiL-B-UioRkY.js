const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/imageryUtils-Cv1J3BuP-C0eOslJm.js","assets/utils-CwBq5UrM-DFr-_PPw.js","assets/jsonMap-Bs3hmeCU-Cusd0Fmz.js","assets/originUtils-CPX8CCAY-UgTmEqwz.js","assets/multiOriginJSONSupportUtils-C0wm8_Yw-DH8sdIsE.js","assets/collectionUtils-jDyktm0P-ArdXNs6F.js","assets/index-CTl7hdrJ.js","assets/index-Cv2ko1Ob.css","assets/Point-BfTTZoMu-BAT2Wq6O.js","assets/reader-DcGs6kKN-DHJfK-tm.js","assets/reactiveUtils-SO2Ko3sy-BCLX8Jdy.js","assets/Extent-CgDMOSRD-CU1qE5Kr.js","assets/SimpleObservable-CvFyr0NA-DXpoMYph.js","assets/PortalItem-DnxMlRVo-Dhq4alsp.js","assets/jsonContext-C00-qqFg-DK7bPg6q.js","assets/portalItemUtils-CaPNUJg6-JsqddoLx.js","assets/projectionUtils-BGH_5_I3-BySNUA-B.js","assets/Polyline-CoiTLswR-BLagWJLS.js","assets/Polygon-D6wEPb3W-CpL9Efjx.js","assets/aaBoundingRect-CjwcS2F3-D7aII9DY.js","assets/mathUtils-PIGhLnI9-B1tKUlUb.js","assets/saveUtils-BO8L-Vl8-bXGcqq8I.js","assets/Layer-DZvC7bne-m1cEC_yw.js","assets/date-IqUzANpt-bLKO9IDT.js","assets/datasetUtils-DdDUWBI2-CH5OCkUx.js"])))=>i.map(i=>d[i]);
import{H as De,_ as Te}from"./index-CTl7hdrJ.js";import{aU as Le,J as Pe,I as V,v as te,w as ge,Y as D,H as T,G as he}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{A as Re}from"./getPopupProvider-CmskPttI-C4PqyuPF.js";import{Y as Ae}from"./collectionUtils-jDyktm0P-ArdXNs6F.js";import{k as $e}from"./MultiOriginJSONSupport-Bd1TKmh_-BHNF5tHX.js";import{j as Oe}from"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import{e as Ee,r as Me}from"./GraphicOrigin-uE6TDXc9-DqbdmNAV.js";import{o as Ne}from"./Layer-DZvC7bne-m1cEC_yw.js";import{y as je}from"./BlendLayer-HE_aYHHW-CZa4IAJu.js";import{i as Ve}from"./CustomParametersMixin-Dshqz1Zp-BFC165kX.js";import{n as ke,_ as Fe,i as $,B as w,P as y,$ as E,r as S,o as A,l as ve}from"./xmlUtilities-iKlo1iNG-DvjWCHGS.js";import{C as _e,I as Ge,L as Ue}from"./OperationalLayer-B6zbJ5nR-sYdHUfAL.js";import{z as Be}from"./PortalLayer-CbFNhtZ4-CCXE0v4V.js";import{I as We,k as qe,j as ne,v as He}from"./RasterJobHandlerMixin-CxrZ5p3m-CYkei0rm.js";import{O as ze}from"./RefreshableLayer-CBbEkZf--CC_b3xaQ.js";import{s as Ye}from"./ScaleRangeLayer-DQr2T3Hh-Dh1UYk4i.js";import{j as Ze}from"./TemporalLayer-D4R0YvXo-CzgQNAIr.js";import{o as ce}from"./Field-Cm_ZejYW-CwJZmSru.js";import{P as Je,N as Ke}from"./rasterFieldUtils-0bNK-dHZ-COz_3SPB.js";import{z as B}from"./Extent-CgDMOSRD-CU1qE5Kr.js";import{r as ye}from"./crsUtils-DAndLU68-Bd9gMwk5.js";import{H as se}from"./Point-BfTTZoMu-BAT2Wq6O.js";import{P as Xe}from"./Polygon-D6wEPb3W-CpL9Efjx.js";import{ap as Qe,I as et,Z as re}from"./RasterSymbolizer-Dqn5Dve--B2hts7xc.js";import{S as tt}from"./popupUtils-D4UavgYz-4fibcgIL.js";import"./lengthUtils-Dt1_RvOO-bleznLOi.js";import"./date-IqUzANpt-bLKO9IDT.js";import"./Color-CERqXxxY-BuYn26eI.js";import"./mathUtils-PIGhLnI9-B1tKUlUb.js";import"./mat4f32-Djp3mnm5-DzYG3LYB.js";import"./mat4-C96X-Nn0-Do6fKsNS.js";import"./TileInfo-Bz7QlefV-tjhen9qQ.js";import"./Polyline-CoiTLswR-BLagWJLS.js";import"./projectionUtils-BGH_5_I3-BySNUA-B.js";import"./PixelBlock-DA_u_GpM-weQWKsre.js";import"./rasterFunctionHelper-Dh1b3BL7-CxBi_D0M.js";import"./vec42-B8VM4vXb-BnA9MysM.js";import"./vec4f64-DPb6J-GU-C7c2DqbZ.js";import"./typeUtils-DqrRcjBx-ZWdHcSIJ.js";import"./colorRamps-DswZzxkO-BqSFavfl.js";import"./FeatureSet-BF7daP96-BqhMUjXs.js";import"./Graphic-DgGzDmqW-CFzg0c4i.js";import"./typeUtils-CXW_VpOn-BoSnXkME.js";import"./lineMarkers-CDwLe3J6-CNUjJvs3.js";import"./PolygonSymbol3D-BXRHZiCQ-Vi0-2Gvc.js";import"./ExtrudeSymbol3DLayer-DSc1ou2x-CsVYZCeG.js";import"./aaBoundingBox-Cn49X7ge-DORLZxoS.js";import"./mat4f64-q_b6UJoq-Dh6sWB_w.js";import"./Font-BwmnW7d2-D-oIm_Md.js";import"./SimpleFillSymbol-CDawtd9z-CWD2KI2D.js";import"./SimpleMarkerSymbol-BGAFRS9_-CVQ5NLIA.js";import"./PictureMarkerSymbol-CaSh-vZk-BNpExnAb.js";import"./TextSymbol-hRGhyDHs-C0NgASym.js";import"./ElevationInfo-Cw2HaA6E-Br1RWTYu.js";import"./unitConversionUtils-4vB4Ezlp-B0eWR3Ls.js";import"./asyncUtils-w6KfWU41-HenJ0UOu.js";import"./PortalItem-DnxMlRVo-Dhq4alsp.js";import"./ClassBreaksRenderer-BvgdqtTq-DxMHNS7X.js";import"./commonProperties-DbO613LF-DeJ_ZDUB.js";import"./ColorStop-De5gQTjr-C1lw16u9.js";import"./visualVariableUtils-ma4r7Z2K-C4Gu8Tj6.js";import"./defaults3D-C2hXSee1-DVT6WkAf.js";import"./defaults-BDN9qxeN-CCVK4JpS.js";import"./RendererLegendOptions-ByGHYLtx-C9PvCikc.js";import"./UniqueValueRenderer-JPjz9Qvs-C1w5-GWR.js";import"./workers-BEkgoq8Q-BNWfkyQs.js";import"./intl-DRFqUect-ClAS7BRt.js";import"./normalizeUtils-85zLqeMi-DCF9gKvo.js";import"./normalizeUtilsCommon-CnhQye_A-zWtr51r8.js";import"./utils-Dha_-5-2-eHjlcsVE.js";import"./LRUCache-fy84PBMi-Y56WPIvD.js";import"./ClassBreaksDefinition-BGOzyovZ-K0U0wKo_.js";import"./TimeInfo-D7ssmbZO-CCS1Im5i.js";import"./fieldType-DVUzXtk_-tUuvnZJM.js";import"./reader-DcGs6kKN-DHJfK-tm.js";import"./SimpleObservable-CvFyr0NA-DXpoMYph.js";import"./layerContainerType-CSXZNpHb-BIF7XAYP.js";import"./jsonUtils-CY6YsQMo-SliJcuqs.js";import"./screenUtils-BitdhK1O-L0FLPAMi.js";import"./datasetUtils-DdDUWBI2-CH5OCkUx.js";import"./QueueProcessor-D8z0mMzA-GcdBlDoB.js";import"./Queue-CYlrXMwB-CYJTUII-.js";import"./ReactiveMap-B0by2bYu-DCsCfMj5.js";import"./signal-BX9ezF8a-cf1Pn6io.js";import"./rasterProjectionHelper-CKWxY3oy-CcS-Q5Ne.js";import"./opacityUtils-DuFH0EC9-DWspTgn2.js";import"./layerUtils-DZGhvm-W-DLw3QMll.js";import"./portalItemUtils-CaPNUJg6-JsqddoLx.js";import"./jsonUtils-CmpazY1u-ateEpj4Q.js";import"./dataUtils-1NJ_tbX7-DOg3Y4ON.js";import"./aaBoundingRect-CjwcS2F3-D7aII9DY.js";import"./_commonjsHelpers-DCkdB7M8-DwXtFsJ3.js";import"./colorUtils-CeIi7j7j-nwrKvQYb.js";import"./TileKey-CXWFOqOI-CcilLir8.js";import"./createFeatureId-CVwTD0fV-3fKpJDrk.js";import"./DoubleArray-DExKNiTh-CvVpHySW.js";import"./jsonUtils-C9q_FK4K-Cuz7ImzI.js";import"./defaultsJSON-GKolV7NZ-GKolV7NZ.js";import"./diffUtils-wTC1YzlE-JuqUWoWa.js";import"./styleUtils-DWvicjTN-DYvOM9HS.js";import"./Cyclical-BLSxUpe7-Bj8R2Yk-.js";import"./utils-CylVuxNi-CqOfmBVG.js";import"./utils-Dpg4yj1D-BVnuoMV8.js";import"./cimSymbolUtils-DOGwV0lV-DF1x9X12.js";import"./utils-DX2muIr3-DiPfFKSl.js";import"./timeZoneUtils-BSc7-7qA-BAv3h8mh.js";const be=(e,t=be,i=t.f||(t.f=["assets/imageryUtils-Cv1J3BuP.js","assets/utils-CwBq5UrM.js","assets/jsonMap-Bs3hmeCU.js","assets/originUtils-CPX8CCAY.js","assets/multiOriginJSONSupportUtils-C0wm8_Yw.js","assets/collectionUtils-jDyktm0P.js","assets/index-BzxsWNRw.js","assets/index-Cv2ko1Ob.css","assets/Point-BfTTZoMu.js","assets/reader-DcGs6kKN.js","assets/reactiveUtils-SO2Ko3sy.js","assets/Extent-CgDMOSRD.js","assets/SimpleObservable-CvFyr0NA.js","assets/PortalItem-DnxMlRVo.js","assets/jsonContext-C00-qqFg.js","assets/portalItemUtils-CaPNUJg6.js","assets/projectionUtils-BGH_5_I3.js","assets/Polyline-CoiTLswR.js","assets/Polygon-D6wEPb3W.js","assets/aaBoundingRect-CjwcS2F3.js","assets/mathUtils-PIGhLnI9.js","assets/saveUtils-BO8L-Vl8.js","assets/Layer-DZvC7bne.js","assets/date-IqUzANpt.js","assets/datasetUtils-DdDUWBI2.js"]))=>e.map(r=>i[r]),it=Symbol("isWCSGraphicOrigin");var me;class nt extends Ee{get[(me=it,Me)](){return this.layer}constructor(t){super(),this[me]=!0,this.type="wcs",this.layer=t}get id(){return this.layer.id}}function K(e){return e.endsWith("?")?e.slice(0,-1):e}function oe(e){return e.filter(({coverageSubType:t})=>t==null||t===""||/^rectified(grid|dataset)/i.test(t))}function st(e){const t=y(e,"Service/name"),i=w(e,"Capability"),r=w(i,"GetCapabilities/Get/OnlineResource")?.getAttribute("xlink:href")??"",n=w(i,"DescribeCoverage/Get/OnlineResource")?.getAttribute("xlink:href")??"",o=w(i,"GetCoverage/Get/OnlineResource")?.getAttribute("xlink:href")??"",s={getCapabilities:K(r),describeCoverage:K(n),getCoverage:K(o)},a=$(e,"CoverageOfferingBrief"),c=[];for(let l=0;l<a.length;l++){const u=a[l],d=y(u,"name"),p=$(u,"pos"),f=S(p[0]),m=S(p[1]),g=new B({xmin:f[0],ymin:f[1],xmax:m[0],ymax:m[1],spatialReference:{wkid:4326}});c.push({id:d,lonLatEnvelope:g})}return{name:t,onlineResources:s,coverages:c,gridCoverages:oe(c),supportedVersions:["1.0.0"],version:"1.0.0"}}function we(e){const t={};for(let i=0;i<e.childNodes.length;i++){const r=e.childNodes[i];if(r.nodeType!==1)continue;const n=ve(r).toLowerCase();switch(n){case"title":case"abstract":t[n]=y(r);break;case"identifier":t.id=y(r);break;case"wgs84boundingbox":{const o=S(r,"LowerCorner"),s=S(r,"UpperCorner");t.lonLatEnvelope=new B({xmin:o[0],ymin:o[1],xmax:s[0],ymax:s[1],spatialReference:{wkid:4326}})}break;case"coveragesummary":t.coverageSummaries=t.coverageSummaries||[],t.coverageSummaries.push(we(r))}}return t}function xe(e,t){if(e.coverageSummaries)for(let i=0;i<e.coverageSummaries.length;i++)e.coverageSummaries[i].abstract=e.coverageSummaries[i].abstract||e.abstract,e.coverageSummaries[i].lonLatEnvelope=e.coverageSummaries[i].lonLatEnvelope||e.lonLatEnvelope,e.coverageSummaries[i].title=e.coverageSummaries[i].title||e.title,xe(e.coverageSummaries[i],t);e.id!=null&&t.push(e)}function Ce(e){const t=w(e.querySelector("Operation[name=GetCapabilities]"),"Get")?.getAttribute("xlink:href")||"",i=w(e.querySelector("Operation[name=DescribeCoverage]"),"Get")?.getAttribute("xlink:href")||"",r=w(e.querySelector("Operation[name=GetCoverage]"),"Get")?.getAttribute("xlink:href")||"";return{getCapabilities:K(t),describeCoverage:K(i),getCoverage:K(r)}}function rt(e){const t=y(e,"ServiceIdentification/Title"),i=E(e,"ServiceIdentification/ServiceTypeVersion"),r=Ce(w(e,"OperationsMetadata")),n=[],o=w(e,"Contents");for(let a=0;a<o.childNodes.length;a++){const c=o.childNodes[a];c.nodeType===1&&A(c,"CoverageSummary")&&xe(we(c),n)}const s=E(o,"SupportedFormat");return{name:t,onlineResources:r,coverages:n,gridCoverages:oe(n),supportedVersions:i,supportedFormats:s,version:"1.1.0"}}function ot(e){const t=w(e,"ServiceIdentification"),i=y(t,"Title"),r=E(t,"ServiceTypeVersion"),n=E(t,"Profile"),o=Ce(w(e,"OperationsMetadata")),s=$(e,"Contents/CoverageSummary"),a=[];for(let l=0;l<s.length;l++){const u=s[l],d=y(u,"CoverageId"),p=w(u,"WGS84BoundingBox");let f;if(p){const g=S(p,"LowerCorner"),h=S(p,"UpperCorner");f=new B({xmin:g[0],ymin:g[1],xmax:h[0],ymax:h[1],spatialReference:{wkid:4326}})}const m=y(u,"CoverageSubtype")||"RectifiedGridCoverage";a.push({id:d,lonLatEnvelope:f,coverageSubType:m})}const c=w(e,"ServiceMetadata");return{name:i,supportedVersions:r,supportedFormats:E(c,"formatSupported"),supportedInterpolations:E(c,"interpolationSupported").concat(E(c,"InterpolationSupported")),onlineResources:o,profiles:n,coverages:a,gridCoverages:oe(a),version:"2.0.1"}}function at(e){let t=null;typeof e=="string"?t=new DOMParser().parseFromString(e,"text/xml"):t=e;const i=t.documentElement.getAttribute("version"),r=i?.slice(0,3);return r!=null&&r<"2.1"}function lt(e,t=null){let i=null;typeof e=="string"?i=new DOMParser().parseFromString(e,"text/xml"):i=e;let r=i.documentElement.getAttribute("version");r==="1.0"?r="1.0.0":r==="1.1"&&(r="1.1.0");const n=r||t||"1.0.0",o=n.slice(0,3);let s;if(o==="2.0")s=ot(i);else if(o==="1.1")s=rt(i);else{if(o!=="1.0")throw new V("wcsraster:parsecapabilities","the capabilities version is not supported");s=st(i)}return s.version=n,s}function ae(e){e.variables.forEach(t=>t.dimensions.forEach(i=>i.values??=He(i)))}function pt(e){return{requestResponseCRSs:E(e,"requestResponseCRSs").map(t=>t.split(":")[1]),nativeCRSs:E(e,"nativeCRSs").map(t=>t.split(":")[1])}}function Ie(e,t){const i=E(e,t==="1.0.0"?"interpolationMethod":"InterpolationMethod"),r=t==="1.0.0"?e.getAttribute("default"):y(e,"InterpolationMethods/Default");return r!=null?[r].concat(i.filter(n=>n.toLowerCase()!==r.toLowerCase())):i}function le(e){return e==null?["nearest"]:e.map(t=>{const i=t.toLowerCase();return i.includes("nearest")?"nearest":i.includes("linear")?"bilinear":i.includes("cubic")?"cubic":null}).filter(t=>!!t)}function ut(e){const t=$(e,"pos"),i=S(t[0]),r=S(t[1]);return new B({xmin:i[0],ymin:i[1],xmax:r[0],ymax:r[1],spatialReference:{wkid:4326}})}function pe(e,t){const i=E(e,t);return i?.length&&i[0]!==""&&!isNaN(Number(i[0]))?i.map(r=>Number(r)):null}function ct(e){const t=S(e,"MinimumValue"),i=S(e,"MaximumValue");return t.length&&i.length?t.map((r,n)=>({min:r,max:i[n],avg:-1,stddev:-1})):null}function ue(e){return e==null?null:e.every(t=>t===e[0])?e[0]:e}function mt(e){const t=[],i=$(e,"RangeSet");let r=[];for(let n=0;n<i.length;n++){const o=y(i[n],"name"),s=y(i[n],"label"),a=[],c=pe(i[n],"nullValues/singleValue"),l=$(i[n],"AxisDescription");for(let u=0;u<l.length;u++){const d=y(l[u],"name"),p=y(l[u],"label"),f=E(l[u],"singleValue");if(f.length===0){const m=y(l[u],"min"),g=y(l[u],"max"),h=Number(y(l[u],"res"))||1;if(m!==null&&g!==null)for(let v=parseInt(m,10);v<=parseInt(g,10);v+=h)f.push(v.toString())}d.toLowerCase()==="band"&&(r=f),a.push({name:d,label:p,values:f})}t.push({name:o,label:s,nullValues:c,axis:a})}return{rangeSet:t,bandNames:r}}function dt(e=null){if(!e)return{resolution:null,units:null};let t=e.toUpperCase();const i=["Y","M","D"],r=["H","M","S"],n=["Years","Months","Days","Hours","Minutes","Seconds"];let o,s,a;return t.includes("PT")?(t=t.slice(2),a=r.findIndex(c=>t.includes(c)),o=n[3+a],s=parseFloat(t.slice(0,-1))):(t=t.slice(1),a=i.findIndex(c=>t.includes(c)),a>-1&&(o=n[a]),s=parseFloat(t.slice(0,-1))),{resolution:s,units:o}}function ee(e){const t=$(e,"timeposition");if(t.length>0){const r=[];for(let n=0;n<t.length;n++)r.push(new Date(y(t[n])));return{begin:r[0],end:r[r.length-1],values:r}}const i=w(e,"timePeriod")||w(e,"TimePeriod");return i?{begin:new Date(y(i,"beginPosition")||y(i,"BeginPosition")),end:new Date(y(i,"endPosition")||y(i,"EndPosition")),...dt(y(i,"timeResolution")||y(i,"TimeResolution"))}:null}function ft(e){const t=w(e,"spatialDomain"),i=w(t,"Envelope")||w(t,"EnvelopeWithTimePeriod"),r=i.getAttribute("srsName").split(":"),n=r[r.length-1],o=$(i,"pos"),s=S(o[0]),a=S(o[1]),c=parseInt(n,10),l=isNaN(c)?null:{wkid:c},u=new B({xmin:s[0],ymin:s[1],xmax:a[0],ymax:a[1],spatialReference:l}),d=w(t,"RectifiedGrid"),p=y(d,"low").split(" "),f=y(d,"high").split(" "),m=parseInt(f[0],10)-parseInt(p[0],10)+1,g=parseInt(f[1],10)-parseInt(p[1],10)+1,h=S(t,"origin/pos"),v=$(t,"offsetVector"),b={envelope:u,columns:m,rows:g,offset:{x:parseFloat(y(v[0]).split(" ")[0]),y:parseFloat(y(v[1]).split(" ")[1])},origin:{x:h[0],y:h[1]}},x=w(e,"temporalDomain")||w(e,"TemporalDomain");return{spatialDomain:b,temporalDomain:x?ee(x):null}}function gt(e){const t={version:"1.0"};let i,r=[];for(let m=0;m<e.childNodes.length;m++){const g=e.childNodes[m];if(g.nodeType===1)if(A(g,"description"))t.description=y(g);else if(A(g,"name"))t.name=y(g);else if(A(g,"label"))t.label=y(g);else if(A(g,"supportedFormats"))t.supportedFormats=E(g,"formats");else if(A(g,"supportedCRSs"))t.supportedCRSs=pt(g);else if(A(g,"supportedInterpolations"))t.supportedInterpolations=Ie(g,"1.0.0");else if(A(g,"lonLatEnvelope"))t.lonLatEnvelope=ut(g);else if(A(g,"rangeSet")){const h=mt(g);t.rangeSet=h.rangeSet,r=h.bandNames;const v=h.rangeSet[0].nullValues;v?.length&&(i=ue(v))}else A(g,"domainSet")&&(t.domainSet=ft(g))}const n=le(t.supportedInterpolations),{name:o,description:s,label:a,lonLatEnvelope:c,supportedFormats:l}=t,{spatialDomain:u}=t.domainSet,d={x:Math.abs(u.offset.x),y:Math.abs(u.offset.y)},p=ht(t.domainSet),f=new re({width:u.columns,height:u.rows,pixelSize:d,pixelType:"unknown",extent:u.envelope,spatialReference:u.envelope.spatialReference,bandCount:r.length||1,noDataValue:i,multidimensionalInfo:p});return{id:o,title:t.name,description:s||a,lonLatEnvelope:c,rasterInfo:f,bandNames:r,supportedFormats:l,supportedInterpolations:n,coverageDescription:t,version:"1.0.0",useEPSGAxis:!1}}function ht(e){if(!e.temporalDomain)return null;const{begin:t,end:i,values:r,units:n,resolution:o}=e.temporalDomain,s={variables:[{name:"default",description:"",dimensions:[{name:"StdTime",description:"",unit:"ISO8601",values:r?.map(a=>a.getTime()),hasRegularIntervals:!r,interval:o,intervalUnit:n,extent:[t.getTime(),i.getTime()]}]}]};return ae(s),s}function vt(e,t){const i=[],r=$(e,"Field");let n,o=[];for(let s=0;s<r.length;s++){const a=y(r[s],"Identifier"),c=y(r[s],"Description"),l=y(r[s],"Definition"),u=y(r[s],"Abstract"),d=y(r[s],"Title"),p=pe(r[s],"NullValue"),f=w(r[s],"AllowedValues"),m=f?ct(f):null,g=Ie(r[s],"1.1.0"),h=[],v=$(r[s],"Axis");for(let b=0;b<v.length;b++){const x=v[b].getAttribute("identifier"),I=y(v[b],"UOM"),P=y(v[b],"DataType"),W=E(v[b],"Key");t&&!x.toLowerCase().includes("band")||(o=W,n=p),h.push({identifier:x,uom:I,dataType:P,values:W,bandNoDataValues:n})}i.push({identifier:a,description:c,definition:l,abstract:u,title:d,supportedInterpolations:g,axis:h,nullValues:p,statistics:m})}return{rangeSet:i,bandNames:o,bandNoDataValues:n,statistics:i[0].statistics}}function yt(e,t){if(!t.temporalDomain)return null;const i=e.filter(n=>!n.identifier.toLowerCase().includes("field_1")&&!n.axis.some(o=>o.identifier.includes("band"))),r=[];if(i.length&&i.forEach(n=>{const o=n.axis.map(s=>{const a=s.values.map(l=>s.uom==="ISO8601"?(l=l.trim()).toLowerCase().includes("z")?new Date(l).getTime():new Date(l+"Z").getTime():parseFloat(l.trim())),c=[Math.min.apply(null,a),Math.max.apply(null,a)];return{name:s.identifier.trim(),description:"",field:s.identifier.trim(),unit:s.uom?s.uom.trim():"",hasRegularIntervals:!1,values:a,extent:c}});r.push({name:n.identifier.trim(),description:n.description?.trim()??"",unit:"",dimensions:o,statistics:n.statistics})}),t.temporalDomain){const{begin:n,end:o,values:s,units:a,resolution:c}=t.temporalDomain;r.some(l=>l.dimensions.some(u=>u.name.toLowerCase()==="stdtime"))||r.forEach(l=>{l.dimensions.push({name:"StdTime",description:"",unit:"ISO8601",values:s?.map(u=>u.getTime()),hasRegularIntervals:!s,interval:c,intervalUnit:a,extent:[n.getTime(),o.getTime()]})})}if(r.length){const n={variables:r};return ae(n),n}return null}function bt(e){const t=w(e,"SpatialDomain"),i=w(t,"GridCRS"),r=y(i,"GridBaseCRS"),n=y(i,"GridOrigin"),o=n?.split(" ").map(v=>parseFloat(v))??[0,0],s=S(i,"GridOffsets"),a=$(t,"BoundingBox");let c,l,u,d;for(let v=0;v<a.length;v++){const b=a[v].getAttribute("crs")?.toLowerCase();if(b!=null){if(b.includes("imagecrs")){const x=S(a[v],"LowerCorner"),I=S(a[v],"UpperCorner");c=I[0]-x[0]+1,l=I[1]-x[1]+1}else if(b.indexOf("epsg")>0){const x=b.split(":");u=parseInt(x[x.length-1],10);const I=S(a[v],"LowerCorner"),P=S(a[v],"UpperCorner");d=new B({xmin:I[0],ymin:I[1],xmax:P[0],ymax:P[1],spatialReference:{wkid:u}})}}}const p=c>l,f=d.xmax-d.xmin>d.ymax-d.ymin;let m=!1;ye(u)&&(p===f?m=!1:(m=!0,d=new B({xmin:d.ymin,ymin:d.xmin,xmax:d.ymax,ymax:d.xmax,spatialReference:{wkid:u}})));const g={columns:c,rows:l,origin:{x:o[0],y:o[1]},offset:{x:s[0],y:s[s.length-1]},gridBaseCRS:r,envelope:d,useEPSGAxis:m},h=w(e,"temporalDomain")||w(e,"TemporalDomain");return{spatialDomain:g,temporalDomain:h?ee(h):null}}function wt(e,t){const i=[],r=[],n={supportedFormats:i,supportedCRSs:r,version:"1.1"};let o,s,a=[];for(let v=0;v<e.childNodes.length;v++){const b=e.childNodes[v];if(b.nodeType!==1)continue;const x=ve(b).toLowerCase();switch(x){case"title":case"abstract":case"identifier":n[x]=y(b);break;case"supportedformat":{const I=y(b);i.includes(I)||i.push(I)}break;case"supportedcrs":{const I=y(b);r.includes(I)||r.push(I)}break;case"range":{const I=vt(b,!!n.domain?.temporalDomain);n.range=I.rangeSet,a=I.bandNames;const{bandNoDataValues:P}=I;P?.length&&(o=ue(P)),s=I.statistics}break;case"domain":n.domain=bt(b)}}const c=le(n.range[0].supportedInterpolations),{identifier:l,abstract:u,title:d,domain:p,range:f}=n,m={x:Math.abs(p.spatialDomain.offset.x),y:Math.abs(p.spatialDomain.offset.y)},g=yt(f,p);g&&(o=f[0].nullValues,o?.length===1&&(o=o[0]));const h=new re({width:p.spatialDomain.columns,height:p.spatialDomain.rows,pixelSize:m,pixelType:"unknown",extent:p.spatialDomain.envelope,spatialReference:p.spatialDomain.envelope.spatialReference,bandCount:a.length||1,noDataValue:o,statistics:s,multidimensionalInfo:g});return{id:l,title:n.title,description:u||d,bandNames:a,rasterInfo:h,supportedFormats:i,supportedInterpolations:c,coverageDescription:n,version:t,useEPSGAxis:p.spatialDomain.useEPSGAxis}}function xt(e){const t=w(e,"Envelope")||w(e,"EnvelopeWithTimePeriod"),i=t.getAttribute("srsName"),r=i.slice(i.lastIndexOf("/")+1),n=t.getAttribute("axisLabels").split(" ").map(g=>g.trim()).filter(g=>g.trim()!==""),o=S(t,"lowerCorner"),s=S(t,"upperCorner"),a=!["y","lat","latitude","north","nor","n","b"].includes(n[0].toLowerCase());let c;const l=parseInt(r,10),u=isNaN(l)?null:{wkid:l};c=new B(a?{xmin:o[0],ymin:o[1],xmax:s[0],ymax:s[1],spatialReference:u}:{xmin:o[1],ymin:o[0],xmax:s[1],ymax:s[0],spatialReference:u});const d={mins:o,maxs:s},p=t.getAttribute("uomLabels").trim().split(" ");let f,m;if(A(t,"EnvelopeWithTimePeriod")){f=new Date(y(e,"beginPosition")||y(e,"BeginPosition")),m=new Date(y(e,"endPosition")||y(e,"EndPosition"));const g=p?.findIndex(h=>h?.toLowerCase()==="oledatetime");g>-1&&(p[g]="ISO8601")}return{envelope:c,axisLabels:n,uomLabels:p.length?p:null,envelopeAllDims:d,beginPosition:f,endPosition:m,isEastFirst:a}}function Ct(e,t){const i=[],r=$(e,"DataRecord"),n=[];let o,s=[];for(let a=0;a<r.length;a++){const c=$(r[a],"field"),l=[];for(let u=0;u<c.length;u++){const d=c[u].getAttribute("name"),p=y(c[u],"description")||"",f=w(c[u],"uom")?.getAttribute("code")||"",m=S(c[u],"interval"),g=pe(c[u],"nilValue")?.[0];t&&!d.toLowerCase().includes("band")||(n.push(d),m?.length&&(o=o||[],o.push({min:m[0],max:m[1],avg:-1,stddev:-1})),s.push(g)),l.push({name:d,description:p,uom:f,allowedValues:m,nilValue:g})}i.push(l)}return s.some(a=>a!=null)||(s=null),{rangeType:i,bandNames:n,bandStats:o,bandNoDataValues:s}}function It(e){let t=1,i="";const r=.01;return Math.abs(e-1/24)<1/24*r?i="Hours":Math.abs(e-1)<1*r?i="Days":e<1?(t=Math.round(24*e),i="Hours"):e>28-r&&e<31+r||Math.round(e/30)<12?i="Months":e>365-r&&e<366+r&&(i="Years"),{interval:t,intervalUnit:i}}function St(e,t,i){if(i.axisLabels.length<=2)return null;const r=[];for(let o=0;o<e.length;o++){const s=e[o];for(let a=0;a<s.length;a++)s[a].name.toLowerCase().includes("band")||r.push(s[a])}const n=[];if(r.length){const o=[];for(let s=2;s<i.axisLabels.length;s++){const a=t.uomLabels?.[s]?.trim()??"",c=i.axisLabels[s].toLowerCase().includes("time")||a.toLowerCase()==="iso8601"||a.toLowerCase()==="oledatetime";let l,u;if(c){const p=It(i.offset[s]);l=p.interval,u=p.intervalUnit}else l=i.offset[s],u=a;const d=[];c?(d.push(ne(t.envelopeAllDims.mins[s])),d.push(ne(t.envelopeAllDims.maxs[s]))):(d.push(t.envelopeAllDims.mins[s]),d.push(t.envelopeAllDims.maxs[s])),o.push({name:i.axisLabels[s].trim(),description:i.axisLabels[s].trim(),unit:c?"ISO8601":a,hasRegularIntervals:!0,extent:d,interval:l,intervalUnit:u})}if(r.forEach(s=>{const{allowedValues:a}=s,c=a?.length===2?[{min:a[0],max:a[1],avg:-1,stddev:-1}]:null;n.push({name:s.name.trim(),description:s.description?.trim()??"",unit:s.uom.trim(),statistics:c,dimensions:[...o]})}),n.length){const s={variables:n};return ae(s),s}}return null}function Dt(e,t){const i=w(e,"RectifiedGrid"),r=S(i,"low"),n=S(i,"high"),o=[];for(let h=0;h<r.length;h++)o.push(n[h]-r[h]+1);const s=y(i,"axisLabels").split(" "),a=S(i,"origin/pos"),c=$(i,"offsetVector"),l=[];for(let h=0;h<c.length;h++){const v=S(c[h]),b=v.findIndex(x=>x!==0);l[b]=v[b]}const u=["y","lat","latitude","north","nor","n","b"];let d=!1;t?.length&&s?.length&&(d=[...t].sort((h,v)=>h<v?-1:1).join(",")===[...s].sort((h,v)=>h<v?-1:1).join(","));const p=d?s:t;let f,m,g;return u.includes(p[0].toLowerCase())?(f=o[1],m=o[0],g={y:Math.abs(l[0]),x:Math.abs(l[1])}):(f=o[0],m=o[1],g={x:Math.abs(l[0]),y:Math.abs(l[1])}),{columns:f,rows:m,origin:a,offset:l,resolution:g,gridSamples:o,axisLabels:s,hasSameAxisLabelsAsBoundedBy:d}}function Tt(e){const t=w(e,"EarthObservation");if(!t)return null;const i=w(t,"phenomenonTime"),r=i?ee(i):null,n=w(t,"phenomenonTime"),o=n?ee(n):null,s=y(t,"featureOfInterest/Footprint/multiExtentOf/MultiSurface/surfaceMembers/Polygon/exterior/LinearRing/posList");let a=null;if(s){const c=s.split(" ").map(l=>l.trim()).filter(l=>l!=null&&l!=="").map(Number);if(c.length){const l=[];for(let u=0;u<c.length/2;u+=2)l.push(c[u],c[u+1]);a=new Xe({rings:[[l]]})}}return{observation:{phenomenonTime:r,resultTime:o,footprint:a,identifier:y(e,"metaDataProperty/EarthObservationMetaData/identifier"),acquisitionType:y(e,"metaDataProperty/EarthObservationMetaData/acquisitionType"),status:y(e,"metaDataProperty/EarthObservationMetaData/status")}}}function Lt(e){const t={version:"2.0"};let i,r,n=[];for(let d=0;d<e.childNodes.length;d++){const p=e.childNodes[d];if(p.nodeType===1){if(A(p,"coverageId"))t.coverageId=y(p);else if(A(p,"ServiceParameters"))t.serviceParameters={supportedFormats:E(p,"nativeFormat")};else if(A(p,"boundedBy"))t.boundedBy=xt(p);else if(A(p,"rangeType")){const f=Ct(p,t.boundedBy?.axisLabels.length>2||t.domainSet?.axisLabels.length>2);t.rangeType=f.rangeType,n=f.bandNames,i=f.bandStats;const{bandNoDataValues:m}=f;m?.length&&(r=ue(m))}else if(A(p,"domainSet"))t.domainSet=Dt(p,t.boundedBy?.axisLabels);else if(A(p,"metadata")){const f=w(p,"EOMetadata");t.eoMetadata=f?Tt(f):null}}}const{coverageId:o,boundedBy:s,domainSet:a,rangeType:c,serviceParameters:l}=t,u=St(c,s,a);return!i&&u&&(i=u?.variables[0].statistics),u!=null&&(r=c[0][0].nilValue),{id:o,title:o,description:o,bandNames:n,rasterInfo:new re({width:a.columns,height:a.rows,pixelSize:a.resolution,pixelType:"unknown",extent:s.envelope,spatialReference:s.envelope.spatialReference,bandCount:n.length||1,statistics:i,noDataValue:r,multidimensionalInfo:u}),supportedFormats:l.supportedFormats,coverageDescription:t,version:"2.0.1",useEPSGAxis:!1}}function Pt(e,t){let i=null;if(typeof e=="string"?i=new DOMParser().parseFromString(e,"text/xml"):i=e,t==="1.0.0")return $(i,"CoverageOffering").map(n=>gt(n));const r=$(i,"CoverageDescription");return t==="1.1.0"||t==="1.1.1"||t==="1.1.2"?r.map(n=>wt(n,t)):r.map(n=>Lt(n))}async function Rt(e,t){const{version:i,customParameters:r,signal:n}=t??{},o=i?.startsWith("1.0")?"version":"acceptVersions",s={service:"WCS",request:"GetCapabilities",[o]:i,...r};try{let{data:a}=await se(e,{query:s,responseType:"xml",signal:n});return t?.version||at(a)||(s[o]="2.0.1",{data:a}=await se(e,{query:s,responseType:"xml",signal:n})),lt(a)}catch(a){throw ge(a)?a:new V("wcslayer:open","wcs capabilities is not valid or supported")}}async function ie(e,t){const{coverageIds:i,version:r,customParameters:n,signal:o}=t,s=r.slice(0,3),a=s==="1.0"?"coverage":s==="1.1"?"identifiers":"coverageId",c={service:"WCS",request:"DescribeCoverage",version:r,[a]:i.join(","),...n};try{const{data:l}=await se(e,{query:c,responseType:"xml",signal:o});return Pt(l,r)}catch(l){throw ge(l)?l:new V("wcslayer:open","wcs coverage description is not valid or supported")}}function At(e){const t=Ot(e);return t?{isMultipart:!0,data:t.boundary?$t(e.data,t,0):null}:{isMultipart:!1,data:null}}function $t(e,t,i=0){const r="--"+t.boundary,n=[];for(let h=0;h<r.length;h++)n.push(r.charCodeAt(h));const o=[],s=`
--`+t.boundary+"--";for(let h=0;h<s.length;h++)o.push(s.charCodeAt(h));const a=[10],c=[13,10],l=[],u=n.length,d=new Uint8Array(e,i),p=d.length-u;let f=0,m=0;for(let h=0;h<p;h++){for(m=0;m<u&&d[h+m]===n[m];m++);if(m!==u)continue;let v=!1;if(f){const b=de(d.subarray(f,h),t);l.push(b),v=!!b.isValidImage}if(h+=u-1,d[h+1]===a[0]?h+=1:d[h+1]===c[0]&&d[h+2]===c[1]&&(h+=2),f=h+1,v)break}const g=o.length;for(let h=d.length-g-10;h<d.length-g;h++){for(m=0;m<g&&d[h+m]===o[m];m++);if(m===g){l.push(de(d.subarray(f,h),t));break}}return l}function Ot(e){const t=e.getHeader?.("Content-Type")?.split(";");if(!t||!(t[0].trim()??"").startsWith("multipart/"))return null;const i={boundary:"",start:"",type:""};for(let r=1;r<t.length;r++){const n=t[r].indexOf("=");if(n>0){const o=t[r].slice(0,n).trim(),s=t[r].slice(n+1).trim();i[o]=s.startsWith('"')?s.slice(1,-1):s}}return i}function de(e,t){const i=String.fromCharCode.apply(null,e.subarray(0,Math.min(300,e.length))).split(`
`),r=Math.min(i.length,7),n={contentDisposition:"inline"};let o=0;for(let s=0;s<r;s++)if(i[s].length<4)o=o+i[s].length+1;else if(i[s].slice(0,7).toLowerCase()==="content"){o=o+i[s].length+1;const a=i[s].indexOf(":");if(a===-1)continue;const c=i[s].slice(0,a).trim(),l=i[s].slice(a+1).trim();switch(c.toLowerCase()){case"content-type":n.contentType=l;break;case"content-description":n.contentDescription=l;break;case"content-transfer-encoding":n.contentTransferEncoding=l;break;case"content-id":n.contentID=l;break;case"content-disposition":n.contentDisposition=l;break;case"content-location":n.contentLocation=l}}else{if(n.contentDisposition.toLowerCase().includes("inline")&&i[s].length>=4&&n.contentType?.toLowerCase().includes("image")){let a=!0,c=e.subarray(o,e.length);if(n.contentType.toLowerCase().indexOf("tif")>0){if(n.contentTransferEncoding==="base64"){let l="";const u=c;for(let p=0;p<u.length;p+=65535){const f=u.subarray(p,p+65535>u.length-1?u.length-1:p+65535);l+=String.fromCharCode.apply(null,f)}const d=atob(l);c=new Uint8Array(d.length);for(let p=0;p<c.length;p++)c[p]=d.charCodeAt(p)}a=c[0]===73&&c[1]===73||c[0]===77&&c[1]===77}if(a){let l=c.buffer;n.contentTransferEncoding!=="base64"&&(l=new ArrayBuffer(e.length-o),c=new Uint8Array(l),c.set(e.subarray(o,e.length))),n.contentData=l,n.isValidImage=!0}break}if((t.start===""||n.contentID===t.start)&&n.contentType){if(n.contentType.includes("text")||n.contentType.includes("xml")){n.contentData=String.fromCharCode.apply(null,e.subarray(o,e.length));break}n.contentData=e.subarray(o,e.length)}}return n}const Et=["nearest neighbor","bilinear","bicubic"],Mt=["nearest","linear","cubic"],fe="response is not a supported multipart/related mediaType with inline tiff,  switching to compatibility mode",Nt="response is not a supported multipart mediaType with inline tiff",jt="response is base64 encoded which may impact layer display performance",Vt="server returns an exception",X=new Set(["1.0.0","1.1.0","1.1.1","1.1.2","2.0.1"]);let z=class extends Fe{constructor(){super(...arguments),this.datasetFormat="WCSServer",this.tileType="Raster"}get rasterId(){return`${this.url}-${this.coverageId}-${this.version}`}async fetchRawTile(e,t,i,r={}){if(this.isBlockOutside(e,t,i))return null;const{nativePixelSize:n,spatialReference:o}=this.rasterInfo,s=2**e,a=n.x*s,c=n.y*s,{blockWidth:l,blockHeight:u}=this.getBlockWidthHeight(e),{origin:d}=this.rasterInfo.storageInfo.tileInfo,p=this.getTileExtent({x:a,y:c},t,i,d,o,[l,u]),f=this.rasterInfo.extent,m=p.xmax>f.xmax,g=p.ymin<f.ymin,h=m||g;let v=p,b=l,x=u;if(h&&(v=p.clone().intersection(f),v!=null&&(m&&(b=Math.floor((v.xmax-v.xmin)/a),v.xmax=v.xmin+a*b),g&&(x=Math.floor((v.ymax-v.ymin)/c),v.ymin=v.ymax-c*x))),v==null||b<=1||x<=1)return null;const I=await this._getCoverage(v,b,x,s,r);if(!I)return null;const{coverageDescription:P}=this.coverageInfo,{noDataValue:W,multidimensionalInfo:M}=this.rasterInfo,{multidimensionalDefinition:q}=r;let U;if(M!=null&&q!=null&&q.length){const Y=q[0].variableName;P.version==="2.0"?U=P.rangeType[0].find(Z=>Z.name===Y)?.nilValue:P.version==="1.1"&&(U=P.range.find(Z=>Z.identifier===Y)?.nullValues)}const H=U??W,N=await this.decodePixelBlock(I,{width:b,height:x,planes:null,pixelType:null,tiffNoDataValue:Array.isArray(H)?H[0]:H,matchAllNoData:!0});if(N==null)return null;if(N&&(N.width!==b||N.height!==x))throw new V("wcsraster-fetch",`the response has unexpected dimension width: ${N.width}, height: {pixelBlock.height}`);return h?Qe(N,{x:0,y:0},{width:u,height:u}):N}async _open(e){const{customFetchParameters:t}=this.ioConfig,i=e?.signal,r=await Rt(this.url,{version:t?.version??this.version,customParameters:t,signal:i});if(this.capabilities=r,!this.version){let p=r.version.slice(0,3);p==="2.0"||p==="1.1"||p==="1.0"?this.version=r.version:(p=r.supportedVersions.find(f=>f==="2.0.1")||r.supportedVersions.find(f=>f.startsWith("2.0"))||r.supportedVersions.find(f=>f.startsWith("1.1"))||r.supportedVersions.find(f=>f.startsWith("1.0"))||"1.0.0",this.version=p)}const{version:n}=this;if(!X.has(n))throw new V("wcsraster-open",`unsupported WCS version ${n}`);const{gridCoverages:o}=r;if(!o.length)throw new V("wcsraster-open","cannot find rectified grid coverages");this.coverageId??=o[0].id;const{coverageId:s}=this,a=o.find(p=>p.id===s);if(a==null)throw new V("wcsraster-open",`the coverageId ${s} does not exist in capabilities`);const c=await ie(this.url,{coverageIds:[s],version:n,customParameters:t,signal:i});if(this.coverageInfo=c[0],n.startsWith("2.0")){const{coverageInfo:p}=this;p.lonLatEnvelope=a.lonLatEnvelope,p.supportedInterpolations=le(r.supportedInterpolations),this._patchDimensionValues201(s,i)}this.datasetName=this.coverageInfo.title;const{rasterInfo:l}=this.coverageInfo;if(this.createRemoteDatasetStorageInfo(l,512,512),this._set("rasterInfo",l),l.spatialReference==null)throw new V("wcsraster-open",`coverage without spatial reference is not supported: ${s}`);const{pixelType:u,bandCount:d}=await this._getPixelTypeAndBandCount(i);l.pixelType=u,l.bandCount===1&&d>1&&(l.bandCount=d),this.updateTileInfo()}async _patchDimensionValues201(e,t){const{coverageInfo:i}=this,r=i.rasterInfo.multidimensionalInfo?.variables,n=X.has("1.1.2")?"1.1.2":X.has("1.1.1")?"1.1.1":X.has("1.1.0")?"1.1.0":null,{customFetchParameters:o}=this.ioConfig;if(r&&n)try{const s=this.url.includes("/ImageServer/"),a=e.length>8&&e.startsWith("Coverage")&&s?e.slice(8):e,c=await ie(this.url,{coverageIds:[a??e],version:n,customParameters:o,signal:t}).catch(()=>{if(a)return ie(this.url,{coverageIds:[e],version:n,customParameters:o,signal:t})}),l=c?.[0].rasterInfo.multidimensionalInfo?.variables;if(l)for(const u of r){const d=l.find(({name:p})=>p===u.name);if(d?.dimensions?.length)for(let p=u.dimensions.length-1;p>=0;p--){const f=u.dimensions[p],m=d.dimensions.find(({name:g})=>g===f.name);m?m.values&&m.extent?.join(",")===f.extent?.join(",")&&(u.dimensions[p]={...f,values:m.values}):s&&u.dimensions.splice(p,1)}}}catch{}}async _getPixelTypeAndBandCount(e){const{pixelSize:t,extent:i,multidimensionalInfo:r}=this.rasterInfo,n=i.center,o=new B({xmin:n.x-t.x,xmax:n.x+t.x,ymin:n.y-t.y,ymax:n.y+t.y,spatialReference:i.spatialReference});let s=[];if(r!=null){const m=r.variables[0];s=[],m.dimensions.forEach(g=>{s.push(new qe({variableName:m.name,dimensionName:g.name,values:g.hasRegularIntervals?g.extent?.[0]:g.values?.[0],isSlice:!0}))})}const{coverageDescription:a}=this.coverageInfo,c={interpolation:"nearest",multidimensionalDefinition:s,signal:e},{version:l}=a,{ioConfig:u}=this,d=l==="2.0"&&u.allowAnyMediaType==null||l==="1.1"&&u.use2GridOffsets==null;let p;try{p=await this._getCoverage(o,2,2,1,c,!0)}catch(m){if(!d)throw m;if(l==="1.1"){if(!m.details?.isResolutionMismatch)throw m;u.use2GridOffsets=!0}}if(!p&&d&&(l==="2.0"&&(u.allowAnyMediaType=!0),p=await this._getCoverage(o,2,2,1,c),p&&te.getLogger(this).warn("wcsraster:getcoverage",fe)),!p)throw new V("wcsraster-open","unable to determine pixel type");const f=await this.decodePixelBlock(p,{width:2,height:2,planes:null,pixelType:null});if(f==null)throw new V("wcsraster-open","unable to determine pixel type");return{pixelType:f.pixelType,bandCount:f.getPlaneCount()??0}}async _getCoverage(e,t,i,r,n,o=!1){const{coverageDescription:s}=this.coverageInfo,{version:a}=s,c=a==="2.0"?this._getCoverage201Parameters(e,t,i,r,n,s):a==="1.1"?this._getCoverage110Parameters(e,t,i,n,s):this._getCoverage100Parameters(e,t,i,n),l=a==="2.0"?await this.request(this._constructWCS201Url(c),{signal:n.signal,responseType:"array-buffer"}):await this.request(this.url,{query:c,signal:n.signal,responseType:"array-buffer"});if(a==="1.0")return l.data;if(a==="2.0"&&this.ioConfig.allowAnyMediaType!==!1&&et(l.data)==="tiff")return o&&(this.ioConfig.allowAnyMediaType=!0,te.getLogger(this).warn("wcsraster:getcoverage",fe)),l.data;const u=At(l);if(u.isMultipart&&u.data){const m=u.data.find(g=>g.isValidImage);return o&&m?.contentTransferEncoding==="base64"&&te.getLogger(this).warn("wcsraster:getcoverage",jt),m?.contentData}const d=new Uint8Array(l.data,0,Math.min(l.data.byteLength,2e3)),p=String.fromCharCode.apply(null,d).toLowerCase().includes("exception"),f=p&&String.fromCharCode.apply(null,d).includes("A non-zero RESX/RESY or WIDTH/HEIGHT is required but neither was provided");throw p?new V("wcsraster:getcoverage",Vt,{isResolutionMismatch:f}):new V("wcsraster:getcoverage",Nt)}_getInterpolationIndex(e){return e&&this.coverageInfo.supportedInterpolations?.includes(e)?e==="nearest"?0:e==="bilinear"?1:e==="cubic"?2:0:0}_getCoverage100Parameters(e,t,i,r){const n=`${e.xmin},${e.ymin},${e.xmax},${e.ymax}`,o=e.spatialReference.wkid,s=(this.coverageInfo.supportedFormats||[]).find(m=>m.toLowerCase().includes("tiff"))||"GEOTIFF",{bandIds:a,interpolation:c}=r,l=this._getInterpolationIndex(c),u=a?a.map(m=>this.coverageInfo.bandNames[m]):null,d=Et[l],{multidimensionalDefinition:p}=r;let f;if(p!=null&&this.rasterInfo.multidimensionalInfo!=null){let m=p.find(g=>g.dimensionName==="StdTime")?.values;m&&m.length>0&&(Array.isArray(m[0])&&(m=m[0]),f=m.map(g=>Q(g)).join(","))}return{service:"WCS",request:"GetCoverage",version:this.version,coverage:this.coverageId,format:s,crs:`EPSG:${o}`,bbox:n,width:t,height:i,time:f,interpolation:d,band:u?.join(",")}}_getCoverage110Parameters(e,t,i,r,n){const{multidimensionalDefinition:o,bandIds:s,interpolation:a}=r,c=e.spatialReference.wkid,l=`urn:ogc:def:crs:EPSG::${c}`,u=(this.coverageInfo.supportedFormats||[]).find(R=>R.toLowerCase().includes("tiff"))||"image/tiff",d=this._getInterpolationIndex(a),p=Mt[d],f=a==null||this.coverageInfo.supportedInterpolations?.indexOf(a)===0,m=n.domain.spatialDomain,g=m.origin.x<=m.envelope.xmin&&m.origin.y<=m.envelope.ymin,h=e.width/t,v=e.height/i*(g?1:-1),b=g?[e.xmin,e.ymin]:[e.xmin,e.ymax],x=m.useEPSGAxis&&ye(c),I=x?`${b[1]},${b[0]}`:`${b[0]},${b[1]}`,P=this.ioConfig.use2GridOffsets,W=x?P?`${v},${h}`:`${v},0,0,${h}`:P?`${h},${v}`:`${h},0,0,${v}`,M=h/2,q=e.xmin+M,U=e.xmax-M,H=Math.abs(v)/2,N=e.ymin+H,Y=e.ymax-H,Z=x?`${N},${q},${Y},${U},${l}`:`${q},${N},${U},${Y},${l}`,C=n.range.find(R=>R.axis.some(k=>k.identifier.toLowerCase().includes("band")));let _,O=C&&p&&s?f?`${C.identifier}[${C.axis[0].identifier}[${s.join(",")}]]`:`${C.identifier}:${p}[${C.axis[0].identifier}[${s.join(",")}]]`:null;if(o!=null&&o.length)for(let R=0;R<o.length;R++){let k=o[R].values;const j=o[R].dimensionName?.toLowerCase(),J=o[R].variableName?.toLowerCase(),F=n.range.find(G=>G.identifier.toLowerCase()===J);if(k.length>0){if(Array.isArray(k[0])&&(k=k[0]),j==="stdtime")_=k.map(G=>Q(G)).join(",");else if(F){const G=F.axis.find(Se=>Se.identifier.toLowerCase()===j);G&&(O=f?F.identifier+"["+G.identifier+"["+k.join(",")+"]]":F.identifier+":"+p+"["+G.identifier+"["+k.join(",")+"]]")}}R===o.length-1&&F&&!O&&(O=f?F.identifier:F.identifier+":"+p)}return{service:"WCS",request:"GetCoverage",version:this.version,identifier:this.coverageId,format:u,crs:`EPSG:${c}`,boundingbox:Z,gridCS:"urn:ogc:def:cs:OGC:0.0:Grid2dSquareCS",gridType:"urn:ogc:def:method:WCS:1.1:2dGridIn2dCrs",gridOrigin:I,gridOffsets:W,gridBaseCRS:l,timeSequence:_,rangeSubset:O}}_getCoverage201Parameters(e,t,i,r,n,o){const{multidimensionalDefinition:s,interpolation:a}=n,c=this._getInterpolationIndex(a);let l=null;const{supportedInterpolations:u}=this.capabilities;if(u?.length)switch(c){case 0:l=u.find(C=>C.toLowerCase().includes("nearest"));break;case 1:l=u.find(C=>C.toLowerCase().includes("linear"));break;case 2:l=u.find(C=>C.toLowerCase().includes("cubic")||C.toLowerCase().includes("quadratic"))}const d=(this.coverageInfo.supportedFormats||[]).find(C=>C.toLowerCase().includes("tiff"))||"image/tiff",{bandNames:p}=this.coverageInfo,{boundedBy:f,domainSet:m,rangeType:g}=o,h=f.isEastFirst?0:1,v=1-h,{axisLabels:b}=f,x=b[h],I=b[v],P=`http://www.opengis.net/def/crs/EPSG/0/${e.spatialReference.wkid}`,W=P,M=[];M.push(`${x}(${e.xmin},${e.xmax})`),M.push(`${I}(${e.ymin},${e.ymax})`);const q=[];if(b.length>2)for(let C=2;C<b.length;C++){const _=m.origin[C];if(b[C].toLowerCase().includes("time")){let O=_.toString();f.uomLabels?.[C].toLowerCase().includes("ole")&&(q.push(b[C]),O=Q(_,!0)),M.push(b[C]+",http://www.opengis.net("+O+")")}else M.push(b[C]+",http://www.opengis.net("+_+")")}let U=null;if(s!=null&&s.length){const C=[];g.forEach(O=>O.forEach(R=>C.push(R.name)));const _=[];for(let O=0;O<s.length;O++){const R=b.find(j=>j===s[O].dimensionName),k=C.find(j=>j===s[O].variableName);if(_.includes(k)||_.push(k),R){let j=s[O].values;if(j.length>0){Array.isArray(j[0])&&(j=j[0]);let J="";J=R.toLowerCase().includes("time")?j.map(G=>Q(G)).join(","):j.join(",");const F=M.findIndex(G=>G.startsWith(R+",http://www.opengis.net"));F===-1&&M.push(R+",http://www.opengis.net("+J+")"),F===-1||M[F].includes("("+J+")")||M.splice(F,1,R+",http://www.opengis.net("+J+")")}}}_.length&&(U=_.join(","))}else p?.length>=2&&(U=(n.bandIds?n.bandIds.map(C=>p[C]):p).join(","));const H=M.join("&subset="),N=!o.domainSet.hasSameAxisLabelsAsBoundedBy&&this.ioConfig.allowScaleFactor!==!1,Y=N?null:`${x}(${t}),${I}(${i})`,Z=N?1/r:null;return{service:"WCS",request:"GetCoverage",version:this.version,coverageId:this.coverageId,rangesubset:U,interpolation:l,scaleSize:Y,scaleFactor:Z,subset:H,format:d,mediaType:this.ioConfig.allowAnyMediaType?null:"multipart/related",outputcrs:P,subsettingcrs:W}}_constructWCS201Url(e){const t={...this.ioConfig.customFetchParameters,...e},i=[];return Object.keys(t).forEach(r=>{const n=t[r];n!=null&&(r==="subset"?typeof n=="string"&&n.split("&subset=").forEach(o=>{o&&i.push(`subset=${encodeURIComponent(o)}`)}):i.push(`${r}=${encodeURIComponent(n)}`))}),`${encodeURI(this.url)}?${i.join("&")}`}};function Q(e,t=!1){return(t?new Date(ne(e)):new Date(e)).toISOString()}D([T({type:String,json:{write:!0}})],z.prototype,"datasetFormat",void 0),D([T({readOnly:!0})],z.prototype,"tileType",void 0),D([T({type:String,json:{write:!0}})],z.prototype,"version",void 0),D([T({type:String,json:{write:!0}})],z.prototype,"coverageId",void 0),D([T({readOnly:!0})],z.prototype,"rasterId",null),z=D([he("esri.layers.support.rasterDatasets.WCSRaster")],z);const kt=new Set(["milliseconds","seconds","minutes","hours","days","weeks","months","years","decades","centuries"]);let L=class extends je(Ye(_e(Be(Ve(ke(We(Ze(ze($e(Ae(Ne))))))))))){constructor(...e){super(...e),this.coverageId=null,this.version=null,this.isReference=null,this.graphicOrigin=new nt(this),this.legendEnabled=!0,this.noData=0,this.operationalLayerType="WCS",this.type="wcs",this.popupEnabled=!0,this.popupTemplate=null,this.fields=null,this._debouncedSaveOperations=Le(async(t,i,r)=>{const{save:n,saveAs:o}=await De(()=>Te(()=>import("./imageryUtils-Cv1J3BuP-C0eOslJm.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24])),be([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24]));switch(t){case 0:return n(this,i);case 1:return o(this,r,i)}})}normalizeCtorArgs(e,t){return typeof e=="string"?{url:e,...t}:e}load(e){const t=e!=null?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["WCS"]},e).catch(Pe).then(()=>this._openRaster(t))),Promise.resolve(this)}get renderer(){return super.renderer}set renderer(e){super.renderer=e}get coverageInfo(){return this.raster.coverageInfo}get defaultPopupTemplate(){return this.createPopupTemplate()}get rasterFields(){const e=[Je("Pixel Value")],t=this.raster?.rasterInfo??this.serviceRasterInfo,i=t?.multidimensionalInfo;if(i){const r=Ke(i);e.push(...r)}return e}createPopupTemplate(e){return tt({fields:this.rasterFields,title:this.title},e)}async save(e){return this._debouncedSaveOperations(0,e)}async saveAs(e,t){return this._debouncedSaveOperations(1,t,e)}async _openRaster(e){const t=new z({url:this.url,version:this.version,coverageId:this.coverageId,ioConfig:{sampling:"closest",...this.ioConfig,customFetchParameters:this.customParameters}});if(await t.open({signal:e}),!t.rasterInfo)throw t.destroy(),new V("wcs-layer:load","cannot load resources on "+this.url);const{rasterInfo:i}=t;i.noDataValue==null&&(i.noDataValue=this.noData),this._set("serviceRasterInfo",i),this._set("spatialReference",i.spatialReference),this.title==null&&this.setAtOrigin("title",t.datasetName,"service"),this.coverageId==null&&this.setAtOrigin("coverageId",t.coverageInfo.id,"service"),this.version==null&&t.version&&this.setAtOrigin("version",t.version,"service"),this.setAtOrigin("tileInfo",t.rasterInfo.storageInfo.tileInfo,"service");const{multidimensionalInfo:r}=i;if(r!=null){const n=r.variables[0].dimensions.find(({name:o})=>o==="StdTime");if(n){let o=n.extent?.[0]??n.values[0];Array.isArray(o)&&(o=o[0]);let s=n.extent?.[1]??n.values[n.values.length-1];Array.isArray(s)&&(s=s[1]);const a=kt.has(n.intervalUnit?.toLowerCase())?n.intervalUnit?.toLowerCase():null;this.set("timeInfo",{startField:"StdTime",fullTimeExtent:{start:o,end:s},timeZone:null,interval:a?{value:n.interval,unit:a}:null})}}this.raster=t,this._configDefaultSettings(),this.addHandles(Oe(()=>this.customParameters,n=>this.raster.ioConfig.customFetchParameters=n))}};D([T({type:String,nonNullable:!0,json:{name:"wcsInfo.coverageId",write:{isRequired:!0,ignoreOrigin:!0}}})],L.prototype,"coverageId",void 0),D([T()],L.prototype,"coverageInfo",null),D([T({type:["1.0.0","1.1.0","1.1.1","1.1.2","2.0.1"],nonNullable:!0,json:{name:"wcsInfo.version",write:{isRequired:!0,ignoreOrigin:!0}}})],L.prototype,"version",void 0),D([T({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],L.prototype,"isReference",void 0),D([T({json:{read:!0,write:!0}})],L.prototype,"blendMode",void 0),D([T({readOnly:!0,clonable:!1})],L.prototype,"graphicOrigin",void 0),D([T(Ge)],L.prototype,"legendEnabled",void 0),D([T({type:["show","hide"]})],L.prototype,"listMode",void 0),D([T()],L.prototype,"noData",void 0),D([T({type:["WCS"]})],L.prototype,"operationalLayerType",void 0),D([T()],L.prototype,"raster",void 0),D([T({readOnly:!0})],L.prototype,"type",void 0),D([T(Ue)],L.prototype,"popupEnabled",void 0),D([T({type:Re,json:{name:"popupInfo",write:!0}})],L.prototype,"popupTemplate",void 0),D([T({readOnly:!0})],L.prototype,"defaultPopupTemplate",null),D([T({readOnly:!0,type:[ce]})],L.prototype,"fields",void 0),D([T({readOnly:!0,type:[ce]})],L.prototype,"rasterFields",null),L=D([he("esri.layers.WCSLayer")],L);const kn=L;export{kn as default};
