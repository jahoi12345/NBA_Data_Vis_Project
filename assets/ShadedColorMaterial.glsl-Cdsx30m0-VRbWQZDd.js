import{F as Re,J as Te,$ as Ee,l as Ce}from"./projectionUtils-BGH_5_I3-BySNUA-B.js";import{bq as D,J as De,a5 as me,a0 as _e,E as M}from"./ShadowCastClear.glsl-CeOT_rAo-iOFMl8eB.js";import{o as B,k as ge,C as ze,E as K,Y as Ae,z as Fe}from"./mat4-C96X-Nn0-Do6fKsNS.js";import{n as R}from"./mat4f64-q_b6UJoq-Dh6sWB_w.js";import{L as m,V as P,l as G,F as ve,O as z,W as Y,k as I,I as X,y as xe,$ as be}from"./vec32-CewSdTn3-DHOFKD0R.js";import{t as u,e as ye,M as q}from"./collectionUtils-jDyktm0P-ArdXNs6F.js";import{e as N,o as $e}from"./vec4f64-DPb6J-GU-C7c2DqbZ.js";import{o as Me}from"./VisualElement-By4iq8p4-ZBataKFH.js";import{q as ke,_ as We}from"./line-DShd3yGd-Vds7wO8W.js";import{i as Ge,U as Ie,c as Ne,Y as S}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{I as He}from"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import{y as Q}from"./mathUtils-PIGhLnI9-B1tKUlUb.js";import{g as Ve,a as we,w as Be,d as U}from"./screenUtils-BitdhK1O-L0FLPAMi.js";import{E as Z,a as Ke,U as Ye}from"./Polygon-D6wEPb3W-CpL9Efjx.js";import{b as A,a5 as Xe}from"./Point-BfTTZoMu-BAT2Wq6O.js";import{M as qe}from"./computeTranslationToOriginAndRotation-Bjd4esRf-CXUng2L4.js";import{X as Qe}from"./aaBoundingRect-CjwcS2F3-D7aII9DY.js";import{k as Ue,x as J,P as Ze,a as Je}from"./frustum-CMzahy3--CFytpSYl.js";import{X as ee,K as et,P as te}from"./plane-BNdSPG2o-Cq7jmU6w.js";import{x as tt}from"./sphere-DLQ6p7mp-DmnRpHXV.js";import{z as f,C as st}from"./vector-B8ZDYGQ6-B1uNywRb.js";import{x as se,k as it,w as rt,n as ot}from"./RealisticTree.glsl-WN9nrQUl-CRRcYwOn.js";import{a as nt}from"./elevationInfoUtils-B8MpdRMP-CN_w2fPT.js";import{a8 as at,u as ct,o as lt,cx as ie,a2 as ht,Y as ut,w as dt,cK as pt,av as ft,N as mt,B as _t,F as gt,ah as vt,al as bt,bJ as yt,a0 as wt,bI as St,ao as Lt,ay as Ot,bp as Pt,aQ as jt,aR as Rt,aN as Tt,aS as Et,aO as Ct,aT as re,br as Dt,d as zt,j as At,ca as L}from"./Texture-CFNZjV2R-lGBztxVp.js";import{s as Se}from"./colorUtils-CeIi7j7j-nwrKvQYb.js";import{V as Le}from"./ColorMaterial.glsl-rhi0cQVb-BUmbct5I.js";import{L as Ft,i as xt}from"./aaBoundingBox-Cn49X7ge-DORLZxoS.js";import{m as $t,a as Mt}from"./BufferView-Cj2sQaht-DuP-iLZg.js";import{_ as k,l as Oe,A as kt,m as Wt,n as b,y as Gt}from"./Emissions.glsl-B8XKMjLy-DXfiRNVX.js";import{H as It}from"./index-CTl7hdrJ.js";import{p as Nt}from"./InterleavedLayout-B7roQAzV-CC2VYRPC.js";import"./vec2f64-rIxtbMRN-Kai9mK1i.js";function Gs(s,e,t,i=!1){const r=Re(s,e);return r==null?null:(r.hasZ&&!i||t==null||(r.z=D(t,r)??0),r)}function Is(s,e,t){t.warnOnce(`Failed to project analysis geometry (id: '${s.id}'), projection from spatial reference (wkid: '${e.wkid}') to view spatial reference is not supported. Projection may be possible after calling projection.load().`)}let Ht=class extends Me{constructor(s){super(s),this._resources=null,this._transform=R()}get object(){return this._resources!=null?this._resources.object:null}get transform(){return this._transform}set transform(s){ge(this._transform,s),this._resources!=null&&(this._resources.object.transformation=this._transform)}recreate(){this.attached&&this.createResources()}recreateGeometry(){if(this._resources==null)return;const s=this._resources.object;s.removeAllGeometries(),this.createGeometries(s),s.visible=this.visible}createResources(){this.destroyResources();const s=this.view.stage;if(!s)return;const e=new me(s,{pickable:!1,updatePolicy:1}),t=new _e({castShadow:!1});t.transformation=this._transform,this.createExternalResources(),this.createGeometries(t),e.add(t),t.visible=this.visible,this._resources={layer:e,object:t}}destroyResources(){const s=this.view.stage;this._resources!=null&&s&&(this._resources.layer.destroy(),this._resources.object.dispose(),this.destroyExternalResources(),this._resources=null)}updateVisibility(s){this._resources!=null&&(this._resources.object.visible=s)}},Ns=class extends Ht{constructor(s,e){super(s),this._hasExternalMaterial=!1,this._hasExternalMaterial=e!=null,this._material=e??new De({width:1,color:N(1,0,1,1),stipplePreferContinuous:!0,isClosed:!1,falloff:0,innerWidth:1,hasPolygonOffset:!1,renderOccluded:4,isDecoration:!!s.isDecoration,writeDepth:!0},s.view.state.isGlobal),this.applyProperties(s)}setGeometryFromPoint(s,e=1e3){const t=u();this.view.renderCoordsHelper.toRenderCoords(s,t)&&this.setGeometryFromRenderSpacePoint(t,e)}setGeometryFromRenderSpacePoint(s,e=1e3){this.geometry=[[[s[0]-e,s[1],s[2]],[s[0]+e,s[1],s[2]]],[[s[0],s[1]-e,s[2]],[s[0],s[1]+e,s[2]]],[[s[0],s[1],s[2]-e],[s[0],s[1],s[2]+e]]]}setGeometryFromExtent(s){const e=this.view.spatialReference,t=u(),i=u(),r=100,o=[];m(t,s[0],s[1],r),this.view.renderCoordsHelper.toRenderCoords(t,e,i),o.push([i[0],i[1],i[2]]),m(t,s[2],s[1],r),this.view.renderCoordsHelper.toRenderCoords(t,e,i),o.push([i[0],i[1],i[2]]),m(t,s[2],s[3],r),this.view.renderCoordsHelper.toRenderCoords(t,e,i),o.push([i[0],i[1],i[2]]),m(t,s[0],s[3],r),this.view.renderCoordsHelper.toRenderCoords(t,e,i),o.push([i[0],i[1],i[2]]),m(t,s[0],s[1],r),this.view.renderCoordsHelper.toRenderCoords(t,e,i),o.push([i[0],i[1],i[2]]),m(t,s[0],s[1],r),this.view.renderCoordsHelper.toRenderCoords(t,e,i),o.push([i[0],i[1],i[2]]),this.geometry=[o]}setGeometryFromFrustum(s){const e=[];s.lines.forEach(t=>{e.push([t.origin[0],t.origin[1],t.origin[2]]),e.push([t.endpoint[0],t.endpoint[1],t.endpoint[2]])}),this.geometry=[e]}setGeometryFromBoundedPlane(s){const e=[],t=s.origin,i=s.basis1,r=s.basis2,o=.5,n=u(),a=u(),c=u(),l=u();n[0]=t[0]-i[0]*o-r[0]*o,n[1]=t[1]-i[1]*o-r[1]*o,n[2]=t[2]-i[2]*o-r[2]*o,a[0]=t[0]-i[0]*o+r[0]*o,a[1]=t[1]-i[1]*o+r[1]*o,a[2]=t[2]-i[2]*o+r[2]*o,c[0]=t[0]+i[0]*o+r[0]*o,c[1]=t[1]+i[1]*o+r[1]*o,c[2]=t[2]+i[2]*o+r[2]*o,l[0]=t[0]+i[0]*o-r[0]*o,l[1]=t[1]+i[1]*o-r[1]*o,l[2]=t[2]+i[2]*o-r[2]*o,e.push([n[0],n[1],n[2]]),e.push([a[0],a[1],a[2]]),e.push([c[0],c[1],c[2]]),e.push([l[0],l[1],l[2]]),e.push([n[0],n[1],n[2]]),this.geometry=[e]}setGeometryFromSegment(s){const e=s.endRenderSpace;this.transform=B(oe,e);const{points:t}=s.createRenderGeometry(e,this.view.renderCoordsHelper);this.geometry=[t]}setGeometryFromSegments(s,e=ye){this.transform=B(oe,e),this.geometry=s.map(t=>t.createRenderGeometry(e,this.view.renderCoordsHelper).points)}getTransformedGeometry(){return this._geometry==null?null:this._geometry.map(s=>s.map(e=>P(u(),e,this.transform)))}get renderOccluded(){return this._material.parameters.renderOccluded}set renderOccluded(s){this._material.setParameters({renderOccluded:s})}get geometry(){return this._geometry}set geometry(s){this._geometry=s,this.recreateGeometry()}get width(){return this._material.parameters.width}set width(s){this._material.setParameters({width:s})}get color(){return this._material.parameters.color}set color(s){const e=s[3]===1;this._material.setParameters({color:s,writeDepth:e})}get innerWidth(){return this._material.parameters.innerWidth}set innerWidth(s){this._material.setParameters({innerWidth:s})}get innerColor(){return this._material.parameters.innerColor}set innerColor(s){this._material.setParameters({innerColor:s})}get stipplePattern(){return this._material.parameters.stipplePattern}set stipplePattern(s){this._material!=null&&this._material.setParameters({stipplePattern:s})}get stippleOffColor(){return this._material.parameters.stippleOffColor}set stippleOffColor(s){this._material.setParameters({stippleOffColor:s})}get stipplePreferContinuous(){return this._material.parameters.stipplePreferContinuous}set stipplePreferContinuous(s){this._material.setParameters({stipplePreferContinuous:s})}get falloff(){return this._material.parameters.falloff}set falloff(s){this._material.setParameters({falloff:s})}get polygonOffset(){return this._material.parameters.hasPolygonOffset}set polygonOffset(s){this._material.setParameters({hasPolygonOffset:s})}createExternalResources(){}destroyExternalResources(){}createGeometries(s){for(const e of ke(this.geometry)){const t=We(this._material,e);s.addGeometry(t)}}forEachMaterial(s){this._hasExternalMaterial||s(this._material)}};const oe=R();class Hs{constructor(e){this.metadata=void 0,this._camera=new at,this._elevation={offset:0,override:null},this.collisionType={type:"point"},this.collisionPriority=0,this._renderObjects=new Array,this.autoScaleRenderObjects=!0,this._available=!0,this._noDisplayCount=0,this._radius=10,this._worldSized=!1,this.focusMultiplier=2,this.touchMultiplier=2.5,this.worldOriented=!1,this._modelTransform=R(),this._worldFrame=null,this._renderLocation=u(),this._renderLocationDirty=!0,this._location=new A({x:0,y:0,z:0}),this._elevationAlignedLocation=new A,this._elevationAlignedLocationDirty=!0,this.interactive=!0,this.selectable=!1,this.grabbable=!0,this.consumesClicks=!0,this.cursor=null,this.grabCursor=null,this._grabbing=!1,this.dragging=!1,this._hovering=!1,this._selected=!1,this._state=0,this._focused=!1,this.events=new He,this._screenLocation={screenPointArray:we(),renderScreenPointArray:Ve(),pixelSize:0},this._screenLocationDirty=!0,this._engineResourcesAddedToStage=!1,this._attached=!1,this._location.spatialReference=e.view.spatialReference,Object.assign(this,e);const t=this.view.state?.camera;t&&this._camera.copyFrom(t)}destroy(){this._applyObjectTransform=Xt,this._removeResourcesFromStage(),this._engineResources=null,this.view=null,this._camera=null}get _stage(){return this.view?.stage}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this._elevationAlignedLocationDirty=!0,this._renderLocationDirty=!0,this._updateEngineObject()}get renderObjects(){return this._renderObjects}set renderObjects(e){this._removeResourcesFromStage(),this._engineResources=null,this._renderObjects=e.slice(),this._updateEngineObject()}set available(e){e!==this._available&&(this._available=e,this._updateEngineObject())}get available(){return this._available}disableDisplay(){return this._noDisplayCount++,this._noDisplayCount===1&&this._updateEngineObject(),Ge(()=>{this._noDisplayCount--,this._noDisplayCount===0&&this._updateEngineObject()})}set radius(e){e!==this._radius&&(this._radius=e,this._updateEngineObject())}get radius(){return this._radius}set worldSized(e){e!==this._worldSized&&(this._worldSized=e,this._updateEngineObject())}get worldSized(){return this._worldSized}get modelTransform(){return this._modelTransform}set modelTransform(e){ne(e)&&(this._screenLocationDirty=!0),ge(this._modelTransform,e),this._updateEngineObject()}get renderLocation(){return this._renderLocationDirty&&(this._renderLocationDirty=!1,this.view.renderCoordsHelper.toRenderCoords(this.elevationAlignedLocation,this._renderLocation),this.worldOriented?(this._worldFrame||(this._worldFrame=R()),Vt(this.view,this._renderLocation,this._worldFrame)):this._worldFrame&&(this._worldFrame=null)),this._renderLocation}set renderLocation(e){this.view.renderCoordsHelper.fromRenderCoords(e,this._location),this.elevationAlignedLocation=this._location}get location(){return this._location}set location(e){se(e,this._location),this._notifyLocationChanged()}_notifyLocationChanged(){this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!0,this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}get elevationAlignedLocation(){return this._elevationAlignedLocationDirty?(this._evaluateElevationAlignment(),this._updateElevationAlignedLocation(),this._elevationAlignedLocation):this._elevationAlignedLocation}set elevationAlignedLocation(e){se(e,this._location),this._evaluateElevationAlignment(),this._location.z-=this._elevation.offset,this._updateElevationAlignedLocation(),this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}_updateElevationAlignedLocation(){const e=this._elevation.override!=null?this._elevation.override:this.location.z||0;this._elevationAlignedLocation.x=this.location.x,this._elevationAlignedLocation.y=this.location.y,this._elevationAlignedLocation.z=e+this._elevation.offset,this._elevationAlignedLocation.spatialReference=it(this.location.spatialReference),this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!1}grabbableForEvent(){return!0}get grabbing(){return this._grabbing}set grabbing(e){e!==this._grabbing&&(this._grabbing=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}get hovering(){return this._hovering}set hovering(e){e!==this._hovering&&(this._hovering=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}get selected(){return this._selected}set selected(e){e!==this._selected&&(this._selected=e,this._updateEngineObject(),this.events.emit("select-changed",{action:e?"select":"deselect"}))}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._updateEngineObject())}updateStateEnabled(e,t){t?this.state|=e:this.state&=~e}_setFocused(e){e!==this._focused&&(this._focused=e,this.events.emit("focus-changed",{action:e===!0?"focus":"unfocus"}))}get focused(){return this._focused}get screenLocation(){return this._ensureScreenLocation(),this._screenLocation}_ensureScreenLocation(){if(!this._screenLocationDirty)return;this._screenLocation.pixelSize=this._camera.computeScreenPixelSizeAt(this.renderLocation),this._screenLocationDirty=!1;let e;if(ne(this._modelTransform)){const t=this._calculateModelTransformOffset(Yt);e=z(t,t,this.renderLocation)}else e=this.renderLocation;this._camera.projectToRenderScreen(e,this._screenLocation.renderScreenPointArray),this._camera.renderToScreen(this._screenLocation.renderScreenPointArray,this._screenLocation.screenPointArray)}get applyObjectTransform(){return this._applyObjectTransform}set applyObjectTransform(e){this._applyObjectTransform=e,this._screenLocationDirty=!0,this._updateEngineObject()}get attached(){return this._attached}intersectionDistance(e,t){if(!this.available)return null;const i=Be(e,Bt),r=this._getCollisionRadius(t),o=-1*this.collisionPriority;switch(this.collisionType.type){case"point":if(Ye(this.screenLocation.screenPointArray,i)<r*r)return this.screenLocation.renderScreenPointArray[2]+o;break;case"line":{const n=this.collisionType.paths,a=this._getWorldToScreenObjectScale(),c=this._calculateObjectTransform(a,E),l=r*this.screenLocation.pixelSize,h=M(this._camera,i,W);if(h==null)return null;for(const d of n){if(d.length===0)continue;const p=P(T,d[0],c);for(let w=1;w<d.length;w++){const _=P(le,d[w],c),g=Je(J(p,_,ae),h);if(g!=null&&g<l*l){const v=z(f.get(),p,_);I(v,v,.5);const j=U(f.get());if(this._camera.projectToRenderScreen(v,j))return j[2]+o}X(p,_)}}break}case"disc":{const n=this.collisionType.direction,a=this.collisionType.offset??ye,c=this._getWorldToScreenObjectScale(),l=this._calculateObjectTransform(c,E),h=r*this.screenLocation.pixelSize,d=M(this._camera,i,W);if(d==null)return null;const p=Z(ce,l),w=Y(ue,n,p),_=P(de,a,l);ee(_,w,C);const g=he;if(te(C,d,g)&&xe(g,_)<h*h)return this.screenLocation.renderScreenPointArray[2]+o;break}case"ribbon":{const{paths:n,direction:a}=this.collisionType,c=this._getWorldToScreenObjectScale(),l=this._calculateObjectTransform(c,E),h=r*this._camera.computeScreenPixelSizeAt(this.renderLocation),d=M(this._camera,i,W);if(d==null)return null;const p=Z(ce,l),w=Y(ue,a,p),_=this._calculateModelTransformPosition(de);ee(_,w,C);const g=he;if(!te(C,d,g))break;for(const v of n){if(v.length===0)continue;const j=P(T,v[0],l);for(let F=1;F<v.length;F++){const x=P(le,v[F],l),H=Ue(J(j,x,ae),g);if(H!=null&&H<h*h){const $=z(f.get(),j,x);I($,$,.5);const V=U(f.get());if(this._camera.projectToRenderScreen($,V))return V[2]+o}X(j,x)}}break}default:Ie(this.collisionType)}return null}attach(e={manipulator3D:{}}){const t=this._stage;if(!t)return;const i=e.manipulator3D;i.engineLayerId==null?(this._engineLayer=new me(t,{pickable:!1,updatePolicy:1}),i.engineLayerId=this._engineLayer.id):t?.getLayer&&(this._engineLayer=t.getLayer(i.engineLayerId)),i.engineLayerReferences=(i.engineLayerReferences||0)+1,this._camera.copyFrom(this.view.state.camera),this._attached=!0,this._updateEngineObject(),Te(this._location.spatialReference,this.view.spatialReference)||(this.location=new A({x:0,y:0,z:0,spatialReference:this.view.spatialReference}))}detach(e={manipulator3D:{}}){const t=e.manipulator3D;t.engineLayerReferences--;const i=t.engineLayerReferences===0;this._removeResourcesFromStage(),i&&(t.engineLayerId=null,Ne(this._engineLayer)),this._engineResources=null,this._engineLayer=null,this._attached=!1}onViewChange(){this._camera.copyFrom(this.view.state.camera),this._screenLocationDirty=!0,this._updateEngineObject()}onElevationChange(e){Ee(this.location,pe,e.spatialReference)&&Qe(e.extent,pe)&&this._notifyLocationChanged()}_evaluateElevationAlignment(){if(this.elevationInfo==null)return;let e=null,t=0;const i=nt(this.elevationInfo,this.location.spatialReference??this.view.elevationProvider.spatialReference);switch(this.elevationInfo.mode){case"on-the-ground":e=D(this.view.elevationProvider,this.location,"ground")??0;break;case"relative-to-ground":t=(D(this.view.elevationProvider,this.location,"ground")??0)+i;break;case"relative-to-scene":t=(D(this.view.elevationProvider,this.location,"scene")??0)+i;break;case"absolute-height":t=i}return t!==this._elevation.offset||e!==this._elevation.override?(this._elevation.offset=t,void(this._elevation.override=e)):void 0}_updateEngineObject(){if(!this._attached)return;if(!this.available)return void this._removeResourcesFromStage();const e=this._getWorldToScreenObjectScale(),t=E;if(this.autoScaleRenderObjects===!0){const n=this._getFocusedSize(this._radius,this.focused)*e;this._calculateObjectTransform(n,t)}else this._calculateObjectTransform(e,t);const{objectsByState:i}=this._ensureEngineResources(),r=(this.focused?2:1)|(this.selected?8:4),o=this._noDisplayCount>0;for(const{stateMask:n,objects:a}of i){if(o){for(const h of a)h.visible=!1;continue}const c=!(15&n)||(r&n)===(15&n),l=!(65520&n)||(this.state&n)===(65520&n);if(c&&l)for(const h of a)h.visible=!0,h.transformation=t;else for(const h of a)h.visible=!1}}_ensureEngineResources(){if(this._engineResources==null){const e=this._engineLayer,t=[],i=new Set;this.renderObjects.forEach(({geometry:{material:n}})=>{i.has(n)||(t.push(n),i.add(n))});const r=new Map;this._renderObjects.forEach(n=>{const a=new _e({castShadow:!1,geometries:[n.geometry]}),c=r.get(n.stateMask)||[];c.push(a),r.set(n.stateMask,c)});const o=[];r.forEach((n,a)=>o.push({stateMask:a,objects:n})),this._engineResources={objectsByState:o,layer:e,materials:t}}return this._addResourcesToStage(),this._engineResources}_addResourcesToStage(){const e=this._stage;if(this._engineResourcesAddedToStage||this._engineResources==null||!e)return;const{objectsByState:t,layer:i}=this._engineResources;t.forEach(({objects:r})=>i.addMany(r)),this._engineResourcesAddedToStage=!0}_removeResourcesFromStage(){const e=this._stage;if(!this._engineResourcesAddedToStage||this._engineResources==null||!e)return;const{objectsByState:t,layer:i}=this._engineResources;t.forEach(({objects:r})=>i.removeMany(r)),this._engineResourcesAddedToStage=!1}_getCollisionRadius(e){return this._getFocusedSize(this.radius,!0)*(e==="touch"?this.touchMultiplier:1)}_getFocusedSize(e,t){return e*(t?this.focusMultiplier:1)}_getWorldToScreenObjectScale(){return this._worldSized?1:this.screenLocation.pixelSize}_calculateModelTransformPosition(e){const t=this._getWorldToScreenObjectScale(),i=this._calculateObjectTransform(t,Kt);return m(e,i[12],i[13],i[14])}_calculateModelTransformOffset(e){const t=this._calculateModelTransformPosition(e);return be(e,t,this.renderLocation)}_calculateObjectTransform(e,t){return ze(t,e,0,0,0,0,e,0,0,0,0,e,0,0,0,0,1),this._worldFrame&&K(t,t,this._worldFrame),K(t,t,this._modelTransform),t[12]+=this.renderLocation[0],t[13]+=this.renderLocation[1],t[14]+=this.renderLocation[2],t[15]=1,this._applyObjectTransform!=null&&this._applyObjectTransform(t),t}get test(){}}function ne(s){return s[12]!==0||s[13]!==0||s[14]!==0}function Vt(s,e,t){switch(s.viewingMode){case"local":return Ae(t),!0;case"global":{const i=Xe(s.renderCoordsHelper.spatialReference);return Ce(e,0,T,0,i.radius),qe(Q(T[0]),Q(T[1]),t),!0}}}const Bt=we(),ae=Ze(),W=tt(),ce=Ke(),Kt=R(),E=R(),C=et(),T=u(),le=u(),he=u(),ue=u(),de=u(),Yt=u(),pe=new A({x:0,y:0,z:0,spatialReference:null}),Xt=()=>{};function qt(s){return s?.operations?.data.geometry}function Qt(s,e){if(!e.screenSizeEnabled)return;const t=s.vertex;zt(t,e),t.uniforms.add(new At("perScreenPixelRatio",i=>i.camera.perScreenPixelRatio),new Gt("screenSizeScale",i=>i.screenSizeScale)).code.add(b`float computeRenderPixelSizeAt( vec3 pWorld ){
vec3 viewForward = - vec3(view[0][2], view[1][2], view[2][2]);
float viewDirectionDistance = abs(dot(viewForward, pWorld - cameraPosition));
return viewDirectionDistance * perScreenPixelRatio;
}
vec3 screenSizeScaling(vec3 position, vec3 anchor){
return position * screenSizeScale * computeRenderPixelSizeAt(anchor) + anchor;
}`)}function Pe(s){const e=new Ot;e.include(Pt),e.include(Qt,s),e.fragment.include(jt,s),e.include(Rt,s),e.include(Tt,s);const{vertex:t,fragment:i}=e;return i.include(Et),Ct(t,s),i.uniforms.add(new re("uColor",r=>r.color)),e.attributes.add("position","vec3"),e.varyings.add("vWorldPosition","vec3"),s.screenSizeEnabled&&e.attributes.add("offset","vec3"),s.shadingEnabled&&(Dt(t),e.attributes.add("normal","vec3"),e.varyings.add("vViewNormal","vec3"),i.uniforms.add(new kt("shadingDirection",r=>r.shadingDirection)),i.uniforms.add(new re("shadedColor",r=>Ut(r.shadingTint,r.color)))),t.main.add(b`
    vWorldPosition = ${s.screenSizeEnabled?b`screenSizeScaling(offset, position)`:b`position`};
    ${Wt(s.shadingEnabled,b`vec3 worldNormal = normal;
           vViewNormal = (viewNormal * vec4(worldNormal, 1)).xyz;`)}
    forwardViewPosDepth((view * vec4(vWorldPosition, 1.0)).xyz);
    gl_Position = transformPosition(proj, view, vWorldPosition);
  `),i.main.add(b`
      discardBySlice(vWorldPosition);
      discardByTerrainDepth();
      ${s.shadingEnabled?b`vec3 viewNormalNorm = normalize(vViewNormal);
             float shadingFactor = 1.0 - clamp(-dot(viewNormalNorm, shadingDirection), 0.0, 1.0);
             vec4 finalColor = mix(uColor, shadedColor, shadingFactor);`:b`vec4 finalColor = uColor;`}
      outputColorHighlightOID(finalColor, vWorldPosition, finalColor.rgb);`),e}function Ut(s,e){const t=1-s[3],i=s[3]+e[3]*t;return i===0?(O[3]=i,O):(O[0]=(s[0]*s[3]+e[0]*e[3]*t)/i,O[1]=(s[1]*s[3]+e[1]*e[3]*t)/i,O[2]=(s[2]*s[3]+e[2]*e[3]*t)/i,O[3]=e[3],O)}const O=$e(),Zt=Object.freeze(Object.defineProperty({__proto__:null,build:Pe},Symbol.toStringTag,{value:"Module"}));class Jt extends mt{constructor(e,t){super(e,t,new _t(Zt,()=>It(()=>Promise.resolve().then(()=>as),void 0)),je(t).locations)}initializePipeline(e){const{oitPass:t,output:i,transparent:r,cullFace:o,shadingEnabled:n}=e,a=t===0,c=t===2;return gt({blending:Oe(i)&&r?Lt(t):null,culling:St(o),depthTest:{func:c?513:n?515:513},depthWrite:wt(e),drawBuffers:yt(t,i),colorWrite:bt,polygonOffset:a||c?null:vt})}}function je(s){const e=Nt().vec3f("position").vec3f("normal");return s.screenSizeEnabled&&e.vec3f("offset"),e}class y extends ut{constructor(){super(...arguments),this.cullFace=0,this.transparent=!1,this.writeDepth=!0,this.screenSizeEnabled=!0,this.shadingEnabled=!0,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.textureCoordinateType=0,this.emissionSource=0,this.occlusionPass=!1,this.olidColorInstanced=!1,this.draped=!1,this.overlayEnabled=!1,this.snowCover=!1}get discardInvisibleFragments(){return this.transparent}}S([L({count:3})],y.prototype,"cullFace",void 0),S([L()],y.prototype,"transparent",void 0),S([L()],y.prototype,"writeDepth",void 0),S([L()],y.prototype,"screenSizeEnabled",void 0),S([L()],y.prototype,"shadingEnabled",void 0),S([L()],y.prototype,"terrainDepthTest",void 0),S([L()],y.prototype,"cullAboveTerrain",void 0);class es extends ct{constructor(e){super(e,ss),this._configuration=new y,this.supportsEdges=!0,this._pp0=q(0,0,1),this._pp1=q(0,0,0),this.produces=new Map([[2,t=>t===9||k(t)&&!this.parameters.transparent],[4,t=>k(t)&&this.parameters.transparent&&this.parameters.writeDepth],[8,t=>k(t)&&this.parameters.transparent&&!this.parameters.writeDepth]])}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.screenSizeEnabled=this.parameters.screenSizeEnabled,this._configuration.shadingEnabled=this.parameters.shadingEnabled,this._configuration.oitPass=t.oitPass,this._configuration.terrainDepthTest=t.terrainDepthTest&&Oe(e),this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration}get visible(){return this.parameters.color[3]>=lt}intersect(e,t,i,r,o,n){this._intersect(e,i,r,o,n)}intersectDraped(e,t,i,r){return this._pp0[0]=this._pp1[0]=i[0],this._pp0[1]=this._pp1[1]=i[1],this._intersect(e,t,this._pp0,this._pp1,r)}_intersect(e,t,i,r,o){if(this.parameters.screenSizeEnabled){const n=e.attributes.get("offset");ie(e,t,i,r,{applyToVertex:(a,c,l,h)=>{const d=m(fe,n.data[3*h],n.data[3*h+1],n.data[3*h+2]),p=m(rs,a,c,l);return I(d,d,this.parameters.screenSizeScale*(t.camera?.computeScreenPixelSizeAt(d)??1)),z(p,p,d),[p[0],p[1],p[2]]},applyToAabb:a=>{const c=Ft(a,fe);return xt(a,this.parameters.screenSizeScale*(t.camera?.computeScreenPixelSizeAt(c)??1))}},o)}else ie(e,t,i,r,void 0,o)}createGLMaterial(e){return new ts(e)}createBufferWriter(){return new is(je(this.parameters))}}class ts extends dt{beginSlot(e){return this.getTechnique(Jt,e)}}let ss=class extends ht{constructor(){super(...arguments),this.color=N(1,1,1,1),this.shadingTint=N(0,0,0,.25),this.shadingDirection=G(u(),[.5,-.5,-.5]),this.screenSizeScale=14,this.forceTransparentMode=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.cullFace=0,this.screenSizeEnabled=!1,this.shadingEnabled=!0}get transparent(){return this.color[3]<1||this.forceTransparentMode}};class is{constructor(e){this.layout=e}elementCount(e){return e.get("position").indices.length}write(e,t,i,r,o,n){const a=pt(i,r,this.layout,e,t,o,n),c=o.getField("offset",$t);if(c&&i.has("offset")){const l=i.get("offset");Mt(l.size===3),ft(l,t,c,n)}return a}}const fe=u(),rs=u();function Vs(s,e=4,t=!0){const i=Se(s),r=!(s[3]<1);return t?new es({color:i,writeDepth:r,cullFace:2,renderOccluded:e,isDecoration:!0}):new Le({color:i,writeDepth:r,cullFace:2,renderOccluded:e,isDecoration:!0})}function Bs(s,e=4){const t=Se(s);return new Le({color:t,writeDepth:!0,cullFace:1,renderOccluded:e,isDecoration:!0})}const Ks=Object.freeze({calloutLength:40,calloutWidth:1,discRadius:27,focusMultiplier:1.1}),Ys=Object.freeze({autoScaleRenderObjects:!1,worldSized:!0});function Xs(s,e,t,i){const r=be(f.get(),s,t),o=os(r,ve(f.get(),i,r),t,st.get());Fe(o,o);const n=P(f.get(),e,o);return Math.atan2(n[1],n[0])}function os(s,e,t,i){const r=G(f.get(),s),o=G(f.get(),e),n=ve(f.get(),r,o);return i[0]=r[0],i[1]=r[1],i[2]=r[2],i[3]=0,i[4]=o[0],i[5]=o[1],i[6]=o[2],i[7]=0,i[8]=n[0],i[9]=n[1],i[10]=n[2],i[11]=0,i[12]=t[0],i[13]=t[1],i[14]=t[2],i[15]=1,i}function qs(s,e){const t=s.getViewForGraphic(e);return t!=null&&"computeAttachmentOrigin"in t?t.computeAttachmentOrigin(e,s.spatialReference):null}function Qs(s,e){const t=e.origin;t==null?ns(s,qt(e)):s.elevationAlignedLocation=t}function ns(s,e){if(e==null)return;const t=e.type==="mesh"?e.origin:rt(e);t!=null&&(s.location=ot(t))}class Us{constructor(e,t=0){this.geometry=e,this.stateMask=t}}const as=Object.freeze(Object.defineProperty({__proto__:null,build:Pe},Symbol.toStringTag,{value:"Module"}));export{Hs as B,Gs as G,Is as I,Xs as K,Ns as N,qs as Q,Ks as U,Qs as X,Ys as Y,Bs as Z,Ht as a,es as b,qt as c,Us as e,os as o,Vs as q};
