import{ar as G,Y as r,H as s,G as A,K}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{t as L}from"./Viewshed-DfPsAopA-B3KuvnAd.js";import{a as N}from"./Analysis-C-jU7dDl-CpOyKr7-.js";import{R as j,C as P,w as Y}from"./collectionUtils-jDyktm0P-BDP2Oq99.js";import{M as b}from"./Cyclical-BLSxUpe7-Bj8R2Yk-.js";import{y as z,s as C}from"./mathUtils-PIGhLnI9-B1tKUlUb.js";import{j as q,l as H}from"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import{z as k}from"./Extent-CgDMOSRD-Bod5LY6s.js";import{Y as D}from"./projectionUtils-BGH_5_I3-DGwchVO8.js";import{k as J}from"./MultiOriginJSONSupport-Bd1TKmh_-BHNF5tHX.js";import{o as S}from"./Layer-DZvC7bne-D3VLDrab.js";import{C as U}from"./OperationalLayer-B6zbJ5nR-DyK_ztCk.js";import"./featureReferenceUtils-CSsVlhur-Bq31yTLX.js";import"./vec32-CewSdTn3-VRto2OOh.js";import"./Polygon-D6wEPb3W-D2MPjRU4.js";import"./Point-BfTTZoMu-DeJwQYfh.js";import"./index-B0z_nLWi.js";import"./sphere-DLQ6p7mp-DyEe1Vll.js";import"./mat4-C96X-Nn0-BrMLOLCb.js";import"./vec4f64-DPb6J-GU-C7c2DqbZ.js";import"./vector-B8ZDYGQ6-DRILJdcx.js";import"./mat4f64-q_b6UJoq-Dh6sWB_w.js";import"./quatf64-CCm9z-pX-CQ7_sSji.js";import"./vec2f64-rIxtbMRN-Kai9mK1i.js";import"./aaBoundingBox-Cn49X7ge-BcYPaJ58.js";import"./vec42-B8VM4vXb-B6OGOEI9.js";import"./Polyline-CoiTLswR-DTxpB2Yg.js";import"./date-IqUzANpt-bLKO9IDT.js";import"./ElevationInfo-Cw2HaA6E-CuK5hJ96.js";import"./lengthUtils-Dt1_RvOO-j3MEdmHu.js";import"./unitConversionUtils-4vB4Ezlp-DnY5MDxd.js";import"./reader-DcGs6kKN-DHJfK-tm.js";import"./SimpleObservable-CvFyr0NA-DXpoMYph.js";import"./aaBoundingRect-CjwcS2F3-ri8bmh30.js";import"./layerContainerType-CSXZNpHb-BIF7XAYP.js";import"./opacityUtils-DuFH0EC9-DWspTgn2.js";import"./intersectorUtilsConversions-pLQPEbcN-Ck-nyNYa.js";import"./HUDIntersectorResult-1xTExS7z-dL9SFL6u.js";import"./Intersector-DS9YtyQY-DMoYp6i0.js";import"./DoubleArray-DExKNiTh-CvVpHySW.js";const V=j.ofType(L);let n=class extends N{constructor(e){super(e),this.type="viewshed",this._extent=null}initialize(){this.addHandles(q(()=>this._computeExtent(),e=>{e.pending==null&&(this._extent=e.extent)},H))}get viewsheds(){return this._get("viewsheds")||new V}set viewsheds(e){this._set("viewsheds",P(e,this.viewsheds,V))}get spatialReference(){for(const e of this.viewsheds)if(e.observer!=null)return e.observer.spatialReference;return null}get extent(){return this._extent}get valid(){return this.viewsheds.every(e=>e.valid)}async waitComputeExtent(){const e=this._computeExtent();e.pending!=null&&await e.pending}_computeExtent(){const{spatialReference:e}=this;if(e==null)return{pending:null,extent:null};const t=this.viewsheds.filter(i=>i.observer!=null),p=t.map(i=>i.observer).toArray(),a=D(p,e);return a.pending!=null?{pending:a.pending,extent:null}:{pending:null,extent:a.geometries.map((i,u)=>{const v=t.at(u);return i!=null&&v!=null?this._computeViewshedExtent(this.viewsheds.at(u),i):null}).filter(i=>i!=null).reduce((i,u)=>X(i,u),null)}}_computeViewshedExtent(e,t){const{farDistance:p,heading:a,tilt:i,horizontalFieldOfView:u,verticalFieldOfView:v}=e,{spatialReference:E}=t,x=u/2,g=v/2,O=p/E.metersPerUnit,T=[b.normalize(a-x),a,b.normalize(a+x)],h=k.fromPoint(t),w=y=>{const m=T.map(l=>b.normalize(l-y));if(m[0]>m[2]||u===360)return O;const d=m.map(l=>Math.abs(l>180?360-l:l)).reduce((l,f)=>l>f?f:l);return d>90?0:O*Math.cos(z(d))};h.xmax+=w(90),h.xmin-=w(-90),h.ymax+=w(0),h.ymin-=w(180);const c=t.z;if(c!=null){let y=c,m=c;const d=i-90,l=C(d+g,-90,90),f=C(d-g,-90,90),_=E?.isGeographic?p:O;y+=_*R(l),m+=_*R(f);const F=$(g)*_,M=R(d)*F*(1-$(x));i<90&&(y-=M),i>90&&(m-=M),h.zmax=Math.max(y,c),h.zmin=Math.min(m,c)}return h}equals(e){return this===e||super.equals(e)&&G(this.viewsheds.toArray(),e.viewsheds.toArray(),(t,p)=>t.equals(p))}clear(){this.viewsheds.removeAll()}};function X(e,t){return e==null?t:t==null?e:e.union(t)}function $(e){return Math.cos(z(e))}function R(e){return Math.sin(z(e))}r([s({type:["viewshed"]})],n.prototype,"type",void 0),r([s({cast:Y,type:V,nonNullable:!0})],n.prototype,"viewsheds",null),r([s({readOnly:!0})],n.prototype,"spatialReference",null),r([s()],n.prototype,"_extent",void 0),r([s()],n.prototype,"extent",null),r([s({readOnly:!0})],n.prototype,"valid",null),n=r([A("esri.analysis.ViewshedAnalysis")],n);let o=class extends U(J(S)){constructor(e){super(e),this.type="viewshed",this.operationalLayerType="ViewshedLayer",this.source=new n,this.opacity=1}initialize(){this.addHandles(q(()=>this.source,(e,t)=>{t!=null&&t.parent===this&&(t.parent=null),e!=null&&(e.parent=this)},H))}async load(){return this.addResolvingPromise(this.source.waitComputeExtent()),this}get spatialReference(){return this.source.spatialReference}get fullExtent(){return this.source.extent}releaseAnalysis(e){this.source===e&&(this.source=new n)}get analysis(){return this.source}set analysis(e){this.source=e}get viewsheds(){return this.source.viewsheds}set viewsheds(e){this.source.viewsheds=e}writeViewsheds(e,t,p,a){t.viewsheds=e.filter(i=>i.valid).toJSON(a)}};r([s({json:{read:!1},readOnly:!0})],o.prototype,"type",void 0),r([s({type:["ViewshedLayer"]})],o.prototype,"operationalLayerType",void 0),r([s({type:n,nonNullable:!0})],o.prototype,"source",void 0),r([s({readOnly:!0})],o.prototype,"spatialReference",null),r([s({readOnly:!0})],o.prototype,"fullExtent",null),r([s({readOnly:!0,json:{read:!1,write:!1,origins:{service:{read:!1,write:!1},"portal-item":{read:!1,write:!1},"web-document":{read:!1,write:!1}}}})],o.prototype,"opacity",void 0),r([s({type:["show","hide"]})],o.prototype,"listMode",void 0),r([s({type:j.ofType(L),json:{write:{ignoreOrigin:!0},origins:{"web-scene":{write:{ignoreOrigin:!0}}}}})],o.prototype,"viewsheds",null),r([K("web-scene","viewsheds")],o.prototype,"writeViewsheds",null),o=r([A("esri.layers.ViewshedLayer")],o);const He=o;export{He as default};
