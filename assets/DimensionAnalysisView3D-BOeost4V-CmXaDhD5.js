import{v as Xt,M as X,x as Oe,c as Pt,q as Q,b as Qt,c6 as gt,L as De,Y as d,H as u,G as U,a as Ht,aq as Te,$ as xe,i as Re,s as Ae,ag as He}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{f as ut,J as B,s as te,a_ as ze,a$ as ke,ax as zt,aZ as $e,aY as Ge}from"./ShadowCastClear.glsl-CeOT_rAo-iOFMl8eB.js";import{s as Le}from"./AnalysisView3D-zhHEgrUR-DZ8OICjY.js";import{j as v,l as D,W as Ee,s as at,i as vt,o as Z}from"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import{af as Ve,bp as Ie,bq as Ue,b as G}from"./Point-BfTTZoMu-BAT2Wq6O.js";import{s as Be}from"./getDefaultUnitForView-BIGim07z-C-_fairS.js";import{y as kt,B as Fe}from"./mathUtils-PIGhLnI9-B1tKUlUb.js";import{o as je,h as $t,Y as Ne,U as ee}from"./mat4-C96X-Nn0-Do6fKsNS.js";import{n as bt}from"./mat4f64-q_b6UJoq-Dh6sWB_w.js";import{I as O,z as _t,w as st,V as Gt,h as A,F as E,A as z,l as qe,t as ie,k as tt,c as ne,x as ae,L as se,$ as oe,m as Lt}from"./vec32-CewSdTn3-DHOFKD0R.js";import{t as P,e as F,M as ot}from"./collectionUtils-jDyktm0P-ArdXNs6F.js";import{z as f}from"./vector-B8ZDYGQ6-B1uNywRb.js";import{h as Ye}from"./projectVectorToVector-Csv3NYZI-BsIKHfQD.js";import{x as q,l as Ze,M as J}from"./RealisticTree.glsl-WN9nrQUl-CRRcYwOn.js";import{E as V,$ as Je}from"./Segment-DyJXA5Sk-cifKzJu0.js";import{M as re,f as Ke,$ as We,o as Xe}from"./euclideanLengthMeasurementUtils-CpHh36Dt-B3Q3Npaw.js";import{F as I}from"./Color-CERqXxxY-BuYn26eI.js";import{e as Qe,y as ti}from"./LengthDimension-B4lz3ld0-C7bgQA1m.js";import{M as yt}from"./Cyclical-BLSxUpe7-Bj8R2Yk-.js";import{l as T}from"./screenUtils-BitdhK1O-L0FLPAMi.js";import{m as j,o as ei}from"./vec4f64-DPb6J-GU-C7c2DqbZ.js";import{X as St,K as Mt,j as Et,x as ii}from"./plane-BNdSPG2o-Cq7jmU6w.js";import{e as ni,n as ai}from"./colorUtils-CeIi7j7j-nwrKvQYb.js";import{G as si,I as oi,N as L,a as ri,B as mt,q as li,e as x,Y as le,o as Ct,U as it,K as pi}from"./ShadedColorMaterial.glsl-Cdsx30m0-VRbWQZDd.js";import{p as Ot,S as di,B as pe}from"./dragEventPipeline3D-DqqdeG4y-BLCkBDmN.js";import{a as Vt}from"./orientedBoundingBox-BLEx7wLU-CPBtS4XC.js";import{g as ui}from"./Texture-CFNZjV2R-lGBztxVp.js";import{J as et,e as Dt,v as mi}from"./InteractiveToolBase-DXh7kfgV-R_Z6wqPu.js";import{m as ci}from"./elevationInfoUtils-B8MpdRMP-CN_w2fPT.js";import{r as hi}from"./UpdatingHandles-D2RI_3Hb-dwLPjVun.js";import{j as It}from"./Factory-CBIg5Skh-B50LJt1_.js";import{o as fi}from"./SnappingVisualizer3D-BUM9kaD3-BdMhfnf4.js";import{b as gi}from"./VerticesVisualElement-_ApBW3px-D82ufz7m.js";import{y as vi}from"./ImageMaterial.glsl-CrPy6XFt-DT5hEKxs.js";import{r as rt}from"./lineStippleUtils-CCavR4OV-DESXkwZW.js";import{S as _i,Z as yi,d as Si}from"./EditGeometryOperations-DZvKpTU8-cI99RYYJ.js";import{g as Mi}from"./SnappingContext-CApcAey_-Kve-1Boq.js";import{r as wi}from"./SnappingDragPipelineStep-Uh4sAWwf-B8z4_n_a.js";import{v as Pi}from"./SnappingManagerPool-DdmH-hls-BuYjMLac.js";import{a as bi}from"./SnappingOperation-ClIdnPwp-BbaP0Atw.js";import{z as Ci,f as Oi,B as Ut,u as Di}from"./analysisViewUtils-Z_Z4rbWk-DilCDlu1.js";import{r as Ti}from"./ToolIntersector-BVL3bGrn-Vo_uVU8o.js";import{V as xi}from"./intl-DRFqUect-ClAS7BRt.js";import{i as Ri}from"./quantityFormatUtils-WvkXaau6-BqnfKmyX.js";import{q as Ai,_ as Hi}from"./line-DShd3yGd-Vds7wO8W.js";import{u as de}from"./LineMarker.glsl-CTKL3oPN-CG-nglIF.js";import{h as zi}from"./automaticLengthMeasurementUtils-O6uwtXFm-C_BY4_yv.js";import"./index-CTl7hdrJ.js";import"./Extent-CgDMOSRD-CU1qE5Kr.js";import"./Polyline-CoiTLswR-BLagWJLS.js";import"./Polygon-D6wEPb3W-CpL9Efjx.js";import"./typeUtils-DqrRcjBx-ZWdHcSIJ.js";import"./modeUtils-BA-mAwuS-UrytRxLw.js";import"./sanitizerUtils-BT_8V5US-CWQWUwZQ.js";import"./lengthUtils-Dt1_RvOO-bleznLOi.js";import"./date-IqUzANpt-bLKO9IDT.js";import"./workers-BEkgoq8Q-BNWfkyQs.js";import"./PooledRBush-Dco5QkUp-DX3CMhf3.js";import"./GraphicsCollection-Bk6M0b7D-ByzFamPI.js";import"./Graphic-DgGzDmqW-CFzg0c4i.js";import"./getPopupProvider-CmskPttI-C4PqyuPF.js";import"./Layer-DZvC7bne-m1cEC_yw.js";import"./typeUtils-CXW_VpOn-BoSnXkME.js";import"./lineMarkers-CDwLe3J6-CNUjJvs3.js";import"./PolygonSymbol3D-BXRHZiCQ-Vi0-2Gvc.js";import"./ExtrudeSymbol3DLayer-DSc1ou2x-CsVYZCeG.js";import"./aaBoundingBox-Cn49X7ge-DORLZxoS.js";import"./Font-BwmnW7d2-D-oIm_Md.js";import"./SimpleFillSymbol-CDawtd9z-CWD2KI2D.js";import"./SimpleMarkerSymbol-BGAFRS9_-CVQ5NLIA.js";import"./PictureMarkerSymbol-CaSh-vZk-BNpExnAb.js";import"./TextSymbol-hRGhyDHs-C0NgASym.js";import"./HeightModelInfo-D5IdRvJ2-BK9di2bT.js";import"./projectionUtils-BGH_5_I3-BySNUA-B.js";import"./spatialReferenceEllipsoidUtils-D2JabnKt-Cip58jmo.js";import"./TilemapCache-CjhKW_vj-BYOTuKe8.js";import"./LRUCache-fy84PBMi-Y56WPIvD.js";import"./asyncUtils-w6KfWU41-HenJ0UOu.js";import"./Map-AEYszeHg-D2YZkc1e.js";import"./Basemap-CL_uaRmk-ChnHJfg0.js";import"./PortalItem-DnxMlRVo-Dhq4alsp.js";import"./writeUtils-DEFpwIW1-D44H3UWs.js";import"./CollectionFlattener-D6h2Fkvj-qnUHjb1M.js";import"./resourceExtension-DOTCeiZj-BXiJr75H.js";import"./PolygonCollection-HNNpnBH7-C5NQ6xHr.js";import"./mat4f32-Djp3mnm5-DzYG3LYB.js";import"./Query-BlS0WPDF-BdshFBMz.js";import"./Field-Cm_ZejYW-CwJZmSru.js";import"./fieldType-DVUzXtk_-tUuvnZJM.js";import"./normalizeUtils-85zLqeMi-DCF9gKvo.js";import"./normalizeUtilsCommon-CnhQye_A-zWtr51r8.js";import"./ElevationQuery-DzlYa4L4-BxQXlEAE.js";import"./TileInfo-Bz7QlefV-tjhen9qQ.js";import"./vec2f64-rIxtbMRN-Kai9mK1i.js";import"./vec3f32-WCVSSNPR-9V6Uhrx-.js";import"./Scheduler-CNrsbccs-Bcg8fWoS.js";import"./Indices-D0_UQPPr-t1Qev6md.js";import"./InterleavedLayout-B7roQAzV-CC2VYRPC.js";import"./BufferView-Cj2sQaht-DuP-iLZg.js";import"./vec42-B8VM4vXb-BnA9MysM.js";import"./sphere-DLQ6p7mp-DmnRpHXV.js";import"./constants-D67WmGms-H7IOwEdB.js";import"./quat-B7J5v7rV-i-DOMCm_.js";import"./quatf64-CCm9z-pX-CQ7_sSji.js";import"./frustum-CMzahy3--CFytpSYl.js";import"./floatRGBA-D-Q4FzNN-BzjdY1tU.js";import"./UnknownTimeZone-B697BDFv-CBbtul7O.js";import"./TileKey-C44YQC4_-BW7BBbYp.js";import"./unitConversionUtils-4vB4Ezlp-B0eWR3Ls.js";import"./vec2f32-CaVKkSa6-BjkBmyoj.js";import"./Emissions.glsl-B8XKMjLy-DXfiRNVX.js";import"./Octree-DckBBpQ7-BC8mmFdF.js";import"./axisAngleDegrees-CjbXmycq-LMRXo165.js";import"./edgePreprocessing-D_eX-fWy-CRLN12td.js";import"./vec3-B_phcnZY-DHC7I6xa.js";import"./vec33-CWJeyzxV-Me4sF5XB.js";import"./MeshLocalVertexSpace-BGd1IdEs-DqCdtROz.js";import"./TextOverlayItem-OzxvglQU-BNRRgu9H.js";import"./utils-DTE-xBiC-uxMmcNif.js";import"./geodeticLengthOperator-ysQZ6ofQ-CX26XL0i.js";import"./ColorMaterial.glsl-rhi0cQVb-BUmbct5I.js";import"./ExtendedLineVisualElement-B_Ze482f-D1G6-LVV.js";import"./EngineVisualElement-DP9Jiq6V-BhC9DiP0.js";import"./LaserlinePath.glsl-DfE4imRj-B0vl76WV.js";import"./DefaultLayouts-B8c6Qefj-D-9ZzY5G.js";import"./allLayerSnapping-DASGx2Wx-Bt7bxtdA.js";import"./jsonUtils-CmpazY1u-ateEpj4Q.js";import"./SimpleObservable-CvFyr0NA-DXpoMYph.js";import"./aaBoundingRect-CjwcS2F3-D7aII9DY.js";import"./projectPointToVector-DL7Z4uvb-BbcUuq8O.js";import"./scaleUtils-yfx9kKWT-BPfZ-Fh2.js";import"./layerUtils-DZGhvm-W-DLw3QMll.js";import"./tagSymbols-BPcGfZon-BPcGfZon.js";import"./Queue-CYlrXMwB-CYJTUII-.js";import"./signal-BX9ezF8a-cf1Pn6io.js";import"./timeZoneUtils-BSc7-7qA-BAv3h8mh.js";import"./ReactiveMap-B0by2bYu-DCsCfMj5.js";import"./TablesMixin-Q80MT3nU-CFBTh0j7.js";import"./enums-B4pqBiXb-BO-3hS_8.js";import"./memoryEstimations-Bd726a_p-0cVCY2Jz.js";import"./VertexElementDescriptor-BlxU8vCE-BwuKQkTU.js";import"./reader-DcGs6kKN-DHJfK-tm.js";import"./computeTranslationToOriginAndRotation-Bjd4esRf-CXUng2L4.js";import"./layerViewUtils-BTa15X3o-BjQlX2q8.js";import"./dehydratedFeatures-Ql-uVzLq-DehgeO5I.js";import"./quantizationUtils-Ceq-Uxsu-CDK8m1qL.js";import"./featureConversionUtils-BDA_FXJx-CUwkrHf5.js";import"./OptimizedFeature-CwRGZPwv-Ddclhn0A.js";import"./OptimizedFeatureSet-BR8EEvDc-CgsRgxJh.js";import"./createFeatureId-CVwTD0fV-3fKpJDrk.js";import"./HUDIntersectorResult-1xTExS7z-CU1-YQoW.js";import"./intersectorUtilsConversions-pLQPEbcN-rV-4Q5_m.js";import"./Intersector-DS9YtyQY-CuzM48xl.js";import"./DefaultLoadingContext-DXgBe4GE-Colk9t6X.js";import"./wosrLoader-CIPfz1Cl-qtGxLmBP.js";import"./Version-BtYZEj58-LyRHDnSJ.js";import"./DoubleArray-DExKNiTh-CvVpHySW.js";import"./config-Dg972SSE-D9DBKeq5.js";import"./GeometryUtils-C354xUs0-CG8X9WjO.js";import"./definitions-Dvg4hMIw-CdK2DzFN.js";import"./WorkerHandle-B930SiRy-b7IwaSpV.js";import"./capabilities-Bi6C4OG6-CpURufko.js";import"./imageUtils-142g71N8-CjUugWaS.js";import"./videoUtils-Dwx3AEgj-CduhpDRk.js";import"./uuid-Oe6SV2kF-IYX19xBA.js";import"./quickselect-QQC62dOK-Br2Ahhru.js";import"./meshVertexSpaceUtils-CtG7DPVT-V_uCtHpB.js";import"./TileKey-CXWFOqOI-CcilLir8.js";import"./loadAll-BCyxerwc-DK9uHnLK.js";import"./opacityUtils-DuFH0EC9-DWspTgn2.js";import"./persistable-CdoDQOTR-CH9U-JJT.js";import"./MD5-MtSiOt06-jWr180Yc.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw-DH8sdIsE.js";import"./utils-CylVuxNi-CqOfmBVG.js";import"./utils-Dpg4yj1D-BVnuoMV8.js";import"./types-BKo2foNY-DE0QfIFp.js";import"./labelUtils-BtizwBfq-Zegx4520.js";import"./ArcadeExpression-BlIRq-oN-DGzfhzBj.js";import"./TimeOnly-BERR31kg-PKcKegNB.js";import"./enum-BzLwmiID-CcyIdWlQ.js";import"./FieldsIndex-CimK-TqD-CrSnohIk.js";import"./VisualElement-By4iq8p4-ZBataKFH.js";import"./geometry2dUtils-B4vDf2wH-D5Eyn-ve.js";import"./PointVisualElement-pF4jjqm_-_bLXT2e5.js";import"./TriangleMaterial-BIKWylXl-CcDbhy8X.js";import"./rotate-CKztRS_J-BP1oc49D.js";import"./curveOperationUtils-BGqPT1bh-COCfpJm1.js";import"./PointSnappingHint-w5twIXP5-ULx8JUZp.js";import"./dehydratedFeatureComparison-faNSTYzo-C3UzI31T.js";import"./geodeticCurveType-CirnHLSB-CirnHLSB.js";class ki{constructor(e,i,n,a,s,o){this.elevationAlignedStartPoint=e,this.elevationAlignedEndPoint=i,this.directSegment=n,this.dimensionSegment=a,this.primaryOffsetAxis=s,this.spatialReference=o}}const Bt=De(G);function $i(t,e,i,n){if(t==null)return null;let a;if(e==="horizontal")a=n.autoDistanceBetweenPoints2D(Bt(t.elevationAlignedStartPoint),Bt(t.elevationAlignedEndPoint));else{const{startRenderSpace:o,endRenderSpace:r}=t.dimensionSegment;a=We(o,r,t.spatialReference)}if(a==null)return null;const s=e==="vertical"?Ie(a.value,a.unit,i):Ue(a.value,a.unit,i);return te(a,s)}function lt(t){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:i,dimension:{offset:n,measureType:a,orientation:s}}=t;return{elevationAlignedStartPoint:e,elevationAlignedEndPoint:i,offset:n,measureType:a,orientation:s}}function pt({elevationAlignedStartPoint:t,elevationAlignedEndPoint:e,offset:i,measureType:n,orientation:a},s,o=null){if(t==null||e==null)return null;const r=me(o?.directSegment??new V,{elevationAlignedStartPoint:t,elevationAlignedEndPoint:e},s),l=o?.primaryOffsetAxis??P();ct(l,{measureType:n,elevationAlignedStartPoint:t,elevationAlignedEndPoint:e,directSegment:r,orientation:a,renderCoordsHelper:s});const p=o?.dimensionSegment??new V;return Tt({elevationAlignedStartPoint:t,elevationAlignedEndPoint:e})&&n==="vertical"?(O(p.startRenderSpace,r.startRenderSpace),O(p.endRenderSpace,r.endRenderSpace)):ce(p,l,i,r,s),new ki(t,e,r,p,l,s.spatialReference)}function Ft(t,e,i,n){return e===0?(O(t.startRenderSpace,i.startRenderSpace),O(t.endRenderSpace,n.startRenderSpace)):(O(t.startRenderSpace,i.endRenderSpace),O(t.endRenderSpace,n.endRenderSpace)),t}function Gi(t,e,i,n){st(t.startRenderSpace,e.startRenderSpace,i,n),st(t.endRenderSpace,e.endRenderSpace,i,n)}function ue(t,e,i,n){switch(e){case"direct":return me(t,i,n);case"horizontal":case"vertical":{const{elevationAlignedStartPoint:a,elevationAlignedEndPoint:s,dimension:o,geometry:r}=i;let l;o.measureType==="direct"?(l=Li(r,n)===a.z>s.z,e==="horizontal"&&(l=!l)):l=!Ei(r);const[p,m]=l?[a,s]:[s,a],c=q(m,Vi);return e==="horizontal"?c.z=p.z:(c.x=p.x,c.y=p.y),n.toRenderCoords(p,t.startRenderSpace),n.toRenderCoords(c,t.endRenderSpace),t}}}function me(t,e,i){return i.toRenderCoords(e.elevationAlignedStartPoint,t.startRenderSpace),i.toRenderCoords(e.elevationAlignedEndPoint,t.endRenderSpace),t}function Li(t,e){const i=t.directSegment.eval(.5,f.get()),n=e.worldUpAtPosition(i,f.get()),a=t.dimensionSegment.eval(.5,f.get()),s=A(f.get(),a,i);return!ie(s,F)&&z(s,n)>0}function Ei(t){const{startRenderSpace:e,endRenderSpace:i}=t.dimensionSegment,{startRenderSpace:n,endRenderSpace:a}=t.directSegment;return Lt(n,e)<Lt(a,i)}const Vi=Ye(0,0,0,null);function Ii(t,e,i,n){const{directSegment:a}=i,s=ct(f.get(),{measureType:e,directSegment:a,renderCoordsHelper:n}),o=ce(Ui,s,0,a,n).eval(.5,f.get()),r=A(f.get(),t,o);return z(r,s)*n.unitInMeters}const Ui=new V;function ct(t,e){const{measureType:i,elevationAlignedStartPoint:n,elevationAlignedEndPoint:a,directSegment:{startRenderSpace:s,endRenderSpace:o},directSegment:r,renderCoordsHelper:l}=e,p=r.eval(.5,f.get()),m=l.worldUpAtPosition(p,f.get()),c=l.worldBasisAtPosition(p,1,f.get());switch(i){case"horizontal":O(t,m);break;case"vertical":z(s,m)<z(o,m)?A(t,o,s):A(t,s,o),E(t,t,m),E(t,t,m);break;case"direct":{const h=e.orientation??0;if(Tt({elevationAlignedStartPoint:n,elevationAlignedEndPoint:a}))$t(nt,-kt(h),m),Gt(t,c,nt);else{const g=A(f.get(),o,s),_=E(f.get(),g,m);E(_,_,g),$t(nt,kt(h),g),Gt(t,_,nt)}break}}return ie(t,F)?O(t,c):qe(t,t)}const nt=bt();function Tt({elevationAlignedStartPoint:t,elevationAlignedEndPoint:e}){return t!=null&&e!=null&&t.x===e.x&&t.y===e.y}function ce(t,e,i,n,a){const{startRenderSpace:s,endRenderSpace:o}=n,r=i/a.unitInMeters,[l,p]=Bi(s,o,e,r);return st(t.startRenderSpace,n.startRenderSpace,e,l),st(t.endRenderSpace,n.endRenderSpace,e,p),t}function Bi(t,e,i,n=0){const a=z(e,i),s=z(t,i),o=Math.abs(a-s)+n;return a>s?[o,n]:[n,o]}function ht(t,e,i){const n=e.directSegment.eval(.5,f.get());return i.worldUpAtPosition(n,t)}function xt(t,e){const{startRenderSpace:i,endRenderSpace:n}=e.directSegment;return A(t,n,i)}function Rt(t,e,i={invert:!1}){const{startRenderSpace:n,endRenderSpace:a}=e.dimensionSegment;return i.invert?A(t,n,a):A(t,a,n)}function wt(t,e){const i=t.directSegment.eval(.5,f.get());return e.headingAtPosition(i,t.primaryOffsetAxis)}function Fi(t,e){return _t(Rt(ji,t))/e**2}const ji=P();function he(t){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:i}=t;if(e==null||i==null)return!1;const n=Ke(e,i);return n!=null&&te(n,"meters").value>re}function K(t){return t.geometry!=null}let $=class extends Q{constructor(t){super(t)}initialize(){const t=ut(()=>this.analysisViewData.computations,({computation:e})=>this._watchComputation(e));this.addHandles(X(t))}get analysis(){return this.analysisViewData.analysis}get _defaultUnit(){return Be(this.view)}_watchComputation(t){return v(()=>lt(t),e=>{const{measureType:i}=e;if(he(e)&&i!=="direct"){const a=Math.round(Ve(re,"meters","kilometers"));return Xt.getLogger(this).warnOnce(`A ${i} dimension in the analysis (id: '${this.analysis.id}') will not display, because only direct dimensions can measure lengths greater than ${a} km. Update the measureType of the affected dimension to "direct" to display it.`),void(t.geometry=null)}const n=pt(e,this.view.renderCoordsHelper,t.geometry);t.geometry=n,t.result.length=$i(n,i,this._defaultUnit,this.automaticLengthMeasurementUtils)},D)}};d([u({constructOnly:!0})],$.prototype,"analysisViewData",void 0),d([u({constructOnly:!0})],$.prototype,"view",void 0),d([u({constructOnly:!0})],$.prototype,"automaticLengthMeasurementUtils",void 0),d([u()],$.prototype,"analysis",null),d([u()],$.prototype,"_defaultUnit",null),$=d([U("esri.views.3d.analysis.Dimension.DimensionController")],$);function W(t){return ni(t.accentColor,.5)}function jt(t){return ai(t.accentColor)}const fe=5,Ni=new I([127,127,127,.5]),ge=.8,qi=4,Yi=6,Zi=.1,ve=.5,Ji=18,Ki=2,Wi=.3,Xi=2,Qi=.25,tn=20,en=5,Nt=5,qt=10,nn=2500,an=50,sn=2;class on{constructor(e){this.start=e.start,this.end=e.end,this.offset=e.offset,this.heading=e.heading,this.rotation=e.rotation,this.direct=e.direct,this.horizontal=e.horizontal,this.vertical=e.vertical}manipulatorName(e){return Object.keys(this).find(i=>this.hasOwnProperty(i)&&e===this[i])}values(){return[this.start,this.end,this.offset,this.heading,this.rotation,this.direct,this.horizontal,this.vertical]}forEachMeasureTypeManipulator(e){for(const i of ti)e(this.manipulatorForMeasureType(i),i)}manipulatorForMeasureType(e){switch(e){case"direct":return this.direct;case"horizontal":return this.horizontal;case"vertical":return this.vertical}}}class rn extends mt{constructor(e,i){const n=li(I.toUnitRGBA(W(e.effectiveTheme))),a=[new x(Ze(n,1,32,32),H)];super({view:e,renderObjects:a,metadata:i.metadata,available:!1,grabCursor:"crosshair",radius:fe,collisionPriority:1}),this._themeHandle=v(()=>({color:I.toUnitRGBA(W(e.effectiveTheme))}),s=>n.setParameters(s))}destroy(){this._themeHandle.remove(),super.destroy()}}function ln(t,e){const i=[ot(-.5,0,0),ot(.5,0,0)],n=J(e.unfocusedMaterial,i.map(s=>tt(P(),s,ve))),a=n.instantiate({material:e.focusedMaterial});return new mt({view:t,renderObjects:[new x(n,9|H),new x(a,2|H)],collisionType:{type:"line",paths:[i]},radius:At(e.lineSizePt)/2,metadata:e.metadata,available:!1,...le})}class Yt extends mt{constructor(e,{lineSizePt:i,material:n,metadata:a}){super({view:e,autoScaleRenderObjects:!1,collisionPriority:1,metadata:a}),this._options={calloutColor:ei(),lineSizePt:i,material:n},this._themeHandle=v(()=>I.toUnitRGBA(W(e.effectiveTheme)),s=>{this._options.calloutColor=s,Jt(this,Zt({...this._options,metadata:this.metadata}))},Z)}update({lineSizePt:e,material:i}){this._options.lineSizePt=e,this._options.material=i,Jt(this,Zt({...this._options,metadata:this.metadata}))}destroy(){this._themeHandle.remove(),super.destroy()}}function Zt({calloutColor:t,lineSizePt:e,material:i,metadata:n}){return{calloutLength:.25*Ge*ge*T(e)+Ji,calloutColor:t,calloutWidth:Ki,customStateMask:H,discScale:Wi,focusMultiplier:Xi,material:i,metadata:n}}function pn(t,e){const i=[ot(-.5,0,0),ot(.5,0,0)],n=J(e.thinOffsetManipulatorMaterial,i),a=J(e.unfocusedMaterial,i.map(o=>tt(P(),o,ve))),s=a.instantiate({material:e.focusedMaterial});return new mt({view:t,renderObjects:[new x(a,1|H),new x(s,2|H),new x(n,H)],collisionType:{type:"line",paths:[i]},radius:At(e.lineSizePt)/2,available:!1,metadata:e.metadata,...le})}function dn(t,{isStart:e,createSnappingPipelineStep:i,dimension:n,onUpdate:a,view:s}){const o=e?"startPoint":"endPoint";return[et(t,(r,l,p,m)=>{const c=Ot(r),{snappingStep:h,cancelSnapping:g}=i(m);p=p.next(c).next(Dt(n,[o,"measureType","orientation"])).next(g),l.next(c).next(di(s)).next(...h).next(_=>{const M=q(_.mapEnd,new G);a(o==="startPoint"?{startPoint:M}:{endPoint:M})})})]}function un(t,{computation:e,view:i}){return[et(t,(n,a,s)=>{if(!K(e)||!n.selected)return;const{geometry:o,dimension:r}=e,l=Ot(n);a.next(l).next(ye(i,r,o.dimensionSegment,o.primaryOffsetAxis)),s.next(l).next(Dt(r,["offset"]))})]}function mn(t,{computation:e,view:i}){return[et(t,(n,a,s)=>{_e({cancel:s,computation:e,settingHeading:!0,steps:a,view:i})})]}function cn(t,{computation:e,view:i}){return[et(t,(n,a,s)=>{_e({cancel:s,computation:e,settingHeading:!1,steps:a,view:i})}),t.events.on("immediate-click",n=>{hn(n,e,i)})]}function hn(t,e,i){const{dimension:n,geometry:a}=e;if(n.orientation===90||n.orientation===270)return n.orientation=0,void t.stopPropagation();if(a==null)return;const{renderCoordsHelper:s}=i,o=pt({...lt(e),orientation:90},s),r=pt({...lt(e),orientation:270},s);if(o==null||r==null)return;const l=wt(o,s),p=wt(r,s),m=Se(a,i),c=yt.shortestSignedDiff(m,l),h=yt.shortestSignedDiff(m,p);n.orientation=Math.abs(c)<Math.abs(h)?90:270,t.stopPropagation()}function _e(t){const{cancel:e,computation:i,settingHeading:n,steps:a,view:s}=t;if(!K(i))return;const{renderCoordsHelper:o}=s,{dimension:r,geometry:l}=i,p=P(),m=we(P(),l,l.directSegment,o),c=Pe(f.get(),{forHeading:n,geometry:l,renderCoordsHelper:o}),h=St(m,c,Mt()),g=n?r.orientation??wt(l,s.renderCoordsHelper):r.orientation??0;a.next(pe(s,h)).next(_=>{_.action==="start"&&O(p,_.renderStart);const M=ii(h),S=pi(p,_.renderEnd,m,M);let k=g-Fe(S);n||(k=fn(k)),r.orientation=k}),e.next(Dt(r,["orientation"]))}function fn(t){const e=yt.normalize(t)%90;return e<Nt?t-e:90-e<Nt?t+(90-e):t}function gn(t,{computation:e,manipulatorMeasureType:i,view:n}){let a="direct",s=0,o=0;return[t.events.on("grab-changed",r=>{if(r.action!=="start"||!K(e))return;const{dimension:l,geometry:p}=e;a=l.measureType,s=l.offset,o=l.orientation;const m=O(f.get(),t.renderLocation);l.measureType=i,l.offset=Ii(m,i,p,n.renderCoordsHelper),l.orientation=0}),et(t,(r,l,p)=>{if(!K(e))return;const{geometry:m,dimension:c}=e,{renderCoordsHelper:h}=n,g=ue(be,i,e,h),_=ct(f.get(),{measureType:i,directSegment:m.directSegment,renderCoordsHelper:h}),M=Ot(r);l.next(M).next(ye(n,c,g,_)),p.next(M).next(S=>(c.measureType=a,c.offset=s,c.orientation=o,S))})]}function ye(t,e,i,n){const a=oe(f.get(),i.endRenderSpace,i.startRenderSpace);E(a,a,n);const s=St(i.startRenderSpace,a,Mt()),o=St(i.startRenderSpace,n,Mt()),r=e.offset;let l,p=0;const m=new mi;return m.next(pe(t,s)).next(c=>{c.action==="start"&&(p=Et(o,c.renderStart));const h=(Et(o,c.renderEnd)-p)*t.renderCoordsHelper.unitInMeters;e.offset=r+h,l=c}),c=>(m.execute(c),l)}function Se(t,e){const{directSegment:i}=t,{renderCoordsHelper:n}=e,a=ht(f.get(),t,n),s=xt(f.get(),t),o=E(f.get(),s,a),{viewForward:r}=e.state.camera;z(o,r)>0&&tt(o,o,-1);const l=i.eval(.5,f.get());return n.headingAtPosition(l,o)}function vn(t,e,i){const{dimensionSegment:n,primaryOffsetAxis:a}=e,s=Rt(Y,e),o=ne(s,F)?Ne(dt):Ct(s,a,F,dt),r=Math.max(ae(s),Zi/i.unitInMeters);ee(o,o,se(Y,r,r,r)),t.modelTransform=o,t.renderLocation=n.eval(.5,Y)}function _n(t,e,i){Me(t,e,i,{forHeading:!0})}function yn(t,e,i){Me(t,e,i,{forHeading:!1})}function Me(t,e,i,{forHeading:n}){const{dimension:a,geometry:s}=e,{primaryOffsetAxis:o}=s,r=tt(Sn,o,a.offset>=0?1:-1),l=Pe(Mn,{forHeading:n,geometry:s,renderCoordsHelper:i});E(l,l,r);const p=Ct(r,l,F,dt);t.modelTransform=p,t.renderLocation=we(Y,s,s.dimensionSegment,i)}const Sn=P(),Mn=P();function wn(t,e,i,n){const{geometry:a}=e,s=ue(be,i,e,n),o=ct(Y,{measureType:i,directSegment:a.directSegment,renderCoordsHelper:n}),r=A(ft,s.endRenderSpace,s.startRenderSpace),l=Ct(r,o,F,dt),p=ae(r);ee(l,l,se(ft,p,p,p)),t.modelTransform=l,t.renderLocation=s.eval(.5,ft)}function we(t,e,i,n){const{startRenderSpace:a,endRenderSpace:s}=i,o=Pn(e,n)?a:s;return O(t,o)}function Pe(t,{forHeading:e,geometry:i,renderCoordsHelper:n}){return e?ht(t,i,n):Rt(t,i,{invert:!0})}function Pn(t,e){const i=xt(bn,t),n=ht(Cn,t,e);return z(i,n)>0}const bn=P(),Cn=P();function On(t){return T(t)+qi}function At(t){return T(t)+Yi}function Jt(t,e){const i=e.material,n=e.focusMultiplier??it.focusMultiplier,a=e.calloutLength??it.calloutLength,s=it.discRadius*(e.discScale??1),o=s*n,r=(g,_)=>{const M=[0,1,2,2,3,0];return new ui(_,[["position",new Vt([a-g,-g,0,a+g,-g,0,a+g,g,0,a-g,g,0],M,3,!0)],["uv0",new Vt([0,0,1,0,1,1,0,1],M,2,!0)]])},l=e.calloutWidth??it.calloutWidth,p=new B({width:l,color:e.calloutColor,renderOccluded:4,isDecoration:!0},t.view.state.isGlobal),m=J(p,[[0,0,0],[a-s,0,0]]),c=J(p,[[0,0,0],[a-o,0,0]]),h=e.customStateMask??0;t.collisionType={type:"disc",direction:[0,0,1],offset:[a,0,0]},t.focusMultiplier=n,t.metadata=e.metadata,t.radius=s,t.renderObjects=[new x(r(s,i),1|h),new x(m,1|h),new x(r(o,i),2|h),new x(c,2|h)]}const H=16,Y=P(),ft=P(),dt=bt(),be=new V;function Dn(t,e){return{enabled:e.effectiveFeatureEnabled,elevationAlignedStartPoint:t.elevationAlignedStartPoint,elevationAlignedEndPoint:t.elevationAlignedEndPoint,geometry:t.geometry}}function Tn(t,e){if(he(t))return 2;if(!t.enabled)return null;const{geometry:i}=t;if(i==null||ne(i.directSegment.startRenderSpace,i.directSegment.endRenderSpace))return null;const{camera:n}=e.state,a=ht(f.get(),i,e.renderCoordsHelper),s=xt(f.get(),i),o=tt(f.get(),a,z(s,a)),r=oe(f.get(),s,o),l=_t(r),p=_t(o),{startRenderSpace:m,endRenderSpace:c}=i.directSegment,h=Math.max(n.computeScreenPixelSizeAt(m)*qt,n.computeScreenPixelSizeAt(c)*qt)**2;return l<h?1:p<h?0:null}function xn(t,e,{constraint:i,view:n}){const{unconstrainedGeometry:a}=t;if(a==null)return;const{renderCoordsHelper:s,spatialReference:o}=n,{startRenderSpace:r,endRenderSpace:l}=a.directSegment,p=s.fromRenderCoords(r,new G({spatialReference:o})),m=s.fromRenderCoords(l,new G({spatialReference:o}));let c;c=e==="start"?{startPoint:p}:{endPoint:m},Ce(t,c,{constraint:i,elevationAlignedStartPoint:t.elevationAlignedStartPoint,elevationAlignedEndPoint:t.elevationAlignedEndPoint,unconstrainedGeometry:a,view:n})}function Ce(t,e,i){const{constraint:n,elevationAlignedStartPoint:a,elevationAlignedEndPoint:s,unconstrainedGeometry:o,view:r}=i,{dimension:l,previousConstraint:p,preConstraintProperties:m}=t;if(a==null||s==null)return;const c=()=>{"startPoint"in e?l.startPoint=e.startPoint:"endPoint"in e&&(l.endPoint=e.endPoint)};if(n==null)c(),p!=null&&m!=null&&(l.measureType=m.measureType,l.orientation=m.orientation);else switch(l.measureType="direct",n){case 0:if(n!==p&&(l.orientation=0),"startPoint"in e){const h=e.startPoint;h!=null&&(h.z=s.z),l.startPoint=h}else if("endPoint"in e){const h=e.endPoint;h!=null&&(h.z=a.z),l.endPoint=h}break;case 1:if(n!==p&&(l.orientation=Se(o,r)),"startPoint"in e){const h=e.startPoint;h!=null&&(h.x=s.x,h.y=s.y),l.startPoint=h}else if("endPoint"in e){const h=e.endPoint;h!=null&&(h.x=a.x,h.y=a.y),l.endPoint=h}break;case 2:n!==p&&m!=null&&(l.orientation=m.orientation),c()}t.previousConstraint=n,t.unconstrainedGeometry=o}let y=class extends Q{constructor(t){super(t),this._stagedDimension=null,this._snappingManagerResult=null,this._computationManipulators=new Map,this._computationHandles=new Qt,this._updatingHandles=new hi,this._getSnappingContext=ci(n=>new Mi({elevationInfo:{mode:"absolute-height",offset:0},pointer:n,editGeometryOperations:new _i(new yi("point",Si(!0,!1,this.view.spatialReference)),this.view.state.viewingMode),visualizer:new fi}));const{view:e}=t;this._unfocusedOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(e),this._focusedOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(e),this._thinOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(e),this._thinOffsetManipulatorMaterial.setParameters({stipplePattern:rt(2)}),this._constraintSnappingIndicator=new L({view:e,attached:!0,width:1,renderOccluded:4,stipplePattern:rt(5),isDecoration:!0});const i=I.toUnitRGBA(Ni);this._stagedStartIndicator=new gi({view:e,attached:!1,elevationInfo:{mode:"absolute-height",offset:0},spatialReference:t.view.renderCoordsHelper.spatialReference,color:i,size:2*fe,outlineSize:0,renderOccluded:4,isDecoration:!0})}initialize(){const{view:t}=this;this._snappingOperation=new bi({view:t});const e=W(t.effectiveTheme),i=jt(t.effectiveTheme),n=!t.stage?.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result;this._textureHandle=It(t.stage.textures,{accentColor:e,contrastColor:i,preMultiplyAlpha:n}),this._orientationManipulatorMaterial=new vi({draped:!1,texture:this._textureHandle.texture,writeDepth:!1,renderOccluded:16,isDecoration:!0});const a=ut(()=>this.analysisViewData.computations,({computation:s})=>this._createManipulators(s));this.addHandles([v(()=>({accentColor:W(t.effectiveTheme),contrastColor:jt(t.effectiveTheme)}),({accentColor:s,contrastColor:o})=>{const r=this._textureHandle;this._textureHandle=It(t.stage.textures,{accentColor:s,contrastColor:o,preMultiplyAlpha:n}),this._orientationManipulatorMaterial.setParameters({texture:this._textureHandle.texture}),r?.release();const l=I.toUnitRGBA(s);this._unfocusedOffsetManipulatorMaterial.setParameters({color:l}),this._focusedOffsetManipulatorMaterial.setParameters({color:l}),this._thinOffsetManipulatorMaterial.setParameters({color:l}),this._constraintSnappingIndicator.color=l},Z),X(a),v(()=>({stagedPoint:this._snappingOperation.stagedPoint,stagedComputation:this._stagedComputation}),({stagedPoint:s,stagedComputation:o})=>{if(o==null||s==null)return;const r=q(s,new G);this._applyPointUpdate(o,{endPoint:r})},vt),v(()=>({stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}),(s,o)=>{const{stagedDimension:r,selectedComputation:l,firstGrabbedManipulator:p}=s;if(r===o?.stagedDimension&&p===o?.firstGrabbedManipulator){for(const m of[l,o?.selectedComputation])if(m!=null){const c=this._computationManipulators.get(m);c!=null&&this._updateManipulators(m,c,s)}}else for(const[m,c]of this._computationManipulators)this._updateManipulators(m,c,s)},D),v(()=>this.analysis.style.lineSize,s=>this._updateManipulatorStyle(s),Z),v(()=>this.view.state.camera,()=>{this._stagedComputation!=null&&this._updateStagedDimensionOffset(this._stagedComputation)}),v(()=>{const s=this._stagedComputation;if(!s)return null;const o=s.elevationAlignedStartPoint,r=P();return o!=null&&this.view.renderCoordsHelper.toRenderCoords(o,r)?r:null},s=>{s!=null?(this._stagedStartIndicator.vertices=[s],this._stagedStartIndicator.attached=!0):this._stagedStartIndicator.attached=!1})]),this.addHandles(this._constraintHandles),this.addHandles(this._snappingIndicatorHandles),Xe(this,()=>{const s=this._activeComputation,o=this._stagedComputation;if(s==null||o!=null){const r=this.view.inputManager.latestPointerInfo?.type??"mouse",l=this._getSnappingContext(r);this._updatingHandles.addPromise(Ht(this._snappingOperation.snapAgainNearPreviousMapPoint(this._ensureSnappingManager(),l)))}if(s!=null){const{start:r,end:l}=this._computationManipulators.get(s);if(r.grabbing||l.grabbing){const p=r.grabbing?"start":"end",m=this._computeConstraint(s);xn(s,p,{constraint:m,view:this.view})}}})}destroy(){this._textureHandle=Te(this._textureHandle),this._snappingOperation=Pt(this._snappingOperation),this._computationHandles.destroy(),this._constraintSnappingIndicator.destroy(),this._stagedStartIndicator.destroy(),this._orientationManipulatorMaterial.dispose()}get updating(){return this._updatingHandles.updating||!!this._snappingManager?.updating}get firstGrabbedManipulator(){return this.parentTool.firstGrabbedManipulator}get hasGrabbedManipulators(){return this.parentTool.hasGrabbedManipulators}get snappingOptions(){return this._snappingManager?.options}get _snappingManager(){return this._snappingManagerResult?.snappingManager}_ensureSnappingManager(){return this._snappingManagerResult||(this._snappingManagerResult=Pi(this.view),this.addHandles(this._snappingManagerResult)),this._snappingManagerResult.snappingManager}get _activeComputation(){if(this._stagedComputation!=null)return this._stagedComputation;const{selectedComputation:t}=this.analysisViewData;return this.hasGrabbedManipulators&&t!=null?t:null}get _stagedComputation(){const t=this._stagedDimension,e=this.analysisViewData.computations.at(-1)?.computation;return t==null||e==null||e.dimension!==t?null:e}get _constraintHandles(){return[at(()=>this.analysisViewData.selectedComputation,t=>{t.previousConstraint=this._computeConstraint(t)},{...D,equals:gt}),v(()=>{const t=this._activeComputation;if(t==null)return null;const{measureType:e,orientation:i}=t.dimension;return{measureType:e,orientation:i,computation:t}},(t,e)=>{if(t!=null&&e==null){const{measureType:i,orientation:n,computation:a}=t;switch(a.previousConstraint){case 0:a.preConstraintProperties={measureType:"horizontal",orientation:0};break;case 1:a.preConstraintProperties={measureType:"vertical",orientation:0};break;case 2:a.preConstraintProperties={measureType:"direct",orientation:n};break;default:a.preConstraintProperties={measureType:i,orientation:n}}}t==null&&e!=null&&(e.computation.preConstraintProperties=null)},vt)]}get _snappingIndicatorHandles(){const t="snapping-indicator-event-handles";return[v(()=>({stagedComputation:this._stagedComputation,activeComputation:this._activeComputation}),({stagedComputation:e,activeComputation:i})=>{const n=this._constraintSnappingIndicator;if(this.removeHandles(t),i!=null)if(i===e)n.attached=!0;else{const{start:a,end:s}=this._computationManipulators.get(i),o=()=>{n.attached=a.grabbing||s.grabbing};o(),this.addHandles([a.events.on("grab-changed",o),s.events.on("grab-changed",o)],t)}else n.attached=!1}),v(()=>{const e=this._activeComputation;return e!=null?{geometry:e.geometry,constraint:e.previousConstraint}:{}},({geometry:e,constraint:i})=>{const n=this._constraintSnappingIndicator;e!=null&&i!=null&&i!==2?(n.visible=!0,n.setGeometryFromSegment(e.directSegment)):n.visible=!1})]}removeStaged(){return this._stagedDimension!=null&&(this.analysis.dimensions.remove(this._stagedDimension),this._stagedDimension=null,!0)}onDeactivate(){this.removeStaged(),this._resetSnappingState()}onClick(t){const{_stagedDimension:e}=this;if(e==null){const i=this._onUnstagedClick(t);return this.analysis.dimensions.add(i),null}return this._onStagedClick(t),e}onPointerMove({mapPoint:t,pointerType:e}){if(e==="touch")return;const i=this._getSnappingContext(e);this._updatingHandles.addPromise(Ht(this._snappingOperation.snap({point:t},this._ensureSnappingManager(),i)))}onManipulatorSelectionChanged(){this.analysisViewData.selectedComputation!=null&&(this._computationManipulators.get(this.analysisViewData.selectedComputation).offset.selected||(this.analysisViewData.selectedDimension=null))}_onUnstagedClick({mapPoint:t,pointerType:e}){let i=t;if(e==="mouse"){const a=this._getSnappingContext(e);i=this._ensureSnappingManager().update({point:t,context:a})}const n=new Qe({startPoint:q(i,new G),endPoint:null,measureType:"horizontal"});return this._stagedDimension=n,this._resetSnappingState(),n}_onStagedClick({mapPoint:t,pointerType:e}){const i=this._stagedComputation;if(i==null)return;let n=t;if(e==="mouse"){const s=this._getSnappingContext(e);n=this._ensureSnappingManager().update({point:t,context:s})}const a=q(n,new G);this._applyPointUpdate(i,{endPoint:a}),this._stagedDimension=null,this._resetSnappingState()}_resetSnappingState(){this._ensureSnappingManager().doneSnapping(),this._snappingOperation.abort(),this._snappingOperation.stagedPoint=null}_createManipulators(t){const e=this._setupPointManipulator(t,{isStart:!0}),i=this._setupPointManipulator(t,{isStart:!1}),n=this._setupOffsetManipulator(t),a=this._setupHeadingManipulator(t),s=this._setupRotationManipulator(t),o=this._setupMeasureTypeManipulator(t,"direct"),r=this._setupMeasureTypeManipulator(t,"horizontal"),l=this._setupMeasureTypeManipulator(t,"vertical"),p=new on({start:e,end:i,offset:n,heading:a,rotation:s,direct:o,horizontal:r,vertical:l});this._setupComputationToManipulatorsSync(t,p),this._computationManipulators.set(t,p),this.manipulators.addMany(p.values());const m=xe(p.values().map(c=>c.events.on("focus-changed",()=>{p.values().some(h=>h.focused)&&this._resetSnappingState()})));return{manipulators:p,remove:()=>{m.remove(),this._computationHandles.remove(t),this._computationManipulators.delete(t);for(const c of p.values())this.manipulators.remove(c)}}}_setupComputationToManipulatorsSync(t,e){this._computationHandles.add([v(()=>t.geometry,()=>this._updateManipulators(t,e),{...D,equals:gt})],t)}_setupPointManipulator(t,e){const{view:i}=this,{dimension:n}=t,a=new rn(i,{metadata:n}),s=dn(a,{isStart:e.isStart,createSnappingPipelineStep:o=>wi({snappingContext:this._getSnappingContext(o),snappingManager:this._snappingManager,updatingHandles:this._updatingHandles}),dimension:n,onUpdate:o=>this._applyPointUpdate(t,o),view:i});return this._computationHandles.add(s,t),a}_setupOffsetManipulator(t){const{view:e}=this,i=ln(e,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,metadata:t.dimension}),n=un(i,{computation:t,view:e});return this._computationHandles.add(n,t),i}_setupHeadingManipulator(t){const{view:e}=this,i=new Yt(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:t.dimension}),n=mn(i,{computation:t,view:e});return this._computationHandles.add(n,t),i}_setupRotationManipulator(t){const{view:e}=this,i=new Yt(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:t.dimension}),n=cn(i,{computation:t,view:e});return this._computationHandles.add(n,t),i}_setupMeasureTypeManipulator(t,e){const{view:i}=this,n=pn(i,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,thinOffsetManipulatorMaterial:this._thinOffsetManipulatorMaterial,metadata:t.dimension}),a=gn(n,{computation:t,manipulatorMeasureType:e,view:i});return this._computationHandles.add(a,t),n}_updateManipulators(t,e,i={stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}){const{stagedDimension:n,selectedComputation:a,firstGrabbedManipulator:s}=i,{start:o,end:r,offset:l,heading:p,rotation:m}=e,c=a===t,h=K(t),{dimension:g}=t;for(const S of e.values()){const k=h&&n==null&&(s==null||S===s);S===l?(S.available=k,S.selected=c):S.available=k&&c}if(!h)return;this._computeConstraint(t)!=null?e.forEachMeasureTypeManipulator(S=>S.available=!1):e.manipulatorForMeasureType(g.measureType).available=!1;for(const S of[p,m])g.measureType==="direct"&&g.offset!==0||(S.available=!1);Tt(t)?m.available=!1:p.available=!1;const{geometry:_}=t;o.renderLocation=_.directSegment.startRenderSpace,r.renderLocation=_.directSegment.endRenderSpace;const{renderCoordsHelper:M}=this.view;vn(l,_,M),p.available&&_n(p,t,M),m.available&&yn(m,t,M),e.forEachMeasureTypeManipulator((S,k)=>{S.available&&wn(S,t,k,M)})}_updateManipulatorStyle(t){const e=On(t),i=At(t),n={lineSizePt:t,material:this._orientationManipulatorMaterial};for(const{offset:a,heading:s,rotation:o}of this._computationManipulators.values())a.radius=i/2,s.update(n),o.update(n);this._unfocusedOffsetManipulatorMaterial.setParameters({width:e}),this._focusedOffsetManipulatorMaterial.setParameters({width:i})}_applyPointUpdate(t,e){const{view:i}=this,n=lt(t);"startPoint"in e&&(n.elevationAlignedStartPoint=e.startPoint),"endPoint"in e&&(n.elevationAlignedEndPoint=e.endPoint);const a=pt(n,i.renderCoordsHelper);if(a==null)return;const s=this._computeConstraint({...n,geometry:a});Ce(t,e,{...n,constraint:s,unconstrainedGeometry:a,view:i}),t===this._stagedComputation&&this._updateStagedDimensionOffset(t)}_updateStagedDimensionOffset(t){if(t.geometry==null)return;t.geometry.directSegment.eval(.5,Kt);const{state:e,renderCoordsHelper:i}=this.view,n=e.camera.computeScreenPixelSizeAt(Kt);t.dimension.offset=an*n*i.unitInMeters}_computeConstraint(t){return Tn(Dn(t,this._ensureSnappingManager().options),this.view)}_createOffsetManipulatorMaterial(t){return new B({width:1,renderOccluded:4,writeDepth:!1,hasPolygonOffset:!0,isDecoration:!0},t.state.isGlobal)}get test(){}};d([u({constructOnly:!0})],y.prototype,"analysis",void 0),d([u({constructOnly:!0})],y.prototype,"analysisViewData",void 0),d([u({constructOnly:!0})],y.prototype,"manipulators",void 0),d([u({constructOnly:!0})],y.prototype,"parentTool",void 0),d([u({constructOnly:!0,nonNullable:!0})],y.prototype,"view",void 0),d([u({readOnly:!0})],y.prototype,"updating",null),d([u()],y.prototype,"firstGrabbedManipulator",null),d([u()],y.prototype,"hasGrabbedManipulators",null),d([u()],y.prototype,"snappingOptions",null),d([u()],y.prototype,"_stagedDimension",void 0),d([u()],y.prototype,"_snappingManager",null),d([u()],y.prototype,"_activeComputation",null),d([u()],y.prototype,"_stagedComputation",null),d([u()],y.prototype,"_snappingManagerResult",void 0),y=d([U("esri.views.3d.analysis.Dimension.LengthDimensionSubTool")],y);const Kt=P();let b=class extends Di{constructor(t){super(t),this.automaticManipulatorSelection=!1,this.removeIncompleteOnCancel=!1,this._placementMode=Wt,this._pointerMoveTimerMs=nn,this._prevPointerMoveTimeout=null}initialize(){this._intersector=Ti(this.view.state.viewingMode),this._lengthDimensionSubTool=new y({analysis:this.analysis,analysisViewData:this.analysisViewData,manipulators:this.manipulators,parentTool:this,view:this.view}),this.addHandles([X(this._lengthDimensionSubTool),Re(()=>this._clearPointerMoveTimeout()),at(()=>this.state==="created",()=>this.finishToolCreation(),D),at(()=>this.firstGrabbedManipulator,t=>{this.selectedDimension=t.metadata},D),v(()=>this.selectedDimension,()=>this._resetPointerMoveTimeout(),D)])}get state(){return this.analysis.dimensions.some(t=>t.type==="length")?this._activeSubTool!=null?"creating":"created":"ready"}get updating(){return this._lengthDimensionSubTool.updating}get cursor(){return this.active?"crosshair":null}get selectedDimension(){return this.analysisViewData.selectedDimension}set selectedDimension(t){this.analysisViewData.selectedDimension=t}place(t){this.selectedDimension=null,this._placementMode=t}onInputEvent(t){switch(t.type){case"immediate-click":this._clickHandler(t);break;case"immediate-double-click":this._doubleClickHandler(t);break;case"pointer-move":this._pointerMoveHandler(t);break;case"key-down":this._keyDownHandler(t)}}onActivate(){this._placementMode=Wt,this._activeSubTool=this._lengthDimensionSubTool}onDeactivate(){this._activeSubTool?.onDeactivate(),this._activeSubTool=null}onShow(){this._resetPointerMoveTimeout()}onManipulatorSelectionChanged(){this._lengthDimensionSubTool.onManipulatorSelectionChanged()}onHide(){this.selectedDimension=null}_clickHandler(t){if(this.hasFocusedManipulators)return void t.stopPropagation();if(this._activeSubTool==null)return;const e=this._intersectScreen(t);e!=null&&(this.selectedDimension=this._activeSubTool.onClick({mapPoint:e,pointerType:t.pointerType}),this.selectedDimension&&this._placementMode==="single"&&(this.view.activeTool=null),t.stopPropagation())}_doubleClickHandler(t){this.active&&(this.view.activeTool=null,t.stopPropagation())}_pointerMoveHandler(t){if(this._resetPointerMoveTimeout(),this._activeSubTool==null||this.hasFocusedManipulators)return;const e=this._intersectScreen(t);e!=null&&this._activeSubTool.onPointerMove({mapPoint:e,pointerType:t.pointerType})}_keyDownHandler(t){zt.cancel===t.key?(this._activeSubTool?.removeStaged()&&this._placementMode==="multiple"&&t.stopPropagation(),this.active||(this.selectedDimension=null)):zt.delete.includes(t.key)&&(this._activeSubTool?.removeStaged(),this._removeSelected())}_intersectScreen(t){const e=$e(t);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(e,this._intersector);const i=this._intersector.results.min,n=f.get();return i.getIntersectionPoint(n)?this.view.renderCoordsHelper.fromRenderCoords(n,new G({spatialReference:this.view.spatialReference})):null}_removeSelected(){this.selectedDimension!=null&&(this.analysis.dimensions.remove(this.selectedDimension),this.selectedDimension=null)}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=Ae(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.manipulators.forEach(t=>t.manipulator.state|=H),this._prevPointerMoveTimeout=He.setTimeout(()=>{this.manipulators.forEach(t=>t.manipulator.state&=~H)},this._pointerMoveTimerMs)}get test(){}};d([u({constructOnly:!0})],b.prototype,"view",void 0),d([u({constructOnly:!0})],b.prototype,"analysis",void 0),d([u({readOnly:!0})],b.prototype,"state",null),d([u({readOnly:!0})],b.prototype,"updating",null),d([u({readOnly:!0})],b.prototype,"cursor",null),d([u({constructOnly:!0})],b.prototype,"analysisViewData",void 0),d([u()],b.prototype,"selectedDimension",null),d([u()],b.prototype,"automaticManipulatorSelection",void 0),d([u()],b.prototype,"_activeSubTool",void 0),d([u()],b.prototype,"_lengthDimensionSubTool",void 0),d([u()],b.prototype,"_placementMode",void 0),b=d([U("esri.views.3d.analysis.Dimension.DimensionTool")],b);const Wt="multiple";class Rn extends ri{constructor(e,i){super(e),this._hasExternalMaterial=!1,this._renderOccluded=4,this._width=1,this._color=ze(1,0,1,1),this._placement="end",this._markerPrimitive="arrow",this._material=i,this._hasExternalMaterial=i!=null,this.applyProperties(e)}setGeometryFromSegment(e,i){const n=e.endRenderSpace;this.transform=je(An,n),this._normal=i;const{points:a}=e.createRenderGeometry(n,this.view.renderCoordsHelper);this.geometry=[a]}get renderOccluded(){return this._material?.parameters.renderOccluded??this._renderOccluded}set renderOccluded(e){this._renderOccluded=e,this._material?.setParameters({renderOccluded:e})}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get normal(){return this._normal}set normal(e){this._normal=e,this.recreateGeometry()}get width(){return this._material?.parameters.width??this._width}set width(e){this._width=e,this._material?.setParameters({width:e})}get color(){return this._material?.parameters.color??this._color}set color(e){this._color=ke(e),this._material?.setParameters({color:this._color})}get placement(){return this._material?.parameters.placement??this._placement}set placement(e){this._placement=e,this._material?.setParameters({placement:this._placement})}get markerPrimitive(){return this._material?.parameters.markerPrimitive??this._markerPrimitive}set markerPrimitive(e){this._markerPrimitive=e,this._material?.setParameters({markerPrimitive:e})}createExternalResources(){this._hasExternalMaterial||(this._material=new de({width:this._width,color:this._color,placement:this._placement,renderOccluded:this._renderOccluded,markerPrimitive:this._markerPrimitive,isDecoration:this.isDecoration},this.view.state.isGlobal))}destroyExternalResources(){this._hasExternalMaterial||(this._material=null)}createGeometries(e){for(const i of Ai(this.geometry,this.normal)){const n=Hi(this._material,i);e.addGeometry(n)}}forEachMaterial(e){this._hasExternalMaterial||e(this._material)}}const An=bt();let Hn=class{set visible(t){for(const e of this._visualElements.values())e.attached=t}constructor(t){this.destroyed=!1,this._handles=new Qt,this._messages=null,this._labelSegment=new V;const{analysis:e,computation:i,view:n,messages:a,isDecoration:s}=t;this.analysis=e,this.computation=i,this.view=n,this._messages=a;const o=t.visible,r={view:n,attached:o,isDecoration:s},{fontSize:l,textColor:p,textBackgroundColor:m}=e.style;this._visualElements=new Ln({marker:new Rn(r,t.markerMaterial),dimension:new L(r,t.dimensionLineMaterial),startOffset:new L(r,t.offsetLineMaterial),endOffset:new L(r,t.offsetLineMaterial),dimensionSmall:new L(r,t.smallDimensionLineMaterial),startOffsetSmall:new L(r,t.smallOffsetLineMaterial),endOffsetSmall:new L(r,t.smallOffsetLineMaterial),label:new Je({view:n,attached:o,distance:0,geometry:{type:"segment",sampleLocation:"center",segment:this._labelSegment,callout:!1},fontSize:T(l),textColor:p.clone(),backgroundColor:m.clone(),isDecoration:s})}),this._handles.add([v(()=>i.geometry,c=>{this.updateCameraDependentElements(n.state.camera,c,e.style),i.geometry!=null&&this._updateLines(i.geometry)},{...Z,equals:gt}),v(()=>i.length,c=>this._updateLabelContent(c),Z)])}destroy(){this.destroyed=!0,this._handles=Pt(this._handles);for(const t of this._visualElements.values())t.destroy()}get testInfo(){}_updateLines(t){const e=Ft(kn,0,t.directSegment,t.dimensionSegment),i=Ft($n,1,t.directSegment,t.dimensionSegment),n=this._visualElements;n.marker.setGeometryFromSegment(t.dimensionSegment,t.primaryOffsetAxis),n.dimension.setGeometryFromSegment(t.dimensionSegment),n.startOffset.setGeometryFromSegment(e),n.endOffset.setGeometryFromSegment(i),n.dimensionSmall.setGeometryFromSegment(t.dimensionSegment),n.startOffsetSmall.setGeometryFromSegment(e),n.endOffsetSmall.setGeometryFromSegment(i)}updateCameraDependentElements(t,e,i){const n=this._visualElements;if(e==null){for(const _ of n.values())_.visible=!1;return}const a=t.computeScreenPixelSizeAt(e.dimensionSegment.eval(.5,Gn)),s=Fi(e,a),o=s<(T(i.lineSize)*sn)**2,r=!o;n.marker.visible=r,n.dimension.visible=r,n.startOffset.visible=r,n.endOffset.visible=r,n.dimensionSmall.visible=o,n.startOffsetSmall.visible=o,n.endOffsetSmall.visible=o;const l=T(i.fontSize)*en,{label:p}=n;if(p.visible=s>=l**2,!p.visible)return;const{dimensionSegment:m,primaryOffsetAxis:c}=e,{offset:h}=this.computation.dimension,g=(Math.sign(h)>=0?1:-1)*zn(i)*a;Gi(this._labelSegment,m,c,g),p.updateLabelPosition()}updateLabelStyle(t){const{label:e}=this._visualElements;e.fontSize=T(t.fontSize),e.textColor=t.textColor,e.backgroundColor=t.textBackgroundColor}updateUnitsMessages(t){this._messages=t;const{length:e}=this.computation;this._updateLabelContent(e)}_updateLabelContent(t){const{label:e}=this._visualElements;t!=null&&this._messages!=null?e.text=Ri(this._messages,t,t.unit):e.text=""}};function zn(t){return 1.5*T(t.fontSize)+tn+T(t.lineSize/2)}const kn=new V,$n=new V,Gn=P();class Ln{constructor(e){this.marker=e.marker,this.dimension=e.dimension,this.startOffset=e.startOffset,this.endOffset=e.endOffset,this.dimensionSmall=e.dimensionSmall,this.startOffsetSmall=e.startOffsetSmall,this.endOffsetSmall=e.endOffsetSmall,this.label=e.label}values(){return[this.marker,this.dimension,this.startOffset,this.endOffset,this.dimensionSmall,this.startOffsetSmall,this.endOffsetSmall,this.label]}}let R=class extends Q{get analysis(){return this.analysisViewData.analysis}get visible(){return this.analysisViewData.visible}constructor(t){super(t),this.loadingMessages=!1,this._messages=null}initialize(){const t=this.isDecoration;this._markerMaterial=new de({width:1,anchor:1,color:j,placement:"begin-end",worldSpace:!0,hideOnShortSegments:!0,hasTip:!0,renderOccluded:4,markerPrimitive:"triangle",isDecoration:t},this.view.state.isGlobal),this._dimensionLineMaterial=new B({width:1,color:j,renderOccluded:4,markerParameters:this._markerMaterial.parameters,isDecoration:t},this.view.state.isGlobal),this._offsetLineMaterial=new B({width:1,color:j,renderOccluded:4,stipplePattern:rt(5),isDecoration:t},this.view.state.isGlobal),this._smallDimensionLineMaterial=new B({width:1,color:j,renderOccluded:4,isDecoration:t},this.view.state.isGlobal),this._smallOffsetLineMaterial=new B({width:1,color:j,renderOccluded:4,stipplePattern:rt(5),isDecoration:t},this.view.state.isGlobal);const e=ut(()=>this.analysisViewData.computations,({computation:i})=>this._createVisualization(i));this._dimensionVisualizations=e,this.addHandles([X(e),v(()=>I.toUnitRGBA(this.analysis.style.color),i=>{for(const n of this._lineMaterials())n.setParameters({color:i})},D),v(()=>this.analysis.style.lineSize,i=>{const n=T(i);this._markerMaterial.setParameters({width:n*ge}),this._dimensionLineMaterial.setParameters({width:n,markerParameters:this._markerMaterial.parameters});const a=Math.max(n*Qi,1);this._offsetLineMaterial.setParameters({width:a})},D),v(()=>({camera:this.view.state.camera,style:En(this.analysis)}),({camera:i,style:n})=>{for(const{visualization:a}of this._dimensionVisualizations)a.updateCameraDependentElements(i,a.computation.geometry,n),a.updateLabelStyle(n)}),v(()=>this.visible,i=>{for(const{visualization:n}of this._dimensionVisualizations)n.visible=i})]),this.addHandles([Ee(()=>this._updateMessageBundle()),at(()=>!this.loadingMessages,()=>{for(const{visualization:i}of this._dimensionVisualizations)i.updateUnitsMessages(this._messages)},vt)]),this._updateMessageBundle()}get testInfo(){}_createVisualization(t){const e=new Hn({analysis:this.analysis,computation:t,view:this.view,visible:this.visible,markerMaterial:this._markerMaterial,dimensionLineMaterial:this._dimensionLineMaterial,offsetLineMaterial:this._offsetLineMaterial,smallDimensionLineMaterial:this._smallDimensionLineMaterial,smallOffsetLineMaterial:this._smallOffsetLineMaterial,messages:this._messages,isDecoration:this.isDecoration});return{visualization:e,remove:()=>e.destroy()}}_lineMaterials(){return[this._markerMaterial,this._dimensionLineMaterial,this._offsetLineMaterial,this._smallDimensionLineMaterial,this._smallOffsetLineMaterial]}async _updateMessageBundle(){this.loadingMessages=!0;try{this._messages=await xi("esri/core/t9n/Units")}finally{this.loadingMessages=!1}}};function En(t){const{fontSize:e,lineSize:i,textColor:n,textBackgroundColor:a}=t.style;return{fontSize:e,lineSize:i,textBackgroundColor:a.clone(),textColor:n.clone()}}d([u({constructOnly:!0})],R.prototype,"analysisViewData",void 0),d([u({constructOnly:!0,nonNullable:!0})],R.prototype,"view",void 0),d([u({constructOnly:!0})],R.prototype,"isDecoration",void 0),d([u()],R.prototype,"analysis",null),d([u()],R.prototype,"visible",null),d([u()],R.prototype,"loadingMessages",void 0),R=d([U("esri.views.3d.analysis.Dimension.DimensionVisualization")],R);let N=class extends Q{constructor(t){super(t),this.dimension=null,this.length=null}};d([u({constructOnly:!0,nonNullable:!0})],N.prototype,"dimension",void 0),d([u()],N.prototype,"length",void 0),N=d([U("esri.views.analysis.LengthDimensionResult")],N);let C=class extends Q{constructor(t){super(t),this.geometry=null,this.unconstrainedGeometry=null,this.elevationAlignedStartPoint=null,this.elevationAlignedEndPoint=null}normalizeCtorArgs(t){const{dimension:e,...i}=t;return{result:new N({dimension:e}),...i}}initialize(){this.addHandles([v(()=>this.dimension.startPoint,t=>this.elevationAlignedStartPoint=this.projectAndAlignPoint(t),D),v(()=>this.dimension.endPoint,t=>this.elevationAlignedEndPoint=this.projectAndAlignPoint(t),D)])}get dimension(){return this.result.dimension}get length(){return this.result.length}};d([u({constructOnly:!0,nonNullable:!0})],C.prototype,"result",void 0),d([u({constructOnly:!0,nonNullable:!0})],C.prototype,"projectAndAlignPoint",void 0),d([u()],C.prototype,"dimension",null),d([u()],C.prototype,"length",null),d([u()],C.prototype,"geometry",void 0),d([u()],C.prototype,"unconstrainedGeometry",void 0),d([u()],C.prototype,"elevationAlignedStartPoint",void 0),d([u()],C.prototype,"elevationAlignedEndPoint",void 0),d([u()],C.prototype,"preConstraintProperties",void 0),d([u()],C.prototype,"previousConstraint",void 0),C=d([U("esri.views.3d.analysis.Dimension.LengthDimensionComputation")],C);let w=class extends Le{constructor(t){super(t),this.type="dimension-view-3d",this.analysis=null,this.tool=null,this.selectedDimension=null,this.userOperation=null,this._dimensionsToComputations=new Map,this._projectAndAlignPoint=null}initialize(){this._projectAndAlignPoint=e=>{if(e==null)return null;const{spatialReference:i,elevationProvider:n}=this.view,a=si(e,i,n);return a==null&&oi(this.analysis,e.spatialReference,Xt.getLogger(this)),a};const t=ut(()=>this.analysis.dimensions,e=>this._createComputation(e));this.computations=t,this.addHandles([Ci(this,b),X(t)]),this._analysisVisualization=new R({analysisViewData:this,view:this.view,isDecoration:!this.parent}),this.addResolvingPromise(zi().then(e=>{this._analysisController=new $({analysisViewData:this,view:this.view,automaticLengthMeasurementUtils:e})}))}destroy(){this.userOperation=Oe(this.userOperation),Oi(this),this._analysisVisualization=Pt(this._analysisVisualization)}get visible(){return super.visible}set visible(t){super.visible=t}get interactive(){return super.interactive}set interactive(t){super.interactive=t}get updating(){return this._analysisVisualization?.loadingMessages??!1}get results(){return this.analysis.dimensions.map(t=>this._dimensionsToComputations.get(t).result)}get selectedComputation(){const{selectedDimension:t}=this;return t==null?null:this._dimensionsToComputations.get(t)}get testInfo(){}async createLengthDimensions(t){this.selectedDimension=null,await Ut(this,{placementOptions:t,onToolActivated:e=>e.place("multiple")})}place(t){return this.selectedDimension=null,Ut(this,{placementOptions:t,onToolActivated:e=>e.place("single")})}_createComputation(t){const{_dimensionsToComputations:e}=this,i=new C({dimension:t,projectAndAlignPoint:this._projectAndAlignPoint});return e.set(t,i),{computation:i,remove:()=>this._removeComputation(i)}}_removeComputation(t){const{dimension:e}=t;e===this.selectedDimension&&(this.selectedDimension=null),this._dimensionsToComputations.delete(e),t.destroy()}};d([u({readOnly:!0})],w.prototype,"type",void 0),d([u({constructOnly:!0,nonNullable:!0})],w.prototype,"analysis",void 0),d([u()],w.prototype,"tool",void 0),d([u()],w.prototype,"updating",null),d([u({readOnly:!0})],w.prototype,"results",null),d([u()],w.prototype,"computations",void 0),d([u()],w.prototype,"selectedDimension",void 0),d([u()],w.prototype,"selectedComputation",null),d([u()],w.prototype,"userOperation",void 0),d([u()],w.prototype,"_analysisVisualization",void 0),d([u()],w.prototype,"_analysisController",void 0),d([u()],w.prototype,"_dimensionsToComputations",void 0),w=d([U("esri.views.3d.analysis.DimensionAnalysisView3D")],w);const hr=w;export{hr as default};
