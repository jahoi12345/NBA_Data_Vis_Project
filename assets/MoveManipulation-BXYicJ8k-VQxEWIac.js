import{b as O,$ as P,l as tt,c as Y,i as z,s as at}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{s as et,j,o as G,I as K}from"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import{B as D,e as p,q as b}from"./ShadedColorMaterial.glsl-Cdsx30m0-BzzDoTK3.js";import{F as L}from"./Color-CERqXxxY-BuYn26eI.js";import{e as I,o as H,M as it,E as T,h as st,L as nt,a as rt}from"./mat4-C96X-Nn0-BrMLOLCb.js";import{n as $}from"./mat4f64-q_b6UJoq-Dh6sWB_w.js";import{L as E,f as ot,$ as lt,l as q,A as ut,F as B,k as ht}from"./vec32-CewSdTn3-VRto2OOh.js";import{M as _,t as F}from"./collectionUtils-jDyktm0P-BDP2Oq99.js";import{z as S,C as f}from"./vector-B8ZDYGQ6-DRILJdcx.js";import{O as k,f as ct}from"./dragEventPipeline3D-DqqdeG4y-VV3Rp8Vu.js";import{J as R,P as pt,V as dt,v as _t,r as W,K as Mt,i as C}from"./InteractiveToolBase-DXh7kfgV-B5EAl8tr.js";import{p as mt,A as ft,y as gt,q as vt,r as wt}from"./RealisticTree.glsl-WN9nrQUl-QZiY3aPA.js";import{V as J}from"./ColorMaterial.glsl-rhi0cQVb-DVm6kWLC.js";import{B as yt}from"./elevationInfoUtils-B8MpdRMP-CDlK86wO.js";import{o as xt}from"./colorUtils-CeIi7j7j-C2WVx6th.js";import{s as bt}from"./mathUtils-PIGhLnI9-B1tKUlUb.js";import{i as Et}from"./settings-CtLiSuVx-BZX89kPd.js";let A=class{constructor(){this._available=!0}set location(a){this._forEachManipulator3D(t=>t.location=a)}set elevationAlignedLocation(a){this._forEachManipulator3D(t=>t.elevationAlignedLocation=a)}set elevationInfo(a){this._forEachManipulator3D(t=>t.elevationInfo=a)}get renderLocation(){let a;return this._forEachManipulator3D(t=>{a||(a=t.renderLocation)}),a}set renderLocation(a){this._forEachManipulator3D(t=>t.renderLocation=a)}get available(){return this._available}set available(a){this._available=a,this._forEachManipulator3D(t=>t.available=a)}get hovering(){return this.someManipulator(a=>a.hovering)}get grabbing(){return this.someManipulator(a=>a.grabbing)}get dragging(){return this.someManipulator(a=>a.dragging)}get selected(){return this.someManipulator(a=>a.selected)}hasManipulator(a){return this.someManipulator(t=>t===a)}someManipulator(a){let t=!1;return this.forEachManipulator(e=>{!t&&a(e)&&(t=!0)}),t}_forEachManipulator3D(a){this.forEachManipulator((t,e)=>{t instanceof D&&a(t,e)})}},St=class extends A{constructor(){super(...arguments),this._interactive=!0}get interactive(){return this._interactive}set interactive(a){this._interactive!==a&&(this._interactive=a),this._updateManipulatorInteractivity()}_updateManipulatorInteractivity(){const a=!this.grabbing&&this._interactive;this.forEachManipulator(t=>{t.interactive=a||t.grabbing})}};const Dt=128,M=70,At=80,N=.02,Tt=54,Pt=100,It=Math.ceil(M/3*2),Q=160,ta=.5,aa=24,ea=9,ia=Q+30,sa=Q+53,na=60,ra=23,oa=5*Math.PI/12,la=1*Math.PI/3,ua=10,ha=.2,ca=30,pa=53,da=.2,_a=.3,Ma=200,ma=3,fa=1e6;function U(a,t,e){const s=(i,n)=>{t({action:i,object:a,dxScreen:n.screenDeltaX,dyScreen:n.screenDeltaY})};return e((i,n,o)=>(n.next(r=>(r.action==="start"&&s("start",r),r)).next(pt(a)).next(r=>{switch(r.action){case"start":case"update":(r.translationX||r.translationY||r.translationZ)&&s("update",r);break;case"end":s("end",r)}return r}),{steps:n,cancel:o=o.next(dt(a)).next(r=>(s("end",{screenDeltaX:0,screenDeltaY:0}),r))}))}function ga(a){if(a?.axis==null)return 1;const{mapStart:t,mapEnd:e,axis:s}=a,i=[e.x-t.x,e.y-t.y];return i[0]*s[0]+i[1]*s[1]>0?1:-1}let Ot=class extends A{constructor(a){super(),this._handles=new O,this._arrowManipulatorInfos=new Array,this._angle=0,this._scale=1,this._radius=M,this._updateAfterDrag=!1,this.events=new K,this._tool=a.tool,this._view=a.view,this._opaqueMaterial=this._createMaterial(),this._transparentMaterial=this._createMaterial(.5),a.radius!=null&&(this._radius=a.radius),this._createManipulators(),this.forEachManipulator(t=>this._tool.manipulators.add(t))}set orthogonalAvailable(a){this._arrowManipulatorInfos.length>=3&&(this._arrowManipulatorInfos[1].manipulator.available=a,this._arrowManipulatorInfos[3].manipulator.available=a)}destroy(){this._handles=Y(this._handles),this.forEachManipulator(a=>{this._tool.manipulators.remove(a),a.destroy()}),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0}forEachManipulator(a){for(const{manipulator:t}of this._arrowManipulatorInfos)a(t,1)}createManipulatedObjectDragPipeline(a,t,e){if(!t.operations)return z();const s=t.operations.data.spatialReference,i=t.graphic;return U(t,e,n=>this.createDragPipeline((o,r,l,u,h)=>({steps:r,cancel:l}=a(o,r,l,u,h),n(o,r,l)),t.elevationInfo,s,i))}createDragPipeline(a,t,e,s){return P(this._arrowManipulatorInfos.map(({manipulator:i},n)=>R(i,(o,r,l,u,h)=>{const c=r.next(d=>({...d,manipulatorType:1})).next(W(this._view,o.elevationAlignedLocation)).next(k(this._view,o.elevationAlignedLocation,t,e,s)).next(Mt(o.location,this.angle+(n+1)*Math.PI*.5)).next(C());a(o,c,l,u,h)})))}get angle(){return this._angle}set angle(a){this._angle=a,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}get displayScale(){return this._scale}set displayScale(a){this._scale=a,this._updateManipulatorTransform()}get radius(){return this._radius}set radius(a){this._radius!==a&&(this._radius=a,this._updateManipulators())}_updateManipulators(){for(let a=0;a<this._arrowManipulatorInfos.length;a++)this._updateArrowManipulator(this._arrowManipulatorInfos[a],a);this._updateManipulatorTransform()}_updateArrowManipulator({manipulator:a,transform:t},e){const s=this._radius/M,i=Tt*s,n=i*Math.sqrt(3)/2,o=ft(this._opaqueMaterial,n,i/2,i/2,N);gt(o,H(f.get(),E(S.get(),0,-n/3,0))),a.renderObjects=[new p(o,2),new p(o.instantiate({material:this._transparentMaterial}),1)],a.radius=n/3*2*1.2;const r=it(f.get(),e*Math.PI/2),l=H(f.get(),E(S.get(),0,Pt*s,0));T(t,r,l)}_createManipulators(){for(let a=0;a<4;a++){const t=this._createArrowManipulator(a);this._arrowManipulatorInfos.push(t)}this._updateManipulatorTransform()}_updateManipulatorTransform(){const a=this.angle,t=st(f.get(),a,_(0,0,1));if(t==null)return;const e=I(f.get(),E(S.get(),this.displayScale,this.displayScale,this.displayScale)),s=T(f.get(),e,t);for(const i of this._arrowManipulatorInfos){const n=T(f.get(),s,i.transform);i.manipulator.modelTransform=n}}_createArrowManipulator(a){const t=new D({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:_(0,0,1)}}),e={manipulator:t,transform:$()};return this._updateArrowManipulator(e,a),this._handles.add(t.events.on("drag",s=>{this._updateAfterDrag&&s.action==="end"&&!this.dragging&&(this._updateManipulatorTransform(),this._updateAfterDrag=!1)})),e}_createMaterial(a=1){const t=new J({cullFace:2,renderOccluded:2,isDecoration:!0});return this._handles.add(j(()=>L.toUnitRGBA(this._view.effectiveTheme.accentColor),e=>{e[3]*=a,t.setParameters({color:e})},G)),t}get test(){}};class zt{constructor(){this._view=null,this._elevationInfo=null,this._lastDragEvent=null,this._next=null,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&this._lastDragEvent!=null&&this._next!=null){const e=this._lastDragEvent.mapEnd,s=this._snap(this._lastDragEvent.screenEnd);if(s!=null){const i={action:"update",mapStart:this._lastDragEvent.mapStart,mapEnd:t===!0?s:e,screenStart:this._lastDragEvent.screenEnd,screenEnd:this._lastDragEvent.screenEnd};this._next.execute(i)}}this._enabled=t}_snap(t){const e=this._view!=null?this._view.toMap(t,{exclude:[]}):null;return e!=null&&this._view!=null&&(e.z=yt(e,this._view,this._elevationInfo)),e}createDragEventPipelineStep(t,e){this._view=t,this._elevationInfo=e,this._lastDragEvent=null;const s=new _t;return this._next=s,[i=>{if(this._lastDragEvent=i.action!=="end"?{...i}:null,this._enabled){const n=this._snap(i.screenEnd);return n!=null?{action:i.action,mapStart:i.mapStart,mapEnd:n,screenStart:i.screenStart,screenEnd:i.screenEnd}:null}return{action:i.action,mapStart:i.mapStart,mapEnd:i.mapEnd,screenStart:i.screenStart,screenEnd:i.screenEnd}},s]}}let jt=class extends A{constructor(a){super(),this._handles=new O,this._snapToScene=new zt,this._scale=1,this._radius=M,this._view=a.view,this._tool=a.tool,this._discMaterial=this._createMaterial(),this._discMaterialTransparent=this._createMaterial(.5),a.snapToScene!=null&&(this.snapToScene=a.snapToScene),a.radius!=null&&(this._radius=a.radius),this._createManipulator(),this.forEachManipulator(t=>this._tool.manipulators.add(t))}destroy(){this._handles=Y(this._handles),this.forEachManipulator(a=>{this._tool.manipulators.remove(a),a.destroy()}),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(a){a(this._manipulator,1)}get displayScale(){return this._scale}set displayScale(a){this._scale=a,this._updateManipulatorTransform()}get snapToScene(){return this._snapToScene.enabled}set snapToScene(a){this._snapToScene.enabled=a}get radius(){return this._radius}set radius(a){a!==this._radius&&(this._radius=a,this._updateManipulator())}get discManipulator(){return this._manipulator}createManipulatedObjectDragPipeline(a,t,e){if(!t.operations)return z();const s=t.graphic,i=t.elevationInfo,n=t.operations.data.spatialReference;return U(t,e,o=>this.createDragPipeline((r,l,u,h,c)=>({steps:l,cancel:u}=a(r,l,u,h,c),o(r,l,u)),i,n,s))}createDragPipeline(a,t,e,s){const i=this._view;return R(this._manipulator,(n,o,r,l,u)=>{const h=o.next(W(i,n.elevationAlignedLocation)).next(k(i,n.elevationAlignedLocation,t,e,s)).next(...this._snapToScene.createDragEventPipelineStep(i,t)).next(c=>({...c,manipulatorType:1})).next(C());a(n,h,r,l,u)})}_updateManipulatorTransform(){const a=I(f.get(),E(S.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=a}_createManipulator(){const a=this._view;this._manipulator=new D({view:a,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:_(0,0,1)},worldOriented:!0}),this._updateManipulator()}_updateManipulator(){const a=mt(this._discMaterial,N,1,Dt,_(0,0,1),_(0,0,0));a.transformation=I($(),_(this._radius,this._radius,this._radius)),this._manipulator.renderObjects=[new p(a,2),new p(a.instantiate({material:this._discMaterialTransparent}),1)],this._manipulator.radius=At*(this._radius/M)}_createMaterial(a=1){const t=new J({cullFace:2,renderOccluded:2,isDecoration:!0});return this._handles.add(j(()=>L.toUnitRGBA(this._view.effectiveTheme.accentColor),e=>{e[3]*=a,t.setParameters({color:e})},G)),t}get test(){}};class Lt extends A{constructor(t){super(),this._radius=M,this.events=new K,this._tool=t.tool,this._view=t.view;const e=new Et({getTheme:()=>this._view.effectiveTheme});this._settings=e,t.radius!=null&&(this._radius=t.radius);const s=this._view.effectiveTheme.accentColor;this._materials={materialUnfocused:b(m(s,1,.25),1),materialFocused:b(m(s,1,0),1),materialOccludedUnfocused:b(m(s,.7,0),e.zManipulator.renderOccluded),materialOccludedFocused:b(m(s,.85,0),e.zManipulator.renderOccluded)},this._themeHandle=j(()=>this._view.effectiveTheme.accentColor,i=>{const n=m(i,1,.25),o=m(i,1,0),r=m(i,.7,0),l=m(i,.85,0),{materialUnfocused:u,materialFocused:h,materialOccludedUnfocused:c,materialOccludedFocused:d}=this._materials;u.setParameters({color:n}),h.setParameters({color:o}),c.setParameters({color:r}),d.setParameters({color:l})}),this._createManipulator(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this._themeHandle=at(this._themeHandle),this._manipulator.applyObjectTransform=Ft,this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()})}forEachManipulator(t){t(this._manipulator,0)}createManipulatedObjectDragPipeline(t,e,s){if(!e.operations)return z();const i=e.operations.data.spatialReference;return U(e,s,n=>this.createDragPipeline((o,r,l,u,h)=>({steps:r,cancel:l}=t(o,r,l,u,h),n(o,r,l)),i))}createDragPipeline(t,e){const s=this._view;return R(this._manipulator,(i,n,o,r,l)=>{const u=n.next(h=>({...h,manipulatorType:0})).next(ct(s,i.renderLocation,e)).next(C());t(i,u,o,r,l)})}get radius(){return this._radius}set radius(t){t!==this._radius&&(this._radius=t,this._updateManipulator())}_updateManipulator(){const t=this._settings,e=this._radius/M,s=t.zManipulator.height*e,i=t.zManipulator.coneHeight*e,n=t.zManipulator.coneWidth*e,o=t.zManipulator.width*e,r=[_(0,0,0),_(0,0,s)],l=[_(0,0,0),_(0,0,s+i)],u=(()=>{const v=$();return nt(v,v,[0,0,s]),rt(v,v,Math.PI/2),v})(),{materialUnfocused:h,materialFocused:c,materialOccludedUnfocused:d,materialOccludedFocused:w}=this._materials,y=vt(h,r,o/2,16,!1),g=wt(h,i,n/2,16,!1);g.transformation=u,this._manipulator.renderObjects=[new p(g,1),new p(y,1),new p(g.instantiate({material:c}),2),new p(y.instantiate({material:c}),2),new p(g.instantiate({material:d}),1),new p(y.instantiate({material:d}),1),new p(g.instantiate({material:w}),2),new p(y.instantiate({material:w}),2)],this._manipulator.radius=o/2+2,this._manipulator.collisionType={type:"line",paths:[l]}}_createManipulator(){const t=this._view,e=new D({view:t,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});e.applyObjectTransform=s=>{const i=t.state.camera,n=X;t.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,n);const o=ot(i.eye,n),r=i.computeRenderPixelSizeAtDist(o),l=lt(x,n,i.eye);q(l,l);const u=$t;t.renderCoordsHelper.worldUpAtPosition(X,u);const h=Math.abs(ut(l,u)),c=B(x,l,u),d=B(x,c,u),w=bt(h,.01,1),y=1-Math.sqrt(1-w*w)/w/i.fullWidth,g=this._settings,v=this._radius/M,Z=g.zManipulator.width*v;ht(d,q(d,d),(1/y-1)*o+r*Z),s[12]-=x[0],s[13]-=x[1],s[14]-=x[2]},this._manipulator=e,this._updateManipulator()}get test(){}}function m(a,t,e){const s=xt(a,e);return s.a*=t,L.toUnitRGBA(s)}const X=F(),x=F(),$t=F(),Ft=()=>{};class va extends St{constructor(t){super(),this._handles=new O;const{tool:e,view:s,snapToScene:i,radius:n}=t;this._view=s,this.xyManipulation=new jt({tool:e,view:s,snapToScene:i,radius:n}),this.xyAxisManipulation=new Ot({tool:e,view:s,radius:n}),this.zManipulation=new Lt({tool:e,view:s,radius:n}),this.xyManipulation.available=t.xyAvailable,this.xyAxisManipulation.available=t.xyAxisAvailable,this.zManipulation.available=t.zAvailable,this._autoHideXYAxis(),this.forEachManipulator(o=>this._handles.add(o.events.on("grab-changed",()=>this._updateManipulatorInteractivity())))}destroy(){this._handles.destroy(),this.xyManipulation.destroy(),this.xyAxisManipulation.destroy(),this.zManipulation.destroy()}createManipulatedObjectDragPipeline(t,e,s){return P([this.xyManipulation.createManipulatedObjectDragPipeline((i,n,o,r,l)=>t(0,i,n,o,r,l),e,s),this.xyAxisManipulation.createManipulatedObjectDragPipeline((i,n,o,r,l)=>t(1,i,n,o,r,l),e,s),this.zManipulation.createManipulatedObjectDragPipeline((i,n,o,r,l)=>t(2,i,n,o,r,l),e,s)])}createDragPipeline(t,e,s,i){return P([this.xyManipulation.createDragPipeline((n,o,r,l,u)=>t(0,n,o,r,l,u),e,s,i),this.xyAxisManipulation.createDragPipeline((n,o,r,l,u)=>t(1,n,o,r,l,u),e,s,i),this.zManipulation.createDragPipeline((n,o,r,l,u)=>t(2,n,o,r,l,u),s)])}set snapToScene(t){this.xyManipulation.snapToScene=t}set angle(t){this.xyAxisManipulation.angle=t}set radius(t){this.xyAxisManipulation.radius=t,this.xyManipulation.radius=t,this.zManipulation.radius=t}set displayScale(t){this.xyManipulation.displayScale=t,this.xyAxisManipulation.displayScale=t}forEachManipulator(t){this.xyManipulation.forEachManipulator(e=>t(e,1)),this.xyAxisManipulation.forEachManipulator(e=>t(e,1)),this.zManipulation.forEachManipulator(e=>t(e,0))}get _xyAxisVisible(){const t=this.xyManipulation.someManipulator(e=>e.focused)||this.xyAxisManipulation.someManipulator(e=>e.focused);return this._view.inputManager&&this._view.inputManager.latestPointerInfo?.type==="touch"||t}_autoHideXYAxis(){const t=this.xyAxisManipulation,e=this.xyManipulation;if(tt("esri-mobile"))return;const s=[];e.forEachManipulator(n=>s.push(n)),t.forEachManipulator(n=>s.push(n));const i=()=>{const n=[];this._xyAxisVisible||t.forEachManipulator(o=>n.push(o.disableDisplay())),this._handles.remove(V),this._handles.add(n,V)};for(const n of s)this._handles.add(n.events.on("focus-changed",i));this._view.inputManager&&this._handles.add(et(()=>this._view.inputManager?.latestPointerInfo?.type,i)),i()}static radiusForSymbol(t){const e=t!=null&&t.type==="point-3d"&&t.symbolLayers;return e&&e.some(s=>s.type==="icon")?It:M}}const V="disable-xy-axis-display";export{St as $,U as C,Dt as D,_a as M,Q as N,A as S,It as T,pa as _,da as a,va as b,la as c,ca as d,ta as e,Ma as f,ma as g,ua as h,aa as i,ra as l,M as m,ia as n,na as o,ha as p,sa as r,ea as s,oa as u,fa as v,ga as w};
