const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/RealisticTree.glsl-WN9nrQUl-CRRcYwOn.js","assets/mathUtils-PIGhLnI9-B1tKUlUb.js","assets/Polygon-D6wEPb3W-CpL9Efjx.js","assets/jsonMap-Bs3hmeCU-Cusd0Fmz.js","assets/Extent-CgDMOSRD-CU1qE5Kr.js","assets/Point-BfTTZoMu-BAT2Wq6O.js","assets/index-CTl7hdrJ.js","assets/index-Cv2ko1Ob.css","assets/reader-DcGs6kKN-DHJfK-tm.js","assets/aaBoundingRect-CjwcS2F3-D7aII9DY.js","assets/mat4-C96X-Nn0-Do6fKsNS.js","assets/collectionUtils-jDyktm0P-ArdXNs6F.js","assets/reactiveUtils-SO2Ko3sy-BCLX8Jdy.js","assets/SimpleObservable-CvFyr0NA-DXpoMYph.js","assets/mat4f64-q_b6UJoq-Dh6sWB_w.js","assets/vec2f64-rIxtbMRN-Kai9mK1i.js","assets/vec32-CewSdTn3-DHOFKD0R.js","assets/vec4f64-DPb6J-GU-C7c2DqbZ.js","assets/BufferView-Cj2sQaht-DuP-iLZg.js","assets/vec42-B8VM4vXb-BnA9MysM.js","assets/Emissions.glsl-B8XKMjLy-DXfiRNVX.js","assets/Color-CERqXxxY-BuYn26eI.js","assets/InterleavedLayout-B7roQAzV-CC2VYRPC.js","assets/types-BKo2foNY-DE0QfIFp.js","assets/enums-B4pqBiXb-BO-3hS_8.js","assets/VertexElementDescriptor-BlxU8vCE-BwuKQkTU.js","assets/projectionUtils-BGH_5_I3-BySNUA-B.js","assets/Polyline-CoiTLswR-BLagWJLS.js","assets/aaBoundingBox-Cn49X7ge-DORLZxoS.js","assets/DoubleArray-DExKNiTh-CvVpHySW.js","assets/meshVertexSpaceUtils-CtG7DPVT-V_uCtHpB.js","assets/MeshLocalVertexSpace-BGd1IdEs-DqCdtROz.js","assets/projectVectorToVector-Csv3NYZI-BsIKHfQD.js","assets/projectPointToVector-DL7Z4uvb-BbcUuq8O.js","assets/Graphic-DgGzDmqW-CFzg0c4i.js","assets/getPopupProvider-CmskPttI-C4PqyuPF.js","assets/lengthUtils-Dt1_RvOO-bleznLOi.js","assets/date-IqUzANpt-bLKO9IDT.js","assets/Layer-DZvC7bne-m1cEC_yw.js","assets/jsonUtils-CmpazY1u-ateEpj4Q.js","assets/typeUtils-DqrRcjBx-ZWdHcSIJ.js","assets/createFeatureId-CVwTD0fV-3fKpJDrk.js","assets/typeUtils-CXW_VpOn-BoSnXkME.js","assets/lineMarkers-CDwLe3J6-CNUjJvs3.js","assets/PolygonSymbol3D-BXRHZiCQ-Vi0-2Gvc.js","assets/ExtrudeSymbol3DLayer-DSc1ou2x-CsVYZCeG.js","assets/screenUtils-BitdhK1O-L0FLPAMi.js","assets/opacityUtils-DuFH0EC9-DWspTgn2.js","assets/Font-BwmnW7d2-D-oIm_Md.js","assets/SimpleFillSymbol-CDawtd9z-CWD2KI2D.js","assets/SimpleMarkerSymbol-BGAFRS9_-CVQ5NLIA.js","assets/PictureMarkerSymbol-CaSh-vZk-BNpExnAb.js","assets/TextSymbol-hRGhyDHs-C0NgASym.js","assets/vec3f32-WCVSSNPR-9V6Uhrx-.js","assets/Indices-D0_UQPPr-t1Qev6md.js","assets/plane-BNdSPG2o-Cq7jmU6w.js","assets/vector-B8ZDYGQ6-B1uNywRb.js","assets/quatf64-CCm9z-pX-CQ7_sSji.js","assets/sphere-DLQ6p7mp-DmnRpHXV.js","assets/orientedBoundingBox-BLEx7wLU-CPBtS4XC.js","assets/quat-B7J5v7rV-i-DOMCm_.js","assets/spatialReferenceEllipsoidUtils-D2JabnKt-Cip58jmo.js","assets/computeTranslationToOriginAndRotation-Bjd4esRf-CXUng2L4.js","assets/memoryEstimations-Bd726a_p-0cVCY2Jz.js","assets/HUDIntersectorResult-1xTExS7z-CU1-YQoW.js","assets/Intersector-DS9YtyQY-CuzM48xl.js","assets/frustum-CMzahy3--CFytpSYl.js","assets/Cyclical-BLSxUpe7-Bj8R2Yk-.js","assets/normalizeUtils-85zLqeMi-DCF9gKvo.js","assets/normalizeUtilsCommon-CnhQye_A-zWtr51r8.js","assets/utils-CylVuxNi-CqOfmBVG.js","assets/utils-Dpg4yj1D-BVnuoMV8.js","assets/videoUtils-Dwx3AEgj-CduhpDRk.js"])))=>i.map(i=>d[i]);
import{H as Ai,_ as Oi}from"./index-CTl7hdrJ.js";import{s as cr,j as Rl,n as ae}from"./mat4f64-q_b6UJoq-Dh6sWB_w.js";import{V as Pe,O as pe,L as G,k as q,f as Fl,J as ur,y as Fs,$ as ce,v as pn,I as Y,c as We,h as Xe,A as we,d as ca,m as ds,x as te,F as Fe,l as Te,i as mn,W as Pl,w as qe,B as gn}from"./vec32-CewSdTn3-DHOFKD0R.js";import{h as Al,U as Ol}from"./Indices-D0_UQPPr-t1Qev6md.js";import{j as Cr,q as Er,I as X,bs as Ir,v as bt,x as Dl,o as hr,w as zl,bt as xi,bu as vn,bv as Nl,bw as Ll,l as Rr,bf as Si,bx as Vl,m as Bl,z as dr,by as $l,bz as vi,at as jl,a5 as Hl,S as Ul,ar as Gl,aO as rt,az as _n,bA as Wl,bB as kl,a7 as ql,ah as Bi,aq as Et,N as Xl,s as Yl,U as Ps,Y as f,H as x,G as Nt,K as Zl}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{a as W,E as Jl,m as ir,_ as ri,F as fr,V as ua,c as Kl,d as Ql,Y as ha,t as da,L as ec,e as tc}from"./BufferView-Cj2sQaht-DuP-iLZg.js";import{t as g,e as ot,Z as Ci,M as ve,X as yi,o as fa,m as $i,y as Ei,Y as ic,b as rc}from"./collectionUtils-jDyktm0P-ArdXNs6F.js";import{x as mt,q as sc,f as ac,y as Fr,h as xn,Q as yn,b as bn,G as nc,T as wn,A as oc,j as lc,e as Tn}from"./sphere-DLQ6p7mp-DmnRpHXV.js";import{N as Mn,S as cc,U as Sn,g as uc,$ as hc,V as dc,_ as fc,D as pc,F as mc,O as gc,e as vc,x as _c,P as Cn}from"./frustum-CMzahy3--CFytpSYl.js";import{F as xc}from"./vector-B8ZDYGQ6-B1uNywRb.js";import{n as h,A as ue,V as Ne,u as ie,I as Gr,w as rr,l as Ot,P as yc,m as U,W as bc,U as En,z as kt,y as xt,C as Ie,R as pr,M as In,G as wc}from"./Emissions.glsl-B8XKMjLy-DXfiRNVX.js";import{m as ge,s as Ve,B as lt,S as Di,y as _e,A as mr}from"./mathUtils-PIGhLnI9-B1tKUlUb.js";import{O as gr,H as K,R as Ee,N as fs,E as Tc,_ as F,S as vr,T as bi,G as Mc,B as Sc,P as Cc,C as Wr,D as kr,U as Ec}from"./enums-B4pqBiXb-BO-3hS_8.js";import{u as Ic,l as Rc,a as Fc}from"./aaBoundingBox-Cn49X7ge-DORLZxoS.js";import{a as wt,aF as Pc,aq as Ac,aA as Oc,P as ps,F as Dt,E as Rn,$ as Dc,M as zc,C as Fn,e as Pn,ar as Nc,D as Lc,a0 as ni}from"./Polygon-D6wEPb3W-CpL9Efjx.js";import{z as sr,G as ms,k as ei,E as Ii,q as Vc,D as Bc,R as $c,C as jc,U as Hc,L as _r,h as Uc,W as Gc,M as Wc,a as An,Y as kc,_ as On,j as Dn,s as qc,t as Xc}from"./mat4-C96X-Nn0-Do6fKsNS.js";import{d as Yc,e as Zc}from"./orientedBoundingBox-BLEx7wLU-CPBtS4XC.js";import{o as nt,e as gs,c as Jc}from"./vec4f64-DPb6J-GU-C7c2DqbZ.js";import{p as As,n as vs}from"./InterleavedLayout-B7roQAzV-CC2VYRPC.js";import{I as zn,j as Nn,o as Kc}from"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import{X as pa,K as ma,$ as Qc,b as ga,f as eu,U as tu,C as iu,x as ru}from"./plane-BNdSPG2o-Cq7jmU6w.js";import{a as su,g as au,l as nu}from"./screenUtils-BitdhK1O-L0FLPAMi.js";import{S as va,I as _a,V as qr,_ as qt,q as xa,P as ji,z as Ce,g as ou}from"./vec42-B8VM4vXb-BnA9MysM.js";import{f as Os,Q as lu,J as Vt,V as ya}from"./lengthUtils-Dt1_RvOO-bleznLOi.js";import{r as Ln,o as zi,a as ba,O as cu}from"./vec2f64-rIxtbMRN-Kai9mK1i.js";import{l as uu,M as hu}from"./Cyclical-BLSxUpe7-Bj8R2Yk-.js";import{Z as wa,M as du,br as fu,a5 as Ni,f as Vn,ar as pu,b as gt,H as mu,F as gu,an as vu,s as Xr}from"./Point-BfTTZoMu-BAT2Wq6O.js";import{u as _u}from"./reader-DcGs6kKN-DHJfK-tm.js";import"./projectionUtils-BGH_5_I3-BySNUA-B.js";import{l as _s}from"./projectPointToVector-DL7Z4uvb-BbcUuq8O.js";import{x as xr}from"./projectVectorToVector-Csv3NYZI-BsIKHfQD.js";import{J as xu}from"./aaBoundingRect-CjwcS2F3-D7aII9DY.js";import{k as yu,T as xs,v as ar}from"./HUDIntersectorResult-1xTExS7z-CU1-YQoW.js";import{z as Ds}from"./Extent-CgDMOSRD-CU1qE5Kr.js";import{$ as bu}from"./normalizeUtils-85zLqeMi-DCF9gKvo.js";import{h as si,u as Bn,c as wu}from"./VertexElementDescriptor-BlxU8vCE-BwuKQkTU.js";import{v as Tu}from"./Color-CERqXxxY-BuYn26eI.js";import{i as Mu}from"./videoUtils-Dwx3AEgj-CduhpDRk.js";const Li=(e,t=Li,i=t.f||(t.f=["assets/RealisticTree.glsl-WN9nrQUl.js","assets/mathUtils-PIGhLnI9.js","assets/Polygon-D6wEPb3W.js","assets/jsonMap-Bs3hmeCU.js","assets/Extent-CgDMOSRD.js","assets/Point-BfTTZoMu.js","assets/reader-DcGs6kKN.js","assets/index-BzxsWNRw.js","assets/index-Cv2ko1Ob.css","assets/aaBoundingRect-CjwcS2F3.js","assets/mat4-C96X-Nn0.js","assets/collectionUtils-jDyktm0P.js","assets/reactiveUtils-SO2Ko3sy.js","assets/SimpleObservable-CvFyr0NA.js","assets/mat4f64-q_b6UJoq.js","assets/vec2f64-rIxtbMRN.js","assets/vec32-CewSdTn3.js","assets/vec4f64-DPb6J-GU.js","assets/BufferView-Cj2sQaht.js","assets/vec42-B8VM4vXb.js","assets/Emissions.glsl-B8XKMjLy.js","assets/Color-CERqXxxY.js","assets/InterleavedLayout-B7roQAzV.js","assets/types-BKo2foNY.js","assets/enums-B4pqBiXb.js","assets/VertexElementDescriptor-BlxU8vCE.js","assets/projectionUtils-BGH_5_I3.js","assets/Polyline-CoiTLswR.js","assets/aaBoundingBox-Cn49X7ge.js","assets/DoubleArray-DExKNiTh.js","assets/meshVertexSpaceUtils-CtG7DPVT.js","assets/MeshLocalVertexSpace-BGd1IdEs.js","assets/projectVectorToVector-Csv3NYZI.js","assets/projectPointToVector-DL7Z4uvb.js","assets/Graphic-DgGzDmqW.js","assets/getPopupProvider-CmskPttI.js","assets/lengthUtils-Dt1_RvOO.js","assets/date-IqUzANpt.js","assets/Layer-DZvC7bne.js","assets/jsonUtils-CmpazY1u.js","assets/typeUtils-DqrRcjBx.js","assets/createFeatureId-CVwTD0fV.js","assets/typeUtils-CXW_VpOn.js","assets/lineMarkers-CDwLe3J6.js","assets/PolygonSymbol3D-BXRHZiCQ.js","assets/ExtrudeSymbol3DLayer-DSc1ou2x.js","assets/screenUtils-BitdhK1O.js","assets/opacityUtils-DuFH0EC9.js","assets/Font-BwmnW7d2.js","assets/SimpleFillSymbol-CDawtd9z.js","assets/SimpleMarkerSymbol-BGAFRS9_.js","assets/PictureMarkerSymbol-CaSh-vZk.js","assets/TextSymbol-hRGhyDHs.js","assets/vec3f32-WCVSSNPR.js","assets/Indices-D0_UQPPr.js","assets/plane-BNdSPG2o.js","assets/vector-B8ZDYGQ6.js","assets/quatf64-CCm9z-pX.js","assets/sphere-DLQ6p7mp.js","assets/orientedBoundingBox-BLEx7wLU.js","assets/quat-B7J5v7rV.js","assets/spatialReferenceEllipsoidUtils-D2JabnKt.js","assets/computeTranslationToOriginAndRotation-Bjd4esRf.js","assets/memoryEstimations-Bd726a_p.js","assets/HUDIntersectorResult-1xTExS7z.js","assets/Intersector-DS9YtyQY.js","assets/frustum-CMzahy3-.js"]))=>e.map(r=>i[r]);let Pt=class extends rc{constructor(e){super(e),this.row=0,this.column=0,this.rows=1,this.columns=1}equals(e){return e!=null&&this.row===e.row&&this.rows===e.rows&&this.column===e.column&&this.columns===e.columns}};f([x({type:Number,nonNullable:!0,json:{read:!1,write:!1}})],Pt.prototype,"row",void 0),f([x({type:Number,nonNullable:!0,json:{read:!1,write:!1}})],Pt.prototype,"column",void 0),f([x({type:Number,nonNullable:!0,json:{read:!1,write:!1}})],Pt.prototype,"rows",void 0),f([x({type:Number,nonNullable:!0,json:{read:!1,write:!1}})],Pt.prototype,"columns",void 0),Pt=f([Nt("esri.CameraLayout")],Pt);const $n=Pt;let Ge=class extends ic(ql){constructor(...e){super(...e),this.position=new gt([0,0,0]),this.heading=0,this.tilt=0,this.fov=55,this.layout=new $n}normalizeCtorArgs(e,t,i,r){if(e&&typeof e=="object"&&("x"in e||Array.isArray(e))){const s={position:e};return t!=null&&(s.heading=t),i!=null&&(s.tilt=i),r!=null&&(s.fov=r),s}return e}writePosition(e,t,i,r){const s=e.clone();s.x=rt(e.x||0),s.y=rt(e.y||0),s.z=e.hasZ?rt(e.z||0):e.z,t[i]=s.write({},r)}readPosition(e,t){const i=new gt;return i.read(e,t),i.x=rt(i.x||0),i.y=rt(i.y||0),i.z=i.hasZ?rt(i.z||0):i.z,i}equals(e){return e!=null&&this.tilt===e.tilt&&this.heading===e.heading&&this.fov===e.fov&&this.position.equals(e.position)&&this.layout.equals(e.layout)}};f([x({type:gt,json:{write:{isRequired:!0}}})],Ge.prototype,"position",void 0),f([Zl("position")],Ge.prototype,"writePosition",null),f([_u("position")],Ge.prototype,"readPosition",null),f([x({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}}),Xr(e=>hu.normalize(rt(e)))],Ge.prototype,"heading",void 0),f([x({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}}),Xr(e=>Ve(rt(e),-180,180))],Ge.prototype,"tilt",void 0),f([x({type:Number,nonNullable:!0,json:{default:55,write:!0}}),Xr(e=>Ve(rt(e,55),1,170))],Ge.prototype,"fov",void 0),f([x({type:$n,nonNullable:!0,json:{read:!1,write:!1}})],Ge.prototype,"layout",void 0),Ge=f([Nt("esri.Camera")],Ge);const Su=Ge;function Cu(e,t,i){return 2*Math.atan(Math.sqrt(t*t+i*i)*Math.tan(.5*e)/t)}function Eu(e,t,i){return 2*Math.atan(Math.sqrt(t*t+i*i)*Math.tan(.5*e)/i)}function Iu(e,t,i){return 2*Math.atan(t*Math.tan(.5*e)/Math.sqrt(t*t+i*i))}function Ru(e,t,i){return 2*Math.atan(i*Math.tan(.5*e)/Math.sqrt(t*t+i*i))}var ys;let z=ys=class extends Er{constructor(e){super(e),this._ray=mt(),this._viewport=gs(0,0,1,1),this._padding=gs(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=Ln(1,1e3),this._viewDirty=!0,this._viewMatrix=ae(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=ae(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=ae(),this._frustumDirty=!0,this._frustum=Mn(),this._fullViewport=nt(),this._pixelRatio=1,this.row=0,this.column=0,this._rows=1,this._columns=1,this._center=g(),this._up=g(),this.relativeElevation=0}get pixelRatio(){return this._pixelRatio}set pixelRatio(e){this._pixelRatio=e>0?e:1}get rows(){return this._rows}set rows(e){this._rows=Math.max(1,e)}get columns(){return this._columns}set columns(e){this._columns=Math.max(1,e)}get eye(){return this._ray.origin}set eye(e){this._compareAndSetView(e,this._ray.origin)}get center(){return this._center}set center(e){this._compareAndSetView(e,this._center,"_center")}get ray(){return ce(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(e){this._compareAndSetView(e,this._up,"_up")}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(e){ei(this._viewMatrix,e),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),G(g(),-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10])}get viewUp(){return this._ensureViewClean(),G(g(),this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9])}get viewRight(){return this._ensureViewClean(),G(g(),this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8])}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(e){this._nearFar[0]!==e&&(this._nearFar[0]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get far(){return this._nearFar[1]}set far(e){this._nearFar[1]!==e&&(this._nearFar[1]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get viewport(){return this._viewport}set viewport(e){this.x=e[0],this.y=e[1],this.width=e[2],this.height=e[3]}get screenViewport(){if(this.pixelRatio===1)return this._viewport;const e=va(nt(),this._viewport,1/this.pixelRatio),t=this._get("screenViewport");return t&&_a(e,t)?t:e}get screenPadding(){if(this.pixelRatio===1)return this._padding;const e=va(nt(),this._padding,1/this.pixelRatio),t=this._get("screenPadding");return t&&_a(e,t)?t:e}get x(){return this._viewport[0]}set x(e){e+=this._padding[3],this._viewport[0]!==e&&(this._viewport[0]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get y(){return this._viewport[1]}set y(e){e+=this._padding[2],this._viewport[1]!==e&&(this._viewport[1]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get width(){return this._viewport[2]}set width(e){this._viewport[2]!==e&&(this._viewport[2]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get height(){return this._viewport[3]}set height(e){this._viewport[3]!==e&&(this._viewport[3]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get fullWidth(){return this._viewport[2]+this._padding[1]+this._padding[3]}set fullWidth(e){this.width=e-(this._padding[1]+this._padding[3])}get fullHeight(){return this._viewport[3]+this._padding[0]+this._padding[2]}set fullHeight(e){this.height=e-(this._padding[0]+this._padding[2])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[3],this._fullViewport[1]=this._viewport[1]-this._padding[2],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get _aspect(){return this.width/this.height}get padding(){return this._padding}set padding(e){qr(this._padding,e)||(this._viewport[0]+=e[3]-this._padding[3],this._viewport[1]+=e[2]-this._padding[2],this._viewport[2]-=e[1]+e[3]-(this._padding[1]+this._padding[3]),this._viewport[3]-=e[0]+e[2]-(this._padding[0]+this._padding[2]),qt(this._padding,e),this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_padding"),this.notifyChange("_viewport"))}get viewProjectionMatrix(){return this._viewProjectionDirty&&(Ii(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){return this._projectionMatrixInternal}get inverseProjectionMatrix(){return sr(ae(),this.projectionMatrix)||this._get("inverseProjectionMatrix")||ae()}get fov(){return this._fov}set fov(e){this._fov=e,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return Iu(this._fov,this.width,this.height)}set fovX(e){this._fov=Cu(e,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return Ru(this._fov,this.width,this.height)}set fovY(e){this._fov=Eu(e,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return pn(this.center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(sr(this._viewInverseTransposeMatrix,this.viewMatrix),ms(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(e){const{near:t,far:i}=this;return 2*t*i/(i+t-e*(i-t))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return this.relativeElevation!=null&&this.relativeElevation>=0}get _projectionMatrixInternal(){const e=this.width,t=this.height,i=this.near*Math.tan(this.fovY/2)*2,r=i*this._aspect,s=i/this.rows,a=r/this.columns,n=-r/2+this.column*a,o=n+a,l=-i/2+this.row*s,c=l+s,u=Vc(ae(),n*(1+2*this._padding[3]/e),o*(1+2*this._padding[1]/e),l*(1+2*this._padding[2]/t),c*(1+2*this._padding[0]/t),this.near,this.far),d=this._get("projectionMatrix");return d&&Bc(d,u)?d:u}copyFrom(e){Y(this._ray.origin,e.eye),this.center=e.center,this.up=e.up,qt(this._viewport,e.viewport),this.notifyChange("_viewport"),qt(this._padding,e.padding),this.notifyChange("_padding"),Ac(this._nearFar,e.nearFar),this.notifyChange("_nearFar"),this._fov=e.fov,this.row=e.row,this.column=e.column,this.rows=e.rows,this.columns=e.columns,this.relativeElevation=e.relativeElevation;const t=e;return this._viewDirty=t._viewDirty,this._viewDirty||(ei(this._viewMatrix,e.viewMatrix),this.notifyChange("_viewMatrix")),this._viewProjectionDirty=!0,this._frustumDirty=t._frustumDirty,this._frustumDirty||(cc(this._frustum,e.frustum),this._frustumDirty=!1),t._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(ei(this._viewInverseTransposeMatrix,e.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),qt(this._fullViewport,e.fullViewport),this.pixelRatio=e.pixelRatio,this}copyViewFrom(e){this.eye=e.eye,this.center=e.center,this.up=e.up,this.fov=e.fov}clone(){return new ys().copyFrom(this)}equals(e){return We(this.eye,e.eye)&&We(this.center,e.center)&&We(this.up,e.up)&&qr(this._viewport,e.viewport)&&qr(this._padding,e.padding)&&Oc(this.nearFar,e.nearFar)&&this._fov===e.fov&&this.pixelRatio===e.pixelRatio&&this.relativeElevation===e.relativeElevation&&this.row===e.row&&this.column===e.column&&this.rows===e.rows&&this.columns===e.columns}almostEquals(e){const t=Math.max(1,1/this.pixelRatio,1/e.pixelRatio);if(Math.abs(e.fov-this._fov)>=.001||xa(e.screenPadding,this.screenPadding)>=t||xa(this.screenViewport,e.screenViewport)>=t||this.row!==e.row||this.column!==e.column||this.rows!==e.rows||this.columns!==e.columns)return!1;Xe(re,e.eye,e.center),Xe(Ue,this.eye,this.center);const i=we(re,Ue),r=ca(re),s=ca(Ue),a=5e-4;return i*i>=(1-1e-10)*r*s&&ds(e.eye,this.eye)<Math.max(r,s)*a*a}computeRenderPixelSizeAt(e){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(e))}computeRenderPixelSizeAtDist(e){return e*this.perRenderPixelRatio}computeScreenPixelSizeAt(e){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(e))}_viewDirectionDistance(e){return Math.abs(xc(this.viewForward,ce(re,e,this.eye)))}computeScreenPixelSizeAtDist(e){return e*this.perScreenPixelRatio}computeDistanceFromRadius(e,t){return e/Math.tan(Math.min(this.fovX,this.fovY)/(2*(t||1)))}getScreenCenter(e=su()){return e[0]=(this.padding[3]+this.width/2)/this.pixelRatio,e[1]=(this.padding[0]+this.height/2)/this.pixelRatio,e}getRenderCenter(e,t=.5,i=.5){return e[0]=this.padding[3]+this.width*t,e[1]=this.padding[2]+this.height*i,e[2]=.5,e}setGLViewport(e){const t=this.viewport,i=this.padding;e.setViewport(t[0]-i[3],t[1]-i[2],t[2]+i[1]+i[3],t[3]+i[0]+i[2])}applyProjection(e,t){e!==B&&Y(B,e),B[3]=1,ji(B,B,this.projectionMatrix);const i=Math.abs(B[3]);q(B,B,1/i);const r=this.fullViewport;t[0]=ge(0,r[0]+r[2],.5+.5*B[0]),t[1]=ge(0,r[1]+r[3],.5+.5*B[1]),t[2]=.5*(B[2]+1),t[3]=i}unapplyProjection(e,t){const i=this.fullViewport;B[0]=(e[0]/(i[0]+i[2])*2-1)*e[3],B[1]=(e[1]/(i[1]+i[3])*2-1)*e[3],B[2]=(2*e[2]-1)*e[3],B[3]=e[3],this.inverseProjectionMatrix!=null&&(ji(B,B,this.inverseProjectionMatrix),t[0]=B[0],t[1]=B[1],t[2]=B[2])}projectToScreen(e,t){return this.projectToRenderScreen(e,Yr),this.renderToScreen(Yr,t),t}projectToRenderScreen(e,t){if(B[0]=e[0],B[1]=e[1],B[2]=e[2],B[3]=1,ji(B,B,this.viewProjectionMatrix),B[3]===0)return null;const i=B;q(i,i,1/Math.abs(B[3]));const r=this.fullViewport,s=ge(0,r[0]+r[2],.5+.5*i[0]),a=ge(0,r[1]+r[3],.5+.5*i[1]);return"x"in t?(t.x=s,t.y=a):(t[0]=s,t[1]=a,t.length>2&&(t[2]=.5*(i[2]+1))),t}unprojectFromScreen(e,t){return this.unprojectFromRenderScreen(this.screenToRender(e,Yr),t)}unprojectFromRenderScreen(e,t){if(Ii(Hi,this.projectionMatrix,this.viewMatrix),!sr(Hi,Hi))return null;const i=this.fullViewport;return B[0]=2*(e[0]-i[0])/i[2]-1,B[1]=2*(e[1]-i[1])/i[3]-1,B[2]=2*e[2]-1,B[3]=1,ji(B,B,Hi),B[3]===0?null:(t[0]=B[0]/B[3],t[1]=B[1]/B[3],t[2]=B[2]/B[3],t)}constrainWindowSize(e,t,i,r){const s=e*this.pixelRatio,a=t*this.pixelRatio,n=Math.max(s-i/2,0),o=Math.max(this.fullHeight-a-r/2,0),l=-Math.min(s-i/2,0),c=-Math.min(this.fullHeight-a-r/2,0),u=i-l- -Math.min(this.fullWidth-s-i/2,0),d=r-c- -Math.min(a-r/2,0);return[Math.round(n),Math.round(o),Math.round(u),Math.round(d)]}computeUp(e){e===1?this._computeUpGlobal():this._computeUpLocal()}screenToRender(e,t){const i=e[0]*this.pixelRatio,r=this.fullHeight-e[1]*this.pixelRatio;return t[0]=i,t[1]=r,t}renderToScreen(e,t){const i=e[0]/this.pixelRatio,r=(this.fullHeight-e[1])/this.pixelRatio;t[0]=i,t[1]=r}_computeUpGlobal(){ce(re,this.center,this.eye);const e=te(this.center);e<1?We(this._up,fa)&&(Y(this._up,fa),this._markViewDirty(),this.notifyChange("_up")):Math.abs(we(re,this.center))>.9999*te(re)*e||(Fe(Ue,re,this.center),Fe(Ue,Ue,re),Te(Ue,Ue),We(this._up,Ue)||(Y(this._up,Ue),this.notifyChange("_up"),this._markViewDirty()))}_computeUpLocal(){mn(re,this.eye,this.center),Math.abs(re[2])<=.9999&&(q(re,re,re[2]),G(re,-re[0],-re[1],1-re[2]),Te(re,re),We(this._up,re)||(Y(this._up,re),this.notifyChange("_up"),this._markViewDirty()))}_compareAndSetView(e,t,i=""){typeof e[0]=="number"&&isFinite(e[0])&&typeof e[1]=="number"&&isFinite(e[1])&&typeof e[2]=="number"&&isFinite(e[2])?We(e,t)||(Y(t,e),this._markViewDirty(),i.length&&this.notifyChange(i)):bt.getLogger("esri.views.3d.webgl-engine.lib.RenderCamera").warn("RenderCamera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&(Sn(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&($c(this._viewMatrix,this.eye,this.center,this.up),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}};f([x()],z.prototype,"_viewport",void 0),f([x()],z.prototype,"_padding",void 0),f([x()],z.prototype,"_fov",void 0),f([x()],z.prototype,"_nearFar",void 0),f([x()],z.prototype,"_viewDirty",void 0),f([x()],z.prototype,"_viewMatrix",void 0),f([x()],z.prototype,"_pixelRatio",void 0),f([x()],z.prototype,"pixelRatio",null),f([x()],z.prototype,"row",void 0),f([x()],z.prototype,"column",void 0),f([x()],z.prototype,"_rows",void 0),f([x()],z.prototype,"rows",null),f([x()],z.prototype,"_columns",void 0),f([x()],z.prototype,"columns",null),f([x()],z.prototype,"eye",null),f([x()],z.prototype,"center",null),f([x()],z.prototype,"_center",void 0),f([x()],z.prototype,"up",null),f([x()],z.prototype,"_up",void 0),f([x()],z.prototype,"viewMatrix",null),f([x({readOnly:!0})],z.prototype,"viewForward",null),f([x({readOnly:!0})],z.prototype,"viewUp",null),f([x({readOnly:!0})],z.prototype,"viewRight",null),f([x({readOnly:!0})],z.prototype,"nearFar",null),f([x()],z.prototype,"near",null),f([x()],z.prototype,"far",null),f([x()],z.prototype,"viewport",null),f([x({readOnly:!0})],z.prototype,"screenViewport",null),f([x({readOnly:!0})],z.prototype,"screenPadding",null),f([x()],z.prototype,"x",null),f([x()],z.prototype,"y",null),f([x()],z.prototype,"width",null),f([x()],z.prototype,"height",null),f([x()],z.prototype,"fullWidth",null),f([x()],z.prototype,"fullHeight",null),f([x({readOnly:!0})],z.prototype,"_aspect",null),f([x()],z.prototype,"padding",null),f([x({readOnly:!0})],z.prototype,"projectionMatrix",null),f([x({readOnly:!0})],z.prototype,"inverseProjectionMatrix",null),f([x()],z.prototype,"fov",null),f([x()],z.prototype,"fovX",null),f([x()],z.prototype,"fovY",null),f([x()],z.prototype,"viewInverseTransposeMatrix",null),f([x({readOnly:!0})],z.prototype,"_projectionMatrixInternal",null),f([x()],z.prototype,"relativeElevation",void 0),z=ys=f([Nt("esri.views.3d.webgl.RenderCamera")],z);const jn=z,B=nt(),Hi=ae(),re=g(),Ue=g(),Yr=au();let bs=class ws{constructor(t=1/0,i=-1/0){this.near=t,this.far=i}set(t,i){this.near=t,this.far=i}union(t){t!=null&&(this.near=Math.min(this.near,t.near),this.far=Math.max(this.far,t.far))}within(t){return this.near<=t&&t<=this.far}equals(t){return this.near===t.near&&this.far===t.far}static{this.Zero=new ws(0,0)}static{this.Infinite=new ws}},Fu=class{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.filteredLayerViewUids=[],this.store=2,this.normalRequired=!0,this.excludeLabels=!1}},Pu=class{constructor(){this._transform=ae(),this._transformInverse=new Ui({value:this._transform},sr,ae),this._transformInverseTranspose=new Ui(this._transformInverse,ms,ae),this._transformTranspose=new Ui({value:this._transform},ms,ae),this._transformInverseRotation=new Ui({value:this._transform},Pc,wt)}_invalidateLazyTransforms(){this._transformInverse.invalidate(),this._transformInverseTranspose.invalidate(),this._transformTranspose.invalidate(),this._transformInverseRotation.invalidate()}get transform(){return this._transform}get inverse(){return this._transformInverse.value}get inverseTranspose(){return this._transformInverseTranspose.value}get inverseRotation(){return this._transformInverseRotation.value}get transpose(){return this._transformTranspose.value}setTransformMatrix(e){ei(this._transform,e)}multiplyTransform(e){Ii(this._transform,this._transform,e)}set(e){ei(this._transform,e),this._invalidateLazyTransforms()}setAndInvalidateLazyTransforms(e,t){this.setTransformMatrix(e),this.multiplyTransform(t),this._invalidateLazyTransforms()}},Ui=class{constructor(e,t,i){this._original=e,this._update=t,this._dirty=!0,this._transform=i()}invalidate(){this._dirty=!0}get value(){return this._dirty&&(this._update(this._transform,this._original.value),this._dirty=!1),this._transform}},Au=class{constructor(e=0){this.offset=e,this.tmpVertex=g()}applyToVertex(e,t,i){const r=G(zs,e,t,i),s=pe(Hn,r,this.localOrigin),a=this.offset/te(s);return qe(this.tmpVertex,r,s,a),this.tmpVertex}applyToAabb(e){const t=zu,i=Nu,r=Lu;for(let o=0;o<3;++o)t[o]=e[0+o]+this.localOrigin[o],i[o]=e[3+o]+this.localOrigin[o],r[o]=t[o];const s=this.applyToVertex(t[0],t[1],t[2]);for(let o=0;o<3;++o)e[o]=s[o],e[o+3]=s[o];const a=o=>{const l=this.applyToVertex(o[0],o[1],o[2]);for(let c=0;c<3;++c)e[c]=Math.min(e[c],l[c]),e[c+3]=Math.max(e[c+3],l[c])};for(let o=1;o<8;++o){for(let l=0;l<3;++l)r[l]=o&1<<l?i[l]:t[l];a(r)}let n=0;for(let o=0;o<3;++o)t[o]*i[o]<0&&(n|=1<<o);if(n!==0&&n!==7){for(let o=0;o<8;++o)if((n&o)===0){for(let l=0;l<3;++l)r[l]=n&1<<l?0:o&1<<l?t[l]:i[l];a(r)}}for(let o=0;o<3;++o)e[o]-=this.localOrigin[o],e[o+3]-=this.localOrigin[o];return e}},Ou=class{constructor(e=0){this.componentLocalOriginLength=0,this._totalOffset=0,this._offset=0,this._tmpVertex=g(),this._tmpMbs=Fr(),this._tmpObb=new Yc,this._resetOffset(e)}_resetOffset(e){this._offset=e,this._totalOffset=e}set offset(e){this._resetOffset(e)}get offset(){return this._offset}set componentOffset(e){this._totalOffset=this._offset+e}set localOrigin(e){this.componentLocalOriginLength=te(e)}applyToVertex(e,t,i){const r=G(zs,e,t,i),s=G(Hn,e,t,i+this.componentLocalOriginLength),a=this._totalOffset/te(s);return qe(this._tmpVertex,r,s,a),this._tmpVertex}applyToAabb(e){const t=this.componentLocalOriginLength,i=e[0],r=e[1],s=e[2]+t,a=e[3],n=e[4],o=e[5]+t,l=Math.abs(i),c=Math.abs(r),u=Math.abs(s),d=Math.abs(a),m=Math.abs(n),v=Math.abs(o),p=.5*(1+Math.sign(i*a))*Math.min(l,d),_=.5*(1+Math.sign(r*n))*Math.min(c,m),y=.5*(1+Math.sign(s*o))*Math.min(u,v),w=Math.max(l,d),T=Math.max(c,m),M=Math.max(u,v),E=Math.sqrt(p*p+_*_+y*y),I=Math.sign(l+i),N=Math.sign(c+r),R=Math.sign(u+s),C=Math.sign(d+a),S=Math.sign(m+n),A=Math.sign(v+o),b=this._totalOffset;if(E<b)return e[0]-=(1-I)*b,e[1]-=(1-N)*b,e[2]-=(1-R)*b,e[3]+=C*b,e[4]+=S*b,e[5]+=A*b,e;const O=b/Math.sqrt(w*w+T*T+M*M),P=b/E,D=P-O,L=-D;return e[0]+=i*(I*L+P),e[1]+=r*(N*L+P),e[2]+=s*(R*L+P),e[3]+=a*(C*D+O),e[4]+=n*(S*D+O),e[5]+=o*(A*D+O),e}applyToMbs(e){const t=xn(e),i=te(t),r=this._totalOffset/i,s=qe(Un,t,t,r),a=e[3]+e[3]*this._totalOffset/i;return yn(this._tmpMbs,s,a),this._tmpMbs}applyToObb(e){return Zc(e,this._totalOffset,this._totalOffset,1,this._tmpObb),this._tmpObb}},Du=class{constructor(e=0){this.offset=e,this.sphere=Fr(),this.tmpVertex=g()}applyToVertex(e,t,i){const r=this.objectTransform.transform,s=G(zs,e,t,i),a=Pe(s,s,r),n=this.offset/te(a);qe(a,a,a,n);const o=this.objectTransform.inverse;return Pe(this.tmpVertex,a,o),this.tmpVertex}applyToMinMax(e,t){const i=this.offset/te(e);qe(e,e,e,i);const r=this.offset/te(t);qe(t,t,t,r)}applyToAabb(e){const t=this.offset/Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);e[0]+=e[0]*t,e[1]+=e[1]*t,e[2]+=e[2]*t;const i=this.offset/Math.sqrt(e[3]*e[3]+e[4]*e[4]+e[5]*e[5]);return e[3]+=e[3]*i,e[4]+=e[4]*i,e[5]+=e[5]*i,e}applyToBoundingSphere(e){const t=xn(e),i=te(t),r=this.offset/i,s=qe(Un,t,t,r),a=e[3]+e[3]*this.offset/i;return yn(this.sphere,s,a),this.sphere}};const Ta=new Du;function Ts(e){return e!=null?(Ta.offset=e,Ta):null}const Ma=new Ou;function tv(e){return e!=null?(Ma.offset=e,Ma):null}const Sa=new Au;function iv(e){return e!=null?(Sa.offset=e,Sa):null}const rv="terrain",zs=g(),Hn=g(),zu=g(),Nu=g(),Lu=g(),Un=g(),Ca=1e-5;let Vu=class{constructor(e){this.options=new Fu,this._results=new Bu,this.transform=new Pu,this.camera=new jn,this.tolerance=Ca,this.verticalOffset=null,this._ray=mt(),this._rayEnd=g(),this._rayBeginTransformed=g(),this._rayEndTransformed=g(),this.viewingMode=e??1}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(e,t,i){this.resetWithRay(sc(e,t,this._ray),i)}resetWithRay(e,t){this.camera=t,e!==this._ray&&ac(e,this._ray),this.options.verticalOffset!==0?this.viewingMode===2?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,pe(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(e=null,t,i,r,s){this.point=t,this.filterPredicate=r,this.tolerance=i??Ca;const a=Ts(this.verticalOffset);if(e&&e.length>0){const n=s?o=>{s(o)&&this.intersectObject(o)}:o=>{this.intersectObject(o)};for(const o of e){const l=o.getSpatialQueryAccelerator?.();l!=null?(a!=null?l.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,n,a):l.forEachAlongRay(this._ray.origin,this._ray.direction,n),this.options.selectionMode&&this.options.hud&&l.forEachDegenerateObject(n)):o.objects.forEach(c=>n(c))}}this.sortResults()}intersectObject(e){const t=e.geometries;if(!t)return;const i=e.effectiveTransformation,r=Ts(this.verticalOffset);for(const s of t){if(!s.visible)continue;const{material:a,id:n}=s;if(!a.visible)continue;this.transform.setAndInvalidateLazyTransforms(i,s.transformation),Pe(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),Pe(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const o=this.transform.transform;r!=null&&(r.objectTransform=this.transform),a.intersect(s,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,(l,c,u,d)=>this.handleObjectIntersection({object:e,geometryId:n,primitiveIndex:u},l,c,o,d))}}handleObjectIntersection(e,t,i,r,s){if(t<0||this.filterPredicate!=null&&!this.filterPredicate(this._ray.origin,this._rayEnd,t))return;const a=s?this._results.hud:this._results;e=s?new yu(e,s):e;const n=s?o=>o.set(1,e,t,i):o=>o.set(4,e,t,i,r);if((a.min.distance==null||t<a.min.distance)&&n(a.min),this.options.store!==0&&(a.max.distance==null||t>a.max.distance)&&n(a.max),this.options.store===2)if(s){const o=new xs(this._ray);n(o),this._results.hud.all.push(o)}else{const o=new ar(this._ray);n(o),this._results.all.push(o)}}sortResults(e=this._results.all){e.sort((t,i)=>t.distance!==i.distance?(t.distance??0)-(i.distance??0):t.drapedLayerOrder!==i.drapedLayerOrder?Ea(t.drapedLayerOrder,i.drapedLayerOrder):Ea(t.renderPriority,i.renderPriority))}};function Ea(e,t){return(t??-Number.MAX_VALUE)-(e??-Number.MAX_VALUE)}let Bu=class{constructor(){this.min=new ar(mt()),this.max=new ar(mt()),this.hud={min:new xs(mt()),max:new xs(mt()),all:new Array},this.ground=new ar(mt()),this.all=[]}init(e){this.min.init(e),this.max.init(e),this.ground.init(e),this.all.length=0,this.hud.min.init(e),this.hud.max.init(e),this.hud.all.length=0}};function sv(e,t,i,r){return e.renderCoordsHelper.fromRenderCoords(t.eye,yr,r)!=null&&xu(i,yr)}function $u(e,t){return e.elevationProvider?e.elevationProvider.getElevation(t[0],t[1],t[2],e.renderCoordsHelper.spatialReference,"ground")??0:0}function ju(e,t,i,r){const s=e.state.camera.clone();t&&i&&r&&(s.eye=t,s.center=i,s.up=r),Hu(e,s.ray,ut)||Y(ut,s.center);const a=e.state.constraints,n=a.minimumPoiDistance;if(Fs(s.eye,ut)<n){const o=a.collision.enabled;Y(It,s.viewForward),q(It,It,n),o?s.eye=ce(yr,ut,It):pe(ut,s.eye,It);const l=e.renderCoordsHelper,c=l.getAltitude(s.eye),u=a.collision.elevationMargin;o&&c<u&&(ce(It,ut,s.eye),s.eye=l.setAltitude(yr,u,s.eye),pe(ut,s.eye,It))}return s.center=ut,s}function Ia(e,t,i){if(!e.state.isGlobal||!e.stateManager.constraintsManager)return!1;const r=$u(e,t),s=e.stateManager.constraintsManager.nearFarHeuristic;let a=Ra.get(e);a===void 0&&(a=new jn,Ra.set(e,a)),a.eye=t,a.center=i;const{far:n}=s.compute(a,e.renderDataExtent,bs.Infinite,r),o=n*n;return Fs(t,i)>o}function Hu(e,t,i){let r=Ms[e.viewingMode];r||(r=new Vu(e.state.viewingMode),r.options.backfacesTerrain=!e.state.isGlobal,r.options.invisibleTerrain=!0,Ms[e.viewingMode]=r);const{isGlobal:s}=e.state;return!(!e.sceneIntersectionHelper.intersectRay(t,r,i)||Ia(e,t.origin,i))||!(!e.renderCoordsHelper.intersectManifold(t,0,i)||Ia(e,t.origin,i))||!!s&&Uu(t,i,Ni(e.spatialReference).radius)}function Uu(e,t,i){const r=we(e.origin,e.origin)-i*i,s=r>0?Math.sqrt(r)/3:1;return q(t,e.direction,s/te(e.direction)),pe(t,t,e.origin),!0}let Ms={};function av(){Ms={}}const yr=g(),ut=g(),It=g(),Ra=new WeakMap;function Gu(e,t){const i=[],r=[];return Gi(i,e,t,0),Gi(r,i,t,1),Gi(i,r,t,2),Gi(r,i,t,3),r}function Gi(e,t,i,r){const s=Wu(i,r);if(e.length=0,t.length){s(Wi,t[0],t[0])===1&&li(e,t[0]);for(let a=0;a<t.length;a++){const n=t[a===t.length-1?0:a+1];switch(s(Wi,t[a],n)){case 1:li(e,n);break;case 3:li(e,ba(Wi));break;case 2:li(e,ba(Wi)),li(e,n)}}}}function li(e,t){e.length!==0&&Nc(e.at(-1),t)||e.push(t)}function Wu(e,t){const i=t===0||t===2?0:1,r=e[t],s=t===0||t===1?1:-1,a=i===0?1:0;return(n,o,l)=>{if(o[i]<r&&l[i]<r)return s===1?0:1;if(o[i]>r&&l[i]>r)return s===1?1:0;const c=(l[a]-o[a])/(l[i]-o[i]),u=o[a]+c*(r-o[i]);return n[i]=r,n[a]=u,(o[i]<r?1:-1)*s>0?2:3}}const Wi=zi(),ku=g(),ki=g();function Gn(){return{direction:g(),up:g()}}function Wn(e,t,i,r,s){let a=Te(ku,e),n=we(a,r);const o=n>0;n=Math.abs(n),n>.99&&(n=Math.abs(we(t,r)),n<.99?(Y(a,t),o&&q(a,a,-1)):a=null);let l=0;if(a){q(ki,r,we(r,a)),ce(a,a,ki);const u=we(a,s)/(te(a)*te(s));Fe(ki,a,s),l=(we(ki,r)>0?1:-1)*lt(mr(u))}const c=lt(mr(-we(r,e)/te(e)));return i?(i.heading=l,i.tilt=c,i):{heading:l,tilt:c}}function kn(e,t,i,r){ce(Fa,i,t),tu(r,vc(t,Fa),e)||e===i||Y(e,i)}const Fa=g(),qn=ve(0,1,0),Xn=ve(0,0,1),ci=ae(),Qe=g(),et=g();function Yn(e,t,i,r=Gn()){const{direction:s,up:a}=r;return Wc(ci,-_e(t)),An(ci,ci,_e(i)),Pe(s,Xn,ci),q(s,s,-1),Pe(a,qn,ci),r}function qu(e,t,i,r){return Wn(t,i,r,Xn,qn)}function Xu(e,t,i,r){const s=Yn(e,i,r),a=g();return q(a,s.direction,-t),pe(a,a,e),{up:s.up,eye:a,heading:i,tilt:r}}function Yu(e){return lt(e)}function Zu(e){return _e(e)}function Ju(e,t,i,r,s){const a=e.renderSpatialReference,n=e.spatialReference??t.spatialReference;return _s(t,Qe,a),_s(t,et,a),Qe[0]-=i/2,et[0]+=i/2,Qe[1]-=r/2,et[1]+=r/2,xr(Qe,a,Qe,n),xr(et,a,et,n),s?(s.xmin=Qe[0],s.ymin=Qe[1],s.xmax=et[0],s.ymax=et[1],s.spatialReference=n):s=new Ds(Qe[0],Qe[1],et[0],et[1],n),s}function Ku(e,t){const i=e.frustum,{renderCoordsHelper:r}=e,s=r.getAltitude(t),a=e.spatialReference,n=e.state.camera.eye,o=[],l=i.planes[5];for(let c=0;c<4;c++){const u=i.lines[c];r.intersectInfiniteManifold(bn(u.origin,u.direction),s,ze)||Qu(ze,i,r,u.endpoint,s),kn(ze,n,ze,l),o.push(Ln(ze[0],ze[1]))}return eh(Gu(o,r.extent),r,a)}function Qu(e,t,i,r,s){const a=t.lines[11].direction,n=(s-i.getAltitude(r))/a[2];qe(e,r,a,n)}function eh(e,t,i){const r=e.map(s=>(G(ze,s[0],s[1],0),t.fromRenderCoords(ze,ze,i),[ze[0],ze[1]]));return r.length<=2?new ps({spatialReference:i}):(r.push(r[0].slice()),Fn(r)||r.reverse(),new ps({rings:[r],spatialReference:i}))}const ze=g(),th=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:qu,eyeForCenterWithHeadingTilt:Xu,eyeTiltToLookAtTilt:Zu,headingTiltToDirectionUp:Yn,lookAtTiltToEyeTilt:Yu,toArea:Ku,toExtent:Ju},Symbol.toStringTag,{value:"Module"}));let ih=class{get planes(){return this.frustum}get points(){return this._points}get mutablePoints(){return this._points}get direction(){return this._direction}get origin(){return this._origin}constructor(e){this.renderCoordsHelper=e,this.frustum=Mn(),this._points=uc(),this.lines=new Array(12),this._origin=g(),this._direction=g(),this._altitude=null;for(let t=0;t<12;t++)this.lines[t]={origin:null,direction:g(),endpoint:null}}update(e){Sn(e.viewMatrix,e.projectionMatrix,this.frustum,this._points),Y(this._origin,e.eye),Y(this._direction,e.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this._updateLines()}updatePoints(e){for(let t=0;t<this._points.length;t++)Y(this._points[t],e[t]);hc(this.frustum,this._points),this._updateLines()}get altitude(){return this._altitude}intersectsSphere(e){return dc(this.frustum,e)}intersectsRay(e){return fc(this.frustum,e)}intersectsLineSegment(e,t){return pc(this.frustum,e,t)}intersectsPoint(e){return mc(this.frustum,e)}_updateLines(){const e=this._points;for(let t=0;t<4;t++){const i=t+4;Zr(this.lines[t],e[t],e[i]),Zr(this.lines[t+4],e[t],t===3?e[0]:e[t+1]),Zr(this.lines[t+8],e[i],t===3?e[4]:e[i+1])}}static{this.planePointIndices=gc}static{this.nearFarLineIndices=[[0,4],[1,5],[2,6],[3,7]]}};function Zr(e,t,i){e.origin=t,e.endpoint=i,mn(e.direction,t,i)}function rh(e){return Ve((e-Pa)/(sh-Pa),0,1)}const Pa=1e5,sh=1e6,nv=1e4,Jr=ve(parseFloat(5802e-9.toFixed(6)),parseFloat(13558e-9.toFixed(6)),parseFloat(331e-7.toFixed(6))),Kr=3,Qr=ve(Kr*parseFloat(65e-8.toFixed(6)),Kr*parseFloat(1881e-9.toFixed(6)),Kr*parseFloat(85e-9.toFixed(6))),ov=3996e-9,lv=ve(parseFloat(Number(Jr[0]+Qr[0]).toFixed(6)),parseFloat(Number(Jr[1]+Qr[1]).toFixed(6)),parseFloat(Number(Jr[2]+Qr[2]).toFixed(6)));function cv(e,t,i){return e===1?new nh(t,i):new ah(t,i)}let ah=class{constructor(e,t){this._elevationProvider=e,this._referenceEllipsoid=Ni(t),this._unitInMeters=gu(t,this._referenceEllipsoid.metersPerDegree)}compute(e,t,i,r){const{eye:s,center:a}=e;let n=s[2]*this._unitInMeters;const o=n,l=n-r,c=this._elevationProvider?.visibleElevationBounds;c&&(n=l>=0?o-this._unitInMeters*c.min:this._unitInMeters*c.max-o),t??=new Ds({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0});const u={x:t.xmax-t.xmin,y:t.ymax-t.ymin,z:4*Math.max(t.xmax-t.xmin,t.ymax-t.ymin)},d=Math.max(u.x,u.y,u.z);ce(ft,a,s),ye[0]=ft[0]>0?t.xmax:t.xmin,ye[1]=ft[1]>0?t.ymax:t.ymin,ye[2]=ft[2]>0?d/2:-d/2,ce(ye,ye,s),Te(ft,ft);const m=1.1*we(ye,ft)*this._unitInMeters,v=Math.sqrt(n*(n+2*this._referenceEllipsoid.radius)),p=Math.max(t.xmax-t.xmin,t.ymax-t.ymin),_=p*lh*this._unitInMeters,y=p*ch*this._unitInMeters,w=Ve((n-y)/(_-y),0,1)**3,T=Math.min(ge(v,m,w),v)*Math.max(Math.log(Math.abs(l)),1);return Zn(Math.min(T,Math.max(34064e4,d))/this._unitInMeters,nr,this._unitInMeters,Ut)}},nh=class{constructor(e,t){this._elevationProvider=e,this._referenceEllipsoid=Ni(t)}compute(e,t,i,r){const{eye:s}=e,a=te(s),n=a-this._referenceEllipsoid.radius,o=this._referenceEllipsoid.radius+Math.min(0,r),l=Math.abs(n-r),c=Math.max(l,Math.abs(n)),u=this._elevationProvider?.visibleElevationBounds.max??0,d=rh(c),m=Math.sqrt(c*(c+2*o)),v=a+this._referenceEllipsoid.radius,p=1.2*ge(m,v,d),_=(Math.log(c)-Aa)/(oh-Aa);Zn(p,Ve(nr-_*(nr-Oa),Oa,nr),1,Ut);const y=this._referenceEllipsoid.radius+u,w=this._referenceEllipsoid.radius+this._referenceEllipsoid.atmosphereHeight,T=Math.max(y,w),M=a-T;if(d>0&&M>Ns){const E=Te(ye,q(ye,e.eye,-1)),I=Te(ft,e.viewForward),N=mr(we(E,I)),R=.5*e.fovY,C=Math.cos(R);let S=bs.Infinite.near;if(N<=R)S=M*C;else{const b=Te(ye,e.viewUp),O=Math.tan(R),P=q(ye,b,O),D=Te(ye,ce(ye,I,P)),L=oc(e.eye,D,hh),j=wn(uh,T);if(lc(j,L,ye)){const H=ce(ye,ye,e.eye);S=te(H)*C}}const A=.99*Math.min(i.near,S);if(A<bs.Infinite.near&&A>Ut.near){const b=ge(Ut.near,A,d);Ut.near=b}}return Ut}};function Zn(e,t,i,r){const s=Ns/i,a=e/t;return a>s?(r.far=e,r.near=a):(r.near=s,r.far=r.near*t),r}const Aa=7.983,oh=16.994,nr=2e4,Oa=100,Ns=2,lh=.001,ch=1e-4,ye=g(),ft=g(),Ut={near:0,far:0},uh=Fr(),hh=mt();function dh(e,t,i){e.worldUpAtPosition(t,Da),ce(es,i,t);const r=te(es);return r===0?0:mr(we(es,Da)/r)}const Da=g(),es=g();function za(e,t,i){if(t.longitude==null||t.latitude==null||i.longitude==null||i.latitude==null)throw new Error("Invalid points: no lon/lat");return fh(e,t.longitude,t.latitude,i.longitude,i.latitude)}function fh(e,t,i,r,s){const a=_e(i),n=_e(s),o=a-n,l=_e(t)-_e(r),c=Math.sin(o/2),u=Math.sin(l/2),d=2*Di(Math.sqrt(c*c+Math.cos(a)*Math.cos(n)*u*u))*e;return Math.round(1e4*d)/1e4}function uv(e,t,i){const r=t.spatialReference,s=Ni(r),a=new gt(t.x,e.y,r),n=new gt(i.x,e.y,r),o=new gt(e.x,t.y,r),l=new gt(e.x,i.y,r);return{lon:za(s.radius,a,n),lat:za(s.radius,o,l)}}function ph(e,t,i){const r=t/i,s=_e(e),a=Math.sin(r/2),n=Math.cos(s),o=2*Di(Math.sqrt(a*a/(n*n)));return lt(o)}function mh(e,t){return e/15}function hv(e,t){const i=e?.[0];if(i==null)return null;t||(t={hours:0,minutes:0,seconds:0}),t.hours=mh(i);const r=t.hours%1;t.hours-=r,t.minutes=60*r;const s=t.minutes%1;return t.minutes-=s,t.seconds=Math.round(60*s),t}const Jn=ve(0,0,1),Kn=Te(g(),ve(1,1,1)),ui=ae(),pt=g(),Bt=g();function Qn(e,t,i,r=Gn()){Fe(pt,e,Jn),we(pt,pt)===0&&Fe(pt,e,Kn),Uc(ui,-_e(t),e),Gc(ui,ui,-_e(i),pt);const{up:s,direction:a}=r;return Fe(s,pt,e),Te(s,s),Pe(s,s,ui),Te(a,e),gn(a,a),Pe(a,a,ui),r}function gh(e,t,i,r){const s=pt,a=Bt;return Te(s,e),Fe(Bt,s,Jn),we(Bt,Bt)===0&&Fe(Bt,s,Kn),Fe(a,Bt,s),Wn(t,i,r,s,a)}function vh(e,t,i,r){const s={eye:g(),up:null,tilt:r,heading:i},a=pt;a[0]=e[0],a[1]=e[2],a[2]=-e[1];const n=t,o=_e(i),l=_e(r),c=Math.sin(o),u=Math.cos(o),d=Math.sin(l),m=Math.cos(l),v=te(a);let p;if(Math.abs(l)<1e-8)p=n+v;else{const j=v/d,H=Di(n/j),Q=Math.PI-l-H;p=j*Math.sin(Q)}const _=m*n,y=n*n*(d*d),w=u*u*y,T=p-_,M=T*T,E=w*(w+M-a[1]*a[1]);if(E<0)return q(s.eye,a,p/v),s.tilt=0,qi(s,e);const I=Math.sqrt(E),N=a[1]*T,R=w+M;let C;if(C=u>0?-I+N:I+N,Math.abs(R)<1e-8)return v<1e-8?(s.eye[0]=0,s.eye[1]=0,s.eye[2]=n):q(s.eye,a,p/v),s.tilt=0,ts(s.eye),qi(s,e);s.eye[1]=C/R;const S=c*c*y,A=d*n,b=u*A*s.eye[1],O=s.eye[1]*s.eye[1],P=1-O,D=Math.sqrt(P),L=w*O+S-2*b*D*T+P*M;return Math.abs(L)<1e-8?(q(s.eye,a,p/v),s.tilt=0,ts(s.eye),qi(s,e)):(s.eye[0]=(P*(p*a[0]-_*a[0])-A*D*(a[0]*s.eye[1]*u+a[2]*c))/L,s.eye[2]=(P*(p*a[2]-_*a[2])-A*D*(a[2]*s.eye[1]*u-a[0]*c))/L,q(s.eye,s.eye,p),ts(s.eye),qi(s,e))}function ts(e){const t=e[1];e[1]=-e[2],e[2]=t}function qi(e,t){const i=Qn(t,e.heading,e.tilt);return e.up=i.up,e}function _h(e,t,i){const r=te(t),s=Math.sqrt(i*i+r*r-2*i*r*Math.cos(Math.PI-e)),a=Di(i/(s/Math.sin(e)));return lt(e-a)}function xh(e,t,i){const r=_e(e),s=te(t);return Di(i/(s/Math.sin(r)))+r}function yh(e,t,i,r,s){let a,n,o,l;const c=t.latitude,u=Ni(e.spatialReference).radius,d=t.longitude,m=ph(c,i,u)/2;a=d-m,n=d+m;const v=_e(c),p=(1+Math.sin(v))/(1-Math.sin(v)),_=(p+1)*Math.tan(r/u/2),y=_*_;function w(M){const E=Math.PI/2;return(M=uu.normalize(M,-E))>E&&(M=Math.PI-M),M}if(o=1.5*Math.PI-2*Math.atan(.5*(_+Math.sqrt(4*p+y))),l=o+r/u,o=w(o),l=w(l),l<o){const M=l;l=o,o=M}if(o=Math.max(lt(o),-90),l=Math.min(lt(l),90),n=bu.monotonic(a,n),n-a>180){const M=(n-a-180)/2;a+=M,n-=M}const T=e.spatialReference&&e.spatialReference.isGeographic?e.spatialReference:Vn.WGS84;return s?(s.xmin=a,s.ymin=o,s.xmax=n,s.ymax=l,s.spatialReference=T):s=new Ds(a,o,n,l,T),e.spatialReference&&e.spatialReference.isWebMercator&&pu(s,!1,s),s}function bh(e,t){const{renderCoordsHelper:i}=e,r=e.state.camera.clone(),s=new ih(i);r.near=Ns,s.update(r);const a=i.getAltitude(t),n=e.spatialReference,o=i.referenceEllipsoid.radius,l=r.eye,c=1+pn(l,t)/(o+a),u=Math.sqrt(c*c-1),{minCurvature:d,maxCurvature:m,minSamples:v,maxSamples:p}=Sh,_=Mh(e),y=Ve((u-d)/(m-d),0,1),w=Math.round(ge(v,p,y)),T=r.aboveGround,M=s.planes[5],E=[],I=pa(ot,Ch,ma()),N=pa(ot,Eh,ma());Ce(is,0,0,0,0);const R=S=>{};for(let S=0;S<4;S++){const A=S===1&&!T||S===3&&T?1-_:0,b=S===1&&T||S===3&&!T?_:1,O=s.lines[S],P=s.lines[S===3?0:S+1];for(let D=0;D<w;D++){const L=D/w,j=D===0?0:ge(A,b,S===1?1-(1-L)**2:S===3?L**2:L),H=ur(Rh,O.origin,P.origin,j),Q=Qc(O.direction,P.direction,j,Ih);i.intersectManifoldClosestSilhouette(bn(H,Q),a,be),kn(be,l,be,M),E.push(yi(be)),E.length!==0&&R(ds(E.at(-1),be));const oe=(ga(I,be)?1:0)|(ga(N,be)?2:0);is[oe]=1}}E.length>2&&R(ds(E[0],E.at(-1)));const C=wh(ou(is)>1?Th(eo(E,I),N):[E],i,n);return new ps({rings:C,spatialReference:n})}function wh(e,t,i){const r=2*Pn();return e.map(s=>{const a=[];let n=!1;for(const o of s)t.fromRenderCoords(o,be,i),Math.abs(o[0])<r&&Math.abs(o[1])<r?(a.push([null,be[1]]),a.push([null,be[1]]),n=!0):a.push([be[0],be[1]]);if(n)for(let o=0;o<a.length;o++){const l=a[o];if(l[0]!=null)continue;const c=a[o+1],u=a.at(o===0?-1:o-1);l[0]=u[0],o++;const d=a.at(o===a.length-1?0:o+1);c[0]=d[0]}return a.push(a[0]),Fn(a)||a.reverse(),a})}function Th(e,t){const i=[];for(const r of e)i.push(...eo(r,t));return i}function eo(e,t){const i=[],r=[],s=Pn();for(let n=0;n<e.length;n++){const o=e[n],l=n===e.length-1?e[0]:e[n+1],c=_c(o,l,Fh),u=iu(t,c.origin,c.vector,0,be);switch(u){case 2:i.push(o);break;case 3:r.push(o);break;case 0:case 1:{const[d,m,v]=u===0?[1,i,r]:[-1,r,i],p=ru(t),_=qe(g(),be,p,d*s),y=qe(g(),be,p,d*-s);m.push(o),m.push(_),v.push(y)}}}const a=[];return i.length&&a.push(i),r.length&&a.push(r),a}function Mh(e){const{renderCoordsHelper:t,state:{camera:i}}=e,{center:r,eye:s}=i,a=Math.abs(t.getAltitude(r)),n=Math.abs(Math.PI/2-dh(t,r,s));return wn(Na,t.referenceEllipsoid.radius+a),nc(Na,n,i.distance,i.fovY)}const Sh={minCurvature:_e(5),maxCurvature:_e(50),minSamples:1,maxSamples:6},Ch=ve(1,0,0),Eh=ve(0,1,0),Ih=g(),Rh=g(),be=g(),Na=Fr(),Fh=Cn(),is=nt(),Ph=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:gh,eyeForCenterWithHeadingTilt:vh,eyeTiltToLookAtTilt:xh,headingTiltToDirectionUp:Qn,lookAtTiltToEyeTilt:_h,toArea:bh,toExtent:yh},Symbol.toStringTag,{value:"Module"}));function to({state:e}){return e.isGlobal?Ph:th}function Ah(e,t,i,r,s){return to(e).directionToHeadingTilt(t,i,r,s)}const Oh={OPAQUE:"opaque-color",TRANSPARENT:"transparent-color",COMPOSITE:"composite-color",FINAL:"final-color"},La={SSAO:"ssao",LASERLINES:"laserline-color",ANTIALIASING:"aa-color",HIGHLIGHTS:"highlight-color",MAGNIFIER:"magnifier-color",OCCLUDED:"occluded-color",VIEWSHED:"viewshed-color",CUTFILL_DEPTH:"cutfill-depth",CUTFILL_COLOR:"cutfill-color",OPAQUE_TERRAIN:"opaque-terrain-color",OPAQUE_ENVIRONMENT:"opaque-environment-color",TRANSPARENT_ENVIRONMENT:"transparent-environment-color",FOCUSAREA:"focusarea",FOCUSAREA_COLOR:"focusarea-color"};function dv(e,t,i){const r=e.renderSpatialReference,s=Ah(e,t.eye,t.viewForward,t.up,Dh);let a=e.spatialReference;return xr(t.eye,r,$t,a)||(a=Vn.WGS84,xr(t.eye,r,$t,a)),i==null?i=new Su(new gt($t,a),s.heading,s.tilt,lt(t.fov)):(i.position.x=$t[0],i.position.y=$t[1],i.position.z=$t[2],i.position.spatialReference=a,i.heading=s.heading,i.tilt=s.tilt,i.fov=lt(t.fov)),i.layout.row=t.row,i.layout.rows=t.rows,i.layout.column=t.column,i.layout.columns=t.columns,i}function fv(e,t){if(!t)return null;const i=e.renderSpatialReference,r=to(e).headingTiltToDirectionUp,s=g();if(!_s(t.position,s,i))return null;const a=r(s,t.heading,t.tilt);q(a.direction,a.direction,e.state.camera.distance),pe(a.direction,a.direction,s);const n=ju(e,s,a.direction,a.up);return n.fov=_e(t.fov),n.row=t.layout.row,n.rows=t.layout.rows,n.column=t.layout.column,n.columns=t.layout.columns,n}const $t=g(),Dh={heading:0,tilt:0};function io(e,t=!0){e.attributes.add("position","vec2"),t&&e.varyings.add("uv","vec2"),e.vertex.main.add(h`
      gl_Position = vec4(position, 0.0, 1.0);
      ${t?h`uv = position * 0.5 + vec2(0.5);`:""}
  `)}let ro=class extends ie{constructor(e,t,i){super(e,"vec2",1,(r,s,a)=>r.setUniform2fv(e,t(s,a),i))}},Ye=class extends ie{constructor(e,t,i){super(e,"mat3",1,(r,s,a)=>r.setUniformMatrix3fv(e,t(s,a),i))}},zh=class{};const Be=zh,pv=new Be,Ls=()=>bt.getLogger("esri.views.3d.webgl-engine.core.shaderModules.shaderBuilder");let so=class{constructor(){this._includedModules=new Map}include(e,t){this._includedModules.has(e)?this._includedModules.get(e):(this._includedModules.set(e,t),e(this.builder,t))}},Pr=class extends so{constructor(){super(...arguments),this.vertex=new Va,this.fragment=new Va,this.attributes=new Bh,this.varyings=new $h,this.extensions=new jh,this.outputs=new Hh}get fragmentUniforms(){return this.fragment.uniforms.entries}get attributeNames(){return this.attributes.names}get builder(){return this}generate(e,t=!1){const i=this.extensions.generateSource(e),r=this.attributes.generateSource(e),s=this.varyings.generateSource(e),a=e==="vertex"?this.vertex:this.fragment,n=a.uniforms.generateSource(),o=a.code.generateSource(),l=a.main.generateSource(t),c=e==="vertex"?Wh:Gh,u=a.constants.generateSource(),d=this.outputs.generateSource(e);return`#version 300 es
${i.join(`
`)}
${c}
${u.join(`
`)}
${n.join(`
`)}
${r.join(`
`)}
${s.join(`
`)}
${d.join(`
`)}
${o.join(`
`)}
${l.join(`
`)}`}generateBind(e){const t=new Map;this.vertex.uniforms.entries.forEach(s=>{const a=s.bind[0];a&&t.set(s.name,a)}),this.fragment.uniforms.entries.forEach(s=>{const a=s.bind[0];a&&t.set(s.name,a)});const i=Array.from(t.values()),r=i.length;return s=>{for(let a=0;a<r;++a)i[a](e,s)}}generateBindPass(e){const t=new Map;this.vertex.uniforms.entries.forEach(s=>{const a=s.bind[1];a&&t.set(s.name,a)}),this.fragment.uniforms.entries.forEach(s=>{const a=s.bind[1];a&&t.set(s.name,a)});const i=Array.from(t.values()),r=i.length;return(s,a)=>{for(let n=0;n<r;++n)i[n](e,s,a)}}generateBindDraw(e){const t=new Map;this.vertex.uniforms.entries.forEach(s=>{const a=s.bind[2];a&&t.set(s.name,a)}),this.fragment.uniforms.entries.forEach(s=>{const a=s.bind[2];a&&t.set(s.name,a)});const i=Array.from(t.values()),r=i.length;return(s,a,n)=>{for(let o=0;o<r;++o)i[o](e,n,s,a)}}},Nh=class{constructor(e){this._stage=e,this._entries=new Map}add(...e){for(const t of e)this._add(t);return this._stage}get(e){return this._entries.get(e)}_add(e){if(e!=null){if(this._entries.has(e.name)&&!this._entries.get(e.name).equals(e))throw new X("shaderbuilder:duplicate-uniform",`Duplicate uniform name ${e.name} for different uniform type`);this._entries.set(e.name,e)}else Ls().error(`Trying to add null Uniform from ${new Error().stack}.`)}generateSource(){return Array.from(this._entries.values()).map(({name:e,arraySize:t,type:i})=>t!=null?`uniform ${i} ${e}[${t}];`:`uniform ${i} ${e};`)}get entries(){return Array.from(this._entries.values())}},Lh=class{constructor(e){this._stage=e,this._bodies=new Array}add(e){return this._bodies.push(e),this._stage}generateSource(e){if(this._bodies.length>0)return[`void main() {
 ${this._bodies.join(`
`)||""} 
}`];if(e)throw new X("shaderbuilder:missing-main","Shader does not contain main function body.");return[]}},Vh=class{constructor(e){this._stage=e,this._entries=new Array}add(e){return this._entries.push(e),this._stage}generateSource(){return this._entries}},Va=class extends so{constructor(){super(...arguments),this.uniforms=new Nh(this),this.main=new Lh(this),this.code=new Vh(this),this.constants=new Uh(this)}get builder(){return this}},Bh=class{constructor(){this._entries=new Array}add(e,t){this._entries.push([e,t])}generateSource(e){return e==="fragment"?[]:this._entries.map(t=>`in ${t[1]} ${t[0]};`)}get names(){return this._entries.map(([e])=>e)}},$h=class{constructor(){this._entries=new Map}add(e,t,i){this._entries.has(e)?Ls().warn(`Ignoring duplicate varying ${t} ${e}`):this._entries.set(e,{type:t,invariant:i?.invariant??!1})}generateSource(e){const t=new Array;return this._entries.forEach((i,r)=>t.push((i.invariant&&e==="vertex"?"invariant ":"")+(i.type==="int"?"flat ":"")+(e==="vertex"?"out":"in")+` ${i.type} ${r};`)),t}},jh=class Ss{constructor(){this._entries=new Set}add(t){this._entries.add(t)}generateSource(t){const i=t==="vertex"?Ss.ALLOWLIST_VERTEX:Ss.ALLOWLIST_FRAGMENT;return Array.from(this._entries).filter(r=>i.includes(r)).map(r=>`#extension ${r} : enable`)}static{this.ALLOWLIST_FRAGMENT=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives"]}static{this.ALLOWLIST_VERTEX=[]}},Hh=class Cs{constructor(){this._entries=new Map}add(t,i,r=0){const s=this._entries.get(r);s?.name!==t||s?.type!==i?this._entries.set(r,{name:t,type:i}):Ls().warn(`Fragment shader output location ${r} occupied`)}static{this.DEFAULT_TYPE="vec4"}static{this.DEFAULT_NAME="fragColor"}generateSource(t){if(t==="vertex")return[];this._entries.size===0&&this._entries.set(0,{name:Cs.DEFAULT_NAME,type:Cs.DEFAULT_TYPE});const i=new Array;return this._entries.forEach((r,s)=>i.push(`layout(location = ${s}) out ${r.type} ${r.name};`)),i}},Uh=class k{constructor(t){this._stage=t,this._entries=new Set}add(t,i,r){let s="ERROR_CONSTRUCTOR_STRING";switch(i){case"float":s=k._numberToFloatStr(r);break;case"int":s=k._numberToIntStr(r);break;case"bool":s=r.toString();break;case"vec2":s=`vec2(${k._numberToFloatStr(r[0])},                            ${k._numberToFloatStr(r[1])})`;break;case"vec3":s=`vec3(${k._numberToFloatStr(r[0])},                            ${k._numberToFloatStr(r[1])},                            ${k._numberToFloatStr(r[2])})`;break;case"vec4":s=`vec4(${k._numberToFloatStr(r[0])},                            ${k._numberToFloatStr(r[1])},                            ${k._numberToFloatStr(r[2])},                            ${k._numberToFloatStr(r[3])})`;break;case"ivec2":s=`ivec2(${k._numberToIntStr(r[0])},                             ${k._numberToIntStr(r[1])})`;break;case"ivec3":s=`ivec3(${k._numberToIntStr(r[0])},                             ${k._numberToIntStr(r[1])},                             ${k._numberToIntStr(r[2])})`;break;case"ivec4":s=`ivec4(${k._numberToIntStr(r[0])},                             ${k._numberToIntStr(r[1])},                             ${k._numberToIntStr(r[2])},                             ${k._numberToIntStr(r[3])})`;break;case"uvec2":s=`uvec2(${k._numberToIntStr(r[0])},                             ${k._numberToIntStr(r[1])})`;break;case"uvec3":s=`uvec3(${k._numberToIntStr(r[0])},                             ${k._numberToIntStr(r[1])},                             ${k._numberToIntStr(r[2])})`;break;case"uvec4":s=`uvec4(${k._numberToIntStr(r[0])},                             ${k._numberToIntStr(r[1])},                             ${k._numberToIntStr(r[2])},                             ${k._numberToIntStr(r[3])})`;break;case"mat2":case"mat3":case"mat4":s=`${i}(${Array.prototype.map.call(r,a=>k._numberToFloatStr(a)).join(", ")})`}return this._entries.add(`const ${i} ${t} = ${s};`),this._stage}static _numberToIntStr(t){return t.toFixed(0)}static _numberToFloatStr(t){return Number.isInteger(t)?t.toFixed(1):t.toString()}generateSource(){return Array.from(this._entries)}};const Gh=`#ifdef GL_FRAGMENT_PRECISION_HIGH
  precision highp float;
  precision highp int;
  precision highp sampler2D;
  precision highp usampler2D;
  precision highp sampler2DArray;
  precision highp sampler2DShadow;
#else
  precision mediump float;
  precision mediump int;
  precision mediump sampler2D;
  precision mediump usampler2D;
  precision mediump sampler2DArray;
  precision mediump sampler2DShadow;
#endif`,Wh=`precision highp float;
 precision highp sampler2D;
 precision highp usampler2D;
 precision highp sampler2DArray;
 precision highp sampler2DShadow;


 invariant gl_Position;
 `;let Ar=class{constructor(e,t){this._module=e,this._load=t}get(){return this._module}async reload(){return this._module=await this._load(),this._module}};const kh=()=>bt.getLogger("esri.views.webgl.checkWebGLError");function ao(e){switch(e.getError()){case e.NO_ERROR:return null;case e.INVALID_ENUM:return"Invalid Enum. An unacceptable value has been specified for an enumerated argument.";case e.INVALID_VALUE:return"Invalid Value. A numeric argument is out of range.";case e.INVALID_OPERATION:return"Invalid Operation. The specified command is not allowed for the current state.";case e.INVALID_FRAMEBUFFER_OPERATION:return"Invalid Framebuffer operation. The currently bound framebuffer is not framebuffer complete when trying to render to or to read from it.";case e.OUT_OF_MEMORY:return"Out of memory. Not enough memory is left to execute the command.";case e.CONTEXT_LOST_WEBGL:return"WebGL context has been lost";default:return"Unknown error"}}const no=!!Rr("enable-feature:webgl-debug");function Ri(){return no}function mv(){return no}function ke(e,t=Ri()){if(t){const i=ao(e);if(i){const r=new Error().stack;kh().error(new X("webgl-error","WebGL error occurred",{message:i,stack:r}))}}}let Ba=class{constructor(e,t,i){this._context=e,this.locations=i,this._textures=new Map,this.source=Ri()?t:null,t.attributeNames.forEach(r=>{i.has(r)||console.error(`Missing VertexAttributeLocation for ${r} used in shader`)}),this._glProgram=e.programCache.acquire(t.generate("vertex",!0),t.generate("fragment",!0),i),this._glProgram.stop=()=>{throw new Error("Wrapped _glProgram used directly")},this.bind=t.generateBind(this),this.bindPass=t.generateBindPass(this),this.bindDraw=t.generateBindDraw(this)}dispose(){this._glProgram.dispose()}get glName(){return this._glProgram.glName}get hasTransformFeedbackVaryings(){return this._glProgram.hasTransformFeedbackVaryings}get compiled(){return this._glProgram.compiled}setUniform1b(e,t){this._glProgram.setUniform1i(e,t?1:0)}setUniform1i(e,t){this._glProgram.setUniform1i(e,t)}setUniform1f(e,t,i){this._glProgram.setUniform1f(e,t,i)}setUniform2fv(e,t,i){this._glProgram.setUniform2fv(e,t,i)}setUniform3fv(e,t,i){this._glProgram.setUniform3fv(e,t,i)}setUniform4fv(e,t,i){this._glProgram.setUniform4fv(e,t,i)}setUniformMatrix3fv(e,t,i){this._glProgram.setUniformMatrix3fv(e,t,!1,i)}setUniformMatrix4fv(e,t,i){this._glProgram.setUniformMatrix4fv(e,t,!1,i)}setUniformMatrices4fv(e,t,i){this._glProgram.setUniformMatrices4fv(e,t,!1,i)}setUniform1fv(e,t,i){this._glProgram.setUniform1fv(e,t,i)}setUniform1iv(e,t){this._glProgram.setUniform1iv(e,t)}setUniform2iv(e,t){this._glProgram.setUniform2iv(e,t)}setUniform3iv(e,t){this._glProgram.setUniform3iv(e,t)}setUniform4iv(e,t){this._glProgram.setUniform4iv(e,t)}assertCompatibleVertexAttributeLocations(e,t){let i=e.locations;if(t){const r=new Map(i);t.forEach((s,a)=>r.set(a,i.size+s)),i=r}i.size!==this.locations.size&&console.error(`VertexAttributeLocations are incompatible: ${i}, ${this.locations}`),this.locations.forEach((r,s)=>{i.get(s)!==r&&console.error(`VertexAttributeLocations are incompatible: Program has ${s} at position ${r}, VAO has it at position ${i.get(s)}.`)})}stop(){this._textures.clear()}bindTexture(e,t){t?.glName||(Ri()&&console.error(`Texture sampler ${e} has no given Texture in ${new Error().stack} `),t=this._context.emptyTexture);const i=this._ensureTextureUnit(e,t);this._context.useProgram(this),this.setUniform1i(e,i.unit),this._context.bindTexture(t,i.unit)}_ensureTextureUnit(e,t){let i=this._textures.get(e);return i==null?(i={texture:t,unit:this._textures.size},this._textures.set(e,i)):i.texture=t,i}};function Or(e,t,i=32774,r=[0,0,0,0]){return{srcRgb:e,srcAlpha:e,dstRgb:t,dstAlpha:t,opRgb:i,opAlpha:i,color:{r:r[0],g:r[1],b:r[2],a:r[3]}}}function Vs(e,t,i,r,s=32774,a=32774,n=[0,0,0,0]){return{srcRgb:e,srcAlpha:t,dstRgb:i,dstAlpha:r,opRgb:s,opAlpha:a,color:{r:n[0],g:n[1],b:n[2],a:n[3]}}}const gv=Or(0,771),vv=Or(1,0),_v=Or(1,1),oo=Or(1,771),qh=Vs(770,1,771,771),xv=Vs(0,0,768,1),Xh={face:1029,mode:2305},Yh={face:1028,mode:2305},Zh=e=>e===2?Xh:e===1?Yh:null,Jh={zNear:0,zFar:1},Dr={r:!0,g:!0,b:!0,a:!0};function Kh(e){return od.intern(e)}function Qh(e){return ld.intern(e)}function ed(e){return cd.intern(e)}function td(e){return ud.intern(e)}function id(e){return hd.intern(e)}function rd(e){return dd.intern(e)}function sd(e){return fd.intern(e)}function ad(e){return pd.intern(e)}function nd(e){return md.intern(e)}function zr(e){return gd.intern(e)}let Ze=class{constructor(e,t){this._makeKey=e,this._makeRef=t,this._interns=new Map}intern(e){if(!e)return null;const t=this._makeKey(e),i=this._interns;return i.has(t)||i.set(t,this._makeRef(e)),i.get(t)??null}};function Je(e){return"["+e.join(",")+"]"}const od=new Ze(lo,e=>({__tag:"Blending",...e}));function lo(e){return e?Je([e.srcRgb,e.srcAlpha,e.dstRgb,e.dstAlpha,e.opRgb,e.opAlpha,e.color.r,e.color.g,e.color.b,e.color.a]):null}const ld=new Ze(co,e=>({__tag:"Culling",...e}));function co(e){return e?Je([e.face,e.mode]):null}const cd=new Ze(uo,e=>({__tag:"PolygonOffset",...e}));function uo(e){return e?Je([e.factor,e.units]):null}const ud=new Ze(ho,e=>({__tag:"DepthTest",...e}));function ho(e){return e?Je([e.func]):null}const hd=new Ze(fo,e=>({__tag:"StencilTest",...e}));function fo(e){return e?Je([e.function.func,e.function.ref,e.function.mask,e.operation.fail,e.operation.zFail,e.operation.zPass]):null}const dd=new Ze(po,e=>({__tag:"DepthWrite",...e}));function po(e){return e?Je([e.zNear,e.zFar]):null}const fd=new Ze(mo,e=>({__tag:"ColorWrite",...e}));function mo(e){return e?Je([e.r,e.g,e.b,e.a]):null}const pd=new Ze(go,e=>({__tag:"StencilWrite",...e}));function go(e){return e?Je([e.mask]):null}const md=new Ze(vo,e=>({__tag:"DrawBuffers",...e}));function vo(e){return e?Je(e.buffers):null}const gd=new Ze(vd,e=>({blending:Kh(e.blending),culling:Qh(e.culling),polygonOffset:ed(e.polygonOffset),depthTest:td(e.depthTest),stencilTest:id(e.stencilTest),depthWrite:rd(e.depthWrite),colorWrite:sd(e.colorWrite),stencilWrite:ad(e.stencilWrite),drawBuffers:nd(e.drawBuffers)}));function vd(e){return e?Je([lo(e.blending),co(e.culling),uo(e.polygonOffset),ho(e.depthTest),fo(e.stencilTest),po(e.depthWrite),mo(e.colorWrite),go(e.stencilWrite),vo(e.drawBuffers)]):null}let yv=class{constructor(e){this._pipelineInvalid=!0,this._blendingInvalid=!0,this._cullingInvalid=!0,this._polygonOffsetInvalid=!0,this._depthTestInvalid=!0,this._stencilTestInvalid=!0,this._depthWriteInvalid=!0,this._colorWriteInvalid=!0,this._stencilWriteInvalid=!0,this._drawBuffersInvalid=!0,this._stateSetters=e}setPipeline(e){(this._pipelineInvalid||e!==this._pipeline)&&(this._setBlending(e.blending),this._setCulling(e.culling),this._setPolygonOffset(e.polygonOffset),this._setDepthTest(e.depthTest),this._setStencilTest(e.stencilTest),this._setDepthWrite(e.depthWrite),this._setColorWrite(e.colorWrite),this._setStencilWrite(e.stencilWrite),this._setDrawBuffers(e.drawBuffers),this._pipeline=e),this._pipelineInvalid=!1}invalidateBlending(){this._blendingInvalid=!0,this._pipelineInvalid=!0}invalidateCulling(){this._cullingInvalid=!0,this._pipelineInvalid=!0}invalidatePolygonOffset(){this._polygonOffsetInvalid=!0,this._pipelineInvalid=!0}invalidateDepthTest(){this._depthTestInvalid=!0,this._pipelineInvalid=!0}invalidateStencilTest(){this._stencilTestInvalid=!0,this._pipelineInvalid=!0}invalidateDepthWrite(){this._depthWriteInvalid=!0,this._pipelineInvalid=!0}invalidateColorWrite(){this._colorWriteInvalid=!0,this._pipelineInvalid=!0}invalidateStencilWrite(){this._stencilTestInvalid=!0,this._pipelineInvalid=!0}invalidateDrawBuffers(){this._drawBuffersInvalid=!0,this._pipelineInvalid=!0}_setBlending(e){this._blending=this._setSubState(e,this._blending,this._blendingInvalid,this._stateSetters.setBlending),this._blendingInvalid=!1}_setCulling(e){this._culling=this._setSubState(e,this._culling,this._cullingInvalid,this._stateSetters.setCulling),this._cullingInvalid=!1}_setPolygonOffset(e){this._polygonOffset=this._setSubState(e,this._polygonOffset,this._polygonOffsetInvalid,this._stateSetters.setPolygonOffset),this._polygonOffsetInvalid=!1}_setDepthTest(e){this._depthTest=this._setSubState(e,this._depthTest,this._depthTestInvalid,this._stateSetters.setDepthTest),this._depthTestInvalid=!1}_setStencilTest(e){this._stencilTest=this._setSubState(e,this._stencilTest,this._stencilTestInvalid,this._stateSetters.setStencilTest),this._stencilTestInvalid=!1}_setDepthWrite(e){this._depthWrite=this._setSubState(e,this._depthWrite,this._depthWriteInvalid,this._stateSetters.setDepthWrite),this._depthWriteInvalid=!1}_setColorWrite(e){this._colorWrite=this._setSubState(e,this._colorWrite,this._colorWriteInvalid,this._stateSetters.setColorWrite),this._colorWriteInvalid=!1}_setStencilWrite(e){this._stencilWrite=this._setSubState(e,this._stencilWrite,this._stencilWriteInvalid,this._stateSetters.setStencilWrite),this._stencilTestInvalid=!1}_setDrawBuffers(e){this._drawBuffers=this._setSubState(e,this._drawBuffers,this._drawBuffersInvalid,this._stateSetters.setDrawBuffers),this._drawBuffersInvalid=!1}_setSubState(e,t,i,r){return(i||e!==t)&&(r(e),this._pipelineInvalid=!0),e}};const _d=()=>bt.getLogger("esri.views.3d.webgl.ShaderTechnique");let Bs=class{constructor(e,t,i,r){this.primitiveType=Tc.TRIANGLES,this.key=t.key,this._program=new Ba(e.rctx,i.get().build(t),r),this._pipeline=this.initializePipeline(t),this.reload=async s=>{s&&await i.reload(),this.key.equals(t.key)||_d().warn("Configuration was changed after construction, cannot reload shader.",i),dr(this._program),this._program=new Ba(e.rctx,i.get().build(t),r),this._pipeline=this.initializePipeline(t)}}destroy(){this._program=dr(this._program),this._pipeline=null}get program(){return this._program}get compiled(){return this.program.compiled}ensureAttributeLocations(e){this.program.assertCompatibleVertexAttributeLocations(e)}getPipeline(e,t){return this._pipeline}initializePipeline(e){return zr({blending:oo,colorWrite:Dr})}};function xd(e,t){return yc(e)?{buffers:[Sc]}:t??null}const bv=[],yd=[new si("position",3,Ee.FLOAT,0,12)],bd=[new si("position",2,Ee.FLOAT,0,8)],_o=Bn(bd),wv=Bn(yd),Tv=[new si("position",2,Ee.FLOAT,0,12),new si("uv0",2,Ee.HALF_FLOAT,8,12)],Mv=[new si("position",2,Ee.FLOAT,0,16),new si("uv0",2,Ee.FLOAT,8,16)];let wd=class{constructor(e){this._bits=[...e]}equals(e){return Gl(this._bits,e.bits)}get code(){return this._code??=String.fromCharCode(...this._bits),this._code}get bits(){return this._bits}},Td=class extends Be{constructor(){super(),this._parameterBits=this._parameterBits?.map(()=>0)??[],this._parameterNames??=[]}get key(){return this._key??=new wd(this._parameterBits),this._key}decode(e=this.key){const t=this._parameterBits;this._parameterBits=[...e.bits];const i=this._parameterNames.map(r=>`    ${r}: ${this[r]}`).join(`
`);return this._parameterBits=t,i}};function V(e={}){return(t,i)=>{t.hasOwnProperty("_parameterNames")||Object.defineProperty(t,"_parameterNames",{value:t._parameterNames?.slice()??[],configurable:!0,writable:!0}),t.hasOwnProperty("_parameterBits")||Object.defineProperty(t,"_parameterBits",{value:t._parameterBits?.slice()??[0],configurable:!0,writable:!0}),t._parameterNames.push(i);const r=e.count||2,s=Math.ceil(Math.log2(r)),a=t._parameterBits;let n=0;for(;a[n]+s>16;)n++,n>=a.length&&a.push(0);const o=a[n],l=(1<<s)-1<<o;a[n]+=s,e.count?Object.defineProperty(t,i,{get(){return(this._parameterBits[n]&l)>>o},set(c){if(this[i]!==c){if(this._key=null,this._parameterBits[n]=this._parameterBits[n]&~l|+c<<o&l,typeof c!="number")throw new X("internal:invalid-shader-configuration",`Configuration value for ${i} must be a number, got ${typeof c}`);if(e.count==null)throw new X("internal:invalid-shader-configuration",`Configuration value for ${i} must provide a count option`)}}}):Object.defineProperty(t,i,{get(){return!!((this._parameterBits[n]&l)>>o)},set(c){if(this[i]!==c&&(this._key=null,this._parameterBits[n]=this._parameterBits[n]&~l|+c<<o&l,typeof c!="boolean"))throw new X("internal:invalid-shader-configuration",`Configuration value for ${i} must be boolean, got ${typeof c}`)}})}}const $a=()=>bt.getLogger("esri.views.webgl.BufferObject"),Md=!!Rr("esri-tests-disable-gpu-memory-measurements");let Sd=class Gt{static createIndex(t,i,r){return new Gt(t,34963,i,r)}static createUniform(t,i,r){return new Gt(t,35345,i,r)}static createPixelPack(t,i=35041,r){const s=new Gt(t,35051,i);return r&&s.setSize(r),s}static createPixelUnpack(t,i=35040,r){return new Gt(t,35052,i,r)}static createTransformFeedback(t,i=35044,r){const s=new Gt(t,35982,i);return s.setSize(r),s}constructor(t,i,r,s){this._context=t,this.bufferType=i,this.usage=r,this._glName=null,this._size=-1,this._indexType=void 0,t.instanceCounter.increment(gr.BufferObject,this),this._glName=this._context.gl.createBuffer(),ke(this._context.gl),s&&this.setData(s)}get glName(){return this._glName}get size(){return this._size}get indexType(){return this._indexType}get sizeBytes(){if(this.bufferType===34963){if(this._indexType===Ee.UNSIGNED_INT)return 4*this._size;if(this._indexType===Ee.UNSIGNED_SHORT)return 2*this._size}return this._size}get usedMemory(){return Md?0:this.sizeBytes}get _isVAOAware(){return this.bufferType===34963||this.bufferType===34962}dispose(){this._context?.gl?(this._glName&&(this._context.gl.deleteBuffer(this._glName),this._glName=null),this._context.instanceCounter.decrement(gr.BufferObject,this),this._context=null):this._glName&&$a().warn("Leaked WebGL buffer object")}setSize(t,i=null){if(this.bufferType===34963&&i!=null)switch(this._indexType=i,i){case Ee.UNSIGNED_SHORT:t*=2;break;case Ee.UNSIGNED_INT:t*=4}this._setBufferData(t)}setData(t){if(!t)return;let i=t.byteLength;this.bufferType===34963&&(xi(t)?this._indexType=Ee.UNSIGNED_BYTE:vn(t)?(i/=2,this._indexType=Ee.UNSIGNED_SHORT):Nl(t)&&(i/=4,this._indexType=Ee.UNSIGNED_INT)),this._setBufferData(i,t)}_setBufferData(t,i=null){this._size=t;const r=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const s=this._context.gl;i!=null?s.bufferData(this.bufferType,i,this.usage):s.bufferData(this.bufferType,t,this.usage),ke(s),this._isVAOAware&&this._context.bindVAO(r)}setSubData(t,i,r,s){if(!t)return;const a=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const{gl:n}=this._context;n.bufferSubData(this.bufferType,i*t.BYTES_PER_ELEMENT,t,r,s-r),ke(n),this._isVAOAware&&this._context.bindVAO(a)}getSubData(t,i=0,r,s){if(r<0||s<0)return;const a=Cd(t)?t.BYTES_PER_ELEMENT:1;if(a*((r??0)+(s??0))>t.byteLength)return;i+a*(s??0)>this.usedMemory&&$a().warn("Potential problem getting subdata: requested data exceeds buffer size!");const n=this._context.gl;this.bufferType===35982?(this._context.bindBuffer(this,35982),n.getBufferSubData(35982,i,t,r,s),this._context.unbindBuffer(35982)):(this._context.bindBuffer(this,36662),n.getBufferSubData(36662,i,t,r,s),this._context.unbindBuffer(36662))}async getSubDataAsync(t,i=0,r,s){await this._context.clientWaitAsync(),this.getSubData(t,i,r,s)}};function Cd(e){return $l(e)}function Sv(e,t,i,r=0){const s=e.gl;e.bindBuffer(i);for(const a of i.layout){const n=t.get(a.name);if(n==null){console.warn(`There is no location for vertex attribute '${a.name}' defined.`);continue}const o=r*a.stride;if(a.count<=4)s.vertexAttribPointer(n,a.count,a.type,a.normalized,a.stride,a.offset+o),s.enableVertexAttribArray(n),a.divisor>0&&s.vertexAttribDivisor(n,a.divisor);else if(a.count===9)for(let l=0;l<3;l++)s.vertexAttribPointer(n+l,3,a.type,a.normalized,a.stride,a.offset+12*l+o),s.enableVertexAttribArray(n+l),a.divisor>0&&s.vertexAttribDivisor(n+l,a.divisor);else if(a.count===16)for(let l=0;l<4;l++)s.vertexAttribPointer(n+l,4,a.type,a.normalized,a.stride,a.offset+16*l+o),s.enableVertexAttribArray(n+l),a.divisor>0&&s.vertexAttribDivisor(n+l,a.divisor);else console.error("Unsupported vertex attribute element count: "+a.count);if(Ri()){const l=ao(e.gl);l&&console.error(`Unable to bind vertex attribute "${a.name}" with baseInstanceOffset ${o}:`,l,a)}}}function Ed(e){switch(e){case 6406:case 6409:case 6403:case 36244:case 6402:case 34041:return 1;case 6410:case 33319:case 33320:return 2;case 6407:case 36248:return 3;case 6408:case 36249:return 4}return 0}function xo(e){switch(e){case 6406:case 6409:case 6403:case 36244:case F.R8:case F.R8I:case F.R8UI:case F.R8_SNORM:case 36168:return 1;case 6410:case 33319:case 33320:case F.RGBA4:case F.R16F:case F.R16I:case F.R16UI:case F.RG8:case F.RG8I:case F.RG8UI:case F.RG8_SNORM:case F.RGB565:case F.RGB5_A1:case bi.DEPTH_COMPONENT16:return 2;case 6407:case 36248:case F.RGB8:case F.RGB8I:case F.RGB8UI:case F.RGB8_SNORM:case F.SRGB8:case bi.DEPTH_COMPONENT24:return 3;case 6408:case 36249:case F.RGBA8:case F.R32F:case F.R11F_G11F_B10F:case F.RG16F:case F.R32I:case F.R32UI:case F.RG16I:case F.RG16UI:case F.RGBA8I:case F.RGBA8UI:case F.RGBA8_SNORM:case F.SRGB8_ALPHA8:case F.RGB9_E5:case F.RGB10_A2UI:case F.RGB10_A2:case bi.DEPTH_COMPONENT32F:case vr.DEPTH24_STENCIL8:return 4;case vr.DEPTH32F_STENCIL8:return 5;case F.RGB16F:case F.RGB16I:case F.RGB16UI:return 6;case F.RG32F:case F.RG32I:case F.RG32UI:case F.RGBA16F:case F.RGBA16I:case F.RGBA16UI:return 8;case F.RGB32F:case F.RGB32I:case F.RGB32UI:return 12;case F.RGBA32F:case F.RGBA32I:case F.RGBA32UI:return 16;case K.COMPRESSED_RGB_S3TC_DXT1_EXT:case K.COMPRESSED_RGBA_S3TC_DXT1_EXT:return .5;case K.COMPRESSED_RGBA_S3TC_DXT3_EXT:case K.COMPRESSED_RGBA_S3TC_DXT5_EXT:return 1;case K.COMPRESSED_R11_EAC:case K.COMPRESSED_SIGNED_R11_EAC:case K.COMPRESSED_RGB8_ETC2:case K.COMPRESSED_SRGB8_ETC2:case K.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:case K.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:return .5;case K.COMPRESSED_RG11_EAC:case K.COMPRESSED_SIGNED_RG11_EAC:case K.COMPRESSED_RGBA8_ETC2_EAC:case K.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:return 1}return 0}let $s=class{constructor(e=0,t=e){this.width=e,this.height=t,this.type=0,this.target=3553,this.pixelFormat=6408,this.dataType=fs.UNSIGNED_BYTE,this.samplingMode=9729,this.wrapMode=10497,this.maxAnisotropy=1,this.flipped=!1,this.hasMipmap=!1,this.isOpaque=!1,this.unpackAlignment=4,this.preMultiplyAlpha=!1,this.compareEnabled=!1,this.linearFilterDepth=!1,this.depth=1,this.isImmutable=!1}};function Id(e){return e.width<=0||e.height<=0||e.depth<=0?0:Math.round(e.width*e.height*e.depth*(e.hasMipmap?4/3:1)*(e.internalFormat==null?4:xo(e.internalFormat))*(e.target===34067?6:1))}const hi=()=>bt.getLogger("esri/views/webgl/textureUtils");function di(e){const{width:t,height:i,depth:r}=e;(t!=null&&t<0||i!=null&&i<0||r!=null&&r<0)&&hi().error("Negative dimension parameters are not allowed!");const{internalFormat:s}=e;if(s&&(yo(s)||bo(s))){const{linearFilterDepth:a,compareEnabled:n,samplingMode:o,hasMipmap:l}=e;l&&hi().error("Depth textures cannot have mipmaps"),a?o!==9729&&o!==9728&&hi().error("Depth textures cannot sample mipmaps"):(o!==9728&&hi().error("Depth textures without filtering must use NEAREST filtering"),n&&hi().error("Depth textures without filtering cannot use compare function"))}}function Rd(e){return Mc.includes(e)}function yo(e){return Ir(bi,e)}function bo(e){return Ir(vr,e)}function Fd(e){return e!=null&&Ir(K,e)}function Wt(e){return e!=null&&"type"in e&&e.type==="compressed"}function Pd(e){return e!=null&&"byteLength"in e}function ja(e){return e!=null&&!Wt(e)&&!Pd(e)}function jt(e){return e===32879||e===35866}function Ha(e,t,i,r=1){let s=Math.max(t,i);return e===32879&&(s=Math.max(s,r)),Math.floor(Math.log2(s))+1}function Xi(e){if(e.internalFormat!=null)return e.internalFormat;switch(e.dataType){case fs.FLOAT:switch(e.pixelFormat){case 6408:return F.RGBA32F;case 6407:return F.RGB32F;default:throw new X("texture:unknown-format","Unable to derive format")}case fs.UNSIGNED_BYTE:switch(e.pixelFormat){case 6408:return F.RGBA8;case 6407:return F.RGB8}}const{pixelFormat:t}=e;return e.internalFormat=t===34041?vr.DEPTH24_STENCIL8:t===6402?bi.DEPTH_COMPONENT24:t,e.internalFormat}function Ad(e){let t="width"in e?e.width:e.codedWidth,i="height"in e?e.height:e.codedHeight;return e instanceof HTMLVideoElement&&(t=e.videoWidth,i=e.videoHeight),{width:t,height:i,depth:1}}let Od=class wo extends $s{constructor(t,i){switch(super(),this.context=t,Object.assign(this,i),this.internalFormat){case F.R16F:case F.R32F:case F.R8_SNORM:case F.R8:this.pixelFormat=6403;break;case F.R8I:case F.R8UI:case F.R16I:case F.R16UI:case F.R32I:case F.R32UI:this.pixelFormat=36244}}static validate(t,i){return new wo(t,i)}};const Dd=!!Rr("esri-tests-disable-gpu-memory-measurements"),tt=()=>bt.getLogger("esri/views/webgl/Texture");let ti=class Se{static{this.TEXTURE_UNIT_FOR_UPDATES=0}static{this.compressionWorkerHandle=null}constructor(t,i=null,r=null){if(this.type=1,this._glName=null,this._samplingModeDirty=!1,this._wrapModeDirty=!1,this._shadowFilterDirty=!1,this._wasImmutablyAllocated=!1,"context"in t)this._descriptor=t,r=i;else{const s=Od.validate(t,i);if(!s)throw new X("texture:invalid-descriptor","Texture descriptor invalid");this._descriptor=s}this._descriptor.target===34067?this._setDataCubeMap(r):this.setData(r)}get glName(){return this._glName}get descriptor(){return this._descriptor}get usedMemory(){return Dd?0:Id(this._descriptor)}get isDirty(){return this._samplingModeDirty||this._wrapModeDirty||this._shadowFilterDirty}get hasWebGLTextureObject(){return!!this._glName}dispose(){this.abortCompression(),this.hasWebGLTextureObject&&this._descriptor.context?.gl&&(this._descriptor.context.instanceCounter.decrement(gr.Texture,this),this._descriptor.context.unbindTexture(this),this._descriptor.context.gl.deleteTexture(this._glName),this._glName=null,this._descriptor=null)}release(){this.dispose()}[Symbol.dispose](){this.dispose()}resize(t,i){const r=this._descriptor;if(r.width!==t||r.height!==i){if(this._wasImmutablyAllocated)throw new X("texture:immutable-resize","Immutable textures can't be resized!");r.width=t,r.height=i,this._descriptor.target===34067?this._setDataCubeMap(null):this.setData(null)}}enableCompression(t){this._descriptor.compress=t}disableCompression(){this._descriptor.compress=void 0}setData(t){this.abortCompression(),!Wt(t)&&this._descriptor.internalFormat&&Ir(K,this._descriptor.internalFormat)&&(this._descriptor.internalFormat=void 0),this._setData(t),!Wt(t)&&this._descriptor.compress&&this._compressOnWorker(t)}updateData(t,i,r,s,a,n,o=0){n||tt().error("An attempt to use uninitialized data!"),this.hasWebGLTextureObject||tt().error("An attempt to update uninitialized texture!");const l=this._descriptor;l.internalFormat=Xi(l);const{context:c,pixelFormat:u,dataType:d,target:m,isImmutable:v}=l;if(v&&!this._wasImmutablyAllocated)throw new X("texture:uninitialized","Cannot update immutable texture before allocation!");const p=c.bindTexture(this,Se.TEXTURE_UNIT_FOR_UPDATES,!0);(i<0||r<0||i+s>l.width||r+a>l.height)&&tt().error("An attempt to update out of bounds of the texture!"),this._configurePixelStorage();const{gl:_}=c;o&&(s&&a||tt().warn("Must pass width and height if `UNPACK_SKIP_ROWS` is used"),_.pixelStorei(_.UNPACK_SKIP_ROWS,o)),ja(n)?_.texSubImage2D(m,t,i,r,s,a,u,d,n):Wt(n)?_.compressedTexSubImage2D(m,t,i,r,s,a,l.internalFormat,n.levels[t]):_.texSubImage2D(m,t,i,r,s,a,u,d,n),o&&_.pixelStorei(_.UNPACK_SKIP_ROWS,0),c.bindTexture(p,Se.TEXTURE_UNIT_FOR_UPDATES)}updateData3D(t,i,r,s,a,n,o,l){l||tt().error("An attempt to use uninitialized data!"),this.hasWebGLTextureObject||tt().error("An attempt to update an uninitialized texture!");const c=this._descriptor;c.internalFormat=Xi(c);const{context:u,pixelFormat:d,dataType:m,isImmutable:v,target:p}=c;if(v&&!this._wasImmutablyAllocated)throw new X("texture:uninitialized","Cannot update immutable texture before allocation!");jt(p)||tt().warn("Attempting to set 3D texture data on a non-3D texture");const _=u.bindTexture(this,Se.TEXTURE_UNIT_FOR_UPDATES);u.setActiveTexture(Se.TEXTURE_UNIT_FOR_UPDATES),(i<0||r<0||s<0||i+a>c.width||r+n>c.height||s+o>c.depth)&&tt().error("An attempt to update out of bounds of the texture!"),this._configurePixelStorage();const{gl:y}=u;if(Wt(l))l=l.levels[t],y.compressedTexSubImage3D(p,t,i,r,s,a,n,o,c.internalFormat,l);else{const w=l;y.texSubImage3D(p,t,i,r,s,a,n,o,d,m,w)}u.bindTexture(_,Se.TEXTURE_UNIT_FOR_UPDATES)}generateMipmap(){const t=this._descriptor;if(t.width===0||t.height===0)return;if(!t.hasMipmap){if(this._wasImmutablyAllocated)throw new X("texture:immutable-change","Cannot add mipmaps to immutable texture after allocation");t.hasMipmap=!0,this._samplingModeDirty=!0,di(t)}t.samplingMode===9729?(this._samplingModeDirty=!0,t.samplingMode=9985):t.samplingMode===9728&&(this._samplingModeDirty=!0,t.samplingMode=9984);const i=this._descriptor.context.bindTexture(this,Se.TEXTURE_UNIT_FOR_UPDATES);this._descriptor.context.setActiveTexture(Se.TEXTURE_UNIT_FOR_UPDATES),this._descriptor.context.gl.generateMipmap(t.target),this._descriptor.context.bindTexture(i,Se.TEXTURE_UNIT_FOR_UPDATES)}clearMipmap(){const t=this._descriptor;if(t.hasMipmap){if(this._wasImmutablyAllocated)throw new X("texture:immutable-change","Cannot delete mipmaps to immutable texture after allocation");t.hasMipmap=!1,this._samplingModeDirty=!0,di(t)}t.samplingMode===9985?(this._samplingModeDirty=!0,t.samplingMode=9729):t.samplingMode===9984&&(this._samplingModeDirty=!0,t.samplingMode=9728)}setSamplingMode(t){t!==this._descriptor.samplingMode&&(this._descriptor.samplingMode=t,this._samplingModeDirty=!0)}setWrapMode(t){t!==this._descriptor.wrapMode&&(this._descriptor.wrapMode=t,di(this._descriptor),this._wrapModeDirty=!0)}setShadowFiltering(t){t!==this._descriptor.linearFilterDepth&&(this._descriptor.linearFilterDepth=this._descriptor.compareEnabled=t,this.setSamplingMode(t?9729:9728),di(this._descriptor),this._shadowFilterDirty=!0)}applyChanges(){this._samplingModeDirty&&(this._applySamplingMode(),this._samplingModeDirty=!1),this._wrapModeDirty&&(this._applyWrapMode(),this._wrapModeDirty=!1),this._shadowFilterDirty&&(this._applyShadowMode(),this._shadowFilterDirty=!1)}abortCompression(){this._compressionAbortController=Dl(this._compressionAbortController)}_setData(t,i){const r=this._descriptor,s=r.context?.gl;if(!s)return;ke(s),this.hasWebGLTextureObject||(this._glName=s.createTexture(),r.context.instanceCounter.increment(gr.Texture,this)),di(r);const a=r.context.bindTexture(this,Se.TEXTURE_UNIT_FOR_UPDATES);r.context.setActiveTexture(Se.TEXTURE_UNIT_FOR_UPDATES),this._configurePixelStorage(),ke(s);const n=i??r.target,o=jt(n);if(ja(t))this._setDataFromTexImageSource(t,n);else{const{width:l,height:c,depth:u}=r;if(l==null||c==null)throw new X("texture:missing-size","Width and height must be specified!");if(o&&u==null)throw new X("texture:missing-depth","Depth must be specified!");if(r.internalFormat=Xi(r),r.isImmutable&&!this._wasImmutablyAllocated&&this._texStorage(n,r.internalFormat,r.hasMipmap,l,c,u),Wt(t)){if(!Fd(r.internalFormat))throw new X("texture:format-mismatch","Attempting to use compressed data with an uncompressed format!");this._setDataFromCompressedSource(t,r.internalFormat,n)}else this._texImage(n,0,r.internalFormat,l,c,u,t),ke(s),r.hasMipmap&&this.generateMipmap()}this._applySamplingMode(),this._applyWrapMode(),this._applyAnisotropicFilteringParameters(),this._applyShadowMode(),ke(s),r.context.bindTexture(a,Se.TEXTURE_UNIT_FOR_UPDATES)}_setDataCubeMap(t=null){for(let i=34069;i<=34074;i++)this._setData(t,i)}_configurePixelStorage(){const t=this._descriptor.context.gl,{unpackAlignment:i,flipped:r,preMultiplyAlpha:s}=this._descriptor;t.pixelStorei(t.UNPACK_ALIGNMENT,i),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,r?1:0),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,s?1:0)}_setDataFromTexImageSource(t,i){const{gl:r}=this._descriptor.context,s=this._descriptor;s.internalFormat=Xi(s);const a=jt(i),{width:n,height:o,depth:l}=Ad(t);s.width&&s.height,s.width||(s.width=n),s.height||(s.height=o),a&&s.depth,a&&(s.depth=l),s.isImmutable&&!this._wasImmutablyAllocated&&this._texStorage(i,s.internalFormat,s.hasMipmap,n,o,l),this._texImage(i,0,s.internalFormat,n,o,l,t),ke(r),s.hasMipmap&&(this.generateMipmap(),ke(r))}_setDataFromCompressedSource(t,i,r){const s=this._descriptor,{width:a,height:n,depth:o}=s,l=t.levels,c=Ha(r,a,n,o),u=Math.min(c,l.length)-1;this._descriptor.context.gl.texParameteri(s.target,33085,u),this._forEachMipmapLevel((d,m,v,p)=>{const _=l[Math.min(d,l.length-1)];this._compressedTexImage(r,d,i,m,v,p,_)},u)}_texStorage(t,i,r,s,a,n){const{gl:o}=this._descriptor.context;if(!Rd(i)&&!yo(i)&&!bo(i))throw new X("texture:missing-format","Immutable textures must have a sized internal format");if(!this._descriptor.isImmutable)return;const l=r?Ha(t,s,a,n):1;if(jt(t)){if(n==null)throw new X("texture:missing-depth","Missing depth dimension for 3D texture upload");o.texStorage3D(t,l,i,s,a,n)}else o.texStorage2D(t,l,i,s,a);this._wasImmutablyAllocated=!0}_texImage(t,i,r,s,a,n,o){const l=this._descriptor.context.gl,c=jt(t),{isImmutable:u,pixelFormat:d,dataType:m}=this._descriptor;if(u){if(o!=null){const v=o;if(c){if(n==null)throw new X("texture:missing-depth","Missing depth dimension for 3D texture upload");l.texSubImage3D(t,i,0,0,0,s,a,n,d,m,v)}else l.texSubImage2D(t,i,0,0,s,a,d,m,v)}}else{const v=o;if(c){if(n==null)throw new X("texture:missing-depth","Missing depth dimension for 3D texture upload");l.texImage3D(t,i,r,s,a,n,0,d,m,v)}else l.texImage2D(t,i,r,s,a,0,d,m,v)}}_compressedTexImage(t,i,r,s,a,n,o){const l=this._descriptor.context.gl,c=jt(t);if(this._descriptor.isImmutable){if(o!=null)if(c){if(n==null)throw new X("texture:missing-depth","Missing depth dimension for 3D texture upload");l.compressedTexSubImage3D(t,i,0,0,0,s,a,n,r,o)}else l.compressedTexSubImage2D(t,i,0,0,s,a,r,o)}else if(c){if(n==null)throw new X("texture:missing-depth","Missing depth dimension for 3D texture upload");l.compressedTexImage3D(t,i,r,s,a,n,0,o)}else l.compressedTexImage2D(t,i,r,s,a,0,o)}async _compressOnWorker(t){const{width:i,height:r,context:s,flipped:a,preMultiplyAlpha:n,hasMipmap:o}=this._descriptor,l=this._descriptor.compress?.compressionTracker,c=this._descriptor.compress?.compressionCallback,{compressedTextureETC:u,compressedTextureS3TC:d}=s.capabilities;if(!Se.compressionWorkerHandle?.isCompressible(t,this._descriptor)||!u&&!d)return;this.abortCompression();const m=new AbortController;let v;this._compressionAbortController=m,l?.increment();try{t instanceof Uint8Array?v=t.buffer:(v=await createImageBitmap(t,{imageOrientation:a?"flipY":"none"}),hr(m));const p={data:v,width:i,height:r,needsFlip:t instanceof Uint8Array&&this.descriptor.flipped,components:this._descriptor.pixelFormat===6408?4:3,preMultiplyAlpha:n,hasMipmap:o,hasETC:!!u,hasS3TC:!!d},_=await Se.compressionWorkerHandle.invoke(p,m.signal,"low");if(hr(m),_.compressedTexture&&this.hasWebGLTextureObject){const y=this.usedMemory;this._descriptor.internalFormat=_.internalFormat,this._setData(_.compressedTexture),c?.(y-this.usedMemory)}}catch(p){zl(p)||tt().error("Texture compression failed!")}finally{l?.decrement(),this._compressionAbortController?.signal.aborted&&(this._compressionAbortController=null),v instanceof ImageBitmap&&v.close()}}_forEachMipmapLevel(t,i=1/0){let{width:r,height:s,depth:a,hasMipmap:n,target:o}=this._descriptor;const l=o===32879;if(r==null||s==null||l&&a==null)throw new X("texture:missing-size","Missing texture dimensions for mipmap calculation");for(let c=0;t(c,r,s,a),n&&(r!==1||s!==1||l&&a!==1)&&!(c>=i);++c)r=Math.max(1,r>>1),s=Math.max(1,s>>1),l&&(a=Math.max(1,a>>1))}_applySamplingMode(){const t=this._descriptor,i=t.context?.gl;let r=t.samplingMode,s=t.samplingMode;r===9985||r===9987?(r=9729,t.hasMipmap||(s=9729)):r!==9984&&r!==9986||(r=9728,t.hasMipmap||(s=9728)),i.texParameteri(t.target,i.TEXTURE_MAG_FILTER,r),i.texParameteri(t.target,i.TEXTURE_MIN_FILTER,s)}_applyWrapMode(){const t=this._descriptor,i=t.context?.gl;typeof t.wrapMode=="number"?(i.texParameteri(t.target,i.TEXTURE_WRAP_S,t.wrapMode),i.texParameteri(t.target,i.TEXTURE_WRAP_T,t.wrapMode)):(i.texParameteri(t.target,i.TEXTURE_WRAP_S,t.wrapMode.s),i.texParameteri(t.target,i.TEXTURE_WRAP_T,t.wrapMode.t))}_applyShadowMode(){const t=this._descriptor,i=t.context?.gl,r=t.compareEnabled?i.COMPARE_REF_TO_TEXTURE:i.NONE;i.texParameteri(t.target,i.TEXTURE_COMPARE_MODE,r),t.compareEnabled&&i.texParameteri(t.target,i.TEXTURE_COMPARE_FUNC,i.GREATER),ke(i)}_applyAnisotropicFilteringParameters(){const t=this._descriptor,i=t.context.capabilities.textureFilterAnisotropic;i&&t.context.gl.texParameterf(t.target,i.TEXTURE_MAX_ANISOTROPY,t.maxAnisotropy??1)}},zt=class extends ie{constructor(e,t,i){super(e,"vec3",0,(r,s)=>r.setUniform3fv(e,t(s),i))}},or=class extends ie{constructor(e,t,i){super(e,"mat4",0,(r,s)=>r.setUniformMatrix4fv(e,t(s),i))}},At=class extends Er{constructor(e){super(e),this.view=null,this.consumes={required:[]},this.produces=Oh.COMPOSITE,this.requireGeometryDepth=!1,this._dirty=!0}initialize(){this.addHandles([Nn(()=>this.view.ready,e=>{e&&this.view.stage?.renderer.addRenderNode(this)},Kc)])}destroy(){this.view.stage?.renderer?.removeRenderNode(this)}precompile(){}render(){throw new X("RenderNode:render-function-not-implemented","render() is not implemented.")}get camera(){return this.view.state.camera.clone()}get sunLight(){return this.bindParameters.lighting.legacy}get gl(){return this.view.stage.renderView.renderingContext.gl}get techniques(){return this.view.stage.renderView.techniques}acquireOutputFramebuffer(){const e=this._frameBuffer?.getTexture()?.descriptor,t=this.view.stage.renderer.fboCache.acquire(e?.width??640,e?.height??480,this.produces);return t.fbo?.initializeAndBind(),t}bindRenderTarget(){return this._frameBuffer?.fbo?.initializeAndBind(),this._frameBuffer}requestRender(e){switch(e){case 2:this.view.state.fading=!0;case 1:this.view.stage?.renderView.requestRender(e);case 0:case void 0:this._dirty=!0}}resetWebGLState(){this.renderingContext.resetState(),this.renderingContext.bindFramebuffer(this._frameBuffer?.fbo)}get fboCache(){return this.view.stage.renderer.fboCache}get bindParameters(){return this.renderContext.bind}get renderingContext(){return this.view.stage.renderView.renderingContext}get renderContext(){return this.view.stage?.renderer.renderContext}updateAnimation(e){return!!this._dirty&&(this._dirty=!1,!0)}doRender(e){this._frameBuffer=e.find(({name:t})=>t===this.produces);try{return this.render(e)}finally{this._frameBuffer=null}}};f([x({constructOnly:!0})],At.prototype,"view",void 0),f([x({constructOnly:!0})],At.prototype,"consumes",void 0),f([x()],At.prototype,"produces",void 0),f([x({readOnly:!0})],At.prototype,"techniques",null),At=f([Nt("esri.views.3d.webgl.RenderNode")],At);let zd=class extends Sd{constructor(e,t,i,r=35044){super(e,34962,r,i),this.layout=t}},Nd=class{constructor(e=Ei()){this.intensity=e}},Ld=class{constructor(e=Ei(),t=ve(.57735,.57735,.57735)){this.intensity=e,this.direction=t}},Es=class{constructor(e=Ei(),t=ve(.57735,.57735,.57735),i=!0,r=1,s=1){this.intensity=e,this.direction=t,this.castShadows=i,this.specularStrength=r,this.environmentStrength=s}},To=class{constructor(){this.r=[0],this.g=[0],this.b=[0]}},J=class extends Er{constructor(){super(...arguments),this.SCENEVIEW_HITTEST_RETURN_INTERSECTOR=!1,this.DECONFLICTOR_SHOW_VISIBLE=!1,this.DECONFLICTOR_SHOW_INVISIBLE=!1,this.DECONFLICTOR_SHOW_GRID=!1,this.LABELS_SHOW_BORDER=!1,this.TEXT_SHOW_BASELINE=!1,this.TEXT_SHOW_BORDER=!1,this.OVERLAY_DRAW_DEBUG_TEXTURE=!1,this.OVERLAY_SHOW_CENTER=!1,this.SHOW_POI=!1,this.TESTS_DISABLE_OPTIMIZATIONS=!1,this.TESTS_DISABLE_FAST_UPDATES=!1,this.DRAW_MESH_GEOMETRY_NORMALS=!1,this.FEATURE_TILE_FETCH_SHOW_TILES=!1,this.FEATURE_TILE_TREE_SHOW_TILES=!1,this.TERRAIN_TILE_TREE_SHOW_TILES=!1,this.I3S_TREE_SHOW_TILES=!1,this.I3S_SHOW_MODIFICATIONS=!1,this.LOD_INSTANCE_RENDERER_DISABLE_UPDATES=!1,this.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL=!1,this.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES=!1,this.LINE_WIREFRAMES=!1}};f([x()],J.prototype,"SCENEVIEW_HITTEST_RETURN_INTERSECTOR",void 0),f([x()],J.prototype,"DECONFLICTOR_SHOW_VISIBLE",void 0),f([x()],J.prototype,"DECONFLICTOR_SHOW_INVISIBLE",void 0),f([x()],J.prototype,"DECONFLICTOR_SHOW_GRID",void 0),f([x()],J.prototype,"LABELS_SHOW_BORDER",void 0),f([x()],J.prototype,"TEXT_SHOW_BASELINE",void 0),f([x()],J.prototype,"TEXT_SHOW_BORDER",void 0),f([x()],J.prototype,"OVERLAY_DRAW_DEBUG_TEXTURE",void 0),f([x()],J.prototype,"OVERLAY_SHOW_CENTER",void 0),f([x()],J.prototype,"SHOW_POI",void 0),f([x()],J.prototype,"TESTS_DISABLE_OPTIMIZATIONS",void 0),f([x()],J.prototype,"TESTS_DISABLE_FAST_UPDATES",void 0),f([x()],J.prototype,"DRAW_MESH_GEOMETRY_NORMALS",void 0),f([x()],J.prototype,"FEATURE_TILE_FETCH_SHOW_TILES",void 0),f([x()],J.prototype,"FEATURE_TILE_TREE_SHOW_TILES",void 0),f([x()],J.prototype,"TERRAIN_TILE_TREE_SHOW_TILES",void 0),f([x()],J.prototype,"I3S_TREE_SHOW_TILES",void 0),f([x()],J.prototype,"I3S_SHOW_MODIFICATIONS",void 0),f([x()],J.prototype,"LOD_INSTANCE_RENDERER_DISABLE_UPDATES",void 0),f([x()],J.prototype,"LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL",void 0),f([x()],J.prototype,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",void 0),f([x()],J.prototype,"LINE_WIREFRAMES",void 0),J=f([Nt("esri.views.3d.support.debugFlags")],J);const Vd=new J;let Is=class{constructor(){this._scale=0,this._angleFactor=0,this._minScale=0}update(e,t,i,r){i?(this._scale=Math.min(i.divisor/(t-i.offset),1),this._angleFactor=Bd(e),this._minScale=r!=null?Math.min(i.minPixelSize/r,1):0):(this._scale=1,this._minScale=1,this._angleFactor=1)}apply(e){const{_scale:t,_angleFactor:i,_minScale:r}=this;return e*Ve(ge(t,1,i),r,1)}applyVec2(e,t){e[0]=this.apply(t[0]),e[1]=this.apply(t[1])}},Cv=class{constructor(){this.evaluator=new Is,this.alignmentEvaluator=new Is}update(e,t,i,r,s,a){this.evaluator.update(e,t,i,r),this.alignmentEvaluator.update(e,t,s??i,(s?a:null)??r)}};function Bd(e){return Math.abs(e)**3}function Ev(e){return!!e&&!0}let $d=class{constructor(){this.distance=0,this.fovY=0}},Iv=class{constructor(){this.camera=new $d,this.offset=0,this.divisor=0,this.minPixelSize=0}};function js(){return!!Rr("enable-feature:objectAndLayerId-rendering")}let Hs=class{constructor(e){this.field=e}},jd=class extends Hs{constructor(e){super(e),this.minSize=[0,0,0],this.maxSize=[0,0,0],this.offset=[0,0,0],this.factor=[0,0,0],this.type=[0,0,0],this.fallback=[0,0,0]}},Ua=class extends Hs{constructor(e){super(e),this.colors=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.values=[0,0,0,0,0,0,0,0],this.fallback=[0,0,0,0]}},Hd=class extends Hs{constructor(e,t=0){super(e),this.fallback=t,this.values=[0,0,0,0,0,0,0,0],this.opacityValues=[0,0,0,0,0,0,0,0]}},Ud=class{};function fi(e){return e!=null}function ne(e,t){e&&e.push(t)}function Gd(e,t,i,r=ae()){const s=e||0,a=t||0,n=i||0;return s!==0&&qc(r,r,-s/180*Math.PI),a!==0&&An(r,r,a/180*Math.PI),n!==0&&Xc(r,r,n/180*Math.PI),r}function ht(e,t,i,r,s){const a=e.minSize,n=e.maxSize;if(e.useSymbolValue){const o=r.symbolSize[i];return t.minSize[i]=o,t.maxSize[i]=o,t.offset[i]=t.minSize[i],t.factor[i]=0,t.type[i]=1,!0}if(fi(e.field))return fi(e.stops)?e.stops.length===2&&Vt(e.stops[0].size)&&Vt(e.stops[1].size)?(Ga(e.stops[0].size,e.stops[1].size,e.stops[0].value,e.stops[1].value,t,i),t.type[i]=1,!0):(ne(s,"Could not convert size info: stops only supported with 2 elements"),!1):Vt(a)&&Vt(n)&&fi(e.minDataValue)&&fi(e.maxDataValue)?(Ga(a,n,e.minDataValue,e.maxDataValue,t,i),t.type[i]=1,!0):e.valueUnit==="unknown"?(ne(s,"Could not convert size info: proportional size not supported"),!1):ya[e.valueUnit]!=null?(t.minSize[i]=-1/0,t.maxSize[i]=1/0,t.offset[i]=0,t.factor[i]=1/ya[e.valueUnit],t.type[i]=1,!0):(ne(s,"Could not convert size info: scale-dependent size not supported"),!1);if(!fi(e.field)){if(e.stops?.[0]&&Vt(e.stops[0].size))return t.minSize[i]=e.stops[0].size,t.maxSize[i]=e.stops[0].size,t.offset[i]=t.minSize[i],t.factor[i]=0,t.type[i]=1,!0;if(Vt(a))return t.minSize[i]=a,t.maxSize[i]=a,t.offset[i]=a,t.factor[i]=0,t.type[i]=1,!0}return ne(s,"Could not convert size info: unsupported variant of sizeInfo"),!1}function Ga(e,t,i,r,s,a){const n=Math.abs(r-i)>0?(t-e)/(r-i):0;s.minSize[a]=n>0?e:t,s.maxSize[a]=n>0?t:e,s.offset[a]=e-i*n,s.factor[a]=n}function Wd(e,t,i,r){if(e.normalizationField||e.valueRepresentation)return ne(r,"Could not convert size info: unsupported property"),null;if(!lu(e.field))return ne(r,"Could not convert size info: field is not a string"),null;if(t.size){if(e.field)if(t.size.field){if(e.field!==t.size.field)return ne(r,"Could not convert size info: multiple fields in use"),null}else t.size.field=e.field}else t.size=new jd(e.field),Y(t.size.fallback,i.fallbackSize);let s;switch(e.axis){case"width":return s=ht(e,t.size,0,i,r),s?t:null;case"height":return s=ht(e,t.size,2,i,r),s?t:null;case"depth":return s=ht(e,t.size,1,i,r),s?t:null;case"width-and-depth":return s=ht(e,t.size,0,i,r),s&&ht(e,t.size,1,i,r),s?t:null;case null:case void 0:case"all":return s=ht(e,t.size,0,i,r),s=s&&ht(e,t.size,1,i,r),s=s&&ht(e,t.size,2,i,r),s?t:null;default:return ne(r,`Could not convert size info: unknown axis "${e.axis}""`),null}}function kd(e,t,i){for(let s=0;s<3;++s){let a=t.unitInMeters;e.type[s]===1&&(a*=t.modelSize[s],e.type[s]=2),e.minSize[s]=e.minSize[s]/a,e.maxSize[s]=e.maxSize[s]/a,e.offset[s]=e.offset[s]/a,e.factor[s]=e.factor[s]/a}let r;if(e.type[0]!==0)r=0;else if(e.type[1]!==0)r=1;else{if(e.type[2]===0)return ne(i,"No size axis contains a valid size or scale"),!1;r=2}for(let s=0;s<3;++s)e.type[s]===0&&(e.minSize[s]=e.minSize[r],e.maxSize[s]=e.maxSize[r],e.offset[s]=e.offset[r],e.factor[s]=e.factor[r],e.type[s]=e.type[r]);return!0}function Wa(e,t,i){e[4*t]=i.r/255,e[4*t+1]=i.g/255,e[4*t+2]=i.b/255,e[4*t+3]=i.a}function qd(e,t,i,r){if(e.normalizationField)return ne(r,"Could not convert color info: unsupported property"),null;if(Os(e.field)){if(!e.stops)return ne(r,"Could not convert color info: missing stops or colors"),null;{if(e.stops.length>8)return ne(r,"Could not convert color info: too many color stops"),null;t.color=new Ua(e.field);const s=e.stops;for(let a=0;a<8;++a){const n=s[Math.min(a,s.length-1)];t.color.values[a]=n.value,Wa(t.color.colors,a,n.color)}qt(t.color.fallback,i.fallbackColor)}}else{if(!(e.stops&&e.stops.length>=0))return ne(r,"Could not convert color info: no field and no colors/stops"),null;{const s=e.stops&&e.stops.length>=0&&e.stops[0].color;t.color=new Ua(null);for(let a=0;a<8;a++)t.color.values[a]=1/0,Wa(t.color.colors,a,s);qt(t.color.fallback,i.fallbackColor)}}return t}function Xd(e,t,i,r){if(e.normalizationField)return ne(r,"Could not convert opacity info: unsupported property"),null;if(Os(e.field)){if(!e.stops)return ne(r,"Could not convert opacity info: missing stops or opacities"),null;{if(e.stops.length>8)return ne(r,"Could not convert opacity info: too many opacity stops"),null;t.opacity=new Hd(e.field,i.fallbackColor[3]);const s=e.stops;for(let a=0;a<8;++a){const n=s[Math.min(a,s.length-1)];t.opacity.values[a]=n.value,t.opacity.opacityValues[a]=n.opacity}}}else{if(!(e.stops&&e.stops.length>=0))return ne(r,"Could not convert opacity info: no field and no opacities/stops"),null;{const s=e.stops&&e.stops.length>=0?e.stops[0].opacity:0;t.opacity={field:null,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0],fallback:i.fallbackColor[3]};for(let a=0;a<8;a++)t.opacity.values[a]=1/0,t.opacity.opacityValues[a]=s}}return t}function rs(e,t,i){const r=i===2&&e.rotationType==="arithmetic";t.offset[i]=r?90:0,t.factor[i]=r?-1:1,t.type[i]=1}function Yd(e,t,i){if(!Os(e.field))return ne(i,"Could not convert rotation info: field is not a string"),null;if(t.rotation){if(e.field)if(t.rotation.field){if(e.field!==t.rotation.field)return ne(i,"Could not convert rotation info: multiple fields in use"),null}else t.rotation.field=e.field}else t.rotation={field:e.field,offset:[0,0,0],factor:[1,1,1],type:[0,0,0]};switch(e.axis){case"tilt":return rs(e,t.rotation,0),t;case"roll":return rs(e,t.rotation,1),t;case null:case void 0:case"heading":return rs(e,t.rotation,2),t;default:return ne(i,`Could not convert rotation info: unknown axis "${e.axis}""`),null}}let Rv=class{constructor({supports:e,modelSize:t,symbolSize:i,unitInMeters:r,anchor:s,scale:a,rotation:n,fallbackColor:o,fallbackSize:l}){this.supports=e,this.modelSize=t??$i(),this.symbolSize=i??$i(),this.unitInMeters=r??1,this.anchor=s??Ei(),this.scale=a??$i(),this.rotation=n??Ei(),this.fallbackColor=o??Jc(),this.fallbackSize=l??$i()}};function Mo(e,t,i){if(!e)return null;const r=e.reduce((s,a)=>{if(!s)return s;if(a.valueExpression)return ne(i,"Could not convert visual variables: arcade expressions not supported"),null;switch(a.type){case"size":return t.supports.size?Wd(a,s,t,i):s;case"color":return t.supports.color?qd(a,s,t,i):s;case"opacity":return t.supports.opacity?Xd(a,s,t,i):null;case"rotation":return t.supports.rotation?Yd(a,s,i):s;default:return null}},new Ud);return!(e.length>0&&r)||r.size||r.color||r.opacity||r.rotation?r?.size&&!kd(r.size,t,i)?null:r:null}let Zd=class{constructor(e,t,i){this.visualVariables=e,this.materialParameters=t,this.requiresShaderTransformation=i}};function Fv(e,t){if(!e||js()||Vd.TESTS_DISABLE_FAST_UPDATES)return null;const i=Mo(e.visualVariables,t);return i?new Zd(i,Co(i,t),!!i.size):null}function Pv(e,t,i){if(!t||!e)return!1;const r=e.visualVariables,s=Mo(t.visualVariables,i);return!!s&&!!(Yi(r.size,s.size,"size")&&Yi(r.color,s.color,"color")&&Yi(r.rotation,s.rotation,"rotation")&&Yi(r.opacity,s.opacity,"opacity"))&&(e.visualVariables=s,e.materialParameters=Co(s,i),e.requiresShaderTransformation=!!s.size,!0)}function Yi(e,t,i){if(!!e!=!!t||e&&e.field!==t?.field)return!1;if(e&&i==="rotation"){const r=e,s=t;for(let a=0;a<3;a++)if(r.type[a]!==s.type[a]||r.offset[a]!==s.offset[a]||r.factor[a]!==s.factor[a])return!1}return!0}class So extends Be{constructor(t){super(),this.vvSize=t?.size??null,this.vvColor=t?.color??null,this.vvOpacity=t?.opacity??null}get hasVVSize(){return!!this.vvSize}get hasVVColor(){return!!this.vvColor}get hasVVOpacity(){return!!this.vvOpacity}}function Co(e,t){const i=new So(e);return i.vvSize&&(i.vvSymbolAnchor=t.anchor,kc(wi),Gd(t.rotation[2],t.rotation[0],t.rotation[1],wi),i.vvSymbolRotationMatrix=i.vvSymbolRotationMatrix||wt(),Rn(i.vvSymbolRotationMatrix,wi)),i}function Av(e,t,i){if(!e.vvSize)return i;ei(dt,i);const r=e.vvSymbolRotationMatrix;return jc(wi,r[0],r[1],r[2],0,r[3],r[4],r[5],0,r[6],r[7],r[8],0,0,0,0,1),Ii(dt,dt,wi),Jd(ka,e,t),Hc(dt,dt,ka),_r(dt,dt,e.vvSymbolAnchor),dt}function Jd(e,t,i){if(!t.vvSize)return G(e,1,1,1),e;if(Number.isNaN(i[0]))return Y(e,t.vvSize.fallback);for(let r=0;r<3;++r){const s=t.vvSize.offset[r]+i[0]*t.vvSize.factor[r];e[r]=Ve(s,t.vvSize.minSize[r],t.vvSize.maxSize[r])}return e}function Ov(e,t){const i=e==null?0:t.attributes[e];return typeof i=="number"&&isFinite(i)?i:NaN}const dt=ae(),ka=g(),wi=ae();function Kd(e){e.vertex.code.add(h`float screenSizePerspectiveViewAngleDependentFactor(float absCosAngle) {
return absCosAngle * absCosAngle * absCosAngle;
}`),e.vertex.code.add(h`vec3 screenSizePerspectiveScaleFactor(float absCosAngle, float distanceToCamera, vec3 params) {
return vec3(
min(params.x / (distanceToCamera - params.y), 1.0),
screenSizePerspectiveViewAngleDependentFactor(absCosAngle),
params.z
);
}`),e.vertex.code.add(h`float applyScreenSizePerspectiveScaleFactorFloat(float size, vec3 factor) {
return size * clamp(mix(factor.x, 1.0, factor.y), factor.z, 1.0);
}`),e.vertex.code.add(h`float screenSizePerspectiveScaleFloat(float size, float absCosAngle, float distanceToCamera, vec3 params) {
return applyScreenSizePerspectiveScaleFactorFloat(
size,
screenSizePerspectiveScaleFactor(absCosAngle, distanceToCamera, params)
);
}`),e.vertex.code.add(h`vec2 applyScreenSizePerspectiveScaleFactorVec2(vec2 size, vec3 factor) {
return size * clamp(mix(factor.x, 1.0, factor.y), factor.z, 1.0);
}`),e.vertex.code.add(h`vec2 screenSizePerspectiveScaleVec2(vec2 size, float absCosAngle, float distanceToCamera, vec3 params) {
return applyScreenSizePerspectiveScaleFactorVec2(size, screenSizePerspectiveScaleFactor(absCosAngle, distanceToCamera, params));
}`)}function Dv(e){e.uniforms.add(new ue("screenSizePerspective",t=>Eo(t.screenSizePerspective,t.screenSizePerspectiveMinPixelReferenceSize)))}function Qd(e){e.uniforms.add(new ue("screenSizePerspectiveAlignment",t=>Eo(t.screenSizePerspectiveAlignment||t.screenSizePerspective,t.screenSizePerspectiveAlignment?null:t.screenSizePerspectiveMinPixelReferenceSize)))}function Eo(e,t){const i=t!=null&&e!=null?Math.min(e.minPixelSize/t,1):0;return e?G(qa,e.divisor,e.offset,i):G(qa,0,0,0)}const qa=g();let yt=class extends ie{constructor(e,t,i){super(e,"float",0,(r,s)=>r.setUniform1f(e,t(s),i))}},ef=class extends ie{constructor(e,t,i){super(e,"mat4",2,(r,s,a)=>r.setUniformMatrix4fv(e,t(s,a),i))}};function Fi(e,t){t.instancedDoublePrecision?e.constants.add("cameraPosition","vec3",ot):e.uniforms.add(new Ne("cameraPosition",(i,r)=>G(Io,r.camera.viewInverseTransposeMatrix[3]-i.origin[0],r.camera.viewInverseTransposeMatrix[7]-i.origin[1],r.camera.viewInverseTransposeMatrix[11]-i.origin[2])))}function Xt(e,t){if(!t.instancedDoublePrecision)return void e.uniforms.add(new or("proj",r=>r.camera.projectionMatrix),new ef("view",(r,s)=>_r(Xa,s.camera.viewMatrix,r.origin)),new Ne("localOrigin",r=>r.origin));const i=({camera:r})=>G(Io,r.viewInverseTransposeMatrix[3],r.viewInverseTransposeMatrix[7],r.viewInverseTransposeMatrix[11]);e.uniforms.add(new or("proj",r=>r.camera.projectionMatrix),new or("view",r=>_r(Xa,r.camera.viewMatrix,i(r))),new zt("localOrigin",r=>i(r)))}const Xa=ae(),Io=g();function tf(e){e.uniforms.add(new or("viewNormal",t=>t.camera.viewInverseTransposeMatrix))}function zv(e){e.uniforms.add(new yt("pixelRatio",t=>t.camera.pixelRatio/t.overlayStretch))}let Nr=class extends ie{constructor(e,t,i){super(e,"vec4",1,(r,s,a)=>r.setUniform4fv(e,t(s,a),i))}},Nv=class{constructor(e){this.screenLength=nu(e.screenLength),this.minWorldLength=e.minWorldLength??0,this.maxWorldLength=e.maxWorldLength??1/0}};function Ro(e,t){const i=e.vertex;t.hasVerticalOffset?(sf(i),t.hasScreenSizePerspective&&(e.include(Kd),Qd(i),Fi(e.vertex,t)),i.code.add(h`
      vec3 calculateVerticalOffset(vec3 worldPos, vec3 localOrigin) {
        float viewDistance = length((view * vec4(worldPos, 1.0)).xyz);
        ${t.spherical?h`vec3 worldNormal = normalize(worldPos + localOrigin);`:h`vec3 worldNormal = vec3(0.0, 0.0, 1.0);`}
        ${t.hasScreenSizePerspective?h`
            float cosAngle = dot(worldNormal, normalize(worldPos - cameraPosition));
            float verticalOffsetScreenHeight = screenSizePerspectiveScaleFloat(verticalOffset.x, abs(cosAngle), viewDistance, screenSizePerspectiveAlignment);`:h`
            float verticalOffsetScreenHeight = verticalOffset.x;`}
        // Screen sized offset in world space, used for example for line callouts
        float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * viewDistance, verticalOffset.z, verticalOffset.w);
        return worldNormal * worldOffset;
      }

      vec3 addVerticalOffset(vec3 worldPos, vec3 localOrigin) {
        return worldPos + calculateVerticalOffset(worldPos, localOrigin);
      }
    `)):i.code.add(h`vec3 addVerticalOffset(vec3 worldPos, vec3 localOrigin) { return worldPos; }`)}const rf=nt();function sf(e){e.uniforms.add(new Nr("verticalOffset",(t,i)=>{const{minWorldLength:r,maxWorldLength:s,screenLength:a}=t.verticalOffset,n=Math.tan(.5*i.camera.fovY)/(.5*i.camera.fullViewport[3]),o=i.camera.pixelRatio||1;return Ce(rf,a*o,n,r,s)}))}let De=class extends ie{constructor(e,t,i){super(e,"vec4",0,(r,s)=>r.setUniform4fv(e,t(s),i))}},af=class{constructor(e){this._material=e.material,this._techniques=e.techniques,this._output=e.output}dispose(){}get _stippleTextures(){return this._techniques.context?.stippleTextures}get _markerTextures(){return this._techniques.context?.markerTextures}getTechnique(e,t){return this._techniques.get(e,this._material.getConfiguration(this._output,t))}ensureResources(e){return 2}},nf=class extends af{constructor(e){super(e),this._numLoading=0,this._disposed=!1,this._textures=e.textures,this.updateTexture(e.textureId),this._acquire(e.normalTextureId,t=>this._textureNormal=t),this._acquire(e.emissiveTextureId,t=>this._textureEmissive=t),this._acquire(e.occlusionTextureId,t=>this._textureOcclusion=t),this._acquire(e.metallicRoughnessTextureId,t=>this._textureMetallicRoughness=t)}dispose(){super.dispose(),this._texture=Et(this._texture),this._textureNormal=Et(this._textureNormal),this._textureEmissive=Et(this._textureEmissive),this._textureOcclusion=Et(this._textureOcclusion),this._textureMetallicRoughness=Et(this._textureMetallicRoughness),this._disposed=!0}ensureResources(e){return this._numLoading===0?2:1}get textureBindParameters(){return new lf(this._texture?.glTexture??null,this._textureNormal?.glTexture??null,this._textureEmissive?.glTexture??null,this._textureOcclusion?.glTexture??null,this._textureMetallicRoughness?.glTexture??null)}updateTexture(e){this._texture!=null&&e===this._texture.id||(this._texture=Et(this._texture),this._acquire(e,t=>this._texture=t))}_acquire(e,t){if(e==null)return void t(null);const i=this._textures.acquire(e);if(Xl(i))return++this._numLoading,void i.then(r=>{if(this._disposed)return Et(r),void t(null);t(r)}).finally(()=>--this._numLoading);t(i)}},of=class extends Be{constructor(e=null){super(),this.textureEmissive=e}},lf=class extends of{constructor(e,t,i,r,s,a,n){super(i),this.texture=e,this.textureNormal=t,this.textureOcclusion=r,this.textureMetallicRoughness=s,this.scale=a,this.normalTextureTransformMatrix=n}},cf=class extends Td{constructor(){super(...arguments),this.instancedDoublePrecision=!1,this.hasModelTransformation=!1}},Yt=class extends cf{constructor(){super(...arguments),this.output=0,this.oitPass=0,this.hasSlicePlane=!1,this.hasHighlightMixTexture=!1,this.bindType=1,this.instanced=!1,this.writeDepth=!0}};f([V({count:11})],Yt.prototype,"output",void 0),f([V({count:3})],Yt.prototype,"oitPass",void 0),f([V()],Yt.prototype,"hasSlicePlane",void 0),f([V()],Yt.prototype,"hasHighlightMixTexture",void 0);function uf(e,t,i,r,s,a){let n=i.screenLength*e.pixelRatio;s!=null&&(Za.update(r,t,s,a),n=Za.apply(n));const o=n*Math.tan(.5*e.fovY)/(.5*e.fullHeight);return Ve(o*t,i.minWorldLength,i.maxWorldLength)}const hf=Ll();function Ya(e,t){let i=!1;for(const r in t){const s=t[r];s!==void 0&&(Array.isArray(s)?Array.isArray(e[r])&&hf(s,e[r])||(e[r]=s.slice(),i=!0):e[r]!==s&&(i=!0,e[r]=s))}return i}const Ti={multiply:1,ignore:2,replace:3,tint:4},Za=new Is;let df=class{constructor(e,t){this.id=Cr(),this.supportsEdges=!1,this._renderPriority=0,this._parameters=new t,Ya(this._parameters,e),this.validateParameters(this._parameters)}get parameters(){return this._parameters}update(e){return!1}setParameters(e,t=!0){Ya(this._parameters,e)&&(this.validateParameters(this._parameters),t&&this._parametersChanged())}validateParameters(e){}shouldRender(e){return this.visible&&this.isVisibleForOutput(e.output)&&(!this.parameters.isDecoration||e.bind.decorations)&&(this.parameters.renderOccluded&e.renderOccludedMask)!==0}isVisibleForOutput(e){return!0}get renderPriority(){return this._renderPriority}set renderPriority(e){e!==this._renderPriority&&(this._renderPriority=e,this._parametersChanged())}_parametersChanged(){this.repository?.materialChanged(this)}get renderOccludedFlags(){return this.visible?this.parameters.renderOccluded:0}get hasEmissions(){return!1}getConfiguration(e,t,i=new Yt){return i.output=e,i.hasHighlightMixTexture=e===9&&t.highlightMixTexture!=null,i}},Vv=class extends Be{constructor(){super(...arguments),this.renderOccluded=1,this.isDecoration=!1}};function Bv(e,t,i,r=1){const{data:s,indices:a}=e,n=t.typedBuffer,o=t.typedBufferStride,l=a.length;if(i*=o,r===1)for(let c=0;c<l;++c)n[i]=s[a[c]],i+=o;else for(let c=0;c<l;++c){const u=s[a[c]];for(let d=0;d<r;d++)n[i]=u,i+=o}}function ss(e,t,i){const{data:r,indices:s}=e,a=t.typedBuffer,n=t.typedBufferStride,o=s.length;i*=n;for(let l=0;l<o;++l){const c=2*s[l];a[i]=r[c],a[i+1]=r[c+1],i+=n}}function Us(e,t,i,r=1){const{data:s,indices:a}=e,n=t.typedBuffer,o=t.typedBufferStride,l=a.length;if(i*=o,r===1)for(let c=0;c<l;++c){const u=3*a[c];n[i]=s[u],n[i+1]=s[u+1],n[i+2]=s[u+2],i+=o}else for(let c=0;c<l;++c){const u=3*a[c];for(let d=0;d<r;++d)n[i]=s[u],n[i+1]=s[u+1],n[i+2]=s[u+2],i+=o}}function Fo(e,t,i,r=1){const{data:s,indices:a}=e,n=t.typedBuffer,o=t.typedBufferStride,l=a.length;if(i*=o,r===1)for(let c=0;c<l;++c){const u=4*a[c];n[i]=s[u],n[i+1]=s[u+1],n[i+2]=s[u+2],n[i+3]=s[u+3],i+=o}else for(let c=0;c<l;++c){const u=4*a[c];for(let d=0;d<r;++d)n[i]=s[u],n[i+1]=s[u+1],n[i+2]=s[u+2],n[i+3]=s[u+3],i+=o}}function $v(e,t,i){const r=e.typedBuffer,s=e.typedBufferStride;t*=s;for(let a=0;a<i;++a)r[t]=0,r[t+1]=0,r[t+2]=0,r[t+3]=0,t+=s}function ff(e,t,i,r,s=1){if(!t)return void Us(e,i,r,s);const{data:a,indices:n}=e,o=i.typedBuffer,l=i.typedBufferStride,c=n.length,u=t[0],d=t[1],m=t[2],v=t[4],p=t[5],_=t[6],y=t[8],w=t[9],T=t[10],M=t[12],E=t[13],I=t[14];r*=l;let N=0,R=0,C=0;const S=On(t)?A=>{N=a[A]+M,R=a[A+1]+E,C=a[A+2]+I}:A=>{const b=a[A],O=a[A+1],P=a[A+2];N=u*b+v*O+y*P+M,R=d*b+p*O+w*P+E,C=m*b+_*O+T*P+I};if(s===1)for(let A=0;A<c;++A)S(3*n[A]),o[r]=N,o[r+1]=R,o[r+2]=C,r+=l;else for(let A=0;A<c;++A){S(3*n[A]);for(let b=0;b<s;++b)o[r]=N,o[r+1]=R,o[r+2]=C,r+=l}}function pf(e,t,i,r,s=1){if(!t)return void Us(e,i,r,s);const{data:a,indices:n}=e,o=t,l=i.typedBuffer,c=i.typedBufferStride,u=n.length,d=o[0],m=o[1],v=o[2],p=o[4],_=o[5],y=o[6],w=o[8],T=o[9],M=o[10],E=!Dn(o),I=1e-6,N=1-I;r*=c;let R=0,C=0,S=0;const A=On(o)?b=>{R=a[b],C=a[b+1],S=a[b+2]}:b=>{const O=a[b],P=a[b+1],D=a[b+2];R=d*O+p*P+w*D,C=m*O+_*P+T*D,S=v*O+y*P+M*D};if(s===1)if(E)for(let b=0;b<u;++b){A(3*n[b]);const O=R*R+C*C+S*S;if(O<N&&O>I){const P=1/Math.sqrt(O);l[r]=R*P,l[r+1]=C*P,l[r+2]=S*P}else l[r]=R,l[r+1]=C,l[r+2]=S;r+=c}else for(let b=0;b<u;++b)A(3*n[b]),l[r]=R,l[r+1]=C,l[r+2]=S,r+=c;else for(let b=0;b<u;++b){if(A(3*n[b]),E){const O=R*R+C*C+S*S;if(O<N&&O>I){const P=1/Math.sqrt(O);R*=P,C*=P,S*=P}}for(let O=0;O<s;++O)l[r]=R,l[r+1]=C,l[r+2]=S,r+=c}}function mf(e,t,i,r,s=1){if(!t)return void Fo(e,i,r,s);const{data:a,indices:n}=e,o=t,l=i.typedBuffer,c=i.typedBufferStride,u=n.length,d=o[0],m=o[1],v=o[2],p=o[4],_=o[5],y=o[6],w=o[8],T=o[9],M=o[10],E=!Dn(o),I=1e-6,N=1-I;if(r*=c,s===1)for(let R=0;R<u;++R){const C=4*n[R],S=a[C],A=a[C+1],b=a[C+2],O=a[C+3];let P=d*S+p*A+w*b,D=m*S+_*A+T*b,L=v*S+y*A+M*b;if(E){const j=P*P+D*D+L*L;if(j<N&&j>I){const H=1/Math.sqrt(j);P*=H,D*=H,L*=H}}l[r]=P,l[r+1]=D,l[r+2]=L,l[r+3]=O,r+=c}else for(let R=0;R<u;++R){const C=4*n[R],S=a[C],A=a[C+1],b=a[C+2],O=a[C+3];let P=d*S+p*A+w*b,D=m*S+_*A+T*b,L=v*S+y*A+M*b;if(E){const j=P*P+D*D+L*L;if(j<N&&j>I){const H=1/Math.sqrt(j);P*=H,D*=H,L*=H}}for(let j=0;j<s;++j)l[r]=P,l[r+1]=D,l[r+2]=L,l[r+3]=O,r+=c}}function gf(e,t,i,r,s=1){const{data:a,indices:n}=e,o=i.typedBuffer,l=i.typedBufferStride,c=n.length;if(r*=l,t===a.length&&t===4){o[r]=a[0],o[r+1]=a[1],o[r+2]=a[2],o[r+3]=a[3];const u=new Uint32Array(i.typedBuffer.buffer,i.start),d=l/4,m=u[r/=4];r+=d;const v=c*s;for(let p=1;p<v;++p)u[r]=m,r+=d;return}if(s!==1)if(t!==4)for(let u=0;u<c;++u){const d=3*n[u];for(let m=0;m<s;++m)o[r]=a[d],o[r+1]=a[d+1],o[r+2]=a[d+2],o[r+3]=255,r+=l}else for(let u=0;u<c;++u){const d=4*n[u];for(let m=0;m<s;++m)o[r]=a[d],o[r+1]=a[d+1],o[r+2]=a[d+2],o[r+3]=a[d+3],r+=l}else{if(t===4){for(let u=0;u<c;++u){const d=4*n[u];o[r]=a[d],o[r+1]=a[d+1],o[r+2]=a[d+2],o[r+3]=a[d+3],r+=l}return}for(let u=0;u<c;++u){const d=3*n[u];o[r]=a[d],o[r+1]=a[d+1],o[r+2]=a[d+2],o[r+3]=255,r+=l}}}function vf(e,t,i){const{data:r,indices:s}=e,a=t.typedBuffer,n=t.typedBufferStride,o=s.length,l=r[0];i*=n;for(let c=0;c<o;++c)a[i]=l,i+=n}function jv(e,t,i,r){ce(Rt,e,t);const s=Math.max(Math.sqrt(te(Rt)),1e-4);q(Rt,Rt,1/s),i[r++]=Rt[0],i[r++]=Rt[1],i[r++]=Rt[2],i[r++]=s}const Rt=g();function _f(e,t,i,r,s=1){const a=t.typedBuffer,n=t.typedBufferStride;if(r*=n,s===1)for(let o=0;o<i;++o)a[r]=e[0],a[r+1]=e[1],a[r+2]=e[2],a[r+3]=e[3],r+=n;else for(let o=0;o<i;++o)for(let l=0;l<s;++l)a[r]=e[0],a[r+1]=e[1],a[r+2]=e[2],a[r+3]=e[3],r+=n}function xf(e,t,i,r,s,a,n){let o={numItems:0,numVerticesPerItem:0};for(const l of i.fields.keys()){const c=e.get(l),u=c?.indices;if(c&&u)l==="position"&&(o={numItems:1,numVerticesPerItem:u.length}),yf(l,c,r,s,a,n);else if(l==="olidColor"&&t!=null){const d=e.get("position")?.indices;if(d){const m=d.length;_f(t,a.getField(l,ri),m,n)}}}return o}function yf(e,t,i,r,s,a){switch(e){case"position":{W(t.size===3);const n=s.getField(e,ir);W(!!n,`No buffer view for ${e}`),ff(t,i,n,a);break}case"normal":{W(t.size===3);const n=s.getField(e,ir);W(!!n,`No buffer view for ${e}`),pf(t,r,n,a);break}case"normalCompressed":case"profileRight":case"profileUp":{W(t.size===2);const n=s.getField(e,da);W(!!n,`No buffer view for ${e}`),ss(t,n,a);break}case"uv0":{W(t.size===2);const n=s.getField(e,ec)??s.getField(e,tc);W(!!n,`No buffer view for ${e}`),ss(t,n,a);break}case"uvi":{W(t.size===2);const n=s.getField(e,da);W(!!n,`No buffer view for ${e}`),ss(t,n,a);break}case"color":case"symbolColor":{const n=s.getField(e,ri);W(!!n,`No buffer view for ${e}`),W(t.size===3||t.size===4),gf(t,t.size,n,a);break}case"colorFeatureAttribute":case"opacityFeatureAttribute":case"sizeFeatureAttribute":{const n=s.getField(e,ha)??s.getField(e,ha);W(!!n,`No buffer view for ${e}`),W(t.size===1),vf(t,n,a);break}case"tangent":{W(t.size===4);const n=s.getField(e,fr);W(!!n,`No buffer view for ${e}`),mf(t,i,n,a);break}case"profileVertexAndNormal":{W(t.size===4);const n=s.getField(e,Ql)??s.getField(e,fr);W(!!n,`No buffer view for ${e}`),Fo(t,n,a);break}case"profileAuxData":{W(t.size===3);const n=s.getField(e,Kl)??s.getField(e,ir);W(!!n,`No buffer view for ${e}`),Us(t,n,a);break}}}let Hv=class extends Be{constructor(e){super(),this.slicePlaneLocalOrigin=e}};function Uv(e,t){Ao(e,t,new ue("slicePlaneOrigin",(i,r)=>Gs(t,i,r)),new ue("slicePlaneBasis1",(i,r)=>ai(t,i,r,r.slicePlane?.basis1)),new ue("slicePlaneBasis2",(i,r)=>ai(t,i,r,r.slicePlane?.basis2)))}function Zt(e,t){Ao(e,t,new Ne("slicePlaneOrigin",(i,r)=>Gs(t,i,r)),new Ne("slicePlaneBasis1",(i,r)=>ai(t,i,r,r.slicePlane?.basis1)),new Ne("slicePlaneBasis2",(i,r)=>ai(t,i,r,r.slicePlane?.basis2)))}function Gv(e,t){Po(e,t,new Ne("slicePlaneOrigin",(i,r)=>Gs(t,i,r)),new Ne("slicePlaneBasis1",(i,r)=>ai(t,i,r,r.slicePlane?.basis1)),new Ne("slicePlaneBasis2",(i,r)=>ai(t,i,r,r.slicePlane?.basis2)))}const bf=h`struct SliceFactors {
float front;
float side0;
float side1;
float side2;
float side3;
};
SliceFactors calculateSliceFactors(vec3 pos) {
vec3 rel = pos - slicePlaneOrigin;
vec3 slicePlaneNormal = -cross(slicePlaneBasis1, slicePlaneBasis2);
float slicePlaneW = -dot(slicePlaneNormal, slicePlaneOrigin);
float basis1Len2 = dot(slicePlaneBasis1, slicePlaneBasis1);
float basis2Len2 = dot(slicePlaneBasis2, slicePlaneBasis2);
float basis1Dot = dot(slicePlaneBasis1, rel);
float basis2Dot = dot(slicePlaneBasis2, rel);
return SliceFactors(
dot(slicePlaneNormal, pos) + slicePlaneW,
-basis1Dot - basis1Len2,
basis1Dot - basis1Len2,
-basis2Dot - basis2Len2,
basis2Dot - basis2Len2
);
}
bool sliceByFactors(SliceFactors factors) {
return factors.front < 0.0
&& factors.side0 < 0.0
&& factors.side1 < 0.0
&& factors.side2 < 0.0
&& factors.side3 < 0.0;
}
bool sliceEnabled() {
return dot(slicePlaneBasis1, slicePlaneBasis1) != 0.0;
}
bool sliceByPlane(vec3 pos) {
return sliceEnabled() && sliceByFactors(calculateSliceFactors(pos));
}
bool rejectBySlice(vec3 pos) {
return sliceByPlane(pos);
}`;function Po(e,t,...i){t.hasSlicePlane?(e.uniforms.add(...i),e.code.add(bf)):e.code.add("bool rejectBySlice(vec3 pos) { return false; }")}function Ao(e,t,...i){Po(e,t,...i),t.hasSlicePlane?e.code.add(`
    void discardBySlice(vec3 pos) {
      if (sliceByPlane(pos)) {
        discard;
      }
    }

    vec4 applySliceOutline(vec4 color, vec3 pos) {
      SliceFactors factors = calculateSliceFactors(pos);

      factors.front /= 2.0 * fwidth(factors.front);
      factors.side0 /= 2.0 * fwidth(factors.side0);
      factors.side1 /= 2.0 * fwidth(factors.side1);
      factors.side2 /= 2.0 * fwidth(factors.side2);
      factors.side3 /= 2.0 * fwidth(factors.side3);

      // return after calling fwidth, to avoid aliasing caused by discontinuities in the input to fwidth
      if (sliceByFactors(factors)) {
        return color;
      }

      float outlineFactor = (1.0 - step(0.5, factors.front))
        * (1.0 - step(0.5, factors.side0))
        * (1.0 - step(0.5, factors.side1))
        * (1.0 - step(0.5, factors.side2))
        * (1.0 - step(0.5, factors.side3));

      return mix(color, vec4(vec3(0.0), color.a), outlineFactor * 0.3);
    }

    vec4 applySlice(vec4 color, vec3 pos) {
      return sliceEnabled() ? applySliceOutline(color, pos) : color;
    }
  `):e.code.add(h`void discardBySlice(vec3 pos) { }
vec4 applySlice(vec4 color, vec3 pos) { return color; }`)}function Oo(e,t,i){return e.instancedDoublePrecision?G(wf,i.camera.viewInverseTransposeMatrix[3],i.camera.viewInverseTransposeMatrix[7],i.camera.viewInverseTransposeMatrix[11]):t.slicePlaneLocalOrigin}function Do(e,t){return e!=null?ce(br,t.origin,e):t.origin}function zo(e,t,i){return e.hasSliceTranslatedView?t!=null?_r(Tf,i.camera.viewMatrix,t):i.camera.viewMatrix:null}function Gs(e,t,i){if(i.slicePlane==null)return ot;const r=Oo(e,t,i),s=Do(r,i.slicePlane),a=zo(e,r,i);return a!=null?Pe(br,s,a):s}function ai(e,t,i,r){if(r==null||i.slicePlane==null)return ot;const s=Oo(e,t,i),a=Do(s,i.slicePlane),n=zo(e,s,i);return n!=null?(pe(pi,r,a),Pe(br,a,n),Pe(pi,pi,n),ce(pi,pi,br)):r}const wf=g(),br=g(),pi=g(),Tf=ae();function Mf(e,t){if(t.output!==10)return e.vertex.code.add(h`void forwardObjectAndLayerIdColor() {}`),void e.fragment.code.add(h`void outputObjectAndLayerIdColor() {}`);const i=t.instanced;e.varyings.add("objectAndLayerIdColorVarying","vec4");const r=i?"instanceOlidColor":"olidColor";e.attributes.add(r,"vec4"),e.vertex.code.add(h`
    void forwardObjectAndLayerIdColor() {
      objectAndLayerIdColorVarying = ${r} * 0.003921568627451;
    }`),e.fragment.code.add(h`void outputObjectAndLayerIdColor() {
fragColor = objectAndLayerIdColorVarying;
}`)}let Sf=class extends ie{constructor(e,t){super(e,"bool",0,(i,r)=>i.setUniform1b(e,t(r)))}},Lr=class extends ie{constructor(e,t,i){super(e,"vec2",0,(r,s)=>r.setUniform2fv(e,t(s),i))}};function Ws(e){e.uniforms.add(new Lr("zProjectionMap",t=>Cf(t.camera))),e.code.add(h`float linearizeDepth(float depth) {
float depthNdc = depth * 2.0 - 1.0;
float c1 = zProjectionMap[0];
float c2 = zProjectionMap[1];
return -(c1 / (depthNdc + c2 + 1e-7));
}`),e.code.add(h`float delinearizeDepth(float linearDepth) {
float c1 = zProjectionMap[0];
float c2 = zProjectionMap[1];
float depthNdc = (-c1/linearDepth) - c2 - 1e-7;
float depthNonlinear01 = (depthNdc + 1.0 ) / 2.0;
return depthNonlinear01;
}`),e.code.add(h`float depthFromTexture(sampler2D depthTexture, vec2 uv) {
ivec2 iuv = ivec2(uv * vec2(textureSize(depthTexture, 0)));
float depth = texelFetch(depthTexture, iuv, 0).r;
return depth;
}`),e.code.add(h`float linearDepthFromTexture(sampler2D depthTexture, vec2 uv) {
return linearizeDepth(depthFromTexture(depthTexture, uv));
}`)}function Cf(e){const t=e.projectionMatrix;return Dt(Ef,t[14],t[10])}const Ef=zi();let ks=class extends ie{constructor(e,t){super(e,"sampler2D",0,(i,r)=>i.bindTexture(e,t(r)))}};function No(e,{occlusionPass:t,terrainDepthTest:i,cullAboveTerrain:r}){const{vertex:s,fragment:a,varyings:n}=e;if(!i)return s.code.add("void forwardViewPosDepth(vec3 pos) {}"),void a.code.add(`${t?"bool":"void"} discardByTerrainDepth() { ${U(t,"return false;")}}`);n.add("viewPosDepth","float",{invariant:!0}),s.code.add(`void forwardViewPosDepth(vec3 pos) {
    viewPosDepth = pos.z;
  }`),a.include(Ws),a.uniforms.add(new ks("terrainDepthTexture",o=>o.terrainDepth?.attachment)).code.add(h`
    ${t?"bool":"void"} discardByTerrainDepth() {
      float depth = texelFetch(terrainDepthTexture, ivec2(gl_FragCoord.xy), 0).r;
      float linearDepth = linearizeDepth(depth);
      ${t?"return viewPosDepth < linearDepth && depth < 1.0;":`if(viewPosDepth ${r?">":"<="} linearDepth) discard;`}
    }`)}function If(e){const{fragment:t}=e;t.code.add(h`uint readChannelBits(uint channel, int highlightLevel) {
int llc = (highlightLevel & 3) << 1;
return (channel >> llc) & 3u;
}
uint readChannel(uvec2 texel, int highlightLevel) {
int lic = (highlightLevel >> 2) & 1;
return texel[lic];
}
uint readLevelBits(uvec2 texel, int highlightLevel) {
return readChannelBits(readChannel(texel, highlightLevel), highlightLevel);
}`)}let Rf=class extends ie{constructor(e,t){super(e,"ivec2",0,(i,r)=>i.setUniform2iv(e,t(r)))}},Lo=class extends ie{constructor(e,t){super(e,"int",0,(i,r)=>i.setUniform1i(e,t(r)))}},Ff=class extends ie{constructor(e,t){super(e,"usampler2D",0,(i,r)=>i.bindTexture(e,t(r)))}};function Vo(e,t){const{fragment:i}=e,{output:r,draped:s,hasHighlightMixTexture:a}=t;r===9?(i.uniforms.add(new Lo("highlightLevel",n=>n.highlightLevel??0),new Rf("highlightMixOrigin",n=>n.highlightMixOrigin)),e.outputs.add("fragHighlight","uvec2",0),e.include(If),a?i.uniforms.add(new Ff("highlightMixTexture",n=>n.highlightMixTexture)).code.add(h`uvec2 getAccumulatedHighlight() {
return texelFetch(highlightMixTexture, ivec2(gl_FragCoord.xy) - highlightMixOrigin, 0).rg;
}
void outputHighlight(bool occluded) {
if (highlightLevel == 0) {
uint bits = occluded ? 3u : 1u;
fragHighlight = uvec2(bits, 0);
} else {
int ll = (highlightLevel & 3) << 1;
int li = (highlightLevel >> 2) & 3;
uint bits;
if (occluded) {
bits = 3u << ll;
} else {
bits = 1u << ll;
}
uvec2 combinedHighlight = getAccumulatedHighlight();
combinedHighlight[li] |= bits;
fragHighlight = combinedHighlight;
}
}`):i.code.add(h`void outputHighlight(bool occluded) {
uint bits = occluded ? 3u : 1u;
fragHighlight = uvec2(bits, 0);
}`),s?i.code.add(h`bool isHighlightOccluded() {
return false;
}`):i.uniforms.add(new ks("depthTexture",n=>n.mainDepth)).code.add(h`bool isHighlightOccluded() {
float sceneDepth = texelFetch(depthTexture, ivec2(gl_FragCoord.xy), 0).x;
return gl_FragCoord.z > sceneDepth + 5e-7;
}`),i.code.add(h`void calculateOcclusionAndOutputHighlight() {
outputHighlight(isHighlightOccluded());
}`)):i.code.add(h`void calculateOcclusionAndOutputHighlight() {}`)}function Tt(e){e.code.add(h`struct MaskedColor {
vec4 color;
bvec4 mask;
};`)}function Bo(e){e.include(Tt),e.code.add(h`
    MaskedColor createMaskedFromUInt8NaNColor(vec4 color) {
      return MaskedColor(color * ${h.float(1/254)}, equal(color, vec4(255)));
    }
  `)}function qs(e){e.include(Tt),e.code.add(h`vec4 maskedColorSelectOrOne(MaskedColor color) {
return vec4(
color.mask.r ? 1.0 : color.color.r,
color.mask.g ? 1.0 : color.color.g,
color.mask.b ? 1.0 : color.color.b,
color.mask.a ? 1.0 : color.color.a
);
}
MaskedColor multiplyMaskedColors(MaskedColor color1, MaskedColor color2) {
vec4 masked1 = maskedColorSelectOrOne(color1);
vec4 masked2 = maskedColorSelectOrOne(color2);
return MaskedColor(masked1 * masked2, bvec4(ivec4(color1.mask) & ivec4(color2.mask)));
}`)}function Xs(e){e.include(Tt),e.code.add(h`MaskedColor createMaskedFromNaNColor(vec4 color) {
return MaskedColor(color, isnan(color));
}`)}let Pf=class extends ie{constructor(e,t,i,r){super(e,"vec4",1,(s,a,n)=>s.setUniform4fv(e,t(a,n),r),i)}},Af=class extends ie{constructor(e,t,i,r){super(e,"float",1,(s,a,n)=>s.setUniform1fv(e,t(a,n),r),i)}},Wv=class extends So{constructor(){super(...arguments),this.renderOccluded=1,this.isDecoration=!1}};const as=8;function Mi(e,t){const{vertex:i,attributes:r}=e;t.hasVVInstancing&&(t.hasVVSize||t.hasVVColor)&&r.add("instanceFeatureAttribute","vec4"),t.hasVVSize?(i.uniforms.add(new ue("vvSizeMinSize",s=>s.vvSize.minSize)),i.uniforms.add(new ue("vvSizeMaxSize",s=>s.vvSize.maxSize)),i.uniforms.add(new ue("vvSizeOffset",s=>s.vvSize.offset)),i.uniforms.add(new ue("vvSizeFactor",s=>s.vvSize.factor)),i.uniforms.add(new ue("vvSizeFallback",s=>s.vvSize.fallback)),i.uniforms.add(new Ye("vvSymbolRotationMatrix",s=>s.vvSymbolRotationMatrix)),i.uniforms.add(new ue("vvSymbolAnchor",s=>s.vvSymbolAnchor)),i.code.add(h`vec3 vvScale(vec4 _featureAttribute) {
if (isnan(_featureAttribute.x)) {
return vvSizeFallback;
}
return clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize);
}
vec4 vvTransformPosition(vec3 position, vec4 _featureAttribute) {
return vec4(vvSymbolRotationMatrix * ( vvScale(_featureAttribute) * (position + vvSymbolAnchor)), 1.0);
}`),i.code.add(h`
      const float eps = 1.192092896e-07;
      vec4 vvTransformNormal(vec3 _normal, vec4 _featureAttribute) {
        vec3 scale = max(vvScale(_featureAttribute), eps);
        return vec4(vvSymbolRotationMatrix * _normal / scale, 1.0);
      }

      ${t.hasVVInstancing?h`
      vec4 vvLocalNormal(vec3 _normal) {
        return vvTransformNormal(_normal, instanceFeatureAttribute);
      }

      vec4 localPosition() {
        return vvTransformPosition(position, instanceFeatureAttribute);
      }`:""}
    `)):i.code.add(h`vec4 localPosition() { return vec4(position, 1.0); }
vec4 vvLocalNormal(vec3 _normal) { return vec4(_normal, 1.0); }`),e.vertex.include(Tt),t.hasVVColor?(i.constants.add("vvColorNumber","int",as),i.uniforms.add(new Af("vvColorValues",s=>s.vvColor.values,as),new Pf("vvColorColors",s=>s.vvColor.colors,as),new Nr("vvColorFallback",s=>s.vvColor.fallback,{supportsNaN:!0})),t.hasVVInstancing&&(e.vertex.include(qs),e.vertex.include(Xs)),i.code.add(h`
      vec4 interpolateVVColor(float value) {
        if (isnan(value)) {
          return vvColorFallback;
        }

        if (value <= vvColorValues[0]) {
          return vvColorColors[0];
        }

        for (int i = 1; i < vvColorNumber; ++i) {
          if (vvColorValues[i] >= value) {
            float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
            return mix(vvColorColors[i-1], vvColorColors[i], f);
          }
        }
        return vvColorColors[vvColorNumber - 1];
      }

      vec4 vvGetColor(vec4 featureAttribute) {
        return interpolateVVColor(featureAttribute.y);
      }

      ${t.hasVVInstancing?h`
            vec4 vvColor() {
              return vvGetColor(instanceFeatureAttribute);
            }

            MaskedColor applyVVColor(MaskedColor color) {
              return multiplyMaskedColors(color, createMaskedFromNaNColor(vvColor()));
            }
            `:h`
            vec4 vvColor() {
              return vec4(1.0);
            }

            MaskedColor applyVVColor(MaskedColor color) {
              return color;
            }
            `}
    `)):i.code.add(h`vec4 vvColor() {
return vec4(1.0);
}
MaskedColor applyVVColor(MaskedColor color) {
return color;
}`)}function $o(e){e.code.add(h`vec4 premultiplyAlpha(vec4 v) {
return vec4(v.rgb * v.a, v.a);
}
vec3 rgb2hsv(vec3 c) {
vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
vec4 p = c.g < c.b ? vec4(c.bg, K.wz) : vec4(c.gb, K.xy);
vec4 q = c.r < p.x ? vec4(p.xyw, c.r) : vec4(c.r, p.yzx);
float d = q.x - min(q.w, q.y);
float e = 1.0e-10;
return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), min(d / (q.x + e), 1.0), q.x);
}
vec3 hsv2rgb(vec3 c) {
vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
}
float rgb2v(vec3 c) {
return max(c.x, max(c.y, c.z));
}`)}const oi=1/255.5,Of=Vs(1,0,1,771);function Df(e,t=!1){switch(e){case 0:return t?oo:qh;case 1:return Of;case 2:case 3:return null}}function zf(e){if(e.draped)return null;switch(e.oitPass){case 0:case 2:return e.writeDepth?Jh:null;case 1:case 3:return null}}const Nf=5e5,Lf={factor:-1,units:-2};function Vf({oitPass:e,enableOffset:t}){return t&&e===1?Lf:null}function Bf(e,t=513){return e===0||e===2?t:515}function $f(e,t){const i=En(t);return e===1?i?{buffers:[Wr,kr,Ec]}:{buffers:[Wr,kr]}:i?{buffers:[Wr,kr]}:null}function jf(e){if(e.length<Si)return Array.from(e);if(Array.isArray(e))return Float64Array.from(e);if(!("BYTES_PER_ELEMENT"in e))return Array.from(e);switch(e.BYTES_PER_ELEMENT){case 1:return Uint8Array.from(e);case 2:return Vl(e)?Jl().from(e):vn(e)?Uint16Array.from(e):Int16Array.from(e);case 4:return Float32Array.from(e);default:return Float64Array.from(e)}}let Hf=class jo{get center(){return ve(this._data[0],this._data[1],this._data[2])}get radius(){return this._data[3]}get bbMin(){return ve(this._data[4],this._data[5],this._data[6])}get bbMax(){return ve(this._data[7],this._data[8],this._data[9])}constructor(t,i,r){this.primitiveIndices=t,this._numIndexPerPrimitive=i,this.position=r,this._data=[.1,0,0,0,0,0,0,0,0,0],this._children=void 0,W(t.length>=1),W(r.size===3||r.size===4);const{data:s,size:a,indices:n}=r;W(n.length%this._numIndexPerPrimitive===0),W(n.length>=t.length*this._numIndexPerPrimitive);const o=t.length;let l=a*n[this._numIndexPerPrimitive*t[0]];Ft.clear(),Ft.push(l);const c=ve(s[l],s[l+1],s[l+2]),u=yi(c);for(let p=0;p<o;++p){const _=this._numIndexPerPrimitive*t[p];for(let y=0;y<this._numIndexPerPrimitive;++y){l=a*n[_+y],Ft.push(l);let w=s[l];c[0]=Math.min(w,c[0]),u[0]=Math.max(w,u[0]),w=s[l+1],c[1]=Math.min(w,c[1]),u[1]=Math.max(w,u[1]),w=s[l+2],c[2]=Math.min(w,c[2]),u[2]=Math.max(w,u[2])}}for(let p=0;p<3;++p)this._data[4+p]=c[p],this._data[7+p]=u[p];const d=ur(g(),this.bbMin,this.bbMax,.5);let m=.5*Math.max(Math.max(u[0]-c[0],u[1]-c[1]),u[2]-c[2]),v=m*m;for(let p=0;p<Ft.length;++p){l=Ft.at(p);const _=s[l]-d[0],y=s[l+1]-d[1],w=s[l+2]-d[2],T=_*_+y*y+w*w;if(T<=v)continue;const M=Math.sqrt(T),E=.5*(M-m);m+=E,v=m*m;const I=E/M;d[0]+=_*I,d[1]+=y*I,d[2]+=w*I}this._data[3]=m;for(let p=0;p<3;++p)this._data[0+p]=d[p];Ft.clear()}getChildren(){if(this._children||Fs(this.bbMin,this.bbMax)<=1)return this._children;const t=ur(g(),this.bbMin,this.bbMax,.5),i=this.primitiveIndices.length,r=new Uint8Array(i),s=new Array(8);for(let u=0;u<8;++u)s[u]=0;const{data:a,size:n,indices:o}=this.position;for(let u=0;u<i;++u){let d=0;const m=this._numIndexPerPrimitive*this.primitiveIndices[u];let v=n*o[m],p=a[v],_=a[v+1],y=a[v+2];for(let w=1;w<this._numIndexPerPrimitive;++w){v=n*o[m+w];const T=a[v],M=a[v+1],E=a[v+2];T<p&&(p=T),M<_&&(_=M),E<y&&(y=E)}p<t[0]&&(d|=1),_<t[1]&&(d|=2),y<t[2]&&(d|=4),r[u]=d,++s[d]}let l=0;for(let u=0;u<8;++u)s[u]>0&&++l;if(l<2)return;const c=new Array(8);for(let u=0;u<8;++u)c[u]=s[u]>0?new Uint32Array(s[u]):void 0;for(let u=0;u<8;++u)s[u]=0;for(let u=0;u<i;++u){const d=r[u];c[d][s[d]++]=this.primitiveIndices[u]}this._children=new Array;for(let u=0;u<8;++u)c[u]!==void 0&&this._children.push(new jo(c[u],this._numIndexPerPrimitive,this.position));return this._children}static prune(){Ft.prune()}};const Ft=new Bl({deallocator:null});let Uf=class{constructor(e){this.id=Cr(),this._attributes=new Map;for(const[t,i]of e)this._attributes.set(t,{...i,indices:Ol(i.indices)})}get attributes(){return this._attributes}};function Gf(e){return e?{p0:yi(e.p0),p1:yi(e.p1),p2:yi(e.p2)}:{p0:g(),p1:g(),p2:g()}}function kv(e,t,i){const r=t[0]-e[0],s=t[1]-e[1],a=i[0]-e[0],n=i[1]-e[1];return .5*Math.abs(r*n-s*a)}function Wf(e,t,i){return ce(ns,t,e),ce(Ja,i,e),.5*te(Fe(ns,ns,Ja))}new Tn(Cn);new Tn(()=>Gf());const ns=g(),Ja=g();function kf(e,t){if(!e)return!1;const{size:i,data:r,indices:s}=e;G(t,0,0,0),G(Re,0,0,0);let a=0,n=0;for(let o=0;o<s.length-2;o+=3){const l=s[o]*i,c=s[o+1]*i,u=s[o+2]*i;G(le,r[l],r[l+1],r[l+2]),G(st,r[c],r[c+1],r[c+2]),G(Zi,r[u],r[u+1],r[u+2]);const d=Wf(le,st,Zi);d?(pe(le,le,st),pe(le,le,Zi),q(le,le,1/3*d),pe(t,t,le),a+=d):(pe(Re,Re,le),pe(Re,Re,st),pe(Re,Re,Zi),n+=3)}return(n!==0||a!==0)&&(a!==0?(q(t,t,1/a),!0):n!==0&&(q(t,Re,1/n),!0))}function qf(e,t){if(!e)return!1;const{size:i,data:r,indices:s}=e;G(t,0,0,0);let a=-1,n=0;for(let o=0;o<s.length;o++){const l=s[o]*i;a!==l&&(t[0]+=r[l],t[1]+=r[l+1],t[2]+=r[l+2],n++),a=l}return n>1&&q(t,t,1/n),n>0}function Xf(e,t,i){if(!e)return!1;G(i,0,0,0),G(Re,0,0,0);let r=0,s=0;const{size:a,data:n,indices:o}=e,l=o.length-1,c=l+(t?2:0);for(let u=0;u<c;u+=2){const d=u<l?u+1:0,m=o[u<l?u:l]*a,v=o[d]*a;le[0]=n[m],le[1]=n[m+1],le[2]=n[m+2],st[0]=n[v],st[1]=n[v+1],st[2]=n[v+2],q(le,pe(le,le,st),.5);const p=Fl(le,st);p>0?(pe(i,i,q(le,le,p)),r+=p):r===0&&(pe(Re,Re,le),s++)}return r!==0?(q(i,i,1/r),!0):s!==0&&(q(i,Re,1/s),!0)}const le=g(),st=g(),Zi=g(),Re=g();let Ho=class{constructor(){this.uid=Cr()}},Yf=class extends Ho{constructor(e){super(),this.highlightName=e,this.channel=0}},qv=class extends Ho{constructor(){super(...arguments),this.channel=1}},Xv=class Uo extends Uf{constructor(t,i,r=null,s=0,a=null,n=-1,o){super(i),this.material=t,this.mapPositions=r,this.type=s,this.olidColor=a,this.edgeIndicesLength=n,this.baseGeometry=o,this._highlights=null,this._highlightOptionsCounts=null,this.visible=!0,this._boundingInfo=null;const l=this.positionAttribute;l!=null&&this.edgeIndicesLength<0&&(this.edgeIndicesLength=l.indices.length)}instantiate(t={}){const i=new Uo(t.material||this.material,[],this.mapPositions,this.type,this.olidColor,this.edgeIndicesLength,this.baseGeometry);return this._attributes.forEach((r,s)=>{r.exclusive=!1,i._attributes.set(s,r)}),i._boundingInfo=this._boundingInfo,i.transformation=t.transformation||this.transformation,i}getMutableAttribute(t){let i=this._attributes.get(t);return i&&!i.exclusive&&(i={...i,exclusive:!0,data:jf(i.data)},this._attributes.set(t,i)),i}setAttributeData(t,i){const r=this._attributes.get(t);r?this._attributes.set(t,{...r,exclusive:!0,data:i}):Ri()&&console.warn(`Setting undefined attribute ${t} data`)}get positionAttribute(){return this.attributes.get("position")??this.baseGeometry?.attributes.get("position")}get indexCount(){return this._attributes.values().next().value?.indices?.length??0}get faceCount(){return this.indexCount/3}get boundingInfo(){return this._boundingInfo??=this._calculateBoundingInfo(),this._boundingInfo}computeAttachmentOrigin(t){return!!(this.type===0?this._computeAttachmentOriginTriangles(t):this.type===2?this._computeAttachmentOriginLines(t):this._computeAttachmentOriginPoints(t))&&(this._transformation!=null&&Pe(t,t,this._transformation),!0)}_computeAttachmentOriginTriangles(t){const i=this.positionAttribute;return kf(i,t)}_computeAttachmentOriginLines(t){const i=this.positionAttribute;return Xf(i,Zf(this.material.parameters,i),t)}_computeAttachmentOriginPoints(t){const i=this.positionAttribute;return qf(i,t)}invalidateBoundingInfo(){this._boundingInfo=null}_calculateBoundingInfo(){const t=this.positionAttribute;if(!t||t.indices.length===0)return null;const i=this.type===0?3:1;W(t.indices.length%i===0,"Indexing error: "+t.indices.length+" not divisible by "+i);const r=Al(t.indices.length/i);return new Hf(r,i,t)}get transformation(){return this._transformation??cr}set transformation(t){this._transformation=t&&t!==cr?Rl(t):null}get highlights(){return this._highlights||Jf}get hasHighlights(){return(this._highlightOptionsCounts?.size??0)>0}foreachHighlightOptions(t){this._highlightOptionsCounts?.forEach((i,r)=>t(r))}allocateIdAndHighlight(t){const i=new Yf(t);return this.addHighlight(i)}addHighlight(t){this._ensureHighlights().add(t);const{highlightName:i}=t,r=(this._highlightOptionsCounts?.get(i)??0)+1;return this._ensureHighlightOptionsCounts().set(i,r),t}_ensureHighlights(){let t=this._highlights;return t||(t=new Set,this._highlights=t),t}_ensureHighlightOptionsCounts(){let t=this._highlightOptionsCounts;return t||(t=new Map,this._highlightOptionsCounts=t),t}removeHighlight(t){if(this._highlights?.delete(t)){const{highlightName:i}=t,r=this._highlightOptionsCounts?.get(i)??0;r<=1?this._highlightOptionsCounts?.delete(i):this._ensureHighlightOptionsCounts().set(i,r-1)}}};function Zf(e,t){return!(!("isClosed"in e)||!e.isClosed)&&t.indices.length>2}const Jf=new Set;function Yv(e,t=!1){return e<=Si?t?new Array(e).fill(0):new Array(e):new Float32Array(e)}function Zv(e){return Array.isArray(e)?e.length<Si?e:new Float32Array(e):e.length<Si?Array.from(e):e}function Jv(e){return(Array.isArray(e)?e.length:e.byteLength/8)<=Si?Array.from(e):new Float32Array(e)}function Kv(e,t,i){return Array.isArray(e)?e.slice(t,t+i):e.subarray(t,t+i)}let Kf=class{constructor(e=0,t=!1,i=!0){this.tolerance=e,this.isVerticalRay=t,this.normalRequired=i}};const Ji=Rc();function Qf(e,t,i,r,s,a){if(!e.visible)return;const n=Xe(ko,r,i),o=(u,d,m)=>a(u,m,d),{tolerance:l}=t,c=new Kf(l,!1,t.options.normalRequired);if(e.boundingInfo)W(e.type===0),Go(e.boundingInfo,i,n,l,s,c,o);else{const u=e.positionAttribute,d=u.indices;Wo(i,n,0,d.length/3,d,u.data,u.stride,s,c,o)}}const ep=g();function Go(e,t,i,r,s,a,n){if(e==null)return;const o=lp(i,ep);if(Ic(Ji,e.bbMin),Fc(Ji,e.bbMax),s?.applyToAabb(Ji),cp(Ji,t,o,r)){const{primitiveIndices:l,position:c}=e,u=l?l.length:c.indices.length/3;if(u>hp){const d=e.getChildren();if(d!==void 0){for(const m of d)Go(m,t,i,r,s,a,n);return}}rp(t,i,0,u,c.indices,c.data,c.stride,l,s,a,n)}}const vt=g();function Qv(e,t,i,r,s,a,n,o,l){const{data:c,stride:u}=a;Wo(e,Xe(ko,t,e),i,r,s,c,u,n,o,l)}function e_(e,t,i,r){if(!i.visible)return;const s=(l,c,u)=>r(l,u,c),{boundingInfo:a}=i;if(a){const{bbMin:l,bbMax:c}=a;if(e<l[0]||e>c[0]||t<l[1]||t>c[1])return}const n=i.positionAttribute,o=n.indices;tp(e,t,0,o.length/3,o,n,s)}function tp(e,t,i,r,s,a,n){const{data:o,stride:l}=a;for(let c=i;c<r;++c){const u=3*c,d=l*s[u],m=l*s[u+1],v=l*s[u+2],p=o[d+0]-e,_=o[d+1]-t,y=o[m+0]-e,w=o[m+1]-t,T=o[v+0]-e,M=o[v+1]-t,E=T*w-M*y,I=p*M-_*T,N=y*_-w*p;(E<0||I<0||N<0)&&(E>0||I>0||N>0)||n(0,c,null)}}function t_(e,t,i,r,s,a,n,o,l,c=null,u=0){const d=e[0],m=e[1],v=e[2],p=t[0],_=t[1],y=t[2];for(let w=i;w<r;++w){const T=u+(c?c[w]:w),M=3*T,E=n*s[M],I=a[E],N=a[E+1],R=a[E+2],C=n*s[M+1],S=a[C],A=a[C+1],b=a[C+2],O=n*s[M+2],P=S-I,D=A-N,L=b-R,j=a[O]-I,H=a[O+1]-N,Q=a[O+2]-R,oe=_*Q-H*y,he=y*j-Q*p,se=p*H-j*_,Z=P*oe+D*he+L*se;if(Math.abs(Z)<=Br)continue;const de=d-I,fe=m-N,me=v-R,ee=de*oe+fe*he+me*se;if(Z>0){if(ee<0||ee>Z)continue}else if(ee>0||ee<Z)continue;const Ae=fe*L-D*me,$e=me*P-L*de,je=de*D-P*fe,xe=p*Ae+_*$e+y*je;if(Z>0){if(xe<0||ee+xe>Z)continue}else if(xe>0||ee+xe<Z)continue;const He=(j*Ae+H*$e+Q*je)/Z;He>=0&&l(He,T,o?Vr(P,D,L,j,H,Q,vt):null)}}function ip(e,t,i,r,s,a,n,o){const l=e[0],c=e[1],u=e[2],d=t[0],m=t[1],v=t[2];for(let p=i;p<r;++p){const _=3*p,y=_+1,w=_+2,T=a*_,M=s[T],E=s[T+1],I=s[T+2],N=a*y,R=a*w,C=s[N]-M,S=s[N+1]-E,A=s[N+2]-I,b=s[R]-M,O=s[R+1]-E,P=s[R+2]-I,D=m*P-O*v,L=v*b-P*d,j=d*O-b*m,H=C*D+S*L+A*j;if(Math.abs(H)<=Br)continue;const Q=l-M,oe=c-E,he=u-I,se=Q*D+oe*L+he*j;if(H>0){if(se<0||se>H)continue}else if(se>0||se<H)continue;const Z=oe*A-S*he,de=he*C-A*Q,fe=Q*S-C*oe,me=d*Z+m*de+v*fe;if(H>0){if(me<0||se+me>H)continue}else if(me>0||se+me<H)continue;const ee=(b*Z+O*de+P*fe)/H;ee>=0&&o(ee,p,n?Vr(C,S,A,b,O,P,vt):null)}}function i_(e,t,i,r,s,a,n,o,l,c,u,d=null,m=0){const v=e[0],p=e[1],_=e[2],y=t[0],w=t[1],T=t[2];for(let M=i;M<r;++M){const E=m+(d?d[M]:M),I=3*E,N=n*s[I],R=a[N],C=a[N+1],S=a[N+2],A=n*s[I+1],b=a[A],O=a[A+1],P=a[A+2],D=n*s[I+2],L=a[D],j=a[D+1],H=a[D+2],Q=S-l,oe=o/Math.sqrt(R*R+C*C+Q*Q),he=R+R*oe,se=C+C*oe,Z=S+Q*oe,de=P-l,fe=o/Math.sqrt(b*b+O*O+de*de),me=b+b*fe,ee=O+O*fe,Ae=P+de*fe,$e=H-l,je=o/Math.sqrt(L*L+j*j+$e*$e),xe=me-he,He=ee-se,Mt=Ae-Z,St=L+L*je-he,Ke=j+j*je-se,Ct=H+$e*je-Z,ia=w*Ct-Ke*T,ra=T*St-Ct*y,sa=y*Ke-St*w,ct=xe*ia+He*ra+Mt*sa;if(Math.abs(ct)<=Br)continue;const jr=v-he,Hr=p-se,Ur=_-Z,Lt=jr*ia+Hr*ra+Ur*sa;if(ct>0){if(Lt<0||Lt>ct)continue}else if(Lt>0||Lt<ct)continue;const aa=Hr*Mt-He*Ur,na=Ur*xe-Mt*jr,oa=jr*He-xe*Hr,Vi=y*aa+w*na+T*oa;if(ct>0){if(Vi<0||Lt+Vi>ct)continue}else if(Vi>0||Lt+Vi<ct)continue;const la=(St*aa+Ke*na+Ct*oa)/ct;la>=0&&u(la,E,c?Vr(xe,He,Mt,St,Ke,Ct,vt):null)}}function rp(e,t,i,r,s,a,n,o,l,c,u){const d=e[0],m=e[1],v=e[2],p=t[0],_=t[1],y=t[2],{normalRequired:w}=c;for(let T=i;T<r;++T){const M=o[T],E=3*M,I=n*s[E];let N=a[I],R=a[I+1],C=a[I+2];const S=n*s[E+1];let A=a[S],b=a[S+1],O=a[S+2];const P=n*s[E+2];let D=a[P],L=a[P+1],j=a[P+2];l!=null&&([N,R,C]=l.applyToVertex(N,R,C,T),[A,b,O]=l.applyToVertex(A,b,O,T),[D,L,j]=l.applyToVertex(D,L,j,T));const H=A-N,Q=b-R,oe=O-C,he=D-N,se=L-R,Z=j-C,de=_*Z-se*y,fe=y*he-Z*p,me=p*se-he*_,ee=H*de+Q*fe+oe*me;if(Math.abs(ee)<=Br)continue;const Ae=d-N,$e=m-R,je=v-C,xe=Ae*de+$e*fe+je*me;if(ee>0){if(xe<0||xe>ee)continue}else if(xe>0||xe<ee)continue;const He=$e*oe-Q*je,Mt=je*H-oe*Ae,St=Ae*Q-H*$e,Ke=p*He+_*Mt+y*St;if(ee>0){if(Ke<0||xe+Ke>ee)continue}else if(Ke>0||xe+Ke<ee)continue;const Ct=(he*He+se*Mt+Z*St)/ee;Ct>=0&&u(Ct,M,w?Vr(H,Q,oe,he,se,Z,vt):null)}}function Wo(e,t,i,r,s,a,n,o,l,c){const u=t,d=dp,m=Math.abs(u[0]),v=Math.abs(u[1]),p=Math.abs(u[2]),_=m>=v?m>=p?0:2:v>=p?1:2,y=_,w=u[y]<0?2:1,T=(_+w)%3,M=(_+(3-w))%3,E=u[T]/u[y],I=u[M]/u[y],N=1/u[y],R=sp,C=ap,S=np,{normalRequired:A}=l;for(let b=i;b<r;++b){const O=3*b,P=n*s[O];G(d[0],a[P+0],a[P+1],a[P+2]);const D=n*s[O+1];G(d[1],a[D+0],a[D+1],a[D+2]);const L=n*s[O+2];G(d[2],a[L+0],a[L+1],a[L+2]),o&&(Y(d[0],o.applyToVertex(d[0][0],d[0][1],d[0][2],b)),Y(d[1],o.applyToVertex(d[1][0],d[1][1],d[1][2],b)),Y(d[2],o.applyToVertex(d[2][0],d[2][1],d[2][2],b))),Xe(R,d[0],e),Xe(C,d[1],e),Xe(S,d[2],e);const j=R[T]-E*R[y],H=R[M]-I*R[y],Q=C[T]-E*C[y],oe=C[M]-I*C[y],he=S[T]-E*S[y],se=S[M]-I*S[y],Z=he*oe-se*Q,de=j*se-H*he,fe=Q*H-oe*j;if((Z<0||de<0||fe<0)&&(Z>0||de>0||fe>0))continue;const me=Z+de+fe;if(me===0)continue;const ee=Z*(N*R[y])+de*(N*C[y])+fe*(N*S[y]);if(ee*Math.sign(me)<0)continue;const Ae=ee/me;Ae>=0&&c(Ae,b,A?op(d):null)}}const sp=g(),ap=g(),np=g();function Vr(e,t,i,r,s,a,n){return G(wr,e,t,i),G(Tr,r,s,a),Fe(n,wr,Tr),Te(n,n),n}function op(e){return Xe(wr,e[1],e[0]),Xe(Tr,e[2],e[0]),Fe(vt,wr,Tr),Te(vt,vt),vt}const wr=g(),Tr=g();function r_(e,t,i){return G(i,1/(t[0]-e[0]),1/(t[1]-e[1]),1/(t[2]-e[2]))}function lp(e,t){return G(t,1/e[0],1/e[1],1/e[2])}function cp(e,t,i,r){return up(e,t,i,r,1/0)}function up(e,t,i,r,s){const a=(e[0]-r-t[0])*i[0],n=(e[3]+r-t[0])*i[0];let o=Math.min(a,n),l=Math.max(a,n);const c=(e[1]-r-t[1])*i[1],u=(e[4]+r-t[1])*i[1];if(l=Math.min(l,Math.max(c,u)),l<0||(o=Math.max(o,Math.min(c,u)),o>l))return!1;const d=(e[2]-r-t[2])*i[2],m=(e[5]+r-t[2])*i[2];return l=Math.min(l,Math.max(d,m)),!(l<0)&&(o=Math.max(o,Math.min(d,m)),!(o>l)&&o<s)}const hp=1e3,Br=1e-7,ko=g(),dp=[g(),g(),g()];let fp=class{constructor(e){this.layout=e}elementCount(e){return e.get("position").indices.length}write(e,t,i,r,s,a){return xf(i,r,this.layout,e,t,s,a)}intersect(e,t,i,r,s,a,n){const o=this.layout.createView(e).getField("position",ir);if(o==null)return;const l=Xe(pp,a,s),c=0,u=o.count/3,d=r.options.normalRequired,m=(v,p,_)=>n(v,_,p);ip(s,l,c,u,o.typedBuffer,o.typedBufferStride,d,m)}};const pp=g();function $r(e,t){switch(e.fragment.code.add(h`vec3 screenDerivativeNormal(vec3 positionView) {
return normalize(cross(dFdx(positionView), dFdy(positionView)));
}`),t.normalType){case 1:e.attributes.add("normalCompressed","vec2"),e.vertex.code.add(h`vec3 decompressNormal(vec2 normal) {
float z = 1.0 - abs(normal.x) - abs(normal.y);
return vec3(normal + sign(normal) * min(z, 0.0), z);
}
vec3 normalModel() {
return decompressNormal(normalCompressed);
}`);break;case 0:e.attributes.add("normal","vec3"),e.vertex.code.add(h`vec3 normalModel() {
return normal;
}`);break;default:Ps(t.normalType);case 2:case 3:}}function qo({code:e,uniforms:t},i){t.add(new yt("dpDummy",()=>1)),e.add(h`vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
vec3 hiD = hiA + hiB;
vec3 loD = loA + loB;
return  dpDummy * hiD + loD;
}`)}let Xo=class extends ie{constructor(e,t,i){super(e,"mat3",2,(r,s,a)=>r.setUniformMatrix3fv(e,t(s,a),i))}},Yo=class extends ie{constructor(e,t,i){super(e,"mat4",1,(r,s,a)=>r.setUniformMatrix4fv(e,t(s,a),i))}};function mp(e,t){const{attributes:i,vertex:r,varyings:s,fragment:a}=e;r.include(qo,t),i.add("position","vec3"),s.add("vPositionWorldCameraRelative","vec3"),s.add("vPosition_view","vec3",{invariant:!0}),r.uniforms.add(new ue("transformWorldFromViewTH",n=>n.transformWorldFromViewTH),new ue("transformWorldFromViewTL",n=>n.transformWorldFromViewTL),new Ye("transformViewFromCameraRelativeRS",n=>n.transformViewFromCameraRelativeRS),new Yo("transformProjFromView",n=>n.transformProjFromView),new Xo("transformWorldFromModelRS",n=>n.transformWorldFromModelRS),new Ne("transformWorldFromModelTH",n=>n.transformWorldFromModelTH),new Ne("transformWorldFromModelTL",n=>n.transformWorldFromModelTL)),r.code.add(h`vec3 positionWorldCameraRelative() {
vec3 rotatedModelPosition = transformWorldFromModelRS * position;
vec3 transform_CameraRelativeFromModel = dpAdd(
transformWorldFromModelTL,
transformWorldFromModelTH,
-transformWorldFromViewTL,
-transformWorldFromViewTH
);
return transform_CameraRelativeFromModel + rotatedModelPosition;
}`),r.code.add(h`
    void forwardPosition(float fOffset) {
      vPositionWorldCameraRelative = positionWorldCameraRelative();
      if (fOffset != 0.0) {
        vPositionWorldCameraRelative += fOffset * ${t.spherical?h`normalize(transformWorldFromViewTL + vPositionWorldCameraRelative)`:h`vec3(0.0, 0.0, 1.0)`};
      }

      vPosition_view = transformViewFromCameraRelativeRS * vPositionWorldCameraRelative;
      gl_Position = transformProjFromView * vec4(vPosition_view, 1.0);
    }
  `),a.uniforms.add(new ue("transformWorldFromViewTL",n=>n.transformWorldFromViewTL)),r.code.add(h`vec3 positionWorld() {
return transformWorldFromViewTL + vPositionWorldCameraRelative;
}`),a.code.add(h`vec3 positionWorld() {
return transformWorldFromViewTL + vPositionWorldCameraRelative;
}`)}let gp=class extends Be{constructor(){super(...arguments),this.transformWorldFromViewTH=g(),this.transformWorldFromViewTL=g(),this.transformViewFromCameraRelativeRS=wt(),this.transformProjFromView=ae()}},vp=class extends Be{constructor(){super(...arguments),this.transformWorldFromModelRS=wt(),this.transformWorldFromModelTH=g(),this.transformWorldFromModelTL=g()}};function Zo(e,t){switch(t.normalType){case 0:case 1:e.include($r,t),e.varyings.add("vNormalWorld","vec3"),e.varyings.add("vNormalView","vec3"),e.vertex.uniforms.add(new Xo("transformNormalGlobalFromModel",i=>i.transformNormalGlobalFromModel),new Ye("transformNormalViewFromGlobal",i=>i.transformNormalViewFromGlobal)).code.add(h`void forwardNormal() {
vNormalWorld = transformNormalGlobalFromModel * normalModel();
vNormalView = transformNormalViewFromGlobal * vNormalWorld;
}`);break;case 2:e.vertex.code.add(h`void forwardNormal() {}`);break;default:Ps(t.normalType);case 3:}}let _p=class extends gp{constructor(){super(...arguments),this.transformNormalViewFromGlobal=wt()}},xp=class extends vp{constructor(){super(...arguments),this.transformNormalGlobalFromModel=wt(),this.toMapSpace=nt()}};const s_={func:513},a_={func:519},yp={mask:255},n_={mask:0},o_=e=>({function:{func:517,ref:e,mask:e},operation:{fail:7680,zFail:7680,zPass:7680}}),l_=e=>({function:{func:519,ref:e,mask:e},operation:{fail:7680,zFail:7680,zPass:7681}}),bp={function:{func:519,ref:2,mask:2},operation:{fail:7680,zFail:7680,zPass:0}},wp={function:{func:519,ref:2,mask:2},operation:{fail:7680,zFail:7680,zPass:7681}},c_={function:{func:514,ref:2,mask:2},operation:{fail:7680,zFail:7680,zPass:7680}},u_={function:{func:517,ref:2,mask:2},operation:{fail:7680,zFail:7680,zPass:7680}};let Tp=class{constructor(e,t,i){this.elementSize=t.stride,this._buffer=new zd(e,vs(t,1)),this.resize(i)}destroy(){this._buffer.dispose()}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get usedMemory(){return this._array.byteLength+this._buffer.usedMemory}copyRange(e,t,i,r=0){const s=new Uint8Array(this.array,e*this.elementSize,(t-e)*this.elementSize);new Uint8Array(i.array,r*this.elementSize).set(s)}transferAll(){this._buffer.setData(this._array)}transferRange(e,t){const i=e*this.elementSize,r=t*this.elementSize;this._buffer.setSubData(new Uint8Array(this._array),i,i,r)}resize(e){const t=e*this.elementSize,i=new ArrayBuffer(t);this._array&&(e>=this._capacity?new Uint8Array(i).set(new Uint8Array(this._array)):new Uint8Array(i).set(new Uint8Array(this._array).subarray(0,e*this.elementSize))),this._array=i,this._buffer.setSize(t),this._capacity=e}},Ka=class{constructor(e){this.localTransform=e.localTransform,this.globalTransform=e.globalTransform,this.modelOrigin=e.modelOrigin,this.model=e.instanceModel,this.modelNormal=e.instanceModelNormal,this.modelScaleFactors=e.modelScaleFactors,this.boundingSphere=e.boundingSphere,this.featureAttribute=e.getField("instanceFeatureAttribute",fr),this.color=e.getField("instanceColor",ri),this.olidColor=e.getField("instanceOlidColor",ri),this.state=e.getField("state",ua),this.lodLevel=e.getField("lodLevel",ua)}},mi=class extends Er{constructor(e,t){super(e),this.events=new zn,this._capacity=0,this._size=0,this._next=0,this._highlightOptionsMap=new Map,this._highlightOptionsMapPrev=new Map,this._layout=Cp(t),this._capacity=Mr,this._buffer=this._layout.createBuffer(this._capacity),this._view=new Ka(this._buffer)}get capacity(){return this._capacity}get size(){return this._size}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this._grow();const e=this._findSlot();return this._view.state.set(e,1),this._size++,this.events.emit("instances-changed"),e}removeInstance(e){const t=this._view.state;W(e>=0&&e<this._capacity&&!!(1&t.get(e)),"invalid instance handle"),this._getStateFlag(e,18)?this._setStateFlags(e,32):this.freeInstance(e),this.events.emit("instances-changed")}freeInstance(e){const t=this._view.state;W(e>=0&&e<this._capacity&&!!(1&t.get(e)),"invalid instance handle"),t.set(e,0),this._size--}setLocalTransform(e,t,i=!0){this._view.localTransform.setMat(e,t),i&&this.updateModelTransform(e)}getLocalTransform(e,t){this._view.localTransform.getMat(e,t)}setGlobalTransform(e,t,i=!0){this._view.globalTransform.setMat(e,t),i&&this.updateModelTransform(e)}getGlobalTransform(e,t){this._view.globalTransform.getMat(e,t)}updateModelTransform(e){const t=this._view,i=Me,r=Oe;t.localTransform.getMat(e,Qa),t.globalTransform.getMat(e,os);const s=Ii(os,os,Qa);G(i,s[12],s[13],s[14]),t.modelOrigin.setVec(e,i),Rn(r,s),t.model.setMat(e,r);const a=eu(Me,s);a.sort(),t.modelScaleFactors.set(e,0,a[1]),t.modelScaleFactors.set(e,1,a[2]),Dc(r,r),zc(r,r),t.modelNormal.setMat(e,r),this._setStateFlags(e,64),this.events.emit("instance-transform-changed",{index:e})}getModelTransform(e,t){const i=this._view;i.model.getMat(e,Oe),i.modelOrigin.getVec(e,Me),t[0]=Oe[0],t[1]=Oe[1],t[2]=Oe[2],t[3]=0,t[4]=Oe[3],t[5]=Oe[4],t[6]=Oe[5],t[7]=0,t[8]=Oe[6],t[9]=Oe[7],t[10]=Oe[8],t[11]=0,t[12]=Me[0],t[13]=Me[1],t[14]=Me[2],t[15]=1}applyShaderTransformation(e,t){this.shaderTransformation!=null&&this.shaderTransformation.applyTransform(this,e,t)}getCombinedModelTransform(e,t){return this.getModelTransform(e,t),this.shaderTransformation!=null&&this.shaderTransformation.applyTransform(this,e,t),t}getCombinedLocalTransform(e,t){this._view.localTransform.getMat(e,t),this.shaderTransformation!=null&&this.shaderTransformation.applyTransform(this,e,t)}getCombinedMaxScaleFactor(e){let t=this._view.modelScaleFactors.get(e,1);return this.shaderTransformation!=null&&(this.shaderTransformation.scaleFactor(Me,this,e),t*=Math.max(Me[0],Me[1],Me[2])),t}getCombinedMedianScaleFactor(e){let t=this._view.modelScaleFactors.get(e,0);return this.shaderTransformation!=null&&(this.shaderTransformation.scaleFactor(Me,this,e),t*=Mp(Me[0],Me[1],Me[2])),t}getModel(e,t){this._view.model.getMat(e,t)}setFeatureAttribute(e,t){this._view.featureAttribute?.setVec(e,t)}getFeatureAttribute(e,t){this._view.featureAttribute?.getVec(e,t)}setColor(e,t){this._view.color?.setVec(e,t)}setObjectAndLayerIdColor(e,t){this._view.olidColor?.setVec(e,t)}setVisible(e,t){t!==this.getVisible(e)&&(this._setStateFlag(e,4,t),this.events.emit("instance-visibility-changed",{index:e}))}getVisible(e){return this._getStateFlag(e,4)}setHighlight(e,t){const{_highlightOptionsMap:i}=this,r=i.get(e);t?t!==r&&(i.set(e,t),this._setStateFlag(e,8,!0),this.events.emit("instance-highlight-changed")):r&&(i.delete(e),this._setStateFlag(e,8,!1),this.events.emit("instance-highlight-changed"))}get highlightOptionsMap(){return this._highlightOptionsMap}getHighlightStateFlag(e){return this._getStateFlag(e,8)}geHighlightOptionsPrev(e){const t=this._highlightOptionsMapPrev.get(e)??null;return this._highlightOptionsMapPrev.delete(e),t}getHighlightName(e){const t=this.highlightOptionsMap.get(e)??null;return t?this._highlightOptionsMapPrev.set(e,t):this._highlightOptionsMapPrev.delete(e),t}getState(e){return this._view.state.get(e)}getLodLevel(e){return this._view.lodLevel.get(e)}countFlags(e){let t=0;for(let i=0;i<this._capacity;++i)this.getState(i)&e&&++t;return t}_setStateFlags(e,t){const i=this._view.state;t=i.get(e)|t,i.set(e,t)}_clearStateFlags(e,t){const i=this._view.state;t=i.get(e)&~t,i.set(e,t)}_setStateFlag(e,t,i){i?this._setStateFlags(e,t):this._clearStateFlags(e,t)}_getStateFlag(e,t){return!!(this._view.state.get(e)&t)}_grow(){this._capacity=Math.max(Mr,Math.floor(this._capacity*_n)),this._buffer=this._layout.createBuffer(this._capacity).copyFrom(this._buffer),this._view=new Ka(this._buffer)}_findSlot(){const e=this._view.state;let t=this._next;for(;1&e.get(t);)t=t+1===this._capacity?0:t+1;return this._next=t+1===this._capacity?0:t+1,t}};function Mp(e,t,i){return Math.max(Math.min(e,t),Math.min(Math.max(e,t),i))}f([x({constructOnly:!0})],mi.prototype,"shaderTransformation",void 0),f([x()],mi.prototype,"_size",void 0),f([x({readOnly:!0})],mi.prototype,"size",null),mi=f([Nt("esri.views.3d.webgl-engine.lib.lodRendering.InstanceData")],mi);const Sp=As().mat4f64("localTransform").mat4f64("globalTransform").vec4f64("boundingSphere").vec3f64("modelOrigin").mat3f("instanceModel").mat3f("instanceModelNormal").vec2f("modelScaleFactors");function Cp(e){return Jo(Sp.clone(),e).u8("state").u8("lodLevel")}function Jo(e,t){return t.instancedFeatureAttribute&&e.vec4f("instanceFeatureAttribute"),t.instancedColor&&e.vec4u8("instanceColor"),js()&&e.vec4u8("instanceOlidColor"),e}const Me=g(),Oe=wt(),Qa=ae(),os=ae(),Mr=64;let Ep=class{constructor(e){this.model=e.instanceModel,this.modelNormal=e.instanceModelNormal,this.modelOriginHi=e.instanceModelOriginHi,this.modelOriginLo=e.instanceModelOriginLo,this.featureAttribute=e.getField("instanceFeatureAttribute",fr),this.color=e.getField("instanceColor",ri),this.olidColor=e.getField("instanceOlidColor",ri)}},h_=class{constructor(e,t){this._rctx=e,this._layout=t,this._headIndex=0,this._tailIndex=0,this._firstIndex=null,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){const e=this._headIndex,t=this._tailIndex;return e>=t?e-t:e+this._capacity-t}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get usedMemory(){return this._buffer?.usedMemory??0}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCycle(){this._captureFirstIndex=!0}beginUpdate(){W(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){W(this._updating,"not updating"),this.size<Wl*this.capacity&&this._shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this._transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){W(this._updating,"not updating"),this.isFull&&this._grow();const e=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=e,this._captureFirstIndex=!1),this._incrementHead(),W(this._headIndex!==this._tailIndex,"invalid pointers"),e}freeTail(){W(this._updating,"not updating"),W(this.size>0,"invalid size");const e=this._tailIndex===this._firstIndex;this._incrementTail(),e&&(this._firstIndex=this._tailIndex)}_grow(){const e=Math.max(Mr,Math.floor(this._capacity*_n));this._resize(e)}_shrink(){const e=Math.max(Mr,Math.floor(this._capacity*kl));this._resize(e)}_resize(e){if(W(this._updating,"not updating"),e===this._capacity)return;const t=new Tp(this._rctx,this._layout,e);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const i=this.size,r=this._compactInstances(t);W(r===i,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=r,this._prevHeadIndex=0}this._resized=!0,this._capacity=e,this._buffer=t,this._view=new Ep(this._layout.createView(this._buffer.array))}_compactInstances(e){const t=this._headIndex,i=this._tailIndex;return i<t?(this._buffer.copyRange(i,t,e),t-i):i>t?(this._buffer.copyRange(i,this._capacity,e),t>0&&this._buffer.copyRange(0,t,e,this._capacity-i),t+(this._capacity-i)):0}_incrementHead(e=1){this._headIndex=(this._headIndex+e)%this._capacity}_incrementTail(e=1){this._tailIndex=(this._tailIndex+e)%this._capacity}_transferRange(e,t){e<t?this._buffer.transferRange(e,t):e>t&&(t>0&&this._buffer.transferRange(0,t),this._buffer.transferRange(e,this._capacity))}};const Ip=As().vec3f("instanceModelOriginHi").vec3f("instanceModelOriginLo").mat3f("instanceModel").mat3f("instanceModelNormal");function Rp(e){return Jo(Ip.clone(),e)}function d_({normalTexture:e,metallicRoughnessTexture:t,metallicFactor:i,roughnessFactor:r,emissiveTexture:s,emissiveFactor:a,occlusionTexture:n}){return e==null&&t==null&&s==null&&(a==null||We(a,ot))&&n==null&&(r==null||r===1)&&(i==null||i===1)}function f_({normalTexture:e,metallicRoughnessTexture:t,metallicFactor:i,roughnessFactor:r,emissiveTexture:s,emissiveFactor:a,occlusionTexture:n}){return e==null&&t==null&&s==null&&(a==null||We(a,ot))&&n==null&&(r==null||r===1)&&(i==null||i===1||i===0)}const Fp=Ci(1,1,.5),p_=Ci(0,.6,.2),m_=Ci(0,1,.2);function Ko(e){e.vertex.code.add(h`vec4 offsetBackfacingClipPosition(vec4 posClip, vec3 posWorld, vec3 normalWorld, vec3 camPosWorld) {
vec3 camToVert = posWorld - camPosWorld;
bool isBackface = dot(camToVert, normalWorld) > 0.0;
if (isBackface) {
posClip.z += 0.0000003 * posClip.w;
}
return posClip;
}`)}function Pp(e){e.varyings.add("linearDepth","float",{invariant:!0})}function Qo(e,t){Pp(e),e.vertex.code.add(h`
    void forwardLinearDepth(float _linearDepth) { ${U(t,"linearDepth = _linearDepth;")} }
  `)}function el(e){e.vertex.uniforms.add(new Lr("nearFar",t=>t.camera.nearFar))}function tl(e){e.vertex.code.add(h`float calculateLinearDepth(vec2 nearFar,float z) {
return (-z - nearFar[0]) / (nearFar[1] - nearFar[0]);
}`)}function g_(e,t){const{vertex:i}=e,r=rr(t.output);r&&(e.include(mp,t),Qo(e,!0),el(e),tl(e)),i.code.add(h`
    void forwardLinearDepthToWriteShadowMap() {
      ${U(r,"forwardLinearDepth(calculateLinearDepth(nearFar, vPosition_view.z));")}
    }
  `)}function Jt(e){tl(e),e.vertex.code.add(h`vec4 transformPositionWithDepth(mat4 proj, mat4 view, vec3 pos, vec2 nearFar, out float depth) {
vec4 eye = view * vec4(pos, 1.0);
depth = calculateLinearDepth(nearFar,eye.z);
return proj * eye;
}`),e.vertex.code.add(h`vec4 transformPosition(mat4 proj, mat4 view, vec3 pos) {
return proj * (view * vec4(pos, 1.0));
}`)}function il(e,t){t.instancedColor?(e.attributes.add("instanceColor","vec4"),e.vertex.include(Tt),e.vertex.include(Bo),e.vertex.include(qs),e.vertex.code.add(h`
      MaskedColor applyInstanceColor(MaskedColor color) {
        return multiplyMaskedColors( color, createMaskedFromUInt8NaNColor(${"instanceColor"}));
      }
    `)):e.vertex.code.add(h`MaskedColor applyInstanceColor(MaskedColor color) {
return color;
}`)}function v_(e,t,i){for(let r=0;r<i;++r)t[2*r]=e[r],t[2*r+1]=e[r]-t[2*r]}function Ap(e,t){const i=e.length;for(let r=0;r<i;++r)Kt[0]=e[r],t[r]=Kt[0];return t}function Op(e,t){const i=e.length;for(let r=0;r<i;++r)Kt[0]=e[r],Kt[1]=e[r]-Kt[0],t[r]=Kt[1];return t}const Kt=new Float32Array(2),en=wt();function rl(e,t){const{hasModelTransformation:i,instancedDoublePrecision:r,instanced:s,output:a,hasVertexTangents:n}=t;i&&(e.vertex.uniforms.add(new Yo("model",l=>l.modelTransformation??cr)),e.vertex.uniforms.add(new Ye("normalLocalOriginFromModel",l=>(Lc(en,l.modelTransformation??cr),en)))),s&&r&&(e.attributes.add("instanceModelOriginHi","vec3"),e.attributes.add("instanceModelOriginLo","vec3"),e.attributes.add("instanceModel","mat3"),e.attributes.add("instanceModelNormal","mat3"));const o=e.vertex;r&&(o.include(qo,t),o.uniforms.add(new zt("viewOriginHi",l=>Ap(G(Ki,l.camera.viewInverseTransposeMatrix[3],l.camera.viewInverseTransposeMatrix[7],l.camera.viewInverseTransposeMatrix[11]),Ki)),new zt("viewOriginLo",l=>Op(G(Ki,l.camera.viewInverseTransposeMatrix[3],l.camera.viewInverseTransposeMatrix[7],l.camera.viewInverseTransposeMatrix[11]),Ki)))),o.code.add(h`
    vec3 getVertexInLocalOriginSpace() {
      return ${i?r?"(model * vec4(instanceModel * localPosition().xyz, 1.0)).xyz":"(model * localPosition()).xyz":r?"instanceModel * localPosition().xyz":"localPosition().xyz"};
    }

    vec3 subtractOrigin(vec3 _pos) {
      ${r?h`
          // Issue: (should be resolved now with invariant position) https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/56280
          vec3 originDelta = dpAdd(viewOriginHi, viewOriginLo, -instanceModelOriginHi, -instanceModelOriginLo);
          return _pos - originDelta;`:"return vpos;"}
    }
    `),o.code.add(h`
    vec3 dpNormal(vec4 _normal) {
      return normalize(${i?r?"normalLocalOriginFromModel * (instanceModelNormal * _normal.xyz)":"normalLocalOriginFromModel * _normal.xyz":r?"instanceModelNormal * _normal.xyz":"_normal.xyz"});
    }
    `),a===3&&(tf(o),o.code.add(h`
    vec3 dpNormalView(vec4 _normal) {
      return normalize((viewNormal * ${i?r?"vec4(normalLocalOriginFromModel * (instanceModelNormal * _normal.xyz), 1.0)":"vec4(normalLocalOriginFromModel * _normal.xyz, 1.0)":r?"vec4(instanceModelNormal * _normal.xyz, 1.0)":"_normal"}).xyz);
    }
    `)),n&&o.code.add(h`
    vec4 dpTransformVertexTangent(vec4 _tangent) {
      ${i?r?"return vec4(normalLocalOriginFromModel * (instanceModelNormal * _tangent.xyz), _tangent.w);":"return vec4(normalLocalOriginFromModel * _tangent.xyz, _tangent.w);":r?"return vec4(instanceModelNormal * _tangent.xyz, _tangent.w);":"return _tangent;"}
    }`)}const Ki=g();let Dp=class extends ie{constructor(e,t){super(e,"int",1,(i,r,s)=>i.setUniform1i(e,t(r,s)))}};function sl(e,t){e.varyings.add("colorMixMode","int"),e.varyings.add("opacityMixMode","int"),e.vertex.uniforms.add(new Dp("symbolColorMixMode",i=>Ti[i.colorMixMode])),t.hasSymbolColors?(e.vertex.include(Tt),e.vertex.include(Bo),e.vertex.include(qs),e.attributes.add("symbolColor","vec4"),e.vertex.code.add(h`
    MaskedColor applySymbolColor(MaskedColor color) {
      return multiplyMaskedColors(color, createMaskedFromUInt8NaNColor(${"symbolColor"}));
    }
  `)):e.vertex.code.add(h`MaskedColor applySymbolColor(MaskedColor color) {
return color;
}`),e.vertex.code.add(h`
    void forwardColorMixMode(bvec4 mask) {
      colorMixMode = mask.r ? ${h.int(Ti.ignore)} : symbolColorMixMode;
      opacityMixMode = mask.a ? ${h.int(Ti.ignore)} : symbolColorMixMode;
    }
  `)}function al(e,t){t.hasVertexColors?(e.attributes.add("color","vec4"),e.varyings.add("vColor","vec4"),e.vertex.code.add(h`void forwardVertexColor() { vColor = color; }`),e.vertex.code.add(h`
      void forwardNormalizedVertexColor() { vColor = color * ${h.float(1/255)}; }
    `)):e.vertex.code.add(h`void forwardVertexColor() {}
void forwardNormalizedVertexColor() {}`)}function zp(e,t){switch(t.output){case 4:case 5:case 6:case 7:e.fragment.code.add(h`float _calculateFragDepth(const in float depth) {
const float SLOPE_SCALE = 2.0;
const float BIAS = 20.0 * .000015259;
float m = max(abs(dFdx(depth)), abs(dFdy(depth)));
return depth + SLOPE_SCALE * m + BIAS;
}
void outputDepth(float _linearDepth){
float fragDepth = _calculateFragDepth(_linearDepth);
gl_FragDepth = fragDepth;
}`);break;case 8:e.fragment.code.add(h`void outputDepth(float _linearDepth){
gl_FragDepth = _linearDepth;
}`)}}function Qt(e,t){nl(e,t,new xt("textureAlphaCutoff",i=>i.textureAlphaCutoff))}function __(e,t){nl(e,t,new wc("textureAlphaCutoff",i=>i.textureAlphaCutoff))}function nl(e,t,i){const r=e.fragment,s=t.alphaDiscardMode,a=s===0;s!==2&&s!==3||r.uniforms.add(i),r.code.add(h`
    void discardOrAdjustAlpha(inout vec4 color) {
      ${s===1?"color.a = 1.0;":`if (color.a < ${a?h.float(oi):"textureAlphaCutoff"}) {
              discard;
             } ${U(s===2,"else { color.a = 1.0; }")}`}
    }
  `)}function ol(e,t){const{vertex:i,fragment:r,varyings:s}=e,{hasColorTexture:a,alphaDiscardMode:n}=t,o=a&&n!==1,{output:l,normalType:c,hasColorTextureTransform:u}=t;switch(l){case 2:Xt(i,t),e.include(Jt),r.include(Zt,t),e.include(kt,t),o&&r.uniforms.add(new Ie("tex",d=>d.texture)),i.main.add(h`vpos = getVertexInLocalOriginSpace();
vpos = subtractOrigin(vpos);
vpos = addVerticalOffset(vpos, localOrigin);
gl_Position = transformPosition(proj, view, vpos);
forwardTextureCoordinates();`),e.include(Qt,t),r.main.add(h`
        discardBySlice(vpos);
        ${U(o,h`vec4 texColor = texture(tex, ${u?"colorUV":"vuv0"});
                discardOrAdjustAlpha(texColor);`)}`);break;case 4:case 5:case 6:case 7:case 10:Xt(i,t),e.include(Jt),e.include(kt,t),e.include(Mi,t),e.include(zp,t),r.include(Zt,t),e.include(Mf,t),el(e),s.add("depth","float",{invariant:!0}),o&&r.uniforms.add(new Ie("tex",d=>d.texture)),i.main.add(h`vpos = getVertexInLocalOriginSpace();
vpos = subtractOrigin(vpos);
vpos = addVerticalOffset(vpos, localOrigin);
gl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, depth);
forwardTextureCoordinates();
forwardObjectAndLayerIdColor();`),e.include(Qt,t),r.main.add(h`
        discardBySlice(vpos);
        ${U(o,h`vec4 texColor = texture(tex, ${u?"colorUV":"vuv0"});
               discardOrAdjustAlpha(texColor);`)}
        ${l===10?h`outputObjectAndLayerIdColor();`:h`outputDepth(depth);`}`);break;case 3:{Xt(i,t),e.include(Jt),e.include($r,t),e.include(Zo,t),e.include(kt,t),e.include(Mi,t),o&&r.uniforms.add(new Ie("tex",m=>m.texture)),c===2&&s.add("vPositionView","vec3",{invariant:!0});const d=c===0||c===1;i.main.add(h`
        vpos = getVertexInLocalOriginSpace();
        ${d?h`vNormalWorld = dpNormalView(vvLocalNormal(normalModel()));`:h`vPositionView = (view * vec4(vpos, 1.0)).xyz;`}
        vpos = subtractOrigin(vpos);
        vpos = addVerticalOffset(vpos, localOrigin);
        gl_Position = transformPosition(proj, view, vpos);
        forwardTextureCoordinates();`),r.include(Zt,t),e.include(Qt,t),r.main.add(h`
        discardBySlice(vpos);
        ${U(o,h`vec4 texColor = texture(tex, ${u?"colorUV":"vuv0"});
                discardOrAdjustAlpha(texColor);`)}

        ${c===2?h`vec3 normal = screenDerivativeNormal(vPositionView);`:h`vec3 normal = normalize(vNormalWorld);
                    if (gl_FrontFacing == false){
                      normal = -normal;
                    }`}
        fragColor = vec4(0.5 + 0.5 * normal, 1.0);`);break}case 9:Xt(i,t),e.include(Jt),e.include(kt,t),e.include(Mi,t),o&&r.uniforms.add(new Ie("tex",d=>d.texture)),i.main.add(h`vpos = getVertexInLocalOriginSpace();
vpos = subtractOrigin(vpos);
vpos = addVerticalOffset(vpos, localOrigin);
gl_Position = transformPosition(proj, view, vpos);
forwardTextureCoordinates();`),r.include(Zt,t),e.include(Qt,t),e.include(Vo,t),r.main.add(h`
        discardBySlice(vpos);
        ${U(o,h`vec4 texColor = texture(tex, ${u?"colorUV":"vuv0"});
                discardOrAdjustAlpha(texColor);`)}
        calculateOcclusionAndOutputHighlight();`)}}function Np(e,t){const i=e.fragment,{hasVertexTangents:r,doubleSidedMode:s,hasNormalTexture:a,textureCoordinateType:n,bindType:o,hasNormalTextureTransform:l}=t;r?(e.attributes.add("tangent","vec4"),e.varyings.add("vTangent","vec4"),s===2?i.code.add(h`mat3 computeTangentSpace(vec3 normal) {
float tangentHeadedness = gl_FrontFacing ? vTangent.w : -vTangent.w;
vec3 tangent = normalize(gl_FrontFacing ? vTangent.xyz : -vTangent.xyz);
vec3 bitangent = cross(normal, tangent) * tangentHeadedness;
return mat3(tangent, bitangent, normal);
}`):i.code.add(h`mat3 computeTangentSpace(vec3 normal) {
float tangentHeadedness = vTangent.w;
vec3 tangent = normalize(vTangent.xyz);
vec3 bitangent = cross(normal, tangent) * tangentHeadedness;
return mat3(tangent, bitangent, normal);
}`)):i.code.add(h`mat3 computeTangentSpace(vec3 normal, vec3 pos, vec2 st) {
vec3 Q1 = dFdx(pos);
vec3 Q2 = dFdy(pos);
vec2 stx = dFdx(st);
vec2 sty = dFdy(st);
float det = stx.t * sty.s - sty.t * stx.s;
vec3 T = stx.t * Q2 - sty.t * Q1;
T = T - normal * dot(normal, T);
T *= inversesqrt(max(dot(T,T), 1.e-10));
vec3 B = sign(det) * cross(normal, T);
return mat3(T, B, normal);
}`),a&&n!==0&&(e.include(In,t),i.uniforms.add(o===1?new Ie("normalTexture",c=>c.textureNormal):new pr("normalTexture",c=>c.textureNormal)),l&&(i.uniforms.add(new ro("scale",c=>c.scale??cu)),i.uniforms.add(new Ye("normalTextureTransformMatrix",c=>c.normalTextureTransformMatrix??ni))),i.code.add(h`vec3 computeTextureNormal(mat3 tangentSpace, vec2 uv) {
vec3 rawNormal = textureLookup(normalTexture, uv).rgb * 2.0 - 1.0;`),l&&i.code.add(h`mat3 normalRotation = mat3(normalTextureTransformMatrix[0][0]/scale[0], normalTextureTransformMatrix[0][1]/scale[1], 0.0,
normalTextureTransformMatrix[1][0]/scale[0], normalTextureTransformMatrix[1][1]/scale[1], 0.0,
0.0, 0.0, 0.0 );
rawNormal.xy = (normalRotation * vec3(rawNormal.x, rawNormal.y, 1.0)).xy;`),i.code.add(h`return tangentSpace * rawNormal;
}`))}const Lp=3e5,tn=5e5;let Vp=class extends ie{constructor(e,t,i){super(e,"vec2",2,(r,s,a,n)=>r.setUniform2fv(e,t(s,a,n),i))}};const ls=4;function Bp(){const e=new Pr,t=e.fragment;e.include(io);const i=(ls+1)/2,r=1/(2*i*i);return t.include(Ws),t.uniforms.add(new Ie("depthMap",s=>s.depthTexture),new pr("tex",s=>s.colorTexture),new Vp("blurSize",s=>s.blurSize),new xt("projScale",(s,a)=>{const n=a.camera.distance;return n>5e4?Math.max(0,s.projScale-(n-5e4)):s.projScale})),t.code.add(h`
    void blurFunction(vec2 uv, float r, float center_d, float sharpness, inout float wTotal, inout float bTotal) {
      float c = texture(tex, uv).r;
      float d = linearDepthFromTexture(depthMap, uv);

      float ddiff = d - center_d;

      float w = exp(-r * r * ${h.float(r)} - ddiff * ddiff * sharpness);
      wTotal += w;
      bTotal += w * c;
    }
  `),e.outputs.add("fragBlur","float"),t.main.add(h`
    float b = 0.0;
    float w_total = 0.0;

    float center_d = linearDepthFromTexture(depthMap, uv);

    float sharpness = -0.05 * projScale / center_d;
    for (int r = -${h.int(ls)}; r <= ${h.int(ls)}; ++r) {
      float rf = float(r);
      vec2 uvOffset = uv + rf * blurSize;
      blurFunction(uvOffset, rf, center_d, sharpness, w_total, b);
    }
    fragBlur = b / w_total;`),e}const $p=Object.freeze(Object.defineProperty({__proto__:null,build:Bp},Symbol.toStringTag,{value:"Module"}));let rn=class extends Bs{constructor(e,t){super(e,t,new Ar($p,()=>Ai(()=>Oi(()=>import("./RealisticTree.glsl-WN9nrQUl-CRRcYwOn.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72])).then(i=>i.ao),Li([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66]))),_o)}initializePipeline(){return zr({colorWrite:Dr})}};const jp="eXKEvZaUc66cjIKElE1jlJ6MjJ6Ufkl+jn2fcXp5jBx7c6KEflSGiXuXeW6OWs+tfqZ2Yot2Y7Zzfo2BhniEj3xoiXuXj4eGZpqEaHKDWjSMe7palFlzc3BziYOGlFVzg6Zzg7CUY5JrjFF7eYJ4jIKEcyyEonSXe7qUfqZ7j3xofqZ2c4R5lFZ5Y0WUbppoe1l2cIh2ezyUho+BcHN2cG6DbpqJhqp2e1GcezhrdldzjFGUcyxjc3aRjDyEc1h7Sl17c6aMjH92pb6Mjpd4dnqBjMOEhqZleIOBYzB7gYx+fnqGjJuEkWlwnCx7fGl+c4hjfGyRe5qMlNOMfnqGhIWHc6OMi4GDc6aMfqZuc6aMzqJzlKZ+lJ6Me3qRfoFue0WUhoR5UraEa6qMkXiPjMOMlJOGe7JrUqKMjK6MeYRzdod+Sl17boiPc6qEeYBlcIh2c1WEe7GDiWCDa0WMjEmMdod+Y0WcdntzhmN8WjyMjKJjiXtzgYxYaGd+a89zlEV7e2GJfnd+lF1rcK5zc4p5cHuBhL6EcXp5eYB7fnh8iX6HjIKEeaxuiYOGc66RfG2Ja5hzjlGMjEmMe9OEgXuPfHyGhPeEdl6JY02McGuMfnqGhFiMa3WJfnx2l4hwcG1uhmN8c0WMc39og1GBbrCEjE2EZY+JcIh2cIuGhIWHe0mEhIVrc09+gY5+eYBlnCyMhGCDl3drfmmMgX15aGd+gYx+fnuRfnhzY1SMsluJfnd+hm98WtNrcIuGh4SEj0qPdkqOjFF7jNNjdnqBgaqUjMt7boeBhnZ4jDR7c5pze4GGjEFrhLqMjHyMc0mUhKZze4WEa117kWlwbpqJjHZ2eX2Bc09zeId+e0V7WlF7jHJ2l72BfId8l3eBgXyBe897jGl7c66cgW+Xc76EjKNbgaSEjGx4fId8jFFjgZB8cG6DhlFziZhrcIh2fH6HgUqBgXiPY8dahGFzjEmMhEFre2dxhoBzc5SGfleGe6alc7aUeYBlhKqUdlp+cH5za4OEczxza0Gcc4J2jHZ5iXuXjH2Jh5yRjH2JcFx+hImBjH+MpddCl3dreZeJjIt8ZW18bm1zjoSEeIOBlF9oh3N7hlqBY4+UeYFwhLJjeYFwaGd+gUqBYxiEYot2fqZ2ondzhL6EYyiEY02Ea0VjgZB8doaGjHxoc66cjEGEiXuXiXWMiZhreHx8frGMe75rY02Ec5pzfnhzlEp4a3VzjM+EhFFza3mUY7Zza1V5e2iMfGyRcziEhDyEkXZ2Y4OBnCx7g5t2eyBjgV6EhEFrcIh2dod+c4Z+nJ5zjm15jEmUeYxijJp7nL6clIpjhoR5WrZraGd+fnuRa6pzlIiMg6ZzfHx5foh+eX1ufnB5eX1ufnB5aJt7UqKMjIh+e3aBfm5lbYSBhGFze6J4c39oc0mUc4Z+e0V7fKFVe0WEdoaGY02Ec4Z+Y02EZYWBfH6HgU1+gY5+hIWUgW+XjJ57ebWRhFVScHuBfJ6PhBx7WqJzlM+Ujpd4gHZziX6HjHmEgZN+lJt5boiPe2GJgX+GjIGJgHZzeaxufnB5hF2JtdN7jJ57hp57hK6ElFVzg6ZzbmiEbndzhIWHe3uJfoFue3qRhJd2j3xoc65zlE1jc3p8lE1jhniEgXJ7e657vZaUc3qBh52BhIF4aHKDa9drgY5+c52GWqZzbpqJe8tjnM+UhIeMfo2BfGl+hG1zSmmMjKJjZVaGgX15c1lze0mEp4OHa3mUhIWHhDyclJ6MeYOJkXiPc0VzhFiMlKaEboSJa5Jze41re3qRhn+HZYWBe0mEc4p5fnORbox5lEp4hGFjhGGEjJuEc1WEhLZjeHeGa7KlfHx2hLaMeX1ugY5+hIWHhKGPjMN7c1WEho1zhoBzZYx7fnhzlJt5exyUhFFziXtzfmmMa6qMYyiEiXxweV12kZSMeWqXSl17fnhzxmmMrVGEe1mcc4p5eHeGjK6MgY5+doaGa6pzlGV7g1qBh4KHkXiPeW6OaKqafqZ2eXZ5e1V7jGd7boSJc3BzhJd2e0mcYot2h1RoY8dahK6EQmWEWjx7e1l2lL6UgXyBdnR4eU9zc0VreX1umqaBhld7fo2Bc6KEc5Z+hDyEcIeBWtNrfHyGe5qMhMuMe5qMhEGEbVVupcNzg3aHhIF4boeBe0mEdlptc39ofFl5Y8uUlJOGiYt2UmGEcyxjjGx4jFF7a657ZYWBnElzhp57iXtrgZN+tfOEhIOBjE2HgU1+e8tjjKNbiWCDhE15gUqBgYN7fnqGc66ce9d7iYSBj0qPcG6DnGGcT3eGa6qMZY+JlIiMl4hwc3aRdnqBlGV7eHJ2hLZjfnuRhDyEeX6MSk17g6Z+c6aUjHmEhIF4gXyBc76EZW18fGl+fkl+jCxrhoVwhDyUhIqGlL2DlI6EhJd2tdN7eYORhEGMa2Faa6pzc3Bzc4R5lIRznM+UY9eMhDycc5Z+c4p5c4iGY117pb6MgXuPrbJafnx2eYOJeXZ5e657hDyEcziElKZjfoB5eHeGj4WRhGGEe6KGeX1utTStc76EhFGJnCyMa5hzfH6HnNeceYB7hmN8gYuMhIVrczSMgYF8h3N7c5pza5hzjJqEYIRdgYuMlL2DeYRzhGGEeX1uhLaEc4iGeZ1zdl6JhrVteX6Me2iMfm5lWqJzSpqEa6pzdnmchHx2c6OMhNdrhoR5g3aHczxzeW52gV6Ejm15frGMc0Vzc4Z+l3drfniJe+9rWq5rlF1rhGGEhoVwe9OEfoh+e7pac09+c3qBY0lrhDycdnp2lJ6MiYOGhGCDc3aRlL2DlJt5doaGdnp2gYF8gWeOjF2Uc4R5c5Z+jEmMe7KEc4mEeYJ4dmyBe0mcgXiPbqJ7eYB7fmGGiYSJjICGlF1reZ2PnElzbpqJfH6Hc39oe4WEc5eJhK6EhqyJc3qBgZB8c09+hEmEaHKDhFGJc5SGiXWMUpaEa89zc6OMnCyMiXtrho+Be5qMc7KEjJ57dmN+hKGPjICGbmiEe7prdod+hGCDdnmchBx7eX6MkXZ2hGGEa657hm98jFFjY5JreYOJgY2EjHZ2a295Y3FajJ6Mc1J+YzB7e4WBjF2Uc4R5eV12gYxzg1qBeId+c9OUc5pzjFFjgY5+hFiMlIaPhoR5lIpjjIKBlNdSe7KEeX2BfrGMhIqGc65zjE2UhK6EklZ+QmWEeziMWqZza3VzdnR4foh+gYF8n3iJiZhrnKp7gYF8eId+lJ6Me1lrcIuGjKJjhmN8c66MjFF7a6prjJ6UnJ5zezyUfruRWlF7nI5zfHyGe657h4SEe8tjhBx7jFFjc09+c39ojICMeZeJeXt+YzRzjHZ2c0WEcIeBeXZ5onSXkVR+gYJ+eYFwdldzgYF7eX2BjJ6UiXuXlE1jh4SEe1mchLJjc4Z+hqZ7eXZ5bm1zlL6Ue5p7iWeGhKqUY5pzjKJjcIeBe8t7gXyBYIRdlEp4a3mGnK6EfmmMZpqEfFl5gYxzjKZuhGFjhoKGhHx2fnx2eXuMe3aBiWeGvbKMe6KGa5hzYzB7gZOBlGV7hmN8hqZlYot2Y117a6pzc6KEfId8foB5rctrfneJfJ6PcHN2hFiMc5pzjH92c0VzgY2EcElzdmCBlFVzg1GBc65zY4OBboeBcHiBeYJ4ewxzfHx5lIRzlEmEnLKEbk1zfJ6PhmN8eYBljBiEnMOEiXxwezyUcIeBe76EdsKEeX2BdnR4jGWUrXWMjGd7fkl+j4WRlEGMa5Jzho+BhDyEfnqMeXt+g3aHlE1jczClhNN7ZW18eHx8hGFjZW18iXWMjKJjhH57gYuMcIuGWjyMe4ZtjJuExmmMj4WRdntzi4GDhFFzYIRdnGGcjJp7Y0F7e4WEkbCGiX57fnSHa657a6prhBCMe3Z+SmmMjH92eHJ2hK6EY1FzexhrvbKMnI5za4OEfnd+eXuMhImBe897hLaMjN+EfG+BeIOBhF1+eZeJi4GDkXZ2eXKEgZ6Ejpd4c2GHa1V5e5KUfqZuhCx7jKp7lLZrg11+hHx2hFWUoot2nI5zgbh5mo9zvZaUe3qRbqKMfqZ2kbCGhFiM";let Hp=class extends Be{constructor(){super(...arguments),this.projScale=1}},Up=class extends Hp{constructor(){super(...arguments),this.intensity=1}},Gp=class extends Be{},Wp=class extends Gp{constructor(){super(...arguments),this.blurSize=zi()}};function kp(e){e.fragment.uniforms.add(new De("projInfo",t=>qp(t.camera))),e.fragment.uniforms.add(new Lr("zScale",t=>Xp(t.camera))),e.fragment.code.add(h`vec3 reconstructPosition(vec2 fragCoord, float depth) {
return vec3((fragCoord * projInfo.xy + projInfo.zw) * (zScale.x * depth + zScale.y), depth);
}`)}function qp(e){const t=e.projectionMatrix;return t[11]===0?Ce(sn,2/(e.fullWidth*t[0]),2/(e.fullHeight*t[5]),(1+t[12])/t[0],(1+t[13])/t[5]):Ce(sn,-2/(e.fullWidth*t[0]),-2/(e.fullHeight*t[5]),(1-t[8])/t[0],(1-t[9])/t[5])}const sn=nt();function Xp(e){return e.projectionMatrix[11]===0?Dt(an,0,1):Dt(an,1,0)}const an=zi(),nn=16;function Yp(){const e=new Pr,t=e.fragment;return e.include(io),e.include(kp),t.include(Ws),t.uniforms.add(new yt("radius",i=>Ys(i.camera))).code.add(h`vec3 sphere[16] = vec3[16](
vec3(0.186937, 0.0, 0.0),
vec3(0.700542, 0.0, 0.0),
vec3(-0.864858, -0.481795, -0.111713),
vec3(-0.624773, 0.102853, -0.730153),
vec3(-0.387172, 0.260319, 0.007229),
vec3(-0.222367, -0.642631, -0.707697),
vec3(-0.01336, -0.014956, 0.169662),
vec3(0.122575, 0.1544, -0.456944),
vec3(-0.177141, 0.85997, -0.42346),
vec3(-0.131631, 0.814545, 0.524355),
vec3(-0.779469, 0.007991, 0.624833),
vec3(0.308092, 0.209288,0.35969),
vec3(0.359331, -0.184533, -0.377458),
vec3(0.192633, -0.482999, -0.065284),
vec3(0.233538, 0.293706, -0.055139),
vec3(0.417709, -0.386701, 0.442449)
);
float fallOffFunction(float vv, float vn, float bias) {
float f = max(radius * radius - vv, 0.0);
return f * f * f * max(vn - bias, 0.0);
}`),t.code.add(h`float aoValueFromPositionsAndNormal(vec3 C, vec3 n_C, vec3 Q) {
vec3 v = Q - C;
float vv = dot(v, v);
float vn = dot(normalize(v), n_C);
return fallOffFunction(vv, vn, 0.1);
}`),e.outputs.add("fragOcclusion","float"),t.uniforms.add(new Ie("normalMap",i=>i.normalTexture),new Ie("depthMap",i=>i.depthTexture),new xt("projScale",i=>i.projScale),new Ie("rnm",i=>i.noiseTexture),new ro("rnmScale",(i,r)=>Dt(on,r.camera.fullWidth/i.noiseTexture.descriptor.width,r.camera.fullHeight/i.noiseTexture.descriptor.height)),new xt("intensity",i=>i.intensity),new Lr("screenSize",i=>Dt(on,i.camera.fullWidth,i.camera.fullHeight))).main.add(h`
    float depth = depthFromTexture(depthMap, uv);

    // Early out if depth is out of range, such as in the sky
    if (depth >= 1.0 || depth <= 0.0) {
      fragOcclusion = 1.0;
      return;
    }

    // get the normal of current fragment
    ivec2 iuv = ivec2(uv * vec2(textureSize(normalMap, 0)));
    vec4 norm4 = texelFetch(normalMap, iuv, 0);
    if(norm4.a != 1.0) {
      fragOcclusion = 1.0;
      return;
    }
    vec3 norm = normalize(norm4.xyz * 2.0 - 1.0);

    float currentPixelDepth = linearizeDepth(depth);
    vec3 currentPixelPos = reconstructPosition(gl_FragCoord.xy, currentPixelDepth);

    float sum = 0.0;
    vec3 tapPixelPos;

    vec3 fres = normalize(2.0 * texture(rnm, uv * rnmScale).xyz - 1.0);

    // note: the factor 2.0 should not be necessary, but makes ssao much nicer.
    // bug or deviation from CE somewhere else?
    float ps = projScale / (2.0 * currentPixelPos.z * zScale.x + zScale.y);

    for(int i = 0; i < ${h.int(nn)}; ++i) {
      vec2 unitOffset = reflect(sphere[i], fres).xy;
      vec2 offset = vec2(-unitOffset * radius * ps);

      // don't use current or very nearby samples
      if( abs(offset.x) < 2.0 || abs(offset.y) < 2.0){
        continue;
      }

      vec2 tc = vec2(gl_FragCoord.xy + offset);
      if (tc.x < 0.0 || tc.y < 0.0 || tc.x > screenSize.x || tc.y > screenSize.y) continue;
      vec2 tcTap = tc / screenSize;
      float occluderFragmentDepth = linearDepthFromTexture(depthMap, tcTap);

      tapPixelPos = reconstructPosition(tc, occluderFragmentDepth);

      sum += aoValueFromPositionsAndNormal(currentPixelPos, norm, tapPixelPos);
    }

    // output the result
    float A = max(1.0 - sum * intensity / float(${h.int(nn)}), 0.0);

    // Anti-tone map to reduce contrast and drag dark region farther: (x^0.2 + 1.2 * x^4) / 2.2
    A = (pow(A, 0.2) + 1.2 * A * A * A * A) / 2.2;

    fragOcclusion = A;
  `),e}function Ys(e){return Math.max(10,20*e.computeScreenPixelSizeAtDist(Math.abs(4*e.relativeElevation)))}const on=zi(),Zp=Object.freeze(Object.defineProperty({__proto__:null,build:Yp,getRadius:Ys},Symbol.toStringTag,{value:"Module"}));let ln=class extends Bs{constructor(e,t){super(e,t,new Ar(Zp,()=>Ai(()=>Oi(()=>import("./RealisticTree.glsl-WN9nrQUl-CRRcYwOn.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72])).then(i=>i.ap),Li([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66]))),_o)}initializePipeline(){return zr({colorWrite:Dr})}};const _i=2;let gi=class extends At{constructor(e){super(e),this.consumes={required:["normals"]},this.produces=La.SSAO,this.isEnabled=()=>!1,this._enableTime=Bi(0),this._passParameters=new Up,this._drawParameters=new Wp}initialize(){const e=Uint8Array.from(atob(jp),i=>i.charCodeAt(0)),t=new $s(32);t.wrapMode=33071,t.pixelFormat=6407,t.wrapMode=10497,t.hasMipmap=!0,this._passParameters.noiseTexture=new ti(this.renderingContext,t,e),this.techniques.precompile(ln),this.techniques.precompile(rn),this.addHandles(Nn(()=>this.isEnabled(),()=>this._enableTime=Bi(0)))}destroy(){this._passParameters.noiseTexture=dr(this._passParameters.noiseTexture)}render(e){const t=e.find(({name:I})=>I==="normals"),i=t?.getTexture(),r=t?.getTexture(Cc);if(!i||!r)return;const s=this.techniques.get(ln),a=this.techniques.get(rn);if(!s.compiled||!a.compiled)return this._enableTime=Bi(performance.now()),void this.requestRender(1);this._enableTime===0&&(this._enableTime=Bi(performance.now()));const n=this.renderingContext,o=this.view.qualitySettings.fadeDuration,l=this.bindParameters,c=l.camera,u=c.relativeElevation,d=Ve((tn-u)/(tn-Lp),0,1),m=o>0?Math.min(o,performance.now()-this._enableTime)/o:1,v=m*d;this._passParameters.normalTexture=i,this._passParameters.depthTexture=r,this._passParameters.projScale=1/c.computeScreenPixelSizeAtDist(1),this._passParameters.intensity=4*Jp/Ys(c)**6*v;const p=c.fullViewport[2],_=c.fullViewport[3],y=this.fboCache.acquire(p,_,"ssao input",2);n.bindFramebuffer(y.fbo),n.setViewport(0,0,p,_),n.bindTechnique(s,l,this._passParameters,this._drawParameters),n.screen.draw();const w=Math.round(p/_i),T=Math.round(_/_i),M=this.fboCache.acquire(w,T,"ssao blur",0);n.bindFramebuffer(M.fbo),this._drawParameters.colorTexture=y.getTexture(),Dt(this._drawParameters.blurSize,0,_i/_),n.bindTechnique(a,l,this._passParameters,this._drawParameters),n.setViewport(0,0,w,T),n.screen.draw(),y.release();const E=this.fboCache.acquire(w,T,La.SSAO,0);return n.bindFramebuffer(E.fbo),n.setViewport(0,0,p,_),n.setClearColor(1,1,1,0),n.clear(16384),this._drawParameters.colorTexture=M.getTexture(),Dt(this._drawParameters.blurSize,_i/p,0),n.bindTechnique(a,l,this._passParameters,this._drawParameters),n.setViewport(0,0,w,T),n.screen.draw(),n.setViewport4fv(c.fullViewport),M.release(),m<1&&this.requestRender(2),E}};f([x()],gi.prototype,"consumes",void 0),f([x()],gi.prototype,"produces",void 0),f([x({constructOnly:!0})],gi.prototype,"isEnabled",void 0),gi=f([Nt("esri.views.3d.webgl-engine.effects.ssao.SSAO")],gi);const Jp=.5;function Zs(e,t){t.receiveAmbientOcclusion?(e.uniforms.add(new ks("ssaoTex",i=>i.ssao?.getTexture())),e.constants.add("blurSizePixelsInverse","float",1/_i),e.code.add(h`float evaluateAmbientOcclusionInverse() {
vec2 ssaoTextureSizeInverse = 1.0 / vec2(textureSize(ssaoTex, 0));
return texture(ssaoTex, gl_FragCoord.xy * blurSizePixelsInverse * ssaoTextureSizeInverse).r;
}
float evaluateAmbientOcclusion() {
return 1.0 - evaluateAmbientOcclusionInverse();
}`)):e.code.add(h`float evaluateAmbientOcclusionInverse() { return 1.0; }
float evaluateAmbientOcclusion() { return 0.0; }`)}function Kp(e,t){const i=e.fragment,r=t.lightingSphericalHarmonicsOrder!==void 0?t.lightingSphericalHarmonicsOrder:2;r===0?(i.uniforms.add(new zt("lightingAmbientSH0",({lighting:s})=>G(cn,s.sh.r[0],s.sh.g[0],s.sh.b[0]))),i.code.add(h`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec3 ambientLight = 0.282095 * lightingAmbientSH0;
return ambientLight * (1.0 - ambientOcclusion);
}`)):r===1?(i.uniforms.add(new De("lightingAmbientSH_R",({lighting:s})=>Ce(it,s.sh.r[0],s.sh.r[1],s.sh.r[2],s.sh.r[3])),new De("lightingAmbientSH_G",({lighting:s})=>Ce(it,s.sh.g[0],s.sh.g[1],s.sh.g[2],s.sh.g[3])),new De("lightingAmbientSH_B",({lighting:s})=>Ce(it,s.sh.b[0],s.sh.b[1],s.sh.b[2],s.sh.b[3]))),i.code.add(h`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec4 sh0 = vec4(
0.282095,
0.488603 * normal.x,
0.488603 * normal.z,
0.488603 * normal.y
);
vec3 ambientLight = vec3(
dot(lightingAmbientSH_R, sh0),
dot(lightingAmbientSH_G, sh0),
dot(lightingAmbientSH_B, sh0)
);
return ambientLight * (1.0 - ambientOcclusion);
}`)):r===2&&(i.uniforms.add(new zt("lightingAmbientSH0",({lighting:s})=>G(cn,s.sh.r[0],s.sh.g[0],s.sh.b[0])),new De("lightingAmbientSH_R1",({lighting:s})=>Ce(it,s.sh.r[1],s.sh.r[2],s.sh.r[3],s.sh.r[4])),new De("lightingAmbientSH_G1",({lighting:s})=>Ce(it,s.sh.g[1],s.sh.g[2],s.sh.g[3],s.sh.g[4])),new De("lightingAmbientSH_B1",({lighting:s})=>Ce(it,s.sh.b[1],s.sh.b[2],s.sh.b[3],s.sh.b[4])),new De("lightingAmbientSH_R2",({lighting:s})=>Ce(it,s.sh.r[5],s.sh.r[6],s.sh.r[7],s.sh.r[8])),new De("lightingAmbientSH_G2",({lighting:s})=>Ce(it,s.sh.g[5],s.sh.g[6],s.sh.g[7],s.sh.g[8])),new De("lightingAmbientSH_B2",({lighting:s})=>Ce(it,s.sh.b[5],s.sh.b[6],s.sh.b[7],s.sh.b[8]))),i.code.add(h`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec3 ambientLight = 0.282095 * lightingAmbientSH0;
vec4 sh1 = vec4(
0.488603 * normal.x,
0.488603 * normal.z,
0.488603 * normal.y,
1.092548 * normal.x * normal.y
);
vec4 sh2 = vec4(
1.092548 * normal.y * normal.z,
0.315392 * (3.0 * normal.z * normal.z - 1.0),
1.092548 * normal.x * normal.z,
0.546274 * (normal.x * normal.x - normal.y * normal.y)
);
ambientLight += vec3(
dot(lightingAmbientSH_R1, sh1),
dot(lightingAmbientSH_G1, sh1),
dot(lightingAmbientSH_B1, sh1)
);
ambientLight += vec3(
dot(lightingAmbientSH_R2, sh2),
dot(lightingAmbientSH_G2, sh2),
dot(lightingAmbientSH_B2, sh2)
);
return ambientLight * (1.0 - ambientOcclusion);
}`),t.pbrMode!==1&&t.pbrMode!==2||i.code.add(h`const vec3 skyTransmittance = vec3(0.9, 0.9, 1.0);
vec3 calculateAmbientRadiance(float ambientOcclusion)
{
vec3 ambientLight = 1.2 * (0.282095 * lightingAmbientSH0) - 0.2;
return ambientLight *= (1.0 - ambientOcclusion) * skyTransmittance;
}`))}const cn=g(),it=nt();function Sr(e){e.uniforms.add(new zt("mainLightDirection",t=>t.lighting.mainLight.direction))}function Pi(e){e.uniforms.add(new zt("mainLightIntensity",t=>t.lighting.mainLight.intensity))}function Qp(e){Sr(e.fragment),Pi(e.fragment),e.fragment.code.add(h`vec3 applyShading(vec3 shadingNormal, float shadow) {
float dotVal = clamp(dot(shadingNormal, mainLightDirection), 0.0, 1.0);
return mainLightIntensity * ((1.0 - shadow) * dotVal);
}`)}function em(e){e.code.add(h`vec3 evaluateDiffuseIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float NdotNG) {
return ((1.0 - NdotNG) * ambientGround + (1.0 + NdotNG) * ambientSky) * 0.5;
}`),e.code.add(h`float integratedRadiance(float cosTheta2, float roughness) {
return (cosTheta2 - 1.0) / (cosTheta2 * (1.0 - roughness * roughness) - 1.0);
}`),e.code.add(h`vec3 evaluateSpecularIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float RdotNG, float roughness) {
float cosTheta2 = 1.0 - RdotNG * RdotNG;
float intRadTheta = integratedRadiance(cosTheta2, roughness);
float ground = RdotNG < 0.0 ? 1.0 - intRadTheta : 1.0 + intRadTheta;
float sky = 2.0 - ground;
return (ground * ambientGround + sky * ambientSky) * 0.5;
}`)}function Js(e){const t=3.141592653589793,i=.3183098861837907;e.constants.add("PI","float",t),e.constants.add("LIGHT_NORMALIZATION","float",i),e.constants.add("INV_PI","float",i),e.constants.add("HALF_PI","float",1.570796326794897),e.constants.add("TWO_PI","float",6.28318530717958)}function Ks(e,t){e.include(Js),t.pbrMode!==1&&t.pbrMode!==2&&t.pbrMode!==5&&t.pbrMode!==6||(e.code.add(h`float normalDistribution(float NdotH, float roughness)
{
float a = NdotH * roughness;
float b = roughness / (1.0 - NdotH * NdotH + a * a);
return b * b * INV_PI;
}`),e.code.add(h`const vec4 c0 = vec4(-1.0, -0.0275, -0.572,  0.022);
const vec4 c1 = vec4( 1.0,  0.0425,  1.040, -0.040);
const vec2 c2 = vec2(-1.04, 1.04);
vec2 prefilteredDFGAnalytical(float roughness, float NdotV) {
vec4 r = roughness * c0 + c1;
float a004 = min(r.x * r.x, exp2(-9.28 * NdotV)) * r.x + r.y;
return c2 * a004 + r.zw;
}`)),t.pbrMode!==1&&t.pbrMode!==2||(e.include(em),e.code.add(h`struct PBRShadingInfo
{
float NdotV;
float LdotH;
float NdotNG;
float RdotNG;
float NdotAmbDir;
float NdotH_Horizon;
vec3 skyRadianceToSurface;
vec3 groundRadianceToSurface;
vec3 skyIrradianceToSurface;
vec3 groundIrradianceToSurface;
float averageAmbientRadiance;
float ssao;
vec3 albedoLinear;
vec3 f0;
vec3 f90;
vec3 diffuseColor;
float metalness;
float roughness;
};`),e.code.add(h`vec3 evaluateEnvironmentIllumination(PBRShadingInfo inputs) {
vec3 indirectDiffuse = evaluateDiffuseIlluminationHemisphere(inputs.groundIrradianceToSurface, inputs.skyIrradianceToSurface, inputs.NdotNG);
vec3 indirectSpecular = evaluateSpecularIlluminationHemisphere(inputs.groundRadianceToSurface, inputs.skyRadianceToSurface, inputs.RdotNG, inputs.roughness);
vec3 diffuseComponent = inputs.diffuseColor * indirectDiffuse * INV_PI;
vec2 dfg = prefilteredDFGAnalytical(inputs.roughness, inputs.NdotV);
vec3 specularColor = inputs.f0 * dfg.x + inputs.f90 * dfg.y;
vec3 specularComponent = specularColor * indirectSpecular;
return (diffuseComponent + specularComponent);
}`))}function x_(e,t){e.include(Js),e.code.add(h`
  struct PBRShadingWater {
      float NdotL;   // cos angle between normal and light direction
      float NdotV;   // cos angle between normal and view direction
      float NdotH;   // cos angle between normal and half vector
      float VdotH;   // cos angle between view direction and half vector
      float LdotH;   // cos angle between light direction and half vector
      float VdotN;   // cos angle between view direction and normal vector
  };

  float dtrExponent = ${t.useCustomDTRExponentForWater?"2.2":"2.0"};
  `),e.code.add(h`vec3 fresnelReflection(float angle, vec3 f0, float f90) {
return f0 + (f90 - f0) * pow(1.0 - angle, 5.0);
}`),e.code.add(h`float normalDistributionWater(float NdotH, float roughness) {
float r2 = roughness * roughness;
float NdotH2 = NdotH * NdotH;
float denom = pow((NdotH2 * (r2 - 1.0) + 1.0), dtrExponent) * PI;
return r2 / denom;
}`),e.code.add(h`float geometricOcclusionKelemen(float LoH) {
return 0.25 / (LoH * LoH);
}`),e.code.add(h`vec3 brdfSpecularWater(in PBRShadingWater props, float roughness, vec3 F0, float F0Max) {
vec3  F = fresnelReflection(props.VdotH, F0, F0Max);
float dSun = normalDistributionWater(props.NdotH, roughness);
float V = geometricOcclusionKelemen(props.LdotH);
float diffusionSunHaze = mix(roughness + 0.045, roughness + 0.385, 1.0 - props.VdotH);
float strengthSunHaze  = 1.2;
float dSunHaze = normalDistributionWater(props.NdotH, diffusionSunHaze) * strengthSunHaze;
return ((dSun + dSunHaze) * V) * F;
}`)}function tm(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]*t[r];return i}function cs(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]*t;return i}function ii(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]+t[r];return i}function ll(e){return(e+1)*(e+1)}function im(e){return Ve(Math.floor(Math.sqrt(e)-1),0,2)}function cl(e,t,i){const r=e[0],s=e[1],a=e[2],n=i||[];return n.length=ll(t),t>=0&&(n[0]=.28209479177),t>=1&&(n[1]=.4886025119*r,n[2]=.4886025119*a,n[3]=.4886025119*s),t>=2&&(n[4]=1.09254843059*r*s,n[5]=1.09254843059*s*a,n[6]=.31539156525*(3*a*a-1),n[7]=1.09254843059*r*a,n[8]=.54627421529*(r*r-s*s)),n}function rm(e,t){const i=ll(e),r=t||{r:[],g:[],b:[]};r.r.length=r.g.length=r.b.length=i;for(let s=0;s<i;s++)r.r[s]=r.g[s]=r.b[s]=0;return r}function sm(e,t){const i=im(t.r.length);for(const r of e)gn(Rs,r.direction),cl(Rs,i,at),tm(at,lr),cs(at,r.intensity[0],Ht),ii(t.r,Ht),cs(at,r.intensity[1],Ht),ii(t.g,Ht),cs(at,r.intensity[2],Ht),ii(t.b,Ht);return t}function am(e,t){cl(Rs,0,at);for(const i of e)t.r[0]+=at[0]*lr[0]*i.intensity[0]*4*Math.PI,t.g[0]+=at[0]*lr[0]*i.intensity[1]*4*Math.PI,t.b[0]+=at[0]*lr[0]*i.intensity[2]*4*Math.PI;return t}function nm(e,t,i,r){rm(t,r),G(i.intensity,0,0,0);let s=!1;const a=om,n=lm,o=cm;a.length=0,n.length=0,o.length=0;for(const l of e)l instanceof Es&&!s?(Y(i.direction,l.direction),Y(i.intensity,l.intensity),i.specularStrength=l.specularStrength,i.environmentStrength=l.environmentStrength,i.castShadows=l.castShadows,s=!0):l instanceof Es||l instanceof Ld?a.push(l):l instanceof Nd?n.push(l):l instanceof To&&o.push(l);sm(a,r),am(n,r);for(const l of o)ii(r.r,l.r),ii(r.g,l.g),ii(r.b,l.b)}const om=[],lm=[],cm=[],at=[0],Ht=[0],Rs=g(),lr=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398];let un=class{constructor(){this.color=g(),this.intensity=1}},um=class{constructor(){this.direction=g(),this.ambient=new un,this.diffuse=new un}};const ul=.4;let y_=class{constructor(){this._shOrder=2,this._legacy=new um,this.globalFactor=.5,this.noonFactor=.5,this._sphericalHarmonics=new To,this._mainLight=new Es(g(),ve(1,0,0),!1)}get legacy(){return this._legacy}get sh(){return this._sphericalHarmonics}get mainLight(){return this._mainLight}set(e){nm(e,this._shOrder,this._mainLight,this._sphericalHarmonics),this.updateLegacy()}updateLegacy(){Y(this._legacy.direction,this._mainLight.direction);const e=1/Math.PI;this._legacy.ambient.color[0]=.282095*this._sphericalHarmonics.r[0]*e,this._legacy.ambient.color[1]=.282095*this._sphericalHarmonics.g[0]*e,this._legacy.ambient.color[2]=.282095*this._sphericalHarmonics.b[0]*e,q(this._legacy.diffuse.color,this._mainLight.intensity,e),Y(Qi,this._legacy.diffuse.color),q(Qi,Qi,ul*this.globalFactor),pe(this._legacy.ambient.color,this._legacy.ambient.color,Qi)}copyFrom(e){this._sphericalHarmonics.r=Array.from(e.sh.r),this._sphericalHarmonics.g=Array.from(e.sh.g),this._sphericalHarmonics.b=Array.from(e.sh.b),Y(this._mainLight.direction,e.mainLight.direction),Y(this._mainLight.intensity,e.mainLight.intensity),this._mainLight.castShadows=e.mainLight.castShadows,this._mainLight.specularStrength=e.mainLight.specularStrength,this._mainLight.environmentStrength=e.mainLight.environmentStrength,this.globalFactor=e.globalFactor,this.noonFactor=e.noonFactor}lerpLighting(e,t,i){if(ur(this._mainLight.intensity,e.mainLight.intensity,t.mainLight.intensity,i),this._mainLight.environmentStrength=ge(e.mainLight.environmentStrength,t.mainLight.environmentStrength,i),this._mainLight.specularStrength=ge(e.mainLight.specularStrength,t.mainLight.specularStrength,i),Y(this._mainLight.direction,t.mainLight.direction),this._mainLight.castShadows=t.mainLight.castShadows,this.globalFactor=ge(e.globalFactor,t.globalFactor,i),this.noonFactor=ge(e.noonFactor,t.noonFactor,i),e.sh.r.length===t.sh.r.length)for(let r=0;r<t.sh.r.length;r++)this._sphericalHarmonics.r[r]=ge(e.sh.r[r],t.sh.r[r],i),this._sphericalHarmonics.g[r]=ge(e.sh.g[r],t.sh.g[r],i),this._sphericalHarmonics.b[r]=ge(e.sh.b[r],t.sh.b[r],i);else for(let r=0;r<t.sh.r.length;r++)this._sphericalHarmonics.r[r]=t.sh.r[r],this._sphericalHarmonics.g[r]=t.sh.g[r],this._sphericalHarmonics.b[r]=t.sh.b[r];this.updateLegacy()}};const Qi=g();function hm(e){e.code.add(h`float mapChannel(float x, vec2 p) {
return (x < p.x) ? mix(0.0, p.y, x/p.x) : mix(p.y, 1.0, (x - p.x) / (1.0 - p.x) );
}`),e.code.add(h`vec3 blackLevelSoftCompression(vec3 color, float averageAmbientRadiance) {
vec2 p = vec2(0.02, 0.0075) * averageAmbientRadiance;
return vec3(mapChannel(color.x, p), mapChannel(color.y, p), mapChannel(color.z, p));
}`)}function dm(e){e.code.add(h`vec3 tonemapACES(vec3 x) {
return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);
}`)}function Qs(e){e.constants.add("ambientBoostFactor","float",ul)}function ea(e){e.uniforms.add(new yt("lightingGlobalFactor",t=>t.lighting.globalFactor))}function hl(e,t){const i=e.fragment,{pbrMode:r,spherical:s,hasColorTexture:a}=t;i.include(Zs,t),r!==0&&i.include(Ks,t),e.include(Kp,t),i.include(Js),i.include(dm,t);const n=!(r===2&&!a);switch(n&&i.include(hm),i.code.add(h`
    const float GAMMA_SRGB = ${h.float(Tu)};
    const float INV_GAMMA_SRGB = 0.4761904;
    ${U(r!==0,"const float GROUND_REFLECTANCE = 0.2;")}
  `),Qs(i),ea(i),Sr(i),i.code.add(h`
    float additionalDirectedAmbientLight(vec3 vPosWorld) {
      float vndl = dot(${s?h`normalize(vPosWorld)`:h`vec3(0.0, 0.0, 1.0)`}, mainLightDirection);
      return smoothstep(0.0, 1.0, clamp(vndl * 2.5, 0.0, 1.0));
    }
  `),Pi(i),i.code.add(h`vec3 evaluateAdditionalLighting(float ambientOcclusion, vec3 vPosWorld) {
float additionalAmbientScale = additionalDirectedAmbientLight(vPosWorld);
return (1.0 - ambientOcclusion) * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor * mainLightIntensity;
}`),r){case 0:case 4:case 3:e.include(Qp),i.code.add(h`vec3 evaluateSceneLighting(vec3 normalWorld, vec3 albedo, float shadow, float ssao, vec3 additionalLight) {
vec3 mainLighting = applyShading(normalWorld, shadow);
vec3 ambientLighting = calculateAmbientIrradiance(normalWorld, ssao);
vec3 albedoLinear = pow(albedo, vec3(GAMMA_SRGB));
vec3 totalLight = mainLighting + ambientLighting + additionalLight;
totalLight = min(totalLight, vec3(PI));
vec3 outColor = vec3((albedoLinear / PI) * totalLight);
return pow(outColor, vec3(INV_GAMMA_SRGB));
}`);break;case 1:case 2:i.code.add(h`const float fillLightIntensity = 0.25;
const float horizonLightDiffusion = 0.4;
const float additionalAmbientIrradianceFactor = 0.02;
vec3 evaluateSceneLightingPBR(vec3 normal, vec3 albedo, float shadow, float ssao, vec3 additionalLight,
vec3 viewDir, vec3 groundNormal, vec3 mrr, float additionalAmbientIrradiance) {
vec3 viewDirection = -viewDir;
vec3 h = normalize(viewDirection + mainLightDirection);
PBRShadingInfo inputs;
inputs.NdotV = clamp(abs(dot(normal, viewDirection)), 0.001, 1.0);
inputs.NdotNG = clamp(dot(normal, groundNormal), -1.0, 1.0);
vec3 reflectedView = normalize(reflect(viewDirection, normal));
inputs.RdotNG = clamp(dot(reflectedView, groundNormal), -1.0, 1.0);
inputs.albedoLinear = pow(albedo, vec3(GAMMA_SRGB));
inputs.ssao = ssao;
inputs.metalness = mrr[0];
inputs.roughness = clamp(mrr[1] * mrr[1], 0.001, 0.99);`),i.code.add(h`inputs.f0 = (0.16 * mrr[2] * mrr[2]) * (1.0 - inputs.metalness) + inputs.albedoLinear * inputs.metalness;
inputs.f90 = vec3(clamp(dot(inputs.f0, vec3(50.0 * 0.33)), 0.0, 1.0));
inputs.diffuseColor = inputs.albedoLinear * (vec3(1.0) - inputs.f0) * (1.0 - inputs.metalness);`),t.useFillLights?i.uniforms.add(new Sf("hasFillLights",o=>o.enableFillLights)):i.constants.add("hasFillLights","bool",!1),i.code.add(h`vec3 ambientDir = vec3(5.0 * groundNormal[1] - groundNormal[0] * groundNormal[2], - 5.0 * groundNormal[0] - groundNormal[2] * groundNormal[1], groundNormal[1] * groundNormal[1] + groundNormal[0] * groundNormal[0]);
ambientDir = ambientDir != vec3(0.0) ? normalize(ambientDir) : normalize(vec3(5.0, -1.0, 0.0));
inputs.NdotAmbDir = hasFillLights ? abs(dot(normal, ambientDir)) : 1.0;
float NdotL = clamp(dot(normal, mainLightDirection), 0.001, 1.0);
vec3 mainLightIrradianceComponent = NdotL * (1.0 - shadow) * mainLightIntensity;
vec3 fillLightsIrradianceComponent = inputs.NdotAmbDir * mainLightIntensity * fillLightIntensity;
vec3 ambientLightIrradianceComponent = calculateAmbientIrradiance(normal, ssao) + additionalLight;
inputs.skyIrradianceToSurface = ambientLightIrradianceComponent + mainLightIrradianceComponent + fillLightsIrradianceComponent ;
inputs.groundIrradianceToSurface = GROUND_REFLECTANCE * ambientLightIrradianceComponent + mainLightIrradianceComponent + fillLightsIrradianceComponent ;`),i.uniforms.add(new yt("lightingSpecularStrength",o=>o.lighting.mainLight.specularStrength),new yt("lightingEnvironmentStrength",o=>o.lighting.mainLight.environmentStrength)).code.add(h`vec3 horizonRingDir = inputs.RdotNG * groundNormal - reflectedView;
vec3 horizonRingH = normalize(viewDirection + horizonRingDir);
inputs.NdotH_Horizon = dot(normal, horizonRingH);
float NdotH = clamp(dot(normal, h), 0.0, 1.0);
vec3 mainLightRadianceComponent = lightingSpecularStrength * normalDistribution(NdotH, inputs.roughness) * mainLightIntensity * (1.0 - shadow);
vec3 horizonLightRadianceComponent = lightingEnvironmentStrength * normalDistribution(inputs.NdotH_Horizon, min(inputs.roughness + horizonLightDiffusion, 1.0)) * mainLightIntensity * fillLightIntensity;
vec3 ambientLightRadianceComponent = lightingEnvironmentStrength * calculateAmbientRadiance(ssao) + additionalLight;
float normalDirectionModifier = mix(1., min(mix(0.1, 2.0, (inputs.NdotNG + 1.) * 0.5), 1.0), clamp(inputs.roughness * 5.0, 0.0 , 1.0));
inputs.skyRadianceToSurface = (ambientLightRadianceComponent + horizonLightRadianceComponent) * normalDirectionModifier + mainLightRadianceComponent;
inputs.groundRadianceToSurface = 0.5 * GROUND_REFLECTANCE * (ambientLightRadianceComponent + horizonLightRadianceComponent) * normalDirectionModifier + mainLightRadianceComponent;
inputs.averageAmbientRadiance = ambientLightIrradianceComponent[1] * (1.0 + GROUND_REFLECTANCE);`),i.code.add(h`
        vec3 reflectedColorComponent = evaluateEnvironmentIllumination(inputs);
        vec3 additionalMaterialReflectanceComponent = inputs.albedoLinear * additionalAmbientIrradiance;
        vec3 outColorLinear = reflectedColorComponent + additionalMaterialReflectanceComponent;
        ${n?h`vec3 outColor = pow(blackLevelSoftCompression(outColorLinear, inputs.averageAmbientRadiance), vec3(INV_GAMMA_SRGB));`:h`vec3 outColor = pow(max(vec3(0.0), outColorLinear - 0.005 * inputs.averageAmbientRadiance), vec3(INV_GAMMA_SRGB));`}
        return outColor;
      }
    `);break;case 5:case 6:Sr(i),Pi(i),i.code.add(h`const float roughnessTerrain = 0.5;
const float specularityTerrain = 0.5;
const vec3 fresnelReflectionTerrain = vec3(0.04);
vec3 evaluatePBRSimplifiedLighting(vec3 n, vec3 c, float shadow, float ssao, vec3 al, vec3 vd, vec3 nup) {
vec3 viewDirection = -vd;
vec3 h = normalize(viewDirection + mainLightDirection);
float NdotL = clamp(dot(n, mainLightDirection), 0.001, 1.0);
float NdotV = clamp(abs(dot(n, viewDirection)), 0.001, 1.0);
float NdotH = clamp(dot(n, h), 0.0, 1.0);
float NdotNG = clamp(dot(n, nup), -1.0, 1.0);
vec3 albedoLinear = pow(c, vec3(GAMMA_SRGB));
float lightness = 0.3 * albedoLinear[0] + 0.5 * albedoLinear[1] + 0.2 * albedoLinear[2];
vec3 f0 = (0.85 * lightness + 0.15) * fresnelReflectionTerrain;
vec3 f90 =  vec3(clamp(dot(f0, vec3(50.0 * 0.33)), 0.0, 1.0));
vec3 mainLightIrradianceComponent = (1. - shadow) * NdotL * mainLightIntensity;
vec3 ambientLightIrradianceComponent = calculateAmbientIrradiance(n, ssao) + al;
vec3 ambientSky = ambientLightIrradianceComponent + mainLightIrradianceComponent;
vec3 indirectDiffuse = ((1.0 - NdotNG) * mainLightIrradianceComponent + (1.0 + NdotNG ) * ambientSky) * 0.5;
vec3 outDiffColor = albedoLinear * (1.0 - f0) * indirectDiffuse / PI;
vec3 mainLightRadianceComponent = normalDistribution(NdotH, roughnessTerrain) * mainLightIntensity;
vec2 dfg = prefilteredDFGAnalytical(roughnessTerrain, NdotV);
vec3 specularColor = f0 * dfg.x + f90 * dfg.y;
vec3 specularComponent = specularityTerrain * specularColor * mainLightRadianceComponent;
vec3 outColorLinear = outDiffColor + specularComponent;
vec3 outColor = pow(outColorLinear, vec3(INV_GAMMA_SRGB));
return outColor;
}`)}}function fm(e,t){const i=e.fragment;switch(i.code.add(h`struct ShadingNormalParameters {
vec3 normalView;
vec3 viewDirection;
} shadingParams;`),t.doubleSidedMode){case 0:i.code.add(h`vec3 shadingNormal(ShadingNormalParameters params) {
return normalize(params.normalView);
}`);break;case 1:i.code.add(h`vec3 shadingNormal(ShadingNormalParameters params) {
return dot(params.normalView, params.viewDirection) > 0.0 ? normalize(-params.normalView) : normalize(params.normalView);
}`);break;case 2:i.code.add(h`vec3 shadingNormal(ShadingNormalParameters params) {
return gl_FrontFacing ? normalize(params.normalView) : normalize(-params.normalView);
}`);break;default:Ps(t.doubleSidedMode);case 3:}}function dl(e,t){const i=t.pbrMode,r=e.fragment;if(i!==2&&i!==0&&i!==1)return void r.code.add(h`void applyPBRFactors() {}`);if(i===0)return void r.code.add(h`void applyPBRFactors() {}
float getBakedOcclusion() { return 1.0; }`);if(i===2)return void r.code.add(h`vec3 mrr = vec3(0.0, 0.6, 0.2);
float occlusion = 1.0;
void applyPBRFactors() {}
float getBakedOcclusion() { return 1.0; }`);const{hasMetallicRoughnessTexture:s,hasMetallicRoughnessTextureTransform:a,hasOcclusionTexture:n,hasOcclusionTextureTransform:o,bindType:l}=t;(s||n)&&e.include(In,t),r.code.add(h`vec3 mrr;
float occlusion;`),s&&r.uniforms.add(l===1?new Ie("texMetallicRoughness",c=>c.textureMetallicRoughness):new pr("texMetallicRoughness",c=>c.textureMetallicRoughness)),n&&r.uniforms.add(l===1?new Ie("texOcclusion",c=>c.textureOcclusion):new pr("texOcclusion",c=>c.textureOcclusion)),r.uniforms.add(l===1?new ue("mrrFactors",c=>c.mrrFactors):new Ne("mrrFactors",c=>c.mrrFactors)),r.code.add(h`
    ${U(s,h`void applyMetallicRoughness(vec2 uv) {
            vec3 metallicRoughness = textureLookup(texMetallicRoughness, uv).rgb;
            mrr[0] *= metallicRoughness.b;
            mrr[1] *= metallicRoughness.g;
          }`)}

    ${U(n,"void applyOcclusion(vec2 uv) { occlusion *= textureLookup(texOcclusion, uv).r; }")}

    float getBakedOcclusion() {
      return ${n?"occlusion":"1.0"};
    }

    void applyPBRFactors() {
      mrr = mrrFactors;
      occlusion = 1.0;

      ${U(s,`applyMetallicRoughness(${a?"metallicRoughnessUV":"vuv0"});`)}
      ${U(n,`applyOcclusion(${o?"occlusionUV":"vuv0"});`)}
    }
  `)}function pm(e,t){const i=Ot(t.output)&&t.receiveShadows;i&&Qo(e,!0),e.vertex.code.add(h`
    void forwardLinearDepthToReadShadowMap() { ${U(i,"forwardLinearDepth(gl_Position.w);")} }
  `)}let mm=class extends ie{constructor(e,t,i,r){super(e,"mat4",2,(s,a,n,o)=>s.setUniformMatrices4fv(e,t(a,n,o),r),i)}},gm=class extends ie{constructor(e,t,i,r){super(e,"mat4",1,(s,a,n)=>s.setUniformMatrices4fv(e,t(a,n),r),i)}};function vm(e){e.fragment.uniforms.add(new gm("shadowMapMatrix",(t,i)=>i.shadowMap.getShadowMapMatrices(t.origin),4)),fl(e)}function _m(e){e.fragment.uniforms.add(new mm("shadowMapMatrix",(t,i)=>i.shadowMap.getShadowMapMatrices(t.origin),4)),fl(e)}function fl(e){const{fragment:t}=e;t.uniforms.add(new De("cascadeDistances",i=>i.shadowMap.cascadeDistances),new Lo("numCascades",i=>i.shadowMap.numCascades)),t.code.add(h`const vec3 invalidShadowmapUVZ = vec3(0.0, 0.0, -1.0);
vec3 lightSpacePosition(vec3 _vpos, mat4 mat) {
vec4 lv = mat * vec4(_vpos, 1.0);
lv.xy /= lv.w;
return 0.5 * lv.xyz + vec3(0.5);
}
vec2 cascadeCoordinates(int i, ivec2 textureSize, vec3 lvpos) {
float xScale = float(textureSize.y) / float(textureSize.x);
return vec2((float(i) + lvpos.x) * xScale, lvpos.y);
}
vec3 calculateUVZShadow(in vec3 _worldPos, in float _linearDepth, in ivec2 shadowMapSize) {
int i = _linearDepth < cascadeDistances[1] ? 0 : _linearDepth < cascadeDistances[2] ? 1 : _linearDepth < cascadeDistances[3] ? 2 : 3;
if (i >= numCascades) {
return invalidShadowmapUVZ;
}
mat4 shadowMatrix = i == 0 ? shadowMapMatrix[0] : i == 1 ? shadowMapMatrix[1] : i == 2 ? shadowMapMatrix[2] : shadowMapMatrix[3];
vec3 lvpos = lightSpacePosition(_worldPos, shadowMatrix);
if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
return invalidShadowmapUVZ;
}
vec2 uvShadow = cascadeCoordinates(i, shadowMapSize, lvpos);
return vec3(uvShadow, lvpos.z);
}`)}function xm(e){e.fragment.code.add(h`float readShadowMapUVZ(vec3 uvzShadow, sampler2DShadow _shadowMap) {
return texture(_shadowMap, uvzShadow);
}`)}let ym=class extends ie{constructor(e,t){super(e,"sampler2DShadow",0,(i,r)=>i.bindTexture(e,t(r)))}},b_=class extends Be{constructor(){super(...arguments),this.origin=g()}};function pl(e,t){t.receiveShadows&&e.include(vm),gl(e,t)}function ml(e,t){t.receiveShadows&&e.include(_m),gl(e,t)}function gl(e,t){e.fragment.uniforms.add(new yt("lightingGlobalFactor",s=>s.lighting.globalFactor));const{receiveShadows:i,spherical:r}=t;e.include(pm,t),i&&bm(e),e.fragment.code.add(h`
    float readShadow(float additionalAmbientScale, vec3 vpos) {
      return ${i?"max(lightingGlobalFactor * (1.0 - additionalAmbientScale), readShadowMap(vpos, linearDepth))":U(r,"lightingGlobalFactor * (1.0 - additionalAmbientScale)","0.0")};
    }
  `)}function bm(e){e.include(xm),e.fragment.uniforms.add(new ym("shadowMap",({shadowMap:t})=>t.depthTexture)).code.add(h`float readShadowMap(const in vec3 _worldPos, float _linearDepth) {
vec3 uvzShadow = calculateUVZShadow(_worldPos, _linearDepth, textureSize(shadowMap,0));
if (uvzShadow.z < 0.0) {
return 0.0;
}
return readShadowMapUVZ(uvzShadow, shadowMap);
}`)}function wm(e,t){t.hasColorTextureTransform?(e.varyings.add("colorUV","vec2"),e.vertex.uniforms.add(new Ye("colorTextureTransformMatrix",i=>i.colorTextureTransformMatrix??ni)).code.add(h`void forwardColorUV(){
colorUV = (colorTextureTransformMatrix * vec3(vuv0, 1.0)).xy;
}`)):e.vertex.code.add(h`void forwardColorUV(){}`)}function Tm(e,t){t.hasNormalTextureTransform&&t.textureCoordinateType!==0?(e.varyings.add("normalUV","vec2"),e.vertex.uniforms.add(new Ye("normalTextureTransformMatrix",i=>i.normalTextureTransformMatrix??ni)).code.add(h`void forwardNormalUV(){
normalUV = (normalTextureTransformMatrix * vec3(vuv0, 1.0)).xy;
}`)):e.vertex.code.add(h`void forwardNormalUV(){}`)}function Mm(e,t){t.hasEmissionTextureTransform&&t.textureCoordinateType!==0?(e.varyings.add("emissiveUV","vec2"),e.vertex.uniforms.add(new Ye("emissiveTextureTransformMatrix",i=>i.emissiveTextureTransformMatrix??ni)).code.add(h`void forwardEmissiveUV(){
emissiveUV = (emissiveTextureTransformMatrix * vec3(vuv0, 1.0)).xy;
}`)):e.vertex.code.add(h`void forwardEmissiveUV(){}`)}function Sm(e,t){t.hasOcclusionTextureTransform&&t.textureCoordinateType!==0?(e.varyings.add("occlusionUV","vec2"),e.vertex.uniforms.add(new Ye("occlusionTextureTransformMatrix",i=>i.occlusionTextureTransformMatrix??ni)).code.add(h`void forwardOcclusionUV(){
occlusionUV = (occlusionTextureTransformMatrix * vec3(vuv0, 1.0)).xy;
}`)):e.vertex.code.add(h`void forwardOcclusionUV(){}`)}function Cm(e,t){t.hasMetallicRoughnessTextureTransform&&t.textureCoordinateType!==0?(e.varyings.add("metallicRoughnessUV","vec2"),e.vertex.uniforms.add(new Ye("metallicRoughnessTextureTransformMatrix",i=>i.metallicRoughnessTextureTransformMatrix??ni)).code.add(h`void forwardMetallicRoughnessUV(){
metallicRoughnessUV = (metallicRoughnessTextureTransformMatrix * vec3(vuv0, 1.0)).xy;
}`)):e.vertex.code.add(h`void forwardMetallicRoughnessUV(){}`)}function vl(e){e.include($o),e.code.add(h`
    vec3 mixExternalColor(vec3 internalColor, vec3 textureColor, vec3 externalColor, int mode) {
      // workaround for artifacts in macOS using Intel Iris Pro
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/10475
      vec3 internalMixed = internalColor * textureColor;
      vec3 allMixed = internalMixed * externalColor;

      if (mode == ${h.int(1)}) {
        return allMixed;
      }
      if (mode == ${h.int(2)}) {
        return internalMixed;
      }
      if (mode == ${h.int(3)}) {
        return externalColor;
      }

      // tint (or something invalid)
      float vIn = rgb2v(internalMixed);
      vec3 hsvTint = rgb2hsv(externalColor);
      vec3 hsvOut = vec3(hsvTint.x, hsvTint.y, vIn * hsvTint.z);
      return hsv2rgb(hsvOut);
    }

    float mixExternalOpacity(float internalOpacity, float textureOpacity, float externalOpacity, int mode) {
      // workaround for artifacts in macOS using Intel Iris Pro
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/10475
      float internalMixed = internalOpacity * textureOpacity;
      float allMixed = internalMixed * externalOpacity;

      if (mode == ${h.int(2)}) {
        return internalMixed;
      }
      if (mode == ${h.int(3)}) {
        return externalOpacity;
      }

      // multiply or tint (or something invalid)
      return allMixed;
    }
  `)}function _l(e,t){t.snowCover&&(e.uniforms.add(new yt("snowCover",i=>i.snowCover)).code.add(h`float getSnow(vec3 normal, vec3 groundNormal) {
return smoothstep(0.5, 0.55, dot(normal, groundNormal)) * snowCover;
}
float getRealisticTreeSnow(vec3 faceNormal, vec3 shadingNormal, vec3 groundNormal) {
float snow = min(1.0, smoothstep(0.5, 0.55, dot(faceNormal, groundNormal)) +
smoothstep(0.5, 0.55, dot(-faceNormal, groundNormal)) +
smoothstep(0.0, 0.1, dot(shadingNormal, groundNormal)));
return snow * snowCover;
}`),e.code.add(h`vec3 applySnowToMRR(vec3 mrr, float snow) {
return mix(mrr, vec3(0.0, 1.0, 0.04), snow);
}`))}function xl(e,t){e.include(Vo,t),e.include(bc,t),e.fragment.include($o);const{output:i,oitPass:r,discardInvisibleFragments:s,snowCover:a}=t,n=i===10,o=En(i),l=Ot(i)&&r===1,c=Ot(i)&&r!==1;let u=0;(c||o||l)&&e.outputs.add("fragColor","vec4",u++),o&&e.outputs.add("fragEmission","vec4",u++),l&&e.outputs.add("fragAlpha","float",u++),e.fragment.code.add(h`
    void outputColorHighlightOID(vec4 finalColor, const in vec3 vWorldPosition, vec3 emissiveSymbolColor ${U(a,", float snow")}) {
      ${U(n,"finalColor.a = 1.0;")}

      ${U(s,`if (finalColor.a < ${h.float(oi)}) { discard; }`)}

      finalColor = applySlice(finalColor, vWorldPosition);
      ${U(l,h`fragColor = premultiplyAlpha(finalColor);
             fragAlpha = finalColor.a;`)}
      ${U(c,"fragColor = finalColor;")}
      ${U(o,`fragEmission = ${U(a,"mix(finalColor.a * getEmissions(emissiveSymbolColor), vec4(0.0), snow);","finalColor.a * getEmissions(emissiveSymbolColor);")}`)}
      calculateOcclusionAndOutputHighlight();
      ${U(n,"outputObjectAndLayerIdColor();")}
    }
  `)}function Em(e){const t=new Pr,{attributes:i,vertex:r,fragment:s,varyings:a}=t,{output:n,normalType:o,offsetBackfaces:l,spherical:c,snowCover:u,pbrMode:d,textureAlphaPremultiplied:m,instancedDoublePrecision:v,hasVertexColors:p,hasVertexTangents:_,hasColorTexture:y,hasNormalTexture:w,hasNormalTextureTransform:T,hasColorTextureTransform:M}=e;if(Xt(r,e),i.add("position","vec3"),a.add("vpos","vec3",{invariant:!0}),t.include(Mi,e),t.include(rl,e),t.include(Ro,e),t.include(wm,e),!Ot(n))return t.include(ol,e),t;t.include(Tm,e),t.include(Mm,e),t.include(Sm,e),t.include(Cm,e),Fi(r,e),t.include($r,e),t.include(Jt);const E=o===0||o===1;return E&&l&&t.include(Ko),t.include(Np,e),t.include(Zo,e),t.include(il,e),a.add("vPositionLocal","vec3"),t.include(kt,e),t.include(sl,e),t.include(al,e),r.uniforms.add(new Nr("externalColor",I=>I.externalColor,{supportsNaN:!0})),a.add("vcolorExt","vec4"),t.include(No,e),r.include(Tt),r.include(Xs),t.include(v?pl:ml,e),r.main.add(h`
    forwardNormalizedVertexColor();

    MaskedColor maskedColor =
      applySymbolColor(applyVVColor(applyInstanceColor(createMaskedFromNaNColor(externalColor))));

    vcolorExt = maskedColor.color;
    forwardColorMixMode(maskedColor.mask);

    vpos = getVertexInLocalOriginSpace();
    vPositionLocal = vpos - view[3].xyz;
    vpos = subtractOrigin(vpos);
    ${U(E,"vNormalWorld = dpNormal(vvLocalNormal(normalModel()));")}
    vpos = addVerticalOffset(vpos, localOrigin);
    ${U(_,"vTangent = dpTransformVertexTangent(tangent);")}
    gl_Position = transformPosition(proj, view, vpos);
    ${U(E&&l,"gl_Position = offsetBackfacingClipPosition(gl_Position, vpos, vNormalWorld, cameraPosition);")}

    forwardViewPosDepth((view * vec4(vpos, 1.0)).xyz);
    forwardTextureCoordinates();
    forwardColorUV();
    forwardNormalUV();
    forwardEmissiveUV();
    forwardOcclusionUV();
    forwardMetallicRoughnessUV();

    if (opacityMixMode != ${h.int(Ti.ignore)} && vcolorExt.a < ${h.float(oi)}) {
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
    }
    forwardLinearDepthToReadShadowMap();
  `),t.include(hl,e),s.include(Zs,e),t.include(Qt,e),s.include(Zt,e),t.include(xl,e),Fi(s,e),s.uniforms.add(r.uniforms.get("localOrigin"),new ue("ambient",I=>I.ambient),new ue("diffuse",I=>I.diffuse),new xt("opacity",I=>I.opacity),new xt("layerOpacity",I=>I.layerOpacity)),y&&s.uniforms.add(new Ie("tex",I=>I.texture)),t.include(dl,e),s.include(Ks,e),s.include(vl),t.include(fm,e),s.include(_l,e),Qs(s),ea(s),Pi(s),s.main.add(h`
    discardBySlice(vpos);
    discardByTerrainDepth();
    ${y?h`
            vec4 texColor = texture(tex, ${M?"colorUV":"vuv0"});
            ${U(m,"texColor.rgb /= texColor.a;")}
            discardOrAdjustAlpha(texColor);`:h`vec4 texColor = vec4(1.0);`}
    shadingParams.viewDirection = normalize(vpos - cameraPosition);
    ${o===2?h`vec3 normal = screenDerivativeNormal(vPositionLocal);`:h`shadingParams.normalView = vNormalWorld;
                vec3 normal = shadingNormal(shadingParams);`}
    applyPBRFactors();
    float ssao = evaluateAmbientOcclusionInverse() * getBakedOcclusion();

    vec3 posWorld = vpos + localOrigin;

    float additionalAmbientScale = additionalDirectedAmbientLight(posWorld);
    float shadow = readShadow(additionalAmbientScale, vpos);

    vec3 matColor = max(ambient, diffuse);
    vec3 albedo = mixExternalColor(${U(p,"vColor.rgb *")} matColor, texColor.rgb, vcolorExt.rgb, colorMixMode);
    float opacity_ = layerOpacity * mixExternalOpacity(${U(p,"vColor.a * ")} opacity, texColor.a, vcolorExt.a, opacityMixMode);

    ${w?`mat3 tangentSpace = computeTangentSpace(${_?"normal":"normal, vpos, vuv0"});
            vec3 shadingNormal = computeTextureNormal(tangentSpace, ${T?"normalUV":"vuv0"});`:"vec3 shadingNormal = normal;"}
    vec3 normalGround = ${c?"normalize(posWorld);":"vec3(0.0, 0.0, 1.0);"}

    ${U(u,h`
          float snow = getSnow(normal, normalGround);
          albedo = mix(albedo, vec3(1), snow);
          shadingNormal = mix(shadingNormal, normal, snow);
          ssao = mix(ssao, 1.0, snow);`)}

    vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

    ${d===1||d===2?h`
            float additionalAmbientIrradiance = additionalAmbientIrradianceFactor * mainLightIntensity[2];
            ${U(u,"mrr = applySnowToMRR(mrr, snow);")}
            vec3 shadedColor = evaluateSceneLightingPBR(shadingNormal, albedo, shadow, 1.0 - ssao, additionalLight, shadingParams.viewDirection, normalGround, mrr, additionalAmbientIrradiance);`:h`vec3 shadedColor = evaluateSceneLighting(shadingNormal, albedo, shadow, 1.0 - ssao, additionalLight);`}
    vec4 finalColor = vec4(shadedColor, opacity_);
    outputColorHighlightOID(finalColor, vpos, albedo ${U(u,", snow")});
  `),t}const Im=Object.freeze(Object.defineProperty({__proto__:null,build:Em},Symbol.toStringTag,{value:"Module"}));let Rm=class extends _p{constructor(){super(...arguments),this.isSchematic=!1,this.usePBR=!1,this.mrrFactors=Fp,this.hasVertexColors=!1,this.hasSymbolColors=!1,this.doubleSided=!1,this.doubleSidedType="normal",this.cullFace=2,this.instanced=!1,this.instancedFeatureAttribute=!1,this.instancedColor=!1,this.instanceColorEncodesAlphaIgnore=!1,this.emissiveStrength=0,this.emissiveSource=1,this.emissiveBaseColor=ot,this.instancedDoublePrecision=!1,this.normalType=0,this.receiveShadows=!0,this.receiveAmbientOcclusion=!0,this.castShadows=!0,this.ambient=Ci(.2,.2,.2),this.diffuse=Ci(.8,.8,.8),this.externalColor=gs(1,1,1,1),this.colorMixMode="multiply",this.opacity=1,this.layerOpacity=1,this.origin=g(),this.hasSlicePlane=!1,this.offsetTransparentBackfaces=!1,this.vvSize=null,this.vvColor=null,this.vvOpacity=null,this.vvSymbolAnchor=null,this.vvSymbolRotationMatrix=null,this.modelTransformation=null,this.drivenOpacity=!1,this.writeDepth=!0,this.customDepthTest=0,this.textureAlphaMode=0,this.textureAlphaCutoff=oi,this.textureAlphaPremultiplied=!1,this.renderOccluded=1,this.isDecoration=!1}get hasVVSize(){return!!this.vvSize}get hasVVColor(){return!!this.vvColor}get hasVVOpacity(){return!!this.vvOpacity}},w_=class extends xp{constructor(){super(...arguments),this.origin=g(),this.slicePlaneLocalOrigin=this.origin}};class yl extends Bs{constructor(t,i,r=new Ar(Im,()=>Ai(()=>Oi(()=>import("./RealisticTree.glsl-WN9nrQUl-CRRcYwOn.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72])).then(s=>s.aq),Li([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66])))){const s=[vs(bl(i))];i.instanced&&i.instancedDoublePrecision&&s.push(vs(Rp(i))),super(t,i,r,wu(s))}_makePipeline(t,i){const{oitPass:r,output:s,transparent:a,cullFace:n,customDepthTest:o,hasOccludees:l}=t;return zr({blending:Ot(s)&&a?Df(r):null,culling:Pm(t)?Zh(n):null,depthTest:{func:Bf(r,Fm(o))},depthWrite:zf(t),drawBuffers:xd(s,$f(r,s)),colorWrite:Dr,stencilWrite:l?yp:null,stencilTest:l?i?wp:bp:null,polygonOffset:Vf(t)})}initializePipeline(t){return this._occludeePipelineState=this._makePipeline(t,!0),this._makePipeline(t,!1)}getPipeline(t){return t?this._occludeePipelineState:super.getPipeline()}}function Fm(e){switch(e){case 1:return 515;case 0:case 3:return 513;case 2:return 516}}function Pm(e){return e.cullFace!==0||!e.hasSlicePlane&&!e.transparent&&!e.doubleSidedMode}function bl(e){const t=As().vec3f("position");return e.normalType===1?t.vec2i16("normalCompressed",{glNormalized:!0}):t.vec3f("normal"),e.hasVertexTangents&&t.vec4f("tangent"),e.hasTextures&&t.vec2f16("uv0"),e.hasVertexColors&&t.vec4u8("color"),e.hasSymbolColors&&t.vec4u8("symbolColor"),!e.instanced&&js()&&t.vec4u8("olidColor"),t}let $=class extends Yt{constructor(e){super(),this.spherical=e,this.alphaDiscardMode=1,this.doubleSidedMode=0,this.pbrMode=0,this.cullFace=0,this.normalType=0,this.customDepthTest=0,this.emissionSource=0,this.hasVertexColors=!1,this.hasSymbolColors=!1,this.hasVerticalOffset=!1,this.hasColorTexture=!1,this.hasMetallicRoughnessTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.hasScreenSizePerspective=!1,this.hasVertexTangents=!1,this.hasOccludees=!1,this.instanced=!1,this.instancedDoublePrecision=!1,this.hasModelTransformation=!1,this.offsetBackfaces=!1,this.hasVVSize=!1,this.hasVVColor=!1,this.receiveShadows=!1,this.receiveAmbientOcclusion=!1,this.textureAlphaPremultiplied=!1,this.instancedFeatureAttribute=!1,this.instancedColor=!1,this.writeDepth=!0,this.transparent=!1,this.enableOffset=!0,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.snowCover=!1,this.hasColorTextureTransform=!1,this.hasEmissionTextureTransform=!1,this.hasNormalTextureTransform=!1,this.hasOcclusionTextureTransform=!1,this.hasMetallicRoughnessTextureTransform=!1,this.occlusionPass=!1,this.useCustomDTRExponentForWater=!1,this.useFillLights=!0,this.draped=!1}get textureCoordinateType(){return this.hasTextures?1:0}get hasTextures(){return this.hasColorTexture||this.hasNormalTexture||this.hasMetallicRoughnessTexture||this.emissionSource===3||this.hasOcclusionTexture}get hasVVInstancing(){return this.instanced}get discardInvisibleFragments(){return this.transparent}};f([V({count:4})],$.prototype,"alphaDiscardMode",void 0),f([V({count:3})],$.prototype,"doubleSidedMode",void 0),f([V({count:7})],$.prototype,"pbrMode",void 0),f([V({count:3})],$.prototype,"cullFace",void 0),f([V({count:3})],$.prototype,"normalType",void 0),f([V({count:3})],$.prototype,"customDepthTest",void 0),f([V({count:8})],$.prototype,"emissionSource",void 0),f([V()],$.prototype,"hasVertexColors",void 0),f([V()],$.prototype,"hasSymbolColors",void 0),f([V()],$.prototype,"hasVerticalOffset",void 0),f([V()],$.prototype,"hasColorTexture",void 0),f([V()],$.prototype,"hasMetallicRoughnessTexture",void 0),f([V()],$.prototype,"hasOcclusionTexture",void 0),f([V()],$.prototype,"hasNormalTexture",void 0),f([V()],$.prototype,"hasScreenSizePerspective",void 0),f([V()],$.prototype,"hasVertexTangents",void 0),f([V()],$.prototype,"hasOccludees",void 0),f([V()],$.prototype,"instanced",void 0),f([V()],$.prototype,"instancedDoublePrecision",void 0),f([V()],$.prototype,"hasModelTransformation",void 0),f([V()],$.prototype,"offsetBackfaces",void 0),f([V()],$.prototype,"hasVVSize",void 0),f([V()],$.prototype,"hasVVColor",void 0),f([V()],$.prototype,"receiveShadows",void 0),f([V()],$.prototype,"receiveAmbientOcclusion",void 0),f([V()],$.prototype,"textureAlphaPremultiplied",void 0),f([V()],$.prototype,"instancedFeatureAttribute",void 0),f([V()],$.prototype,"instancedColor",void 0),f([V()],$.prototype,"writeDepth",void 0),f([V()],$.prototype,"transparent",void 0),f([V()],$.prototype,"enableOffset",void 0),f([V()],$.prototype,"terrainDepthTest",void 0),f([V()],$.prototype,"cullAboveTerrain",void 0),f([V()],$.prototype,"snowCover",void 0),f([V()],$.prototype,"hasColorTextureTransform",void 0),f([V()],$.prototype,"hasEmissionTextureTransform",void 0),f([V()],$.prototype,"hasNormalTextureTransform",void 0),f([V()],$.prototype,"hasOcclusionTextureTransform",void 0),f([V()],$.prototype,"hasMetallicRoughnessTextureTransform",void 0);function Am(e){const t=new Pr,{attributes:i,vertex:r,fragment:s,varyings:a}=t,{output:n,offsetBackfaces:o,pbrMode:l,snowCover:c,spherical:u}=e,d=l===1||l===2;if(Xt(r,e),i.add("position","vec3"),a.add("vpos","vec3",{invariant:!0}),t.include(Mi,e),t.include(rl,e),t.include(Ro,e),t.include(No,e),!Ot(n))return t.include(ol,e),t;Fi(t.vertex,e),t.include($r,e),t.include(Jt),o&&t.include(Ko),a.add("vNormalWorld","vec3"),a.add("localvpos","vec3",{invariant:!0}),t.include(kt,e),t.include(sl,e),t.include(il,e),t.include(al,e),r.include(Tt),r.include(Xs),r.uniforms.add(new Nr("externalColor",p=>p.externalColor,{supportsNaN:!0})),a.add("vcolorExt","vec4"),t.include(e.instancedDoublePrecision?pl:ml,e),r.main.add(h`
    forwardNormalizedVertexColor();

    MaskedColor maskedColorExt =
      applySymbolColor(applyVVColor(applyInstanceColor(createMaskedFromNaNColor(externalColor))));

    vcolorExt = maskedColorExt.color;
    forwardColorMixMode(maskedColorExt.mask);

    bool alphaCut = opacityMixMode != ${h.int(Ti.ignore)} && vcolorExt.a < ${h.float(oi)};
    vpos = getVertexInLocalOriginSpace();

    localvpos = vpos - view[3].xyz;
    vpos = subtractOrigin(vpos);
    vNormalWorld = dpNormal(vvLocalNormal(normalModel()));
    vpos = addVerticalOffset(vpos, localOrigin);
    vec4 basePosition = transformPosition(proj, view, vpos);

    forwardViewPosDepth((view * vec4(vpos, 1.0)).xyz);
    forwardTextureCoordinates();
    forwardLinearDepthToReadShadowMap();
    gl_Position = alphaCut ? vec4(1e38, 1e38, 1e38, 1.0) :
    ${U(o,"offsetBackfacingClipPosition(basePosition, vpos, vNormalWorld, cameraPosition);","basePosition;")}
  `);const{hasColorTexture:m,hasColorTextureTransform:v}=e;return t.include(hl,e),s.include(Zs,e),t.include(Qt,e),s.include(Zt,e),t.include(xl,e),Fi(s,e),Sr(s),Qs(s),ea(s),s.uniforms.add(r.uniforms.get("localOrigin"),r.uniforms.get("view"),new ue("ambient",p=>p.ambient),new ue("diffuse",p=>p.diffuse),new xt("opacity",p=>p.opacity),new xt("layerOpacity",p=>p.layerOpacity)),m&&s.uniforms.add(new Ie("tex",p=>p.texture)),t.include(dl,e),s.include(Ks,e),s.include(vl),s.include(_l,e),Pi(s),s.main.add(h`
      discardBySlice(vpos);
      discardByTerrainDepth();
      vec4 texColor = ${m?`texture(tex, ${v?"colorUV":"vuv0"})`:" vec4(1.0)"};
      ${U(m,`${U(e.textureAlphaPremultiplied,"texColor.rgb /= texColor.a;")}
        discardOrAdjustAlpha(texColor);`)}
      vec3 viewDirection = normalize(vpos - cameraPosition);
      applyPBRFactors();
      float ssao = evaluateAmbientOcclusionInverse();
      ssao *= getBakedOcclusion();

      float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);
      vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
      float shadow = readShadow(additionalAmbientScale, vpos);
      vec3 matColor = max(ambient, diffuse);
      ${e.hasVertexColors?h`vec3 albedo = mixExternalColor(vColor.rgb * matColor, texColor.rgb, vcolorExt.rgb, colorMixMode);
             float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, opacityMixMode);`:h`vec3 albedo = mixExternalColor(matColor, texColor.rgb, vcolorExt.rgb, colorMixMode);
             float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, opacityMixMode);`}

      vec3 shadingNormal = normalize(vNormalWorld);
      vec3 groundNormal = ${u?"normalize(vpos + localOrigin)":"vec3(0.0, 0.0, 1.0)"};

      ${U(c,`vec3 faceNormal = screenDerivativeNormal(vpos);
         float snow = getRealisticTreeSnow(faceNormal, shadingNormal, groundNormal);
         albedo = mix(albedo, vec3(1), snow);`)}

      ${h`albedo *= 1.2;
             vec3 viewForward = vec3(view[0][2], view[1][2], view[2][2]);
             float alignmentLightView = clamp(dot(viewForward, -mainLightDirection), 0.0, 1.0);
             float transmittance = 1.0 - clamp(dot(viewForward, shadingNormal), 0.0, 1.0);
             float treeRadialFalloff = vColor.r;
             float backLightFactor = 0.5 * treeRadialFalloff * alignmentLightView * transmittance * (1.0 - shadow);
             additionalLight += backLightFactor * mainLightIntensity;`}

      ${d?h`float additionalAmbientIrradiance = additionalAmbientIrradianceFactor * mainLightIntensity[2];
            ${U(c,"mrr = applySnowToMRR(mrr, snow);")}
            vec3 shadedColor = evaluateSceneLightingPBR(shadingNormal, albedo, shadow, 1.0 - ssao, additionalLight, viewDirection, groundNormal, mrr, additionalAmbientIrradiance);`:h`vec3 shadedColor = evaluateSceneLighting(shadingNormal, albedo, shadow, 1.0 - ssao, additionalLight);`}
      vec4 finalColor = vec4(shadedColor, opacity_);
      outputColorHighlightOID(finalColor, vpos, albedo ${U(c,", 1.0")});`),t}const Om=Object.freeze(Object.defineProperty({__proto__:null,build:Am},Symbol.toStringTag,{value:"Module"}));let Dm=class extends yl{constructor(e,t){super(e,t,new Ar(Om,()=>Ai(()=>Oi(()=>import("./RealisticTree.glsl-WN9nrQUl-CRRcYwOn.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72])).then(i=>i.ar),Li([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66]))))}};class T_ extends df{constructor(t,i){super(t,Nm),this.materialType="default",this.supportsEdges=!0,this.intersectDraped=void 0,this.produces=new Map([[2,r=>(Gr(r)||rr(r))&&!this.transparent],[4,r=>(Gr(r)||rr(r))&&this.transparent&&this.parameters.writeDepth],[8,r=>(Gr(r)||rr(r))&&this.transparent&&!this.parameters.writeDepth]]),this._layout=bl(this.parameters),this._configuration=new $(i.spherical)}isVisibleForOutput(t){return t!==4&&t!==6&&t!==5||this.parameters.castShadows}get visible(){const{layerOpacity:t,colorMixMode:i,opacity:r,externalColor:s}=this.parameters;return t*(i==="replace"?1:r)*(i==="ignore"||isNaN(s[3])?1:s[3])>=oi}get _hasEmissiveBase(){return!!this.parameters.emissiveTextureId||!We(this.parameters.emissiveBaseColor,ot)}get hasEmissions(){return this.parameters.emissiveStrength>0&&(this.parameters.emissiveSource===0&&this._hasEmissiveBase||this.parameters.emissiveSource===1)}getConfiguration(t,i){const{parameters:r,_configuration:s}=this,{treeRendering:a,doubleSided:n,doubleSidedType:o}=r;return super.getConfiguration(t,i,this._configuration),s.hasNormalTexture=r.hasNormalTexture,s.hasColorTexture=r.hasColorTexture,s.hasMetallicRoughnessTexture=r.hasMetallicRoughnessTexture,s.hasOcclusionTexture=r.hasOcclusionTexture,s.hasVertexTangents=!a&&r.hasVertexTangents,s.instanced=r.instanced,s.instancedDoublePrecision=r.instancedDoublePrecision,s.hasVVColor=!!r.vvColor,s.hasVVSize=!!r.vvSize,s.hasVerticalOffset=r.verticalOffset!=null,s.hasScreenSizePerspective=r.screenSizePerspective!=null,s.hasSlicePlane=r.hasSlicePlane,s.alphaDiscardMode=r.textureAlphaMode,s.normalType=a?0:r.normalType,s.transparent=this.transparent,s.writeDepth=r.writeDepth,s.customDepthTest=r.customDepthTest??0,s.hasOccludees=i.hasOccludees,s.cullFace=r.hasSlicePlane?0:r.cullFace,s.cullAboveTerrain=i.cullAboveTerrain,s.hasModelTransformation=!a&&r.modelTransformation!=null,s.hasVertexColors=r.hasVertexColors,s.hasSymbolColors=r.hasSymbolColors,s.doubleSidedMode=a?2:n&&o==="normal"?1:n&&o==="winding-order"?2:0,s.instancedFeatureAttribute=r.instancedFeatureAttribute,s.instancedColor=r.instancedColor,Ot(t)?(s.terrainDepthTest=i.terrainDepthTest,s.receiveShadows=r.receiveShadows,s.receiveAmbientOcclusion=r.receiveAmbientOcclusion&&i.ssao!=null):(s.terrainDepthTest=!1,s.receiveShadows=s.receiveAmbientOcclusion=!1),s.textureAlphaPremultiplied=!!r.textureAlphaPremultiplied,s.pbrMode=r.usePBR?r.isSchematic?2:1:0,s.emissionSource=r.emissionSource,s.offsetBackfaces=!(!this.transparent||!r.offsetTransparentBackfaces),s.oitPass=i.oitPass,s.enableOffset=i.camera.relativeElevation<Nf,s.snowCover=i.snowCover>0,s.hasColorTextureTransform=!!r.colorTextureTransformMatrix,s.hasNormalTextureTransform=!!r.normalTextureTransformMatrix,s.hasEmissionTextureTransform=!!r.emissiveTextureTransformMatrix,s.hasOcclusionTextureTransform=!!r.occlusionTextureTransformMatrix,s.hasMetallicRoughnessTextureTransform=!!r.metallicRoughnessTextureTransformMatrix,s}intersect(t,i,r,s,a,n){if(this.parameters.verticalOffset!=null){const o=r.camera;G(hs,i[12],i[13],i[14]);let l=null;switch(r.viewingMode){case 1:l=Te(hn,hs);break;case 2:l=Y(hn,$m)}let c=0;const u=ce(jm,hs,o.eye),d=te(u),m=q(u,u,1/d);let v=null;this.parameters.screenSizePerspective&&(v=we(l,m)),c+=uf(o,d,this.parameters.verticalOffset,v??0,this.parameters.screenSizePerspective,null),q(l,l,c),Pl(us,l,r.transform.inverseRotation),s=ce(Vm,s,us),a=ce(Bm,a,us)}Qf(t,r,s,a,Ts(r.verticalOffset),n)}createGLMaterial(t){return new zm(t)}createBufferWriter(){return new fp(this._layout)}get transparent(){return Lm(this.parameters)}}let zm=class extends nf{constructor(e){super({...e,...e.material.parameters})}beginSlot(e){this._material.setParameters({receiveShadows:e.shadowMap.enabled});const t=this._material.parameters;this.updateTexture(t.textureId);const i=e.camera.viewInverseTransposeMatrix;return G(t.origin,i[3],i[7],i[11]),this._material.setParameters(this.textureBindParameters),this.getTechnique(t.treeRendering?Dm:yl,e)}},Nm=class extends Rm{constructor(){super(...arguments),this.treeRendering=!1,this.hasVertexTangents=!1}get hasNormalTexture(){return!this.treeRendering&&!!this.normalTextureId}get hasColorTexture(){return!!this.textureId}get hasMetallicRoughnessTexture(){return!this.treeRendering&&!!this.metallicRoughnessTextureId}get hasOcclusionTexture(){return!this.treeRendering&&!!this.occlusionTextureId}get emissionSource(){return this.treeRendering?0:this.emissiveTextureId!=null&&this.emissiveSource===0?3:this.usePBR?this.emissiveSource===0?2:1:0}get hasTextures(){return this.hasColorTexture||this.hasNormalTexture||this.hasMetallicRoughnessTexture||this.emissionSource===3||this.hasOcclusionTexture}};function Lm(e){const{drivenOpacity:t,opacity:i,externalColor:r,layerOpacity:s,texture:a,textureId:n,textureAlphaMode:o,colorMixMode:l}=e,c=r[3];return t||i<1&&l!=="replace"||c<1&&l!=="ignore"||s<1||(a!=null||n!=null)&&o!==1&&o!==2&&l!=="replace"}const Vm=g(),Bm=g(),$m=ve(0,0,1),hn=g(),us=g(),hs=g(),jm=g(),_t=16;function dn(e,t){return t=Math.floor(t/_t)*_t,Math.min(Math.round(e/_t)*_t,t)}function M_(e,t){return t=Math.floor(t/_t)*_t,Math.min(Math.ceil(e/_t)*_t,t)}function Hm(e,t){const[i,r]=Um(e,t);return e.width===i&&e.height===r?e:wl(e,i,r)}function Um({width:e,height:t},{maxPreferredTexturePixels:i,maxTextureSize:r}){const s=Math.max(e,t),a=e*t;if(s<=r&&a<=i)return[e,t];const n=Math.min(Math.sqrt(i/a),r/s);return[dn(Math.round(e*n),r),dn(Math.round(t*n),r)]}function wl(e,t,i){if(e instanceof ImageData)return wl(Gm(e),t,i);const r=document.createElement("canvas");return r.width=t,r.height=i,r.getContext("2d").drawImage(e,0,0,r.width,r.height),r}function Gm(e){const t=document.createElement("canvas");t.width=e.width,t.height=e.height;const i=t.getContext("2d");if(i==null)throw new X("texture:context-failed","Failed to create 2d context from HTMLCanvasElement");return i.putImageData(e,0,0),t}async function Wm(e,t){const{data:i}=await mu(e,{responseType:"image",...t});return i}function km(){return fn??=(async()=>{const e=await Ai(()=>Oi(()=>import("./basis_transcoder-DuG70Smz-n335q0Yd.js"),[]),[]),t=await e.default({locateFile:i=>vu(`esri/libs/basisu/${i}`)});return t.initializeBasis(),t})(),fn}let fn,Le=null,er=null;async function Tl(){return er==null&&(er=km(),Le=await er),er}function qm(e,t){if(Le==null)return e.byteLength;const i=new Le.BasisFile(new Uint8Array(e)),r=Sl(i)?Ml(i.getNumLevels(0),i.getHasAlpha(),i.getImageWidth(0,0),i.getImageHeight(0,0),t):0;return i.close(),i.delete(),r}function Xm(e,t){if(Le==null)return e.byteLength;const i=new Le.KTX2File(new Uint8Array(e)),r=Cl(i)?Ml(i.getLevels(),i.getHasAlpha(),i.getWidth(),i.getHeight(),t):0;return i.close(),i.delete(),r}function Ml(e,t,i,r,s){const a=xo(t?K.COMPRESSED_RGBA8_ETC2_EAC:K.COMPRESSED_RGB8_ETC2),n=s&&e>1?(4**e-1)/(3*4**(e-1)):1;return Math.ceil(i*r*a*n)}function Sl(e){return e.getNumImages()>=1&&!e.isUASTC()}function Cl(e){return e.getFaces()>=1&&e.isETC1S()}async function Ym(e,t,i){Le==null&&(Le=await Tl());const r=new Le.BasisFile(new Uint8Array(i));if(!Sl(r))return null;r.startTranscoding();const s=El(e,t,r.getNumLevels(0),r.getHasAlpha(),r.getImageWidth(0,0),r.getImageHeight(0,0),(a,n)=>r.getImageTranscodedSizeInBytes(0,a,n),(a,n,o)=>r.transcodeImage(o,0,a,n,0,0));return r.close(),r.delete(),s}async function Zm(e,t,i){Le==null&&(Le=await Tl());const r=new Le.KTX2File(new Uint8Array(i));if(!Cl(r))return null;r.startTranscoding();const s=El(e,t,r.getLevels(),r.getHasAlpha(),r.getWidth(),r.getHeight(),(a,n)=>r.getImageTranscodedSizeInBytes(a,0,0,n),(a,n,o)=>r.transcodeImage(o,a,0,0,n,0,-1,-1));return r.close(),r.delete(),s}function El(e,t,i,r,s,a,n,o){const{compressedTextureETC:l,compressedTextureS3TC:c}=e.capabilities,[u,d]=l?r?[1,K.COMPRESSED_RGBA8_ETC2_EAC]:[0,K.COMPRESSED_RGB8_ETC2]:c?r?[3,K.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[2,K.COMPRESSED_RGB_S3TC_DXT1_EXT]:[13,6408],m=t.hasMipmap?i:Math.min(1,i),v=[];for(let p=0;p<m;p++)v.push(new Uint8Array(n(p,u))),o(p,u,v[p]);return t.internalFormat=d,t.hasMipmap=v.length>1,t.samplingMode=t.hasMipmap?9987:9729,t.width=s,t.height=a,new ti(e,t,{type:"compressed",levels:v})}const tr=()=>bt.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil"),Jm=542327876,Km=131072,Qm=4;function ta(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}function eg(e){return String.fromCharCode(255&e,e>>8&255,e>>16&255,e>>24&255)}const tg=ta("DXT1"),ig=ta("DXT3"),rg=ta("DXT5"),sg=31,ag=0,ng=1,og=2,lg=3,cg=4,ug=7,hg=20,dg=21;function fg(e,t,i){const r=pg(i,t.hasMipmap??!1);if(r==null)throw new Error("DDS texture data is null");const{textureData:s,internalFormat:a,width:n,height:o}=r;return t.samplingMode=s.levels.length>1?9987:9729,t.hasMipmap=s.levels.length>1,t.internalFormat=a,t.width=n,t.height=o,new ti(e,t,s)}function pg(e,t){const i=new Int32Array(e.buffer,e.byteOffset,sg);if(i[ag]!==Jm)return tr().error("Invalid magic number in DDS header"),null;if(!(i[hg]&Qm))return tr().error("Unsupported format, must contain a FourCC code"),null;const r=i[dg];let s,a;switch(r){case tg:s=8,a=K.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case ig:s=16,a=K.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case rg:s=16,a=K.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return tr().error("Unsupported FourCC code:",eg(r)),null}let n=1,o=i[cg],l=i[lg];(3&o||3&l)&&(tr().warn("Rounding up compressed texture size to nearest multiple of 4."),o=o+3&-4,l=l+3&-4);const c=o,u=l;let d,m;i[og]&Km&&t!==!1&&(n=Math.max(1,i[ug]));let v=e.byteOffset+i[ng]+4;const p=[];for(let _=0;_<n;++_)m=(o+3>>2)*(l+3>>2)*s,d=new Uint8Array(e.buffer,v,m),p.push(d),v+=m,o=Math.max(1,o>>1),l=Math.max(1,l>>1);return{textureData:{type:"compressed",levels:p},internalFormat:a,width:c,height:u}}let S_=class{constructor(e,t){this._data=e,this.id=Cr(),this.events=new zn,this._parameters={...gg,...t},this._startPreload(e)}dispose(){this.unload(),this._data=this.update=void 0}_startPreload(e){e instanceof HTMLVideoElement?(this.update=t=>this._update(e,t),this._startPreloadVideoElement(e)):e instanceof HTMLImageElement&&this._startPreloadImageElement(e)}_startPreloadVideoElement(e){if(!(wa(e.src)||e.preload==="auto"&&e.crossOrigin)&&(e.preload="auto",e.crossOrigin="anonymous",e.src=e.src,e.paused&&e.autoplay)){const t=[];Mu(e,i=>t.push(i)).then(()=>{e.play()}).finally(()=>t.forEach(i=>i.remove()))}}_startPreloadImageElement(e){du(e.src)||wa(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)}_createDescriptor(e){const t=new $s;return t.wrapMode=this._parameters.wrap??10497,t.flipped=!this._parameters.noUnpackFlip,t.samplingMode=this._parameters.mipmap?9987:9729,t.hasMipmap=!!this._parameters.mipmap,t.preMultiplyAlpha=!!this._parameters.preMultiplyAlpha,t.maxAnisotropy=this._parameters.maxAnisotropy??(this._parameters.mipmap?e.parameters.maxMaxAnisotropy:1),t.dataType=this._parameters.dataType??t.dataType,t.pixelFormat=this._parameters.pixelFormat??t.pixelFormat,t.internalFormat=this._parameters.internalFormat??t.internalFormat,t}get glTexture(){return this._glTexture??this._emptyTexture}get loaded(){return this._glTexture!=null}get usedMemory(){return this._glTexture?.usedMemory||mg(this._data,this._parameters)}load(e){if(this._loadingPromise)return this._loadingPromise;if(this._glTexture)return this._glTexture;const t=this._data;return t==null?(this._glTexture=new ti(e,this._createDescriptor(e),null),this._glTexture):(this._emptyTexture=e.emptyTexture,this._parameters.reloadable||(this._data=void 0),typeof t=="string"?this._loadFromURL(e,t):t instanceof Image?this._loadFromImageElement(e,t):t instanceof HTMLVideoElement?this._loadFromVideoElement(e,t):t instanceof ImageData||t instanceof HTMLCanvasElement?this._loadFromImage(e,t):xi(t)&&this._parameters.encoding==="image/vnd-ms.dds"?this._loadFromDDSData(e,t):vi(t)&&this._parameters.encoding==="image/vnd-ms.dds"?this._loadFromDDSData(e,new Uint8Array(t)):(vi(t)||xi(t))&&this._parameters.encoding==="image/ktx2"?this._loadFromKTX2(e,t):(vi(t)||xi(t))&&this._parameters.encoding==="image/x.basis"?this._loadFromBasis(e,t):vi(t)?this._loadFromPixelData(e,new Uint8Array(t)):jl(t)?this._loadFromPixelData(e,t):null)}_update(e,t){return this._glTexture==null||e.readyState<HTMLMediaElement.HAVE_CURRENT_DATA||t===e.currentTime?t:(this._glTexture.setData(e),this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this._parameters.updateCallback&&this._parameters.updateCallback(),e.currentTime)}_loadFromDDSData(e,t){return this._glTexture=fg(e,this._createDescriptor(e),t),this._emptyTexture=null,this._glTexture}_loadFromKTX2(e,t){return this._loadAsync(()=>Zm(e,this._createDescriptor(e),t).then(i=>(this._glTexture=i,i)))}_loadFromBasis(e,t){return this._loadAsync(()=>Ym(e,this._createDescriptor(e),t).then(i=>(this._glTexture=i,i)))}_loadFromPixelData(e,t){W(this._parameters.width>0&&this._parameters.height>0);const i=this._createDescriptor(e);return i.pixelFormat!==6407&&i.pixelFormat!==6408||(i.compress=this._parameters.compressionOptions),i.width=this._parameters.width??0,i.height=this._parameters.height??0,this._glTexture=new ti(e,i,t),this._glTexture}_loadFromURL(e,t){return this._loadAsync(async i=>{const r=await Wm(t,{signal:i});return hr(i),this._loadFromImage(e,r)})}_loadFromImageElement(e,t){return t.complete?this._loadFromImage(e,t):this._loadAsync(async i=>{const r=await fu(t,t.src,!1,i);return hr(i),this._loadFromImage(e,r)})}_loadFromVideoElement(e,t){return t.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA?this._loadFromImage(e,t):this._loadFromVideoElementAsync(e,t)}_loadFromVideoElementAsync(e,t){return this._loadAsync(i=>new Promise((r,s)=>{const a=()=>{t.removeEventListener("loadeddata",n),t.removeEventListener("error",o),Yl(l)},n=()=>{t.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA&&(a(),r(this._loadFromImage(e,t)))},o=c=>{a(),s(c||new X("texture:load-error","Failed to load video"))};t.addEventListener("loadeddata",n),t.addEventListener("error",o);const l=Hl(i,()=>o(Ul()))}))}_loadFromImage(e,t){let i=t;i instanceof HTMLVideoElement||(i=Hm(i,e.parameters));const r=Il(i);this._parameters.width=r.width,this._parameters.height=r.height;const s=this._createDescriptor(e);return s.width=r.width,s.height=r.height,s.compress=this._parameters.compressionOptions,this._glTexture=new ti(e,s,i),this._emptyTexture=null,this.events.emit("loaded"),this._glTexture}_loadAsync(e){const t=new AbortController;this._loadingController=t;const i=e(t.signal);this._loadingPromise=i;const r=()=>{this._loadingController===t&&(this._loadingController=null),this._loadingPromise===i&&(this._loadingPromise=null),this._emptyTexture=null};return i.then(r,r),i}unload(){if(this._glTexture=dr(this._glTexture),this._emptyTexture=null,this._loadingController!=null){const e=this._loadingController;this._loadingController=null,this._loadingPromise=null,e.abort()}this.events.emit("unloaded")}get parameters(){return this._parameters}};function mg(e,t){if(e==null)return 0;if(vi(e)||xi(e))return t.encoding==="image/ktx2"?Xm(e,!!t.mipmap):t.encoding==="image/x.basis"?qm(e,!!t.mipmap):e.byteLength;const{width:i,height:r}=e instanceof Image||e instanceof ImageData||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement?Il(e):t,s=t.pixelFormat??6408,a=Ed(s);return(t.mipmap?4/3:1)*i*r*a||0}function Il(e){return e instanceof HTMLVideoElement?{width:e.videoWidth,height:e.videoHeight}:e}const gg={wrap:{s:10497,t:10497},mipmap:!0,noUnpackFlip:!1,preMultiplyAlpha:!1};export{jv as $,Dv as A,Ar as B,M_ as C,Lp as D,_o as E,zr as F,Sr as G,Pi as H,Ov as I,v_ as J,Mv as K,$s as L,Mi as M,Bs as N,zd as O,Sf as P,to as Q,zt as R,Ws as S,Sd as T,ks as U,Be as V,Lr as W,Ca as X,Yt as Y,Tv as Z,rv as _,Vd as a,Kf as a$,zf as a0,T_ as a1,Vv as a2,xo as a3,Es as a4,Nd as a5,Ld as a6,hv as a7,jn as a8,bs as a9,Ah as aA,cv as aB,sv as aC,dn as aD,Um as aE,dh as aF,up as aG,iv as aH,gi as aI,ke as aJ,S_ as aK,Js as aL,Mf as aM,No as aN,Xt as aO,De as aP,Zt as aQ,xl as aR,$o as aS,Nr as aT,Jh as aU,Vs as aV,At as aW,Oh as aX,La as aY,Gn as aZ,uv as a_,ih as aa,dv as ab,fv as ac,ju as ad,Su as ae,$u as af,Iv as ag,Lf as ah,wp as ai,bp as aj,yp as ak,Dr as al,xd as am,Bf as an,Df as ao,u_ as ap,a_ as aq,qh as ar,c_ as as,n_ as at,s_ as au,ff as av,pf as aw,Fo as ax,Pr as ay,io as az,Ri as b,mp as b$,Qv as b0,Fd as b1,o_ as b2,Xh as b3,oo as b4,Wm as b5,Hf as b6,Pa as b7,Ns as b8,rh as b9,yo as bA,_v as bB,xv as bC,yv as bD,ao as bE,r_ as bF,cp as bG,l_ as bH,Zh as bI,$f as bJ,Ye as bK,Dp as bL,_p as bM,Yo as bN,Kp as bO,If as bP,Vp as bQ,xm as bR,ym as bS,i_ as bT,Jr as bU,lv as bV,ov as bW,vm as bX,kp as bY,mv as bZ,gv as b_,Yv as ba,nv as bb,bv as bc,tv as bd,Cv as be,Or as bf,t_ as bg,b_ as bh,vv as bi,Fp as bj,Gv as bk,ro as bl,Qd as bm,y_ as bn,$r as bo,Jt as bp,Vo as bq,tf as br,zp as bs,Pp as bt,el as bu,hl as bv,ml as bw,Zs as bx,Qs as by,ea as bz,Kd as c,Yh as c$,Zo as c0,al as c1,__ as c2,Uv as c3,dl as c4,Np as c5,pl as c6,g_ as c7,_l as c8,vl as c9,Zv as cA,p_ as cB,d_ as cC,f_ as cD,Ev as cE,Lo as cF,Mo as cG,Rv as cH,kv as cI,Hv as cJ,xf as cK,Ya as cL,cf as cM,bo as cN,gm as cO,Rm as cP,w_ as cQ,$ as cR,yl as cS,pv as cT,wv as cU,yd as cV,Kv as cW,Fv as cX,Pv as cY,Nv as cZ,Av as c_,V as ca,av as cb,lf as cc,Jd as cd,uf as ce,gf as cf,ss as cg,Bv as ch,$v as ci,_f as cj,nf as ck,Uf as cl,Jv as cm,sf as cn,Bp as co,Ys as cp,Yp as cq,Em as cr,Am as cs,Nf as ct,fp as cu,yf as cv,Vf as cw,Qf as cx,e_ as cy,Tl as cz,Fi as d,fm as d0,as as d1,Pf as d2,m_ as d3,mi as d4,Rp as d5,h_ as d6,Ti as d7,gp as d8,vp as d9,Xo as da,qo as db,Nm as dc,Lm as dd,jf as de,Sv as e,ef as f,Xv as g,Af as h,zv as i,yt as j,x_ as k,dm as l,tn as m,or as n,oi as o,qv as p,Yf as q,Wv as r,js as s,ti as t,df as u,xp as v,af as w,bd as x,Td as y,Vu as z};
