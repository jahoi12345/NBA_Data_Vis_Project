import{l as ne,Q as ae,o as le,i as ue,_ as P,m as B,a as me}from"./jsonMap-Bs3hmeCU.js";import{n,r as pe,j as $t,i as ce,O as he}from"./collectionUtils-oMUPqMMC.js";import{l as ht,w as Ot,U as It}from"./reactiveUtils-SO2Ko3sy.js";import{r as Pt}from"./signal-BX9ezF8a.js";import{C as fe,i as de,d as At}from"./aaBoundingRect-C2DMsiYR.js";import{l as Bt,h as Tt}from"./FeatureTileDescriptor-Bb_QT1pS.js";import{s as Lt,A as E,R as N,P as T,q as at,o as _,W as H,_ as tt,u as St,g as X,Y as vt}from"./vec32-D-LmkFhk.js";import{q as ft}from"./frustum-CMU-76e0.js";import{a as _e}from"./sphere-Bsee12C4.js";import{a5 as ge}from"./Point-Byf20bUE.js";import{a as ve}from"./spatialReferenceEllipsoidUtils-Dh5jNhp7.js";import{C as ye,d as Te,b as Se}from"./projectionUtils-Ca1qXe4h.js";import{b as nt,X as mt}from"./plane-DWmLiQ-_.js";import{c as be,g as Me}from"./Texture-DTVG6Cub.js";import{aa as we}from"./ShadowCastClear.glsl-CTBiNCmp.js";import{f as bt,F as kt}from"./Scheduler-CNrsbccs.js";import"./index-DqD_sEjA.js";import"./reader-DcGs6kKN.js";import"./Extent-KC9qx-Cg.js";import"./SimpleObservable-CvFyr0NA.js";import"./mathUtils-PIGhLnI9.js";import"./Polygon-BuPlovwL.js";import"./vector-rshDErmj.js";import"./mat4f64-q_b6UJoq.js";import"./quatf64-CCm9z-pX.js";import"./vec2f64-rIxtbMRN.js";import"./vec4f64-DPb6J-GU.js";import"./mat4-Dyb44KrD.js";import"./vec42-B7JTmW9u.js";import"./Polyline-DWJWvQfr.js";import"./Indices-D0_UQPPr.js";import"./BufferView-DJ6YhZlA.js";import"./Emissions.glsl-B8XKMjLy.js";import"./Color-CERqXxxY.js";import"./enums-B4pqBiXb.js";import"./aaBoundingBox-3Iqogf_p.js";import"./DoubleArray-DExKNiTh.js";import"./orientedBoundingBox-BZfYAK8f.js";import"./quat-BOZsyh2S.js";import"./computeTranslationToOriginAndRotation-D3f4P-V4.js";import"./InterleavedLayout-BzTz5c2k.js";import"./types-BKo2foNY.js";import"./VertexElementDescriptor-BlxU8vCE.js";import"./screenUtils-BitdhK1O.js";import"./lengthUtils-go2kD43r.js";import"./date-IqUzANpt.js";import"./Cyclical-BLSxUpe7.js";import"./projectPointToVector-CB8yc0oW.js";import"./projectVectorToVector-ClOaOAsc.js";import"./HUDIntersectorResult-CB-YC_gl.js";import"./normalizeUtils-Cn5Bv9D5.js";import"./normalizeUtilsCommon-CXyKHnVX.js";import"./jsonUtils-yEjkUv4W.js";import"./utils-Co6npZg_.js";import"./utils-pRUfTktY.js";import"./videoUtils-Dwx3AEgj.js";import"./typeUtils-cp7rBKcN.js";import"./modeUtils-BQgEm-fS.js";import"./intl-sjEXBsFq.js";import"./uuid-Oe6SV2kF.js";import"./sanitizerUtils-BT_8V5US.js";import"./workers-1ohSU8uJ.js";import"./Queue-CYlrXMwB.js";import"./PooledRBush-Dco5QkUp.js";import"./quickselect-QQC62dOK.js";import"./GraphicsCollection-B5BtcSOd.js";import"./Graphic-DDayESOh.js";import"./getPopupProvider-3D7bbDmC.js";import"./Layer-C7047eDe.js";import"./createFeatureId-CVwTD0fV.js";import"./typeUtils-CzDvsuOn.js";import"./lineMarkers-CDwLe3J6.js";import"./PolygonSymbol3D-59towS1W.js";import"./ExtrudeSymbol3DLayer-DSc1ou2x.js";import"./opacityUtils-DuFH0EC9.js";import"./Font-2nHmDeHF.js";import"./SimpleFillSymbol-CDawtd9z.js";import"./SimpleMarkerSymbol-BGAFRS9_.js";import"./PictureMarkerSymbol-BOUJUEwC.js";import"./TextSymbol-nUyYMD__.js";import"./HeightModelInfo-BAxQYIJ4.js";import"./RealisticTree.glsl-CEyQWjjF.js";import"./meshVertexSpaceUtils-4wKFiYHz.js";import"./MeshLocalVertexSpace-BF5t-ZPw.js";import"./vec3f32-WCVSSNPR.js";import"./memoryEstimations-Bd726a_p.js";import"./Intersector-xRrE-gUt.js";import"./scaleUtils-BWnCGTna.js";import"./layerUtils-CVHRa_-F.js";import"./TilemapCache-BbjoN03J.js";import"./LRUCache-fy84PBMi.js";import"./TileKey-7ckOq8tD.js";import"./tagSymbols-BPcGfZon.js";import"./UpdatingHandles-D2RI_3Hb.js";import"./asyncUtils-w6KfWU41.js";import"./Map-DHqF3BVm.js";import"./Basemap-DGCp49tr.js";import"./loadAll-CJq_H00c.js";import"./PortalItem-BBxBVCCK.js";import"./writeUtils-BEpoIKEQ.js";import"./CollectionFlattener-DgYL3St7.js";import"./persistable-BoVzi5yb.js";import"./MD5-MtSiOt06.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw.js";import"./resourceExtension-D2zUsunA.js";import"./PolygonCollection-CKv8Fhgy.js";import"./mat4f32-Djp3mnm5.js";import"./TablesMixin-CNKorJ8k.js";import"./timeZoneUtils-BSc7-7qA.js";import"./ReactiveMap-B0by2bYu.js";import"./Query-CEeFv7EX.js";import"./Field-Cm_ZejYW.js";import"./fieldType-DVUzXtk_.js";import"./ElevationQuery-DPyvicX-.js";import"./TileInfo-91BYYMfX.js";import"./constants-D67WmGms.js";import"./floatRGBA-CKE8XRqu.js";import"./labelUtils-BtizwBfq.js";import"./ArcadeExpression-Cdtbfg1V.js";import"./TimeOnly-DVuxiQet.js";import"./enum-BzLwmiID.js";import"./UnknownTimeZone-B697BDFv.js";import"./FieldsIndex-CKlbiDH8.js";import"./TileKey-C44YQC4_.js";import"./layerViewUtils-BTa15X3o.js";import"./unitConversionUtils-CewTmddc.js";import"./vec2f32-CaVKkSa6.js";import"./dehydratedFeatures-mX9SSgz7.js";import"./quantizationUtils-BEnKwGJh.js";import"./featureConversionUtils-DmN26Mnx.js";import"./OptimizedFeature-CwRGZPwv.js";import"./OptimizedFeatureSet-BR8EEvDc.js";import"./Octree-D2AA2k9W.js";import"./elevationInfoUtils-DnjVkdfR.js";import"./intersectorUtilsConversions-rja_eiKU.js";import"./DefaultLoadingContext-C43nV_Si.js";import"./wosrLoader-BQn9EqLz.js";import"./Version-BtYZEj58.js";import"./axisAngleDegrees-DcezjY_o.js";import"./edgePreprocessing-t8VXN1GM.js";import"./config-Dg972SSE.js";import"./GeometryUtils-BG5lg9a7.js";import"./definitions-Dvg4hMIw.js";import"./WorkerHandle-BioJnATq.js";import"./colorUtils-lLdknrGQ.js";import"./vec3-B_phcnZY.js";import"./vec33-CWJeyzxV.js";import"./capabilities-Bi6C4OG6.js";import"./imageUtils-BJxc18ls.js";function Re(i,t,e,r,o,l,s=1){const a=ye(t,o);if(a==null)return!1;if(a===Te){if(i===r&&e===l)return!0;const m=e+s;for(let d=e,p=l;d<m;++d,++p)Lt(r[p],i[d]);return!0}const u=e+s;for(let m=e,d=l;m<u;++m,++d)a(i[m],0,r[d],0);return!0}let xe=class{constructor(t,e){this._renderCoordsHelper=t,this.opaqueGround=e,this._cache=new Map,this._cameraForward=n(),this._cameraEye=n(),this._cameraFovY=55*Math.PI/180,this._frustumBoundingSphereCenter=n(),this._frustumBoundingSphereRadius=0,this._frustum=new be(t),this._renderSR=t.spatialReference;const r=ve(this._renderSR);this._renderSREllipsoidRadius=ge(r).radius}setup(t){this._aboveGround=t.aboveGround,this._frustum.update(t),E(this._cameraForward,t.viewForward),Lt(this._cameraEye,t.eye),this._cameraFovY=t.fovY,this._updateFrustumBoundingSphere()}done(){this._cache.clear()}compute(t){if(this._cache.has(t.id))return this._cache.get(t.id);const e=this._isVisibleInFrustum(t);return this._cache.set(t.id,e),e}_isVisibleInFrustum(t){return this._renderCoordsHelper.viewingMode===2?this._isTileVisibleInFrustumLocal(t):this._isTileVisibleInFrustumGlobal(t)}_updateFrustumBoundingSphere(){const t=this._frustum,e=t.origin,r=Ie;E(r,t.direction);const o=t.points,l=Pe;N(l,o[4],e);const s=.5*T(l,l)/T(r,l),a=this._frustumBoundingSphereCenter;at(a,e,r,s);const u=1+s;this._frustumBoundingSphereRadius=u}_isTileVisibleInFrustumLocal(t){const e=t.spatialReference,r=t.extent,o=this._renderSR;if(!r)return!0;if(S[0]=r[0],S[1]=r[1],S[2]=0,S[3]=r[2],S[4]=r[3],S[5]=0,!Se(S,e,0,S,o,0))return!1;_(C[0],S[0],S[1],0),_(C[1],S[3],S[1],0),_(C[2],S[3],S[4],0),_(C[3],S[0],S[4],0),_(dt,.5*(S[0]+S[3]),.5*(S[1]+S[4]),.5*(S[2]+S[5]));const l=jt,s=.5*H(C[0],C[2]),a=this._frustum,u=this._frustumBoundingSphereRadius,m=this._frustumBoundingSphereCenter,d=Be;N(d,m,dt);const p=T(l,d),M=Ae;if(at(M,dt,l,p),H(M,m)>s+u)return!1;const h=this._cameraForward,L=T(h,jt),G=this._cameraFovY,f=this._cameraEye;if(Math.abs(L)<Math.abs(Math.cos(.5*G))){let c=!0;const F=_(mr,h[0],h[1],0),x=T(f,F);for(let $=0;$<4;++$){const U=C[$];if(T(U,F)-x>0){c=!1;break}}if(c)return!1}{const c=C[0],F=C[2];if(c[0]<=f[0]&&f[0]<=F[0]&&c[1]<=f[1]&&f[1]<=F[1])return!0}const g=Ge,k=this.opaqueGround&&this._aboveGround,Z=this.opaqueGround&&!this._aboveGround,q=Math.min(Z?ut:1/0,p+u),j=Math.max(k?-ut:-1/0,p-u);for(let c=0;c<4;++c)at(g[c],C[c],l,q),at(g[c+4],C[c],l,j);if(Dt(a.planes,g,8))return!1;if(Mt(a.planes,g,8))return!0;for(let c=0;c<4;++c){const F=g[c],x=g[c+4];if(xt(a.planes,F,x))return!0;const $=g[(c+1)%4];if(xt(a.planes,F,$))return!0;const U=g[4+(c+1)%4];if(xt(a.planes,x,U))return!0}if(Y[0][3]=+C[0][0],Y[1][3]=-C[2][0],Y[2][3]=+C[0][1],Y[3][3]=-C[2][1],Y[4][3]=+j,Y[5][3]=-q,Mt(Y,a.points)||Mt(Y,a.points))return!0;for(let c=0;c<4;++c){const F=f,x=a.points[c+4];if(zt(Y,F,x))return!0;const $=a.points[4+(c+1)%4];if(zt(Y,x,$))return!0}return!1}_isTileVisibleInFrustumGlobal(t){if(t.level<gt)return!0;const e=t.spatialReference,r=t.extent;if(!r||!e)return!0;const o=this.opaqueGround&&this._aboveGround,l=this.opaqueGround&&!this._aboveGround,s=C,a=.5*(r[0]+r[2]);if(_(s[0],r[0],r[1],0),_(s[1],r[2],r[1],0),_(s[2],r[2],r[3],0),_(s[3],r[0],r[3],0),_(s[4],a,r[1],0),_(s[5],a,r[3],0),!Re(s,e,0,s,this._renderSR,0,6))return!1;const u=s[0][2]>0,m=s[3][2]<0,d=u||m,p=this._renderSREllipsoidRadius;if(d){const w=Ce;K(w,_t,s[0]);const b=qe;if(K(b,_t,s[1]),u){const y=Ht,v=s[4],R=Ut;K(R,v,_t),K(y,R,v);const I=s[0];tt(I,w,y),lt(I,p);const D=s[1];tt(D,b,y),lt(D,p)}else if(m){const y=Ht,v=s[5],R=Ut;K(R,v,_t),K(y,v,R);const I=s[3];tt(I,y,w),lt(I,p);const D=s[2];tt(D,y,b),lt(D,p)}}const M=dt,h=N(He,s[3],s[0]);E(h,h);const L=St(Ue,s[0],s[3]);X(L,L,.5);const G=-T(L,h),f=St(Ve,s[0],s[1]);X(f,f,.5);const g=St(je,s[2],s[3]);X(g,g,.5);const k=N(ze,g,f);E(k,k);const Z=-(G+T(h,f))/T(h,k);at(M,f,k,Z),lt(M,p);const q=this._frustumBoundingSphereRadius,j=this._frustumBoundingSphereCenter,c=this._frustum,F=c.planes,x=Fe;E(x,M);const $=T(s[0],x)/vt(s[0]),U=c.origin,J=c.points;let Q=!1;if(o){{Q=!0;const b=E(Vt,U);for(let y=0;y<4;++y){const v=J[4+y],R=N(n(),v,U);E(R,R);const I=tt(n(),b,R);E(I,I);const D=tt(n(),R,I);if(E(D,D),T(U,D)>p){Q=!1;break}}}if(Q&&T(U,x)<p*$-ut)return!1;const w=E(Vt,c.origin);if(T(w,x)<0)return!1;{const b=E(lr,c.direction);if(T(b,x)>ur)return!1}}const pt=Math.sqrt(1-$*$);if(pt>.9)return!0;let et=!1;const rt=T(x,j),it=vt(j);if(it<=q&&!F.some(w=>mt(w,wt)>0)){if(!o)return!0;et=!0}const A=rt/it;if(!et&&rt<=0&&-rt>q)return!1;const W=q/it;if(Math.sqrt(1-A*A)*Math.sqrt(1-W*W)-W*A>pt)return!1;if(!Q&&(s.some(w=>c.intersectsPoint(w))||c.intersectsPoint(M)))return!0;const st=ke;N(st,j,wt);const ot=T(st,x),Gt=Oe;X(Gt,x,ot);const re=H(Gt,j),Ct=e.isWGS84,yt=t.lij,qt=Ct&&yt[2]===2**yt[0]-1,Ft=Ct&&yt[2]===0,ie=Ft?rr:qt?tr:Ke,se=Ft?ir:qt?er:Ze;if(!et){const w=s,b=sr,y=Ye,v=Ne,R=wt;for(const I of ie){const D=w[I];if(Wt(y,w[(I+1)%4],D),Wt(v,R,D),K(b,v,y),Le(b,J,1))return!1}}let V=null;if(!o&&ot<1.01*q){const w=2.5*q;if(re>$*w+q)return!1;const b=De,y=w/$;for(let v=0;v<4;++v)X(b[v],s[v],y/p);_(b[4],0,0,0),V=b}else{const w=(l?p+ut:ot+q)/$,b=o?p-ut:(ot-q)/$,y=We;for(let v=0;v<4;++v){const R=s[v];X(y[v],R,b/p),X(y[v+4],R,w/p)}V=y}if(Dt(F,V,V.length))return!1;const oe=c.lines,z=Xe,ct=Je;for(const w of oe){E(ct,w.direction);for(const b of se){const y=V[b];if(E(z,y),Rt(ct,z,V,J))return!1;const v=(b+1)%4;if(o){const R=V[v];if(N(z,R,y),E(z,z),Rt(ct,z,V,J))return!1}if(l){const R=V[4+b],I=V[4+v];if(N(z,I,R),E(z,z),Rt(ct,z,V,J))return!1}}}return!0}};function K(i,t,e){return tt(i,t,e),E(i,i),i}function Wt(i,t,e){return N(i,t,e),E(i,i),i}function lt(i,t){return X(i,i,t/vt(i)),i}const Zt=[0,1,2,3,5];function Ee(i,t,e){for(let r=0;r<e;++r)if(mt(i,t[r])<=0)return!1;return!0}function Dt(i,t,e){for(const r of Zt)if(Ee(i[r],t,e))return!0;return!1}function Mt(i,t,e=t.length){for(let r=0;r<e;++r){const o=t[r];let l=!0;for(const s of i)if(mt(s,o)>0){l=!1;break}if(l)return!0}return!1}const gt=2,$e=4;function Le(i,t,e){for(const r of t)if(T(r,i)<e)return!1;return!0}const Ge=[n(),n(),n(),n(),n(),n(),n(),n()],S=[0,0,0,0,0,0],C=[n(),n(),n(),n(),n(),n()],dt=n(),Ht=n(),Ce=n(),qe=n(),Ut=n(),Fe=n(),Oe=n(),Ie=n(),Pe=n(),Ae=n(),Be=n(),wt=$t(0,0,0),ke=n(),We=[n(),n(),n(),n(),n(),n(),n(),n()],De=[n(),n(),n(),n(),n()],He=n(),Ue=n(),Ve=n(),je=n(),ze=n(),Ye=n(),Ne=n(),Xe=n(),Je=n(),Qe=n(),Ke=[0,1,2,3],Ze=[0,1,2,3],tr=[0,1,3],er=[0,1,3],rr=[1,2,3],ir=[1,2,3],sr=n();function or(i,t,e){let r=1/0,o=-1/0;for(const l of e){const s=T(t,l);r=Math.min(r,s),o=Math.max(o,s)}i[0]=r,i[1]=o}function nr(i,t,e,r){let o=1/0,l=-1/0;for(const s of r){const a=T(e,s);if(o=Math.min(o,a),l=Math.max(l,a),o<=t&&l>=i)return!1}return!0}const ar=[0,0];function Rt(i,t,e,r){const o=e.length,l=r.length;if(o===0||l===0)return!0;const s=Qe;K(s,i,t);const a=l<o,u=a?e:r,m=ar;return or(m,s,a?r:e),nr(m[0],m[1],s,u)}const ut=430,Vt=n(),lr=n(),ur=Math.cos(.25*Math.PI),jt=pe(0,0,1),mr=n();function xt(i,t,e){const r={t0:0,t1:1};for(const o of Zt)if(!te(i[o],t,e,r))return!1;return r.t0<r.t1}function zt(i,t,e){const r={t0:0,t1:1};for(const o of i)if(!te(o,t,e,r))return!1;return r.t0<r.t1}function te(i,t,e,r){let{t0:o,t1:l}=r;const s=mt(i,t),a=mt(i,e);if(s>=0&&a>=0)return!1;if(s<0&&a>=0){const u=-s/(a-s);if(u<o)return!1;u<l&&(l=u)}else if(s>=0&&a<0){const u=s/(s-a);if(u>l)return!1;u>o&&(o=u)}return r.t0=o,r.t1=l,!0}const Y=[nt(-1,0,0,1),nt(1,0,0,-1),nt(0,-1,0,1),nt(0,1,0,-1),nt(0,0,-1,1),nt(0,0,1,-1)],_t=$t(0,0,1);class Yt{constructor(t,e,r){this._renderCoordsHelper=t,this._tilingScheme=e,this._camera=new Me,this._surfaceElevation=0,this._focusOnMap=[0,0],this._visibility=new xe(t,r)}set opaqueGround(t){this._visibility.opaqueGround=t}setup(t,e,r){this._camera.copyFrom(t),this._surfaceElevation=r,this._focusOnMap[0]=e.x,this._focusOnMap[1]=e.y,this._visibility.setup(this._camera)}done(){this._visibility.done()}update(t){const{measures:e,extent:r,level:o}=t;r&&(e.visible=this._visibility.compute(t),e.distance=fe(r,this._focusOnMap),e.mergeable=!0,e.lodLevel=gt,e.splitPriority=Math.max(0,gt-o),e.visible&&(this._isGlobal?this._updateSplitAndLodGlobal(t):this._updateSplitAndLodLocal(t)))}_updateSplitAndLodGlobal(t){const e=t.level,r=this._renderCoordsHelper,{eye:o,fov:l}=this._camera,s=r.referenceEllipsoid.radius,a=vt(o)-s;if(2*Math.atan(s/a)<l&&a>0)return void(t.measures.lodLevel=Math.max(e,gt));const u=Nt,{extent:m}=t;if(!m)return;const{_surfaceElevation:d}=this;_(u[0],m[0],m[1],d),_(u[1],m[2],m[1],d),_(u[2],m[2],m[3],d),_(u[3],m[0],m[3],d);const p=_(Xt,.5*(m[0]+m[2]),.5*(m[1]+m[3]),d),M=this._tilingScheme.spatialReference;for(let f=0;f<4;++f)r.toRenderCoords(u[f],M,u[f]);r.toRenderCoords(p,M,p);const h=E(Et.direction,p),L=T(o,h),G=X(Jt,h,L);this._updateSplitAndLod(t,u,p,G)}_updateSplitAndLodLocal(t){const e=Nt,{extent:r}=t;if(!r)return;const{_surfaceElevation:o}=this;_(e[0],r[0],r[1],o),_(e[1],r[2],r[1],o),_(e[2],r[2],r[3],o),_(e[3],r[0],r[3],o);const l=this._tilingScheme.spatialReference;for(let p=0;p<4;++p)this._renderCoordsHelper.toRenderCoords(e[p],l,e[p]);const s=_(Xt,.5*(e[0][0]+e[2][0]),.5*(e[0][1]+e[2][1]),.25*(e[0][2]+e[1][2]+e[2][2]+e[3][2])),a=_(pr,s[0],s[1],0),{eye:u,far:m}=this._camera,d=_(Jt,a[0],a[1],u[2]);_(Et.origin,a[0],a[1],u[2]-2*m),Lt(Et.direction,ee),this._updateSplitAndLod(t,e,s,d)}_updateSplitAndLod(t,e,r,o){const l=Math.max(H(e[0],e[2]),H(e[1],e[3]),H(e[0],r)+H(r,e[2]),H(e[1],r)+H(r,e[3])),{eye:s,near:a,fov:u,viewForward:m,width:d,height:p,pixelRatio:M,frustum:h}=this._camera,L=T(s,m),G=T(r,m)-L,f=H(r,s);let g=G,k=G,Z=f,q=f;const j=(A,W)=>W<a?1:Math.sqrt(A*A-W*W)/W;let c=j(f,G);for(const A of e){const W=T(A,m)-L;g=Math.min(g,W),k=Math.max(k,W);const st=H(A,s);q=Math.max(q,st),Z=Math.min(Z,st);const ot=j(st,W);c=Math.min(c,ot)}if(k<a)return void(t.measures.lodLevel=0);const F=Math.cos(.5*u),x=H(s,o);c>F&&x>hr*l&&(k=Qt*q,g=Qt*Z);const $=.5*Math.sqrt(d*d+p*p)/M,U=2*Math.tan(.5*u),J=A=>Math.max(a,A)*cr/$*U,Q=t.level,pt=l*2**Q*Math.max(1,U),et=J(g),rt=Math.ceil(Math.log2(Math.max(1,pt/et)));if(t.measures.lodLevel=Math.max(rt,t.measures.lodLevel),t.measures.splitPriority+=t.measures.lodLevel-Q,Q<rt){const A=+ft(h,e[0])+ +ft(h,e[1])+ +ft(h,e[2])+ +ft(h,e[3]);t.measures.splitPriority+=A}const it=J(k)/et;it>2.5&&(t.measures.splitPriority+=it)}get _isGlobal(){return this._renderCoordsHelper.viewingMode===1}}const Nt=[n(),n(),n(),n()],Xt=n(),pr=n(),Jt=n(),ee=$t(0,0,1),Et=_e(ce,ee),cr=312,hr=.5,Qt=2,fr=60;let O=class extends ne{constructor(i){super(i),this.tiles=new he,this.tileSize=512,this._idToTile=new Map,this._dirty=Pt(!1),this._pendingTiles=Pt(null),this._newTiles=new ae,this._tests=!1,this._measurements=new Yt(i.renderCoordsHelper,i.terrain.tilingScheme,this._opaqueGround)}initialize(){this.addHandles([ht(()=>this.tileSize,()=>this._reset(),Ot),ht(()=>[this.pointsOfInterest.cameraOnSurface?.location,this.viewState?.contentCamera,this.pointsOfInterest.focus?.location,this.terrain?.baseOpacity??1],()=>this._setDirty(),Ot),ht(()=>this.tilingScheme,i=>{this._reset(),this._measurements=new Yt(this.renderCoordsHelper,i,this._opaqueGround)},It),ht(()=>this._opaqueGround,i=>this._measurements.opaqueGround=i,It)]),this._frameWorker=this.scheduler?.registerTask(bt.FEATURE_TILE_TREE,this)}destroy(){this._frameWorker=le(this._frameWorker),this._measurements=null,this._newTiles.prune()}get tilingScheme(){return this.terrain.tilingScheme?.clone()}set filterExtent(i){if(i!=null&&!i.spatialReference.equals(this.viewState.spatialReference))return void ue.getLogger(this).error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const t=this._get("filterExtent");if(t===i||t!=null&&i&&t.equals(i))return;const e=i!=null?i.clone():null;this._set("filterExtent",e),this._setDirty()}get _filterExtentRect(){if(this.filterExtent==null)return null;const i=de();return we(this.filterExtent,i,this.tilingScheme.spatialReference),i}get _rootTileIds(){const{tilingScheme:i}=this;return this._filterExtentRect&&i?i.rootTilesInExtent(this._filterExtentRect):[[0,0,0]]}set suspended(i){i!==this._get("suspended")&&(this._set("suspended",i),this._setDirty())}get updating(){return this._dirty.value||!!this._pendingTiles.value}get _opaqueGround(){return(this.terrain?.baseOpacity??1)===1}_setDirty(){this.suspended||(this._frameWorker?this._dirty.value=!0:this.runTask(kt))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(!1),this._dirty.value=!1}get readyToRun(){return this.updating}_reset(i=!0){this._newTiles.clear(),this._pendingTiles.value=null,i&&this._setDirty()}_getRootTiles(){const i=this.tilingScheme;return this._rootTileIds.map(t=>new Bt(t[0],t[1],t[2],i))}runTask(i){i=this._tests?kt:i,this._dirty.value=!1,this._pendingTiles.value||(this._startUpdate(i),this._frameWorker!=null&&(this._frameWorker.priority=bt.FEATURE_TILE_TREE_ACTIVE)),this._splitPendingTiles(i),this._pendingTiles.value||this._frameWorker==null||(this._frameWorker.priority=bt.FEATURE_TILE_TREE)}_startUpdate(i){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();const{_measurements:t,_filterExtentRect:e,_newTiles:r}=this;t.setup(this.viewState.contentCamera,this.pointsOfInterest.focus.location,this.pointsOfInterest.cameraOnSurface.location.z??0),this._pendingTiles.value=this._getRootTiles().filter(o=>{if(t.update(o),o.measures.visible&&(!e||!o.extent||At(o.extent,e))){if(o.measures.splitPriority>0)return!0;r.push(o)}return!1}).sort(Kt),this._newTiles.clear(),i.madeProgress()}_splitPendingTiles(i){const t=this._pendingTiles.value;if(!t)return;const{tilingScheme:e,_filterExtentRect:r,_newTiles:o,_measurements:l}=this;for(;t.length>0&&this._tileBudgetRatio<=2;){const s=t.pop();if(i.madeProgress(),s.measures.splitPriority>0){e.ensureMaxLod(s.level+1);const a=s.createChildren();for(const u of a)l.update(u),!u.measures.visible||r&&u.extent&&!At(u.extent,r)||(u.measures.splitPriority>0?t.push(u):o.push(u));t.sort(Kt),this._mergeNewTiles(2),this._mergeNewTiles(2,!0)}else o.push(s);if(i.done)return}o.pushArray(t),this._pendingTiles.value=null,this._updateTiles(),o.clear(),l.done()}get _tileBudgetRatio(){return(this._newTiles.length+(this._pendingTiles.value?.length??0))/fr}_mergeNewTiles(i,t=!1){if(this._tileBudgetRatio<=i)return;const{_newTiles:e,_measurements:r}=this;e.sort((s,a)=>a.measures.distance-s.measures.distance);const o=new Map(e.map(s=>[s.id,s])),l=e.length;for(const s of o.values()){const{lij:a,measures:u}=s;if(!u.mergeable||a[1]%2!=0||a[2]%2!=0||a[0]<=1||s.lodLevelDelta>=$e)continue;const m=u.lodLevel;let d=m,p=!0;const M=o.get(Tt(a[0],a[1]+1,a[2]));let h=Math.abs((M?.measures.lodLevel??0)-m),L=h===0||t&&M?.measures.mergeable&&h<=1;if(!M||!L)continue;d+=M.measures.lodLevel,p&&=h===0;const G=o.get(Tt(a[0],a[1],a[2]+1));if(h=Math.abs((G?.measures.lodLevel??0)-m),L=h===0||t&&G?.measures.mergeable&&h<=1,!G||!L)continue;d+=G.measures.lodLevel,p&&=h===0;const f=o.get(Tt(a[0],a[1]+1,a[2]+1));if(h=Math.abs((f?.measures.lodLevel??0)-m),L=h===0||t&&f?.measures.mergeable&&h<=1,!f||!L)continue;d+=f.measures.lodLevel,p&&=h===0,e.removeUnordered(s),e.removeUnordered(M),e.removeUnordered(G),e.removeUnordered(f),o.delete(s.id),o.delete(M.id),o.delete(G.id),o.delete(f.id);const g=new Bt(a[0]-1,a[1]/2,a[2]/2,this.tilingScheme);if(r.update(g),g.measures.visible=!0,g.measures.lodLevel=d/4,g.measures.mergeable=p,e.push(g),o.set(g.id,g),this._tileBudgetRatio<=i)return}e.length<l&&this._mergeNewTiles(i,t)}_updateTiles(){this._mergeNewTiles(1),this._mergeNewTiles(1,!0);for(const r of this.tiles.items)r.used=!1;let i=!1;const t=this._newTiles.filter(r=>{const o=this._idToTile.get(r.id);return o?(i||=o.measures.lodLevel!==r.measures.lodLevel,o.measures={...r.measures},o.used=!0):this._idToTile.set(r.id,r),!o}),e=this.tiles.items.filter(r=>!r.used&&(this._idToTile.delete(r.id),!0));this.tiles.removeMany(e),this.tiles.addMany(t),this._sortTiles(),!i||e.length||t.length||this.tiles.emit("change")}_sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort((i,t)=>i.measures.distance-t.measures.distance),this.tiles.forEach((i,t)=>i.loadPriority=t)}};function Kt(i,t){return i.lodLevelDelta-t.lodLevelDelta||i.measures.splitPriority-t.measures.splitPriority||t.measures.distance-i.measures.distance}P([B({constructOnly:!0})],O.prototype,"scheduler",void 0),P([B({constructOnly:!0})],O.prototype,"renderCoordsHelper",void 0),P([B({constructOnly:!0})],O.prototype,"pointsOfInterest",void 0),P([B({constructOnly:!0})],O.prototype,"viewState",void 0),P([B({constructOnly:!0})],O.prototype,"terrain",void 0),P([B()],O.prototype,"tiles",void 0),P([B()],O.prototype,"tileSize",void 0),P([B({readOnly:!0})],O.prototype,"tilingScheme",null),P([B()],O.prototype,"filterExtent",null),P([B({readOnly:!0})],O.prototype,"_filterExtentRect",null),P([B({readOnly:!0})],O.prototype,"_rootTileIds",null),P([B({value:!1})],O.prototype,"suspended",null),P([B({readOnly:!0})],O.prototype,"updating",null),O=P([me("esri.views.3d.layers.support.FeatureTileTree3D")],O);export{O as FeatureTileTree3D};
