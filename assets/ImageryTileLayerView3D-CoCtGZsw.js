import{_ as h,m as d,a as L,bb as g,s as U}from"./jsonMap-Bs3hmeCU.js";import{l as S,U as v,j as W}from"./reactiveUtils-SO2Ko3sy.js";import{v as J,u as D,I as Z}from"./rasterProjectionHelper-LFVfFknq.js";import{l as Y}from"./LayerView3D-CCv_nmv5.js";import{p as Q}from"./TiledLayerView3D-B9vBKj7k.js";import{l as K}from"./throttle-D_a5zHdu.js";import{u as X}from"./aaBoundingRect-DfeeUq5j.js";import{y as tt}from"./dataUtils-27saOfMQ.js";import{r as et,c as rt}from"./FlowSubView3D-BNBCQXs4.js";import{h as b,c as it}from"./loadUtils-CUhSQ7p8.js";import{am as st,an as at,ao as ot}from"./ShadowCastClear.glsl-BGPoo-07.js";import{l as C}from"./vec2f64-rIxtbMRN.js";import{E as j,N as F}from"./enums-B4pqBiXb.js";import{r as G,A as P}from"./Texture-CAvBvljT.js";import{_ as lt}from"./Graphic-CkB18CDi.js";import{V as nt,i as w,a as mt}from"./rasterFieldUtils-0bNK-dHZ.js";import{i as ut}from"./timeSupport-DhNsaFLS.js";import{t as pt}from"./datasetUtils-DdDUWBI2.js";import{n as ht}from"./popupUtils-CEImAaCE.js";import{d as dt}from"./LayerView-B4B44Ajx.js";import{i as ct}from"./RefreshableLayerView-BZ0W4dR0.js";import{t as ft}from"./capabilities-Bi6C4OG6.js";import"./index-CB_zX-aI.js";import"./Point-62ir3Nzl.js";import"./reader-DcGs6kKN.js";import"./Extent-Cs-ESnE1.js";import"./Polygon-BbQMC1ht.js";import"./mathUtils-PIGhLnI9.js";import"./projectionUtils-ClsoIho7.js";import"./SimpleObservable-CvFyr0NA.js";import"./collectionUtils-CB98pReO.js";import"./Polyline-CUSonZ4c.js";import"./layerViewUtils-BTa15X3o.js";import"./Color-CERqXxxY.js";import"./screenUtils-BitdhK1O.js";import"./vec4f64-DPb6J-GU.js";import"./signal-BX9ezF8a.js";import"./ElevationInfo-DqQyVbKu.js";import"./lengthUtils-Cm-zragw.js";import"./date-IqUzANpt.js";import"./unitConversionUtils-BSQ4LGUO.js";import"./SubView3D-BgWeOqxP.js";import"./UpdatingHandles-D2RI_3Hb.js";import"./WorkerHandle-IsvMxqHu.js";import"./workers-VgzaPqUK.js";import"./Queue-CYlrXMwB.js";import"./intl-BIQN36K8.js";import"./line-DzJxYxSt.js";import"./DoubleArray-DExKNiTh.js";import"./mat4f64-q_b6UJoq.js";import"./BufferView-CdBDKeBv.js";import"./vec32-zHQcyKRA.js";import"./vec42-fTNpW1Xv.js";import"./Indices-D0_UQPPr.js";import"./orientedBoundingBox-CbUQAgG7.js";import"./quat-CCdR5JrD.js";import"./quatf64-CCm9z-pX.js";import"./spatialReferenceEllipsoidUtils-BGTSZp-L.js";import"./computeTranslationToOriginAndRotation-CTVG2hGD.js";import"./mat4-Bjnccznk.js";import"./plane-CAH7O3r1.js";import"./vector-knXISDaK.js";import"./elevationInfoUtils-OU8rgnDX.js";import"./memoryEstimations-Bd726a_p.js";import"./Scheduler-CNrsbccs.js";import"./FeatureTileDescriptor-n8K3eVrw.js";import"./Cyclical-BLSxUpe7.js";import"./jsonUtils-alsySR4T.js";import"./typeUtils-BR_JAZOz.js";import"./modeUtils-BF30GgRz.js";import"./uuid-Oe6SV2kF.js";import"./sanitizerUtils-BT_8V5US.js";import"./PooledRBush-Dco5QkUp.js";import"./quickselect-QQC62dOK.js";import"./GraphicsCollection-mGxi3VN1.js";import"./HeightModelInfo-CNRqlD7K.js";import"./projectPointToVector-B1tbWJiK.js";import"./RealisticTree.glsl-DAhEIR1w.js";import"./Emissions.glsl-B8XKMjLy.js";import"./InterleavedLayout-KZk0acs8.js";import"./types-BKo2foNY.js";import"./VertexElementDescriptor-BlxU8vCE.js";import"./aaBoundingBox-DO0Hqciy.js";import"./meshVertexSpaceUtils-BZiL5Bbc.js";import"./MeshLocalVertexSpace-De2t7DNQ.js";import"./projectVectorToVector-CDqzCeaL.js";import"./vec3f32-WCVSSNPR.js";import"./sphere-DGD4QNOm.js";import"./HUDIntersectorResult-Ds4yeNc-.js";import"./Intersector-BFu7YAUe.js";import"./frustum-Cq95H2HO.js";import"./scaleUtils-m8EJvm5m.js";import"./layerUtils-4EQ207Ij.js";import"./Layer-BLV7fz0K.js";import"./TilemapCache-DrtAz5a3.js";import"./LRUCache-fy84PBMi.js";import"./TileKey-zev9cGPe.js";import"./tagSymbols-BPcGfZon.js";import"./asyncUtils-w6KfWU41.js";import"./Map-DoBsBAGU.js";import"./Basemap-BI8rdNrf.js";import"./loadAll-CleWBL8j.js";import"./PortalItem-QIiqvhel.js";import"./writeUtils-D0J7VXri.js";import"./CollectionFlattener-C1ewYzfL.js";import"./opacityUtils-DuFH0EC9.js";import"./persistable-AW3PLevT.js";import"./MD5-MtSiOt06.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw.js";import"./resourceExtension-3aprB2zB.js";import"./PolygonCollection-BQYUC051.js";import"./mat4f32-Djp3mnm5.js";import"./TablesMixin-MGFFfhKn.js";import"./timeZoneUtils-BSc7-7qA.js";import"./ReactiveMap-B0by2bYu.js";import"./Query-98igen-k.js";import"./Field-Cm_ZejYW.js";import"./fieldType-DVUzXtk_.js";import"./normalizeUtils-BTK6arYa.js";import"./normalizeUtilsCommon-BRJdiLvx.js";import"./utils-uBZTDKaj.js";import"./utils-tSEVTzcz.js";import"./ElevationQuery-C16QuML_.js";import"./TileInfo-fM6eYiPH.js";import"./ExtrudeSymbol3DLayer-DSc1ou2x.js";import"./constants-D67WmGms.js";import"./floatRGBA-D95YiFWR.js";import"./labelUtils-BtizwBfq.js";import"./ArcadeExpression-BKKJxDUn.js";import"./TimeOnly-DbBUn0Ig.js";import"./enum-BzLwmiID.js";import"./UnknownTimeZone-B697BDFv.js";import"./FieldsIndex-DoTtx8Ak.js";import"./TileKey-C44YQC4_.js";import"./typeUtils-D0MaDvT3.js";import"./lineMarkers-CDwLe3J6.js";import"./PolygonSymbol3D-Dla3O-pf.js";import"./Font-BYMGzku7.js";import"./SimpleFillSymbol-CDawtd9z.js";import"./SimpleMarkerSymbol-BGAFRS9_.js";import"./PictureMarkerSymbol-CjQJkY_m.js";import"./TextSymbol-Ck-WHI2u.js";import"./vec2f32-CaVKkSa6.js";import"./dehydratedFeatures-BBoTEZJ8.js";import"./quantizationUtils-BSWXSK29.js";import"./featureConversionUtils-DlTGrdYn.js";import"./OptimizedFeature-CwRGZPwv.js";import"./OptimizedFeatureSet-BR8EEvDc.js";import"./createFeatureId-CVwTD0fV.js";import"./Octree-vaE3elxD.js";import"./intersectorUtilsConversions-Cv_V2i_M.js";import"./DefaultLoadingContext-BnNmzeR1.js";import"./wosrLoader-B8RYB0d4.js";import"./Version-BtYZEj58.js";import"./axisAngleDegrees-D1LL0HZb.js";import"./edgePreprocessing-CBVaMT5L.js";import"./config-Dg972SSE.js";import"./GeometryUtils-BUMmi0hw.js";import"./definitions-Dvg4hMIw.js";import"./colorUtils-CfxFVJbg.js";import"./vec3-B_phcnZY.js";import"./vec33-CWJeyzxV.js";import"./imageUtils-DRSdxeif.js";import"./videoUtils-Dwx3AEgj.js";import"./getPopupProvider-mckaq9Ri.js";import"./utils-DTE-xBiC.js";const _={type:"delete"},yt={type:"waiting"},gt={type:"on-worker",upsampled:!1},_t={type:"on-worker",upsampled:!0};let I=class extends et{constructor(e){super(e),this._resetTileData=!0,this._throttledTriggerLoad=null,this._throttling=!1}initialize(){this.addHandles([this.surface.on("tile-data-changed",({tile:e,layerIndex:t,layerClass:r})=>{this.renderedTiles!=null&&(this.loadByTileTreesAllowed||this._tileIsUpsampled(e))&&t===this._layerIndex&&r===1&&this._updateFlowDataTile(e)}),S(()=>this.renderedTiles,e=>{const t=this.frameTask.scheduleGenerator(r=>this._updateFlowDataTiles(e,r));this.updatingHandles.addPromise(t)},v),S(()=>this._pixelSize,()=>{this.invalidateTileData(),this._resetTileData=!0},v)]),this._throttledTriggerLoad=K(()=>{super.triggerLoad(),this._throttling=!1},()=>this._throttling=!0,rt,this),this.addHandles(this._throttledTriggerLoad)}async*_updateFlowDataTiles(e,t){const r=z();for(const i of e??[]){const a=this._flowDataTiles?.get(b(i)),s=a==null||a.type==="delete"||a.type==="waiting"?this._getLoadedState(i):a;s!=null&&r.set(b(i),s),t.madeProgress(),t.done&&(t=yield)}this._flowDataTiles=r,this._resetTileData=!0,this.triggerLoad()}abort(){super.abort(),this._throttling=!1}get _layerIndex(){return this.surface.getLayerIndexByUID(1,this.layerView.uid)}get loadByTileTreesAllowed(){return super.loadByTileTreesAllowed||!this._allTilesLoaded}get _pixelSize(){return this.surface.tilingScheme.pixelSize}doRefresh(){this.invalidateTileData(),super.doRefresh()}triggerLoad(){const{_throttledTriggerLoad:e}=this;this._allTilesLoaded?(e.hasPendingUpdates()||e(),e.forceUpdate()):e()}async fetchDataAndGenerateStreamlines(e,t){const{_flowDataTiles:r,needsMagnitude:i,workerHandle:a}=this,s=this.getSimulationSettings(e);if(s==null||a==null||r==null)return;const n=this._resetTileData;this._resetTileData=!1;const u=z();r.forEach((o,l)=>{o.type==="delete"?(u.set(l,_),r.delete(l)):(n||o.type!=="on-worker"&&o.type!=="waiting")&&(u.set(l,o),r.set(l,o.type!=="waiting"&&o.upsampled?_t:gt))});const m={simulationSettings:s,flowExtentInfo:e.flowExtentInfo,flowDataTiles:u,reset:n,needsMagnitude:i,startPositions:this.startPositions(e)},{streamlines:p}=await a.generateTiledStreamlines(m,t);return p}getUpdating(){return super.getUpdating()||this._throttling}_getLoadedState(e){const{_layerIndex:t}=this,r=e.surface==null;if(t==null||r)return _;const i=e.getLayerInfo(t,1);if(i==null)return _;if(!e.visible&&i.requestAbort==null)return i.requestAbort=new AbortController,this.surface.requestTileData(e,t,1,i.requestAbort),_;const a=this._getRasterTile(i,e,t);return a==null?this._upsampleFlowData(t,i.upsampleInfo,e.lij,e.extent):{type:"loaded",data:this._createFlowDataTile(a,e.lij,e.extent,this._pixelSize),upsampled:!1}}_upsampleFlowData(e,t,r,i){if(t==null)return _;const a=t.tile;if(a==null)return _;const s=a.getLayerInfo(e,1);if(s==null)return _;const n=this._getRasterTile(s,a,e);if(n==null)return _;const{scale:u,offset:m}=t,p=Math.max(Math.floor(this._pixelSize*u),1),o=n.source,l=Math.floor(m[0]*o.width),y=Math.floor((1-m[1]-u)*o.height);return{type:"loaded",data:this._createFlowDataTile(n,r,i,p,l,y),upsampled:!0}}_getRasterTile(e,t,r){const{data:i}=e;return!e.dataMissing&&t.hasLayerData(r,1)&&st(i)?i:null}_createFlowDataTile(e,t,r,i,a,s){const n=tt(this.layer.serviceRasterInfo.dataType,e.source,i,i,a,s),u=n.mask.slice();return new it(n.data,u,n.width,n.height,t,X(r))}_updateFlowDataTile(e){const{renderedTiles:t,_layerIndex:r}=this;if(t==null||r==null)return;if(t.has(e)){const a=this._getLoadedState(e);return void(this._setTileData(e,a)&&this.triggerLoad())}let i=this._setTileData(e,_);for(const a of t.values()){const s=a.getLayerInfo(r,1);if(s==null||this._getRasterTile(s,a,r)!=null||s.upsampleInfo?.tile!==e)continue;const u=this._getLoadedState(a),m=this._setTileData(a,u);i||=m}i&&this.triggerLoad()}_setTileData(e,t){const{_flowDataTiles:r}=this;if(r==null)return!1;const i=b(e);return(r.get(i)!=null||t.type!=="delete")&&(r.set(i,t),!0)}get _allTilesLoaded(){let e=0;for(const t of this._flowDataTiles?.values()??[])t.type!=="delete"&&t.type!=="waiting"&&e++;return e===this.renderedTiles?.size}invalidateTileData(){const{_flowDataTiles:e}=this;e?.forEach((t,r)=>{e.set(r,yt)})}_tileIsUpsampled(e){const t=this._flowDataTiles?.get(b(e));return t!=null&&(t.type==="loaded"||t.type==="on-worker")&&t.upsampled}get usedMemory(){const e=9*this._pixelSize**2,t=(this._flowDataTiles?.size??0)*e;return super.usedMemory+t}get test(){return{...super.test,loadedTiles:this._flowDataTiles??z()}}};function z(){return new Map}h([d()],I.prototype,"_throttling",void 0),I=h([L("esri.views.3d.support.flow.FlowSubViewTiles3D")],I);function Tt(e,t,r="nearest",i=!1){const a=!(i&&t.pixelType==="u8"),s=a?F.FLOAT:F.UNSIGNED_BYTE,n=t.pixels==null||t.pixels.length===0?null:a?t.getAsRGBAFloat():t.getAsRGBA(),u=e.capabilities.textureFloatLinear,m=new G(t.width,t.height);return m.internalFormat=a?j.RGBA32F:6408,m.samplingMode=!u||r!=="bilinear"&&r!=="cubic"?9728:9729,m.dataType=s,m.wrapMode=33071,new P(e,m,n)}function wt(e,t){const{spacing:r,offsets:i,coefficients:a,size:[s,n]}=t,u=r[0]>1,m=new G(u?4*s:s,n);m.internalFormat=j.RGBA32F,m.dataType=F.FLOAT,m.samplingMode=9728,m.wrapMode=33071;const p=new Float32Array(u?s*n*16:2*i.length);if(u&&a!=null)for(let o=0,l=0;o<a.length;o++)p[l++]=a[o],o%3==2&&(p[l++]=1);else for(let o=0;o<n;o++)for(let l=0;l<s;l++){const y=4*(o*s+l),c=2*(l*n+o);p[y]=i[c],p[y+1]=i[c+1],p[y+3]=i[c]===-1?0:1}return new P(e,m,p)}function M(e,t){const r=new G(t.length/4,1);return r.internalFormat=6408,r.samplingMode=9728,r.wrapMode=33071,new P(e,r,t)}function xt(e,t,r,i=1,a=!0){return{u_flipY:a,u_applyTransform:!!e,u_opacity:i,u_transformSpacing:e?e.spacing:C,u_transformGridSize:e?e.size:C,u_targetImageSize:t,u_srcImageSize:r}}function bt(e,t){return{u_colormapOffset:t||0,u_colormapMaxIndex:e?e.length/4-1:0}}function It(e){return{u_bandCount:e.bandCount,u_minOutput:e.minOutput,u_maxOutput:e.maxOutput,u_minCutOff:e.minCutOff,u_maxCutOff:e.maxCutOff,u_factor:e.factor,u_useGamma:e.useGamma,u_gamma:e.gamma,u_gammaCorrection:e.gammaCorrection}}function St(e){return{u_hillshadeType:e.hillshadeType,u_sinZcosAs:e.sinZcosAs,u_sinZsinAs:e.sinZsinAs,u_cosZs:e.cosZs,u_weights:e.weights,u_factor:e.factor,u_minValue:e.minValue,u_maxValue:e.maxValue}}const $={bandCount:3,minOutput:0,maxOutput:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};class vt{constructor(t,r,i=null,a=null){this.lij=t,this.type="raster-tile",this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.opacity=1,this.source=r,this.width=i||r.width,this.height=a||r.height}get source(){return this._source}set source(t){this._source=t,this._rasterTexture=g(this._rasterTexture),this._memoryUsed=null}get symbolizerParameters(){return this.isRendereredSource?{...$,maxCutOff:[1,1,1],factor:[1,1,1]}:this._symbolizerParameters||$}set symbolizerParameters(t){this._symbolizerParameters=t}get bandIds(){return this._bandIds}set bandIds(t){t!=null&&t.length>0?this._bandIds&&t.every((r,i)=>!!this._bandIds?.[i]&&r===this._bandIds[i])||(this._bandIds=t,this._dirty=!0):this._bandIds=null}get interpolation(){return this._interpolation||"nearest"}set interpolation(t){if(this._interpolation=t,this._rasterTexture!=null){const r=this._getRasterTextureInterpolation(t);this._rasterTexture.setSamplingMode(r==="bilinear"?9729:9728)}}get transformGrid(){return this._transformGrid}set transformGrid(t){this._transformGrid=t,this._transformGridTexture=g(this._transformGridTexture),this._memoryUsed=null}bind(t){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&((this._rasterTexture==null||this._dirty)&&this._updateRasterTexture(t,this.bandIds),this._rasterTexture!=null&&(this._updateColormapTexture(t),this.transformGrid&&this._transformGridTexture==null&&(this._transformGridTexture=wt(t,this.transformGrid))),!0)}getUniforms(t){const{symbolizerParameters:r,transformGrid:i,width:a,height:s,opacity:n}=this,u=xt(i,[a,s],[this.source.width,this.source.height],n),m=bt(r.colormap,r.colormapOffset),p=this.symbolizerParameters.type==="stretch"?It(this.symbolizerParameters):null,o=this.symbolizerParameters.type==="hillshade"?St(this.symbolizerParameters):null,l=t.emptyTexture;return new at(u,m,p||o,this._rasterTexture??l,this._transformGridTexture??l,this._colormapTexture??l)}get isBilinearWithStretchColorRamp(){const{symbolizerParameters:t}=this;return this.interpolation==="bilinear"&&t.colormap!=null&&t.type==="stretch"}get memoryUsage(){if(this._memoryUsed==null){const t=[this._rasterTexture,this._transformGridTexture,this._colormapTexture];this._memoryUsed=t.map(r=>r!=null?r.descriptor.width*r.descriptor.height*4:0).reduce((r,i)=>r+i,0)}return this._memoryUsed}release(){return this._rasterTexture=g(this._rasterTexture),this._transformGridTexture=g(this._transformGridTexture),this._colormapTexture=g(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(t,r){const i=this.source?this.source.extractBands(r):null;if(!(i?.pixels&&i.pixels.length>0))return void(this._rasterTexture=g(this._rasterTexture));const a=r==null&&this.bandIds==null||r!=null&&this.bandIds!=null&&r.join("")===this.bandIds.join("");if(this._rasterTexture!=null&&a)return;this._rasterTexture=g(this._rasterTexture);const s=this._getRasterTextureInterpolation(this.interpolation);this._rasterTexture=Tt(t,i,s,this.isRendereredSource||this.hasStretchTypeNone())}hasStretchTypeNone(){return"stretchType"in this.symbolizerParameters&&this.symbolizerParameters.stretchType==="none"&&!this.symbolizerParameters.useGamma&&this.source.pixelType==="u8"}_getRasterTextureInterpolation(t){return this.symbolizerParameters.type==="lut"||t==="nearest"||t==="majority"||this.isBilinearWithStretchColorRamp?"nearest":"bilinear"}_updateColormapTexture(t){const r=this._colormap,i=this.symbolizerParameters.colormap;return i?r?i.length!==r.length||i.some((a,s)=>a!==r[s])?(this._colormapTexture=g(this._colormapTexture),this._colormapTexture=M(t,i),void(this._colormap=i)):void 0:(this._colormapTexture=M(t,i),void(this._colormap=i)):(this._colormapTexture=g(this._colormapTexture),void(this._colormap=null))}}const Rt=e=>{const t=e;let r=class extends t{constructor(...i){super(...i),this.layer=null,this.tileInfo=null}get fullExtent(){try{return this.layer.loaded?this._getFullExtent():null}catch{return null}}get timeExtent(){return ut(this.layer,this.view?.timeExtent,this._get("timeExtent"))}get hasTilingEffects(){const{renderer:i}=this.layer;return!!(i?.type==="raster-stretch"&&i.dynamicRangeAdjustment&&!(i.stretchType==="min-max"||i.stretchType==="standard-deviation"))}get datumTransformation(){try{return this.layer.loaded?J(this.layer.fullExtent,this.view.spatialReference,!0):null}catch{return null}}supportsSpatialReference(i){try{return!this.layer.loaded||!!D(this.layer.serviceRasterInfo,i)}catch{return!1}}async fetchPopupFeaturesAtLocation(i,a){const{layer:s}=this;if(!i)throw new U("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:s});const{popupEnabled:n}=s,u=ht(s,a);if(!n||u==null)return[];const m=[],{value:p,magdirValue:o,processedValue:l}=await s.identify(i,{timeExtent:this.timeExtent,signal:a?.signal});let y="";if(p?.length){y=s.type==="imagery-tile"&&s.hasStandardTime()&&p[0]!=null?p.map(R=>s.getStandardTimeValue(R)).join(", "):p.join(", ");const c={ObjectId:0};c[w.servicePixelValue]=s.type==="imagery-tile"&&pt(s.raster)?l?.join(", "):y,c[w.rawServicePixelValue]=y;const O=s.raster?.rasterInfo??s.serviceRasterInfo,A=O?.attributeTable;if(A!=null){const{fields:R,features:N}=A,V=R.find(({name:T})=>T.toLowerCase()==="value"),q=c[w.servicePixelValue],x=V?N.find(T=>String(T.attributes[V.name])===q):null;if(x)for(const T in x.attributes)x.attributes.hasOwnProperty(T)&&(c[mt+T]=x.attributes[T])}const E=O?.dataType;E!=="vector-magdir"&&E!=="vector-uv"||(c[w.magnitude]=o?.[0],c[w.direction]=o?.[1]);const{multidimensionalDefinition:k}=this.layer.normalizeRasterFetchOptions({timeExtent:this.timeExtent});nt(s.rasterFields,c,k);const{graphicOrigin:B}=s,H=new lt({geometry:this.fullExtent?.clone(),attributes:c,layer:s,origin:B,sourceLayer:s});m.push(H)}return m}async getSourceScale(){return await this.layer.load(),Z(this.layer.serviceRasterInfo,this.view.spatialReference)}_getFullExtent(){return D(this.layer.serviceRasterInfo,this.view.spatialReference)}};return h([d()],r.prototype,"fullExtent",null),h([d()],r.prototype,"layer",void 0),h([d({readOnly:!0})],r.prototype,"timeExtent",null),h([d()],r.prototype,"tileInfo",void 0),h([d({readOnly:!0})],r.prototype,"hasTilingEffects",null),h([d()],r.prototype,"datumTransformation",null),r=h([L("esri.views.layers.ImageryTileLayerView")],r),r};let f=class extends Rt(ct(Q(Y(dt)))){constructor(){super(...arguments),this.type="imagery-tile-3d",this._isAlignedMapTile=!0,this._flowSubView=null,this.ignoresMemoryFactor=!1,this.unloadedMemory=0}initialize(){this.layer.increaseRasterJobHandlerUsage(),this.fullExtent==null&&this.addResolvingPromise(Promise.reject(new U("layerview:spatial-reference-incompatible","The layer extent cannot be projected to the view's spatial reference",{layer:this.layer})));const e=W(()=>this.view?.basemapTerrain?.tilingSchemeLocked).then(()=>{const t=this.view.basemapTerrain.tilingScheme,r=this.layer.tileInfo;this._isAlignedMapTile=["png","png24","png32","jpg","mixed"].includes(r.format)&&t.compatibleWith(r),this.tileInfo=this._isAlignedMapTile?r:t.toTileInfo(),this.addHandles([S(()=>this.layer.renderer,i=>{this._setSubView(i),this._updatingHandles.addPromise(this.doRefresh())},v),S(()=>[this.layer.interpolation,this.layer.bandIds,this.layer.multidimensionalDefinition,this.layer.multidimensionalSubset,this.layer.rasterFunction,this.timeExtent],()=>this._updatingHandles.addPromise(this.doRefresh()),v)])});this._setSubView(this.layer.renderer),this.addResolvingPromise(e)}destroy(){this.layer.decreaseRasterJobHandlerUsage(),this._flowSubView?.destroy()}_setSubView(e){if(this.layer.type==="wcs")return;const t=e?.type==="flow",r=this._flowSubView;t&&r!=null||(r?.destroy(),this._flowSubView=t?new I({layerView:this}):null)}get _blankTile(){const e=document.createElement("canvas"),t=e.getContext("2d"),[r,i]=this.tileInfo.size;return e.width=r,e.height=i,t.clearRect(0,0,r,i),t.getImageData(0,0,r,i)}get _hasFlow(){return this._flowSubView!=null}get imageFormatIsOpaque(){return this.layer.tileInfo.format==="jpg"}get hasMixedImageFormats(){return this.layer.tileInfo.format==="mixed"}get dataLevelRange(){const e=this.layer.tileInfo,t=this.tileInfo.lodAt(0)?.scale,r=e.lodAt(e.lods.length-1)?.scale;return this.levelRangeFromScaleRange(t,r)}get visibleAtCurrentScale(){return this._flowSubView?.visibleAtCurrentScale??this.tilesVisibleAtCurrentScale()}_getFullExtent(){return D(this.layer.serviceRasterInfo,this.view.basemapTerrain?.spatialReference??this.view.spatialReference)}async fetchTile(e,t){const r=this.tileInfo,i=this._canSymbolizeInWebGL(),a={tileInfo:r,requestRawData:i&&!this._hasFlow,signal:t.signal,timeExtent:this.timeExtent,requestAsImageElement:this._isAlignedMapTile,requestProjectedLocalDirections:this._hasFlow,noClip:!1},{layer:s}=this,[n,u,m]=e,p=await s.fetchTile(n,u,m,a);if(p instanceof HTMLImageElement)return p;let o=p?.pixelBlock;if(o==null)return this._blankTile;if(!i&&!this._hasFlow&&(o=await s.applyRenderer(p),o==null))return this._blankTile;const l=new vt([n,u,m],o,r.size[0],r.size[1]);return i?(l.symbolizerRenderer=s.symbolizer.rendererJSON,l.symbolizerParameters=s.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(n)),l.transformGrid=p.transformGrid,l.bandIds=s.bandIds):(l.isRendereredSource=!0,l.bandIds=null),l.interpolation=s.interpolation,l}_getSymbolizerOptions(e){const t=this.tileInfo.lodAt(e).resolution;return{pixelBlock:null,isGCS:this.view.basemapTerrain?.spatialReference!=null?this.view.basemapTerrain.spatialReference.isGeographic:this.view.spatialReference.isGeographic,resolution:{x:t,y:t},bandIds:this.layer.bandIds}}ensureSymbolizerParameters(e){this._canSymbolizeInWebGL()&&JSON.stringify(e.symbolizerRenderer)!==JSON.stringify(this.layer.symbolizer.rendererJSON)&&(e.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(e.lij[0])))}createFetchPopupFeaturesQueryGeometry(e,t){return ot(e,t,this.view)}async doRefresh(){this.suspended||(this._flowSubView?.doRefresh(),this.emit("data-changed"))}isUpdating(){return this._flowSubView?.updating??!1}_canSymbolizeInWebGL(){const e=ft(),{symbolizer:t}=this.layer,r=t.lookup.colormapLut?.indexedColormap,i=!!this.layer.rasterFunction?.hasClipFunction,a=r&&r.length>4*(e.maxTextureSize||4096);return t.canRenderInWebGL&&!a&&!i}get usedMemory(){return this._flowSubView?.usedMemory??0}get test(){}};h([d({readOnly:!0})],f.prototype,"_blankTile",null),h([d()],f.prototype,"_hasFlow",null),h([d({readOnly:!0})],f.prototype,"imageFormatIsOpaque",null),h([d({readOnly:!0})],f.prototype,"hasMixedImageFormats",null),h([d()],f.prototype,"_flowSubView",void 0),h([d({readOnly:!0})],f.prototype,"dataLevelRange",null),h([d({readOnly:!0})],f.prototype,"visibleAtCurrentScale",null),f=h([L("esri.views.3d.layers.ImageryTileLayerView3D")],f);const Gi=f;export{Gi as default};
