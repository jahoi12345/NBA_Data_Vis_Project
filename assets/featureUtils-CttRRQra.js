import{i as _,z as h,G as V}from"./jsonMap-Bs3hmeCU.js";import{N as W,b as A}from"./date-IqUzANpt.js";import{s as B,l as T,c as w}from"./intl-sjEXBsFq.js";import{c as J}from"./getPopupProvider-3D7bbDmC.js";import{q as k,k as K,x as X,a as R}from"./lengthUtils-go2kD43r.js";import{I as N,G as Y}from"./layerUtils-CVHRa_-F.js";import{x as U,U as ee}from"./utils-CvNxd5Ky.js";import{h as te}from"./timeZoneUtils-BSc7-7qA.js";import"./reactiveUtils-SO2Ko3sy.js";import"./Point-Byf20bUE.js";import"./reader-DcGs6kKN.js";import"./index-DqD_sEjA.js";import"./collectionUtils-oMUPqMMC.js";import"./Extent-KC9qx-Cg.js";import"./SimpleObservable-CvFyr0NA.js";import"./Color-CERqXxxY.js";import"./mathUtils-PIGhLnI9.js";import"./Layer-C7047eDe.js";import"./mat4f32-Djp3mnm5.js";import"./mat4-Dyb44KrD.js";import"./Polygon-BuPlovwL.js";import"./aaBoundingRect-C2DMsiYR.js";const re="esri.widgets.Feature.support.featureUtils",F=()=>_.getLogger(re),ne=/href=(""|'')/gi,ie=/(\{([^{\r\n]+)\})/g,ae=/'/g,j=/^\s*expression\//i,oe=/(\n)/gi,le=/[\u00A0-\u9999<>&]/gim,se=/href\s*=\s*(?:"([^"]+)"|'([^']+)')/gi,ue=/^(?:mailto:|tel:)/,M="relationships/",v=W("short-date-short-time");function tt(e){if(e!=null)return(e.sourceLayer||e.layer)??void 0}async function rt({type:e,value:t,event:r}){try{return typeof t=="function"?t(r):await t}catch(n){return void F().error("error",`An error occurred when calling the "${e}" function`,{error:n,graphic:r.graphic,value:t})}}function nt(e=""){if(e)return!ue.test(e.trim().toLowerCase())}function S(e){return!!e&&j.test(e)}function fe(e,t){if(!t||!S(t)||!e)return;const r=t.replace(j,"").toLowerCase();return e.find(({name:n})=>n.toLowerCase()===r)}function D({fieldInfo:e,graphic:t}){return!(!e?.fieldName||S(e.fieldName)||C(e.fieldName)||t?.isAggregate||t?.popupTemplate)}function it({expressionInfos:e,fieldInfo:t,graphic:r,isContentFieldInfos:n,layer:a}){if(!t?.fieldName)return null;const i=fe(e,t.fieldName);if(i)return i.title||null;if(N(a)&&D({fieldInfo:t,graphic:r})){const o=a.getFieldAlias(t.fieldName);return n?t.label||o||t.fieldName:o||t.fieldName}return t.label||t.fieldName}function de({fieldInfo:e,isContentFieldInfos:t,layer:r}){if(!e?.fieldName)return null;if(N(r)){const n=r.popupTemplate||r.fieldConfigurations?r.getFieldConfiguration(e.fieldName)?.fieldFormat:J(e,r.getField(e.fieldName));return t&&e.fieldFormat||n}return null}function ce(e,t){return`{${t.get(e.toLowerCase())?.fieldName||e}}`}function pe(e){return e.replaceAll(ne,"")}function G(e,t){const r=L(t,e);return r?r.name:e}function at(e,t){return e&&e.map(r=>G(r,t))}function L(e,t){return e&&typeof e.getField=="function"&&t?e.getField(t)??null:null}function z(e){return`${e}`.trim()}function ot({attributes:e,globalAttributes:t,layer:r,text:n,expressionAttributes:a,fieldInfoMap:i}){return n?ye({formattedAttributes:t,template:he(n,{...t,...a,...e},r),fieldInfoMap:i}):""}function ye({formattedAttributes:e,template:t,fieldInfoMap:r}){return z(pe(h(h(t,n=>ce(n,r)),e)))}function me(e,t,r=!1){const n=t[e];if(typeof n=="string"){const i=(r?encodeURIComponent(n):n).replaceAll(ae,"%27");t[e]=i}}function Ie(e,t=!1){const r={...e};return Object.keys(r).forEach(n=>me(n,r,t)),r}function be(e,t,r){const n=(t=z(t))&&!t.startsWith("{");return h(e,Ie(r,n||!1))}function ge(e,t){return e.replaceAll(ie,(r,n,a)=>{const i=L(t,a);return i?`{${i.name}}`:n})}function he(e,t,r){const n=ge(e,r);return n&&n.replaceAll(se,(a,i,o)=>be(a,i||o,t))}function Fe(e,t){const r=t?.fieldFormat?.type==="number"||t?.format&&t.format.dateFormat==null&&(t.format.places!=null||t.format.digitSeparator!=null);if(typeof e=="string"&&r){const n=Number(e);if(!isNaN(n))return n}return e}function Te(e){return e!=null&&typeof e=="object"&&"fieldsIndex"in e&&"geometryType"in e&&"getField"in e&&"load"in e&&"loaded"in e&&"objectIdField"in e&&"spatialReference"in e&&"type"in e&&(e.type==="feature"||e.type==="scene"||e.type==="subtype-group"||e.type==="subtype-sublayer"||e.type==="sublayer")&&"when"in e}function we(e){return e!=null&&typeof e=="object"&&"createQuery"in e&&"queryFeatureCount"in e&&"queryObjectIds"in e&&"queryRelatedFeatures"in e&&"queryRelatedFeaturesCount"in e&&"relationships"in e}function O(e){return Te(e)&&we(e)}function lt(e){return!(!(e&&typeof e=="object"&&"createQuery"in e&&"getField"in e&&"queryFeatureCount"in e&&"queryFeatures"in e&&"queryObjectIds"in e&&"capabilities"in e&&"fields"in e&&"fieldsIndex"in e&&"type"in e)||e.type!=="feature"&&e.type!=="subtype-group"&&e.type!=="subtype-sublayer"&&e.type!=="sublayer"||!("when"in e))&&(e.type==="subtype-sublayer"&&"parent"in e&&e.parent&&typeof e.parent=="object"?"globalIdField"in e.parent:"globalIdField"in e)}function st(e){return!!e&&typeof e=="object"&&"sourceLayer"in e&&O(e.sourceLayer)}function Ne(e,t){const{fieldInfos:r,fieldName:n,graphic:a,isContentFieldInfos:i,layer:o,preventPlacesFormatting:u,timeZone:s}=t,l=Ce(r,n),c=L(o,n),f=N(o)&&D({fieldInfo:l,graphic:a}),d=f?null:l?.format,p=f?de({fieldInfo:l,layer:o,isContentFieldInfos:i}):null,I=p?.type==="number";if(l&&!k(n)){const m=c?.type,b=p?.type==="date-time",q=d?.dateFormat;if(m==="date"||m==="date-only"||m==="time-only"||m==="timestamp-offset"||b||q)return U(e,{format:b?void 0:q,fieldFormat:b?p:void 0,fieldType:m,timeZoneOptions:{layerTimeZone:o&&"preferredTimeZone"in o?o.preferredTimeZone:null,viewTimeZone:s,datesInUnknownTimezone:!(!o||!("datesInUnknownTimezone"in o))&&!!o.datesInUnknownTimezone}})}if(typeof e=="string"&&k(n)&&d)return Le(e,d);if(typeof(e=Fe(e,{format:I?void 0:d,fieldFormat:I?p:void 0}))=="string"||e==null||d==null&&p==null)return Q(e);const x=I?B(p):d?T(d):void 0;return w(e,u?{...x,minimumFractionDigits:0,maximumFractionDigits:20}:x)}function Le(e,t){return e=e.trim(),/\d{2}-\d{2}/.test(e)?e:e.includes(",")?g(e,",",", ",t):e.includes(";")?g(e,";","; ",t):e.includes(" ")?g(e," "," ",t):w(Number(e),T(t))}function g(e,t,r,n){return e.trim().split(t).map(a=>w(Number(a),T(n))).join(r)}function Ce(e,t){if(e?.length&&t)return e.find(r=>r.fieldName?.toLowerCase()===t.toLowerCase())}function xe({fieldName:e,graphic:t,layer:r}){if(C(e)||!r||typeof r.getFeatureType!="function")return null;const{typeIdField:n}=r;if(!n||e!==n)return null;const a=r.getFeatureType(t);return a?a.name:null}function qe({fieldName:e,value:t,graphic:r,layer:n}){if(C(e)||!n||typeof n.getFieldDomain!="function")return null;const a=r&&n.getFieldDomain(e,{feature:r,excludeImpliedDomains:V("esri-widget-legacy-field-domain-calculation")});return a&&a.type==="coded-value"?a.getName(t):null}function ut(e,t,r,n){const{creatorField:a,creationDateField:i,editorField:o,editDateField:u}=e;if(!t)return;const s=te(n&&"preferredTimeZone"in n?n.preferredTimeZone:null,!(!n||!("datesInUnknownTimezone"in n))&&!!n.datesInUnknownTimezone,r,v,"date"),l={...v,...s},c=t[u];if(typeof c=="number"){const d=t[o];return{type:"edit",date:A(c,l),user:d}}const f=t[i];if(typeof f=="number"){const d=t[a];return{type:"create",date:A(f,l),user:d}}return null}function ft(e,t){const r=new Map;if(!e)return r;for(const n of e){if(!n.fieldName)continue;const a=G(n.fieldName,t);n.fieldName=a,r.set(a.toLowerCase(),n)}return r}function dt(e){const t=[];if(!e)return t;const{fieldInfos:r,content:n}=e;return r&&t.push(...r),n&&Array.isArray(n)&&n.forEach(a=>{if(a.type==="fields"){const i=a?.fieldInfos;i&&t.push(...i)}}),t}function ct(e){return e.replaceAll(le,t=>`&#${t.charCodeAt(0)};`)}function Q(e){return typeof e=="string"?e.replaceAll(oe,'<br class="esri-text-new-line" />'):e}function H(e){const{fieldInfoMap:t,fieldInfos:r,fieldName:n,graphic:a,isContentFieldInfos:i,layer:o,timeZone:u,value:s}=e;if(s==null)return"";const l=qe({fieldName:n,value:s,graphic:a,layer:o});if(l)return l;const c=xe({fieldName:n,graphic:a,layer:o});if(c)return c;if(t.get(n.toLowerCase()))return Ne(s,{fieldInfos:r||Array.from(t.values()),fieldName:n,graphic:a,isContentFieldInfos:i,layer:o,timeZone:u});const f=o?.fieldsIndex?.get(n);return f&&(ee(f)||X(f))?U(s,{fieldType:f.type,timeZoneOptions:{layerTimeZone:o&&"preferredTimeZone"in o?o.preferredTimeZone:null,viewTimeZone:u,datesInUnknownTimezone:!(!o||!("datesInUnknownTimezone"in o))&&!!o.datesInUnknownTimezone}}):Q(s)}function pt({attributes:e,fieldInfoMap:t,fieldInfos:r,graphic:n,isContentFieldInfos:a,layer:i,relatedInfos:o,timeZone:u}){const s={};return o?.forEach(l=>$e({attributes:s,relatedInfo:l,fieldInfoMap:t,fieldInfos:r,layer:i,timeZone:u})),e&&Object.keys(e).forEach(l=>{const c=e[l];s[l]=H({fieldInfoMap:t,fieldInfos:r,fieldName:l,graphic:n,isContentFieldInfos:a,layer:i,timeZone:u,value:c})}),s}async function Ae(e,t){const{layer:r,graphic:n,outFields:a,objectIds:i,returnGeometry:o,spatialReference:u}=e,s=i[0];if(typeof s!="number"&&typeof s!="string"){const c="Could not query required fields for the specified feature. The feature's ID is invalid.",f={layer:r,graphic:n,objectId:s,requiredFields:a};return F().warn(c,f),null}if(!Y(r)?.operations?.supportsQuery){const c="The specified layer cannot be queried. The following fields will not be available.",f={layer:r,graphic:n,requiredFields:a,returnGeometry:o};return F().warn(c,f),null}const l=r.createQuery();return l.objectIds=i,l.outFields=a?.length?a:[r.objectIdField],l.returnGeometry=!!o,l.returnZ=!!o,l.returnM=!!o,l.outSpatialReference=u,(await r.queryFeatures(l,t)).features[0]}async function ke(e){if(!e.expressionInfos?.length)return!1;const t=await R(),{arcadeUtils:{hasGeometryFunctions:r}}=t;return r(e)}async function ve(e){if(!e.expressionInfos?.length)return!1;const t=await R(),{arcadeUtils:{requiresTrack:r}}=t;return r(e)}async function yt({graphic:e,popupTemplate:t,layer:r,spatialReference:n},a){if(!r||!t||(typeof r.load=="function"&&await r.load(a),!e.attributes))return;const i=r.objectIdField,o=e.attributes[i];if(o==null)return;const u=[o],s=new Set(await t.getRequiredFields(r.fieldsIndex));r.timeInfo?.trackIdField==null||s.has(r.timeInfo.trackIdField)||await ve(t)&&s.add(r.timeInfo.trackIdField);const l=K(e,s),c=l?[]:s.has(i)?[...s]:[...s,i],f=t.returnGeometry||await ke(t);if(l&&!f)return;const d=await Ae({layer:r,graphic:e,outFields:c,objectIds:u,returnGeometry:f,spatialReference:n},a);d&&(d.geometry&&(e.geometry=d.geometry),d.attributes&&(e.attributes={...e.attributes,...d.attributes}))}function C(e=""){return!!e&&e.includes(M)}function Ze(e){return e?`${M}${e.layerId}/${e.fieldName}`:""}function Z({attributes:e,graphic:t,relatedInfo:r,fieldInfos:n,fieldInfoMap:a,layer:i,timeZone:o}){e&&t&&r&&Object.keys(t.attributes).forEach(u=>{const s=Ze({layerId:r.relation.id.toString(),fieldName:u}),l=t.attributes[u];e[s]=H({fieldName:s,fieldInfos:n,fieldInfoMap:a,layer:i,value:l,graphic:t,timeZone:o})})}function $e({attributes:e,relatedInfo:t,fieldInfoMap:r,fieldInfos:n,layer:a,timeZone:i}){e&&t&&(t.relatedFeatures?.forEach(o=>Z({attributes:e,graphic:o,relatedInfo:t,fieldInfoMap:r,fieldInfos:n,layer:a,timeZone:i})),t.relatedStatsFeatures?.forEach(o=>Z({attributes:e,graphic:o,relatedInfo:t,fieldInfoMap:r,fieldInfos:n,layer:a,timeZone:i})))}const $=e=>{if(!e)return!1;const t=e.toUpperCase();return t.includes("CURRENT_TIMESTAMP")||t.includes("CURRENT_DATE")||t.includes("CURRENT_TIME")},P=({layer:e,method:t,query:r,definitionExpression:n})=>{if(!e.capabilities?.query?.supportsCacheHint||t==="attachments")return;const a=r.where!=null?r.where:null,i=r.geometry!=null?r.geometry:null;$(n)||$(a)||i?.type==="extent"||r.resultType==="tile"||(r.cacheHint=!0)},mt=({query:e,layer:t,method:r})=>{P({layer:t,method:r,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression??""}`})},It=({queryPayload:e,layer:t,method:r})=>{P({layer:t,method:r,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression??""}`})};function bt(e,t,r){return e&&t&&r?t.type==="sublayer"?y({layers:t.layer?.allSublayers,map:e,relatedLayer:t,relationship:r})||y({layers:t.layer?.subtables,map:e,relatedLayer:t,relationship:r}):y({layers:e.allLayers,map:e,relatedLayer:t,relationship:r})||y({layers:e.allTables,map:e,relatedLayer:t,relationship:r}):null}function gt(e,t){return e&&"utilityNetworks"in e&&t?e.utilityNetworks?.find(r=>r.isUtilityLayer(t)):null}function E(e,t){return e?.allTables.find(r=>r.type==="feature"&&r.layerId===t.id&&r.url===t.layer?.url)}function y({map:e,relationship:t,relationship:{relatedTableId:r},relatedLayer:n,layers:a}){if(!a)return null;for(const i of a){if(i.type==="map-image"){const u=y({layers:i.sublayers,map:e,relatedLayer:n,relationship:t})||y({layers:i.subtables,map:e,relatedLayer:n,relationship:t});if(u)return u;continue}if(!O(i))continue;if(n.type==="sublayer"){if(i!==n&&i.id===r)return i.isTable?E(e,i):i;continue}const o=n.type==="scene"&&n.associatedLayer?n.associatedLayer.url:n.url;if(!o)return null;if(i.type!=="sublayer"){if(i!==n&&i.url===o&&i.layerId===r)return i}else if(i!==n&&i.layer?.url===o&&i.id===r)return i.isTable?E(e,i):i}return null}export{Q as applyTextFormattingHTML,ft as createFieldInfoMap,bt as findRelatedLayer,gt as findUtilityNetwork,ge as fixTokens,pt as formatAttributes,ut as formatEditInfo,Ne as formatValueToFieldInfo,dt as getAllFieldInfos,de as getFieldFormat,Ce as getFieldInfo,it as getFieldInfoLabel,G as getFixedFieldName,at as getFixedFieldNames,tt as getSourceLayer,rt as graphicCallback,ct as htmlEntities,lt as isAssociatedFeatureSupportedLayer,S as isExpressionField,Te as isFeatureSupportedLayer,st as isGraphicForRelatableFeatureSupportedLayer,O as isRelatableFeatureSupportedLayer,we as isRelatableLayer,C as isRelatedField,D as isSupportedContext,mt as preLayerQueryCallback,It as preRequestCallback,Ae as querySourceLayer,yt as queryUpdatedFeature,nt as shouldOpenInNewTab,ye as substituteAttributes,ot as substituteFieldsInLinksAndAttributes};
