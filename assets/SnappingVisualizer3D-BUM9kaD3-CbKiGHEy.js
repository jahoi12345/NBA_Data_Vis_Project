import{F as q}from"./Color-CERqXxxY-BuYn26eI.js";import{e as ne}from"./colorUtils-CeIi7j7j-C2WVx6th.js";import{M as y}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{v as U,l as C,$ as A,I as R,c as P,O as X,J as ce}from"./vec32-CewSdTn3-VRto2OOh.js";import{t as m,e as $,M as le}from"./collectionUtils-jDyktm0P-BDP2Oq99.js";import{h as ee,x as ue}from"./projectVectorToVector-Csv3NYZI-DpBtmQMN.js";import{z as te,R as re}from"./elevationInfoUtils-B8MpdRMP-CDlK86wO.js";import{t as I,b as L,U as h,n as de,c as he,K as pe}from"./euclideanLengthMeasurementUtils-CpHh36Dt-Ct4GxOU1.js";import{Z as me}from"./ExtendedLineVisualElement-B_Ze482f-1sZ0lLhF.js";import{j as ie}from"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import{a as oe,m as Q}from"./screenUtils-BitdhK1O-L0FLPAMi.js";import{Y as _e,b as fe,l as S,F as ge,u as v}from"./Polygon-D6wEPb3W-D2MPjRU4.js";import{o as F}from"./vec2f64-rIxtbMRN-Kai9mK1i.js";import{_ as V,V as De}from"./vec42-B8VM4vXb-B6OGOEI9.js";import{e as H}from"./vec4f64-DPb6J-GU-C7c2DqbZ.js";import{E as se}from"./EngineVisualElement-DP9Jiq6V-Dztd1hg5.js";import{J as j,h as ae,B as E}from"./ShadowCastClear.glsl-CeOT_rAo-BEYyVrmo.js";import{M as T}from"./RealisticTree.glsl-WN9nrQUl-QZiY3aPA.js";import{j as B}from"./PointVisualElement-pF4jjqm_-CfTxywah.js";import{o as W,U as Z}from"./mat4-C96X-Nn0-BrMLOLCb.js";import{n as Oe}from"./mat4f64-q_b6UJoq-Dh6sWB_w.js";import{z as b}from"./vector-B8ZDYGQ6-DRILJdcx.js";import{a as Re}from"./orientedBoundingBox-BLEx7wLU-ByGP9QG1.js";import{g as we}from"./Texture-CFNZjV2R-CxGjQ8pI.js";import{V as K}from"./ColorMaterial.glsl-rhi0cQVb-DVm6kWLC.js";import{z as ye}from"./SnappingContext-CApcAey_-Bfkkm4s2.js";class Me extends se{constructor(e){super(e),this._location=m(),this._direction=le(1,0,0),this._width=1,this._offset=1,this._length=18,this._color=H(1,0,1,1),this._renderOccluded=4,this.applyProperties(e)}createObject3DResourceFactory(e){return{view:e,createResources:t=>this._createObject3DResources(t),destroyResources:ve,recreateGeometry:(t,i)=>this._recreateObject3DGeometry(t,i),cameraChanged:()=>this._updateGeometry(),forEachMaterial:(t,i)=>i(t.material)}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:be,recreateGeometry:t=>this._recreateDrapedGeometry(t),forEachMaterial:(t,i)=>i(t.material)}}get location(){return this._location}set location(e){P(this._location,e)||(R(this._location,e),this._updateGeometry())}get direction(){return this._direction}set direction(e){P(this._direction,e)||(R(this._direction,e),this._updateGeometry())}setDirectionFromPoints(e,t){C(this._direction,A(this._direction,t,e)),this._updateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get offset(){return this._offset}set offset(e){e!==this._offset&&(this._offset=e,this._updateGeometry())}get length(){return this._length}set length(e){e!==this._length&&(this._length=e,this._updateGeometry())}get color(){return this._color}set color(e){De(e,this._color)||(V(this._color,e),this._updateMaterial())}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get isDecoration(){return this._isDecoration}set isDecoration(e){this._isDecoration=e,this._updateMaterial()}_createObject3DResources(e){const t=new j(this.materialParameters,this.view.state.isGlobal),i=new Array;return this._createObject3DGeometry(t,e,i),{material:t,geometries:i}}_recreateObject3DGeometry(e,t){e.geometries.length=0,this._createObject3DGeometry(e.material,t,e.geometries)}_createObject3DGeometry(e,t,i){const[s,o]=k(e);t.addGeometry(s),t.addGeometry(o),i.push(s),i.push(o),this._updateVerticesObject3D(t)}_createDrapedResources(){const e=new j(this.materialParameters,this.view.state.isGlobal),t=ie(()=>this.view.state.contentPixelRatio,()=>this.drapedResources.recreateGeometry());return{material:e,geometries:this._createDrapedGeometry(e),pixelRatioHandle:t}}_recreateDrapedGeometry(e){e.geometries=this._createDrapedGeometry(e.material)}_createDrapedGeometry(e){const t=k(e);return this._updateVerticesDraped(t),t.map(i=>new ae(i))}_updateMaterial(){const{materialParameters:e}=this;this.object3dResources.resources?.material.setParameters(e),this.drapedResources.resources?.material.setParameters(e)}get materialParameters(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded,isDecoration:this.isDecoration}}_updateGeometry(){if(this.isDraped)this.drapedResources.recreateGeometry();else{const e=this.object3dResources.object;e&&this._updateVerticesObject3D(e)}}_updateVerticesObject3D(e){const t=this.view.state.camera;t.projectToScreen(this.location,G),X(p,this.location,this.direction),t.projectToScreen(p,O),_e(O,fe(O,O,G)),this._updateVertexAttributesObject3D(t,e,0,G,O,1),this._updateVertexAttributesObject3D(t,e,1,G,O,-1)}_updateVertexAttributesObject3D(e,t,i,s,o,a){const n=t.geometries[i],c=n.getMutableAttribute("position")?.data;if(!c)return;const{start:l,end:d}=J(o,s,a,this.offset,this.width,this.length);e.unprojectFromScreen(Q(l),p),c[0]=p[0],c[1]=p[1],c[2]=p[2],e.unprojectFromScreen(Q(d),p),c[3]=p[0],c[4]=p[1],c[5]=p[2],t.geometryVertexAttributeUpdated(n,"position")}_updateVerticesDraped(e){const{view:{overlayManager:t,state:{contentPixelRatio:i}}}=this,{location:s,width:o,length:a,offset:n}=this,c=xe;c.spatialReference=t.spatialReference,c.x=s[0],c.y=s[1];const l=this.view.overlayPixelSizeInMapUnits(c)*i,d=o*l,_=a*l,u=n*l;this._updateVertexAttributesDraped(e[0],d,_,u,-1),this._updateVertexAttributesDraped(e[1],d,_,u,1)}_updateVertexAttributesDraped(e,t,i,s,o){const a=e.getMutableAttribute("position")?.data;if(!a)return;const{location:n,direction:c}=this,{start:l,end:d}=J(c,n,o,s,t,i);a[0]=l[0],a[1]=l[1],a[2]=E,a[3]=d[0],a[4]=d[1],a[5]=E,e.invalidateBoundingInfo()}}function k(r){return[T(r,[m(),m()]),T(r,[m(),m()])]}function J(r,e,t,i,s,o){const a=S(Y,ge(Y,r[1]*t,r[0]*-t),i+s/2),n=v(x,v(x,v(x,e,S(x,r,o/2)),a),a);return{start:n,end:v(N,n,S(N,r,-o))}}function ve(r){r.geometries.length=0}function be(r){r.pixelRatioHandle.remove(),r.geometries=[]}const p=m(),Y=F(),x=F(),N=F(),G=oe(),O=oe(),xe=ee(0,0,void 0,null);let Ge=class extends se{constructor(r){super(r),this._maxSize=0,this._position=m(),this._up=m(),this._right=m(),this._renderOccluded=4,this._color=H(1,0,0,1),this._outlineColor=H(0,0,0,1),this._outlineSize=0,this._size=32,this._outlineRenderOccluded=16,this.applyProperties(r)}createObject3DResourceFactory(r){return{view:r,createResources:e=>this._createObject3DResources(e),destroyResources:()=>{},cameraChanged:()=>this._updateTransformObject3D(),forEachMaterial:(e,t)=>{t(e.outlineMaterial),t(e.quadMaterial)}}}createDrapedResourceFactory(r){return{view:r,createResources:()=>this._createDrapedResources(),destroyResources:ze,forEachMaterial:(e,t)=>{t(e.outlineMaterial),t(e.quadMaterial)}}}get renderOccluded(){return this._renderOccluded}set renderOccluded(r){r!==this._renderOccluded&&(this._renderOccluded=r,this._updateQuadMaterial())}get isDecoration(){return this._isDecoration}set isDecoration(r){this._isDecoration=r,this._updateOutlineMaterial(),this._updateQuadMaterial()}get color(){return this._color}set color(r){V(this._color,r),this._updateQuadMaterial()}get outlineColor(){return this._outlineColor}set outlineColor(r){V(this._outlineColor,r),this._updateOutlineMaterial()}get outlineSize(){return this._outlineSize}set outlineSize(r){const e=this._outlineSize===0!=(r===0);this._outlineSize=r,e?this.recreateGeometry():this._updateOutlineMaterial()}get size(){return this._size}set size(r){r!==this._size&&(this._size=r,this._updateTransform())}get outlineRenderOccluded(){return this._outlineRenderOccluded}set outlineRenderOccluded(r){this._outlineRenderOccluded=r,this._updateOutlineMaterial()}set geometry({previous:r,center:e,next:t}){this._maxSize=Math.min(U(e,r),U(e,t))/3,C(this._up,A(this._up,r,e)),C(this._right,A(this._right,t,e)),R(this._position,e),this.recreateGeometry()}_createObject3DResources(r){const e=new K(this._quadMaterialParameters),t=this._outlineSize===0?void 0:new j(this._outlineMaterialParameters,this.view.state.isGlobal);return this._createObject3DGeometries(r,e,t),{quadMaterial:e,outlineMaterial:t}}_createObject3DGeometries(r,e,t){if(P(this._up,$)&&P(this._right,$))return;const i=this._createGeometries(e,t);for(const s of i)r.addGeometry(s);this._updateTransformObject3D(r)}_createDrapedResources(){const r=new K(this._quadMaterialParameters),e=this._outlineSize===0?void 0:new j(this._outlineMaterialParameters,this.view.state.isGlobal),t=this._createGeometries(r,e).map(i=>new ae(i));return this._setTransformDraped(t),{quadMaterial:r,outlineMaterial:e,geometries:t,pixelRatioHandle:ie(()=>this.view.state.contentPixelRatio,()=>this.drapedResources.recreateGeometry())}}_createGeometries(r,e){const{up:t,right:i,corner:s}=this._getVertices(),o=Pe(t,i,s,r);return e?[o,T(e,[t,s,i])]:[o]}_getVertices(){let r=this._up,e=this._right;const t=X(b.get(),r,e);return this.isDraped&&(r=R(b.get(),r),e=R(b.get(),e),r[2]=0,e[2]=0,t[2]=0),{up:r,right:e,corner:t}}_updateTransform(){this.isDraped?this.drapedResources.recreateGeometry():this._updateTransformObject3D()}_updateTransformObject3D(r=this.object3dResources.object){if(!r)return;const e=this.view.state.camera,t=this._size*e.computeScreenPixelSizeAt(this._position),i=Math.min(this._maxSize,t);W(f,this._position),Z(f,f,[i,i,i]),r.transformation=f}_setTransformDraped(r){if(r.length===0)return;const{view:{overlayManager:e,state:{contentPixelRatio:t}}}=this,{_position:i,_size:s}=this,o=R(b.get(),i);o[2]=E;const a=je;a.spatialReference=e.spatialReference,a.x=o[0],a.y=o[1];const n=s*(this.view.overlayPixelSizeInMapUnits(a)*t),c=Math.min(this._maxSize,n);W(f,o),Z(f,f,[c,c,1]);for(const l of r)l.transformation=f}get _quadMaterialParameters(){return{color:this._color,forceTransparentMode:!0,writeDepth:!1,polygonOffset:!0,renderOccluded:this._renderOccluded,isDecoration:this.isDecoration}}_updateQuadMaterial(){this.object3dResources.resources?.quadMaterial.setParameters(this._quadMaterialParameters),this.drapedResources.resources?.quadMaterial.setParameters(this._quadMaterialParameters)}get _outlineMaterialParameters(){return{color:this._outlineColor,width:this._outlineSize,renderOccluded:this._outlineRenderOccluded,isDecoration:this.isDecoration}}_updateOutlineMaterial(){this.object3dResources.resources?.outlineMaterial?.setParameters(this._outlineMaterialParameters),this.drapedResources.resources?.outlineMaterial?.setParameters(this._outlineMaterialParameters)}};function ze(r){r.pixelRatioHandle.remove(),r.geometries=[]}function Pe(r,e,t,i){return new we(i,[["position",new Re([0,0,0,...e,...r,...t],[0,1,2,1,2,3],3,!0)]])}const f=Oe(),je=ee(0,0,void 0,null);class ot extends ye{sortUniqueHints(e){return e.sort((t,i)=>(i instanceof I?i.length:0)-(t instanceof I?t.length:0))}visualizeIntersectionPoint(e,t){const{spatialReference:i,view:s}=t,o=M(t);return y(new B({view:s,primitive:"circle",geometry:L(e.intersectionPoint,i),elevationInfo:e.isDraped?te:re,size:20,outlineSize:2,color:o.intersectionPointColor,outlineColor:o.intersectionPointOutlineColor,pixelSnappingEnabled:!1,isDecoration:!0,attached:!0}))}visualizePoint(e,t){const{view:i,spatialReference:s}=t,o=M(t),a=g(e.point,e.domain,t);return y(new B({view:i,primitive:"circle",geometry:L(a,s),elevationInfo:z(e),size:20,outlineSize:2,color:o.pointColor,outlineColor:o.pointOutlineColor,pixelSnappingEnabled:!1,isDecoration:!0,attached:!0}))}visualizeLine(e,t){const{view:i,spatialReference:s}=t,o=M(t),a=g(e.lineStart,e.domain,t),n=g(e.lineEnd,e.domain,t);return y(Se(e.type,a,n,s,z(e),i,o,e.isDraped,e.fadeLeft,e.fadeRight))}visualizeParallelSign(e,t){const{view:i,spatialReference:s}=t,o=M(t),{isDraped:a}=e,n=z(e),c=g(e.lineStart,e.domain,t),l=g(e.lineEnd,e.domain,t),d=D(c,s,n,i,a),_=D(l,s,n,i,a),u=ce(_,d,_,.5),w=new Me({view:i,attached:!1,offset:h.parallelLineHintOffset,length:h.parallelLineHintLength,width:h.parallelLineHintWidth,color:o.parallelSignColor,location:u,renderOccluded:a?4:16,isDraped:a,renderGroup:3,isDecoration:!0});return w.setDirectionFromPoints(d,u),w.attached=!0,y(w)}visualizeRightAngleQuad(e,t){const{view:i,spatialReference:s}=t,o=M(t),a=z(e),{isDraped:n}=e,c=g(e.previousVertex,e.domain,t),l=g(e.centerVertex,e.domain,t),d=g(e.nextVertex,e.domain,t),_=D(c,s,a,i,n),u=D(l,s,a,i,n),w=D(d,s,a,i,n);return y(new Ge({view:i,attached:!0,color:n?o.rightAngleColorDraped:o.rightAngleColor,renderOccluded:n?4:2,outlineRenderOccluded:n?4:16,outlineColor:o.rightAngleOutlineColor,outlineSize:h.rightAngleHintOutlineSize,size:h.rightAngleHintSize,isDraped:n,geometry:{previous:_,center:u,next:w},renderGroup:3,isDecoration:!0}))}}function M(r){const{effectiveTheme:e}=r.view,t=q.toUnitRGBA(e.accentColor),i=[0,0,0,0];return{intersectionPointColor:i,intersectionPointOutlineColor:t,pointColor:i,pointOutlineColor:t,lineColor:t,lineOutlineColor:void 0,parallelSignColor:t,rightAngleColor:t,rightAngleColorDraped:q.toUnitRGBA(ne(e.accentColor,.5)),rightAngleOutlineColor:t}}function g(r,e,{selfSnappingZ:t,view:i,spatialReference:s}){return 2&e&&he(r)&&t!=null?de(r,t,i,s):r}function z(r){return r.isDraped?te:re}function Se(r,e,t,i,s,o,a,n=!1,c=!0,l=!0){const d=D(e,i,s,o,n),_=D(t,i,s,o,n),u=new me({view:o,extensionType:3,start:d,end:_,isDraped:n,color:a.lineColor,renderOccluded:n?4:16,renderGroup:3,isDecoration:!0});switch(r){case 0:u.width=h.lineHintWidthTarget,u.fadedExtensions={start:0,end:h.lineHintFadedExtensions};break;case 2:u.width=h.lineHintWidthReference,u.fadedExtensions={start:0,end:0};break;case 1:u.width=h.lineHintWidthReference,u.fadedExtensions={start:c?h.lineHintFadedExtensions:0,end:l?h.lineHintFadedExtensions:0}}return u.attached=!0,u}function D(r,e,t,i,s){const o=m();if(s){const a=i.overlayManager.spatialReference;ue(r,e,o,a)}else pe(r,e,t,i,o);return o}export{Ge as G,ot as o};
