const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/I3STreeDebugger-Z2ZXlghR-CxhBmrQd.js","assets/jsonMap-Bs3hmeCU-Cusd0Fmz.js","assets/mat4-C96X-Nn0-BrMLOLCb.js","assets/collectionUtils-jDyktm0P-BDP2Oq99.js","assets/index-B0z_nLWi.js","assets/index-Cv2ko1Ob.css","assets/Point-BfTTZoMu-DeJwQYfh.js","assets/reader-DcGs6kKN-DHJfK-tm.js","assets/reactiveUtils-SO2Ko3sy-BCLX8Jdy.js","assets/Extent-CgDMOSRD-Bod5LY6s.js","assets/SimpleObservable-CvFyr0NA-DXpoMYph.js","assets/Polygon-D6wEPb3W-D2MPjRU4.js","assets/aaBoundingRect-CjwcS2F3-ri8bmh30.js","assets/mathUtils-PIGhLnI9-B1tKUlUb.js","assets/mat4f64-q_b6UJoq-Dh6sWB_w.js","assets/vec32-CewSdTn3-VRto2OOh.js","assets/projectionUtils-BGH_5_I3-DGwchVO8.js","assets/Polyline-CoiTLswR-DTxpB2Yg.js","assets/TileTreeDebugger-DsAI0NzA-Dgv5neWE.js","assets/Color-CERqXxxY-BuYn26eI.js","assets/Graphic-DgGzDmqW-d1CNicxz.js","assets/getPopupProvider-CmskPttI-CzUWpGwk.js","assets/lengthUtils-Dt1_RvOO-j3MEdmHu.js","assets/date-IqUzANpt-bLKO9IDT.js","assets/Layer-DZvC7bne-D3VLDrab.js","assets/jsonUtils-CmpazY1u-6pDLj5sx.js","assets/typeUtils-DqrRcjBx-DZ6_Gsbu.js","assets/createFeatureId-CVwTD0fV-3fKpJDrk.js","assets/typeUtils-CXW_VpOn-BGgLp_TK.js","assets/lineMarkers-CDwLe3J6-CNUjJvs3.js","assets/PolygonSymbol3D-BXRHZiCQ-BjPAY2LA.js","assets/ExtrudeSymbol3DLayer-DSc1ou2x-CsVYZCeG.js","assets/screenUtils-BitdhK1O-L0FLPAMi.js","assets/opacityUtils-DuFH0EC9-DWspTgn2.js","assets/aaBoundingBox-Cn49X7ge-BcYPaJ58.js","assets/DoubleArray-DExKNiTh-CvVpHySW.js","assets/Font-BwmnW7d2-Dwh3xjKw.js","assets/SimpleFillSymbol-CDawtd9z-CWD2KI2D.js","assets/SimpleMarkerSymbol-BGAFRS9_-CVQ5NLIA.js","assets/PictureMarkerSymbol-CaSh-vZk-xhjZ61bb.js","assets/TextSymbol-hRGhyDHs-CoS7dSjf.js","assets/meshUtils-DPfwf6VG-C6zSZU-V.js","assets/Mesh-CkDBRbaq-DwAP_1yt.js","assets/axisAngleDegrees-CjbXmycq-DcVVDR1-.js","assets/quat-B7J5v7rV-CZ9akUv-.js","assets/quatf64-CCm9z-pX-CQ7_sSji.js","assets/vec42-B8VM4vXb-B6OGOEI9.js","assets/MeshComponent-Ccgxjntc-lZNdhigm.js","assets/imageUtils-142g71N8-Wj0XNClb.js","assets/meshProperties-DWLWd_LJ-DdGPdsWo.js","assets/MeshLocalVertexSpace-BGd1IdEs-C0HJG4wR.js","assets/MeshTransform-Bl0zl104-SaBiGlTx.js","assets/MeshVertexAttributes-CsRRGxwu-B0_t4SvE.js","assets/meshVertexSpaceUtils-CtG7DPVT-kybwngCt.js","assets/triangulationUtils-D34y65Gu-Cdt3j08j.js","assets/earcut-D9gy186--DqxOpTir.js","assets/Indices-D0_UQPPr-t1Qev6md.js","assets/plane-BNdSPG2o-DTV5z6SO.js","assets/vector-B8ZDYGQ6-DRILJdcx.js","assets/vec2f64-rIxtbMRN-Kai9mK1i.js","assets/vec4f64-DPb6J-GU-C7c2DqbZ.js","assets/deduplicate-Lzwo1kX7-CSf-1ZcR.js","assets/projectPointToVector-DL7Z4uvb-CPbOlZdQ.js","assets/vertexSpaceConversion-DwAXLcxI-BXQ2PRg6.js","assets/spatialReferenceEllipsoidUtils-D2JabnKt-Ce3ED0lc.js","assets/computeTranslationToOriginAndRotation-Bjd4esRf-vJ4LbdOU.js","assets/vec3-B_phcnZY-DHC7I6xa.js","assets/BufferView-Cj2sQaht-avJ4OGB_.js","assets/vec4-B7mYuNMQ-ChTBJPnP.js","assets/External-DqWxNHeL-BMl9kTYf.js","assets/infoFor3D-DhzudQro-CCYgWfsv.js"])))=>i.map(i=>d[i]);
import{H as Ae,_ as Ve}from"./index-B0z_nLWi.js";import{Y as p,H as v,G as Re,l as he,a as Nt,c as j,v as O,m as Dt,w as He,o as Ce,ab as Pt,bV as ce,bW as ke,a3 as Tt,t as ut,e as At,s as Vt,a6 as Ht,I as kt,a5 as Gt,q as _t,j as Lt,bH as Ut,r as Bt,bz as gt,bf as $t,y as zt,i as qt,bX as ft,n as mt}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{F as Wt}from"./Color-CERqXxxY-BuYn26eI.js";import{s as ue}from"./Graphic-DgGzDmqW-d1CNicxz.js";import{o as P,j as ie,q as pt}from"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import{E as Kt,a as Ge,$ as Xt}from"./Polygon-D6wEPb3W-D2MPjRU4.js";import{E as Qt,i as Zt}from"./mat4-C96X-Nn0-BrMLOLCb.js";import{j as Yt,n as Jt}from"./mat4f64-q_b6UJoq-Dh6sWB_w.js";import{c as es}from"./quatf64-CCm9z-pX-CQ7_sSji.js";import{L as _e,V as ts,W as Me,h as ss,O as Q,k as is,$ as rs,a as yt}from"./vec32-CewSdTn3-VRto2OOh.js";import{t as V}from"./collectionUtils-jDyktm0P-BDP2Oq99.js";import{z as Le}from"./vec42-B8VM4vXb-B6OGOEI9.js";import{e as as,o as ns}from"./vec4f64-DPb6J-GU-C7c2DqbZ.js";import{r as os}from"./UpdatingHandles-D2RI_3Hb-dwLPjVun.js";import{z as ls}from"./spatialReferenceEllipsoidUtils-D2JabnKt-Ce3ED0lc.js";import{p as ds,n as hs,i as cs,s as us}from"./Transform-B98MC8vi-B90xtMIX.js";import{X as _s}from"./projectBoundingSphere-B69Mxmv9-BDEAeDef.js";import{b as Se,P as Ue}from"./projectionUtils-BGH_5_I3-DGwchVO8.js";import{x as ge,h as gs}from"./projectVectorToVector-Csv3NYZI-DpBtmQMN.js";import{S as Ee,y as fs,P as ms,l as Y,r as ps}from"./aaBoundingBox-Cn49X7ge-BcYPaJ58.js";import{y as ae,d as ys}from"./aaBoundingRect-CjwcS2F3-ri8bmh30.js";import{i as ne,s as fe}from"./DoubleArray-DExKNiTh-CvVpHySW.js";import{o as Be,a as q,cz as $e,cA as bs,bd as vs,a$ as Is}from"./Texture-CFNZjV2R-CxGjQ8pI.js";import{U as Cs}from"./Indices-D0_UQPPr-t1Qev6md.js";import{h as bt,g as Ms,a as ws,S as xs}from"./sphere-DLQ6p7mp-DyEe1Vll.js";import{t as Rs,ad as Ss,ac as we,V as Es,b5 as Os,ai as js,a6 as Fs,aj as Ns,ah as Ds,aa as ze,l as Ps,d as Ts}from"./ShadowCastClear.glsl-CeOT_rAo-BEYyVrmo.js";import{G as As,D as Vs,P as Hs,b as ks,f as Gs,V as Ls,k as Us}from"./I3SOverrides-BAPZnFo2-C2R-CAn0.js";import{a as Bs,$ as $s}from"./lengthUtils-Dt1_RvOO-j3MEdmHu.js";import{r as zs}from"./SceneModification-BvcaWkQk-BdvrXsuH.js";import{d as qs,v as Ws}from"./visualVariableUtils-ma4r7Z2K-Df6C3Hkh.js";import{x as Ks,d as Xs,b as Qs,a as Zs}from"./ExtentSet-BmZuhn8E-DMTIpxE1.js";import{a as qe}from"./elevationInfoUtils-B8MpdRMP-CDlK86wO.js";import{g as Ys,h as Js}from"./typeUtils-CXW_VpOn-BGgLp_TK.js";import{o as ei}from"./SimpleFillSymbol-CDawtd9z-CWD2KI2D.js";import{d as me}from"./mathUtils-PIGhLnI9-B1tKUlUb.js";import{C as ti}from"./diffUtils-wTC1YzlE-DCTUTUs8.js";import{E as si}from"./layerViewUtils-BTa15X3o-BjQlX2q8.js";import{A as ii,D as ri}from"./I3SMeshWorkerHandle-BaFEt1Xl-BDbleven.js";import{initialize as ai,setModificationsSync as ni,filterObbsForModificationsSync as oi,interpretObbModificationResults as li}from"./SceneLayerWorker-B7YoqKUk-DWCdyy9k.js";import{t as We}from"./RealisticTree.glsl-WN9nrQUl-QZiY3aPA.js";import{r as Ke}from"./Scheduler-CNrsbccs-Bcg8fWoS.js";import{J as pe}from"./I3SBinaryReader-ZmgM2p_h-BnxBvCpV.js";import{n as di,_ as hi,e as ci,X as ui,i as _i,u as gi,N as Xe,d as fi,s as ye,a as mi,o as W,V as pi,l as yi}from"./I3SUtil-BtVE6TXz-Dtqhx7kO.js";import{q as bi}from"./intersectorUtilsConversions-pLQPEbcN-Ck-nyNYa.js";import{v as vi}from"./HUDIntersectorResult-1xTExS7z-dL9SFL6u.js";import{u as be}from"./attributeUtils-Dc8--CBJ-B-j5BZQ_.js";import{u as Ii,m as Qe}from"./highlightUtils--bJgM-zK-C5dtE5Ia.js";import{d as Z,n as Ze}from"./orientedBoundingBox-BLEx7wLU-ByGP9QG1.js";import{n as Ci}from"./InterleavedLayout-B7roQAzV-CdGz7mlm.js";import{Q as ve}from"./Emissions.glsl-B8XKMjLy-DXfiRNVX.js";import{t as Mi}from"./highlightOptionsUtils-Cdm0-Ad8-Cud-MHR_.js";const xe=(r,a=xe,n=a.f||(a.f=["assets/I3STreeDebugger-Z2ZXlghR.js","assets/jsonMap-Bs3hmeCU.js","assets/mat4-C96X-Nn0.js","assets/collectionUtils-jDyktm0P.js","assets/index-BzxsWNRw.js","assets/index-Cv2ko1Ob.css","assets/Point-BfTTZoMu.js","assets/reader-DcGs6kKN.js","assets/reactiveUtils-SO2Ko3sy.js","assets/Extent-CgDMOSRD.js","assets/SimpleObservable-CvFyr0NA.js","assets/Polygon-D6wEPb3W.js","assets/aaBoundingRect-CjwcS2F3.js","assets/mathUtils-PIGhLnI9.js","assets/mat4f64-q_b6UJoq.js","assets/vec32-CewSdTn3.js","assets/projectionUtils-BGH_5_I3.js","assets/Polyline-CoiTLswR.js","assets/TileTreeDebugger-DsAI0NzA.js","assets/Color-CERqXxxY.js","assets/Graphic-DgGzDmqW.js","assets/getPopupProvider-CmskPttI.js","assets/lengthUtils-Dt1_RvOO.js","assets/date-IqUzANpt.js","assets/Layer-DZvC7bne.js","assets/jsonUtils-CmpazY1u.js","assets/typeUtils-DqrRcjBx.js","assets/createFeatureId-CVwTD0fV.js","assets/typeUtils-CXW_VpOn.js","assets/lineMarkers-CDwLe3J6.js","assets/PolygonSymbol3D-BXRHZiCQ.js","assets/ExtrudeSymbol3DLayer-DSc1ou2x.js","assets/screenUtils-BitdhK1O.js","assets/opacityUtils-DuFH0EC9.js","assets/aaBoundingBox-Cn49X7ge.js","assets/DoubleArray-DExKNiTh.js","assets/Font-BwmnW7d2.js","assets/SimpleFillSymbol-CDawtd9z.js","assets/SimpleMarkerSymbol-BGAFRS9_.js","assets/PictureMarkerSymbol-CaSh-vZk.js","assets/TextSymbol-hRGhyDHs.js","assets/meshUtils-DPfwf6VG.js","assets/Mesh-CkDBRbaq.js","assets/axisAngleDegrees-CjbXmycq.js","assets/quat-B7J5v7rV.js","assets/quatf64-CCm9z-pX.js","assets/vec42-B8VM4vXb.js","assets/MeshComponent-Ccgxjntc.js","assets/imageUtils-142g71N8.js","assets/meshProperties-DWLWd_LJ.js","assets/MeshLocalVertexSpace-BGd1IdEs.js","assets/MeshTransform-Bl0zl104.js","assets/MeshVertexAttributes-CsRRGxwu.js","assets/meshVertexSpaceUtils-CtG7DPVT.js","assets/triangulationUtils-D34y65Gu.js","assets/earcut-D9gy186-.js","assets/Indices-D0_UQPPr.js","assets/plane-BNdSPG2o.js","assets/vector-B8ZDYGQ6.js","assets/vec2f64-rIxtbMRN.js","assets/vec4f64-DPb6J-GU.js","assets/deduplicate-Lzwo1kX7.js","assets/projectPointToVector-DL7Z4uvb.js","assets/vertexSpaceConversion-DwAXLcxI.js","assets/spatialReferenceEllipsoidUtils-D2JabnKt.js","assets/computeTranslationToOriginAndRotation-Bjd4esRf.js","assets/vec3-B_phcnZY.js","assets/BufferView-Cj2sQaht.js","assets/vec4-B7mYuNMQ.js","assets/External-DqWxNHeL.js","assets/infoFor3D-DhzudQro.js"]))=>r.map(e=>n[e]);function wi(r,a=!1){return r<=$t?a?new Array(r).fill(0):new Array(r):new Uint8Array(r)}let xi=class{constructor(r){this.renderBounds=r}};function sa(r,a,n){const e=ne(24);return t=>{const s=t.meta.featureExtents,i=new Float64Array(s.buffer,6*t.index*Float64Array.BYTES_PER_ELEMENT,6);return i[0]===Number.POSITIVE_INFINITY&&(Oe(t.index,n,t.meta.objectHandle,e,0),Se(e,a,0,e,r,0)?Ee(e,i):fs(i,ms)),i}}function Oe(r,a,n,e,t){const s=a.getComponentAabb(n,r,Ri),i=a.getObjectTransform(n);for(let o=0;o<8;++o)D[0]=1&o?s[0]:s[3],D[1]=2&o?s[1]:s[4],D[2]=4&o?s[2]:s[5],Me(D,D,i.rotationScale),Q(D,D,i.position),e[t++]=D[0],e[t++]=D[1],e[t++]=D[2];return e}const Ye=24,Ri=Y(),D=V();let Si=class extends pt{constructor(){super(...arguments),this._map=new Map}clear(){if(this._map.size>0){const r=this.toArray();this._map.clear(),this.emit("change",{added:[],removed:r})}}get length(){return this._map.size}get(r){return this._map.get(r)}addMany(r){if(r.length===0)return;const a=new Set;for(let e=0;e<r.length;e++){const t=r[e],s=t.objectId,i=this._map.get(s);i?(a.add(s),t!==i&&(r[e]=i),i.refCount||(i.refCount=0),++i.refCount):(t.refCount=1,this._map.set(s,t))}const n=a.size>0?r.filter(e=>!a.has(e.objectId)):r;n.length>0&&this.emit("change",{added:n,removed:[]})}removeMany(r){const a=[];for(const n of r){const e=n.objectId,t=this._map.get(e);t!=null&&(!t.refCount||--t.refCount<=0)&&(this._map.delete(e),a.push(n))}a.length>0&&this.emit("change",{added:[],removed:a})}removeManyByObjectId(r){const a=[];for(const n of r){const e=this._map.get(n);e!=null&&(!e.refCount||--e.refCount<=0)&&(this._map.delete(n),a.push(e))}a.length>0&&this.emit("change",{added:[],removed:a})}toArray(){return[...this._map.values()]}find(r){return ft(this._map,r)}some(r){return mt(this._map,r)}forEach(r){this._map.forEach(a=>r(a))}},Ei=class extends pt{constructor(r){super(),this._limit=r,this._all=new Si,this._active=new ji(this),this._pending=new Map,this._handle=this._all.on("change",a=>this._handleChanges(a))}destroy(){super.destroy(),this._handle.remove()}get length(){return this._active.length}toArray(){return this._active.toArray()}find(r){return this._active.find(r)}some(r){return this._active.some(r)}forEach(r){this._active.forEach(r)}addMany(r){this._all.addMany(r)}removeManyByObjectId(r){this._all.removeManyByObjectId(r)}_handleChanges(r){let a=r.removed;if(this._pending.size>0){a=new Array;for(const s of r.removed)this._pending.delete(s.objectId)||a.push(s)}let n=this._limit-this._active.length+a.length;n<r.added.length&&(this._active.removeMany(a),a=[],G.reset(1-this._limit/(this._active.length+r.added.length)),this._active.forEach(s=>{G.sample()&&(a.push(s),this._pending.set(s.objectId,s))}),n=this._limit-this._active.length+a.length);let e=r.added;if(n<r.added.length){e=new Array,G.reset(n/r.added.length);for(const s of r.added)G.sample()?e.push(s):this._pending.set(s.objectId,s)}const t=n-e.length;t>0&&this._pending.size>0&&(G.reset(t/this._pending.size),this._pending.forEach(s=>{G.sample()&&(e.push(s),this._pending.delete(s.objectId))})),this._active.addAndRemove(e,a)}},Oi=class{constructor(){this._percentage=1,this._last=-1,this._index=0}reset(r){this._percentage=r,this._last=-1}sample(){const r=Math.floor(this._index*this._percentage);return++this._index,r!==this._last&&(this._last=r,!0)}};const G=new Oi;let ji=class{constructor(r){this._parent=r,this._map=new Map}get length(){return this._map.size}forEach(r){this._map.forEach(a=>r(a))}find(r){return ft(this._map,r)}some(r){return mt(this._map,r)}toArray(){return Array.from(this._map.values())}addAndRemove(r,a){for(const n of r)this._map.set(n.objectId,n);for(const n of a)this._map.delete(n.objectId);(r.length>0||a.length>0)&&this._parent.emit("change",{added:r,removed:a})}removeMany(r){for(const a of r)this._map.delete(a.objectId);r.length>0&&this._parent.emit("change",{added:[],removed:r})}};class Je{constructor(a,n){this.meta=a,this.index=n}}class Fi{constructor(a,n){this.graphic=a,this.geometry=n,this.components=[],this.overridesDirty=!1}}let N=class extends _t{get updating(){return this._graphicsCore?.updating??!1}constructor(r){super(r),this.loadedGraphics=new Ei(5e4),this.slicePlaneEnabled=!1,this._renderingInfo=new Ps(null,new Js),this._featuresMap=new Map}initialize(){const r=this.view.basemapTerrain;this._graphicsCore=new Xs({owner:this,layer:this.layer,preferredUpdatePolicy:0,elevationFeatureExpressionEnabled:!1,graphicSymbolSupported:!1,getRenderingInfoWithoutRenderer:!0,hasZ:!0,hasM:!1,componentFactories:{deconflictor:a=>this.view.deconflictor.addGraphicsOwner(a),labeler:(a,n)=>this.view.labeler.addGraphicsOwner(a,n,{emptySymbolLabelSupported:!0,elevationInfoOverride:{mode:"absolute-height",offset:0},disablePlacement:{logEntityDescription:"3D Object Scene Layer features"}}),scaleVisibility:si()?null:(a,n)=>new Qs({graphicsCoreOwner:this,layer:this.layer,queryGraphicUIDsInExtent:n,graphicsCore:a,basemapTerrain:r,layerScaleEnabled:!1})}}),this._graphicsCore.initializePromise.then(()=>this._graphicsCore.startCreateGraphics()).catch(()=>{}),this.addHandles(ie(()=>this.layer.labelingInfo,(a,n)=>{ti(a,n)&&this._graphicsCore.updateLabelingInfo()}))}destroy(){this._graphicsCore=j(this._graphicsCore),this.loadedGraphics=j(this.loadedGraphics),this.view=null}addNodeMeta(r,a){let n=0;const e=r.filteredIds,t=this.view.spatialReference,s=[];for(let i=0;i<r.featureIds.length;i++){const o=r.featureIds[i];let d=e==null;if(e&&n<e.length&&o===e[n]&&(d=!0,n++),!this._enabledForFeatureInNode(r,i))continue;const l=this._featuresMap.get(o);if(l){l.components.push(new Je(r,i)),this._updateLabelPosition(o);continue}const h=a(i,r),c=gs(0,0,0,t),u={objectId:o,uid:Lt(),attributes:h,visible:d,geometry:c},C=new Fi(u,c);C.components.push(new Je(r,i)),this._featuresMap.set(o,C),this._updateLabelGeometry(o),s.push(u)}this.loadedGraphics.addMany(s)}updateLabelPositions(r){const a=this.view.renderCoordsHelper;this._forEachGraphic(r,(n,e,t)=>{const s=this._graphicsCore.getGraphics3DGraphicById(e.uid);s!=null&&this._updateLabelGeometry(r.featureIds[n])&&s.alignWithAbsoluteElevation(t.z??0,a,!1)})}setNodeMetaAttributes(r,a){const n=new Array;this._forEachGraphic(r,(e,t)=>{const s=a(e,r);Ut(t.attributes,s)||(t.attributes=s,n.push(t.uid))}),this._graphicsCore.updateLabelingInfo(n)}applyFilterChange(r){this._forEachFeature(r,(a,n,e)=>{if(!this._enabledForFeatureInNode(r,a)){const i=r.featureIds[a];switch(this._removeFeature(n,r,a)){case 2:this.loadedGraphics.removeManyByObjectId([i]);break;case 1:this._updateLabelPosition(i)}return}const t=n.graphic,s=t.visible;s!==e&&(t.visible=e,L.graphic=t,L.property="visible",L.oldValue=s,L.newValue=e,this._graphicsCore.graphicUpdateHandler(L),L.graphic=null)})}removeNodeMeta(r){const a=[];this._forEachGraphic(r,n=>{const e=r.featureIds[n],t=this._featuresMap.get(e);if(t)switch(this._removeFeature(t,r,n)){case 1:this._updateLabelPosition(e);break;case 2:a.push(e)}}),this.loadedGraphics.removeManyByObjectId(a)}_removeFeature(r,a,n){const e=r.components.length;return Bt(r.components,t=>!(t.meta===a&&t.index===n)),r.components.length===0?(this._featuresMap.delete(a.featureIds[n]),2):e!==r.components.length?1:0}getRenderingInfo(){return this._renderingInfo}notifyGraphicGeometryChanged(){}notifyGraphicVisibilityChanged(){}_updateLabelPosition(r){const a=this._featuresMap.get(r);a&&this._updateLabelGeometry(r)&&(this.loadedGraphics.removeManyByObjectId([r]),this.loadedGraphics.addMany([a.graphic]))}_updateLabelGeometry(r){const a=this._featuresMap.get(r);if(!a)return!1;const n=a.geometry,e=this.view.spatialReference,t=this.view.renderCoordsHelper,s=n.x,i=n.y,o=n.z??0,d=a.components.length,l=ne(d*Ye);let h=0;for(const{meta:c,index:u}of a.components)Oe(u,this.collection,c.objectHandle,l,h),h+=Ye;return Se(l,t.spatialReference,0,l,e,0),Ee(l,U),n.x=(U[0]+U[3])/2,n.y=(U[1]+U[4])/2,n.z=U[5],!me(n.x,s)||!me(n.y,i)||!me(n.z,o)}_forEachGraphic(r,a){this._forEachFeature(r,(n,{graphic:e,geometry:t},s)=>{this._enabledForFeatureInNode(r,n)&&a(n,e,t,s)})}_forEachFeature(r,a){let n=0;for(let e=0;e<r.featureIds.length;e++){const t=this._featuresMap.get(r.featureIds[e]);let s=r.filteredIds==null;r.filteredIds&&r.filteredIds[n]===r.featureIds[e]&&(s=!0,n++),t&&a(e,t,s)}}_enabledForFeatureInNode(r,a){return r.node.index<0||!this.overrides?.featureHasGeometryChanges(r.featureIds[a])}get updatePolicy(){return this._graphicsCore.effectiveUpdatePolicy}get usedMemory(){return this._graphicsCore.usedMemory}get unloadedMemoryEstimate(){return this._graphicsCore.unprocessedMemoryEstimate}get test(){}};p([v()],N.prototype,"view",void 0),p([v()],N.prototype,"layer",void 0),p([v()],N.prototype,"collection",void 0),p([v()],N.prototype,"loadedGraphics",void 0),p([v()],N.prototype,"overrides",void 0),p([v()],N.prototype,"layerViewUid",void 0),p([v()],N.prototype,"updating",null),p([v()],N.prototype,"slicePlaneEnabled",void 0),p([v()],N.prototype,"_graphicsCore",void 0),N=p([Re("esri.views.3d.layers.I3SMeshViewLabeler")],N);const L={graphic:null,property:null,oldValue:null,newValue:null},U=Y();class Ni extends Ts{constructor(a,n,e,t,s,i,o){super(a,0,0,0,n),this.gpuMB=e,this.geometryMB=t,this.textureMB=s,this.unloadedMB=i,this.idbHitRate=o}}class Di{constructor(a){this.highlightName=a,this.ids=new Set}}let Pi=class{constructor({collection:r,forAllFeatures:a,forAllFeaturesOfNode:n}){this._highlights=new Map,this._collection=r,this._forAllFeatures=a,this._forAllFeaturesOfNode=n}destroy(){this._highlights.forEach(r=>r.forEach(a=>this._releaseSet(a))),this._highlights=null}acquireSet(r){const a=new Di(r);zt(this._highlights,r,()=>[]).push(a);const n=qt(()=>{const e=this._highlights?.get(r);e&&(this._releaseSet(a),ut(e,a))});return{set:a,handle:n}}setFeatureIds(r,a){a.forEach(n=>r.ids.add(n)),this._initializeSet(r)}_initializeSet(r){this._forAllFeatures((a,n,e)=>(r.ids.has(a)&&this._collection.addComponentHighlight(e.objectHandle,n,r.highlightName),1))}_releaseSet(r){this._forAllFeatures((a,n,e)=>(r.ids.has(a)&&this._collection.removeComponentHighlight(e.objectHandle,n,r.highlightName),1))}objectCreated(r){this._highlights.forEach((a,n)=>{a.forEach(e=>{this._forAllFeaturesOfNode(r,(t,s)=>(e.ids.has(t)&&this._collection.addComponentHighlight(r.objectHandle,s,n),1))})})}objectDeleted(r){this._collection.clearHighlights(r.objectHandle)}},re=class extends _t{constructor(r,a,n,e){super({}),this._updateExtent=a,this._updateNode=n,this._getElevationMode=e,this.readyToRun=!1,this._extentSet=new Zs,this._nodeSet=new Set;const t=this._taskPriority,s=r.registerTask(this._taskPriority,this);this.addHandles(s),this._task=s,this._lastTaskPriority=t}destroy(){this._extentSet.destroy()}get _taskPriority(){const r=this._getElevationMode();return r&&r===1?Ke.ELEVATION_ALIGNMENT_SCENE:Ke.ELEVATION_ALIGNMENT}_updateTaskPriority(){const r=this._taskPriority;r!==this._lastTaskPriority&&(this._task.priority=r,this._lastTaskPriority=r)}addExtent(r){this._extentSet.add(r),this._updateTaskPriority(),this.readyToRun=!0}schedule(r){this._nodeSet.add(r),this._updateTaskPriority(),this.readyToRun=!0}remove(r){this._nodeSet.delete(r),this._updateRunning()}runTask(r){const a=this._extentSet;for(r.run(()=>a.merge(r));!a.empty&&!r.done;)this._updateExtent(a.pop())?.forAll(t=>this.schedule(t)),r.madeProgress();if(r.done)return;const n=this._nodeSet;for(const e of n)if(n.delete(e),this._updateNode(e),r.madeProgress(),r.done)break;this._updateRunning()}_updateRunning(){this.readyToRun=this._nodeSet.size>0||this._extentSet.size>0}};p([v()],re.prototype,"readyToRun",void 0),re=p([Re("esri.views.3d.layers.i3s.I3SAsyncElevationUpdater")],re);let Ti=class{constructor(){this.lodCrossfadeSignedDuration=0}};class Ai{constructor(a){this._view=a,this._preRenderFrameTaskHandle=null,this._currentFrameStartTime=null,this._numFadingNodes=0}destroy(){this._preRenderFrameTaskHandle?.remove(),this._preRenderFrameTaskHandle=null,this._view=null}get updating(){return this._numFadingNodes>0}stopNodeFading(a){a.lodCrossfadeProgress!=null&&(this._numFadingNodes--,a.lodCrossfadeProgress=null,this._numFadingNodes===0&&(this._preRenderFrameTaskHandle!=null&&(this._preRenderFrameTaskHandle=Vt(this._preRenderFrameTaskHandle)),this._view.notifyLODUpdate(),this._view.notifyUpdate()))}_startNodeFading(a,n,e){this._numFadingNodes===0&&(this._preRenderFrameTaskHandle=Ht({preRender:t=>this._updateAllNodeFading(t)}),this._view.notifyLODUpdate()),a.lodCrossfadeProgress==null&&(this._numFadingNodes++,this._view.notifyUpdate()),a.lodCrossfadeSignedDuration=e,a.lodCrossfadeProgress=n}_updateAllNodeFading(a){const n=this._view.nodeCrossfadingEnabled;this._view.foreachCrossfadeNode((e,t)=>{if(e?.lodCrossfadeProgress!=null){const s=e.lodCrossfadeSignedDuration,i=s>0?this._view.fullOpacity:0,o=a.deltaTime/s,d=e.lodCrossfadeProgress+Math.abs(o),l=!n||d>=1||s===0,h=i-(l?0:s>0?1:-1)*(1-d);l?(this.stopNodeFading(e),s<0&&this._view.markNodeToRemove(t)):e.lodCrossfadeProgress=d,this._view.setNodeOpacityByIndex(t,h)}}),this._view.removeMarkedNodes()}stopAllNodeFading(){this._view.foreachCrossfadeNode((a,n)=>{if(a?.lodCrossfadeProgress!=null){this.stopNodeFading(a);const e=a.lodCrossfadeSignedDuration;e<0&&this._view.markNodeToRemove(n);const t=e>0?this._view.fullOpacity:0;this._view.setNodeOpacityByIndex(n,t)}}),this._view.removeMarkedNodes()}fadeNode(a,n,e,t){this._currentFrameStartTime==null&&(this._currentFrameStartTime=Date.now());const s=this._view,i=s.nodeCrossfadingEnabled,o=e===0?s.fullOpacity:0,d=i?t?e===0?s.lodCrossfadeinDuration:s.lodCrossfadeoutDuration:s.lodCrossfadeUncoveredDuration:0,l=this._view.getNodeOpacityByIndex(a);if(i&&l!==o&&d>0){const h=1-Math.abs(o-l);this._startNodeFading(n,h,Vi(e)*d)}else this.stopNodeFading(n),this._view.setNodeOpacityByIndex(a,o),e===1&&this._view.removeNode(a)}isNodeFullyFadedIn(a){const n=this._view.getNodeCrossfadeMetaData(a);return n==null||n.lodCrossfadeProgress==null&&this._view.getNodeOpacityByIndex(a)===this._view.fullOpacity}}function Vi(r){return r===0?1:-1}let Hi=class{constructor(r){this.type=2,this._needVerticalOffset=!1,this.layerViewUid=r.layerViewUid,this.sublayerId=r.sublayerId,this._collection=r.collection,this._traverseNodeHierarchy=r.traverseNodeHierarchy,this.slicePlaneEnabled=r.slicePlaneEnabled,this.isGround=r.isGround}updateElevationAlignState(r,a){this._needVerticalOffset=r&&a===1}intersect(r,a,n,e,t,s){const i=r.options.store===2,o=r.ray.direction;let d=y=>y,l=y=>y;const h=vs(r.verticalOffset??(this._needVerticalOffset?0:null));r.verticalOffset!=null&&h!=null&&(d=y=>h.applyToMbs(y),l=y=>h.applyToObb(y));const{results:c,tolerance:u}=r,C=new Is(u,s,r.options.normalRequired),w=(y,x)=>{if(y.childrenLoaded===0)return!1;const _=y.serviceObbInRenderSR?.isValid?y.serviceObbInRenderSR:null;return!(_&&!l(_).intersectRay(n,o,u))&&(!x||!_&&yi(y.serviceMbsInRenderSR)&&!ki(d(y.serviceMbsInRenderSR),n,o,u)||y.geometryObbInRenderSR!=null&&!l(y.geometryObbInRenderSR).intersectRay(n,o,u)||this._collection.intersect(x,n,e,h,C,(b,g,f,m)=>{if(g<0||a!=null&&!a(n,e,g))return;const I=R=>{const F=new bi(this.layerViewUid,this.sublayerId,y.index,b,m);R.set(this.type,F,g,f)};if(this.isGround&&(c.ground.distance==null||g<c.ground.distance)&&I(c.ground),!r.options.isFiltered&&((c.min.distance==null||g<c.min.distance)&&I(c.min),(c.max.distance==null||g>c.max.distance)&&I(c.max),i)){const R=new vi(r.ray);I(R),r.results.all.push(R)}}),!0)};this._traverseNodeHierarchy(w)}};function ki(r,a,n,e=0){const t=r[3]+e,s=a[0]-r[0],i=a[1]-r[1],o=a[2]-r[2],d=n[0],l=n[1],h=n[2],c=d*s+l*i+h*o;return c*c-(d*d+l*l+h*h)*(s*s+i*i+o*o-t*t)>=0}const Gi=14;class Li{constructor(a,n,e=Gi){this._version=e,this._db=null,this._quotaReductionPromise=null,this._gcCounter=0,this._hit=0,this._miss=0,this._destroyed=!1,this.gcFrequency=50,this.maxByteSize=1073741824,this.quotaReductionFactor=.2,this._dbName=a,this._storeName=n}init(){return Promise.resolve().then(()=>{const a=indexedDB.open(this._dbName,this._version);return a.onupgradeneeded=n=>{const e=a.result,t=a.transaction,s=e.objectStoreNames.contains(this._storeName)?t.objectStore(this._storeName):e.createObjectStore(this._storeName),i=e.objectStoreNames.contains("last_access")?t.objectStore("last_access"):e.createObjectStore("last_access");i.indexNames.contains("date")||i.createIndex("date","date",{unique:!1}),i.indexNames.contains("byteSize")||i.createIndex("byteSize","byteSize",{unique:!1}),n.oldVersion<this._version&&(s.clear(),i.clear())},B(a)}).then(a=>{this._destroyed?a.close():this._db=a})}destroy(){this._db&&(this._db.close(),this._db=null),this._destroyed=!0}get initialized(){return this._db!=null}getHitRate(){return this._hit/(this._hit+this._miss)}put(a,n){return this._db==null?Promise.reject(new kt("indexedb:not-initialized","IndexedDB Cache is not initialized")):(this._quotaReductionPromise!=null?this._quotaReductionPromise:Promise.resolve()).then(()=>this._put(a,n)).catch(e=>{if(e&&e.name==="QuotaExceededError")return this._quotaReductionPromise==null&&(this._quotaReductionPromise=this._getCacheSize().then(t=>this._removeLeastRecentlyAccessed(n.byteSize+Math.ceil(t*this.quotaReductionFactor))),this._quotaReductionPromise.then(()=>this._quotaReductionPromise=null,()=>this._quotaReductionPromise=null)),this._quotaReductionPromise.then(()=>this._put(a,n));throw e}).then(()=>{this._gcCounter--,this._gcCounter<0&&this._db!=null&&(this._gcCounter=this.gcFrequency,this._getCacheSize().then(e=>this._removeLeastRecentlyAccessed(e-this.maxByteSize)))})}get(a,n){const e=this._db;if(e==null)return Promise.resolve(void 0);let t=null;return Promise.resolve().then(()=>{const s=e.transaction(this._storeName,"readonly");return t=Gt(n,()=>{s.abort()}),B(s.objectStore(this._storeName).get(a))}).then(s=>(s==null?++this._miss:this._db&&(++this._hit,this._db.transaction("last_access","readwrite").objectStore("last_access").put({date:Date.now(),byteSize:s.byteSize},a)),t?.remove(),s)).catch(()=>{++this._miss,Ce(n),t?.remove()})}remove(a){const n=this._db;return n==null?Promise.resolve():Promise.resolve().then(async()=>{const e=n.transaction([this._storeName,"last_access"],"readwrite"),t=e.objectStore(this._storeName),s=e.objectStore("last_access"),i=t.delete(a),o=s.delete(a);await Promise.all([B(i),B(o),te(e)])})}_put(a,n){const e=this._db;if(e==null)return Promise.resolve();const t=e.transaction([this._storeName,"last_access"],"readwrite"),s=t.objectStore(this._storeName),i=t.objectStore("last_access"),o=s.put(n,a),d=i.put({date:Date.now(),byteSize:n.byteSize},a);return Promise.all([B(o),B(d),te(t)])}_removeLeastRecentlyAccessed(a){if(a<=0||!this._db)return Promise.resolve();const n=this._db.transaction([this._storeName,"last_access"],"readwrite"),e=n.objectStore(this._storeName),t=n.objectStore("last_access");let s=0;const i=t.index("date").openCursor(null,"next");return i.onsuccess=()=>{const o=i.result;o!=null&&(o.value.byteSize!=null&&(s+=o.value.byteSize),e.delete(o.primaryKey),t.delete(o.primaryKey),s<a&&o.continue())},te(n)}_getCacheSize(){const a=this._db;if(a==null)return Promise.resolve(0);const n=a.transaction("last_access"),e=n.objectStore("last_access");let t=0;const s=e.index("byteSize").openKeyCursor();return s.onsuccess=()=>{const i=s.result;if(!i)return;const o=i.key;o!=null&&(t+=o),i.continue()},te(n).then(()=>t)}}function te(r){return new Promise((a,n)=>{r.oncomplete=()=>a(),r.onerror=()=>n(r.error),r.onabort=()=>n(r.error)})}function B(r){return new Promise((a,n)=>{r.readyState==="done"?r.error!=null?n(r.error):a(r.result):(r.onsuccess=()=>a(r.result),r.onerror=()=>n(r.error))})}const et=new WeakMap;let Ui=class{constructor(r,a){switch(this._miss=0,this._hit=0,this.initialized=!0,a){case"layer":this._data=new Map;break;case"view":{const n=et.get(r);if(n){this._data=n;break}const e=new Map;this._data=e,et.set(r,e)}}}init(){return Promise.resolve()}async get(r,a){if(this._data.has(r))return this._hit++,this._data.get(r)??void 0;this._miss++}destroy(){}put(r,a){return this._data.set(r,a),Promise.resolve()}remove(r){return this._data.delete(r),Promise.resolve()}getHitRate(){return this._hit/(this._hit+this._miss)}};class Bi{constructor(){this.color=ns(),this.castShadows=!0,this.pickable=!0,this.colorMixMode=1}}const tt=[1,1,1,1];class $i extends Ti{constructor(a,n,e,t,s,i,o,d,l){super(),this.node=a,this.featureIds=n,this.objectHandle=e,this.cachedRendererVersion=t,this.attributeInfo=s,this.material=i,this.textures=o,this.anchorIds=d,this.anchors=l,this.cachedElevationAnchors=null,this.cachedEdgeMaterials=new Array,this.edgeMemoryUsage=0,this.cachedSymbologyStride=5}get usedMemory(){return this.node.memory}get featureExtents(){return this._featureExtents??=new Float64Array(6*this.featureIds.length).fill(Number.POSITIVE_INFINITY),this._featureExtents}}const zi=26,qi=104857600,ia=r=>{const a=r;let n=class extends a{constructor(){super(...arguments),this._applySSAO=!0,this._shadeNormals=!0,this._updatingHandles=new os,this._highlights=null,this._nodeId2Meta=new Map,this._nodeId2MetaReloading=new Map,this._i3sWasmLoaded=!1,this._snappingSourcesTrackers=[],this._compressionTracker=new Ss,this._hasLoadedPBRTextures=!1,this._asyncModuleLoading=0,this._addTasks=new Map,this._currentRenderer=null,this._rendererVersion=0,this._colorVariable=null,this._opacityVariable=null,this._rendererFields=null,this._symbologyFields=null,this._symbologyOverride=null,this._symbologyOverrideFields=null,this._symbolInfos=new Map,this._visibleGeometryChangedSchedulerHandle=null,this._hasComponentData=!1,this._hasVertexColors=!1,this._nodeColorOverride=null,this.updating=!0,this.holeFilling="auto",this._hasColors=!1,this._hasTextures=!1,this._hasData=!1,this.slicePlaneEnabled=!1,this._modifications=new Array,this.ignoresMemoryFactor=!1,this._layerUrl="",this._cacheKeySuffix=null,this._planetRadiusInGlobalMode=0,this._elevationTask=null,this._needFilterResolve=!1,this._filters=[],this._arcade=null,this._tmpAttributeOnlyGraphic=new ue,this._crossfadeHelper=new Ai(this)}get lodCrossfadeoutDuration(){return 0}get lodCrossfadeinDuration(){return 0}get lodCrossfadeUncoveredDuration(){return 0}get layerViewUid(){return this.uid}get layerId(){return this.i3slayer&&this.i3slayer.id}get sublayerId(){return null}get _isIntegratedMesh(){return this.i3slayer.type==="integrated-mesh"}get contentVisible(){return!this.suspended&&this._controller?.rootNodeVisible&&this.fullOpacity>Be}get legendEnabled(){return this.contentVisible&&this.i3slayer?.legendEnabled===!0}get updatingProgressValue(){return this._controller?.updatingProgress??0}get hasTexturesOrVertexColors(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"}get rendererTextureUsage(){return di(this._currentRenderer)?this._usePBR||this._hasLoadedPBRTextures?63:37:this._usePBR||this._hasLoadedPBRTextures?44:36}get elevationOffset(){const e=this.i3slayer!=null?this.i3slayer.elevationInfo:null;return e!=null&&e.mode==="absolute-height"?qe(e,this.i3slayer.spatialReference):0}get elevationInfo(){const e=this.i3slayer!=null?this.i3slayer.elevationInfo:null;if(e==null)return new X(0,0);const t=qe(e,this.i3slayer.spatialReference);switch(e.mode){case"absolute-height":return new X(0,t);case"relative-to-ground":return new X(1,t);case"on-the-ground":return new X(2,0);default:return new X(0,0)}}get supportedTextureEncodings(){return As(this.view.stage.renderView.capabilities)}get clientGeometry(){return this.i3sOverrides.geometryOverrides}get elevationRange(){const e=this._nodeId2Meta,t=new we;for(const s of e.values()){if(s==null)continue;const{node:{serviceMbsInIndexSR:i}}=s,[o,d,l,h]=i;t.expandElevationRangeValues(l-h,l+h)}return t.elevationRangeValid?t:null}get fullExtent(){return this.i3slayer.fullExtent}initialize(){const e=he("enable-feature:idb-mock-cache");this._idbCache=e?new Ui(this.view,e):new Li("esri-scenelayer-cache","geometries"),this._preLoadBasis(),this.addResolvingPromise(this.i3slayer.indexInfo);const t=this.view.resourceController,s=t.memoryController;this.i3sOverrides=new Vs({view:this.view,layer:this.i3slayer,memoryController:s}),this._workerHandle=new ii(Es(t)),this.addResolvingPromise(this._workerHandle.promise);const i=this.i3slayer.store;this.addResolvingPromise(this._workerHandle.setLegacySchema(this.uid,i.defaultGeometrySchema).catch(Nt)),hi(this.i3slayer),ci(this.i3slayer,this.view),this._layerUrl=this.i3slayer.parsedUrl.path,this._controller=new Hs({layerView:this,worker:this._workerHandle}),this._gpuMemoryEstimate=0,this._texMemoryEstimate=0,this._geoMemoryEstimate=0,this._stage=this.view.stage,this._collection=this._stage.renderView.componentObjectCollection;const o=i.defaultGeometrySchema;if(this._isIntegratedMesh||!o)this._hasComponentData=!1;else{const _=o.featureAttributes;this._hasComponentData=!!(_&&_.faceRange&&_.id)}this._hasVertexColors=(o?.vertexAttributes.color??null)!=null&&!this.i3slayer.cachedDrawingInfo?.color;const d=this.view.resourceController.memoryController.newCache(`sl-${this.uid}`,_=>this._deleteComponentObject(_));this._memCache=d;const l=this._controller,h=this._nodeId2Meta,c=this._nodeId2MetaReloading,u=_=>{const b=l.index;if(!b)return;const g=b.rootNode;if(!g)return;const f=m=>{const I=m.index,R=h.get(I)||c.get(I);return _(m,R?.objectHandle??null)};b.traverse(g,f)};this._intersectionHandler=new Hi({layerViewUid:this.layerViewUid,sublayerId:this.sublayerId,collection:this._collection,slicePlaneEnabled:this.slicePlaneEnabled,isGround:this._isIntegratedMesh,traverseNodeHierarchy:u}),this._elevationProvider=new ds({view:this.view,layerElevationSource:this,intersectionHandler:this._intersectionHandler}),this._hasLoadedPBRTextures=this._usePBR,this._updatingHandles.add(()=>this.view.clippingArea,()=>this._clippingAreaChanged(),P),this._updatingHandles.add(()=>this.fullOpacity,_=>this._opacityChange(_)),this._updatingHandles.add(()=>this.slicePlaneEnabled,_=>this._slicePlaneEnabledChange(_)),this._updatingHandles.add(()=>this.elevationOffset,(_,b)=>{this._reloadAll(b),this._controller.invalidateVisibilityObbs()}),this._updatingHandles.add(()=>this.elevationInfo,(_,b)=>this._elevationInfoChanged(_,b),P),this._updatingHandles.add(()=>!this.suspended&&this.elevationInfo.mode!==0,(_,b)=>{_?this.addHandles(this.view.basemapTerrain.on("elevation-change",({extent:g})=>this._ensureElevationTask().addExtent(g)),dt):b&&this.removeHandles(dt)},P),this._updatingHandles.add(()=>this._usePBR,_=>this._updatePBR(_));const C=()=>{this._reloadAll(),this.clearMemCache()};this._updatingHandles.add(()=>this.rendererTextureUsage,C),this._updatingHandles.add(()=>this.contentVisible,_=>this._contentVisibleChanged(_),P),this._updatingHandles.add(()=>this.i3slayer.labelsVisible,()=>this._labelingChanged(),P),this._updatingHandles.add(()=>this.i3slayer.labelingInfo,()=>this._labelingChanged(),P),this._updatingHandles.add(()=>this._modifications,()=>this._modificationsChanged(),P),this.addHandles([ie(()=>q.I3S_TREE_SHOW_TILES,_=>{if(_&&!this._treeDebugger){const b=this._controller.crsIndex;Ae(async()=>{const{I3STreeDebugger:g}=await Ve(()=>import("./I3STreeDebugger-Z2ZXlghR-CxhBmrQd.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40]));return{I3STreeDebugger:g}},xe([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40])).then(({I3STreeDebugger:g})=>{!this._treeDebugger&&q.I3S_TREE_SHOW_TILES&&(this._treeDebugger=new g({lv:this,view:this.view,nodeSR:b}))})}else _||q.I3S_TREE_SHOW_TILES||(this._treeDebugger=j(this._treeDebugger))},P),ie(()=>q.I3S_SHOW_MODIFICATIONS,()=>this._showModifications(),P)]),this._cacheKeySuffix=this._getCacheKeySuffix(),this._idbCache.init().catch(_=>O.getLogger(this).warn(`Failed to initialize IndexedDB cache: ${_}`));const{view:w}=this,{viewingMode:y,renderCoordsHelper:x}=w;this._planetRadiusInGlobalMode=y==="local"?0:x.referenceEllipsoid.radius}destroy(){this._clearAddTasks(),this._elevationTask=j(this._elevationTask),this.i3sOverrides=j(this.i3sOverrides),this._elevationProvider&&(this._elevationProvider.notifyObjectsChanged(this.getVisibleObbs()),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this._intersectionHandler&&(this._stage.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null);const e=this._workerHandle;e&&(e.destroyContextAndSelf(this.uid),this._workerHandle=null),this._removeAllNodeDataFromStage(),this._memCache=j(this._memCache),this._collection=null,this._stage=null,this._edgeView=null,this._labeler=j(this._labeler),this._treeDebugger=j(this._treeDebugger),this._controller=j(this._controller),this._highlights=j(this._highlights),this._nodeId2Meta.clear(),this._nodeId2MetaReloading.clear(),this._crossfadeHelper=j(this._crossfadeHelper),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null),this._updatingHandles=j(this._updatingHandles)}_memEstimateTextureAdded(e){const t=e.usedMemory;return this._gpuMemoryEstimate+=t,this._texMemoryEstimate+=t,t}_memEstimateTextureRemoved(e){if(e!=null){const t=e.usedMemory;this._gpuMemoryEstimate-=t,this._texMemoryEstimate-=t}}_memEstimateGeometryAdded(e){const t=this._collection.getObjectGPUMemoryUsage(e);return this._gpuMemoryEstimate+=t,this._geoMemoryEstimate+=t,t}_memEstimateGeometryRemoved(e){const t=this._collection.getObjectGPUMemoryUsage(e);this._gpuMemoryEstimate-=t,this._geoMemoryEstimate-=t}isNodeLoaded(e){return this._nodeId2Meta.has(e)}isNodeReloading(e){return this._nodeId2MetaReloading.has(e)}get usedMemory(){let e=this._labeler!=null?this._labeler.usedMemory:0;return this._nodeId2Meta.forEach(t=>e+=t!=null?t.node.memory:0),this._nodeId2MetaReloading.forEach(t=>e+=t!=null?t.node.memory:0),e}get unloadedMemory(){return(this._controller!=null?this._controller.unloadedMemoryEstimate:0)+(this._labeler!=null?this._labeler.unloadedMemoryEstimate:0)}_labelingChanged(){if(!(Os(this.i3slayer)&&this._supportsLabeling))return void(this._labeler!=null&&(this._labeler.destroy(),this._labeler=null));if(this._labeler!=null)return;const e=new N({view:this.view,layer:this.i3slayer,collection:this._collection,overrides:this.i3sOverrides,layerViewUid:this.uid});this._nodeId2Meta.forEach(t=>t!=null&&this._addMetaToLabeler(e,t)),this._labeler=e}_loadAsyncModule(e){return++this._asyncModuleLoading,e.then(t=>(--this._asyncModuleLoading,t),t=>{throw--this._asyncModuleLoading,t})}_modificationsChanged(){if(!this._i3sWasmLoaded&&this.hasModifications)return this._i3sWasmLoaded=ai().then(()=>{this._i3sWasmLoaded=!0,this._modificationsChanged(),this.notifyUpdate()}),void this.notifyUpdate();if(this._i3sWasmLoaded!==!0)return;const e=l=>O.getLogger(this).error("set-modifications-error","Error when setting modifications:",l),t=this.uid,s=this.i3slayer.spatialReference,i=s.isGeographic,o=ri(this._layerClippingArea,this._modifications,s);this._workerHandle.setModifications(t,o,i).catch(e);try{ni({context:t,modifications:o,isGeodetic:i})}catch(l){e(l)}this._controller.modificationsChanged();const d=this.hasModifications?new Dt:null;this._nodeId2Meta.forEach((l,h)=>{l==null?(this._nodeId2Meta.delete(h),this._controller.updateLoadStatus(h,!1)):l.node.hasModifications?(this._updateFeatureIdCounts(l,-1),this._nodeId2Meta.delete(h),this._nodeId2MetaReloading.set(h,l)):d?.push(l.node)}),this.notifyChange("elevationRange"),d!=null&&this._nodeId2MetaReloading.forEach(l=>d.push(l.node)),d!=null&&d.length>0&&(this.updateNodeModificationStatus(d),d.forAll(l=>{if(l.imModificationImpact!==2){const h=this._nodeId2Meta.get(l.index);this._controller.invalidateGeometryVisibility(l.index),h!=null?(this._updateFeatureIdCounts(h,-1),this._nodeId2Meta.delete(l.index),this._nodeId2MetaReloading.set(l.index,h),this.notifyChange("elevationRange")):this._nodeId2Meta.has(l.index)&&(this._nodeId2Meta.delete(l.index),this._controller.updateLoadStatus(l.index,!1))}})),this.clearMemCache(),this._controller.restartNodeLoading(),this._showModifications()}_showModifications(){if(this._modificationGraphics!=null&&(this.view.graphics.removeMany(this._modificationGraphics),this._modificationGraphics=null),!q.I3S_SHOW_MODIFICATIONS||this._modifications.length===0)return;const e={clip:[227,227,79,.8],mask:[227,139,79,.8],replace:[139,227,79,.8]},t={outline:{color:[255,255,255],width:1}};this._modificationGraphics=[];for(const s of this._modifications){const i=s.geometry;i.spatialReference=this.i3slayer.spatialReference;const o=new ei({...t,color:e[s.type]});this._modificationGraphics.push(new ue({geometry:i,symbol:o}))}this.view.graphics.addMany(this._modificationGraphics)}_addMetaToLabeler(e,t){e.addNodeMeta(t,(s,i)=>this._createAttributes(s,i))}_contentVisibleChanged(e){e?(this.view.elevationProvider.register(this._elevationContext,this._elevationProvider),this._stage.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler)):(this._removeAllNodeDataFromStage(),this.view.elevationProvider&&this.view.elevationProvider.unregister(this._elevationProvider),this._stage.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler))}getLoadedAttributes(e){const t=this._nodeId2Meta.get(e);if(t?.attributeInfo!=null)return t.attributeInfo.loadedAttributes}getAttributeData(e){const t=this._nodeId2Meta.get(e);if(t?.attributeInfo!=null)return t.attributeInfo.attributeData}setAttributeData(e,t){const s=this._nodeId2Meta.get(e);s?.attributeInfo!=null&&(s.attributeInfo.attributeData=t,this._attributeValuesChanged(s))}async updateAttributes(e,t,s){const i=this._nodeId2Meta.get(e);i!=null&&(await this.i3sOverrides.applyAttributeOverrides(i.featureIds,t,s,this._controller.requiredAttributes),i.attributeInfo=t,this._controller.reschedule(()=>{this._nodeId2Meta.get(e)===i&&this._attributeValuesChanged(i)},s).catch(o=>{He(o)||O.getLogger(this).warn("Error while updating attribute values. Layer might not display correctly.",o)}))}_attributeValuesChanged(e){e.cachedRendererVersion=this._getInvalidRendererVersion(),e.appliedFilters=null,this._labeler!=null&&this._labeler.setNodeMetaAttributes(e,(t,s)=>this._createAttributes(t,s)),this._updateEngineObject(e)}clearMemCache(){this._memCache!=null&&this._memCache.clear(),this._addTasks.forEach(e=>e.allowMemCache=!1)}getVisibleNodes(){const e=new Array;return this._nodeId2Meta.forEach(t=>t!=null&&e.push(t.node)),e}getVisibleObbs(){const e=new Array;return this._nodeId2Meta.forEach(t=>t&&e.push(this._collection.getComponentObb(t.objectHandle))),e}getLoadedNodeIndices(e){this._nodeId2Meta.forEach((t,s)=>e.push(s)),this._nodeId2MetaReloading.forEach((t,s)=>e.push(s))}_preLoadBasis(){!he("disable-feature:i3s-basis")&&2&this.supportedTextureEncodings&&this.i3slayer.textureSetDefinitions?.some(e=>e.formats.some(t=>t.format==="basis"||t.format==="ktx2"))&&$e()}_getVertexBufferLayout(e,t){return Ci(js(this._getGeometryParameters({hasTexture:at(e.params.material),hasNormals:t.normal,hasRegions:t.uvRegion})))}_getObjectIdField(){return this.i3slayer.objectIdField||Fs}_getGlobalIdField(){return this.i3slayer.globalIdField}_findGraphicNodeAndIndex(e){const t=be(this.i3slayer.fieldsIndex,e.attributes,this._getObjectIdField());for(const s of this._nodeId2Meta.values()){const i=s?.featureIds.indexOf(t);if(i!=null&&i>=0)return{node:s.node,index:i}}return null}_getGraphicIndices(e,t){const s=this._nodeId2Meta.get(e.index);if(s==null)return[];const i=[],o=this._getObjectIdField(),d=this.i3slayer.fieldsIndex;for(const l of t){const h=be(d,l.attributes,o),c=s.featureIds.indexOf(h);c!==-1&&i.push(c)}return i}whenGraphicBounds(e){const t=this._findGraphicNodeAndIndex(e);if(!t)return Promise.reject();const s=this.getAABB(t.node.index,t.index);return s==null?Promise.reject():Promise.resolve({boundingBox:s,screenSpaceObjects:[]})}getAABBFromIntersectorTarget(e){return e.nodeIndex==null||e.componentIndex==null?null:this.getAABB(e.nodeIndex,e.componentIndex)}getAABB(e,t){const s=this._nodeId2Meta.get(e);if(s?.featureIds==null||t>=s.featureIds.length)return null;const i=s.objectHandle,o=Oe(t,this._collection,i,ne(24),0),d=this.view.renderSpatialReference,l=this.view.spatialReference;return Se(o,d,0,o,l,0)?Ee(o):null}whenGraphicAttributes(e,t){return ui(this.i3slayer,e,this._getObjectIdField(),t,()=>[...this._nodeId2Meta.values()].filter(At))}getGraphicFromIntersectorTarget(e,t){if(e.nodeIndex==null||e.componentIndex==null)return null;const s=this._nodeId2Meta.get(e.nodeIndex);if(s?.featureIds==null||e.componentIndex>=s.featureIds.length)return null;const i=this._createLayerGraphic(this._createAttributes(e.componentIndex,s));return i?t.defer?(t.defer(async()=>(i.geometry=(await Ae(async()=>{const{createMesh:o}=await Ve(()=>import("./meshUtils-DPfwf6VG-C6zSZU-V.js"),__vite__mapDeps([41,1,42,4,5,3,6,7,8,9,10,11,12,13,34,35,14,43,2,44,45,15,46,47,19,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,16,17,63,64,65,66,67,68,69,70]));return{createMesh:o}},xe([41,1,42,4,5,3,6,7,8,9,10,11,12,13,34,35,14,43,2,44,45,15,46,47,19,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,16,17,63,64,65,66,67,68,69,70]))).createMesh({layerView:this,nodeIndex:e.nodeIndex,featureIndex:e.componentIndex}),i)),null):i:null}_getCacheKey(e){return`${this._layerUrl}/v${zi}/${e}${this._cacheKeySuffix}`}_getCacheKeySuffix(){const e=this.view.renderSpatialReference;return e==null?tr:e===ls(e)?sr:this.i3slayer.spatialReference.equals(e)?er:e.wkid!=null?`@${e.wkid}`:null}_getMemCacheKey(e,t=this.elevationOffset){return e+"#"+t}get _idbCacheEnabled(){return!this._controller.disableIDBCache&&!this.hasModifications&&this.elevationOffset===0&&this._cacheKeySuffix!=null}loadCachedGPUData(e){return this._memCache!=null?this._memCache.pop(this._getMemCacheKey(e)):null}deleteCachedGPUData(e){e!=null&&this._deleteComponentObject(e)}_cacheGPUData(e,t=this.elevationOffset){if(this._memCache==null)return void this._deleteComponentObject(e);const s=this._controller.indexDepth-e.node.level;this._memCache.put(this._getMemCacheKey(e.node.index,t),e,s)}loadMissingTextures(e,t,s,i){const o=e?.filter((d,l)=>{if((d.usage&this.rendererTextureUsage)===0)return!1;if(t==null)return!0;const h=ks(d.encodings,this.supportedTextureEncodings),c=t[l];return!!(c?.data==null||h&&c.encoding!==h.encoding)})??[];return o.length===0?Promise.resolve(!1):s(o,i).then(d=>{let l=0;for(let h=0;h<e.length;h++)l<d.length&&d[l].id===e[h].id&&(t[h]=d[l],l++);return!0})}loadCachedNodeData(e,t,s){return this._idbCacheEnabled?this._idbCache.get(this._getCacheKey(e.id),t).then(i=>i==null?null:(i.globalTrafo=fe(i.globalTrafo),i.nodeVersion!==e.version?(this._idbCache.remove(this._getCacheKey(e.id)),null):(this.elevationInfo.mode===0&&(e.geometryObbInRenderSR=Z.fromData(i.geometryObbData)),this.loadMissingTextures(i.requiredTextures,i.textureData,s,t).then(o=>(o&&this._idbCache.initialized&&i.textureData!=null&&(i.byteSize=ot(i.transformedGeometry,i.textureData),i.textureData.every(nt)&&this._indexedDbSizeCheck(e,i)&&this._idbCache.put(this._getCacheKey(e.id),i).catch(d=>O.getLogger(this).warn(`Failed to update node with textures in IndexedDB cache: ${e.id}: ${d}`))),Ce(t),i))))):Promise.resolve(null)}addNode(e,t,s){return Qi(t)?t.geometryBuffer==null?(this._addNodeMeta(e.index,null),Promise.resolve()):this._addData(e,t.attributeDataInfo,()=>this._transformNode(e,t,s).then(i=>this._safeReschedule(()=>{if(i==null)return e.hasModifications=!1,this._addCachedNodeData(e,null,s);e.hasModifications=i.transformedGeometry.hasModifications;const{obb:o,componentOffsets:d,featureIds:l,anchorIds:h,anchors:c,transformedGeometry:u}=i,C=fe(i.globalTrafo),w=_e(lt,o.center.x,o.center.y,o.center.z);ts(w,w,C);const y=new Z(w,[o.extents.x,o.extents.y,o.extents.z],es(o.orientation.x,o.orientation.y,o.orientation.z,o.orientation.w));this.elevationInfo.mode===0&&(e.geometryObbInRenderSR=y),t.geometryData.componentOffsets=d,l&&(t.geometryData.featureIds=Array.from(l)),t.geometryData.anchorIds=h,t.geometryData.anchors=c;const x={nodeVersion:e.version,geometryData:t.geometryData,requiredTextures:t.requiredTextures,textureData:t.textureData,transformedGeometry:u,globalTrafo:C,geometryObbData:y.data,byteSize:ot(u,t.textureData)};if(this._idbCacheEnabled&&this._idbCache.initialized&&this._indexedDbSizeCheck(e,x)){const _=x.textureData!=null?x.textureData.map(b=>nt(b)?b:null):null;this._idbCache.put(this._getCacheKey(e.id),{...x,textureData:_}).catch(b=>O.getLogger(this).warn(`Failed to store node in IndexedDB cache: ${e.id}: ${b}`))}return this._addCachedNodeData(e,x,s)},s))):Promise.reject()}getElevationRange(e){const t=new we,s=this._controller,{index:i}=s;if(!i)return t;const{rootNode:o}=i;if(!o)return t;const d=this._nodeId2Meta,l=e[3],h=s.viewportQueries,c=this._planetRadiusInGlobalMode,{view:u}=this,{renderCoordsHelper:C}=u,w=C.referenceEllipsoid.radius,y=this._collection,x=_=>{const{childrenLoaded:b}=_;if(b===0)return!1;const g=h.getAndUpdateVisibilityObbInRenderSR(_);let f=null,m=-1;if(g){if(m=g.radius,!g.intersectSphereWithMBS(e,m))return!1}else f=h.getServiceMbsInRenderSR(_),f&&(m=f[3]);if(m>=0&&l>=1*m)return g!=null?Ie(t,g,c):f!=null&&f[3]>=0&&ht(t,f,c),!1;const I=ir;if(I.elevationRangeMin=1/0,I.elevationRangeMax=-1/0,(g!=null||f!=null)&&(g!=null?Ie(I,g,c):f!=null&&ht(I,f,c),I.elevationRangeMin>=t.elevationRangeMin&&I.elevationRangeMax<=t.elevationRangeMax))return!1;const R=d.get(_.index);if(R){const{geometryObbInRenderSR:F}=_;if(!F||F.intersectSphereWithMBS(e)){if(F&&l>0*F.radius)return Ie(t,F,c),!1;const{objectHandle:H}=R,M=y.getObjectTransform(H),oe=C.getAltitude(M.position);y.expandRangeWithComponentObjectElevationRange(H,oe,w,t)}}return b-(R?1:0)>0};return i.traverse(o,x),t}computeVisibilityObb(e){return _i(e,this.view.renderSpatialReference,this._controller.crsIndex,this.i3slayer.spatialReference,this.elevationOffset,this._modifications,this.view.renderCoordsHelper.sphericalPCPF)}_transformNode(e,t,s){const i=t.geometryData.geometries??[],o=new Array(i.length);for(let g=0;g<i.length;++g)o[g]=this._getVertexBufferLayout(i[g],t.geometryDescriptor);const d=this.i3slayer.normalReferenceFrame,l=t.normalReferenceFrame??d??"none",h=e.serviceMbsInIndexSR,c=this.elevationOffset,u=this._controller.crsIndex,C=this._controller.crsVertex,w=this.view.renderSpatialReference,y=gi(h,c,l,u,w),x=Ue(u,C),_=Ue(C,w);if(x==null||_==null)return Promise.resolve(null);const b={context:this.uid,geometryBuffer:t.geometryBuffer,geometryData:t.geometryData,geometryDescriptor:t.geometryDescriptor,layouts:o,globalTrafo:y,mbs:h,obbData:e.serviceObbInIndexSR?.data,elevationOffset:c,needNormals:this._controller.isMeshPyramid,normalReferenceFrame:l,indexToVertexProjector:x,vertexToRenderProjector:_};return this._workerHandle.invoke(b,s)}get _supportsNodeCrossFading(){return!this.view?.stage?.renderer.shadowsEnabled}get nodeCrossfadingEnabled(){return this._supportsNodeCrossFading&&(this.lodCrossfadeinDuration>0||this.lodCrossfadeoutDuration>0||this.lodCrossfadeUncoveredDuration>0)}get nodeFadeoutEnabled(){return this._supportsNodeCrossFading&&this.lodCrossfadeoutDuration>0}_setNewNodeOpacity(e){const t=this.nodeCrossfadingEnabled?0:this.fullOpacity;this._setNodeOpacity(e,t)}addCachedGPUData(e,t,s){if(this.elevationInfo.mode===0&&(e.geometryObbInRenderSR=this._collection.getComponentObb(t.objectHandle).clone()),!this._controller.isGeometryVisible(e))return void this._cacheGPUData(t);this._labeler!=null&&this._addMetaToLabeler(this._labeler,t);const i=e.index;this._addNodeMeta(i,t),this.updateNodeState(i,s),this._collection.setObjectVisibility(t.objectHandle,!0),this._updateMaterial(t),this._setNewNodeOpacity(t),this.elevationInfo.mode!==0&&this._ensureElevationTask().schedule(i),this._updateEngineObject(t),this._highlights?.objectCreated(t),this._treeDebugger!=null&&this._treeDebugger.update()}addCachedNodeData(e,t,s,i){return this._addData(e,s,()=>this._addCachedNodeData(e,t,i))}async deleteCachedNodeData(e){if(this._idbCacheEnabled)return this._idbCache.remove(this._getCacheKey(e))}async _addCachedNodeData(e,t,s){if(!this.contentVisible||!this._controller.isGeometryVisible(e))return void this._removeNodeStageData(e.index,this.elevationOffset,this._nodeId2MetaReloading);if(t==null)return void this._addNodeMeta(e.index,null);const i=this._addTasks.get(e.index),{geometryData:o,transformedGeometry:d}=t;await this.i3sOverrides.applyAttributeOverrides(o.featureIds,i.attributeInfo,s,this._controller.requiredAttributes);const l=t.textureData!=null?t.textureData.filter(E=>E!=null&&(E.usage&this.rendererTextureUsage)!==0):[];!he("disable-feature:i3s-basis")&&l.some(E=>E!=null&&(E.encoding===2||E.encoding===1))&&await $e(),e.memory=0;const{componentOffsets:h,geometries:c,featureIds:u,anchorIds:C,anchors:w}=o,y=this._collection,x=c[0],{layout:_,indices:b,interleavedVertexData:g,positionData:f,hasColors:m}=d,{material:I,geometryParameters:R}=this._materialParameters(x,_),F=h||new Uint32Array([0,b?b.length:g.byteLength/_[0].stride]),H=new Ns({data:g,count:g.byteLength/_[0].stride,layoutParameters:R},{positions:bs(f.data),indices:Cs(f.indices)},b,F),M=x.transformation?Yt(x.transformation):Jt(),oe=fe(t.globalTrafo);Qt(M,oe,M);const je=Zt(V(),M),Fe=Kt(Ge(),M),Ne=this.view.renderSpatialReference,De=this.view.basemapTerrain.spatialReference,le=Z.fromData(Ze(t.geometryObbData)).center,z=[1,1,1];hs(le,Ne,z,De)||O.getLogger(this).errorOnce("Unsupported coordinate system for IM overlay");const de=V();ge(le,Ne,de,De);const Pe=Ge();Xt(Pe,Fe);const J=V();Me(J,ss(J,le,je),Pe);const vt=de[0]-J[0]*z[0],It=de[1]-J[1]*z[1],ee=y.createObject(new cs(as(vt,It,z[0],z[1]),new us(je,Fe),Z.fromData(Ze(t.geometryObbData)),H,!this._isIntegratedMesh)),Ct=R.textureCoordinateType===2,{textures:Te,texturePromise:Mt}=this._initMaterialAndTextures(ee,I,l,Ct,e);e.memory+=this._memEstimateGeometryAdded(ee),e.memory+=Te.reduce((E,T)=>E+(T!=null?this._memEstimateTextureAdded(T):0),0);const wt=!!I.hasParametersFromSource,xt=I.alphaMode!=="blend"&&I.metallicRoughness.baseColorFactor[3]>=1,S=new $i(e,u,ee,this._getInvalidRendererVersion(),i.attributeInfo,{hasParametersFromSource:wt,isOpaque:xt},Te,C,w);i.meta=S,this._hasTextures||=t.requiredTextures?.some(({usage:E})=>!!(19&E))||!!e.resources.texture,this._hasData=!0,this._hasColors||=m,this.notifyChange("hasTexturesOrVertexColors");const Rt=this.slicePlaneEnabled;return Promise.all([this._addOrUpdateEdgeRendering(S),Mt]).then(([E,T])=>(this._addTasks.has(e.index)&&E?.updateObjectVisibility(S.objectHandle,!1).catch(k=>this._logEdgeViewError(k,this.i3slayer.title)),this._safeReschedule(()=>{const k=this._addTasks.get(e.index);if(!k)return;if(this._addNodeMeta(e.index,S),k.meta=null,!this.contentVisible)return void this._removeNodeStageData(e.index,this.elevationOffset);y.setObjectVisibility(ee,!0),E?.updateObjectVisibility(S.objectHandle,!0).catch(Ft=>this._logEdgeViewError(Ft,this.i3slayer.title)),S.attributeInfo=k.attributeInfo;const St=S.cachedRendererVersion!==this._rendererVersion,Et=Rt!==this.slicePlaneEnabled;this._updateElevationOffsets(S);const Ot=S.elevationOffsets;this._updateComponentData(S);const jt=this._applyFiltersToNode(S);(St||E!=null&&(Et||jt||Ot))&&this._addOrUpdateEdgeRendering(S),this._labeler!=null&&this._addMetaToLabeler(this._labeler,S),this._visibleGeometryChanged(S,0),this._highlights?.objectCreated(S),this._updateMaterial(S),this._setNewNodeOpacity(S),this._treeDebugger!=null&&this._treeDebugger.update()},s))).catch(E=>{const{meta:T,allowMemCache:k}=i;throw i.meta=null,T&&k?this._cacheGPUData(T):T&&this._deleteComponentObject(T),E})}_addNodeMeta(e,t){if(this._removeNodeStageData(e,this.elevationOffset,this._nodeId2MetaReloading),this._nodeId2Meta.has(e)){O.getLogger(this).error("Removing duplicated node");const s=this._nodeId2Meta.get(e);s&&(this._deleteComponentObject(s),this._updateFeatureIdCounts(s,-1))}else this._controller.updateLoadStatus(e,!0);t&&(t.lodCrossfadeProgress=null,this.nodeCrossfadingEnabled&&K(t.cachedEdgeMaterials,0),this._updateFeatureIdCounts(t,1)),this._nodeId2Meta.set(e,t),this.notifyChange("elevationRange")}_updateElevationOffsets(e){const t=this.view.renderSpatialReference,s=this._controller.crsIndex,i=this.elevationInfo,o=this.view.basemapTerrain,d=o.spatialReference,l=i.mode;if(t==null||d==null||l===0)return void(e.elevationOffsets=null);const h=this._collection.getObjectTransform(e.objectHandle);e.elevationOffsets=e.elevationOffsets??[];const c=lt,u=Ji,C=l===2,w=this.view.renderCoordsHelper,y=e.featureIds.length,x=(()=>{if(e.cachedElevationAnchors)return e.cachedElevationAnchors;const f=ne(3*y);e.cachedElevationAnchors=f;for(let m=0;m<y;m++){const I=3*m,R=e.anchorIds?.indexOf(m)??-1;e.anchors&&R>=0?(_e(c,e.anchors[3*R],e.anchors[3*R+1],e.anchors[3*R+2]),Q(c,c,bt(e.node.serviceMbsInIndexSR)),ge(c,s,c,d),f[I]=c[0],f[I+1]=c[1],f[I+2]=w.getAltitude(c)):(this._collection.getComponentAabb(e.objectHandle,m,u,!0),_e(c,(u[0]+u[3])/2,(u[1]+u[4])/2,u[2]),Me(c,c,h.rotationScale),Q(c,c,h.position),f[I+2]=w.getAltitude(c),ge(c,t,c,d),f[I]=c[0],f[I+1]=c[1])}return f})(),_=i.offset,b=e.elevationOffsets,g=(f,m)=>{const I=C?x[3*f+2]:0;b[f]=_+(m??0)-I};o.getElevations(x,y,g)}_ensureElevationTask(){return this._elevationTask!=null||(this._elevationTask=new re(this.view.resourceController.scheduler,e=>this._controller.updateElevationChanged(e,this.view.basemapTerrain.spatialReference)?.filterInPlace(t=>this._nodeId2Meta.get(t)!=null),e=>this._nodeElevationAlignmentChanged(this._nodeId2Meta.get(e)),()=>this.elevationInfo?.mode)),this._elevationTask}_elevationInfoChanged(e,t){const s=e.mode!==0,i=!!t&&t!==e&&t.mode!==0;this._intersectionHandler.updateElevationAlignState(s,this.view.state.viewingMode),s&&!i&&this._controller.removeAllGeometryObbs(),this._nodeId2Meta.forEach(o=>this._nodeElevationAlignmentChanged(o))}_nodeElevationAlignmentChanged(e){e!=null&&(this._updateElevationOffsets(e),this._updateComponentData(e),this._updateEdgeRendering(e),this._labeler!=null&&this._labeler.updateLabelPositions(e),this._updateSnappingSources(e,2),this._elevationProvider.notifyObjectChanged(this._collection.getComponentObb(e.objectHandle)))}_safeReschedule(e,t){return Ce(t),this._controller.reschedule(e,t)}_materialParameters(e,t){const s=e.params.material!=null?e.params.material:Gs(),i=t.some(l=>l.name==="uvRegion"),o=t.some(l=>l.name==="normalCompressed"),d=at(s);return{geometryParameters:this._getGeometryParameters({hasTexture:d,hasNormals:o,hasRegions:i}),material:s}}_initMaterialAndTextures(e,t,s,i,o){const d=this._stage.renderView,l=u=>{this._gpuMemoryEstimate-=u,this._texMemoryEstimate-=u,o.memory-=u},h=s.map(u=>Ls(u,t,i,d,this._compressionTracker,l));this._stage.addTextures(h);let c=null;return this._collection.updateMaterial(e,u=>{c=Us(u,t,h,s,this.view.stage.renderView.textures,{rendererTextureUsage:this.rendererTextureUsage,usePBR:this._usePBR,isIntegratedMesh:this._isIntegratedMesh,slicePlaneEnabled:this.slicePlaneEnabled,viewSpatialReference:this.view.spatialReference}),this._updateMaterialOverlay(u)}),{textures:h,texturePromise:c}}_getGeometryParameters(e){return new Ds(this._hasVertexColors,e.hasTexture?e.hasRegions?2:1:0,e.hasNormals,this._shadeNormals,this._applySSAO)}_addData(e,t,s){let i=this._addTasks.get(e.index);if(i)i.attributeInfo=t;else{const o=Pt();i=new Yi(t,null,o.promise),this._addTasks.set(e.index,i),s().then(o.resolve,o.reject).then(()=>this._addTasks.delete(e.index)).catch(d=>{throw this._addTasks.delete(e.index),d})}return i.promise}_clearAddTasks(){this._addTasks.forEach(e=>{e.meta!=null&&(this._cacheGPUData(e.meta),e.meta=null)}),this._addTasks.clear()}_clippingAreaChanged(){const e=this.view.renderSpatialReference,t=this.i3slayer.spatialReference,s=ae();this._renderClippingArea=ze(this.view.clippingArea,s,e)?s:null;const i=ae();this._layerClippingArea=ze(this.view.clippingArea,i,t)?i:null,this._filterChange(),this._controller&&this._controller.updateClippingArea(this.view.clippingArea),this._isIntegratedMesh&&this._modificationsChanged()}get hasGeometryFilter(){return!1}_geometryFilterChange(){const e=this.hasGeometryFilter;this._controller.geometryFilterChanged(e),this._applyFilters(e),this._assertFeatureIdNodeCounts(e)}_assertFeatureIdNodeCounts(e){e&&!this._featureIdCounts?(this._featureIdCounts=$(this._nodeId2Meta.values()),this._filteredIdCounts=$(this._nodeId2Meta.values(),1),this._weaklyRemovedIdCounts=$(this._nodeId2Meta.values(),2),this.addHandles(ie(()=>this._controller.updating,t=>{!t&&this._needFilterResolve&&(this.multiGeometryFilterResolve(),this._needFilterResolve=!1,this.notifyUpdate())},{sync:!0}),"updateFinished")):!e&&this._featureIdCounts&&(this._featureIdCounts=null,this._filteredIdCounts=null,this._weaklyRemovedIdCounts=null,this._mismatchShow=null,this._mismatchHide=null,this.removeHandles("updateFinished"),this._needFilterResolve=!1,this.notifyUpdate())}_updateFeatureIdCounts(e,t){this._featureIdCounts&&(this._needFilterResolve=!0,A(this._featureIdCounts,e.featureIds,t),A(this._filteredIdCounts,e.filteredIds,t),A(this._weaklyRemovedIdCounts,e.weaklyRemovedIds,t))}_updateFilteredIdCounts(e,t,s){this._filteredIdCounts&&(this._needFilterResolve=!0,A(this._filteredIdCounts,t,-1),A(this._filteredIdCounts,e.filteredIds,1),A(this._weaklyRemovedIdCounts,s,-1),A(this._weaklyRemovedIdCounts,e.weaklyRemovedIds,1))}_checkFeatureIdNodeCountInvariant(){const e=this._featureIdCounts!=null;if(this.hasGeometryFilter!==e&&O.getLogger(this).error("checkFeatureIdNodeCountInvariant()","LayerView should have feature id node counts if and only if it has a geometry filter",{layerView:this,hasNodeCounts:e}),!this._featureIdCounts||!this._filteredIdCounts)return;const t=$(this._nodeId2Meta.values());ce(this._featureIdCounts,t)||O.getLogger(this).error("checkFeatureIdNodeCountInvariant()","Incorrect _featureIdCounts",{layerView:this,counts:this._featureIdCounts,expected:t});const s=$(this._nodeId2Meta.values(),1);ce(this._filteredIdCounts,s)||O.getLogger(this).error("checkFeatureIdNodeCountInvariant()","Incorrect _filteredIdCounts",{layerView:this,counts:this._filteredIdCounts,expected:s});const i=$(this._nodeId2Meta.values(),2);ce(this._weaklyRemovedIdCounts,i)||O.getLogger(this).error("checkFeatureIdNodeCountInvariant()","Incorrect _weaklyRemovedIdCounts",{layerView:this,counts:this._weaklyRemovedIdCounts,expected:s})}multiGeometryFilterResolve(){if(!this._featureIdCounts||!this._filteredIdCounts)return;let e=null,t=null;for(const[s,i]of this._filteredIdCounts){const o=this._featureIdCounts.get(s);o!==i&&(i+(this._weaklyRemovedIdCounts?.get(s)??0)===o?(e??=new Set,e.add(s)):(t??=new Set,t.add(s)))}ke(e,this._mismatchShow)&&ke(t,this._mismatchHide)||(this._mismatchShow=e,this._mismatchHide=t,this._nodeId2Meta.forEach(s=>{if(!s?.filteredIds)return;const i=ct(s,this._mismatchShow,this._mismatchHide);this._collection.setAllComponentVisibilities(s.objectHandle,i),this._visibleGeometryChanged(s,2)}))}_filterChange(){this._applyFilters(this.hasGeometryFilter)}_applyFilters(e){this._filters=this.getFilters(),e?this._controller&&this._controller.requestUpdate():this._nodeId2Meta.forEach(t=>{t&&this._applyFiltersToNode(t)&&(this._addOrUpdateEdgeRendering(t),this._visibleGeometryChanged(t,2))})}getFilters(){const e=[],t=this._renderClippingArea;return t!=null&&e.push((s,i)=>this._boundingRectFilter(s,i,t)),e}addSqlFilter(e,t,s){if(t!=null){const i=t.fieldNames;e.push((o,d)=>this._sqlFilter(o,d,t,i,s))}}_sqlFilter(e,t,s,i,o){const d={},l=this._createLayerGraphic(d);if(!l)return;const h=this.i3slayer.objectIdField,c=t.featureIds,u=t.attributeInfo?.attributeData;i.every(C=>C===h||u?.[C]!=null)&&Xe(e,c,C=>{d[h]=c[C];for(const w of i)w!==h&&(d[w]=u?pe(u[w],C):null);try{return s.testFeature(l)}catch(w){return o(w),!1}})}_boundingRectNodeTest(e,t){return _s(e.node.serviceMbsInIndexSR,this._controller.crsIndex,rt,this.view.renderSpatialReference),fi(t,rt)}_boundingRectFeatureTest(e,t,s){return this._collection.getComponentAabb(e.objectHandle,t,st),ps(st,it),ys(s,it)}_boundingRectFilter(e,t,s){const i=this._collection,o=this._boundingRectNodeTest(t,s);if(o===3)return;if(o===0)return void(e.length=0);const d=i.getComponentCount(t.objectHandle);if(d.invisible+d.visible!==t.featureIds.length)return;const l=this._transformClippingArea(Wi,s,t.objectHandle);Xe(e,t.featureIds,h=>this._boundingRectFeatureTest(t,h,l))}_transformClippingArea(e,t,s){const i=this._collection.getObjectTransform(s),o=i.position,d=i.rotationScale;return e[0]=(t[0]-o[0])/d[0],e[1]=(t[1]-o[1])/d[4],e[2]=(t[2]-o[0])/d[0],e[3]=(t[3]-o[1])/d[4],e}async _addOrUpdateEdgeRendering(e,t=!0){const s=e.objectHandle,{hasEdges:i,perFeatureEdgeMaterials:o}=this._getFilteredEdgeMaterials(e);i&&!this._edgeView&&(this._edgeView=await this._stage.renderer.loadEdgeView());const d=this._edgeView;if(!d)return null;const l=d.hasObject(s);if(i){if(l)return this.nodeCrossfadingEnabled&&K(o,this.getNodeOpacity(e)),d.updateAllComponentMaterials(s,o,this.slicePlaneEnabled,t).catch(c=>this._logEdgeViewError(c,this.i3slayer.title)),d.updateObjectVisibility(s,!0).catch(c=>this._logEdgeViewError(c,this.i3slayer.title)),d.updateAllVerticalOffsets(s,e.elevationOffsets).catch(c=>this._logEdgeViewError(c,this.i3slayer.title)),d;const h=await this._collection.addEdges(s,d,o,this.slicePlaneEnabled,e.elevationOffsets);return e.edgeMemoryUsage=h,e.node.memory+=h,d}return l&&(e.node.memory-=e.edgeMemoryUsage,e.edgeMemoryUsage=0,d.removeObject(s)),null}_applyFiltersToNode(e){const{filteredIds:t,weaklyRemovedIds:s}=e,i=this._applyFiltersToNodeComponents(e);return this._updateFilteredIdCounts(e,t,s),i&&this._labeler?.applyFilterChange(e),i}_applyFiltersToNodeComponents(e){const t=this._collection,s=t.getComponentCount(e.objectHandle),i=e.filteredIds!=null,o=s.invisible===0;if(t.setAllComponentVisibilities(e.objectHandle,"all"),this._filters.length===0)return e.filteredIds=null,!o;if(e.filteredIds!=null&&e.appliedFilters===this._filters||(e.weaklyRemovedIds=null,e.filteredIds=rr(e,this._filters),e.appliedFilters=this._filters),i&&e.filteredIds===e.featureIds&&(!this._mismatchHide||e.filteredIds.every(l=>!this._mismatchHide?.has(l))))return!o;const d=ct(e,this._mismatchShow,this._mismatchHide);return t.setAllComponentVisibilities(e.objectHandle,d),!0}_removeAllNodeDataFromStage(e=this.elevationOffset){this._nodeId2Meta.forEach((t,s)=>this._removeNodeStageData(s,e)),this._nodeId2MetaReloading.forEach((t,s)=>this._removeNodeStageData(s,e,this._nodeId2MetaReloading)),this._elevationTask=j(this._elevationTask)}removeNode(e){const t=this.elevationOffset;this._removeNodeStageData(e,t),this._removeNodeStageData(e,t,this._nodeId2MetaReloading),this._elevationTask!=null&&this._elevationTask.remove(e)}_removeNodeStageData(e,t,s=this._nodeId2Meta){s.has(e)&&this._controller.updateLoadStatus(e,!1);const i=s.get(e);i!=null?(this._collection.setObjectVisibility(i.objectHandle,!1),this._edgeView!=null&&this._edgeView.hasObject(i.objectHandle)&&this._edgeView.updateObjectVisibility(i.objectHandle,!1).catch(o=>this._logEdgeViewError(o,this.i3slayer.title)),this._visibleGeometryChanged(i,1),this._labeler!=null&&this._labeler.removeNodeMeta(i),s.delete(e),this._highlights?.objectDeleted(i),s===this._nodeId2Meta?(this._updateFeatureIdCounts(i,-1),this._cacheGPUData(i,t),this.nodeCrossfadingEnabled&&this._crossfadeHelper.stopNodeFading(i)):this._deleteComponentObject(i),this._treeDebugger!=null&&this._treeDebugger.update()):s.delete(e)}_deleteComponentObject(e){if(this._edgeView!=null&&this._edgeView.removeObject(e.objectHandle),this._memEstimateGeometryRemoved(e.objectHandle),this._collection.destroyObject(e.objectHandle),e.textures)for(const t of e.textures)this._memEstimateTextureRemoved(t),this._stage.removeTexture(t)}updateNodeState(e,t){const s=this._nodeId2Meta.get(e);s!=null&&this._collection.updateMaterial(s.objectHandle,i=>i.polygonOffsetEnabled=t===0)}updateNodeIndex(e,t){if(this._nodeId2Meta.has(e)){const i=this._nodeId2Meta.get(e);this._nodeId2Meta.delete(e),this._nodeId2Meta.set(t,i),this.notifyChange("elevationRange")}const s=this._nodeId2MetaReloading.get(e);s&&(this._nodeId2MetaReloading.delete(e),this._nodeId2MetaReloading.set(t,s))}_invalidateAllSymbols(){this._rendererVersion=ye(this._rendererVersion,1),this._controller?.requestUpdate()}_getInvalidRendererVersion(){return ye(this._rendererVersion,-1)}async _rendererChange(e){if(this._currentRenderer=e,this.notifyChange("rendererTextureUsage"),this._rendererVersion=ye(this._rendererVersion,1),this._rendererFields=null,this._colorVariable=null,this._opacityVariable=null,this._invalidateAllSymbols(),e&&(this._rendererFields=await e.getRequiredFields(this.i3slayer.fieldsIndex)),this._updateSymbologyFields(),!this._arcade&&e&&"arcadeRequired"in e&&e.arcadeRequired&&(this._arcade=await Bs()),e&&"visualVariables"in e&&e.visualVariables)for(const t of e.visualVariables)t.type==="color"?this._colorVariable=t:t.type==="opacity"?this._opacityVariable=t:O.getLogger(this).warn(`Unsupported visual variable type for 3D Object Scene Services: ${t.type}`);if(e)for(const t of e.symbols)t.type!=="mesh-3d"&&O.getLogger(this).error(`Symbols of type '${t.type}' are not supported for 3D Object Scene Services.`);this._controller&&this._controller.requestUpdate()}_getCachedEdgeMaterials(e){return this._hasComponentData&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e),e.cachedEdgeMaterials}_getComponentParameters(e){this._hasComponentData&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e);const t=e.cachedSymbology;return(s,i)=>{const o=s*e.cachedSymbologyStride;Le(i.externalColor,t[o]/255,t[o+1]/255,t[o+2]/255,t[o+3]/255);const d=this._stage.renderView.olidRenderHelper;if(d){const l=e.featureIds[s],h=this.sublayerId?`${this.layerViewUid}_${this.sublayerId}`:this.layerViewUid,c=Ks(this.view,this.uid);d.setUidToObjectAndLayerId(l,l,this.layerId,h,this.layerPopupEnabledAndHasTemplate&&!c,e.node.resources.attributes,s,this.sublayerId),i.olidColor=d.getObjectAndLayerIdColor({graphicUid:l,layerViewUid:h})}i.externalColorMixMode=15&t[o+4],i.castShadows=!!(16&t[o+4]),i.pickable=!!(32&t[o+4]),i.elevationOffset=e.elevationOffsets?.[s]??0,i.emissiveStrength=e.emissiveStrengths?.[s]??1,i.emissiveSource=e.emissiveSources?.[s]??0}}_getSymbolInfo(e,t){const s=e?.getSymbol(t,{arcade:this._arcade});if(!(s instanceof Ys))return null;const i=s.id;if(this._symbolInfos.has(i))return this._symbolInfos.get(i);const o=mi(s);return this._symbolInfos.set(i,o),o}_setSymbologyOverride(e,t){this._symbologyOverride!==e&&(this._symbologyOverride=e,this._symbologyOverrideFields=t,this._invalidateAllSymbols(),this._updateSymbologyFields())}_updateSymbologyFields(){this._symbologyFields=this._symbologyOverrideFields!=null&&this._symbologyOverrideFields.length>0?this._rendererFields!=null&&this._rendererFields.length>0?$s(this.i3slayer.fieldsIndex,[...this._rendererFields,...this._symbologyOverrideFields]):this._symbologyOverrideFields:this._rendererFields}_updateCachedRendererData(e){if(e.cachedRendererVersion=this._rendererVersion,!this._hasComponentData)return;const t=this._tmpAttributeOnlyGraphic,s={};t.attributes=s;const i=this._currentRenderer,o=e.attributeInfo?.attributeData,d=e.featureIds?this.i3slayer.objectIdField:null,l=o!=null&&this._symbologyFields!=null&&this._symbologyFields.length>0;let h=null,c=null;if(l&&this._symbologyFields!=null){h=[],c=[];for(const g of this._symbologyFields){const f=o[g];f&&(h.push(g),c.push(f))}}e.cachedSymbology||(e.cachedSymbology=wi(e.featureIds.length*e.cachedSymbologyStride));const u=new Bi,C=this.fullOpacity,w=this.nodeCrossfadingEnabled?this.getNodeOpacity(e):C;let y=null,x=1,_=W,b=0;for(let g=0;g<e.featureIds.length;g++){if(d!=null&&(s[d]=e.featureIds[g]),l&&h)for(let M=0;M<h.length;M++)s[h[M]]=pe(c[M],g);const f=i?this._getSymbolInfo(i,t):null;let m,I;if(u.pickable=!0,i&&"visualVariables"in i){if(this._colorVariable){const M=qs(this._colorVariable,t,{color:Xi,arcade:this._arcade});M&&(m=u.color,m[0]=M.r/255,m[1]=M.g/255,m[2]=M.b/255,m[3]=M.a??1,this._opacityVariable||M.a===null||(I=M.a))}this._opacityVariable&&(I=Ws(this._opacityVariable,t,{arcade:this._arcade}))}if(f?.material){const M=f.material;m=m==null||I==null?We(m,I,M.color,M.alpha,tt,u.color):We(m,I,null,null,tt,u.color)}m??=Le(u.color,1,1,1,1);const R=f?.material;if(u.colorMixMode=R?.colorMixMode??1,u.edgeMaterial=f?.edgeMaterial,this._symbologyOverride?.(t,u),this._nodeColorOverride!=null&&(this._nodeColorOverride(e.node,m),u.colorMixMode=3),u.pickable&&=m[3]>=Be,u.castShadows=f?f.castShadows:u.pickable,u.edgeMaterial!=null){const M=m[3]>=1&&(e.material.isOpaque||u.colorMixMode===3)?1:0;u.edgeMaterial===y&&M===x||(_={...u.edgeMaterial,opacity:w,objectTransparency:M},y=u.edgeMaterial,x=M),e.cachedEdgeMaterials[g]=_}else e.cachedEdgeMaterials[g]=W;e.cachedSymbology[b++]=Math.round(255*m[0]),e.cachedSymbology[b++]=Math.round(255*m[1]),e.cachedSymbology[b++]=Math.round(255*m[2]),e.cachedSymbology[b++]=Math.round(255*m[3]),e.cachedSymbology[b++]=u.colorMixMode|+u.castShadows<<4|+u.pickable<<5;const F=R?.emissive?.strength??ve;F===ve||e.emissiveStrengths||(e.emissiveStrengths=new Array(e.featureIds.length).fill(ve)),e.emissiveStrengths&&(e.emissiveStrengths[g]=F);const H=R?.emissive?.source||0;H===0||e.emissiveSources||(e.emissiveSources=new Array(e.featureIds.length).fill(0)),e.emissiveSources&&(e.emissiveSources[g]=H)}}_getFilteredEdgeMaterials(e){const t=this._getCachedEdgeMaterials(e);this.nodeCrossfadingEnabled||K(t,this.fullOpacity);const s=e.filteredIds;if(s==null)return{hasEdges:t.some(l=>l!==W),perFeatureEdgeMaterials:t};let i=0,o=!1;const d=t.map((l,h)=>e.featureIds[h]!==s[i]?W:(o=o||l!==W,i++,l));return{hasEdges:o,perFeatureEdgeMaterials:d}}_updateComponentData(e){if(!this._hasComponentData)return;const t=e.objectHandle,s=this._getComponentParameters(e);this._collection.setComponentData(t,s),this._stage.renderView.requestRender()}_reloadAll(e=this.elevationOffset){this._removeAllNodeDataFromStage(e),this._controller!=null&&this._controller.restartNodeLoading()}_opacityChange(e){this.nodeCrossfadingEnabled&&this._crossfadeHelper.stopAllNodeFading(),this._nodeId2Meta.forEach(t=>{t!=null&&(this._collection.updateMaterial(t.objectHandle,s=>s.objectOpacity=e),K(t.cachedEdgeMaterials,e),this._updateEdgeRendering(t))})}_updateMaterial(e){this._collection.updateMaterial(e.objectHandle,t=>{t.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,t.usePBR=this._usePBR,this._updateMaterialOverlay(t)})}_updateMaterialOverlay(e){}_updateEngineObject(e){this._updateComponentData(e),this._applyFiltersToNode(e),this._addOrUpdateEdgeRendering(e),this._visibleGeometryChanged(e,2)}intersect(e,t,s,i){this._intersectionHandler.intersect(e,t,s,i,null,!1)}_slicePlaneEnabledChange(e){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=e),this._labeler!=null&&(this._labeler.slicePlaneEnabled=e),this._nodeId2Meta.forEach(t=>{t!=null&&(this._collection.updateMaterial(t.objectHandle,s=>s.commonMaterialParameters.hasSlicePlane=e),this._updateEdgeRendering(t,!1))})}_updatePBR(e){this._nodeId2Meta.forEach(t=>{t!=null&&this._collection.updateMaterial(t.objectHandle,s=>s.usePBR=e)}),this._hasLoadedPBRTextures=!0}get _usePBR(){return this._shadeNormals&&this.view.qualitySettings.physicallyBasedRenderingEnabled}_updateEdgeRendering(e,t=!0){this._edgeView!=null&&this._edgeView.hasObject(e.objectHandle)&&this._addOrUpdateEdgeRendering(e,t)}_forAllNodes(e){this._nodeId2Meta.forEach(e)}_ignoreClientNodeOverriddenFeatures(e){return this.i3sOverrides.hasGeometryChanges?(t,s,i)=>i.node.index>=0&&this.i3sOverrides.featureHasGeometryChanges(t)?1:e(t,s,i):e}_forAllFeatures(e,t,s){for(const i of this._nodeId2Meta.values()){if(i==null)continue;if(t!=null)switch(t(i.node.serviceMbsInIndexSR)){case 0:return;case 2:continue}let o=1;switch(s){case 1:o=this._forAllFeaturesOfNode(i,e);break;case 0:o=this._forAllVisibleFeaturesOfNode(i,e);break;case 2:o=this._forAllQueryableFeaturesOfNode(i,e)}if(o===0)return}}_forAllFeaturesOfNode(e,t){let s=1;const i=e.featureIds;for(let o=0;o<i.length;o++)if(s=t(i[o],o,e),s===0)return s;return s}_forAllVisibleFeaturesOfNode(e,t){let s=1;const i=e.featureIds;return this._collection.forEachVisibleComponent(e.objectHandle,o=>(s=t(i[o],o,e),s===1)),s}_forAllQueryableFeaturesOfNode(e,t){const s=this._ignoreClientNodeOverriddenFeatures(t);if(this._renderClippingArea==null)return this._forAllFeaturesOfNode(e,s);const i=this._boundingRectNodeTest(e,this._renderClippingArea);if(i===0)return 1;if(i===3)return this._forAllFeaturesOfNode(e,s);const o=1,d=e.featureIds,l=e.objectHandle,h=pi(this._renderClippingArea,this._collection.getObjectTransform(l));for(let c=0;c<d.length;c++){if(!this._boundingRectFeatureTest(e,c,h))continue;const u=s(d[c],c,e);if(u===0)return u}return o}_createAttributes(e,t){const s={};t.featureIds!=null&&(s[this._getObjectIdField()]=t.featureIds[e]);const i=t.attributeInfo?.attributeData;if(i!=null)for(const o of Object.keys(i))s[o]=pe(i[o],e);return s}_createGraphic(e,t){return this._createLayerGraphic(this._createAttributes(e,t))}highlight(e,t){const s=Ii(e);if(s.length===0)return Qe;const i=Mi(t),o=s[0]instanceof ue?this._featureIdsFromGraphics(s):typeof s[0]=="number"?s:null;if(!o)return Qe;const d=this._ensureHighlights(),{set:l,handle:h}=d.acquireSet(i);return d.setFeatureIds(l,o),h}_featureIdsFromGraphics(e){const t=this.i3slayer.fieldsIndex,s=this._getObjectIdField();return e.map(i=>be(t,i.attributes,s))}_ensureHighlights(){let e=this._highlights;return e||(e=new Pi({collection:this._collection,forAllFeatures:t=>this._forAllFeatures(t,null,1),forAllFeaturesOfNode:(t,s)=>this._forAllFeaturesOfNode(t,s)}),this._highlights=e),e}resetHighlights(){this._highlights=j(this._highlights)}_visibleGeometryChanged(e,t){this._elevationProvider&&(this._visibleGeometryChangedSchedulerHandle==null&&(this._visibleGeometryChangedSchedulerHandle=Tt(()=>{const{node:s}=e,i=s.visibilityObbInRenderSR??s.geometryObbInRenderSR??s.serviceObbInRenderSR;if(i!=null){const o=Y();i.toAaBoundingBox(o),this.emit("visible-geometry-changed",new xi(o))}else this.emit("visible-geometry-changed");this._visibleGeometryChangedSchedulerHandle=null})),this._updateSnappingSources(e,t),this._elevationProvider.notifyObjectChanged(this._collection.getComponentObb(e.objectHandle)))}get performanceInfo(){return new Ni(this.usedMemory,this._nodeId2Meta.size,Math.round(this._gpuMemoryEstimate/1048576),Math.round(this._geoMemoryEstimate/1048576),Math.round(this._texMemoryEstimate/1048576),Math.round(this.unloadedMemory/1048576),this._idbCacheEnabled?Math.round(100*this._idbCache.getHitRate()):0)}checkInvariants(){}get test(){}getNodeOpacityByIndex(e){const t=this._nodeId2Meta.get(e);return this.getNodeOpacity(t)}getNodeOpacity(e){return e!=null?this._collection.getMaterial(e.objectHandle).objectOpacity:0}isNodeFullyFadedIn(e){return this._crossfadeHelper.isNodeFullyFadedIn(e)}getNodeCrossfadeMetaData(e){return this._nodeId2Meta.get(e)}getNodeComponentHandle(e){return this._nodeId2Meta.get(e)?.objectHandle}markNodeToRemove(e){this._controller&&this._controller.markNodeToRemove(e)}removeMarkedNodes(){this._controller&&this._controller.removeMarkedNodes()}foreachCrossfadeNode(e){this._nodeId2Meta.forEach(e)}fadeNode(e,t,s){if(!this.nodeCrossfadingEnabled)return;const i=this._nodeId2Meta.get(e);i!=null&&this._crossfadeHelper.fadeNode(e,i,t,s)}setNodeOpacityByIndex(e,t){const s=this._nodeId2Meta.get(e);s!=null&&this._setNodeOpacity(s,t)}_setNodeOpacity(e,t){this._collection.updateMaterial(e.objectHandle,s=>s.objectOpacity=t),this._setNodeEdgeOpacity(e,t)}_setNodeEdgeOpacity(e,t){if(this._edgeView==null||!e.cachedEdgeMaterials)return;K(e.cachedEdgeMaterials,t);const s=e.objectHandle;this._edgeView.hasObject(s)&&this._edgeView.updateAllComponentOpacities(s,t).catch(i=>this._logEdgeViewError(i,this.i3slayer.title))}get hasModifications(){return this._isIntegratedMesh&&this._layerClippingArea!=null||this._modifications&&this._modifications.length>0}updateNodeModificationStatus(e){const t=e.length;if(!this.hasModifications||t<=0||this._i3sWasmLoaded!==!0)return;const s=this.uid,i=Zi(e);if(i){const o={context:s,buffer:i.buffer};oi(o);const d=new Float64Array(i.buffer);e.forAll((l,h)=>{const c=d[h],u=li(c);l.imModificationImpact=u,u!==0&&this._controller.invalidateGeometryVisibility(l.index)})}}notifyUpdate(){this.notifyChange("updating")}notifyLODUpdate(){this._controller.notifyLODUpdate()}isUpdating(){return!(!this._controller||!this._controller.updating)||!!this._visibleGeometryChangedSchedulerHandle||this._labeler!=null&&this._labeler.updating||this._crossfadeHelper?.updating||this._i3sWasmLoaded instanceof Promise||this._asyncModuleLoading>0||this._elevationTask!=null&&this._elevationTask.readyToRun||this._needFilterResolve||this._compressionTracker.compressing}trackSnappingSources(e){const t={events:e,fetchEdgeLocations:async(s,i,o)=>{const d=this._nodeId2Meta.get(s);if(d==null)throw new Error("invalid-node");const{origin:l,buffer:h}=await this._collection.extractEdgeInformation(d.objectHandle,i,o);return this._snappingLocationsApplyElevation(d,h,l),{type:"components",objectIds:d.featureIds,locations:h,origin:l}},remove:()=>ut(this._snappingSourcesTrackers,t)};return this._snappingSourcesTrackers.push(t),this._nodeId2Meta.forEach((s,i)=>{if(s==null)return;const o=this._controller.getRenderMbs(s.node);o&&e.add(i,o)}),t}_snappingLocationsApplyElevation(e,t,s){if(!e.elevationOffsets||this.elevationInfo.mode===0)return;const i=t.position0,o=t.position1,d=t.componentIndex,l=V(),h=V(),c=(u,C)=>{Q(u,u,s),this.view.renderCoordsHelper.worldUpAtPosition(u,h),Q(u,u,is(h,h,C)),rs(u,u,s)};for(let u=0;u<i.count;u++){const C=e.elevationOffsets[d.get(u)];i.getVec(u,l),c(l,C),i.setVec(u,l),o.getVec(u,l),c(l,C),o.setVec(u,l)}}_updateSnappingSources(e,t){const{index:s}=e.node,i=this._controller.getRenderMbs(e.node);if(i!=null)for(const o of this._snappingSourcesTrackers)t!==1&&t!==2||o.events.remove(s),t!==0&&t!==2||o.events.add(s,i)}_logEdgeViewError(e,t){He(e)||O.getLogger(this).warn("Error while processing edges. Edges on this layer might not display correctly",t,e)}_indexedDbSizeCheck(e,t){return t.byteSize>qi?(O.getLogger(this).warn(`Node is too big to store in IndexedDB cache: ${e.id} (${t.byteSize} bytes)`),!1):t.byteSize>0}get elevationProvider(){return this._elevationProvider}};return p([v()],n.prototype,"_hasLoadedPBRTextures",void 0),p([v()],n.prototype,"_asyncModuleLoading",void 0),p([v()],n.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),p([v()],n.prototype,"view",void 0),p([v()],n.prototype,"i3slayer",void 0),p([v()],n.prototype,"_controller",void 0),p([v()],n.prototype,"_labeler",void 0),p([v()],n.prototype,"updating",void 0),p([v()],n.prototype,"suspended",void 0),p([v()],n.prototype,"contentVisible",null),p([v({readOnly:!0})],n.prototype,"legendEnabled",null),p([v(Rs)],n.prototype,"updatingProgress",void 0),p([v()],n.prototype,"updatingProgressValue",null),p([v()],n.prototype,"hasTexturesOrVertexColors",null),p([v()],n.prototype,"rendererTextureUsage",null),p([v()],n.prototype,"elevationOffset",null),p([v()],n.prototype,"elevationInfo",null),p([v({type:Boolean})],n.prototype,"slicePlaneEnabled",void 0),p([v()],n.prototype,"supportedTextureEncodings",null),p([v({type:[zs]})],n.prototype,"_modifications",void 0),p([v({readOnly:!0})],n.prototype,"clientGeometry",null),p([v()],n.prototype,"elevationRange",null),p([v()],n.prototype,"fullExtent",null),p([v()],n.prototype,"_elevationTask",void 0),p([v({readOnly:!0})],n.prototype,"_usePBR",null),n=p([Re("esri.views.3d.layers.I3SMeshView3D")],n),n},st=Y(),it=ae(),Wi=ae(),Ki=new Z,Xi=new Wt([0,0,0,0]),rt=Ms(0,0,0,0);function at(r){if(r==null)return!1;const a=r.metallicRoughness;return a&&a.baseColorTextureId>=0||a&&a.metallicRoughnessTextureId>=0||r.normalTextureId>=0||r.emissiveTextureId>=0||r.occlusionTextureId>=0}function Qi(r){return"geometryData"in r}function nt(r){return r!=null&&gt(r.data)}function ot(r,a){let n=1024+r.interleavedVertexData.byteLength+(r.indices?r.indices.byteLength:0)+r.positionData.data.byteLength+r.positionData.indices.byteLength;if(a!=null)for(const e of a)e!=null&&gt(e.data)&&(n+=e.data.byteLength);return n}function Zi(r){if(r.length===0)return;const a=10*r.length,n=new Float64Array(a);let e=0;return r.forAll(t=>{let s=t.serviceObbInIndexSR;s==null&&(s=Ki,s.center=ws(t.serviceMbsInIndexSR,V()),s.halfSize=[t.serviceMbsInIndexSR[3],t.serviceMbsInIndexSR[3],t.serviceMbsInIndexSR[3]]);const i=s.data;n[e++]=i[0],n[e++]=i[1],n[e++]=i[2],n[e++]=i[3],n[e++]=i[4],n[e++]=i[5],n[e++]=i[6],n[e++]=i[7],n[e++]=i[8],n[e++]=i[9]}),n}class Yi{constructor(a,n,e){this.attributeInfo=a,this.meta=n,this.promise=e,this.allowMemCache=!0}}function K(r,a){r.forEach(n=>n.opacity=a)}class X{constructor(a,n){this.mode=a,this.offset=n}}const lt=V(),Ji=Y(),dt="elevation-change",er="",tr="@null",sr="@ECEF",se=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],ir=new we;function Ie(r,a,n){let e=r.elevationRangeMin,t=r.elevationRangeMax;const s=n;if(s>0){a.getCorners(se);for(const i of se){const o=yt(i)-s;e=Math.min(e,o),t=Math.max(t,o)}}else{a.getCorners(se);for(const i of se){const o=i[2];e=Math.min(e,o),t=Math.max(t,o)}}r.expandElevationRangeValues(e,t)}function ht(r,a,n){const e=bt(a),t=n>0?yt(e)-n:e[2],s=xs(a);r.expandElevationRangeValues(t-s,t+s)}function rr(r,a){const n=r.featureIds.slice();for(const e of a)if(e(n,r),n.length===0)break;return n.length===r.featureIds.length?r.featureIds:n}function ct(r,a,n){const e=new Array,t=r.filteredIds;if(t==null||a?.size||n?.size){if(t!=null){let s=0;r.featureIds.forEach((i,o)=>{if(t[s]===i)++s;else if(!a?.has(i))return;n?.has(i)||e.push(o)})}}else r.featureIds.forEach((s,i)=>{t[e.length]===s&&e.push(i)});return e}function A(r,a,n){if(r&&a)for(const e of a){const t=(r.get(e)??0)+n;t>0?r.set(e,t):r.delete(e)}}function $(r,a=0){const n=new Map;for(const e of r)A(n,a===0?e?.featureIds:a===1?e?.filteredIds:e?.weaklyRemovedIds,1);return n}export{ia as h,sa as t};
