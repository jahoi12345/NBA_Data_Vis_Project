import{c as U,x as ht,e as Pe,v as T,w as ut,af as ct,o as we,bz as pt,Y as g,H as _,G as Y,m as mt,z as ve,y as gt,i as ft}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{s as me}from"./Graphic-DgGzDmqW-d1CNicxz.js";import{C as _t,k as yt}from"./asyncUtils-w6KfWU41-HenJ0UOu.js";import{h as Ne,o as ge,f as ze,s as bt,i as St}from"./memoryEstimations-Bd726a_p-0cVCY2Jz.js";import{o as S,j as Re,i as xt,l as Pt}from"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import{l as wt}from"./screenUtils-BitdhK1O-L0FLPAMi.js";import{x as Je,O as vt,A as R,I as Nt,$ as Ce,k as zt,B as Rt,z as Ct,L as Ae}from"./vec32-CewSdTn3-VRto2OOh.js";import{_ as At}from"./vec3f32-WCVSSNPR-9V6Uhrx-.js";import{M as It,t as k}from"./collectionUtils-jDyktm0P-BDP2Oq99.js";import{z as Ot}from"./Extent-CgDMOSRD-Bod5LY6s.js";import{b as Mt}from"./Point-BfTTZoMu-DeJwQYfh.js";import{X as Ft}from"./projectBoundingSphere-B69Mxmv9-BDEAeDef.js";import{x as Et}from"./projectVectorToVector-Csv3NYZI-DpBtmQMN.js";import{l as H,v as $t,X as Ie,Z as je,U as kt,y as qt,M as fe,c as Vt,O as Dt}from"./aaBoundingBox-Cn49X7ge-BcYPaJ58.js";import{y as Qt,K as Ye}from"./plane-BNdSPG2o-DTV5z6SO.js";import{g as Lt,q as Wt,d as Ht,j as Bt}from"./sphere-DLQ6p7mp-DyEe1Vll.js";import{O as Gt}from"./OptimizedFeature-CwRGZPwv-Ddclhn0A.js";import{h as Ut}from"./QueryEngine-J0SYKhS8-C5yUyj6A.js";import{l as Tt,d as Jt}from"./Field-Cm_ZejYW-CwJZmSru.js";import{s as Oe}from"./lengthUtils-Dt1_RvOO-j3MEdmHu.js";import{c as jt}from"./FeatureSet-BF7daP96-B_JvMbY7.js";import{o as se}from"./Query-BlS0WPDF-jdXS_Qhy.js";import{a as Yt}from"./elevationInfoUtils-B8MpdRMP-CDlK86wO.js";import{u as Zt}from"./LayerView3D-JY0KVfxL-H13gXtj0.js";import{bo as Kt,bp as Xt,S as ei,ar as ti,d as ii,t as ri}from"./ShadowCastClear.glsl-CeOT_rAo-BEYyVrmo.js";import{f as si}from"./WorkerHandle-B930SiRy-DglEKt53.js";import{r as oi}from"./I3SQueryFeatureStore-B0E9P4O6-B-ZqNvqh.js";import{t as ni,r as ai}from"./I3SUtil-BtVE6TXz-Dtqhx7kO.js";import{z as li}from"./spatialReferenceEllipsoidUtils-D2JabnKt-Ce3ED0lc.js";import{z as di}from"./vec42-B8VM4vXb-B6OGOEI9.js";import{W as hi}from"./intersectorUtilsConversions-pLQPEbcN-Ck-nyNYa.js";import{O as Me,V as ui,Y as ci,N as pi,B as mi,F as gi,am as fi,aj as _i,ak as yi,al as bi,aU as Si,cJ as xi,q as Pi,ay as wi,bk as vi,f as Ni,n as zi,bQ as Fe,bl as Ri,bq as Ci,ca as J}from"./Texture-CFNZjV2R-CxGjQ8pI.js";import{$ as oe,l as Ze,V as Ee,n as E}from"./Emissions.glsl-B8XKMjLy-DXfiRNVX.js";import{v as Ai}from"./HUDIntersectorResult-1xTExS7z-dL9SFL6u.js";import{H as Ii}from"./index-B0z_nLWi.js";import{E as $e,R as Ke}from"./enums-B4pqBiXb-BO-3hS_8.js";import{h as Xe,u as Oi}from"./VertexElementDescriptor-BlxU8vCE-BwuKQkTU.js";import{F as Mi,T as Fi,R as Ei}from"./PointCloudWorkerUtil-NeuLSYI--CWtGefQb.js";import{u as $i,m as ke}from"./highlightUtils--bJgM-zK-C5dtE5Ia.js";import{j as ki}from"./PopupSceneLayerView-BZIYKvNy-ArkShuMv.js";import{d as ne}from"./orientedBoundingBox-BLEx7wLU-ByGP9QG1.js";import{t as qi}from"./LayerView-BnpxrRF8-Ca-QSx3a.js";import{t as Vi}from"./highlightOptionsUtils-Cdm0-Ad8-Cud-MHR_.js";import{C as Di}from"./layerViewUtils-BTa15X3o-BjQlX2q8.js";import{K as Qi,r as Li}from"./Scheduler-CNrsbccs-Bcg8fWoS.js";import{h as $}from"./mathUtils-PIGhLnI9-B1tKUlUb.js";import{E as Wi,o as Hi}from"./mat4-C96X-Nn0-BrMLOLCb.js";import{n as Bi}from"./mat4f64-q_b6UJoq-Dh6sWB_w.js";import{F as ae}from"./Polygon-D6wEPb3W-D2MPjRU4.js";import{o as Gi}from"./vec2f64-rIxtbMRN-Kai9mK1i.js";import"./getPopupProvider-CmskPttI-CzUWpGwk.js";import"./Color-CERqXxxY-BuYn26eI.js";import"./date-IqUzANpt-bLKO9IDT.js";import"./Layer-DZvC7bne-D3VLDrab.js";import"./Polyline-CoiTLswR-DTxpB2Yg.js";import"./typeUtils-DqrRcjBx-DZ6_Gsbu.js";import"./typeUtils-CXW_VpOn-BGgLp_TK.js";import"./lineMarkers-CDwLe3J6-CNUjJvs3.js";import"./PolygonSymbol3D-BXRHZiCQ-BjPAY2LA.js";import"./ExtrudeSymbol3DLayer-DSc1ou2x-CsVYZCeG.js";import"./Font-BwmnW7d2-Dwh3xjKw.js";import"./SimpleFillSymbol-CDawtd9z-CWD2KI2D.js";import"./SimpleMarkerSymbol-BGAFRS9_-CVQ5NLIA.js";import"./PictureMarkerSymbol-CaSh-vZk-xhjZ61bb.js";import"./TextSymbol-hRGhyDHs-CoS7dSjf.js";import"./projectionUtils-BGH_5_I3-DGwchVO8.js";import"./vector-B8ZDYGQ6-DRILJdcx.js";import"./quatf64-CCm9z-pX-CQ7_sSji.js";import"./vec4f64-DPb6J-GU-C7c2DqbZ.js";import"./normalizeUtils-85zLqeMi-C1bdAKNn.js";import"./normalizeUtilsCommon-CnhQye_A-UWhaH-kt.js";import"./LRUCache-fy84PBMi-Y56WPIvD.js";import"./WhereClause-BSVqskBz-CT_IXPhv.js";import"./UnknownTimeZone-B697BDFv-CBbtul7O.js";import"./fieldType-DVUzXtk_-tUuvnZJM.js";import"./FixedIntervalBinParameters-8snYOK8a-DXffLEh-.js";import"./NormalizationBinParametersMixin-BK9wNkI3-BKYeOhDN.js";import"./mat4f32-Djp3mnm5-DzYG3LYB.js";import"./intl-DRFqUect-DPhFaHB2.js";import"./ClassBreaksDefinition-BGOzyovZ-K0U0wKo_.js";import"./unitConversionUtils-4vB4Ezlp-DnY5MDxd.js";import"./modeUtils-BA-mAwuS-DSb1K26b.js";import"./sanitizerUtils-BT_8V5US-CWQWUwZQ.js";import"./workers-BEkgoq8Q-BM_Hz460.js";import"./PooledRBush-Dco5QkUp-DX3CMhf3.js";import"./GraphicsCollection-Bk6M0b7D-Dk6KdmO7.js";import"./HeightModelInfo-D5IdRvJ2-23y6MRiu.js";import"./RealisticTree.glsl-WN9nrQUl-QZiY3aPA.js";import"./BufferView-Cj2sQaht-avJ4OGB_.js";import"./InterleavedLayout-B7roQAzV-CdGz7mlm.js";import"./MeshLocalVertexSpace-BGd1IdEs-C0HJG4wR.js";import"./Indices-D0_UQPPr-t1Qev6md.js";import"./frustum-CMzahy3--B-DC1Co-.js";import"./TilemapCache-CjhKW_vj-8gKqgQfa.js";import"./UpdatingHandles-D2RI_3Hb-dwLPjVun.js";import"./Map-AEYszeHg-ZEOzAMWa.js";import"./Basemap-CL_uaRmk-O3l-dbYk.js";import"./PortalItem-DnxMlRVo-CI4Ns2_M.js";import"./writeUtils-DEFpwIW1-AHZYPaSV.js";import"./CollectionFlattener-D6h2Fkvj-WVl2BXw-.js";import"./resourceExtension-DOTCeiZj-C2WIbjQM.js";import"./PolygonCollection-HNNpnBH7-5UHgGprq.js";import"./ElevationQuery-DzlYa4L4-DkUTW9Ak.js";import"./TileInfo-Bz7QlefV-CdK7c8ef.js";import"./constants-D67WmGms-H7IOwEdB.js";import"./quat-B7J5v7rV-CZ9akUv-.js";import"./floatRGBA-D-Q4FzNN-DQhowfyr.js";import"./TileKey-C44YQC4_-BW7BBbYp.js";import"./vec2f32-CaVKkSa6-BjkBmyoj.js";import"./Octree-DckBBpQ7-CkRPu4UJ.js";import"./axisAngleDegrees-CjbXmycq-DcVVDR1-.js";import"./edgePreprocessing-D_eX-fWy-DqE-06Ss.js";import"./vec3-B_phcnZY-DHC7I6xa.js";import"./vec33-CWJeyzxV-Me4sF5XB.js";import"./PointCloudUniqueValueRenderer-7tgHeRs5-DZSH_eUF.js";import"./RendererLegendOptions-ByGHYLtx-Bwoo6l33.js";import"./ColorStop-De5gQTjr-C1lw16u9.js";import"./jsonUtils-CmpazY1u-6pDLj5sx.js";import"./createFeatureId-CVwTD0fV-3fKpJDrk.js";import"./reader-DcGs6kKN-DHJfK-tm.js";import"./SimpleObservable-CvFyr0NA-DXpoMYph.js";import"./projectPointToVector-DL7Z4uvb-CPbOlZdQ.js";import"./aaBoundingRect-CjwcS2F3-ri8bmh30.js";import"./DoubleArray-DExKNiTh-CvVpHySW.js";import"./featureConversionUtils-BDA_FXJx-CDxX1Wik.js";import"./OptimizedFeatureSet-BR8EEvDc-CgsRgxJh.js";import"./WhereClauseCache-B0L2SmwV-NVT3RoWW.js";import"./TimeOnly-BERR31kg-CQiLyUZi.js";import"./enum-BzLwmiID-CcyIdWlQ.js";import"./QueryEngineCapabilities-DJC_YILC-CshvWf3J.js";import"./quantizationUtils-Ceq-Uxsu-DjgKK_0s.js";import"./utils-CUk96PkC-CJv0qCOi.js";import"./heatmapUtils-B-AXnq0l-BF3Q_jd2.js";import"./utils-BbtW4lHb-D1wApKS_.js";import"./timeZoneUtils-BSc7-7qA-BAv3h8mh.js";import"./utils-BEeBypEk-DQLTC4jR.js";import"./SnappingCandidate-DGkpYqI6-CfPvDre4.js";import"./FieldsIndex-CimK-TqD--24JoCkp.js";import"./scaleUtils-yfx9kKWT-D9SVsyM-.js";import"./layerUtils-DZGhvm-W-CfyHx1TZ.js";import"./tagSymbols-BPcGfZon-BPcGfZon.js";import"./Queue-CYlrXMwB-CYJTUII-.js";import"./signal-BX9ezF8a-cf1Pn6io.js";import"./ReactiveMap-B0by2bYu-DCsCfMj5.js";import"./TablesMixin-Q80MT3nU-CBB9B-b6.js";import"./Cyclical-BLSxUpe7-Bj8R2Yk-.js";import"./computeTranslationToOriginAndRotation-Bjd4esRf-vJ4LbdOU.js";import"./dehydratedFeatures-Ql-uVzLq-aoK2987s.js";import"./DefaultLoadingContext-DXgBe4GE-Unnb_XgV.js";import"./wosrLoader-CIPfz1Cl-DlmQQkMX.js";import"./Version-BtYZEj58-LyRHDnSJ.js";import"./config-Dg972SSE-D9DBKeq5.js";import"./GeometryUtils-C354xUs0-BLAznQrw.js";import"./definitions-Dvg4hMIw-CdK2DzFN.js";import"./colorUtils-CeIi7j7j-C2WVx6th.js";import"./capabilities-Bi6C4OG6-CpURufko.js";import"./imageUtils-142g71N8-Wj0XNClb.js";import"./videoUtils-Dwx3AEgj-CduhpDRk.js";import"./uuid-Oe6SV2kF-IYX19xBA.js";import"./quickselect-QQC62dOK-Br2Ahhru.js";import"./meshVertexSpaceUtils-CtG7DPVT-kybwngCt.js";import"./Intersector-DS9YtyQY-DMoYp6i0.js";import"./TileKey-CXWFOqOI-Lra6v-mg.js";import"./loadAll-BCyxerwc-B4Lp8wGC.js";import"./opacityUtils-DuFH0EC9-DWspTgn2.js";import"./persistable-CdoDQOTR-BklJqWTn.js";import"./MD5-MtSiOt06-jWr180Yc.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw-DH8sdIsE.js";import"./utils-CylVuxNi--x86XOjU.js";import"./utils-Dpg4yj1D-CeFz2JVC.js";import"./types-BKo2foNY-DE0QfIFp.js";import"./labelUtils-BtizwBfq-Zegx4520.js";import"./ArcadeExpression-BlIRq-oN-VZkrwLVE.js";import"./featurePopupQueryUtils-CnnY2XPA-CIiZSoGi.js";import"./I3SBinaryReader-ZmgM2p_h-BnxBvCpV.js";import"./popupUtils-BKHMiD6K-CUN0lBkb.js";let Ui=class extends ii{constructor(e,t,i,r,s){super(e,t,-1,i,r),this.queue=s}},Ti=class{constructor(e,t,i,r){this.loading=e,this.indexLoading=t,this.processing=i,this.idleProcessing=r}},Ji=class extends si{constructor(e){super("PointCloudWorker","transform",{transform:t=>ji(t)},e)}};function ji(e){const t=[e.geometryBuffer];if(e.primaryAttributeData!=null&&e.primaryAttributeData.buffer&&t.push(e.primaryAttributeData.buffer),e.modulationAttributeData!=null&&e.modulationAttributeData.buffer&&t.push(e.modulationAttributeData.buffer),e.filterAttributesData!=null)for(const i of e.filterAttributesData)i!=null&&i.buffer&&t.push(i.buffer);for(const i of e.userAttributesData)i.buffer&&t.push(i.buffer);return t}function Yi(e,t,i){for(let s=0;s<t.length;s++)de[s]=!1,z[s]=null;for(let s=0;s<e.length;s++)le[s]=!1,N[s]=null;for(let s=0;s<t.length;s++){const o=qe(t[s],e,i);o>=0&&(de[s]=!0,N[o]!=null?N[o].push(t[s]):N[o]=[t[s]])}for(let s=0;s<e.length;s++){const o=qe(e[s],t,i);o>=0&&(le[s]=!0,z[o]!=null?z[o].push(e[s]):z[o]=[e[s]])}const r=[];for(let s=0;s<e.length;s++)N[s]!=null||le[s]||r.push({load:[],remove:[e[s]]});for(let s=0;s<t.length;s++)z[s]!=null||de[s]||r.push({load:[t[s]],remove:[]});for(let s=0;s<t.length;s++)z[s]!=null&&(z[s].length>1||z[s][0]!==t[s])&&r.push({load:[t[s]],remove:z[s]});for(let s=0;s<e.length;s++)N[s]!=null&&(N[s].length>1||N[s][0]!==e[s])&&r.push({load:N[s],remove:[e[s]]});return r}const le=[!1],N=[null],de=[!1],z=[null];function qe(e,t,i){let r=e;for(;r>0;){const s=t.indexOf(r);if(s>=0)return s;r=i.getParentId(r)}return t.indexOf(r)}function Zi(e,t,i){return e.sort((r,s)=>{if(r.load.length===0&&s.load.length===0)return 0;if(r.load.length===0)return-1;if(s.load.length===0)return 1;if(r.remove.length===0&&s.remove.length===0){const o=i.getRenderObb(r.load[0]).center,n=i.getRenderObb(s.load[0]).center;return R(o,t)-R(n,t)}if(r.remove.length===0)return-1;if(s.remove.length===0)return 1;if(r.load.length===1&&s.load.length===1){const o=i.getRenderObb(r.load[0]).center,n=i.getRenderObb(s.load[0]).center;return R(o,t)-R(n,t)}if(r.load.length===1)return-1;if(s.load.length===1)return 1;{const o=i.getRenderObb(r.remove[0]).center,n=i.getRenderObb(s.remove[0]).center;return R(o,t)-R(n,t)}})}function Ki(e,t,i){for(let r=0;r<e.length;++r){const s=e[r];s.load.length>t&&s.remove.length===1&&Xi(e,s,i)}}function Xi(e,t,i){const r=[t.remove[0]],s=[];for(;r.length===1;){const o=r.pop();s.length=0;for(let n=0;n<t.load.length;n++){let a=t.load[n],l=i.getParentId(a);for(;l!==o;)a=l,l=i.getParentId(a);let h=r.indexOf(a);h<0&&(h=r.length,r.push(a),s.push([])),s[h].push(t.load[n])}}t.load=r;for(let o=0;o<r.length;o++)s[o].length>1?e.push({remove:[r[o]],load:s[o]}):r[o]=s[o][0]}let er=class{constructor(e,t,i){this._pages=[],this.pageSize=0,this._nodeSR=e,this._renderSR=t,this._renderSRSphericalPCPF=li(t),this.pageSize=i}addPage(e,t,i=0){for(;this._pages.length<e;)this._pages.push(null);ir(t,this._nodeSR,this._renderSR,i,this._renderSRSphericalPCPF),this._pages[e]={nodes:t,parents:new Uint32Array(this.pageSize)},rr(this._pages,this.pageSize)}hasPage(e){return!!this._pages[e]}getNode(e){const t=this.pageSize;return this._pages[v(e,t)].nodes[q(e,t)]}getRenderObb(e){const t=this.pageSize;return this._pages[v(e,t)].nodes[q(e,t)].obbInRenderSR}setRenderObb(e,t){const i=this.pageSize;this._pages[v(e,i)].nodes[q(e,i)].obbInRenderSR.copy(t)}getParentId(e){const t=this.pageSize;return this._pages[v(e,t)].parents[q(e,t)]}hasNodes(e,t){const i=v(e,this.pageSize),r=v(e+t-1,this.pageSize);for(let s=i;s<=r;s++)if(this._pages[s]==null)return!1;return!0}forEachNodeId(e){for(let t=0;t<this._pages.length;t++){const i=this._pages[t];if(i)for(let r=0;r<i.nodes.length;r++)e(t*this.pageSize+r)}}createVisibilityTraverse(){const e={index:this,queue:[],masks:[],tempAabb:H()};return(t,i)=>tr(e,t,i)}};function tr(e,t,i){const r=e.index;if(!r.hasNodes(0,1))return;const s=e.queue;s.length=0,s.push(0);const o=e.masks;for(o.length=0,o.push(0);s.length>0;){const n=s.pop();let a=o.pop();const l=r.getNode(n),h=r.getRenderObb(n);let d=!0;if(t.clippingBox!=null){const u=1<<t.frustum.length;(a&u)===0&&(h.toAaBoundingBox(e.tempAabb),je(t.clippingBox,e.tempAabb)?a|=u:Dt(t.clippingBox,e.tempAabb)||(d=!1))}for(let u=0;u<t.frustum.length&&d;u++){const p=1<<u;if((a&p)===0){const y=h.intersectPlane(t.frustum[u]);y>0?d=!1:y<0&&(a|=p)}}if(i.predicate(n,l,d)){const u=l.firstChild,p=l.childCount;let y=!1;const P=v(u,r.pageSize),f=v(u+p-1,r.pageSize);for(let m=P;m<=f;m++)if(!r.hasPage(m)){i.pageMiss(n,m),y=!0;break}if(!y)for(let m=0;m<p;m++)s.push(u+m),o.push(a)}}}function ir(e,t,i,r,s){for(let o=0;o<e.length;o++){const n=e[o];n.obb.transform(n.obbInRenderSR,t,i,r,s)}}function rr(e,t){const i=[0];for(;i.length;){const r=i.pop(),s=e[v(r,t)].nodes[q(r,t)];for(let o=0;o<s.childCount;o++){const n=s.firstChild+o;e[v(n,t)]!=null&&(e[v(n,t)].parents[q(n,t)]=r,i.push(n))}}}function v(e,t){return e/t|0}function q(e,t){return e%t}let W=class extends me{constructor(e){super(e),this.pointCloudMetadata=null}};g([_({constructOnly:!0,clonable:"reference"})],W.prototype,"pointCloudMetadata",void 0),W=g([Y("esri.views.3d.layers.i3s.PointCloudGraphic")],W);let sr=class{constructor(e){this._context=e,this._highlights=new Map}get empty(){return this._highlights.size===0}destroy(){this._highlights=null}add(e,t){const i=new or(e,t),r=this._highlights.get(t);return r?r.add(i):this._highlights.set(t,new Set([i])),this._enableSet(i),ft(()=>this._removeSet(i))}_removeSet(e){this._disableSet(e);const{highlightName:t}=e.id,i=this._highlights.get(t);i&&(i.delete(e),i.size===0&&this._highlights.delete(t))}_enableSet(e){e.enabled||(e.enabled=!0,this._context.forEachNode(t=>this._enableSetForNode(e,t)))}_enableSetForNode(e,t){if(!e.enabled)return;const i=e.ids.get(t.id);i&&i.forEach(r=>this._context.addHighlight(t,r,e.id))}_disableSet(e){e.enabled&&(e.enabled=!1,this._context.forEachNode(t=>this._disableSetForNode(e,t)))}_disableSetForNode(e,t){e.enabled||this._context.removeHighlight(t,e.id)}nodeAdded(e){this._forEachSet(t=>this._enableSetForNode(t,e))}nodeRemoved(e){this._forEachSet(t=>this._disableSetForNode(t,e))}removeAll(){this._forEachSet(e=>this._disableSet(e))}_forEachSet(e){this._highlights.forEach(t=>t.forEach(e))}has(e){return this._highlights.has(e)}},or=class{constructor(e,t){this.ids=new Map,this.enabled=!1;for(const i of e)i!=null&&this._add(i.nodeId,i.pointId);this.id=new Pi(t)}_add(e,t){const i=this.ids.get(e);i?i.add(t):this.ids.set(e,new Set([t]))}};class ye extends ui{constructor(){super(...arguments),this.clipBox=H(fe),this.useFixedSizes=!1,this.useRealWorldSymbolSizes=!1,this.scaleFactor=1,this.minSizePx=0,this.size=0,this.sizePx=0}get fixedSize(){return this.drawScreenSpace?this.sizePx:this.size}get screenMinSize(){return this.useFixedSizes?0:this.minSizePx}get drawScreenSpace(){return this.useFixedSizes&&!this.useRealWorldSymbolSizes}}class be extends xi{constructor(t,i,r){super(t),this.origin=t,this.isLeaf=i,this.splatSize=r}}function et(e){const t=new wi,i=Ze(e.output),{vertex:r,fragment:s}=t;return t.vertex.include(vi,e),t.attributes.add("position","vec3"),t.attributes.add("color","vec3"),r.uniforms.add(new Ni("modelView",(o,n)=>Wi(Ve,n.camera.viewMatrix,Hi(Ve,o.origin))),new zi("proj",o=>o.camera.projectionMatrix),new Fe("screenMinMaxSize",(o,n,a)=>ae(he,a.useFixedSizes?0:a.minSizePx*n.camera.pixelRatio,Z(o.isLeaf)*n.camera.pixelRatio)),e.useFixedSizes?new Ri("pointScale",(o,n)=>ae(he,o.fixedSize*n.camera.pixelRatio,n.camera.fullHeight)):new Fe("pointScale",(o,n,a)=>ae(he,o.splatSize*a.scaleFactor*n.camera.pixelRatio,n.camera.fullHeight/n.camera.pixelRatio))),e.clippingEnabled?r.uniforms.add(new Ee("clipMin",(o,n,a)=>Ae(De,a.clipBox[0]-o.origin[0],a.clipBox[1]-o.origin[1],a.clipBox[2]-o.origin[2])),new Ee("clipMax",(o,n,a)=>Ae(De,a.clipBox[3]-o.origin[0],a.clipBox[4]-o.origin[1],a.clipBox[5]-o.origin[2]))):(r.constants.add("clipMin","vec3",[-$,-$,-$]),r.constants.add("clipMax","vec3",[$,$,$])),i&&t.varyings.add("vColor","vec3"),r.main.add(E`
    // Move clipped points outside of clipspace
    if (position.x < clipMin.x || position.y < clipMin.y || position.z < clipMin.z ||
      position.x > clipMax.x || position.y > clipMax.y || position.z > clipMax.z) {
      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
      gl_PointSize = 0.0;
      return;
    }

    if (rejectBySlice(position)) {
      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
      gl_PointSize = 0.0;
      return;
    }

    // Position in camera space
    vec4 camera = modelView * vec4(position, 1.0);

    float pointSize = pointScale.x;
    vec4 position = proj * camera;
    ${e.drawScreenSize?E`float clampedScreenSize = pointSize;`:E`float pointRadius = 0.5 * pointSize;
           vec4 cameraOffset = camera + vec4(0.0, pointRadius, 0.0, 0.0);
           vec4 positionOffset = proj * cameraOffset;
           float radius = abs(positionOffset.y - position.y);
           float viewHeight = pointScale.y;
           // screen diameter = (2 * r / w) * (h / 2)
           float screenPointSize = (radius / position.w) * viewHeight;
           float clampedScreenSize = clamp(screenPointSize, screenMinMaxSize.x, screenMinMaxSize.y);
           // Shift towards camera, to move rendered point out of terrain i.e. to
           // the camera-facing end of the virtual point when considering it as a
           // 3D sphere.
           camera.xyz -= normalize(camera.xyz) * pointRadius * clampedScreenSize / screenPointSize;
           position = proj * camera;`}

    gl_PointSize = clampedScreenSize;
    gl_Position = position;
    ${i?E`vColor = color;`:""}`),t.include(Ci,e),s.main.add(E`
    vec2 vOffset = gl_PointCoord - vec2(0.5, 0.5);
    float r2 = dot(vOffset, vOffset);

    if (r2 > 0.25) {
      discard;
    }
    calculateOcclusionAndOutputHighlight();
    ${i?E`fragColor = vec4(vColor, 1.0);`:""}`),t}function Z(e){return e?256:64}const Ve=Bi(),De=k(),he=Gi(),nr=Object.freeze(Object.defineProperty({__proto__:null,PointRendererDrawParameters:be,PointRendererPassParameters:ye,build:et,getMaxPointSizeScreenspace:Z},Symbol.toStringTag,{value:"Module"}));class ar extends pi{constructor(t,i){super(t,i,new mi(nr,()=>Ii(()=>Promise.resolve().then(()=>br),void 0)),Oi(lr))}initializePipeline(t){return gi({depthTest:{func:513},depthWrite:Si,colorWrite:bi,stencilWrite:t.hasOccludees?yi:null,stencilTest:t.hasOccludees?_i:null,drawBuffers:fi(t.output)})}}const tt=[new Xe("position",3,Ke.FLOAT,0,12)],it=[new Xe("color",3,Ke.UNSIGNED_BYTE,0,3,!0)],lr=tt.concat(it);let L=class extends ci{constructor(){super(...arguments),this.drawScreenSize=!1,this.useFixedSizes=!1,this.hasOccludees=!1,this.clippingEnabled=!1,this.draped=!1}};g([J()],L.prototype,"drawScreenSize",void 0),g([J()],L.prototype,"useFixedSizes",void 0),g([J()],L.prototype,"hasOccludees",void 0),g([J()],L.prototype,"clippingEnabled",void 0);let j=class extends ei{constructor(e){super(e),this.type=6,this.isGround=!1,this._passParameters=new ye,this._highlights=new sr({forEachNode:t=>this.forEachNode(t),addHighlight:(t,i,r)=>this._addHighlight(t,i,r),removeHighlight:(t,i)=>this._removeHighlight(t,i)}),this.produces=new Map([[2,t=>!(oe(t)||t===9&&this._highlights.empty)],[3,t=>oe(t)]]),this.point=k(),this.intersectionRayDir=k(),this.intersectionPlane=Ye(),this.nodeOriginOffset=k(),this.nodeBoundingBox=H(),this.layerViewUid="",this._slicePlaneEnabled=!1,this._configuration=new L,this._nodes=new mt}destroy(){this._nodes.prune()}hasHighlight(e){return this._highlights.has(e)}initializeRenderContext(e){this._context=e,e.requestRender()}uninitializeRenderContext(){}intersect(e,t,i,r){const{point:s,intersectionRayDir:o,nodeOriginOffset:n,intersectionPlane:a,layerViewUid:l,nodeBoundingBox:h}=this,d=Wt(i,r),u=e.camera.perScreenPixelRatio/2,p=e.camera.near;Ce(o,r,i);const y=1/Je(o);zt(o,o,y);const P=k();Rt(P,o),di(a,o[0],o[1],o[2],-R(o,i));const f=new ce,m=new ce,I=new Array,O=H(this._passParameters.clipBox);Ie(O,-i[0],-i[1],-i[2],O),this._nodes.forAll(c=>{const{isLeaf:x,coordinates:C}=c,A=c.splatSize*this._passParameters.scaleFactor;let X=c.obb.minimumDistancePlane(a),D=c.obb.maximumDistancePlane(a);X-=ue(A,X+p,this._passParameters,u,x),D-=ue(A,D+p,this._passParameters,u,x);const rt=D<0,st=f.dist!=null&&m.dist!=null&&f.dist<X*y&&m.dist>D*y;if(rt||st)return;const G=_e(A,D+p,this._passParameters,u,x),ot=Ht(c.obb.center,c.obb.radius+G);if(!Bt(ot,d,null)||!c.obb.intersectRay(i,o,G))return;const nt=G*G;c.obb.toAaBoundingBox(h),Ie(h,-i[0],-i[1],-i[2],h);const at=!je(O,h);Ce(n,c.origin,i);const lt=C.length/3;for(let M=0;M<lt;M++){const ee=3*M;if(s[0]=n[0]+C[ee],s[1]=n[1]+C[ee+1],s[2]=n[2]+C[ee+2],at&&!kt(O,s))continue;const Q=R(s,o),dt=Q*Q,Se=Ct(s)-dt;if(Se>nt)continue;let te=Q+p;const ie=ue(A,te,this._passParameters,u,x);if(Q-ie<0)continue;te-=ie;const xe=_e(A,te,this._passParameters,u,x);if(Se>xe*xe)continue;const F=(Q-ie)*y,re=w=>(w.point=w.point?Qe(c,M,w.point):Qe(c,M),w.dist=F,w.normal=P,w.node=c,w.pointId=M,w.layerViewUid=l,w);if((f.dist==null||F<f.dist)&&(t==null||t(i,r,F))&&re(f),e.options.store!==0&&(m.dist==null||F>m.dist)&&(t==null||t(i,r,F))&&re(m),e.options.store===2&&(t==null||t(i,r,F))){const w=new ce;I.push(re(w))}}});const K=c=>{const{layerViewUid:x,node:C,pointId:A}=c;return new hi(c.point,x,A,()=>this.createGraphic(C,A,c.point))},V=(c,x)=>{const C=K(x);c.set(this.type,C,x.dist,x.normal)};if(Le(f)){const c=e.results.min;(c.distance==null||f.dist<c.distance)&&V(c,f)}if(Le(m)&&e.options.store!==0){const c=e.results.max;(c.distance==null||m.dist>c.distance)&&V(c,m)}if(e.options.store===2)for(const c of I){const x=new Ai(d);V(x,c),e.results.all.push(x)}}acquireTechniques(e){const t=e.output===9;return this._nodes.length!==0&&(Ze(e.output)||oe(e.output)&&e.bind.slot===3||t)?(this._nodes.forAll(i=>this._initNode(e,i)),this._configuration.drawScreenSize=this._passParameters.drawScreenSpace,this._configuration.useFixedSizes=this._passParameters.useFixedSizes,this._configuration.hasSlicePlane=this._slicePlaneEnabled,this._configuration.hasOccludees=e.bind.hasOccludees,this._configuration.clippingEnabled=this._clippingEnabled,this._configuration.hasHighlightMixTexture=t&&e.bind.highlightMixTexture!=null,this._configuration.output=e.output,this._context.techniques.get(ar,this._configuration)):null}render(e,t){const{rctx:i,bind:r,output:s}=e,o=i.bindTechnique(t,r,this._passParameters),n=s===9,a=r.highlight?.name??null;n&&!a||this._nodes.forAll(l=>{l.coordinates.length===0||l.vao==null||n&&!l.highlightMap.has(a)||(o.assertCompatibleVertexAttributeLocations(l.vao),o.bindDraw(r,this._passParameters,l),i.bindVAO(l.vao),n?this._renderHighlightFragments(e,l):i.drawArrays($e.POINTS,0,l.coordinates.length/3))})}_renderHighlightFragments(e,t){const{highlightMap:i}=t,{rctx:r,bind:s}=e,{highlight:o}=s;if(!o)return;const n=o.name,a=i.get(n);if(!a||a.length===0)return;const{highlightOrderMap:l,highlightLevel:h}=s;if(h==null)return;for(const f of i.keys())if(f!==n){const m=l.get(f);if(m!==void 0&&m>h)return}let d=0,u=a[0].componentIndex,p=u+1;const y=()=>{for(;d<a.length&&a[d].id.highlightName!==n;)u=a[d].componentIndex,++d;p=u+1};y();const P=(f,m)=>{const I=m-f;I>0&&r.drawArrays($e.POINTS,f,I)};for(;d<a.length;){const f=a[d];if(f.id.highlightName!==n){P(u,p),++d,y();continue}const m=f.componentIndex;m!==p&&(P(u,p),u=m),p=m+1,++d}P(u,p)}set useFixedSizes(e){this._passParameters.useFixedSizes!==e&&(this._passParameters.useFixedSizes=e,this._requestRender())}get useFixedSizes(){return this._passParameters.useFixedSizes}set scaleFactor(e){this._passParameters.scaleFactor!==e&&(this._passParameters.scaleFactor=e,this._requestRender())}get scaleFactor(){return this._passParameters.scaleFactor}set minSizePx(e){this._passParameters.minSizePx!==e&&(this._passParameters.minSizePx=e,this._requestRender())}get minSizePx(){return this._passParameters.minSizePx}set useRealWorldSymbolSizes(e){this._passParameters.useRealWorldSymbolSizes!==e&&(this._passParameters.useRealWorldSymbolSizes=e,this._requestRender())}get useRealWorldSymbolSizes(){return this._passParameters.useRealWorldSymbolSizes}set size(e){this._passParameters.size!==e&&(this._passParameters.size=e,this._requestRender())}get size(){return this._passParameters.size}set sizePx(e){this._passParameters.sizePx!==e&&(this._passParameters.sizePx=e,this._requestRender())}get sizePx(){return this._passParameters.sizePx}set clippingBox(e){qt(this._passParameters.clipBox,e||fe)}get _clippingEnabled(){return!Vt(this._passParameters.clipBox,fe,(e,t)=>e===t)}get slicePlaneEnabled(){return this._slicePlaneEnabled}set slicePlaneEnabled(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._requestRender())}addNode(e){this._nodes.push(e),this._highlights.nodeAdded(e),this._requestRender()}removeNode(e){let t=null;return this._nodes.filterInPlace(i=>i.id!==e||(t=i,i.vao=ve(i.vao),this._highlights.nodeRemoved(i),!1)),this._requestRender(),t}forEachNode(e){this._nodes.forEach(e)}removeAll(){this._nodes.forAll(e=>e.vao=ve(e.vao)),this._highlights.removeAll(),this._nodes.clear(),this._requestRender()}highlight(e,t){return this._highlights.add(e,t)}_addHighlight(e,t,i){e.addHighlight(t,i),this._requestRender()}_removeHighlight(e,t){e.removeHighlight(t),this._requestRender()}_initNode(e,t){t.vao??=new ti(e.rctx,new Map([["positions",new Me(e.rctx,tt,t.coordinates)],["colors",new Me(e.rctx,it,t.rgb)]]))}_requestRender(){this._context&&this._context.requestRender()}};function _e(e,t,i,r,s){if(i.drawScreenSpace)return i.fixedSize*t*r;const o=Z(s)*t*r;return i.useFixedSizes?Math.min(i.fixedSize/2,o):i.screenMinSize>0?Math.min(Math.max(i.screenMinSize*t*r,e/2),o):Math.min(e/2,o)}function ue(e,t,i,r,s){return i.drawScreenSpace?0:_e(e,t,i,r,s)}function Qe(e,t,i=k()){return i[0]=e.origin[0]+e.coordinates[3*t],i[1]=e.origin[1]+e.coordinates[3*t+1],i[2]=e.origin[2]+e.coordinates[3*t+2],i}g([_({constructOnly:!0})],j.prototype,"createGraphic",void 0),j=g([Y("esri.views.3d.layers.i3s.PointCloudRenderer")],j);class ce{constructor(){this.node=null,this.pointId=null,this.point=null,this.dist=null,this.normal=null,this.layerViewUid=""}}function Le(e){return e.dist!=null&&e.point!=null&&e.pointId!=null&&e.node!=null}class dr extends be{constructor(t,i,r,s,o,n,a,l,h=null){super(r,o,i),this.id=t,this.obb=s,this.coordinates=n,this.rgb=a,this.attributes=l,this.pointIdFilterMap=h,this.highlightMap=new Map}addHighlight(t,i){const{highlightMap:r}=this,s=gt(r,i.highlightName,()=>new Array),o=new ur(t,i);s.push(o);const n=We(o);for(let a=s.length-1;a>0&&n<We(s[a-1]);--a)[s[a-1],s[a]]=[s[a],s[a-1]]}removeHighlight(t){const{highlightMap:i}=this,{highlightName:r}=t,s=i.get(r);if(!s)return;const o=s.filter(n=>n.id!==t);o.length===0?i.delete(r):i.set(r,o)}get usedMemory(){return 5*this.coordinates.length+128}}function hr(e){return e.hasOwnProperty("splatSize")}function We(e){return e.componentIndex!=null?e.componentIndex:-1}class ur{constructor(t,i){this.componentIndex=t,this.id=i}}function He(e){const t=e.renderer,i=t?.type,r=t?.toJSON()??null;let s=null,o=!1;const n=e.attributeStorageInfo;i==="point-cloud-unique-value"||i==="point-cloud-stretch"||i==="point-cloud-class-breaks"?s=B(n,t.field):i==="point-cloud-rgb"?(s=Ue(n,t.field),o=s!=null):(s=Ue(n,"RGB"),o=s!=null);let a=null;return t?.colorModulation&&(a=B(n,t.colorModulation.field)),{rendererJSON:r,isRGBRenderer:o,primaryAttribute:s,modulationAttribute:a}}function Be(e){const t=e.filters;return t?t.map(i=>({filterJSON:i.toJSON(),attributeInfo:B(e.attributeStorageInfo,i.field)})):[]}function cr(e){const t=e?.pointSizeAlgorithm;return t&&t.type==="splat"?t:null}function Ge(e){const t=e?.pointSizeAlgorithm;return t&&t.type==="fixed-size"?t:null}function pr(e){const t=e?.pointSizeAlgorithm;return!!t?.type&&t.type==="fixed-size"}function Ue(e,t){for(const i of e??[])if(i.name===t&&i.attributeValues!=null&&i.attributeValues.valueType==="UInt8"&&i.attributeValues.valuesPerElement===3)return{name:t,storageInfo:i,useElevation:!1};return null}function B(e,t){for(const i of e??[])if(i.name===t){const r=i.encoding==="embedded-elevation";return r?{name:t,storageInfo:null,useElevation:r}:{name:t,storageInfo:i,useElevation:r}}return t?.toLowerCase()==="elevation"?{name:t,storageInfo:null,useElevation:!0}:null}const mr=e=>{const t=e;let i=class extends t{constructor(...r){super(...r),this.layer=null}get availableFields(){return[]}highlight(r,s){throw new Error("Not implemented")}queryFeatures(){throw new Error("Not implemented")}queryFeatureCount(){throw new Error("Not implemented")}createQuery(){throw new Error("Not implemented")}queryExtent(){throw new Error("Not implemented")}};return g([_()],i.prototype,"layer",void 0),g([_()],i.prototype,"availableFields",null),i=g([Y("esri.views.layers.PointCloudLayerView")],i),i},gr=8,fr=Ye();let b=class extends mr(ki(Zt(qi))){constructor(){super(...arguments),this.type="point-cloud-3d",this.maximumPointCount=4e6,this.slicePlaneEnabled=!1,this._renderer=null,this._rendererAdded=!1,this._renderedNodes=new Set,this._updateViewNeeded=!0,this._lodFactor=1,this._maxLoggedBoxWarnings=5,this._pageMultiplier=1,this._nodeLoadEpoch=0,this._indexQueue=[],this._workQueue=new Array,this._idleQueue=new Qi,this._indexPagesLoading=new Map,this._loadingNodes=new Map,this._recalcWork=!0,this._layerIsVisible=!1,this._codedDomainPopulationPromise=null,this._codedDomainPopulationAbortController=null,this._totalWork=0,this._index=null,this._loadingInitNodePage=!1,this._nodeIdArray=[],this.ignoresMemoryFactor=!1}get baseUrl(){return this.layer.parsedUrl?.path??""}get pointScale(){const e=cr(this.layer?.renderer);return e?.scaleFactor!=null?e.scaleFactor:1}get useRealWorldSymbolSizes(){const e=Ge(this.layer?.renderer);return e?.useRealWorldSymbolSizes!=null?e.useRealWorldSymbolSizes:!1}get pointSize(){const e=Ge(this.layer?.renderer);return e?.size!=null?e.size:0}get inverseDensity(){return this.layer?.renderer?96/this.layer.renderer.pointsPerInch:5}get availableFields(){const e=He(this.layer),t=new Set;e.primaryAttribute&&t.add(e.primaryAttribute.name),e.modulationAttribute&&t.add(e.modulationAttribute.name);const i=Be(this.layer);if(i)for(const r of i)r.attributeInfo&&t.add(r.attributeInfo.name);if(this.layer.outFields)for(const r of Oe(this.layer.fieldsIndex,this.layer.outFields))t.add(r);return Array.from(t)}get _clippingBox(){if(!this.view||!this.view.clippingArea)return null;const e=H(),t=this.view.renderSpatialReference;return Kt(this.view.clippingArea,e,t)?e:null}get _elevationOffset(){const e=this.layer&&this.layer.elevationInfo;return e&&e.mode==="absolute-height"?Yt(e,this.layer.spatialReference):0}get _graphicOrigin(){return this.layer.graphicOrigin}initialize(){const e=this.view.resourceController,t=yr(e);this._worker=new Ji(t),this.addResolvingPromise(this._worker.promise),this.addResolvingPromise(this.layer.rootPagePromise),ni(this.layer),ai(this.layer,this.view),this._indexRequester=e.createStreamDataRequester(2),this._dataRequester=e.createStreamDataRequester(3),this._initRenderer();const i=this._initNodePages(),r=this.view.resourceController.memoryController;this._memCache=r.newCache(`pcl-${this.layer.uid}`),this._queryFeaturesCache=r.newCache(`pcl-query-features-${this.layer.uid};`),this._updatingHandles.add(()=>this._clippingBox,()=>this._setUpdateViewNeeded(),S),this._updatingHandles.add(()=>this._elevationOffset,()=>this._elevationOffsetChanged(),S),this._updatingHandles.add(()=>this.layer.renderer,()=>this._rendererChanged(),S),this._updatingHandles.add(()=>this.layer.filters,()=>this._reload(),S),this._updatingHandles.add(()=>this.layer.outFields,()=>this._reload(),S),this._updatingHandles.add(()=>this.layer.effectiveScaleRange,()=>this._setUpdateViewNeeded()),this._updatingHandles.add(()=>this.view.state.contentCamera,()=>this._setUpdateViewNeeded()),this.addHandles([Re(()=>this.view.quality,()=>this._setUpdateViewNeeded(),xt)]),this.addResolvingPromise(i),this.when(()=>{this.addHandles([e.scheduler.registerTask(Li.POINT_CLOUD_LAYER,this),Re(()=>this.view.state.mode===2,()=>this._setUpdateViewNeeded(),Pt),this._updatingHandles.add(()=>this.suspended,s=>{s?this._clearNodeState():this._setUpdateViewNeeded()},S)])},()=>{this._updatingHandles.removeAll(),this.removeAllHandles()})}_setUpdateViewNeeded(){this._updateViewNeeded=!0,this._updateLoading()}destroy(){this.cancelLoading(),this._worker=U(this._worker),this._destroyRenderer(),this._memCache=U(this._memCache),this._queryFeaturesCache=U(this._queryFeaturesCache),this._queryEngine=U(this._queryEngine),this._codedDomainPopulationAbortController=ht(this._codedDomainPopulationAbortController),this._codedDomainPopulationPromise=null}_initRenderer(){this._renderer=new j({createGraphic:(e,t,i)=>this._createGraphic(e,t,i)}),this._renderer.layerViewUid=this.uid,this._updatingHandles.add(()=>this._clippingBox,e=>this._renderer.clippingBox=e,S),this._updatingHandles.add(()=>this.suspended,e=>this._setPointsVisible(!e),S),this._updatingHandles.add(()=>this.pointScale,e=>this._renderer.scaleFactor=e,S),this._renderer.minSizePx=Math.sqrt(2),this._updatingHandles.add(()=>this.useRealWorldSymbolSizes,e=>this._renderer.useRealWorldSymbolSizes=e,S),this._updatingHandles.add(()=>this.pointSize,e=>{const t=wt(e);this._renderer.size=e,this._renderer.sizePx=t},S),this._updatingHandles.add(()=>this.slicePlaneEnabled,e=>this._renderer.slicePlaneEnabled=e,S),this._updatingHandles.add(()=>this.inverseDensity,()=>this._setUpdateViewNeeded(),S),this._updatingHandles.add(()=>this.maximumPointCount,()=>this._setUpdateViewNeeded(),S),this._updatingHandles.add(()=>this.view.qualitySettings.sceneService.pointCloud.lodFactor,e=>{this._lodFactor=e,this._setUpdateViewNeeded()},S)}_destroyRenderer(){this._renderer.removeAll(),this._setPointsVisible(!1)}_createGraphic(e,t,i,r){const s=e.pointIdFilterMap!=null?e.pointIdFilterMap[t]:t,o=i?"declaredClass"in i?i:Xt(this.view,i):null;return r??=this._createGraphicAttributes(e,s),new W({pointCloudMetadata:{nodeId:e.id,pointIndexInNode:t,attributePointIndexInNode:s,epoch:this._nodeLoadEpoch},geometry:o,attributes:r,layer:this.layer,sourceLayer:this.layer,origin:this._graphicOrigin})}_createGraphicAttributes(e,t){const i={};for(const r of e.attributes)this._encodeGraphicAttribute(r.attributeInfo,r.values,t,i);return i}_getGraphicAttribute(e,t,i){const r=e.storageInfo?.attributeValues,s=r?.valuesPerElement??1;if(s===1)return t[i];if(r?.valueType==="UInt8"&&s<=4){let o=0;const n=i*s;for(let a=n;a<n+s;a++)o=(o<<8)+t[a];return o}}_encodeGraphicAttribute(e,t,i,r){r[e.name]=this._getGraphicAttribute(e,t,i)}_setPointsVisible(e){e&&!this._rendererAdded?(this.view.stage.addRenderPlugin(this._renderer),this._rendererAdded=!0):!e&&this._rendererAdded&&(this.view.stage.removeRenderPlugin(this._renderer),this._rendererAdded=!1)}_rendererChanged(){this._renderer.useFixedSizes=pr(this.layer.renderer),this._reload()}_reload(){this._clearNodeState(),this._memCache.clear(),this._setUpdateViewNeeded()}_elevationOffsetChanged(){this._clearNodeState(),this._memCache.clear(),this._initNodePages()}_displayNodes(e){this._workQueue=Yi([...this._renderedNodes],e,this._index),Zi(this._workQueue,this.view.state.contentCamera.viewForward,this._index),Ki(this._workQueue,gr,this._index),this._updateQueues(),this._totalWork=this._computeWork(),this._updateLoading(),this._layerIsVisible=e.length>0||this._loadingInitNodePage,this.notifyChange("suspended")}cancelLoading(){this._cancelNodeLoading(),this._cancelIndexLoading()}_cancelNodeLoading(){const e=new Array;this._loadingNodes.forEach(({abortController:t})=>e.push(t)),this._loadingNodes.clear();for(const t of e)t.abort();this._workQueue=[],this._idleQueue.cancelAll(),this._totalWork=this._computeWork(),this._updateLoading()}_updateQueues(){const e=new Set;this._workQueue.forEach(r=>r.load.forEach(s=>e.add(s)));const t=new Array,i=new Map;this._loadingNodes.forEach((r,s)=>{e.has(s)?i.set(s,r):t.push(r)}),this._loadingNodes=i;for(const{abortController:r}of t)r.abort();this._workQueue=this._workQueue.filter(r=>{for(const s of r.load)if(this._loadingNodes.has(s))return this._recalcWork=!0,!1;return!0}),this._totalWork=this._computeWork(),this._updateLoading()}_cancelIndexLoading(){this._indexQueue=[],this._indexPagesLoading.forEach(({abortController:e})=>e.abort()),this._indexPagesLoading.clear(),this._totalWork=this._computeWork(),this._updateLoading()}_clearNodeState(){this._nodeLoadEpoch++,this._renderedNodes.forEach(e=>this._removeFromRenderer(e)),this._cancelNodeLoading()}get readyToRun(){return this.suspended?this._updateViewNeeded:this._updateViewNeeded||this._indexQueue.length>0||this._workQueue.length>0||this._idleQueue.readyToRun}runTask(e){if(this.suspended){if(this._updateViewNeeded){this._updateViewNeeded=!1;const t=this._isRootNodeVisible();t!==this._layerIsVisible&&(this._layerIsVisible=t,this.notifyChange("suspended")),this._updateLoading()}}else{for(e.run(()=>this._updateWorkQueues());this._indexQueue.length>0&&e.run(()=>this._processIndexQueue()););this._processWorkQueue(e),this._idleQueue.runTask(e)}}_processIndexQueue(){const e=this._indexQueue.shift(),t=this._loadNodePage(e);return this._indexPagesLoading.set(e,t),t.promise.then(i=>{this._index.addPage(e,i,this._elevationOffset),this._setUpdateViewNeeded()}).then(()=>{this._indexPagesLoading.delete(e)},()=>{this._indexPagesLoading.delete(e)}),!0}_processWorkQueue(e){for(;!e.done;){const t=this._scheduleWorkEntry();if(t==null)return void e.madeProgress();this._processWorkEntry(t),e.madeProgress()}}_scheduleWorkEntry(){let e=this._workQueue.length;for(;e--;){const t=this._workQueue.shift();if(!t.remove.find(i=>!this._renderedNodes.has(i)))return t;this._workQueue.push(t)}return null}_processWorkEntry(e){if(e.load.length!==0)Promise.all(e.load.map(t=>{const i=new AbortController,r=this._memCache.pop(t.toString());return r!=null?this._loadingNodes.set(t,{abortController:i,promise:Promise.resolve(r)}):this._loadingNodes.has(t)||this._loadingNodes.set(t,{abortController:i,promise:this._loadNode(t,i.signal)}),this._loadingNodes.get(t).promise})).then(t=>{for(let i=0;i<e.load.length;i++)if(t[i]){const r=this._setupRendererData(e.load[i],t[i]);this._addToRenderer(r)}for(const i of e.remove)this._removeFromRenderer(i)}).catch(()=>{}).then(()=>{for(const t of e.load)this._loadingNodes.delete(t);this._updateLoading(),this._recalcWork&&!this._idleQueue.updating&&this._indexQueue.length===0&&this._loadingNodes.size===0&&(this._recalcWork=!1,this._setUpdateViewNeeded())}),this._updateLoading();else for(const t of e.remove)this._removeFromRenderer(t)}async _populateClassCodeCodedDomain(e,t){const i="CLASS_CODE",r=this.layer.fieldsIndex.get(i);if(!r||r.domain||!e.includes(r.name))return;const s=await _t(this.layer.queryCachedStatistics(i,{signal:t}));if(s.ok===!1)return;const o=s.value?.stats?.labels?.labels;o&&Array.isArray(o)&&(r.domain=new Tt({name:"CLASS_CODE",codedValues:o.map(n=>new Jt({code:n.value,name:n.label}))}))}async prepareFetchPopupFeatures(e){return this._codedDomainPopulationPromise||(this._codedDomainPopulationAbortController=new AbortController,this._codedDomainPopulationPromise=this._populateClassCodeCodedDomain(e,this._codedDomainPopulationAbortController.signal).then(()=>{this._codedDomainPopulationAbortController=null})),this._codedDomainPopulationPromise}async whenGraphicAttributes(e,t){const i=this._splitGraphicsPerNode(e),r=this.layer.attributeStorageInfo,s=t.map(a=>B(r,a)).filter(Pe),o=async(a,l)=>{const h=this._index.getNode(l);await yt(s,async d=>{const u=d.useElevation?await this._loadElevationAttributeFromGeometry(h.resourceId):await this._loadAndParseAttribute(h,d);if(u){for(const p of a)if(this._isValidPointGraphic(p)){const y=p.pointCloudMetadata.attributePointIndexInNode;this._encodeGraphicAttribute(d,u,y,p.attributes)}}})},n=[];return i.forEach((a,l)=>{n.push(o(a,l))}),await Promise.allSettled(n),e}_isValidPointGraphic(e){return e instanceof W&&e.pointCloudMetadata?.epoch===this._nodeLoadEpoch}_splitGraphicsPerNode(e){const t=new Map;for(const i of e){if(!this._isValidPointGraphic(i))continue;const r=i.pointCloudMetadata,s=t.get(r.nodeId);s?s.push(i):t.set(r.nodeId,[i])}return t}async _loadAndParseAttribute(e,t){const i=await this._loadAttribute(e.resourceId,t,null);return i?Mi({attributeInfo:t,buffer:i},null,e.vertexCount):null}async _loadElevationAttributeFromGeometry(e){const t=this.layer.store.defaultGeometrySchema,i=Fi(t,await this._loadGeometry(e,null));return Ei(i,i.length/3)}highlight(e,t){const i=$i(e);if(i.length===0)return ke;if(!(i[0]instanceof me))return ke;const r=i;return this._renderer.highlight(r.map(s=>this._graphicToPointDefinition(s)),Vi(t))}_graphicToPointDefinition(e){if(!this._isValidPointGraphic(e))return null;const{nodeId:t,pointIndexInNode:i}=e.pointCloudMetadata;return t!=null&&i!=null?{nodeId:t,pointId:i}:null}_computeWork(){let e=0;for(const t of this._workQueue)e+=t.load.length+t.remove.length;return e+=this._loadingNodes.size,e+=(this._indexQueue.length+this._indexPagesLoading.size)*this._index.pageSize,e+=this._loadingInitNodePage?100:0,e+=this._updateViewNeeded?100:0,e}get updatingProgressValue(){if(this.suspended)return this._updateViewNeeded?0:1;const e=this._computeWork();return 1-Math.min(this._totalWork,e)/this._totalWork}_updateLoading(){this.notifyChange("updating"),this.notifyChange("updatingProgressValue")}canResume(){return super.canResume()&&this._layerIsVisible}isUpdating(){return this.suspended?this._updateViewNeeded:this._computeWork()>0}get visibleAtCurrentScale(){return Di(this.layer.effectiveScaleRange,this.view.scale)}async queryFeatures(e,t){const i=await this._ensureQueryEngine().executeQuery(this._ensureQueryJSON(e),t?.signal),r=i.features;i.features=[];const s=jt.fromJSON(i),o=this.view.spatialReference;return s.features=r.map(n=>{const{attributes:a,metadata:l}=n;if(!l){const d=me.fromJSON(n);return d.geometry&&(d.geometry.spatialReference=s.spatialReference??o),d.layer=this.layer,d.sourceLayer=this.layer,d.origin=this._graphicOrigin,d}const h=n.geometry?Mt.fromJSON(n.geometry):void 0;return h&&(h.spatialReference=s.spatialReference??o),this._createGraphic(l.node,l.pointId,h,a)}),s}createQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference,returnZ:!0};return new se(e)}async queryFeatureCount(e,t){return await this._ensureQueryEngine().executeQueryForCount(this._ensureQueryJSON(e),t?.signal)}async queryExtent(e,t){const{count:i,extent:r}=await this._ensureQueryEngine().executeQueryForExtent(this._ensureQueryJSON(e),t?.signal);return{count:i,extent:Ot.fromJSON(r)}}_ensureQueryJSON(e){return e==null?new se({outSpatialReference:this.view.spatialReference}).toJSON():se.from(e).toJSON()}_ensureQueryEngine(){if(this._queryEngine)return this._queryEngine;const{spatialReference:e}=this.view;return this._queryEngine=new Ut({fieldsIndex:this.layer.fieldsIndex.toJSON(),geometryType:"esriGeometryPoint",spatialReference:e,featureIdInfo:{type:"object-id",fieldName:"objectId"},hasZ:!0,featureStore:new oi({sourceSpatialReference:e,viewSpatialReference:e,forAllFeatures:(t,i)=>{let r=!1;this._renderer.forEachNode(s=>{if(r)return;if(i){const n=s.obb,a=Lt(n.center[0],n.center[1],n.center[2],Je(n.halfSize));Ft(a,this.view.renderSpatialReference,a,this.view.spatialReference);const l=i(a);if(l===2||(r=l===0,r))return}let o=this._queryFeaturesCache.get(`${s.id}`);o||(o=this._createQueryPointFeatures(s),this._queryFeaturesCache.put(`${s.id}`,o)),o.features.forEach(t)})},getFeatureExtent:({point:t},i)=>$t(t,t,i),featureAdapter:{cloneWithGeometry:(t,i)=>new Te(t.node,t.pointId,i.coords),getAttribute:({node:t,attributePointId:i},r)=>{for(const s of t.attributes)if(s.attributeInfo.name===r)return this._getGraphicAttribute(s.attributeInfo,s.values,i)},getAttributes:({node:t,attributePointId:i})=>this._createGraphicAttributes(t,i),getCentroid:t=>t.getGeometry(),getGeometry:t=>t.getGeometry(),getObjectId:()=>{},getMetadata:t=>t}})}),this._queryEngine}_createQueryPointFeatures(e){const t=e.coordinates,i=new Array;for(let r=0;r<t.length/3;r++){const s=3*r,o=It(t[s+0],t[s+1],t[s+2]);vt(o,o,e.origin),Et(o,this.view.renderSpatialReference,o,this.view.spatialReference);const n=new Te(e,r,o);i.push(n)}return new _r(i)}async _initNodePages(){const e=this.layer.store.index,t=e.nodesPerPage||e.nodePerIndexBlock;this._index=new er(this.layer.spatialReference,this.view.renderCoordsHelper.spatialReference,t),this._cancelIndexLoading(),this._traverseVisible=this._index.createVisibilityTraverse(),this._loadingInitNodePage=!0,this._layerIsVisible=!0,this.notifyChange("suspended"),this._updateLoading(),this._pageMultiplier=e.nodesPerPage!=null?1:e.nodePerIndexBlock;const i=await this.layer.rootPagePromise;this._loadingInitNodePage=!1,i?(this._index.addPage(0,this._processJSONNodes(i,0),this._elevationOffset),this._setUpdateViewNeeded()):T.getLogger(this).error("Point cloud layer root page not loaded")}_loadNodePage(e){const t=new AbortController,i=`${this.baseUrl}/nodepages/${e*this._pageMultiplier}`;return{promise:this._requestNodePage(i,t.signal).then(r=>this._processJSONNodes(r,e)),abortController:t}}_processJSONNodes(e,t){const i=t*this._index.pageSize;return e.nodes.map((r,s)=>({resourceId:r.resourceId??i+s,obb:ne.fromJSON(r.obb),obbInRenderSR:new ne,firstChild:r.firstChild,childCount:r.childCount,vertexCount:r.vertexCount??r.pointCount,lodThreshold:r.lodThreshold??r.effectiveArea}))}_updateWorkQueues(){if(!this._updateViewNeeded)return!1;const e=this.view.quality;let t=this.inverseDensity/this._lodFactor*e;const i=this.maximumPointCount*this._lodFactor*e;let r=this._computeNodesForMinimumDensity(t),s=this._computePointCount(r),o=Math.sqrt(s/(.75*i));for(;s>i;)t*=o,r=this._computeNodesForMinimumDensity(t),s=this._computePointCount(r),o=Math.sqrt(2);return this._displayNodes(r),this._updateViewNeeded=!1,this._updateLoading(),!0}_computePointCount(e){let t=0;for(let i=0;i<e.length;i++){const r=this._index.getNode(e[i]);r&&(t+=r.vertexCount)}return t}_isRootNodeVisible(){let e=!1;return this._traverseVisible({frustum:this.view.state.contentCamera.frustum,clippingBox:this._clippingBox},{predicate:(t,i,r)=>(e=r,!1),pageMiss:()=>{}}),e}_computeNodesForMinimumDensity(e){const t=this.view.state.contentCamera,i=t.frustum,r=this._clippingBox,s=t.viewForward,o=R(s,t.eye),n=Qt(s,-o,fr),a=t.perScreenPixelRatio/2,l=e*e,h=this._nodeIdArray;h.length=0;const d=u=>h.push(u);return this._traverseVisible({frustum:i,clippingBox:r},{predicate:(u,p,y)=>{if(!y)return!1;if(p.childCount===0)return d(u),!1;const P=this._index.getRenderObb(u);return!(this._computeAveragePixelArea(P,p.lodThreshold,p.vertexCount,n,a)<=l)||(d(u),!1)},pageMiss:(u,p)=>{d(u),this._indexQueue.includes(p)||this._indexQueue.push(p)}}),h}_computeAveragePixelArea(e,t,i,r,s){const o=Math.max(1e-7,e.minimumDistancePlane(r));return t/(o*o)/(4*s*s)/i}_loadNode(e,t){try{return this._loadNodeAsync(e,t)}catch(i){throw ut(i)||T.getLogger(this).error(i),i}}async _loadAdditionalUserAttributes(e,t,i){const r=this.layer.outFields;if(!r)return[];const s=Oe(this.layer.fieldsIndex,r),o=new Set(e.map(h=>h!=null?h.name:null)),n=this.layer.attributeStorageInfo,a=[];for(const h of s){if(o.has(h))continue;const d=B(n,h);d&&a.push(t(d))}const l=await ct(a);return we(i),l.filter(Pe)}async _loadNodeAsync(e,t){const i=this._index.getNode(e),r=He(this.layer),s=Be(this.layer),o=i.resourceId,n=async a=>{if(!a)return null;if(a.useElevation)return{attributeInfo:a,buffer:null};const l=await this._loadAttribute(o,a,t);return l!=null?{attributeInfo:a,buffer:l}:null};return this._idleQueue.push(async()=>{const a=this._loadGeometry(o,t),{primaryAttribute:l,modulationAttribute:h}=r,d=n(l),u=n(h),p=s.map(c=>c.attributeInfo),y=p.map(c=>n(c)),P=this._loadAdditionalUserAttributes([l,h,...p],n,t),[f,m,I,O,K]=await Promise.all([a,d,u,Promise.all(y),P]);we(t);const V={geometryBuffer:f,primaryAttributeData:m,modulationAttributeData:I,filterAttributesData:O,userAttributesData:K,schema:this.layer.store.defaultGeometrySchema,rendererInfo:r,filterInfo:s,obbData:this._index.getRenderObb(e).data,elevationOffset:this._elevationOffset,inSR:this.layer.spatialReference.toJSON(),outSR:this.view.renderCoordsHelper.spatialReference.toJSON()};return this._worker.invoke(V,t)},t)}async _loadGeometry(e,t){return this._requestData(`${this.baseUrl}/nodes/${e}/geometries/0`,t)}async _loadAttribute(e,t,i){if(!t?.storageInfo)return null;const r=t.storageInfo.key;return this._requestData(`${this.baseUrl}/nodes/${e}/attributes/${r}`,i)}_requestNodePage(e,t){const i={f:"json",...this.layer.customParameters,token:this.layer.apiKey};return this._indexRequester.request(e,0,{query:i,signal:t})}_requestData(e,t){return this._dataRequester.request(e,1,{query:{...this.layer.customParameters,token:this.layer.apiKey},signal:t})}_removeFromRenderer(e){if(this._renderedNodes.has(e)){const t=this._renderer.removeNode(e);this._renderedNodes.delete(e),this._memCache.put(t.id.toString(),t)}}_addToRenderer(e){this._renderedNodes.has(e.id)||(this._renderedNodes.add(e.id),this._renderer.addNode(e))}_setupRendererData(e,t){const i=this._index.getNode(e),r=Math.sqrt(i.lodThreshold/i.vertexCount),s=this._index.getRenderObb(e);if(hr(t))return t.splatSize=r,t.obb=s,Nt(t.origin,t.obb.center),t;const o=ne.fromData(t.obbData),n=o.halfSize,a=s.halfSize,l=.01*Math.max(a[0],a[1],a[2]);if(n[0]>a[0]+l||n[1]>a[1]+l||n[2]>a[2]+l){if(this._maxLoggedBoxWarnings>0){const h=d=>`[${d.halfSize[0]}, ${d.halfSize[1]}, ${d.halfSize[2]}]`;T.getLogger(this).warn(`Node ${e} reported bounding box too small. got ${h(s)} but points cover ${h(o)}`),--this._maxLoggedBoxWarnings===0&&T.getLogger(this).warn("  Too many bounding box errors, stopping reporting for this layer.")}this._index.setRenderObb(e,o)}return new dr(e,r,At(s.center),s,i.childCount===0,t.points,t.rgb,t.attributes,t.pointIdFilterMap)}get usedMemory(){let e=0;return this._renderer.forEachNode(t=>{e+=pe,e+=Ne(t.coordinates);for(const i of t.attributes){const r=i.values;pt(r.buffer)&&(e+=Ne(r))}}),e}get unloadedMemory(){const e=this._renderedNodes.size;if(e<4)return 0;const t=[...this._renderedNodes].reduce((r,s)=>r+this._index.getNode(s).vertexCount);let i=this._loadingNodes.size;for(let r=0;r<this._workQueue.length;r++)i+=this._workQueue[r].load.length,i-=this._workQueue[r].remove.length;return i<0?0:i*t/e*((this.usedMemory-e*pe)/t)+i*pe}get performanceInfo(){return new Ui(this.usedMemory,this._renderedNodes.size,[...this._renderedNodes].reduce((e,t)=>e+this._index.getNode(t).vertexCount,0),this.maximumPointCount,new Ti(this._loadingNodes.size,this._indexQueue.length,this._workQueue.length,this._idleQueue.length))}get test(){}};g([_()],b.prototype,"layer",void 0),g([_()],b.prototype,"baseUrl",null),g([_()],b.prototype,"pointScale",null),g([_()],b.prototype,"useRealWorldSymbolSizes",null),g([_()],b.prototype,"pointSize",null),g([_()],b.prototype,"inverseDensity",null),g([_()],b.prototype,"maximumPointCount",void 0),g([_({readOnly:!0})],b.prototype,"availableFields",null),g([_({readOnly:!0})],b.prototype,"_clippingBox",null),g([_({readOnly:!0})],b.prototype,"_elevationOffset",null),g([_({type:Boolean})],b.prototype,"slicePlaneEnabled",void 0),g([_()],b.prototype,"_graphicOrigin",null),g([_()],b.prototype,"updating",void 0),g([_(ri)],b.prototype,"updatingProgress",void 0),g([_({readOnly:!0})],b.prototype,"updatingProgressValue",null),g([_({readOnly:!0})],b.prototype,"visibleAtCurrentScale",null),b=g([Y("esri.views.3d.layers.PointCloudLayerView3D")],b);const kn=b;class Te{constructor(t,i,r){this.node=t,this.pointId=i,this.point=r}getGeometry(){return new Gt([1],Array.from(this.point))}get attributePointId(){const{node:t,pointId:i}=this;return t.pointIdFilterMap!=null?t.pointIdFilterMap[i]:i}get usedMemory(){return ge+ge+ze+bt(this.point,ze)}}class _r{constructor(t){this.features=t}get usedMemory(){return this.features.reduce((t,i)=>t+i.usedMemory,ge+St)}}const pe=160;function yr(e){return t=>e.immediate.schedule(t)}const br=Object.freeze(Object.defineProperty({__proto__:null,PointRendererDrawParameters:be,PointRendererPassParameters:ye,build:et,getMaxPointSizeScreenspace:Z},Symbol.toStringTag,{value:"Module"}));export{kn as default};
