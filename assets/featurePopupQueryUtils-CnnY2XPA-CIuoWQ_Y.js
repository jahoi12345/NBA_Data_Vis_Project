import{s as G,d as z,G as $,a as O}from"./lengthUtils-Dt1_RvOO-bleznLOi.js";async function B(s,n,r,d){const u=new Array(n.length),l=new Map,a=new Map,b=G(s.fieldsIndex,r.outFields),F=s.capabilities?.operations?.supportsQuery===!0&&s.queryFeatures!=null,q=d?.hasRequiredFields??z;for(let e=0;e<n.length;e++){const t=n[e];if(F&&!t.isAggregate){if(r.returnGeometry||!q(t,b)){const i=t.getObjectId();if(i!=null){l.set(i,{graphic:t,index:e});continue}const c=t.getGlobalId();if(c!=null){a.set(c,{graphic:t,index:e});continue}}u[e]=t}else u[e]=t}if(!F||!s.queryFeatures||l.size===0&&a.size===0)return u.filter(Boolean);const f=[],h=(e,t)=>{t&&(e.outFields??=[],e.outFields.includes(t)||e.outFields.push(t))};if(l.size>0){const e=r.clone();h(e,s.objectIdField),"uniqueIdFields"in s&&s.uniqueIdFields?.length&&(e.outFields??=[],e.outFields.push(...s.uniqueIdFields)),e.objectIds=Array.from(l.keys()),f.push({type:"object-id",query:e,map:l})}const p="globalIdField"in s?s.globalIdField:null;if(p!=null&&a.size>0){const e=r.clone();h(e,p);const t=Array.from(a.keys());e.where=$(r.where,`${p} IN (${t.map(i=>`'${i}'`).join(",")})`),f.push({type:"global-id",query:e,map:a})}const j=d?.updateSourceAttributes??!1;for(const{type:e,query:t,map:i}of f)try{const c=await s.queryFeatures(t,d);for(const o of c.features){const I=e==="object-id"?o.getObjectId():o.getGlobalId();if(I==null)continue;const m=i.get(I);if(!m)continue;const{graphic:y,index:x}=m;if(j&&o.attributes){y.attributes??={};for(const g of b)g in o.attributes&&(y.attributes[g]=o.attributes[g])}const{geometry:A,origin:w}=y;o.geometry||=A,o.origin=w,u[x]=o}}catch{}return u.filter(Boolean)}async function M(s){if(s.expressionInfos?.length||Array.isArray(s.content)&&s.content.some(n=>n.type==="expression"))return O()}export{M as $,B as O};
