import{f as B,H as N,a5 as V}from"./Point-BfTTZoMu-BAT2Wq6O.js";import{I as w,bY as Y,l as Z}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{z as _}from"./mat4-C96X-Nn0-Do6fKsNS.js";import{n as E}from"./mat4f64-q_b6UJoq-Dh6sWB_w.js";import{L as H,V as M,I as J}from"./vec32-CewSdTn3-DHOFKD0R.js";import{t as b}from"./collectionUtils-jDyktm0P-ArdXNs6F.js";import{J as X}from"./projectionUtils-BGH_5_I3-BySNUA-B.js";import{x as O}from"./projectVectorToVector-Csv3NYZI-BsIKHfQD.js";import{y as L,a as A,P as W,d as D}from"./aaBoundingRect-CjwcS2F3-D7aII9DY.js";import{h as Q}from"./sphere-DLQ6p7mp-DmnRpHXV.js";import{O as ee}from"./featurePopupQueryUtils-CnnY2XPA-CIuoWQ_Y.js";import{o as te}from"./Query-BlS0WPDF-BdshFBMz.js";import{s as re,J as ne}from"./I3SBinaryReader-ZmgM2p_h-BnxBvCpV.js";import{y as oe}from"./computeTranslationToOriginAndRotation-Bjd4esRf-CXUng2L4.js";import{F as G,g as ae,B as se,y as ie}from"./layerViewUtils-BTa15X3o-BjQlX2q8.js";import{d as le,w as ce}from"./orientedBoundingBox-BLEx7wLU-CPBtS4XC.js";import{Q as F}from"./Emissions.glsl-B8XKMjLy-DXfiRNVX.js";function ue(e,t,r,n,o){const a=r==="east-north-up"?Q(e):fe(e,t,n),u=E();return oe(n,a,u,o),u}const j=1,P=5-j;function fe(e,t,r){const n=b(),o=e[3],a=2**(Math.ceil(Math.log(o)*Math.LOG2E/P)*P+j);if(r.isGeographic){const i=a/V(r).radius*180/Math.PI,f=Math.round(e[1]/i),d=Math.max(-90,Math.min(90,f*i)),c=i/Math.cos((Math.abs(d)-i/2)/180*Math.PI),h=Math.round(e[0]/c)*c;n[0]=h,n[1]=d}else{const i=Math.round(e[0]/a),f=Math.round(e[1]/a);n[0]=i*a,n[1]=f*a}const u=e[2]+t,l=Math.round(u/a);return n[2]=l*a,n}function z(e){return e?parseInt(e.slice(e.lastIndexOf("/")+1),10):void 0}function Ve(e){if(Z("disable-feature:i3s-draco")||!e)return!1;for(const t of e)for(const r of t.geometryBuffers)if(r.compressedAttributes?.encoding==="draco")return!0;return!1}function Ye(e,t,r,n){r.traverse(t,o=>{const a=o.serviceMbsInIndexSR;return(a!=null&&pe(e,a))!==0&&(n(o),!0)})}function Ze(e,t,r){let n=0,o=0;for(let a=0;a<t.length&&n<e.length;a++)e[n]===t[a]&&(r(a)&&(e[o]=e[n],o++),n++);e.length=o}function _e(e,t,r){let n=0,o=0;for(;n<r.length;)Y(e,r[n])>=0===t&&(r[o]=r[n],o++),n++;r.length=o}function He(e,t){if(t.rotationScale[1]===0&&t.rotationScale[2]===0&&t.rotationScale[3]===0&&t.rotationScale[5]===0&&t.rotationScale[6]===0&&t.rotationScale[7]===0)return v[0]=(e[0]-t.position[0])/t.rotationScale[0],v[1]=(e[1]-t.position[1])/t.rotationScale[4],v[2]=(e[2]-t.position[0])/t.rotationScale[0],v[3]=(e[3]-t.position[1])/t.rotationScale[4],v}const v=L();function pe(e,t){const r=t[0],n=t[1],o=t[3],a=e[0]-r,u=r-e[2],l=e[1]-n,i=n-e[3],f=Math.max(a,u,0),d=Math.max(l,i,0),c=f*f+d*d;return c>o*o?0:c>0?1:-Math.max(a,u,l,i)>o?3:2}function de(e,t,r){const n=[],o=r?.missingFields,a=r?.originalFields;let u=!1;for(const l of e){const i=t.get(l);i?(a?.push(l),n.push(i.name),l!==i.name&&(u=!0)):o?.push(l)}return r&&"hasMismatchedCasing"in r&&(r.hasMismatchedCasing=u),n}async function Je(e,t,r,n,o,a){if(t.length===0)return[];const u=e.attributeStorageInfo;if(e.associatedLayer!=null)try{return await ye(e.associatedLayer,t,n,a)}catch(l){if(e.associatedLayer.loaded)throw l}if(u){const l=me(e,t,r,o),i=e.parsedUrl.path;return await Promise.allSettled(l.map(f=>ge(i,u,f.node,f.indices,n,e.apiKey,e.customParameters,a).then(d=>{for(let c=0;c<f.graphics.length;c++){const h=f.graphics[c],y=d[c];if(h.attributes)for(const s in h.attributes)s in y||(y[s]=h.attributes[s]);h.attributes=y}}))),t}throw new w("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available")}function me({globalIdField:e},t,r,n){const o=new Map,a=[],u=n();for(const l of t){const i=l.attributes?.[r],f=i==null?l.getGlobalId():void 0;for(let d=0;d<u.length;d++){const c=u[d],h=he(c,i,e,f);if(h<0)continue;let y=o.get(c.node);y||(y={node:c.node,indices:[],graphics:[]},a.push(y),o.set(c.node,y)),y.indices.push(h),y.graphics.push(l);for(let s=d;s>0;s--)u[s]=u[s-1];u[0]=c;break}}return a}function he(e,t,r,n){if(t!=null&&typeof t=="number")return e.featureIds.indexOf(t);if(n==null||r==null)return-1;const o=e.attributeInfo?.attributeData?.[r];return o?o.indexOf(n):-1}async function ye(e,t,r,n){const o=[],a={hasMismatchedCasing:!1,originalFields:o},u=de(r,e.fieldsIndex,a),l=new te({outFields:[...u]});if(await ee(e,t,l,{updateSourceAttributes:!0,...n}),!a.hasMismatchedCasing)return t;for(let i=0;i<t.length;i++){const f=t[i];if(f.attributes)for(let d=0;d<o.length;d++){const c=o[d],h=u[d];h in f.attributes&&(f.attributes[c]=f.attributes[h],delete f.attributes[h])}}return t}function ge(e,t,r,n,o,a,u,l){return be(e,t,r.resources.attributes,n,o,a,u,l)}async function be(e,t,r,n,o,a,u,l){const i=[];for(const c of t)if(c&&o.includes(c.name)){const h=`${e}/nodes/${r}/attributes/${c.key}/0`;i.push({url:h,storageInfo:c})}const f=await Promise.allSettled(i.map(c=>N(c.url,{responseType:"array-buffer",query:{...u,token:a},signal:l?.signal}).then(h=>re(c.storageInfo,h.data)))),d=[];for(const c of n){const h={};for(let y=0;y<f.length;y++){const s=f[y];if(s.status==="fulfilled"){const m=s.value;h[i[y].storageInfo.name]=ne(m,c)}}d.push(h)}return d}function we(e){const t=e.store,r=t.indexCRS||t.geographicCRS,n=r===void 0?t.indexWKT:void 0;if(n){if(!e.spatialReference)throw new w("layerview:no-store-spatial-reference-wkt-index-and-no-layer-spatial-reference","Found indexWKT in the scene layer store but no layer spatial reference",{});if(n!==e.spatialReference.wkt)throw new w("layerview:store-spatial-reference-wkt-index-incompatible","The indexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const o=r?new B(z(r)):e.spatialReference;return o.equals(e.spatialReference)?e.spatialReference:o}function Me(e){const t=e.store,r=t.vertexCRS||t.projectedCRS,n=r===void 0?t.vertexWKT:void 0;if(n){if(!e.spatialReference)throw new w("layerview:no-store-spatial-reference-wkt-vertex-and-no-layer-spatial-reference","Found vertexWKT in the scene layer store but no layer spatial reference",{});if(n!==e.spatialReference.wkt)throw new w("layerview:store-spatial-reference-wkt-vertex-incompatible","The vertexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const o=r?new B(z(r)):e.spatialReference;return o.equals(e.spatialReference)?e.spatialReference:o}function K(e,t,r){if(!X(e,t))throw G("scene layer",e?.wkid,t?.wkid);if(r==="local"&&!ve(e,t))throw G("scene layer",e?.wkid,t?.wkid)}function Xe(e,t,r){if(e.serviceUpdateTimeStamp?.lastUpdate!==t.serviceUpdateTimeStamp?.lastUpdate||!r.isEmpty||e.associatedLayer?.url!==t.associatedLayer?.url)throw new w("layerview:recycle-failed","Could not recycle layerview")}function ve(e,t){return e.equals(t)||e.isWGS84&&t.isWebMercator||e.isWebMercator&&t.isWGS84}function xe(e,t,r){const n=we(e),o=Me(e);K(n,t,r),K(o,t,r)}function Se(e){return(e.geometryType==null||e.geometryType==="triangles")&&(e.topology==null||e.topology==="PerAttributeArray")&&e.vertexAttributes?.position!=null}function De(e){if(e.store?.defaultGeometrySchema==null||!Se(e.store.defaultGeometrySchema))throw new w("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:e.parsedUrl.path})}function et(e,t){xe(e,t.spatialReference,t.viewingMode)}function Ie(e){return e.geometryType!=null&&e.geometryType==="points"&&(e.topology==null||e.topology==="PerAttributeArray")&&(e.encoding==null||e.encoding===""||e.encoding==="lepcc-xyz")&&e.vertexAttributes?.position!=null}function tt(e){if(e.store?.defaultGeometrySchema==null||!Ie(e.store.defaultGeometrySchema))throw new w("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{})}function rt(e,t){K(e.spatialReference,t.spatialReference,t.viewingMode)}function Re(e){return e.type==="simple"||e.type==="class-breaks"||e.type==="unique-value"}function Te(e){return e.type==="mesh-3d"}function nt(e){if(e==null||!Re(e)||(e.type==="unique-value"||e.type==="class-breaks")&&e.defaultSymbol==null)return!0;const t=e.symbols;if(t.length===0)return!0;for(const r of t){if(!Te(r)||r.symbolLayers.length===0)return!0;for(const n of r.symbolLayers.items)if(n.type!=="fill"||n.material?.color==null||n.material.colorMixMode!=="replace")return!0}return!1}const ot=ae({color:[0,0,0,0],opacity:0});class $e{constructor(){this.edgeMaterial=null,this.material=null,this.castShadows=!0}}function at(e){const t=new $e;let r=!1,n=!1;for(const o of e.symbolLayers.items)if(o.type==="fill"&&o.enabled){const a=o.material,u=o.edges;if(a!=null&&!r){const l=a.color,i=se(a.colorMixMode),f={strength:a.emissive?.strength??F,source:a.emissive?.source==="color"?1:0};t.material=l!=null?{color:[l.r/255,l.g/255,l.b/255],alpha:l.a,colorMixMode:i,emissive:f}:{color:[1,1,1],alpha:1,colorMixMode:1,emissive:f},t.castShadows=o.castShadows,r=!0}u==null||n||(t.edgeMaterial=ie(u,{}),n=!0)}return t.material||(t.material={color:[1,1,1],alpha:1,colorMixMode:1,emissive:{strength:F,source:0}}),t}function st(e,t){return(0|e)+(0|t)|0}function it(e,t,r,n,o,a,u){if(!a||a.length===0||t==null||!e.serviceMbsInIndexSR)return null;const l=ue(e.serviceMbsInIndexSR,o,"none",r,t);_(R,l);let i=null;const f=()=>{if(!i)if(i=ke,A(I),e.serviceObbInIndexSR!=null){e.serviceObbInIndexSR.transform(q,r,t,o,u),q.getCorners(i);for(const s of i)M(s,s,R),W(I,s)}else{const s=e.serviceMbsInIndexSR;if(!s)return;const m=s[3];O(Q(s),r,p,t),M(p,p,R),p[2]+=o;for(let g=0;g<8;++g){const x=1&g?m:-m,T=2&g?m:-m,$=4&g?m:-m,S=i[g];J(S,[p[0]+x,p[1]+T,p[2]+$]),W(I,S)}}};let d=1/0,c=-1/0;const h=s=>{if(s.type!=="replace")return;const m=s.geometry;if(!m?.hasZ)return;A(C);const g=m.spatialReference||n,x=m.rings.reduce((T,$)=>$.reduce((S,k)=>(H(p,k[0],k[1],k[2]),O(p,g,p,t),M(p,p,R),W(C,p),Math.min(p[2],S)),T),1/0);f(),D(I,C)&&(d=Math.min(d,x),c=Math.max(c,x))};if(a.forEach(s=>h(s)),d===1/0)return null;const y=(s,m,g)=>{M(p,g,l),s[m]=p[0],s[m+1]=p[1],s[m+2]=p[2],m+=24,g[2]=d,M(p,g,l),s[m]=p[0],s[m+1]=p[1],s[m+2]=p[2],m+=24,g[2]=c,M(p,g,l),s[m]=p[0],s[m+1]=p[1],s[m+2]=p[2]};for(let s=0;s<8;++s)y(U.data,3*s,i[s]);return ce(U)}function lt(e){return e[3]>=0}function ct(e){e!=null&&(e[3]=-1)}const ke=[b(),b(),b(),b(),b(),b(),b(),b()],C=L(),I=L(),q=new le,p=b(),U={data:new Array(72),size:3,exclusive:!0,stride:3},R=E();export{K,Me as M,Ze as N,_e as Q,xe as S,He as V,Je as X,Xe as Y,Ve as Z,De as _,at as a,be as b,ct as c,pe as d,et as e,it as i,Ye as j,lt as l,nt as n,ot as o,de as p,rt as r,st as s,tt as t,ue as u,we as w};
