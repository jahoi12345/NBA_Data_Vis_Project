const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/FeatureLayer-BRWpcy_W-D7AhvLUt.js","assets/index-B0z_nLWi.js","assets/index-Cv2ko1Ob.css","assets/jsonMap-Bs3hmeCU-Cusd0Fmz.js","assets/getPopupProvider-CmskPttI-CzUWpGwk.js","assets/collectionUtils-jDyktm0P-BDP2Oq99.js","assets/Point-BfTTZoMu-DeJwQYfh.js","assets/reader-DcGs6kKN-DHJfK-tm.js","assets/reactiveUtils-SO2Ko3sy-BCLX8Jdy.js","assets/Extent-CgDMOSRD-Bod5LY6s.js","assets/SimpleObservable-CvFyr0NA-DXpoMYph.js","assets/lengthUtils-Dt1_RvOO-j3MEdmHu.js","assets/date-IqUzANpt-bLKO9IDT.js","assets/Color-CERqXxxY-BuYn26eI.js","assets/mathUtils-PIGhLnI9-B1tKUlUb.js","assets/Layer-DZvC7bne-D3VLDrab.js","assets/MultiOriginJSONSupport-Bd1TKmh_-BHNF5tHX.js","assets/layerContainerType-CSXZNpHb-BIF7XAYP.js","assets/FormTemplate-DuPZvaVv-DtJsNdqp.js","assets/Field-Cm_ZejYW-CwJZmSru.js","assets/fieldType-DVUzXtk_-tUuvnZJM.js","assets/Graphic-DgGzDmqW-d1CNicxz.js","assets/jsonUtils-CmpazY1u-6pDLj5sx.js","assets/Polyline-CoiTLswR-DTxpB2Yg.js","assets/Polygon-D6wEPb3W-D2MPjRU4.js","assets/aaBoundingRect-CjwcS2F3-ri8bmh30.js","assets/typeUtils-DqrRcjBx-DZ6_Gsbu.js","assets/createFeatureId-CVwTD0fV-3fKpJDrk.js","assets/typeUtils-CXW_VpOn-BGgLp_TK.js","assets/lineMarkers-CDwLe3J6-CNUjJvs3.js","assets/PolygonSymbol3D-BXRHZiCQ-BjPAY2LA.js","assets/ExtrudeSymbol3DLayer-DSc1ou2x-CsVYZCeG.js","assets/screenUtils-BitdhK1O-L0FLPAMi.js","assets/opacityUtils-DuFH0EC9-DWspTgn2.js","assets/aaBoundingBox-Cn49X7ge-BcYPaJ58.js","assets/DoubleArray-DExKNiTh-CvVpHySW.js","assets/mat4f64-q_b6UJoq-Dh6sWB_w.js","assets/Font-BwmnW7d2-Dwh3xjKw.js","assets/SimpleFillSymbol-CDawtd9z-CWD2KI2D.js","assets/SimpleMarkerSymbol-BGAFRS9_-CVQ5NLIA.js","assets/PictureMarkerSymbol-CaSh-vZk-xhjZ61bb.js","assets/TextSymbol-hRGhyDHs-CoS7dSjf.js","assets/GraphicOrigin-uE6TDXc9-DqbdmNAV.js","assets/isFeatureGraphicOrigin-YA2hudPe-Bk2FjH_E.js","assets/workers-BEkgoq8Q-BM_Hz460.js","assets/Queue-CYlrXMwB-CYJTUII-.js","assets/intl-DRFqUect-DPhFaHB2.js","assets/editsZScale-D3N5iH_c-CCATcpvE.js","assets/queryZScale-CRP3Sh_E-F3y679Wx.js","assets/projectionUtils-BGH_5_I3-DGwchVO8.js","assets/FeatureSet-BF7daP96-B_JvMbY7.js","assets/APIKeyMixin--YGbad8e-DJ-JJTX5.js","assets/ArcGISService-SIwch9bz-DEFXc423.js","assets/BlendLayer-HE_aYHHW-D0es7Iiq.js","assets/jsonUtils-CY6YsQMo-LM0PY-PG.js","assets/mat4f32-Djp3mnm5-DzYG3LYB.js","assets/mat4-C96X-Nn0-BrMLOLCb.js","assets/CustomParametersMixin-Dshqz1Zp-BFC165kX.js","assets/DisplayFilteredLayer-DyjtPayS-DLMYIA49.js","assets/scaleUtils-yfx9kKWT-D9SVsyM-.js","assets/uuid-Oe6SV2kF-IYX19xBA.js","assets/displayFilterUtils-CIXGrQzt-XEoxkZ3i.js","assets/EditBusLayer-rxUbWTiY-BxA39RQ7.js","assets/FeatureEffectLayer-BG_KTtPw-C05GQDNc.js","assets/FeatureEffect-mVCOF1v6--fvFHZv2.js","assets/FeatureFilter-G4_pWMVe-D0hu4KAy.js","assets/Query-BlS0WPDF-jdXS_Qhy.js","assets/FeatureLayerBase-BUeDgO3U-q6RnYMdc.js","assets/HeightModelInfo-D5IdRvJ2-23y6MRiu.js","assets/OperationalLayer-B6zbJ5nR-DyK_ztCk.js","assets/ElevationInfo-Cw2HaA6E-CuK5hJ96.js","assets/unitConversionUtils-4vB4Ezlp-DnY5MDxd.js","assets/timeZoneUtils-BSc7-7qA-BAv3h8mh.js","assets/featureLayerUtils-FKjLNPl_-Cv8vWd4i.js","assets/asyncUtils-w6KfWU41-HenJ0UOu.js","assets/featureQueryAll-BfDWA5Wx-BKksFkIA.js","assets/layerUtils-DZGhvm-W-CfyHx1TZ.js","assets/SimpleRenderer-CEmCWePp-BJ25mYcH.js","assets/commonProperties-DbO613LF-CHjBvYhj.js","assets/colorRamps-DswZzxkO-BqSFavfl.js","assets/ColorStop-De5gQTjr-C1lw16u9.js","assets/visualVariableUtils-ma4r7Z2K-Df6C3Hkh.js","assets/jsonUtils-C9q_FK4K-GRCbm_Pe.js","assets/defaults3D-C2hXSee1-CTj29-Ly.js","assets/defaults-BDN9qxeN-C-EfxQM4.js","assets/defaultsJSON-GKolV7NZ-GKolV7NZ.js","assets/UniqueValueRenderer-JPjz9Qvs-Duu1CubQ.js","assets/diffUtils-wTC1YzlE-DCTUTUs8.js","assets/RendererLegendOptions-ByGHYLtx-Bwoo6l33.js","assets/styleUtils-DWvicjTN-DL6_BIk4.js","assets/NormalizationBinParametersMixin-BK9wNkI3-BKYeOhDN.js","assets/LayerFloorInfo-CTubHTci-DciGdwJt.js","assets/multiLayerServiceUtils-CpHWiXA7-HO_F3Kjq.js","assets/Relationship-CrANqG2c-DiHDOAEy.js","assets/serviceCapabilitiesUtils-BV_pcUiO-Dw-u7_oZ.js","assets/infoFor3D-DhzudQro-CCYgWfsv.js","assets/portalItemUtils-CaPNUJg6-CXDHI5LA.js","assets/FeatureReductionLayer-Bhh5MvS_-6_Dufsno.js","assets/FeatureReductionSelection-Du7o8OIG-DmruV-ou.js","assets/labelingInfo-BYG2hiVF-B7-dv03v.js","assets/labelUtils-BtizwBfq-Zegx4520.js","assets/jsonUtils-BCGKNxno-DZ1Xr_O8.js","assets/typeUtils-DDFS4uuz-B7KgP61w.js","assets/ClassBreaksRenderer-BvgdqtTq-D2fU8Sng.js","assets/LRUCache-fy84PBMi-Y56WPIvD.js","assets/DictionaryScriptEvaluator-G73uSGpN-ErvAW-Hm.js","assets/Version-BtYZEj58-LyRHDnSJ.js","assets/FieldsIndex-CimK-TqD--24JoCkp.js","assets/UnknownTimeZone-B697BDFv-CBbtul7O.js","assets/ArcadeExpression-BlIRq-oN-VZkrwLVE.js","assets/TimeOnly-BERR31kg-CQiLyUZi.js","assets/enum-BzLwmiID-CcyIdWlQ.js","assets/utils-DX2muIr3-DiPfFKSl.js","assets/heatmapUtils-B-AXnq0l-BF3Q_jd2.js","assets/vec42-B8VM4vXb-B6OGOEI9.js","assets/vec4f64-DPb6J-GU-C7c2DqbZ.js","assets/MD5-MtSiOt06-jWr180Yc.js","assets/OrderedLayer-DQAUgUTV-CpnQmtbN.js","assets/PortalLayer-CbFNhtZ4-Doeialq-.js","assets/PortalItem-DnxMlRVo-CI4Ns2_M.js","assets/RefreshableLayer-CBbEkZf--DylHaNOC.js","assets/ScaleRangeLayer-DQr2T3Hh-Dh1UYk4i.js","assets/TemporalLayer-D4R0YvXo-PSBzKw25.js","assets/TimeInfo-D7ssmbZO-Burc-nDV.js","assets/TrackableLayer-B-086Hm8-C0H4r_hG.js","assets/FeatureTemplate-Bur8tORn-C24tlGMe.js","assets/FeatureType-CFJlAOcG-DepIzvPz.js","assets/fieldProperties-BoJj55FN-DI1Lssr9.js","assets/TitleCreator-BosRD8XX-Cm4g2hqp.js","assets/sanitizerUtils-BT_8V5US-CWQWUwZQ.js","assets/versionUtils-BfuZvWmP-RYMRQmOM.js","assets/styleUtils-CZJC3pZm-BNE6B1Si.js","assets/popupUtils-D4UavgYz-DI7Mb3me.js"])))=>i.map(i=>d[i]);
import{H as C,_ as D}from"./index-B0z_nLWi.js";import{v as a,I as c,a8 as R,ab as w,Y as h,H as m,G as y}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{ai as S,H as B,f as U}from"./Point-BfTTZoMu-DeJwQYfh.js";import{P as x}from"./jsonUtils-CmpazY1u-6pDLj5sx.js";import{o as b}from"./projectionUtils-BGH_5_I3-DGwchVO8.js";import{J as P}from"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import{v as _}from"./query-DeNEvEsQ-DfFlUyui.js";import{o as L}from"./Query-BlS0WPDF-jdXS_Qhy.js";import"./Extent-CgDMOSRD-Bod5LY6s.js";import"./Polyline-CoiTLswR-DTxpB2Yg.js";import"./Polygon-D6wEPb3W-D2MPjRU4.js";import"./mathUtils-PIGhLnI9-B1tKUlUb.js";import"./collectionUtils-jDyktm0P-BDP2Oq99.js";import"./normalizeUtils-85zLqeMi-C1bdAKNn.js";import"./normalizeUtilsCommon-CnhQye_A-UWhaH-kt.js";import"./pbf-2SIhMekG-LK438LAR.js";import"./Color-CERqXxxY-BuYn26eI.js";import"./typeUtils-DqrRcjBx-DZ6_Gsbu.js";import"./Field-Cm_ZejYW-CwJZmSru.js";import"./fieldType-DVUzXtk_-tUuvnZJM.js";import"./Layer-DZvC7bne-D3VLDrab.js";import"./date-IqUzANpt-bLKO9IDT.js";import"./reader-DcGs6kKN-DHJfK-tm.js";import"./SimpleObservable-CvFyr0NA-DXpoMYph.js";import"./aaBoundingRect-CjwcS2F3-ri8bmh30.js";import"./pbfQueryUtils-DlZBMNQk-rXCy_evW.js";import"./OptimizedFeature-CwRGZPwv-Ddclhn0A.js";import"./memoryEstimations-Bd726a_p-0cVCY2Jz.js";import"./OptimizedFeatureSet-BR8EEvDc-CgsRgxJh.js";import"./queryZScale-CRP3Sh_E-F3y679Wx.js";import"./Cyclical-BLSxUpe7-Bj8R2Yk-.js";import"./utils-CylVuxNi--x86XOjU.js";import"./utils-Dpg4yj1D-CeFz2JVC.js";const v=(e,s=v,t=s.f||(s.f=["assets/FeatureLayer-BRWpcy_W.js","assets/index-BzxsWNRw.js","assets/index-Cv2ko1Ob.css","assets/jsonMap-Bs3hmeCU.js","assets/getPopupProvider-CmskPttI.js","assets/collectionUtils-jDyktm0P.js","assets/Point-BfTTZoMu.js","assets/reader-DcGs6kKN.js","assets/reactiveUtils-SO2Ko3sy.js","assets/Extent-CgDMOSRD.js","assets/SimpleObservable-CvFyr0NA.js","assets/lengthUtils-Dt1_RvOO.js","assets/date-IqUzANpt.js","assets/Color-CERqXxxY.js","assets/mathUtils-PIGhLnI9.js","assets/Layer-DZvC7bne.js","assets/MultiOriginJSONSupport-Bd1TKmh_.js","assets/layerContainerType-CSXZNpHb.js","assets/FormTemplate-DuPZvaVv.js","assets/Field-Cm_ZejYW.js","assets/fieldType-DVUzXtk_.js","assets/Graphic-DgGzDmqW.js","assets/jsonUtils-CmpazY1u.js","assets/Polyline-CoiTLswR.js","assets/Polygon-D6wEPb3W.js","assets/aaBoundingRect-CjwcS2F3.js","assets/typeUtils-DqrRcjBx.js","assets/createFeatureId-CVwTD0fV.js","assets/typeUtils-CXW_VpOn.js","assets/lineMarkers-CDwLe3J6.js","assets/PolygonSymbol3D-BXRHZiCQ.js","assets/ExtrudeSymbol3DLayer-DSc1ou2x.js","assets/screenUtils-BitdhK1O.js","assets/opacityUtils-DuFH0EC9.js","assets/aaBoundingBox-Cn49X7ge.js","assets/DoubleArray-DExKNiTh.js","assets/mat4f64-q_b6UJoq.js","assets/Font-BwmnW7d2.js","assets/SimpleFillSymbol-CDawtd9z.js","assets/SimpleMarkerSymbol-BGAFRS9_.js","assets/PictureMarkerSymbol-CaSh-vZk.js","assets/TextSymbol-hRGhyDHs.js","assets/GraphicOrigin-uE6TDXc9.js","assets/isFeatureGraphicOrigin-YA2hudPe.js","assets/workers-BEkgoq8Q.js","assets/Queue-CYlrXMwB.js","assets/intl-DRFqUect.js","assets/editsZScale-D3N5iH_c.js","assets/queryZScale-CRP3Sh_E.js","assets/projectionUtils-BGH_5_I3.js","assets/FeatureSet-BF7daP96.js","assets/APIKeyMixin--YGbad8e.js","assets/ArcGISService-SIwch9bz.js","assets/BlendLayer-HE_aYHHW.js","assets/jsonUtils-CY6YsQMo.js","assets/mat4f32-Djp3mnm5.js","assets/mat4-C96X-Nn0.js","assets/CustomParametersMixin-Dshqz1Zp.js","assets/DisplayFilteredLayer-DyjtPayS.js","assets/scaleUtils-yfx9kKWT.js","assets/uuid-Oe6SV2kF.js","assets/displayFilterUtils-CIXGrQzt.js","assets/EditBusLayer-rxUbWTiY.js","assets/FeatureEffectLayer-BG_KTtPw.js","assets/FeatureEffect-mVCOF1v6.js","assets/FeatureFilter-G4_pWMVe.js","assets/Query-BlS0WPDF.js","assets/FeatureLayerBase-BUeDgO3U.js","assets/HeightModelInfo-D5IdRvJ2.js","assets/OperationalLayer-B6zbJ5nR.js","assets/ElevationInfo-Cw2HaA6E.js","assets/unitConversionUtils-4vB4Ezlp.js","assets/timeZoneUtils-BSc7-7qA.js","assets/featureLayerUtils-FKjLNPl_.js","assets/asyncUtils-w6KfWU41.js","assets/featureQueryAll-BfDWA5Wx.js","assets/layerUtils-DZGhvm-W.js","assets/SimpleRenderer-CEmCWePp.js","assets/commonProperties-DbO613LF.js","assets/colorRamps-DswZzxkO.js","assets/ColorStop-De5gQTjr.js","assets/visualVariableUtils-ma4r7Z2K.js","assets/jsonUtils-C9q_FK4K.js","assets/defaults3D-C2hXSee1.js","assets/defaults-BDN9qxeN.js","assets/defaultsJSON-GKolV7NZ.js","assets/UniqueValueRenderer-JPjz9Qvs.js","assets/diffUtils-wTC1YzlE.js","assets/RendererLegendOptions-ByGHYLtx.js","assets/styleUtils-DWvicjTN.js","assets/NormalizationBinParametersMixin-BK9wNkI3.js","assets/LayerFloorInfo-CTubHTci.js","assets/multiLayerServiceUtils-CpHWiXA7.js","assets/Relationship-CrANqG2c.js","assets/serviceCapabilitiesUtils-BV_pcUiO.js","assets/infoFor3D-DhzudQro.js","assets/portalItemUtils-CaPNUJg6.js","assets/FeatureReductionLayer-Bhh5MvS_.js","assets/FeatureReductionSelection-Du7o8OIG.js","assets/labelingInfo-BYG2hiVF.js","assets/labelUtils-BtizwBfq.js","assets/jsonUtils-BCGKNxno.js","assets/typeUtils-DDFS4uuz.js","assets/ClassBreaksRenderer-BvgdqtTq.js","assets/LRUCache-fy84PBMi.js","assets/DictionaryScriptEvaluator-G73uSGpN.js","assets/Version-BtYZEj58.js","assets/FieldsIndex-CimK-TqD.js","assets/UnknownTimeZone-B697BDFv.js","assets/ArcadeExpression-BlIRq-oN.js","assets/TimeOnly-BERR31kg.js","assets/enum-BzLwmiID.js","assets/utils-DX2muIr3.js","assets/heatmapUtils-B-AXnq0l.js","assets/vec42-B8VM4vXb.js","assets/vec4f64-DPb6J-GU.js","assets/MD5-MtSiOt06.js","assets/OrderedLayer-DQAUgUTV.js","assets/PortalLayer-CbFNhtZ4.js","assets/PortalItem-DnxMlRVo.js","assets/RefreshableLayer-CBbEkZf-.js","assets/ScaleRangeLayer-DQr2T3Hh.js","assets/TemporalLayer-D4R0YvXo.js","assets/TimeInfo-D7ssmbZO.js","assets/TrackableLayer-B-086Hm8.js","assets/FeatureTemplate-Bur8tORn.js","assets/FeatureType-CFJlAOcG.js","assets/fieldProperties-BoJj55FN.js","assets/TitleCreator-BosRD8XX.js","assets/sanitizerUtils-BT_8V5US.js","assets/versionUtils-BfuZvWmP.js","assets/styleUtils-CZJC3pZm.js","assets/popupUtils-D4UavgYz.js"]))=>e.map(r=>t[r]);let g=class extends P{destroy(){this.emit("destroy")}get connectionError(){return this.errorString?new c("stream-connection",this.errorString):null}onFeature(e){this.emit("data-received",e)}onMessage(e){this.emit("message-received",e)}};h([m({readOnly:!0})],g.prototype,"connectionError",null),g=h([y("esri.layers.support.StreamConnection")],g);let f=class extends g{constructor(e){super({}),this._outstandingMessages=[],this.errorString=null;const{geometryType:s,spatialReference:t,sourceSpatialReference:r}=e;this._config=e,this._featureZScaler=b(s,r,t),this._open()}normalizeCtorArgs(){return{}}async _open(){await this._tryCreateWebSocket(),this.destroyed||await this._handshake()}destroy(){super.destroy(),this._websocket!=null&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null}get connectionStatus(){if(this._websocket==null)return"disconnected";switch(this._websocket.readyState){case 0:case 1:return"connected";case 2:case 3:return"disconnected"}}sendMessageToSocket(e){this._websocket!=null?this._websocket.send(JSON.stringify(e)):this._outstandingMessages.push(e)}sendMessageToClient(e){this._onMessage(e)}updateCustomParameters(e){this._config.customParameters=e,this._websocket!=null&&this._websocket.close()}async _tryCreateWebSocket(e=this._config.source.path,s=1e3,t=0){try{if(this.destroyed)return;const r=S(e,this._config.customParameters??{});this._websocket=await this._createWebSocket(r),this.notifyChange("connectionStatus")}catch(r){const o=s/1e3;return this._config.maxReconnectionAttempts&&t>=this._config.maxReconnectionAttempts?(a.getLogger(this).error(new c("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),void this.destroy()):(a.getLogger(this).error(new c("websocket-connection",`Failed to connect. Attempting to reconnect in ${o}s`,r)),await R(s),this._tryCreateWebSocket(e,Math.min(1.5*s,1e3*this._config.maxReconnectionInterval),t+1))}}_setWebSocketJSONParseHandler(e){e.onmessage=s=>{try{const t=JSON.parse(s.data);this._onMessage(t)}catch(t){return void a.getLogger(this).error(new c("websocket-connection","Failed to parse message, invalid JSON",{error:t}))}}}_createWebSocket(e){return new Promise((s,t)=>{const r=new WebSocket(e);r.onopen=()=>{if(r.onopen=null,this.destroyed)return r.onclose=null,void r.close();r.onclose=o=>this._onClose(o),r.onerror=o=>this._onError(o),this._setWebSocketJSONParseHandler(r),s(r)},r.onclose=o=>{r.onopen=r.onclose=null,t(o)}})}async _handshake(e=1e4){const s=this._websocket;if(s==null)return;const t=w(),r=s.onmessage,{filter:o,outFields:i,spatialReference:l}=this._config;return t.timeout(e),s.onmessage=d=>{let u=null;try{u=JSON.parse(d.data)}catch{}u&&typeof u=="object"||(a.getLogger(this).error(new c("websocket-connection","Protocol violation. Handshake failed - malformed message",d.data)),t.reject(),this.destroy()),u.spatialReference?.wkid!==l?.wkid&&(a.getLogger(this).error(new c("websocket-connection",`Protocol violation. Handshake failed - expected wkid of ${l.wkid}`,d.data)),t.reject(),this.destroy()),u.format!=="json"&&(a.getLogger(this).error(new c("websocket-connection","Protocol violation. Handshake failed - format is not set",d.data)),t.reject(),this.destroy()),o&&u.filter!==o&&a.getLogger(this).error(new c("websocket-connection","Tried to set filter, but server doesn't support it")),i&&u.outFields!==i&&a.getLogger(this).error(new c("websocket-connection","Tried to set outFields, but server doesn't support it")),s.onmessage=r;for(const n of this._outstandingMessages)s.send(JSON.stringify(n));this._outstandingMessages=[],t.resolve()},s.send(JSON.stringify({filter:o,outFields:i,format:"json",spatialReference:{wkid:l.wkid}})),t.promise}_onMessage(e){if(this.onMessage(e),"type"in e)switch(e.type){case"features":case"featureResult":for(const s of e.features)this._featureZScaler!=null&&this._featureZScaler(s.geometry),this.onFeature(s)}}_onError(e){const s="Encountered an error over WebSocket connection";this._set("errorString",s),a.getLogger(this).error("websocket-connection",s)}_onClose(e){this._websocket=null,this.notifyChange("connectionStatus"),e.code!==1e3&&a.getLogger(this).error("websocket-connection",`WebSocket closed unexpectedly with error code ${e.code}`),this.destroyed||this._open()}};h([m()],f.prototype,"connectionStatus",null),h([m()],f.prototype,"errorString",void 0),f=h([y("esri.layers.graphics.sources.connections.WebSocketConnection")],f);const T=1e4,O={maxQueryDepth:5,maxRecordCountFactor:3};let j=class extends f{constructor(e){super({...O,...e}),this._buddyServicesQuery=null,this._relatedFeatures=null}async _open(){const e=await this._fetchServiceDefinition(this._config.source);e.timeInfo.trackIdField||a.getLogger(this).warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect.");const s=this._fetchWebSocketUrl(e.streamUrls,this._config.spatialReference);this._buddyServicesQuery||(this._buddyServicesQuery=this._queryBuddyServices()),await this._buddyServicesQuery,await this._tryCreateWebSocket(s);const{filter:t,outFields:r}=this._config;this.destroyed||this._setFilter(t,r)}_onMessage(e){if("attributes"in e){let s;try{s=this._enrich(e),this._featureZScaler!=null&&this._featureZScaler(s.geometry)}catch(t){return void a.getLogger(this).error(new c("geoevent-connection","Failed to parse message",t))}this.onFeature(s)}else this.onMessage(e)}async _fetchServiceDefinition(e){const s={f:"json",...this._config.customParameters},t=B(e.path,{query:s,responseType:"json"}),r=(await t).data;return this._serviceDefinition=r,r}_fetchWebSocketUrl(e,s){const t=e[0],{urls:r,token:o}=t,i=this._inferWebSocketBaseUrl(r);return S(`${i}/subscribe`,{outSR:""+s.wkid,token:o})}_inferWebSocketBaseUrl(e){if(e.length===1)return e[0];for(const s of e)if(s.includes("wss"))return s;return a.getLogger(this).error(new c("geoevent-connection","Unable to infer WebSocket url",e)),null}async _setFilter(e,s){const t=this._websocket;if(t==null||e==null&&s==null)return;const r=JSON.stringify({filter:this._serializeFilter(e,s)});let o=!1;const i=w(),l=()=>{o||(this.destroyed||this._websocket!==t||a.getLogger(this).error(new c("geoevent-connection","Server timed out when setting filter")),i.reject())},d=u=>{const n=JSON.parse(u.data);n.filter&&(n.error&&(a.getLogger(this).error(new c("geoevent-connection","Failed to set service filter",n.error)),this._set("errorString",`Could not set service filter - ${n.error}`),i.reject(n.error)),this._setWebSocketJSONParseHandler(t),o=!0,i.resolve())};return t.onmessage=d,t.send(r),setTimeout(l,T),i.promise}_serializeFilter(e,s){const t={};if(e==null&&s==null)return t;if(e?.geometry)try{const r=x(e.geometry);if(r.type!=="extent")throw new c("geoevent-connection",`Expected extent but found type ${r.type}`);t.geometry=JSON.stringify(r.shiftCentralMeridian())}catch(r){a.getLogger(this).error(new c("geoevent-connection","Encountered an error when setting connection geometryDefinition",r))}return e?.where&&e.where!=="1 = 1"&&e.where!=="1=1"&&(t.where=e.where),s!=null&&(t.outFields=s.join(",")),t}_enrich(e){if(!this._relatedFeatures)return e;const s=this._serviceDefinition.relatedFeatures.joinField,t=e.attributes[s],r=this._relatedFeatures.get(t);if(!r)return a.getLogger(this).warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",e),e;const{attributes:o,geometry:i}=r;for(const l in o)e.attributes[l]=o[l];return i&&(e.geometry=i),e.geometry||e.centroid||a.getLogger(this).error(new c("geoevent-connection","Found malformed feature - no geometry found",e)),e}async _queryBuddyServices(){try{const{relatedFeatures:e,keepLatestArchive:s}=this._serviceDefinition,t=this._queryRelatedFeatures(e),r=this._queryArchive(s);await t;const o=await r;if(!o)return;for(const i of o.features)this.onFeature(this._enrich(i))}catch(e){a.getLogger(this).error(new c("geoevent-connection","Encountered an error when querying buddy services",{error:e}))}}async _queryRelatedFeatures(e){if(!e)return;const s=await this._queryBuddy(e.featuresUrl);this._addRelatedFeatures(s)}async _queryArchive(e){if(e)return this._queryBuddy(e.featuresUrl)}async _queryBuddy(e){const s=new(await C(async()=>{const{default:F}=await D(()=>import("./FeatureLayer-BRWpcy_W-D7AhvLUt.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132]));return{default:F}},v([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132]))).default({url:e}),{capabilities:t}=await s.load(),r=t.query.supportsMaxRecordCountFactor,o=t.query.supportsPagination,i=t.query.supportsCentroid,l=this._config.maxRecordCountFactor,d=s.capabilities.query.maxRecordCount,u=r?d*l:d,n=new L;if(n.outFields=this._config.outFields??["*"],n.where=this._config.filter?.where??"1=1",n.returnGeometry=!0,n.returnExceededLimitFeatures=!0,n.outSpatialReference=U.fromJSON(this._config.spatialReference),i&&(n.returnCentroid=!0),r&&(n.maxRecordCountFactor=l),o)return n.num=u,s.destroy(),this._queryPages(e,n);const k=await _(e,n,this._config.sourceSpatialReference);return s.destroy(),k.data}async _queryPages(e,s,t=[],r=0){s.start=s.num!=null?r*s.num:null;const{data:o}=await _(e,s,this._config.sourceSpatialReference);return o.exceededTransferLimit&&r<(this._config.maxQueryDepth??0)?(o.features.forEach(i=>t.push(i)),this._queryPages(e,s,t,r+1)):(t.forEach(i=>o.features.push(i)),o)}_addRelatedFeatures(e){const s=new Map,t=e.features,r=this._serviceDefinition.relatedFeatures.joinField;for(const o of t){const i=o.attributes[r];s.set(i,o)}this._relatedFeatures=s}};j=h([y("esri.layers.graphics.sources.connections.GeoEventConnection")],j);let p=class extends g{constructor(e){super({}),this.connectionStatus="connected",this.errorString=null;const{geometryType:s,spatialReference:t,sourceSpatialReference:r}=e;this._featureZScaler=b(s,r,t)}normalizeCtorArgs(){return{}}updateCustomParameters(e){}sendMessageToSocket(e){}sendMessageToClient(e){if("type"in e)switch(e.type){case"features":case"featureResult":for(const s of e.features)this._featureZScaler!=null&&this._featureZScaler(s.geometry),this.onFeature(s)}this.onMessage(e)}};h([m()],p.prototype,"connectionStatus",void 0),h([m()],p.prototype,"errorString",void 0),p=h([y("esri.layers.support.ClientSideConnection")],p);function W(e,s){if(e==null&&s==null)return null;const t={};return s!=null&&(t.geometry=s),e!=null&&(t.where=e),t}function me(e,s,t,r,o,i,l,d,u){const n={source:e,sourceSpatialReference:s,spatialReference:t,geometryType:r,filter:W(o,i),maxReconnectionAttempts:l,maxReconnectionInterval:d,customParameters:u};return e?e.path.startsWith("wss://")||e.path.startsWith("ws://")?new f(n):new j(n):new p(n)}export{me as createConnection};
