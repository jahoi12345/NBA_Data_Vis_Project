import{s as O,y as $}from"./jsonUtils-BGiBUdmT.js";import{c as k}from"./floatRGBA-CCeie_ny.js";import{p as T}from"./imageUtils-Dd3IjdtB.js";import{Y as F,a as j,m as q}from"./CIMSymbolHelper-BoDeF39M.js";import{OverrideHelper as A}from"./OverrideHelper-CrYtylFK.js";import{T as S,R as G}from"./rasterizingUtils-DEMjiF3k.js";import{O as D}from"./utils-DX2muIr3.js";import"./Extent-D4kxmHSf.js";import"./jsonMap-Bs3hmeCU.js";import"./Point-B6yFWNoR.js";import"./reader-DcGs6kKN.js";import"./index-CAyy5ces.js";import"./Polyline-CiznIgZG.js";import"./Polygon-BUi4eoGW.js";import"./aaBoundingRect-F1Nk1aID.js";import"./mathUtils-PIGhLnI9.js";import"./lengthUtils-BsZbNiqt.js";import"./date-IqUzANpt.js";import"./reactiveUtils-SO2Ko3sy.js";import"./intl-BY86zs1L.js";import"./labelUtils-BtizwBfq.js";import"./ArcadeExpression-tLhjkIsm.js";import"./TimeOnly-CyjHJh3J.js";import"./enum-BzLwmiID.js";import"./UnknownTimeZone-B697BDFv.js";import"./FieldsIndex-DldSuWRM.js";import"./timeZoneUtils-BSc7-7qA.js";import"./TileKey-C44YQC4_.js";import"./Queue-CYlrXMwB.js";import"./SimpleObservable-CvFyr0NA.js";import"./ReactiveMap-B0by2bYu.js";import"./signal-BX9ezF8a.js";import"./BidiEngine-BvER9tXK.js";import"./screenUtils-BitdhK1O.js";import"./Font-DF-HycCW.js";import"./labelPoint-B4KnQcU5.js";import"./OptimizedFeature-CwRGZPwv.js";import"./memoryEstimations-Bd726a_p.js";import"./GeometryUtils-Baowv_lX.js";import"./mat2d-CH0tgjFI.js";import"./mat2df32-Dpt2CT5P.js";import"./vec2f32-CaVKkSa6.js";import"./defaults-CGwYBJxE.js";import"./SimpleFillSymbol-CDawtd9z.js";import"./Color-CERqXxxY.js";import"./SimpleMarkerSymbol-BGAFRS9_.js";import"./lineMarkers-CDwLe3J6.js";import"./TextSymbol-BjfCHbpC.js";import"./defaultsJSON-GKolV7NZ.js";import"./definitions-Dvg4hMIw.js";import"./colorUtils-CQgSrs28.js";import"./vec42-Cr02Pi7P.js";import"./vec4f64-DPb6J-GU.js";import"./callExpressionWithFeature-Dx8ZPhTw.js";import"./quantizationUtils-BHf4RTyd.js";class B{constructor(){this._resourceMap=new Map,this._inFlightResourceMap=new Map}destroy(){this._inFlightResourceMap.clear(),this._resourceMap.clear()}getResource(e){return this._resourceMap.get(e)??null}async fetchResource(e,s){const n=this._resourceMap.get(e);if(n)return{width:n.width,height:n.height};let p=this._inFlightResourceMap.get(e);return p?p.then(c=>({width:c.width,height:c.height})):(p=T(e,s),this._inFlightResourceMap.set(e,p),p.then(c=>(this._inFlightResourceMap.delete(e),this._resourceMap.set(e,c),{width:c.width,height:c.height}),()=>({width:0,height:0})))}deleteResource(e){this._inFlightResourceMap.delete(e),this._resourceMap.delete(e)}loadFont(e){return k(e)}}const H=96/72;class Jt{constructor(e){this._spatialReference=e,this._imageDataCanvas=null,this._cimResourceManager=new B}get _canvas(){return this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas")),this._imageDataCanvas}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(e,s,n,p,c,a,g,l,u,R){if(!e)return null;const{data:w}=e;if(!w||w.type!=="CIMSymbolReference"||!w.symbol)return null;const{symbol:C}=w;a||(a=D(C));const m=await A.resolveSymbolOverrides(w,s,this._spatialReference,c,a,g,l),f=this._cimResourceManager,_=[];F.fetchResources(m,f,_),F.fetchFonts(m,f,_),_.length>0&&await Promise.all(_);const{width:i,height:h}=n;let y=z(a,i,h,p,R);const t=F.getEnvelope(m,y,f);if(!t)return null;t.x===1/0&&(t.x=i+2),t.y===1/0&&(t.y=-h/2),t.width===-1/0&&(t.width=i),t.height===-1/0&&(t.height=h);let d=1,I=0,v=0;switch(C.type){case"CIMPointSymbol":case"CIMTextSymbol":{let r=1;t.width>i&&(r=i/t.width);let o=1;t.height>h&&(o=h/t.height),p==="preview"&&(t.width<i&&(r=i/t.width),t.height<h&&(o=h/t.height)),d=Math.min(r,o),I=t.x+t.width/2,v=t.y+t.height/2}break;case"CIMLineSymbol":if(R){v=t.y+t.height/2,I=t.x+t.width/2;const r=t.width-i,o=t.height-h;y={paths:S(y.paths,{xmin:-1*t.width/2+r,xmax:t.width/2-r,ymin:-1*t.height/2+o,ymax:t.height/2-o,width:t.width-2*r,height:t.height-2*o})}}else{(u||t.height>h)&&(d=h/t.height),v=t.y+t.height/2;const r=t.x*d+i/2,o=(t.x+t.width)*d+i/2,b=O(y)?y.paths:$(y)?y.rings:null;if(b===null)throw new Error("Bad geometry, can't rasterise symbol!");b[0][0][0]-=r/d,b[0][2][0]-=(o-i)/d}break;case"CIMPolygonSymbol":if(R){v=t.y+t.height/2,I=t.x+t.width/2;const r=t.width-i,o=t.height-h;y={paths:S(y.rings,{xmin:-1*t.width/2+r,xmax:t.width/2-r,ymin:-1*t.height/2+o,ymax:t.height/2-o,width:t.width-2*r,height:t.height-2*o})}}else{I=t.x+t.width/2,v=t.y+t.height/2;const r=t.x*d+i/2,o=(t.x+t.width)*d+i/2,b=t.y*d+h/2,P=(t.y+t.height)*d+h/2,{rings:M}=y;r<0&&(M[0][0][0]-=r,M[0][3][0]-=r,M[0][4][0]-=r),b<0&&(M[0][0][1]+=b,M[0][1][1]+=b,M[0][4][1]+=b),o>i&&(M[0][1][0]-=o-i,M[0][2][0]-=o-i),P>h&&(M[0][2][1]+=P-h,M[0][3][1]+=P-h)}}const E={type:"cim",data:{type:"CIMSymbolReference",symbol:m}};return this.rasterize(E,i,h,I,v,d,a,1,y)}rasterize(e,s,n,p,c,a,g,l=0,u=null,R=window.devicePixelRatio||1){const{data:w}=e;if(!w||w.type!=="CIMSymbolReference"||!w.symbol)return null;const{symbol:C}=w,m=this._canvas,f=R*H;m.width=s*f,m.height=n*f,g||(g=D(C)),u||(u=z(g,s,n,"legend")),m.width+=2*l,m.height+=2*l;const _=m.getContext("2d",{willReadFrequently:!0}),i=j.createIdentity();return i.translate(-p,-c),i.scale(a*f,-a*f),i.translate(s*f/2+l,n*f/2+l),_.clearRect(0,0,m.width,m.height),new q(_,this._cimResourceManager,i,!0).drawSymbol(C,u),_.getImageData(0,0,m.width,m.height)}}function L(x,e,s,n){return e==="esriGeometryPolygon"?{rings:G(S(x.rings,{xmin:0,ymin:0,width:s,height:n}),-1*s/2,-1*n/2)}:e==="esriGeometryPolyline"?{paths:G(S(x.paths,{xmin:0,ymin:0,width:s,height:n}),-1*s/2,-1*n/2)}:null}function z(x,e,s,n,p){const a=-e/2+1,g=e/2-1,l=s/2-1,u=-s/2+1;if(p&&(x==="esriGeometryPolygon"||x==="esriGeometryPolyline")){const R=L(p,x,e,s);if(R)return R}switch(x){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[a,0],[0,0],[g,0]]]};default:return n==="legend"?{rings:[[[a,l],[g,0],[g,u],[a,u],[a,l]]]}:{rings:[[[a,l],[g,l],[g,u],[a,u],[a,l]]]}}}export{Jt as CIMSymbolRasterizer};
