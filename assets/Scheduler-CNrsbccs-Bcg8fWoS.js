import{a4 as c,S as E,bI as D,N as h,a as O,ay as R,s as M,ah as o,t as b,r as Q,v as w,U as V,q as H,b as Y,w as x,I as W,Y as g,H as N,G as q}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{j,o as $,s as B}from"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import{n as l}from"./signal-BX9ezF8a-cf1Pn6io.js";let _=class extends H{constructor(){super(...arguments),this.SCHEDULER_LOG_SLOW_TASKS=!1,this.FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES=!1}};g([N()],_.prototype,"SCHEDULER_LOG_SLOW_TASKS",void 0),g([N()],_.prototype,"FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES",void 0),_=g([q("esri.views.support.debugFlags")],_);const X=new _,v=Symbol("Yield");class K{constructor(){this._tasks=new Array,this._numPendingTasks=l(0),this._readyToRun=l(!1)}get length(){return this._tasks.length}get updating(){return this._numPendingTasks.value>0}get readyToRun(){return this._readyToRun.value}_updateReadyToRun(){this._readyToRun.value=this._tasks.length>0}destroy(){this.cancelAll()}runTask(e){if(this.length===0)return v;for(;!e.done&&this._process(e);)e.madeProgress()}push(e,t,s){return this._addTask((a,n)=>new y(a,n,e,t,s),Array.prototype.push)}unshift(e,t,s){return this._addTask((a,n)=>new y(a,n,e,t,s),Array.prototype.unshift)}pushGenerator(e,t,s){return this._addTask((a,n)=>new z(a,n,e,t,s),Array.prototype.push)}_process(e){if(this._tasks.length===0)return!1;const t=this._tasks.shift();this._updateReadyToRun();try{if(c(t.signal))this._cancelTask(t,E());else switch(t.type){case 0:this._processSimple(t,e);break;case 1:this._processGenerator(t,e);break;case 2:this._processIterator(t,e);break;default:V(t)}}catch(s){t.reject(s)}return!0}cancelAll(){const e=E();for(const t of this._tasks)this._cancelTask(t,e);this._tasks.length=0,this._updateReadyToRun()}_cancelTask(e,t){if(e.abortCallback){const s=e.abortCallback(t);e.type===2&&e.iterator.return&&S(e.iterator.return()),h(s)?s.then(e.resolve,e.reject):e.resolve(s)}else e.type===2&&e.iterator.throw&&S(e.iterator.throw(t)),e.reject(t)}_onIteratorResult(e,t){t.done?e.resolve(t.value):(this._tasks.unshift(e),this._updateReadyToRun())}_processSimple(e,t){const s=e.callback(t);h(s)?s.then(e.resolve,e.reject):e.resolve(s)}_processGenerator(e,t){const s=e.generatorFunction(t),a=new J(e.resolve,e.reject,s,e.signal,e.abortCallback);this._processIterator(a,t)}_processIterator(e,t){const s=e.iterator.next(t);h(s)?s.then(a=>this._onIteratorResult(e,a),e.reject):this._onIteratorResult(e,s)}_addTask(e,t){return new Promise((s,a)=>{const n=e(s,a);t.call(this._tasks,n),++this._numPendingTasks.value,this._updateReadyToRun()}).finally(()=>--this._numPendingTasks.value)}}function S(i){h(i)?i.then(m,m):m(i)}function m(i){x(i)||i instanceof Error||i instanceof W||i!=null&&typeof i=="object"&&"done"in i&&i.done||w.getLogger("esri.layers.support.PromiseQueue").warn("Generator iterator was aborted, but it is not done.")}let I=class{constructor(i,e,t=void 0,s=void 0){this.resolve=i,this.reject=e,this.signal=t,this.abortCallback=s}};class y extends I{constructor(e,t,s,a,n){super(e,t,a,n),this.callback=s,this.type=0}}class z extends I{constructor(e,t,s,a,n){super(e,t,a,n),this.generatorFunction=s,this.type=1}}let J=class extends I{constructor(i,e,t,s,a){super(i,e,s,a),this.iterator=t,this.type=2}};function he(){return new re}const r={RESOURCE_CONTROLLER_IMMEDIATE:"immediate",RESOURCE_CONTROLLER:"schedule",SLIDE:"slide",STREAM_DATA_LOADER:"stream loader",ELEVATION_QUERY:"elevation query",TERRAIN_SURFACE:"terrain",SURFACE_GEOMETRY_UPDATES:"surface geometry updates",LOD_RENDERER:"LoD renderer",GRAPHICS_CORE:"Graphics3D",I3S_CONTROLLER:"I3S",POINT_CLOUD_LAYER:"point cloud",FEATURE_TILE_FETCHER:"feature fetcher",STREAM_CONTROLLER:"stream controller",OVERLAY:"overlay",OVERLAY_RENDERER:"overlay renderer",STAGE:"stage",GRAPHICS_DECONFLICTOR:"graphics deconflictor",FILTER_VISIBILITY:"Graphics3D filter visibility",SCALE_VISIBILITY:"Graphics3D scale visibility",FRUSTUM_VISIBILITY:"Graphics3D frustum visibility",POINT_OF_INTEREST_FREQUENT:"POI frequent",POINT_OF_INTEREST_INFREQUENT:"POI infrequent",LABELER:"labeler",FEATURE_QUERY_ENGINE:"feature query",FEATURE_TILE_TREE:"feature tile tree",FEATURE_TILE_TREE_ACTIVE:"fast feature tile tree",ELEVATION_ALIGNMENT:"elevation alignment",ELEVATION_ALIGNMENT_SCENE:"elevation alignment scene",TEXT_TEXTURE_ATLAS:"text texture atlas",TEXTURE_UNLOAD:"texture unload",LINE_OF_SIGHT_TOOL:"line of sight tool",LINE_OF_SIGHT_TOOL_INTERACTIVE:"interactive line of sight tool",ELEVATION_PROFILE:"elevation profile",SNAPPING:"snapping",SHADOW_ACCUMULATOR:"shadow accumulator",CLOUDS_GENERATOR:"clouds generator",FLOW_GENERATOR:"flow generator",MAPVIEW_FETCH_QUEUE:"mapview fetch queue",MAPVIEW_LAYERVIEW_UPDATE:"mapview layerview update",MAPVIEW_VECTOR_TILE_PARSING_QUEUE:"mapview vector tile parsing queue",NONE:0,TEST_PRIO:1},u=0,P=new Map([[r.RESOURCE_CONTROLLER_IMMEDIATE,u],[r.RESOURCE_CONTROLLER,4],[r.SLIDE,u],[r.STREAM_DATA_LOADER,u],[r.ELEVATION_QUERY,u],[r.TERRAIN_SURFACE,1],[r.SURFACE_GEOMETRY_UPDATES,1],[r.LOD_RENDERER,2],[r.GRAPHICS_CORE,2],[r.I3S_CONTROLLER,2],[r.POINT_CLOUD_LAYER,2],[r.FEATURE_TILE_FETCHER,2],[r.STREAM_CONTROLLER,2],[r.CLOUDS_GENERATOR,2],[r.OVERLAY,4],[r.OVERLAY_RENDERER,4],[r.STAGE,4],[r.GRAPHICS_DECONFLICTOR,4],[r.FILTER_VISIBILITY,4],[r.SCALE_VISIBILITY,4],[r.FRUSTUM_VISIBILITY,4],[r.POINT_OF_INTEREST_FREQUENT,6],[r.POINT_OF_INTEREST_INFREQUENT,30],[r.LABELER,8],[r.FEATURE_QUERY_ENGINE,8],[r.FEATURE_TILE_TREE,16],[r.FEATURE_TILE_TREE_ACTIVE,u],[r.ELEVATION_ALIGNMENT,12],[r.ELEVATION_ALIGNMENT_SCENE,14],[r.TEXT_TEXTURE_ATLAS,12],[r.TEXTURE_UNLOAD,12],[r.LINE_OF_SIGHT_TOOL,16],[r.LINE_OF_SIGHT_TOOL_INTERACTIVE,u],[r.SNAPPING,u],[r.SHADOW_ACCUMULATOR,30],[r.FLOW_GENERATOR,12],[r.MAPVIEW_FETCH_QUEUE,u],[r.MAPVIEW_LAYERVIEW_UPDATE,2],[r.MAPVIEW_VECTOR_TILE_PARSING_QUEUE,u]]);function U(i){return P.has(i)?P.get(i):typeof i=="number"?i:1}const Z=o(6.5),C=o(1),ee=o(30),te=o(1e3/30),se=o(100),F=.9;class re{get updating(){return this._updating.value}_updatingChanged(){this._updating.value=this._tasks.some(e=>e.needsUpdate)}constructor(){this._updating=l(!0),this._microTaskQueued=!1,this._frameNumber=0,this.performanceInfo={total:new R("total"),tasks:new Map},this._frameTaskTimes=new Map,this._budget=new f,this.state=1,this._tasks=new Array,this._runQueue=new Array,this._load=0,this._forceTask=!1,this._debug=!1,this._debugHandle=j(()=>X.SCHEDULER_LOG_SLOW_TASKS,e=>this._debug=e,$);for(const e of Object.keys(r))this.performanceInfo.tasks.set(r[e],new R(String(r[e])))}destroy(){this._tasks.forEach(e=>e.remove()),this._tasks.length=0,this._runQueue.length=0,M(this._debugHandle),this._microTaskQueued=!1,this._updatingChanged()}taskRunningChanged(e){this._updatingChanged(),e&&this._budget.remaining>0&&!this._microTaskQueued&&(this._microTaskQueued=!0,queueMicrotask(()=>{this._microTaskQueued&&(this._microTaskQueued=!1,this._budget.remaining>0&&this._schedule()&&this._runFrame())}))}registerTask(e,t){const s=new ae(this,e,t);return this._tasks.push(s),this._updatingChanged(),this.performanceInfo.tasks.has(e)||this.performanceInfo.tasks.set(e,new R(e)),s}get load(){return this._load}frame(e){if(this._startFrameTaskTimes(),this._updateBudget(e)){const t=this._budget.now();return this._runFrame(),this._recordFrameTaskTimes(this._budget.now()-t),!0}return this._recordFrameTaskTimes(0),!1}_updateBudget(e){this._test&&(this._test.usedBudget=0),++this._frameNumber;let t=Z,s=e.frameDuration,a=C;switch(this.state){case 2:t=o(0),s=o(Math.max(se,e.frameDuration)),a=ee;break;case 1:s=o(Math.max(te,e.frameDuration))}return s=o(s-e.elapsedFrameTime-t),this.state!==2&&s<C&&!this._forceTask?(this._forceTask=!0,!1):(s=o(Math.max(s,a)),this._budget.reset(s),this._updateLoad(),this._schedule())}_runFrame(){switch(this._forceTask=!1,this._microTaskQueued=!1,this.state){case 2:this._runIdle();break;case 1:this._runInteracting();break;default:this._runAnimating()}this._test&&(this._test.usedBudget=this._budget.elapsed)}stopFrame(){this._budget.reset(o(0)),this._budget.madeProgress()}removeTask(e){b(this._tasks,e),b(this._runQueue,e),this._updatingChanged()}_updateTask(e){this._tasks.forEach(t=>{t.name===e&&t.setPriority(e)})}_getState(e){if(this._runQueue.some(s=>s.name===e))return"s";let t="i";return this._tasks.forEach(s=>{s.name===e&&s.needsUpdate&&(s.schedulePriority<=1?t="r":t!=="r"&&(t="w"))}),t}_getRuntime(e){let t=0;return this._tasks.forEach(s=>{s.name===e&&(t+=s.runtime)}),t}_resetRuntimes(){this._tasks.forEach(e=>e.runtime=0)}_getRunning(){const e=new Map;if(this._tasks.forEach(s=>{s.needsUpdate&&e.set(s.name,(e.get(s.name)||0)+1)}),e.size===0)return null;let t="";return e.forEach((s,a)=>{t+=s>1?` ${s}x ${a}`:` ${a}`}),t}_runIdle(){this._run()}_runInteracting(){this._run()}_runAnimating(){this._run()}_updateLoad(){const e=this._tasks.reduce((t,s)=>s.needsUpdate?++t:t,0);this._load=this._load*F+e*(1-F)}_schedule(){for(Q(this._runQueue,e=>!!e.needsUpdate||(e.schedulePriority=e.basePriority,!1)),this._tasks.forEach(e=>{e.basePriority===u&&e.needsUpdate&&!this._runQueue.includes(e)&&e.blockFrame!==this._frameNumber&&this._runQueue.unshift(e)});this._runQueue.length===0;){let e=!1,t=0;if(this._tasks.forEach(s=>{s.needsUpdate&&s.schedulePriority!==0&&s.basePriority!==u&&s.blockFrame!==this._frameNumber&&(e=!0,t=Math.max(t,s.basePriority),s.schedulePriority===1?(s.schedulePriority=0,this._runQueue.push(s)):--s.schedulePriority)}),!e)return this._updatingChanged(),!1}return this._updatingChanged(),!0}_run(){do for(;this._runQueue.length>0;){const e=this._budget.now(),t=this._runQueue.pop();this._budget.resetProgress();try{t.task.runTask(this._budget)===v&&(t.blockFrame=this._frameNumber)}catch(a){w.getLogger("esri.views.support.Scheduler").error(`Exception in task "${t.name}"`,a),t.blockFrame=this._frameNumber}!this._budget.hasProgressed&&t.blockFrame!==this._frameNumber&&t.needsUpdate&&(t.name,t.blockFrame=this._frameNumber),t.schedulePriority=t.basePriority;const s=this._budget.now()-e;if(t.runtime+=s,this._frameTaskTimes.set(t.priority,this._frameTaskTimes.get(t.priority)+s),this._budget.remaining<=0)return void this._updatingChanged()}while(this._schedule());this._updatingChanged()}_startFrameTaskTimes(){for(const e of Object.keys(r))this._frameTaskTimes.set(r[e],0)}_recordFrameTaskTimes(e){this._frameTaskTimes.forEach((t,s)=>this.performanceInfo.tasks.get(s).push(t)),this.performanceInfo.total.push(e)}get test(){return this._test}}class ae{get task(){return this._task.value}get readyToRun(){return this._queue.readyToRun}get updating(){return this._queue.updating}constructor(e,t,s){this._scheduler=e,this.name=t,this.blockFrame=0,this.runtime=0,this._queue=new K,this._handles=new Y,this._basePriority=U(t),this.schedulePriority=this._basePriority,this._task=l(s??this._queue),this._handles.add(B(()=>this.task.readyToRun,a=>e.taskRunningChanged(a)))}remove(){this.processQueue(d),this._scheduler.removeTask(this),this.schedule=p.schedule,this.reschedule=p.reschedule,this.scheduleGenerator=p.scheduleGenerator,this._handles.destroy()}get basePriority(){return this._basePriority}setPriority(e){if(this.name===e)return;this.name=e;const t=U(e);this._basePriority!==u&&this.schedulePriority===0||(this.schedulePriority=t),this._basePriority=t}get priority(){return this.name}set priority(e){this.setPriority(e)}get needsUpdate(){return this.readyToRun||!this.task.destroyed&&this.task.readyToRun}schedule(e,t,s){return this._queue.push(e,t,s)}reschedule(e,t,s){return this._queue.unshift(e,t,s)}scheduleGenerator(e,t,s){return this._queue.pushGenerator(e,t,s)}processQueue(e){return this._queue.runTask(e)}}class f{constructor(){this._begin=performance?.now()??0,this._budget=0,this._done=!1,this._progressed=!1,this._enabled=!0}run(e){return!this.done&&(e()===!0&&this.madeProgress(),!0)}get done(){return this._done}get budget(){return this._budget}madeProgress(){return this._progressed=!0,this._done=this.elapsed>=this._budget&&this._enabled,this._done}get enabled(){return this._enabled}set enabled(e){this._enabled=e}reset(e){this._begin=this.now(),this._budget=e,this.resetProgress()}get remaining(){return Math.max(this._budget-this.elapsed,0)}now(){return performance.now()}get elapsed(){return this.now()-this._begin}resetProgress(){this._progressed=!1,this._done=!1}get hasProgressed(){return this._progressed}}const d=new f;function _e(i){const e=new f;return e.reset(i),e}d.enabled=!1;class ie{remove(){}processQueue(){}schedule(e,t,s){try{if(c(t)){const a=E();return s?Promise.resolve(s(a)):Promise.reject(a)}return D(e(d))}catch(a){return Promise.reject(a)}}reschedule(e,t,s){return this.schedule(e,t,s)}async scheduleGenerator(e,t,s){if(c(t)){const n=E();if(s)return s(n);throw n}const a=e(d);for(;;){const n=a.next(d),A=h(n)?await n:n;if(c(t)){const T=E();if(s){const G=s(T),k=a.return(null);return h(k)&&await O(k),G}const L=a.throw(T);throw h(L)&&await O(L),T}if(A.done)return A.value}}}const p=new ie;export{he as E,K,X,_e as a,d,p,r,v};
