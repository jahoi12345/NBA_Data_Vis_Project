import{o as x,r as et}from"./arcadeEnvironment-DqZGrNFy-B7LAcj80.js";import{j as W,q as g,V as q,Z as J,M as S,E as y,H as Z,K as rt,A as v,g as p,T as U,b as u,a as A,n as xt,d as St,B as G,w as E,L as ot,u as at,$ as nt,a4 as Ft,f as D,R as It,e as X}from"./Dictionary-B4WY1XGX-DPfLsCo2.js";import{o as kt,i as it,s as st,j as Ot,E as Mt,P as Rt,g as Ct,C as Nt,a as At,b as Et,y as Bt,d as z,f as lt,c as jt,p as $t}from"./arcade-zfxT_nQK-BUKByHhX.js";import{u as n,x as ct}from"./enum-BzLwmiID-CcyIdWlQ.js";import{I as ut}from"./Feature-BVRwBUzm-CdKSTB7Z.js";import{T as Gt}from"./aiServices-BQaMAyiK-Bd9y7e2i.js";import{registerFunctions as Kt}from"./geomasync-g54M5al--BON99H2m.js";import{v as Zt}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{f as ft,c as Y}from"./Point-BfTTZoMu-DeJwQYfh.js";import{K as _t,W as k,f as h,Z as B,J as N}from"./lengthUtils-Dt1_RvOO-j3MEdmHu.js";import"./UnknownTimeZone-B697BDFv-CBbtul7O.js";import"./date-IqUzANpt-bLKO9IDT.js";import"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import"./Extent-CgDMOSRD-Bod5LY6s.js";import"./Field-Cm_ZejYW-CwJZmSru.js";import"./Color-CERqXxxY-BuYn26eI.js";import"./mathUtils-PIGhLnI9-B1tKUlUb.js";import"./fieldType-DVUzXtk_-tUuvnZJM.js";import"./Polyline-CoiTLswR-DTxpB2Yg.js";import"./Polygon-D6wEPb3W-D2MPjRU4.js";import"./index-B0z_nLWi.js";import"./WhereClause-BSVqskBz-CT_IXPhv.js";import"./unitConversion-C1kMoaUu-BTuDmVw5.js";import"./collectionUtils-jDyktm0P-BDP2Oq99.js";import"./aaBoundingBox-Cn49X7ge-BcYPaJ58.js";import"./mat4f64-q_b6UJoq-Dh6sWB_w.js";import"./workers-BEkgoq8Q-BM_Hz460.js";import"./intl-DRFqUect-DPhFaHB2.js";import"./TimeOnly-BERR31kg-CQiLyUZi.js";import"./ImmutableArray-BPVd6ESQ-BGk4ZTNG.js";import"./shared-yd-CR64C-BEo7YVMh.js";import"./number-D_FvV3D1-OQFavbmh.js";import"./jsonUtils-CmpazY1u-6pDLj5sx.js";import"./streamLayerUtils-DFlbJ4P1-DFlbJ4P1.js";import"./hash-CcEbRgUF-DpReY683.js";import"./uuid-Oe6SV2kF-IYX19xBA.js";import"./featureConversionUtils-BDA_FXJx-CDxX1Wik.js";import"./aaBoundingRect-CjwcS2F3-ri8bmh30.js";import"./OptimizedFeature-CwRGZPwv-Ddclhn0A.js";import"./memoryEstimations-Bd726a_p-0cVCY2Jz.js";import"./OptimizedFeatureSet-BR8EEvDc-CgsRgxJh.js";import"./createFeatureId-CVwTD0fV-3fKpJDrk.js";import"./DoubleArray-DExKNiTh-CvVpHySW.js";import"./FieldsIndex-CimK-TqD--24JoCkp.js";import"./timeZoneUtils-BSc7-7qA-BAv3h8mh.js";import"./commonProperties-DHiB1uzW-DHiB1uzW.js";import"./utils-CylVuxNi--x86XOjU.js";import"./reader-DcGs6kKN-DHJfK-tm.js";import"./SimpleObservable-CvFyr0NA-DXpoMYph.js";import"./portalUtils-CnpwenOG-DKdnPlyB.js";import"./operatorsWorkerConnection-DB7Gw949-xZQu01kQ.js";import"./Queue-CYlrXMwB-CYJTUII-.js";const P=()=>Zt.getLogger("esri.arcade.arcadeAsyncRuntime"),M=Symbol("uninitialized");function K(e){if(e===M)throw new n(null,"InvalidIdentifier",null)}function pt(e){return K(e),e}function R(e,t){const r=x(t);if(e.localScope!==null){const i=e.localScope[r];if(i!==void 0)return{scope:e.localScope,id:r,var:i}}const o=e.globalScope[r];if(o!==void 0)return{scope:e.globalScope,id:r,var:o};throw new n(e,"InvalidIdentifier",t)}function wt(e,t,r="InvalidIdentifier"){const o=x(t);if(e.localScope!==null){const s=e.localScope[o];if(s!==void 0)return K(s),s.value}const i=e.globalScope[o];if(i!==void 0)return K(i),i.value;throw new n(e,r,t)}const j=function(){};async function dt(e,t){const r=[];for(let o=0;o<t.arguments.length;o++)r.push(await c(e,t.arguments[o]));return r}async function b(e,t,r){return t.preparsed===!0?r(e,null,t.arguments):r(e,t,await dt(e,t))}j.prototype=Object.freeze(Object.create(null));class Lt extends It{constructor(t,r,o,i){super(),this.definition=t,this.context=r,this._params=o,this._locals=i}createFunction(t){return(...r)=>{const o={spatialReference:this.context.spatialReference,console:this.context.console,lrucache:this.context.lrucache,timeZone:this.context.timeZone??null,exports:this.context.exports,libraryResolver:this.context.libraryResolver,interceptor:this.context.interceptor,services:this.context.services,abortSignal:this.context.abortSignal,localScope:new j,depthCounter:{depth:t.depthCounter.depth+1},globalScope:this.context.globalScope,track:this.context.track};if(o.depthCounter.depth>64)throw new n(t,"MaximumCallDepth",null);return L(o,this.definition.body,this._params,this._locals,r,null)}}call(t,r){return T(t,r,(o,i,s)=>{const a={spatialReference:t.spatialReference,services:t.services,console:t.console,libraryResolver:t.libraryResolver,exports:t.exports,lrucache:t.lrucache,timeZone:t.timeZone??null,interceptor:t.interceptor,localScope:new j,abortSignal:t.abortSignal,globalScope:t.globalScope,depthCounter:{depth:t.depthCounter.depth+1},track:t.track};if(a.depthCounter.depth>64)throw new n(t,"MaximumCallDepth",r);return L(a,this.definition.body,this._params,this._locals,s,r)})}marshalledCall(t,r,o,i){return i(t,r,async(s,a,l)=>{const f={spatialReference:t.spatialReference,services:t.services,globalScope:o.globalScope,depthCounter:{depth:t.depthCounter.depth+1},libraryResolver:t.libraryResolver,exports:t.exports,console:t.console,abortSignal:t.abortSignal,lrucache:t.lrucache,timeZone:t.timeZone??null,interceptor:t.interceptor,localScope:new j,track:t.track};return l=l.map(w=>!S(w)||w instanceof D?w:X(w,t,i)),X(await L(f,this.definition.body,this._params,this._locals,l,r),o,i)})}}async function L(e,t,r,o,i,s){if(r.length!==i.length)throw new n(e,"WrongNumberOfParameters",s);if(e.localScope!=null){for(let l=0;l<r.length;l++)e.localScope[r[l]]={value:i[l]};for(const l of o)e.localScope[l]=M}const a=await m(e,t);if(a instanceof g)return a.value;if(a===y)throw new n(e,"UnexpectedToken",s);if(a===Z)throw new n(e,"UnexpectedToken",s);return a instanceof q?a.value:a}class I extends Ft{constructor(t){super(),this.moduleGlobalContext=t}global(t){const r=x(t),o=this.moduleGlobalContext.globalScope[r];if(K(o),S(o.value)&&!(o.value instanceof D)){const i=new D;return i.fn=o.value,i.parameterEvaluator=b,i.context=this.moduleGlobalContext,this.moduleGlobalContext.globalScope[r]={value:i},i}return o.value}setGlobal(t,r){if(S(r))throw new n(null,"AssignModuleFunction",null);const o=x(t);if(this.moduleGlobalContext.globalScope[o]===void 0)throw new n(null,"ModuleExportNotFound",null);this.moduleGlobalContext.globalScope[o]={value:r}}hasGlobal(t){return this.moduleGlobalContext.exports.has(x(t))}static async load(t,r){const{globals:o,exports:i}=it(r),s=new Q;for(const f of o)f in s||(s[f]=M);const a=t.spatialReference??ft.WebMercator,l={lrucache:t.lrucache,interceptor:t.interceptor,services:t.services,console:t.console??vt,abortSignal:t.abortSignal??et,timeZone:t.timeZone??null,spatialReference:a,track:null,depthCounter:{depth:1},libraryResolver:new st(t.libraryResolver._moduleSingletons,r.loadedModules),exports:i,localScope:null,globalScope:s};return await V(l,r),new I(l)}}async function T(e,t,r){return t.preparsed===!0?r(e,null,t.arguments):r(e,t,await dt(e,t))}async function c(e,t){t.breakpoint&&await t.breakpoint();try{switch(t.type){case"UpdateExpression":return await Vt(e,t);case"AssignmentExpression":return await Ht(e,t);case"TemplateLiteral":return await ue(e,t);case"Identifier":return H(e,t);case"MemberExpression":return await ae(e,t);case"Literal":return t.value;case"CallExpression":return await ce(e,t);case"UnaryExpression":return await ne(e,t);case"BinaryExpression":return await se(e,t);case"LogicalExpression":return await le(e,t);case"ArrayExpression":return await ie(e,t);case"ObjectExpression":return await Ut(e,t);default:throw new n(e,"Unrecognized",t)}}catch(r){throw ct(e,t,r)}}async function m(e,t){t.breakpoint&&await t.breakpoint();try{switch(t.type){case"ImportDeclaration":return await te(e,t);case"ExportNamedDeclaration":return await ee(e,t);case"VariableDeclaration":return await re(e,t);case"BlockStatement":return await V(e,t);case"FunctionDeclaration":return await Yt(e,t);case"ReturnStatement":return await Xt(e,t);case"IfStatement":return await Jt(e,t);case"ExpressionStatement":return await Qt(e,t);case"ForStatement":return await zt(e,t);case"WhileStatement":return await Dt(e,t);case"ForInStatement":return await qt(e,t);case"ForOfStatement":return await Tt(e,t);case"BreakStatement":return y;case"EmptyStatement":return p;case"ContinueStatement":return Z;default:throw new n(e,"Unrecognized",t)}}catch(r){throw ct(e,t,r)}}async function Ut(e,t){const r=[];for(let a=0;a<t.properties.length;a++){const l=t.properties[a],f=await c(e,l.value),w=l.key.type==="Identifier"?l.key.name:await c(e,l.key);r[a]={key:w,value:f}}const o=Object.create(null),i=new Map;for(let a=0;a<r.length;a++){const l=r[a];if(S(l.value))throw new n(e,"NoFunctionInDictionary",t);if(h(l.key)===!1)throw new n(e,"KeyMustBeString",t);let f=l.key.toString();const w=f.toLowerCase();i.has(w)?f=i.get(w):i.set(w,f),l.value===p?o[f]=null:o[f]=l.value}const s=new v(o);return s.immutable=!1,s}async function Dt(e,t){let r=await c(e,t.test);if(r===!1)return p;if(r!==!0)throw new n(e,"BooleanConditionRequired",t);for(;r===!0;){const o=await m(e,t.body);if(o===y)break;if(o instanceof g)return o;if(r=await c(e,t.test),r!==!0&&r!==!1)throw new n(e,"BooleanConditionRequired",t)}return p}async function zt(e,t){try{for(t.init!==null&&(t.init.type==="VariableDeclaration"?await m(e,t.init):await c(e,t.init));;){if(t.test!==null){const o=await c(e,t.test);if(e.abortSignal?.aborted===!0)throw new n(e,"Cancelled",t);if(o===!1)break;if(o!==!0)throw new n(e,"BooleanConditionRequired",t)}const r=await m(e,t.body);if(r===y)break;if(r instanceof g)return r;t.update!==null&&await c(e,t.update)}return p}catch(r){throw r}}async function $(e,t,r,o,i="i"){const s=r.length;for(let a=0;a<s;a++){if(i==="k"){if(a>=r.length)throw new n(e,"OutOfBounds",t);o.scope[o.id]={value:r[a]}}else o.scope[o.id]={value:a};const l=await m(e,t.body);if(l===y)break;if(l instanceof g)return l}return p}async function ht(e,t,r,o,i="i"){const s=r.length();for(let a=0;a<s;a++){o.scope[o.id]=i==="k"?{value:r.get(a)}:{value:a};const l=await m(e,t.body);if(l===y)break;if(l instanceof g)return l}return p}async function mt(e,t,r,o){const i=r.iterator(e.abortSignal);let s;for(;(s=await i.next())!=null;){const a=ut.createFromGraphicLikeObject(s.geometry,s.attributes,r,e.timeZone);a._underlyingGraphic=s,o.scope[o.id]={value:a};const l=await m(e,t.body);if(l===y)break;if(l instanceof g)return l}return p}async function Pt(e,t,r,o){for(const i of r.keys()){const s=r.field(i);o.scope[o.id]={value:v.containerEntry(i,s)};const a=await m(e,t.body);if(a===y)break;if(a instanceof g)return a}return p}async function Wt(e,t,r,o){for(const i of lt(r)){const s=z(r,i,e,t,1);o.scope[o.id]={value:v.containerEntry(i,s)};const a=await m(e,t.body);if(a===y)break;if(a instanceof g)return a}return p}async function qt(e,t){const r=await c(e,t.right);t.left.type==="VariableDeclaration"&&await m(e,t.left);const o=R(e,t.left.type==="VariableDeclaration"?t.left.declarations[0].id:t.left);return B(r)||h(r)?await $(e,t,r,o):E(r)?await ht(e,t,r,o):r instanceof v||G(r)?await $(e,t,r.keys(),o,"k"):at(r)?await mt(e,t,r,o):nt(r)?await $(e,t,lt(r),o,"k"):p}async function Tt(e,t){const r=await c(e,t.right);t.left.type==="VariableDeclaration"&&await m(e,t.left);const o=R(e,t.left.type==="VariableDeclaration"?t.left.declarations[0].id:t.left);return B(r)||h(r)?await $(e,t,r,o,"k"):E(r)?await ht(e,t,r,o,"k"):r instanceof v||G(r)?await Pt(e,t,r,o):at(r)?await mt(e,t,r,o):nt(r)?await Wt(e,t,r,o):p}async function Vt(e,t){const r=t.argument;if(r.type==="CallExpression")throw new n(e,"NeverReach",t);if(r.type==="MemberExpression"){const a=await c(e,r.object);let l,f;if(r.computed===!0)l=await c(e,r.property);else{if(r.property.type!=="Identifier")throw new n(e,"Unrecognized",t);l=r.property.name}if(B(a)){if(!N(l))throw new n(e,"ArrayAccessMustBeNumber",t);if(l<0&&(l=a.length+l),l<0||l>=a.length)throw new n(e,"OutOfBounds",t);f=u(a[l]),a[l]=t.operator==="++"?f+1:f-1}else if(a instanceof v){if(h(l)===!1)throw new n(e,"KeyAccessorMustBeString",t);if(a.hasField(l)!==!0)throw new n(e,"FieldNotFound",t,{key:l});f=u(a.field(l)),a.setField(l,t.operator==="++"?f+1:f-1)}else if(a instanceof I){if(h(l)===!1)throw new n(e,"ModuleAccessorMustBeString",t);if(a.hasGlobal(l)!==!0)throw new n(e,"ModuleExportNotFound",t);f=u(a.global(l)),a.setGlobal(l,t.operator==="++"?f+1:f-1)}else{if(!ot(a))throw E(a)?new n(e,"Immutable",t):new n(e,"InvalidParameter",t);if(h(l)===!1)throw new n(e,"KeyAccessorMustBeString",t);if(a.hasField(l)!==!0)throw new n(e,"FieldNotFound",t,{key:l});f=u(a.field(l)),a.setField(l,t.operator==="++"?f+1:f-1)}return t.prefix===!1?f:t.operator==="++"?f+1:f-1}const o=R(e,r),i=u(pt(o.var).value),s=t.operator==="++"?i+1:i-1;return o.scope[o.id]={value:s},t.prefix===!1?i:t.operator==="++"?i+1:i-1}function F(e,t,r,o,i){switch(t){case"=":return e===p?null:e;case"/=":return u(r)/u(e);case"*=":return u(r)*u(e);case"-=":return u(r)-u(e);case"+=":return h(r)||h(e)?A(r)+A(e):u(r)+u(e);case"%=":return u(r)%u(e);default:throw new n(i,"UnsupportedOperator",o)}}async function Ht(e,t){const r=t.left;if(r.type==="MemberExpression"){const s=await c(e,r.object);let a;if(r.computed===!0)a=await c(e,r.property);else{if(r.property.type!=="Identifier")throw new n(e,"InvalidIdentifier",t);a=r.property.name}const l=await c(e,t.right);if(B(s)){if(!N(a))throw new n(e,"ArrayAccessMustBeNumber",t);if(a<0&&(a=s.length+a),a<0||a>s.length)throw new n(e,"OutOfBounds",t);if(a===s.length){if(t.operator!=="=")throw new n(e,"OutOfBounds",t);s[a]=F(l,t.operator,s[a],t,e)}else s[a]=F(l,t.operator,s[a],t,e)}else if(s instanceof v){if(h(a)===!1)throw new n(e,"KeyAccessorMustBeString",t);if(s.hasField(a)===!0)s.setField(a,F(l,t.operator,s.field(a),t,e));else{if(t.operator!=="=")throw new n(e,"FieldNotFound",t,{key:a});s.setField(a,F(l,t.operator,null,t,e))}}else if(s instanceof I){if(h(a)===!1)throw new n(e,"KeyAccessorMustBeString",t);if(s.hasGlobal(a)!==!0)throw new n(e,"ModuleExportNotFound",t);s.setGlobal(a,F(l,t.operator,s.global(a),t,e))}else{if(!ot(s))throw E(s)?new n(e,"Immutable",t):new n(e,"InvalidParameter",t);if(h(a)===!1)throw new n(e,"KeyAccessorMustBeString",t);if(s.hasField(a)===!0)s.setField(a,F(l,t.operator,s.field(a),t,e));else{if(t.operator!=="=")throw new n(e,"FieldNotFound",t,{key:a});s.setField(a,F(l,t.operator,null,t,e))}}return p}const o=R(e,r),i=await c(e,t.right);return o.scope[o.id]={value:F(i,t.operator,t.operator!=="="?pt(o.var).value:null,t,e)},p}async function Qt(e,t){const r=await c(e,t.expression);return r===p?p:new q(r)}async function Jt(e,t){const r=await c(e,t.test);if(r===!0)return m(e,t.consequent);if(r===!1)return t.alternate!==null?m(e,t.alternate):p;throw new n(e,"BooleanConditionRequired",t)}async function V(e,t){return gt(e,t,0)}async function gt(e,t,r){if(r>=t.body.length)return p;const o=await m(e,t.body[r]);return o instanceof g||o===y||o===Z||r===t.body.length-1?o:gt(e,t,r+1)}async function Xt(e,t){if(t.argument===null)return new g(p);const r=await c(e,t.argument);return new g(r)}async function Yt(e,t){if(e.localScope!=null)throw P().error("Function declarations are only valid in global scope."),new n(e,"NeverReach",t);const r=x(t.id);if(!(r in e.globalScope))throw P().error(`Function "${r}" not declared.`),new n(e,"NeverReach",t);const o=jt(t),i=t.params.map(a=>x(a)),s=Array.from(o).filter(a=>!i.includes(a));return e.globalScope[r]={value:new Lt(t,e,i,s)},p}async function te(e,t){const r=R(e,t.specifiers[0].local),o=e.libraryResolver;if(o==null)throw P().error("Internal error: module loader not initialized"),new n(e,"NeverReach",t);const i=o.loadLibrary(r.id);let s;return o._moduleSingletons?.has(i.uri)?s=o._moduleSingletons.get(i.uri):(s=await I.load(e,i.syntax),o._moduleSingletons?.set(i.uri,s)),r.scope[r.id]={value:s},p}async function ee(e,t){return await m(e,t.declaration),p}async function re(e,t){for(const r of t.declarations)await oe(e,r);return p}async function oe(e,t){let r=null;r=t.init===null?null:await c(e,t.init),r===p&&(r=null);const o=R(e,t.id);o.scope[o.id]={value:r}}async function ae(e,t){const r=await c(e,t.object);if(r===null)throw new n(e,"MemberOfNull",t);if(t.computed===!1){if(t.property.type==="Identifier"){if(r instanceof v||G(r))return r.field(t.property.name);if(r instanceof Y)return z(r,t.property.name,e,t);if(r instanceof I){if(!r.hasGlobal(t.property.name))throw new n(e,"InvalidIdentifier",t);return r.global(t.property.name)}throw new n(e,"InvalidMemberAccessKey",t)}throw new n(e,"InvalidMemberAccessKey",t)}let o=await c(e,t.property);if(r instanceof v||G(r)){if(h(o))return r.field(o);throw new n(e,"InvalidMemberAccessKey",t)}if(r instanceof I){if(h(o))return r.global(o);throw new n(e,"InvalidMemberAccessKey",t)}if(r instanceof Y){if(h(o))return z(r,o,e,t);throw new n(e,"InvalidMemberAccessKey",t)}if(B(r)){if(N(o)&&isFinite(o)&&Math.floor(o)===o){if(o<0&&(o=r.length+o),o>=r.length||o<0)throw new n(e,"OutOfBounds",t);return r[o]}throw new n(e,"InvalidMemberAccessKey",t)}if(E(r)){if(N(o)&&isFinite(o)&&Math.floor(o)===o){if(o<0&&(o=r.length()+o),o>=r.length()||o<0)throw new n(e,"OutOfBounds",t);return r.get(o)}throw new n(e,"InvalidMemberAccessKey",t)}if(h(r)){if(N(o)&&isFinite(o)&&Math.floor(o)===o){if(o<0&&(o=r.length+o),o>=r.length||o<0)throw new n(e,"OutOfBounds",t);return r[o]}throw new n(e,"InvalidMemberAccessKey",t)}throw new n(e,"InvalidMemberAccessKey",t)}async function ne(e,t){const r=await c(e,t.argument);if(k(r)){if(t.operator==="!")return!r;if(t.operator==="-")return-1*u(r);if(t.operator==="+")return 1*u(r);if(t.operator==="~")return~u(r);throw new n(e,"UnsupportUnaryOperator",t)}if(t.operator==="-")return-1*u(r);if(t.operator==="+")return 1*u(r);if(t.operator==="~")return~u(r);throw new n(e,"UnsupportUnaryOperator",t)}async function ie(e,t){const r=[];for(let o=0;o<t.elements.length;o++)r.push(await c(e,t.elements[o]));for(let o=0;o<r.length;o++){if(S(r[o]))throw new n(e,"NoFunctionInArray",t);r[o]===p&&(r[o]=null)}return r}async function se(e,t){const r=await c(e,t.left),o=await c(e,t.right);switch(t.operator){case"|":case"<<":case">>":case">>>":case"^":case"&":return St(u(r),u(o),t.operator);case"==":return U(r,o);case"!=":return!U(r,o);case"<":case">":case"<=":case">=":return xt(r,o,t.operator);case"+":return h(r)||h(o)?A(r)+A(o):u(r)+u(o);case"-":return u(r)-u(o);case"*":return u(r)*u(o);case"/":return u(r)/u(o);case"%":return u(r)%u(o);default:throw new n(e,"UnsupportedOperator",t)}}async function le(e,t){const r=await c(e,t.left);if(!k(r))throw new n(e,"LogicalExpressionOnlyBoolean",t);switch(t.operator){case"||":{if(r===!0)return r;const o=await c(e,t.right);if(k(o))return o;throw new n(e,"LogicExpressionOrAnd",t)}case"&&":{if(r===!1)return r;const o=await c(e,t.right);if(k(o))return o;throw new n(e,"LogicExpressionOrAnd",t)}default:throw new n(e,"LogicExpressionOrAnd",t)}}function H(e,t){return wt(e,t)}async function ce(e,t){if(t.callee.type==="MemberExpression"){const o=await c(e,t.callee.object);if(!(o instanceof I))throw new n(e,"FunctionNotFound",t);const i=t.callee.computed===!1?t.callee.property.name:await c(e,t.callee.property);if(!o.hasGlobal(i))throw new n(e,"FunctionNotFound",t);const s=o.global(i);if(!S(s))throw new n(e,"CallNonFunction",t);return s.call(e,t)}if(t.callee.type!=="Identifier")throw new n(e,"FunctionNotFound",t);const r=wt(e,t.callee,"FunctionNotFound");if(S(r))return r.call(e,t);throw new n(e,"CallNonFunction",t)}async function ue(e,t){let r="",o=0;for(const i of t.quasis)if(r+=i.value?i.value.cooked:"",i.tail===!1){if(t.expressions[o]){const s=await c(e,t.expressions[o]);if(S(s))throw new n(e,"NoFunctionInTemplateLiteral",t);r+=A(s)}o++}return r}async function fe(e,t){rt(t.arguments===null?[]:t.arguments,3,3,e,t);const r=await c(e,t.arguments[0]);if(k(r)===!1)throw new n(e,"BooleanConditionRequired",t);return c(e,r?t.arguments[1]:t.arguments[2])}async function pe(e,t){rt(t.arguments===null?[]:t.arguments,2,3,e,t);const r=await c(e,t.arguments[0]);if(t.arguments.length===3){const o=await c(e,t.arguments[1]),i=Bt(r,o);return i!=null&&i!==""?i:c(e,t.arguments[2])}return r==null||r===""?c(e,t.arguments[1]):r}async function we(e,t){if(t.arguments.length<2)throw new n(e,"WrongNumberOfParameters",t);if(t.arguments.length===2)return c(e,t.arguments[1]);if((t.arguments.length-1)%2==0)throw new n(e,"WrongNumberOfParameters",t);return yt(e,t,1,await c(e,t.arguments[0]))}async function yt(e,t,r,o){const i=await c(e,t.arguments[r]);if(U(i,o))return c(e,t.arguments[r+1]);const s=t.arguments.length-r;return s===1?c(e,t.arguments[r]):s===2?null:s===3?c(e,t.arguments[r+2]):yt(e,t,r+2,o)}async function de(e,t){if(t.arguments.length<3)throw new n(e,"WrongNumberOfParameters",t);if(t.arguments.length%2==0)throw new n(e,"WrongNumberOfParameters",t);const r=await c(e,t.arguments[0]);if(k(r)===!1)throw new n(e,"BooleanConditionRequired",t.arguments[0]);return bt(e,t,0,r)}async function bt(e,t,r,o){if(o===!0)return c(e,t.arguments[r+1]);if(t.arguments.length-r===3)return c(e,t.arguments[r+2]);const i=await c(e,t.arguments[r+2]);if(k(i)===!1)throw new n(e,"ModuleExportNotFound",t.arguments[r+2]);return bt(e,t,r+2,i)}function he(){const e=Object.create(null);Ot(e,b),Mt(e,b),Rt(e,b,H),Ct(e,b),Nt(e,b),At(e,b),Et(e,b),Kt({functions:e,compiled:!1,signatures:null,evaluateIdentifier:null,mode:"async",standardFunction:b,standardFunctionAsync:T}),e.iif=fe,e.defaultvalue=pe,e.decode=we,e.when=de;const t=function(){this.textformatting={value:v.textFormatting()}};t.prototype=Object.create(null),t.prototype.infinity=Object.freeze({value:Number.POSITIVE_INFINITY}),t.prototype.pi=Object.freeze({value:Math.PI});for(const[r,o]of Object.entries(e))t.prototype[r]=Object.freeze({value:new W(o)});return t}const Q=he();function tt(e){const t={mode:"async",compiled:!1,functions:Object.create(null),signatures:[],standardFunction:b,standardFunctionAsync:T,evaluateIdentifier:H};for(let r=0;r<e.length;r++)e[r].registerFunctions(t);for(const[r,o]of Object.entries(t.functions))Q.prototype[r]=Object.freeze({value:new W(o)});for(let r=0;r<t.signatures.length;r++)kt(t.signatures[r],"async")}function vt(e){console.log(e)}function me(e,t){const r=new Set(Object.keys(t?.vars||{}).map(a=>x(a))),o=new Set(Object.keys(t?.customfunctions||{}).map(a=>x(a))),{globals:i,exports:s}=it(e);return async a=>{const l=a.spatialReference??ft.WebMercator;let f=null;e.usesModules&&(f=new st(new Map,e.loadedModules));const w=new Q;for(const d of o)a.customfunctions!=null&&d in a.customfunctions?w[d]={value:new W(a.customfunctions[d])}:w[d]=M;for(const d of r){if(a.vars==null||!(d in a.vars)){d in w||(w[d]=M);continue}const _=a.vars[d]??null;_t(_)?w[d]={value:ut.createFromGraphic(_,a.timeZone??null)}:w[d]={value:_}}for(const d of i)d in w||(w[d]=M);const C={lrucache:a.lrucache,interceptor:a.interceptor,services:a.services,console:a.console??vt,abortSignal:a.abortSignal??et,timeZone:a.timeZone??null,spatialReference:l,track:a.track,depthCounter:{depth:1},libraryResolver:f,exports:s,localScope:null,globalScope:w},O=await V(C,e);if(O instanceof g||O instanceof q){const d=O.value;if(J(d))return null;if(S(d))throw new n(C,"IllegalResult",null);return d}if(J(O))return null;throw O===y?new n(C,"IllegalResult",null):O===Z?new n(C,"IllegalResult",null):new n(C,"NeverReach",null)}}function hr(e,t){return me(e,t)(t)}tt([$t]),tt([Gt]);export{hr as executeScript,tt as extend,me as prepareScript};
