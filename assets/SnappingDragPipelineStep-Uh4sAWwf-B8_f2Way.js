import{x as b,s as R,a as j,aU as A}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{j as F}from"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import{c as L}from"./dehydratedFeatureComparison-faNSTYzo-N4d2j25_.js";import{x as M}from"./RealisticTree.glsl-WN9nrQUl-QZiY3aPA.js";import{R as N}from"./elevationInfoUtils-B8MpdRMP-CDlK86wO.js";import{v as q}from"./InteractiveToolBase-DXh7kfgV-B5EAl8tr.js";import{g as D}from"./SnappingContext-CApcAey_-Bfkkm4s2.js";import{p as Q,r as V}from"./Scheduler-CNrsbccs-Bcg8fWoS.js";function rn({predicate:n=()=>!0,snappingManager:t,snappingContext:o,updatingHandles:a,useZ:e=!0}){const l=new q;if(t==null)return{snappingStep:[H,l],cancelSnapping:H};let c,u=null,r=null,p=null;const f=()=>{u=b(u),t.doneSnapping(),r?.frameTask.remove(),r=null,c=R(c),p=null},g=W(t,e,l);let d=null,s=null,Z=null;return{snappingStep:[i=>{if(!n(i))return i;const{action:P}=i;if(P==="start"){const{info:x}=i,v=X(t.view);if(r=B(o,i,v),r.context.selfSnappingZ=null,!e&&x!=null){const m=K(o.coordinateHelper,x.handle.part);m!=null&&(r.context.selfSnappingZ={value:m,elevationInfo:o.elevationInfo??N})}}if(r!=null){const{context:x,originalScenePos:v,originalPos:m}=r,{mapEnd:k,mapStart:z,scenePoints:U}=i,S=I(m,y(k,z)),T=y(z,m),$={...i,action:"update"},C=r.context,h=J(v,U),w=t.update({point:S,scenePoint:h,context:x});if(Z=w,E(k,w,T,e),d=S,s=h,P!=="end"){const{frameTask:G}=r;u==null&&(u=new AbortController),p=O=>{a.addPromise(j(g({frameTask:G,event:$,context:C,point:S,scenePoint:h,delta:T,getLastState:()=>({point:d,scenePoint:s,updatePoint:O.forceUpdate?null:Z})},u.signal)))},p({forceUpdate:!1}),c==null&&(c=F(()=>t.options.effectiveEnabled,()=>p?.({forceUpdate:!0})))}}return P==="end"&&f(),i},l],cancelSnapping:i=>(f(),i)}}function W(n,t,o){return A(async({frameTask:a,point:e,scenePoint:l,context:c,event:u,delta:r,getLastState:p},f)=>{const g=await a.schedule(()=>n.snap({point:e,scenePoint:l,context:c,signal:f}),f);if(g.valid){let d=await a.schedule(()=>g.apply(),f);const s=p();s.point!=null&&e!==s.point&&(d=n.update({point:s.point,scenePoint:s.scenePoint,context:c})),s.updatePoint!=null&&L(d,s.updatePoint)||(E(u.mapEnd,d,r,t),o.execute(u))}})}function X(n){return n.type==="3d"?n.resourceController.scheduler.registerTask(V.SNAPPING):Q}function B(n,t,o){return{context:new D({editGeometryOperations:n.editGeometryOperations,elevationInfo:n.elevationInfo,pointer:n.pointer,vertexHandle:t.info!=null?t.info.handle:null,excludeFeature:n.excludeFeature,feature:n.feature,visualizer:n.visualizer}),originalPos:t.snapOrigin!=null?n.coordinateHelper.vectorToDehydratedPoint(t.snapOrigin):t.mapStart,originalScenePos:t.scenePoints!=null?t.scenePoints.sceneStart:null,frameTask:o}}function I(n,[t,o,a]){const e=M(n);return e.x+=t,e.y+=o,e.hasZ&&(e.z+=a),e}function J(n,t){return n==null||t==null?null:I(n,y(t.sceneEnd,t.sceneStart))}function y(n,t){const o=n.hasZ&&t.hasZ?n.z-t.z:0;return[n.x-t.x,n.y-t.y,o]}function E(n,t,[o,a,e],l){n.x=t.x+o,n.y=t.y+a,l&&n.hasZ&&t.hasZ&&(n.z=t.z+e)}function K(n,t){if(!n.hasZ())return null;const o=t.vertices;let a=null;for(const e of o){const l=n.getZ(e.pos);if(a!=null&&l!=null&&Math.abs(l-a)>1e-6)return null;a==null&&(a=l)}return a}function H(n){return n}export{rn as r};
