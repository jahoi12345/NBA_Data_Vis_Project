import{I as H,v as E,y as P,o as Q,w as re,S as Ne,b7 as De,Y as w,H as M,G as ve}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{f as K,P as xe,E as Ie,$ as Ee,a as _e,e as Se,N as Ae,S as se,B as Re,H as ze,W as Ge,Q as Pe,z as Oe,U as Fe,G as Be,_ as Ue}from"./KnowledgeGraphSublayer-DPPfNGwx-CadxsbLX.js";import{R as U}from"./collectionUtils-jDyktm0P-BDP2Oq99.js";import{k as je}from"./MultiOriginJSONSupport-Bd1TKmh_-BHNF5tHX.js";import{j as He,i as We}from"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import{z as ge}from"./Extent-CgDMOSRD-Bod5LY6s.js";import{b as J}from"./Point-BfTTZoMu-DeJwQYfh.js";import{n as fe}from"./Polyline-CoiTLswR-DTxpB2Yg.js";import{T as $e}from"./Polygon-D6wEPb3W-D2MPjRU4.js";import{o as Qe}from"./Layer-DZvC7bne-D3VLDrab.js";import{H as q}from"./featureConversionUtils-BDA_FXJx-CDxX1Wik.js";import{_ as C,I as X,t as Z,S as A,o as qe}from"./constants-SxxbBSOD-SxxbBSOD.js";import{y as Ke}from"./BlendLayer-HE_aYHHW-D0es7Iiq.js";import{C as Ve,f as Ye}from"./OperationalLayer-B6zbJ5nR-DyK_ztCk.js";import{s as Je}from"./ScaleRangeLayer-DQr2T3Hh-Dh1UYk4i.js";import{u as Xe}from"./knowledgeGraphService-DzM6eaby-DhRVLaCS.js";import"./aaBoundingBox-Cn49X7ge-BcYPaJ58.js";import"./mathUtils-PIGhLnI9-B1tKUlUb.js";import"./mat4f64-q_b6UJoq-Dh6sWB_w.js";import"./lengthUtils-Dt1_RvOO-j3MEdmHu.js";import"./index-B0z_nLWi.js";import"./date-IqUzANpt-bLKO9IDT.js";import"./projectionUtils-BGH_5_I3-DGwchVO8.js";import"./Graphic-DgGzDmqW-d1CNicxz.js";import"./getPopupProvider-CmskPttI-CzUWpGwk.js";import"./Color-CERqXxxY-BuYn26eI.js";import"./typeUtils-DqrRcjBx-DZ6_Gsbu.js";import"./typeUtils-CXW_VpOn-BGgLp_TK.js";import"./lineMarkers-CDwLe3J6-CNUjJvs3.js";import"./PolygonSymbol3D-BXRHZiCQ-BjPAY2LA.js";import"./ExtrudeSymbol3DLayer-DSc1ou2x-CsVYZCeG.js";import"./Font-BwmnW7d2-Dwh3xjKw.js";import"./SimpleFillSymbol-CDawtd9z-CWD2KI2D.js";import"./SimpleMarkerSymbol-BGAFRS9_-CVQ5NLIA.js";import"./PictureMarkerSymbol-CaSh-vZk-xhjZ61bb.js";import"./TextSymbol-hRGhyDHs-CoS7dSjf.js";import"./GraphicsLayer-CZ0Xqeb2-BtZ4GO5Z.js";import"./GraphicsCollection-Bk6M0b7D-Dk6KdmO7.js";import"./ElevationInfo-Cw2HaA6E-CuK5hJ96.js";import"./unitConversionUtils-4vB4Ezlp-DnY5MDxd.js";import"./mat4f32-Djp3mnm5-DzYG3LYB.js";import"./mat4-C96X-Nn0-BrMLOLCb.js";import"./GraphQueryStreaming-ERTkxqUb-BYv3_5cC.js";import"./Query-BlS0WPDF-jdXS_Qhy.js";import"./Field-Cm_ZejYW-CwJZmSru.js";import"./fieldType-DVUzXtk_-tUuvnZJM.js";import"./workers-BEkgoq8Q-BM_Hz460.js";import"./intl-DRFqUect-DPhFaHB2.js";import"./GraphicOrigin-uE6TDXc9-DqbdmNAV.js";import"./FeatureStore-DSSTHScY-DmyCmhL1.js";import"./PooledRBush-Dco5QkUp-DX3CMhf3.js";import"./QueryEngine-J0SYKhS8-C5yUyj6A.js";import"./normalizeUtils-85zLqeMi-C1bdAKNn.js";import"./normalizeUtilsCommon-CnhQye_A-UWhaH-kt.js";import"./LRUCache-fy84PBMi-Y56WPIvD.js";import"./WhereClause-BSVqskBz-CT_IXPhv.js";import"./UnknownTimeZone-B697BDFv-CBbtul7O.js";import"./FixedIntervalBinParameters-8snYOK8a-DXffLEh-.js";import"./NormalizationBinParametersMixin-BK9wNkI3-BKYeOhDN.js";import"./vec42-B8VM4vXb-B6OGOEI9.js";import"./vec4f64-DPb6J-GU-C7c2DqbZ.js";import"./ClassBreaksDefinition-BGOzyovZ-K0U0wKo_.js";import"./Scheduler-CNrsbccs-Bcg8fWoS.js";import"./FormTemplate-DuPZvaVv-DtJsNdqp.js";import"./FeatureTemplate-Bur8tORn-C24tlGMe.js";import"./labelingInfo-BYG2hiVF-B7-dv03v.js";import"./defaults-BDN9qxeN-C-EfxQM4.js";import"./defaults3D-C2hXSee1-CTj29-Ly.js";import"./DisplayFilteredLayer-DyjtPayS-DLMYIA49.js";import"./FeatureEffect-mVCOF1v6--fvFHZv2.js";import"./FeatureFilter-G4_pWMVe-D0hu4KAy.js";import"./FeatureReductionLayer-Bhh5MvS_-6_Dufsno.js";import"./FeatureReductionSelection-Du7o8OIG-DmruV-ou.js";import"./featureLayerUtils-FKjLNPl_-Cv8vWd4i.js";import"./asyncUtils-w6KfWU41-HenJ0UOu.js";import"./SimpleRenderer-CEmCWePp-BJ25mYcH.js";import"./commonProperties-DbO613LF-CHjBvYhj.js";import"./colorRamps-DswZzxkO-BqSFavfl.js";import"./ColorStop-De5gQTjr-C1lw16u9.js";import"./visualVariableUtils-ma4r7Z2K-Df6C3Hkh.js";import"./UniqueValueRenderer-JPjz9Qvs-Duu1CubQ.js";import"./RendererLegendOptions-ByGHYLtx-Bwoo6l33.js";import"./jsonUtils-BCGKNxno-DZ1Xr_O8.js";import"./typeUtils-DDFS4uuz-B7KgP61w.js";import"./ClassBreaksRenderer-BvgdqtTq-D2fU8Sng.js";import"./OrderedLayer-DQAUgUTV-CpnQmtbN.js";import"./RefreshableLayer-CBbEkZf--DylHaNOC.js";import"./TimeInfo-D7ssmbZO-Burc-nDV.js";import"./FeatureSet-BF7daP96-B_JvMbY7.js";import"./utils-Dha_-5-2-l1tlHmkW.js";import"./networkEnums-DcxQ-KKD-B7fWvtQx.js";import"./GPMessage-D_4FfUD9-H-J6FJ7I.js";import"./OptimizedFeature-CwRGZPwv-Ddclhn0A.js";import"./memoryEstimations-Bd726a_p-0cVCY2Jz.js";import"./jsonUtils-CmpazY1u-6pDLj5sx.js";import"./clientSideDefaults-3DdoYkYX-n_psRtPH.js";import"./QueryEngineCapabilities-DJC_YILC-CshvWf3J.js";import"./defaultsJSON-GKolV7NZ-GKolV7NZ.js";import"./fieldProperties-BoJj55FN-DI1Lssr9.js";import"./FieldsIndex-CimK-TqD--24JoCkp.js";import"./timeZoneUtils-BSc7-7qA-BAv3h8mh.js";import"./layerUtils-DZGhvm-W-CfyHx1TZ.js";import"./FeatureEffectLayer-BG_KTtPw-C05GQDNc.js";import"./TemporalLayer-D4R0YvXo-PSBzKw25.js";import"./reader-DcGs6kKN-DHJfK-tm.js";import"./layerContainerType-CSXZNpHb-BIF7XAYP.js";import"./popupUtils-D4UavgYz-DI7Mb3me.js";import"./SimpleObservable-CvFyr0NA-DXpoMYph.js";import"./aaBoundingRect-CjwcS2F3-ri8bmh30.js";import"./OptimizedFeatureSet-BR8EEvDc-CgsRgxJh.js";import"./createFeatureId-CVwTD0fV-3fKpJDrk.js";import"./jsonUtils-CY6YsQMo-LM0PY-PG.js";import"./screenUtils-BitdhK1O-L0FLPAMi.js";import"./opacityUtils-DuFH0EC9-DWspTgn2.js";import"./utils-CylVuxNi--x86XOjU.js";import"./Cyclical-BLSxUpe7-Bj8R2Yk-.js";import"./utils-Dpg4yj1D-CeFz2JVC.js";import"./DoubleArray-DExKNiTh-CvVpHySW.js";import"./Queue-CYlrXMwB-CYJTUII-.js";import"./BoundsStore-CBAymNAD-BDX_dT4b.js";import"./optimizedFeatureQueryEngineAdapter-Bma9_B5X-BMDAgToU.js";import"./quickselect-QQC62dOK-Br2Ahhru.js";import"./WhereClauseCache-B0L2SmwV-NVT3RoWW.js";import"./TimeOnly-BERR31kg-CQiLyUZi.js";import"./enum-BzLwmiID-CcyIdWlQ.js";import"./quantizationUtils-Ceq-Uxsu-DjgKK_0s.js";import"./utils-CUk96PkC-CJv0qCOi.js";import"./heatmapUtils-B-AXnq0l-BF3Q_jd2.js";import"./utils-BbtW4lHb-D1wApKS_.js";import"./utils-BEeBypEk-DQLTC4jR.js";import"./SnappingCandidate-DGkpYqI6-CfPvDre4.js";import"./signal-BX9ezF8a-cf1Pn6io.js";import"./labelUtils-BtizwBfq-Zegx4520.js";import"./jsonUtils-C9q_FK4K-GRCbm_Pe.js";import"./scaleUtils-yfx9kKWT-D9SVsyM-.js";import"./uuid-Oe6SV2kF-IYX19xBA.js";import"./displayFilterUtils-CIXGrQzt-XEoxkZ3i.js";import"./MD5-MtSiOt06-jWr180Yc.js";import"./featureQueryAll-BfDWA5Wx-BKksFkIA.js";import"./diffUtils-wTC1YzlE-DCTUTUs8.js";import"./styleUtils-DWvicjTN-DL6_BIk4.js";import"./DictionaryScriptEvaluator-G73uSGpN-ErvAW-Hm.js";import"./Version-BtYZEj58-LyRHDnSJ.js";import"./ArcadeExpression-BlIRq-oN-VZkrwLVE.js";import"./utils-DX2muIr3-DiPfFKSl.js";import"./cimSymbolUtils-DOGwV0lV-DF1x9X12.js";const le={MULTIPLIER:"multiplier",ABSOLUTE:"absolute-value"};let g=class extends Ve(Ke(Je(je(Qe)))){constructor(e){if(super(e),this.url=null,this.dataPreloadedInLocalCache=!1,this.initializationLinkChartConfig=null,this.membershipModified=!0,this._currentLinkChartConfig={layoutMode:"organic-standard"},this._graphTypeLookup=new Map,this.dataManager=null,this.knowledgeGraph=null,this.layers=new(U.ofType(K)),this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map,this.linkChartExtent=new ge({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),this.memberEntityTypes=null,this.memberRelationshipTypes=null,this.operationalLayerType="LinkChartLayer",this.sublayerIdsCache=new Map,this.tables=new(U.ofType(K)),this.type="link-chart",this.chronologicalAuxiliaryGraphics=null,this._originalInclusionList=e?.initializationInclusionModeDefinition,e?.dataPreloadedInLocalCache&&!e?.initializationInclusionModeDefinition)throw new H("knowledge-graph:linkchart-layer-constructor","If creating a link chart composite layer and configured that data is already loaded in the cache, you must specify an inclusion list so the Composite Layer knows what records belong to it");this.addHandles(He(()=>this.layers.concat(this.tables),(t,i)=>this._handleSublayersChange(t,i),We))}normalizeCtorArgs(e){if(!e)return{};const{url:t,title:i,dataPreloadedInLocalCache:o,initializationLinkChartConfig:a}=e;return{url:t,title:i,dataPreloadedInLocalCache:o,initializationLinkChartConfig:a}}_initializeLayerProperties(e){if(!this.title&&this.url){const n=this.url.split("/");this.title=n[n.length-2]}const t=new Set;let i=[],o=[];if(e.inclusionModeDefinition&&(!e.inclusionModeDefinition.namedTypeDefinitions||e.inclusionModeDefinition.namedTypeDefinitions.size<1))throw new H("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined");e.inclusionModeDefinition?.generateAllSublayers?(i=e.knowledgeGraph.dataModel.entityTypes??[],o=e.knowledgeGraph.dataModel.relationshipTypes??[]):e.inclusionModeDefinition?.namedTypeDefinitions&&e.inclusionModeDefinition?.namedTypeDefinitions.size>0?e.inclusionModeDefinition?.namedTypeDefinitions.forEach((n,s)=>{const h=this._graphTypeLookup.get(s);if(!h)return E.getLogger(this).warn(`A named type, ${s}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(s);h.type==="relationship"?t.has(s)||(t.add(s),o.push(h)):h.type==="entity"?t.has(s)||(t.add(s),i.push(h)):(E.getLogger(this).warn(`A named type, ${s}, was in the inclusion list that wasn't properly modeled and will be removed`),e.inclusionModeDefinition?.namedTypeDefinitions.delete(s))}):(i=e.knowledgeGraph.dataModel.entityTypes??[],o=e.knowledgeGraph.dataModel.relationshipTypes??[]);const a=new xe({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition});this.knowledgeGraph=e.knowledgeGraph,this.memberEntityTypes=i,this.memberRelationshipTypes=o,this.dataManager=a}load(e){const t=async()=>{const i=[],o=[];this.loadLayerAssumingLocalCache(),this._layersLoadedFromAuthoritativeItem()||await se(this),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(a=>{a.useAllData=!1}),await this._initializeDiagram(),this.layers.forEach(a=>{o.push(a.refreshCachedQueryEngine()),i.push(new Promise(n=>{a.on("layerview-create",()=>{n(null)})}))}),this.tables.forEach(a=>{o.push(a.refreshCachedQueryEngine())}),await Promise.all(o)};return this.addResolvingPromise(new Promise(i=>{Xe(this.url).then(async o=>{o.dataModel.entityTypes?.forEach(n=>{n.name&&this._graphTypeLookup.set(n.name,n)}),o.dataModel.relationshipTypes?.forEach(n=>{n.name&&this._graphTypeLookup.set(n.name,n)});const a=this.linkChart?.linkChartProperties;if(a?.originIdOf("entitiesUrl")===6&&(this.membershipModified=!1,this._originalInclusionList=await Ie.fetchAndConvertSerializedLinkChart({entitiesUrl:a?.entitiesUrl,relationshipsUrl:a?.relationshipsUrl}),this._alignLayersDataModelAndInclusionDefinition(o.dataModel),this.initializationLinkChartConfig={layoutSettings:a?.layoutSettings??void 0,layoutMode:Ee(a.layoutType)}),this._initializeLayerProperties({knowledgeGraph:o,inclusionModeDefinition:this._originalInclusionList}),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.size||(this.dataManager.inclusionModeDefinition={generateAllSublayers:!1,namedTypeDefinitions:new Map},this.dataManager.knowledgeGraph.dataModel.entityTypes?.forEach(n=>{n.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(n.name,{useAllData:!0})}),this.dataManager.knowledgeGraph.dataModel.relationshipTypes?.forEach(n=>{n.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(n.name,{useAllData:!0})})),this.dataPreloadedInLocalCache){const n=_e.getInstance();for(const[s,h]of this.dataManager.inclusionModeDefinition?.namedTypeDefinitions??[])for(const m of h.members?.values()??[]){const c=n.readFromStoreById(`${s}__${m.id}`);c&&P(this.dataManager.sublayerCaches,s,()=>new Map).set(m.id,c)}await t()}else{const n=this.initializationLinkChartConfig?.layoutMode==="geographic-organic-standard";this.addResolvingPromise(this.dataManager.refreshCacheContent(void 0,!1,n,!0).then(async()=>{Q(e),await t()}))}i(null)})})),Promise.resolve(this)}set initializationInclusionModeDefinition(e){this.loadStatus!=="loaded"&&this.loadStatus!=="failed"?this._set("initializationInclusionModeDefinition",e):E.getLogger(this).error("#initializationInclusionModeDefinition","initializationInclusionModeDefinition cannot be changed after the layer is loaded.")}get linkChart(){return this.parent}get sublayerCapabilities(){return Se(this.knowledgeGraph)}async addRecords(e,t){let i=[];t?.cascadeAddRelationshipEndNodes&&this.dataManager.knowledgeGraph.dataModel&&(i=await Ae(e,this.dataManager.knowledgeGraph));const o=e.concat(i).filter(a=>!this.sublayerIdsCache.get(a.typeName)?.has(a.id));o.length>0&&(this.membershipModified=!0),await this._handleNewRecords(o,t)}async createSublayerForNamedType(e){await this.load();const t=this._graphTypeLookup.get(e);if(!t)throw new H("knowledge-graph:missing-type","The specified type does not exist in the knowledge graph.");if(this.dataManager.sublayerCaches.has(e))throw new H("knowledge-graph:duplicate-type","The specified type already exists as a sublayer.");this.dataManager.sublayerCaches.set(e,new Map),P(this.sublayerIdsCache,e,()=>new Set);const i=this._createSublayer(t);return t.type==="entity"?this.dataManager.entityTypeNames.add(e):this.dataManager.relationshipTypeNames.add(e),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.set(e,{useAllData:!1,members:new Map}),i.geometryType?this.layers.push(i):this.tables.push(i),await se(this,[e]),this._refreshNamedTypes(),i}async removeRecords(e,{cascadeRemoveRelationships:t=!0,recalculateLayout:i=!1,overrideMembershipCheck:o=!1}={cascadeRemoveRelationships:!0,recalculateLayout:!1,overrideMembershipCheck:!1}){let a=[];for(const h of e)(o||this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(h.typeName)?.useAllData===!1&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(h.typeName)?.members?.has(h.id))&&a.push(h);if(t){const h=new Set,m=[];for(const c of a)if(this.dataManager.nodeConnectionsLookup.has(c.id))for(const y of this.dataManager.nodeConnectionsLookup.get(c.id))h.add(y);for(const c of h)if(this.dataManager.memberIdTypeLookup.has(c))for(const y of this.dataManager.memberIdTypeLookup.get(c))this.dataManager.relationshipTypeNames.has(y)&&m.push({id:c,typeName:y});a=a.concat(m)}this.dataManager.removeFromLayer(a);for(const h of a)this.sublayerIdsCache.get(h.typeName)?.delete(h.id),this.dataManager.relationshipTypeNames.has(h.typeName)?this.relationshipLinkChartDiagramLookup.delete(h.id):this.entityLinkChartDiagramLookup.delete(h.id);const n=i?void 0:this.getCurrentNodeLocations();await this._calculateLayoutWithSublayerTimeInfo(this._currentLinkChartConfig.layoutMode,{layoutSettings:this._currentLinkChartConfig.layoutSettings,lockedNodeLocations:n}),a.length>0&&(this.membershipModified=!0);const s=[];return this.layers.forEach(h=>{s.push(h.refreshCachedQueryEngine())}),await Promise.all(s),this._refreshNamedTypes(),a}async expand(e,t){let i=[];try{const o=await this.dataManager.getConnectedRecordIds(e,t?.relationshipTypeNames,t);i=o.filter(a=>!this.sublayerIdsCache.get(a.typeName)?.has(a.id)),await this._handleNewRecords(i,t),o.length>0&&(this.membershipModified=!0),Q(t?.signal)}catch(o){throw re(o)&&i.length>0&&await this.removeRecords(i,{overrideMembershipCheck:!0}),o}return{records:i}}loadLayerAssumingLocalCache(){const e=[...this.memberRelationshipTypes,...this.memberEntityTypes];this.layers.length||this.originIdOf("tables")===0?this.originIdOf("layers")===0?this._createSublayers(e,this.layers,t=>!!t.geometryType):this._updateSublayers(e,this.layers):this.layers=new U,this.tables.length||this.originIdOf("layers")===0?this.originIdOf("tables")===0?this._createSublayers(e,this.tables,t=>!t.geometryType):this._updateSublayers(e,this.tables):this.tables=new U,this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((t,i)=>{const o=P(this.sublayerIdsCache,i,()=>new Set);t.members?.forEach(({id:a,linkChartLocation:n})=>{if(o.add(a),n){const s="coords"in n&&"lengths"in n?n:q(n);this.dataManager.relationshipTypeNames.has(i)?this.relationshipLinkChartDiagramLookup.set(a,s):this.entityLinkChartDiagramLookup.set(a,s)}})})}async calculateLinkChartLayout(e="organic-standard",t){const i=[],o=[],a=[];this.dataManager.sublayerCaches.forEach((r,p)=>{this.dataManager.entityTypeNames.has(p)?r.forEach(l=>{i.push({typeName:p,feature:l})}):this.dataManager.relationshipTypeNames.has(p)&&r.forEach(l=>{o.push({typeName:p,feature:l})})}),this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map;const n=new Map,s=new Map,h=new Map,m=new Map,c=new Uint8Array(i.length),y=new Float64Array(i.length),b=new Float64Array(i.length),j=new Float64Array(i.length),S=new Float64Array(i.length),T=new Uint32Array(o.length),ee=new Uint32Array(o.length),he=new Float64Array(o.length),pe=new Float64Array(o.length),f=[],we="organic-standard";let de=!1;const N=new ge({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7});let O,me="organic-standard",u=0,v=0;const be=Re.apply;switch(me=e==="geographic-organic-standard"?we:e,me){case"organic-standard":O=Be.apply;break;case"organic-community":O=Fe.apply;break;case"hierarchical-bottom-to-top":O=Oe.apply;break;case"radial-root-centric":O=Pe.apply;break;case"tree-left-to-right":O=Ge.apply;break;default:O=ze.apply}let te=!1;i.forEach(({typeName:r,feature:p})=>{if(e!=="chronological-mono-timeline"&&e!=="chronological-multi-timeline"&&t?.lockedNodeLocations?.has(p.attributes[C])){e==="geographic-organic-standard"&&this.dataManager.geographicLookup.has(r)?c[u]=2:c[u]=0;const l=t.lockedNodeLocations.get(p.attributes[C]);y[u]=l.x,b[u]=l.y}else if(e==="geographic-organic-standard"&&this.dataManager.geographicLookup.has(r)){c[u]=2;let l=null;const k=p.attributes[this.dataManager.geographicLookup.get(r).name];switch(this.dataManager.geographicLookup.get(r)?.geometryType){case"esriGeometryPoint":y[u]=k?.x,b[u]=k?.y;break;case"esriGeometryPolygon":{const D=$e(k);l=D?J.fromJSON(D):null,l?.x!=null&&l?.y!=null?(y[u]=l.x,b[u]=l.y):c[u]=1;break}case"esriGeometryPolyline":case"esriGeometryMultipoint":l=k?.extent?.center,l?.x!=null&&l?.y!=null?(y[u]=l.x,b[u]=l.y):c[u]=1;break;default:c[u]=1}(y[u]==null||b[u]==null||Number.isNaN(y[u])||Number.isNaN(b[u]))&&(c[u]=1,y[u]=0,b[u]=0)}else if(e==="chronological-mono-timeline"||e==="chronological-multi-timeline"){!te&&t?.lockedNodeLocations?.has(p.attributes[C])&&(te=!0);const l=t?.timeInfoByTypeName?.get(r),k=l?.startField,D=k&&l?.startField?p.attributes[k]:null;j[u]=D?new Date(D).getTime():NaN;const L=l?.endField,I=L&&l?.endField?p.attributes[L]:null;S[u]=I?new Date(I).getTime():NaN,y[u]=0,b[u]=0,c[u]=1}else c[u]=1,y[u]=0,b[u]=0;m.set(p.attributes[C],u),f[u]={feature:p,typeName:r},u++}),te&&E.getLogger(this).warn("Locked node locations are not supported for chronological layout at this time.  Requested node locations were ignored");let ue=!1;const ie=new Map;o.forEach(r=>{const p=r.feature.attributes[X],l=r.feature.attributes[Z],k=m.get(p),D=m.get(l),L=t?.timeInfoByTypeName?.get(r.typeName),I=t?.timeInfoByTypeName?L?.startField:null,R=I?r.feature.attributes[I]:null,Y=L?.endField,F=Y?r.feature.attributes[Y]:null;if(k!==void 0&&D!==void 0){let z=p+"-"+l;e!=="chronological-mono-timeline"&&e!=="chronological-multi-timeline"||(z=z+"-"+R+"-"+F);const $=ie.get(z);$?.has(r.typeName)||(T[v]=k,ee[v]=D,e!=="chronological-mono-timeline"&&e!=="chronological-multi-timeline"||(he[v]=R?new Date(R).getTime():NaN,pe[v]=F?new Date(F).getTime():NaN),$===void 0?ie.set(z,new Map([[r.typeName,v]])):$.set(r.typeName,v),v++),a.push(r)}else ue=!0,this.relationshipLinkChartDiagramLookup.set(p,null)}),ue&&E.getLogger(this).warn("A relationship is a member of this layer that has either origin or destination entity nodes that are not members. The diagram geometry will be set to null");const Le=this._validateOrganicLayoutSettings(e,t?.layoutSettings?.organicLayoutSettings),ae=this._convertValidatedOrganicSettingsToCalculationSettings(Le);await Ue();let W=1,x=null;if(e==="chronological-mono-timeline"||e==="chronological-multi-timeline"){let r;({status:W,links:x,graphics:r}=be(()=>t?.signal?.aborted??!1,c,y,b,j,S,T.subarray(0,v),ee.subarray(0,v),he.subarray(0,v),pe.subarray(0,v),e==="chronological-multi-timeline",t?.layoutSettings?.chronologicalLayoutSettings)),W===0&&(this.chronologicalAuxiliaryGraphics=r)}else({status:W,links:x}=O(()=>t?.signal?.aborted??!1,c,y,b,T.subarray(0,v),ee.subarray(0,v),ae.computationBudgetTime,ae.idealEdgeLengthMultiplier,ae.repulsionRadiusMultiplier));if(Q(t?.signal),W===1)throw new H("knowledge-graph:layout-failed","Attempting to arrange the records in the specified layout failed");if(W===2)throw Ne();for(let r=0;r<f.length;r++){if(b[r]>84.9999?b[r]=84.9999:b[r]<-84.9999&&(b[r]=-84.9999),y[r]>179.9999?y[r]=179.9999:y[r]<-179.9999&&(y[r]=-179.9999),f[r].feature.attributes[A]=new J(y[r],b[r]),n.has(f[r].typeName))n.get(f[r].typeName)?.set(f[r].feature.attributes[C],f[r].feature);else{const L=new Map;L.set(f[r].feature.attributes[C],f[r].feature),n.set(f[r].typeName,L)}h.set(f[r].feature.attributes[C],f[r].feature);const p=q(f[r].feature.attributes[A]);this.entityLinkChartDiagramLookup.set(f[r].feature.attributes[C],f[r].feature.attributes[A]?p:null);const l=P(this.dataManager.inclusionModeDefinition.namedTypeDefinitions,f[r].typeName,()=>({useAllData:!1,members:new Map}));P(l.members,f[r].feature.attributes[C],()=>({id:f[r].feature.attributes[C],linkChartLocation:void 0})).linkChartLocation=f[r].feature.attributes[A];const{x:k,y:D}=f[r].feature.attributes[A];de?(N.xmin=Math.min(N.xmin,k),N.xmax=Math.max(N.xmax,k),N.ymin=Math.min(N.ymin,D),N.ymax=Math.max(N.ymax,D)):(N.xmin=k-1e-7,N.xmax=k+1e-7,N.ymin=D-1e-7,N.ymax=D+1e-7,de=!0)}if(this.linkChartExtent.xmin=N.xmin,this.linkChartExtent.xmax=N.xmax,this.linkChartExtent.ymin=N.ymin,this.linkChartExtent.ymax=N.ymax,!x)throw new H("knowledge-graph:layout-failed","Attempting to retrieve link geometry from diagram engine failed");const V=new Map,oe=new Map,ne=new Map,ce=new Set;for(let r=0;r<a.length;r++){const p=[],l=a[r],k=l.feature.attributes[X],D=l.feature.attributes[Z];let L=k+"-"+D;if(e==="chronological-mono-timeline"||e==="chronological-multi-timeline"){const d=t?.timeInfoByTypeName?.get(l.typeName),_=t?.timeInfoByTypeName?d?.startField:null,G=_?l.feature.attributes[_]:null,B=d?.endField;L+="-"+G+"-"+(B?l.feature.attributes[B]:null)}const I=ie.get(L).get(l.typeName),R=I===0?0:x?.vertexEndIndex[I-1];if(!ce.has(I)){if(ce.add(I),x.types[I]===2){const d=[x.vertices[2*R],x.vertices[2*R+1]],_=[x.vertices[2*(R+1)],x.vertices[2*(R+1)+1]],G=[.5*(d[0]+_[0]),.5*(d[1]+_[1])],B=[G[0]-d[0],G[1]-d[1]],Ce=[G[0]+B[1],G[1]-B[0]],Te=[G[0]-B[1],G[1]+B[0]];p.push(d),p.push(Ce),p.push(_),p.push(Te),p.push(d)}else{if(x.types[I]!==0){E.getLogger(this).warn("A relationship generated an unsupported link geometry type.  It will not be rendered");continue}for(let d=R;d<x.vertexEndIndex[I];d++)p.push([x.vertices[2*d],x.vertices[2*d+1]])}if(e!=="chronological-mono-timeline"&&e!=="chronological-multi-timeline"){const d=f[m.get(k)]?.feature.attributes[A],_=f[m.get(D)]?.feature.attributes[A];p[0][0]===d.x&&p[0][1]===d.y||(p[0]=[d.x,d.y]),p[p.length-1][0]===_.x&&p[p.length-1][1]===_.y||(p[p.length-1]=[_.x,_.y])}for(let d=1;d<p.length-1;d++)p[d][1]>85.5?p[d][1]=85.5:p[d][1]<-85.5&&(p[d][1]=-85.5),p[d][0]>179.9999?p[d][0]=179.9999:p[d][0]<-179.9999&&(p[d][0]=-179.9999);V.has(L)?V.get(L).push(p):V.set(L,[p])}const Y=V.get(L);oe.has(L)||(oe.set(L,new Map),ne.set(L,new Map));const F=oe.get(L),z=ne.get(L);F.has(l.typeName)||(F.set(l.typeName,Y.shift()),z.set(l.typeName,0));const $=F.get(l.typeName);z.set(l.typeName,z.get(l.typeName)+1);const Me=new fe({paths:[$]});if(l.feature.attributes[A]=Me,s.has(l.typeName))s.get(l.typeName)?.set(l.feature.attributes[C],l.feature);else{const d=new Map;d.set(l.feature.attributes[C],l.feature),s.set(l.typeName,d)}h.set(l.feature.attributes[C],l.feature);const ye=q(l.feature.attributes[A]);this.relationshipLinkChartDiagramLookup.set(l.feature.attributes[C],l.feature.attributes[A]?ye:null);const ke=P(this.dataManager.inclusionModeDefinition.namedTypeDefinitions,l.typeName,()=>({useAllData:!1,members:new Map}));P(ke.members,l.feature.attributes[C],()=>({id:l.feature.attributes[C],linkChartLocation:void 0})).linkChartLocation=ye}for(const r of a)r.feature.attributes[qe]=ne.get(r.feature.attributes[X]+"-"+r.feature.attributes[Z])?.get(r.typeName)??null;return this._currentLinkChartConfig={layoutMode:e,layoutSettings:t?.layoutSettings?.clone()},{nodes:n,links:s,idMap:h}}async applyNewLinkChartLayout(e="organic-standard",t){const i=[];await this._calculateLayoutWithSublayerTimeInfo(e,t),this.layers.forEach(o=>{i.push(o.refreshCachedQueryEngine())}),this.membershipModified=!0,await Promise.all(i),this._refreshNamedTypes()}getCurrentNodeLocations(){const e=new Map;for(const[t,i]of this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.entries()??[])this.dataManager.relationshipTypeNames.has(t)||i?.members?.forEach(o=>{const a=o.linkChartLocation;let n;const s=o.id;a&&(n="x"in a?{x:a.x,y:a.y}:{x:a.coords[0],y:a.coords[1]},e.set(s,new J({x:n.x,y:n.y})))});return e}async refreshLinkChartCache(e){await this.dataManager.refreshCacheContent(e);const t=[];this.layers.forEach(i=>{t.push(i.refreshCachedQueryEngine())}),await Promise.all(t),this._refreshNamedTypes()}async connectBetweenEntities(e,t){if(!e.length)return{records:[]};let i=[];try{let o=[];for(const a of this.dataManager.relationshipTypeNames){const n=this.sublayerIdsCache.get(a);n&&(o=o.concat(Array.from(n.keys())))}i=await this.dataManager.getRelationshipsBetweenNodes(e,o,t),await this._handleNewRecords(i,t),Q(t)}catch(o){throw re(o)&&this.removeRecords(i),o}return{records:i}}async connectFromEntities(e,t){if(!e.length)return{records:[]};let i=[];try{let o=[];for(const n of this.dataManager.relationshipTypeNames){const s=this.sublayerIdsCache.get(n);s&&(o=o.concat(Array.from(s.keys())))}let a=[];for(const n of this.dataManager.entityTypeNames){const s=this.sublayerIdsCache.get(n);s&&(a=a.concat(Array.from(s)))}i=await this.dataManager.getRelationshipsFromNodes(e,a,o,t),await this._handleNewRecords(i,t),i.length>0&&(this.membershipModified=!0),Q(t)}catch(o){throw re(o)&&this.removeRecords(i),o}return{records:i}}getCurrentLayout(){return this._currentLinkChartConfig.layoutMode}async _calculateLayoutWithSublayerTimeInfo(e="organic-standard",t){const i=new Map;this.layers.forEach(o=>{i.set(o.objectType.name,o.timeInfo)}),await this.calculateLinkChartLayout(e,{timeInfoByTypeName:i,...t}),this.linkChart?.handleChronologicalOverlay()}async _handleNewRecords(e,t){const i=new Set,o=[],a=this.layers.concat(this.tables);for(const s of e)this._graphTypeLookup.has(s.typeName)&&(a.some(h=>h.objectType.name===s.typeName)===!1&&(this.dataManager.sublayerCaches.set(s.typeName,new Map),i.add(s.typeName)),P(this.sublayerIdsCache,s.typeName,()=>new Set).add(s.id),o.push(s));this.dataManager.addToLayer(o);for(const s of i){const h=this._graphTypeLookup.get(s);if(h){const m=this._createSublayer(h);h.type==="entity"?this.dataManager.entityTypeNames.add(s):this.dataManager.relationshipTypeNames.add(s),m.geometryType?this.layers.push(m):this.tables.push(m)}}await se(this,Array.from(i),t),await this.dataManager.refreshCacheContent(e.map(s=>s.id),void 0,void 0,void 0,t);const n={layoutSettings:this._currentLinkChartConfig.layoutSettings,lockedNodeLocations:new Map};for(const[s,h]of this.entityLinkChartDiagramLookup.entries())h&&n.lockedNodeLocations.set(s,new J(h.coords[0],h.coords[1]));await this.applyNewLinkChartLayout(this._currentLinkChartConfig.layoutMode,n)}_createSublayers(e,t,i){e.forEach(o=>{const a=this._createSublayer(o);i(a)&&t.push(a),this._updateSublayerCaches(o)})}_updateSublayers(e,t){t.forEach(i=>{i.parentCompositeLayer=this;const o=e.find(a=>a.type===i.graphType&&a.name===i.graphTypeName);o&&(i.objectType=o,i.read({title:o.name},{origin:"service"}),this._updateSublayerCaches(o))})}_updateSublayerCaches({name:e}){if(!e)return;const t=this.dataManager.sublayerCaches;t.has(e)||t.set(e,new Map)}_layersLoadedFromAuthoritativeItem(){const e=this.originIdOf("layers");return e>=3&&e<7}async _initializeDiagram(){this.initializationLinkChartConfig?this.initializationLinkChartConfig.doNotRecalculateLayout?(this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((e,t)=>{e?.members?.forEach(i=>{const o=i.linkChartLocation;let a;const n=i.id;if(!o)return;a="x"in o?{x:o.x,y:o.y}:{x:o.coords[0],y:o.coords[1]};const s=q(a);this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(n,s):this.entityLinkChartDiagramLookup.set(n,s),this.linkChartExtent.xmin>a.x&&(this.linkChartExtent.xmin=a.x),this.linkChartExtent.xmax<a.x&&(this.linkChartExtent.xmax=a.x),this.linkChartExtent.ymin>a.y&&(this.linkChartExtent.ymin=a.y),this.linkChartExtent.ymax<a.y&&(this.linkChartExtent.ymax=a.y)})}),this.memberRelationshipTypes.forEach(e=>{e.name&&this.dataManager.sublayerCaches.get(e.name)?.forEach(t=>{const i=this.relationshipLinkChartDiagramLookup.get(t.attributes[X]),o=this.relationshipLinkChartDiagramLookup.get(t.attributes[Z]);if(i&&o){const a=q(new fe({paths:[[[i.coords[0],i.coords[1]],[o.coords[0],o.coords[1]]]]}));this.relationshipLinkChartDiagramLookup.set(t.attributes[C],a)}else this.relationshipLinkChartDiagramLookup.set(t.attributes[C],null)})})):await this._calculateLayoutWithSublayerTimeInfo(this.initializationLinkChartConfig.layoutMode,{lockedNodeLocations:this.getCurrentNodeLocations(),...this.initializationLinkChartConfig}):await this._calculateLayoutWithSublayerTimeInfo("organic-standard",{lockedNodeLocations:this.getCurrentNodeLocations()})}_refreshNamedTypes(){for(const e of this.layers)e.emit("refresh",{dataChanged:!0});for(const e of this.tables)e.emit("refresh",{dataChanged:!0})}_validateOrganicLayoutSettings(e,t){const i=T=>typeof T=="number"&&!isNaN(T),o=T=>i(T)&&T>=1,a=T=>i(T)&&T>=1,n=T=>Object.values(le).includes(T),s=T=>i(T)&&T>=0,h={};if(!new Set(["organic-standard","organic-community","geographic-organic-standard","chronological-multi-timeline","chronological-mono-timeline"]).has(e)||!t)return h;const{computationBudgetTime:m,autoRepulsionRadius:c,repulsionRadiusMultiplier:y,absoluteIdealEdgeLength:b,multiplicativeIdealEdgeLength:j,idealEdgeLengthType:S}=t;return a(m)?h.computationBudgetTime=m:m&&E.getLogger(this).warn("Invalid layout computationBudgetTime setting, will revert to default setting"),h.autoRepulsionRadius=c,!c&&o(y)?h.repulsionRadiusMultiplier=y:c||(h.autoRepulsionRadius=!0,E.getLogger(this).warn("Invalid layout repulsionRadiusMultiplier setting, will revert to default setting")),e==="geographic-organic-standard"&&(n(S)?h.idealEdgeLengthType=S:S!==void 0&&E.getLogger(this).warn('Invalid layout idealEdgeLengthType setting, will revert to "multiplier" setting'),S==="absolute-value"&&s(b)?h.absoluteIdealEdgeLength=b:S==="absolute-value"&&b!==void 0?E.getLogger(this).warn("Invalid layout idealEdgeLength setting, will revert to default setting"):S==="multiplier"&&s(j)?h.multiplicativeIdealEdgeLength=j:S==="multiplier"&&j!==void 0&&E.getLogger(this).warn("Invalid layout idealEdgeLength setting, will revert to default setting")),h}_convertValidatedOrganicSettingsToCalculationSettings(e){let t=e.idealEdgeLengthType===le.ABSOLUTE?e.absoluteIdealEdgeLength:e.multiplicativeIdealEdgeLength;return e.idealEdgeLengthType===le.ABSOLUTE&&(t===void 0?t=-1:t*=-1),{computationBudgetTime:e.computationBudgetTime??void 0,repulsionRadiusMultiplier:e.repulsionRadiusMultiplier&&!e.autoRepulsionRadius?e.repulsionRadiusMultiplier:void 0,idealEdgeLengthMultiplier:t}}_createSublayer(e){return new K({objectType:e,parentCompositeLayer:this,graphType:e.type})}_handleSublayersChange(e,t){t&&(t.forEach(i=>{i.parent=null}),this.removeHandles("sublayers-owner")),e&&(e.forEach(i=>{i.parent=this}),this.addHandles([e.on("after-add",({item:i})=>{i.parent=this}),e.on("after-remove",({item:i})=>{i.parent=null})],"sublayers-owner"))}_alignLayersDataModelAndInclusionDefinition(e){const t=new Set((e.entityTypes??[]).map(a=>a.name).concat((e.relationshipTypes??[]).map(a=>a.name))),i=new Set((e.entityTypes??[]).map(a=>a.name)),o=new Set((e.relationshipTypes??[]).map(a=>a.name));if(this.layers){for(const n of this.layers)!n.graphType&&t.has(n.graphTypeName)&&(n.graphType=i.has(n.graphTypeName)?"entity":"relationship");const a=this.layers.filter(n=>t.has(n.graphTypeName)&&(n.graphType==="entity"?i.has(n.graphTypeName):o.has(n.graphTypeName)));this.setAtOrigin("layers",a,De(this.originIdOf("layers")))}else this.layers=new U;if(this.layers&&this._originalInclusionList){const a=new Set(this._originalInclusionList.namedTypeDefinitions.keys()),n=this.tables?.map(m=>m.graphTypeName)??[],s=this.layers.map(m=>m.graphTypeName).concat(n);for(const m of s)a.has(m)||this._originalInclusionList.namedTypeDefinitions.set(m,{useAllData:!1,members:new Map});const h=[];for(const m of this._originalInclusionList.namedTypeDefinitions.keys())s.includes(m)||(E.getLogger(this).warn(`A named type, ${m}, was in the serialized feature collection but did not have a sublayer config in the item, so will be removed`),h.push(m));for(const m of h)this._originalInclusionList.namedTypeDefinitions.delete(m)}}};w([M(Ye)],g.prototype,"url",void 0),w([M()],g.prototype,"dataPreloadedInLocalCache",void 0),w([M()],g.prototype,"initializationLinkChartConfig",void 0),w([M()],g.prototype,"membershipModified",void 0),w([M()],g.prototype,"dataManager",void 0),w([M()],g.prototype,"initializationInclusionModeDefinition",null),w([M()],g.prototype,"knowledgeGraph",void 0),w([M({type:U.ofType(K),json:{write:{ignoreOrigin:!0}}})],g.prototype,"layers",void 0),w([M({readOnly:!0})],g.prototype,"linkChart",null),w([M()],g.prototype,"entityLinkChartDiagramLookup",void 0),w([M()],g.prototype,"relationshipLinkChartDiagramLookup",void 0),w([M()],g.prototype,"linkChartExtent",void 0),w([M()],g.prototype,"memberEntityTypes",void 0),w([M()],g.prototype,"memberRelationshipTypes",void 0),w([M({type:["LinkChartLayer"]})],g.prototype,"operationalLayerType",void 0),w([M()],g.prototype,"sublayerCapabilities",null),w([M()],g.prototype,"sublayerIdsCache",void 0),w([M({type:U.ofType(K),json:{write:{ignoreOrigin:!0}}})],g.prototype,"tables",void 0),w([M({json:{read:!1}})],g.prototype,"type",void 0),w([M({json:{read:!1}})],g.prototype,"chronologicalAuxiliaryGraphics",void 0),g=w([ve("esri.layers.LinkChartLayer")],g);const Pa=g;export{Pa as default};
