import{I as f,v as k,bS as b,bT as U,B as q,l as W}from"./jsonMap-Bs3hmeCU-Cusd0Fmz.js";import{R as J}from"./collectionUtils-jDyktm0P-ArdXNs6F.js";import{QueueProcessor as V}from"./QueueProcessor-D8z0mMzA-GcdBlDoB.js";import{f as O}from"./Point-BfTTZoMu-BAT2Wq6O.js";import{y as S,N as F,l as h,C as $,B as D,o as Z}from"./aaBoundingBox-Cn49X7ge-DORLZxoS.js";import{B as H,A as I,h as L}from"./QueryEngine-J0SYKhS8-CFA9lsZ6.js";import{$ as X}from"./clientSideDefaults-3DdoYkYX-n_psRtPH.js";import{o as v}from"./Field-Cm_ZejYW-CwJZmSru.js";import{m as K}from"./FieldsIndex-CimK-TqD-CrSnohIk.js";import{a3 as Y}from"./lengthUtils-Dt1_RvOO-bleznLOi.js";import{L as ee,A as te,M as A,a as se,u as re}from"./parquetUtils-CmGs5KEq-C-owg9dM.js";import{Z as Q,H as oe}from"./parquet-BvPtb2Qg-DEpjS4pk.js";import{C as ae,Z as B,j as T,X as ie,z as ne}from"./SourceChunkStore-CfCqYuFd-CCGk3ReM.js";import"./index-CTl7hdrJ.js";import"./reactiveUtils-SO2Ko3sy-BCLX8Jdy.js";import"./Extent-CgDMOSRD-CU1qE5Kr.js";import"./mathUtils-PIGhLnI9-B1tKUlUb.js";import"./mat4f64-q_b6UJoq-Dh6sWB_w.js";import"./projectionUtils-BGH_5_I3-BySNUA-B.js";import"./Polyline-CoiTLswR-BLagWJLS.js";import"./Polygon-D6wEPb3W-CpL9Efjx.js";import"./normalizeUtils-85zLqeMi-DCF9gKvo.js";import"./normalizeUtilsCommon-CnhQye_A-zWtr51r8.js";import"./LRUCache-fy84PBMi-Y56WPIvD.js";import"./WhereClause-BSVqskBz-DANRwfyr.js";import"./UnknownTimeZone-B697BDFv-CBbtul7O.js";import"./date-IqUzANpt-bLKO9IDT.js";import"./fieldType-DVUzXtk_-tUuvnZJM.js";import"./FixedIntervalBinParameters-8snYOK8a-BSPWw9c2.js";import"./Color-CERqXxxY-BuYn26eI.js";import"./NormalizationBinParametersMixin-BK9wNkI3-BKYeOhDN.js";import"./Layer-DZvC7bne-m1cEC_yw.js";import"./vec42-B8VM4vXb-BnA9MysM.js";import"./vec4f64-DPb6J-GU-C7c2DqbZ.js";import"./mat4f32-Djp3mnm5-DzYG3LYB.js";import"./mat4-C96X-Nn0-Do6fKsNS.js";import"./intl-DRFqUect-ClAS7BRt.js";import"./ClassBreaksDefinition-BGOzyovZ-K0U0wKo_.js";import"./Scheduler-CNrsbccs-Bcg8fWoS.js";import"./vec2f64-rIxtbMRN-Kai9mK1i.js";import"./reader-DcGs6kKN-DHJfK-tm.js";import"./SimpleObservable-CvFyr0NA-DXpoMYph.js";import"./Queue-CYlrXMwB-CYJTUII-.js";import"./ReactiveMap-B0by2bYu-DCsCfMj5.js";import"./signal-BX9ezF8a-cf1Pn6io.js";import"./aaBoundingRect-CjwcS2F3-D7aII9DY.js";import"./DoubleArray-DExKNiTh-CvVpHySW.js";import"./jsonUtils-CmpazY1u-ateEpj4Q.js";import"./featureConversionUtils-BDA_FXJx-CUwkrHf5.js";import"./OptimizedFeature-CwRGZPwv-Ddclhn0A.js";import"./memoryEstimations-Bd726a_p-0cVCY2Jz.js";import"./OptimizedFeatureSet-BR8EEvDc-CgsRgxJh.js";import"./createFeatureId-CVwTD0fV-3fKpJDrk.js";import"./WhereClauseCache-B0L2SmwV-BYc3WALz.js";import"./TimeOnly-BERR31kg-PKcKegNB.js";import"./enum-BzLwmiID-CcyIdWlQ.js";import"./QueryEngineCapabilities-DJC_YILC-CshvWf3J.js";import"./quantizationUtils-Ceq-Uxsu-CDK8m1qL.js";import"./utils-CUk96PkC-CThUWKre.js";import"./screenUtils-BitdhK1O-L0FLPAMi.js";import"./heatmapUtils-B-AXnq0l-G7fD8L97.js";import"./utils-BbtW4lHb-DKC09XMb.js";import"./timeZoneUtils-BSc7-7qA-BAv3h8mh.js";import"./utils-BEeBypEk-DQLTC4jR.js";import"./SnappingCandidate-DGkpYqI6-CfPvDre4.js";import"./defaultsJSON-GKolV7NZ-GKolV7NZ.js";import"./locationUtils-BujNe57r-CDKGDIj3.js";import"./labelPoint-4nqVL63d-Dz1LbGNv.js";import"./quickselect-QQC62dOK-Br2Ahhru.js";import"./definitions-Dvg4hMIw-CdK2DzFN.js";import"./Cyclical-BLSxUpe7-Bj8R2Yk-.js";import"./utils-CylVuxNi-CqOfmBVG.js";import"./utils-Dpg4yj1D-BVnuoMV8.js";function ue(o){switch(o.type){case"wkb":return re.fromJSON(o);case"location":return se.fromJSON(o)}}const w=new ie,le=4,R=8e3,P="__OBJECTID";class Tt{constructor(){this._fileInfos=new Map,this._queue=new V({concurrency:le,process:(e,s)=>this._executeQuery(e,s)})}async load(e){const s=e.spatialReference?O.fromJSON(e.spatialReference):void 0;if(s&&!s.isWGS84&&!s.isWebMercator)throw new f("parquet:unsupported-projection","Only WGS84 and Web Mercator are supported");const t=await ee({urls:new J(e.urls),fields:e.fields?.map(a=>v.fromJSON(a)),encoding:e.encoding?ue(e.encoding):null,geometryType:e.geometryType?te(e.geometryType):null,spatialReference:s},{customParameters:e.customParameters});let r;if(t.geometryType&&t.encoding){if(!t.spatialReference)throw new f("parquet:unsupported","SpatialReference must be defined");if(!t.spatialReference.isGeographic&&!t.spatialReference.isWebMercator)throw new f("parquet:unsupported-projection","Only WGS84 and Web Mercator are supported");t.spatialReference.isGeographic&&!t.spatialReference.isWGS84&&(k.getLogger("parquet:unsupported-projection").warn("Found a geographic projection that is not WGS84. Handling as WGS84.",{spatialReference:t.spatialReference}),t.spatialReference=O.WGS84),r={geometryType:A(t.geometryType),spatialReference:t.spatialReference.toJSON(),encoding:t.encoding.toJSON(),displayOptimization:t.displayOptimization}}this.setCustomParameters(e.customParameters),this._geometryInfo=r;const i=e.urls;for(const a of i){const d=await Q(a,{geometryInfo:r,outSpatialReference:null,getCustomParameters:()=>this._customParameters});this._fileInfos.set(a,{index:this._fileInfos.size,file:d})}this._capabilities=E(await this.getFileStatistics());const n=this._fileInfos.values().next().value?.file;if(!n)return{layerDefinition:{},capabilities:E(null)};const{fields:u}=t;if(u==null)throw new f("parquet-layer:missing-metadata","Unable to create parquet source: cannot infer fields",u);u.push(new v({name:P,type:"oid",alias:P}));const l={fields:u.map(a=>({...a.toJSON(),column:n.columnForFieldName(a.name)})),timeZoneByFieldName:null},c=K.fromJSON(l);this._fieldsIndex=c;const p=A(t.geometryType??"point");if(this._metadata=ae.createFeature({fieldsIndex:l,geometryType:p,featureIdInfo:{type:"object-id",fieldName:"rowId"},subtypes:null,subtypeField:null,types:null,typeIdField:null,globalIdField:null,spatialReference:t.spatialReference,outSpatialReference:null,timeInfo:null,timeReferenceUnknownClient:null,dateFieldsTimeZone:null}),this._queryEngineParams={fieldsIndex:this._metadata.fieldsIndex,geometryType:r?.geometryType??"esriGeometryPoint",featureIdInfo:{type:"object-id",fieldName:"rowId"},hasM:!1,hasZ:!1,spatialReference:r?.spatialReference??{wkid:4326},aggregateAdapter:null,timeInfo:null,definitionExpression:null},t.spatialReference&&(this._fullExtent=ce(this._fileInfos.values(),t.spatialReference.toJSON())),this._fullExtent==null&&t.encoding?.type==="location"){const{latitudeFieldName:a,longitudeFieldName:d}=t.encoding,M=this._fieldsIndex.get(a)?.column,N=this._fieldsIndex.get(d)?.column,m=S(h(),F);for(const j of this._fileInfos.values())for(const _ of j.file.rowGroups()){const y={stack:[],error:void 0,hasError:!1};try{const g=b(y,_.columnDescriptorForAttribute(M),!1),C=b(y,_.columnDescriptorForAttribute(N),!1),z=[C.minValue(),g.minValue(),C.maxValue(),g.maxValue()];$(m,z),_.free()}catch(g){y.error=g,y.hasError=!0}finally{U(y)}}this._fullExtent={xmin:m[0],ymin:m[1],xmax:m[3],ymax:m[4],spatialReference:t.spatialReference?.toJSON()}}return{capabilities:this._capabilities,layerDefinition:{fields:t.fields?.map(a=>a.toJSON()),drawingInfo:X(p),extent:this._fullExtent??void 0,geometryType:p,geometryEncoding:t.encoding?.toJSON(),displayOptimization:t.displayOptimization}}}destroy(){for(const e of this._fileInfos.values())e.file.free();this._fileInfos.clear(),this._queue.destroy()}setCustomParameters(e){this._customParameters=e}getFileStatistics(){if(!this._fileInfos.size)return null;const e=Array.from(this._fileInfos.values()).reduce((s,t)=>s+t.file.byteLength(),0);return{featureCount:this._getFeatureCount(),byteLength:e}}async updateFiles(e){const s=new Set(e);for(const[t,r]of this._fileInfos.entries())s.has(t)?s.delete(t):(r.file.free(),this._fileInfos.delete(t));for(const t of s){const r=await Q(t,{geometryInfo:this._geometryInfo,outSpatialReference:null,getCustomParameters:()=>this._customParameters});this._fileInfos.set(t,{index:this._fileInfos.size,file:r})}}async queryFeatures(e,s){return this._validateQuery(e),de(e)||(e.resultRecordCount=e.resultRecordCount?Math.min(e.resultRecordCount,8e3):8e3,e.resultOffset=e.resultOffset??0),(e.outStatistics||e.returnDistinctValues)&&delete e.returnGeometry,(await this._enqueueQuery(e,s)).createQueryResponse()}async queryFeatureCount(e,s){return this._validateQuery(e),x(e)?(delete e.outFields,delete e.returnGeometry,(await this._enqueueQuery(e,s)).createQueryResponseForCount()):this._getFeatureCount()}async queryObjectIds(e,s){return this._validateQuery(e),x(e)?(e.resultRecordCount=e.resultRecordCount?Math.min(e.resultRecordCount,8e3):8e3,e.resultOffset=e.resultOffset??0,delete e.returnGeometry,delete e.outFields,(await this._enqueueQuery(e,s)).items.map(t=>t.getObjectId())):Array.from({length:this._getFeatureCount()},(t,r)=>r)}async queryExtent(e,s){if(this._validateQuery(e),this._fullExtent&&!x(e))return{count:this._getFeatureCount(),extent:this._fullExtent};const t=q(this._metadata.spatialReference);e.returnGeometry=!0,delete e.outFields;const r=S(h(),F),i=h(),n=await this._enqueueQuery(e,s);let u=0;for(const l of n.items)l.getBounds(i)&&(D(r,i),u+=1);return{count:u,extent:H(r,t,e.outSR?q(e.outSR):t,t,!1)}}_getFeatureCount(){return Array.from(this._fileInfos.values()).reduce((e,s)=>e+s.file.numRows(),0)}_validateQuery(e){if(!this._capabilities.query.supportsStatistics&&e.outStatistics)throw new f("parquet:unsupported","Statistics queries are not supported",{query:e});if(!this._capabilities.query.supportsOrderBy&&e.orderByFields?.length)throw new f("parquet:unsupported","Queries using orderBy are not supported",{query:e});if(!this._capabilities.query.supportsDistinct&&e.returnDistinctValues)throw new f("parquet:unsupported","Queries using returnDistinctValues are not supported",{query:e})}async*_fetchChunks(e,s){for(const t of this._fileInfos.values()){const r=t.file.numRows(),i=Math.ceil(r/R);for(let n=0;n<i;n++){const u=n*R,l=await t.file.readChunk(u,R,e.fields,e.returnGeometry,s);for(const c of l){const p=new B(this._metadata,this._fieldsIndex,c,0,t.index);yield G([new T(p,null,0,!1)],this._queryEngineParams)}}}}_enqueueQuery(e,s){return this._queue.push(e,s)}async _executeQuery(e,s){const t=await this._getReadParams(e);if(e.objectIds?.length)for(const u of this._fileInfos.values()){const l=[],c=G((await u.file.readChunksByRowId(new Uint32Array(e.objectIds),t.fields,t.returnGeometry,s)).map((a,d)=>new B(this._metadata,this._fieldsIndex,a,d,u.index)).map((a,d)=>new T(a,null,d,!1)),this._queryEngineParams),p=await c.executeQueryForOpaqueFeatures(e,s);for(const a of p)l.push(a);return new I(l,e,{fieldsIndex:this._fieldsIndex,geometryType:this._metadata.geometryType,spatialReference:this._queryEngineParams.spatialReference,objectIdField:"rowId",hasM:!1,hasZ:!1,featureAdapter:w})}let r=e.resultRecordCount??this._getFeatureCount(),i=e.resultOffset??0;delete e.resultRecordCount,delete e.resultOffset;const n=[];for await(const u of this._fetchChunks(t,s)){const l=await u.executeQueryForOpaqueFeatures(e,s);if(l.length>i){const c=l.slice(i,Math.min(i+r,l.length));for(const p of c)n.push(p);if(i=0,r-=c.length,r===0)return new I(n,e,{fieldsIndex:this._fieldsIndex,geometryType:this._metadata.geometryType,spatialReference:this._queryEngineParams.spatialReference,objectIdField:"rowId",hasM:!1,hasZ:!1,featureAdapter:w})}else i-=l.length}return new I(n,e,{fieldsIndex:this._fieldsIndex,geometryType:this._metadata.geometryType,spatialReference:this._queryEngineParams.spatialReference,objectIdField:"rowId",hasM:!1,hasZ:!1,featureAdapter:w})}async _getReadParams(e){const s=new Set;if(e.where&&await Y(s,this._fieldsIndex,e.where),e.outStatistics)for(const t of e.outStatistics)t.onStatisticField!=null&&s.add(t.onStatisticField);if(e.outFields)for(const t of e.outFields)s.add(t);return{fields:this._getAttributeIds(Array.from(s)),returnGeometry:!!e.returnGeometry||!!e.geometry}}_getAttributeIds(e){if(e==null)return new Uint32Array;if(e.includes("*"))return new Uint32Array(this._fieldsIndex.fields.map(t=>t.column).filter(t=>t!=null));const s=[];for(const t of e){const r=this._fieldsIndex.get(t);if(r==null)throw new f("unknown-field",`Field ${t} does not exist`);r.column==null||s.push(r.column)}return new Uint32Array(s)}}function x(o){return Object.keys(o).some(e=>pe(e))}function pe(o){switch(o){case"resultOffset":case"resultRecordCount":case"aggregateIds":case"distance":case"gdbVersion":case"geometry":case"having":case"timeExtent":case"where":case"objectIds":case"historicMoment":return!0;default:return!1}}function G(o,e){const s=new ne;for(const t of o)s.insert(t);return new L({...e,featureStore:s})}function fe(o){switch(o.length){case 4:return Z(h(),o);case 6:return o;default:throw new f("parquet:protocol-violation","Invalid Geoparquet file. BoundingBox size must be 4 or 6.",{bbox:o})}}function ce(o,e){const s=S(h(),F);for(const t of o){const r=oe(t.file);if(!r)return null;const i=r.columns[r.primary_column];if(!i.bbox)return null;const n=fe(i.bbox);D(s,n)}return{xmin:s[0],ymin:s[1],xmax:s[3],ymax:s[4],spatialReference:e}}function E(o){const e=o?.featureCount;let s=!1;return e!=null&&e<W("parquetlayer-full-query-feature-count")&&(s=!0),{analytics:{supportsCacheHint:!1},attachment:null,data:{isVersioned:!1,isBranchVersioned:!1,supportsAttachment:!1,supportsM:!1,supportsZ:!1},metadata:{supportsAdvancedFieldProperties:!1},operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:!1,supportsDelete:!1,supportsEditing:!1,supportsChangeTracking:!1,supportsQuery:!0,supportsQueryBins:!1,supportsQueryPivot:!1,supportsQueryAnalytics:!1,supportsQueryAttachments:!1,supportsQueryTopFeatures:!1,supportsResizeAttachments:!1,supportsSync:!1,supportsUpdate:!1,supportsExceedsLimitStatistics:!1,supportsAsyncConvert3D:!1},query:{maxRecordCount:8e3,maxRecordCountFactor:void 0,maxUniqueIDCount:void 0,standardMaxRecordCount:void 0,supportsCacheHint:!1,supportsCentroid:!0,supportsCentroidOnDegeneratedQuantizedGeometry:!1,supportsCurrentUser:!1,supportsDegeneratedQuantizedGeometry:!1,supportsDisjointSpatialRelationship:!1,supportsDistance:!1,supportsDistinct:s,supportsExtent:!1,supportsFormatPBF:!1,supportsGeometryProperties:!1,supportsHavingClause:!1,supportsHistoricMoment:!1,supportsMaxRecordCountFactor:!1,supportsOrderBy:s,supportsPagination:!0,supportsPaginationOnAggregatedQueries:!1,supportsPercentileStatistics:!1,supportsQuantization:!0,supportsQuantizationEditMode:!1,supportsQueryByAnonymous:!1,supportsQueryByOthers:!1,supportsQueryGeometry:!1,supportsResultType:!1,supportsReturnMesh:!1,supportsStandardizedQueriesOnly:!1,supportsTopFeaturesQuery:!1,supportsStatistics:s,supportsSpatialAggregationStatistics:!1,supportedSpatialAggregationStatistics:{envelope:!1,centroid:!1,convexHull:!1},supportsDefaultSpatialReference:!1,supportsFullTextSearch:!1,supportsCompactGeometry:!1,supportsSqlExpression:!1,supportsTrueCurve:!1,tileMaxRecordCount:void 0},queryAttributeBins:{supportsDate:!1,supportsFixedInterval:!1,supportsAutoInterval:!1,supportsFixedBoundaries:!1,supportsStackBy:!1,supportsSplitBy:!1,supportsSnapToData:!1,supportsReturnFullIntervalBin:!1,supportsFirstDayOfWeek:!1,supportsNormalization:!1},queryRelated:{supportsCount:!1,supportsOrderBy:!1,supportsPagination:!1,supportsCacheHint:!1},queryTopFeatures:{supportsCacheHint:!1},editing:{supportsDeleteByAnonymous:!1,supportsDeleteByOthers:!1,supportsGeometryUpdate:!1,supportsGlobalId:!1,supportsReturnServiceEditsInSourceSpatialReference:!1,supportsRollbackOnFailure:!1,supportsUpdateByAnonymous:!1,supportsUpdateByOthers:!1,supportsUploadWithItemId:!1,supportsUpdateWithoutM:!1,supportsAsyncApplyEdits:!1,zDefault:void 0}}}function de(o){return!!(o.objectIds?.length||o.outStatistics||o.orderByFields?.length||o.returnDistinctValues)}export{Tt as default};
